<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>HN100 - Readable Contents</title>
        <link>https://hn.algolia.com/api/v1/search_by_date?tags=%28story,poll%29&amp;numericFilters=points%3E100</link>
        <description>Uses Readability to add bodies to the RSS feed</description>
        <lastBuildDate>Tue, 18 Mar 2025 14:30:02 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[The Model Is the Product (112 pts)]]></title>
            <link>https://vintagedata.org/blog/posts/model-is-the-product</link>
            <guid>43397474</guid>
            <pubDate>Tue, 18 Mar 2025 09:56:37 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://vintagedata.org/blog/posts/model-is-the-product">https://vintagedata.org/blog/posts/model-is-the-product</a>, See on <a href="https://news.ycombinator.com/item?id=43397474">Hacker News</a></p>
<div id="readability-page-1" class="page"><section id="page-wrapper">
                                            
                                            
<p>There were a lot of speculation over the past years about what the next cycle of AI development could be. Agents? Reasoners? Actual multimodality? </p>
<p>I think it's time to call it: the model is the product.</p>
<p>All current factors in research and market development push in this direction.</p>
<ul>
<li>Generalist scaling is stalling. This was the whole message behind the release of GPT-4.5: capacities are growing linearly while compute costs are on a geometric curve. Even with all the efficiency gains in training and infrastructure of the past two years, OpenAI can't deploy this giant model with a remotely affordable pricing.</li>
<li>Opinionated training is working <em>much</em> better than expected. The combination of reinforcement learning and reasoning means that models are suddenly learning tasks. It's not machine learning, it's not base model either, it's a secret third thing. It's even tiny models getting suddenly scary good at math. It's coding model no longer just generating code but managing an entire code base by themselves. It's Claude playing Pokemon with very poor contextual information and no dedicated training.</li>
<li>Inference cost are in free fall. The recent optimizations from DeepSeek means that all the available GPUs could cover a demand of 10k tokens per day from a frontier model for… the entire earth population. There is nowhere this level of demand. The economics of selling tokens does not work anymore for model providers: they have to move higher up in the value chain.</li>
</ul>
<p>This is also an uncomfortable direction. All investors have been betting on the application layer. In the next stage of AI evolution, the application layer is likely to be the first to be automated and disrupted.</p>
<h2>Shapes of models to come.</h2>
<p>Over the past weeks, we have seen two prime example of this new generation of models as a product: OpenAI's DeepResearch and Claude Sonnet 3.7.</p>
<p>I've read a lot of misunderstandings about DeepResearch, which isn't helped by the multiplication of open and closed clones. OpenAI has not built a wrapper on top of O3. They have <a href="https://cdn.openai.com/deep-research-system-card.pdf">trained an entirely new model</a>, able to perform search internally, without any external calls, prompts or orchestration:</p>
<blockquote>
<p>The model learned the core browsing capabilities (searching, clicking, scrolling, interpreting files) (…) and how to reason to synthetize a large number of websites to find specific pieces of information or write comprehensive reports through reinforcement learning training on these browsing tasks.</p>
</blockquote>
<p>DeepResearch is not a standard LLM, nor a standard chatbot. It's a new form of <em>research language model</em>, explicitly designed to perform search tasks end to end. The difference is immediately striking to everyone using it seriously: the model generate lengthy reports with consistent structure and underlying source analysis process. In comparison as Hanchung Lee <a href="https://leehanchung.github.io/blogs/2025/02/26/deep-research/">underlined</a> all the other DeepSearch, including the Perplexity and Google variant, are just your usual models with a few twists:</p>
<blockquote>
<p>Google’s Gemini and Perplexity’s chat assistants also offer “Deep Research” features, but neither has published any literature on how they optimized their models or systems for the task or any substaintial quantitative evaluations (…) We will make an assumption that the fine-tuning work done is non-substantial.</p>
</blockquote>
<p>Anthropic has been laying their current vision ever clearer. In December, they introduced a controversial but, to my mind, correct <a href="https://www.anthropic.com/research/building-effective-agents">definition</a> of agent models. Similarly to DeepSearch, an agent has to perform the targeted tasks internally: they "dynamically direct their own processes and tool usage, maintaining control over how they accomplish tasks". </p>
<p>What most agent startups are currently building is not agents, it's workflows, that is "systems where LLMs and tools are orchestrated through predefined code paths." Workflows may still bring some value, especially for vertical adaptations. Yet, to anyone currently working in the big labs it's strikingly obvious that all major progress in autonomous systems will be through redesigning the models in the first place.</p>
<p>We had a very concrete demonstration of this with the release of Claude 3.7, a model primarily trained with complex code use cases in mind. All the workflow adaptation like Devin had a major boost on SWE benchmarks.</p>
<p>To give it another example done at a much smaller scale: at Pleias we're currently working on automating RAG. Current RAG systems are a lot of interconnected yet brittle workflows: routing, chunking reranking, query interpretation, query expansion, source contextualization, search engineering. With the evolving training tech stack, there is a real potential to bundle all theses processes in two separate yet interconnected models, one for data preparation and the other for search/retrieval/report generation. This requires an elaborated synthetic pipeline and entirely new reward functions for reinforcement learning. Actual training, actual research.</p>
<p>What all this all means in practice: displacing complexity. Training anticipates a wide range of actions and edge cases, so that deployment becomes much more simple. But in this process most of the value is now created and, likely in the end, captured by the model trainer. In short, what Claude aims to disrupt and replace the current workflows like this basic "agent" system from llama index:</p>
<p><img src="https://huggingface.co/datasets/Pclanglais/course-material/resolve/main/llama_index.png" alt="Llama Index Basic Agent"></p>
<p>With this:</p>
<p><img src="https://huggingface.co/datasets/Pclanglais/course-material/resolve/main/claude.png" alt="Claude Agent"></p>
<h2>Training or being trained on.</h2>
<p>To reassert: the big labs are not advancing with an hidden agenda. While they can be opaque at time, they laying it all in the open: they will bundle, they will go up the application layer and they will attempt to capture most of the value there. And the commercial consequences are quite clear. Naveen Rao, the Gen AI VP of Databricks, <a href="https://x.com/NaveenGRao/status/1886544584588619840">phrased it quite well</a>:</p>
<blockquote>
<p>all closed AI model providers will stop selling APIs in the next 2-3 years. Only open models will be available via APIs (…) Closed model providers are trying to build non-commodity capabilities and they need great UIs to deliver those. It's not just a model anymore, but an app with a UI for a purpose.</p>
</blockquote>
<p>So what is happening right now is just a lot of denial. The honeymoon period between model providers and wrappers is over. Things could evolve in both direction:</p>
<ul>
<li>Claude Code and DeepSearch are early technical and product experiments in this direction. You will notice that DeepSearch is not available through an API, only used to create value for the premium subscriptions. Claude Code is a minimalistic terminal integration. Weirdly enough, while Claude 3.7 works perfectly in Claude Code, Cursor struggles with it and I've already seen several high end users cancelling their subscriptions as a result. Actual LLM agents doesn't care about pre-existing workflows: they replace it.</li>
<li>The most high profile wrapper are now scrambling to become hybrid AI training companies. They do have some training capacities, though very little advertised. One of Cursor main assets is their small autocompletion model. WindSurf has their internal cheap code model, Codium. Perplexity always relied on home classifiers for routing and recently pivoted to train their own DeepSeek variant for search purposes.</li>
<li>For smaller wrappers, not much will change, except likely increased reliance on agnostic inference providers if the big labs entirely let go of this market. I do also expect to see much more focus on UI which is still dramatically underestimated, as even more generalist models are likely to bundle common deployment takss, especially for RAG.</li>
</ul>
<p>In short the dilemma for most successful wrappers is simple: training or being trained on. What they are doing right now is both free market research for the big labs but, even, as all outputs is ultimately generated through model providers, free data design and generation. </p>
<p>What will happen afterwards is anyone guess. Successful wrappers do have the advantage of knowing their vertical well and accumiulating a lot of precious user feedbacks. Yet, in my experience, it's easier to go down from the model to application layers than building an entirely new training capacities from scratch. Wrappers may not have been helped by their investors either. From what I overheard, there is such a negative polarization against training, they almost have to hide what is going to be their most critical value: neither cursor small nor codium are properly documented at this moment.</p>
<h2>Reinforcement learning was not priced in.</h2>
<p>This brings me to the actual painful part: currently all AI investments are correlated. Funds are operating under the following assumptions:</p>
<ul>
<li>The real value lay exclusively in an application layer independent from the model layer that is best positioned to disrupt existing market.</li>
<li>Model providers will only sell tokens at an ever lowering price, making wrappers in turn more profitable.</li>
<li>Close models wrapping will satisfy all the existing demands, even in regulated sectors with long lasting concerns over external dependencies.</li>
<li>Building any training capacity is just a waste of time. This does not include only pre-training but all forms of training.</li>
</ul>
<p>I'm afraid this increasingly look like an adventurous bet and an actual market failure to accurately price the latest technical developments, especially in RL. In the current economic ecosystem, venture funds are meant to find uncorrelated investments. They will not beat S&amp;P500 but that's not what larger institutional investors are looking for: they want to bundle risks, ensure that in a bad year at least some things will work out. Model training is like a textbook perfect example for this: lots of potential for disruption in a context where most western economies are on course for a recession. And yet model trainers can't raise, or at least not in the usual way. Prime Intellect is one of the few new western ai training companies that has a clear potential to become a frontier lab. Yet, despite their achievements including the training of the first decentralized LLM, they struggled to raise more than your usual wrapper.</p>
<p>Beyond that, aside from the big lab, the current training ecosystem is very tiny. You can count all theses companies on your hands: Prime Intellect, Moondream, Arcee, Nous, Pleias, Jina, the HuggingFace pretraining team (actually tiny)… Along with a few more academic actors (Allen AI, Eleuther…) they build and support most of the current open infrastructure for training. In Europe, I know that at least 7-8 LLM projects will integrate the Common Corpus and some of the pretraining tools we developed at Pleias — and the rest will be fineweb, and likely post-training instruction sets from Nous or Arcee. </p>
<p>There is something deeply wrong in the current funding environment. Even OpenAI senses it now. Lately, there was some <a href="https://x.com/khoomeik/status/1892743475843813680">felt irritation</a> at the lack of "vertical RL" in the current Silicon Valley startup landscape. I believe the message comes straight from Sam Altman and will likely result in some adjustment in the next YC batch but pinpoint to a larger shift: soon the big labs select partners won't be API customers but associated contractors involved in the earlier training stage. </p>
<p>If the model is the product, you cannot necessarily build it alone. Search and code are easy low hanging fruits: major use cases for two years, the market is nearly mature and you can ship a new cursor in a few months. Now many of the most lucrative AI uses cases in the future are not at this advanced stage of development — typically, think about all these rule based system that still rule most of the world economy… Small dedicated teams with a cross-expertise and a high level of focus may be best positioned to tackle this— eventually becoming potential acquihire once the initial ground work is done. We could see the same pipeline in the UI side. Some preferred partner, getting exclusive API access to close specialized models, provided they get on the road for business acquisition.</p>
<p>I haven't mentioned DeepSeek, nor Chinese labs so far. Simply because DeepSeek is already one step further: not model as a product, but as a universal infrastructure layer. Like OpenAI and Anthropic, Lian Wenfeng <a href="https://www.lesswrong.com/posts/kANyEjDDFWkhSKbcK/two-interviews-with-the-founder-of-deepseek">lays his plans in the open</a>:</p>
<blockquote>
<p>We believe that the current stage is an explosion of technological innovation, not an explosion of applications (…) If a complete upstream and downstream industrial ecosystem is formed, then there is no need for us to make applications ourselves. Of course, there is no obstacle for us to make applications if needed, but research and technological innovation will always be our first priority.</p>
</blockquote>
<p>At this stage, working only on applications is like "fighting the next wars with last war generals". I'm afraid we're at the point where many in the west are not even aware the last war is over.</p>

                </section></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Please stop externalizing your costs directly into my face (150 pts)]]></title>
            <link>https://drewdevault.com/2025/03/17/2025-03-17-Stop-externalizing-your-costs-on-me.html</link>
            <guid>43397361</guid>
            <pubDate>Tue, 18 Mar 2025 09:42:12 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://drewdevault.com/2025/03/17/2025-03-17-Stop-externalizing-your-costs-on-me.html">https://drewdevault.com/2025/03/17/2025-03-17-Stop-externalizing-your-costs-on-me.html</a>, See on <a href="https://news.ycombinator.com/item?id=43397361">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
  <article>
    <p>Over the past few months, instead of working on our priorities at SourceHut, I
have spent anywhere from 20-100% of my time in any given week mitigating
hyper-aggressive LLM crawlers at scale. This isn’t the first time SourceHut has
been at the wrong end of some malicious bullshit or paid someone else’s
externalized costs – every couple of years someone invents a new way of ruining
my day.</p>
<p>Four years ago, we decided to <a href="https://man.sr.ht/ops/builds.sr.ht-migration.md">require payment to use our CI services</a>
because it was being abused to mine cryptocurrency. We alternated between
periods of designing and deploying tools to curb this abuse and periods of
near-complete outage when they adapted to our mitigations and saturated all of
our compute with miners seeking a profit. It was bad enough having to beg my
friends and family to avoid “investing” in the scam without having the scam
break into my business and trash the place every day.</p>
<p>Two years ago, we threatened to <a href="https://sourcehut.org/blog/2023-01-09-gomodulemirror/">blacklist the Go module mirror</a> because for
some reason the Go team thinks that running terabytes of git clones all day,
every day for every Go project on git.sr.ht is cheaper than maintaining any
state or using webhooks or coordinating the work between instances or even just
designing a module system that doesn’t require Google to DoS git forges whose
entire annual budgets are considerably smaller than a single Google engineer’s
salary.</p>
<p>Now it’s LLMs. If you think these crawlers respect robots.txt then you are
several assumptions of good faith removed from reality. These bots crawl
everything they can find, robots.txt be damned, including expensive endpoints
like git blame, every page of every git log, and every commit in every repo, and
they do so using random User-Agents that overlap with end-users and come from
tens of thousands of IP addresses – mostly residential, in unrelated subnets,
each one making no more than one HTTP request over any time period we tried to
measure – actively and maliciously adapting and blending in with end-user
traffic and avoiding attempts to characterize their behavior or block their
traffic.</p>
<p>We are experiencing dozens of brief outages per week, and I have to review our
mitigations several times per day to keep that number from getting any higher.
When I do have time to work on something else, often I have to drop it when all
of our alarms go off because our current set of mitigations stopped working.
Several high-priority tasks at SourceHut have been delayed weeks or even months
because we keep being interrupted to deal with these bots, and many users have
been negatively affected because our mitigations can’t always reliably
distinguish users from bots.</p>
<p>All of my sysadmin friends are dealing with the same problems. I was asking one
of them for feedback on a draft of this article and our discussion was
interrupted to go deal with a new wave of LLM bots on their own server. Every
time I sit down for beers or dinner or to socialize with my sysadmin friends
it’s not long before we’re complaining about the bots and asking if the other
has cracked the code to getting rid of them once and for all. The desperation in
these conversations is palpable.</p>
<p>Whether it’s cryptocurrency scammers mining with FOSS compute resources or
Google engineers too lazy to design their software properly or Silicon Valley
ripping off all the data they can get their hands on at everyone else’s expense…
I am sick and tired of having all of these costs externalized directly into my
fucking face. Do something productive for society or get the hell away from my
servers. Put all of those billions and billions of dollars towards the common
good before sysadmins collectively start a revolution to do it for you.</p>
<p>Please stop legitimizing LLMs or AI image generators or GitHub Copilot or any of
this garbage. I am begging you to stop using them, stop talking about them, stop
making new ones, just <em>stop</em>. If blasting CO<sub>2</sub> into the air and
ruining all of our freshwater and traumatizing cheap laborers and making every
sysadmin you know miserable and ripping off code and books and art at scale and
ruining our fucking democracy isn’t enough for you to leave this shit alone,
what is?</p>
<p>If you personally work on developing LLMs et al, know this: I will never work
with you again, and I will remember which side you picked when the bubble
bursts.</p>

  </article>
</div><section>
  <h2>
    Articles from blogs I read
    <small>
      Generated by
      <a href="https://git.sr.ht/~sircmpwn/openring">openring</a>
    </small>
  </h2>
  <section>
    
    <div>
      <h4>
        <a href="https://blog.brixit.nl/after-fosdem-videobox-updates/" target="_blank" rel="noopener">After-FOSDEM videobox updates</a>
      </h4>
      <p>The FOSDEM video capture box is a custom device for doing all the in-room stuff for the live-streams of the event. It contains a Radxa x4 SBC, a digital audio mixer, an HDMI capture card, some USB chargers and a network switch. Every room that is  livestr…</p>
      <p><small>
        via <a href="https://blog.brixit.nl/">BrixIT Blog</a>
      </small>
      <small>March 10, 2025</small>
    </p></div>
    
    <div>
      <h4>
        <a href="https://sourcehut.org/blog/2025-03-07-whats-cooking-q1-25/" target="_blank" rel="noopener">What's cooking on SourceHut? Q1 2025</a>
      </h4>
      <p>Hello all! We’re back with another “What’s cooking”, after another too-long
hiatus since September. We did promise to resume monthly updates, but in
hindsight that seems a bit ambitious given everything on our plate. For now
we’re going to aim for the more m…</p>
      <p><small>
        via <a href="https://sourcehut.org/blog/">Blogs on Sourcehut</a>
      </small>
      <small>March 7, 2025</small>
    </p></div>
    
    <div>
      <h4>
        <a href="https://100r.co/site/log.html#feb2025" target="_blank" rel="noopener">Summary of changes for February 2025</a>
      </h4>
      <p>
Hey everyone!This is the list of all the changes we've done to our projects during the month of February.



Summary Of Changes


  100r.co, added Dinghy gelcoat, Week 10, Week 11, and Week 12 of the Victoria to Sitka logbook. Updated solar with new pictures…</p>
      <p><small>
        via <a href="https://100r.co/">Hundred Rabbits</a>
      </small>
      <small>March 1, 2025</small>
    </p></div>
    
  </section>
</section></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Moving away from US cloud services (513 pts)]]></title>
            <link>https://martijnhols.nl/blog/moving-away-from-us-cloud-services</link>
            <guid>43396795</guid>
            <pubDate>Tue, 18 Mar 2025 08:09:37 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://martijnhols.nl/blog/moving-away-from-us-cloud-services">https://martijnhols.nl/blog/moving-away-from-us-cloud-services</a>, See on <a href="https://news.ycombinator.com/item?id=43396795">Hacker News</a></p>
<div id="readability-page-1" class="page"><article><div><div><p>Published</p><!-- --> <p><time role="button" tabindex="0" aria-expanded="false" datetime="2025-03-13">2 days ago</time>,</p><!-- --> <p><span>updated <time role="button" tabindex="0" aria-expanded="false" datetime="2025-03-15">today</time></span></p></div><p>For years, using US clouds in the EU has been questionable. <strong>Time and time again, data-sharing agreements between the EU and the US get busted</strong>, showing there's just no legal compatibility between EU privacy rights and US spying laws. Every few years, it's <a href="https://en.wikipedia.org/wiki/PRISM">revealed</a> that the US is <a href="https://www.wired.com/story/congress-spy-powers-fisa-ndaa-trump-702/">spying more</a> than expected. While everyone in the EU kinda knows storing personal data on US clouds is <span role="button" tabindex="0" aria-expanded="false">pretty much impossible to do legally</span>, they figure that since everyone is doing it, even if it's not legal, then <a href="https://blog.iusmentis.com/2025/01/17/mag-ik-ondertussen-data-in-de-cloud-zetten-als-die-fysiek-in-europa-blijft/">at least you'd be wrong with everyone else, so that makes it less bad</a>. And soon, it may become <a href="https://noyb.eu/en/us-cloud-soon-illegal-trump-punches-first-hole-eu-us-data-deal">fully illegal</a>.</p>
<p>But privacy isn't the only concern anymore. With the current political situation in the US, it's also starting to become clear that <strong>our entire digital infrastructure is at the mercy of US policies</strong>. <a href="https://berthub.eu/articles/posts/you-can-no-longer-base-your-government-and-society-on-us-clouds/">It is no longer safe to rely on US clouds for our governments and societies</a>, as the US government can shut it down at will. And it <a href="https://berthub.eu/articles/posts/servers-in-de-eu-eigen-sleutels-helpt-het/#wat-als-er-ruzie-is">doesn't matter</a> whether the servers are in the EU.</p>
<p>This isn't just speculation. In 2019 GitHub started <a href="https://www.zdnet.com/article/github-starts-blocking-developers-in-countries-facing-us-trade-sanctions/">blocking</a> individual developers due to US trade sanctions. More recently, the US imposed new <a href="https://www.theguardian.com/us-news/2025/feb/06/trump-sanction-icc">sanctions on the International Criminal Court</a> in The Netherlands. These sanctions make it illegal for US companies to provide services to <span role="button" tabindex="0" aria-expanded="false">affected persons</span>, essentially cutting them off from US services. This is a huge problem for them; <a href="https://www.theguardian.com/law/2025/jan/20/international-criminal-court-icc-braces-swift-trump-sanctions-over-israeli-arrest-warrants">the ICC fears being cut off from all of their evidence</a>, and <a href="https://www.justiceinfo.net/en/140499-can-the-icc-survive-the-u-s-sanctions-part-2.html#h-a-potential-threat-to-the-very-existence-of-the-court">it may even shut the ICC down</a>.</p>
<p>This sets a dangerous precedent. It increasingly appears that the US government will use tech companies as a weapon.</p>
<p><img alt="Taking the exit with the US cloud" loading="lazy" width="2750" height="1350" decoding="async" data-nimg="1" srcset="https://martijnhols.nl/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fcover.38be4c3b.png&amp;w=3840&amp;q=75 1x" src="https://martijnhols.nl/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fcover.38be4c3b.png&amp;w=3840&amp;q=75"></p><p>All things considered, <strong>it's high time to move away from US cloud services</strong>. In this article, I'll break down how I'm migrating away, what I switched to, and the challenges along the way.</p>
<h2 id="my-dependencies">My dependencies</h2>
<p>Before starting, I made an inventory of the US cloud services I depend on. I decided to focus on cloud services (and not software and hardware), as that's where the biggest risks are. My <span role="button" tabindex="0" aria-expanded="false">complete</span> dependency list roughly in order of reliance:</p>
<ul>
<li>Microsoft Office 365<!-- -->
<ul>
<li>Mail</li>
<li>Calendar</li>
<li>OneDrive</li>
</ul>
</li>
<li>Bitwarden</li>
<li>GitHub</li>
<li>Google search</li>
<li>Cloudflare/Google DNS</li>
<li>Docker Hub</li>
<li>NPM</li>
</ul>
<p>This list is focused on cloud services I use professionally (for my business), but I plan to migrate personal services as well (privately I also rely on WhatsApp for communication and iCloud for backups and notes).</p>
<div><p>Aside</p><div><p>While they're technically not cloud services, I also depend on online
platforms like Hacker News, Reddit,
<a href="https://www.linkedin.com/in/martijnhols/">LinkedIn</a>,
<a href="https://x.com/MartijnHols">Twitter</a> and
<a href="https://bsky.app/profile/martijnhols.nl">BlueSky</a> and WhatsApp. I use social
media like Hacker News and Reddit to reach people and stay informed, and
LinkedIn, Twitter and BlueSky are ways for people to find and follow me. These
platforms are only as good as the people on them, making most of them
irreplaceable. Not because of their infrastructure, but because of their
communities.</p></div></div>
<h2 id="replacing-the-dependencies">Replacing the dependencies</h2>
<p>With my list handy, I replaced each dependency one by one. A useful tool for finding alternatives is the <a href="https://european-alternatives.eu/">European Alternatives</a> website.</p>
<h3 id="goodbye-microsoft-office-365">Goodbye Microsoft Office 365</h3>
<p>Microsoft 365 was my most important dependency. It has all of my mail, including history that I'm legally required to save, my calendar, and most of my important files, which I'm legally required to keep long-term. Losing access to these services isn't an option.</p>
<p>On top of that, I've had long-standing usability issues with Microsoft 365. Particularly OneDrive for Mac, which was constantly draining my battery and overheating my CPU, making the switch even more appealing.</p>
<p>I went looking for an all-in-one solution; mail, calendar, and storage, mostly because it's simpler, but I also don't want to pay for everything separately. In the end, I settled on <a href="https://proton.me/">Proton</a>. I had heard of Proton Mail before as a privacy-focused highly-encrypted mail provider, but never really looked into it as I had no real need for that, and I figured it would come at the cost of usability and price. But <strong>I was seriously impressed by how good Proton software is.</strong> Their apps are really <span role="button" tabindex="0" aria-expanded="false">well-made and very usable</span>. I actually have a better experience than I did using Microsoft's. I'm impressed by how they made everything work so well without sacrificing privacy in any way.</p>

<p>The <a href="https://proton.me/business/plans">Proton Business Suite</a>, which includes 1 TB for Mail, Calendar, VPN, Pass and Drive, is only 12.99 per month (the non-business variant is 9.99). And just like Microsoft 365, it has full-fledged support for teams.</p>
<p>Another thing that impressed me about Proton is <a href="https://www.washingtonpost.com/technology/2023/06/27/gmail-switch-proton-email/">how easy</a> switching from Microsoft 365 was. Their <a href="https://proton.me/easyswitch">Easy Switch</a> tool, handled all the data importing for me in just a few clicks. All I had to do manually was update the DNS for my domains. And as a bonus, Proton allows setting up 15 custom email domains, so I can cancel all of my separate <a href="https://www.transip.nl/email-hosting/">email hosting</a> and centralize all my mailboxes.</p>
<p>Yet another bonus: the Proton Business Plan includes a VPN. I only need one very occasionally and my needs were never enough to subscribe to one, so this is a nice extra perk.</p>
<h3 id="replacing-bitwarden">Replacing Bitwarden</h3>
<p>I was very hesitant to switch password managers. I'd used Bitwarden daily for over 4 years, and despite its usability issues, it had become a core part of my toolkit.</p>
<p>But as I really wanted to ditch US cloud services, I looked into replacing it. After all, even though my vaults are encrypted, they're still hosted by Bitwarden and they can restrict my access as they see fit.</p>
<p>The obvious place to start was <a href="https://proton.me/pass">Proton Pass</a>, since it came <span role="button" tabindex="0" aria-expanded="false">bundled</span> with the Proton Business Suite. When I saw <a href="https://www.youtube.com/watch?v=CBdDYurOMyg">1Password users switching</a>, I figured it had to be good. Turns out, it really is! <strong>It has all of the features I used in Bitwarden, and more.</strong> The main new things I appreciate are sharing a password via a link, and the return of the login dropdown in login forms. Oh, I missed you so.</p>
<figure><p><img alt="Shows a login form (Email or username and password) with an autofill overaly open with an option to login as &quot;martijnhols&quot;" loading="lazy" width="500" height="249" decoding="async" data-nimg="1" srcset="https://martijnhols.nl/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fproton-pass-autofill.94d6e56f.png&amp;w=640&amp;q=75 1x, https://martijnhols.nl/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fproton-pass-autofill.94d6e56f.png&amp;w=1080&amp;q=75 2x" src="https://martijnhols.nl/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fproton-pass-autofill.94d6e56f.png&amp;w=1080&amp;q=75"></p><figcaption>The dropdown opens automatically, so I can confirm a login with a single click</figcaption></figure>
<p>Migration was even easier than mail; just export in Bitwarden and import in Proton Pass, and you're done. Even TOTP codes and secure notes transfer over seamlessly.</p>
<h3 id="the-github-challenge">The GitHub challenge</h3>
<p>I'm deeply locked into GitHub, having <a href="https://martijnhols.nl/blog/migrating-away-from-martijnhols-actions-cache">heavily customized</a> my <a href="https://github.com/MartijnHols/martijnhols.nl/actions">build pipelines</a> to work within their platform. As a result, I haven't started migrating yet.</p>
<p>GitHub only hosts my repositories and CI; I don't store any personal data on GitHub, nor do I use it to process it. I have copies of my repositories on my computer, plus occasional backups. The only real risk is my Mac's SSD self-destructing at the exact same time; then I'd lose a few days of work.</p>
<p>Still, I rely on GitHub heavily for my projects, so migrating will take time. I'll find a new home for my repositories eventually, but considering the impact, this will probably be the last thing I migrate, so I haven't really explored alternatives yet.</p>
<h3 id="escaping-google-search-almost">Escaping Google search (almost)</h3>
<p>If you've tried alternative search engines, you know: Google search is really, really good. It's very hard to find an alternative that doesn't make you want to switch back.</p>
<p>But I found it: <a href="https://www.startpage.com/">Startpage</a></p>
<figure><figcaption>Try for yourself</figcaption></figure>
<p>Startpage is a Dutch-owned search engine that promises "uncompromising" privacy. Despite that, <strong>I was really surprised by how good its search results are.</strong> Turns out that's because it's actually a Google proxy. Bummer.</p>
<p>It's unclear what Startpage's reliance on Google means for privacy, but it's still much better than using Google directly. It doesn't eliminate the US cloud dependency though. Unfortunately, fully European alternatives that don't make me want to switch back are scarce.</p>
<h3 id="disconnecting-cloudflare-google-dns">Disconnecting Cloudflare/Google DNS</h3>
<p>The promise of optimal DNS performance attracted me to the DNS servers of Cloudflare and Google, but this too comes with privacy issues and reliance on US infrastructure. As part of this de-US-ing, I've opted to replace those with <a href="https://www.quad9.net/">Quad9</a>. Quad9 is a free, Swiss-based DNS service focused on <span role="button" tabindex="0" aria-expanded="false">security</span> and privacy.</p>
<p>Switching to Quad9 is easy; just pop <a href="https://www.quad9.net/service/service-addresses-and-features#rec">their DNS IPs</a> in your router or <a href="https://docs.quad9.net/">install a provisioning profile on mobile</a> and you're done.</p>
<div><p>Aside</p><div><p>This section only covers Cloudflare's DNS servers (1.1.1.1), not its
nameservers or CDN. If you're looking to move away from Cloudflare's CDN,
check out <a href="https://jonathan-frere.com/posts/switching-to-bunny-cdn">Switching to Bunny
CDN</a> by Jonathan
Frere for a relevant experience.</p></div></div>
<h3 id="ditching-docker-hub">Ditching Docker Hub</h3>
<p>Docker Hub (a registry for <span role="button" tabindex="0" aria-expanded="false">Docker images</span>) is essential to my <span role="button" tabindex="0" aria-expanded="false">CD pipeline</span>; it stores the private images that my servers <a href="https://github.com/containrrr/watchtower">automatically pull</a> to install new versions of my apps.</p>
<p>I'm quite eager to move away from Docker Hub. I haven't been a fan of Docker Inc. for a long time; they make it really obvious their focus is entirely on enterprise customers. Docker started going downhill when they <a href="https://reddit.com/r/docker/comments/85w2vd/docker_cloud_is_shutting_down/">shut down Docker Cloud</a>. Later, they even canceled my subscription based on their "fair use" clause because they misinterpreted their logs (they were counting <a href="https://github.com/containrrr/watchtower/discussions/668">HTTP HEAD requests</a> as image pulls).</p>
<p>Since my needs are simple, I initially considered self-hosting a Docker registry with a European S3-compatible backend, looking at <del><span role="button" tabindex="0" aria-expanded="false">OVH</span></del> and <a href="https://www.scaleway.com/en/object-storage/">Scaleway Object Storage</a>. But the self-hosted Docker registries seemed to require too much complexity and it just didn't seem worth the overhead.</p>
<p>Instead, I went with <a href="https://www.scaleway.com/en/container-registry/">Scaleway Container Registry</a>. It's fully managed, straightforward to use, and keeps my images in the EU. In the end it took me less than two hours to setup and will probably cost me <span role="button" tabindex="0" aria-expanded="false">less than €1 per month</span>. Can't beat that.</p>
<h3 id="npm">NPM</h3>
<p>For NPM (a Node package registry), a key challenge is the reliance on public <span role="button" tabindex="0" aria-expanded="false">packages</span>. These are downloaded and installed in every CI build and every time someone clones the project. While these are heavily cached, NPM becoming unavailable would break most tooling.</p>
<p>Unfortunately I couldn't find any public European NPM mirrors (let me know if I missed any). I think this is because most large companies host their own private mirrors. I've used <a href="https://verdaccio.org/">Verdaccio</a> before as a private registry and cache, and setting it up should be fairly easy with a Docker image.</p>
<p>However, this requires setting up persistent storage first. I'll sort this out shortly after publishing this article. Once that's ready, I'll set up Verdaccio. That way, if NPM becomes unavailable, I'll still have access to the versions I've been using, and others can use that registry to get started.</p>
<h2 id="wrapping-up">Wrapping up</h2>
<p><strong>Migrating away from US cloud services was easier than I expected.</strong> While there are still some challenges to tackle, migrating my most important dependency (Microsoft 365) took just an afternoon. This is mostly thanks to Proton, which turned out to be a surprisingly good alternative to Microsoft 365.</p>
<p>Replacing Docker Hub required more research, mainly because I hadn't set up a custom registry or persistent storage before – something I should have solved ages ago.</p>
<p>Other services, such as GitHub, will take longer. But it's on my list and seems within reach. It even seems fun to explore European alternatives. Or maybe I'll self-host something.</p>
<p>Google Search, on the other hand, still feels unbeatable. <span role="button" tabindex="0" aria-expanded="false">Hopefully more alternatives will pop up</span>, but for now using a more privacy-focused proxy seems to be the only viable option.</p>
<p>If you're thinking about reducing your reliance on US cloud services, now is a good time to make it so. The risks, both in terms of privacy and control over your infrastructure, are getting harder to ignore. As my experience shows, some migrations may be a lot easier than you'd expect.</p>
<p>At the very least, think twice before signing up for <em>new</em> US services. Consider European services instead.</p>
<p>If you've gone through a similar transition, I'd love to hear what worked (or didn't work) for you.</p></div></article></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Block YouTube ads on AppleTV by decrypting and stripping ads from Profobuf (432 pts)]]></title>
            <link>https://ericdraken.com/pfsense-decrypt-ad-traffic/</link>
            <guid>43396735</guid>
            <pubDate>Tue, 18 Mar 2025 07:59:50 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://ericdraken.com/pfsense-decrypt-ad-traffic/">https://ericdraken.com/pfsense-decrypt-ad-traffic/</a>, See on <a href="https://news.ycombinator.com/item?id=43396735">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="page"><main id="main" role="main"><article id="post-5418"><p><a href="https://ericdraken.com/files/So-many-YouTube-ads.png"><img src="https://ericdraken.com/files/So-many-YouTube-ads-754x240.png" alt="So many ads" width="754" height="240" srcset="https://ericdraken.com/files/So-many-YouTube-ads.png 754w, https://ericdraken.com/files/So-many-YouTube-ads-300x95.png 300w, https://static.ericdraken.com/files/So-many-YouTube-ads-600x191.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/So-many-YouTube-ads-754x240.png" data-srcset="https://ericdraken.com/files/So-many-YouTube-ads.png 754w, https://ericdraken.com/files/So-many-YouTube-ads-300x95.png 300w, https://static.ericdraken.com/files/So-many-YouTube-ads-600x191.png 600w"></a></p><div><p><span>In a Nutshell</span></p><p>I discovered that putting a man-in-the-middle proxy between my Apple TV and the world lets me decrypt HTTPS traffic. From there, I can read the Protocol Buffer data Google uses to populate YouTube with ads. It is too CPU-intensive to decode Protobuf on the fly, so instead, I found a flaw in the Protobuf format which allows me to reliably change one byte to obliterate ads.</p><p>What follows is a reference guide for setting up a bare-metal network router to block malicious ads, obnoxious ads, tracking, clickbait, crypto-jackers, scam popups, Windows spying on you, etc. using blocklists to protect all networked devices.</p></div><hr><div><p><strong>Goal:</strong> Let’s build a cryptographically-strong router with FreeBSD and pfSense to completely block YouTube ads using a flaw in the Google Protocol Buffer format to completely block pre-roll, mid-roll, and end-roll YouTube ads on Apple TV and iPhones, network-wide.</p></div><div><p><strong>Disclaimer:</strong> I want to support content creators, so to be fair, after a few months of blocking YouTube ads, I am now paying for YouTube Premium; Just because I can break something, doesn’t mean I need to.</p></div><h2>Sections</h2><h3>Part 1 – Setup pfSense on Bare-Metal</h3><ol><li><a href="#why">Why block Ads and Behaviour Tracking?</a></li><li><a href="#hardware">Required Router Hardware</a></li><li><a href="#unboxing">Unboxing the Hardware</a></li><li><a href="#install">Install pfSense on Bare Metal</a></li><li><a href="#firstboot">First pfSense Boot</a></li><li><a href="#aes-ni">Enable the AES-NI Cryptographic Instruction</a></li><li><a href="#ramdisk">Enable RAM Disk</a></li><li><a href="#dashboard">Dashboard Widgets</a></li><li><a href="#pfblocker">Adblocking with pfBlockerNG</a></li><li><a href="#topology">Isolate LANs for Security</a></li><li><a href="#classb">Class B IPv4 172.31.1.0/24 Network for Untrusted Devices</a></li><li><a href="#firewall">Add Firewall Rules</a></li></ol><h3>Part 2 – Isolate Network LANs</h3><ol><li><a href="#untrusted-ap">Setup the Untrusted Wi-Fi AP</a></li><li><a href="#backups">Automatic pfSense Configuration Backups</a></li><li><a href="#bridge">Unable to Reach 172.31.1.x from 192.168.10.x</a></li><li><a href="#firmware">Replace Stock Firmware on the AC1200 Wi-Fi Access Point</a></li><li><a href="#r7000">Archer C5 v2 into the Refuse Bin, R7000 as the New Wi-Fi AP</a></li><li><a href="#wireless">Set up the Trusted Wireless Network</a></li><li><a href="#check">Network Devices Interconnectivity Check</a></li><li><a href="#sharing">Windows File Sharing Gotchas</a></li><li><a href="#psa">Public Service Announcement: Edge Browser</a></li></ol><h3>Part 3 – Setup DNS Adblocking</h3><ol><li><a href="#clickbait">Block Clickbait, Incessant Ads, and Dangerous Sites</a></li><li><a href="#trap-dns">Intercept all DNS Requests, Even to Hardcoded DNS Servers</a></li></ol><h3>Part 4 – Trick the YouTube Ad Algorithm</h3><ol><li><a href="#yt-ads">How to Restrict Apple TV YouTube Ads?</a></li><li><a href="#algo">Trick the YouTube Ad Algorithm Instead</a></li><li><a href="#ad-spend">Research into YouTube Advertizing Spend</a></li><li><a href="#new-goal-trick">New Goal: Convince YouTube I’m 70 and in Italy</a></li><li><a href="#route-vpn">Selectively Route Apple TV Over the VPN</a></li><li><a href="#route-youtube">Selectively Route Apple TV YouTube Traffic Over the VPN</a></li><li><a href="#gotcha-dns">Gotcha: DNS Race Condition</a></li><li><a href="#gotcha-403">Gotcha: Authentication Trouble, Forbidden 403 Error</a></li><li><a href="#gotcha-uk">Gotcha: YouTube is Now Showing UK Ads, Not Italian Ads</a></li><li><a href="#asn">Find a VPN Exit Node with no ASN Leak</a></li><li><a href="#dynamic-dns">Hijack Google Video DNS Queries</a></li><li><a href="#new-goal">New Goal: Programmatically add IPs to the Firewall Policy Rule</a></li><li><a href="#research-dns">Research Python Methods to Hijack DNS Queries</a><br>i. <a href="#rsync">Rsync Disk Backup</a><br>ii. <a href="#rest-api">Install pfSense REST API</a><br>iii. <a href="#unbound-python">Explore the Unbound Python Module</a></li><li><a href="#hijack-smoke">Smoke Test: A Python DNS Hijacking Script</a></li></ol><h3>Part 5 – Decrypt HTTPS Traffic</h3><ol><li><a href="#new-goal2">New Goal: Research and install a Squid-like proxy</a><br>i. <a href="#jailbreak">Fun fact: Jailbreaking iPhones in Japan</a></li><li><a href="#fake-ca">Install a Fake-but-Trusted CA Cert on Apple TV and iPhone?</a></li><li><a href="#squid">Experiment with Squid and SquidGuard</a></li><li><a href="#self-host">Self-Host the CA Certificate</a></li><li><a href="#bye-squid">Abandoning Squid: Too Slow, Too Heavy</a><br>i. <a href="#rsync-diff">Rsync Diff of Changes</a></li><li><a href="#mitmproxy">Install MITMProxy in a FreeBSD Jail</a></li><li><a href="#explore">Exploring MITMProxy</a></li><li><a href="#patch">Patch MITMProxy Source Code for Server SNI Interrogation</a></li></ol><h3>Part 6 – Intercept Apple TV and iOS YouTube Ads</h3><ol><li><a href="#smoke-block">Smoke Test: Intercept YouTube Ads with MITMProxy</a></li><li><a href="#ublock">Examine uBlock Origin Regex Patterns for Inspiration</a></li><li><a href="#alter-json">Surgically Alter the JSON Response to Remove Ads</a></li><li><a href="#protobuf">The iOS YouTube App Uses Protobuf, not JSON</a></li><li><a href="#timing">Timing Analysis to Detect Ad Videos?</a></li><li><a href="#decode-pb">Decode the YouTube Protobuf Responses</a></li><li><a href="#poly">Ad URL Polymorphism</a></li><li><a href="#smoke-proto">Smoke Test: Intercept and Decode Protobuf in Python</a><br>i. <a href="#pure-python">Pure Python Benchmarks</a><br>ii. <a href="#pure-cpp">Pure C++ Benchmarks</a></li><li><a href="#fuzzing">Fuzzing the YouTube Video Ad Responses</a></li><li><a href="#burp">Enter Burp Suite Tools for Penetration Testing</a></li><li><a href="#exfil">Exfil the Proto Schemas from the App, Cleanly?</a></li></ol><h3>Part 7 – Reverse-Engineer Protobuf Messages</h3><ol><li><a href="#deepdive">Hardcore Deep-Dive into Protobuf and Wire Format</a></li><li><a href="#protobuf-flaw">Exploit a Protobuf Flaw to Easily Remove All Ads by Changing One Byte</a></li><li><a href="#smoke-remove">Smoke Test: Remove Ads from Protobuf in O(n)-Time</a></li><li><a href="#analysis">Analysis of this Successful Adblocking Technique</a><br>i. <a href="#analysis-summary">Summary</a><br>ii. <a href="#analysis-timing">Timing Analysis</a><br>iii. <a href="#analysis-benefits">Knock-On Benefits</a><br>iv. <a href="#analysis-future">Future-Proof</a><br>v. <a href="#analysis-worried">Should Google be Worried?</a></li><li><a href="#script">The MITMProxy YouTube Adblocking Script</a></li></ol><h3>Part 8 – Summary</h3><ol><li><a href="#youtube-premium">YouTube Premium</a><br>i. <a href="#experiment">Experiment in Ad Viewing</a><br>ii. <a href="#cpv-15">$0.15 as a Ballpark CPV</a><br>iii. <a href="#cpv-1">CPV from US Advertising Spend Divided by Total Views</a><br>iv. <a href="#worth-it">Is YouTube Premium Worth It?</a></li><li><a href="#dmca">DMCA, Sony, Viacom</a></li><li><a href="#summary">Summary of Accomplishments</a></li></ol><hr><h2>Why block Malicious Ads and Behaviour Tracking?</h2><p>You are a valuable commodity that is bought and sold without your knowledge or consent. You will be tricked with clickbait, distracted with large ads, and enticed to leave the site you are on at every opportunity. Plus, everything you do online is being monitored so your habits and searches can be remarketed and sold over and over again for years.</p><p><a href="https://ericdraken.com/files/clickbait.png"><img src="https://ericdraken.com/files/clickbait-754x325.png" alt="clickbait" width="754" height="325" srcset="https://ericdraken.com/files/clickbait-754x325.png 754w, https://static.ericdraken.com/files/clickbait-300x129.png 300w, https://ericdraken.com/files/clickbait-600x259.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/clickbait-754x325.png" data-srcset="https://ericdraken.com/files/clickbait-754x325.png 754w, https://static.ericdraken.com/files/clickbait-300x129.png 300w, https://ericdraken.com/files/clickbait-600x259.png 600w"></a></p><p><strong>Privacy</strong> – Knowing what you like to watch and read, what phone you have, what you watch on Netflix, what you shop for, what you ask Alexa about, yout taste in music, etc. is <em>unbelievably</em> valuable to advertisers. Spying on people is such a big problem that Europe passed the <a href="https://en.wikipedia.org/wiki/General_Data_Protection_Regulation" target="_blank" rel="nofollow">GDPR law</a> so every site you visit asks if you are okay with cookies (and we blindly click “ok” to hide the banner). We must wrestle back privacy ourselves.</p><p><strong>Bandwidth</strong> – If privacy doesn’t concern you, how about this: it is well-known that between 25% and 40% of network traffic is ads, tracking, JavaScript to load trackers (<a href="https://github.com/fingerprintjs/fingerprintjs" target="_blank" rel="nofollow">fingerprint.js</a>, <a href="https://www.npmjs.com/package/@analytics/google-tag-manager" target="_blank" rel="nofollow">googletagmanager.js</a>), websocket traffic to collect how you scroll and what you type (<a href="https://www.hotjar.com/" target="_blank" rel="nofollow">Hotjar</a>), and the like. Do you have a 100 Mbps internet connection? Consider it 60 Mbps!</p><p><strong>Clickbait</strong> – Then there is clickbait. “You won’t believe what Tom Cruise did. He…” and you may want to click. Then you are in the spider’s web. How about fake news? Or articles that don’t say “sponsored” in size-8 font, but now say “underscored” to be clever. What is even real anymore? As soon as you click on clickbait, you may end up on a page with a dozen more ads that aren’t approved by Google but lead to a dark world of maliciousness. <strong>Clickbait is so incredibly profitable to scammers.</strong></p><p><strong>Cryptojacking</strong> – Some websites will load crypto-mining JavaScript (e.g. <a href="https://www.fortinet.com/blog/threat-research/the-growing-trend-of-coin-miner-javascript-infection" target="_blank" rel="nofollow">CoinHive.js</a>) so while you read, they overheat and abuse your computer to try to make a few pennies. Some sites will load JavaScript that tries to steal from your crypto wallet or trick you into transferring cryptocurrency.</p><div><p><strong>Takeaway:</strong> It is highly lucrative yet detrimental to you to track and trick you, and only <em>you</em> can do something about it.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Required Router Hardware</h2><p>A virtual machine, Docker image, or Raspberry Pi are not performant enough to protect a whole SMB network; We need dedicated hardware with a cryptographic instruction set so that its only function is to route, decrypt, and monitor packets in and out. Here is what I used.</p><ul><li>A mini PC with the AES-NI instruction set (e.g. J4125)</li><li>Several gigabytes of DDR4 RAM (e.g. 32 GiB)</li><li>A decent mSATA SSD drive (e.g. 128 GiB)</li><li>A USB drive to transfer pfSense</li></ul><p><a href="#top">Top ↩</a></p><hr><h2>Unboxing the Hardware</h2><p>I’ve ordered a mini J4125 PC from AliExpress, ordered 32 GB of DDR4 RAM and a 128 GB mSATA from Amazon, and will assemble them for the first time now.</p><div><p><strong>Warning:</strong> Out of caution, I searched diligently for a barebones mini PC that did not include RAM or an SSD; there is nothing stopping an overseas seller from including some generic RAM and SSD but charging Samsung prices.</p></div><div><p><strong>Tip:</strong> 128 GB of disk space on a router? Yup. That should be plenty of space to hold logs and not wear down the SSD too quickly, <strong>and</strong> to allow beautiful packet capture (and maybe an edge cache for NPM and Docker?).</p></div><p>A beautiful box, isn’t it? It only has 3 LAN ports, but it can be extended with network switches.</p><figure id="attachment_5543"><a href="https://static.ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC.jpg"><img src="https://static.ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-754x533.jpg" alt="The J4125 AES-NI quad-core fanless mini PC" width="754" height="533" srcset="https://static.ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-754x533.jpg 754w, https://static.ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-300x212.jpg 300w, https://ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-600x424.jpg 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-754x533.jpg" data-srcset="https://static.ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-754x533.jpg 754w, https://static.ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-300x212.jpg 300w, https://ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-600x424.jpg 600w"></a><figcaption>The J4125 AES-NI quad-core fanless mini PC</figcaption></figure><figure id="attachment_5544"><a href="https://static.ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC.jpg"><img src="https://ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-754x523.jpg" alt="The J4125 pfSense router from a fanless mini PC" width="754" height="523" srcset="https://ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-754x523.jpg 754w, https://static.ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-300x208.jpg 300w, https://ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-600x416.jpg 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-754x523.jpg" data-srcset="https://ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-754x523.jpg 754w, https://static.ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-300x208.jpg 300w, https://ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-600x416.jpg 600w"></a><figcaption>The pfSense router from a J4125 fanless mini PC</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Install pfSense on Bare Metal</h2><p>I’ve never used <a href="https://www.pfsense.org/getting-started/" target="_blank" rel="nofollow">pfSense</a> before, so we will explore this together. The compressed image is about 360 MB and can be flashed to a USB drive with an AppImage binary of Etcher (very cool). Decisions, decisions: VGA install or serial? Let’s serial into the new router. Why not?</p><figure id="attachment_5549"><a href="https://static.ericdraken.com/files/Lets-not-serial-into-the-router.jpg"><img src="https://static.ericdraken.com/files/Lets-not-serial-into-the-router-754x407.jpg" alt="Let's not serial into the router" width="754" height="407" srcset="https://static.ericdraken.com/files/Lets-not-serial-into-the-router-754x407.jpg 754w, https://ericdraken.com/files/Lets-not-serial-into-the-router-300x162.jpg 300w, https://static.ericdraken.com/files/Lets-not-serial-into-the-router-600x324.jpg 600w, https://static.ericdraken.com/files/Lets-not-serial-into-the-router.jpg 1066w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Lets-not-serial-into-the-router-754x407.jpg" data-srcset="https://static.ericdraken.com/files/Lets-not-serial-into-the-router-754x407.jpg 754w, https://ericdraken.com/files/Lets-not-serial-into-the-router-300x162.jpg 300w, https://static.ericdraken.com/files/Lets-not-serial-into-the-router-600x324.jpg 600w, https://static.ericdraken.com/files/Lets-not-serial-into-the-router.jpg 1066w"></a><figcaption>Let’s not serial into the router</figcaption></figure><p>Well, that looks painful. It would also be a whole production to serial into the box in case of an emergency because the serial port is inside, and there isn’t even an RS232 or JTAG connector – just some narrow header pins. Yikes. Let’s go with VGA and plug a keyboard into the USB port – get ready to navigate with arrows and tabs.</p><figure id="attachment_5552"><a href="https://static.ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable.jpg"><img src="https://static.ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-754x531.jpg" alt="J4125 mini PC BIOS over a VGA cable" width="754" height="531" srcset="https://static.ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-754x531.jpg 754w, https://static.ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-300x211.jpg 300w, https://ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-600x423.jpg 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-754x531.jpg" data-srcset="https://static.ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-754x531.jpg 754w, https://static.ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-300x211.jpg 300w, https://ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-600x423.jpg 600w"></a><figcaption>J4125 mini PC BIOS over a VGA cable</figcaption></figure><p>I’ll follow this guide on <a href="https://www.youtube.com/watch?v=9kSZ1oM-4ZM" target="_blank" rel="nofollow">YouTube</a>. I’ll pass on encrypting the disk since I would like to avoid entering a passphrase each time the mini PC reboots. A stripe disk is fine since there is only one disk. I have no idea what to expect yet, so I will pass on dropping to a shell for a more advanced configuration.</p><p><a href="#top">Top ↩</a></p><hr><h2>First pfSense Boot</h2><p>I ejected the USB containing the boot image (important) and rebooted the little box. It played a melody on the internal speaker (there is an internal buzzer and thankfully it isn’t very loud).</p><p>Do I need to have a LAN connection already, or can I just start the thing? I’ll just start pfSense and let it complain to me if it wants… and according to the YouTube <a href="https://youtu.be/9kSZ1oM-4ZM?t=610" target="_blank" rel="nofollow">tutorial</a>, I should guess which port is LAN 1. I’ll do that now.</p><p>I figured out that I should set the LAN 1 to a static IP address that is not in my existing router’s DHCP range, so I went with <code>192.168.1.3</code>. Now I can access an admin web portal (<em>admin</em>/<em>pfsense</em>). Hooray.</p><p>Yikes, the mini PC beeped at me and informed me that ‘admin’ has logged in. That startled me a bit, but hey that is pretty neat.</p><figure id="attachment_5553"><a href="https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI.png"><img src="https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-754x500.png" alt="First time logging into pFsense admin UI" width="754" height="500" srcset="https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-754x500.png 754w, https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-300x199.png 300w, https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-600x398.png 600w, https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI.png 890w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-754x500.png" data-srcset="https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-754x500.png 754w, https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-300x199.png 300w, https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-600x398.png 600w, https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI.png 890w"></a><figcaption>First time logging into pFsense admin UI</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Enable the AES-NI Cryptographic Instruction</h2><p>I played around with the wizard, used defaults, and got to the web configurator. The first thing that caught my eye was <code>AES-NI CPU Crypto: Yes (inactive)</code>. I went out of my way to get a mini PC with AES-NI. What gives?</p><p>Ah, this needs to be enabled in System &gt; Advanced &gt; Miscellaneous. Why not auto-detect this and use the best option? I’m glad I spotted that, or else this mini PC might as well be a Celeron J1900 of yesteryear.</p><p><a href="#top">Top ↩</a></p><hr><h2>Enable RAM Disk</h2><p>Having 32 GiB of RAM, let’s take advantage of that and use a generous amount of RAM for <code>/var</code> and <code>/tmp</code>, and since hopefully this 128 GiB SSD has wear levelling, let’s take a RAM Disk backup every hour.</p><figure id="attachment_5521"><a href="https://ericdraken.com/files/Lets-take-advantage-of-RAM-disk.png"><img src="https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-754x258.png" alt="Let's take advantage of RAM disk" width="754" height="258" srcset="https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-754x258.png 754w, https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-300x103.png 300w, https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-600x205.png 600w, https://ericdraken.com/files/Lets-take-advantage-of-RAM-disk.png 1149w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-754x258.png" data-srcset="https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-754x258.png 754w, https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-300x103.png 300w, https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-600x205.png 600w, https://ericdraken.com/files/Lets-take-advantage-of-RAM-disk.png 1149w"></a><figcaption>Let’s take advantage of RAM disk</figcaption></figure><p>Reboot! <code>AES-NI</code> is now active.</p><p><a href="#top">Top ↩</a></p><hr><h2>Dashboard Widgets</h2><p>This dashboard is pretty slick. I’m just discovering that there are widgets that can be added to the Dashboard, including S.M.A.R.T to alert us if the SSD is going bad. Nice.</p><figure id="attachment_5900"><a href="https://ericdraken.com/files/pfSense-dashboard.png"><img src="https://ericdraken.com/files/pfSense-dashboard-754x329.png" alt="Final pfSense dashboard after all setup" width="754" height="329" srcset="https://ericdraken.com/files/pfSense-dashboard-754x329.png 754w, https://static.ericdraken.com/files/pfSense-dashboard-300x131.png 300w, https://static.ericdraken.com/files/pfSense-dashboard-600x262.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/pfSense-dashboard-754x329.png" data-srcset="https://ericdraken.com/files/pfSense-dashboard-754x329.png 754w, https://static.ericdraken.com/files/pfSense-dashboard-300x131.png 300w, https://static.ericdraken.com/files/pfSense-dashboard-600x262.png 600w"></a><figcaption>Final pfSense dashboard after all setup</figcaption></figure><p>Hang on, when I added the Services Status widget, something called <code>PC/SC Smart Card Daemon</code> shows up. What is that? Research shows it’s a daemon for hardware smart keys that we can probably do without(?). It can be disabled in the <code>/etc/rc.bootup</code> file like so:</p><div id="crayon-63661eaabe474366916701" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>/</span><span>*</span><span> </span><span>pcscd </span><span>daemon </span><span>must </span><span>be </span><span>started </span><span>before </span><span>IPsec</span><span> </span><span>*</span><span>/</span></p><p><span>echo</span><span> </span><span>"SKIPPING PC/SC Smart Card Services..."</span><span>;</span></p><p><span># echo "Starting PC/SC Smart Card Services...";</span></p><p><span># mwexec_bg("/usr/local/sbin/pcscd");</span></p><p><span># echo "done.\n";</span></p></div></td></tr></tbody></table></div><p>Wait. After some time went by, I noticed the router slowed down, fatally.</p><figure id="attachment_5721"><a href="https://ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router.png"><img src="https://static.ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-754x475.png" alt="IPsec without the SD Card Service will cripple the router" width="754" height="475" srcset="https://static.ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-754x475.png 754w, https://ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-300x189.png 300w, https://static.ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-600x378.png 600w, https://ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router.png 923w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-754x475.png" data-srcset="https://static.ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-754x475.png 754w, https://ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-300x189.png 300w, https://static.ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-600x378.png 600w, https://ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router.png 923w"></a><figcaption>IPsec without the SD Card Service will cripple the router</figcaption></figure><div><p><strong>Warning:</strong> Do NOT try to disable the Smart Card Service as it is needed by IPsec; if you start experimenting with an IPsec VPN tunnel and the <code>pcscd</code> daemon is disabled, then your hard disk will fill up with logs and your CPU will run hot.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Adblocking with pfBlockerNG</h2><p>This unboxing and setup has been fun, but I’d like to block all the bad traffic on my network. I’ve been using a workhorse of a DNS-level adblocker called <a href="https://ericdraken.com/block-malicious-ads-with-pi-hole/" target="_blank">Pi-Hole</a> on a… yes, Pi, but it would be nice if I can reclaim that wee bit of hardware for something else and use a comparable add-on module in pfSense. Let’s explore that now.</p><blockquote><p>pfBlockerNG is a very powerful package for pfSense® which provides advertisement and malicious content blocking along with geo-blocking capabilities.</p></blockquote><p>Question: Do I install the first <code>pfBlockerNG</code> or the <code>pfBlockerNG-devel</code> which feels like a developer version? I’m a software developer, so this is for me, but am I a pfSense developer? No. Maybe it will show me advanced logs or I can mess about with LUA? Let’s Google this.</p><p>From <a href="https://forum.netgate.com/topic/156604/pfblockerng-vs-pfblockerng-devel" target="_blank" rel="nofollow">here</a>, random people are saying to install the development version. Another <a href="https://linuxincluded.com/block-ads-malvertising-on-pfsense-using-pfblockerng-dnsbl/" target="_blank" rel="nofollow">blogger</a> advocates using the dev version as well. Meh, I guess we can install <code>jq</code>, <code>rsync</code>, and Python 3.8. This doesn’t <em>feel</em> like a development version since it has exciting dependencies.</p><figure id="attachment_5522"><a href="https://static.ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one.png"><img src="https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-754x428.png" alt="Install pfBlockerNG-devel not the other one" width="754" height="428" srcset="https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-754x428.png 754w, https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-300x170.png 300w, https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-600x341.png 600w, https://static.ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one.png 1144w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-754x428.png" data-srcset="https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-754x428.png 754w, https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-300x170.png 300w, https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-600x341.png 600w, https://static.ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one.png 1144w"></a><figcaption>Install pfBlockerNG-devel not the other one</figcaption></figure><p>That was painless and only added an extra 20 MiB. It seems a lot of the dependencies are part of pfSense already. The knight at the end of Raiders would say that I have chosen wisely (hey, why did Indy age like a normal person up to Indy 4 if he drank the immortality water that the thousand-year-old knight also drank?).</p><div id="crayon-63661eaabe47e463690482" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>New</span><span> </span><span>packages </span><span>to</span><span> </span><span>be </span><span>INSTALLED</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>gmp</span><span>:</span><span> </span><span>6.2.1</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>grepcidr</span><span>:</span><span> </span><span>2.0</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>iprange</span><span>:</span><span> </span><span>1.0.4</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>jq</span><span>:</span><span> </span><span>1.6</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>libmaxminddb</span><span>:</span><span> </span><span>1.6.0</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>lighttpd</span><span>:</span><span> </span><span>1.4.59</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>lua52</span><span>:</span><span> </span><span>5.2.4</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>nettle</span><span>:</span><span> </span><span>3.7.2_2</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>pfSense</span><span>-</span><span>pkg</span><span>-</span><span>pfBlockerNG</span><span>-</span><span>devel</span><span>:</span><span> </span><span>3.1.0</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>py38</span><span>-</span><span>maxminddb</span><span>:</span><span> </span><span>2.0.3</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>py38</span><span>-</span><span>sqlite3</span><span>:</span><span> </span><span>3.8.10_7</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>rsync</span><span>:</span><span> </span><span>3.2.3_1</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>whois</span><span>:</span><span> </span><span>5.5.7</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>xxhash</span><span>:</span><span> </span><span>0.8.0</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>zstd</span><span>:</span><span> </span><span>1.5.0</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p></div></td></tr></tbody></table></div><p>Wizard time.</p><figure id="attachment_5523"><a href="https://static.ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one.png"><img src="https://static.ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-754x269.png" alt="The pfBlockerNG wizard had four steps but step three is like 50 steps in one" width="754" height="269" srcset="https://static.ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-754x269.png 754w, https://ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-300x107.png 300w, https://ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-600x214.png 600w, https://static.ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one.png 1151w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-754x269.png" data-srcset="https://static.ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-754x269.png 754w, https://ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-300x107.png 300w, https://ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-600x214.png 600w, https://static.ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one.png 1151w"></a><figcaption>The pfBlockerNG wizard had four steps but step three is like 50 steps in one</figcaption></figure><p>There are a lot of options in step three. This is not like Pi-hole at all. I’m going to <a href="https://www.youtube.com/watch?v=xizAeAqYde4" target="_blank" rel="nofollow">come back to this</a> and set up my network instead so I accomplish retiring my Nighthawk R700 or giving it new life as a Wi-Fi AP.</p><div><p><strong>Fix:</strong> If the <code>pfb_dnsbl</code> service won’t start or the status tab states <code>[ Missing CRON task ]</code>, try deleting the empty file <code>/var/run/booting</code> (<a href="https://www.reddit.com/r/pfBlockerNG/comments/9x5sid/pfb_dnsbl_service_will_not_start/" target="_blank" rel="nofollow">ref</a>).</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Isolate LANs for Security</h2><p>An opportunity has presented itself: I can create real networks on each of the three router Gigabit ports (not VLANs), and should I do so? Yes, yes I should. I would like a dedicated hardware network for all my home-phoning spy devices (Alexas and Apple TV) so they don’t flood my network with metrics info and “sure I’m muted and not listening to you” audio payloads back to their HQs.</p><p>I can see it now: A Wi-Fi AP on a hardware LAN that is isolated from everything else and dedicated to these gadgets, <strong>and</strong> runs through the adblocker <strong>and</strong> traps hard-coded DNS queries to <code>1.1.1.1</code> and <code>9.9.9.9</code> and others (I’ll have to explore this) so YouTube on my TV doesn’t sneakily bypass <del>Pi-Hole</del> any DNS-level blocker. It’s so Utopian an outcome I may not be able to sleep.</p><p>I’ve decided that my bottom-shelf TP-Link wireless router that is so old that <code>AC1200</code> might as well be “A.D. 1200” is going to be my Wi-Fi AP for those IoT spy devices.</p><p>In sum, there will be a dedicated hardware LAN</p><ul><li>with a wireless AP (AC1200) for Amazon/Apple gadgets and the TV.</li><li>with a wired switch for all the beefy computers and clusters in my lab.</li><li>with another wireless AP (R7000) just for iPhones and watches.</li></ul><p>As an aside, since doing an Offensive Security hacking course in my spare time, and I rare-earth-magnet-strongly suggest isolating Wi-Fi devices from any critical LAN segments connected to devices that touch daily banking or stock trading (or crypto wallets).</p><p><a href="#top">Top ↩</a></p><hr><h2>Class B IPv4 172.31.1.0/24 Network for Untrusted Devices</h2><p>The class B IPv4 range 172.16/16 is a valid range of private IP addresses. I’m not uncomfortable with Alexa and Apple TV being even on the same class network as my main LAN segment, so I will banish them to the class B private network at the hardware level, and my more trusted LANs will be on the traditional class C network (192.168/16). This helps mitigate any misconfigured <code>iptables</code> rules by naturally having no routes between the two networks.</p><figure id="attachment_5524"><a href="https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices.png"><img src="https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-754x371.png" alt="Set up a physical network for the untrusted smart devices" width="754" height="371" srcset="https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-754x371.png 754w, https://static.ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-300x148.png 300w, https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-600x295.png 600w, https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices.png 1146w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-754x371.png" data-srcset="https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-754x371.png 754w, https://static.ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-300x148.png 300w, https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-600x295.png 600w, https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices.png 1146w"></a><figcaption>Set up a physical network for the untrusted smart devices</figcaption></figure><p>Be sure to enable the DHCP resolver on the physical NIC that will connect smart devices (which mainly just tell me the weather and creepily listen to me sleep).</p><p>From this point, DHCP works on this new network, but by default, it assigns IP addresses but does <em>no</em> routing. All traffic is blocked by default.</p><p><a href="#top">Top ↩</a></p><hr><h2>Add Firewall Rules</h2><p>We need to manually add rules so traffic on the physical NICs goe somewhere.</p><figure id="attachment_5525"><a href="https://ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet.png"><img src="https://static.ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-754x252.png" alt="Our first rule to allow eth3 to access the Internet" width="754" height="252" srcset="https://static.ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-754x252.png 754w, https://ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-300x100.png 300w, https://ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-600x200.png 600w, https://ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet.png 1157w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-754x252.png" data-srcset="https://static.ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-754x252.png 754w, https://ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-300x100.png 300w, https://ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-600x200.png 600w, https://ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet.png 1157w"></a><figcaption>Our first rule to allow eth3 to access the Internet</figcaption></figure><p>There is a logging message. Let me reproduce it below.</p><blockquote><p>Hint: the firewall has limited local log space. Don’t turn on logging for everything.</p></blockquote><p>I read that to mean, “Congratulations on not cheaping out on your SSD. Now go forth and log everything, my son.”</p><p>I’m not a new-age, fancy-jazz, coloured-light- or smart-plug-controlling guy who forgot how to turn on a light without his phone, so I do not need to have smart devices on the same network as my phone (why create dozens of wireless attack vectors into your home?). I’m classicly trained to actuate an electromechanical current interrupter on the wall and light let there be.</p><p><a href="#top">Top ↩</a></p><hr><h2>Setup the Untrusted Wi-Fi AP</h2><p>How do I reach the admin UI of AC1200 Wi-Fi AP now? I factory reset it, plugged the WAN NIC into the ETH3 NIC of the pfSense router, but both devices are just blinking at me.</p><p>I suppose I can just Wi-Fi into the factory-reset AC1200. Yikes, 2016 was a bad year for responsive web UIs I take it. This is horrible; I’ll pull out a netbook for this. One sec.</p><p>It seems the Archer C5 has no AP Mode. This is my problem, not yours, but I’m still going to vent.</p><p>Oh, and the “refresh” icon on the top of the DCHP Leases page in pfSense is not “refresh”, but “reload service”. Whoops.</p><p>Well, I bricked the AC1200 router. I will have to run an Ethernet cable manually… but, wait, my thin notebook has no Ethernet ports and needs a USB-NIC adapter. Happy Friday.</p><div><p><strong>Tip:</strong> Connect LAN to LAN, not the AP’s WAN to pfSense’s LAN unless you want to do double NATing.</p></div><p>There were shenanigans, but I set the LAN IP of the AC1200 to <code>172.31.1.100</code>, the ETH3 NIC IP of the pfSense router to <code>172.31.1.1/24</code>, and set the pfSense DHCP service on ETH3 to assign addresses <code>172.31.1.101~150</code>. What <em>failed</em> was setting the AC1200 to <code>172.31.1.2</code> as it was unreachable (reason unknown). Oh yes, I had to turn off firewally things and <code>NAT Boost</code>, and basically drop the horsepower of this TP-Link router down to that of a potato battery. The above settings allow me to access the AC1200 remotely now.</p><p>The other video ran its course, so I started following this <a href="https://www.youtube.com/watch?v=FPgPHJvLmh0" target="_blank" rel="nofollow">YouTube video</a> (set the speed to 1.5x).</p><figure id="attachment_5526"><a href="https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads.jpg"><img src="https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-754x474.jpg" alt="There are some good tutorials on advanced pfSense... if you can sit through the ads" width="754" height="474" srcset="https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-754x474.jpg 754w, https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-300x189.jpg 300w, https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-600x377.jpg 600w, https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads.jpg 965w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-754x474.jpg" data-srcset="https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-754x474.jpg 754w, https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-300x189.jpg 300w, https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-600x377.jpg 600w, https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads.jpg 965w"></a><figcaption>There are some good tutorials on advanced pfSense… if you can sit through the ads</figcaption></figure><p>One more thing: I installed the <code>nmap</code> package for pfSense and scanned the AC1200 router, and found some sneaky ports open.</p><div id="crayon-63661eaabe487832563043" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>Running</span><span>:</span><span> </span><span>/</span><span>usr</span><span>/</span><span>local</span><span>/</span><span>bin</span><span>/</span><span>nmap</span><span>&nbsp;&nbsp;</span><span>-</span><span>sT</span><span> </span><span>-</span><span>P0</span><span> </span><span>-</span><span>e</span><span> </span><span>igb1</span><span> </span><span>'172.31.1.100'</span></p><p><span>Starting </span><span>Nmap</span><span> </span><span>7.91</span><span> </span><span>(</span><span> </span><span>https</span><span>:</span><span>/</span><span>/</span><span>nmap</span><span>.org</span><span> </span><span>)</span><span> </span><span>at</span><span> </span><span>2021</span><span>-</span><span>11</span><span>-</span><span>15</span><span> </span><span>17</span><span>:</span><span>40</span><span> </span><span>PST</span></p><p><span>Nmap </span><span>scan </span><span>report </span><span>for</span><span> </span><span>172.31.1.100</span></p><p><span>Host </span><span>is</span><span> </span><span>up</span><span> </span><span>(</span><span>0.0017s</span><span> </span><span>latency</span><span>)</span><span>.</span></p><p><span>Not</span><span> </span><span>shown</span><span>:</span><span> </span><span>969</span><span> </span><span>closed </span><span>ports</span><span>,</span><span> </span><span>28</span><span> </span><span>filtered </span><span>ports</span></p><p><span>PORT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>STATE </span><span>SERVICE</span></p><p><span>22</span><span>/</span><span>tcp&nbsp;&nbsp;&nbsp;&nbsp;</span><span>open&nbsp;&nbsp;</span><span>ssh</span></p><p><span>80</span><span>/</span><span>tcp&nbsp;&nbsp;&nbsp;&nbsp;</span><span>open&nbsp;&nbsp;</span><span>http</span></p><p><span>20005</span><span>/</span><span>tcp </span><span>open&nbsp;&nbsp;</span><span>btx</span></p></div></td></tr></tbody></table></div><p>Port <code>20005/tcp</code> is a print server port that I’ve now closed. However, the Archer C5 AC1200 is vulnerable to all kinds of Kali <a href="https://www.hackingtutorials.org/wifi-hacking-tutorials/tp-link-archer-c5-router-hacking/" target="_blank" rel="nofollow">mischief</a> so it was wise to put it on its own network. I’m not sure how to close port 22 and the <code>SSHd</code> service on it the AC1200 because the stock firmware is ancient and crippled, so I’ll just have to block port 22 on the whole LAN segment.</p><p>I’ve also taken care of disallowing private networks to ingress on the WAN (see the next section to set up DMZ).</p><p><a href="#top">Top ↩</a></p><hr><h2>Unable to Reach 172.31.1.x from 192.168.10.x</h2><p>Ping and Traceroute are aiding me in my efforts to connect to the AC1200 Wi-Fi AP from my <em>Trusted</em> LAN. I went ahead and added the subnet to the Symantec Firewall rules just in case (Symantec has its place now and then, but yes, definitely have available PC CPU horsepower to spare).</p><figure id="attachment_5529"><a href="https://static.ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet.png"><img src="https://static.ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-754x248.png" alt="Configure Symantec to allow the Untrusted subnet" width="754" height="248" srcset="https://static.ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-754x248.png 754w, https://ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-300x99.png 300w, https://ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-600x197.png 600w, https://static.ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet.png 940w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-754x248.png" data-srcset="https://static.ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-754x248.png 754w, https://ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-300x99.png 300w, https://ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-600x197.png 600w, https://static.ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet.png 940w"></a><figcaption>Configure Symantec to allow the Untrusted subnet</figcaption></figure><p>Now, it seems ICMP packets are no longer blocked between networks, but I still cannot ping the AP web management UI even though I can see the pings in the traffic logs.</p><p>I’ve even added an “any to any” firewall rule on the Untrusted network. No change.</p><div><p><strong>Warning:</strong> If you run <code>nmap</code> as I did, software firewalls may detect a port scan and kick your network connection for an hour by default.</p><p><a href="https://ericdraken.com/files/Disable-Symantec-port-scan-detection.png"><img src="https://ericdraken.com/files/Disable-Symantec-port-scan-detection.png" alt="Disable Symantec port scan detection" width="474" height="647" srcset="https://ericdraken.com/files/Disable-Symantec-port-scan-detection.png 474w, https://static.ericdraken.com/files/Disable-Symantec-port-scan-detection-220x300.png 220w" sizes="(max-width: 474px) 100vw, 474px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Disable-Symantec-port-scan-detection.png" data-srcset="https://ericdraken.com/files/Disable-Symantec-port-scan-detection.png 474w, https://static.ericdraken.com/files/Disable-Symantec-port-scan-detection-220x300.png 220w"></a></p></div><p>Let’s try a stealth scan instead: <code>sudo nmap -sS -v 172.31.1.*</code>.</p><figure id="attachment_5530"><a href="https://ericdraken.com/files/I-think-a-port-scan-has-been-detected.png"><img src="https://ericdraken.com/files/I-think-a-port-scan-has-been-detected-754x319.png" alt="I think a port scan has been detected" width="754" height="319" srcset="https://ericdraken.com/files/I-think-a-port-scan-has-been-detected-754x319.png 754w, https://static.ericdraken.com/files/I-think-a-port-scan-has-been-detected-300x127.png 300w, https://ericdraken.com/files/I-think-a-port-scan-has-been-detected-600x254.png 600w, https://ericdraken.com/files/I-think-a-port-scan-has-been-detected.png 1069w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/I-think-a-port-scan-has-been-detected-754x319.png" data-srcset="https://ericdraken.com/files/I-think-a-port-scan-has-been-detected-754x319.png 754w, https://static.ericdraken.com/files/I-think-a-port-scan-has-been-detected-300x127.png 300w, https://ericdraken.com/files/I-think-a-port-scan-has-been-detected-600x254.png 600w, https://ericdraken.com/files/I-think-a-port-scan-has-been-detected.png 1069w"></a><figcaption>I think a port scan has still been detected</figcaption></figure><p>Nope, pfSense doesn’t like that at all. And, the whole network stopped working. Nice security! Also, dang.</p><p>The good news is that I’ve isolated the packet malaise to the TP-Link AC1200 box itself. I suspect that I need to add <code>net.ipv4.ip_forward=1</code> to forward packets with no addresses in them, but I’d need root access to the AC1200. Let’s burn it to the ground and rebuild from its sprinkler-soaked ashes.</p><p><a href="#top">Top ↩</a></p><hr><h2>Replace Stock Firmware on the AC1200 Wi-Fi Access Point</h2><p>Of course, I cannot actually stop Untrusted LAN devices from reaching the AC1200 as they all exist downstream from the pfSense box.</p><p>DD-WRT open-source router firmware, meet my ancient Archer C5 and do your thing.</p><figure id="attachment_5532"><a href="https://ericdraken.com/files/DD-WRT-supports-the-Archer-C5.png"><img src="https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-754x251.png" alt="DD-WRT supports the Archer C5" width="754" height="251" srcset="https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-754x251.png 754w, https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-300x100.png 300w, https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-600x199.png 600w, https://ericdraken.com/files/DD-WRT-supports-the-Archer-C5.png 954w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-754x251.png" data-srcset="https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-754x251.png 754w, https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-300x100.png 300w, https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-600x199.png 600w, https://ericdraken.com/files/DD-WRT-supports-the-Archer-C5.png 954w"></a><figcaption>DD-WRT supports the Archer C5</figcaption></figure><p>The Archer C5 did not accept the DD-WRT firmware. Hmm… how about OpenWRT?</p><figure id="attachment_5533"><a href="https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5.png"><img src="https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5-754x292.png" alt="OpenWRT supports the Archer C5" width="754" height="292" srcset="https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5-754x292.png 754w, https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5-300x116.png 300w, https://static.ericdraken.com/files/OpenWRT-supports-the-Archer-C5-600x232.png 600w, https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5.png 755w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5-754x292.png" data-srcset="https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5-754x292.png 754w, https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5-300x116.png 300w, https://static.ericdraken.com/files/OpenWRT-supports-the-Archer-C5-600x232.png 600w, https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5.png 755w"></a><figcaption>OpenWRT supports the Archer C5</figcaption></figure><p>The Archer C5 did not accept the OpenWRT firmware either. What the actual facepalm (WTAF)?</p><p><strong>Wait.</strong> My hardware is revision 2 using the Broadcom chipsets which are notoriously difficult networking chips.</p><div><p><strong>Careful:</strong> Devices with Broadcom Wi-Fi chipsets have limited OpenWrt supportability (due to limited FLOSS driver availability for Broadcom chips). (REF: OpenWRT.org)</p></div><p>Alright, so OpenWRT, DD-WRT, and Tomato projects have no firmware for this AC1200 with unpopular Broadcom chipsets. Into the refuse bin it goes.</p><p><a href="#top">Top ↩</a></p><hr><h2>Archer C5 v2 into the Refuse Bin, R7000 as the New Wi-Fi AP</h2><p>I’ve dismantled the AC1200 so I do not forget why I threw it out. It’s too bad because it’s so pretty on the inside, and they always say, “It is what is inside that counts… except if you are a router with Broadcom chips.”</p><figure id="attachment_5534"><a href="https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips.jpg"><img src="https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-754x566.jpg" alt="Inside the Archer C5 v2 with Broadcom chips" width="754" height="566" srcset="https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-754x566.jpg 754w, https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-300x225.jpg 300w, https://ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-600x450.jpg 600w, https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips.jpg 1008w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-754x566.jpg" data-srcset="https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-754x566.jpg 754w, https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-300x225.jpg 300w, https://ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-600x450.jpg 600w, https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips.jpg 1008w"></a><figcaption>Inside the Archer C5 v2 with Broadcom chips</figcaption></figure><p>The R7000 is factory reset, and here is the first problem:</p><div><p><strong>Tip:</strong> On factory reset, the Nighthawk R7000 is pretty uptight about the format of the password. One rule is that no more than two identical consecutive characters are allowed. Well, thanks Netgear for pretty much providing a Regex to password crackers. Let’s disable all those rules with a few keystrokes to delete the JavaScript “blocking” the form submission. Now my admin password does not conform to the Regex and is super long. Muhahaha to Netgear password crackers.</p></div><p>The R7000 is in AP mode, but I can still access the pfSense web management page from the Untrusted network. Let’s lock down the web UI in pfSense under Firewall Rules.</p><figure id="attachment_5847"><a href="https://ericdraken.com/files/Untrusted-network-firewall-rules.png"><img src="https://static.ericdraken.com/files/Untrusted-network-firewall-rules-754x310.png" alt="Untrusted network firewall rules" width="754" height="310" srcset="https://static.ericdraken.com/files/Untrusted-network-firewall-rules-754x310.png 754w, https://ericdraken.com/files/Untrusted-network-firewall-rules-300x124.png 300w, https://static.ericdraken.com/files/Untrusted-network-firewall-rules-600x247.png 600w, https://ericdraken.com/files/Untrusted-network-firewall-rules.png 1156w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Untrusted-network-firewall-rules-754x310.png" data-srcset="https://static.ericdraken.com/files/Untrusted-network-firewall-rules-754x310.png 754w, https://ericdraken.com/files/Untrusted-network-firewall-rules-300x124.png 300w, https://static.ericdraken.com/files/Untrusted-network-firewall-rules-600x247.png 600w, https://ericdraken.com/files/Untrusted-network-firewall-rules.png 1156w"></a><figcaption>Untrusted network firewall rules</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Set up the Trusted Wireless Network</h2><p>The Untrusted network is now looking good. It’s time to make the <em>other</em> R7000 Nighthawk I have into a Wi-Fi AP as well so my phone and watch have a safe place to connect to, as well as a laptop when I want to RDP into my wired machines from the kitchen. I was saving that for a honeypot AP, but I can come back to that later.</p><p>Let’s see if I can Wi-Fi into the Wireless LAN’s R7000…</p><div><p><strong>Tip:</strong> Remember to physically unplug the pfSense upstream router from the R7000 because the R7000 is too helpful and will enter into AP mode by sensing any upstream routers, then you cannot get into the web UI anymore.</p></div><p>Since only my trusted devices should be on the Wireless LAN, I’ll turn off 2.4 GHz wi-fi because anything recent and wireless should support 5 GHz. That means those pesky AliExpress Pineapple wi-fi password stealers on the cheap side only use 2.4 GHz, so a neighbour is going to have to put in some effort to snoop on my network. Plus, 5 GHz is blocked more easily by walls and concrete, so I prefer it for averting medium-range snooping. But, I so am going to set up a honeypot and to brake check my faith in humanity.</p><p>It is normally straightforward to put a Wi-Fi router into AP mode by disabling WAN and DHCP.</p><p><a href="#top">Top ↩</a></p><hr><h2>Network Devices Interconnectivity Check</h2><p>Do all my dozens of computers, laptops, Pis, clusters, NAS drives, and the like still connect as before? Most important is my web-scraping bot in a hardened, RAIDed, dedicated machine with its own UPS. But alas, I cannot SSH into it even though the SSH handshake packets make it to the hefty box.</p><p>Could this be our old frienemy IPv4 forwarding being disabled? Possibly. I’m able to SSH into the machine from my iPhone (seriously) when on the same network.</p><p>Nope. Adding <code>net.ipv4.ip_forward = 1</code> in the right place with a restart did not yield joy.</p><p>According to <code>dmesg -w</code> (to tail <code>dmesg</code> logs), UFW (Uncomplicated Firewall) is not blocking ICMP requests or TCP requests on port 22. When I do something nutty like try to SSH on, say, port 23, then I can see the UFW block logs in <code>dmesg</code>. Confirmed: Packets can reach that machine.</p><p>Running <code>tcpdump src 192.168.10.100</code> where the IP is from the Trusted network on the target machine shows it <em>is</em> responding to pings. I’m even getting replies to SSH handshake requests. So now we know that <em>return</em> packets are being dropped. Interesting! Aside: <code>tcpdump</code> is awesome.</p><p>Let’s follow the trail. Digging a little deeper I see replies to ICMP and SSH handshakes are being sent to some IP over HTTPS that I do not recognize. Bizzare. When I run the usual <code>ipinfo</code> tools I see that <a href="https://ericdraken.com/ssh-using-real-ip-bypass-vpn/" target="_blank">replies are going over a VPN</a> that I completely forgot about. Ha. Replies to a different subnet are egressing over the VPN, but cannot return properly. Neat.</p><figure id="attachment_5438"><a href="https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter.png"><img src="https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-754x303.png" alt="VPN causes ACK packets to return over the wrong adapter" width="754" height="303" srcset="https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-754x303.png 754w, https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-300x121.png 300w, https://static.ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-600x241.png 600w, https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter.png 1056w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-754x303.png" data-srcset="https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-754x303.png 754w, https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-300x121.png 300w, https://static.ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-600x241.png 600w, https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter.png 1056w"></a><figcaption>VPN causes ACK packets to return over the wrong adapter</figcaption></figure><p>Now that I remember what I did in 2019, I re-added NAT alias rules, and it’s showtime again.</p><p><a href="#top">Top ↩</a></p><hr><h2>Windows File Sharing Gotchas</h2><p>Your path may be smoother, but I’ve always seem to make the Trench Run instead of remote-piloting a handful of lead-filled X-Wings at light speed right <em>through</em> the Death Star’s reactor to make it go boom: the easy way.</p><p>I’ve added some rules to allow Static DHCP devices to talk to each other – Windows devices – but by default, the Private Network in the Windows Defender uses the local subnet as the rule scope. That means different subnets are isolated. We can’t just relax the pfSense DHCP subnet mask to say <code>192.168.20.0/16</code> because it conflicts with another subnet. Instead, just to get file sharing working, I relax the <code>scope</code> in Advanced Settings like below. Be sure to modify In and Out for SMB and ICMP.</p><figure id="attachment_5491"><a href="https://ericdraken.com/files/Windows-file-sharing-across-subnets.png"><img src="https://static.ericdraken.com/files/Windows-file-sharing-across-subnets-754x427.png" alt="Windows file sharing across subnets" width="754" height="427" srcset="https://static.ericdraken.com/files/Windows-file-sharing-across-subnets-754x427.png 754w, https://ericdraken.com/files/Windows-file-sharing-across-subnets-300x170.png 300w, https://static.ericdraken.com/files/Windows-file-sharing-across-subnets-600x340.png 600w, https://ericdraken.com/files/Windows-file-sharing-across-subnets.png 1496w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Windows-file-sharing-across-subnets-754x427.png" data-srcset="https://static.ericdraken.com/files/Windows-file-sharing-across-subnets-754x427.png 754w, https://ericdraken.com/files/Windows-file-sharing-across-subnets-300x170.png 300w, https://static.ericdraken.com/files/Windows-file-sharing-across-subnets-600x340.png 600w, https://ericdraken.com/files/Windows-file-sharing-across-subnets.png 1496w"></a><figcaption>Windows file sharing across subnets</figcaption></figure><p>Again, please add whatever subnets you desire instead of <code>any</code>.</p><p><a href="#top">Top ↩</a></p><hr><h2>Public Service Announcement: Edge Browser</h2><p>Why does the Microsoft Edge browser start automatically and run in the background, and why can’t I kill it when I <code>ctrl+alt+del</code>? If you’ve asked yourself this, you’re not alone. It turns out Edge starts up when you log in and it keeps running in the background. Here is the fix:</p><figure id="attachment_5540"><a href="https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser..png"><img src="https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-754x238.png" alt="Prevent Microsoft Edge from starting or running in the background. Sneaky browser." width="754" height="238" srcset="https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-754x238.png 754w, https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-300x95.png 300w, https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-600x190.png 600w, https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser..png 1214w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-754x238.png" data-srcset="https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-754x238.png 754w, https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-300x95.png 300w, https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-600x190.png 600w, https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser..png 1214w"></a><figcaption>Prevent Microsoft Edge from starting or running in the background. Sneaky browser.</figcaption></figure><p>I suggest downloading Winaero Tweaker and applying registry tweaks to cut down on the Redmond Spy Machine.</p><figure id="attachment_5565"><a href="https://ericdraken.com/files/Stop-Microsoft-from-spying-on-you.png"><img src="https://static.ericdraken.com/files/Stop-Microsoft-from-spying-on-you-754x454.png" alt="Stop Microsoft from spying on you" width="754" height="454" srcset="https://static.ericdraken.com/files/Stop-Microsoft-from-spying-on-you-754x454.png 754w, https://static.ericdraken.com/files/Stop-Microsoft-from-spying-on-you-300x181.png 300w, https://ericdraken.com/files/Stop-Microsoft-from-spying-on-you-600x361.png 600w, https://ericdraken.com/files/Stop-Microsoft-from-spying-on-you.png 899w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Stop-Microsoft-from-spying-on-you-754x454.png" data-srcset="https://static.ericdraken.com/files/Stop-Microsoft-from-spying-on-you-754x454.png 754w, https://static.ericdraken.com/files/Stop-Microsoft-from-spying-on-you-300x181.png 300w, https://ericdraken.com/files/Stop-Microsoft-from-spying-on-you-600x361.png 600w, https://ericdraken.com/files/Stop-Microsoft-from-spying-on-you.png 899w"></a><figcaption>Stop Microsoft from spying on you</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Block Clickbait, Endless Ads, and Dangerous Sites</h2><p>Thanks to web-browser and DNS-level adblockers (i.e. Pi-hole), it’s commonplace to block bad sites, crypto-miners, fingerprinters, trackers, remarketers, banners, pop-ups, fake tech-support scam alerts, and all manner of unscrupulousness designed to take advantage of you. Let’s take pfBlockerNG on pfSense for spin.</p><figure id="attachment_5429"><a href="https://static.ericdraken.com/files/pfBlockerNG-blocking-ad-domains.png"><img src="https://ericdraken.com/files/pfBlockerNG-blocking-ad-domains-754x282.png" alt="pfBlockerNG blocking ad domains with graphs" width="754" height="282" srcset="https://ericdraken.com/files/pfBlockerNG-blocking-ad-domains-754x282.png 754w, https://ericdraken.com/files/pfBlockerNG-blocking-ad-domains-300x112.png 300w, https://static.ericdraken.com/files/pfBlockerNG-blocking-ad-domains-600x224.png 600w, https://static.ericdraken.com/files/pfBlockerNG-blocking-ad-domains.png 1149w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/pfBlockerNG-blocking-ad-domains-754x282.png" data-srcset="https://ericdraken.com/files/pfBlockerNG-blocking-ad-domains-754x282.png 754w, https://ericdraken.com/files/pfBlockerNG-blocking-ad-domains-300x112.png 300w, https://static.ericdraken.com/files/pfBlockerNG-blocking-ad-domains-600x224.png 600w, https://static.ericdraken.com/files/pfBlockerNG-blocking-ad-domains.png 1149w"></a><figcaption>pfBlockerNG blocking ad domains with graphs</figcaption></figure><p>The pie chart looks great. I followed this <a href="https://tekgru.com/how-to-block-ads-on-pfsense-with-pfblockerng-and-dnsbl/" target="_blank" rel="nofollow">pfBlockerNG tutorial</a>.</p><figure id="attachment_5433"><a href="https://static.ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog.png"><img src="https://ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-754x396.png" alt="Tekgru.com pfBlockerNG tutorial blog" width="754" height="396" srcset="https://ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-754x396.png 754w, https://static.ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-300x157.png 300w, https://ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-600x315.png 600w, https://static.ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog.png 764w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-754x396.png" data-srcset="https://ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-754x396.png 754w, https://static.ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-300x157.png 300w, https://ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-600x315.png 600w, https://static.ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog.png 764w"></a><figcaption>Tekgru.com pfBlockerNG tutorial blog</figcaption></figure><p><strong><span>This is mportant:</span></strong> If you have multiple network interfaces (the mini PC has four), then you need to enable the Permit Firewall Rules for multiple interfaces and select them.</p><figure id="attachment_5434"><a href="https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces.png"><img src="https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-754x125.png" alt="DNSBL Perfmit Firewall Rules for multiple interfaces" width="754" height="125" srcset="https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-754x125.png 754w, https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-300x50.png 300w, https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-600x100.png 600w, https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces.png 1005w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-754x125.png" data-srcset="https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-754x125.png 754w, https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-300x50.png 300w, https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-600x100.png 600w, https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces.png 1005w"></a><figcaption>DNSBL Perfmit Firewall Rules for multiple interfaces</figcaption></figure><p>Would you like to have discretion over blocklists? Let’s add a DNS blocklist related to gambling and reload pfBlockerNG to see if a poker site is blocked on the Trusted LAN.</p><figure id="attachment_5435"><a href="https://static.ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked.png"><img src="https://ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-754x187.png" alt="Some sketchy poker sites are now blocked" width="754" height="187" srcset="https://ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-754x187.png 754w, https://ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-300x74.png 300w, https://static.ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-600x148.png 600w, https://static.ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked.png 881w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-754x187.png" data-srcset="https://ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-754x187.png 754w, https://ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-300x74.png 300w, https://static.ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-600x148.png 600w, https://static.ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked.png 881w"></a><figcaption>Some sketchy poker sites are now blocked</figcaption></figure><p>If you would prefer the connection to just close instead of rendering a PHP page, create a new PHP script with the following code and select it in the pfBlockerNG settings page:</p><div id="crayon-63661eaabe495363075859" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>&lt;?php</span></p><p><span># nano /usr/local/www/pfblockerng/www/killed.php</span></p><p><span>ignore_user_abort</span><span>(</span><span>true</span><span>)</span><span>;</span></p><p><span>fastcgi_finish_request</span><span>(</span><span>)</span><span>;</span></p></div></td></tr></tbody></table></div><p><a href="#top">Top ↩</a></p><hr><h2>Intercept All DNS Requests, Even to Hardcoded DNS Servers</h2><p>Let’s make sure all clients behind the pfSense router use the local Unbound DNS server so pfBlockerNG can act on them. We do not want apps and home assistants to bypass our DNS server, so we have to add some NAT rules.</p><figure id="attachment_5439"><a href="https://static.ericdraken.com/files/Trap-all-DNS-and-DNSTLS-requests.png"><img src="https://static.ericdraken.com/files/Trap-all-DNS-and-DNSTLS-requests.png" alt="Trap all DNS and DNS+TLS requests" width="563" height="316" srcset="https://static.ericdraken.com/files/Trap-all-DNS-and-DNSTLS-requests.png 563w, https://ericdraken.com/files/Trap-all-DNS-and-DNSTLS-requests-300x168.png 300w" sizes="(max-width: 563px) 100vw, 563px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Trap-all-DNS-and-DNSTLS-requests.png" data-srcset="https://static.ericdraken.com/files/Trap-all-DNS-and-DNSTLS-requests.png 563w, https://ericdraken.com/files/Trap-all-DNS-and-DNSTLS-requests-300x168.png 300w"></a><figcaption>Trap all DNS and DNS+TLS requests</figcaption></figure><p>First, we have to block DNS over TLS (for now) and only allow local DNS requests (note the rule order):</p><figure id="attachment_5655"><a href="https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries.png"><img src="https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-754x386.png" alt="Overarching DNS rules allowing only internal DNS queries" width="754" height="386" srcset="https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-754x386.png 754w, https://ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-300x154.png 300w, https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-600x307.png 600w, https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries.png 949w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-754x386.png" data-srcset="https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-754x386.png 754w, https://ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-300x154.png 300w, https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-600x307.png 600w, https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries.png 949w"></a><figcaption>Overarching DNS rules allowing only internal DNS queries</figcaption></figure><div><p><strong>Note:</strong> DNS over TLS must be blocked (for now) for all clients behind the pfSense router in order to allow DNS query trapping to succeed. An iPhone may show a Privacy Warning that the network is blocking encrypted DNS traffic. That is okay because we are encrypting upstream DNS requests to Cloudflare.</p><p><a href="https://static.ericdraken.com/files/We-can-ignore-the-Privacy-Warning-in-devices-behind-the-pfSense-router.png"><img src="https://static.ericdraken.com/files/We-can-ignore-the-Privacy-Warning-in-devices-behind-the-pfSense-router.png" alt="We can ignore the Privacy Warning in devices behind the pfSense router" width="521" height="489" srcset="https://static.ericdraken.com/files/We-can-ignore-the-Privacy-Warning-in-devices-behind-the-pfSense-router.png 521w, https://ericdraken.com/files/We-can-ignore-the-Privacy-Warning-in-devices-behind-the-pfSense-router-300x282.png 300w" sizes="(max-width: 521px) 100vw, 521px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/We-can-ignore-the-Privacy-Warning-in-devices-behind-the-pfSense-router.png" data-srcset="https://static.ericdraken.com/files/We-can-ignore-the-Privacy-Warning-in-devices-behind-the-pfSense-router.png 521w, https://ericdraken.com/files/We-can-ignore-the-Privacy-Warning-in-devices-behind-the-pfSense-router-300x282.png 300w"></a></p></div><p>Here is a NAT rule for one interface. I started by making a rule for each interface except WAN (obviously) like this below.</p><figure id="attachment_5440"><a href="https://static.ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface.png"><img src="https://ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-754x739.png" alt="Example rule to trap DNS queries on a given interface" width="754" height="739" srcset="https://ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-754x739.png 754w, https://ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-300x294.png 300w, https://static.ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-600x588.png 600w, https://static.ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface.png 1031w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-754x739.png" data-srcset="https://ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-754x739.png 754w, https://ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-300x294.png 300w, https://static.ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-600x588.png 600w, https://static.ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface.png 1031w"></a><figcaption>Example rule to trap DNS queries on a given interface</figcaption></figure><div><p><strong>Tip:</strong> NAT reflection should be disabled so the wild Internet cannot access our DNS server.</p></div><p>To make life simpler, I made a firewall alias of all non-WAN interfaces called <code>Non_WAN</code>. Covering IPv4 and IPV6 to redirect local DNS queries on port 53 to localhost are the following redirect rules:</p><figure id="attachment_5660"><a href="https://ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost.png"><img src="https://ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-754x165.png" alt="Firewall DNS query redirect rules to localhost" width="754" height="165" srcset="https://ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-754x165.png 754w, https://static.ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-300x66.png 300w, https://static.ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-600x131.png 600w, https://ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost.png 945w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-754x165.png" data-srcset="https://ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-754x165.png 754w, https://static.ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-300x66.png 300w, https://static.ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-600x131.png 600w, https://ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost.png 945w"></a><figcaption>Firewall DNS query redirect rules to localhost</figcaption></figure><p>Let’s also log trapped DNS requests. Head to the <code>Services &gt; DNS Resolver</code> page, click “Display Custom Options”, and add the lines:</p><p>Well, hello there, Microsoft Windows. What are you up to trying to reach Google Tag Manager? Naughty OS. That request is now black-holed to a non-existent IP at <code>10.10.10.1</code>.</p><figure id="attachment_5445"><a href="https://static.ericdraken.com/files/Windows-is-trying-to-reach-Google-Tag-Manager.png"><img src="https://static.ericdraken.com/files/Windows-is-trying-to-reach-Google-Tag-Manager.png" alt="Windows is trying to reach Google Tag Manager" width="439" height="476" srcset="https://static.ericdraken.com/files/Windows-is-trying-to-reach-Google-Tag-Manager.png 439w, https://static.ericdraken.com/files/Windows-is-trying-to-reach-Google-Tag-Manager-277x300.png 277w" sizes="(max-width: 439px) 100vw, 439px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Windows-is-trying-to-reach-Google-Tag-Manager.png" data-srcset="https://static.ericdraken.com/files/Windows-is-trying-to-reach-Google-Tag-Manager.png 439w, https://static.ericdraken.com/files/Windows-is-trying-to-reach-Google-Tag-Manager-277x300.png 277w"></a><figcaption>Windows is trying to reach Google Tag Manager</figcaption></figure><p>Let’s turn our attention to the TV and see how it fares under DNS interception.</p><p><a href="#top">Top ↩</a></p><hr><h2>How to Restrict Apple TV and iPhone YouTube Ads?</h2><div><p><strong>YouTube:</strong> Regarding YouTube, YouTube has been showing 7-second and 15-second ads, twice, back-to-back, nearly every few minutes. Why are the ads incessant and so long? I do not mind the occasional ad, similar to live TV, but these frequent ads would warrant FTC complaints it they were on live TV.</p></div><p>YouTube is tricky because ads are also videos that come from the same domain, so domain-name blockers like pfBlockerNG cannot act on them. The best pfBlockerNG and Pi-hole can do is block <code>googleadservices.com</code> only after you watch an ad video and click on the ad.</p><p>Many people opt to use a web browser like Firefox or Chrome with <a href="https://chrome.google.com/webstore/detail/ublock-origin/cjpalhdlnbpafiamejdnhcphjbkeiagm?hl=en" target="_blank" rel="nofollow">uBlock Origin</a> that acts on JavaScript as a workaround. It might be enough to watch YouTube on a web browser and stream that to a smart TV. However, we cannot restrict ads on the iPhone (without jailbreaking and compromising it).</p><p>What are our options? How can we safely restrict YouTube ads on all network devices?</p><p><a href="#top">Top ↩</a></p><hr><h2>Trick the YouTube Ad Algorithm Instead</h2><div><p><strong>Thought Experiment:</strong> Among friends, let’s say that English-speaking countries get ads for the most ridiculous things because their residents are assumed to have disposable income. Can we instead make YouTube think we are an undesirable advertising target?</p></div><p>What do ads in other parts of the world look like? Are those living in Antarctica or <a href="https://xkcd.com/713/" target="_blank" rel="nofollow">Low Earth Orbit</a> getting a lot of ads too?</p><figure id="attachment_5449"><a href="https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers.png"><img src="https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers.png" alt="Xkcd.com: Mess with advertisers" width="683" height="264" srcset="https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers.png 683w, https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers-300x116.png 300w, https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers-600x232.png 600w" sizes="(max-width: 683px) 100vw, 683px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers.png" data-srcset="https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers.png 683w, https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers-300x116.png 300w, https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers-600x232.png 600w"></a><figcaption>Xkcd.com: Mess with advertisers</figcaption></figure><p>What would happen if we leverage the capabilities of this pfSense router to route YouTube Location Tracking information through a VPN that terminates in some remote part of the world with fewer YouTube viewers per capita? In other words, let’s make ourselves undesirable to advertisers and see if we get fewer ads.</p><figure id="attachment_5880"><a href="https://ericdraken.com/files/soured-the-milk.jpg"><img src="https://ericdraken.com/files/soured-the-milk.jpg" alt="Scotty from TNG episode 'Relics' understands the plan" width="620" height="448" srcset="https://ericdraken.com/files/soured-the-milk.jpg 620w, https://ericdraken.com/files/soured-the-milk-300x217.jpg 300w, https://ericdraken.com/files/soured-the-milk-600x434.jpg 600w" sizes="(max-width: 620px) 100vw, 620px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/soured-the-milk.jpg" data-srcset="https://ericdraken.com/files/soured-the-milk.jpg 620w, https://ericdraken.com/files/soured-the-milk-300x217.jpg 300w, https://ericdraken.com/files/soured-the-milk-600x434.jpg 600w"></a><figcaption>Scotty from TNG episode ‘Relics’ understands the plan</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Research into YouTube Advertizing Spend</h2><p>Let’s do some <a href="https://www.statista.com/statistics/272859/mobile-advertising-spending-worldwide/" rel="nofollow">YouTube demographics research</a> to find a part of the world avoided by advertisers.</p><figure id="attachment_5452"><a href="https://ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020.png"><img src="https://static.ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-754x427.png" alt="Mobile advertiser spend by country in 2020 (REF: statista.com)" width="754" height="427" srcset="https://static.ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-754x427.png 754w, https://static.ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-300x170.png 300w, https://ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-600x340.png 600w, https://ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020.png 1203w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-754x427.png" data-srcset="https://static.ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-754x427.png 754w, https://static.ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-300x170.png 300w, https://ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-600x340.png 600w, https://ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020.png 1203w"></a><figcaption>Mobile advertiser spend by country in 2020</figcaption></figure><p>Let’s also check some <a href="https://medium.com/@ChannelMeter/youtubes-top-countries-47b0d26dded" target="_blank" rel="nofollow">YouTube statistics</a> about viewers by country for insights. Thinking about following some Reddit advice and VPN’ing into India? Think again.</p><figure id="attachment_5453"><a href="https://static.ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter.png"><img src="https://ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-754x425.png" alt="Total YouTube views by country in 2019 (REF: ChannelMeter)" width="754" height="425" srcset="https://ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-754x425.png 754w, https://static.ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-300x169.png 300w, https://ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-600x338.png 600w, https://static.ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter.png 1000w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-754x425.png" data-srcset="https://ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-754x425.png 754w, https://static.ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-300x169.png 300w, https://ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-600x338.png 600w, https://static.ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter.png 1000w"></a><figcaption>Total YouTube views by country in 2019 (REF: ChannelMeter)</figcaption></figure><p>That was 2019. This is <a href="https://backlinko.com/youtube-users" target="_blank" rel="nofollow">2020</a>:</p><figure id="attachment_5454"><a href="https://ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_.png"><img src="https://ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_.png" alt="Top ten YouTube countries with population (REF: backlinko.com)" width="710" height="417" srcset="https://ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_.png 710w, https://ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_-300x176.png 300w, https://static.ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_-600x352.png 600w" sizes="(max-width: 710px) 100vw, 710px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_.png" data-srcset="https://ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_.png 710w, https://ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_-300x176.png 300w, https://static.ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_-600x352.png 600w"></a><figcaption>Top ten YouTube countries with population (REF: backlinko.com)</figcaption></figure><p>I’m not a digital advertiser, but I can see that people in the UK and Canada watch a large number of videos per sitting. If I <em>were</em> an advertiser though, I’d pump those two countries with video ad after video ad because, statistically, those residents will take the eyeball kicking. All things being equal, I definitely need a VPN to terminate outside of Canada, the UK, and the United States (English-speaking countries) to enjoy YouTube more.</p><p>Does age play a factor? Who <strong>don’t</strong> advertisers want? I want to be that guy on paper.</p><figure id="attachment_5455"><a href="https://static.ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_.png"><img src="https://static.ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_.png" alt="YouTube age demographics as of 2020 (REF: backlinko.com)" width="710" height="176" srcset="https://static.ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_.png 710w, https://ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_-300x74.png 300w, https://static.ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_-600x149.png 600w" sizes="(max-width: 710px) 100vw, 710px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_.png" data-srcset="https://static.ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_.png 710w, https://ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_-300x74.png 300w, https://static.ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_-600x149.png 600w"></a><figcaption>YouTube age demographics as of 2020 (REF: backlinko.com)</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><div><p><a name="new-goal-trick"></a><strong>New Goal:</strong> Let’s trick YouTube into believing I am a 70-year-old male living in Italy. Yes, that should definitely cut down on the Nespresso and Starbucks ads, at least.</p></div><p>How then to convince YouTube that I am a retired Sicilian living on a small chain island? I embellished that last part. Seventy and in Italy is sufficient.</p><p>Let’s do this. In the YouTube account…</p><figure id="attachment_5457"><a href="https://ericdraken.com/files/I-am-71-years-old.png"><img src="https://ericdraken.com/files/I-am-71-years-old.png" alt="I am 71 years old" width="601" height="516" srcset="https://ericdraken.com/files/I-am-71-years-old.png 601w, https://ericdraken.com/files/I-am-71-years-old-300x258.png 300w, https://ericdraken.com/files/I-am-71-years-old-600x515.png 600w" sizes="(max-width: 601px) 100vw, 601px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/I-am-71-years-old.png" data-srcset="https://ericdraken.com/files/I-am-71-years-old.png 601w, https://ericdraken.com/files/I-am-71-years-old-300x258.png 300w, https://ericdraken.com/files/I-am-71-years-old-600x515.png 600w"></a><figcaption>I am <del>Iron Man</del> 71 years old</figcaption></figure><figure id="attachment_5458"><a href="https://static.ericdraken.com/files/I-am-in-Italy.png"><img src="https://static.ericdraken.com/files/I-am-in-Italy.png" alt="I am in Italy" width="317" height="455" srcset="https://static.ericdraken.com/files/I-am-in-Italy.png 317w, https://ericdraken.com/files/I-am-in-Italy-209x300.png 209w" sizes="(max-width: 317px) 100vw, 317px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/I-am-in-Italy.png" data-srcset="https://static.ericdraken.com/files/I-am-in-Italy.png 317w, https://ericdraken.com/files/I-am-in-Italy-209x300.png 209w"></a><figcaption>I am in Italy</figcaption></figure><p>It is doubtful that this is all it takes for our goal. Let’s find a VPN exit point in Italy.</p><figure id="attachment_5459"><a href="https://ericdraken.com/out/nordvpn"><img src="https://ericdraken.com/files/NordVPN-has-60-servers-in-Italy-754x383.png" alt="NordVPN has 60+ servers in Italy" width="754" height="383" srcset="https://ericdraken.com/files/NordVPN-has-60-servers-in-Italy-754x383.png 754w, https://static.ericdraken.com/files/NordVPN-has-60-servers-in-Italy-300x153.png 300w, https://ericdraken.com/files/NordVPN-has-60-servers-in-Italy-600x305.png 600w, https://static.ericdraken.com/files/NordVPN-has-60-servers-in-Italy.png 1166w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/NordVPN-has-60-servers-in-Italy-754x383.png" data-srcset="https://ericdraken.com/files/NordVPN-has-60-servers-in-Italy-754x383.png 754w, https://static.ericdraken.com/files/NordVPN-has-60-servers-in-Italy-300x153.png 300w, https://ericdraken.com/files/NordVPN-has-60-servers-in-Italy-600x305.png 600w, https://static.ericdraken.com/files/NordVPN-has-60-servers-in-Italy.png 1166w"></a><figcaption>NordVPN has 60+ servers in Italy</figcaption></figure><p>Nice. <a href="https://ericdraken.com/out/nordvpn" target="_blank">NordVPN</a> has about 60 servers in Italy (that’s an affiliate link by the way).</p><p><a href="#top">Top ↩</a></p><hr><h2>Selectively Route Apple TV Over the VPN</h2><p>Let’s go through some tutorials to set up <em>OpenVPN</em> in pfSense. Just kidding! We’re going to use WireGuard – we have the Intel AES-NI crypto instruction set because we didn’t go cheap and get a yesteryear J1900 mini PC that sellers are trying to offload.</p><p>I’ll now install the FreeBSD WireGuard package.</p><figure id="attachment_5462"><a href="https://static.ericdraken.com/files/Install-the-WireGuard-package-in-pfSense.png"><img src="https://ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-754x328.png" alt="Install the WireGuard package in pfSense" width="754" height="328" srcset="https://ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-754x328.png 754w, https://static.ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-300x131.png 300w, https://static.ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-600x261.png 600w, https://static.ericdraken.com/files/Install-the-WireGuard-package-in-pfSense.png 1144w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-754x328.png" data-srcset="https://ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-754x328.png 754w, https://static.ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-300x131.png 300w, https://static.ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-600x261.png 600w, https://static.ericdraken.com/files/Install-the-WireGuard-package-in-pfSense.png 1144w"></a><figcaption>Install the WireGuard package in pfSense</figcaption></figure><p>Next, add a tunnel and enable it. According to this <a href="https://www.reddit.com/r/PFSENSE/comments/m0989o/nordvpn_wireguard_setup_works/" target="_blank" rel="nofollow">thread</a> and this <a href="https://www.reddit.com/r/PFSENSE/comments/m0989o/nordvpn_wireguard_setup_works/" target="_blank" rel="nofollow">thread</a> on Reddit, we need to get some information for WireGuard and NordLynx from a sacrificial Linux VM to transpose the settings (i.e. private key) to the pfSense router. No problem.</p><figure id="attachment_5463"><a href="https://ericdraken.com/files/Connect-to-Italy-over-WireGuard.png"><img src="https://ericdraken.com/files/Connect-to-Italy-over-WireGuard.png" alt="Connect to Italy over WireGuard" width="547" height="85" srcset="https://ericdraken.com/files/Connect-to-Italy-over-WireGuard.png 547w, https://static.ericdraken.com/files/Connect-to-Italy-over-WireGuard-300x47.png 300w" sizes="(max-width: 547px) 100vw, 547px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Connect-to-Italy-over-WireGuard.png" data-srcset="https://ericdraken.com/files/Connect-to-Italy-over-WireGuard.png 547w, https://static.ericdraken.com/files/Connect-to-Italy-over-WireGuard-300x47.png 300w"></a><figcaption>Connect to Italy over WireGuard</figcaption></figure><figure id="attachment_5464"><a href="https://static.ericdraken.com/files/WireGuard-config-information-via-wg-show.png"><img src="https://static.ericdraken.com/files/WireGuard-config-information-via-wg-show.png" alt="WireGuard config information via wg show" width="608" height="233" srcset="https://static.ericdraken.com/files/WireGuard-config-information-via-wg-show.png 608w, https://static.ericdraken.com/files/WireGuard-config-information-via-wg-show-300x115.png 300w, https://ericdraken.com/files/WireGuard-config-information-via-wg-show-600x230.png 600w" sizes="(max-width: 608px) 100vw, 608px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/WireGuard-config-information-via-wg-show.png" data-srcset="https://static.ericdraken.com/files/WireGuard-config-information-via-wg-show.png 608w, https://static.ericdraken.com/files/WireGuard-config-information-via-wg-show-300x115.png 300w, https://ericdraken.com/files/WireGuard-config-information-via-wg-show-600x230.png 600w"></a><figcaption>WireGuard config information via wg show</figcaption></figure><p>Run <code>sudo wg showconf nordlynx</code> to see your private key needed by the pfSense tunnel config.</p><p>Here are various screenshots that show the steps in more detail.</p><figure id="attachment_5477"><a href="https://static.ericdraken.com/files/VPN-WireGuard-Tunnels.png"><img src="https://static.ericdraken.com/files/VPN-WireGuard-Tunnels-754x450.png" alt="VPN > WireGuard > Tunnels" width="754" height="450" srcset="https://static.ericdraken.com/files/VPN-WireGuard-Tunnels-754x450.png 754w, https://static.ericdraken.com/files/VPN-WireGuard-Tunnels-300x179.png 300w, https://ericdraken.com/files/VPN-WireGuard-Tunnels-600x358.png 600w, https://static.ericdraken.com/files/VPN-WireGuard-Tunnels.png 1154w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/VPN-WireGuard-Tunnels-754x450.png" data-srcset="https://static.ericdraken.com/files/VPN-WireGuard-Tunnels-754x450.png 754w, https://static.ericdraken.com/files/VPN-WireGuard-Tunnels-300x179.png 300w, https://ericdraken.com/files/VPN-WireGuard-Tunnels-600x358.png 600w, https://static.ericdraken.com/files/VPN-WireGuard-Tunnels.png 1154w"></a><figcaption>VPN &gt; WireGuard &gt; Tunnels</figcaption></figure><figure id="attachment_5478"><a href="https://ericdraken.com/files/VPN-WireGuard-Peers.png"><img src="https://ericdraken.com/files/VPN-WireGuard-Peers-754x563.png" alt="VPN > WireGuard > Peers" width="754" height="563" srcset="https://ericdraken.com/files/VPN-WireGuard-Peers-754x563.png 754w, https://ericdraken.com/files/VPN-WireGuard-Peers-300x224.png 300w, https://ericdraken.com/files/VPN-WireGuard-Peers-600x448.png 600w, https://ericdraken.com/files/VPN-WireGuard-Peers.png 1147w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/VPN-WireGuard-Peers-754x563.png" data-srcset="https://ericdraken.com/files/VPN-WireGuard-Peers-754x563.png 754w, https://ericdraken.com/files/VPN-WireGuard-Peers-300x224.png 300w, https://ericdraken.com/files/VPN-WireGuard-Peers-600x448.png 600w, https://ericdraken.com/files/VPN-WireGuard-Peers.png 1147w"></a><figcaption>VPN &gt; WireGuard &gt; Peers</figcaption></figure><div><p><strong>Tip:</strong> Enter <code>1.0.0.0</code> and then <code>0</code> as the subnet mask. Do not go for <code>0.0.0.0</code> as there is a glitch or bug in the UI or whathaveyou. The result will still be <code>0.0.0.0/0</code>.</p></div><figure id="attachment_5479"><a href="https://static.ericdraken.com/files/VPN-WireGuard-Settings.png"><img src="https://static.ericdraken.com/files/VPN-WireGuard-Settings-754x345.png" alt="VPN > WireGuard > Settings" width="754" height="345" srcset="https://static.ericdraken.com/files/VPN-WireGuard-Settings-754x345.png 754w, https://ericdraken.com/files/VPN-WireGuard-Settings-300x137.png 300w, https://ericdraken.com/files/VPN-WireGuard-Settings-600x275.png 600w, https://static.ericdraken.com/files/VPN-WireGuard-Settings.png 1153w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/VPN-WireGuard-Settings-754x345.png" data-srcset="https://static.ericdraken.com/files/VPN-WireGuard-Settings-754x345.png 754w, https://ericdraken.com/files/VPN-WireGuard-Settings-300x137.png 300w, https://ericdraken.com/files/VPN-WireGuard-Settings-600x275.png 600w, https://static.ericdraken.com/files/VPN-WireGuard-Settings.png 1153w"></a><figcaption>VPN &gt; WireGuard &gt; Settings</figcaption></figure><figure id="attachment_5480"><a href="https://static.ericdraken.com/files/Interfaces-Interface-Assignments.png"><img src="https://static.ericdraken.com/files/Interfaces-Interface-Assignments-754x248.png" alt="Interfaces > Interface Assignments" width="754" height="248" srcset="https://static.ericdraken.com/files/Interfaces-Interface-Assignments-754x248.png 754w, https://ericdraken.com/files/Interfaces-Interface-Assignments-300x99.png 300w, https://static.ericdraken.com/files/Interfaces-Interface-Assignments-600x197.png 600w, https://static.ericdraken.com/files/Interfaces-Interface-Assignments.png 1153w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Interfaces-Interface-Assignments-754x248.png" data-srcset="https://static.ericdraken.com/files/Interfaces-Interface-Assignments-754x248.png 754w, https://ericdraken.com/files/Interfaces-Interface-Assignments-300x99.png 300w, https://static.ericdraken.com/files/Interfaces-Interface-Assignments-600x197.png 600w, https://static.ericdraken.com/files/Interfaces-Interface-Assignments.png 1153w"></a><figcaption>Interfaces &gt; Interface Assignments</figcaption></figure><p>That should be enough to allow Diagnostics to <code>curl</code> Italy.</p><figure id="attachment_5466"><a href="https://static.ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense.png"><img src="https://ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-754x203.png" alt="Successfully connected to NordVPN through WireGuard on pfSense" width="754" height="203" srcset="https://ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-754x203.png 754w, https://static.ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-300x81.png 300w, https://static.ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-600x161.png 600w, https://static.ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense.png 1148w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-754x203.png" data-srcset="https://ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-754x203.png 754w, https://static.ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-300x81.png 300w, https://static.ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-600x161.png 600w, https://static.ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense.png 1148w"></a><figcaption>Successfully connected to NordVPN through WireGuard on pfSense</figcaption></figure><figure id="attachment_5468"><a href="https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified.png"><img src="https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified-754x479.png" alt="Successfully connect to Italy and verified" width="754" height="479" srcset="https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified-754x479.png 754w, https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified-300x191.png 300w, https://ericdraken.com/files/Successfully-connect-to-Italy-and-verified-600x381.png 600w, https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified.png 757w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified-754x479.png" data-srcset="https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified-754x479.png 754w, https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified-300x191.png 300w, https://ericdraken.com/files/Successfully-connect-to-Italy-and-verified-600x381.png 600w, https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified.png 757w"></a><figcaption>Successfully connect to Italy and verified</figcaption></figure><p>Now that the easy part is out of the way, let’s set some Policy rules to send the Apple TV traffic over the VPN to Italy as a baseline test.</p><p>From Netgate, on the <a href="https://docs.netgate.com/pfsense/en/latest/nat/process-order.html" target="_blank" rel="nofollow">order of Firewall/NAT processing</a>:</p><blockquote><p>Traffic from LAN to WAN is processed as described in the following more detailed example.</p><ul><li>Port forwards or 1:1 NAT on the LAN interface (e.g. proxy or DNS redirects)</li><li>Firewall rules for the LAN interface:<ul><li>Floating rules inbound on LAN</li><li>Rules for interface groups including the LAN interface</li><li>LAN tab rules</li></ul></li><li>1:1 NAT or Outbound NAT rules on WAN</li><li>Floating rules that match outbound on WAN</li></ul></blockquote><p>I’ll make an alias, for now, to hold some clients that have static DHCP entries and hostnames I gave them in pfSense.</p><figure id="attachment_5483"><a href="https://static.ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page.png"><img src="https://ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-754x171.png" alt="VPN clients in the Firewall > Aliases > IP page" width="754" height="171" srcset="https://ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-754x171.png 754w, https://static.ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-300x68.png 300w, https://ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-600x136.png 600w, https://static.ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page.png 1149w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-754x171.png" data-srcset="https://ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-754x171.png 754w, https://static.ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-300x68.png 300w, https://ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-600x136.png 600w, https://static.ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page.png 1149w"></a><figcaption>VPN clients in the Firewall &gt; Aliases &gt; IP page</figcaption></figure><p>Floating rules <strong>in</strong> have high precedence, so I’ll add some rules below the automatic pfBlockerNG rules that were created, and I’ll add a nice little blue separator while I’m here.</p><figure id="attachment_5484"><a href="https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy.png"><img src="https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-754x463.png" alt="Floating rule to route select clients over the VPN to Italy" width="754" height="463" srcset="https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-754x463.png 754w, https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-300x184.png 300w, https://static.ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-600x369.png 600w, https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy.png 1151w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-754x463.png" data-srcset="https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-754x463.png 754w, https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-300x184.png 300w, https://static.ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-600x369.png 600w, https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy.png 1151w"></a><figcaption>Floating rule to route select clients over the VPN to Italy</figcaption></figure><p>And here is that rule as a very long screenshot:</p><figure id="attachment_5485"><a href="https://ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN.png"><img src="https://static.ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-754x1712.png" alt="Firewall > Rules > Floating rule to route select clients over the VPN" width="754" height="1712" srcset="https://static.ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-754x1712.png 754w, https://ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-132x300.png 132w, https://ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-600x1363.png 600w, https://ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN.png 1147w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-754x1712.png" data-srcset="https://static.ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-754x1712.png 754w, https://ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-132x300.png 132w, https://ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-600x1363.png 600w, https://ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN.png 1147w"></a><figcaption>Firewall &gt; Rules &gt; Floating rule to route select clients over the VPN</figcaption></figure><p>Apply. Wait. Let’s try it out using one of my notebooks connected to the Untrusted network.</p><figure id="attachment_5492"><a href="https://ericdraken.com/files/Google-is-entirely-in-Italian-now.png"><img src="https://static.ericdraken.com/files/Google-is-entirely-in-Italian-now-754x393.png" alt="Google is entirely in Italian now" width="754" height="393" srcset="https://static.ericdraken.com/files/Google-is-entirely-in-Italian-now-754x393.png 754w, https://static.ericdraken.com/files/Google-is-entirely-in-Italian-now-300x156.png 300w, https://ericdraken.com/files/Google-is-entirely-in-Italian-now-600x312.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Google-is-entirely-in-Italian-now-754x393.png" data-srcset="https://static.ericdraken.com/files/Google-is-entirely-in-Italian-now-754x393.png 754w, https://static.ericdraken.com/files/Google-is-entirely-in-Italian-now-300x156.png 300w, https://ericdraken.com/files/Google-is-entirely-in-Italian-now-600x312.png 600w"></a><figcaption>Google is entirely in Italian now</figcaption></figure><p>Google is in Italian. Very cool. Now for the Apple TV.</p><figure id="attachment_5509"><a href="https://ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy.jpg"><img src="https://ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-754x318.jpg" alt="Apple TV's YouTube reports I am in Italy" width="754" height="318" srcset="https://ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-754x318.jpg 754w, https://static.ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-300x126.jpg 300w, https://ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-600x253.jpg 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-754x318.jpg" data-srcset="https://ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-754x318.jpg 754w, https://static.ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-300x126.jpg 300w, https://ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-600x253.jpg 600w"></a><figcaption>Apple TV’s YouTube reports I am in Italy</figcaption></figure><p>Winner winner, chicken diner. All my YouTube is in Italian. I get some ads, not as many, but because Italians speak slowly and with a kind of sexy accent I do not mind the ads for Nutella at all.</p><p>With this technique, I no longer feel manipulated by non-English ads. I have personalized ads <em>off</em>, but given my new status as a retired gentleman I should turn that back on to scare away advertising dollars, er, euros. I wonder if Netflix and Amazon Prime behave any differently…</p><figure id="attachment_5508"><a href="https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked.jpg"><img src="https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-754x524.jpg" alt="Some Netflix assets are being blocked" width="754" height="524" srcset="https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-754x524.jpg 754w, https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-300x208.jpg 300w, https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-600x417.jpg 600w, https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked.jpg 1276w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-754x524.jpg" data-srcset="https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-754x524.jpg 754w, https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-300x208.jpg 300w, https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-600x417.jpg 600w, https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked.jpg 1276w"></a><figcaption>Some Netflix assets are being blocked</figcaption></figure><p>Dang. Netflix is having problems. Amazon Prime is even worse. It looks like some CSS or font files are blocked as well, and the thumbnails aren’t loading. It’s time to move to Phase Two: Tunnel only YouTube traffic over the VPN.</p><div><p><strong>Warning:</strong> Do not try to send all the Apple TV traffic over a VPN because Netflix, Prime, and others are wise to VPN providers and have gotten great at geofencing.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Selectively Route Apple TV YouTube Traffic Over the VPN</h2><p>Let’s start by adding Firewall Policy rules to send the most common YouTube domains over the VPN.</p><p>As I’m about to add the rules, my hands hover over the keyboard not knowing what domains to tunnel. They need to be FQDN (fully-qualified domain names, no wildcards). Let’s open up a Chromium-based browser and see what traffic it generates in DevTools.</p><figure id="attachment_5559"><a href="https://static.ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls.png"><img src="https://ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-754x440.png" alt="Add the domains column to DevTools to see where YouTube calls" width="754" height="440" srcset="https://ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-754x440.png 754w, https://static.ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-300x175.png 300w, https://static.ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-600x350.png 600w, https://static.ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls.png 1031w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-754x440.png" data-srcset="https://ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-754x440.png 754w, https://static.ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-300x175.png 300w, https://static.ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-600x350.png 600w, https://static.ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls.png 1031w"></a><figcaption>Add the domains column to DevTools to see where YouTube calls</figcaption></figure><p>Here are some candidate FQDNs to add:</p><div id="crayon-63661eaabe4aa191315272" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>www</span><span>.youtube</span><span>.com</span></p><p><span>youtube</span><span>.com</span></p><p><span>googlevideo</span><span>.com</span></p><p><span>accounts</span><span>.google</span><span>.com</span></p><p><span>googleapis</span><span>.com</span></p><p><span>gstatic</span><span>.com</span></p></div></td></tr></tbody></table></div><p>But wait, I hear you ask, why <code>accounts.google.com</code> and <code>gstatic.com</code>? This is a preventative measure just in case one of those domains is geo-jacked (Geo-IP LowJacking). I wouldn’t put it past Google engineers to geo-jack the fonts domains like <code>fonts.googleapis.com</code>, but I’ll take a chance they don’t in the interest of scaling to billions of page views efficiently.</p><p>Here are my new rules where I chain two of them using a tag so I can limit YouTube tunnelling to only the same untrusted machines (including Apple TV).</p><figure id="attachment_5496"><a href="https://static.ericdraken.com/files/YouTube-domains-to-tunnel.png"><img src="https://static.ericdraken.com/files/YouTube-domains-to-tunnel-754x422.png" alt="YouTube domains to tunnel" width="754" height="422" srcset="https://static.ericdraken.com/files/YouTube-domains-to-tunnel-754x422.png 754w, https://static.ericdraken.com/files/YouTube-domains-to-tunnel-300x168.png 300w, https://static.ericdraken.com/files/YouTube-domains-to-tunnel-600x336.png 600w, https://static.ericdraken.com/files/YouTube-domains-to-tunnel.png 1146w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/YouTube-domains-to-tunnel-754x422.png" data-srcset="https://static.ericdraken.com/files/YouTube-domains-to-tunnel-754x422.png 754w, https://static.ericdraken.com/files/YouTube-domains-to-tunnel-300x168.png 300w, https://static.ericdraken.com/files/YouTube-domains-to-tunnel-600x336.png 600w, https://static.ericdraken.com/files/YouTube-domains-to-tunnel.png 1146w"></a><figcaption>YouTube domains to tunnel</figcaption></figure><figure id="attachment_5497"><a href="https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule.png"><img src="https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-754x132.png" alt="Use a match rule before the tunnel rule" width="754" height="132" srcset="https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-754x132.png 754w, https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-300x53.png 300w, https://static.ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-600x105.png 600w, https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule.png 1140w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-754x132.png" data-srcset="https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-754x132.png 754w, https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-300x53.png 300w, https://static.ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-600x105.png 600w, https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule.png 1140w"></a><figcaption>Use a match rule before the tunnel rule</figcaption></figure><figure id="attachment_5498"><a href="https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them.png"><img src="https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-754x1673.png" alt="The first rule matches VPN clients and tags them" width="754" height="1673" srcset="https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-754x1673.png 754w, https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-135x300.png 135w, https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-600x1331.png 600w, https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them.png 1145w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-754x1673.png" data-srcset="https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-754x1673.png 754w, https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-135x300.png 135w, https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-600x1331.png 600w, https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them.png 1145w"></a><figcaption>The first rule matches VPN clients and tags them</figcaption></figure><figure id="attachment_5499"><a href="https://ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN.png"><img src="https://ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-754x1674.png" alt="The second rule tunnels tagged requests through the VPN" width="754" height="1674" srcset="https://ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-754x1674.png 754w, https://static.ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-135x300.png 135w, https://static.ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-600x1332.png 600w, https://ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN.png 1142w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-754x1674.png" data-srcset="https://ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-754x1674.png 754w, https://static.ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-135x300.png 135w, https://static.ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-600x1332.png 600w, https://ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN.png 1142w"></a><figcaption>The second rule tunnels tagged requests through the VPN</figcaption></figure><p>And with that, YouTube thinks I’m in Milan, Netflix and Prime Video think I am still in Canada, and the ads… oh the ads… they are few and far between, and when they do come on, they are just a treat to listen to in that slow, lack-of-harsh-aspirants-or-yelling of a beautiful language Italian is.</p><figure id="attachment_5571"><a href="https://ericdraken.com/files/YouTube-Italy.jpg"><img src="https://static.ericdraken.com/files/YouTube-Italy-754x386.jpg" alt="YouTube, Italy" width="754" height="386" srcset="https://static.ericdraken.com/files/YouTube-Italy-754x386.jpg 754w, https://ericdraken.com/files/YouTube-Italy-300x154.jpg 300w, https://static.ericdraken.com/files/YouTube-Italy-600x308.jpg 600w, https://ericdraken.com/files/YouTube-Italy.jpg 1200w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/YouTube-Italy-754x386.jpg" data-srcset="https://static.ericdraken.com/files/YouTube-Italy-754x386.jpg 754w, https://ericdraken.com/files/YouTube-Italy-300x154.jpg 300w, https://static.ericdraken.com/files/YouTube-Italy-600x308.jpg 600w, https://ericdraken.com/files/YouTube-Italy.jpg 1200w"></a><figcaption>YouTube, Italy</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><p><em>Time goes by…</em></p><hr><h2>Gotcha: DNS Race Condition</h2><p>A day has gone by and I’ve noticed that I only get Nutella and Ferrero Roche ads in the middle of videos, not at the start. Odd. I did some research and this is what I found:</p><figure id="attachment_5561"><a href="https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases.png"><img src="https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases.png" alt="Pertinent information about pfSense and hostname aliases" width="696" height="589" srcset="https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases.png 696w, https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases-300x254.png 300w, https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases-600x508.png 600w" sizes="(max-width: 696px) 100vw, 696px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases.png" data-srcset="https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases.png 696w, https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases-300x254.png 300w, https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases-600x508.png 600w"></a><figcaption>Pertinent information about pfSense and hostname aliases</figcaption></figure><p>This means that the hostnames are resolved to IP addresses <strong>once</strong> and those IPs are used in my VPN tunnelling policy rules.</p><blockquote><p>A hostname entry in a host or network type alias is <strong>periodically resolved and updated by the firewall every few minutes</strong>. The default interval is 300 seconds (5 minutes), and can be changed by adjusting the value of Aliases Hostnames Resolve Interval on System &gt; Advanced, Firewall &amp; NAT tab. – pfSense</p></blockquote><p>Ah-ha, so I suspect there is a DNS race condition. Let me explain:</p><p>This happens if, say, the Alias Daemon updates the IPs of the FQDNs. Then, I turn on the Apple TV for the first time all day. Since the usual TTL (time-to-live) of DNS queries is 1440 seconds (30 minutes), all the YouTube DNS entries will be cache misses and will need to be updated. At this point, the IPs from the second DNS queries may be from a pool and are not guaranteed to be the same that the Alias Daemon has. When the Alias Daemon checks again in five minutes, it may resolve the FQDNs to yet different IPs!</p><p>Let’s solve this by overwriting whatever TTL (time-to-live) YouTube has in its DNS entries:</p><figure id="attachment_5568"><a href="https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry.png"><img src="https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-754x181.png" alt="Do not abide by the minimum TTL of the target DNS entry" width="754" height="181" srcset="https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-754x181.png 754w, https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-300x72.png 300w, https://static.ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-600x144.png 600w, https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry.png 1069w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-754x181.png" data-srcset="https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-754x181.png 754w, https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-300x72.png 300w, https://static.ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-600x144.png 600w, https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry.png 1069w"></a><figcaption>Do not abide by the minimum TTL of the target DNS entry</figcaption></figure><p>And with that, no more DNS lookup race condition.</p><p><a href="#top">Top ↩</a></p><hr><h2>Gotcha: Authentication Trouble, Forbidden 403 Error</h2><p>Sometimes videos will not play. For security, YouTube embeds your IP in the <code>googlevideo.com</code> request. I’ve known about this since my post about <a href="https://ericdraken.com/download-youtube-videos-with-php/" target="_blank">Download YouTube 4K Videos with PHP</a> back in 2016. The new problem is that various JavaScript and “are you human?” assets are tunnelled over VPN, but those darn domains like <code>r5---sn-hpa7kn76.googlevideo.com</code> are not tunnelled and thus come from the wrong IP. Queue the <code>403 Forbidden</code> error.</p><figure id="attachment_5569"><a href="https://ericdraken.com/files/YouTube-authentication-failure.png"><img src="https://static.ericdraken.com/files/YouTube-authentication-failure-754x359.png" alt="YouTube authentication failure" width="754" height="359" srcset="https://static.ericdraken.com/files/YouTube-authentication-failure-754x359.png 754w, https://static.ericdraken.com/files/YouTube-authentication-failure-300x143.png 300w, https://ericdraken.com/files/YouTube-authentication-failure-600x286.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/YouTube-authentication-failure-754x359.png" data-srcset="https://static.ericdraken.com/files/YouTube-authentication-failure-754x359.png 754w, https://static.ericdraken.com/files/YouTube-authentication-failure-300x143.png 300w, https://ericdraken.com/files/YouTube-authentication-failure-600x286.png 600w"></a><figcaption>YouTube authentication failure</figcaption></figure><p>Let’s fail fast with a quick experiment: I’ve gotten the IP of the above second-level domain name (SLD), added it manually to the list of domains/IPs to VPN tunnel, applied the change, and refreshed YouTube:</p><figure id="attachment_5574"><a href="https://ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well..png"><img src="https://static.ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-754x360.png" alt="Success. We need to route the mangled domains over the VPN as well." width="754" height="360" srcset="https://static.ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-754x360.png 754w, https://static.ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-300x143.png 300w, https://ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-600x287.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-754x360.png" data-srcset="https://static.ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-754x360.png 754w, https://static.ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-300x143.png 300w, https://ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-600x287.png 600w"></a><figcaption>Success. We need to route the mangled domains over the VPN as well.</figcaption></figure><p>Excellent. Now, we just need a way to tunnel that wildcard <code>*.googlevideo.com</code> domain. Unfortunately, the NAT and Firewall rules work with IPs, not <a href="https://www.reddit.com/r/PFSENSE/comments/7wwnun/wildcard_domains_in_aliases/" target="_blank" rel="nofollow">wildcard domain names</a>. Can we predict or enumerate these domains?</p><p>Here is a Wireshark capture of DNS requests to <code>*.googlevideo.com</code> to show that the SLDs (second-level domains) are not eyeballably predictable:</p><figure id="attachment_5663"><a href="https://static.ericdraken.com/files/Random-SLDs-from-googlevideo.com_.png"><img src="https://ericdraken.com/files/Random-SLDs-from-googlevideo.com_-754x270.png" alt="Random SLDs from googlevideo.com" width="754" height="270" srcset="https://ericdraken.com/files/Random-SLDs-from-googlevideo.com_-754x270.png 754w, https://ericdraken.com/files/Random-SLDs-from-googlevideo.com_-300x107.png 300w, https://static.ericdraken.com/files/Random-SLDs-from-googlevideo.com_-600x215.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Random-SLDs-from-googlevideo.com_-754x270.png" data-srcset="https://ericdraken.com/files/Random-SLDs-from-googlevideo.com_-754x270.png 754w, https://ericdraken.com/files/Random-SLDs-from-googlevideo.com_-300x107.png 300w, https://static.ericdraken.com/files/Random-SLDs-from-googlevideo.com_-600x215.png 600w"></a><figcaption>Random SLDs from googlevideo.com</figcaption></figure><p>Let’s drop into a web browser with adblocking disabled and walk the HAR waterfall of my interaction with YouTube that led to ads showing up.</p><figure id="attachment_5666"><a href="https://static.ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_.png"><img src="https://ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-754x255.png" alt="Waterfall showing ad interactions coming from www.youtube.com" width="754" height="255" srcset="https://ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-754x255.png 754w, https://static.ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-300x101.png 300w, https://static.ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-600x203.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-754x255.png" data-srcset="https://ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-754x255.png 754w, https://static.ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-300x101.png 300w, https://static.ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-600x203.png 600w"></a><figcaption>Waterfall showing ad interactions coming from www.youtube.com</figcaption></figure><p>What are GET requests like</p><p><code>GET https://r7---sn-uxa0n-t8ge.googlevideo.com/generate_204</code></p><p>doing, exactly? I’ll give this problem some thought offline.</p><p><a href="#top">Top ↩</a></p><hr><h2>Gotcha: YouTube is Now Showing UK Ads, Not Italian Ads</h2><p>Before I could even solve the previous gotcha, British ads started showing up with the same frequency as if we did nothing. Ads from the UK are even more incessant than those from Canada, trailing behind the USA and India according to my earlier stats. It would be a complete failure if we get UK ads. Why does this happen suddenly? I’ve opened a fresh browser in a VM and tunnelled all traffic through Italy. The only leak I can find is when I query <code>ipinfo.io</code> on my Italian tunnel and see a UK address in the ASN. Could this small leak be our undoing?</p><figure id="attachment_5672"><a href="https://ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information.png"><img src="https://static.ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-754x419.png" alt="It is possible the VPN is leaking unintended information" width="754" height="419" srcset="https://static.ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-754x419.png 754w, https://ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-300x167.png 300w, https://static.ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-600x333.png 600w, https://ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information.png 1499w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-754x419.png" data-srcset="https://static.ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-754x419.png 754w, https://ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-300x167.png 300w, https://static.ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-600x333.png 600w, https://ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information.png 1499w"></a><figcaption>It is possible the VPN is leaking unintended information</figcaption></figure><p>Even with my browser’s language set to <code>en_US</code> and location data off, this is the only leak I can spot. Then, in addition to a VPN exiting in Italy, it has to be one that doesn’t leak <code>ASN</code> (Autonomous System Numbers – used for automated routing) that gives up a different country. Dang, Google, you’re good. I’m going to have to bring my A+ game to this one.</p><p><a href="#top">Top ↩</a></p><hr><h2>Find a VPN Exit Node with no ASN Leak</h2><p>By visiting <code>https://nordvpn.com/servers/tools/</code>, I can see the VPN endpoint nodes in Italy. There are many Wireguard endpoints with <a href="https://ericdraken.com/out/nordvpn" target="_blank">NordVPN</a>. Just to move things forward for this exercise, I’ll add an OpenVPN tunnel in pfSense and connect to several VPN nodes and examine the ASNs. It’s better than nothing, and more importantly, I’d like to eliminate the <code>ASN</code> as the leak of GeoIP information. Here is the <a href="https://support.nordvpn.com/Connectivity/Router/1626958942/pfSense-2-5-Setup-with-NordVPN.htm" target="_blank" rel="nofollow">guide</a> I used.</p><p>Through trial and error, I found a VPN node that is registered to an ISP in Italy as found in the <code>Abuse</code> and <code>ASN</code> info.</p><figure id="attachment_5678"><a href="https://static.ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks.png"><img src="https://ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-754x382.png" alt="Found an exit node with no ASN leaks" width="754" height="382" srcset="https://ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-754x382.png 754w, https://static.ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-300x152.png 300w, https://static.ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-600x304.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-754x382.png" data-srcset="https://ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-754x382.png 754w, https://static.ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-300x152.png 300w, https://static.ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-600x304.png 600w"></a><figcaption>Found an exit node with no ASN leaks</figcaption></figure><p>Beautiful. Bellissimo.</p><figure id="attachment_5681"><a href="https://ericdraken.com/files/Italian-content-with-Italian-ads-again.jpg"><img src="https://ericdraken.com/files/Italian-content-with-Italian-ads-again-754x283.jpg" alt="Italian content with Italian ads again" width="754" height="283" srcset="https://ericdraken.com/files/Italian-content-with-Italian-ads-again-754x283.jpg 754w, https://ericdraken.com/files/Italian-content-with-Italian-ads-again-300x113.jpg 300w, https://static.ericdraken.com/files/Italian-content-with-Italian-ads-again-600x226.jpg 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Italian-content-with-Italian-ads-again-754x283.jpg" data-srcset="https://ericdraken.com/files/Italian-content-with-Italian-ads-again-754x283.jpg 754w, https://ericdraken.com/files/Italian-content-with-Italian-ads-again-300x113.jpg 300w, https://static.ericdraken.com/files/Italian-content-with-Italian-ads-again-600x226.jpg 600w"></a><figcaption>Italian content with Italian ads again</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Hijack Google Video DNS Queries</h2><p>To make any of this work, I need a technique to route the wildcard <code>*.googlevideos.com</code> domain through the VPN.</p><div><p><strong>Thought Experiment:</strong> Suppose I write a plugin for pfSense that periodically <code>grep</code>s the DNS query log, keeps track of the <code>*.googlevideo.com</code> queries, and adds them to a unique list of aliases for Google Video domains; if backed by an LRU eviction policy, this could keep working indefinitely. However, if each video uses a unique, mangled domain, then this does not work unless I hit refresh on every single video.</p></div><p>On the other hand, if I “hold up” the DNS query for the <code>*.googlevideo.com</code> domains, add the IPs to some alias list, <em>then</em> allow the DNS response to finish the round trip, we may be in business!</p><figure id="attachment_5583"><a href="https://static.ericdraken.com/files/pfSense-DNS-resolver-has-user-Python-support.png"><img src="https://static.ericdraken.com/files/pfSense-DNS-resolver-has-user-Python-support.png" alt="pfSense DNS resolver has user Python support" width="585" height="257" srcset="https://static.ericdraken.com/files/pfSense-DNS-resolver-has-user-Python-support.png 585w, https://ericdraken.com/files/pfSense-DNS-resolver-has-user-Python-support-300x132.png 300w" sizes="(max-width: 585px) 100vw, 585px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/pfSense-DNS-resolver-has-user-Python-support.png" data-srcset="https://static.ericdraken.com/files/pfSense-DNS-resolver-has-user-Python-support.png 585w, https://ericdraken.com/files/pfSense-DNS-resolver-has-user-Python-support-300x132.png 300w"></a><figcaption>pfSense DNS resolver has user Python support</figcaption></figure><p>Where to even start? Here are some <a href="https://github.com/NLnetLabs/unbound/tree/master/pythonmod/examples" target="_blank" rel="nofollow">Python example scripts</a> just to get some inspiration. A quick, mental reverse-engineering of a handful of scripts reveals that there are some event hooks available. Nice.</p><p>Among friends, let’s say that I can build up the pool of Google video IPs in real-time. How then to add these IPs programmatically to the firewall alias list for YouTube <em>without</em> restarting the firewall? One person actually hacked the PHP scripts in pfSense. Tempting, but I’ll do more research. Another person created a <a href="https://github.com/jaredhendrickson13/pfsense-api" target="_blank" rel="nofollow">REST API for pfSense</a>. Jackpot!</p><p><a href="#top">Top ↩</a></p><hr><div><p><a name="new-goal"></a><strong>New Goal:</strong> We need to add IPs to the firewall policy rule to route YouTube videos over a VPN to avoid incessant and obnoxious North-American ads, but the IPs keep changing due to changing, mangled second-level domain names (SLDs). Using Python 3 and a REST API, we will monitor the appropriate DNS queries, note the IP(s) of the response, hold the response, add the IP(s) to the VPN tunnelling policy rule, then release the DNS query response.</p></div><h2>Research Python Methods to Hijack DNS Requests</h2><p>Why this approach? It’s future-proof, modular, elegant, maintainable, automated, and it lends itself to a future decision tree that could truly restrict YouTube ads outright.</p><p>First, I will enable SSHd in pfSense and take a peek around.</p><figure id="attachment_5588"><a href="https://ericdraken.com/files/Enable-SSHd-in-pfSense.png"><img src="https://ericdraken.com/files/Enable-SSHd-in-pfSense-754x177.png" alt="Enable SSHd in pfSense" width="754" height="177" srcset="https://ericdraken.com/files/Enable-SSHd-in-pfSense-754x177.png 754w, https://static.ericdraken.com/files/Enable-SSHd-in-pfSense-300x71.png 300w, https://static.ericdraken.com/files/Enable-SSHd-in-pfSense-600x141.png 600w, https://ericdraken.com/files/Enable-SSHd-in-pfSense.png 1140w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Enable-SSHd-in-pfSense-754x177.png" data-srcset="https://ericdraken.com/files/Enable-SSHd-in-pfSense-754x177.png 754w, https://static.ericdraken.com/files/Enable-SSHd-in-pfSense-300x71.png 300w, https://static.ericdraken.com/files/Enable-SSHd-in-pfSense-600x141.png 600w, https://ericdraken.com/files/Enable-SSHd-in-pfSense.png 1140w"></a><figcaption>Enable SSHd in pfSense</figcaption></figure><figure id="attachment_5589"><a href="https://ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials.png"><img src="https://ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-754x424.png" alt="SSH into pfSense using the GUI credentials" width="754" height="424" srcset="https://ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-754x424.png 754w, https://static.ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-300x169.png 300w, https://static.ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-600x337.png 600w, https://ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials.png 1052w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-754x424.png" data-srcset="https://ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-754x424.png 754w, https://static.ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-300x169.png 300w, https://static.ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-600x337.png 600w, https://ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials.png 1052w"></a><figcaption>SSH into pfSense using the GUI credentials</figcaption></figure><h3>Rsync Disk Backup</h3><p>Let’s take this opportunity to make a disk backup. <code>du -h</code> or “duh” shows that only 800 MiB is in use on the SSD. Let’s <code>rsync</code> the whole box from our local machine in about four minutes.</p><div id="crayon-63661eaabe4b8255504186" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p></div></td><td><div><p><span># Rsync the pfSense router locally, then compress to an archive.</span></p><p><span># Tell the remote rsync to preserve ownership information.</span></p><p><span># Fix brace expansion and execute (easy to read with tr and sed).</span></p><p><span>cat</span><span> </span><span>&lt;&lt;</span><span> </span><span>EOF</span><span> </span><span>|</span><span> </span><span>tr</span><span> </span><span>-</span><span>s</span><span> </span><span>' '</span><span> </span><span>|</span><span> </span><span>sed</span><span> </span><span>'s/, "/,"/g'</span><span> </span><span>|</span><span> </span><span>bash</span></p><p><span>time</span><span> </span><span>\</span></p><p><span>rsync</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>archive</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>acls</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>xattrs</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>hard</span><span>-</span><span>links</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>fake</span><span>-</span><span>super</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>numeric</span><span>-</span><span>ids</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>checksum</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>info</span><span>=</span><span>progress2</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>no</span><span>-</span><span>compress</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>whole</span><span>-</span><span>file</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>inplace</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>rsync</span><span>-</span><span>path</span><span>=</span><span>"/usr/local/bin/rsync --fake-super --numeric-ids"</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>exclude</span><span>=</span><span>{</span><span>"/dev/*"</span><span>,</span><span>"/proc/*"</span><span>,</span><span>"/sys/*"</span><span>,</span><span>"/tmp/*"</span><span>,</span><span>"/run/*"</span><span>,</span><span>\</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"/var/*"</span><span>,</span><span>"/mnt/*"</span><span>,</span><span>"/media/*"</span><span>,</span><span>"/lost+found"</span><span>}</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>rsh</span><span>=</span><span>"ssh -p 2222"</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>admin</span><span>@</span><span>pfsense</span><span>:</span><span>/</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>~</span><span>/</span><span>.pfsense</span><span>-</span><span>backup</span><span> </span><span>&amp;&amp;</span><span> </span><span>\</span></p><p><span>tar</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>gzip</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>create</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>file</span><span> </span><span>~</span><span>/</span><span>pfsense</span><span>-</span><span>backup</span><span>-</span><span>`</span><span>date</span><span> </span><span>+</span><span>"%Y-%m-%d"</span><span>`</span><span>.tar</span><span>.gz</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>~</span><span>/</span><span>.pfsense</span><span>-</span><span>backup</span></p><p><span>EOF</span></p></div></td></tr></tbody></table></div><div><p><strong>Tip:</strong> To verify the owners and permissions are set in the extended attributes locally, run<br><code>getfattr -d -m ^ -R -- ~/.pfsense-backup</code></p></div><h3>Install pfSense REST API</h3><p>Now that we have a pfSense backup (I’m told just backing up <code>config.xml</code> works too), let’s install the <a href="https://github.com/jaredhendrickson13/pfsense-api" target="_blank" rel="nofollow">REST API</a>.</p><p>This part had me confused. You see, I was looking at the bottom of the screen wondering how the heck I could copy a truncated hash as a token. After a few tries, I noticed the green message at the top that I had been trained to ignore. It has the token.</p><figure id="attachment_5627"><a href="https://static.ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token.png"><img src="https://static.ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-754x634.png" alt="Tricky UI screen to get the API token" width="754" height="634" srcset="https://static.ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-754x634.png 754w, https://ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-300x252.png 300w, https://ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-600x504.png 600w, https://static.ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token.png 1142w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-754x634.png" data-srcset="https://static.ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-754x634.png 754w, https://ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-300x252.png 300w, https://ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-600x504.png 600w, https://static.ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token.png 1142w"></a><figcaption>Tricky UI screen to get the API token</figcaption></figure><p>Next, with the API credentials set up, let’s try out the API:</p><div id="crayon-63661eaabe4bb158173225" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>curl</span><span> </span><span>-</span><span>k</span><span> </span><span>-</span><span>s</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>-</span><span>H</span><span> </span><span>"Content-Type: application/json"</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>-</span><span>H</span><span> </span><span>"Authorization: 61646d696e 978c197c37a882f6da23553c152c1203"</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>-</span><span>X</span><span> </span><span>GET</span><span> </span><span>https</span><span>:</span><span>/</span><span>/</span><span>pfsense</span><span>/</span><span>api</span><span>/</span><span>v1</span><span>/</span><span>firewall</span><span>/</span><span>alias</span><span> </span><span>\</span></p><p><span>|</span><span> </span><span>jq</span><span> </span><span>'.data[] | select(.name == "VPN_domains")'</span></p></div></td></tr></tbody></table></div><figure id="attachment_5628"><a href="https://static.ericdraken.com/files/Successful-API-test.png"><img src="https://static.ericdraken.com/files/Successful-API-test.png" alt="Successful API test" width="746" height="347" srcset="https://static.ericdraken.com/files/Successful-API-test.png 746w, https://ericdraken.com/files/Successful-API-test-300x140.png 300w, https://static.ericdraken.com/files/Successful-API-test-600x279.png 600w" sizes="(max-width: 746px) 100vw, 746px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Successful-API-test.png" data-srcset="https://static.ericdraken.com/files/Successful-API-test.png 746w, https://ericdraken.com/files/Successful-API-test-300x140.png 300w, https://static.ericdraken.com/files/Successful-API-test-600x279.png 600w"></a><figcaption>Successful API test</figcaption></figure><h3>Explore the Unbound Python Module</h3><p>Running <code>find / -name "py*"</code> shows that the current version of Python is 3.8.</p><p>As for the Unbound DNS Resolver, I had some luck tinkering in <code>nano</code> and writing simple Python 3.8 code to log DNS query messages. We now have both parts needed to dynamically update the firewall aliases and tunnel all YouTube traffic once and for all.</p><p>If you are looking for Python module docs for Unbound, here they are:</p><figure id="attachment_5635"><a href="https://static.ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound.png"><img src="https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-754x318.png" alt="There are no readily available Python module docs for Unbound" width="754" height="318" srcset="https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-754x318.png 754w, https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-300x126.png 300w, https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-600x253.png 600w, https://static.ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound.png 1134w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-754x318.png" data-srcset="https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-754x318.png 754w, https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-300x126.png 300w, https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-600x253.png 600w, https://static.ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound.png 1134w"></a><figcaption>There are no readily available Python module docs for Unbound</figcaption></figure><p>Run these commands to quickly get the documentation.</p><div id="crayon-63661eaabe4be389439522" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># Do this in a PyCharm venv terminal</span></p><p><span>git </span><span>clone</span><span> </span><span>--</span><span>depth</span><span> </span><span>1</span><span> </span><span>-</span><span>b</span><span> </span><span>master</span><span> </span><span>--</span><span>single</span><span>-</span><span>branch </span><span>https</span><span>:</span><span>/</span><span>/</span><span>github</span><span>.com</span><span>/</span><span>NLnetLabs</span><span>/</span><span>unbound</span><span>.git</span><span> </span><span>unbound</span></p><p><span>pip3 </span><span>install </span><span>sphinx</span></p><p><span>cd</span><span> </span><span>unbound</span></p><p><span>sphinx</span><span>-</span><span>build</span><span> </span><span>-</span><span>b</span><span> </span><span>html </span><span>pythonmod</span><span>/</span><span>doc</span><span>/</span><span> </span><span>doc</span><span>/</span><span>html</span><span>/</span><span>pythonmod</span><span>/</span></p></div></td></tr></tbody></table></div><div><p><strong>Warning:</strong> The example code is from Python 2.4, so be prepared to run Black and PyCharm code formatting, or run <code>2to3</code>. Also, the most important part of this whole exercise (getting the IPs from the DNS reply) is missing, so here is the hint: <code>import ipaddress</code>. Don’t forget to manually hack the byte strings to pull out the proper IP addresses in binary form, first.</p></div><p>Now we have Python docs and access to all the capabilities. Excellent.</p><figure id="attachment_5639"><a href="https://static.ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx.png"><img src="https://ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-754x311.png" alt="Successful generation of Unbound Python docs with Sphinx" width="754" height="311" srcset="https://ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-754x311.png 754w, https://ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-300x124.png 300w, https://static.ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-600x248.png 600w, https://static.ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx.png 1280w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-754x311.png" data-srcset="https://ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-754x311.png 754w, https://ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-300x124.png 300w, https://static.ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-600x248.png 600w, https://static.ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx.png 1280w"></a><figcaption>Successful generation of Unbound Python docs with Sphinx</figcaption></figure><p>Next, take a backup of your OS or VM and install <code>libtools</code> and <code>swig</code> wherever, <code>./configure --with-pythonmodule</code>, <code>make</code>, fix some errors in the Unbound code, <code>make</code> again, then you’ll have the generated python module (<code>unboundmodule.py</code>) in order to remove all the missing-method red error lines in PyCharm.</p><figure id="attachment_5644"><a href="https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about.png"><img src="https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-754x314.png" alt="PyCharm can now find the missing methods we don't actually need to worry about" width="754" height="314" srcset="https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-754x314.png 754w, https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-300x125.png 300w, https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-600x249.png 600w, https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about.png 885w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-754x314.png" data-srcset="https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-754x314.png 754w, https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-300x125.png 300w, https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-600x249.png 600w, https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about.png 885w"></a><figcaption>PyCharm can now find the missing methods we don’t actually need to worry about</figcaption></figure><figure id="attachment_5647"><a href="https://static.ericdraken.com/files/First-successful-DNS-response-logging-script.png"><img src="https://static.ericdraken.com/files/First-successful-DNS-response-logging-script-754x489.png" alt="First successful DNS response logging script" width="754" height="489" srcset="https://static.ericdraken.com/files/First-successful-DNS-response-logging-script-754x489.png 754w, https://static.ericdraken.com/files/First-successful-DNS-response-logging-script-300x194.png 300w, https://ericdraken.com/files/First-successful-DNS-response-logging-script-600x389.png 600w, https://static.ericdraken.com/files/First-successful-DNS-response-logging-script.png 889w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/First-successful-DNS-response-logging-script-754x489.png" data-srcset="https://static.ericdraken.com/files/First-successful-DNS-response-logging-script-754x489.png 754w, https://static.ericdraken.com/files/First-successful-DNS-response-logging-script-300x194.png 300w, https://ericdraken.com/files/First-successful-DNS-response-logging-script-600x389.png 600w, https://static.ericdraken.com/files/First-successful-DNS-response-logging-script.png 889w"></a><figcaption>First successful DNS response logging script</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Smoke Test: A Python DNS-Hijacking Script</h2><p>Here is a smoke test of the ability to hijack <code>*.google.com</code> DNS requests with reply IPs that the script has caught in just a few minutes (the timestamps are just to maintain a crude LRU cache):</p><figure id="attachment_5651"><a href="https://ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_.png"><img src="https://static.ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-754x733.png" alt="Smoke test for collecting IP addresses of *.google.com" width="754" height="733" srcset="https://static.ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-754x733.png 754w, https://static.ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-300x292.png 300w, https://ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-600x583.png 600w, https://ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_.png 1145w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-754x733.png" data-srcset="https://static.ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-754x733.png 754w, https://static.ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-300x292.png 300w, https://ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-600x583.png 600w, https://ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_.png 1145w"></a><figcaption>Smoke test for collecting IP addresses of *.google.com</figcaption></figure><p>Duplicate IP addresses are possible, and that is fine. I let the smoke test run overnight. Here is the PoC (proof of concept) script I ran as the Unbound Python module script.</p><div id="crayon-63661eaabe4c3362457631" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p><p>65</p><p>66</p><p>67</p><p>68</p><p>69</p><p>70</p><p>71</p><p>72</p><p>73</p><p>74</p><p>75</p><p>76</p><p>77</p><p>78</p><p>79</p><p>80</p><p>81</p><p>82</p><p>83</p><p>84</p><p>85</p><p>86</p><p>87</p><p>88</p><p>89</p><p>90</p><p>91</p><p>92</p><p>93</p><p>94</p><p>95</p><p>96</p><p>97</p><p>98</p><p>99</p><p>100</p><p>101</p><p>102</p><p>103</p><p>104</p><p>105</p><p>106</p><p>107</p><p>108</p><p>109</p><p>110</p><p>111</p><p>112</p><p>113</p><p>114</p><p>115</p><p>116</p><p>117</p><p>118</p><p>119</p><p>120</p><p>121</p><p>122</p><p>123</p><p>124</p><p>125</p><p>126</p><p>127</p><p>128</p><p>129</p><p>130</p><p>131</p><p>132</p><p>133</p><p>134</p><p>135</p><p>136</p><p>137</p><p>138</p><p>139</p><p>140</p><p>141</p><p>142</p><p>143</p><p>144</p><p>145</p><p>146</p><p>147</p><p>148</p><p>149</p><p>150</p><p>151</p><p>152</p><p>153</p><p>154</p><p>155</p><p>156</p><p>157</p><p>158</p><p>159</p><p>160</p><p>161</p><p>162</p><p>163</p><p>164</p><p>165</p><p>166</p><p>167</p><p>168</p><p>169</p><p>170</p><p>171</p><p>172</p><p>173</p><p>174</p><p>175</p><p>176</p><p>177</p><p>178</p><p>179</p><p>180</p><p>181</p><p>182</p><p>183</p><p>184</p><p>185</p><p>186</p><p>187</p><p>188</p><p>189</p><p>190</p><p>191</p><p>192</p><p>193</p><p>194</p><p>195</p><p>196</p><p>197</p><p>198</p><p>199</p><p>200</p><p>201</p><p>202</p><p>203</p><p>204</p><p>205</p><p>206</p><p>207</p><p>208</p><p>209</p><p>210</p><p>211</p><p>212</p><p>213</p><p>214</p><p>215</p><p>216</p><p>217</p><p>218</p><p>219</p><p>220</p><p>221</p><p>222</p><p>223</p><p>224</p><p>225</p><p>226</p><p>227</p><p>228</p><p>229</p><p>230</p><p>231</p><p>232</p><p>233</p><p>234</p><p>235</p><p>236</p><p>237</p><p>238</p><p>239</p><p>240</p><p>241</p><p>242</p><p>243</p><p>244</p><p>245</p><p>246</p><p>247</p><p>248</p><p>249</p><p>250</p><p>251</p><p>252</p><p>253</p><p>254</p><p>255</p><p>256</p><p>257</p><p>258</p><p>259</p><p>260</p><p>261</p><p>262</p><p>263</p><p>264</p><p>265</p><p>266</p><p>267</p><p>268</p><p>269</p><p>270</p><p>271</p><p>272</p><p>273</p><p>274</p><p>275</p><p>276</p><p>277</p><p>278</p><p>279</p><p>280</p><p>281</p><p>282</p><p>283</p><p>284</p><p>285</p><p>286</p><p>287</p><p>288</p><p>289</p><p>290</p><p>291</p><p>292</p><p>293</p><p>294</p><p>295</p><p>296</p><p>297</p><p>298</p><p>299</p><p>300</p><p>301</p></div></td><td><div><p><span># -*- coding: utf-8 -*-</span></p><p><span>#&nbsp;&nbsp;Copyright (c) 2021. Eric Draken (ericdraken.com)</span></p><p><span>import</span><span> </span><span>ipaddress</span></p><p><span>import</span><span> </span><span>json</span></p><p><span>import</span><span> </span><span>os</span></p><p><span>import</span><span> </span><span>ssl</span></p><p><span>import</span><span> </span><span>sys</span></p><p><span>import</span><span> </span><span>time</span></p><p><span>import</span><span> </span><span>urllib</span><span>.</span><span>request</span></p><p><span>from</span><span> </span><span>typing </span><span>import</span><span> </span><span>Final</span><span>,</span><span> </span><span>Union</span></p><p><span>FILENAME</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>os.path</span><span>.</span><span>splitext</span><span>(</span><span>os.path</span><span>.</span><span>basename</span><span>(</span><span>__file__</span><span>)</span><span>)</span><span>[</span><span>0</span><span>]</span><span>.</span><span>upper</span><span>(</span><span>)</span></p><p><span>ALIAS_VPN_WILDCARDS</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>"VPN_wildcards"</span></p><p><span>ALIAS_VPN_DOMAINS</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>"VPN_domains"</span></p><p><span>ALIAS_VPN_WILDCARDS_TTL</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>60</span><span> </span><span>*</span><span> </span><span>60</span><span>&nbsp;&nbsp;</span><span># 1 Hour</span></p><p><span>ALIAS_VPN_WILDCARDS_CAPACITY</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>500</span></p><p><span>AUTH_CODE</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>"61646d696e 978c197c37a882f6da23553c1xxxxxxx"</span></p><p><span>TEST_MODE</span><span> </span><span>=</span><span> </span><span>True</span></p><p><span>if</span><span> </span><span>TEST_MODE</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>API_ALIAS_URL</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>"https://pfsense/api/v1/firewall/alias"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>API_ALIAS_ENTRY_URL</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>"https://pfsense/api/v1/firewall/alias/entry"</span></p><p><span>else</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>API_ALIAS_URL</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>"https://127.0.0.1/api/v1/firewall/alias"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>API_ALIAS_ENTRY_URL</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>"https://127.0.0.1/api/v1/firewall/alias/entry"</span></p><p><span># ***********************************</span></p><p><span>__wildcard_patterns</span><span> </span><span>=</span><span> </span><span>set</span><span>(</span><span>)</span></p><p><span>if</span><span> </span><span>TEST_MODE</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>log_info</span><span>(</span><span>msg</span><span>=</span><span>""</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>print</span><span>(</span><span>f</span><span>"{FILENAME}: {msg}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>log_err</span><span>(</span><span>msg</span><span>=</span><span>""</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>print</span><span>(</span><span>f</span><span>"{FILENAME}: {msg}"</span><span>)</span></p><p><span>else</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># noinspection PyUnresolvedReferences,PyUnboundLocalVariable</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>except</span><span> </span><span>NameError</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Added to suppress IDE errors about missing functions and constants</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>from</span><span> </span><span>unbound</span><span>.</span><span>pythonmod</span><span>.</span><span>unboundmodule </span><span>import</span><span> </span><span>(</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>register_inplace_cb_reply</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>register_inplace_cb_reply_cache</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>register_inplace_cb_reply_local</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MODULE_EVENT_NEW</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MODULE_EVENT_PASS</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MODULE_WAIT_MODULE</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MODULE_EVENT_MODDONE</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MODULE_FINISHED</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_err</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MODULE_ERROR</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Clarity of log messages</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>__old_log_info</span><span> </span><span>=</span><span> </span><span>log_info</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>__old_log_err</span><span> </span><span>=</span><span> </span><span>log_err</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>log_info</span><span>(</span><span>msg</span><span>=</span><span>""</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>__old_log_info</span><span>(</span><span>f</span><span>"{FILENAME}: {msg}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>log_err</span><span>(</span><span>msg</span><span>=</span><span>""</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>__old_log_err</span><span>(</span><span>f</span><span>"{FILENAME}: {msg}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>log_response</span><span>(</span><span>qstate</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>not</span><span> </span><span>qstate</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>r</span><span> </span><span>=</span><span> </span><span>None</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>qstate</span><span>.</span><span>return_msg </span><span>and</span><span> </span><span>qstate</span><span>.</span><span>return_msg</span><span>.</span><span>rep</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>r</span><span> </span><span>=</span><span> </span><span>qstate</span><span>.</span><span>return_msg</span><span>.</span><span>rep</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>q</span><span> </span><span>=</span><span> </span><span>None</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>qstate</span><span>.</span><span>return_msg </span><span>and</span><span> </span><span>qstate</span><span>.</span><span>return_msg</span><span>.</span><span>qinfo</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>q</span><span> </span><span>=</span><span> </span><span>qstate</span><span>.</span><span>return_msg</span><span>.</span><span>qinfo</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>q</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>test</span><span> </span><span>=</span><span> </span><span>str</span><span>(</span><span>q</span><span>.</span><span>qname_str</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>any</span><span>(</span><span>x</span><span> </span><span>in</span><span> </span><span>test</span><span> </span><span>for</span><span> </span><span>x</span><span> </span><span>in</span><span> </span><span>__wildcard_patterns</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>"HIT Query: %s, type: %s (%d), class: %s (%d) "</span><span> </span><span>%</span><span> </span><span>(</span><span>q</span><span>.</span><span>qname_str</span><span>,</span><span> </span><span>q</span><span>.</span><span>qtype_str</span><span>,</span><span> </span><span>q</span><span>.</span><span>qtype</span><span>,</span><span> </span><span>q</span><span>.</span><span>qclass_str</span><span>,</span><span> </span><span>q</span><span>.</span><span>qclass</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>r</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Do not crash the whole Unbound service</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>i</span><span> </span><span>in</span><span> </span><span>range</span><span>(</span><span>0</span><span>,</span><span> </span><span>r</span><span>.</span><span>rrset_count</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>rr</span><span> </span><span>=</span><span> </span><span>r</span><span>.</span><span>rrsets</span><span>[</span><span>i</span><span>]</span><span>&nbsp;&nbsp;</span><span># ReplyInfo_RRSet</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>rk</span><span> </span><span>=</span><span> </span><span>rr</span><span>.</span><span>rk</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>rk</span><span>.</span><span>rrset_class_str</span><span> </span><span>==</span><span> </span><span>"IN"</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>d</span><span> </span><span>=</span><span> </span><span>rr</span><span>.</span><span>entry</span><span>.</span><span>data</span><span>&nbsp;&nbsp;</span><span># RRSetData_RRData</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>j</span><span> </span><span>in</span><span> </span><span>range</span><span>(</span><span>0</span><span>,</span><span> </span><span>d</span><span>.</span><span>count</span><span> </span><span>+</span><span> </span><span>d</span><span>.</span><span>rrsig_count</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>rk</span><span>.</span><span>type_str</span><span> </span><span>==</span><span> </span><span>"A"</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ip</span><span> </span><span>=</span><span> </span><span>ipaddress</span><span>.</span><span>IPv4Address</span><span>(</span><span>d</span><span>.</span><span>rr_data</span><span>[</span><span>j</span><span>]</span><span>[</span><span>2</span><span>:</span><span>]</span><span>)</span><span>.</span><span>exploded</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>elif</span><span> </span><span>rk</span><span>.</span><span>type_str</span><span> </span><span>==</span><span> </span><span>"AAAA"</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ip</span><span> </span><span>=</span><span> </span><span>ipaddress</span><span>.</span><span>IPv6Address</span><span>(</span><span>d</span><span>.</span><span>rr_data</span><span>[</span><span>j</span><span>]</span><span>[</span><span>2</span><span>:</span><span>]</span><span>)</span><span>.</span><span>exploded</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Not an A or AAAA record</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>continue</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"{j}: IP: {ip!s}, TTL={d.rr_ttl[j]!s}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>add_wildcard_ips</span><span>(</span><span>str</span><span>(</span><span>ip</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>except</span><span> </span><span>Exception</span><span> </span><span>as</span><span> </span><span>e</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>exc_type</span><span>,</span><span> </span><span>exc_obj</span><span>,</span><span> </span><span>exc_tb</span><span> </span><span>=</span><span> </span><span>sys</span><span>.</span><span>exc_info</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_err</span><span>(</span><span>f</span><span>"{exc_type}, {exc_tb.tb_lineno}, {e}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>inplace_reply_callback</span><span>(</span><span>qinfo</span><span>,</span><span> </span><span>qstate</span><span>,</span><span> </span><span>rep</span><span>,</span><span> </span><span>rcode</span><span>,</span><span> </span><span>edns</span><span>,</span><span> </span><span>opt_list_out</span><span>,</span><span> </span><span>region</span><span>,</span><span> </span><span>*</span><span>*</span><span>kwargs</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_response</span><span>(</span><span>qstate</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>inplace_cache_callback</span><span>(</span><span>qinfo</span><span>,</span><span> </span><span>qstate</span><span>,</span><span> </span><span>rep</span><span>,</span><span> </span><span>rcode</span><span>,</span><span> </span><span>edns</span><span>,</span><span> </span><span>opt_list_out</span><span>,</span><span> </span><span>region</span><span>,</span><span> </span><span>*</span><span>*</span><span>kwargs</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># log_response(qstate)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>inplace_local_callback</span><span>(</span><span>qinfo</span><span>,</span><span> </span><span>qstate</span><span>,</span><span> </span><span>rep</span><span>,</span><span> </span><span>rcode</span><span>,</span><span> </span><span>edns</span><span>,</span><span> </span><span>opt_list_out</span><span>,</span><span> </span><span>region</span><span>,</span><span> </span><span>*</span><span>*</span><span>kwargs</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># log_response(qstate)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>init_standard</span><span>(</span><span>id_</span><span>,</span><span> </span><span>env</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>"Init start"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Register the inplace_reply_callback function as an inplace callback</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># function when answering a resolved query.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>not</span><span> </span><span>register_inplace_cb_reply</span><span>(</span><span>inplace_reply_callback</span><span>,</span><span> </span><span>env</span><span>,</span><span> </span><span>id_</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Register the inplace_cache_callback function as an inplace callback</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># function when answering from cache.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>not</span><span> </span><span>register_inplace_cb_reply_cache</span><span>(</span><span>inplace_cache_callback</span><span>,</span><span> </span><span>env</span><span>,</span><span> </span><span>id_</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Register the inplace_local_callback function as an inplace callback</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># function when answering from local data.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>not</span><span> </span><span>register_inplace_cb_reply_local</span><span>(</span><span>inplace_local_callback</span><span>,</span><span> </span><span>env</span><span>,</span><span> </span><span>id_</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Prepare the aliases</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>recreate_vpn_wildcards</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>global</span><span> </span><span>__wildcard_patterns</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>__wildcard_patterns</span><span> </span><span>=</span><span> </span><span>get_wildcard_patterns</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>"Init finished"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>deinit</span><span>(</span><span>id_</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>inform_super</span><span>(</span><span>id_</span><span>,</span><span> </span><span>qstate</span><span>,</span><span> </span><span>superqstate</span><span>,</span><span> </span><span>qdata</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>operate</span><span>(</span><span>id_</span><span>,</span><span> </span><span>event</span><span>,</span><span> </span><span>qstate</span><span>,</span><span> </span><span>qdata</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Wait for the Python module</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>event</span><span> </span><span>==</span><span> </span><span>MODULE_EVENT_NEW</span><span>)</span><span> </span><span>or</span><span> </span><span>(</span><span>event</span><span> </span><span>==</span><span> </span><span>MODULE_EVENT_PASS</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>qstate</span><span>.</span><span>ext_state</span><span>[</span><span>id_</span><span>]</span><span> </span><span>=</span><span> </span><span>MODULE_WAIT_MODULE</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Release when the Python module is finished</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>elif</span><span> </span><span>event</span><span> </span><span>==</span><span> </span><span>MODULE_EVENT_MODDONE</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>qstate</span><span>.</span><span>ext_state</span><span>[</span><span>id_</span><span>]</span><span> </span><span>=</span><span> </span><span>MODULE_FINISHED</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>qstate</span><span>.</span><span>ext_state</span><span>[</span><span>id_</span><span>]</span><span> </span><span>=</span><span> </span><span>MODULE_ERROR</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>def</span><span> </span><span>request</span><span>(</span><span>url</span><span>:</span><span> </span><span>str</span><span>,</span><span> </span><span>method</span><span>:</span><span> </span><span>str</span><span> </span><span>=</span><span> </span><span>"GET"</span><span>,</span><span> </span><span>body</span><span>:</span><span> </span><span>object</span><span> </span><span>=</span><span> </span><span>None</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Must be HTTPS</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>req</span><span> </span><span>=</span><span> </span><span>urllib</span><span>.</span><span>request</span><span>.</span><span>Request</span><span>(</span><span>url</span><span>=</span><span>url</span><span>,</span><span> </span><span>method</span><span>=</span><span>method</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>req</span><span>.</span><span>add_header</span><span>(</span><span>"Content-Type"</span><span>,</span><span> </span><span>"application/json"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>req</span><span>.</span><span>add_header</span><span>(</span><span>"Accept"</span><span>,</span><span> </span><span>"application/json"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>req</span><span>.</span><span>add_header</span><span>(</span><span>"Authorization"</span><span>,</span><span> </span><span>AUTH_CODE</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span> </span><span>=</span><span> </span><span>ssl</span><span>.</span><span>create_default_context</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span>.</span><span>check_hostname</span><span> </span><span>=</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span>.</span><span>verify_mode</span><span> </span><span>=</span><span> </span><span>ssl</span><span>.</span><span>CERT_NONE</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>data</span><span> </span><span>=</span><span> </span><span>None</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>body</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>data</span><span> </span><span>=</span><span> </span><span>json</span><span>.</span><span>dumps</span><span>(</span><span>body</span><span>)</span><span>.</span><span>encode</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>req</span><span>.</span><span>add_header</span><span>(</span><span>"Content-Length"</span><span>,</span><span> </span><span>str</span><span>(</span><span>len</span><span>(</span><span>data</span><span>)</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>res</span><span> </span><span>=</span><span> </span><span>urllib</span><span>.</span><span>request</span><span>.</span><span>urlopen</span><span>(</span><span>req</span><span>,</span><span> </span><span>data</span><span>,</span><span> </span><span>context</span><span>=</span><span>ctx</span><span>,</span><span> </span><span>timeout</span><span>=</span><span>1</span><span>)</span><span>&nbsp;&nbsp;</span><span># Short timeout!</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>json_</span><span> </span><span>=</span><span> </span><span>json</span><span>.</span><span>load</span><span>(</span><span>res</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>"data"</span><span> </span><span>not</span><span> </span><span>in</span><span> </span><span>json_</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_err</span><span>(</span><span>f</span><span>"data attribute is missing: {json_}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># log_info(json_)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>json_</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>except</span><span> </span><span>Exception</span><span> </span><span>as</span><span> </span><span>e</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_err</span><span>(</span><span>e</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>False</span></p><p><span>def</span><span> </span><span>recreate_vpn_wildcards</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Check if the VPN_wildcard_ips alias exists</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>aliases</span><span> </span><span>=</span><span> </span><span>request</span><span>(</span><span>API_ALIAS_URL</span><span>,</span><span> </span><span>"GET"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>alias </span><span>in</span><span> </span><span>aliases</span><span>[</span><span>"data"</span><span>]</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>"name"</span><span> </span><span>in</span><span> </span><span>alias </span><span>and</span><span> </span><span>alias</span><span>[</span><span>"name"</span><span>]</span><span> </span><span>==</span><span> </span><span>ALIAS_VPN_WILDCARDS</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"Deleting existing {ALIAS_VPN_WILDCARDS}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># FIXME: If tied to a rule... it 400s</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>request</span><span>(</span><span>API_ALIAS_URL</span><span>,</span><span> </span><span>"DELETE"</span><span>,</span><span> </span><span>{</span><span>"id"</span><span>:</span><span> </span><span>ALIAS_VPN_WILDCARDS</span><span>,</span><span> </span><span>"apply"</span><span>:</span><span> </span><span>True</span><span>}</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>break</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Create</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"Creating {ALIAS_VPN_WILDCARDS}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>request</span><span>(</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>API_ALIAS_URL</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"POST"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"name"</span><span>:</span><span> </span><span>ALIAS_VPN_WILDCARDS</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"type"</span><span>:</span><span> </span><span>"host"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"descr"</span><span>:</span><span> </span><span>f</span><span>"Automatic {ALIAS_VPN_DOMAINS} wildcard expansions"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"address"</span><span>:</span><span> </span><span>[</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"detail"</span><span>:</span><span> </span><span>[</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"apply"</span><span>:</span><span> </span><span>True</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Check</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>aliases</span><span> </span><span>=</span><span> </span><span>request</span><span>(</span><span>API_ALIAS_URL</span><span>,</span><span> </span><span>"GET"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>alias </span><span>in</span><span> </span><span>aliases</span><span>[</span><span>"data"</span><span>]</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>"name"</span><span> </span><span>in</span><span> </span><span>alias </span><span>and</span><span> </span><span>alias</span><span>[</span><span>"name"</span><span>]</span><span> </span><span>==</span><span> </span><span>ALIAS_VPN_WILDCARDS</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"Successfully created {ALIAS_VPN_WILDCARDS}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"Unable to create {ALIAS_VPN_WILDCARDS}"</span><span>)</span></p><p><span>def</span><span> </span><span>evict_wildcard_ips</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>cutoff</span><span> </span><span>=</span><span> </span><span>int</span><span>(</span><span>time</span><span>.</span><span>time</span><span>(</span><span>)</span><span>)</span><span> </span><span>-</span><span> </span><span>ALIAS_VPN_WILDCARDS_TTL</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>res</span><span> </span><span>=</span><span> </span><span>request</span><span>(</span><span>API_ALIAS_URL</span><span>,</span><span> </span><span>"GET"</span><span>,</span><span> </span><span>{</span><span>"name"</span><span>:</span><span> </span><span>ALIAS_VPN_WILDCARDS</span><span>}</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>data</span><span>:</span><span> </span><span>dict</span><span> </span><span>=</span><span> </span><span>res</span><span>[</span><span>"data"</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>data</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>alias</span><span> </span><span>=</span><span> </span><span>data</span><span>.</span><span>popitem</span><span>(</span><span>)</span><span>[</span><span>1</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>addresses</span><span> </span><span>=</span><span> </span><span>str</span><span>(</span><span>alias</span><span>[</span><span>"address"</span><span>]</span><span>)</span><span>.</span><span>split</span><span>(</span><span>" "</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>timestamps</span><span> </span><span>=</span><span> </span><span>str</span><span>(</span><span>alias</span><span>[</span><span>"detail"</span><span>]</span><span>)</span><span>.</span><span>split</span><span>(</span><span>"||"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>assert</span><span> </span><span>len</span><span>(</span><span>addresses</span><span>)</span><span> </span><span>==</span><span> </span><span>len</span><span>(</span><span>timestamps</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>evictable</span><span> </span><span>=</span><span> </span><span>[</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>timestamp</span><span>,</span><span> </span><span>address </span><span>in</span><span> </span><span>zip</span><span>(</span><span>timestamps</span><span>,</span><span> </span><span>addresses</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>int</span><span>(</span><span>timestamp</span><span>)</span><span> </span><span>&lt;</span><span> </span><span>cutoff</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>evictable</span><span>.</span><span>append</span><span>(</span><span>address</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>len</span><span>(</span><span>evictable</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"Evicting {evictable}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>request</span><span>(</span><span>url</span><span>=</span><span>API_ALIAS_ENTRY_URL</span><span>,</span><span> </span><span>method</span><span>=</span><span>"DELETE"</span><span>,</span><span> </span><span>body</span><span>=</span><span>{</span><span>"name"</span><span>:</span><span> </span><span>ALIAS_VPN_WILDCARDS</span><span>,</span><span> </span><span>"address"</span><span>:</span><span> </span><span>evictable</span><span>,</span><span> </span><span>"apply"</span><span>:</span><span> </span><span>True</span><span>}</span><span>)</span></p><p><span>def</span><span> </span><span>add_wildcard_ips</span><span>(</span><span>ips</span><span>:</span><span> </span><span>Union</span><span>[</span><span>str</span><span>,</span><span> </span><span>list</span><span>]</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>isinstance</span><span>(</span><span>ips</span><span>,</span><span> </span><span>str</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ips</span><span> </span><span>=</span><span> </span><span>[</span><span>ips</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ips_repr</span><span> </span><span>=</span><span> </span><span>", "</span><span>.</span><span>join</span><span>(</span><span>ips</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"Adding [{ips_repr}]"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>res</span><span> </span><span>=</span><span> </span><span>request</span><span>(</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>API_ALIAS_ENTRY_URL</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"POST"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"name"</span><span>:</span><span> </span><span>ALIAS_VPN_WILDCARDS</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"type"</span><span>:</span><span> </span><span>"host"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"descr"</span><span>:</span><span> </span><span>ips_repr</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"address"</span><span>:</span><span> </span><span>ips</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"detail"</span><span>:</span><span> </span><span>[</span><span>str</span><span>(</span><span>int</span><span>(</span><span>time</span><span>.</span><span>time</span><span>(</span><span>)</span><span>)</span><span>)</span><span>]</span><span> </span><span>*</span><span> </span><span>len</span><span>(</span><span>ips</span><span>)</span><span>,</span><span>&nbsp;&nbsp;</span><span># Must be a string</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>details</span><span> </span><span>=</span><span> </span><span>res</span><span>[</span><span>"data"</span><span>]</span><span>[</span><span>"detail"</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># len("1638002792||") == 12</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>len</span><span>(</span><span>details</span><span>)</span><span> </span><span>&gt;=</span><span> </span><span>(</span><span>12</span><span> </span><span>*</span><span> </span><span>ALIAS_VPN_WILDCARDS_CAPACITY</span><span>)</span><span> </span><span>-</span><span> </span><span>2</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>"Capacity reached. Starting eviction..."</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>evict_wildcard_ips</span><span>(</span><span>)</span></p><p><span>def</span><span> </span><span>get_wildcard_patterns</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>patterns</span><span> </span><span>=</span><span> </span><span>set</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>res</span><span> </span><span>=</span><span> </span><span>request</span><span>(</span><span>API_ALIAS_URL</span><span>,</span><span> </span><span>"GET"</span><span>,</span><span> </span><span>{</span><span>"name"</span><span>:</span><span> </span><span>ALIAS_VPN_DOMAINS</span><span>}</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>data</span><span>:</span><span> </span><span>dict</span><span> </span><span>=</span><span> </span><span>res</span><span>[</span><span>"data"</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>data</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>alias</span><span> </span><span>=</span><span> </span><span>data</span><span>.</span><span>popitem</span><span>(</span><span>)</span><span>[</span><span>1</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>details</span><span> </span><span>=</span><span> </span><span>str</span><span>(</span><span>alias</span><span>[</span><span>"detail"</span><span>]</span><span>)</span><span>.</span><span>split</span><span>(</span><span>"||"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>detail </span><span>in</span><span> </span><span>details</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>"*."</span><span> </span><span>in</span><span> </span><span>detail </span><span>or</span><span> </span><span>".*"</span><span> </span><span>in</span><span> </span><span>detail</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>patterns</span><span>.</span><span>add</span><span>(</span><span>detail</span><span>.</span><span>replace</span><span>(</span><span>"*."</span><span>,</span><span> </span><span>"."</span><span>)</span><span>.</span><span>replace</span><span>(</span><span>".*"</span><span>,</span><span> </span><span>"."</span><span>)</span><span>)</span><span>&nbsp;&nbsp;</span><span># TODO: Make robust</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>addresses</span><span> </span><span>=</span><span> </span><span>str</span><span>(</span><span>alias</span><span>[</span><span>"address"</span><span>]</span><span>)</span><span>.</span><span>split</span><span>(</span><span>" "</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>address </span><span>in</span><span> </span><span>addresses</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>patterns</span><span>.</span><span>add</span><span>(</span><span>address</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"Found wildcard patterns: {patterns}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>patterns</span></p><p><span>if</span><span> </span><span>TEST_MODE</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>__name__</span><span> </span><span>==</span><span> </span><span>"__main__"</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>"Init start"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>recreate_vpn_wildcards</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>add_wildcard_ips</span><span>(</span><span>"1.2.3.4"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>add_wildcard_ips</span><span>(</span><span>[</span><span>"1.2.3.4"</span><span>,</span><span> </span><span>"1.2.3.5"</span><span>]</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>evict_wildcard_ips</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>get_wildcard_patterns</span><span>(</span><span>)</span></p></div></td></tr></tbody></table></div><p>When I woke up, the Unbound DNS resolver service <strong>segfaulted</strong>. Here are the logs:</p><figure id="attachment_5653"><a href="https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update.png"><img src="https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update.png" alt="We can see a full FQDN alias re-process on each firewall config update" width="626" height="913" srcset="https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update.png 626w, https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update-206x300.png 206w, https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update-600x875.png 600w" sizes="(max-width: 626px) 100vw, 626px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update.png" data-srcset="https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update.png 626w, https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update-206x300.png 206w, https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update-600x875.png 600w"></a><figcaption>We can see a full FQDN alias re-process on each firewall config update</figcaption></figure><div><p><strong>Failure:</strong> Capturing all the IPs from the DNS queries to <code>*.googlevideo.com</code> and <code>*.google.com</code> puts pfSense into a crawl as all the rules need to be reloaded on each addition.</p></div><p><a href="#top">Top ↩</a></p><hr><div><p><a name="new-goal2"></a><strong>New Goal:</strong> Research and install a Squid-like proxy, create a fake-but-trusted CA certificate, host it, install it in a browser as a PoC, decode TLS traffic, and victory dance.</p></div><p>Actually, it is <em>not</em> illegal to <a href="https://github.com/NSSpiral/Blackb0x" target="_blank" rel="nofollow">jailbreak most Apple TV boxes</a>, so we could break in, add a root certificate valid for the pfSense box, MITM traffic from the Apple TV, and then Microsoft Bob is your uncle. That works because the pfSense box as the gateway can decrypt Apple TV traffic, inspect the request headers for the offending ad <code>hostname</code>, block the request, and re-encrypt other valid requests to Mountainview, California.</p><p>But, then my iPhone would still show ads because it is harder to jailbreak, plus banking apps may detect this and not work anymore. Jailbreaking is too extreme, anyway.</p><div><p><a name="jailbreak"></a><strong>Fun fact:</strong> I used a jailbroken iPhone all the time in Japan because of a quirky cellphone law. You see, because of icky perverts who like to take photos inappropriately on elevators and escalators, Japan passed a law that made the camera shutter sound mandatory on all photos.<br><span>&nbsp;</span><br>Super unfortunate was that taking a <em>screenshot</em> of a web page also made the same loud, unmuteable shutter sound. Imagine you are on a train and you screenshot a Google map, it makes that loud shutter noise, and then you get dirty looks from the train riders. Yeah, I had to jailbreak and zero out the camera sound file.</p></div><p>Let’s see what it takes to spy on the HTTPS traffic from the Apple TV and iPhone to see if we can block ad URLs that way.</p><p><a href="#top">Top ↩</a></p><hr><h2>Install a Fake-but-Trusted CA Cert on Apple TV and iPhone?</h2><p>Not wanting to jailbreak and add self-signed certs to Apple TV and iPhone, how hard would it be instead to add fake-but-trusted Certificate Authority (CA) certificates to each device?</p><p>The ‘A’ in CA means there is no one higher to vet such a certificate. The ‘A’ is so powerful, that back in 2001 only a Windows patch was able to revoke some <a href="https://en.wikipedia.org/wiki/Verisign#2001:_Code_signing_certificate_mistake" target="_blank" rel="nofollow">dangerous Verisign certificates</a>. As a thought experiment, new CAs must come into existence from time to time. Let’s Encrypt is relatively new, for example. There should then be an in-warranty way to get a fake, trusted CA cert into an Apple TV and iPhone. If that is possible, then an entire world of MITM spycraft is available to decrypt TLS packets in the clear and use good ‘ol URL blocking on requests like</p><div id="crayon-63661eaabe4ce917346489" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>https</span><span>:</span><span>/</span><span>/</span><span>www</span><span>.youtube</span><span>.com</span><span>/</span><span>pagead</span><span>/</span><span>viewthroughconversion</span><span>/</span><span>.</span><span>.</span><span>.</span></p><p><span>https</span><span>:</span><span>/</span><span>/</span><span>www</span><span>.youtube</span><span>.com</span><span>/</span><span>pagead</span><span>/</span><span>conversion</span><span>/</span><span>.</span><span>.</span><span>.</span></p></div></td></tr></tbody></table></div><p>Let’s see how easy this would be.</p><figure id="attachment_5684"><a href="https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too.jpg"><img src="https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-754x353.jpg" alt="We can add fake, trusted CA certs to iPhone too" width="754" height="353" srcset="https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-754x353.jpg 754w, https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-300x141.jpg 300w, https://static.ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-600x281.jpg 600w, https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too.jpg 1280w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-754x353.jpg" data-srcset="https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-754x353.jpg 754w, https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-300x141.jpg 300w, https://static.ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-600x281.jpg 600w, https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too.jpg 1280w"></a><figcaption>We can add fake, trusted CA certs to iPhone too</figcaption></figure><p>In fact, there are many, many CAs. Here is a quick <code>find / -name "*.pem"</code> in pfSense:</p><figure id="attachment_5702"><a href="https://static.ericdraken.com/files/Many-CAs-exist-already.png"><img src="https://static.ericdraken.com/files/Many-CAs-exist-already-754x320.png" alt="Many CAs exist already" width="754" height="320" srcset="https://static.ericdraken.com/files/Many-CAs-exist-already-754x320.png 754w, https://static.ericdraken.com/files/Many-CAs-exist-already-300x127.png 300w, https://static.ericdraken.com/files/Many-CAs-exist-already-600x254.png 600w, https://static.ericdraken.com/files/Many-CAs-exist-already.png 880w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Many-CAs-exist-already-754x320.png" data-srcset="https://static.ericdraken.com/files/Many-CAs-exist-already-754x320.png 754w, https://static.ericdraken.com/files/Many-CAs-exist-already-300x127.png 300w, https://static.ericdraken.com/files/Many-CAs-exist-already-600x254.png 600w, https://static.ericdraken.com/files/Many-CAs-exist-already.png 880w"></a><figcaption>Many CAs exist already</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Experiment with Squid and SquidGuard</h2><p>I’m aware of <a href="https://mitmproxy.org/" target="_blank" rel="nofollow">mitmproxy</a>, but it needs to be side-channel installed onto the pfSense router. Let’s see if the <code>squid3</code> proxy that is available as a pfSense package can do what we need. First, I will take a bare-metal backup again so I can roll back in case <code>mitmproxy</code> is better.</p><figure id="attachment_5691"><a href="https://static.ericdraken.com/files/Install-squid3-and-ancillary-packages.png"><img src="https://ericdraken.com/files/Install-squid3-and-ancillary-packages-754x348.png" alt="Install squid3 and ancillary packages" width="754" height="348" srcset="https://ericdraken.com/files/Install-squid3-and-ancillary-packages-754x348.png 754w, https://static.ericdraken.com/files/Install-squid3-and-ancillary-packages-300x139.png 300w, https://ericdraken.com/files/Install-squid3-and-ancillary-packages-600x277.png 600w, https://static.ericdraken.com/files/Install-squid3-and-ancillary-packages.png 1147w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Install-squid3-and-ancillary-packages-754x348.png" data-srcset="https://ericdraken.com/files/Install-squid3-and-ancillary-packages-754x348.png 754w, https://static.ericdraken.com/files/Install-squid3-and-ancillary-packages-300x139.png 300w, https://ericdraken.com/files/Install-squid3-and-ancillary-packages-600x277.png 600w, https://static.ericdraken.com/files/Install-squid3-and-ancillary-packages.png 1147w"></a><figcaption>Install squid3 and ancillary packages</figcaption></figure><p>I’ve installed those packages, and naturally, there are more buttons and options than in a space shuttle. I’ll find a <a href="https://turbofuture.com/internet/Intercepting-HTTPS-Traffic-Using-the-Squid-Proxy-in-pfSense" target="_blank" rel="nofollow">guide</a>.</p><p>I’ve followed the steps in the guide, however, since I have a large SSD and generous RAM, I’ve made a dedicated folder <code>/squid_cache</code> (and <code>chown squid:proxy</code>) with 8 GiB of cache and a juicy allowance on the per-item cache size which should also help with Docker and NPM speed-up. Two birds, one stone. With Transparent HTTPS support, this should be pretty rad.</p><div><p><strong>Tip:</strong> If web traffic slows down while using Squid, here are some System Tunables that can make Squid faster (<a href="https://forum.netgate.com/topic/85937/pfsense-2-2-3-internet-is-very-slow-via-squid3/12" target="_blank" rel="nofollow">ref</a>):</p><p><code>vfs.read_max 128</code><br><code>kern.ipc.nmbclusters 32768</code></p><p>Also, for local disk cache, <code>aufs</code> is asynchronous <code>ufs</code> (great for Docker too) and uses POSIX-threads to avoid blocking the main Squid process on disk-I/O.<br></p></div><p>We can actually generate a CA cert in pfSense itself.</p><figure id="attachment_5695"><a href="https://static.ericdraken.com/files/Generate-a-CA-in-pfSense.png"><img src="https://static.ericdraken.com/files/Generate-a-CA-in-pfSense-754x275.png" alt="Generate a CA in pfSense" width="754" height="275" srcset="https://static.ericdraken.com/files/Generate-a-CA-in-pfSense-754x275.png 754w, https://ericdraken.com/files/Generate-a-CA-in-pfSense-300x109.png 300w, https://ericdraken.com/files/Generate-a-CA-in-pfSense-600x219.png 600w, https://static.ericdraken.com/files/Generate-a-CA-in-pfSense.png 1137w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Generate-a-CA-in-pfSense-754x275.png" data-srcset="https://static.ericdraken.com/files/Generate-a-CA-in-pfSense-754x275.png 754w, https://ericdraken.com/files/Generate-a-CA-in-pfSense-300x109.png 300w, https://ericdraken.com/files/Generate-a-CA-in-pfSense-600x219.png 600w, https://static.ericdraken.com/files/Generate-a-CA-in-pfSense.png 1137w"></a><figcaption>Generate a CA in pfSense</figcaption></figure><p>Now, how to get it into the Apple TV and iPhone? It should be hosted somewhere, right? How about on the router?</p><p><a href="#top">Top ↩</a></p><hr><h2>Self-Host the MITM CA Certificate</h2><p>Self-hosting with a single command is ridiculously easy. From the SSH shell into pfSense, I can create a web folder and server like so:</p><div id="crayon-63661eaabe4d3248535284" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>mkdir</span><span> </span><span>/</span><span>www</span></p><p><span>chown</span><span> </span><span>-</span><span>R</span><span> </span><span>squid</span><span>:</span><span>proxy</span><span> </span><span>/</span><span>www</span></p><p><span>chmod</span><span> </span><span>-</span><span>R</span><span> </span><span>644</span><span> </span><span>/</span><span>www</span></p><p><span>echo</span><span> </span><span>"Hello"</span><span> </span><span>&gt;</span><span> </span><span>/</span><span>www</span><span>/</span><span>index</span><span>.php</span></p><p><span>php</span><span> </span><span>-</span><span>S</span><span> </span><span>0.0.0.0</span><span>:</span><span>8000</span><span> </span><span>-</span><span>t</span><span> </span><span>/</span><span>www</span></p></div></td></tr></tbody></table></div><p>When I visit <code>//pfsense:8000</code> I should get a blank page with “Hello”. From here, clients behind the pfSense router can temporarily access static documents.</p><p>To make like easier, here is a PHP script to cause the MITM cert to download.</p><div id="crayon-63661eaabe4d5989096513" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>&lt;?php</span></p><p><span>$file</span><span> </span><span>=</span><span> </span><span>'/www/mitm.crt'</span><span>;</span></p><p><span>if</span><span> </span><span>(</span><span>file_exists</span><span>(</span><span>$file</span><span>)</span><span>)</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>header</span><span>(</span><span>'Content-Description: File Transfer'</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>header</span><span>(</span><span>'Content-Type: application/octet-stream'</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>header</span><span>(</span><span>'Content-Disposition: attachment; filename="'</span><span>.</span><span>basename</span><span>(</span><span>$file</span><span>)</span><span>.</span><span>'"'</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>header</span><span>(</span><span>'Expires: 0'</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>header</span><span>(</span><span>'Cache-Control: must-revalidate'</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>header</span><span>(</span><span>'Pragma: public'</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>header</span><span>(</span><span>'Content-Length: '</span><span> </span><span>.</span><span> </span><span>filesize</span><span>(</span><span>$file</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>readfile</span><span>(</span><span>$file</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>exit</span><span>;</span></p><p><span>}</span></p><p><span>echo</span><span> </span><span>"Not found"</span><span>;</span></p></div></td></tr></tbody></table></div><p>As another smoke test, I’ll add the MITM CA to Chrome (manually) and enable the SSL Filtering. The defaults are fine in Squid. Here is the log file when I visit <code>https://ericdraken.com</code>:</p><figure id="attachment_5704"><a href="https://ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client.png"><img src="https://ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-754x122.png" alt="Successful capture of TLS requests from a downstream client" width="754" height="122" srcset="https://ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-754x122.png 754w, https://static.ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-300x48.png 300w, https://static.ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-600x97.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-754x122.png" data-srcset="https://ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-754x122.png 754w, https://static.ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-300x48.png 300w, https://static.ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-600x97.png 600w"></a><figcaption>Successful capture of TLS requests from a downstream client</figcaption></figure><p>Excellent.</p><p>However, on every other browser and machine there are HTTPS errors like so:</p><figure id="attachment_5705"><a href="https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing.png"><img src="https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-754x485.png" alt="MITM certificate errors if the CA cert is missing" width="754" height="485" srcset="https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-754x485.png 754w, https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-300x193.png 300w, https://ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-600x386.png 600w, https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing.png 966w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-754x485.png" data-srcset="https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-754x485.png 754w, https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-300x193.png 300w, https://ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-600x386.png 600w, https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing.png 966w"></a><figcaption>MITM certificate errors if the CA cert is missing</figcaption></figure><div><p><strong>Locked out?</strong> If you get locked out of pfSense with a TLS error, you may have to disable Remote Cert Checks as the pfSense web configurator uses a self-signed certificate. Or else, you can bypass the proxy for the pfSense UI under <em>Bypass Proxy for These Destination IPs</em> with <code>pfsense; pfsense.localdomain</code>.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Abandoning Squid: Too Slow, Too Heavy</h2><p>After a day of painfully setting up Squid and SquidGuard and adding blacklists and even manual regex for things like <code>.+?/pagead/.+</code>, I’m having nothing but issues with Squid. Here are the top pain points:</p><ul><li>It’s slow. It’s really slow.</li><li>The ACL (Access Control List) settings are cumbersome.</li><li>There is an issue with <code>https://http/*</code> (<a href="https://forum.netgate.com/topic/141472/https-filter-with-https-http" target="_blank" rel="nofollow">ref</a>).</li><li>The SquidGuard URL filter takes eons to update a list.</li><li>The Squid UI is unbelievably lacking.</li></ul><p>Squid makes me sad. I don’t get sad, but Squid makes me sad with its promise and ultimate letdown. I’ve now obliterated Squid and restored the router from the <code>rsync</code> backup I made earlier. Here is a handy little script to show a diff of what has been added by Squid and related packages.</p><h3>Rsync Diff of Changes</h3><div id="crayon-63661eaabe4d9273516381" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p></div></td><td><div><p><span># Show the changed files since the last rsync.</span></p><p><span># Fix brace expansion and execute (easy to read with tr and sed).</span></p><p><span>cat</span><span> </span><span>&lt;&lt;</span><span> </span><span>EOF</span><span> </span><span>|</span><span> </span><span>tr</span><span> </span><span>-</span><span>s</span><span> </span><span>' '</span><span> </span><span>|</span><span> </span><span>sed</span><span> </span><span>'s/, "/,"/g'</span><span> </span><span>|</span><span> </span><span>bash</span></p><p><span>time</span><span> </span><span>\</span></p><p><span>rsync</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>verbose</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>human</span><span>-</span><span>readable</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>links</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>recursive</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>checksum</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>update</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>delete</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>dry</span><span>-</span><span>run</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>exclude</span><span>=</span><span>{</span><span>"/dev/*"</span><span>,</span><span>"/proc/*"</span><span>,</span><span>"/sys/*"</span><span>,</span><span>"/tmp/*"</span><span>,</span><span>"/run/*"</span><span>,</span><span>\</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"/var/*"</span><span>,</span><span>"/mnt/*"</span><span>,</span><span>"/media/*"</span><span>,</span><span>"/lost+found"</span><span>}</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>rsh</span><span>=</span><span>"ssh -p 2222"</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>~</span><span>/</span><span>.pfsense</span><span>-</span><span>backup</span><span>/</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>admin</span><span>@</span><span>pfsense</span><span>:</span><span>/</span><span> </span><span>|</span><span> </span><span>grep</span><span> </span><span>-</span><span>v</span><span> </span><span>'/$'</span><span>&nbsp;&nbsp;</span><span># Hide folders</span></p><p><span>EOF</span></p></div></td></tr></tbody></table></div><p>The output is something like this under the <code>--dry-run</code> option:</p><div id="crayon-63661eaabe4db777065170" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="hide"></td><td><div><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squidGuard</span><span>/</span><span>squidguard_conf</span><span>.xml</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squidGuard</span><span>/</span><span>squidGuard_blk_rebuild</span><span>.conf</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squidGuard</span><span>/</span><span>squidGuard__usrdbrebuild</span><span>.conf</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squidGuard</span><span>/</span><span>squidGuard</span><span>.conf</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squidGuard</span><span>/</span><span>blacklist</span><span>.files</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squid</span><span>/</span><span>squidGuard</span><span>.conf</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squid</span><span>/</span><span>squid</span><span>.conf</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squid</span><span>/</span><span>serverkey</span><span>.pem</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squid</span><span>/</span><span>exclude_domains</span><span>.conf</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>lightsquid</span><span>/</span><span>lightsquid</span><span>.cfg</span></p><p><span>.</span><span>.</span><span>.</span></p></div></td></tr></tbody></table></div><p><a href="#top">Top ↩</a></p><hr><h2>Install MITMProxy in a FreeBSD Jail</h2><p>Even though written in Python, I’ll give <a href="https://mitmproxy.org/" target="_blank" rel="nofollow">mitmproxy</a> a try next; at the very least it can be purpose-built to block YouTube ads with its rich API and Python-hook extensibility. It was a coin toss between <code>mitmproxy</code> and <code>SSLSplit</code> – a Metasploit hack tool – to achieve on-the-fly TLS interception, but the former can be scripted with Python and has a satisfying UI. Let’s go.</p><div><p><strong>Careful:</strong> Please read the whole section before trying any commands because I backtracked a bit but want to explain why.</p></div><div id="crayon-63661eaabe4de391025133" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>set </span><span>LATEST</span><span>=</span><span>7.0.4</span></p><p><span>mkdir</span><span> </span><span>/</span><span>tmp</span><span>/</span><span>mitm</span><span>-</span><span>$</span><span>{</span><span>LATEST</span><span>}</span><span> </span><span>&amp;&amp;</span><span> </span><span>cd</span><span> </span><span>/</span><span>tmp</span><span>/</span><span>mitm</span><span>-</span><span>$</span><span>{</span><span>LATEST</span><span>}</span></p><p><span>curl </span><span>https</span><span>:</span><span>/</span><span>/</span><span>snapshots</span><span>.mitmproxy</span><span>.org</span><span>/</span><span>$</span><span>{</span><span>LATEST</span><span>}</span><span>/</span><span>mitmproxy</span><span>-</span><span>$</span><span>{</span><span>LATEST</span><span>}</span><span>-</span><span>linux</span><span>.tar</span><span>.gz</span><span> </span><span>--</span><span>output</span><span> </span><span>mitmproxy</span><span>-</span><span>$</span><span>{</span><span>LATEST</span><span>}</span><span>.tar</span><span>.gz</span></p><p><span>tar</span><span> </span><span>-</span><span>xvzf</span><span> </span><span>mitmproxy</span><span>-</span><span>$</span><span>{</span><span>LATEST</span><span>}</span><span>.tar</span><span>.gz</span><span> </span><span>&amp;&amp;</span><span> </span><span>rm</span><span> </span><span>mitmproxy</span><span>-</span><span>$</span><span>{</span><span>LATEST</span><span>}</span><span>.tar</span><span>.gz</span></p></div></td></tr></tbody></table></div><p>You’ll notice that there are only three binaries about 24 MiB each. As I understand it, they have a self-contained Python 3 environment and frozen dependencies. I’d like to jail these binaries because, well, because. First, let’s see if there is a vulnerability report for <code>mitmproxy</code> at <a href="https://vuxml.freebsd.org/freebsd/index.html" target="_blank" rel="nofollow">vuxml.freebsd.org</a>. Nothing. How about at <a href="https://www.exploit-db.com/" target="_blank" rel="nofollow">Exploit-DB</a>? Nothing again. Good.</p><p>First, what version of FreeBSD is this pfSense install?</p><div id="crayon-63661eaabe4e0675538432" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>freebsd</span><span>-</span><span>version</span><span> </span><span>-</span><span>k</span></p><p><span># 12.2-Stable</span></p><p><span>getconf</span><span> </span><span>LONG_BIT</span></p><p><span># 64 - This means we are using a 64-bit build</span></p></div></td></tr></tbody></table></div><p>Now, according to this <a href="https://blog.viktorpetersson.com/2018/01/27/jails-on-pfsense.html" target="_blank" rel="nofollow">guide</a>, I’ll need to set up jails myself as they are disabled in a default pfSense installation. Not knowing FreeBSD at all before today, I had to hack around to find a URL to download the <code>ezjail</code> package manually. After another bare-metal backup, here are the steps I took:</p><div id="crayon-63661eaabe4e2901951388" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p></div></td><td><div><p><span># Set versions</span></p><p><span>set </span><span>EZ_VER</span><span>=</span><span>3.4.2_1</span></p><p><span>set </span><span>BSD_VER</span><span>=</span><span>12</span></p><p><span># Install the ezjail package manually</span></p><p><span>mkdir</span><span> </span><span>/</span><span>tmp</span><span>/</span><span>ezjail</span><span> </span><span>&amp;&amp;</span><span> </span><span>cd</span><span> </span><span>/</span><span>tmp</span><span>/</span><span>ezjail</span></p><p><span>curl </span><span>https</span><span>:</span><span>/</span><span>/</span><span>pkg</span><span>.freebsd</span><span>.org</span><span>/</span><span>FreeBSD</span><span>:</span><span>$</span><span>{</span><span>BSD_VER</span><span>}</span><span>:</span><span>amd64</span><span>/</span><span>latest</span><span>/</span><span>All</span><span>/</span><span>ezjail</span><span>-</span><span>$</span><span>{</span><span>EZ_VER</span><span>}</span><span>.pkg</span><span> </span><span>--</span><span>output</span><span> </span><span>ezjail</span><span>-</span><span>$</span><span>{</span><span>EZ_VER</span><span>}</span><span>.pkg</span></p><p><span>pkg</span><span> </span><span>add</span><span> </span><span>ezjail</span><span>-</span><span>$</span><span>{</span><span>EZ_VER</span><span>}</span><span>.pkg</span></p><p><span># Add a missing jail RC file</span></p><p><span># NOTE: Version 12 does not exist, so use 11</span></p><p><span>curl</span><span> </span><span>--</span><span>output </span><span>jail</span><span>.tmp</span><span> </span><span>https</span><span>:</span><span>/</span><span>/</span><span>raw</span><span>.githubusercontent</span><span>.com</span><span>/</span><span>freebsd</span><span>/</span><span>freebsd</span><span>/</span><span>stable</span><span>/</span><span>11</span><span>/</span><span>etc</span><span>/</span><span>rc</span><span>.d</span><span>/</span><span>jail</span></p><p><span># Check that we did not get a 404d file</span></p><p><span>(</span><span>cat</span><span> </span><span>jail</span><span>.tmp</span><span> </span><span>|</span><span> </span><span>grep</span><span> </span><span>-</span><span>q</span><span> </span><span>"FreeBSD"</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>&amp;&amp;</span><span> </span><span>mv</span><span> </span><span>jail</span><span>.tmp</span><span> </span><span>/</span><span>etc</span><span>/</span><span>rc</span><span>.d</span><span>/</span><span>jail</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>&amp;&amp;</span><span> </span><span>chmod</span><span> </span><span>+</span><span>x</span><span> </span><span>/</span><span>etc</span><span>/</span><span>rc</span><span>.d</span><span>/</span><span>jail</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>&amp;&amp;</span><span> </span><span>chmod</span><span> </span><span>u</span><span>-</span><span>w</span><span> </span><span>/</span><span>etc</span><span>/</span><span>rc</span><span>.d</span><span>/</span><span>jail</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>&amp;&amp;</span><span> </span><span>echo</span><span> </span><span>"Success"</span><span>)</span><span> </span><span>\</span></p><p><span>||</span><span> </span><span>echo</span><span> </span><span>"Download failed"</span></p><p><span># Enable jails by writing a file that may not exist</span></p><p><span>echo</span><span> </span><span>'ezjail_enable="YES"'</span><span> </span><span>|</span><span> </span><span>tee</span><span> </span><span>-</span><span>a</span><span> </span><span>/</span><span>etc</span><span>/</span><span>rc</span><span>.conf</span><span>.local</span></p><p><span># Init jails (takes about 30s)</span></p><p><span>ezjail</span><span>-</span><span>admin </span><span>install</span></p></div></td></tr></tbody></table></div><p>We need to do some hacking to get <code>jail</code> working on pfSense’s take on FreeBSD because <code>jail</code> is missing completely. What I’ve done is copy the <code>jail</code> binaries <em>from</em> a jail (via <code>ezjail</code>) back to the root system.</p><div id="crayon-63661eaabe4e5525186613" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>cd</span><span> </span><span>/</span><span>usr</span><span>/</span><span>sbin</span><span>/</span></p><p><span>cp</span><span> </span><span>/</span><span>usr</span><span>/</span><span>jails</span><span>/</span><span>basejail</span><span>/</span><span>usr</span><span>/</span><span>sbin</span><span>/</span><span>jail </span><span>jail</span><span> </span><span>&amp;&amp;</span><span> </span><span>chmod</span><span> </span><span>+</span><span>x</span><span> </span><span>jail</span></p><p><span>cp</span><span> </span><span>/</span><span>usr</span><span>/</span><span>jails</span><span>/</span><span>basejail</span><span>/</span><span>usr</span><span>/</span><span>sbin</span><span>/</span><span>jail </span><span>jls</span><span> </span><span>&amp;&amp;</span><span> </span><span>chmod</span><span> </span><span>+</span><span>x</span><span> </span><span>jls</span></p><p><span>cp</span><span> </span><span>/</span><span>usr</span><span>/</span><span>jails</span><span>/</span><span>basejail</span><span>/</span><span>usr</span><span>/</span><span>sbin</span><span>/</span><span>jail </span><span>jexec</span><span> </span><span>&amp;&amp;</span><span> </span><span>chmod</span><span> </span><span>+</span><span>x</span><span> </span><span>jexec</span></p></div></td></tr></tbody></table></div><p>Let’s set up a jail for <code>mitmproxy</code>.</p><div id="crayon-63661eaabe4e7652363682" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p></div></td><td><div><p><span># Ignore the warnings that many ports are already bound to 127.0.1.1</span></p><p><span>ezjail</span><span>-</span><span>admin </span><span>create </span><span>mitmproxy</span><span> </span><span>'lo0|127.0.1.1'</span></p><p><span># Disable procfs as we don't need processor info</span></p><p><span>sed</span><span> </span><span>-</span><span>I</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>-</span><span>e</span><span> </span><span>'s/procfs_enable=\"YES\"/procfs_enable=\"NO\"/g'</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>/</span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>ezjail</span><span>/</span><span>mitmproxy</span></p><p><span># Start the jail</span></p><p><span>ezjail</span><span>-</span><span>admin </span><span>start </span><span>mitmproxy</span></p><p><span># Show the jail</span></p><p><span>ezjail</span><span>-</span><span>admin </span><span>list</span></p><p><span># Log into the jail</span></p><p><span># We should get: `root@mitmproxy:~ # `</span></p><p><span>ezjail</span><span>-</span><span>admin </span><span>console </span><span>mitmproxy</span></p><p><span># exit</span></p><p><span># TIP: To delete a jail later:</span></p><p><span># ezjail-admin delete mitmproxy</span></p><p><span># chflags -R noschg /usr/jails/mitmproxy</span></p><p><span># rm -rf /usr/jails/mitmproxy</span></p></div></td></tr></tbody></table></div><p><strong><span>This is very important:</span></strong> We must enable raw sockets in this jail to allow transparent proxy mode to work. If not, MITMProxy will report errors like “Transparent mode failure: FileNotFoundError(2, ‘No such file or directory’)” or “Cannot open connection, no hostname given.” This is because raw sockets are inaccessible and server information is unavailable. We can easily edit the <code>ezjail</code> config file per jail like so:</p><div id="crayon-63661eaabe4e9785826618" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p></div></td><td><div><p><span># Edit: /usr/local/etc/ezjail/mitmproxy</span></p><p><span>#</span></p><p><span># To specify the start-up order of your ezjails, use these lines to</span></p><p><span># create a Jail dependency tree. See rcorder(8) for more details.</span></p><p><span>#</span></p><p><span># PROVIDE: standard_ezjail</span></p><p><span># REQUIRE:</span></p><p><span># BEFORE:</span></p><p><span>#</span></p><p><span># This is very important to work properly with pfSense</span></p><p><span>export </span><span>jail_mitmproxy_parameters</span><span>=</span><span>"allow.raw_sockets=1"</span></p><p><span>export </span><span>jail_mitmproxy_hostname</span><span>=</span><span>"mitmproxy"</span></p><p><span>export </span><span>jail_mitmproxy_ip</span><span>=</span><span>"lo0|127.0.1.1"</span></p><p><span>export </span><span>jail_mitmproxy_rootdir</span><span>=</span><span>"/usr/jails/mitmproxy"</span></p><p><span>export </span><span>jail_mitmproxy_exec_start</span><span>=</span><span>"/bin/sh /etc/rc"</span></p><p><span>export </span><span>jail_mitmproxy_exec_stop</span><span>=</span><span>""</span></p><p><span>export </span><span>jail_mitmproxy_mount_enable</span><span>=</span><span>"YES"</span></p><p><span>export </span><span>jail_mitmproxy_devfs_enable</span><span>=</span><span>"YES"</span></p><p><span>export </span><span>jail_mitmproxy_devfs_ruleset</span><span>=</span><span>"devfsrules_jail"</span></p><p><span>export </span><span>jail_mitmproxy_procfs_enable</span><span>=</span><span>"NO"</span></p><p><span>export </span><span>jail_mitmproxy_fdescfs_enable</span><span>=</span><span>"YES"</span></p><p><span># Restart the jail:</span></p><p><span># /usr/local/etc/rc.d/ezjail restart mitmproxy</span></p></div></td></tr></tbody></table></div><p><strong><span>This is also very important:</span></strong> MITMProxy calls <code>sudo -n /sbin/pfctl -s state</code> but there is no <code>sudo</code> in <code>jail</code>. Run <code>pkg install sudo</code> inside the jail.</p><div><p><strong>Sanity Check:</strong> If you are unsuccessful when you run <code>ping 1.1.1.1</code> inside the jail, you may get an error like this: “ssend socket: Operation not permitted”. If you are successful, then <code>ping</code> works as it needs access to raw sockets.</p></div><p>Now we can copy over the <code>mitmproxy</code> binaries and take them for a spin.</p><div id="crayon-63661eaabe4ec017278571" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># Copy the binaries into the new jail</span></p><p><span>cp</span><span> </span><span>-</span><span>r</span><span> </span><span>/</span><span>tmp</span><span>/</span><span>mitm</span><span>-</span><span>$</span><span>{</span><span>LATEST</span><span>}</span><span> </span><span>/</span><span>usr</span><span>/</span><span>jails</span><span>/</span><span>mitmproxy</span><span>/</span><span>root</span><span>/</span></p><p><span># Deal with some FreeBSD shenanigans about 'ELF binary type 0 not known'</span></p><p><span>brandelf</span><span> </span><span>-</span><span>t</span><span> </span><span>freebsd </span><span>mitm</span><span>*</span></p></div></td></tr></tbody></table></div><p>Things are getting tricky with this next part. Running any of the binaries above results in:</p><div id="crayon-63661eaabe4ee320462538" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># root@mitmproxy:~/mitm-7.0.4 # ./mitmproxy</span></p><p><span># ELF interpreter /lib64/ld-linux-x86-64.so.2 not found, error 2</span></p><p><span># Abort</span></p></div></td></tr></tbody></table></div><p>So, there is no <code>/lib64</code> folder nor any similar dynamic linker that I could find. I tried this, however:</p><div id="crayon-63661eaabe4ef345377858" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>root</span><span>@</span><span>mitmproxy</span><span>:</span><span>~</span><span> </span><span># ln -s /libexec/ld-elf.so.1 /lib64/ld-linux-x86-64.so.2</span></p><p><span>root</span><span>@</span><span>mitmproxy</span><span>:</span><span>~</span><span> </span><span># cd mitm-7.0.4/</span></p><p><span>root</span><span>@</span><span>mitmproxy</span><span>:</span><span>~</span><span>/</span><span>mitm</span><span>-</span><span>7.0.4</span><span> </span><span># ./mitmproxy</span></p><p><span>ld</span><span>-</span><span>elf</span><span>.so</span><span>.</span><span>1</span><span>:</span><span> </span><span>Shared </span><span>object</span><span> </span><span>"libdl.so.2"</span><span> </span><span>not</span><span> </span><span>found</span><span>,</span><span> </span><span>required </span><span>by</span><span> </span><span>"mitmproxy"</span></p><p><span>root</span><span>@</span><span>mitmproxy</span><span>:</span><span>~</span><span>/</span><span>mitm</span><span>-</span><span>7.0.4</span><span> </span><span># ldd mitmproxy</span></p><p><span>mitmproxy</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>libdl</span><span>.so</span><span>.</span><span>2</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>not</span><span> </span><span>found</span><span> </span><span>(</span><span>0</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>libz</span><span>.so</span><span>.</span><span>1</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>not</span><span> </span><span>found</span><span> </span><span>(</span><span>0</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>libpthread</span><span>.so</span><span>.</span><span>0</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>not</span><span> </span><span>found</span><span> </span><span>(</span><span>0</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>libc</span><span>.so</span><span>.</span><span>6</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>not</span><span> </span><span>found</span><span> </span><span>(</span><span>0</span><span>)</span></p><p><span>root</span><span>@</span><span>mitmproxy</span><span>:</span><span>~</span><span>/</span><span>mitm</span><span>-</span><span>7.0.4</span><span> </span><span># </span></p></div></td></tr></tbody></table></div><p>Apparently, there is a <code>pkg install compat6x</code> that can solve this for us (unavailable on pfSense), however, this is getting ridiculous! Let’s try a new tactic. Since we are in a jail, we are not bound to the crippled (read: secured) pfSense environment. Maybe we can install the <code>mitmproxy</code> package normally in a jail?</p><p><code>pkg install mitmproxy</code></p><div id="crayon-63661eaabe4f2162327378" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>.</span><span>.</span><span>.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>py38</span><span>-</span><span>urwid</span><span>:</span><span> </span><span>2.1.2</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>py38</span><span>-</span><span>werkzeug</span><span>:</span><span> </span><span>2.0.1</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>py38</span><span>-</span><span>wsproto</span><span>:</span><span> </span><span>1.0.0</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>py38</span><span>-</span><span>zstandard</span><span>:</span><span> </span><span>0.15.2</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>python38</span><span>:</span><span> </span><span>3.8.12</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>readline</span><span>:</span><span> </span><span>8.1.1</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>sqlite3</span><span>:</span><span> </span><span>3.35.5_3</span><span>,</span><span>1</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>zstd</span><span>:</span><span> </span><span>1.5.0</span></p><p><span>Number </span><span>of </span><span>packages </span><span>to</span><span> </span><span>be </span><span>installed</span><span>:</span><span> </span><span>50</span></p><p><span>The </span><span>process </span><span>will </span><span>require</span><span> </span><span>206</span><span> </span><span>MiB </span><span>more</span><span> </span><span>space</span><span>.</span></p><p><span>33</span><span> </span><span>MiB </span><span>to</span><span> </span><span>be </span><span>downloaded</span><span>.</span></p><p><span>Proceed </span><span>with </span><span>this</span><span> </span><span>action</span><span>?</span><span> </span><span>[</span><span>y</span><span>/</span><span>N</span><span>]</span><span>:</span><span> </span></p></div></td></tr></tbody></table></div><p>And, Bingo was his name-o. After this, simply running <code>mitmproxy</code> in the jailed console opens the MITMProxy UI. Nice. Note, this version <em>may</em> be one or two minor versions behind the master branch. Let’s clean up with <code>rm -rf ~/mitm* /lib64</code> and do another bare-metal backup.</p><p><a href="#top">Top ↩</a></p><hr><h2>Exploring MITMProxy</h2><p>This is getting exciting. First, in pfSense, add a virtual IP for <code>127.0.1.1</code> attached to <code>localhost</code>. Then, add a NAT rule to temporarily forward port <code>[Private IPs]:8080</code> to <code>127.0.1.1:8080</code> to access the proxy from the LANs.</p><p>If not in the jail console, I’ll run</p><div id="crayon-63661eaabe4f4407729574" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>ezjail</span><span>-</span><span>admin </span><span>console </span><span>mitmproxy</span></p><p><span>mitmproxy</span><span> </span><span>--</span><span>listen</span><span>-</span><span>port</span><span> </span><span>8080</span><span> </span><span>--</span><span>set </span><span>console_focus_follow</span><span>=</span><span>true</span></p></div></td></tr></tbody></table></div><p>and add the proxy setting <code>192.168.20.1:8080</code> to my sacrificial notebook (that is auto-wiped daily). When the browser opens, we can already see colourful log entries in the MITMProxy UI.</p><figure id="attachment_5733"><a href="https://ericdraken.com/files/First-logs-of-MITMProxy.png"><img src="https://static.ericdraken.com/files/First-logs-of-MITMProxy-754x117.png" alt="First logs of MITMProxy" width="754" height="117" srcset="https://static.ericdraken.com/files/First-logs-of-MITMProxy-754x117.png 754w, https://static.ericdraken.com/files/First-logs-of-MITMProxy-300x47.png 300w, https://static.ericdraken.com/files/First-logs-of-MITMProxy-600x93.png 600w, https://ericdraken.com/files/First-logs-of-MITMProxy.png 1428w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/First-logs-of-MITMProxy-754x117.png" data-srcset="https://static.ericdraken.com/files/First-logs-of-MITMProxy-754x117.png 754w, https://static.ericdraken.com/files/First-logs-of-MITMProxy-300x47.png 300w, https://static.ericdraken.com/files/First-logs-of-MITMProxy-600x93.png 600w, https://ericdraken.com/files/First-logs-of-MITMProxy.png 1428w"></a><figcaption>First logs of MITMProxy</figcaption></figure><p>The next step is to get the auto-generated CA PEM file used by MITMProxy (<code>~/.mitmproxy/mitmproxy-ca-cert.pem</code>). Since any CA cert here is snake oil, I’ll use the provided one. TLS traffic from my devices is safe as long as I use my own proxies.</p><p>Let’s put our experience from our previous attempt at self-hosting a CA into action. However, there is no PHP in the jail, so we can use a Python 3 web server instead.</p><div id="crayon-63661eaabe4f6549194476" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>set </span><span>PYTHON</span><span>=</span><span>'/usr/local/bin/python3.8'</span></p><p><span>mkdir</span><span> </span><span>~</span><span>/</span><span>www</span></p><p><span># Both Python and mitmproxy run as 'root'</span></p><p><span>chmod</span><span> </span><span>444</span><span> </span><span>~</span><span>/</span><span>.mitmproxy</span><span>/</span><span>mitmproxy</span><span>-</span><span>ca</span><span>-</span><span>cert</span><span>.pem</span></p><p><span>ln</span><span> </span><span>-</span><span>s</span><span> </span><span>~</span><span>/</span><span>.mitmproxy</span><span>/</span><span>mitmproxy</span><span>-</span><span>ca</span><span>-</span><span>cert</span><span>.pem</span><span> </span><span>~</span><span>/</span><span>www</span><span>/</span><span>cert</span><span>.pem</span></p><p><span>$PYTHON</span><span> </span><span>-</span><span>m</span><span> </span><span>http</span><span>.server</span><span> </span><span>--</span><span>bind</span><span> </span><span>127.0.1.1</span><span> </span><span>--</span><span>directory</span><span> </span><span>~</span><span>/</span><span>www</span><span> </span><span>8001</span></p></div></td></tr></tbody></table></div><div><p><strong>Tip:</strong> MITMProxy conveniently has onboarding settings to serve the same CA cert, as we did manually, just by visiting <code>mitm.it</code>.</p></div><p>After installing the CA in the Trusted Root Store on my clean notebook (and rebooting), I am treated to this display:</p><figure id="attachment_5734"><a href="https://ericdraken.com/files/MITM-TLS-interception-is-working-well.png"><img src="https://ericdraken.com/files/MITM-TLS-interception-is-working-well-754x293.png" alt="MITM TLS interception is working well" width="754" height="293" srcset="https://ericdraken.com/files/MITM-TLS-interception-is-working-well-754x293.png 754w, https://ericdraken.com/files/MITM-TLS-interception-is-working-well-300x117.png 300w, https://static.ericdraken.com/files/MITM-TLS-interception-is-working-well-600x233.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/MITM-TLS-interception-is-working-well-754x293.png" data-srcset="https://ericdraken.com/files/MITM-TLS-interception-is-working-well-754x293.png 754w, https://ericdraken.com/files/MITM-TLS-interception-is-working-well-300x117.png 300w, https://static.ericdraken.com/files/MITM-TLS-interception-is-working-well-600x233.png 600w"></a><figcaption>MITM TLS interception is working well</figcaption></figure><p>Let’s see if we can get this cert on my iPhone.</p><figure id="attachment_5738"><a href="https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone.png"><img src="https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-754x372.png" alt="Successfully added a root CA to the iPhone" width="754" height="372" srcset="https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-754x372.png 754w, https://ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-300x148.png 300w, https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-600x296.png 600w, https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone.png 934w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-754x372.png" data-srcset="https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-754x372.png 754w, https://ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-300x148.png 300w, https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-600x296.png 600w, https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone.png 934w"></a><figcaption>Successfully added a root CA to the iPhone</figcaption></figure><p>This is incredibly exciting. Can we LoJack the Apple TV box next?</p><figure id="attachment_5746"><a href="https://static.ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV.jpg"><img src="https://ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-754x204.jpg" alt="Successfully installed a root CA on the Apple TV" width="754" height="204" srcset="https://ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-754x204.jpg 754w, https://static.ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-300x81.jpg 300w, https://ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-600x162.jpg 600w, https://static.ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV.jpg 1201w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-754x204.jpg" data-srcset="https://ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-754x204.jpg 754w, https://static.ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-300x81.jpg 300w, https://ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-600x162.jpg 600w, https://static.ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV.jpg 1201w"></a><figcaption>Successfully installed a root CA on the Apple TV</figcaption></figure><p>Excellent.</p><p>But wait, the router is slowing down. <code>mitmproxy</code> is burning up the CPU… on idle.</p><figure id="attachment_5741"><a href="https://ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle.png"><img src="https://static.ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-754x111.png" alt="MITMProxy is burning up the CPU while on idle" width="754" height="111" srcset="https://static.ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-754x111.png 754w, https://ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-300x44.png 300w, https://ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-600x88.png 600w, https://ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle.png 1309w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-754x111.png" data-srcset="https://static.ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-754x111.png 754w, https://ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-300x44.png 300w, https://ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-600x88.png 600w, https://ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle.png 1309w"></a><figcaption>MITMProxy is burning up the CPU while on idle</figcaption></figure><p>Of course: Python is a single-threaded paradigm with the GIL (Global Interpreter Lock) ensuring threads do not actually run concurrently – unless they are blocking on I/O, which is the case here(?). Except, most of the CPU work is to generate TLS certs on the fly for each request. Yikes. Running <code>mitmdump</code> forgoes the UI and extreme logging. The extreme logging of all the headers and full responses heavily slows down <code>mitmproxy</code>, but <code>mitmdump</code> by default only logs entries like classic Apache logs – much kinder on the CPU.</p><div><p><strong>Certificate Pinning</strong> Some advanced, high-security web servers have trouble with the MITMProxy certificates due to <a href="https://security.stackexchange.com/a/29990/114882" target="_blank" rel="nofollow">Certificate Pinning</a> – this is a technique where the server or the client know the fingerprint of the expected certificate in advance so it cannot be forged. A workaround is to use the <code>--ignore-hosts</code> option to let them bypass the proxy.</p></div><p>For my fun, I’ll go with this CLI command:</p><div id="crayon-63661eaabe4fb287054412" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># Try to avoid compression to save CPU usage</span></p><p><span># Ignore some difficult sites</span></p><p><span>mitmproxy</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>listen</span><span>-</span><span>port</span><span> </span><span>8080</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>listen</span><span>-</span><span>host</span><span> </span><span>127.0.1.1</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>anticomp</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>mode </span><span>regular</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>ignore</span><span>-</span><span>hosts</span><span> </span><span>'^(?:.+\.)?apple\.com:443$'</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>ignore</span><span>-</span><span>hosts</span><span> </span><span>'^(?:.+\.)?icloud\.com:443$'</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>set </span><span>console_focus_follow</span><span>=</span><span>true</span></p></div></td></tr></tbody></table></div><p>While on YouTube, we can see the page ads clear as day with their unencrypted headers; can a simple regex now block them? They are exposed, and afraid, and their days have run out.</p><figure id="attachment_5742"><a href="https://ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs.png"><img src="https://static.ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-754x368.png" alt="MITMProxy can see the YouTube ad URLs" width="754" height="368" srcset="https://static.ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-754x368.png 754w, https://ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-300x147.png 300w, https://static.ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-600x293.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-754x368.png" data-srcset="https://static.ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-754x368.png 754w, https://ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-300x147.png 300w, https://static.ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-600x293.png 600w"></a><figcaption>MITMProxy can see the YouTube ad URLs</figcaption></figure><p>We can even see details about each request. For example, all the SAN info is laid out for this wide-reaching certificate. There are curiously a lot of <code>*-cn.com</code> domains covered by this cert.</p><figure id="attachment_5744"><a href="https://ericdraken.com/files/We-can-see-rich-request-and-response-details.png"><img src="https://ericdraken.com/files/We-can-see-rich-request-and-response-details-754x282.png" alt="We can see rich request and response details" width="754" height="282" srcset="https://ericdraken.com/files/We-can-see-rich-request-and-response-details-754x282.png 754w, https://static.ericdraken.com/files/We-can-see-rich-request-and-response-details-300x112.png 300w, https://static.ericdraken.com/files/We-can-see-rich-request-and-response-details-600x224.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/We-can-see-rich-request-and-response-details-754x282.png" data-srcset="https://ericdraken.com/files/We-can-see-rich-request-and-response-details-754x282.png 754w, https://static.ericdraken.com/files/We-can-see-rich-request-and-response-details-300x112.png 300w, https://static.ericdraken.com/files/We-can-see-rich-request-and-response-details-600x224.png 600w"></a><figcaption>We can see rich request and response details</figcaption></figure><div id="crayon-63661eaabe4fe369532479" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># Try to avoid compression to save CPU usage</span></p><p><span># Use a script to block YouTube ads</span></p><p><span>mitmdump</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>listen</span><span>-</span><span>port</span><span> </span><span>8080</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>listen</span><span>-</span><span>host</span><span> </span><span>127.0.1.1</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>anticomp</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>mode </span><span>regular</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>ignore</span><span>-</span><span>hosts</span><span> </span><span>'^(.+\.)?apple\.com(:443)?$'</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>ignore</span><span>-</span><span>hosts</span><span> </span><span>'^(.+\.)?icloud\.com(:443)?$'</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>scripts</span><span> </span><span>"youtube.py"</span><span>&nbsp;&nbsp;</span><span># &lt;-- This is new</span></p></div></td></tr></tbody></table></div><p>Shortly, I’ll write a Python script to block YouTube <code>/pagead/</code> URLs.</p><p><a href="#top">Top ↩</a></p><hr><h2>Patch MITMProxy Source Code for Server SNI Interrogation</h2><p>This step may be optional for most, but as a reminder to myself, to make <code>--allowed-hosts</code> work better in Transparent Proxy Mode, the SNI of the server request needs to be checked against the list of regular expressions or else only the server’s IP is used for matching in many cases. Here is a quick patch I made that can be applied directly in the jail shell (or just type a few lines manually) for <code>mitmproxy</code> version 7.0.4:</p><div id="crayon-63661eaabe500315717351" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p></div></td><td><div><p>Index:<span> </span>venv/lib/python3.8/site-packages/mitmproxy/addons/next_layer.py</p><p>IDEA<span> </span>additional<span> </span>info:</p><p>Subsystem:<span> </span>com.intellij.openapi.diff.impl.patch.CharsetEP</p><p><span>&lt;+&gt;UTF-8</span></p><p>===================================================================</p><p>diff<span> </span>--git<span> </span>a/usr/local/lib/python3.8/site-packages/mitmproxy/addons/next_layer.py<span> </span>b/usr/local/lib/python3.8/site-packages/mitmproxy/addons/next_layer.py</p><p><span>--- a/usr/local/lib/python3.8/site-packages/mitmproxy/addons/next_layer.py&nbsp;&nbsp;(date 1641187083049)</span></p><p><span>+++ b/usr/local/lib/python3.8/site-packages/mitmproxy/addons/next_layer.py&nbsp;&nbsp;(date 1641187083049)</span></p><p><span>@@ -59,7 +59,7 @@</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; re.compile(x, re.IGNORECASE) for x in ctx.options.allow_hosts</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ]</span></p><p><span>-&nbsp;&nbsp;&nbsp;&nbsp;def ignore_connection(self, server_address: Optional[connection.Address], data_client: bytes) -&gt; Optional[bool]:</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;def ignore_connection(self, server: Optional[connection.Server], data_client: bytes) -&gt; Optional[bool]:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; """</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Returns:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; True, if the connection should be ignored.</span></p><p><span>@@ -70,8 +70,11 @@</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hostnames: List[str] = []</span></p><p><span>-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if server_address is not None:</span></p><p><span>-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hostnames.append(server_address[0])</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if server is not None:</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if server.address is not None:</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hostnames.append(server.address[0])</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if server.sni is not None:</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hostnames.append(server.sni)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if is_tls_record_magic(data_client):</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ch = parse_client_hello(data_client)</span></p><p><span>@@ -122,7 +125,7 @@</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return stack_match(context, layers)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # 1. check for --ignore/--allow</span></p><p><span>-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore = self.ignore_connection(context.server.address, data_client)</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore = self.ignore_connection(context.server, data_client)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ignore is True:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return layers.TCPLayer(context, ignore=True)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ignore is None:</span></p></div></td></tr></tbody></table></div><p>With the above patch, I can now reliably intercept a few hosts and let all others pass through.</p><figure id="attachment_5835"><a href="https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode.png"><img src="https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-754x476.png" alt="Reliable server host interception in MITMProxy transparent proxy mode" width="754" height="476" srcset="https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-754x476.png 754w, https://ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-300x189.png 300w, https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-600x379.png 600w, https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode.png 906w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-754x476.png" data-srcset="https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-754x476.png 754w, https://ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-300x189.png 300w, https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-600x379.png 600w, https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode.png 906w"></a><figcaption>Reliable server host interception in MITMProxy transparent proxy mode</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Smoke Test: Intercept YouTube Ads with MITMProxy</h2><p>After reading the docs and navigating the <code>mitmproxy</code> source code in the PyCharm IDE, I’ve written a little script to block ads and tracking URLs coming from YouTube from my clean notebook. I won’t reproduce the code just yet because it didn’t succeed in blocking ads as hoped, so instead, I’ll spend the time investigating why.</p><p>Here are the smoke test filters I used where for a given top-level domain, URLs with the following partial strings are blocked:</p><div id="crayon-63661eaabe504280523207" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>blocked_partials</span><span>:</span><span> </span><span>dict</span><span> </span><span>=</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"youtube.com"</span><span>:</span><span> </span><span>[</span><span>"/pagead/"</span><span>,</span><span> </span><span>"/log_event?"</span><span>,</span><span> </span><span>"/stats/ads"</span><span>,</span><span> </span><span>"/stats/qoe?"</span><span>,</span><span> </span><span>"/ptracking?"</span><span>,</span><span> </span><span>"/generate_204"</span><span>,</span><span> </span><span>"el=adunit"</span><span>,</span><span> </span><span>"adformat="</span><span>,</span><span> </span><span>"/activeview?"</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"google.com"</span><span>:</span><span> </span><span>[</span><span>"/pagead/"</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"google.ca"</span><span>:</span><span> </span><span>[</span><span>"/pagead/"</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"ggpht.com"</span><span>:</span><span> </span><span>[</span><span>"."</span><span>]</span><span>,</span></p><p><span>}</span></p></div></td></tr></tbody></table></div><p>My initial results on blocking are positive. Everything I wanted to be blocked is faithfully blocked. Note, the <code>(failed)</code> entries are due to my script, and the <code>502</code> failures are due to pfBlockerNG black-holing the request.</p><figure id="attachment_5748"><a href="https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working.png"><img src="https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-754x350.png" alt="MITMProxy blocking script is working" width="754" height="350" srcset="https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-754x350.png 754w, https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-300x139.png 300w, https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-600x278.png 600w, https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working.png 1565w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-754x350.png" data-srcset="https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-754x350.png 754w, https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-300x139.png 300w, https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-600x278.png 600w, https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working.png 1565w"></a><figcaption>MITMProxy blocking script is working</figcaption></figure><p>Even in the DevTools network panel, the requests are truly blocked.</p><figure id="attachment_5749"><a href="https://ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel.png"><img src="https://static.ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-754x369.png" alt="YouTube requests are truly blocked in DevTools network panel" width="754" height="369" srcset="https://static.ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-754x369.png 754w, https://ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-300x147.png 300w, https://ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-600x293.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-754x369.png" data-srcset="https://static.ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-754x369.png 754w, https://ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-300x147.png 300w, https://ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-600x293.png 600w"></a><figcaption>YouTube requests are truly blocked in DevTools network panel</figcaption></figure><p>Then how come I am still seeing ads? I’ve disabled HTTP/2 so that subsequent requests on the same channel don’t slide by. Mind you, sometimes the ads skip on their own, or fail to play, but they still show up. Interesting. Could YouTube be using WebSockets? I need some inspiration, so I’ll look at uBlock Origin’s regex filters for some ideas.</p><div><p><strong>Tip:</strong> If you see the error <span>OpenSSL Error([(‘SSL routines’, ‘ssl3_read_bytes’, ‘tlsv1 alert internal error’)])</span>, then the DNS blocker (i.e. pfBlockerNG) is breaking the upstream TLS handshake for a given domain. Either whitelist it in pfBlockerNG (so the request goes through), or intercept it and block the connection in <code>mitmproxy</code>. This error happens to black-holed domains when the upstream TLS cert cannot be sniffed. The cleanest strategy is to use <strong>transparent MITM mode</strong>.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Examine uBlock Origin Regex Patterns for Inspiration</h2><p>Here are some of the regex/filters that uBlock Origin uses on YouTube.</p><figure id="attachment_5753"><a href="https://static.ericdraken.com/files/filters-from-a-web-browser.png"><img src="https://static.ericdraken.com/files/filters-from-a-web-browser.png" alt="uBlock Origin YouTube regex/filters from a web browser" width="746" height="322" srcset="https://static.ericdraken.com/files/filters-from-a-web-browser.png 746w, https://static.ericdraken.com/files/filters-from-a-web-browser-300x129.png 300w, https://ericdraken.com/files/filters-from-a-web-browser-600x259.png 600w" sizes="(max-width: 746px) 100vw, 746px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/filters-from-a-web-browser.png" data-srcset="https://static.ericdraken.com/files/filters-from-a-web-browser.png 746w, https://static.ericdraken.com/files/filters-from-a-web-browser-300x129.png 300w, https://ericdraken.com/files/filters-from-a-web-browser-600x259.png 600w"></a><figcaption>uBlock Origin YouTube regex/filters from a web browser</figcaption></figure><p>At first blush, it seems that a community of like-minded individuals is playing whack-a-mole with YouTube’s HTML and JavaScript. This has got me thinking: How does a video know to play an ad with JavaScript?</p><p>How does YouTube know if the ad converts? They must target ads for individuals, so a given video must receive some unique information about an ad, such as the click link and alt text. WebSockets would be a pain to maintain, especially with all the mobile clients. They must be using stateless JSON to relay that pertinent information in an innocuous URL request that has no telltale signs of ad-ness. Let’s hunt for this info in the JSON replies captured by <code>mitmproxy</code>.</p><figure id="attachment_5755"><a href="https://static.ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response.png"><img src="https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-754x362.png" alt="Key advertizement information contained in a JSON response" width="754" height="362" srcset="https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-754x362.png 754w, https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-300x144.png 300w, https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-600x288.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-754x362.png" data-srcset="https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-754x362.png 754w, https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-300x144.png 300w, https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-600x288.png 600w"></a><figcaption>Key advertizement information contained in a JSON response</figcaption></figure><p>Snap, Crackle, and Pop. We have a new plan: surgically alter the JSON response body to eliminate or Byzantine-up the ad information.</p><p><a href="#top">Top ↩</a></p><hr><h2>Surgically Alter the JSON Response to Remove Ads</h2><p>After a bit more playful exploration, a trove of blocklorne URLs is right there in the JSON payload. In fact, most of what I am trying to block shows up right here:</p><div id="crayon-63661eaabe509451695984" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p></div></td><td><div><p><span> </span><span>.</span><span>.</span><span>.</span></p><p><span> </span><span>"playerAds"</span><span>:</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"playerLegacyDesktopWatchAdsRenderer"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"playerAdParams"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"showContentThumbnail"</span><span>:</span><span> </span><span>true</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"enabledEngageTypes"</span><span>:</span><span> </span><span>"3,6,4,5,17,1"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"gutParams"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"tag"</span><span>:</span><span> </span><span>"\\4061\\ytpwmpu"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"showCompanion"</span><span>:</span><span> </span><span>true</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"showInstream"</span><span>:</span><span> </span><span>true</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"useGut"</span><span>:</span><span> </span><span>true</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;</span><span>"playbackTracking"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"videostatsPlaybackUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://s.youtube.com/api/stats/playback?cl=417308503&amp;docid=IgF3..."</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"videostatsDelayplayUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://s.youtube.com/api/stats/delayplay?cl=417308503&amp;docid=IgF..."</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"videostatsWatchtimeUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://s.youtube.com/api/stats/watchtime?cl=417308503&amp;docid=IgF..."</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"ptrackingUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://www.youtube.com/ptracking?ei=KnzDYZv1B86ikwa0no7AAg&amp;oid=MjD-gn49GocgAFypi8EDnQ&amp;plid=AAXTwR1aNKG2iTgr&amp;pltype=content&amp;ptchn=HnyfMqiRRG1u-2MsSQLbXA&amp;ptk=youtube_single&amp;video_id=IgF3OX8nT0w"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"qoeUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://s.youtube.com/api/stats/qoe?cl=417308503&amp;docid=IgF3OX8nT..."</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"atrUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://s.youtube.com/api/stats/atr?docid=IgF3OX8nT0w&amp;ei=KnzDYZv1B86ikwa0no7AAg&amp;feature=g-high-trv&amp;len=1213&amp;ns=yt&amp;plid=AAXTwR1aNKG2iTgr&amp;ver=2"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"elapsedMediaTimeSeconds"</span><span>:</span><span> </span><span>5</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"videostatsScheduledFlushWalltimeSeconds"</span><span>:</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>10</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>20</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>30</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"videostatsDefaultFlushIntervalSeconds"</span><span>:</span><span> </span><span>40</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"youtubeRemarketingUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://www.youtube.com/pagead/viewthroughconversion/962985656/?backend=innertube&amp;cname=1&amp;cver=2_20211221&amp;data=backend%3Dinnertube%3Bcname%3D1%3Bcver%3D2_20211221%3Bptype%3Df_view%3Btype%3Dview%3Butuid%3DHnyfMqiRRG1u-2MsSQLbXA%3Butvid%3DIgF3OX8nT0w&amp;foc_id=HnyfMqiRRG1u-2MsSQLbXA&amp;label=followon_view&amp;ptype=f_view&amp;random=37068419&amp;utuid=HnyfMqiRRG1u-2MsSQLbXA"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"elapsedMediaTimeSeconds"</span><span>:</span><span> </span><span>0</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"googleRemarketingUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://www.google.com/pagead/1p-user-list/962985656/?backend=innertube&amp;cname=1&amp;cver=2_20211221&amp;data=backend%3Dinnertube%3Bcname%3D1%3Bcver%3D2_20211221%3Bptype%3Df_view%3Btype%3Dview%3Butuid%3DHnyfMqiRRG1u-2MsSQLbXA%3Butvid%3DIgF3OX8nT0w&amp;is_vtc=0&amp;ptype=f_view&amp;random=838827488&amp;utuid=HnyfMqiRRG1u-2MsSQLbXA"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"elapsedMediaTimeSeconds"</span><span>:</span><span> </span><span>0</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;</span><span>}</span><span>,</span></p></div></td></tr></tbody></table></div><p>However, YouTube has bobby-trapped their UI and there is more than one way their obfuscated JavaScript code can pull down the ad details.</p><p><strong>Let’s blow it all away right now.</strong></p><p>After a lot of fun taking apart the YouTube UI and HTTP workflow, taking into account cookies and naughty service workers, I am successfully able to strip away all the pre-roll, post-roll, mid-video, and, well, all the video ads. Here is a screenshot from <code>mitmdump</code> showing how select REST queries are intercepted, decrypted, modified, put back into the response, and the headers updated (content length, etc.).</p><figure id="attachment_5758"><a href="https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses.png"><img src="https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-754x221.png" alt="Success in removing YouTube ads via decrypted JSON responses" width="754" height="221" srcset="https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-754x221.png 754w, https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-300x88.png 300w, https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-600x176.png 600w, https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses.png 1175w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-754x221.png" data-srcset="https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-754x221.png 754w, https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-300x88.png 300w, https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-600x176.png 600w, https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses.png 1175w"></a><figcaption>Success in removing YouTube ads via decrypted JSON responses</figcaption></figure><p>With this new ability, we could even inject JavaScript into the main YouTube web page and subvert their JavaScript in a sort of ECMAScript arms race, possibly even leveraging some of the filters from uBlock Origin. However, we can hang our hats on this accomplishment for today.</p><div><p><strong>Success:</strong> We can strip out ads from the JSON payload for YouTube web ads using a router.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>The iOS YouTube App Uses Protobuf, not JSON</h2><p>I can see very similar data in the Protocol Buffer (Protobuf) version of the same API calls as the web version to that of the YouTube iOS app. That complicates things, somewhat: We cannot lean on JSONPath to hunt down advertisement sections of JSON because with Protobuf the keys are just numbers that can even change.</p><figure id="attachment_5761"><a href="https://ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf.png"><img src="https://static.ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-754x255.png" alt="The iOS version of the YouTube app uses Protobuf" width="754" height="255" srcset="https://static.ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-754x255.png 754w, https://static.ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-300x102.png 300w, https://ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-600x203.png 600w, https://ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf.png 1279w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-754x255.png" data-srcset="https://static.ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-754x255.png 754w, https://static.ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-300x102.png 300w, https://ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-600x203.png 600w, https://ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf.png 1279w"></a><figcaption>The iOS version of the YouTube app uses Protobuf</figcaption></figure><div><p><strong>Fun fact:</strong> YouTube compiles a large list of all the ads you are going to see and sends that to you in a sneaky payload. In fact, it is easier to visualize this when reading Protobuf. If you manage to exhaust that list, then another large list will be coming your way.</p></div><p>I can see strings like “Telus” and “Samsung TV” and “Boxing Week” and “Buy now”. Remember when YouTube was a fun place? A fable about a Golden Goose comes to mind, Alphabet.</p><p>What is a Protocol Buffer? Here is an infographic from <a href="https://www.datascienceblog.net/post/programming/essential-protobuf-guide-python/" target="_blank" rel="nofollow">Data Science Blog</a>.</p><figure id="attachment_5764"><a href="https://static.ericdraken.com/files/Protobuf-introduction.png"><img src="https://static.ericdraken.com/files/Protobuf-introduction-754x424.png" alt="Protobuf introduction" width="754" height="424" srcset="https://static.ericdraken.com/files/Protobuf-introduction-754x424.png 754w, https://static.ericdraken.com/files/Protobuf-introduction-300x169.png 300w, https://static.ericdraken.com/files/Protobuf-introduction-600x338.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Protobuf-introduction-754x424.png" data-srcset="https://static.ericdraken.com/files/Protobuf-introduction-754x424.png 754w, https://static.ericdraken.com/files/Protobuf-introduction-300x169.png 300w, https://static.ericdraken.com/files/Protobuf-introduction-600x338.png 600w"></a><figcaption>Protobuf introduction (Credit: <a href="https://www.datascienceblog.net/post/programming/essential-protobuf-guide-python/" target="_blank" rel="nofollow">Data Science Blog</a>)</figcaption></figure><p>As a consequence of being able to see unencrypted traffic from my iPhone, I’m taken aback by the sheer amount of tracking information laid bare; It’s like I have electrodes on my head and chest while I’m running on a treadmill and a bunch of scientists in white lab coats with clipboards are standing shoulder-to-shoulder recording everything about my internals.</p><div><p><strong>Privacy concern:</strong> Your apps are tracking you like crazy: what you do, how long you dwell, when you leave a given app, and so much more. The URL <code>https://play.googleapis.com/log/batch</code> shows up a lot in my logs.</p></div><p>The next question is: Does the iOS app protocol behave like the web app?</p><p><a href="#top">Top ↩</a></p><hr><h2>Timing Analysis to Detect Ad Videos?</h2><p>The iOS network traffic is not like the web traffic; Google has teams and teams of engineers dedicated to making sure blocking their ads isn’t computationally feasible. Daunted but undeterred, I was staring at network requests to let my mind zone out and wander when I noticed a pattern I had not noticed before.</p><p>For the <em>web</em> version of YouTube, I can eyeball which URLs are ads and which are the videos I want to watch. Take a look:</p><figure id="attachment_5806"><a href="https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos.png"><img src="https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-754x552.png" alt="Which are ad videos and which are content videos?" width="754" height="552" srcset="https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-754x552.png 754w, https://static.ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-300x220.png 300w, https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-600x439.png 600w, https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos.png 1122w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-754x552.png" data-srcset="https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-754x552.png 754w, https://static.ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-300x220.png 300w, https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-600x439.png 600w, https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos.png 1122w"></a><figcaption>Which are ad videos and which are content videos?</figcaption></figure><p>How am I able to eyeball which video URLs are ads in this chaos?</p><figure id="attachment_5807"><a href="https://static.ericdraken.com/files/Two-ad-videos-between-content-videos.png"><img src="https://static.ericdraken.com/files/Two-ad-videos-between-content-videos-754x552.png" alt="Two ad videos between content videos" width="754" height="552" srcset="https://static.ericdraken.com/files/Two-ad-videos-between-content-videos-754x552.png 754w, https://static.ericdraken.com/files/Two-ad-videos-between-content-videos-300x220.png 300w, https://ericdraken.com/files/Two-ad-videos-between-content-videos-600x439.png 600w, https://static.ericdraken.com/files/Two-ad-videos-between-content-videos.png 1122w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Two-ad-videos-between-content-videos-754x552.png" data-srcset="https://static.ericdraken.com/files/Two-ad-videos-between-content-videos-754x552.png 754w, https://static.ericdraken.com/files/Two-ad-videos-between-content-videos-300x220.png 300w, https://ericdraken.com/files/Two-ad-videos-between-content-videos-600x439.png 600w, https://static.ericdraken.com/files/Two-ad-videos-between-content-videos.png 1122w"></a><figcaption>Two ad videos between content videos</figcaption></figure><p>Take a look at the query parameter <code>range</code>. For the web version, a chunk of the video I want is fetched from the 0th byte, then immediately another video is fetched with a <code>range</code> starting again at the 0th byte. Both happen near-simultaneously – faster than a human can click on a new video. It turns out this, as well as examining the <code>clen</code> parameter for the length of the full video (short videos are likely ads), can reasonably allow us to detect and doctor ad videos.</p><p>However, the iOS YouTube protocol does <strong>not</strong> use the <code>range</code> query parameter or even the <code>Range</code> header; video chunks use a counter like <code>&amp;nr=2</code> and <code>&amp;nr=3</code> etc. We must reverse engineer the Protobuf responses.</p><p><a href="#top">Top ↩</a></p><hr><h2>Decode the YouTube Protobuf Responses</h2><p>Here are some decoded Protobuf log files I created then opened in the PyCharm IDE.</p><figure id="attachment_5767"><a href="https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE.png"><img src="https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-754x161.png" alt="Let's examine some Protobuf logs in the IDE" width="754" height="161" srcset="https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-754x161.png 754w, https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-300x64.png 300w, https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-600x128.png 600w, https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE.png 1123w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-754x161.png" data-srcset="https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-754x161.png 754w, https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-300x64.png 300w, https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-600x128.png 600w, https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE.png 1123w"></a><figcaption>Let’s examine some Protobuf logs in the IDE</figcaption></figure><p>After logging decoded Protobuf messages to disk for offline analysis, I did notice something that piqued my interest.</p><div id="crayon-63661eaabe511016360233" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>2</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>1</span><span>:</span><span> </span><span>has_unlimited</span><span>_</span>entitlement</p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>2</span><span>:</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>2</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>1</span><span>:</span><span> </span><span>has_premium_lite</span><span>_</span>entitlement</p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>2</span><span>:</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p></div></td></tr></tbody></table></div><p>I wonder what would happen if I were to, say, toggle those? This is tantalizing, but it is cheating, and hence no fun. Back to heuristics.</p><div><p><strong>Thought Experiment:</strong> As with JSON, can I blow away the Protobuf sections that serve up ads? Could I instead detect the ad videos in the payload, then dynamically modify their responses to be, say, a cached 0.01s video file? The 30s ~ 300s of unskippable ads could be over in the blink of an eye without blocking all those URLs.</p></div><figure id="attachment_5768"><a href="https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload.png"><img src="https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-754x428.png" alt="Intercepted ad URLs from the Protobuf payload" width="754" height="428" srcset="https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-754x428.png 754w, https://ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-300x170.png 300w, https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-600x341.png 600w, https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload.png 962w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-754x428.png" data-srcset="https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-754x428.png 754w, https://ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-300x170.png 300w, https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-600x341.png 600w, https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload.png 962w"></a><figcaption>Intercepted ad URLs from the Protobuf payload</figcaption></figure><p>Let’s start by blocking the ads as intended.</p><p><a href="#top">Top ↩</a></p><hr><h2>Ad URL Polymorphism</h2><p>The Protobuf responses are a hot mess of bytes, but there are human-readable URLs that can be grepped.</p><p>You’d think a simple LRU cache that blocks soon-encountered ad URLs could be the way to go, but, alas, the ad URLs do not quite match the URLs sent over the wire. Also, who is to say that YouTube won’t randomize the position of query-string parameters one day? We need an <code>O(1)</code> lookup of flagged ad URLs that are polymorphic (and group homomorphic) to live ad URLs.</p><figure id="attachment_5775"><a href="https://static.ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs.png"><img src="https://static.ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs.png" alt="Detected ad URLs vs intercepted ad URLs" width="748" height="169" srcset="https://static.ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs.png 748w, https://ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs-300x68.png 300w, https://ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs-600x136.png 600w" sizes="(max-width: 748px) 100vw, 748px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs.png" data-srcset="https://static.ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs.png 748w, https://ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs-300x68.png 300w, https://ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs-600x136.png 600w"></a><figcaption>Detected ad URLs vs intercepted ad URLs</figcaption></figure><p>It might be tempting to split a query string into a sorted dictionary and reassemble it, but we have no way of knowing what the query string boundary is. Plus, a live ad URL could add a key and disrupt the sorting.</p><p>Addionally, I’ve encountered URLs like this that purposely try to obfuscate the query params:</p><blockquote><p>https://r4—sn-vgqsrns6.googlevideo.com/videoplayback<br>/expire/1640607416<br>/ei/WFrJYdWnFfyTsfIP4s2BsAk<br><span>/ip/121.35.98.26</span><br>/id/o-AE7swWOPOwXu3GyRght<br>/source/youtube<br>/requiressl/yes<br>/mh/wU/<br>mm/31,26/…</p></blockquote><p>Notice how <code>/ip/121.35.98.26/</code> is just <code>&amp;ip=121.35.98.26</code>?</p><p>I propose heuristically scanning for query and path parameters of ad URLs with high entropy and using those as keys (fingerprints). For example, in</p><blockquote><p>https://<span>rr6—sn-uxa0n-t8gz</span>.googlevideo.com/initplayback?source=youtube<br>&amp;orc=1&amp;oeis=1&amp;c=IOS&amp;oss=1&amp;oda=1&amp;oad=5500&amp;ovd=5500&amp;oaad=11000&amp;oavd=11000<br>&amp;ocs=700&amp;oputc=1&amp;oses=1&amp;ofpcc=1&amp;osbr=1&amp;osnz=1&amp;msp=1&amp;odeak=1&amp;odepv=1<br>&amp;osfc=1&amp;id=<span>58cc678216d6aaca</span>&amp;ip=<span>121.35.98.26</span>&amp;initcwndbps=<span>2125000</span><br>&amp;mt=<span>1640373902</span></p></blockquote><p>One could note the following candidates in descending order of length:</p><ul><li>rr6—sn-uxa0n-t8gz</li><li>58cc678216d6aaca</li><li>121.35.98.26</li><li>1640373902</li><li>2125000</li></ul><p>Any or all of them could be lookup keys each pointing to the same dictionary of deconstructed query parameters. A lookup of a live URL would involve the same process of finding the highest entropy parameters and checking the URL dictionary for a match. The cache data structure can even be multi-level with the root keys being just the length of the high-entropy strings.</p><div><p><strong>Failure:</strong> Even with the ability to block polymorphic URLs, the video ads are still indistinguishable from content video without context from the Protobuf structure.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Smoke Test: Intercept and Decode Protobuf in Python</h2><div><p><strong>Python is Slow:</strong> Decoding ~500 kiB of raw Protobuf in pure Python is painfully slow.</p></div><p>Decoding ~500 kiB of Protobuf in pure Python, especially the decoding step of converting it to over 1 MiB of human-readable text to parse the ad URLs, takes more time than the connection timeout most of the time. I’ll run some benchmarks using pure Python vs. the native C++ library.</p><h3>Pure Python Benchmarks</h3><div id="crayon-63661eaabe517325973514" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>from</span><span> </span><span>timeit</span><span> </span><span>import</span><span> </span><span>repeat</span></p><p><span>from</span><span> </span><span>mitmproxy</span><span>.</span><span>contentviews</span><span>.</span><span>protobuf </span><span>import</span><span> </span><span>format_pbuf</span></p><p><span>with</span><span> </span><span>open</span><span>(</span><span>"proto.raw"</span><span>,</span><span> </span><span>"rb"</span><span>)</span><span> </span><span>as</span><span> </span><span>f</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>data</span><span>:</span><span> </span><span>bytes</span><span> </span><span>=</span><span> </span><span>f</span><span>.</span><span>read</span><span>(</span><span>)</span></p><p><span>print</span><span>(</span><span>repeat</span><span>(</span><span>lambda</span><span>:</span><span> </span><span>format_pbuf</span><span>(</span><span>data</span><span>)</span><span>,</span><span> </span><span>number</span><span>=</span><span>5</span><span>)</span><span>)</span></p><p><span># On a i7-6700 CPU @ 3.40GHz desktop</span></p><p><span># [2.10792827908881, 2.0718665630556643, 2.0739889848046005, 2.065321908099577, 2.070936748990789]</span></p><p><span># On the pfSense router:</span></p><p><span># [24.182968072011136, 22.833560551982373, 23.53838806191925, 22.842924927012064, 22.81738876597956]</span></p></div></td></tr></tbody></table></div><h3>Pure C++ Benchmarks</h3><div id="crayon-63661eaabe519209175894" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># On a i7-6700 CPU @ 3.40GHz desktop</span></p><p><span>TIMEFORMAT</span><span>=</span><span>%</span><span>R</span></p><p><span>for</span><span> </span><span>i</span><span> </span><span>in</span><span> </span><span>{</span><span>1..5</span><span>}</span><span>;</span><span> </span><span>do</span><span> </span><span>time</span><span> </span><span>protoc</span><span> </span><span>--</span><span>decode_raw</span><span> </span><span>&lt;</span><span> </span><span>proto</span><span>.raw</span><span> </span><span>&gt;</span><span> </span><span>/</span><span>dev</span><span>/</span><span>null</span><span>;</span><span> </span><span>done</span></p><p><span># 0.018</span></p><p><span># 0.017</span></p><p><span># 0.022</span></p><p><span># 0.018</span></p><p><span># 0.018</span></p><p><span># On the pfSense router:</span></p><p><span>printf</span><span> </span><span>'foreach f ( 1 2 3 4 5 )\n time protoc --decode_raw &lt; proto.raw &gt; /dev/null \n end \n'</span><span> </span><span>|</span><span> </span><span>tcsh</span></p><p><span># 0.030u 0.114s 0:00.14 100.0%&nbsp;&nbsp;30+153k 2+0io 0pf+0w</span></p><p><span># 0.024u 0.104s 0:00.12 100.0%&nbsp;&nbsp;8+132k 2+0io 0pf+0w</span></p><p><span># 0.022u 0.106s 0:00.12 100.0%&nbsp;&nbsp;34+156k 2+0io 0pf+0w</span></p><p><span># 0.016u 0.114s 0:00.13 92.3%&nbsp;&nbsp; 8+143k 2+0io 0pf+0w</span></p><p><span># 0.023u 0.102s 0:00.12 100.0%&nbsp;&nbsp;8+132k 2+0io 0pf+0w</span></p></div></td></tr></tbody></table></div><p>If you caught that, it takes about <strong>23s</strong> in Python, and <strong>100ms</strong> in C++! In this Never Ending Story, we have to find a way to parse the raw Protobuf payloads in Python using the C++ library <code>libprotobuf.so</code>. In the interest of time, I’ll use <code>subprocess.Popen</code> and communicate with the C++ <code>protoc</code> binary directly (since raw decoding is not supported in Python anyway).</p><p><a href="#top">Top ↩</a></p><hr><h2>Fuzzing the YouTube Video Ad Responses</h2><p>How about fuzzing the ad video responses? Now being able to isolate ad videos, as a smoke test, I sent back <code>200</code> responses with empty bodies and the iOS app went bananas; it was as if there is an infinite loop with no delay just hammering YouTube’s own servers trying to get the next part of the video in panic mode. I felt bad for their servers, so I stopped. Then, what would a happy-path response payload look like?</p><figure id="attachment_5783"><a href="https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video.png"><img src="https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-754x345.png" alt="Infinite spin-lock loop of YouTube trying to get the next bytes of the ad video" width="754" height="345" srcset="https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-754x345.png 754w, https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-300x137.png 300w, https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-600x274.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-754x345.png" data-srcset="https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-754x345.png 754w, https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-300x137.png 300w, https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-600x274.png 600w"></a><figcaption>Infinite spin-lock loop of YouTube trying to get the next bytes of the ad video</figcaption></figure><p>Try as I might, when I send back empty <code>200</code>s, <code>404</code>s, <code>503</code>s, truncate response bodies, or just null-out part of the ad video, the iOS app crawls then crashes spectacularly with a dying breath of a messed up iOS UI. I now block some error reporting endpoint at <code>/error_204/</code> that indicates a “dev assertion failed” so I don’t make some overworked QA pull out their hair.</p><div><p><strong>Failure:</strong> We’ve learned that blocking ad URLs causes the app to deploy countermeasures and even when defeated, the app hangs forever on the ad screen. We’ve also learned that fuzzing ad videos often causes the app to crash – there is even session meta data in the video response chunks.</p></div><p>Let’s go back to what worked with JSON and obliterate the section of the Protobuf responses that contain the array of ad details.</p><p><a href="#top">Top ↩</a></p><hr><h2>Enter Burp Suite Tools for Penetration Testing</h2><p>There is a library for <a href="https://portswigger.net/burp" target="_blank" rel="nofollow">Burp Suite</a> called <code>blackboxprotobuf</code> (get the <a href="https://github.com/nccgroup/blackboxprotobuf/tree/master/lib" target="_blank" rel="nofollow">original Burp Suite version</a>, <strong>not</strong> the PyPi fork, unless you like infinite recursion bugs) that is designed to decode raw Protobuf wire messages, inject something naughty, then re-encode them again to see how a Protobuf endpoint behaves. We are going to have so much fun together in this next section.</p><div id="crayon-63661eaabe51d734281067" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># Install blackboxprotobuf from source</span></p><p><span>mkdir</span><span> </span><span>blackboxprotobuf_src</span><span> </span><span>&amp;&amp;</span><span> </span><span>cd</span><span> </span><span>blackboxprotobuf_src</span></p><p><span>git </span><span>clone</span><span> </span><span>https</span><span>:</span><span>/</span><span>/</span><span>github</span><span>.com</span><span>/</span><span>nccgroup</span><span>/</span><span>blackboxprotobuf</span><span>.git</span><span> </span><span>.</span></p><p><span>pip3 </span><span>install </span><span>poetry</span></p><p><span>cd</span><span> </span><span>lib</span></p><p><span>poetry </span><span>install</span></p><p><span># pwd -&gt; blackboxprotobuf_src/lib/</span></p><p><span>cp</span><span> </span><span>-</span><span>r</span><span> </span><span>blackboxprotobuf </span><span>your</span><span>/</span><span>project</span><span>/</span><span>folder</span></p><p><span># We only need this folder tree for the Py3 API</span></p></div></td></tr></tbody></table></div><p>You may encounter a small world of pain because some forks of blackboxprotobuf will cause a stack overflow due to deep recursion. You can see this by adding <code>sys.setrecursionlimit(200)</code>.</p><p>Compiling the original library source code for Burp Suite and using the C++ bindings will allow us to transcode ~500 kiB of raw Protobuf bytes in just a few seconds.</p><div><p><strong>Tip:</strong> At the top of your import chain before you import <code>protobuf</code>, add</p><div id="crayon-63661eaabe51f564481961" data-nosnippet="data-nosnippet" data-settings=" no-popup minimize scroll-mouseover"><table><tbody><tr><td data-settings="hide"></td><td><div><p><span>import</span><span> </span><span>os</span></p><p><span>os</span><span>.</span><span>environ</span><span>[</span><span>"PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION"</span><span>]</span><span> </span><span>=</span><span> </span><span>"cpp"</span></p></div></td></tr></tbody></table></div><p>to use the C++ <code>libprotobuf.so</code> implementation whenever possible.<br></p></div><p>It is now possible to generate a best-guess <code>.proto</code> schema with a single function:</p><div id="crayon-63661eaabe521008674169" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>import</span><span> </span><span>os</span></p><p><span>os</span><span>.</span><span>environ</span><span>[</span><span>"PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION"</span><span>]</span><span> </span><span>=</span><span> </span><span>"cpp"</span></p><p><span>from</span><span> </span><span>mitmdump</span><span>.</span><span>blackboxprotobuf</span><span>.</span><span>lib </span><span>import</span><span> </span><span>protobuf_to_json</span></p><p><span>data</span><span>:</span><span> </span><span>bytes</span><span> </span><span>=</span><span> </span><span>.</span><span>.</span><span>.</span></p><p><span>message</span><span>,</span><span> </span><span>typedef</span><span> </span><span>=</span><span> </span><span>protobuf_to_json</span><span>(</span><span>data</span><span>)</span></p><p><span># print(message)</span></p><p><span>print</span><span>(</span><span>typedef</span><span>)</span></p></div></td></tr></tbody></table></div><p>The schema isn’t perfect, and it is huge and deeply nested, and takes forever to pretty-print, and is probably wrong, but is just good enough to pull out the ad details like so (Protobuf to JSON in this sample):</p><figure id="attachment_5798"><a href="https://static.ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads.png"><img src="https://ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-754x300.png" alt="Sample Protobuf to JSON showing a section of ads" width="754" height="300" srcset="https://ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-754x300.png 754w, https://static.ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-300x119.png 300w, https://static.ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-600x238.png 600w, https://static.ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads.png 755w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-754x300.png" data-srcset="https://ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-754x300.png 754w, https://static.ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-300x119.png 300w, https://static.ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-600x238.png 600w, https://static.ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads.png 755w"></a><figcaption>Sample Protobuf to JSON showing a section of ads</figcaption></figure><p>The Python schema is huge and looks like this for about 250,000 more charcters:</p><div id="crayon-63661eaabe524527915615" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>OrderedDict</span><span>(</span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>'1'</span><span>,</span><span> </span><span>OrderedDict</span><span>(</span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>'type'</span><span>,</span><span> </span><span>'message'</span><span>)</span><span>,</span><span> </span><span>(</span><span>'message_typedef'</span><span>,</span><span> </span><span>OrderedDict</span><span>(</span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>'6'</span><span>,</span><span> </span><span>OrderedDict</span><span>(</span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>'type'</span><span>,</span><span> </span><span>'message'</span><span>)</span><span>,</span><span> </span><span>(</span><span>'message_typedef'</span><span>,</span><span> </span><span>OrderedDict</span><span>(</span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>'1'</span><span>,</span><span> </span><span>OrderedDict</span><span>(</span><span>[</span><span>.</span><span>.</span><span>.</span></p></div></td></tr></tbody></table></div><p>Reverse engineering the Protobuf schema sounds good on paper, but our target is spectacularly complex and a moving target.</p><p><a href="#top">Top ↩</a></p><hr><h2>Exfil the Proto Schemas from the App, Cleanly?</h2><p>As fun as it to reverse the Protobuf and generate a best-guess schema, wouldn’t it be more ninja-like to exfil the actual, working <code>.proto</code> or schema files from the smartphone app? Let’s pull out the Protobuf schemas from the Android version of the YouTube app and see if the schemas are the same or compatible.</p><p>This is what I tried <em>at first</em>, but it went nowhere with the <a href="https://github.com/marin-m/pbtk" target="_blank" rel="nofollow">Protobuf Toolkit</a> (PBTK). I reproduce it here so I remember what I tried:</p><div id="crayon-63661eaabe527948865294" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>sudo </span><span>apt </span><span>update</span></p><p><span>sudo </span><span>apt </span><span>install </span><span>libqt5x11extras5 </span><span>python3</span><span>-</span><span>pyqt5</span><span>.qtwebengine</span><span> </span><span>python3</span><span>-</span><span>pyqt5</span></p><p><span>pip3 </span><span>install </span><span>pyqt5 </span><span>pyqtwebengine </span><span>requests </span><span>websocket</span><span>-</span><span>client</span></p><p><span>mkdir</span><span> </span><span>pbtk</span><span> </span><span>&amp;&amp;</span><span> </span><span>cd</span><span> </span><span>pbtk</span></p><p><span>git </span><span>clone</span><span> </span><span>https</span><span>:</span><span>/</span><span>/</span><span>github</span><span>.com</span><span>/</span><span>marin</span><span>-</span><span>m</span><span>/</span><span>pbtk</span><span> </span><span>.</span></p><p><span>.</span><span>/</span><span>gui</span><span>.py</span></p></div></td></tr></tbody></table></div><p>After installing Qt dependencies (pronounced “cute”), I was treated to a GUI.</p><figure id="attachment_5799"><a href="https://static.ericdraken.com/files/PBTK-The-Protobuf-Toolkit.png"><img src="https://static.ericdraken.com/files/PBTK-The-Protobuf-Toolkit.png" alt="PBTK - The Protobuf Toolkit" width="694" height="581" srcset="https://static.ericdraken.com/files/PBTK-The-Protobuf-Toolkit.png 694w, https://ericdraken.com/files/PBTK-The-Protobuf-Toolkit-300x251.png 300w, https://static.ericdraken.com/files/PBTK-The-Protobuf-Toolkit-600x502.png 600w" sizes="(max-width: 694px) 100vw, 694px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/PBTK-The-Protobuf-Toolkit.png" data-srcset="https://static.ericdraken.com/files/PBTK-The-Protobuf-Toolkit.png 694w, https://ericdraken.com/files/PBTK-The-Protobuf-Toolkit-300x251.png 300w, https://static.ericdraken.com/files/PBTK-The-Protobuf-Toolkit-600x502.png 600w"></a><figcaption>PBTK – The Protobuf Toolkit</figcaption></figure><p>Next, I got the most recent release of a 100 MiB Android APK file from <a href="https://apkpure.com/" target="_blank" rel="nofollow">apkpure.com</a>.</p><p>Excited in vain, the most PBTK could get was a 59-byte proto file. Another tool called <a href="https://ibotpeaches.github.io/Apktool/install/" target="_blank" rel="nofollow">Apktool</a> also looked promising, but the best it can do is <em>disassemble</em> bytecode, not decompile it – this may be good enough for Pen Testers, however.</p><p>What ended up working for APK decompilation is a combination of a dedicated person’s <a href="https://github.com/pxb1988/dex2jar" target="_blank" rel="nofollow">dex2jar tool</a> and a <a href="http://java-decompiler.github.io/" target="_blank" rel="nofollow">Java Decompiler</a>. A helpful guide can be found <a href="https://stackoverflow.com/a/4177581/1938889" target="_blank" rel="nofollow">here</a>.</p><div id="crayon-63661eaabe529630536553" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># Follow the install steps at https://stackoverflow.com/a/4177581/1938889</span></p><p><span>cd</span><span> </span><span>dex2jar</span></p><p><span>chmod</span><span> </span><span>-</span><span>R</span><span> </span><span>+</span><span>x</span><span> </span><span>*</span><span>.sh</span></p><p><span>sh</span><span> </span><span>d2j</span><span>-</span><span>dex2jar</span><span>.sh</span><span> </span><span>-</span><span>f</span><span> </span><span>-</span><span>o</span><span> </span><span>.</span><span>.</span><span>/</span><span>output</span><span>.jar</span><span> </span><span>.</span><span>.</span><span>/</span><span>YouTube_v16</span><span>.</span><span>49.37_apkpure.com.apk</span></p><p><span>cd</span><span> </span><span>.</span><span>.</span><span>/</span><span>jd</span><span>-</span><span>gui</span></p><p><span>java</span><span> </span><span>-</span><span>jar </span><span>jd</span><span>-</span><span>gui</span><span>-</span><span>1.6.6.jar</span></p></div></td></tr></tbody></table></div><p>You can see that Google went out of its way to complicate reverse engineering.</p><figure id="attachment_5800"><a href="https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes.png"><img src="https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-754x302.png" alt="YouTube APK reversed into obfuscated Java classes" width="754" height="302" srcset="https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-754x302.png 754w, https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-300x120.png 300w, https://ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-600x240.png 600w, https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes.png 1079w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-754x302.png" data-srcset="https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-754x302.png 754w, https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-300x120.png 300w, https://ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-600x240.png 600w, https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes.png 1079w"></a><figcaption>YouTube APK reversed into obfuscated Java classes</figcaption></figure><p>Google thoughtfully did leave some hints.</p><figure id="attachment_5802"><a href="https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable.png"><img src="https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-754x353.png" alt="All the Protobuf schemas laid bare and human-readable" width="754" height="353" srcset="https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-754x353.png 754w, https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-300x141.png 300w, https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-600x281.png 600w, https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable.png 1091w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-754x353.png" data-srcset="https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-754x353.png 754w, https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-300x141.png 300w, https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-600x281.png 600w, https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable.png 1091w"></a><figcaption>All the Protobuf classes laid bare and human-readable</figcaption></figure><p>Upon deeper inspection, the Protobuf classes are right here, in Java, decorated with getters and setters. Since we are using Python, and we cannot get the true schema files, I will leave this approach for now.</p><p><a href="#top">Top ↩</a></p><hr><h2>Hardcore Deep-Dive into Protobuf and Wire Format</h2><p>After gazing into a sea of decrypted network traffic again, then triggering errors and assertion fails on my iPhone with Protobuf fuzzing, and taking a peek at the error logs being phoned home, I’ve noticed that ads register for “slots” in a given video. They can register for pre-roll, mid-roll, end-roll, full-page, and ad pods (back-to-back ads). Blocking an ad URL causes an error along the lines of “some ad that doesn’t exist booked a slot” and UI panic sets in.</p><p>I’m going to Sun Tzu the <a href="https://developers.google.com/protocol-buffers/docs/encoding" target="_blank" rel="nofollow">Protobuf Wire Format</a> and come back in a bit…</p><p>I’m back. The Wire Format is surprisingly elegant, except for <a href="https://developers.google.com/protocol-buffers/docs/encoding#signed_integers" target="_blank" rel="nofollow">ZigZag encoding</a>. Through trial and error, editing out chunks of Protobuf with a hex editor is just a no-go.</p><p>While computationally expensive, decoding, editing, and re-encoding without the original schema leads to a modified encoding. This is likely because we cannot detect if ZigZag encoding is being used, or if a number is an <code>int32</code>, <code>int64</code>, <code>sint32/64</code>, <code>varint</code>, etc., plus the order of object fields is normally non-deterministic. Here is some <a href="https://developers.google.com/protocol-buffers/docs/encoding#implications" target="_blank" rel="nofollow">Protobuf trivia</a> on the matter:</p><figure id="attachment_5810"><a href="https://ericdraken.com/files/Protobuf-serialization-gotachas.png"><img src="https://ericdraken.com/files/Protobuf-serialization-gotachas-754x323.png" alt="Protobuf serialization gotachas" width="754" height="323" srcset="https://ericdraken.com/files/Protobuf-serialization-gotachas-754x323.png 754w, https://ericdraken.com/files/Protobuf-serialization-gotachas-300x128.png 300w, https://ericdraken.com/files/Protobuf-serialization-gotachas-600x257.png 600w, https://ericdraken.com/files/Protobuf-serialization-gotachas.png 850w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Protobuf-serialization-gotachas-754x323.png" data-srcset="https://ericdraken.com/files/Protobuf-serialization-gotachas-754x323.png 754w, https://ericdraken.com/files/Protobuf-serialization-gotachas-300x128.png 300w, https://ericdraken.com/files/Protobuf-serialization-gotachas-600x257.png 600w, https://ericdraken.com/files/Protobuf-serialization-gotachas.png 850w"></a><figcaption>Protobuf serialization gotachas</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Exploit a Protobuf Flaw to Easily Remove All Ads by Changing One Byte</h2><p>Casually poring over the C++ source code, an interesting comment in the Protobuf code caught my eye:</p><blockquote><p><code>UnknownFieldSet</code> is used to keep track of fields that were seen when parsing a protocol message but whose field numbers or types are unrecognized. This most frequently occurs when new fields are added to a message type and then messages containing those fields are read by old software that was compiled before the new types were added. (<a href="https://developers.google.com/protocol-buffers/docs/proto3#unknowns" target="_blank" rel="nofollow">ref</a>)</p></blockquote><p>Yes, what to do with unknown fields? What to do indeed. And, how easy would it be to say, change a <code>49399797</code> field key to, say, <code>49399796</code> thus making an entire substructure of advertisement and tracking information suddenly unavailable? Tantalizing.</p><p>And, if we can calculate the field tags in bytes with bit-twiddling, then can we use a simple regex to AMF<a title="Adios, My Friend" rel="nofollow" id="return-note-5418-1" href="#note-5418-1"><sup>1</sup></a> the section of ads in <code>O(n)</code> time?</p><p>As a motivating example, I’d like to find the field key <code>49399797</code> which is not as simple as searching for <code>2F1C7F5</code>. Here is an implementation of a tag-scanning algorithm so you can see the bit-twiddling:</p><div id="crayon-63661eaabe52e139325226" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>def</span><span> </span><span>DecodeVarint</span><span>(</span><span>buffer</span><span>,</span><span> </span><span>pos</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;</span><span>mask</span><span> </span><span>=</span><span> </span><span>(</span><span>1</span><span> </span><span>&lt;&lt;</span><span> </span><span>64</span><span>)</span><span> </span><span>-</span><span> </span><span>1</span></p><p><span>&nbsp;&nbsp;</span><span>result</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>&nbsp;&nbsp;</span><span>shift</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>&nbsp;&nbsp;</span><span>while</span><span> </span><span>1</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span> </span><span>=</span><span> </span><span>buffer</span><span>[</span><span>pos</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>result</span><span> </span><span>|=</span><span> </span><span>(</span><span>(</span><span>b</span><span> </span><span>&amp;</span><span> </span><span>0x7f</span><span>)</span><span> </span><span>&lt;&lt;</span><span> </span><span>shift</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>pos</span><span> </span><span>+=</span><span> </span><span>1</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>not</span><span> </span><span>(</span><span>b</span><span> </span><span>&amp;</span><span> </span><span>0x80</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>result</span><span> </span><span>&amp;=</span><span> </span><span>mask</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>result</span><span> </span><span>=</span><span> </span><span>int</span><span>(</span><span>result</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>(</span><span>result</span><span>,</span><span> </span><span>pos</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>shift</span><span> </span><span>+=</span><span> </span><span>7</span></p></div></td></tr></tbody></table></div><p>We know the wire type is <code>2</code> (length-delimited nested string/message), and one target field <em>key</em> is <code>49399797</code>. When bit-twiddled, we get the target <em>tag</em></p><p><code>AA FF B8 BC 01</code></p><p>where the final <code>01</code> happens to mean <code>2</code> (the wire type) in hex. In binary, this is:</p><p><code>10101010 11111111 10111000 10111100 00000001</code></p><p>Let’s lose the MSB from each byte as per the var-length wire format:</p><p><code>.0101010 .1111111 .0111000 .0111100 .0000001</code></p><p>Then we shift and add only the first four bytes since the LSB is first:</p><div id="crayon-63661eaabe531447697148" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>42</span><span> </span><span>+</span><span> </span><span>(</span><span>127</span><span> </span><span>*</span><span> </span><span>2</span><span>^</span><span>7</span><span>)</span><span> </span><span>+</span><span> </span><span>(</span><span>56</span><span> </span><span>*</span><span> </span><span>2</span><span>^</span><span>14</span><span>)</span><span> </span><span>+</span><span> </span><span>(</span><span>188</span><span> </span><span>*</span><span> </span><span>2</span><span>^</span><span>21</span><span>)</span><span> </span><span>=</span></p><p><span>42</span><span> </span><span>+</span><span> </span><span>(</span><span>127</span><span> </span><span>*</span><span> </span><span>128</span><span>)</span><span> </span><span>+</span><span> </span><span>(</span><span>56</span><span> </span><span>*</span><span> </span><span>16384</span><span>)</span><span> </span><span>+</span><span> </span><span>(</span><span>188</span><span> </span><span>*</span><span> </span><span>2097152</span><span>)</span><span> </span><span>=</span></p><p><span>42</span><span> </span><span>+</span><span> </span><span>16256</span><span> </span><span>+</span><span> </span><span>917504</span><span> </span><span>+</span><span> </span><span>394264576</span><span> </span><span>=</span></p><p><span>395198378</span></p></div></td></tr></tbody></table></div><p>Finally, we shift out the number of wire type bits (3) to get back the field key:</p><p><code>395198378 &gt;&gt; 3 = 49399797</code></p><p>And that, folks, is a taste of how Wire Format works.</p><p>Fantastic. Now, all we have to do is scan the Protobuf bytes for classic ad URL signatures like <code>/pagead/</code> to bound our field search, then move backward from there until we find the target(s) field tags and thus field keys we would like to denature (e.g. <code>49399797</code> –&gt; <code>49399796</code>).</p><div id="crayon-63661eaabe533307450758" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>&gt;&gt;</span><span> </span><span>Request</span><span>(</span><span>POST </span><span>youtubei</span><span>.googleapis</span><span>.com</span><span>:</span><span>443</span><span>/</span><span>youtubei</span><span>/</span><span>v1</span><span>/</span><span>browse</span><span>?</span><span>key</span><span>=</span><span>.</span><span>.</span><span>.</span><span>)</span></p><p><span>&lt;&lt;</span><span> </span><span>Response</span><span>(</span><span>200</span><span>,</span><span> </span><span>application</span><span>/</span><span>x</span><span>-</span><span>protobuf</span><span>,</span><span> </span><span>1.87m</span><span>)</span></p><p><span>Intercepting </span><span>https</span><span>:</span><span>/</span><span>/</span><span>youtubei</span><span>.googleapis</span><span>.com</span><span>/</span><span>youtubei</span><span>/</span><span>v1</span><span>/</span><span>browse</span><span>?</span><span>key</span><span>=</span><span>.</span><span>.</span><span>.</span><span> </span><span>(</span><span>Protobuf</span><span>)</span></p><p><span>Found </span><span>key</span><span> </span><span>49399797</span><span> </span><span>at</span><span> </span><span>position</span><span> </span><span>4465</span></p><p><span>Found </span><span>key</span><span> </span><span>50195462</span><span> </span><span>at</span><span> </span><span>position</span><span> </span><span>4477</span></p></div></td></tr></tbody></table></div><p>Notice how the Protobuf response payload is <strong>1.87 MiB</strong>? As I said, Google makes it computationally expensive to decode, alter, and re-encode without the C++ source proto files, but a quick linear scan takes no effort at all.</p><figure id="attachment_5822"><a href="https://static.ericdraken.com/files/Walking-backward-from-the-ad-marker.png"><img src="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png" alt="Walking backward from the ad marker" width="754" height="617" srcset="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png 754w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-300x246.png 300w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-600x491.png 600w, https://static.ericdraken.com/files/Walking-backward-from-the-ad-marker.png 966w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png" data-srcset="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png 754w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-300x246.png 300w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-600x491.png 600w, https://static.ericdraken.com/files/Walking-backward-from-the-ad-marker.png 966w"></a><figcaption>Walking backward from the ad marker</figcaption></figure><p>Just a quick note, there is more than one field tag, but not all of them represent ads. That is why we need to backtrack from the <code>/pagead/</code> markers.</p><figure id="attachment_5892"><a href="https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present.png"><img src="https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present.png" alt="Multiple identical field tags may be present" width="675" height="99" srcset="https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present.png 675w, https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present-300x44.png 300w, https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present-600x88.png 600w" sizes="(max-width: 675px) 100vw, 675px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present.png" data-srcset="https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present.png 675w, https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present-300x44.png 300w, https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present-600x88.png 600w"></a><figcaption>Multiple identical field tags may be present</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Smoke Test: Remove Ads from Protobuf in O(n)-Time</h2><p><strong><span>It works!</span></strong> In one pass with no additional memory, I’m able to scan a huge 1.8 MiB chunk of jibberish-looking Protobuf data, and in the screenshot below only at the 30,593<sup>th</sup> byte (of 1.8 MiB) is our target found, and then backtracking ~600 characters yields our target field key to denature. Not only is this amazing, but I don’t even need to block <code>*.googleadservices.com</code> or URLs with <code>/pagead/</code> in them; Those requests are never made in the first place, anymore.</p><figure id="attachment_5838"><a href="https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response.png"><img src="https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-754x329.png" alt="Successfully able to remove ads from the Protobuf response" width="754" height="329" srcset="https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-754x329.png 754w, https://static.ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-300x131.png 300w, https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-600x262.png 600w, https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response.png 1313w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-754x329.png" data-srcset="https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-754x329.png 754w, https://static.ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-300x131.png 300w, https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-600x262.png 600w, https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response.png 1313w"></a><figcaption>Successfully able to remove ads from the Protobuf response</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Analysis of this Successful Adblocking Technique</h2><h3>Summary</h3><p>By taking advantage of a feature (flaw?) in Protobuf that allows it to be backward compatible with schema changes, along with the fact that Protobuf is very sensitive to byte changes due to its compact nature, we can change a single byte in a critical location and tell Protobuf that an entire section of deeply-nested data is from a future schema version and it should be ignored.</p><h3>Timing Analysis</h3><p>Google returns huge responses in Protobuf (e.g. 1.8 MiB) – including even the layout of the iOS app – so only C++/Swift is fast enough to understand it all before the connection times out. I’ve shown that Python is several orders of magnitude too slow in decoding these Protobuf payloads, so connections do time out waiting on Python. With web-based JSON, the whole payload needs to be parsed, edited, and re-serialized; With my Protobuf technique, it takes microseconds thanks to a single linear scan and then ultra-quick backtracking. This technique is suitable for real-time adblocking without blocklists.</p><h3>Knock-On Benefits</h3><p>All those <code>*.googleadservices.com</code> and <code>/pagead/*</code> URLs on Apple devices originate from the Protobuf payload. This means they all go away for free – we don’t need to block them. In fact, the YouTube app is zippier because fewer connections are made to ad URLs in the first place. This means we can avoid keeping a blocklist of YouTube ad URLs and stay on the sidelines of the whack-a-mole fun. Ads do not register for video location “slots” on the Apple devices and the content just plays.</p><h3>Future-Proof</h3><p>This is a heuristic technique that looks for two strings: <code>/pagead/</code> and some calculated field tag nearby, so this technique is designed to be future-proof.</p><figure id="attachment_5822"><a href="https://static.ericdraken.com/files/Walking-backward-from-the-ad-marker.png"><img src="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png" alt="Walking backward from the ad marker" width="754" height="617" srcset="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png 754w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-300x246.png 300w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-600x491.png 600w, https://static.ericdraken.com/files/Walking-backward-from-the-ad-marker.png 966w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png" data-srcset="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png 754w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-300x246.png 300w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-600x491.png 600w, https://static.ericdraken.com/files/Walking-backward-from-the-ad-marker.png 966w"></a><figcaption>Walking backward from the ad marker to find the field key</figcaption></figure><p>Even if Google changes the field tag (and breaks millions of apps and Apple TVs before they upgrade), it’s an academic exercise to enhance the following script to discover the new field tag(s) automatically.</p><h3>Should Google be Worried?</h3><p>No, not at all.</p><p>This is a <strong>highly-specialized technique</strong> to block Apple-device YouTube ads (or Instagram, Whatsapp, Facebook, etc. tracker blocking). The CPU requirements to decrypt and re-encrypt HTTPS traffic greatly exceed those available to Raspberry Pis. Even if some company takes my script and considers making and selling a NIC dongle, it would likely not be powerful enough. An <a href="https://www.nvidia.com/en-us/shield/shield-tv/" target="_blank" rel="nofollow">Nvidia Shield</a> could handle it, but if you already have Android devices, then just hack the binaries; My technique is for Apple device owners where we don’t want to compromise the OS so that further reduces the audience of this technique.</p><p><a href="#top">Top ↩</a></p><hr><h2>The MITMProxy YouTube Adblocking Script</h2><p>Here is the MITMProxy addon script that serves as a proof-of-concept to block YouTube ads on networked Apple devices. The script can be run as follows (note the prerequisites in the script and be sure to install them first). Name it <code>youtube.py</code> and run the following command:</p><p><code>mitmdump --listen-port 8080 --listen-host 127.0.0.1 -s "youtube.py"</code></p><p>Here is the script, including a fairness function to allow ads 5% of the time:</p><div id="crayon-63661eaabe539122026764" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p><p>65</p><p>66</p><p>67</p><p>68</p><p>69</p><p>70</p><p>71</p><p>72</p><p>73</p><p>74</p><p>75</p><p>76</p><p>77</p><p>78</p><p>79</p><p>80</p><p>81</p><p>82</p><p>83</p><p>84</p><p>85</p><p>86</p><p>87</p><p>88</p><p>89</p><p>90</p><p>91</p><p>92</p><p>93</p><p>94</p><p>95</p><p>96</p><p>97</p><p>98</p><p>99</p><p>100</p><p>101</p><p>102</p><p>103</p><p>104</p><p>105</p><p>106</p><p>107</p><p>108</p><p>109</p><p>110</p><p>111</p><p>112</p><p>113</p><p>114</p><p>115</p><p>116</p><p>117</p><p>118</p><p>119</p><p>120</p><p>121</p><p>122</p><p>123</p><p>124</p><p>125</p><p>126</p><p>127</p><p>128</p><p>129</p><p>130</p><p>131</p><p>132</p><p>133</p><p>134</p><p>135</p><p>136</p><p>137</p><p>138</p><p>139</p><p>140</p><p>141</p><p>142</p><p>143</p><p>144</p><p>145</p><p>146</p><p>147</p><p>148</p><p>149</p><p>150</p><p>151</p><p>152</p><p>153</p><p>154</p><p>155</p><p>156</p><p>157</p><p>158</p><p>159</p><p>160</p><p>161</p><p>162</p><p>163</p><p>164</p><p>165</p><p>166</p><p>167</p><p>168</p><p>169</p><p>170</p><p>171</p><p>172</p><p>173</p><p>174</p><p>175</p><p>176</p><p>177</p><p>178</p><p>179</p><p>180</p><p>181</p><p>182</p><p>183</p><p>184</p><p>185</p><p>186</p><p>187</p><p>188</p><p>189</p><p>190</p><p>191</p><p>192</p><p>193</p><p>194</p><p>195</p><p>196</p><p>197</p><p>198</p><p>199</p><p>200</p><p>201</p><p>202</p><p>203</p><p>204</p><p>205</p><p>206</p><p>207</p><p>208</p><p>209</p><p>210</p><p>211</p><p>212</p><p>213</p><p>214</p><p>215</p><p>216</p><p>217</p><p>218</p><p>219</p><p>220</p><p>221</p><p>222</p><p>223</p><p>224</p><p>225</p><p>226</p><p>227</p><p>228</p><p>229</p><p>230</p><p>231</p><p>232</p><p>233</p><p>234</p><p>235</p><p>236</p><p>237</p><p>238</p><p>239</p><p>240</p><p>241</p><p>242</p><p>243</p><p>244</p><p>245</p><p>246</p><p>247</p><p>248</p><p>249</p><p>250</p><p>251</p><p>252</p><p>253</p><p>254</p><p>255</p><p>256</p><p>257</p><p>258</p><p>259</p><p>260</p><p>261</p><p>262</p><p>263</p><p>264</p><p>265</p><p>266</p><p>267</p><p>268</p><p>269</p><p>270</p><p>271</p><p>272</p><p>273</p><p>274</p><p>275</p><p>276</p><p>277</p><p>278</p><p>279</p><p>280</p><p>281</p><p>282</p><p>283</p><p>284</p><p>285</p><p>286</p><p>287</p><p>288</p><p>289</p><p>290</p><p>291</p><p>292</p><p>293</p><p>294</p><p>295</p><p>296</p><p>297</p><p>298</p><p>299</p><p>300</p><p>301</p><p>302</p><p>303</p><p>304</p><p>305</p><p>306</p><p>307</p><p>308</p><p>309</p><p>310</p><p>311</p><p>312</p><p>313</p><p>314</p><p>315</p><p>316</p><p>317</p><p>318</p><p>319</p><p>320</p><p>321</p><p>322</p><p>323</p><p>324</p><p>325</p><p>326</p><p>327</p><p>328</p><p>329</p><p>330</p><p>331</p><p>332</p><p>333</p><p>334</p><p>335</p><p>336</p><p>337</p><p>338</p><p>339</p><p>340</p><p>341</p><p>342</p><p>343</p><p>344</p><p>345</p><p>346</p><p>347</p><p>348</p><p>349</p><p>350</p><p>351</p><p>352</p><p>353</p><p>354</p><p>355</p><p>356</p><p>357</p><p>358</p><p>359</p><p>360</p><p>361</p><p>362</p><p>363</p><p>364</p><p>365</p><p>366</p><p>367</p><p>368</p></div></td><td><div><p><span># -*- coding: utf-8 -*-</span></p><p><span>#&nbsp;&nbsp;Copyright (c) 2021. Eric Draken (ericdraken.com)</span></p><p><span>#&nbsp;&nbsp;Block YouTube ads on Apple devices by exploiting a Protobuf flaw</span></p><p><span>#</span></p><p><span>#&nbsp;&nbsp;FreeBSD Prerequisites:</span></p><p><span>#&nbsp;&nbsp;pkg install protobuf</span></p><p><span>#&nbsp;&nbsp;pkg install py38-pip</span></p><p><span>#&nbsp;&nbsp;pip install jsonpath-ng</span></p><p><span>#</span></p><p><span>import</span><span> </span><span>hashlib</span></p><p><span>import</span><span> </span><span>inspect</span></p><p><span>import</span><span> </span><span>json</span></p><p><span>import</span><span> </span><span>re</span></p><p><span>import</span><span> </span><span>subprocess</span></p><p><span>import</span><span> </span><span>sys</span></p><p><span>import</span><span> </span><span>traceback</span></p><p><span>from</span><span> </span><span>datetime</span><span> </span><span>import</span><span> </span><span>datetime</span></p><p><span>from</span><span> </span><span>json</span><span> </span><span>import</span><span> </span><span>JSONDecodeError</span></p><p><span>from</span><span> </span><span>typing </span><span>import</span><span> </span><span>Final</span></p><p><span>from</span><span> </span><span>google</span><span>.</span><span>protobuf</span><span>.</span><span>internal</span><span>.</span><span>encoder </span><span>import</span><span> </span><span>TagBytes</span></p><p><span>from</span><span> </span><span>google</span><span>.</span><span>protobuf</span><span>.</span><span>text_format </span><span>import</span><span> </span><span>WIRETYPE_LENGTH_DELIMITED</span></p><p><span>from</span><span> </span><span>jsonpath_ng </span><span>import</span><span> </span><span>DatumInContext</span></p><p><span>from</span><span> </span><span>jsonpath_ng </span><span>import</span><span> </span><span>jsonpath</span><span>,</span><span> </span><span>parse</span></p><p><span>from</span><span> </span><span>jsonpath_ng</span><span>.</span><span>ext </span><span>import</span><span> </span><span>parse</span></p><p><span>from</span><span> </span><span>mitmproxy </span><span>import</span><span> </span><span>ctx</span><span>,</span><span> </span><span>http</span></p><p><span>from</span><span> </span><span>mitmproxy</span><span>.</span><span>addons</span><span>.</span><span>next_layer </span><span>import</span><span> </span><span>NextLayer</span></p><p><span>from</span><span> </span><span>mitmproxy</span><span>.</span><span>flow </span><span>import</span><span> </span><span>Error</span></p><p><span>from</span><span> </span><span>mitmproxy</span><span>.</span><span>proxy </span><span>import</span><span> </span><span>layer</span><span>,</span><span> </span><span>layers</span></p><p><span>TRUNCATE_LEN</span><span>:</span><span> </span><span>Final</span><span>[</span><span>int</span><span>]</span><span> </span><span>=</span><span> </span><span>120</span></p><p><span>DEBUG_MODE</span><span>:</span><span> </span><span>bool</span><span> </span><span>=</span><span> </span><span>False</span></p><p><span>class</span><span> </span><span>Logger</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Helper to bypass the async logger loop to view logs in real-time"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>info</span><span>(</span><span>self</span><span>,</span><span> </span><span>msg</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>print</span><span>(</span><span>msg</span><span>)</span><span> </span><span>if</span><span> </span><span>DEBUG_MODE </span><span>else</span><span> </span><span>ctx</span><span>.</span><span>log</span><span>.</span><span>info</span><span>(</span><span>msg</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>warn</span><span>(</span><span>self</span><span>,</span><span> </span><span>msg</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>print</span><span>(</span><span>msg</span><span>)</span><span> </span><span>if</span><span> </span><span>DEBUG_MODE </span><span>else</span><span> </span><span>ctx</span><span>.</span><span>log</span><span>.</span><span>warn</span><span>(</span><span>msg</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>error</span><span>(</span><span>self</span><span>,</span><span> </span><span>msg</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>print</span><span>(</span><span>msg</span><span>)</span><span> </span><span>if</span><span> </span><span>DEBUG_MODE </span><span>else</span><span> </span><span>ctx</span><span>.</span><span>log</span><span>.</span><span>error</span><span>(</span><span>msg</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>alert</span><span>(</span><span>self</span><span>,</span><span> </span><span>msg</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>print</span><span>(</span><span>msg</span><span>)</span><span> </span><span>if</span><span> </span><span>DEBUG_MODE </span><span>else</span><span> </span><span>ctx</span><span>.</span><span>log</span><span>.</span><span>alert</span><span>(</span><span>msg</span><span>)</span></p><p><span>logger</span><span> </span><span>=</span><span> </span><span>Logger</span><span>(</span><span>)</span></p><p><span>def</span><span> </span><span>trunc</span><span>(</span><span>msg</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>str</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Helper for viewing very long URLs"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>msg</span><span> </span><span>=</span><span> </span><span>str</span><span>(</span><span>msg</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>len</span><span>(</span><span>msg</span><span>)</span><span> </span><span>&gt;</span><span> </span><span>TRUNCATE_LEN</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>f</span><span>"{msg[:TRUNCATE_LEN-3]}..."</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>msg</span></p><p><span>class</span><span> </span><span>KilledError</span><span>(</span><span>Error</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Better logging messages than just 'Connection killed.'"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>__init__</span><span>(</span><span>self</span><span>,</span><span> </span><span>reason</span><span>:</span><span> </span><span>str</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>None</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>_msg</span><span> </span><span>=</span><span> </span><span>Error</span><span>.</span><span>KILLED_MESSAGE</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>reason</span><span> </span><span>=</span><span> </span><span>reason</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>super</span><span>(</span><span>)</span><span>.</span><span>__init__</span><span>(</span><span>self</span><span>.</span><span>_msg</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>@</span><span>property</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>msg</span><span>(</span><span>self</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>caller</span><span> </span><span>=</span><span> </span><span>inspect</span><span>.</span><span>stack</span><span>(</span><span>)</span><span>[</span><span>1</span><span>]</span><span>.</span><span>function</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># These are the only two methods that compare the msg</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># with KILLED_MESSAGE to perform business logic</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>"killable"</span><span> </span><span>in</span><span> </span><span>caller </span><span>or</span><span> </span><span>"check_killed"</span><span> </span><span>in</span><span> </span><span>caller</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>self</span><span>.</span><span>_msg</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>self</span><span>.</span><span>reason</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Needed to satisfy a flow setter</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>@</span><span>msg</span><span>.</span><span>setter</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>msg</span><span>(</span><span>self</span><span>,</span><span> </span><span>msg</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>_msg</span><span> </span><span>=</span><span> </span><span>msg</span></p><p><span>class</span><span> </span><span>JSONPathReplacement</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Helper class to organize JSON ad replacements"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>__init__</span><span>(</span><span>self</span><span>,</span><span> </span><span>tag</span><span>:</span><span> </span><span>str</span><span>,</span><span> </span><span>target_path</span><span>:</span><span> </span><span>str</span><span>,</span><span> </span><span>replacement</span><span>:</span><span> </span><span>any</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>None</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>tag</span><span>:</span><span> </span><span>str</span><span> </span><span>=</span><span> </span><span>tag</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>target_path</span><span> </span><span>=</span><span> </span><span>target_path</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>target</span><span>:</span><span> </span><span>jsonpath</span><span>.</span><span>Root</span><span> </span><span>=</span><span> </span><span>parse</span><span>(</span><span>target_path</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>replacement</span><span>:</span><span> </span><span>any</span><span> </span><span>=</span><span> </span><span>replacement</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>update</span><span>(</span><span>self</span><span>,</span><span> </span><span>obj</span><span>:</span><span> </span><span>object</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>found</span><span> </span><span>=</span><span> </span><span>self</span><span>.</span><span>target</span><span>.</span><span>find</span><span>(</span><span>obj</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>found</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>index</span><span>,</span><span> </span><span>item </span><span>in</span><span> </span><span>enumerate</span><span>(</span><span>found</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>target</span><span>.</span><span>update</span><span>(</span><span>item</span><span>,</span><span> </span><span>self</span><span>.</span><span>replacement</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"Replaced `{self.target_path}[{index}]` with `{self.replacement}`"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>DEBUG_MODE</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>found_again</span><span> </span><span>=</span><span> </span><span>self</span><span>.</span><span>target</span><span>.</span><span>find</span><span>(</span><span>obj</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>replacement_json</span><span> </span><span>=</span><span> </span><span>json</span><span>.</span><span>dumps</span><span>(</span><span>self</span><span>.</span><span>replacement</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>index</span><span>,</span><span> </span><span>item_ </span><span>in</span><span> </span><span>enumerate</span><span>(</span><span>found_again</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>item</span><span>:</span><span> </span><span>DatumInContext</span><span> </span><span>=</span><span> </span><span>item_</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>json</span><span>.</span><span>dumps</span><span>(</span><span>item</span><span>.</span><span>value</span><span>)</span><span> </span><span>!=</span><span> </span><span>replacement_json</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>error</span><span>(</span><span>f</span><span>"Replacement of `{self.target_path}` did not succeed. Found `{json.dumps(item.value)}`"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>info</span><span>(</span><span>f</span><span>"-Skipping `{self.target_path}`"</span><span>)</span></p><p><span>class</span><span> </span><span>ProtobufDebugParser</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Use the C++ protoc binary to parse raw Protobuf data. This is for debugging."""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>cmd</span><span> </span><span>=</span><span> </span><span>[</span><span>"protoc"</span><span>,</span><span> </span><span>"--decode_raw"</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>url_re</span><span> </span><span>=</span><span> </span><span>re</span><span>.</span><span>compile</span><span>(</span><span>r</span><span>"(https?://[^\s\\]+)"</span><span>,</span><span> </span><span>re</span><span>.</span><span>IGNORECASE</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>format_response</span><span>(</span><span>self</span><span>,</span><span> </span><span>data</span><span>:</span><span> </span><span>bytes</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>list</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>protoc_proc</span><span> </span><span>=</span><span> </span><span>subprocess</span><span>.</span><span>Popen</span><span>(</span><span>self</span><span>.</span><span>cmd</span><span>,</span><span> </span><span>shell</span><span>=</span><span>False</span><span>,</span><span> </span><span>stdin</span><span>=</span><span>subprocess</span><span>.</span><span>PIPE</span><span>,</span><span> </span><span>stdout</span><span>=</span><span>subprocess</span><span>.</span><span>PIPE</span><span>,</span><span> </span><span>stderr</span><span>=</span><span>subprocess</span><span>.</span><span>PIPE</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>stdout</span><span>,</span><span> </span><span>stderr</span><span>)</span><span> </span><span>=</span><span> </span><span>protoc_proc</span><span>.</span><span>communicate</span><span>(</span><span>data</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>stderr</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>raise</span><span> </span><span>Exception</span><span>(</span><span>stderr</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>stdout</span><span>.</span><span>splitlines</span><span>(</span><span>keepends</span><span>=</span><span>False</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>parse_response</span><span>(</span><span>self</span><span>,</span><span> </span><span>data</span><span>:</span><span> </span><span>bytes</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>list</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>protoc_proc</span><span> </span><span>=</span><span> </span><span>subprocess</span><span>.</span><span>Popen</span><span>(</span><span>self</span><span>.</span><span>cmd</span><span>,</span><span> </span><span>shell</span><span>=</span><span>False</span><span>,</span><span> </span><span>stdin</span><span>=</span><span>subprocess</span><span>.</span><span>PIPE</span><span>,</span><span> </span><span>stdout</span><span>=</span><span>subprocess</span><span>.</span><span>PIPE</span><span>,</span><span> </span><span>stderr</span><span>=</span><span>subprocess</span><span>.</span><span>PIPE</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>grep_process</span><span> </span><span>=</span><span> </span><span>subprocess</span><span>.</span><span>Popen</span><span>(</span><span>[</span><span>"grep"</span><span>,</span><span> </span><span>"https://"</span><span>]</span><span>,</span><span> </span><span>shell</span><span>=</span><span>False</span><span>,</span><span> </span><span>stdin</span><span>=</span><span>protoc_proc</span><span>.</span><span>stdout</span><span>,</span><span> </span><span>stdout</span><span>=</span><span>subprocess</span><span>.</span><span>PIPE</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>_</span><span>,</span><span> </span><span>stderr</span><span>)</span><span> </span><span>=</span><span> </span><span>protoc_proc</span><span>.</span><span>communicate</span><span>(</span><span>data</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>stdout</span><span>,</span><span> </span><span>_</span><span>)</span><span> </span><span>=</span><span> </span><span>grep_process</span><span>.</span><span>communicate</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>stderr</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>raise</span><span> </span><span>Exception</span><span>(</span><span>stderr</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>urls</span><span> </span><span>=</span><span> </span><span>stdout</span><span>.</span><span>splitlines</span><span>(</span><span>keepends</span><span>=</span><span>False</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>matches</span><span> </span><span>=</span><span> </span><span>[</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>url </span><span>in</span><span> </span><span>urls</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>match</span><span> </span><span>=</span><span> </span><span>self</span><span>.</span><span>url_re</span><span>.</span><span>search</span><span>(</span><span>url</span><span>.</span><span>decode</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>match</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>matches</span><span>.</span><span>append</span><span>(</span><span>match</span><span>.</span><span>group</span><span>(</span><span>0</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>matches</span></p><p><span>class</span><span> </span><span>YouTubeAdBlocker</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Intercept certain YouTube domains and modify the JSON or Protobuf to remove ads from YouTube"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Set this to the blackhole IP used by pfBlockerNG, or even a partial blackhole IP</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>blackhole_ip_prefix</span><span>:</span><span> </span><span>Final</span><span>[</span><span>str</span><span>]</span><span> </span><span>=</span><span> </span><span>"10.10.10."</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Intercept only these wildcard domains and no others</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>intercept_hosts</span><span> </span><span>=</span><span> </span><span>r</span><span>"\.youtube\.com|google\.(com|ca)|googleapis\.com|googleadservices\.com|googlevideo\.com"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>intercept_hosts_re</span><span> </span><span>=</span><span> </span><span>re</span><span>.</span><span>compile</span><span>(</span><span>intercept_hosts</span><span>,</span><span> </span><span>re</span><span>.</span><span>IGNORECASE</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ad_url_search_string</span><span> </span><span>=</span><span> </span><span>b</span><span>"/pagead/"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ad_url_search_limit</span><span> </span><span>=</span><span> </span><span>80_000</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>target_field_tag</span><span> </span><span>=</span><span> </span><span>50195462</span><span>&nbsp;&nbsp;</span><span># This is just one of several field tags</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>protobuf_parser</span><span> </span><span>=</span><span> </span><span>ProtobufDebugParser</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Block requests from wildcard domains with any of the follow URL strings</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>blocked_partials</span><span>:</span><span> </span><span>dict</span><span> </span><span>=</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"youtube.com"</span><span>:</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"pagead/"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"log_event?"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"stats/ads"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"stats/qoe?"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"ptracking?"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"generate_204"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"error_204"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"adformat="</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"activeview?"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"_ad_"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"ai?"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"sw.js"</span><span>,</span><span>&nbsp;&nbsp;</span><span># Just say no to service workers</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"google.com"</span><span>:</span><span> </span><span>[</span><span>"pagead/"</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"google.ca"</span><span>:</span><span> </span><span>[</span><span>"pagead/"</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"googleapis.com"</span><span>:</span><span> </span><span>[</span><span>"pagead/"</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Strip sections of JSON that contain ad information (for web YouTube)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>json_replacements</span><span> </span><span>=</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"yt_ad"</span><span>,</span><span> </span><span>"$.responseContext.serviceTrackingParams[*].params[?(@.key == 'yt_ad')].value"</span><span>,</span><span> </span><span>"0"</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"adPlacements"</span><span>,</span><span> </span><span>"$..adPlacements"</span><span>,</span><span> </span><span>[</span><span>]</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"adPlacementRenderer"</span><span>,</span><span> </span><span>"$..adPlacementRenderer"</span><span>,</span><span> </span><span>{</span><span>}</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"adPlacementConfig"</span><span>,</span><span> </span><span>"$..adPlacementConfig"</span><span>,</span><span> </span><span>{</span><span>}</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"adVideoId"</span><span>,</span><span> </span><span>"$..adVideoId"</span><span>,</span><span> </span><span>""</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"playerAdParams"</span><span>,</span><span> </span><span>"$..playerAdParams"</span><span>,</span><span> </span><span>{</span><span>}</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"showCompanion"</span><span>,</span><span> </span><span>"$..showCompanion"</span><span>,</span><span> </span><span>False</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"showInstream"</span><span>,</span><span> </span><span>"$..showInstream"</span><span>,</span><span> </span><span>False</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"useGut"</span><span>,</span><span> </span><span>"$..useGut"</span><span>,</span><span> </span><span>False</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"gutParams"</span><span>,</span><span> </span><span>"$..gutParams"</span><span>,</span><span> </span><span>{</span><span>}</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>@</span><span>staticmethod</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>in_allowed_ads_window</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Allow ads 5% of the time to support content creators which follows the CRTC rules for Student Radio.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;REF: https://crtc.gc.ca/eng/television/publicit/publicit.htm"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>now</span><span> </span><span>=</span><span> </span><span>datetime</span><span>.</span><span>now</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>0</span><span> </span><span>&lt;=</span><span> </span><span>now</span><span>.</span><span>minute</span><span> </span><span>&lt;=</span><span> </span><span>2</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""The following methods are hooks that are called during the normal flow of MITMProxy"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># noinspection PyMethodMayBeStatic</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>load</span><span>(</span><span>self</span><span>,</span><span> </span><span>_</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Do not allow piped requests we could miss</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span>.</span><span>options</span><span>.</span><span>http2</span><span> </span><span>=</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span>.</span><span>options</span><span>.</span><span>update</span><span>(</span><span>http2</span><span>=</span><span>False</span><span>,</span><span> </span><span>anticomp</span><span>=</span><span>True</span><span>,</span><span> </span><span>mode</span><span>=</span><span>"transparent"</span><span>,</span><span> </span><span>termlog_verbosity</span><span>=</span><span>"debug"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>except</span><span> </span><span>KeyError</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span>.</span><span>options</span><span>.</span><span>update</span><span>(</span><span>http2</span><span>=</span><span>False</span><span>,</span><span> </span><span>anticomp</span><span>=</span><span>True</span><span>,</span><span> </span><span>mode</span><span>=</span><span>"transparent"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"{self.__class__.__name__} loaded"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>running</span><span>(</span><span>self</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Intercept requests only for YouTube domains"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>ctx</span><span>.</span><span>options</span><span>.</span><span>allow_hosts</span><span> </span><span>!=</span><span> </span><span>[</span><span>self</span><span>.</span><span>intercept_hosts</span><span>]</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span>.</span><span>options</span><span>.</span><span>allow_hosts</span><span> </span><span>=</span><span> </span><span>[</span><span>self</span><span>.</span><span>intercept_hosts</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span>.</span><span>options</span><span>.</span><span>ignore_hosts</span><span> </span><span>=</span><span> </span><span>[</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>next_layer_addon</span><span>:</span><span> </span><span>NextLayer</span><span> </span><span>=</span><span> </span><span>ctx</span><span>.</span><span>master</span><span>.</span><span>addons</span><span>.</span><span>get</span><span>(</span><span>"NextLayer"</span><span>.</span><span>lower</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>next_layer_addon</span><span>.</span><span>configure</span><span>(</span><span>"allow_hosts"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"Updated interceptable YouTube hosts"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>next_layer</span><span>(</span><span>self</span><span>,</span><span> </span><span>nextlayer</span><span>:</span><span> </span><span>layer</span><span>.</span><span>NextLayer</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Allow blocked domains that resolve the blackhole IP to pass through"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>nextlayer</span><span>.</span><span>context</span><span>.</span><span>server</span><span>.</span><span>address </span><span>and</span><span> </span><span>nextlayer</span><span>.</span><span>context</span><span>.</span><span>server</span><span>.</span><span>address</span><span>[</span><span>0</span><span>]</span><span>.</span><span>startswith</span><span>(</span><span>self</span><span>.</span><span>blackhole_ip_prefix</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>nextlayer</span><span>.</span><span>layer</span><span> </span><span>=</span><span> </span><span>layers</span><span>.</span><span>TCPLayer</span><span>(</span><span>nextlayer</span><span>.</span><span>context</span><span>,</span><span> </span><span>ignore</span><span>=</span><span>True</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># noinspection PyMethodMayBeStatic</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>error</span><span>(</span><span>self</span><span>,</span><span> </span><span>flow</span><span>:</span><span> </span><span>http</span><span>.</span><span>HTTPFlow</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""The TLS failed due to an ad-blocker info page with no verified TLS"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>flow</span><span>.</span><span>error </span><span>and</span><span> </span><span>(</span><span>"OpenSSL Error"</span><span> </span><span>in</span><span> </span><span>flow</span><span>.</span><span>error</span><span>.</span><span>msg </span><span>and</span><span> </span><span>"alert internal error"</span><span> </span><span>in</span><span> </span><span>flow</span><span>.</span><span>error</span><span>.</span><span>msg</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>flow</span><span>.</span><span>kill</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>request</span><span>(</span><span>self</span><span>,</span><span> </span><span>flow</span><span>:</span><span> </span><span>http</span><span>.</span><span>HTTPFlow</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>None</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Block ad URLs that pfBlockerNG and Pi-hole cannot detect"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Skip inspecting certain requests</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>flow</span><span>.</span><span>response </span><span>or</span><span> </span><span>flow</span><span>.</span><span>error </span><span>or</span><span> </span><span>(</span><span>flow</span><span>.</span><span>reply </span><span>and</span><span> </span><span>flow</span><span>.</span><span>reply</span><span>.</span><span>state</span><span> </span><span>==</span><span> </span><span>"taken"</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Occasionally skip blocking ads to support content creators</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>self</span><span>.</span><span>in_allowed_ads_window</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>test_url</span><span>:</span><span> </span><span>str</span><span> </span><span>=</span><span> </span><span>flow</span><span>.</span><span>request</span><span>.</span><span>url</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>test_host</span><span>:</span><span> </span><span>str</span><span> </span><span>=</span><span> </span><span>flow</span><span>.</span><span>request</span><span>.</span><span>pretty_host</span><span>.</span><span>lower</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>host</span><span>,</span><span> </span><span>partials </span><span>in</span><span> </span><span>self</span><span>.</span><span>blocked_partials</span><span>.</span><span>items</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>test_host</span><span>.</span><span>endswith</span><span>(</span><span>host</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>partial </span><span>in</span><span> </span><span>partials</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>partial </span><span>in</span><span> </span><span>test_url</span><span>.</span><span>lower</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>msg</span><span> </span><span>=</span><span> </span><span>f</span><span>"✘ [{host} -&gt; {partial}] blocking {trunc(flow.request.pretty_url)}..."</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>info</span><span>(</span><span>msg</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Should be a connection refused error</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>flow</span><span>.</span><span>kill</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>flow</span><span>.</span><span>error</span><span> </span><span>=</span><span> </span><span>KilledError</span><span>(</span><span>msg</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>response</span><span>(</span><span>self</span><span>,</span><span> </span><span>flow</span><span>:</span><span> </span><span>http</span><span>.</span><span>HTTPFlow</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""This is the main workhorse. Intercept JSON and Protobuf responses and modify them</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to remove or denature ad information"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Skip inspecting certain responses</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>not</span><span> </span><span>flow</span><span>.</span><span>response </span><span>or</span><span> </span><span>flow</span><span>.</span><span>error </span><span>or</span><span> </span><span>not</span><span> </span><span>flow</span><span>.</span><span>response</span><span>.</span><span>headers</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"&gt;&gt; {flow.request}\n&lt;&lt; {flow.response}\n\n"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Occasionally skip blocking ads to support content creators</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>self</span><span>.</span><span>in_allowed_ads_window</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>test_path</span><span>:</span><span> </span><span>str</span><span> </span><span>=</span><span> </span><span>flow</span><span>.</span><span>request</span><span>.</span><span>url</span><span>.</span><span>lower</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>test_content_type</span><span>:</span><span> </span><span>str</span><span> </span><span>=</span><span> </span><span>str</span><span>(</span><span>flow</span><span>.</span><span>response</span><span>.</span><span>headers</span><span>.</span><span>get</span><span>(</span><span>"content-type"</span><span>)</span><span>)</span><span>.</span><span>lower</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Examine the Protobuf payload</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>"protobuf"</span><span> </span><span>in</span><span> </span><span>test_content_type</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"Intercepting {trunc(test_path)} Protobuf"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Capture rich Protobuf information to disk for offline analysis</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>DEBUG_MODE</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># TODO: This copying can be avoided, but this is debug mode, so we allow it</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>body</span><span> </span><span>=</span><span> </span><span>bytearray</span><span>(</span><span>flow</span><span>.</span><span>response</span><span>.</span><span>get_content</span><span>(</span><span>strict</span><span>=</span><span>False</span><span>)</span><span> </span><span>or</span><span> </span><span>b</span><span>""</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>lines</span><span> </span><span>=</span><span> </span><span>self</span><span>.</span><span>protobuf_parser</span><span>.</span><span>format_response</span><span>(</span><span>body</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>filename</span><span> </span><span>=</span><span> </span><span>""</span><span>.</span><span>join</span><span>(</span><span>x</span><span> </span><span>for</span><span> </span><span>x</span><span> </span><span>in</span><span> </span><span>test_path</span><span>[</span><span>:</span><span>100</span><span>]</span><span> </span><span>if</span><span> </span><span>(</span><span>x</span><span>.</span><span>isalnum</span><span>(</span><span>)</span><span> </span><span>or</span><span> </span><span>x</span><span> </span><span>in</span><span> </span><span>"._- "</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>filename</span><span> </span><span>=</span><span> </span><span>f</span><span>"protobuf-{filename}-{hashlib.md5(test_path.encode()).hexdigest()}"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>with</span><span> </span><span>open</span><span>(</span><span>f</span><span>"{filename}.formatted"</span><span>,</span><span> </span><span>mode</span><span>=</span><span>"w"</span><span>,</span><span> </span><span>buffering</span><span>=</span><span>True</span><span>)</span><span> </span><span>as</span><span> </span><span>f</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>line </span><span>in</span><span> </span><span>lines</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>f</span><span>.</span><span>write</span><span>(</span><span>f</span><span>"{line}\n"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>with</span><span> </span><span>open</span><span>(</span><span>f</span><span>"{filename}.raw"</span><span>,</span><span> </span><span>mode</span><span>=</span><span>"wb"</span><span>)</span><span> </span><span>as</span><span> </span><span>f</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>f</span><span>.</span><span>write</span><span>(</span><span>flow</span><span>.</span><span>response</span><span>.</span><span>raw_content </span><span>or</span><span> </span><span>b</span><span>""</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>with</span><span> </span><span>open</span><span>(</span><span>f</span><span>"{filename}.decoded"</span><span>,</span><span> </span><span>mode</span><span>=</span><span>"wb"</span><span>)</span><span> </span><span>as</span><span> </span><span>f</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>f</span><span>.</span><span>write</span><span>(</span><span>body </span><span>or</span><span> </span><span>b</span><span>""</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># TODO: Use a memory view or some more efficient search structure</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>body</span><span>:</span><span> </span><span>bytearray</span><span> </span><span>=</span><span> </span><span>bytearray</span><span>(</span><span>flow</span><span>.</span><span>response</span><span>.</span><span>get_content</span><span>(</span><span>strict</span><span>=</span><span>False</span><span>)</span><span> </span><span>or</span><span> </span><span>b</span><span>""</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Find a telltale ad URL, but limit the search</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>distance</span><span> </span><span>=</span><span> </span><span>body</span><span>[</span><span>:</span><span> </span><span>self</span><span>.</span><span>ad_url_search_limit</span><span>]</span><span>.</span><span>find</span><span>(</span><span>self</span><span>.</span><span>ad_url_search_string</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>distance</span><span> </span><span>&lt;</span><span> </span><span>0</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"Found {self.ad_url_search_string} at position {distance}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Search forward for an ad URL signature, then backtrack to find the field tag</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>tag_bytes</span><span> </span><span>=</span><span> </span><span>TagBytes</span><span>(</span><span>self</span><span>.</span><span>target_field_tag</span><span>,</span><span> </span><span>WIRETYPE_LENGTH_DELIMITED</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new_bytes</span><span> </span><span>=</span><span> </span><span>TagBytes</span><span>(</span><span>self</span><span>.</span><span>target_field_tag</span><span> </span><span>-</span><span> </span><span>1</span><span>,</span><span> </span><span>WIRETYPE_LENGTH_DELIMITED</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>target_pos</span><span> </span><span>=</span><span> </span><span>body</span><span>[</span><span>:</span><span> </span><span>distance</span><span> </span><span>-</span><span> </span><span>1</span><span>]</span><span>[</span><span>::</span><span>-</span><span>1</span><span>]</span><span>.</span><span>find</span><span>(</span><span>tag_bytes</span><span>[</span><span>::</span><span>-</span><span>1</span><span>]</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>target_pos</span><span> </span><span>&gt;</span><span> </span><span>0</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>target_pos</span><span> </span><span>=</span><span> </span><span>distance</span><span> </span><span>-</span><span> </span><span>1</span><span> </span><span>-</span><span> </span><span>target_pos</span><span> </span><span>-</span><span> </span><span>len</span><span>(</span><span>tag_bytes</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"Found {self.target_field_tag} at position {target_pos}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>assert</span><span> </span><span>body</span><span>[</span><span>target_pos</span><span>]</span><span> </span><span>==</span><span> </span><span>tag_bytes</span><span>[</span><span>0</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>assert</span><span> </span><span>body</span><span>[</span><span>target_pos</span><span> </span><span>+</span><span> </span><span>1</span><span>]</span><span> </span><span>==</span><span> </span><span>tag_bytes</span><span>[</span><span>1</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>assert</span><span> </span><span>body</span><span>[</span><span>target_pos</span><span> </span><span>+</span><span> </span><span>2</span><span>]</span><span> </span><span>==</span><span> </span><span>tag_bytes</span><span>[</span><span>2</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>ind</span><span>,</span><span> </span><span>b</span><span> </span><span>in</span><span> </span><span>enumerate</span><span>(</span><span>new_bytes</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>body</span><span>[</span><span>target_pos</span><span> </span><span>+</span><span> </span><span>ind</span><span>]</span><span> </span><span>=</span><span> </span><span>b</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""NOTE: There are other field keys in different sections, </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and there may be multiple ad sections to denature. What preceded</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is a PoC of the technique that already blocks 90% of ads."""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Example Protobuf path:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"4 {"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;49399797 {"</span><span>&nbsp;&nbsp;</span><span># Damage this key</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;&nbsp;&nbsp;1 {"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ... /pagead/"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Example Protobuf path</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 {"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;50195462 {"</span><span>&nbsp;&nbsp;</span><span># Damage this key</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 {"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;153515154 {"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ... /pagead/"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Put the contents back in the response body</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>flow</span><span>.</span><span>response</span><span>.</span><span>set_content</span><span>(</span><span>bytes</span><span>(</span><span>body</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>except</span><span> </span><span>Exception</span><span> </span><span>as</span><span> </span><span>e</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_</span><span>,</span><span> </span><span>_</span><span>,</span><span> </span><span>exc_traceback</span><span> </span><span>=</span><span> </span><span>sys</span><span>.</span><span>exc_info</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>traceback_</span><span> </span><span>=</span><span> </span><span>traceback</span><span>.</span><span>format_tb</span><span>(</span><span>exc_traceback</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>alert</span><span>(</span><span>f</span><span>"{e!r}, {traceback_}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>elif</span><span> </span><span>"json"</span><span> </span><span>in</span><span> </span><span>test_content_type</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"Intercepting {trunc(test_path)} JSON"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Examine the JSON payload</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>obj</span><span> </span><span>=</span><span> </span><span>flow</span><span>.</span><span>response</span><span>.</span><span>json</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>replacement </span><span>in</span><span> </span><span>self</span><span>.</span><span>json_replacements</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>replacement</span><span>.</span><span>update</span><span>(</span><span>obj</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>flow</span><span>.</span><span>response</span><span>.</span><span>set_content</span><span>(</span><span>json</span><span>.</span><span>dumps</span><span>(</span><span>obj</span><span>,</span><span> </span><span>ensure_ascii</span><span>=</span><span>False</span><span>)</span><span>.</span><span>encode</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>except</span><span> </span><span>(</span><span>TypeError</span><span>,</span><span> </span><span>JSONDecodeError</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>pass</span><span>&nbsp;&nbsp;</span><span># Do not stop the show</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>except</span><span> </span><span>Exception</span><span> </span><span>as</span><span> </span><span>e</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_</span><span>,</span><span> </span><span>_</span><span>,</span><span> </span><span>exc_traceback</span><span> </span><span>=</span><span> </span><span>sys</span><span>.</span><span>exc_info</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>traceback_</span><span> </span><span>=</span><span> </span><span>traceback</span><span>.</span><span>format_tb</span><span>(</span><span>exc_traceback</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>alert</span><span>(</span><span>f</span><span>"{e!r}, {traceback_}"</span><span>)</span></p><p><span># Register the addon</span></p><p><span>addons</span><span> </span><span>=</span><span> </span><span>[</span><span>YouTubeAdBlocker</span><span>(</span><span>)</span><span>]</span></p></div></td></tr></tbody></table></div><p>This script happens to work in Python for a TLS-decrypting man-in-the-middle proxy written in Python. As a working proof-of-concept, it’s pretty rad. Of course, it can be rewritten in Rust or Go or anything but single-threaded Python, but as an intellectual exercise to defeat ads that are served from the same domain as content, it’s elegant.</p><p><a href="#top">Top ↩</a></p><hr><h2>YouTube Premium</h2><p>It’s unknown if CAD <del>$9.99/mo</del> $11.99/mo ($13.43/mo with tax) is even reasonable: Do I personally incur CAD $11.99 of cost to advertisers each month?</p><figure id="attachment_5906"><a href="https://static.ericdraken.com/files/youtube-advertising-cost.png"><img src="https://ericdraken.com/files/youtube-advertising-cost-754x282.png" alt="How much does YouTube advertising cost?" width="754" height="282" srcset="https://ericdraken.com/files/youtube-advertising-cost-754x282.png 754w, https://ericdraken.com/files/youtube-advertising-cost-300x112.png 300w, https://ericdraken.com/files/youtube-advertising-cost-600x225.png 600w, https://static.ericdraken.com/files/youtube-advertising-cost.png 785w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/youtube-advertising-cost-754x282.png" data-srcset="https://ericdraken.com/files/youtube-advertising-cost-754x282.png 754w, https://ericdraken.com/files/youtube-advertising-cost-300x112.png 300w, https://ericdraken.com/files/youtube-advertising-cost-600x225.png 600w, https://static.ericdraken.com/files/youtube-advertising-cost.png 785w"></a><figcaption><a href="https://www.webfx.com/social-media/pricing/how-much-does-youtube-advertising-cost/" target="_blank" rel="nofollow">Source</a></figcaption></figure><p>Since ads are auctioned, the CPV (cost-per-view) varies. Also, many ad campaigns have a capped daily budget, so theoretically there should be fewer ads in the evenings as budgets run out during the day.</p><h3>Experiment in Ad Viewing</h3><p>I watched YouTube on and off for a day on a clean notebook computer with private browsing. My history showed that I only “watched” 10 videos:</p><ul><li>I fast-forwarded through a few of them to get past the “like and subscribe” runtime padding.</li><li>I jumped to the end of one just to get to the “top three” from a “top twenty” list.</li><li>Two were low quality so I left early.</li><li>The rest were music videos.</li></ul><p>In all, for watching parts of 10 videos, I was exposed to 8 ads, and only two were skippable (which I skipped).</p><h3>$0.15 as a Ballpark CPV</h3><p>Let’s use USD $0.15 as a CPV. In one day, let’s say, I incurred 8 x $0.15, or $1.20 to advertisers. Extrapolated to one month, that is roughly USD $36/mo. Do I really cost advertisers USD $36/mo for very casual YouTube viewing? That sounds terrible for advertisers.</p><h3>CPV from US Advertising Spend Divided by Total Views</h3><p>From <a href="https://www.statista.com/statistics/289658/youtube-global-net-advertising-revenues/" target="_blank" rel="nofollow">Statistica</a>, in 2019, US YouTube advertisers spent $15.1 billion dollars. Also in 2019, US residents had 916 billion views (<a href="#ad-spend">ref</a>). That works out to an average of $15.1B / 916B, or USD $0.0165 per view. Then for me, that is only USD 13 cents. Extrapolated to one month, I theoreticaly cost advertisers only USD $3.96/mo.</p><h3>Is YouTube Premium Worth It?</h3><p><a href="https://static.ericdraken.com/files/YouTube-Premium.png"><img src="https://static.ericdraken.com/files/YouTube-Premium-754x324.png" alt="YouTube Premium subscription fee as of Jan, 2022" width="754" height="324" srcset="https://static.ericdraken.com/files/YouTube-Premium-754x324.png 754w, https://static.ericdraken.com/files/YouTube-Premium-300x129.png 300w, https://ericdraken.com/files/YouTube-Premium-600x258.png 600w, https://static.ericdraken.com/files/YouTube-Premium.png 807w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/YouTube-Premium-754x324.png" data-srcset="https://static.ericdraken.com/files/YouTube-Premium-754x324.png 754w, https://static.ericdraken.com/files/YouTube-Premium-300x129.png 300w, https://ericdraken.com/files/YouTube-Premium-600x258.png 600w, https://static.ericdraken.com/files/YouTube-Premium.png 807w"></a></p><p>When I allowed ads for my experiment, I hit the hardware mute button. I also looked away because I have several computers with a lot going on. Ad spend is wasted on me, but I still want to support content creators. For me, CAD $13.48/mo is more than I incur on actual ads and more than I pay for a Netflix subscription. The only way to justify the cost is to have YouTube playing constantly in the background on a TV.</p><p>However, I truly enjoy a handful of creators, so I may start watching them in the background on non-stop play. Let’s give the three-month YouTube Premium trial a chance, and I will still be monitoring what they track about me.</p><figure id="attachment_5913"><a href="https://static.ericdraken.com/files/youtube-premium-traffic.png"><img src="https://ericdraken.com/files/youtube-premium-traffic-754x282.png" alt="YouTube Premium network traffic" width="754" height="282" srcset="https://ericdraken.com/files/youtube-premium-traffic-754x282.png 754w, https://static.ericdraken.com/files/youtube-premium-traffic-300x112.png 300w, https://ericdraken.com/files/youtube-premium-traffic-600x224.png 600w, https://static.ericdraken.com/files/youtube-premium-traffic.png 1503w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/youtube-premium-traffic-754x282.png" data-srcset="https://ericdraken.com/files/youtube-premium-traffic-754x282.png 754w, https://static.ericdraken.com/files/youtube-premium-traffic-300x112.png 300w, https://ericdraken.com/files/youtube-premium-traffic-600x224.png 600w, https://static.ericdraken.com/files/youtube-premium-traffic.png 1503w"></a><figcaption>YouTube Premium network traffic</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>DMCA, Sony, Viacom</h2><p>Recently I learned that due to abuses of the <a href="https://en.wikipedia.org/wiki/Digital_Millennium_Copyright_Act" target="_blank" rel="nofollow">DMCA Act of 1998</a>, YouTube content creators who make reaction videos and “easter egg” videos may have their videos claimed by big companies like Sony and Viacom. That means that from when a claim is made, all ad revenue goes to those big companies, and not even to the creators. That means in all likelihood I unknowingly may not even be supporting my favourite YouTube creators.</p><div><p><strong>Did you know?</strong> Many fair-use and video-game-commentary videos may have automated copyright claims against them, meaning that ad revenue goes to big companies with deep legal pockets and your favourite creators may get nothing, so more and more creators leave YouTube for Twitch.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Summary of Accomplishments</h2><p>I rarely give up, so this is an example of going into an extreme problem-solving mode to solve a fun problem loosely using cryptography and reverse engineering. In the end, a single byte turned it all around, so it was all worth it to come to an elegant and satisfying solution.</p><div><p><strong>Success:</strong> We were able to set up a hardware router from scratch, segment LANs into trusted and untrusted zones, set up traditional DNS adblocking, add a transparent MITM proxy, and ultimately block YouTube ads on networked Apple devices.</p><p>Note: This was a hard problem – now solved – so I am paying for YouTube Premium to give the CPU a rest.</p></div><p><a href="#top">Top ↩</a></p><hr> <hr><span itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemscope="" itemprop="mainEntityOfPage" itemtype="https://schema.org/WebPage" itemid="https://google.com/article"><meta itemprop="headline" content="Block YouTube Ads on AppleTV by Decrypting and Stripping Ads from Profobuf"><meta itemprop="articleBody" content="Apple TV and iPhone YouTube ads are not blocked by DNS adblockers (e.g. Pi-hole), so I heavily researched this and discovered a flaw in Protobuf that allows me to restrict YouTube ads on Apple TV and iOS by simply changing one byte in the Protobuf responses after decrypting HTTPS network traffic."><meta itemprop="description" content="Apple TV and iPhone YouTube ads are not blocked by DNS adblockers (e.g. Pi-hole), so I heavily researched this and discovered a flaw in Protobuf that allows me to restrict YouTube ads on Apple TV and iOS by simply changing one byte in the Protobuf responses after decrypting HTTPS network traffic."><span itemprop="image" itemscope="" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://ericdraken.com/files/pfsense-featured.png"><meta itemprop="width" content="150"><meta itemprop="height" content="50"></span><meta itemprop="datePublished" content="2022-01-6"><meta itemprop="dateModified" content="2022-06-9"><span itemprop="publisher" itemscope="" itemtype="https://schema.org/Organization"><span itemprop="logo" itemscope="" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://secure.gravatar.com/avatar/1b8450e7611d06cec2a2c3a6dcfc1b30?s=96&amp;d=mm&amp;r=g"><meta itemprop="width" content="32"><meta itemprop="height" content="32"></span><meta itemprop="name" content="Eric"></span></span></article></main></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Rhombus Language (172 pts)]]></title>
            <link>https://rhombus-lang.org</link>
            <guid>43394881</guid>
            <pubDate>Tue, 18 Mar 2025 01:37:19 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://rhombus-lang.org">https://rhombus-lang.org</a>, See on <a href="https://news.ycombinator.com/item?id=43394881">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><div><pre>
 
<a href="https://docs.racket-lang.org/rhombus-reference/class.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._class._rhombus/defn))">class</a> Rect<span>(</span>left, top, right, bottom<span>)</span>
                     
<a href="https://docs.racket-lang.org/rhombus-reference/ref-function.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._fun._rhombus/defn))">fun</a> area<span>(</span>r<span>)</span>:
  <a href="https://docs.racket-lang.org/rhombus-reference/Definitions.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._let._rhombus/defn))">let</a> w <a href="https://docs.racket-lang.org/rhombus-reference/Equality.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._~3d))">=</a> r<a href="https://docs.racket-lang.org/rhombus-reference/Dot.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._..))">.</a>right <a href="https://docs.racket-lang.org/rhombus-reference/Numbers.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._-))">-</a> r<a href="https://docs.racket-lang.org/rhombus-reference/Dot.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._..))">.</a>left
  <a href="https://docs.racket-lang.org/rhombus-reference/Definitions.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._let._rhombus/defn))">let</a> h <a href="https://docs.racket-lang.org/rhombus-reference/Equality.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._~3d))">=</a> r<a href="https://docs.racket-lang.org/rhombus-reference/Dot.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._..))">.</a>bottom <a href="https://docs.racket-lang.org/rhombus-reference/Numbers.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._-))">-</a> r<a href="https://docs.racket-lang.org/rhombus-reference/Dot.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._..))">.</a>top
  w<a href="https://docs.racket-lang.org/rhombus-reference/Numbers.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._*))">*</a>h
                                
area<span>(</span>Rect<span>(</span><span>0</span>, <span>0</span>, <span>10</span>, <span>5</span><span>)</span><span>)</span>

</pre></div>
<div><pre>
 
<a href="https://docs.racket-lang.org/rhombus-reference/class.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._class._rhombus/defn))">class</a> Rect<span>(</span>left, top, right, bottom<span>)</span>
                     
<a href="https://docs.racket-lang.org/rhombus-reference/ref-function.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._fun._rhombus/defn))">fun</a> rect_like_to_rect<span>(</span>v<span>)</span>:
  <a href="https://docs.racket-lang.org/rhombus-reference/Matching.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._match))">match</a> v
  | Rect<span>(</span><a href="https://docs.racket-lang.org/rhombus-reference/Matching.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core).__._rhombus/bind))">_</a>, <a href="https://docs.racket-lang.org/rhombus-reference/Matching.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core).__._rhombus/bind))">_</a>, <a href="https://docs.racket-lang.org/rhombus-reference/Matching.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core).__._rhombus/bind))">_</a>, <a href="https://docs.racket-lang.org/rhombus-reference/Matching.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core).__._rhombus/bind))">_</a><span>)</span>: v
  | <span>{</span><span>"LT"</span>: <span>[</span>l, t<span>]</span>, <span>"RB"</span>: <span>[</span>r, b<span>]</span><span>}</span>: Rect<span>(</span>l, t, r, b<span>)</span>
  | <span>{</span><span>"TL"</span>: <span>[</span>t, l<span>]</span>, <span>"RB"</span>: <span>[</span>b, r<span>]</span><span>}</span>: Rect<span>(</span>l, t, r, b<span>)</span>
                                
rect_like_to_rect<span>(</span><span>{</span><span>"TL"</span>: <span>[</span><span>0</span>, <span>2</span><span>]</span>, <span>"RB"</span>: <span>[</span><span>10</span>, <span>5</span><span>]</span><span>}</span><span>)</span>

rect_like_to_rect<span>(</span><span>{</span><span>"LT"</span>: <span>[</span><span>0</span>, <span>2</span><span>]</span>, <span>"RB"</span>: <span>[</span><span>10</span>, <span>5</span><span>]</span><span>}</span><span>)</span>

</pre></div>

<div><pre>
                     
<a href="https://docs.racket-lang.org/rhombus-reference/ref-function.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._fun._rhombus/defn))">fun</a> all_same<span>(</span><span>[</span>str0, str, <a href="https://docs.racket-lang.org/rhombus-reference/Repetitions.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._......._rhombus/bind))">...</a><span>]</span><span>)</span>:
  <a href="https://docs.racket-lang.org/rhombus-reference/Booleans.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._all))">all</a><span>(</span>str0 <a href="https://docs.racket-lang.org/rhombus-reference/Equality.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._~3d~3d))">==</a> str, <a href="https://docs.racket-lang.org/rhombus-reference/Repetitions.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._......))">...</a><span>)</span>
 
all_same<span>(</span><span>[</span><span>"hello"</span>, <span>"hello"</span>, <span>"hello"</span><span>]</span><span>)</span>

all_same<span>(</span><span>[</span><span>"hello"</span>, <span>"goodbye"</span>, <span>"hello"</span><span>]</span><span>)</span>

</pre></div>
<div><pre>
 
<a href="https://docs.racket-lang.org/rhombus-reference/class.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._class._rhombus/defn))">class</a> Posn<span>(</span>x, y<span>)</span>
 
<a href="https://docs.racket-lang.org/rhombus-reference/ref-function.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._fun._rhombus/defn))">fun</a> flip_all<span>(</span><span>[</span>Posn<span>(</span>x, y<span>)</span>, <a href="https://docs.racket-lang.org/rhombus-reference/Repetitions.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._......._rhombus/bind))">...</a><span>]</span><span>)</span>:
  <span>[</span>Posn<span>(</span>y, x<span>)</span>, <a href="https://docs.racket-lang.org/rhombus-reference/Repetitions.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._......))">...</a><span>]</span>
 
flip_all<span>(</span><span>[</span>Posn<span>(</span><span>1</span>, <span>2</span><span>)</span>, Posn<span>(</span><span>3</span>, <span>4</span><span>)</span><span>]</span><span>)</span>

flip_all<span>(</span><span>[</span>Posn<span>(</span><span>5</span>, <span>6</span><span>)</span><span>]</span><span>)</span>

</pre></div>
<div><pre>
 
<a href="https://docs.racket-lang.org/rhombus-reference/class.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._class._rhombus/defn))">class</a> Tree<span>(</span>val, children <a href="https://docs.racket-lang.org/rhombus-reference/Annotations.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._~3a~3a._rhombus/bind))">::</a> <a href="https://docs.racket-lang.org/rhombus-reference/Lists.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._.List._(.List..of._rhombus/annot)))">List.of</a><span>(</span>Tree<span>)</span><span>)</span>:
  <a href="https://docs.racket-lang.org/rhombus-reference/class.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._method._rhombus/class_clause))">method</a> flatten<span>(</span><span>)</span>: 
    <a href="https://docs.racket-lang.org/rhombus-reference/Iteration.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._for))">for</a> <a href="https://docs.racket-lang.org/rhombus-reference/Multiple_Values.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._fold._rhombus/reducer))">fold</a><span>(</span>lst = <span>[</span>val<span>]</span><span>)</span> <span>(</span>child <a href="https://docs.racket-lang.org/rhombus-reference/Membership_Tests.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._in))">in</a> children<span>)</span>:
      
      lst <a href="https://docs.racket-lang.org/rhombus-reference/Appendables.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._++))">++</a> child<a href="https://docs.racket-lang.org/rhombus-reference/Dot.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._..))">.</a>flatten<span>(</span><span>)</span>
 
Tree<span>(</span><span>1</span>, <span>[</span>Tree<span>(</span><span>2</span>, <span>[</span>Tree<span>(</span><span>4</span>, <span>[</span><span>]</span><span>)</span><span>]</span><span>)</span>,
         Tree<span>(</span><span>3</span>, <span>[</span>Tree<span>(</span><span>5</span>, <span>[</span><span>]</span><span>)</span><span>]</span><span>)</span><span>]</span><span>)</span>
  <a href="https://docs.racket-lang.org/rhombus-reference/Dot.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._..))">.</a>flatten<span>(</span><span>)</span> 
</pre></div>


<div><pre>
 
<a href="https://docs.racket-lang.org/rhombus-reference/class.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._class._rhombus/defn))">class</a> Rect<span>(</span>left, top, right, bottom<span>)</span>
 
<a href="https://docs.racket-lang.org/rhombus-meta/Binding_Macros.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core-meta)._bind._(bind..macro._rhombus/defn)))">bind.macro</a> <span>'</span>OriginRect<span>(</span><a href="https://docs.racket-lang.org/rhombus-reference/stxobj.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._~24))">$</a>right, <a href="https://docs.racket-lang.org/rhombus-reference/stxobj.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._~24))">$</a>bottom<span>)</span><span>'</span>:
  <span>'</span>Rect<span>(</span><span>0</span>, <span>0</span>, <a href="https://docs.racket-lang.org/rhombus-reference/stxobj.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._~24))">$</a>right, <a href="https://docs.racket-lang.org/rhombus-reference/stxobj.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._~24))">$</a>bottom<span>)</span><span>'</span>
 
<a href="https://docs.racket-lang.org/rhombus-reference/ref-function.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._fun._rhombus/defn))">fun</a> area<span>(</span>r<span>)</span>:
  <a href="https://docs.racket-lang.org/rhombus-reference/Matching.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._match))">match</a> r
  | OriginRect<span>(</span>r, b<span>)</span>: r<a href="https://docs.racket-lang.org/rhombus-reference/Numbers.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._*))">*</a>b
  | Rect<span>(</span>l, t, r, b<span>)</span>: <span>(</span>r<a href="https://docs.racket-lang.org/rhombus-reference/Numbers.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._-))">-</a>l<span>)</span><a href="https://docs.racket-lang.org/rhombus-reference/Numbers.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._*))">*</a><span>(</span>b<a href="https://docs.racket-lang.org/rhombus-reference/Numbers.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._-))">-</a>t<span>)</span>
                      
area<span>(</span>Rect<span>(</span><span>0</span>, <span>0</span>, <span>10</span>, <span>5</span><span>)</span><span>)</span>

</pre></div>
</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[But how to get to that European cloud? (101 pts)]]></title>
            <link>https://berthub.eu/articles/posts/now-how-to-get-that-european-cloud/</link>
            <guid>43394087</guid>
            <pubDate>Mon, 17 Mar 2025 23:52:34 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://berthub.eu/articles/posts/now-how-to-get-that-european-cloud/">https://berthub.eu/articles/posts/now-how-to-get-that-european-cloud/</a>, See on <a href="https://news.ycombinator.com/item?id=43394087">Hacker News</a></p>
<div id="readability-page-1" class="page"><article>
  

  
  

  <div>
  <p>The very short version: It has now become clear that <a href="https://berthub.eu/articles/posts/you-can-no-longer-base-your-government-and-society-on-us-clouds/">European governments can no longer rely on American clouds</a>, and that we lack good and comprehensive alternatives. Market forces have <a href="https://berthub.eu/articles/posts/the-european-cloud-ladder/">failed to deliver a truly European cloud</a>, and businesses won’t naturally buy as yet unproven cloud services, even when adorned with a beautiful European 🇪🇺 flag, so for now nothing will happen.</p>
<p>This means it’s time for <em>industrial policy</em>, which requires politics to be proficient in “industry.” Such proficiency is the only way to develop policies and plans that don’t go off the rails (which, unfortunately, can happen in many ways).</p>
<p>With a coherent strategy (see below for a suggestion), governments and industry can rapidly improve the cloud situation, allowing Europe to once more manage its own services <a href="https://berthub.eu/articles/posts/communicating-without-musk-and-trump-cloud-kootwijk/">without American prying eyes</a> and without fearing the <a href="https://berthub.eu/articles/posts/servers-in-de-eu-eigen-sleutels-helpt-het/#wat-als-er-ruzie-is">consequences of sanctions &amp; transatlantic disputes</a>.</p>
<p>That concludes the short version.</p>
<blockquote>
<p>This page originates from a productive discussion on <a href="https://www.bnr.nl/podcast/de-technoloog/10568644/we-bouwen-ons-eigen-cloudbedrijf-in-tijden-van-trump">the BNR podcast <em>De Technoloog</em></a>, along with conversations with <a href="https://berthub.eu/articles/posts/digitale-soevereiniteit-rijksoverheid-13-februari-2025/">members of parliaments</a>, civil servants, and entrepreneurs. It is also written with knowledge of <a href="https://berthub.eu/articles/EuroStack_Initiative_Letter_14_March.pdf">this new letter about the EuroStack to the European Commission</a> (<a href="https://www.linkedin.com/posts/euro-stack_european-industry-support-for-eurostack-vision-activity-7307279544082706432-DTti?utm_source=share&amp;utm_medium=member_desktop&amp;rcm=ACoAAAAQ2LUB1m6uzl_IBhQqGcdDlgLy03aa7MU">LinkedIn post</a>).</p>
</blockquote>
<p>In the article <a href="https://berthub.eu/articles/posts/the-european-cloud-ladder/">“The (European) cloud ladder: from virtual server to MS 365”</a>, I outline what is and isn’t available in Europe. There are already plenty of components, at a sufficient scale, to build upon. We can start improving parts of the cloud almost immediately, and eventually develop something with capabilities comparable to AWS, Google, and Microsoft Azure. But it will take a decade of hard work.</p>
<p>Europe and the EU have overcome massive challenges before.</p>
<p>For example, at one point, it was unthinkable that we could operate without the American GPS system. Today, <em>every phone and every smartwatch</em> also uses the EU Galileo satellite system, and Galileo is now the best satellite navigation system in the world. It only cost €15 billion!</p>
<p>Similarly, we once had many separate aerospace and defense companies, but after more than 10 years of mergers and restructuring, <a href="https://en.wikipedia.org/wiki/History_of_Airbus">we got Airbus</a>, which now makes the best large aircraft in the world. That was once unimaginable too.</p>
<p>By now, almost everyone agrees that we need to <a href="https://berthub.eu/articles/posts/you-can-no-longer-base-your-government-and-society-on-us-clouds/">do something similar for “the cloud”—and take it even further: we also need European solutions for workplaces, word processors, and other office applications</a>.</p>
<p>Massive sums of money are already being discussed—tens to hundreds of billions of euros—so funding will be available one way or another. If we can <a href="https://ec.europa.eu/commission/presscorner/detail/sv/statement_25_673">spend €800 billion on defense</a>, we can do something for the cloud as well.</p>
<p>It’s also worth noting that Europe is full of technical talent, including the people who built much of the technology powering the major American cloud providers. The only issue? Much of that European talent is employed by American companies or working on open-source projects as a hobby in their attic (🙋‍♂️).</p>
<p>The question is: how do we combine talent and funding to create a better European cloud? Because <a href="https://berthub.eu/articles/posts/europe-must-invest-in-xyz/">we need to do more than just declare that Europe should invest in things</a>.</p>
<h2 id="governments--contracts">Governments &amp; Contracts</h2>
<p>Roughly speaking, governments <em>produce</em> almost nothing themselves—except for policy, and even that is sometimes outsourced (to lobbyists or consultants).</p>
<p>However, governments do commission vast amounts of roads, bridges, and other infrastructure projects. That’s already complex enough, but at least you have a fairly clear idea of what you want in advance, and there’s an industry that routinely delivers these kinds of projects.</p>
<p>Things get trickier with more complex projects full of surprises, such as <a href="https://nos.nl/artikel/2555536-verbouwing-binnenhof-duurt-weer-langer-2028-is-niet-haalbaar">the renovation of Dutch parliamentary estate het Binnenhof</a>. Sometimes, these projects spiral completely out of control. The most recent examples come from Germany, such as <a href="https://en.wikipedia.org/wiki/Berlin_Brandenburg_Airport#Construction_progress_and_issues">Berlin’s airport</a> or the <a href="https://de.wikipedia.org/wiki/Stuttgart_21">new Stuttgart train station</a>.</p>
<p>But all of this pales in comparison to the challenge of launching a new IT project. And this isn’t just a government problem—even if you know <em>exactly</em> what you want, <a href="https://en.wikipedia.org/wiki/Agile_software_development">the IT world has more or less given up</a>.
<em>“We can tell you what it will cost, when it will be finished, or what it will do. Pick at most two.”</em> Or, honestly, just one.</p>
<p>In practice, it often turns out that the project’s goals, purpose, or target audience are unclear, making everything even harder. In the Netherlands, the <a href="https://www.adviescollegeicttoetsing.nl/">Advisory Board for IT Assessment</a> is doing excellent work with research and recommendations—but their findings are almost always painful to read.</p>
<p>It would be fantastic if governments took a more hands-on approach to creating successful IT solutions again, but there’s a long way to go before they can regain the capability to do things in-house. Still, I’d be excited about that prospect.</p>
<h2 id="ordering-a-cloud">Ordering a Cloud</h2>
<p>The market hasn’t provided a solution, so governments must now figure out how to foster the creation of a functional cloud. As mentioned earlier, this problem can actually be broken down into smaller, manageable pieces—<a href="https://berthub.eu/articles/posts/taking-the-airbus-to-the-ikea-cloud/">we don’t need to build an entire Airbus or IKEA right away</a>.</p>
<p>For politicians and decision-makers, it’s tempting to see this as another Galileo: allocate €15 billion, and a consortium will build a cloud. The big political decision, then, is simply to fund it, which is doable in politics (for example, for “<a href="https://digital-strategy.ec.europa.eu/en/policies/ai-factories">AI factories</a>”).</p>
<p>But this approach won’t work because, unlike Galileo, there is no industry ready to deliver such a project (even though some companies like to pretend there is). And crucially, Galileo had a crystal-clear objective:  1) Deliver exactly what GPS offers. 2) Build on top of that with further innovation.</p>
<p>What we need across <a href="https://berthub.eu/articles/posts/the-european-cloud-ladder/">different layers of the cloud</a> is largely not <em>off the shelf</em>. It’s not just about servers and hardware—it requires <em>development</em>.</p>
<center>
<p><img loading="lazy" src="https://berthub.eu/articles/UI_Desgin.png"><br>
What you get if you ask an enterprise IT company to build you something. Source: <a href="https://www.spyvee.com/apple-ui-vs-google-ui-vs-your-companys-ui/">Eric Burke via spyvee.com</a></p>

</center>
<h2 id="learning-from-past-experiences">Learning from Past Experiences</h2>
<p>There are some lessons to be learned here. To develop Galileo, the EU was able to lean heavily on the European Space Agency (ESA). ESA has extensive experience in commissioning satellites and designing and testing massive projects. It costs a pretty penny, but the results are solid. Take, for example, the <a href="https://www.arianespace.com/news/ariane-6-performs-first-commercial-flight-with-successful-launch-of-cso-3-satellite/">Ariane 6 rocket</a>, which performed well in its first two launches <a href="https://www.youtube.com/watch?v=bvim4rsNHkQ">instead of exploding 17 times</a> before getting it right (though that approach can also work—it does accelerate innovation).</p>
<p>However, we don’t have a “Cloud ESA,” though we sometimes hope that <a href="https://www.tno.nl/nl/digitaal/data-sharing/gaia-europees-initiatief-digitale/">an organization like TNO could fill that role</a>.</p>
<blockquote>
<p>A persistent misconception is that you need to put tens of billions on the table upfront before you can “build a cloud.” That’s not true, you can start with much less and still create credible services. But an even bigger misconception: just because you spend billions doesn’t mean you’ll actually end up with something useful! In many cases, the money might just get <a href="https://berthub.eu/articles/posts/gaia-x-is-an-expensive-distraction/">burned up in endless meetings</a>.</p>
</blockquote>
<h2 id="what-about-subsidies">What About Subsidies?</h2>
<p>Another option is to make funding available through subsidies, which can work well for certain objectives. For example, subsidies have been highly effective in promoting home insulation and have helped the Netherlands become the world leader in solar panels per capita. Due to a policy oversight, the Netherlands has now installed the equivalent of nearly <a href="https://berthub.eu/articles/posts/the-gigantic-unregulated-power-plants-in-the-cloud/">50 nuclear power plants worth of solar panels</a>. This is a massive impact.</p>
<p>Europe has extensive experience in distributing R&amp;D subsidies. The <strong>massive</strong> Horizon Europe program allocates around <a href="https://en.wikipedia.org/wiki/Horizon_Europe">€15 billion per year</a> for this purpose. I’ve personally been a Horizon Europe reviewer for the European Commission, and I hate to say it, but this system is terrible for real innovation. You need to submit a highly detailed plan outlining exactly what you’re going to do, and deviating from that plan is an absolute bureaucratic nightmare. No true innovative entrepreneur wants to deal with this.</p>
<p>The ones who <em>do</em> want to deal with it are slow-moving consortia, staffed with entire floors of people who love defining and checking “work packages” full of “milestones.” These milestones get met, everyone is happy, the money is spent, and you end up with <em>something</em>. But chances are, it won’t actually solve the problem you set out to address. Some of the <a href="https://www.rvo.nl/subsidies-financiering/ipcei/cloud-infrastructuur-en-services-cis">IPCEI-CIS initiatives in the Netherlands</a> may also fall into this trap—though I sincerely hope they succeed.</p>
<p>And this brings us to a crucial point: if we want to build an innovative and modern cloud here, it <em>cannot</em> happen without <em>enthusiastic</em> programmers, developers, and entrepreneurs. <strong>There is no other way.</strong> And rigid, bureaucratic subsidies will never generate that enthusiasm.</p>
<blockquote>
<p>My former company, PowerDNS, went through a failed subsidy program in the early 2000s. It was a traumatic experience—being treated as a potential fraudster while trying to do your best. We barely made it out unscathed. It’s something you never forget.</p>
</blockquote>
<h2 id="smart-procurement">Smart Procurement?</h2>
<p>One major problem is that businesses and governments are <em>very</em> clear about <strong>not wanting to deal with new things</strong>. The <a href="https://www.bankinfosecurity.com/eu-commission-microsoft-appeal-edps-office-365-decision-a-25327">European Commission, for example, is currently in a ridiculous legal battle against its own privacy watchdog</a> just to keep using Microsoft 365. Or take the Dutch Ministry of the Interior, which shares the IP addresses of all its secret service job applicants with Google <a href="https://berthub.eu/tkconv/document.html?nummer=2025D07118">because it’s supposedly tens of thousands of euros per year cheaper than European alternatives</a>. These are strong signals.</p>
<p>Now, every entrepreneur knows that you have to develop products <a href="https://hbr.org/2011/08/henry-ford-never-said-the-fast">that customers don’t yet realize they need</a>. But you should at least be able to reasonably predict that they <em>will</em> need them in the future and they need to be open to trying something new.</p>
<p>And here’s a direct quote from the Dutch Ministry of Economic Affairs’ policy (<a href="https://berthub.eu/tkconv/document.html?nummer=2025D10933">as stated by the State Secretary of the Interior</a>):</p>
<blockquote>
<p>“There are no possibilities to award government contracts exclusively to European and/or Dutch companies. This is legally impossible due to obligations arising from the <a href="https://www.wto.org/english/tratop_e/gproc_e/gp_gpa_e.htm">(WTO) Government Procurement Agreement</a> and our trade agreements.”</p>
</blockquote>
<p>Well, that’s it then. If this is the stance, then European industry is given <em>zero</em> pathway to success. <em>“We’ll only buy from you once your products are the absolute best, according to our procurement standards.”</em> But during the early years of development, your products will <em>inevitably</em> have rough edges and won’t yet do <em>everything</em>. And they will certainly be more expensive, because we don’t allow European companies to get away with selling our data—<a href="https://mastodon.nl/@bert_hubert/114074678596980744">but somehow, American companies can</a>.</p>
<p>I actually doubt whether the minister is correct about this “Government Procurement Agreement.” It would have to be the United States that sues us at the WTO, and the U.S. itself no longer believes in the WTO. In fact, almost no one does anymore.</p>
<p>Despite all this, <em>smart procurement</em> could play a huge role. Governments are the largest purchasers of IT services across Europe. If done wisely, this could effectively signal to the market, entrepreneurs, and developers that their products are in demand. And the scale of government IT is so vast that there are plenty of projects where a (small) risk could be taken—projects that aren’t mission-critical 24/7 and aren’t overly complex.</p>
<p>It’s also possible to <em>procure solutions</em> for specific <em>gaps</em> in European digital services through targeted tenders, such as <a href="https://www.rvo.nl/onderwerpen/innovation-impact-challenge">this innovation challenge</a>:</p>
<ul>
<li><strong>Email is dominated globally by “free” services</strong> (Gmail, Outlook.com). These services are ultimately paid for by selling <em>us</em>. While paid email services exist in Europe, we now know that competing with “free” is nearly impossible. So, build a “Eumail” platform that provides free email to everyone. This probably should not need to be government-run, but the platform could be <em>commissioned</em> and funded to deliver top-tier services. Doing this properly might cost €100 million per year, but imagine the impact!</li>
<li><strong>A European anti-DDoS shield.</strong> This market is currently dominated by a small number of U.S. companies, which means they have visibility into our internet traffic. Some of these companies (like Cloudflare) even offer free services, leading to the same issue as above. <a href="https://www.nbip.nl/en/nawas/">We already have a great non-profit initiative</a>, but it could be expanded significantly.</li>
<li><strong>European governments currently broadcast press conferences via YouTube.</strong> It’s high time for a reliable, user-friendly “Eutube,” so that crucial public information doesn’t get sandwiched between conspiracy theorists. This is becoming an existential issue.</li>
<li><strong>All major web browsers are American, and largely controlled by Google.</strong> Firefox has a much bigger market share than most people realize (especially now that Chrome and Edge are blocking ad blockers). But Firefox, despite being open source, is <em>mostly funded by Google</em>! A great move would be to take over that funding and finance “fEUerfox” for 10 years, ensuring a browsing experience that doesn’t route everything through the U.S.</li>
<li><strong>The open-source ecosystem now largely depends on Microsoft GitHub,</strong> which is heavily AI-focused. And, once again, <em>free</em>. There is a <a href="https://en.wikipedia.org/wiki/Codeberg">European alternative</a>, but since it doesn’t monetize user data, it has limited resources and lacks many features. This could be funded for a <em>trivial</em> amount of money.</li>
<li><strong>Local media now rely overwhelmingly on Facebook (!!) for publishing and engaging with readers.</strong> Since <em>all</em> politics is local, it’s crucial that local journalism isn’t controlled by Meta. <a href="https://www.pubhubs.net/">There are existing initiatives</a>, but no viable business model. Fixing this would cost very little, yet the benefits would be enormous.</li>
<li><strong>Many national media organizations are completely dependent on Google Docs.</strong> Google Docs, on its own, isn’t as complex as the full MS-365 suite. There are already open-source alternatives that are <em>almost</em> good enough. A robust, public, alternative could allow media organizations to operate independently of U.S. surveillance.</li>
</ul>
<p>With a <em>series</em> of well-structured procurement contracts spread across Europe, we could massively accelerate the development of <em>better</em> European cloud services. Especially if these initiatives build on one another. But, as mentioned, it takes courage to prevent “smart procurement” from simply being won by Amazon, Google, and Microsoft.</p>
<p>As a suggestion for the minister: Procurement rules state that you <em>cannot</em> explicitly exclude any company (except on <em>national security</em> grounds). However, you <strong>can</strong> include criteria in your selection process. For example, requiring that vendors <strong>only</strong> fall under European surveillance laws. That’s a completely reasonable demand — and no U.S. (or U.S.-linked) company could ever comply.</p>
<p>With targeted contracts, the industry could, for example, collectively improve or further develop open-source products that are <a href="https://min.io/">essential</a> for large-scale <a href="https://www.keycloak.org/">cloud usage</a>. After all, everyone needs the same core functionality. A group like Germany’s <a href="https://www.sovereign.tech/">Sovereign Tech Agency</a> demonstrates how this can be done. The Dutch foundation <a href="https://nlnet.nl/NGI0/">NLnet</a> is also making great strides in this area.</p>
<p>The beauty of this kind of smart procurement is that it empowers <em>the market</em> to build great things, without requiring a rigid blueprint for <em>how</em> to do it. You don’t need a “Cloud ESA” for this. But you <em>can</em> strongly encourage valuable developments. And, with a billion euros, you could go a <em>very</em> long way.</p>
<h2 id="but-industrial-policy-isnt-easy">But Industrial Policy Isn’t Easy</h2>
<p>At the same time, this is industrial policy. For the past 50 years, that’s been a dirty word. But when the free market doesn’t deliver what you need, and private companies <em>won’t</em> solve it for you, then you <em>have</em> to do something.</p>
<p>If you want to engage in industrial policy, two things are critical:</p>
<ol>
<li><strong>You need a deep understanding of politics.</strong></li>
<li><strong>You need a deep understanding of industry.</strong></li>
</ol>
<p>And <em>that</em> is going to be a massive challenge.</p>
<p>At the highest levels of European governments, there are almost no (technical) experts. Worse still, it seems that these leadership circles <em>actively dislike</em> technology and would rather discuss other topics.</p>
<p>But this knowledge is essential. While it’s not a good idea to <a href="https://civitas.org.uk/press/governments-can-do-and-should-pick-winners/">try to “pick winners”</a>, recognizing quality (or the lack thereof) is absolutely crucial.</p>
<h2 id="the-european-cloud-industry-why-hasnt-it-taken-off">The European Cloud Industry: Why Hasn’t It Taken Off?</h2>
<p>The European cloud industry has struggled to take off, partly because existing players lacked the will or vision to compete effectively (among many other reasons). It’s tempting to place too much value on the ideas of the relatively most successful existing players, but it’s essential to understand why these companies haven’t broken through earlier.</p>

<center>
<p><img loading="lazy" src="https://berthub.eu/articles/clouds-marktaandeel.png"><br>
Not to be taken too seriously, but this is a roughly to-scale comparison of U.S. cloud providers versus European ones. Take a close look at the bottom right, near the “e” in Google.</p>
</center>  
<p>Additionally, there are many organizations in the market that convincingly claim to be the future. Unfortunately, heavy investment in PR often creates a better initial impression than heavy investment in technology. By now, I have a solid list of <em>timewasters</em> for anyone wondering whether an initiative is legitimate or just hot air (feel free to email me).</p>
<blockquote>
<p>I initially didn’t want to mention this, but several proofreaders spontaneously reported bad experiences, which I have also had myself. If you are approached by the company Arqiver or the “EU FED Cloud,” be aware that they did not leave a good impression on me at all.</p>
</blockquote>
<p>There are also <em>false prophets</em>—we all want quick solutions, and sometimes we get (too) excited about people who promise them. For example, in Germany, some claim they have <a href="https://www.arvato-systems.com/blog/delos-cloud-azure-service-portfolio">“made Microsoft’s cloud European” through SAP</a>. However, this turns out to be <a href="https://berthub.eu/articles/posts/servers-in-de-eu-eigen-sleutels-helpt-het/">not quite the case</a>. If the U.S. refuses to cooperate, they (by their own admission) would be <em>down</em> within a few months.</p>
<p>Amazon also claims they are <em>going to</em> do something similar, but <a href="https://aws.amazon.com/compliance/europe-digital-sovereignty/">they’ve been saying that for years</a>, and they conveniently avoid addressing <a href="https://aws.amazon.com/blogs/security/aws-digital-sovereignty-pledge-announcing-a-new-independent-sovereign-cloud-in-europe/">what happens in case of a conflict with the U.S.</a>. We should also be very cautious about believing in “saviors” like the Lidl Cloud, or even <a href="https://berthub.eu/articles/posts/communicating-without-musk-and-trump-cloud-kootwijk/">Cloud Kootwijk</a>. Seeing is believing.</p>
<p>Another risk factor is the confusion between <em>open</em>, <em>standardized</em>, and <em>autonomous</em>. Many hardcore technologists firmly believe that federated, open, standardized systems are the solution. And to some extent, they are right. But having such technologies available is only a <em>necessary</em> condition—it’s not a solution in itself. Just because the technical prerequisites are met doesn’t mean a market will automatically emerge.</p>
<p>Having standards for interchangeable services is a great thing because it enables choice. We don’t need a single <em>EU Cloud Airbus</em>! At the same time, a <em>profitable</em> business model must emerge—we can’t try to create a market where there’s no money to be made, because that market simply <em>won’t happen</em>.</p>
<p>Finally, there’s always the temptation to rely on large, established defense and IT companies that claim that <em>this time</em>, they can deliver something fresh and innovative. And sure, maybe they can. But these companies are fundamentally not designed for real innovation or rapid development. Moreover, we must question whether they even <em>want</em> to—virtually all major existing players are completely entangled with U.S. big tech. That’s a problem in itself. Even if we develop new software in Europe, we still need large companies that are willing to manage and integrate it.</p>
<p>Summarizing, industrial policy is not easy. It will only succeed if governments independently develop and retain <em>deep</em> knowledge of industry, allowing them to determine what works, what doesn’t, and which direction will lead to a stronger European cloud industry.</p>
<h2 id="open-source">Open Source</h2>
<p>Europe may not excel at commercialization, but we <em>are</em> good at collaboration (more on this later). Nearly every initiative aimed at “doing cloud better in Europe” revolves around open source, because that’s where we have a strong foundation. However, this won’t happen <em>automatically</em>.</p>
<p>The initiatives mentioned earlier—such as “Eumail” and “Eutube”—will deliver the best results if they are built on shared code, libraries, and infrastructure. That way, every euro invested benefits multiple projects simultaneously.</p>
<p><a href="https://berthub.eu/articles/posts/open-source-by-itself-is-no-alternative-for-big-tech/">At the same time, open source is not a solution in itself</a>. Successful IT services depend on robust support, training, integration, and reliable operations.</p>
<p>We also need to carefully consider how companies will actually make money. Our lovely European services should not be overshadowed by competitors who offer the same software but undercut us in pricing by <em>selling user data</em>.</p>
<p>As mentioned before, industrial policy is anything but simple—even when open source is part of the equation.</p>
<h2 id="other-options">Other Options</h2>
<p>To shake things up, we need to do things differently. As mentioned, Europe has a wealth of talent. The “American way” of creating successful new companies through risky startups is one approach. I’ve previously written about <a href="https://berthub.eu/articles/posts/is-europe-just-not-good-at-innovating/">why that approach doesn’t work well here</a>. We can’t just <em>play</em> Silicon Valley in Europe. And even in the U.S., that model mostly produces products that spy on users, flood everything with ads, and push unwanted AI. So, it’s not exactly the best model either. They can’t even seem to establish a basic bank that allows people to transfer money (!!) without requiring apps full of trackers for some reason.</p>
<p>So, what <em>can</em> we do? Earlier, I mentioned that traditional subsidies don’t drive innovation. In Germany, they’ve addressed this by creating <a href="https://sprind.org/en">SPRIND</a>, and I’m very enthusiastic about it (partly because they sometimes hire me as a reviewer, and also because the director was formerly the head of my old company, PowerDNS).</p>
<blockquote>
<p>“The Federal Agency for Breakthrough Innovation SPRIND invests in new groundbreaking technologies and topics that have the potential to fundamentally improve our lives.”</p>
</blockquote>
<p>Applying for support for your project is done via <a href="https://sprind.org/en/new-project">a very simple form</a>. Then, experts review the project <strong>and actively work with you to improve your proposal</strong>. After that, you give <a href="https://sprind.org/en/actions/your-project">a presentation</a>, and if all goes well, you receive funding. The goal is for the entire process to take 12 weeks. There have already been cases where scientists burst into tears upon simply being told that their work was good.</p>
<p>This almost sounds too good to be true, but in Germany, a country not exactly known for its dynamic government or flexible procedures, it’s working like a charm.</p>
<p>And unlike Silicon Valley, what works in Germany <em>can</em> be replicated elsewhere in Europe. We’re in a very similar situation. You could almost directly copy this and create a <em>Sprin-NL</em>.</p>
<h2 id="a-coherent-strategy">A Coherent Strategy</h2>
<p>This is just a blog post, but from the above, a <a href="https://www.managementboek.nl/boek/9781781256176/good-strategy-bad-strategy-richard-rumelt">coherent strategy</a> emerges:</p>
<ol>
<li>Clearly communicate that European privacy standards <em>will</em> eventually be enforced, making the use of U.S. cloud services increasingly uncertain—especially for <a href="https://www.dataprotection.ie/en/organisations/know-your-obligations/lawful-processing/special-category-data">sensitive personal data</a> (Article 9 GDPR).</li>
<li>Governments should actively signal a genuine willingness to do business <em>within</em> Europe. Be prepared to take a creative approach to procurement and use WTO GPA Article III exceptions for privacy and security (if not now, then when?). Also, recognize that the U.S. itself no longer believes in the WTO—so let’s not use WTO rules just to do them a favor!</li>
<li>Hire people within government agencies who have <em>deep</em> industry knowledge. That’s the only way to develop effective industrial policies. Also, start doing more projects <em>in-house</em> without relying on consultants or external procurement—nothing teaches you more than hands-on experience.</li>
<li>Work with experts to identify key cloud functionalities that <em>do not</em> yet have strong open-source implementations, then commission their development or improve existing software. Follow <a href="https://berthub.eu/articles/posts/manifest-big-tech-alternatieven/">these principles</a> to ensure the results are well-documented, secure, and easy to use. Germany’s <a href="https://www.sovereign.tech/">Sovereign Tech Agency</a> demonstrates how this can be done effectively.</li>
<li>At the EU level, commission the development of key services like “Eumail,” “Eutube,” and a European alternative to Google Docs. Encourage the use of software from point 4 and support providers that embrace these solutions.</li>
<li>Follow an “Airbus model”: use procurement policies to encourage the consolidation of the European industry—something made easier if the software from point 4 sees widespread adoption.</li>
<li>Take legal action based on point 1 to show that enforcement is serious.</li>
<li>Establish <em>Sprin-NL</em> or actively participate in a potential <em>Sprin-EU</em>.</li>
<li>In the event of a trade war, consider imposing import tariffs on U.S. cloud services.</li>
</ol>
<p>Some of these steps (such as points 3, 4, and 8) are good ideas regardless. Others only make sense as part of a broader, <em>coherent</em> package. For example, it wouldn’t make much sense to pursue legal action (point 7) to force companies to switch to alternative providers if those providers don’t yet exist.</p>
<h2 id="conclusion">Conclusion</h2>
<p>There are multiple ways to make progress. Governments can take a more hands-on approach, using smarter procurement strategies for standard IT needs as well as special initiatives like Eumail and Eutube. They can credibly signal their intention to start buying European open-source solutions again (and stop fighting legal battles that prevent them from doing so). Better-designed subsidies could help, or something like a <em>Sprin-NL</em> could be established.</p>
<p>In all likelihood, we need to do <em>all</em> of these things simultaneously. The urgency is high enough that we must bet on multiple strategies at once.</p>
<p>The common thread in all of this is that governments need much <em>deeper</em> technological expertise and must integrate that knowledge into policy-making. Because only with a strong understanding of industry can you implement <em>effective</em> industrial policy.</p>
<p>And if we do this well, we might just be able to create a European <em>Airbus</em> for our industry, building something meaningful by working together to elevate essential software to the next level or helping to consolidate key players.</p>
<p>This way, we can regain control and stand on our own feet again.</p>
<p>Good luck!</p>

</div>

  



</article></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Past and Present Futures of User Interface Design (171 pts)]]></title>
            <link>https://www.datagubbe.se/futui/</link>
            <guid>43393924</guid>
            <pubDate>Mon, 17 Mar 2025 23:35:02 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.datagubbe.se/futui/">https://www.datagubbe.se/futui/</a>, See on <a href="https://news.ycombinator.com/item?id=43393924">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>



<p><b>Revolutionizing the desktop since 1975</b></p>
<p><i>Spring 2025</i></p>

<p>
In 1968, Douglas Engelbart demonstrated a computer system called the oN-Line System, or NLS. The NLS is the source of a lot of computer firsts. Among other things, Engelbart showed video conferencing, collaborative text editing, embedded graphics, copying and pasting, and hypertext - all of it accessible through a mouse and keyboard. This event has since become known as <a href="https://www.youtube.com/watch?v=yJDv-zdhzMY">"The Mother of All Demos"</a>.
</p>

<p>
Recently, Amelia Wattenberger published <a href="https://wattenberger.com/thoughts/our-interfaces-have-lost-their-senses">an article with ideas about a possible future for user interfaces</a>.
In short, she asks for interfaces with more tactile "friction", praises multi-modality and suggest variations in both input devices and feedback options. We'll return to her text, but first, let's look at some other visions of future user interfaces.
</p>

<h3>Xerox Alto</h3>

<p>
<a href="https://www.datagubbe.se/futui/smalltalk-76.png"><img src="https://www.datagubbe.se/futui/smalltalk-76_crop.png" alt="A screenshot of Smalltalk-76, showing a paint program that looks a lot like MSPaint."></a>
<br>
<i>Smalltalk-76 (from 1976), displaying a paint program written in Smalltalk-76. It looks curiously like Microsoft Paint - or, more correctly, it's the other way around. Click the image to view the full version.</i>
</p>

<p>
The Xerox Alto wasn't as much a vision as an actual product. Inspired by Engelbart and others, a team of researchers at Xerox PARC set about creating computers for the office of the future. This resulted in the Alto, a machine that would probably be recognizable to a lot of present day computer users.
The Alto was the origin of Smalltalk, a programming language with its own GUI environment - the one that inspired Steve Jobs to commission the Lisa. Looking at that GUI now, it's baffling how little desktop interfaces have changed since then, almost 50 years ago.
</p>

<p>
<img src="https://www.datagubbe.se/futui/alto.jpg" alt="A man sitting in front of a Xerox Alto computer.">
<br>
<i>A man and his Alto. The screen was in portrait mode: Xerox was all about paper.</i>
</p>

<p>
<a href="https://www.youtube.com/watch?v=M0zgj2p7Ww4">In a commercial for the Alto</a>, we meet a man - some kind of upper middle management, presumably - going about his daily business. He works in a spacious private office and, using the Alto, he can read and send email and produce laser printouts. Eventually, the Alto conjures up a high resolution image of flowers. The man wonders why, and the computer replies - with text on screen - that it's the man's wedding anniversary. "I forgot," says the man, to which the Alto replies, "It's okay, we're only human."
</p>

<p>
Despite being a very advanced system for its time, the Alto was of course incapable of such banter - and yet, the commercial's producers saw fit to include it, in order to spice things up.
</p>


<h3>Sun Starfire</h3>

<p>
Commercials like that for the Alto always feel a bit stuffy and contrived. Upping the ante in several ways, <a href="https://www.youtube.com/watch?v=w9OKcKisUrY">Sun Microsystem's 1994 commercial for Starfire</a> (an imaginary future computer), is a cringe-filled orgy in stilty acting and terrible writing. The protagonist once more seems to be upper middle management, and she's working on a presentation of an electric car. <b><i>Future!</i></b> She also engages in a bunch of strange and/or morally questionable activities. We'll probably never know why the producers decided to give her a cold, or why she spends so much of her time spying on co-workers using the live CCTV function on her expensive computer. But I digress.
</p>

<p>
The commercial presents several concepts that - like in Engelbart's demo - are now commonplace. Tablet computers, video conferencing, touch screens, AI-augmented image and video editing, and instant scanning (today we'd probably just photograph the document with our smartphone). Granted, imminent mainstream adoption of such functions was fairly obvious in 1994.
</p>

<p>
<img src="https://www.datagubbe.se/futui/starfire.jpg" alt="A woman standing in front of a large, curved touchscreen. The screen wraps around the desk. A computer mouse is visible, but no keyboard.">
<br>
<i>A woman and her ginormous Starfire. Note the apparent lack of a keyboard. A mouse is present, however, despite the massive touchscreen.</i>
</p>

<p>
Our hero is working on her presentation in a grotesquely spacious private office, which is probably necessary considering the sheer size of the Starfire. Actually operating it includes a lot of swiping and tapping on its humongous screen - mixed with talking to it, of course.
</p>

<h3>The Office of the Future</h3>

<p>
There are many other, similar, visions of our digital future. Plenty of them include touch interfaces and speaking to our computers. In fact, many of these visions are curiously reminiscent of how computers work in Star Trek. There's some vague touch-type interface (LCARS), but you can also speak to the computer - which will reply in conversational English. And of course there's video conferencing.
</p>

<p>
<img src="https://www.datagubbe.se/futui/startrek3.jpg" alt="A still from an episode of Star Trek. Captain Janeway and some of her crew are using the LCARS computer interface. In the background, a video conference is going on.">
<br>
<i>Star Trek: The quintessential computer of the future. Touchy, talky and, er, video-y.</i>
</p>

<p>
Some of the more outlandish suggestions in the Starfire commercial (such as a roll of film slowly pouring a texture onto a 3D model) are clearly intended to raise eyebrows, rather than reflect actually working interfaces. Other concepts are recurring in visions of future UI:s, like giant touch displays and the constant desire to talk to our machines.
</p>

<p>
These suggestions also seem genuine, which brings us to Wattenberger's recent article.
</p>

<h3>Tactile computing</h3>

<p>
Wattenberger touches on some relevant issues, especially regarding the prevalence of touchscreens and their inherent lack of tactile feedback. Alas, I think the reasoning presented conflates a desire for "genuine" experiences with something that can be competitive in a global, mass market economy. The former doesn't necessarily <i>disappear</i> because of the latter, but "friction" isn't something that's going to sell a lot of software.
</p>

<p>
To riff of Wattenberger's own example: Most doughs aren't kneaded by humans. We have machines for that - even in our homes - and the majority of our bread is produced at an industrial scale. That doesn't mean we can't knead our own dough if we want to, or that an artisanal bakery can't do well in an affluent neighborhood.
</p>

<p>
Computers are successful not because they introduce friction, but because they <i>reduce</i> it. If friction was a selling point, we'd give up spreadsheet software today and go back to the tactile way - using paper worksheets.
</p>

<p>
We're still allowed to dream, of course. I <a href="https://www.datagubbe.se/cosy/">absolutely agree</a> that more aspects of everyday life should be more tactile than an unyielding flatscreen. Most of that already exists, in the form of actual push buttons, keyboards, joysticks, levers, sliders and turning knobs. It's a question of hardware rather than software. Which is where the harsh reality of capitalism comes in and ruins everything: if it's cheaper with a touchscreen, and at all feasible, it's going to be a touchscreen. Not just in regular smart devices, but in cars, elevators, coffee machines and stovetops as well. Given this, I'd rather we spent some energy on making those interfaces as good as humanly possible, instead of trying to reinvent things that already work well.
</p>

<p>
The interface suggestions made toward the end of the text is what usually crops up when talking about revolutionizing the way we work with computers: an infinite canvas and - harking back to both the Alto, Starfire and Star Trek - some voice control.
</p>

<h3>Design and Reality</h3>

<p>
The infinite canvas isn't bad, necessarily, but the unstructured sprawl of mixed information they often lead to seems to offer little value to the vast majority of computer users. When adding structure and bounds to the canvas, the idea does seem to appeal to a wider audience: spreadsheets are very popular. But there's a limited amount of spreadsheet-type tasks, and at some point we need a different kind of interface and another way to structure our data.
Wouter van Oortmerssen (of CryEngine and WebAssembly fame) released <a href="https://strlen.com/treesheets/">TreeSheets</a> some 16 years ago. While it's an interesting concept, it doesn't seem to have caught on.
</p>

<p>
Traits like structure and relationships also come into play when we work with information. We seem to need a mental model - a spatial psychological abstraction - of our data, to know from which angle to attack it. Such a model can be hard to build when everything exists in a vast 2D space without clear boundaries. That's where things like tree views, lists and grids come into play. Most users aren't performing the kind of work that lends itself to an infinite canvas, anyway: File an order, take the next call, file another one.
In short: if infinite canvases really were that great, I think we'd see a lot more of them.
</p>

<p>
Enormous computer screens, like that of the Starfire, are now cheaper than ever to buy. Touch technology is everywhere. Thankfully, manufacturers have realized that the combination is untenable: Imagine having to raise your arm to swipe, pinch and tap across an ultra-wide screen several times per minute. Touch works best on small surfaces, even if it <i>looks impressive</i> on a bigger screen. For a while, manufacturers wanted us to buy touchscreen laptops. I haven't seen one of those in the wild for several years now - but pure tablets are commonplace. It seems as if there is a keyboard and mouse around, we pick them over touch for most desktop-type tasks.
</p>

<p>
Voice control always adds a certain futuristic vibe to a demo. In reality, it seems we're stuck with several circumstances making it effectively pointless. Our best LLM:s are a far cry from the AI:s in Star Trek, but even for simpler tasks use cases appear limited. I work with developers and other IT professionals all day, hang out with similar people on my free time, ride a commute jam packed with project managing office dwellers, and regularly find myself in big cities - but I haven't heard a single "Hey, Siri" for years. Like with the scarcity of touchscreen laptops, I'm sure that means <i>something</i>.
</p>

<p>
Infinite canvases, laissez-faire touchscreens and voice control seem very <i>designer-y</i> to me. By that I mean they're reflecting how a graphical designer would like to work with a computer at certain points in their creative process.
</p>

<p>
But we shouldn't build entire paradigms, or even just individual interfaces, based on the assumption that everyone else is using computers the same way we ourselves do. Most people don't conceptualize graphic design ideas or freestyle pretend corporate presentations. Some are controlling an industrial process, editing a feature film, designing an airplane or writing code. Most, however, are probably filing a customer complaint, ordering food, booking a flight, or doing some accounting.
</p>
<p>
Some people have the luxury of working in their own, private offices - or at home. Most computer users don't. They're confined to open floor plan offices, hotel lobbies, bustling trading desks, loud workshops or busy stores. Most of them probably perform tasks where speaking - even if it had been in a quiet and solitary environment - is less efficient than typing, tapping or clicking.
</p>

<p>
The same goes for multi-sensory interfaces in general. Voice control have many apparent drawbacks, but so do UI:s with audio feedback. Ever been in an open floorplan office where people have audio notifications enabled when receiving a chat message? Welcome to hell.
</p>

<p>
Even in a spacious private office, audio signals can be annoying. They interfere with music, for example, which is something a lot of people use their computers for both at work and at home. Generally, relying on a single type of feedback is a bad UI idea: Apart from poor accessibility, it reduces the user's freedom to customize their working environment. Some, like me, are annoyed by sound. Others seem to love it, and others still <i>require it</i> if they're to use a computer at all.
</p>

<h3>The Actual Future</h3>

<p>
The desktop user interface is a mainstay of computing. Bread and butter, if you will. A pointer, icons, windows, menus and buttons, controlled using a keyboard and a mouse. Ingenious simplicity.
</p>

<p>
For almost half a century now, we haven't really managed to come up with something better, and that's not for lack of trying. This fact seems to annoy a lot of people looking for a problem to solve - which every so often leads to something rather silly. Removing scrollbars from desktop programs for example, only to realize that people then don't understand there's scrollable content, and then responding by <i>cooking up some other way of doing scrolling</i> instead of just reinstating scrollbars.
</p>

<p>
Blundering about like that isn't inventing a new paradigm, no matter what individual designers claim - it's just making an existing one worse. But is there a real new paradigm around the corner? Is the desktop going to disappear? I honestly don't know, but I sincerely doubt it. It's probably just going to get slightly worse in some aspects, and hopefully slightly better in others.
</p>

<p>
Truly new paradigms do appear from time to time, mostly out of necessity. The smartphone is a great example. It needs to pack a lot of different input methods into one tiny little surface, and touch is great for that. The results aren't always optimal, but they're good enough compromises, vastly improving the flexibility of such a small device.
</p>

<p>
To me, trying to reinvent the desktop experience feels a bit like complaining about steering wheels in cars. To others, it's a great opportunity to confuse <i>change</i> with <i>improvement</i> and <i>different</i> with <i>better</i>.
With that said, I'm on board with Wattenberger's wish for slightly more tactile computers. In fact, if I'm being honest, I'd probably want computers and computing to be more like it <i>actually</i> was in 1994, and much less like our current Starfirey world.
</p>

<p>
Since that's probably not going to happen, I instead urge UI designers to consider the powerful concepts of <i>consistency</i> and <i>familiarity</i> just a bit more often than they presently seem to do.
</p>


</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[GIMP 3.0 Released (1187 pts)]]></title>
            <link>https://testing.gimp.org/news/2025/03/16/gimp-3-0-released/</link>
            <guid>43393822</guid>
            <pubDate>Mon, 17 Mar 2025 23:25:53 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://testing.gimp.org/news/2025/03/16/gimp-3-0-released/">https://testing.gimp.org/news/2025/03/16/gimp-3-0-released/</a>, See on <a href="https://news.ycombinator.com/item?id=43393822">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
                    <p>At long last, the <strong>first release of <span>GIMP</span> 3.0 is here</strong>! This is the end result of
seven years of hard work by volunteer developers, designers, artists, and community members (for reference, <span>GIMP</span> 2.10 was first <a href="https://www.gimp.org/news/2018/04/27/gimp-2-10-0-released/">published in 2018</a>
and the initial development version of <span>GIMP</span> 3.0 was <a href="https://www.gimp.org/news/2020/11/06/gimp-2-99-2-released/">released in 2020</a>). With <span>GIMP</span> 3.0 you can do more than ever before, more easily, more&nbsp;quickly!</p>
<figure>
<img src="https://testing.gimp.org/news/2025/03/16/gimp-3-0-released/gimp-3.0-splash.jpg" alt="GIMP 3.0: splash screen by Sevenix">
<figcaption>
<em><span>GIMP</span> 3.0 splash screen, by Sevenix (<span>CC</span> by-sa 4.0)</em>
</figcaption>
</figure>

<p>While we can’t cover every single change in <span>GIMP</span> from 2.10, we want to highlight some of the biggest ones as you start exploring this new&nbsp;release.</p>
<h2 id="highlights">Highlights<a href="#highlights" title="Permanent link">¶</a></h2>
<ul>
<li>
<p>Need to tweak a filter you applied hours ago?
New in <span>GIMP</span> 3.0 is non-destructive editing for
most commonly-used filters. See the changes in
real time with on-canvas&nbsp;preview.</p>
</li>
<li>
<p>Exchange files with more applications, including
<span>BC7</span> <span>DDS</span> files as well as better <span>PSD</span> export and
many new&nbsp;formats.</p>
</li>
<li>
<p>Don’t know how big to make your drawing?
Simply set your paint tool to expand layers automatically as&nbsp;needed.</p>
</li>
<li>
<p>Making pro-quality text got easier, too. Style your text,
apply outlines, shadows, bevels, and more, and you can
still edit your text, change font and size,
and even tweak the style&nbsp;settings.</p>
</li>
<li>
<p>Organizing your layers has become much easier with the ability to
  select multiple items at once, move them or transform them all&nbsp;together!</p>
</li>
<li>
<p>Color Management was again improved, as our long-term project to make
  <span>GIMP</span> an advanced image editor for all&nbsp;usages.</p>
</li>
<li>
<p>Updated graphical toolkit (<span>GTK3</span>) for modern desktop&nbsp;usage.</p>
</li>
<li>
<p>New Wilber&nbsp;logo!</p>
</li>
</ul>
<figure>
<img src="https://testing.gimp.org/images/frontpage/wilber-big.png" alt="GIMP 3.0: Wilber logo by Aryeom">
<figcaption>
<em>New <span>GIMP</span> logo, Wilber, by Aryeom (<span>CC</span> by-sa 4.0)</em>
</figcaption>
</figure>

<h2 id="learn-more">Learn More<a href="#learn-more" title="Permanent link">¶</a></h2>
<p>We’ve prepared <a href="https://testing.gimp.org/release-notes/gimp-3.0.html">release notes</a> to go over all the changes, improvements, new features, and more. And if you’d like even more details, you can peruse the <a href="https://gitlab.gnome.org/GNOME/gimp/-/blob/master/NEWS"><span>NEWS</span></a> changelog for all 2.99 and 3.0 <span>RC</span>&nbsp;releases.</p>
<p>But to see it for yourself, you can get <span>GIMP</span> 3.0 directly from our <a href="https://www.gimp.org/downloads/">Downloads page</a> and try it&nbsp;out!</p>
<p><a href="https://testing.gimp.org/release-notes/gimp-3.0.html" title="GIMP 3.0.0 Release Notes">
    » <span>READ</span> <span>COMPLETE</span> <span>RELEASE</span> <span>NOTES</span>&nbsp;«
</a></p>
<h2 id="other-releases-in-gimpverse">Other Releases in GIMPVerse<a href="#other-releases-in-gimpverse" title="Permanent link">¶</a></h2>
<p>To accompany our release of <span>GIMP</span> 3.0.0, packagers should also be aware
that we&nbsp;released:</p>
<ul>
<li>babl 0.1.112 (<a href="https://download.gimp.org/babl/0.1/">tarball</a>)</li>
<li><span>GEGL</span> 0.4.56 (<a href="https://download.gimp.org/gegl/0.4/">tarball</a>)</li>
<li><span>GIMP</span> Manual 3.0.0 (<a href="https://download.gimp.org/gimp/help/">tarball</a> and
  <a href="https://download.gimp.org/gimp/help/windows/3.0/">Windows installers</a>)</li>
</ul>
<h2 id="enjoy-gimp-30">Enjoy <span>GIMP</span> 3.0!<a href="#enjoy-gimp-30" title="Permanent link">¶</a></h2>
<p><span>GIMP</span> 3.0 is a new milestone. The application is in active
development and if you think this is awesome, wait until
you see our plans for the&nbsp;future!</p>
<p>
  <span>
    <a href="https://testing.gimp.org/downloads/">
      Download <span>GIMP</span>&nbsp;3.0.0
    </a>
  </span>
</p>

<h2 id="support-gimp-development">Support <span>GIMP</span> development<a href="#support-gimp-development" title="Permanent link">¶</a></h2>
<p>Don’t forget you can <a href="https://www.gimp.org/donating/">donate and personally fund <span>GIMP</span> developers</a>, as a way to
give back and accelerate the development of <span>GIMP</span>. Community commitment helps the project to grow&nbsp;stronger!</p>
<p>
  <a href="https://www.gimp.org/donating/">
    <span>
    Support us by<br> <strong>Donating</strong>
    </span>
  </a>
</p>
                  </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Amazon plans to lay off 14,000 managerial positions to save $3.5B yearly (252 pts)]]></title>
            <link>https://techstartups.com/2025/03/17/amazon-to-lay-off-14000-managerial-positions-to-save-3-5-billion-annually/</link>
            <guid>43393079</guid>
            <pubDate>Mon, 17 Mar 2025 21:50:22 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://techstartups.com/2025/03/17/amazon-to-lay-off-14000-managerial-positions-to-save-3-5-billion-annually/">https://techstartups.com/2025/03/17/amazon-to-lay-off-14000-managerial-positions-to-save-3-5-billion-annually/</a>, See on <a href="https://news.ycombinator.com/item?id=43393079">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="post-95763">
	    
	    		    
	    	
			
			<hr><br>
			
						
			

	    
	    				
			    	    <p><img src="https://techstartups.com/wp-content/uploads/2024/02/Jeff-Bezos-sells-about-2-billion-of-Amazon-shares-960x565.jpg" alt="">
			    	    </p>
			
			
		    <div>
				
				<p data-pm-slice="1 1 []">Amazon is set to cut around 14,000 managerial positions by early 2025, aiming to save between $2.1 billion and $3.6 billion annually. This reduction marks a 13% drop in Amazon’s global management workforce, shrinking the number of managers from 105,770 to 91,936.</p>
<p>This move follows <a href="https://techstartups.com/2025/01/30/amazon-lays-off-employees-in-communications-and-sustainability-units-in-latest-round-of-cuts/" target="_blank" rel="noopener">recent layoffs</a> in Amazon’s communications and sustainability units, as the company pushes to streamline operations and restructure teams.</p>
<p>According to <a href="https://www.businessinsider.com/amazon-could-cut-managers-save-3-billion-analysts-2024-10" target="_blank" rel="noopener">Business Insider</a>, the<span> job cut is part of</span> CEO Andy Jassy’s strategy to simplify decision-making and speed up processes. Last month, Jassy announced plans to boost the ratio of individual contributors to managers by at least 15% by the end of the first quarter of 2025. He emphasized that reducing managerial layers would streamline operations and enable Amazon to make faster decisions without getting bogged down by bureaucracy.</p>
<p>In a note released Thursday, Morgan Stanley projected that Amazon’s plan could cut around 13,834 managerial roles by early next year, saving the company between $2.1 billion and $3.6 billion.&nbsp;The estimate is based on the assumption that managers make up 7% of Amazon’s workforce.</p>
<blockquote><p><em>“Morgan Stanley estimated that this effort could lead to the elimination of roughly 13,834 manager roles by early next year, resulting in cost savings of $2.1 billion to $3.6 billion,” Business Insider reported.</em></p></blockquote>
<p>As part of this plan, Amazon has launched a “bureaucracy tipline,” encouraging employees to flag inefficient procedures that slow down work. Managers have also been instructed to increase their direct reports, limit senior hires, and review pay structures to support the shift toward a leaner management model.</p>
<p>This layoff wave continues Amazon’s cost-cutting efforts that saw over 27,000 job cuts in 2022 and 2023. The company has also pulled back on projects that didn’t yield profits, including its “Try Before You Buy” clothing initiative and a speedy brick-and-mortar delivery service.</p>
<p>Amazon’s workforce saw significant growth during the pandemic, swelling to over 1.6 million by the end of 2021, up from 798,000 in late 2019. Although numbers have dipped since then, the company is still recalibrating its staffing needs.</p>
<p>Earlier this year, Amazon mandated that corporate employees return to the office five days a week. Some staff were asked to relocate to designated office hubs, prompting some to leave rather than move.</p>
<p>Management restructuring is another key part of Jassy’s approach, with efforts to reduce layers between employees and leadership.</p>
<p>This move places Amazon alongside other tech companies trimming their workforce. Layoffs.FYI, a site tracking job cuts in tech, <a href="https://layoffs.fyi/" target="_blank" rel="noopener">reports</a> that 81 tech companies have eliminated 22,692 jobs so far this year.</p>
				
				
				<hr>
				
							</div>

		    			<h5>Trending Now</h5>
			  	<div>
									<div>
														<p><a href="https://techstartups.com/2025/03/07/microsoft-is-plotting-a-future-without-openai/">
								    									    	<img src="https://techstartups.com/wp-content/uploads/2025/03/Moving-Away-700x466.jpg" alt="">
								    </a>
								</p>
														
							</div>
									<div>
														<p><a href="https://techstartups.com/2025/03/17/amazon-to-lay-off-14000-managerial-positions-to-save-3-5-billion-annually/">
								    									    	<img src="https://techstartups.com/wp-content/uploads/2024/02/Jeff-Bezos-sells-about-2-billion-of-Amazon-shares-700x466.jpg" alt="">
								    </a>
								</p>
														
							</div>
						  	</div>
						
						
						
						
						
						
	    </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[The High Heel Problem (251 pts)]]></title>
            <link>https://simonschreibt.de/gat/the-high-heel-problem/</link>
            <guid>43392549</guid>
            <pubDate>Mon, 17 Mar 2025 20:43:35 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://simonschreibt.de/gat/the-high-heel-problem/">https://simonschreibt.de/gat/the-high-heel-problem/</a>, See on <a href="https://news.ycombinator.com/item?id=43392549">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
			
<h2>Introduction</h2>



<p>This article looks at how different types of shoes can affect game development and examines how games deal with this in practice.</p>



<p>Before we dive in, let’s have a look what’s possible with high heels:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/realworld_01-1.mp4" playsinline=""></video><figcaption>Sources: <a href="https://www.youtube.com/shorts/-ymWhRhoQ2o" data-type="link" data-id="https://www.youtube.com/shorts/-ymWhRhoQ2o" target="_blank" rel="noreferrer noopener">#1</a> <a href="https://www.tiktok.com/@blumineck/video/7282440261223992609" data-type="link" data-id="https://www.tiktok.com/@blumineck/video/7282440261223992609" target="_blank" rel="noreferrer noopener">#2</a> <a href="https://www.youtube.com/shorts/2DriKlNOJcc" data-type="link" data-id="https://www.youtube.com/shorts/2DriKlNOJcc" target="_blank" rel="noreferrer noopener">#3</a> <a href="https://www.youtube.com/shorts/L-rvdMHA9ec" data-type="link" data-id="https://www.youtube.com/shorts/L-rvdMHA9ec" target="_blank" rel="noreferrer noopener">#4</a> <a href="https://www.youtube.com/shorts/79n-62kQttA" data-type="link" data-id="https://www.youtube.com/shorts/79n-62kQttA" target="_blank" rel="noreferrer noopener">#5</a></figcaption></figure>



<p>Just in case I mess up the terminology, here is a little chart:</p>





<p><a href="#height" data-type="internal" data-id="#height">Character Height</a> | <a href="#posture" data-type="internal" data-id="#posture">Posture</a> | <a href="#animation">Animation</a> | <a href="#clipping">Optimization</a> | <a href="#audio">Audio</a> | <a href="#bonus" data-type="internal" data-id="#bonus">Bonus</a> | <a href="#summary" data-type="internal" data-id="#summary">Summary</a> | <a href="#sources">Sources</a></p>



<p>💘💘💘 Huge thanks to <a href="https://www.linkedin.com/in/nicolas-gueroux-698a2027" data-type="link" data-id="https://www.linkedin.com/in/nicolas-gueroux-698a2027" target="_blank" rel="noreferrer noopener">Nicolas</a>, Damrus, <a href="https://www.artstation.com/irinaern" data-type="link" data-id="https://www.artstation.com/irinaern" target="_blank" rel="noreferrer noopener">Irina</a>, <a href="https://www.artstation.com/battz" data-type="link" data-id="https://www.artstation.com/battz" target="_blank" rel="noreferrer noopener">Battz</a>, <a href="https://bsky.app/profile/magarigames.bsky.social" data-type="link" data-id="https://bsky.app/profile/magarigames.bsky.social" target="_blank" rel="noreferrer noopener">Magari</a>, <a href="https://www.artstation.com/lunawullaert" data-type="link" data-id="https://www.artstation.com/lunawullaert" target="_blank" rel="noreferrer noopener">Luna</a>, <a href="https://linktr.ee/AngelCake.s" data-type="link" data-id="https://linktr.ee/AngelCake.s" target="_blank" rel="noreferrer noopener">Angel</a> for helping with this article. 💘💘💘</p>



<h2 id="height">Character Height</h2>







<p>Different character body sizes mean a lot of extra work for game developers. Here’s a great example for Dragons Dogma 2, where characters with different body sizes still manage to kiss:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/ddogma_kiss_01.mp4" playsinline=""></video><figcaption>Source: Dragons Dogma 2 Let’s Play <a href="https://youtu.be/4s31tU19dT8" data-type="link" data-id="https://youtu.be/4s31tU19dT8" target="_blank" rel="noreferrer noopener">#1</a> &amp; <a href="https://youtu.be/LK44InP2Tdo" data-type="link" data-id="https://youtu.be/LK44InP2Tdo" target="_blank" rel="noreferrer noopener">#2</a></figcaption></figure>



<p>Here we can see how the animation is adjusted so that the lips can meet. The camera also does a lot of work:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/ddogma_kiss_02.mp4" playsinline=""></video><figcaption>Source: Dragons Dogma 2 Let’s Play <a href="https://youtu.be/4s31tU19dT8" data-type="link" data-id="https://youtu.be/4s31tU19dT8" target="_blank" rel="noreferrer noopener">#1</a> &amp; <a href="https://youtu.be/LK44InP2Tdo" data-type="link" data-id="https://youtu.be/LK44InP2Tdo" target="_blank" rel="noreferrer noopener">#2</a></figcaption></figure>



<p>But even if all characters have the <strong>same</strong> height, different shoes can influence the height of a character as well! This results in new bone positions, so that, for example, a finger no longer hits a button on the wall.</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/zombie_posture_plateau-1.mp4" playsinline=""></video><figcaption>Source: <a href="https://www.mixamo.com/#/?page=1&amp;type=Character" data-type="link" data-id="https://www.mixamo.com/#/?page=1&amp;type=Character" target="_blank" rel="noreferrer noopener">Mixamo “Romero”</a></figcaption></figure>



<p>Apart from precise interactions, there may be other special cases in which heels could lead to a problem: For example, you should be careful that heels do not give the player away behind cover:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/zombie_crouch_high_heels_compare.mp4" playsinline=""></video><figcaption>Source: <a href="https://www.mixamo.com/#/?page=1&amp;type=Character" data-type="link" data-id="https://www.mixamo.com/#/?page=1&amp;type=Character" target="_blank" rel="noreferrer noopener">Mixamo “Romero”</a></figcaption></figure>



<p>If the character’s height changes, you may also need to update the <strong>hit collision volumes</strong> – especially in competitive games. This depends on how the engine handles such volumes. Better double-check!</p>



<p>Game developers are now on a cross road. Choose wisely!</p>


<div>
<figure><a href="https://simonschreibt.de/wp-content/uploads/2025/03/meme_adjust.jpg"><img decoding="async" width="500" height="756" src="https://simonschreibt.de/wp-content/uploads/2025/03/meme_adjust.jpg" alt="" srcset="https://simonschreibt.de/wp-content/uploads/2025/03/meme_adjust.jpg 500w, https://simonschreibt.de/wp-content/uploads/2025/03/meme_adjust-198x300.jpg 198w" sizes="(max-width: 500px) 100vw, 500px"></a></figure></div>


<p>Let’s talk about option A first, where we adjust the height of the character correctly and realistically!</p>



<h2>💡 Solution A: “Adjust Height”</h2>



<p>There are three ways to deal with the consequences of the characters’ different shoe heights:</p>



<ol>
<li>Hope for the best</li>



<li>Fix Manually</li>



<li>Fix Dynamically</li>
</ol>



<h3>🙈 1. Hope for the best</h3>



<p>Some games can afford to adjust the character height because there are only <strong>few precise interactions</strong> with NPCs or the environment. When playing Infinity Nikki, for example, I mostly found animations where it doesn’t matter whether Nikki is 10cm taller or shorter (like opening a chest):</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/nikki_open_chest.mp4" playsinline=""></video><figcaption>Source: <a href="https://store.epicgames.com/fr/p/infinity-nikki-71fc64" data-type="link" data-id="https://store.epicgames.com/fr/p/infinity-nikki-71fc64" target="_blank" rel="noreferrer noopener">Infinity Nikki</a></figcaption></figure>



<p>And I can’t remember any precise interaction in the cutscenes either (e.g. a handshake). So, raising the body is not much of an issue:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/nikki_01.mp4" playsinline=""></video><figcaption>Source: <a href="https://store.epicgames.com/fr/p/infinity-nikki-71fc64" data-type="link" data-id="https://store.epicgames.com/fr/p/infinity-nikki-71fc64" target="_blank" rel="noreferrer noopener">Infinity Nikki</a></figcaption></figure>



<p>However, there is one exception: I have noticed a situation in which there is close interaction: Grooming. There are two outfits for this: one <strong>with</strong> and one <strong>without</strong> heels:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/nikki_grooming.mp4" playsinline=""></video><figcaption>Source: <a href="https://store.epicgames.com/fr/p/infinity-nikki-71fc64" data-type="link" data-id="https://store.epicgames.com/fr/p/infinity-nikki-71fc64" target="_blank" rel="noreferrer noopener">Infinity Nikki</a></figcaption></figure>



<p>I think if I look <strong>very closely</strong>, I can see that there is a slight clipping problem with the animation with heels. Could be due to the different terrain though. I’m not sure, but it’s definitely not a big deal.</p>



<figure><a href="https://simonschreibt.de/wp-content/uploads/2025/03/nikki_grooming.jpg"><img decoding="async" width="1024" height="576" src="https://simonschreibt.de/wp-content/uploads/2025/03/nikki_grooming-1024x576.jpg" alt="" srcset="https://simonschreibt.de/wp-content/uploads/2025/03/nikki_grooming-1024x576.jpg 1024w, https://simonschreibt.de/wp-content/uploads/2025/03/nikki_grooming-300x169.jpg 300w, https://simonschreibt.de/wp-content/uploads/2025/03/nikki_grooming-768x432.jpg 768w, https://simonschreibt.de/wp-content/uploads/2025/03/nikki_grooming-624x351.jpg 624w, https://simonschreibt.de/wp-content/uploads/2025/03/nikki_grooming.jpg 1280w" sizes="(max-width: 1024px) 100vw, 1024px"></a></figure>



<p>Saints Row is another game that correctly resizes the character, and it’s the only game I’ve stumbled across where you can wear heels as a <strong>male</strong> character:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/sr5.mp4" playsinline=""></video><figcaption>Source: <a href="https://store.steampowered.com/app/742420/Saints_Row/" data-type="link" data-id="https://store.steampowered.com/app/742420/Saints_Row/" target="_blank" rel="noreferrer noopener">Saints Row</a></figcaption></figure>



<h3>💪 2. Manual Labor</h3>



<p>If the game needs it, animators could create unique animations (per shoe type) where e.g. the hand positions are corrected. They will love it!</p>



<p><em>stand_groom_barefoot.fbx</em><br><em>stand_groom_shoe_5cm.fbx</em><br><em>stand_groom_shoe_12cm.fbx</em></p>



<p>But be careful! If not <strong>all animations</strong> are adapted, this can lead to problems. Here, for example, a specific golf animation only seems to be available for flat shoes:</p>



<figure><video autoplay="" controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/gtav_gold_high_heels.mp4" playsinline=""></video><figcaption>Source: <a href="https://www.rockstargames.com/gta-online" data-type="link" data-id="https://www.rockstargames.com/gta-online" target="_blank" rel="noreferrer noopener">GTA Online</a></figcaption></figure>



<p>The same happens with the drinking animation (right), which only seems to be available for flat shoes. Special cases such as motorcycling also require special attention when heels are involved:</p>





<p>Here’s a closer look at what happens: The feet have to strike a different pose when high heels are worn (right). Otherwise it looks funny (left):</p>





<p>Incidentally, the same behavior can also be seen in Nikki for a <strong>single frame</strong> when the shoes are swapped. The shoe mesh is replaced one frame before the pose adjusts:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/nikki_01_slowmo.mp4" playsinline=""></video><figcaption>Source: <a href="https://store.epicgames.com/fr/p/infinity-nikki-71fc64" data-type="link" data-id="https://store.epicgames.com/fr/p/infinity-nikki-71fc64" target="_blank" rel="noreferrer noopener">Infinity Nikki</a></figcaption></figure>



<h3>⚙️ 3. Dynamic Systems</h3>



<p><strong>Manual adjustment</strong> is a lot of work! Isn’t there a way to automate this? For example, it would be a nightmare if you wanted to have a hand-holding mechanic and then you need tons of animations to make sure that the hands of characters with different shoe heights still meet precisely.</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/unreal_hand_holding.mp4" playsinline=""></video><figcaption>Source: <a href="https://youtu.be/x8I2Xi8bRL8" data-type="link" data-id="https://youtu.be/x8I2Xi8bRL8" target="_blank" rel="noreferrer noopener">Hand Holding Mechanics</a></figcaption></figure>



<p>IK to the rescue!</p>



<p>Modern engines offer real-time IK systems. Most players are already familiar with them, as these systems adapt the foot orientation to the terrain:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/nikki_terrain_ik.mp4" playsinline=""></video><figcaption>Source: <a href="https://store.epicgames.com/fr/p/infinity-nikki-71fc64" data-type="link" data-id="https://store.epicgames.com/fr/p/infinity-nikki-71fc64" target="_blank" rel="noreferrer noopener">Infinity Nikki</a></figcaption></figure>



<p>Such systems can also be used for atmospheric procedural animations such as touching a wall as you walk by:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/uncharted_wall_ik.mp4" playsinline=""></video><figcaption>Source: <a href="https://youtu.be/dlQqiJYdyYM" data-type="link" data-id="https://youtu.be/dlQqiJYdyYM" target="_blank" rel="noreferrer noopener">iHeartGameDev | Uncharted</a></figcaption></figure>



<p>Or, and this is particularly exciting for our topic, to dynamically adjust the hand position in the direction of a target, so that the character itself can have a different height and/or the target can be at a dynamic height in the level:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/unreal_example_ik.mp4" playsinline=""></video><figcaption>Source: Unreal Content Examples: IK Rig</figcaption></figure>



<p>But be careful. If the IK target is not used correctly, you may end up with NSFW animations. You have been warned!</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/fun_unreal_example_01.mp4" playsinline=""></video></figure>



<h2>💡 Solution B: “Find Workaround”</h2>



<p>Don’t want to manually adjust all animations or use a dynamic system? No problem!<br>Let’s take a look at some ways to equip characters with high heels <strong>without</strong> changing the actual body height to get around the things mentioned above.</p>



<p>Again, we have three options:</p>



<ol>
<li>Hide</li>



<li>Shorten</li>



<li>Bend</li>
</ol>



<h3>🙈 1. Hide!</h3>



<p>If the shoe allows it, you can “hide” your feet in the soles. This makes the leg look shorter (just like in the next section) but neither the leg nor the shoe needs to be altered:</p>





<h3>🦶 2. Shorten</h3>



<p>I have seen this solution <strong>very often</strong> in my research: The lower leg is simply shortened so as not to change the height of the character.</p>



<p>Here is an example in Sims 4, as you can see: The hip stays in place, the upper leg <strong>doesn’t</strong> change, but the lower leg is shortened (the angle is moved up):</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/sims4_kitchen-1.mp4" playsinline=""></video><figcaption>Source: <a href="https://store.steampowered.com/app/1222670/The_Sims_4/" data-type="link" data-id="https://store.steampowered.com/app/1222670/The_Sims_4/" target="_blank" rel="noreferrer noopener">Sims 4</a></figcaption></figure>



<p>Another example while seated:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/sims4_table-1.mp4" playsinline=""></video><figcaption>Source: <a href="https://store.steampowered.com/app/1222670/The_Sims_4/" data-type="link" data-id="https://store.steampowered.com/app/1222670/The_Sims_4/" target="_blank" rel="noreferrer noopener">Sims 4</a></figcaption></figure>



<p>The same in Watchdog Legions. However, the <strong>shape</strong> of the lower leg changes here as it is slightly compressed:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/watchdogs_comparison-1.mp4" playsinline=""></video><figcaption>Source: <a href="https://store.steampowered.com/app/2239550/Watch_Dogs_Legion/" data-type="link" data-id="https://store.steampowered.com/app/2239550/Watch_Dogs_Legion/" target="_blank" rel="noreferrer noopener">Watchdog Legions</a></figcaption></figure>



<p>And another example, this time from Cyberpunk:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/cyberpunk_01.mp4" playsinline=""></video><figcaption>Source: <a href="https://www.cyberpunk.net/" data-type="link" data-id="https://www.cyberpunk.net" target="_blank" rel="noreferrer noopener">Cyberpunk 2077</a></figcaption></figure>



<p>Normally the leg geometry is exchanged for a different one. Theoretically, <strong>blend shapes</strong> could also be used, but these are <strong>expensive</strong>.</p>



<p>⚠️ <strong>Important</strong>: Only the mesh changes, <strong>not</strong> the skeleton. This means that the ankle around which the foot rotates still has the same position:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/blender_ankle_demo-1.mp4" playsinline=""></video></figure>



<p>This can lead to strong visual distortions like in Final Fantasy 14:</p>





<p>In contrast, the ankle should be at this point when wearing high heels. Of course, you can never switch to flat shoes in Nier, so they could fit the skeleton perfectly:</p>





<h3>🦵 3. Bend</h3>



<p>Here’s a nice example where sychnorized character heights are very important (otherwise the lips wouldn’t meet when kissing), but <strong>instead</strong> of shortening the lower leg, the legs are simply <strong>bent</strong> a bit more:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/3dsv-1.mp4" playsinline=""></video><figcaption>Source: <a href="https://www.thrixxx.com/games/" data-type="link" data-id="https://www.thrixxx.com/games/" target="_blank" rel="noreferrer noopener">3D Sex Villa 2</a></figcaption></figure>



<h2 id="posture">Posture</h2>



<p>If you want to do it right, it’s <strong>not enough</strong> to just lift the hips and turn the feet into the “high heel” pose. According to <a href="https://www.oceansidepodiatrist.com/blog/item/1212-the-impact-of-high-heels-on-walking" data-type="link" data-id="https://www.oceansidepodiatrist.com/blog/item/1212-the-impact-of-high-heels-on-walking" target="_blank" rel="noreferrer noopener">this</a> and <a href="https://www.learningmethods.com/downloads/pdf/rossi--why.shoes.make.normal.gait.impossible.pdf" data-type="link" data-id="https://www.learningmethods.com/downloads/pdf/rossi--why.shoes.make.normal.gait.impossible.pdf" target="_blank" rel="noreferrer noopener">this article</a>, the whole posture changes! The main differences:</p>



<ul>
<li>redistribution of body weight</li>



<li>forward tilted pelvis, spine arches gently</li>



<li>engaged calf muscles</li>



<li>accentuated curve of the buttocks</li>
</ul>





<p>I tried to adapt this to my zombie by doing the following (I refrained from doing a blended shape for a fuller bum though):</p>



<ul>
<li>Raise the hips</li>



<li>Rotate the feet (so that they meet the floor again)</li>



<li>Redistribute the body weight by tilting the pelvis and arch the spine</li>
</ul>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/zombie_posture_high_heel.mp4" playsinline=""></video><figcaption>Source: <a href="https://www.mixamo.com/#/?page=1&amp;type=Character" data-type="link" data-id="https://www.mixamo.com/#/?page=1&amp;type=Character" target="_blank" rel="noreferrer noopener">Mixamo “Romero”</a></figcaption></figure>



<p>And I did a test with a walking animation. I added my posture change as an <strong>additive</strong> to a mixamo walking animation and it worked! Check out my sexy zombie :)</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/zombie_walk_high_heels-1.mp4" playsinline=""></video><figcaption>Source: <a href="https://www.mixamo.com/#/?page=1&amp;type=Character" data-type="link" data-id="https://www.mixamo.com/#/?page=1&amp;type=Character" target="_blank" rel="noreferrer noopener">Mixamo “IV Pole Walking</a></figcaption></figure>



<p>By the way #1, I noticed a little detail in Cyberpunk: when the shoe is swapped, we can briefly see how the foot pose changes:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/cyberpunk_02.mp4" playsinline=""></video><figcaption>Source: <a href="https://www.cyberpunk.net/" data-type="link" data-id="https://www.cyberpunk.net" target="_blank" rel="noreferrer noopener">Cyberpunk 2077</a></figcaption></figure>



<p>By the way #2: If you want to be really precise, you should also change the orientation of your big toe, as it is often squeezed unnaturally into the shoe:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/foot_in_high_heel.mp4" playsinline=""></video><figcaption>Source: <a href="https://youtu.be/dq9oyn9OlgA" data-type="link" data-id="https://youtu.be/dq9oyn9OlgA" target="_blank" rel="noreferrer noopener">Foot in High Heel Turntable</a></figcaption></figure>



<h2 id="animation">Animation</h2>



<p>Apart from height and posture, you may also need to change the entire animation, as high heels can drastically alter the gait:</p>



<p><em><a href="https://www.oceansidepodiatrist.com/blog/item/1212-the-impact-of-high-heels-on-walking" data-type="link" data-id="https://www.oceansidepodiatrist.com/blog/item/1212-the-impact-of-high-heels-on-walking">“High heels encourage shorter, more deliberate strides, leading to a smoother and more controlled walking motion”</a></em></p>



<p><a href="http://dyros.snu.ac.kr/project/human-gait-analysis-using-3d-motion-capture/" data-type="link" data-id="http://dyros.snu.ac.kr/project/human-gait-analysis-using-3d-motion-capture/" target="_blank" rel="noreferrer noopener">This article</a> even provides a little graphic showing the changes. They did a lot of motion capture analysis with 12 women:</p>





<p>And here we are at <strong>another</strong> cross road for game developers!</p>


<div>
<figure><a href="https://simonschreibt.de/wp-content/uploads/2025/03/meme_unique_anims.jpg"><img loading="lazy" decoding="async" width="500" height="756" src="https://simonschreibt.de/wp-content/uploads/2025/03/meme_unique_anims.jpg" alt="" srcset="https://simonschreibt.de/wp-content/uploads/2025/03/meme_unique_anims.jpg 500w, https://simonschreibt.de/wp-content/uploads/2025/03/meme_unique_anims-198x300.jpg 198w" sizes="auto, (max-width: 500px) 100vw, 500px"></a></figure></div>


<p>If you’ve decided to reuse only the flat shoe animations, don’t sweat it! I’ll give you two reasons not to worry too much:</p>



<ol>
<li>Other developers do the same</li>



<li>Even in high heels a “normal” walk is possible</li>
</ol>



<h3>😊 1. Other developers do the same</h3>



<p>Most games simply reuse their animations. The only example I could find where <strong>custom animations</strong> are used is a Skyrim <strong>MOD</strong>! There, the animation of the high heels leads to a crossing of the legs and a more accentuated hip movement:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/skyrim_conditional_high_heel_walk-1.mp4" playsinline=""></video><figcaption>Source: <a href="https://www.nexusmods.com/skyrimspecialedition/mods/75174" data-type="link" data-id="https://www.nexusmods.com/skyrimspecialedition/mods/75174" target="_blank" rel="noreferrer noopener">Conditional High Heel Walk</a></figcaption></figure>



<p>And yes, it is true that such a gait can be observed in real life:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/walk_male_female.mp4" playsinline=""></video><figcaption>Source: <a href="https://www.youtube.com/shorts/2DriKlNOJcc" data-type="link" data-id="https://www.youtube.com/shorts/2DriKlNOJcc" target="_blank" rel="noreferrer noopener">Who says men not walk in heels</a></figcaption></figure>



<p>But…</p>



<h3>👠 2. “Normal” Walk in High Heels</h3>



<p>Such a <strong>cross-over</strong> gait is also possible with <strong>FLAT shoes (left)</strong>, while a moderate cross-over (center) or no cross-over at all (right) is also possible with high heels:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/walk_female_high_heel_vs_flat.mp4" playsinline=""></video><figcaption>Source: <a href="https://www.shutterstock.com/video/search/models/1058618608" data-type="link" data-id="https://www.shutterstock.com/video/search/models/1058618608" target="_blank" rel="noreferrer noopener">Shutterstock</a></figcaption></figure>



<p>So wearing high heels <strong>doesn’t</strong> mean that your legs <strong>automatically</strong> cross and your hips go crazy. But if that’s what you want and your game “only” offers flat shoes, you can still do it. Anything is possible!</p>



<p>By the way, not even Nikki has a unique animation per shoe and this game is all about outfits and dressing in style:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/nikki_03.mp4" playsinline=""></video><figcaption>Source: <a href="https://store.epicgames.com/fr/p/infinity-nikki-71fc64" data-type="link" data-id="https://store.epicgames.com/fr/p/infinity-nikki-71fc64" target="_blank" rel="noreferrer noopener">Infinity Nikki</a></figcaption></figure>



<p>What they do have, however, are different idle animations. I counted <strong>four different</strong> ones, depending on which shoe you’re wearing. That’s quite a lot in my eyes:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/nikki_02.mp4" playsinline=""></video><figcaption>Source: <a href="https://store.epicgames.com/fr/p/infinity-nikki-71fc64" data-type="link" data-id="https://store.epicgames.com/fr/p/infinity-nikki-71fc64" target="_blank" rel="noreferrer noopener">Infinity Nikki</a></figcaption></figure>



<h2 id="clipping">Optimization</h2>



<p>What happens to the polygons of the leg when it is covered by a shoe? Good handling can help prevent clipping, and of course it’s a nice optimization. </p>



<p>This is what we want to prevent:</p>





<p>Some games hide the polygons inside shoes. In Saints Row, the legs are made up of different pieces and can be hidden if necessary:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/sr5_wireframe.mp4" playsinline=""></video><figcaption>Source: <a href="https://store.steampowered.com/app/742420/Saints_Row/" data-type="link" data-id="https://store.steampowered.com/app/742420/Saints_Row/" target="_blank" rel="noreferrer noopener">Saints Row</a></figcaption></figure>



<p>Watchdogs is also an interesting example:</p>



<ul>
<li><strong>Left</strong>: The whole leg is a <strong>single draw call</strong> and it is complete (the toes are there, even though they are covered by the shoe)</li>



<li><strong>Right</strong>: same location, only with a flat shoe. Now the leg is made up of <strong>multiple meshes</strong> (aka draw calls). I’m not sure why, as both shoes show about the same amount of skin…. strange! But in this case, the toes are optimized away!</li>
</ul>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/watchdogs_comparison_wireframe.mp4" playsinline=""></video><figcaption>Source: <a href="https://store.steampowered.com/app/2239550/Watch_Dogs_Legion/" data-type="link" data-id="https://store.steampowered.com/app/2239550/Watch_Dogs_Legion/" target="_blank" rel="noreferrer noopener">Watchdog Legions</a></figcaption></figure>



<p>Here is a static comparison of how the game handles the reduction of polygons:</p>



<ul>
<li>High Heels: Full leg (with toes) is used.</li>



<li>Flats: Leg made of several pieces; Toes are removed.</li>



<li>Boots: Leg made of several pieces; Lower leg removed.</li>
</ul>





<p>And cyberpunk? They just keep the whole leg, even if the boots are massive and cover most of it!</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/cyberpunk_03.mp4" playsinline=""></video><figcaption>Source: <a href="https://www.cyberpunk.net/" data-type="link" data-id="https://www.cyberpunk.net" target="_blank" rel="noreferrer noopener">Cyberpunk 2077</a></figcaption></figure>



<h2 id="audio">Audio</h2>



<p>Depending on whether the shoe has a stiletto heel, the steps should sound different. The same applies if you are not wearing any shoes at all (barefoot). Cyberpunk does a good job here:</p>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/cyberpunk_footstep_sound.mp4" playsinline=""></video><figcaption>Source: <a href="https://www.cyberpunk.net/" data-type="link" data-id="https://www.cyberpunk.net" target="_blank" rel="noreferrer noopener">Cyberpunk 2077</a></figcaption></figure>



<p>If you’re playing a <strong>competitive game</strong>, high heels might give away the player’s position more easily as they’re usually louder. This could be a balancing issue!</p>



<h2 id="bonus">Bonus Work</h2>



<p>You’ve already built high heels into your game, everything works perfectly and now you’re bored? Here are some challenges:</p>



<ul>
<li>Implement a real-time muscle simulation to fulfill this: <em><a href="https://www.oceansidepodiatrist.com/blog/item/1212-the-impact-of-high-heels-on-walking" data-type="link" data-id="https://www.oceansidepodiatrist.com/blog/item/1212-the-impact-of-high-heels-on-walking" target="_blank" rel="noreferrer noopener">“The lifted heel also engages the calf muscles and accentuates the curve of the buttocks […]”</a></em>.</li>



<li>If you do a life-simulation where people can get injuries, you can implement long-term side effects of wearing high heels like joint degeneration, shrinking calf muscles, nerve tissue thickening and many more (<a href="https://youtu.be/tyeIaTJ0IEE" data-type="link" data-id="https://youtu.be/tyeIaTJ0IEE" target="_blank" rel="noreferrer noopener">source video</a>). Does Dwarf Fortress simulate this already?</li>



<li>Implement a “Sink into the ground” feature depending on the heel and soil type:</li>
</ul>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/realworld_01_grass.mp4" playsinline=""></video><figcaption>Source: <a href="https://youtu.be/dHlMLmL8mco" data-type="link" data-id="https://youtu.be/dHlMLmL8mco" target="_blank" rel="noreferrer noopener">Ultimate Heel Guards for Walking on Grass</a></figcaption></figure>



<ul>
<li>Implement a higher range and damage for fighters wearing high heels but also add a 5% chance that they slip and need a long pause to recover:</li>
</ul>



<figure><video controls="" loop="" muted="" src="https://simonschreibt.de/wp-content/uploads/2025/03/realworld_01_fight_and_fail.mp4" playsinline=""></video><figcaption>Source: <a href="https://youtube.com/shorts/aj81fNQFYH0?si=SullodiHCRVwOput" data-type="link" data-id="https://youtube.com/shorts/aj81fNQFYH0?si=SullodiHCRVwOput" target="_blank" rel="noreferrer noopener">#1</a> <a href="https://youtu.be/C-cqUj99zMI" data-type="link" data-id="https://youtu.be/C-cqUj99zMI" target="_blank" rel="noreferrer noopener">#2</a></figcaption></figure>



<h2 id="summary">Summary</h2>



<ul>
<li>Supporting different shoe types may change the characters height and foot orientation (and maybe hit volumes).</li>



<li>If precise interaction with the environment or NPCs is necessary, the consequences for the height change require solutions (unique animations, IK systems) or workarounds (shorten lower legs, bent legs)</li>



<li>Different shoe types may also change the posture, gait and footstep sound (the latter could pose a balance problem in competitive games).</li>



<li>Many games use the same animation for all shoe types (but special cases such as motorcycling or sneaking with high heels may require special attention).</li>



<li>Sometimes the polygons that are covered by the shoe are removed for optimization (can also prevent clipping). Usually meshes are swapped as blend shapes are too expensive.</li>



<li>A graceful gait (crossed legs, accentuated hips) is also possible with flat shoes, while a “normal” gait is also possible with high heels.</li>
</ul>



<h2>History Lesson</h2>



<p>Originally, men started wearing high heels and then women adopted – <em><a href="https://www.bbc.com/news/magazine-21151350" data-type="link" data-id="https://www.bbc.com/news/magazine-21151350" target="_blank" rel="noreferrer noopener">“it was in an effort to masculinise their outfits”</a></em>.</p>


<div>
<figure><img loading="lazy" decoding="async" width="610" height="1002" src="https://simonschreibt.de/wp-content/uploads/2025/03/king-2.png" alt="" srcset="https://simonschreibt.de/wp-content/uploads/2025/03/king-2.png 610w, https://simonschreibt.de/wp-content/uploads/2025/03/king-2-183x300.png 183w" sizes="auto, (max-width: 610px) 100vw, 610px"></figure></div>


<h2 id="sources">Sources</h2>



<h2>Articles &amp; Studies</h2>



<ul>
<li>The Impact of High Heels on Walking <a href="https://www.oceansidepodiatrist.com/blog/item/1212-the-impact-of-high-heels-on-walking">https://www.oceansidepodiatrist.com/blog/item/1212-the-impact-of-high-heels-on-walking</a></li>



<li>Wearing high heels – Scholl Biomechanics <a href="https://youtu.be/xlnmvALaMZg">https://youtu.be/xlnmvALaMZg</a></li>



<li>The influence of high heeled shoes on balance ability and walking in healthy women <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC6047962/">https://pmc.ncbi.nlm.nih.gov/articles/PMC6047962/</a></li>



<li>Human Gait Analysis using 3D Motion Capture <a href="http://dyros.snu.ac.kr/project/human-gait-analysis-using-3d-motion-capture/?ckattempt=1">http://dyros.snu.ac.kr/project/human-gait-analysis-using-3d-motion-capture/?ckattempt=1</a></li>



<li>Walking in High Heels: The Physics Behind the Physique <a href="https://illumin.usc.edu/walking-in-high-heels-the-physics-behind-the-physique/">https://illumin.usc.edu/walking-in-high-heels-the-physics-behind-the-physique/</a></li>



<li>Platinum Blog Near Automata <a href="https://www.platinumgames.com/official-blog/article/8997">https://www.platinumgames.com/official-blog/article/8997</a></li>



<li>Walking in high-heel shoes induces redistribution of joint power and work <a href="https://pmc.ncbi.nlm.nih.gov/articles/PMC10291901/">https://pmc.ncbi.nlm.nih.gov/articles/PMC10291901/</a></li>
</ul>



<h2>References</h2>



<ul>
<li><a href="https://www.shutterstock.com/video/search/woman-walk-side-view-heels">https://www.shutterstock.com/video/search/woman-walk-side-view-heels</a></li>



<li><a href="https://www.shutterstock.com/video/search/walk-side-view">https://www.shutterstock.com/video/search/walk-side-view</a></li>



<li>Anatomy for Sculptors <a href="https://www.artstation.com/artwork/Vy3dXn">https://www.artstation.com/artwork/Vy3dXn</a></li>



<li>SKAMotion 3D walk cycles <a href="https://www.youtube.com/@SKAmotion/videos">https://www.youtube.com/@SKAmotion/videos</a></li>



<li>Rapa Motion Female Heels (Motion Capture Animations for Unreal Engine) <a href="https://youtu.be/RJWVI_6cgJU">https://youtu.be/RJWVI_6cgJU</a></li>
</ul>



<h2>Tutorials &amp; Discussions</h2>



<h3>General</h3>



<ul>
<li><a href="https://forums.cgarchitect.com/topic/72061-axyz-women-in-heels-and-mocap/" data-type="link" data-id="https://forums.cgarchitect.com/topic/72061-axyz-women-in-heels-and-mocap/" target="_blank" rel="noreferrer noopener">axyz women in heels and mocap</a></li>



<li><a href="https://www.reddit.com/r/gamedev/comments/1efzail/how_do_devs_implement_changeable_footwear_for/" data-type="link" data-id="https://www.reddit.com/r/gamedev/comments/1efzail/how_do_devs_implement_changeable_footwear_for/" target="_blank" rel="noreferrer noopener">how do devs implement changeable footwear for female characters?</a></li>



<li><a href="https://www.reddit.com/r/cyberpunkgame/comments/sfelrs/this_is_not_how_high_heels_work/" data-type="link" data-id="https://www.reddit.com/r/cyberpunkgame/comments/sfelrs/this_is_not_how_high_heels_work/" target="_blank" rel="noreferrer noopener">this is not how high heels work</a></li>



<li><a href="https://docs.google.com/document/d/1Z8-J7LGmXsN6epwl5MrsRo6rPvmwtuic3eyYyyMw9TI" data-type="link" data-id="https://docs.google.com/document/d/1Z8-J7LGmXsN6epwl5MrsRo6rPvmwtuic3eyYyyMw9TI" target="_blank" rel="noreferrer noopener">Conant Exiles High Heel Modder Guide</a></li>
</ul>



<h3>Blender</h3>



<ul>
<li>Blender rigging heels <a href="https://www.youtube.com/watch?v=bV2jn57oJ4c">https://www.youtube.com/watch?v=bV2jn57oJ4c</a></li>



<li>Heel rigging in 60s <a href="https://www.youtube.com/watch?v=voYM3yyeZP4">https://www.youtube.com/watch?v=voYM3yyeZP4</a></li>



<li>Royal skies rigging <a href="https://www.youtube.com/@TheRoyalSkies/videos">https://www.youtube.com/@TheRoyalSkies/videos</a></li>



<li>How to Use Mixamo Animations in Blender 4.2 <a href="https://youtu.be/F25_c-Q0_Qw">https://youtu.be/F25_c-Q0_Qw</a></li>
</ul>



<h3>Maya</h3>



<ul>
<li>Maya Reverse Footroll Rigging <a href="https://www.artstation.com/blogs/dcbittorf/2ZYN/rigging-a-foot-roll-in-maya-using-a-reverse-foot">https://www.artstation.com/blogs/dcbittorf/2ZYN/rigging-a-foot-roll-in-maya-using-a-reverse-foot</a></li>
</ul>



<h3>Unity</h3>



<ul>
<li>unity heel flat transform <a href="https://www.youtube.com/shorts/tLZ0cRhAjeM">https://www.youtube.com/shorts/tLZ0cRhAjeM</a></li>



<li>Final IK: Interaction System (grabbing objects) <a href="https://youtu.be/RdSfLkFHTWM">https://youtu.be/RdSfLkFHTWM</a></li>



<li>Learn Procedural Animation in Unity <a href="https://youtu.be/cg_vXWPaG8A">https://youtu.be/cg_vXWPaG8A</a></li>



<li>How to handle high heel footwear in Unity characters/rigs? <a href="https://discussions.unity.com/t/how-to-handle-high-heel-footwear-in-unity-characters-rigs/59685">https://discussions.unity.com/t/how-to-handle-high-heel-footwear-in-unity-characters-rigs/59685</a></li>
</ul>



<h3>Unreal</h3>



<ul>
<li>UE5 – Fix High Heels – TPS Template <a href="https://youtu.be/a58-dactGuU">https://youtu.be/a58-dactGuU</a></li>



<li>Feet IK Improvement with ControlRig <a href="https://youtu.be/Yho2BOrBnQs">https://youtu.be/Yho2BOrBnQs</a></li>



<li>High Heels and flat feet help <a href="https://forums.unrealengine.com/t/high-heels-and-flat-feet-help/147715/5">https://forums.unrealengine.com/t/high-heels-and-flat-feet-help/147715/5</a></li>



<li>How to adapt High Heel shoe in Metahuman? <a href="https://forums.unrealengine.com/t/how-to-adapt-high-heel-shoe-in-metahuman/650189">https://forums.unrealengine.com/t/how-to-adapt-high-heel-shoe-in-metahuman/650189</a></li>



<li>heels on meta human <a href="https://forums.unrealengine.com/t/attaching-high-heels-to-metahuman-resolved/1190673/5">https://forums.unrealengine.com/t/attaching-high-heels-to-metahuman-resolved/1190673/5</a></li>



<li>How to add custom clothing onto Metahumans in Unreal Engine using Blender <a href="https://youtu.be/3_b60jkuDMY">https://youtu.be/3_b60jkuDMY</a></li>



<li>Daz To Unreal – Dealing with Heels <a href="https://davidvodhanel.com/daz-to-unreal-dealing-with-heels/">https://davidvodhanel.com/daz-to-unreal-dealing-with-heels/</a></li>



<li>Unreal Engine 5.5: Hand Holding Mechanics <a href="https://youtu.be/x8I2Xi8bRL8">https://youtu.be/x8I2Xi8bRL8</a></li>



<li>Unreal Engine 4 Tutorial – Hands IK <a href="https://youtu.be/xsvvA042l98">https://youtu.be/xsvvA042l98</a></li>



<li>Unreal Engine IK Rig Example Setup <a href="https://dev.epicgames.com/documentation/en-us/unreal-engine/ik-rig-in-unreal-engine">https://dev.epicgames.com/documentation/en-us/unreal-engine/ik-rig-in-unreal-engine</a></li>
</ul>


<div>
<figure><a href="https://simonschreibt.de/wp-content/uploads/2025/03/image-2.png"><img loading="lazy" decoding="async" width="1024" height="435" src="https://simonschreibt.de/wp-content/uploads/2025/03/image-2-1024x435.png" alt="" srcset="https://simonschreibt.de/wp-content/uploads/2025/03/image-2-1024x435.png 1024w, https://simonschreibt.de/wp-content/uploads/2025/03/image-2-300x127.png 300w, https://simonschreibt.de/wp-content/uploads/2025/03/image-2-768x326.png 768w, https://simonschreibt.de/wp-content/uploads/2025/03/image-2-1536x652.png 1536w, https://simonschreibt.de/wp-content/uploads/2025/03/image-2-624x265.png 624w, https://simonschreibt.de/wp-content/uploads/2025/03/image-2.png 1637w" sizes="auto, (max-width: 1024px) 100vw, 1024px"></a><figcaption>Unreal Content Example Map: IK Rig</figcaption></figure></div>


<h2>Wearing Examples</h2>



<ul>
<li>heels walk male/female <a href="https://www.youtube.com/shorts/2DriKlNOJcc">https://www.youtube.com/shorts/2DriKlNOJcc</a></li>



<li>heels dance <a href="https://www.youtube.com/shorts/-ymWhRhoQ2o">https://www.youtube.com/shorts/-ymWhRhoQ2o</a></li>



<li>extreme plateau heels jump <a href="https://www.youtube.com/shorts/L-rvdMHA9ec">https://www.youtube.com/shorts/L-rvdMHA9ec</a></li>



<li>extreme plateau <a href="https://www.youtube.com/shorts/79n-62kQttA">https://www.youtube.com/shorts/79n-62kQttA</a></li>



<li>fighting in heels <a href="https://www.tiktok.com/@blumineck/video/7282440261223992609">https://www.tiktok.com/@blumineck/video/7282440261223992609</a></li>



<li>kicking in heels <a href="https://youtube.com/shorts/aj81fNQFYH0?si=aMkDqtuLvbueOWib">https://youtube.com/shorts/aj81fNQFYH0?si=aMkDqtuLvbueOWib</a></li>



<li>convertible <a href="https://www.youtube.com/shorts/1pHgqF5M-74">https://www.youtube.com/shorts/1pHgqF5M-74</a></li>
</ul>



<h2>Effect on Health</h2>



<ul>
<li><a href="https://youtu.be/tyeIaTJ0IEE" data-type="link" data-id="https://youtu.be/tyeIaTJ0IEE" target="_blank" rel="noreferrer noopener">High Heels Change Your Bone Anatomy</a></li>



<li><a href="https://brightside.me/articles/what-can-happen-to-your-body-if-you-wear-high-heels-every-day-801163/" data-type="link" data-id="https://brightside.me/articles/what-can-happen-to-your-body-if-you-wear-high-heels-every-day-801163/" target="_blank" rel="noreferrer noopener">What Can Happen to Your Body If You Wear High Heels Every Day</a></li>



<li><a href="https://www.functionalps.com/blog/2012/12/20/high-heeled-shoes-a-real-pain/">High Heeled Shoes: A Real Pain</a></li>



<li><a href="https://www.learningmethods.com/downloads/pdf/rossi--why.shoes.make.normal.gait.impossible.pdf" data-type="link" data-id="https://www.learningmethods.com/downloads/pdf/rossi--why.shoes.make.normal.gait.impossible.pdf">Why Shoes Make “Normal” Gait Impossible</a></li>
</ul>
					</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Show HN: OpenTimes – Free travel times between U.S. Census geographies (186 pts)]]></title>
            <link>https://opentimes.org</link>
            <guid>43392521</guid>
            <pubDate>Mon, 17 Mar 2025 20:40:52 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://opentimes.org">https://opentimes.org</a>, See on <a href="https://news.ycombinator.com/item?id=43392521">Hacker News</a></p>
<div id="readability-page-1" class="page"><header><nav><ul><li><a href="https://opentimes.org/about" title="Link to about page">About</a></li><li><a href="https://github.com/dfsnow/opentimes?tab=readme-ov-file#getting-the-data" title="Link to data documentation">Data</a></li></ul><p><a href="https://github.com/dfsnow/opentimes" title="GitHub"><svg aria-label="GitHub" role="img" viewBox="0 0 512 512" width="1.6em" height="1.6em"><title>GitHub</title><path fill-rule="evenodd" d="M50 0h412a50 50 0 0150 50v412a50 50 0 01-50 50H50A50 50 0 010 462V50A50 50 0 0150 0zM335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"></path></svg>
</a><a href="https://opentimes.org/cdn-cgi/l/email-protection#2e474048416e415e4b405a47434b5d00415c49" title="Email"><svg aria-label="Email" role="img" viewBox="0 0 512 512" width="1.6em" height="1.6em"><title>Email</title><path fill-rule="evenodd" d="M50 0h412a50 50 0 0150 50v412a50 50 0 01-50 50H50A50 50 0 010 462V50A50 50 0 0150 0zm52 128 154 144 154-144zM78 152l98 92-98 116zm358 0-98 92 98 116zM102 384l98-116 26 24a62 96 0 0060 0l26-24 98 116z"></path></svg></a></p></nav></header><main></main></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Archival Storage (323 pts)]]></title>
            <link>https://blog.dshr.org/2025/03/archival-storage.html</link>
            <guid>43391459</guid>
            <pubDate>Mon, 17 Mar 2025 18:36:21 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://blog.dshr.org/2025/03/archival-storage.html">https://blog.dshr.org/2025/03/archival-storage.html</a>, See on <a href="https://news.ycombinator.com/item?id=43391459">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="post-body-1202710059733316917" itemprop="description articleBody"><p>
I gave a talk at the Berkeley I-school's <a href="https://www.ischool.berkeley.edu/events/ias">Information Access Seminar</a> entitled <i>Archival Storage</i>. Below the fold is the text of the talk with links to the sources and the slides (with yellow background).<br>
<span><a name="more"></a></span></p><p><i>Don't, don't, don't, don't believe the hype!</i><br>
Public Enemy<br>
</p>
<h2>Introduction</h2><p>
I'm honored to appear in what I believe is the final series of these seminars. Most of my previous appearances have focused on debunking some conventional wisdom, and this one is no exception. My parting gift to you is to stop you wasting time and resources on yet another seductive but impractical idea — that the solution to storing archival data is quasi-immortal media. As usual, you don't have to take notes. The full text of my talk with the slides and links to the sources will go up on my blog shortly after the seminar.</p><h2>Backups</h2>
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgXKlNGhJKcHdX4_k6tqmciQHF7bSn3qg5ytFYOIkZhGgB-fsJC3G5qdJQA2Lfni9EsxDaM5s5CDDjPb3t1o6MqhTn2iY7nz3bsL_MDlIR6hX0PE25SbGdCVE7AFOaxe6nsaW2RxVWsUSeDb7mnrJF24Tz_nR-QPzwbuqV3rDcKFEz7BIV_EYKuJ4RZZk-k/s5184/Backups.JPG"><img data-original-height="5184" data-original-width="3888" height="320" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgXKlNGhJKcHdX4_k6tqmciQHF7bSn3qg5ytFYOIkZhGgB-fsJC3G5qdJQA2Lfni9EsxDaM5s5CDDjPb3t1o6MqhTn2iY7nz3bsL_MDlIR6hX0PE25SbGdCVE7AFOaxe6nsaW2RxVWsUSeDb7mnrJF24Tz_nR-QPzwbuqV3rDcKFEz7BIV_EYKuJ4RZZk-k/s320/Backups.JPG" width="240"></a>
</p><p>
Archival data is often confused with backup data. Everyone should back up their data. After nearly two decades working in digital preservation, here is how I back up my four important systems:</p><ul>
  <li>I run my own mail and Web server. It is on my DMZ network, exposed to the Internet. It is backed up to a Raspberry Pi, also on the DMZ network but not directly accessible from the Internet. Once a week there is a full backup, and daily an incremental backup. Every week the full and incremental backups for the week are written to two DVD-Rs.</li>
  <li>My desktop PC creates a full backup on an external hard drive nightly. The drive is one of a cycle of three.</li>
  <li>I back up my iPhone to my Mac Air laptop every day.</li>
  <li>I create a Time Machine backup of my Mac Air laptop, which includes the most recent iPhone backup, every day on one of a cycle of <a href="https://blog.dshr.org/2024/01/a-lesson-learned.html">three external SSDs</a>.</li>
</ul><p>
Each week the DVD-Rs, the current SSD and the current hard drive are moved off-site. Why am I doing all this? In case of disasters such as fire or ransomware I want to be able to recover to a state as close as possible to that before the disaster. In my case, the worst case is not more than one week.</p><p>

Note the implication that the useful life of backup data is only the time that elapses between the last backup before a disaster and the recovery. Media life span is irrelevant to backup data; that is why backups and archiving are <i>completely different problems</i>.</p><p>

The fact that the data encoded in magnetic grains on the platters of the three hard drives is <a href="https://www.abitare.org/papers/ISandT2008.pdf">good for a quarter-century</a> is interesting but irrelevant to the backup task.</p><div>
<table cols="5">
<thead>
<tr><td>Month</td><td>Media</td><td>Good</td><td>Bad</td><td>Vendor</td>
</tr>
</thead>
<tbody>
<tr><td>01/04</td><td>CD-R</td><td>5x</td><td>0</td><td>GQ</td></tr>
<tr><td>05/04</td><td>CD-R</td><td>5x</td><td>0</td><td>Memorex</td></tr>
<tr><td>02/06</td><td>CD-R</td><td>5x</td><td>0</td><td>GQ</td></tr>
<tr><td>11/06</td><td>DVD-R</td><td>5x</td><td>0</td><td>GQ</td></tr>
<tr><td>12/06</td><td>DVD-R</td><td>1x</td><td>0</td><td>GQ</td></tr>
<tr><td>01/07</td><td>DVD-R</td><td>4x</td><td>0</td><td>GQ</td></tr>
<tr><td>04/07</td><td>DVD-R</td><td>3x</td><td>0</td><td>GQ</td></tr>
<tr><td>05/07</td><td>DVD-R</td><td>2x</td><td>0</td><td>GQ</td></tr>
<tr><td>07/11</td><td>DVD-R</td><td>4x</td><td>0</td><td>Verbatim</td></tr>
<tr><td>08/11</td><td>DVD-R</td><td>1x</td><td>0</td><td>Verbatim</td></tr>
<tr><td>05/12</td><td>DVD+R</td><td>2x</td><td>0</td><td>Verbatim</td></tr>
<tr><td>06/12</td><td>DVD+R</td><td>3x</td><td>0</td><td>Verbatim</td></tr>
<tr><td>04/13</td><td>DVD+R</td><td>2x</td><td>0</td><td>Optimum</td></tr>
<tr><td>05/13</td><td>DVD+R</td><td>3x</td><td>0</td><td>Optimum</td></tr>
</tbody>
</table>
</div><p>
I have saved many hundreds of pairs of weekly DVD-Rs but the only ones that are ever accessed more than a few weeks after being written are the ones I use for my annual series of <a href="https://blog.dshr.org/2024/08/2024-optical-media-durability-update.html"><i>Optical Media Durability Update</i></a> posts. It is interesting that:</p><blockquote>
  with no special storage precautions, generic low-cost media, and consumer drives, I'm getting good data from CD-Rs more than 20 years old, and from DVD-Rs nearly 18 years old.
</blockquote><p>
But the DVD-R media lifetime is not why I'm writing backups to them. The attribute I'm interested in is that DVD-Rs are <i>write-once</i>; the backup data could be destroyed but it can't be modified.</p><p>

Note that the good data from 18-year-old DVD-Rs means that consumers have an affordable, effective archival technology. But the market for optical media and drives is dying, killed off by streaming, which suggests that consumers don't really care about archiving their data. Cathy Marshall's 2008 talk <a href="http://www.usenix.org/events/fast08/tech/marshall.pdf"><i>Its Like A Fire, You Just Have To Move On</i></a> vividly describes this attitude. Her subtitle is "Rethinking personal digital archiving".</p><h2>Archival Data</h2>
<div>
<ul>
<li>Over time, data falls down the storage hierarchy.</li>
<li>Data is archived when it can't earn its keep on near-line media.</li>
<li>Lower cost is purchased with longer access latency.</li>
</ul>
</div><p>
What is a useful definition of archival data? It is data that can no longer earn its keep on readily accessible storage. Thus the fundamental design goal for archival storage systems is to reduce costs by tolerating increased access latency. Data is archived, that is moved to an archival storage system, to save money. Archiving is an <i>economic</i> rather than a technical issue.</p><p>
How long should the archived data last? The <a href="https://longnow.org/">Long Now Foundation</a> is building the <a href="https://longnow.org/clock/">Clock of the Long Now</a>, intended to keep time for 10,000 years. They would like to accompany it with a 10,000-year archive. That is at least two orders of magnitude longer than I am talking about here. We are only just over 75 years from the <a href="https://en.wikipedia.org/wiki/Manchester_Baby">first stored-program computer</a>, so designing a digital archive for a century is a very ambitious goal.</p><h2>Archival Media</h2>
<p>
The mainstream media occasionally comes out with an announcement like this from the <i>Daily Mail</i> in 2013. Note the extrapolation from "a 26 second excerpt" to "every film and TV program ever created in a teacup".</p><p>
Six years later, this is a picture of, as far as I know, the only write-to-read DNA storage drive ever demonstrated. It is from the Microsoft/University of Washington team that has done much of the research in DNA storage. They published it in 2019's <a href="https://doi.org/10.1038/s41598-019-41228-8"><i>Demonstration of End-to-End Automation of DNA Data Storage</i></a>. It cost about $10K and took 21 hours to write then read 5 bytes. </p><p>

 The technical press is equally guilty.  The canonical article about some development in the lab starts with the famous IDC graph projecting the amount of data that will be generated in the future. It goes on to describe the amazing density some research team achieved by writing say a gigabyte into their favorite medium in the lab, and how this density could store all the world's data in a teacup for ever. This conveys five false impressions.</p><h3>Market Size</h3><p>
First, that there is some possibility the researchers could scale their process up to a meaningful fraction of IDC's projected demand, or even to the microscopic fraction of the projected demand that makes sense to archive. There is no such possibility. Archival media is a much <i>smaller</i> market than regular media. In 2018's <a href="https://blog.dshr.org/2018/03/archival-media-not-good-business.html"><i>Archival Media: Not a Good Business</i></a> I wrote:</p><blockquote>

Archival-only media such as <a href="http://www.digitalpreservation.gov/meetings/DSA2016/Day2/HUMMEL_G47-Bit_Plane_Image-Live_Fast_Pitch.pdf">steel tape</a>, <a href="https://www.storagenewsletter.com/2014/10/31/rd-hitachi-rw-of-digital-data-in-fused-silica-glass/">silica DVDs</a>, <a href="http://phys.org/news/2016-02-eternal-5d-storage-history-humankind.html">5D quartz DVDs</a>, and now <a href="https://blog.dshr.org/2018/02/dnas-niche-in-storage-market.html">DNA</a> face some fundamental business model problems because they function only at the very bottom of the storage hierarchy. The usual diagram of the storage hierarchy, like this one from the Microsoft/UW team researching DNA storage, makes it look like the size of the market increases downwards. But that's very far from the case.<br>
</blockquote>

<p><a href="https://digitalpreservation.gov/meetings/DSA2024/loc_dsa2024_website_0104_Lauhoff_Libary_of_Congress_2024_IBM.pdf">IBM's Georg Lauhoff and Gary M Decad's slide</a> shows that the size of the market in dollar terms <i>decreases</i> downwards. LTO tape is less than 1% of the media market in dollar terms and less than 5% in capacity terms. Archival media are a very small part of the storage market. It is noteworthy that in 2023 Optical Archival (OD-3), the most recent archive-only medium, was canceled for lack of a large enough market. It was a 1TB optical disk, an upgrade from Blu-Ray.</p><h3>Timescales</h3><p>
Second, that the researcher's favorite medium could make it into the market in the timescale of IDC's projections. Because the reliability and performance requirements of storage media are so challenging, time scales in the storage market are much longer than the industry's marketeers like to suggest.</p><p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgMEtHjIgtxAHlXzy_DQUhs8BB0KgahIURfneVHh3b49Byhf-rd_j7Qf9_7aSbFmWjIArop5kBHWS95UuOMYFrA9hbiNoEyDGnJNb7MOjLGtqRGFHfe9jb7HfpcbAsMVNGyh_-meN9PY7LEz1C4vIzDQDynC6EhUX3PV8K0wJ55NZwt2Hmk187QRdN5_pyr/s730/DaveAnderson.png"><img data-original-height="497" data-original-width="730" height="218" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgMEtHjIgtxAHlXzy_DQUhs8BB0KgahIURfneVHh3b49Byhf-rd_j7Qf9_7aSbFmWjIArop5kBHWS95UuOMYFrA9hbiNoEyDGnJNb7MOjLGtqRGFHfe9jb7HfpcbAsMVNGyh_-meN9PY7LEz1C4vIzDQDynC6EhUX3PV8K0wJ55NZwt2Hmk187QRdN5_pyr/s320/DaveAnderson.png" width="320"></a>
</p><p>
Take, for example, Seagate's development of the next generation of hard disk technology, HAMR, where research started <a href="https://web.archive.org/web/20190813175046/https://www.seagate.com/news/news-archive/seagate-swings-increase-disc-drive-densities-master-pr/">twenty-six years ago</a>. Nine years later in 2008 they published this graph, showing HAMR entering the market in 2009. Seventeen years later it is only now starting to be shipped to the hyper-scalers. Research on data in silica started <a href="https://www.storagenewsletter.com/2014/10/31/rd-hitachi-rw-of-digital-data-in-fused-silica-glass/">fifteen years ago</a>. Research on the DNA medium started <a href="https://doi.org/10.2307/777811">thirty-six years ago</a>. Neither is within five years of market entry.</p><h3>Customers</h3><p>
Third, that even if the researcher's favorite medium did make it into the market it would be a product that consumers could use. As <a href="https://blog.dshr.org/2014/09/more-on-facebooks-cold-storage.html">Kestutis Patiejunas figured out</a> at Facebook more than a decade ago, because the systems that surround archival media rather than the media themselves are the major cost, the only way to make the economics of archival storage work is to do it at data-center scale but in warehouse space and harvest the synergies that come from not needing data-center power, cooling, staffing, etc.</p><p>
Storage has an analog of Moore's Law called <a href="https://www.scientificamerican.com/article/kryders-law/">Kryder's Law</a>, which states that over time the density of bits on a storage medium increases exponentially. Given the need to reduce costs at data-center scale, Kryder's Law limits the service life of even quasi-immortal media. As we see with tape robots, where data is routinely migrated to newer, denser media long before its theoretical lifespan, what matters is the economic, not the technical lifespan of a medium.</p><p>

Hard disks are replaced every five years although the magnetically encoded data on the platters is <a href="https://www.abitare.org/papers/ISandT2008.pdf">good for a quarter-century</a>. They are engineered to have a five-year life because Kryder's Law implies that they will be replaced after five years even though they still work perfectly. Seagate actually built drives with 25-year life but found that no-one would pay the extra for the longer life.</p><h3>The Cloud</h3>
<p>
Fourth, that anyone either cares or even knows what medium their archived data lives on. Only the hyper-scalers do. Consumers believe their data is safe in the cloud. Why bother backing it up, let alone archiving it, if it is safe anyway? If anyone really cares about archiving they use a service such as Glacier, when they definitely have no idea what medium is being used.</p><h3>Threats</h3>
<p>
Fifth, that bit rot is the only threat that matters; the idea that with quasi-immortal media you don't need Lots Of Copies to Keep Stuff Safe.</p><p>

No medium is perfect. They all have a specified Unrecoverable Bit Error Rate (UBER) rate. For example, typical <a href="https://www.seagate.com/content/dam/seagate/en/content-fragments/products/datasheets/exos-x24/exos-x24-DS2080-2307US-en_US.pdf">disk UBERs are 10<sup>-15</sup></a>. A petabyte is 8*10<sup>15</sup> bits, so if the drive is within its specified performance you can expect up to 8 errors when reading a petabyte. The specified UBER is an upper limit, you will normally see <a href="https://www.microsoft.com/en-us/research/wp-content/uploads/2005/12/tr-2005-166.pdf">far fewer</a>. The <a href="https://cdn.allbound.com/iq-ab/2022/12/LTO-9-TB00068A.pdf">UBER for LT09 tape is 10<sup>-20</sup></a>, so unrecoverable errors on a new tape are very unlikely. But not impossible, and the rate goes up steeply with tape wear.</p><p>

The property that classifies a medium as quasi-immortal is not that its reliability is greater than regular media to start with, although as with tape it may be. It is rather that its reliability decays more slowly than that of regular media. Thus archival systems need to use erasure coding to mitigate both UBER data loss and media failures such as disk crashes and tape wear-out.</p><p>

Another reason for needing erasure codes is that media errors are not the only ones needing mitigation. What matters is the reliability the system delivers to the end user.  Research has shown that the <a href="https://blog.dshr.org/2008/03/more-bad-news-on-storage-reliability.html">majority of end user errors</a> come from layers of the system above the actual media.</p><p>

The archive may contain personally identifiable or other sensitive data. If so, the data on the medium must be encrypted. This is a double-edged sword, because the encryption key becomes a single point of failure; its loss or corruption renders the entire archive inaccessible. So you need Lots Of Copies to keep the key safe. But the more copies the greater the risk of key compromise.</p><p>

Media such as silica, DNA, quartz DVDs, steel tape and so on address bit rot, which is only one of the threats to which long-lived data is subject.  Clearly a single copy on such media, even if erasure coded, is still subject to threats including fire, flood, earthquake, ransomware, and insider attacks.  Thus even an archive needs to maintain multiple copies. This greatly increases the cost, bringing us back to the economic threat.</p><h2>Archival Storage Systems</h2><p>
At Facebook Patiejunas built rack-scale systems, each holding 10,000 100GB optical disks for a Petabyte per rack. Writable Blu-Ray disks are about 80 cents each, so the media to fill the rack would cost about $8K. This is clearly much less than the cost of the robotics and the drives.</p><p>
Let's drive this point home with another example. An <a href="https://www.ibm.com/products/ts4300">IBM TS4300</a> LTO tape robot <a href="https://www.ibm.com/flashsystem/pricing/us-en/family/TP9JK5">starts at $20K</a>. Two 20-pack tape cartridges to fill it cost about $4K, so the media is about 16% of the total system capex. The opex for the robot includes power, cooling, space, staff and an IBM maintenance contract. The opex for the tapes is essentially zero.</p><p>

The media is an insignificant part of the total lifecycle cost of storing archival data on tape. What matters for the economic viability of an archival storage system is minimizing the total system cost, not the cost of the media. No-one is going to spend $24K on a rack-mount tape system from IBM to store 720TB for their home or small business. The economics only work at data-center scale.</p><p>

The reason why this focus on media is a distraction is that the fundamental problem of digital preservation is economic, not technical.  No-one wants to pay for preserving data that isn't earning its keep, pretty much the definition of archived data.  The cost per terabyte of the <i>medium</i> is irrelevant, what drives the economic threat is the capital and operational cost of the <i>system</i>. Take tape for example. The media capital cost is low, but the much higher system capital cost includes the drives and the robotics. Then there are the operational costs of the data center space, power, cooling and staff. It is only by operating at data-center scale and thus amortizing the capital and operational costs over very large amounts of data that the system costs per terabyte can be made competitive.</p><p>

Operating at data center scale, as <a href="https://blog.dshr.org/2014/09/more-on-facebooks-cold-storage.html">Patiejunas discovered</a> and <a href="https://blog.dshr.org/2025/01/storage-roundup.html">Microsoft understands</a>, means that one of the parameters that determines the system cost is <i>write bandwidth</i>. Each of Facebook's racks wrote 12 optical disks in parallel almost continuously. It would take over 800 times the time to write an entire disk to fill the rack.  At the 8x write speed it takes <a href="https://en.wikipedia.org/wiki/Blu-ray#Drive_speeds">22.5 minutes</a> to fill a disk, so it would take around 18,750 minutes to fill the rack, or about two weeks. It isn't clear how many racks Facebook needed simultaneously doing this to keep up with the flow of user-generated content, but it was likely enough to fill a reasonable-size warehouse. Similarly, it would take about 8.5 days to fill the <a href="https://www.ibm.com/docs/en/dtl?topic=performance-lto-specifications">base model TS4300</a>.</p><h3>Project Silica</h3><p>
I wrote about <a href="https://doi.org/10.1145/3600006.3613208">Microsoft's Project Silica</a> a year ago, in <a href="https://blog.dshr.org/2024/03/microsofts-archival-storage-research.html"><i>Microsoft's Archival Storage Research</i></a>. It uses femtosecond lasers to write data into platters of silica.
Like Facebook's, the prototype Silica systems are <a href="https://doi.org/10.1145/3600006.3613208">data-center size</a>:</p><div>
<blockquote>
A <i>Silica library</i> is a sequence of contiguous write, read, and storage racks interconnected by a platter delivery system.  Along all racks there are parallel horizontal rails that span the entire library. We refer to a side of the library (spanning all racks) as a <i>panel</i>. A set of <i>free roaming</i> robots called <i>shuttles</i> are used to move platters between locations.<br>
...<br>
A read rack contains multiple read drives. Each read drive is independent and has slots into which platters are inserted and removed. The number of shuttles active on a panel is limited to twice the number of read drives in the panel. The write drive is full-rack-sized and writes multiple platters concurrently.
</blockquote>
</div><p>
Their performance evaluation focuses on the ability to respond to read requests within 15 hours. Their cost evaluation, like Facebook's, focuses on the savings from using warehouse-type space to house the equipment, although is isn't clear that they have actually done so. The rest of their cost evaluation is somewhat hand-wavy, as is natural for a system that <a href="https://doi.org/10.1145/3600006.3613208">isn't yet in production</a>:</p><div>
<blockquote>
The Silica read drives use polarization microscopy, which is a commoditized technique widely used in many applications and is low-cost. Currently, system cost in Silica is dominated by the write drives, as they use femtosecond lasers which are currently expensive and used in niche applications.  ...  As the Silica technology proliferates, it will drive up the demand for femtosecond lasers, commoditizing the technology.
</blockquote>
</div><p>
I'm skeptical of "commoditizing the technology". Archival systems are a niche in the IT market, and one on which companies are loath to spend money. Realistically, there aren't going to be a vast number of Silica write heads. The only customers for systems like Silica are the large cloud providers, who will be reluctant to commit their archives to technology owned by a competitor. Unless a mass-market application for femtosecond lasers emerges, the scope for cost reduction is limited.</p><p>

But the more I think about this technology, which is still in the lab, the more I think it probably has the best chance of impacting the market among all the rival archival storage technologies. Not great, but better than its competitors:</p><ul>
<li>The media is very cheap and very dense, so the effect of Kryder's Law economics driving media replacement and thus its economic rather than technical lifetime is minimal.</li>
<li>The media is quasi-immortal and survives benign neglect, so opex once written is minimal.</li>
<li>The media is write-once, and the write and read heads are physically separate, so the data cannot be encrypted or erased by malware. The long read latency makes exfiltrating large amounts of data hard.</li>
<li>The robotics are simple and highly redundant. Any of the shuttles can reach any of the platters. They should be much less troublesome than tape library robotics because, unlike tape, a robot failure only renders a small fraction of the library inaccessible and is easily repaired.</li>
<li>All the technologies needed are in the market now, the only breakthroughs needed are economic, not technological.</li>
<li>The team has worked on improving the  write bandwidth which is a critical issue for archival storage at scale. They can currently write hundreds of megabytes a second.</li>
<li>Like <a href="https://blog.dshr.org/2014/09/more-on-facebooks-cold-storage.html">Facebook's archival storage technologies</a>, Project Silica enjoys the synergies of data center scale without needing full data center environmental and power resources.</li>
<li>Like Facebook's technologies, Project Silica has an in-house customer, Azure's archival storage, with a need for a product like this.</li>
</ul>
<p>
The expensive part of the system is the write head. It is an entire rack using femtosecond lasers, which start at around $50K. The eventual system's economics will depend upon the progress made in cost-reducing the lasers.</p><h2>Retrieval</h2>
<p>
The Svalbard archipelago is where I spent the summer of 1969 doing a geological survey.</p><p>

The most important part of an archiving strategy is knowing how you will get stuff out of the archive. Putting stuff in and keeping it safe are important and relatively easy, but if you can't get stuff out when you need it what's the point?</p><p>

In some cases access is only needed to a small proportion of the archive. At Facebook, Patiejunas expected that the major reason for access would be to respond to a subpoena. In other cases, such as migrating to a new archival system, bulk data retrieval is required.</p><p>

But if the reason for needing access is disaster recovery it is important to have a vision of what resources are likley to be available after the disaster. Microsoft gained a lot of <a href="https://www.bloomberg.com/news/features/2019-11-13/microsoft-apocalypse-proofs-open-source-code-in-an-arctic-cave">valuable PR</a> by encoding much of the world's open source software in QR codes on film and storing the cans of film in an abandoned coal mine in Svalbard so it would "survive the apocalypse". In <a href="https://blog.dshr.org/2019/11/seeds-or-code.html"><i>Seeds Or Code?</i></a> I had a lot of fun imagining how the survivors of the apocalypse would be able to access the archive.</p><div>
<table><tbody><tr><td><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhUoFxpu0RgpPA5Ucc2BlYLWU-l9HrFklaIDCTtQBDyf7PvjsoAogcjeEm_xhg69X2p7xmxcRUXI3OF0jNmHjWUZ8IQ_bEpEPGp90IEL9QjTXvGsOvsC_MkErc7lWxYBWwnv8EUQyUoFIZoUKrD0YAPCM_H6B0erV3xmHlIyoYnq4e4RCUMj3uQ1PaJn2Df/s1040/TromsoLongyear.png" imageanchor="1"><img data-original-height="1040" data-original-width="698" height="320" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhUoFxpu0RgpPA5Ucc2BlYLWU-l9HrFklaIDCTtQBDyf7PvjsoAogcjeEm_xhg69X2p7xmxcRUXI3OF0jNmHjWUZ8IQ_bEpEPGp90IEL9QjTXvGsOvsC_MkErc7lWxYBWwnv8EUQyUoFIZoUKrD0YAPCM_H6B0erV3xmHlIyoYnq4e4RCUMj3uQ1PaJn2Df/s320/TromsoLongyear.png" width="215"></a></td></tr><tr><td>The voyage<br></td></tr></tbody></table>
</div><p>
To make a long story short, after even a mild apocalypse, they wouldn't be able to. Let's just point out that the first steps after the apocalypse are getting to Svalbard. They won't be able to fly to <a href="https://en.wikipedia.org/wiki/Svalbard_Airport">LYR</a>. As the crow flies, the voyage from Tromsø is 591 miles across very stormy seas. It takes several days, and getting to Tromsø won't be easy either.</p><h2>Archival Storage Services</h2><p>
Because technologies have very strong economies of scale, the economics of most forms of IT work in favor of the hyper-scalers. These forces are especially strong for archival data, both because it is almost pure cost with no income, and because as I discussed earlier the economics of archival storage only work at data-center scale. It will be the rare institution that can avoid using cloud archival storage. I analyzed the way these economic forces operate in 2019's <a href="https://blog.dshr.org/2019/02/cloud-for-preservation.html"><i>Cloud For Preservation</i></a>:</p><div>
<blockquote>
Much of the attraction of cloud technology for organizations, especially public institutions funded through a government's annual budget process, is that they transfer costs from capital to operational expenditure. It is easy to believe that this increases financial flexibility. As regards ingest and dissemination, this may be true. Ingesting some items can be delayed to the next budget cycle, or the access rate limit lowered temporarily. But as regards preservation, it isn't true. It is unlikely that parts of the institution's collection can be de-accessioned in a budget crunch, only to be re-accessioned later when funds are adequate. Even were the content still available to be re-ingested, the cost of ingest is a significant fraction of the total life-cycle cost of preserving digital content.
</blockquote>
</div><p>
Cloud services typically charge differently for ingest, storage and retrieval. The service's goal in designing their pricing structure is to create lock-in, by analogy with the drug-dealer's algorithm "the first one's free".
In 2019 I used the published rates to compute the cost of ingesting in a month, storing for a year, and retrieving in a month a petabyte using the archive services of the three main cloud providers. Here is that table, with the costs adjusted for inflation to 2024 using the <a href="https://www.bls.gov/data/inflation_calculator.htm">Bureau of Labor Statistics' calculator</a>:</p><div>
<table cols="6"><tbody>
<tr>
    <th colspan="6">Archival Services</th>
</tr>
<tr>
    <th>Service</th>
    <th>In</th>
    <th>Store</th>
    <th>Out</th>
    <th>Total</th>
    <th>Lock-in</th>
  </tr>
<tr> <td><a href="https://aws.amazon.com/glacier/pricing/">AMZN Glacier</a></td> <td>$2,821</td> <td>$60,182</td> <td>$69,260</td> <td>$132,263</td> <td>13.8</td></tr>
<tr> <td><a href="https://cloud.google.com/storage/pricing">GOOG Coldline</a></td> <td>$4,514</td> <td>$105,319</td> <td>$105,144</td> <td>$214,977</td> <td>12.0</td></tr>
<tr> <td><a href="https://azure.microsoft.com/en-us/pricing/details/storage/blobs/">MSFT Archive</a></td> <td>$7,962</td> <td>$30,091</td> <td>$20,387</td> <td>$58,440</td> <td>8.1</td></tr>
</tbody></table>
</div><p>
The "Lock-in" column is the approximate number of months of storage cost that getting the Petabyte out in a month represents. Note that:</p><ul>
<li>In all cases getting data out is much more expensive than putting it in.</li>
<li>The lower cost of archival storage compared to the same service's near-line storage is purchased at the expense of a much stronger lock-in.</li>
<li>Since the whole point of archival storage is keeping data for the long term, the service will earn much more in storage charges over the longer life of archival data than the shorter life of near-line data.</li>
</ul><p>
There may well be reasons why retrieving data from archival storage is expensive. Most storage technologies have unified read/write heads, so retrieval competes with ingest which, as Patiejunas figured out, is the critical performance parameter for archival storage. This is because, to minimize cost, archival systems are designed assuming bulk retrieval is rare. When it happens, whether from a user request or to migrate data to new media, it is disruptive. For example, emptying a base model TS4300 occupies it for more than a week.</p><p>

Six years later, things have changed significantly. Here is the current version of the archival services table:</p><p>
Points to note:</p><ul>
<li>Glacier is the only one of the three that is significantly cheaper in real terms than it was 6 years ago.</li>
<li>Glacier can do this because Kryder's Law has made their storage about a factor of about 6 cheaper in real terms in six years, or about a 35% Kryder rate. This is somewhat faster than the rate of areal density increase of tape, and much faster than that of disk. The guess is that Glacier Deep Archive is on tape.</li>
<li>Google's pricing indicates they aren't serious about the archival market.</li>
<li>Archive services now have differentiated tiers of service. This table uses S3 Deep Archive, Google Archive and Microsoft Archive.</li>
<li>Lock-in has increased from 13.8/12.0/8.1 to 50/175/20. It is also increased by additional charges for data lifetimes less than a threshold, 180/365/180 days. So my cost estimate for Google is too low, because the data would suffer these charges. But accounting for this would skew the comparison.</li>
<li>Bandwidth charges are a big factor in lock-in. For Amazon they are 77%, for Google they are 38%, for Microsoft they are 32%.  Amazon's marketing is smart, hoping you won't notice the outbound bandwidth charges.</li>
</ul><p>
Looking at these numbers it is hard to see how anyone can justify any archive storage other than S3 Deep Archive. It is the only one delivering Kryder's Law to the customer, and as my <a href="https://blog.dshr.org/2017/08/economic-model-of-long-term-storage.html">economic model</a> shows, delivering Kryder's Law is essential to affordable long-term storage. A petabyte for a decade costs under $120K before taking Kryder's Law into account and you can get it all out for under $50K.</p><h2>LOCKSS</h2>
<div>
<table><tbody><tr><td><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjsW7x_4i-TUwFG6xNVH2q_nk5jXabNhRGxUbnEeDV6vKapZoAmu9eDP1JY4Oavw508eDSbFy734Gxb2crvCI-eAQVjL-3LjYp0olWhqIR4OM6AhehgFJTKFxrKEdrLJHUOdsrPCeODqpu4dVDUT2sggb73rBj_EomjFI1YirWH2THzPUgP4_KwTIDX1Q/s151/LOCKSS.logo.png"><img data-original-height="151" data-original-width="151" height="151" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjsW7x_4i-TUwFG6xNVH2q_nk5jXabNhRGxUbnEeDV6vKapZoAmu9eDP1JY4Oavw508eDSbFy734Gxb2crvCI-eAQVjL-3LjYp0olWhqIR4OM6AhehgFJTKFxrKEdrLJHUOdsrPCeODqpu4dVDUT2sggb73rBj_EomjFI1YirWH2THzPUgP4_KwTIDX1Q/s1600/LOCKSS.logo.png" width="151"></a></td></tr><tr><td>Original Logo<br></td></tr></tbody></table>
</div><p>
The fundamental idea behind LOCKSS was that, given a limited budget and a realistic range of threats, data would survive better in many cheap, unreliable, loosely-coupled replicas than in a single expensive, durable one.</p><div>
<blockquote>
Replacing one drive takes about 15 minutes of work. If we have 30,000 drives and 2 percent fail, it takes 150 hours to replace those.  In other words, one employee for one month of 8 hour days. Getting the failure rate down to 1 percent means you save 2 weeks of employee salary - maybe $5,000 total? The 30,000 drives costs you $4m.<p>

The $5k/$4m means the Hitachis are worth 1/10th of 1 per cent higher cost to us. ACTUALLY we pay even more than that for them, but not more than a few dollars per drive (maybe 2 or 3 percent more).</p><p>

Moral of the story: design for failure and buy the cheapest components you can. :-)
</p></blockquote>
</div><p>
Brian Wilson, CTO of BackBlaze <a href="https://blog.dshr.org/2014/04/evercloud-workshop.html">pointed out</a> eleven years ago that in their long-term storage environment <a href="http://www.theregister.co.uk/2014/02/17/backblaze_how_not_to_evaluate_disk_reliability/">"Double the reliability is only worth 1/10th of 1 percent cost increase"</a>. And thus that the moral of the story was "design for failure and buy the cheapest components you can".</p><p>

In other words, don't put all your eggs in one basket.</p>
</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Dataminr tracked Gaza-related protests (223 pts)]]></title>
            <link>https://theintercept.com/2025/03/17/lapd-surveillance-gaza-palestine-protests-dataminr/</link>
            <guid>43390747</guid>
            <pubDate>Mon, 17 Mar 2025 17:25:35 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://theintercept.com/2025/03/17/lapd-surveillance-gaza-palestine-protests-dataminr/">https://theintercept.com/2025/03/17/lapd-surveillance-gaza-palestine-protests-dataminr/</a>, See on <a href="https://news.ycombinator.com/item?id=43390747">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
    
    
<p><span>One week after</span> Hamas’s October 7 attack, thousands rallied outside the Israeli Consulate in Los Angeles to protest the country’s retaliatory assault on Gaza. The protestors were peaceful, <a href="https://www.latimes.com/california/story/2023-10-14/thousands-of-pro-palestinian-groups-gather-in-front-of-federal-building-in-westwood">according to local media</a>, “carrying signs that said ‘Free Palestine’ and ‘End the Occupation,’” and watched over by a “sizable police presence in the area.” The LAPD knew the protests were coming: Two days earlier, the department received advanced warning on Dataminr, a social media surveillance firm and “<a href="https://partners.x.com/en/partners/dataminr">official partner</a>” of X.</p>



<p>Internal Los Angeles Police Department emails obtained via public records request show city police used Dataminr to track Gaza-related demonstrations and other constitutionally protected speech. The department receives real-time alerts from Dataminr not only about protests in progress, but also warnings of upcoming demonstrations as well. Police were tipped off about protests in the Los Angeles area and across the country. On at least one occasion, the emails show a Dataminr employee contacted the LAPD directly to inform officers of a protest being planned that apparently hadn’t been picked up by the company’s automated scanning.</p>



<p>Based on the records obtained by The Intercept, which span October 2023 to April 2024, Dataminr alerted the LAPD of more than 50 different protests, including at least a dozen before they occurred.</p>



<p>It’s unclear whether the LAPD used any of these notifications to inform its response to the wave of pro-Palestine protests that spread across Southern California over the last two years, which have resulted in hundreds of arrests.</p>



<p>Neither the LAPD nor Dataminr responded to a request for comment.</p>



<figure><blockquote><p>“They are using taxpayer money to enlist companies to conduct this surveillance on social media.”</p></blockquote></figure>



<p>Privacy and civil liberties experts argue that police surveillance of First Amendment activity from afar has chilling effect on political association, discourse and dissent.</p>



<div><p>“Police departments are surveilling protests which are First Amendment protected political activity about a matter of public importance,” Jennifer Granick, an attorney with the American Civil Liberties Union’s Speech, Privacy, and Technology Project, told The Intercept. “They are using taxpayer money to enlist companies to conduct this surveillance on social media. This is especially worrisome now that the Administration is targeting Gaza protesters for arrest and deportation based on protected activity.”</p><!-- BLOCK(promote-post)[0](%7B%22componentName%22%3A%22PROMOTE_POST%22%2C%22entityType%22%3A%22SHORTCODE%22%2C%22optional%22%3Atrue%7D)(%7B%22slug%22%3A%22israel-palestine%22%2C%22crop%22%3A%22promo%22%7D) -->  </div>
<!-- END-BLOCK(promote-post)[0] -->



<p><span>The alerts began</span> pouring in on October 9, when Dataminr flagged a “Protest mentioning Israel” blocking traffic in Beverly Hills, citing a tweet. Over the course of the month, Dataminr tipped off the LAPD to six different protests against the war across Los Angeles. These alerts included information about protests already in progress and information about the time and place of at least one LA protest planned for a future date.</p>



<p>Emails produced by the LAPD in response to The Intercept’s records request show that along with its regular feed of information about constitutionally protected speech, it also provides the department with alerts curated through feeds with titles like “Domestic Demonstrations Awareness,” “LA demonstrations,” “LA unrest,” and “demonstrations,” indicating the department proactively monitors First Amendment gatherings using the platform.</p>



<p>The department also began receiving a regular flow of alerts about protests thousands of miles away, including a “protest mentioning Palestinian territories outside the Consulate General of Israel” in Chicago,” and tweets from journalist Talia Jane, who was providing real-time updates on an antiwar rally in New York City.</p>



<p>Jane told The Intercept that she objects to the monitoring of her reporting by police, and also said Dataminr’s summary of her posts were at times inaccurate. In one instance, she says, Dataminr attributed a Manhattan road closure to protesters, when it had in fact been closed by the NYPD. “It’s absurd any agency would spend money on a service that is apparently completely incapable of parsing information correctly,” she said, adding that “the surveillance of journalists’ social media to suppress First Amendment activity is exactly why members of the press have a responsibility to ensure their work is not used to harm people.”</p>



<p>On October 17, Dataminr sent an “urgent update” to the department warning of a “Demonstration mentioning Palestinian territories planned for today at 17:00 in Rittenhouse Square area of Philadelphia,” based on a tweet. Three days later, a similar update noted another “Demonstration mentioning Palestinian territories” planned for Boston’s Copley Square. Another warned of a “protest mentioning Palestinian territories” in the planning stages at the Oregon State Capitol. It’s unclear if the department intended to cast such a wide net, or if the out-of-state protest alerts were sent in error. Dataminr’s threat notifications are known to turn up false positives; multiple tweets by angry Taylor Swift fans aimed at Ticketmaster were forwarded to the LAPD as “L.A. Threats and Disruptions,” the records show.</p>



<p>Materials obtained by The Intercept also show that despite Dataminr’s marketing claims of being an “AI” intermediary between public data and customers, the firm has put its human fingers on the scales. On October 12, a Dataminr account manager emailed three LAPD officers, whose names are redacted, with the subject line “FYSA,” military shorthand meaning “for your situational awareness.” The email informed the officers of a “Protest planned for October 14 at 12:30 at Consulate General of Israel in Los Angeles,” with a link to a tweet by a Los Angeles university professor. It’s unclear if the LAPD has requested these manual tip-offs from Dataminr, or whether such personal service is routine; Dataminr did not respond when asked if it was a standard practice. But the hands-on approach undercuts Dataminr’s prior claims that it just passively provides alerts to customers about social media speech germane to their interests.</p>



<p>A company spokesperson previously told The Intercept that “Every First Alert user has access to the exact same alerts and can choose to receive the alerts most relevant to them.””</p>



<!-- BLOCK(cta)[1](%7B%22componentName%22%3A%22CTA%22%2C%22entityType%22%3A%22SHORTCODE%22%2C%22optional%22%3Atrue%7D)(%7B%7D) -->

<!-- END-BLOCK(cta)[1] -->



<p><span>Dataminr pitches its</span> clients across the private and public sector a social media superpower: What if you had immediate access tweet relevant to your interests — without having to even conduct a search? The company, founded in 2016 and valued at over $4 billion, claims a wide variety of customers, from media newsrooms to government agencies, including lucrative federal contracts with the Department of Defense. It has also found an avid customer base in law enforcement. While its direct access to Twitter has been a primary selling point, Dataminr also scours apps like Snap and Telegram.</p>



<p>The company — which boasts both Twitter and the CIA as early investors — pitches its&nbsp;“First Alert” software platform as a public safety-oriented newsfeed of breaking events.</p>



<p>It has for years defended its police work as simply news reporting, arguing it can’t be considered a surveillance tool because the information relayed to police is public and differs in no way from what an ordinary user browsing social media could access.</p>



<p>Privacy advocates and civil libertarians have countered that the software provides the government with visibility that far surpasses what any individual user or even team of human officers could accomplish. Indeed, Dataminr’s own law enforcement marketing materials <a href="https://www.dataminr.com/resources/solution-sheet/use-public-data-to-make-decisions-faster/">claim</a> “30k people working 24/7 would only process 1% of all the data Dataminr ingests each day.”&nbsp;</p>



  



<p>The company has this power because of its long-standing “official partner” status with both Twitter and now X. Dataminr purchases access to the platform’s data “firehose,” allowing it to query every single post and scan them on behalf of clients in real-time.</p>



<p>Previous reporting by The Intercept has shown Dataminr has used this privileged access to surveil <a href="https://theintercept.com/2023/05/15/abortion-surveillance-dataminr/">abortion rights rallies</a>, <a href="https://theintercept.com/2020/07/09/twitter-dataminr-police-spy-surveillance-black-lives-matter-protests/">Black Lives Matter protests</a>, and other constitutionally protected speech on behalf of both local and federal police. Dataminr <a href="https://theintercept.com/2020/10/21/dataminr-twitter-surveillance-racial-profiling/">sources told The Intercept in 2020</a> how the company’s human analysts, helping tailor the service to its various police and military customers, at time demonstrated implicit biases in their work — an allegation the company denied.</p>



<!-- BLOCK(newsletter)[2](%7B%22componentName%22%3A%22NEWSLETTER%22%2C%22entityType%22%3A%22SHORTCODE%22%2C%22optional%22%3Atrue%7D)(%7B%7D) -->

<!-- END-BLOCK(newsletter)[2] -->



<p>In its previous incarnation as Twitter before its purchase by Elon Musk, and today as X, the social media platform for years <a href="https://developer.x.com/en/developer-terms/agreement-and-policy">expressly prohibited</a> third parties from using its user data for “monitoring sensitive events (including but not limited to protests, rallies, or community organizing meetings),” per its terms of service. Both companies have previously claimed that Dataminr’s service by definition cannot be considered surveillance because it is applied against public discourse; critics have often pointed out that while posts are technically public, only a company with data access as powerful as Dataminr’s would ever be able to find and flag all of these specific posts amid hundreds of millions of others. Neither company has directly addressed how Dataminr’s monitoring of protests is compatible with Twitter and X’s explicit prohibition against monitoring protests.</p>



<p>Neither X nor Dataminr responded when asked about this contradiction.</p>



  



<p>While Dataminr’s monitoring of campus protests began before the second Trump administration, it has taken on greater significance now given the White House’s <a href="https://theintercept.com/2025/03/13/briefing-podcast-mahmoud-khalil-free-speech/">overt attempts to criminalize speech</a> critical of Israel and the war in Gaza. Earlier this month, former Columbia graduate student Mahmoud Khalil, who helped organize Columbia University’s student protests against the war, was abruptly arrested and jailed by plainclothes Immigration and Customs Enforcement officers. The State Department and White House quickly confirmed the arrest was a function of Khalil’s antiwar protest efforts, which the administration has described without evidence or explanation as “aligned to Hamas.” The White House has<a href="https://theintercept.com/2025/03/11/mahmoud-khalil-columbia-ice-louisiana/"> pledged to arrest and deport</a> more individuals who have taken part in similar campus protests against the war.</p>



<p>Civil libertarians have long objected to dragnet monitoring of political speech on the grounds that it will have a chilling effect on speech guaranteed by the First Amendment. While fires, shootings, and natural disasters are of obvious interest to police, these critics frequently argue that if people know their tweets are subject to police scrutiny without any evidence of wrongdoing, they may tend to self-censor.&nbsp;</p>



<p>“Political action supporting any kind of government-disfavored viewpoint could be subject to the same over-policing: gun rights, animal rights, climate change are just a few examples,” the ACLU’s Granick added. “Law enforcement should leave online organizing alone.”</p>




  </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Wall Street’s ‘Private Rooms’ (173 pts)]]></title>
            <link>https://www.bloomberg.com/news/features/2025-03-16/wall-street-s-dark-pools-grow-murkier-with-private-rooms</link>
            <guid>43390595</guid>
            <pubDate>Mon, 17 Mar 2025 17:10:59 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.bloomberg.com/news/features/2025-03-16/wall-street-s-dark-pools-grow-murkier-with-private-rooms">https://www.bloomberg.com/news/features/2025-03-16/wall-street-s-dark-pools-grow-murkier-with-private-rooms</a>, See on <a href="https://news.ycombinator.com/item?id=43390595">Hacker News</a></p>
Couldn't get https://www.bloomberg.com/news/features/2025-03-16/wall-street-s-dark-pools-grow-murkier-with-private-rooms: Error: Request failed with status code 403]]></description>
        </item>
        <item>
            <title><![CDATA[Alphabet spins out Taara – Internet over lasers (250 pts)]]></title>
            <link>https://x.company/blog/posts/taara-graduation/</link>
            <guid>43390467</guid>
            <pubDate>Mon, 17 Mar 2025 16:55:17 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://x.company/blog/posts/taara-graduation/">https://x.company/blog/posts/taara-graduation/</a>, See on <a href="https://news.ycombinator.com/item?id=43390467">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="main">
<section>
<div data-in-view="0">
<picture>
<source srcset="https://lh3.googleusercontent.com/yXpCVH3d-_hSPv05gFVux_qRo3f3qZDul92-BNMlNSWH3CoqQbKaksGnxJUtYXoWJHgulXL6hAi-CvSVdwhey3q6i287XCO1eMK5Fg=e365-pa-nu-w1536-rw 2x, https://lh3.googleusercontent.com/yXpCVH3d-_hSPv05gFVux_qRo3f3qZDul92-BNMlNSWH3CoqQbKaksGnxJUtYXoWJHgulXL6hAi-CvSVdwhey3q6i287XCO1eMK5Fg=e365-pa-nu-w768-rw" media="(max-width: 767.98px)">
<source srcset="https://lh3.googleusercontent.com/yXpCVH3d-_hSPv05gFVux_qRo3f3qZDul92-BNMlNSWH3CoqQbKaksGnxJUtYXoWJHgulXL6hAi-CvSVdwhey3q6i287XCO1eMK5Fg=e365-pa-nu-w1984-rw 2x, https://lh3.googleusercontent.com/yXpCVH3d-_hSPv05gFVux_qRo3f3qZDul92-BNMlNSWH3CoqQbKaksGnxJUtYXoWJHgulXL6hAi-CvSVdwhey3q6i287XCO1eMK5Fg=e365-pa-nu-w992-rw" media="(min-width: 768px) and (max-width: 991.98px)">
<source srcset="https://lh3.googleusercontent.com/yXpCVH3d-_hSPv05gFVux_qRo3f3qZDul92-BNMlNSWH3CoqQbKaksGnxJUtYXoWJHgulXL6hAi-CvSVdwhey3q6i287XCO1eMK5Fg=e365-pa-nu-w2400-rw 2x, https://lh3.googleusercontent.com/yXpCVH3d-_hSPv05gFVux_qRo3f3qZDul92-BNMlNSWH3CoqQbKaksGnxJUtYXoWJHgulXL6hAi-CvSVdwhey3q6i287XCO1eMK5Fg=e365-pa-nu-w1200-rw" media="(min-width: 992px) and (max-width: 1199.98)">
<source srcset="https://lh3.googleusercontent.com/yXpCVH3d-_hSPv05gFVux_qRo3f3qZDul92-BNMlNSWH3CoqQbKaksGnxJUtYXoWJHgulXL6hAi-CvSVdwhey3q6i287XCO1eMK5Fg=e365-pa-nu-w3600-rw 2x, https://lh3.googleusercontent.com/yXpCVH3d-_hSPv05gFVux_qRo3f3qZDul92-BNMlNSWH3CoqQbKaksGnxJUtYXoWJHgulXL6hAi-CvSVdwhey3q6i287XCO1eMK5Fg=e365-pa-nu-w1800-rw">

<img src="https://lh3.googleusercontent.com/yXpCVH3d-_hSPv05gFVux_qRo3f3qZDul92-BNMlNSWH3CoqQbKaksGnxJUtYXoWJHgulXL6hAi-CvSVdwhey3q6i287XCO1eMK5Fg=e365-pa-nu-s0" width="5029" height="2829" alt="" loading="lazy" fetchpriority="auto">
</picture>
</div>
<div>

<p>Taara is spinning out of X to become an independent company with a mission to bring high-speed, affordable and abundant connectivity to people everywhere using beams of light.</p>
<p><span>Mahesh Krishnaswamy, CEO of Taara</span><span>/</span><span>March 17, 2025</span></p>

</div>
</section>
<div>
<p>Today, we’re announcing that the Taara team is graduating from The Moonshot Factory to become an independent company. We’ve raised a round of funding led by <a href="https://seriesx.capital/">Series X Capital</a> to deploy and scale Taara’s groundbreaking new approach to wireless optical communications, which uses light to deliver high-speed, high-capacity connectivity over long distances.</p>
<p>As I shared in today’s episode of <a href="https://x.company/moonshotpodcast/">The Moonshot Podcast</a>, the journey to becoming a company has been a series of adventures. Inspired by <a href="https://www.wired.com/2016/02/google-shot-laser-60-miles-just-send-copy-real-genius/">Loon’s breakthrough work</a> establishing connectivity between two stratospheric balloons, our philosophy building Taara has always been to take technology out of the lab and test it with partners to learn as quickly as possible.&nbsp;From beaming connectivity over the world's <a href="https://x.company/blog/posts/taara-beaming-broadband-across-congo/">deepest river</a>, to deploying in densely populated <a href="https://x.company/case-study/taara-in-africa/">neighborhoods</a>, every pilot project and every partnership has helped bring us closer to overcoming the stubborn connectivity gaps that prevent nearly <a href="https://www.itu.int/itu-d/reports/statistics/2022/11/24/ff22-internet-use/">3 billion people</a> from accessing the internet.</p>
</div>
<div data-in-view="0">
<div>
<picture>
<source srcset="https://lh3.googleusercontent.com/jp6N9yOAmhMOwss0fjLf_A-gerG-DQTgL_53fCbKNdr--os0naoLnrUjvcB3Z5XVbsrOwo5lL4yvxDsQkv21Xw_5TKcvrJsxie4X0Q=e365-pa-nu-w10240-rw 2x, https://lh3.googleusercontent.com/jp6N9yOAmhMOwss0fjLf_A-gerG-DQTgL_53fCbKNdr--os0naoLnrUjvcB3Z5XVbsrOwo5lL4yvxDsQkv21Xw_5TKcvrJsxie4X0Q=e365-pa-nu-w5120-rw">

<img src="https://lh3.googleusercontent.com/jp6N9yOAmhMOwss0fjLf_A-gerG-DQTgL_53fCbKNdr--os0naoLnrUjvcB3Z5XVbsrOwo5lL4yvxDsQkv21Xw_5TKcvrJsxie4X0Q=e365-pa-nu-s0" width="5120" height="2880" alt="" loading="lazy" fetchpriority="auto">
</picture>
</div>
<div>
<p>Episode 2 of <a href="https://x.company/moonshotpodcast/">The Moonshot Podcast</a>, "Essential Connections" looks at X’s mission to find radical new ways to connect the unconnected—starting with Loon balloons and evolving into Taara’s light-beamed internet.</p>
</div>
</div>
<div>
<p>My passion for connectivity was sparked while I was applying for universities in the U.S. from an internet cafe in Chennai.&nbsp;Listening to the beeps and chirps of the dial up modem. I became obsessed with connectivity, and I wanted to bring its economic, educational, and social benefits to more people. Our entire Taara team shares this passion—a diverse group of manufacturing experts, telco industry veterans, optical and photonics engineers and more.</p>
<h2>Moving to the Light Generation</h2>
<p>The connectivity challenge is only becoming more urgent as the world’s demand for data increases. Fiber is the gold standard for high-speed connectivity, but it's often difficult to lay because it's costly, impractical or geographically impossible. Where fiber fails to reach, operators and service providers often turn to radio frequency to fill the gap. However, traditional radio frequency bands are congested and running out of available bandwidth, making it harder to support 5G expansion and keep up the growing <a href="https://www.weforum.org/stories/2024/05/data-growth-drives-ict-energy-innovation/">global demand</a> for fast, reliable connectivity.</p>
<p><a href="https://x.company/projects/taara/">Taara Lightbridge</a> brings fast, fiber-like internet access to areas where it’s too difficult or expensive to install traditional fiber, like in dense city neighborhoods, over rivers and seas, or across rugged terrains and national parks. In the same way fiber optic cables in the ground use light to carry data, Taara uses narrow, invisible light beams to transmit information through the air, at speeds as high as 20 gigabits per second and across distances up to 20 kilometers. Taara’s Lightbridge units deliver high speed, high quality internet and require only a few hours to set up, without the time and cost associated with digging trenches or stringing cables.</p>
</div>
<div data-in-view="0">
<picture>
<source srcset="https://lh3.googleusercontent.com/FjOB3c4b2cSwAXrbptB6-Q2LHlq43SMu8A36zkTFXOsGs6wqhpl4r9U-E2j3QyR0RBbbHnDNA-zJLwmm1dmBo1jO3zA66C67kJI=e365-pa-nu-w3960-rw 2x, https://lh3.googleusercontent.com/FjOB3c4b2cSwAXrbptB6-Q2LHlq43SMu8A36zkTFXOsGs6wqhpl4r9U-E2j3QyR0RBbbHnDNA-zJLwmm1dmBo1jO3zA66C67kJI=e365-pa-nu-w1980-rw">

<img src="https://lh3.googleusercontent.com/FjOB3c4b2cSwAXrbptB6-Q2LHlq43SMu8A36zkTFXOsGs6wqhpl4r9U-E2j3QyR0RBbbHnDNA-zJLwmm1dmBo1jO3zA66C67kJI=e365-pa-nu-s0" width="1980" height="1022" alt="" loading="lazy" fetchpriority="auto">
</picture>
</div>
<div>
<h2>Chasing light as far as it will go</h2>
<p>Thank you to our partners across the industry who have been with us on this journey every step of the way. Taara has already deployed hundreds of links in more than a dozen countries. We’re delivering commercial service in partnership with <a href="https://x.company/blog/posts/taara-india/">Airtel</a>, <a href="https://x.company/blog/posts/bringing-light-speed-internet-to-sub-saharan-africa/">Liquid Intelligent Technologies</a> and&nbsp;<a href="https://www.businesswire.com/news/home/20231101666271/en/Liberty-Networks-Deploys-Taaras-Wireless-Optical-Communication-Technology-To-Increase-High-Capacity-Connectivity-In-The-Eastern-Caribbean-Region">Liberty Networks</a>, as well as pioneering new approaches to wireless optical communications deployments with the likes of <a href="https://x.company/case-study/taara-t-mobile/">T-Mobile</a>&nbsp;and&nbsp;<a href="https://www.mobileworldlive.com/vodafone/vodafone-fixes-for-a-flying-mwc25/">Vodafone</a>. We’re also working with innovators and researchers to explore new applications for our recently launched <a href="https://x.company/blog/posts/taara-chip/">silicon photonic chip</a>&nbsp;which uses light to transmit high-speed data through the air.</p>
<p>And we are just getting started. We’re continuing to look for like-minded partners to join us on this journey. If you’re an internet service provider, network operator, innovator or researcher who shares our mission to expand access to fast, affordable and abundant connectivity, <a href="mailto:Info@taaraconnect.com">please get in touch</a>. You can find our team over at <a href="https://www.taaraconnect.com/">Taara Connect</a>.</p>
</div>
<p><a href="https://x.company/blog/" target="_self"><svg>
<use xlink:href="#icon-arrow"></use>
</svg><span>All Posts</span></a></p>
</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Deep Learning Is Not So Mysterious or Different (423 pts)]]></title>
            <link>https://arxiv.org/abs/2503.02113</link>
            <guid>43390400</guid>
            <pubDate>Mon, 17 Mar 2025 16:47:02 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://arxiv.org/abs/2503.02113">https://arxiv.org/abs/2503.02113</a>, See on <a href="https://news.ycombinator.com/item?id=43390400">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="content-inner">
    
    
                
    <p><a href="https://arxiv.org/pdf/2503.02113">View PDF</a>
    <a href="https://arxiv.org/html/2503.02113v1">HTML (experimental)</a></p><blockquote>
            <span>Abstract:</span>Deep neural networks are often seen as different from other model classes by defying conventional notions of generalization. Popular examples of anomalous generalization behaviour include benign overfitting, double descent, and the success of overparametrization. We argue that these phenomena are not distinct to neural networks, or particularly mysterious. Moreover, this generalization behaviour can be intuitively understood, and rigorously characterized using long-standing generalization frameworks such as PAC-Bayes and countable hypothesis bounds. We present soft inductive biases as a key unifying principle in explaining these phenomena: rather than restricting the hypothesis space to avoid overfitting, embrace a flexible hypothesis space, with a soft preference for simpler solutions that are consistent with the data. This principle can be encoded in many model classes, and thus deep learning is not as mysterious or different from other model classes as it might seem. However, we also highlight how deep learning is relatively distinct in other ways, such as its ability for representation learning, phenomena such as mode connectivity, and its relative universality.
    </blockquote>

    <!--CONTEXT-->
    
  </div><div>
      <h2>Submission history</h2><p> From: Andrew Wilson [<a href="https://arxiv.org/show-email/57319f6c/2503.02113" rel="nofollow">view email</a>]      <br>    <strong>[v1]</strong>
        Mon, 3 Mar 2025 22:56:04 UTC (1,206 KB)<br>
</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Chaos in the Cloudflare Lisbon Office (268 pts)]]></title>
            <link>https://blog.cloudflare.com/chaos-in-cloudflare-lisbon-office-securing-the-internet-with-wave-motion/</link>
            <guid>43389064</guid>
            <pubDate>Mon, 17 Mar 2025 14:38:18 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://blog.cloudflare.com/chaos-in-cloudflare-lisbon-office-securing-the-internet-with-wave-motion/">https://blog.cloudflare.com/chaos-in-cloudflare-lisbon-office-securing-the-internet-with-wave-motion/</a>, See on <a href="https://news.ycombinator.com/item?id=43389064">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="post"><article><h2>Chaos in Cloudflare’s Lisbon office: securing the Internet with wave motion</h2><p>2025-03-17</p><section><p>7 min read</p><img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/2J0BiaLyDMtbEcZrETkdWu/26d0ae2c2dd564138723922bd9612dec/image1.png" alt=""><div><p>Over the years, Cloudflare has gained fame for many things, including our technical blog, but also as <a href="https://www.wired.com/story/cloudflare-lava-lamps-protect-from-hackers/"><u>a tech company securing the Internet using </u><b><u>lava lamps</u></b></a>, a story that began as a research/science project almost 10 years ago. In March 2025, we added another layer to its legacy: a "wall of entropy" made of 50 <b>wave machines </b>in constant motion at our Lisbon office, the company's European HQ.&nbsp;</p><p>These wave machines are a new source of entropy, joining <b>lava lamps</b> in San Francisco, <b>suspended rainbows</b> in Austin, and <b>double chaotic pendulums </b>in London. The entropy they generate contributes to securing the Internet <a href="#lavarand-origins-and-walls-of-entropy"><u>through LavaRand</u></a>.</p>
          <figure>
          <img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/6sp4ZXYnpwUGAabVB0fRKW/f56edd916efeb49173c623e99b87bc70/DSC00336.JPG" alt="" width="3104" height="2064" loading="lazy">
          </figure>
          <figure>
          <img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/1D1cayhBpPyuUNKV4JCcvF/e6d493a71e41c3622dd4f895505a3f43/DSC00450.JPG" alt="" width="3104" height="2064" loading="lazy">
          </figure>
          <figure>
          <img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/EE2gOFRrXCGM5ASh3uCl7/b282e0ed651cb5c354b183bc33aff116/image4.jpg" alt="" width="1999" height="1330" loading="lazy">
          </figure><p><sup><i>The new waves wall at Cloudflare’s Lisbon office sits beside the Radar Display of global Internet insights, with the 25th of April Bridge overlooking the Tagus River in the background.</i></sup></p><p>It’s exciting to see waves in Portugal now playing a role in keeping the Internet secure, especially given Portugal’s deep maritime history.</p><p>The installation honors Portugal’s passion for the sea and exploration of the unknown, famously beginning over 600 years ago, in 1415, with pioneering vessels like <a href="https://en.wikipedia.org/wiki/Caravel"><u>caravels</u></a> and naus/carracks, precursors to galleons and other ships. Portuguese sea exploration was driven by navigation schools and historic voyages <i>“through seas never sailed before”</i> (<i>“Por mares nunca dantes navegados” </i>in Portuguese), as described by Portugal’s famous poet, Luís Vaz de Camões, born 500 years ago (1524).</p><p>Anyone familiar with Portugal knows the <a href="https://en.wikipedia.org/wiki/History_of_Portugal#Naval_exploration_and_Portuguese_Empire_(15th%E2%80%9316th_centuries)"><u>sea is central</u></a> to its identity. The small country has 980 km of coastline, where most of its main cities are located. Maritime areas make up 90% of its territory, including the mid-Atlantic Azores. In 1998, Lisbon’s <a href="https://en.wikipedia.org/wiki/Expo_%2798"><u>Expo 98</u></a> celebrated the oceans and this maritime heritage. Since 2011, the small town of Nazaré also became globally <a href="https://allwaves.surf/waves-explained-nazare/"><u>famous among the surfing community</u></a> for its <a href="https://earthobservatory.nasa.gov/images/149486/monster-waves-of-nazare"><u>giant waves</u></a>.</p>
          <figure>
          <img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/2zN2XfhmWnjbFmkXfTiYGw/fa321c61b54e676136f93d050364ee8b/image6.jpg" alt="" width="1916" height="639" loading="lazy">
          </figure>
          <figure>
          <img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/Tyu4Wlgn1NMihceYSCUvI/45905ee3820880371b508dc13c32f11b/image2.jpg" alt="" width="1999" height="692" loading="lazy">
          </figure><p><sup><i>Nazaré’s waves, famous since Garrett McNamara’s 23.8&nbsp;m (78 ft) ride in 2011, hold </i></sup><a href="https://www.guinnessworldrecords.com/world-records/78115-largest-wave-surfed-unlimited"><sup><i><u>Guinness World Records</u></i></sup></a><sup><i> for the biggest waves ever surfed. Photos: Sam Khawasé &amp; Beatriz Paula, from Cloudflare.</i></sup></p><p>Portugal’s maritime culture also inspired literature and music, including poet Fernando Pessoa, who referenced it in his 1934 book <a href="https://en.wikipedia.org/wiki/Mensagem"><u>Mensagem</u></a>, and musician Rui Veloso, who dedicated his 1990s album <a href="https://open.spotify.com/album/2mzMuD3bxwFaFgfjU2vigY"><u>Auto da Pimenta</u></a> to Portugal’s historic connection to the sea.</p>
          <p>
            <h3 id="how-this-chaos-came-to-be">How this chaos came to be</h3>
            
          </p>
        <p>As Cloudflare’s CEO, Matthew Prince, <a href="https://x.com/eastdakota/status/1899226252956827846"><u>said</u></a> recently, this new wall of entropy began with an idea back in 2023: “What could we use for randomness that was like our lava lamp wall in San Francisco but represented our team in Portugal?”</p><p>The original inspiration came from wave motion machine desk toys, which were popular among some of our team members. Waves and the ocean not only provide a source of movement and randomness, but also align with Portugal’s maritime history and the office’s scenic view.</p><p>However, this was easier said than done. It turns out that making a wave machine wall is a real challenge, given that these toys are not as popular as they were in the past,&nbsp; and aren’t being manufactured in the size we needed any more. We scoured eBay and other sources but couldn't find enough, consistent in style and in working order wave machines. We also discovered that off-the-shelf models weren’t designed to run 24/7, which was a critical requirement for our use.</p><h4>Artistry to create wave machines</h4><p>Undaunted, <a href="https://blog.cloudflare.com/cloudflare-top-100-most-loved-workplaces-in-2022"><u>Cloudflare’s Places team</u></a>, which ensures our offices reflect our values and culture, found a <a href="https://wavemotionmachines.com/"><u>U.S.-based artisan</u></a> that specializes in ocean wave displays to create the wave machines for us. Since 2009, his one-person business, <a href="https://wavemotionmachines.com/"><u>Hughes Wave Motion Machines</u></a>, has blended artistry, engineering, and research, following his transition from Lockheed Martin Space Systems, where he designed military and commercial satellites.</p>
<p><sup><i>Timelapse of the mesmerizing office waves, set to the tune of an AI-generated song.</i></sup></p><p>Collaborating closely, we developed a custom rectangular wave machine (18 inches/45 cm long) that runs nonstop — not an easy task — which required hundreds of hours of testing and many iterations. Featuring rotating wheels, continuous motors, and a unique fluid formula, these machines create realistic ocean-like waves in green, blue, and Cloudflare’s signature orange.&nbsp;</p><p>Here’s a quote from the artist himself about these wave machines:</p><blockquote><p><i>“The machine’s design is a balancing act of matching components and their placement to how the fluid responds in a given configuration. There is a complex yet delicate relationship between viscosity, specific gravity, the size and design of the vessel, and the placement of each mechanical interface. Everything must be precisely aligned, centered around the fluid like a mathematical function. I like to say it’s akin to ’balancing a checkerboard on a beach ball in the wind.’”</i></p></blockquote>
          <figure>
          <img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/3K9fpTU0D0xi831MHFOFBj/570b8c307fea1078f3c0262e13447bf6/image7.jpg" alt="" width="1500" height="1999" loading="lazy">
          </figure><p><sup><i>The Cloudflare Places Team with Lisbon office architects and contractor testing wave machine placement, shelves, lighting, and mirrors to enhance movement and reflection, March 2024.</i></sup></p><p>Despite delays, the Lisbon wave machines finally debuted on March 10, 2025 — an incredibly exciting moment for the Places team.</p><p><b>Some numbers about our wave-machine entropy wall:</b></p><ul><li><p>50 wave machines, 50 motion wheels &amp; motors, 50 acrylic containers filled with Hughes Wave Fluid Formula (two <a href="https://www.sciencedirect.com/topics/engineering/immiscible-liquid"><u>immiscible liquids</u></a>)</p></li><li><p>3 liquid colors: blue, green, and orange</p></li><li><p>15 months from concept to completion</p></li><li><p>14 flips (side-to-side balancing movements) per minute — over 20,000 per day</p></li><li><p>Over 15 waves per minute</p></li><li><p>~0.5 liters of liquid per machine</p></li></ul>
          <p>
            <h3 id="lavarand-origins-and-walls-of-entropy">LavaRand origins and walls of entropy</h3>
            
          </p>
        <p>Cloudflare’s servers handle 71 million HTTP requests per second on average, with 100 million HTTP requests per second at peak. <a href="https://radar.cloudflare.com/adoption-and-usage#http-vs-https"><u>Most of these requests are secured via TLS</u></a>, which relies on secure randomness for cryptographic integrity. A Cryptographically Secure Pseudorandom Number Generator (<a href="https://www.cloudflare.com/learning/ssl/lava-lamp-encryption/"><u>CSPRNG</u></a>) ensures unpredictability, but only when seeded with high-quality entropy. Since chaotic movement in the real world is truly random, Cloudflare designed a system to harness it. Our <a href="https://blog.cloudflare.com/harnessing-office-chaos/"><u>2024 blog post</u></a> expands on this topic in a more technical way, but here’s a quick summary.</p><p>In <a href="https://blog.cloudflare.com/randomness-101-lavarand-in-production/"><u>2017</u></a>, Cloudflare launched LavaRand, inspired by <a href="https://www.wired.com/1997/03/lava-lites-easy-to-break-hard-to-crack/"><u>Silicon Graphics’ 1997 concept</u></a> However, the need for randomness in security was already a hot topic on our blog before that, such as in our discussions of <a href="https://blog.cloudflare.com/why-randomness-matters/"><u>securing systems</u></a> and <a href="https://blog.cloudflare.com/a-relatively-easy-to-understand-primer-on-elliptic-curve-cryptography/"><u>cryptography</u></a>. Originally, LavaRand collected entropy from a wall of lava lamps in our San Francisco office, feeding an internal API that servers periodically query to include in their entropy pools. Over time, we expanded LavaRand beyond lava lamps, incorporating <a href="https://blog.cloudflare.com/harnessing-office-chaos/#londons-unpredictable-pendulums"><u>new sources of office chaos</u></a> while maintaining the same core method.</p>
          <figure>
          <img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/2v6Wvde8j8R7482QjBsSrV/89b37c652654e27c13d328e9acac6489/image9.png" alt="" width="1612" height="381" loading="lazy">
          </figure><p>A camera captures images of dynamic, unpredictable randomness displays. Shadows, lighting changes, and even sensor noise contribute entropy. Each image is then processed into a compact hash, converting it into a sequence of random bytes. These, combined with the previous seed and local system entropy, serve as input for a Key Derivation Function (<a href="https://en.wikipedia.org/wiki/Key_derivation_function"><u>KDF</u></a>), which generates a new seed for a CSPRNG — capable of producing virtually unlimited random bytes upon request. The waves in our Lisbon office are now contributing to this pool of randomness.</p>
          <figure>
          <img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/1XFFjr4jhRMQlz6akHKZm4/44759c4e879de3792cd21b4ce2525c90/image5.png" alt="" width="1491" height="400" loading="lazy">
          </figure><p>Cloudflare’s LavaRand API makes this randomness accessible internally, strengthening cryptographic security across our global infrastructure. For example, when you use <i>Math.random()</i> in <a href="https://workers.cloudflare.com/"><u>Cloudflare Workers</u></a>, part of that randomness comes from LavaRand. Similarly, querying our <a href="https://blog.cloudflare.com/harnessing-office-chaos/#drand-distributed-and-verifiable-public-randomness"><u>drand API</u></a> taps into LavaRand as well. Cloudflare offers this API to enable anyone to generate random numbers and even seed their own systems.</p>
          <p>
            <h3 id="our-new-lisbon-office-space">Our new Lisbon office space</h3>
            
          </p>
        
          <figure>
          <img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/5ivPkCfTkGxfo6Swt6p9qY/e7414a14b88bef7ac7e0ef6f737b58c6/image8.jpg" alt="" width="1999" height="1330" loading="lazy">
          </figure><p><sup><i>Photo of the view from our Lisbon office, featuring ceiling lights arranged in a wave-like pattern.</i></sup></p><p>Entropy also inspired the design ethos of our new Lisbon office, given that the wall of waves and the office are part of the same project. As soon as you enter, you're greeted not only by the motion of the entropy wall but also by the constant movement of planet Earth on our Cloudflare Radar Display screen that stands next to it. But the waves don’t stop there — more elements throughout the space mimic the dynamic flow of the Internet itself. Unlike ocean tides, however, Internet traffic ebbs and flows with the motion of the Sun, not the Moon.</p><p>As you walk through the office, waves are everywhere — in the ceiling lights, the architectural contours, and even the floor plan, thoughtfully designed by our architect to reflect the fluid movement of water. The visual elements create a cohesive experience, reinforcing a sense of motion. Each meeting room embraces this maritime theme, named after famous Portuguese beaches — including, naturally, Nazaré.</p><p>We partnered with an incredible group of local Portuguese vendors for this construction project, where all the leads were women — something incredibly rare for the industry. The local teams worked with passion, proudly wore Cloudflare t-shirts, and fostered a warm, family-like atmosphere. They openly expressed pride in the project, sharing how it stood out from anything they had worked on before.</p>
          <figure>
          <img src="https://cf-assets.www.cloudflare.com/zkvhlag99gkb/7lpuurEtWfpIPKvHVqmD0L/0b0561097859f286d6b5e98db82f1e0f/image3.jpg" alt="" width="1999" height="1125" loading="lazy">
          </figure><p><sup><i>Our amazing third-party team and internal Places team, proudly rocking Cloudflare shirts after bringing this project to life.</i></sup></p>
          <p>
            <h3 id="help-us-select-a-name-for-our-new-wall-of-entropy">Help us select a name for our new wall of entropy</h3>
            
          </p>
        <p>Next, we have several name options for this new wall of entropy. Help us decide the best one, and register your vote using <a href="https://forms.gle/L2gAqoJTwQmJFkmy8"><u>this form</u></a>.</p><blockquote><p><b>The Surf Board</b></p><p><b>Chaos Reef</b></p><p><b>Waves of Entropy</b></p><p><b>Wall of Waves</b></p><p><b>Whirling Wave Wall</b></p><p><b>Chaotic Wave Wall</b></p><p><b>Waves of Chaos</b></p></blockquote><p>If you’re interested in working in Cloudflare’s Lisbon office, we’re hiring! Our <a href="https://www.cloudflare.com/careers/jobs/"><b><u>career page</u></b></a> lists our open roles in Lisbon, as well as our other locations in the U.S., Mexico, Europe and Asia.</p><p><sup><i>Acknowledgements: This project was only possible with the effort, vision and help of John Graham-Cumming, Caroline Quick, Jen Preston, Laura Atwall, Carolina Beja, Hughes Wave Motion Machines, P4 Planning and Project Management, Gensler Europe, Openbook Architecture, and Vector Mais.</i></sup></p></div></section><div><p>Cloudflare's connectivity cloud protects <a target="_blank" href="https://www.cloudflare.com/network-services/" rel="noreferrer">entire corporate networks</a>, helps customers build <a target="_blank" href="https://workers.cloudflare.com/" rel="noreferrer">Internet-scale applications efficiently</a>, accelerates any <a target="_blank" href="https://www.cloudflare.com/performance/accelerate-internet-applications/" rel="noreferrer">website or Internet application</a>, <a target="_blank" href="https://www.cloudflare.com/ddos/" rel="noreferrer">wards off DDoS attacks</a>, keeps <a target="_blank" href="https://www.cloudflare.com/application-security/" rel="noreferrer">hackers at bay</a>, and can help you on <a target="_blank" href="https://www.cloudflare.com/products/zero-trust/" rel="noreferrer">your journey to Zero Trust</a>.</p><p>Visit <a target="_blank" href="https://one.one.one.one/" rel="noreferrer">1.1.1.1</a> from any device to get started with our free app that makes your Internet faster and safer.</p><p>To learn more about our mission to help build a better Internet, <a target="_blank" href="https://www.cloudflare.com/learning/what-is-cloudflare/" rel="noreferrer">start here</a>. If you're looking for a new career direction, check out <a target="_blank" href="https://www.cloudflare.com/careers" rel="noreferrer">our open positions</a>.</p></div><a href="https://blog.cloudflare.com/tag/lavarand/">LavaRand</a><a href="https://blog.cloudflare.com/tag/entropy/">Entropy</a><a href="https://blog.cloudflare.com/tag/security/">Security</a><a href="https://blog.cloudflare.com/tag/randomness/">Randomness</a><a href="https://blog.cloudflare.com/tag/cryptography/">Cryptography</a><a href="https://blog.cloudflare.com/tag/portugal/">Portugal</a><a href="https://blog.cloudflare.com/tag/life-at-cloudflare/">Life at Cloudflare</a><a href="https://blog.cloudflare.com/tag/lisbon/">Lisbon</a><a href="https://blog.cloudflare.com/tag/offices/">Offices</a></article></div></div>]]></description>
        </item>
    </channel>
</rss>