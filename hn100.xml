<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>HN100 - Readable Contents</title>
        <link>https://hn.algolia.com/api/v1/search_by_date?tags=%28story,poll%29&amp;numericFilters=points%3E100</link>
        <description>Uses Readability to add bodies to the RSS feed</description>
        <lastBuildDate>Wed, 16 Aug 2023 12:00:03 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[Htmx is part of the GitHub Accelerator (155 pts)]]></title>
            <link>https://htmx.org/posts/2023-06-06-htmx-github-accelerator/</link>
            <guid>37144985</guid>
            <pubDate>Wed, 16 Aug 2023 10:19:32 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://htmx.org/posts/2023-06-06-htmx-github-accelerator/">https://htmx.org/posts/2023-06-06-htmx-github-accelerator/</a>, See on <a href="https://news.ycombinator.com/item?id=37144985">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
    
  
  <p>We are excited to announce that htmx has been accepted into the first class of the 
<a rel="noopener" target="_blank" href="https://accelerator.github.com/">GitHub Open Source Accelerator</a>!  This is a tremendous opportunity to work with and
learn from some of the most successful open source developers and projects, and a great chance to get the message
out about hypermedia and htmx.</p>
<p>We plan on using this opportunity to begin work on htmx 2.0 and, we hope, possibly learn how to make working on htmx
a full time job!</p>
<p>Here are some of the other open source projects that we have met through the GitHub accelerator and that we recommend 
people check out:</p>
<ul>
<li><a href="https://boxyhq.com/">BoxyHQ</a> - BoxyHQ’s suite of APIs for security and privacy helps engineering teams build and ship compliant cloud applications faster.</li>
<li><a href="https://cal.com/">Cal.com</a> - Cal.com is a scheduling tool that helps you schedule meetings without the back-and-forth emails.</li>
<li><a href="https://www.crowd.dev/">Crowd.dev</a> - Centralize community, product, and customer data to understand which companies are engaging with your open source project.</li>
<li><a href="https://documenso.com/">Documenso</a> - The Open-Source DocuSign Alternative. We aim to earn your trust by enabling you to self-host the platform and examine its inner workings.</li>
<li><a href="https://erxes.io/">Erxes</a> - The Open-Source HubSpot Alternative. A single XOS enables to create unique and life-changing experiences ​​that work for all types of business.</li>
<li><a href="https://formbricks.com/">Formbricks</a> - Survey granular user segments at any point in the user journey. Gather up to 6x more insights with targeted micro-surveys. All open-source.</li>
<li><a href="https://forwardemail.net/">Forward Email</a> - Free email forwarding for custom domains. For 6 years and counting, we are the go-to email service for thousands of creators, developers, and businesses.</li>
<li><a href="https://gitwonk.com/">GitWonk</a> - GitWonk is an open-source technical documentation tool, designed and built focusing on the developer experience.</li>
<li><a href="https://www.hanko.io/">Hanko</a> - Open-source authentication and user management for the passkey era. Integrated in minutes, for web and mobile apps.</li>
<li><a href="https://infisical.com/">Infisical</a> - Open source, end-to-end encrypted platform that lets you securely manage secrets and configs across your team, devices, and infrastructure.</li>
<li><a href="https://novu.co/">Novu</a> - The open-source notification infrastructure for developers. Simple components and APIs for managing all communication channels in one place.</li>
<li><a href="https://openbb.co/">OpenBB</a> - Democratizing investment research through an open source financial ecosystem. The OpenBB Terminal allows everyone to perform investment research, from everywhere.</li>
<li><a href="https://www.sniffnet.net/">Sniffnet</a> - Sniffnet is a network monitoring tool to help you easily keep track of your Internet traffic.</li>
<li><a href="https://typebot.io/">Typebot</a> - Typebot gives you powerful blocks to create unique chat experiences. Embed them anywhere on your apps and start collecting results like magic.</li>
<li><a href="https://www.webiny.com/">Webiny</a> - Open-source enterprise-grade serverless CMS. Own your data. Scale effortlessly. Customize everything.</li>
<li><a href="https://webstudio.is/">Webstudio</a> - Webstudio is an open source alternative to Webflow</li>
</ul>

</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Carl Sagan testifying before Congress on climate change (1985) [video] (122 pts)]]></title>
            <link>https://www.youtube.com/watch?v=Wp-WiNXH6hI</link>
            <guid>37143159</guid>
            <pubDate>Wed, 16 Aug 2023 05:28:09 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.youtube.com/watch?v=Wp-WiNXH6hI">https://www.youtube.com/watch?v=Wp-WiNXH6hI</a>, See on <a href="https://news.ycombinator.com/item?id=37143159">Hacker News</a></p>
&lt;Unparsable&gt;]]></description>
        </item>
        <item>
            <title><![CDATA[NetMaker: Connect Everything with a WireGuard VPN (163 pts)]]></title>
            <link>https://www.netmaker.io/</link>
            <guid>37142388</guid>
            <pubDate>Wed, 16 Aug 2023 03:00:40 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.netmaker.io/">https://www.netmaker.io/</a>, See on <a href="https://news.ycombinator.com/item?id=37142388">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><div><p>Privacy Preference Center</p></div><div><p>When you visit websites, they may store or retrieve data in your browser. This storage is often necessary for the basic functionality of the website. The storage may be used for marketing, analytics, and personalization of the site, such as storing your preferences. Privacy is important to us, so you have the option of disabling certain types of storage that may not be necessary for the basic functioning of the website. Blocking categories may impact your experience on the website.</p></div><div><p><strong>Manage Consent Preferences by Category</strong></p></div><div><p>These items are required to enable basic website functionality.</p></div><div><p>These items are used to deliver advertising that is more relevant to you and your interests. They may also be used to limit the number of times you see an advertisement and measure the effectiveness of advertising campaigns. Advertising networks usually place them with the website operator’s permission.</p></div><div><p>These items allow the website to remember choices you make (such as your user name, language, or the region you are in) and provide enhanced, more personal features. For example, a website may provide you with local weather reports or traffic news by storing data about your current location.</p></div><div><p>These items help the website operator understand how its website performs, how visitors interact with the site, and whether there may be technical issues. This storage type usually doesn’t collect information that identifies a visitor.</p></div></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Putting Down the Pen: Reflecting on Oryx’s Journey (133 pts)]]></title>
            <link>https://www.oryxspioenkop.com/2023/08/putting-down-pen-reflecting-on-oryxs.html</link>
            <guid>37141463</guid>
            <pubDate>Wed, 16 Aug 2023 01:01:24 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.oryxspioenkop.com/2023/08/putting-down-pen-reflecting-on-oryxs.html">https://www.oryxspioenkop.com/2023/08/putting-down-pen-reflecting-on-oryxs.html</a>, See on <a href="https://news.ycombinator.com/item?id=37141463">Hacker News</a></p>
<div id="readability-page-1" class="page"><article>
<div id="post-body-8031291285305773410" itemprop="articleBody">
<meta content="By Stijn Mitzer En güzel deniz: henüz gidilmemiş olandır. En güzel çocuk: henüz büyümedi. En güzel günlerimiz: henüz yaşamadıklarımız. Ve sa..." name="twitter:description">
<p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgvaZHx5v6tcHadcPJS32UMnzM7xOqZz6MjPWwGWXQuXdm6ho4sxbqZQwyZR0vjieO8JfmL_j-81TifqH-QitAqOlXsdUNMAqrxmI_t9nHCSpLN7eiFJKSgesTbs5gafwUAgcm4vX4094BlaMqCK2qPpldKTJA6cHddPoirb1Gvqa_MhqXOvaVUEVZh0gM/s2048/332.png"><img data-original-height="1514" data-original-width="2048" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEgvaZHx5v6tcHadcPJS32UMnzM7xOqZz6MjPWwGWXQuXdm6ho4sxbqZQwyZR0vjieO8JfmL_j-81TifqH-QitAqOlXsdUNMAqrxmI_t9nHCSpLN7eiFJKSgesTbs5gafwUAgcm4vX4094BlaMqCK2qPpldKTJA6cHddPoirb1Gvqa_MhqXOvaVUEVZh0gM/s16000/332.png"></a></p><p><i>By Stijn Mitzer</i><br></p><p><span><i>En güzel deniz: henüz gidilmemiş olandır. En güzel çocuk: henüz büyümedi. En güzel günlerimiz: henüz yaşamadıklarımız. Ve sana söylemek istediğim en güzel söz: henüz söylememiş olduğum sözdür</i> – The most beautiful sea, hasn't been crossed yet. The most beautiful child, hasn't grown up yet. Our most beautiful days, we haven't witnessed yet. And the most beautiful words I wanted to tell you, I haven't said yet.</span><span><span> <i>(<a href="https://youtu.be/ULW4g2jELFA?t=24">By</a> Nazım Hikmet)</i></span></span></p><p>Dear everyone,</p><p>I had always imagined 'penning' this farewell someday. You see, the journey of Oryx took a different path than its intended purpose. What Oryx was meant to be initially was a remedy for my teenage boredom at the age of 17. Back then, I was still in high school, and the manageable workload along with my recent departure from playing football left me with an abundance of spare time. An interest in the Arab Spring, in particular the Libyan and Syrian Revolutions, led me to spend more and more time scouring the internet for updates. As the Syrian Revolution evolved into protracted civil war, I decided to create a Twitter account to more closely monitor the unfolding events.</p><p>One of the accounts I followed was that of Eliot Higgins, who began reporting on the Syrian Civil War on his Brown Moses Blog. After asking him one day if he was going to report on the use of Italian-upgraded T-72 tanks in the war, I remember telling myself that if a ''high-school dropout who knew no more about weapons than the average Xbox owner'' was able to write these articles, so would I probably. That evening, I created a blog, picked a name (Oryx for the majestic animal, and Spioenkop, Afrikaans for 'spy hill', as a place from where one can watch events unfold around the world) and published my first article on Syria's T-72 MBTs. (For those interested, the article can be read <a href="https://web.archive.org/web/20141019093200/http://spioenkop.blogspot.com/2013/02/syrian-turms-t-equipped-t-72s.html">here</a>).</p><p>It was the 16th of February 2013, and little did I realise that the next decade would transform Oryx from a remedy for boredom into a project that would consume the majority of my time and energy. I can still recall the joy I felt when the T-72 article garnered 520 views in just several hours, contributing to a total view count of approximately 3500 for the entire blog that month. Fast forward ten years, and Oryx now achieves an average of 250,000 daily views. In the months following my inaugural article, I continued to write about Syria, a country that held my focus until 2017.&nbsp;However, a desire towards greater challenges was always present. My motivation thrives on challenges. Offer me the most difficult subject to analyse. Upon mastering the subject's intricacies, I seek out the next challenge.</p><p>I ultimately discovered my greatest challenge in the analysis of North Korea. Back in the early 2010s, the scarcity of photographs and videos emerging from the country, in stark contrast to the flood of visual content available now, intrigued me. The limited information available, coupled with the abundance of misinformation, arguably made it the most challenging country to analyse. Through a series of articles and our eventual book(s), Joost and I attempted to unravel the mysteries surrounding the Korean People's Army. Finishing the final pages of the book left me feeling satisfied with North Korea – we had done what we aimed for. We unearthed the answers to our questions. With this challenge resolved, I started looking for another subject that would keep me curious and motivated.</p><p>Finding a challenge this time around proved much harder than before. However, the Nagorno-Karabakh War, Türkiye('s defence industry) and the Tigray War eventually emerged as subjects that provided me with both analytical satisfaction and the desired level of complexity. Their status as topics that Western analysts scarcely delved into rendered them all the more interesting to me. In contrast to mainstream media, we weren't confined by the need to generate popular articles and headlines. Instead, we saw this as an opportunity to illuminate underreported conflicts like the Tigray War, the Libyan War and the War in Yemen. Continuously delving into various countries and conflicts kept Oryx fresh for me, but it has also brought me to a place where I feel that I've largely covered the subjects I intended to explore. The journey has been a source of pleasure, but it has now arrived at its final destination. </p><p>Since late 2021, the act of writing feels repetitive, almost as if I've written every sentence before. For me, this realisation serves as a clear sign that it's time to move on. In fact, I had already contemplated ending Oryx by the spring of 2022, but the Russian invasion of Ukraine infused me with renewed energy to keep going. But 1.5 years later, I have lost my spark. My interest in anything military is fading, and the 
constant pressure to keep up with everything is exhausting. I
usually fall asleep with my phone in hand, only to wake up finding 
I've been sleeping on it. I'm tired of all the death and 
destruction. It's been a whole decade of watching videos of people's bodies having been torn apart by bombs or parents holding their lifeless newborns who died as a result of armed conflict – it really gets to you.</p><p>Still, I take great joy in the opportunities that Oryx has brought
 me, as well as from the lifelong friendships with Joost and Kemal. While I'm aware of options such as securing a position at a 
think tank or even transforming Oryx into a lucrative private 
intelligence agency, these career paths hold no appeal for me. 
I think I possess a moral compass that doesn't align with such institutions' goals. Despite the potential for financial gains through Oryx, I consciously 
opt not to pursue them. To me, the act of <a href="https://www.oryxspioenkop.com/2023/07/patreon-with-purpose-how-your-donations.html">donating</a> our entire Patreon 
income to charities seemed like the only possible course of action. Amidst ongoing wars and natural disasters, it's difficult to justify to ourselves to hold onto money without considering the greater need. Money doesn't tempt me, especially when it's associated with conflict. True wealth, for me, is found within family, health, and finding happiness in the little things in life. A forest stroll or spending time with friends makes me feel genuinely rich. Learning this lesson at a young age is priceless.<br></p><p>Over the years I've come to realise that, to me, genuine success and happiness are scarcely influenced by popularity, recognition, or even publishing a book. While these achievements hold their own significance, they haven't truly brought me a sense of pride. My most significant accomplishments involve making those dear to me proud and understanding the essence of happiness at a young age. Oryx has shown me that that true happiness cannot be attained through fame, career accomplishments, or wealth. Despite Oryx gaining recognition – being featured on major TV channels, acknowledged by figures like John McCain and David Petraeus, and with our information used by intelligence agencies – my proudest moment remains being able to write a message in my book I gave to my then girlfriend. You've shown me what real happiness looks like T. Nothing could ever surpass that. Thank you for that.</p><p>Reflecting on the last decade, I hope that Oryx has and will continue to motivate others to set out on their own journey of analysis and writing. Starting at the age of 17 without ever taking any education in the field of defence or international relations, Oryx can be seen as evidence that great opportunities await those who choose a similar path.<i> </i>What added to the excitement was the interaction with readers on Twitter, which I've thoroughly enjoyed over the years.<i> </i>At a certain point, the number of messages became overwhelming, so I want to apologise if you never received a response. I also want to express my sincere appreciation to all those who have offered their assistance in various capacities to Oryx over the years, with a special acknowledgment to Jakub.<i> </i>What began as a childhood interest ignited by buying Buck Danny and Biggles comic strips when I was 8 years old blossomed into a hobby that has far exceeded any reasonable limits. Although I once contemplated a position with an intelligence agency, an offer never came to fruition (perhaps fortunate given their bureaucracy).<br></p><p>Lastly, I feel compelled to discuss the origin of the practice of list-making and its evolution over time. We began our venture into list-making in 2013 with the goal of aiding our internal analysis. The abundance and variations of North Korea's armored fighting vehicles (AFVs) posed a challenge, prompting us to catalog them before we could analyse them effectively. This initial list set the groundwork for subsequent lists, although it wasn't until the summer of 2014 that we embarked on compiling the 'losses lists,' intended to illustrate the staggering volume of armament and equipment captured by IS in the regions of Iraq and Syria. The rapid proliferation of these lists, owing to the relatively straightforward process of creating them, is probably what Oryx will primarily be remembered for. The lists gained such popularity that I found myself (somewhat jokingly) <a href="https://www.oryxspioenkop.com/2023/04/list-listing-oryx-list-of-lists.html">embracing</a> the entire act of list-making on Oryx with a list of lists. However, I must confess, I have an aversion to planning ahead and never create lists in my everyday life. Sorry!<br></p><p>As I bid farewell on October 1st, I'll leave you with these lines from my most beloved song&nbsp;<a href="https://youtu.be/rbTsG9jrJsU">Ue o Muite Arukō</a> by my favourite singer Sakamoto Kyu.</p><p>Shiawase wa kumo no ue ni - Happiness lies beyond the clouds<br>Shiawase wa sora no ue ni - Happiness lies up above the sky</p><div><p><a href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhtnZJ-bwbP3CxrgnPayC7m3hemRUxyrBx0CGpxkGznAxI0peglIaclhnBvMY5TpTgy3_dnuKRmVGAnIBTONUspdY2paVxmrbxyfU2P6gidj0Kq9QOOuiKBXTy8xxOzRm0TtUlbsvu-CG--Uuoyw3MFUWztj8vtXnUMjVQx_ZWr4ex73BMRjT_pObvOMgM/s2048/25.png"><img data-original-height="1320" data-original-width="2048" height="412" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEhtnZJ-bwbP3CxrgnPayC7m3hemRUxyrBx0CGpxkGznAxI0peglIaclhnBvMY5TpTgy3_dnuKRmVGAnIBTONUspdY2paVxmrbxyfU2P6gidj0Kq9QOOuiKBXTy8xxOzRm0TtUlbsvu-CG--Uuoyw3MFUWztj8vtXnUMjVQx_ZWr4ex73BMRjT_pObvOMgM/w640-h412/25.png" width="640"></a></p><p>PS: Just to clarify, I'm not being sponsored by the Põhjala beer brand – there was a half-price deal for a second bottle at my nearby supermarket. My Dutch spirit remains intact, after all. <br></p></div>
</div>
</article></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Modern CSV version 2 (266 pts)]]></title>
            <link>https://www.moderncsv.com/modern-csv-2-is-now-available/</link>
            <guid>37140159</guid>
            <pubDate>Tue, 15 Aug 2023 22:35:09 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.moderncsv.com/modern-csv-2-is-now-available/">https://www.moderncsv.com/modern-csv-2-is-now-available/</a>, See on <a href="https://news.ycombinator.com/item?id=37140159">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><p>And I think you’ll love it. I focused on several areas:</p>
<ol>
<li>Improved UI and user experience</li>
<li>Faster performance</li>
<li>Useful features</li>
<li>Updated documentation</li>
<li>For Mac users, Native Apple Silicon (ARM – M1, M2) compatibility</li>
</ol>
<p><a href="https://www.moderncsv.com/download" target="_blank"><span>Download Modern CSV 2</span></a></p><p>If that’s all you need to know, you can buy a license <a href="https://www.moderncsv.com/buy">here</a>.<br>
Or if you already have a version 1 license, you can upgrade <a href="https://www.moderncsv.com/upgrade">here</a>.<br>
For those that need more details, here you go.</p>
<h2>Improved UI and User Experience</h2>
<p>There are two areas of the user interface that I aimed to improve for usability: Preferences and File Metadata. I also added several new themes and a bunch of subtle improvements to make it look and feel better.</p>
<p><img decoding="async" fetchpriority="high" src="https://www.moderncsv.com/wp-content/uploads/2023/04/Mac-v2.png" alt="Modern CSV v2" width="1068" height="592" srcset="https://www.moderncsv.com/wp-content/uploads/2023/04/Mac-v2.png 1068w, https://www.moderncsv.com/wp-content/uploads/2023/04/Mac-v2-300x166.png 300w, https://www.moderncsv.com/wp-content/uploads/2023/04/Mac-v2-1024x568.png 1024w, https://www.moderncsv.com/wp-content/uploads/2023/04/Mac-v2-768x426.png 768w, https://www.moderncsv.com/wp-content/uploads/2023/04/Mac-v2-135x75.png 135w, https://www.moderncsv.com/wp-content/uploads/2023/04/Mac-v2-480x266.png 480w" sizes="(max-width:767px) 480px, (max-width:1068px) 100vw, 1068px" data-old-src="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%201068%20592'%3E%3C/svg%3E" data-lazy-srcset="https://www.moderncsv.com/wp-content/uploads/2023/04/Mac-v2.png 1068w, https://www.moderncsv.com/wp-content/uploads/2023/04/Mac-v2-300x166.png 300w, https://www.moderncsv.com/wp-content/uploads/2023/04/Mac-v2-1024x568.png 1024w, https://www.moderncsv.com/wp-content/uploads/2023/04/Mac-v2-768x426.png 768w, https://www.moderncsv.com/wp-content/uploads/2023/04/Mac-v2-135x75.png 135w, https://www.moderncsv.com/wp-content/uploads/2023/04/Mac-v2-480x266.png 480w" data-lazy-src="https://www.moderncsv.com/wp-content/uploads/2023/04/Mac-v2.png"></p>
<h3>Preferences</h3>
<p>In version 1, preferences (i.e. program settings, keyboard shortcuts, and file extension options) could only be set by editing and saving a file. Some users really liked this and others preferred a UI. I decided to give everyone what they want. For those who like it, you can still edit the preference files just like in version 1. For everyone else, there is a Preferences window that is more intuitive and less prone to mistakes.</p>
<div id="attachment_1786"><p><img aria-describedby="caption-attachment-1786" decoding="async" src="https://www.moderncsv.com/wp-content/uploads/2023/04/Settings.png" alt="Settings Window" width="827" height="465" srcset="https://www.moderncsv.com/wp-content/uploads/2023/04/Settings.png 827w, https://www.moderncsv.com/wp-content/uploads/2023/04/Settings-300x169.png 300w, https://www.moderncsv.com/wp-content/uploads/2023/04/Settings-768x432.png 768w, https://www.moderncsv.com/wp-content/uploads/2023/04/Settings-260x146.png 260w, https://www.moderncsv.com/wp-content/uploads/2023/04/Settings-50x28.png 50w, https://www.moderncsv.com/wp-content/uploads/2023/04/Settings-133x75.png 133w" sizes="(max-width:767px) 480px, (max-width:827px) 100vw, 827px" data-old-src="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20827%20465'%3E%3C/svg%3E" data-lazy-srcset="https://www.moderncsv.com/wp-content/uploads/2023/04/Settings.png 827w, https://www.moderncsv.com/wp-content/uploads/2023/04/Settings-300x169.png 300w, https://www.moderncsv.com/wp-content/uploads/2023/04/Settings-768x432.png 768w, https://www.moderncsv.com/wp-content/uploads/2023/04/Settings-260x146.png 260w, https://www.moderncsv.com/wp-content/uploads/2023/04/Settings-50x28.png 50w, https://www.moderncsv.com/wp-content/uploads/2023/04/Settings-133x75.png 133w" data-lazy-src="https://www.moderncsv.com/wp-content/uploads/2023/04/Settings.png"></p><p id="caption-attachment-1786">Settings Window</p></div>

<div id="attachment_1785"><p><img aria-describedby="caption-attachment-1785" decoding="async" src="https://www.moderncsv.com/wp-content/uploads/2023/04/KeyboardShortcuts.png" alt="Keyboard Shortcuts Window" width="827" height="465" srcset="https://www.moderncsv.com/wp-content/uploads/2023/04/KeyboardShortcuts.png 827w, https://www.moderncsv.com/wp-content/uploads/2023/04/KeyboardShortcuts-300x169.png 300w, https://www.moderncsv.com/wp-content/uploads/2023/04/KeyboardShortcuts-768x432.png 768w, https://www.moderncsv.com/wp-content/uploads/2023/04/KeyboardShortcuts-260x146.png 260w, https://www.moderncsv.com/wp-content/uploads/2023/04/KeyboardShortcuts-50x28.png 50w, https://www.moderncsv.com/wp-content/uploads/2023/04/KeyboardShortcuts-133x75.png 133w" sizes="(max-width:767px) 480px, (max-width:827px) 100vw, 827px" data-old-src="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20827%20465'%3E%3C/svg%3E" data-lazy-srcset="https://www.moderncsv.com/wp-content/uploads/2023/04/KeyboardShortcuts.png 827w, https://www.moderncsv.com/wp-content/uploads/2023/04/KeyboardShortcuts-300x169.png 300w, https://www.moderncsv.com/wp-content/uploads/2023/04/KeyboardShortcuts-768x432.png 768w, https://www.moderncsv.com/wp-content/uploads/2023/04/KeyboardShortcuts-260x146.png 260w, https://www.moderncsv.com/wp-content/uploads/2023/04/KeyboardShortcuts-50x28.png 50w, https://www.moderncsv.com/wp-content/uploads/2023/04/KeyboardShortcuts-133x75.png 133w" data-lazy-src="https://www.moderncsv.com/wp-content/uploads/2023/04/KeyboardShortcuts.png"></p><p id="caption-attachment-1785">Keyboard Shortcuts Window</p></div>

<div id="attachment_1790"><p><img aria-describedby="caption-attachment-1790" decoding="async" src="https://www.moderncsv.com/wp-content/uploads/2023/04/FileExtensionOptions.png" alt="File Extension Options" width="827" height="465" srcset="https://www.moderncsv.com/wp-content/uploads/2023/04/FileExtensionOptions.png 827w, https://www.moderncsv.com/wp-content/uploads/2023/04/FileExtensionOptions-300x169.png 300w, https://www.moderncsv.com/wp-content/uploads/2023/04/FileExtensionOptions-768x432.png 768w, https://www.moderncsv.com/wp-content/uploads/2023/04/FileExtensionOptions-260x146.png 260w, https://www.moderncsv.com/wp-content/uploads/2023/04/FileExtensionOptions-50x28.png 50w, https://www.moderncsv.com/wp-content/uploads/2023/04/FileExtensionOptions-133x75.png 133w" sizes="(max-width:767px) 480px, (max-width:827px) 100vw, 827px" data-old-src="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20827%20465'%3E%3C/svg%3E" data-lazy-srcset="https://www.moderncsv.com/wp-content/uploads/2023/04/FileExtensionOptions.png 827w, https://www.moderncsv.com/wp-content/uploads/2023/04/FileExtensionOptions-300x169.png 300w, https://www.moderncsv.com/wp-content/uploads/2023/04/FileExtensionOptions-768x432.png 768w, https://www.moderncsv.com/wp-content/uploads/2023/04/FileExtensionOptions-260x146.png 260w, https://www.moderncsv.com/wp-content/uploads/2023/04/FileExtensionOptions-50x28.png 50w, https://www.moderncsv.com/wp-content/uploads/2023/04/FileExtensionOptions-133x75.png 133w" data-lazy-src="https://www.moderncsv.com/wp-content/uploads/2023/04/FileExtensionOptions.png"></p><p id="caption-attachment-1790">File Extension Options</p></div>
<h3>File Metadata</h3>
<p>In version 1, changing the file’s parameters (e.g. delimiter, character encoding, etc.) or header row/column settings was all done via command. In version 2, you can still do it via command, but there’s now a File Metadata pane to make it easier.</p>
<div id="attachment_1784"><p><img aria-describedby="caption-attachment-1784" decoding="async" src="https://www.moderncsv.com/wp-content/uploads/2023/04/FileMetadata.png" alt="File Metadata Pane" width="388" height="703" srcset="https://www.moderncsv.com/wp-content/uploads/2023/04/FileMetadata.png 388w, https://www.moderncsv.com/wp-content/uploads/2023/04/FileMetadata-166x300.png 166w, https://www.moderncsv.com/wp-content/uploads/2023/04/FileMetadata-81x146.png 81w, https://www.moderncsv.com/wp-content/uploads/2023/04/FileMetadata-28x50.png 28w, https://www.moderncsv.com/wp-content/uploads/2023/04/FileMetadata-41x75.png 41w" sizes="(max-width:767px) 388px, 388px" data-old-src="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20388%20703'%3E%3C/svg%3E" data-lazy-srcset="https://www.moderncsv.com/wp-content/uploads/2023/04/FileMetadata.png 388w, https://www.moderncsv.com/wp-content/uploads/2023/04/FileMetadata-166x300.png 166w, https://www.moderncsv.com/wp-content/uploads/2023/04/FileMetadata-81x146.png 81w, https://www.moderncsv.com/wp-content/uploads/2023/04/FileMetadata-28x50.png 28w, https://www.moderncsv.com/wp-content/uploads/2023/04/FileMetadata-41x75.png 41w" data-lazy-src="https://www.moderncsv.com/wp-content/uploads/2023/04/FileMetadata.png"></p><p id="caption-attachment-1784">File Metadata Pane</p></div>
<h3>Themes</h3>
<p>Version 1 had two themes – Light and Dark. Version 2 has five – Light, Dark, Dracula, Solarized Light, and Solarized Dark.</p>
<div id="attachment_1789"><p><img aria-describedby="caption-attachment-1789" decoding="async" src="https://www.moderncsv.com/wp-content/uploads/2023/04/Dracula.png" alt="Dracula Theme" width="878" height="498" srcset="https://www.moderncsv.com/wp-content/uploads/2023/04/Dracula.png 878w, https://www.moderncsv.com/wp-content/uploads/2023/04/Dracula-300x170.png 300w, https://www.moderncsv.com/wp-content/uploads/2023/04/Dracula-768x436.png 768w, https://www.moderncsv.com/wp-content/uploads/2023/04/Dracula-257x146.png 257w, https://www.moderncsv.com/wp-content/uploads/2023/04/Dracula-50x28.png 50w, https://www.moderncsv.com/wp-content/uploads/2023/04/Dracula-132x75.png 132w" sizes="(max-width:767px) 480px, (max-width:878px) 100vw, 878px" data-old-src="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20878%20498'%3E%3C/svg%3E" data-lazy-srcset="https://www.moderncsv.com/wp-content/uploads/2023/04/Dracula.png 878w, https://www.moderncsv.com/wp-content/uploads/2023/04/Dracula-300x170.png 300w, https://www.moderncsv.com/wp-content/uploads/2023/04/Dracula-768x436.png 768w, https://www.moderncsv.com/wp-content/uploads/2023/04/Dracula-257x146.png 257w, https://www.moderncsv.com/wp-content/uploads/2023/04/Dracula-50x28.png 50w, https://www.moderncsv.com/wp-content/uploads/2023/04/Dracula-132x75.png 132w" data-lazy-src="https://www.moderncsv.com/wp-content/uploads/2023/04/Dracula.png"></p><p id="caption-attachment-1789">Dracula Theme</p></div>

<div id="attachment_1788"><p><img aria-describedby="caption-attachment-1788" decoding="async" src="https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedLight.png" alt="Solarized Light Theme" width="878" height="498" srcset="https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedLight.png 878w, https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedLight-300x170.png 300w, https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedLight-768x436.png 768w, https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedLight-257x146.png 257w, https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedLight-50x28.png 50w, https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedLight-132x75.png 132w" sizes="(max-width:767px) 480px, (max-width:878px) 100vw, 878px" data-old-src="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20878%20498'%3E%3C/svg%3E" data-lazy-srcset="https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedLight.png 878w, https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedLight-300x170.png 300w, https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedLight-768x436.png 768w, https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedLight-257x146.png 257w, https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedLight-50x28.png 50w, https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedLight-132x75.png 132w" data-lazy-src="https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedLight.png"></p><p id="caption-attachment-1788">Solarized Light Theme</p></div>

<div id="attachment_1787"><p><img aria-describedby="caption-attachment-1787" decoding="async" src="https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedDark.png" alt="Solarized Dark Theme" width="878" height="498" srcset="https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedDark.png 878w, https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedDark-300x170.png 300w, https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedDark-768x436.png 768w, https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedDark-257x146.png 257w, https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedDark-50x28.png 50w, https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedDark-132x75.png 132w" sizes="(max-width:767px) 480px, (max-width:878px) 100vw, 878px" data-old-src="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20878%20498'%3E%3C/svg%3E" data-lazy-srcset="https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedDark.png 878w, https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedDark-300x170.png 300w, https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedDark-768x436.png 768w, https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedDark-257x146.png 257w, https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedDark-50x28.png 50w, https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedDark-132x75.png 132w" data-lazy-src="https://www.moderncsv.com/wp-content/uploads/2023/04/SolarizedDark.png"></p><p id="caption-attachment-1787">Solarized Dark Theme</p></div>
<h2>Faster Performance</h2>
<p>The first thing you’ll notice is that it loads faster than version 1. The load time has been cut nearly in half.<br>
For loading large files in read-only mode, load time has been reduced by nearly 20%<br>
Lastly, the performance for loading files with many columns has been reduced by over 90%. That’s a full order of magnitude.</p>
<h2>Useful Features</h2>
<p>I make sure that any feature I add is going to be useful to a broad swatch of Modern CSV users. Most of them have been requested by users. The rest are features I find useful, and since I use my own product, I count as a user. Here are some of the most important new features:</p>
<p>* Select all results of a Find operation.<br>
* Open a new instance.<br>
* Deduplicate rows based on just a few columns (instead of only removing rows that are the same on every column). [Premium]<br>
* Reshape (change dimensions) of a range of cells. [Premium]<br>
* Statistics and Column Analysis. [Premium Business]<br>
* Column Lookup. [Premium Business]</p>
<p>For a more comprehensive list, see the <a href="https://www.moderncsv.com/download">Download page</a>.</p>
<h2>Updated Documentation</h2>
<p>The old documentation was single page and was starting to get pretty large. The new documentation has multiple pages with excellent navigation and search functionality. It’s more comprehensive but still concise. I endeavor to use graphics instead of words when possible.</p>
<h2>Native Apple Silicon (ARM – M1, M2) Compatibility</h2>
<p>Rosetta is no longer needed to run Modern CSV on Apple Silicon machines.</p>
<h2>Conclusion</h2>
<p>A lot of work went into making Modern CSV 2.0. I hope you find it makes editing and viewing CSV files even easier. Please feel free to try it out and let me know what you think.</p>
<p><a href="" target="_blank"><span>Download Modern CSV 2</span></a></p><p>If you’re ready to buy a license, you can do so here <a href="https://www.moderncsv.com/buy">here</a>.</p>
<p>If you already have a version 1 license, you can upgrade <a href="https://www.moderncsv.com/upgrade">here</a>.</p>
</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[How Is LLaMa.cpp Possible? (544 pts)]]></title>
            <link>https://finbarr.ca/how-is-llama-cpp-possible/</link>
            <guid>37140013</guid>
            <pubDate>Tue, 15 Aug 2023 22:18:17 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://finbarr.ca/how-is-llama-cpp-possible/">https://finbarr.ca/how-is-llama-cpp-possible/</a>, See on <a href="https://news.ycombinator.com/item?id=37140013">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="content">
    
    
    
    <p><em>If you want to read more of my writing, I have a <a href="https://finbarrtimbers.substack.com/">Substack</a>. Articles will be posted simultaneously to both places.</em></p>

<p>Recently, a <a href="https://github.com/ggerganov/llama.cpp">project</a> rewrote the <a href="https://github.com/facebookresearch/llama">LLaMa inference code</a> in raw C++. With some optimizations and quantizing the weights, this allows running a LLM locally on a wild variety of hardware:</p>

<ul>
  <li>On a <a href="https://twitter.com/rgerganov/status/1635604465603473408">Pixel5</a>, you can run the 7B parameter model at 1 tokens/s.</li>
  <li>On a <a href="https://simonwillison.net/2023/Mar/11/llama/">M2 Macbook Pro</a>, you can get ~16 tokens/s with the 7B parameter model</li>
  <li>You can <a href="https://twitter.com/miolini/status/1634982361757790209">even run the 7B model on a 4GB RAM Raspberry Pi</a>, albeit at 0.1 tokens/s.</li>
</ul>

<p>If you are like me, you saw this and thought: What? How is this possible? Don’t large models require expensive GPUs? I took my confusion and dove into the math surrounding inference requirements to understand the constraints we’re dealing with.</p>

<p>Let’s start with GPUs. GPUs have two main benefits for deep learning:</p>

<ol>
  <li>They have a large amount of memory bandwidth (<a href="https://www.nvidia.com/content/dam/en-zz/Solutions/Data-Center/a100/pdf/nvidia-a100-datasheet-us-nvidia-1758950-r4-web.pdf">A100</a>: 1935 GB/s, <a href="https://images.nvidia.com/aem-dam/Solutions/geforce/ada/ada-lovelace-architecture/nvidia-ada-gpu-architecture-whitepaper-1.03.pdf">4090</a>: 1008 GB/s)</li>
  <li>They have a large amount of compute (<a href="https://www.nvidia.com/content/dam/en-zz/Solutions/Data-Center/a100/pdf/nvidia-a100-datasheet-us-nvidia-1758950-r4-web.pdf">A100</a>: 312 TFLOPS of FP16, <a href="https://images.nvidia.com/aem-dam/Solutions/geforce/ada/ada-lovelace-architecture/nvidia-ada-gpu-architecture-whitepaper-1.03.pdf">4090</a>: 82.6 TFLOPS of FP16)</li>
</ol>

<p>When we talk about memory bandwidth, we’re talking about how long it takes to move things from the HBM memory (i.e. the RAM) into the on-chip memory. To actually do math with the GPU, we need to move the matrices in question into the on-chip memory, which is quite small (40MB on an A100, compared to 40-80GB of RAM). Note that the memory bandwidth is ~2 orders of magnitude smaller than the compute performance— this will matter later, as the memory bandwidth tends to be the bottleneck for inference.</p>

<p>What does this mean in the context of serving LLaMa? Let’s start with some <a href="https://kipp.ly/blog/transformer-inference-arithmetic/">inference arithmetic</a>. We can do some rough calculations on the inference performance of a LLM using <a href="https://kipp.ly/blog/transformer-param-count/">Kipply’s article</a><sup id="fnref:1" role="doc-noteref"><a href="#fn:1" rel="footnote">1</a></sup>. First, some notation on the dimensions of the model:</p>

<ul>
  <li>The \(Q\), \(K\), and \(V\) weight matrices are all shape [ \(d_{\text{model}}\), \(d_{\text{head}}\)], and we have \(n_{\text{heads}}\) of them per layer; the attention output matrix has the same shape, for a total of  \(4 \times\) [ \(d_{\text{model}}\), \(n_{\text{heads}} \cdot d_{\text{head}}\)]. By convention, GPT-style networks have \(d_{\text{head}} \cdot n_{\text{heads}} = d_{\text{model}}\).</li>
  <li>The MLP has two weight matrices, of shape [ \(d_{\text{model}}\), \(4 \cdot d_{\text{model}}\)] and [ \(4\cdot d_{\text{model}}\), \(d_{\text{model}}\)]</li>
  <li>The embeddings matrix is of size [ \(d_{\text{vocab}}\), \(d_{\text{model}}\)].</li>
</ul>

<p>This gives us a handy equation for the number of parameters in a GPT-style model:<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" rel="footnote">2</a></sup></p><p>

\[P = n_{\text{blocks}} \left( 4 \cdot d_{\text{model}}^2 + 2 \cdot 4 \cdot d_{\text{model}}^2\right) + n_{\text{vocab}} \cdot d_{\text{model}}\]

</p><p>For the duration of the post, I’m going to focus on the case where we’re running a ChatGPT style service locally, which is what LLaMa.cpp does, letting me assume a batch size of 1.</p>

<p>For efficient inference, the KV cache has to be stored in memory; the KV cache requires storing the KV values for every layer, which is equal to storing:</p><p>

\[n_{\text{bytes}} \cdot 2 \cdot d_{\text{model}}\]

</p><p>I use \(n_{\text{bytes}}\) here to indicate the number of bytes per param; for float32s, this is 4, for float16s, this is 2, etc. The 2 in the middle is because we have to store one set of weights for the K values, and one for the Vs.</p>

<p>Given a model with n layers, the total memory for the KV cache is:</p><p>

\[n_{\text{blocks}} \cdot n_{\text{bytes}} \cdot 2 \cdot d_{\text{model}}\]

</p><p>In addition to storing the KV cache in memory, we also need to store the weights themselves in memory; this requires \(n_{\text{bytes}} \cdot P\) bytes.</p>

<p><img src="https://finbarr.ca/static/images/llama-memory-weights.png" alt="Screenshot of table showing the memory required for LLaMa weights"></p>

<p>This is the advantage of quantization. By using less precision, we can radically decrease the amount of memory needed to store our models in memory. Note that, with int4 precision, <em>all of these models fit into memory on an A100</em> (which is the standard datacenter GPU right now), and all of them, except for the biggest model, fit into memory on high-end consumer GPUs (3090s/4090s, which have 24GB of RAM).</p>

<p>It takes approximately \(2P\) FLOPS to run inference on our model for a single token, because we are doing a bunch of matmuls with a total of \(P\) parameters, and multiplying a matrix of size \((m, n)\) with a vector of size \((n,)\) has a cost of \(2mn\).<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" rel="footnote">3</a></sup></p>

<p>With all that math out of the way, let’s calculate the requirements for running inference with LLaMa. The main requirements when it comes to sampling are:</p>

<ol>
  <li>Keep the KV cache in memory, in addition to all the parameters.</li>
  <li>Read all the weights from HBM into the on-chip memory. Because we sample auto-regressively, we have to repeat this for each token we sample.</li>
  <li>Do the actual matmuls to calculate the output of our network.</li>
</ol>

<p>The latency is the maximum of either the compute or the memory latency, as reading parameters into on-chip memory happens asynchronously in all modern tensor programming libraries. As a result, we write:</p><p>

\[\begin{align*}
\text{latency}_\text{model} &amp;= \text{max}(\text{latency}_\text{compute}, \text{latency}_\text{memory})\\
\text{latency}_\text{memory} &amp;= \dfrac{2 \cdot P \cdot n_{\text{bytes}}\cdot B}{n_{\text{memory bandwidth}}},\\
\text{latency}_\text{compute} &amp;= \dfrac{2 \cdot P}{n_{\text{flops}}},
\end{align*}\]

</p><p>where \(B\) is the batch size. As \(n_{\text{memory bandwidth}} = 1.935e12\), and  \(n_{\text{flops}} = 3.12e14,\) as long as the batch size is less than 161, the model is memory-bound.<sup id="fnref:4" role="doc-noteref"><a href="#fn:4" rel="footnote">4</a></sup></p>

<p>With a batch size of 1, this is the same equation, as on most hardware (e.g. Nvidia GPUs), there is a linear speedup as you decrease the precision (you get twice the FLOPS when using fp16 vs fp32, which doubles again as you go to int8, and doubles once more as you go to int4s).</p>

<p>As LLaMa.cpp uses int4s, the RAM requirements are reduced to 1.33GB of memory for the KV cache, and 16.25GB of VRAM for the model parameters. That’s pretty good!</p>

<p>As the memory bandwidth is almost always<sup id="fnref:5" role="doc-noteref"><a href="#fn:5" rel="footnote">5</a></sup> much smaller than the number of FLOPS, memory bandwidth is the binding constraint.</p>

<p><img src="https://finbarr.ca/static/images/llama-inference-times.png" alt="Screenshot fo table showing the inference times to run the varying LLaMa models with varying precision levels on an A100"></p>

<h2 id="running-llama-on-an-a100">Running LLaMa on an A100</h2>

<p>On an A100 (80GB PCIe), the memory bandwidth is 1935GB/s. The int4 compute is 1248 TOPS. As such, the model is (heavily) memory-bound. We should expect to see inferences as given in the table; roughly 30 tokens/s with the 65B model, and 277 tokens/s with the 7B model.</p>

<h2 id="running-llama-on-a-m1-macbook-air">Running LLaMa on a M1 Macbook Air</h2>

<p>The M1 GPU has a bandwidth of <a href="https://www.macworld.com/article/783678/m2-vs-m1-chip-performance-graphics-ram.html">68.25 GB/s</a>, while the M1 GPU can do up to <a href="https://tlkh.dev/benchmarking-the-apple-m1-max#heading-gpu-matrix-multiplication-gemm-performance">5.5 TFLOPS</a> of fp16 compute. As such, we should expect a ceiling of ~1 tokens/s for sampling from the 65B model with int4s, and 10 tokens/s with the 7B model.</p>

<p>As the M2 Pro has 200 GB/s of bandwidth, and the M2 Max has 400 GB/s of bandwidth, we should expect massive improvements with them, going up to 6 tokens/s with the M2 Max with the 65B model. That’s pretty darn good for a laptop.</p>

<h2 id="running-llama-on-a-raspberry-pi-4">Running LLaMa on a Raspberry Pi 4</h2>

<p>A Raspberry Pi 4 has <a href="https://web.eece.maine.edu/~vweaver/group/green_machines.html">13.5 GFLOPS of compute</a>, and <a href="https://forums.raspberrypi.com/viewtopic.php?t=281183">~4GB/s of memory bandwidth</a>. Given this, we’d expect to see ~2 tokens/s with the 7B model if it was memory bound. Given that we’re currently seeing ~0.1 tokens/s, I suspect we’re actually compute-bound (although this is a stab in the dark— I can’t find enough information about the specs for a Raspberry Pi to determine this with any precision).</p>

<h2 id="summary">Summary</h2>

<p>Memory bandwidth is the limiting factor in almost everything to do with sampling from transformers. Anything that reduces the memory requirements for these models makes them <em>much</em> easier to serve— like quantization! This is yet another reason why distillation, or just <a href="https://finbarr.ca/llms-not-trained-enough/">training smaller models for longer</a>, is really important.</p>

<p><em>Note: I’m not an expert in CUDA, so I probably have errors in my math. If so, please shoot me an <a href="mailto:finbarrtimbers@gmail.com">email</a> and let me know- I’d love to hear from you so I can learn more about how this works and update this post.</em></p>

<p>Resources on transformer inference performance:</p>

<ul>
  <li><a href="https://lilianweng.github.io/posts/2023-01-10-inference-optimization/">Large Transformer Model Inference Optimization</a></li>
  <li><a href="https://kipp.ly/blog/transformer-inference-arithmetic/">Transformer inference arithmetic</a></li>
  <li><a href="https://kipp.ly/blog/transformer-param-count/">LLM parameter counting</a></li>
  <li><a href="https://arxiv.org/abs/2009.06732">Efficient Transformers</a></li>
</ul>

<p><em>Thank you to <a href="https://twitter.com/kaushikpatnaik?lang=en">Kaushik Patnaik</a>, <a href="https://twitter.com/arthurallshire">Arthur Allshire</a>, <a href="https://twitter.com/stanislavfort">Stanislav Fort</a>, and <a href="https://twitter.com/banburismus_">Tom McGrath</a> for reading early drafts of this.</em></p>



    
    <p>PS if you want to read more of my writing, subscribe to my <a href="https://finbarrtimbers.substack.com/">Substack</a>.</p>
    
  </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[You're a cyclist who was just struck by a car driver. Why it was your fault (109 pts)]]></title>
            <link>https://www.mcsweeneys.net/articles/youre-a-cyclist-who-was-just-struck-by-a-car-driver-heres-why-it-was-your-fault</link>
            <guid>37139980</guid>
            <pubDate>Tue, 15 Aug 2023 22:15:15 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.mcsweeneys.net/articles/youre-a-cyclist-who-was-just-struck-by-a-car-driver-heres-why-it-was-your-fault">https://www.mcsweeneys.net/articles/youre-a-cyclist-who-was-just-struck-by-a-car-driver-heres-why-it-was-your-fault</a>, See on <a href="https://news.ycombinator.com/item?id=37139980">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="o-wrapper">
    <main>
        <header>
    <div>
      <div>
          <p><span><img role="none" src="https://edge-assets.mcsw.net/assets/search-614fbdcc4e71f0730ad039e484ec78a1085f24294fa0b4514da70b0a930b2dce.svg"></span></p>        </div>
      <div>
        <ul>
          <li><a href="https://www.mcsweeneys.net/">Internet Tendency</a></li>
          <li><a href="https://store.mcsweeneys.net/">The Store</a></li>
          <li><a href="https://store.mcsweeneys.net/t/categories/books">Books Division</a></li>
          <li><a href="https://store.mcsweeneys.net/t/categories/timothy-mcsweeneys-quarterly-concern">Quarterly Concern</a></li>
          <li><a href="https://thebeliever.net/">The Believer</a></li>
          <li><a href="https://www.mcsweeneys.net/donate">Donate</a></li>
        </ul>
      </div>
    </div>
    
  </header>


      
  <div>
    <h6>The Believer has returned</h6>
    
  </div>


      
<article>
    
   
    <div>
      <p><strong>You were riding during rush hour.</strong><br>
Why were you riding then? There are way too many cars on the road. If you were commuting, you should have contacted your boss and politely asked to work from 3:00 a.m. to 11:00 a.m. instead.</p>
<p><strong>You were riding at night or in the early morning.</strong><br>
There’s no way drivers can see you. Remember: if you’re one of those people who rides bikes because it keeps the mental darkness at bay, the best time to do so is in the middle of the workday.</p>
<p><strong>You were riding in the middle of the workday.</strong><br>
The only people who should ride their bikes during the workday are bike messengers, who I also dislike. They weave, they bob—it’s inappropriate. Bike messengers need to do what drivers do: go straight, get pissed off, and hate everyone.</p>
<p><strong>You were riding on a back road.</strong><br>
Those roads are narrow and have a lot of twists and turns. There are hardly any cyclists on them. Drivers weren’t expecting you!</p>
<p><strong>You were riding on a main road.</strong><br>
Again, too much traffic. We’ve been over this.</p>
<p><strong>You were riding in the morning, or at night, or on a quiet road, or a main road.</strong><br>
Do I honestly have to spell it out for you? The only appropriate time and place to ride a bike is a time beyond time and a place beyond place, where the space-time continuum is bent so strangely you are both everywhere and nowhere, eternal and nonexistent. You must become the smoke that comes from shadow, the sound of blue, the smell that emanates from the number twelve.</p>
<p><strong>You didn’t signal properly.</strong><br>
I mean, no, I don’t have any “evidence” for that, but you must have done something wrong for an upstanding citizen like the driver of a Ford Focus that looks like it got into a fight with a forklift to strike you. The stats are on my side. Sixty-six percent of drivers <a href="https://www.forbes.com/sites/carltonreid/2019/05/10/cyclists-break-far-fewer-road-rules-than-motorists-finds-new-video-study/?sh=2d9fafbd4bfa">routinely commit moving violations</a>, compared with 5 percent of cyclists when they have somewhere safe to ride. That’s why I believe drivers.</p>
<p><strong>Your bike isn’t an <span>SUV</span>.</strong><br>
If your bike were an <span>SUV</span>, we wouldn’t be having this conversation. You’d be fine. In fact, it would be the Ford Focus driver who’d be all messed up. And that’s why SUVs are considered safe.</p>
<p><strong>You forgot to go back in time and tell people that subsidizing the oil industry might be a bad idea.</strong><br>
When the oil and auto industries teamed up to bend public policy to their will, making a system of roads and parking lots that now function as a continuous subsidy and magnificent symbol of the normalization of injury and pollution, you had a lot of options. You could have objected. You could have shifted public opinion. Instead, you weren’t even born yet. And, rather than go back in time, all you’ve been doing is riding to get groceries and occasionally saying, “Please stop killing us.” On the effort scale? 1/10.</p>
<p><strong>Frankly, I’m not sure a driver even hit you.</strong><br>
Maybe you were just <a href="https://www.nytimes.com/2023/07/29/health/ebikes-safety-teens.html">clipped by a Nissan van</a>. Was there a driver in the van? Has the passive voice historically functioned to deflect responsibility and consolidate unjust power arrangements? These are all fascinating questions that, sadly, we will never know the answers to.</p>
<p><strong>Oops, looks like you died.</strong><br>
Miraculously, the driver has been arrested and will face involuntary vehicular homicide. For killing you, the driver will get <a href="https://chi.streetsblog.org/2015/11/17/driver-who-killed-cyclist-hector-avalos-sentenced-to-only-100-days-in-prison">a hundred days in prison</a>. Apparently, killing someone is <a href="https://www.outsideonline.com/culture/essays-culture/justice-drivers-hit-cyclists/">basically legal</a> if you do it with a car. Also, our liberal city council has decided to make positive change. As I write, they’re enforcing strict new rules to ensure no one can ride their bikes in this part of town ever again.</p>
    </div>
    

    <div>
    <p>
        Please help support our writers and keep our site ad-free by becoming a patron today!
    </p>
    
  </div>

</article>

    


      <div>
        <h5>Suggested Reads</h5>
        <ul>
            <li>
    <a href="https://www.mcsweeneys.net/articles/the-great-sag">
      <p>October  4, 2000</p>
      <p>The Great Sag</p>
</a>    
  </li>
  <li>
    <a href="https://www.mcsweeneys.net/articles/evidence-that-automakers-predicted-senate-hearings-but-not-the-outcome-of-the-2008-presidential-election">
      <p>December  5, 2008</p>
      <p>Evidence That Automakers Predicted Senate Hearings but Not the Outcome of the 2008 Presidential Election</p>
</a>    <p><span>by </span>Elizabeth Worthington</p>
  </li>
  <li>
    <a href="https://www.mcsweeneys.net/articles/variations-on-the-spelling-of-vehicles-submitted-by-my-6th-graders-attempting-to-earn-extra-credit-on-a-weekly-spelling-test">
      <p>February 18, 2002</p>
      <p>Variations on the Spelling of ‘Vehicles,’ Submitted By My 6th Graders Attempting to Earn Extra Credit on a Weekly Spelling Test</p>
</a>    <p><span>by </span>Andre Theisen</p>
  </li>
  <li>
    <a href="https://www.mcsweeneys.net/articles/our-rv-has-a-kitchen-bedroom-bathroom-and-plenty-of-space-for-our-seven-children">
      <p>June 12, 2023</p>
      <p>Our RV Has a Kitchen, Bedroom, Bathroom, and Plenty of Space for Our Seven Children</p>
</a>    <p><span>by </span>Bobbie Armstrong<span> and&nbsp;</span>Madeline Goetz</p>
  </li>

        </ul>
      </div>


  <section>
        <div>
      <h5>Trending 🔥</h5>
      <ol>
          <li>
    <a href="https://www.mcsweeneys.net/articles/youre-a-cyclist-who-was-just-struck-by-a-car-driver-heres-why-it-was-your-fault">
      <p>August 11, 2023</p>
      <p>You’re a Cyclist Who Was Just Struck by a Car Driver. Here’s Why It Was Your Fault</p>
</a>    <p><span>by </span>Chas Gillespie</p>
  </li>
  <li>
    <a href="https://www.mcsweeneys.net/articles/how-to-ensure-your-annual-beach-vacation-destroys-your-relationship-with-your-extended-family">
      <p>July 26, 2023</p>
      <p>How to Ensure Your Annual Beach Vacation Destroys Your Relationship with Your Extended Family</p>
</a>    <p><span>by </span>Talia Argondezzi<span> and&nbsp;</span>Jeff Bender</p>
  </li>
  <li>
    <a href="https://www.mcsweeneys.net/articles/i-regret-to-announce-that-i-will-not-be-canceling-my-plans-with-you-tonight">
      <p>August  4, 2023</p>
      <p>I Regret to Announce That I Will Not Be Canceling My Plans with You Tonight</p>
</a>    <p><span>by </span>Sam Shafaghi</p>
  </li>
  <li>
    <a href="https://www.mcsweeneys.net/articles/what-your-favorite-80s-band-says-about-you">
      <p>July  5, 2011</p>
      <p>What Your Favorite ’80s Band Says About You</p>
</a>    <p><span>by </span>John K. Peck</p>
  </li>

      </ol>
    </div>

      <div>
    <h5>Recently</h5>
    <ul>
        <li>
    <a href="https://www.mcsweeneys.net/articles/im-racketeering-charges-and-im-here-to-rock-this-presidential-indictment-fest-like-you-wouldnt-believe">
      <p>August 15, 2023</p>
      <p>I’m Racketeering Charges, and I’m Here to Rock This Presidential Indictment-Fest Like You Wouldn’t Believe</p>
</a>    <p><span>by </span>Jess Keefe</p>
  </li>
  <li>
    <a href="https://www.mcsweeneys.net/articles/welcome-to-your-new-city-in-the-northwest-where-recycling-is-so-simple">
      <p>August 15, 2023</p>
      <p>Welcome to Your New City in the Northwest, Where Recycling Is So Simple</p>
</a>    <p><span>by </span>Tori Multon</p>
  </li>
  <li>
    <a href="https://www.mcsweeneys.net/articles/can-i-get-away-with-this-on-the-bus-an-faq-for-the-modern-commuter">
      <p>August 14, 2023</p>
      <p>Can I Get Away with This on the Bus? An <span>FAQ</span> for the Modern Commuter</p>
</a>    <p><span>by </span>Seif Drywater</p>
  </li>
  <li>
    <a href="https://www.mcsweeneys.net/articles/predictive-texts-for-the-conflict-averse">
      <p>August 14, 2023</p>
      <p>Predictive Texts for the Conflict-Averse</p>
</a>    <p><span>by </span>Tom Ellison<span> and&nbsp;</span>Caitlin Kunkel</p>
  </li>

    </ul>
  </div>

  </section>


  

    
  
  
  




        

    </main>
  </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[How should I read type system notation? (302 pts)]]></title>
            <link>https://langdev.stackexchange.com/questions/2692/how-should-i-read-type-system-notation</link>
            <guid>37138807</guid>
            <pubDate>Tue, 15 Aug 2023 20:15:27 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://langdev.stackexchange.com/questions/2692/how-should-i-read-type-system-notation">https://langdev.stackexchange.com/questions/2692/how-should-i-read-type-system-notation</a>, See on <a href="https://news.ycombinator.com/item?id=37138807">Hacker News</a></p>
<div id="readability-page-1" class="page"><div itemprop="text">
<p>The notation used to describe type systems varies from presentation to presentation, so giving a comprehensive overview is impossible. However, most presentations share a large, common subset, so this answer will attempt to provide a foundation of enough of the basics to understand variations on the common theme.</p>
<h2>Syntax and grammars</h2>
<p>Type systems as applied to programming language are <em>syntactic</em> systems. That is, a type system is a set of rules that operate on the (abstract) syntax of a programming language. For this reason, comprehensive treatments of type systems begin by providing the <a href="https://en.wikipedia.org/wiki/Formal_grammar" rel="noreferrer">grammar</a> of all the syntactic constructs considered by the type system using <a href="https://en.wikipedia.org/wiki/Backus%E2%80%93Naur_form" rel="noreferrer">BNF</a> notation. In the simplest typed languages, syntax is needed for precisely two things: <em>expressions</em> and <em>types</em>.</p>
<p>For example, let’s consider the grammar for an extremely simple language of booleans and integers:
<span>$$
\begin{array}{rcll}
e \hskip{-10mu}
  &amp;::=&amp;\hskip{-10mu} \mathsf{true}\hskip{10mu}|\hskip{10mu}\mathsf{false} &amp;\textrm{boolean literal}\\
  &amp; | &amp;\hskip{-10mu} 0 \hskip{5mu}|\hskip{5mu} 1 \hskip{5mu}|\hskip{5mu} {-1} \hskip{5mu}|\hskip{5mu} 2 \hskip{5mu}|\hskip{5mu} {-2} \hskip{5mu}|\hskip{5mu} \ldots &amp;\textrm{integer literal}\\
  &amp; | &amp;\hskip{-10mu} \mathbf{if}\ e\ \mathbf{then}\ e\ \mathbf{else}\ e &amp;\textrm{conditional}\\
  &amp; | &amp;\hskip{-10mu} e + e \hskip{10mu}|\hskip{10mu} e - e \hskip{10mu}|\hskip{10mu} e × e &amp;\textrm{arithmetic}\\
  &amp; | &amp;\hskip{-10mu} e = e \hskip{10mu}|\hskip{10mu} e &lt; e \hskip{10mu}|\hskip{10mu} e &gt; e &amp;\textrm{comparison}\\[8pt]
\tau \hskip{-10mu}
  &amp;::=&amp;\hskip{-10mu} \mathsf{Bool} &amp;\textrm{booleans}\\
  &amp; | &amp;\hskip{-10mu} \mathsf{Int} &amp;\textrm{integers}
\end{array}
$$</span>
Here, <span>$e$</span> corresponds to an expression and <span>$\tau$</span> corresponds to a type, which is a standard notational convention. Some presentations use other symbols for types, such as <span>$t$</span>, <span>$T$</span>, <span>$\sigma$</span>, or other lowercase Greek letters, but the overall structure will look roughly the same.</p>
<p>More complex languages will naturally have more complex grammars: imperative languages will include the grammar of statements, languages with pattern-matching will include the grammar of patterns, and so on. This language is so simple that it doesn’t even have variables! However, this core syntactic division between <em>terms</em> (things that have types) and <em>types</em> is essential, as defining the relationship between them is what type systems are all about.</p>
<h2>Relations, judgments, axioms, and inference rules</h2>
<p>Once the grammar has been specified, the next step is to define the <em>typing relation</em>, which is generally written <span>$e : \tau$</span> and can be read “<span>$e$</span> has type <span>$\tau$</span>”. Intuitively, we understand that some statements of this form “make sense” and others do not:</p>
<ul>
<li><p><span>$1 + 2 : \mathsf{Int}$</span> means “<span>$1 + 2$</span> has type <span>$\mathsf{Int}$</span>”, which certainly makes sense.</p>
</li>
<li><p><span>$1 + 2 : \mathsf{Bool}$</span> means “<span>$1 + 2$</span> has type <span>$\mathsf{Bool}$</span>”, which does <em>not</em> make sense.</p>
</li>
<li><p><span>$\mathsf{true} + 2 : \mathsf{Int}$</span> means “<span>$\mathsf{true} + 2$</span> has type <span>$\mathsf{Int}$</span>”, which makes even <em>less</em> sense, as the expression <span>$\mathsf{true} + 2$</span> is nonsense and does not have any type at all.</p>
</li>
</ul>
<p>We’d like to write down some rules that precisely capture our intuitions about which statements “make sense” and which do not. To do this, we’ll define the <em>typing judgment</em>, which is written using the following notation:
<span>$$
⊢ e : \tau
$$</span>
Here, the <span>$⊢$</span> can be read to mean “the following statement is true”. (The <span>$⊢$</span> might seem a bit unnecessary, and indeed it is sometimes omitted in simple systems like this one, but it will play a more significant role later.) Using this notation, we can write down the some of the <em>typing rules</em> for our type system:
<span>$$
\begin{array}{l}\hline ⊢ \mathsf{true} : \mathsf{Bool}\end{array} \quad \quad
\begin{array}{l}\hline ⊢ \mathsf{false} : \mathsf{Bool}\end{array}
$$</span>
The horizontal bar over each of these rules with nothing on top means that they are <em>always</em> true, which makes them <em>axioms</em>. We also have an infinite number of similar axioms for integer literals:
<span>$$
\begin{array}{l}\hline ⊢ 0 : \mathsf{Int}\end{array} \quad
\begin{array}{l}\hline ⊢ 1 : \mathsf{Int}\end{array} \quad
\begin{array}{l}\hline ⊢ -1 : \mathsf{Int}\end{array} \quad
\begin{array}{l}\hline ⊢ 2 : \mathsf{Int}\end{array} \quad \cdots
$$</span></p>
<p>Of course, the typing rules for literals are fairly boring. Things get much more interesting when we consider rules for expressions that have subexpressions! Here are the typing rules for <span>$+$</span> and <span>$&lt;$</span>:
<span>$$
\begin{array}{l}
⊢ e_1 : \mathsf{Int} \\
⊢ e_2 : \mathsf{Int} \\
\hline
⊢ e_1 + e_2 : \mathsf{Int}
\end{array} \quad \quad \quad \begin{array}{l}
⊢ e_1 : \mathsf{Int} \\
⊢ e_2 : \mathsf{Int} \\
\hline
⊢ e_1 &lt; e_2 : \mathsf{Bool}
\end{array}
$$</span>
Now we have things both above <em>and</em> below the horizontal bars, which makes these <em>inference rules</em>. These represent conditional typing rules: the statement under the bar is true <strong>if</strong> all of the statements above the bar are true. For example, the first rule can be read as “if <span>$e_1 : \mathsf{Int}$</span> and <span>$e_2 : \mathsf{Int}$</span> are true, then <span>$e_1 + e_2 : \mathsf{Int}$</span> is true,” which should hopefully make intuitive sense.</p>
<p>Rules for <span>$-$</span>, <span>$×$</span>, <span>$=$</span>, and <span>$&gt;$</span> are nearly identical to the ones given above, but the rule for <span>$\mathbf{if} \ldots \mathbf{then} \ldots \mathbf{else}$</span> must be slightly more complex. This is because the branches of these expressions can be any type, as long as they agree. That is, both
<span>$$ \mathbf{if}\ \mathsf{true}\ \mathbf{then}\ 1\ \mathbf{else}\ 2 $$</span>
and
<span>$$ \mathbf{if}\ \mathsf{true}\ \mathbf{then}\ \mathsf{false}\ \mathbf{else}\ \mathsf{true} $$</span>
are legal, but
<span>$$
\mathbf{if}\ \mathsf{true}\ \mathbf{then}\ 1\ \mathbf{else}\ \mathsf{true}
$$</span>
is not. To capture this, the typing rule uses a variable to stand for the type of the branches:
<span>$$
\begin{array}{l}
⊢ e_1 : \mathsf{Bool} \\
⊢ e_2 : \tau \\
⊢ e_3 : \tau \\
\hline
⊢ \mathbf{if}\ e_1\ \mathbf{then}\ e_2\ \mathbf{else}\ e_3 : \tau
\end{array}
$$</span>
When the rule is applied, any type may be picked for <span>$\tau$</span> as long as the choice is used consistently.</p>
<p>This notation originates in formal logic, and in particular, the style used to specify type systems most closely resembles <a href="https://en.wikipedia.org/wiki/Natural_deduction" rel="noreferrer">natural deduction</a>. Though I will not go into the formal details of the notation in this answer, rules expressed in this way can be used to construct formal proofs about the system’s properties, which is important for proving things like <a href="https://en.wikipedia.org/wiki/Type_safety" rel="noreferrer">type soundness</a>.</p>
<h2>Judgments as an algorithmic specification</h2>
<p>So far, I’ve intentionally refrained from saying anything about the computational interpretation of typing judgments. In general, judgments are just logical rules, and some type systems specified this way do not directly correspond to a decidable typechecking algorithm. However, if you are not used to thinking about proof systems, this perspective can be extremely difficult to wrap your head around.</p>
<p>Fortunately, in many cases, there <em>is</em> a way to read typing rules that directly yields a typechecking algorithm: it’s possible to interpret <span>$⊢ e : \tau$</span> as a <em>function</em> from an expression <span>$e$</span> to its type <span>$\tau$</span>. This is because there is usually exactly one rule defined for each case in the grammar of expressions, which makes it possible to think of each typing rule as a distinct case in a recursive typechecking function.</p>
<p>For example, consider the rules for our little language given above. They correspond directly to an <span>$\mathrm{infer}$</span> function with the following shape:
<span>$$
\begin{array}{l}
\mathrm{infer} : \mathsf{Expr} → \mathsf{Type} \\
\mathrm{infer}(e) = \mathbf{match}\ e\ \mathbf{where} \\
\quad \begin{alignedat}{2}
  &amp;\mathsf{true}\ |\ \mathsf{false} &amp;&amp;↦ \mathsf{Bool} \\
  &amp;0\ |\ 1\ |\ {-1}\ |\ 2\ |\ \ldots &amp;&amp;↦ \mathsf{Int} \\
  &amp;e_1 + e_2 &amp;&amp;↦ \mathbf{assert}\: \mathrm{infer}(e_1) = \mathsf{Int}; \\
    &amp;&amp;&amp;\phantom{{}↦{}} \mathbf{assert}\: \mathrm{infer}(e_2) = \mathsf{Int}; \\
    &amp;&amp;&amp;\phantom{{}↦{}} \mathsf{Int} \\
  &amp;e_1 &lt; e_2 &amp;&amp;↦ \mathbf{assert}\: \mathrm{infer}(e_1) = \mathsf{Int}; \\
    &amp;&amp;&amp;\phantom{{}↦{}} \mathbf{assert}\: \mathrm{infer}(e_2) = \mathsf{Int}; \\
    &amp;&amp;&amp;\phantom{{}↦{}} \mathsf{Bool} \\
  &amp;\mathbf{if}\ e_1\ \mathbf{then}\ e_2\ \mathbf{else}\ e_3
    &amp;&amp;↦ \mathbf{assert}\: \mathrm{infer}(e_1) = \mathsf{Bool}; \\
    &amp;&amp;&amp;\phantom{{}↦{}} \mathbf{let}\: \tau = \mathrm{infer}(e_2); \\
    &amp;&amp;&amp;\phantom{{}↦{}} \mathbf{assert}\: \mathrm{infer}(e_3) = \tau; \\
    &amp;&amp;&amp;\phantom{{}↦{}} \tau
\end{alignedat}
\end{array}
$$</span></p>
<p>Even when it isn’t possible to perform such a direct translation from typing rules to typechecking algorithm, it can be extremely helpful to consider information flow when reasoning about logical judgments. That is, for the <span>$⊢ e : \tau$</span> judgment we defined above, <span>$e$</span> can be considered an “input” to the judgment and <span>$\tau$</span> considered an “output”. This strict directionality does not always apply to every rule in a type system, but it often applies to many of them, and it is a useful way to wrap your head around what the rules represent.</p>
<h2>Variables, contexts, and environments</h2>
<p>The language we’ve been using as a running example so far is exceptionally simple. One complication I’ve intentionally chosen to avoid so far is <em>variables</em>, but we need to consider them if we want to be able to write typing rules for any useful programming language. Let’s therefore expand our example language by adding functions, making it a variant of the <a href="https://en.wikipedia.org/wiki/Simply_typed_lambda_calculus" rel="noreferrer">simply typed lambda calculus</a> (STLC). This requires the following additions to the language’s grammar:
<span>$$
\begin{array}{rcll}
e \hskip{-10mu}
  &amp;::=&amp;\hskip{-10mu}\ldots\\
  &amp; | &amp;\hskip{-10mu} x &amp;\textrm{variable}\\
  &amp; | &amp;\hskip{-10mu} λx{:}\tau. e &amp;\textrm{function abstraction}\\
  &amp; | &amp;\hskip{-10mu} e\ e &amp;\textrm{function application}\\[8pt]
\tau \hskip{-10mu}
  &amp;::=&amp;\hskip{-10mu}\ldots\\
  &amp; | &amp;\hskip{-10mu} \tau → \tau &amp;\textrm{functions}
\end{array}
$$</span>
Here, <span>$x$</span> stands for “some variable”. If you are unfamiliar with the lambda calculus, the notation used here might appear somewhat exotic, but it is likely not as foreign as it seems: the STLC syntax <span>$λx{:}\tau. e$</span> corresponds directly to <code>(x:τ) =&gt; e</code> in TypeScript, and <span>$f\ x$</span> corresponds to <code>f(x)</code>.</p>
<p>With these additions to our grammar, the notation used for our typing relation does not change—it’s still just <span>$e : \tau$</span>—but the structure of our typing <em>judgment</em> must be extended. The trouble appears when we attempt to write a typing rule for variables:
<span>$$
\begin{array}{l}
\hline
⊢ x : \text{???}
\end{array}
$$</span>
The problem is that the type of a variable depends on the <em>context</em> it appears in. Therefore, we need to extend the typing judgment to keep track of the types of all variables that happen to be in scope, which we do using the following notation:
<span>$$
Γ ⊢ e : \tau
$$</span>
<span>$Γ$</span> is called “the context” or “the type environment”, and the role of the <span>$⊢$</span> now becomes clearer: it separates contextual assumptions from the statement to be proved. The extended judgment can therefore be pronounced “under the context <span>$Γ$</span>, the expression <span>$e$</span> has type <span>$\tau$</span>”, and algorithmically, <span>$Γ$</span> can be considered an additional “input” to the judgment of type <code>Map&lt;Variable, Type&gt;</code>. However, formally speaking, every typing rule must be defined syntactically, so contexts are explicitly represented in typing rules as syntactic constructs with the following shape:
<span>$$
\begin{array}{rcll}
Γ \hskip{-10mu}
  &amp;::=&amp;\hskip{-10mu} \varnothing &amp;\textrm{empty context}\\
  &amp; | &amp;\hskip{-10mu} Γ, x{:}\tau &amp;\textrm{variable binding}
\end{array}
$$</span>
Sometimes <span>$\bullet$</span> is used instead of <span>$\varnothing$</span> to represent the empty context. Under this representation, a context is essentially an <a href="https://en.wikipedia.org/wiki/Association_list" rel="noreferrer">association list</a> mapping variable names to types.</p>
<p>Most typing rules have no reason to care about the context. Most inference rules just pass it along unaltered, and most axioms ignore it altogether. For example, here are a couple typing rules from above adapted to our new judgment:
<span>$$
\begin{array}{l}\hline
Γ ⊢ \mathsf{true} : \mathsf{Bool}
\end{array} \quad \quad \begin{array}{l}
Γ ⊢ e_1 : \mathsf{Int} \\
Γ ⊢ e_2 : \mathsf{Int} \\
\hline
Γ ⊢ e_1 + e_2 : \mathsf{Int}
\end{array}
$$</span>
However, the context is essential for two new typing rules, which handle variable uses and lambda expressions:
<span>$$
\begin{array}{l}
x{:}\tau \in Γ \\
\hline
Γ ⊢ x : \tau
\end{array} \quad \quad
\begin{array}{l}
Γ,x{:}\tau_1 ⊢ e : \tau_2 \\
\hline
Γ ⊢ (λx{:}\tau_1. e) : \tau_1 → \tau_2
\end{array}
$$</span>
The second of these two rules is the more complex one, as it’s where all the magic happens: while typechecking the body <span>$e$</span> of the lambda expression, the context is extended with a new binding <span>$x{:}\tau_1$</span>. This information is then utilized by the first rule, which says that if there is a variable binding <span>$x$</span> with type <span>$\tau$</span> in the current context (and therefore in scope), then <span>$x$</span> has type <span>$\tau$</span>. In other words, the context is used as a communication mechanism to propagate information between these two rules.</p>
<p>(Observant readers may note that this model does not handle variable shadowing. As a simplifying assumption, type systems specified this way usually assume that all variables have already been resolved and made unique.)</p>
<p>If this still seems a bit confusing to you, it may help to consider the way these additions affect our <span>$\mathrm{infer}$</span> function from earlier:
<span>$$
\begin{array}{l}
\mathrm{infer} : (\mathsf{Context}, \mathsf{Expr}) → \mathsf{Type} \\
\mathrm{infer}(Γ, e) = \mathbf{match}\ e\ \mathbf{where} \\
\quad \begin{alignedat}{2}
  &amp;\ldots\\
  &amp;x &amp;&amp;↦ \mathrm{lookup}(Γ, x) \\
  &amp;(λx{:}\tau_1. e') &amp;&amp;↦ \mathbf{let}\: Γ' = \mathrm{extend}(Γ, x, \tau_1); \\
    &amp;&amp;&amp;\phantom{{}↦{}} \mathbf{let}\: \tau_2 = \mathrm{infer}(Γ', e'); \\
    &amp;&amp;&amp;\phantom{{}↦{}} \mathsf{\tau_1 → \tau_2}
\end{alignedat}
\end{array}
$$</span></p>
<p>The only remaining rule we need to add to cope with the addition of functions is a rule for function application:
<span>$$
\begin{array}{l}
Γ ⊢ e_1 : \tau_1 → \tau_2 \\
Γ ⊢ e_2 : \tau_1 \\
\hline
Γ ⊢ e_1\ e_2 : \tau_2
\end{array}
$$</span>
That’s it!</p>
<h2>Other common notation and considerations</h2>
<p>The above describes the large majority of notation used to specify type systems if measured by volume, but modifications and extensions to this foundation are extremely common. It would be impossible to cover all of them, but fortunately, good papers usually explain whatever nonstandard notation they choose to introduce. However, some conventions are common enough that they are often used without explanation; this section attempts to provide a basic survey and describe a few notational quirks.</p>
<p>Since this is not and can never be an exhaustive list, please open a separate question if you find some notation not covered here!</p>
<h2>Inference rule layout</h2>
<p>So far, all of the examples in this answer have laid out inference rules in a very regular, vertical way. However, placing each condition on its own line is not by any means required, so several conditions may appear side-by-side:
<span>$$
\begin{array}{c}
Γ ⊢ e_1 : \mathsf{Int} \hskip{25mu}
Γ ⊢ e_2 : \mathsf{Int} \\
\hline
Γ ⊢ e_1 + e_2 : \mathsf{Int}
\end{array}
$$</span>
Vertical and horizontal arrangement may even be combined within the same rule.</p>
<h2>Side conditions</h2>
<p>Usually, the conditions that appear above the horizontal bar in an inference rule are themselves judgments that must be satisfied by some combination of inference rules and axioms. However, this is not always the case: rules may also include arbitrary boolean expressions known as <em>side conditions</em>, which must all be true in order for the rule to be applied. The <span>$x{:}\tau \in Γ$</span> condition in our typing rule for variables is an example of a side condition.</p>
<p>A special type of side condition that sometimes appears in algorithmic type systems is written <span>$\alpha\ \mathbf{fresh}$</span>. This means that <span>$\alpha$</span> should be a fresh type variable, i.e. a type variable distinct from all other type variables.</p>
<h2>Subtyping</h2>
<p>Subtyping introduces a weaker notion of consistency between types than strict equality, and the subtyping relation must be explicitly defined. It is usually denoted <span>$\tau_1 &lt;: \tau_2$</span>, which can be read as “<span>$\tau_1$</span> is a subtype of <span>$\tau_2$</span>”.</p>
<p>The relation is often defined using the same syntax used to define judgments. For example, a very simple subtyping relation might introduce two special types, <span>$\top$</span> (pronounced “top”) and <span>$\bot$</span> (pronounced “bottom”), which are the supertype and subtype of all types, respectively. This relation can be expressed using three simple axioms:
<span>$$
\begin{array}{l}\hline \tau &lt;: \tau \end{array} \quad \quad
\begin{array}{l}\hline \tau &lt;: \top \end{array} \quad \quad
\begin{array}{l}\hline \bot &lt;: \tau \end{array}
$$</span>
The first rule is the reflexive rule, often abbreviated to “refl”, which states that every type is a subtype of itself and ensures that subtyping is strictly weaker than equality.</p>
<p>The defined subtyping relation must then be used explicitly in every rule that permits subtyping. For example, a system that supports subtyping might use the following rule for function application:
<span>$$
\begin{array}{l}
Γ ⊢ e_1 : \tau_2 → \tau_3 \\
Γ ⊢ e_2 : \tau_1 \\
\tau_1 &lt;: \tau_2 \\
\hline
Γ ⊢ e_1\ e_2 : \tau_3
\end{array}
$$</span></p>
<h2>Multiple contexts</h2>
<p>Some type systems define typing judgments involving more than one context. The second context is usually named <span>$Δ$</span>. Common notations for multi-context rules are <span>$Γ;Δ ⊢ e : \tau$</span> (used when both contexts are morally “inputs”) and <span>$Γ ⊢ e : \tau ⊣ Δ$</span> (used when <span>$Δ$</span> is morally an “output”).</p>
<p>The second context may be used for any number of different things. Perhaps certain variables can be referenced from inside certain expressions but not others, or perhaps an output context is used to keep track of which variables are “consumed” in a resource-aware programming language.</p>
<h2>Bidirectional typechecking</h2>
<p><a href="https://arxiv.org/abs/1908.05839" rel="noreferrer">Bidirectional typechecking</a> is an approach for performing a limited form of nonlocal type inference without the need to use a constraint solver. A bidirectional system splits the usual <span>$Γ ⊢ e : \tau$</span> typing judgment into two specialized judgments:</p>
<ul>
<li><p><span>$Γ ⊢ e ⇐ \tau$</span> is the <em>checking</em> judgment, which checks that <span>$e$</span> has some expected type <span>$\tau$</span>. Algorithmically, <span>$\tau$</span> is an <em>input</em> to this judgment.</p>
</li>
<li><p><span>$Γ ⊢ e ⇒ \tau$</span> is the <em>inference</em> judgment, which is used whenever expected type information is not available. Algorithmically, <span>$\tau$</span> is an <em>output</em> from this judgment.</p>
</li>
</ul>
<p>The two judgments are defined in a mutually-recursive way to propagate type information bidirectionally, which allows some type annotations to sometimes be omitted. For example, the checking variant of the rule for lambda abstraction may omit the annotation on the variable binder since it can be determined from the expected type:
<span>$$
\begin{array}{c}
Γ,x{:}\tau_1 ⊢ e ⇐ \tau_2 \\
\hline
Γ ⊢ (λx. e) ⇐ \tau_1 → \tau_2
\end{array}
$$</span></p>
    </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Requiring ink to scan a document–yet another insult from the printer industry (164 pts)]]></title>
            <link>https://arstechnica.com/gadgets/2023/08/the-printers-that-require-ink-to-scan-and-fax/</link>
            <guid>37138691</guid>
            <pubDate>Tue, 15 Aug 2023 20:06:17 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://arstechnica.com/gadgets/2023/08/the-printers-that-require-ink-to-scan-and-fax/">https://arstechnica.com/gadgets/2023/08/the-printers-that-require-ink-to-scan-and-fax/</a>, See on <a href="https://news.ycombinator.com/item?id=37138691">Hacker News</a></p>
<div id="readability-page-1" class="page"><div itemprop="articleBody">
                                    
<figure>
  <img src="https://cdn.arstechnica.net/wp-content/uploads/2023/08/hp-printer-e1692118118328-800x819.jpg" alt="HP ENVY 6455e printer">
      <figcaption><p><a href="https://cdn.arstechnica.net/wp-content/uploads/2023/08/hp-printer-e1692118118328.jpg" data-height="1245" data-width="1216">Enlarge</a> <span>/</span> Don't bother hitting the scan button if you're out of ink.</p></figcaption>  </figure>

  




<!-- cache hit 4:single/related:e295cebb7bd5fad088ecd7ff3995225e --><!-- empty -->
<p>How much ink does an all-in-one printer need in order to fax a document? Or to scan one to your computer? The obvious answer is "none." But if you own certain printers from companies like HP and Canon, you won't be able to use core features unless the device has ink—even if those features <em>have nothing to do with ink.&nbsp;</em></p>
<p>Unfortunately, all-in-one printers arbitrarily demanding ink to perform non-printing functions <a href="https://www.consumerreports.org/consumerist/if-you-want-to-scan-without-an-ink-cartridge-maybe-dont-buy-an-all-in-one-at-all/">isn't a new frustration</a>. And that's despite some companies having printers that can <a href="https://support.brother.com/g/b/faqend.aspx?c=us&amp;lang=en&amp;prod=mfcj4335dw_us_eu&amp;faqid=faq00002608_007">scan without ink</a>. Clearly, scanning or faxing without requiring an ink cartridge would improve users' experience—and they've illustrated that through class-action lawsuits. But this hasn't stopped printer makers from fighting to keep the nettlesome practice.</p>
<h2>No ink, no scan</h2>
<p>Since mid-2022, HP has been fighting a class-action lawsuit alleging that certain all-in-one printer models won't scan or fax without ink and that HP doesn't properly disclose this to shoppers. On January 13, 2023, the complaint was dismissed but allowed to be amended (you can view the amended complaint here: [<a href="https://cdn.arstechnica.net/wp-content/uploads/2023/08/hp-complaint.pdf">PDF</a>]), and on August 10, a Northern District of California judge dismissed HP's motion to dismiss the amended complaint [<a href="https://cdn.arstechnica.net/wp-content/uploads/2023/08/HP-dismissed.pdf">PDF</a>].</p>
<p>HP Envy 6455e and HP Deskjet 2655 purchasers Gary Freund and Wayne McMath filed the complaint, which states that HP printers are designed to enter an error state when low or out of ink, preventing usage until the installment of a new ink cartridge. The plaintiffs are also peeved that HP marketing and advertising doesn't clearly disclose this, the complaint says. The complaint also notes that an HP support agent has <a href="https://h30434.www3.hp.com/t5/Scanning-Faxing-Copying/Scanning-without-a-working-ink-cartridge/td-p/6777739">said</a> that HP printers are "designed in such a way that with the empty cartridge or without the cartridge the printer will not function."</p>                                            
                                                        
<p>"HP’s All-in-One Printers do not work as advertised. Ink is <em>not</em> a necessary component to scan or to fax a document," the complaint reads.</p>
<p>It adds:</p>
<blockquote><p>Tying the scan or fax capabilities of the All-In-One Printers to ink contained in the devices offers no benefit and only serves to disadvantage and harm consumers financially. However, tying the scan or fax capabilities of the All-In-One Printers to ink contained in the devices does, however [sic], serve to benefit HP.</p></blockquote>
<p>Anyone who's owned an inkjet printer knows how expensive ink can be. That suggests a reason to push people to buy ink through tactics like blocking core features if no ink is present and <a href="https://www.consumerreports.org/electronics-computers/printers/why-is-printer-ink-so-expensive-a2101590645/">reportedly</a> selling printers below cost. Ink-buying programs have also become cash cows. HP in 2021, for example, said its Instant Ink subscription business was worth $500 million, per <a href="https://www.crn.com/news/components-peripherals/hp-says-instant-ink-is-a-500m-business-with-30-percent-growth">CRN</a>. In its Q2 2023 financial report, HP named Instant Ink a key growth area.</p>
<p>The complaint against HP says:</p>
<blockquote><p>Indeed, HP designs its All-in-One printer products so they will not work without ink. Yet, HP does not disclose this fact to consumers. … Even were it technically possible to scan a document without all ink cartridges present, HP does not disclose any 'workaround'&nbsp; to consumers in any of the product packaging nor in any of HP’s advertising and marketing materials regarding its multi-function devices.</p></blockquote>
<p>The complaint seeks monetary damages as well as the end of HP's "misleading advertising and marketing campaign" and for HP to "engage in a corrective campaign to inform consumers of the misleading advertising."</p>
<p>Here are all the HP printer models listed in the complaint:</p>
<ul>
<li aria-level="4">HP Deskjet 2755e</li>
<li aria-level="4">HP DeskJet 3755</li>
<li aria-level="4">HP DeskJet 4155e</li>
<li aria-level="4">HP ENVY 6055e</li>
<li aria-level="4">HP ENVY 6075</li>
<li aria-level="4">HP ENVY 6455</li>
<li aria-level="4">HP ENVY Pro 6475</li>
<li aria-level="4">HP OfficeJet 250 Mobile</li>
<li aria-level="4">HP OfficeJet Pro 7740 Wide Format</li>
<li aria-level="4">HP OfficeJet Pro 8025</li>
<li aria-level="4">HP DeskJet 2622</li>
<li aria-level="4">HP DeskJet 2655</li>
</ul>
<p>HP declined to comment on this story.</p>

                                                </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[ISPs complain that listing every fee is too hard, urge FCC to scrap new rule (428 pts)]]></title>
            <link>https://arstechnica.com/tech-policy/2023/08/isps-complain-that-listing-every-fee-is-too-hard-urge-fcc-to-scrap-new-rule/</link>
            <guid>37138681</guid>
            <pubDate>Tue, 15 Aug 2023 20:05:43 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://arstechnica.com/tech-policy/2023/08/isps-complain-that-listing-every-fee-is-too-hard-urge-fcc-to-scrap-new-rule/">https://arstechnica.com/tech-policy/2023/08/isps-complain-that-listing-every-fee-is-too-hard-urge-fcc-to-scrap-new-rule/</a>, See on <a href="https://news.ycombinator.com/item?id=37138681">Hacker News</a></p>
<div id="readability-page-1" class="page"><div itemprop="articleBody">
                                    
<figure>
  <img src="https://cdn.arstechnica.net/wp-content/uploads/2023/08/getty-internet-bills-800x533.jpg" alt="Dollar signs superimposed on a photo of a person's hands typing on a laptop keyboard.">
      <figcaption><p>Getty Images | anyaberkut</p></figcaption>  </figure>

  




<!-- cache hit 4:single/related:c2dc09635dc8106c544e0dc4acf983a2 --><!-- empty -->
<p>The US broadband industry is united in opposition to a requirement that Internet service providers list all of their monthly fees. Five lobby groups representing cable companies, fiber and DSL providers, and mobile operators have repeatedly urged the Federal Communications Commission to eliminate the requirement before new broadband labeling rules take effect.</p>
<p>The trade associations <a href="https://www.fcc.gov/ecfs/document/10117331109471/1">petitioned the FCC</a> in January to change the rules and renewed their call last week in a <a href="https://www.fcc.gov/ecfs/document/10811085828256/1">filing</a> and in a meeting with FCC officials. The requirement that ISPs list all their monthly fees "would add unnecessary complexity and burdens to the label for consumers and providers and could result in some providers having to create many labels for any given plan," the groups said in the filing on Friday.</p>
<p>The trade groups said the FCC should instead "require providers to include an explanatory statement that such fees may apply and that they vary by jurisdiction, similar to the Commission's treatment of government-imposed taxes," or require "the display of the maximum level of government-imposed fees that might be passed through, so that consumers would not experience bill shock with respect to such fees."</p>
<p>The filing was submitted by NCTA-The Internet &amp; Television Association, which represents Comcast, Charter, Cox, and other cable companies. The NCTA's <em>ex parte</em> filing described a meeting with FCC officials that also included wireless industry trade group CTIA and USTelecom, which represents telcos including AT&amp;T, Verizon, Lumen (formerly CenturyLink), Frontier, and Windstream.</p>
<p>The meeting was attended by two other groups representing smaller ISPs: NTCA-The Rural Broadband Association and ACA Connects-America's Communications Association. The trade groups met on Wednesday with the legal advisors to FCC Chairwoman Jessica Rosenworcel and Commissioner Brendan Carr, according to the filing.</p>                                            
                                                        
<h2>Comcast accused of “trying to create loopholes”</h2>
<p>Comcast submitted its own filing urging the FCC to scrap the rules in June. The calls to weaken the FCC's truth-in-billing rules angered consumer advocates, as we <a href="https://arstechnica.com/tech-policy/2023/06/comcast-complains-to-fcc-that-listing-all-of-its-monthly-fees-is-too-hard/">wrote at the time</a>. "The label hasn't even reached consumers yet, but Comcast is already trying to create loopholes. This request would allow the big ISPs to continue hiding the true cost of service and frustrating customers with poor service," Joshua Stager, policy director at media advocacy group Free Press, told Ars.</p>
<p>Congress required the FCC to implement broadband labels with <a href="https://arstechnica.com/tech-policy/2022/01/fcc-aims-to-stop-broadband-bill-shock-reviving-plan-nixed-by-ajit-pai/">exact prices</a> for Internet service plans in a <a href="https://arstechnica.com/tech-policy/2021/11/congress-oks-42-billion-to-deploy-100mbps-broadband-in-unserved-areas/">2021 law</a>, but gave the FCC some leeway in how to structure the rules. The <a href="https://www.fcc.gov/document/fcc-requires-broadband-providers-display-labels-help-consumers">FCC adopted specific</a> label rules in November 2022.</p>
<p>The labels must be displayed to consumers at the point of sale and include monthly price, additional charges, speeds, data caps, additional charges for data, and other information. The FCC rules aren't in force yet because they are subject to a federal Office of Management and Budget (OMB) review under the US Paperwork Reduction Act.</p>
<p>ISPs object to a portion of the FCC order that says, "providers must list all recurring monthly fees" including "all charges that providers impose at their discretion, <em>i.e.</em>, charges not mandated by a government." The five trade groups complain that this would require ISPs "to display the pass-through of fees imposed by federal, state, or local government agencies on the consumer broadband label."</p>
<p>But just because an ISP says a fee is related to a government charge doesn't mean that ISPs have to break them out separately. ISPs could instead include all costs in their advertised rates to give potential customers a clearer idea of how much they would have to pay each month.</p>
<p>"A provider that opts to combine all of its monthly discretionary fees with its base monthly price may do so and list that total price. In that case, the provider need not separately itemize those fees in the label," the FCC order said.</p>

                                                </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[My deep learning rig (2022) (147 pts)]]></title>
            <link>https://nonint.com/2022/05/30/my-deep-learning-rig/</link>
            <guid>37138672</guid>
            <pubDate>Tue, 15 Aug 2023 20:05:06 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://nonint.com/2022/05/30/my-deep-learning-rig/">https://nonint.com/2022/05/30/my-deep-learning-rig/</a>, See on <a href="https://news.ycombinator.com/item?id=37138672">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="content">
		<main id="main">

		
<article id="post-218">
			<!-- .entry-header -->

	<div>
		
<p>A lot of people have asked about the computers I used to train TorToiSe. I’ve been meaning to snap some pictures, but it’s never “convenient” to turn these servers off so I keep procrastinating.</p>



<p>We had some severe thunderstorms today here in the front range which forced me to shut down my servers. I took the opportunity to take some photos.</p>



<h2>A little history to start</h2>



<p>Building out my servers has been a long, multi-year effort. I started the process right around the time that NVIDIA launched their Ampere GPU lineup. I was fortunate to be able to grab 6 RTX 3090s right around launch time, and slowly built up my inventory one GPU at a time over the course of 2021. I’m sure no one will believe me, but I did manage to purchase every one of the 16 GPUs I own at MSRP.</p>



<p>I maintain two servers. The reason is that I run this whole operation as a business: one of my servers is rented out on vast.ai. This server pays the bills: electricity, component replacement, upgrades, etc. The other server is solely used for my deep learning projects. Both servers are identical except for storage and GPU count. The rental server only has 7 GPUs while my ML server has 8. My ML server also has a massive bank of SSDs to store my datasets.</p>



<p>It probably goes without saying, but I built and maintain these rigs myself. They were pieced together at the component level. I have always enjoyed building computers and I can honestly say that I like maintaining these rigs almost as much as I like using them to build models.</p>



<p>A goal from the get-go was maximum GPU density per-server. This is because without dropping serious $$$ on mellanox high-speed NICs and switches, inter-server communication bandwidth quickly becomes the bottleneck when training large models. I can’t afford fancy enterprise grade hardware, so I get around it by keeping my compute all on the same machine. This goal drives many of the choices I made in building out my servers, as you will see.</p>



<h2>Pics</h2>



<p>Here are some pictures of my 7 GPU rig. As stated above, the 8 GPU server is nearly identical except for a large SSD array hidden away inside.</p>



<p>The pictures were taken with a bright LED shining on the computer, and look far more dusty than they actually are. Don’t judge me. 🙂</p>



<figure><img width="1600" height="1234" src="https://nonint.com/wp-content/uploads/2022/05/front.jpg" alt=""><figcaption><em>Frontal view. The cabling slips in underneath the bottom fans when in operation.</em></figcaption></figure>



<figure><img loading="lazy" width="1600" height="1200" src="https://nonint.com/wp-content/uploads/2022/05/rear.jpg" alt=""><figcaption><em>Rear view. 3PSUs, 7GPUs and a motherboard. It’s a tight fit!</em></figcaption></figure>



<figure><img loading="lazy" width="1600" height="1397" src="https://nonint.com/wp-content/uploads/2022/05/side.jpg" alt=""><figcaption><em>Good view of my custom memory heat sinks, discussed later</em></figcaption></figure>



<figure><img loading="lazy" width="1600" height="1200" src="https://nonint.com/wp-content/uploads/2022/05/top2.jpg" alt=""><figcaption><em>Top down view. The cables are normally routed on the rear of the GPUs. I neglected to tidy up before taking the pics. Whoops.</em></figcaption></figure>



<figure><img loading="lazy" width="1600" height="1200" src="https://nonint.com/wp-content/uploads/2022/05/board.jpg" alt=""><figcaption><em>View of the motherboard. I use standard risers on this server for the GPUs powered by the main power supply and maxcloudon risers elsewhere. The other server only uses maxcloudon risers.</em></figcaption></figure>



<h2>Components</h2>



<p>Lets talk specs. My deep learning server consists of:</p>



<p><em>(Note: Amazon and eBay links below are affiliate links, because either I’m a shill, or it doesn’t matter – take your pick.)</em></p>



<ul><li>CPU: <a href="https://www.ebay.com/sch/i.html?_from=R40&amp;_trksid=p2380057.m570.l1313&amp;_nkw=epyc+7502&amp;_sacat=0&amp;mkcid=1&amp;mkrid=711-53200-19255-0&amp;siteid=0&amp;campid=5338090643&amp;customid=7502&amp;toolid=10001&amp;mkevt=1">AMD EPYC 7502</a></li><li>GPUs: 8x RTX 3090</li><li>Motherboard: <a href="https://amzn.to/38TRekO">Asrock ROMED8-2T</a></li><li>Memory: 256GB <a href="https://www.ebay.com/sch/i.html?_from=R40&amp;_trksid=p2380057.m570.l1313&amp;_nkw=Cisco+PC4-2400T&amp;_sacat=0&amp;mkcid=1&amp;mkrid=711-53200-19255-0&amp;siteid=0&amp;campid=5338090643&amp;customid=&amp;toolid=10001&amp;mkevt=1">Cisco PC4-2400T DDR4 RAM</a></li><li>Storage: <a href="https://amzn.to/3NHnZjN">Samsung 970 EVO 512GB</a>, <a href="https://amzn.to/3NHoiLt">ADATA SX8200PNP 2TB</a>, 8x <a href="https://amzn.to/3t9wpZl">Samsung 860 QVO 8TB</a></li><li>Case: <a href="https://www.ebay.com/itm/184640925437?amdata=enc%3AAQAHAAAAkC2480pi5NLN13z03ExumKClbw2426NYSe2YIwKeYiBi0MC%2BQ0DCu5uFToSmo1Rx%2BUbw1qNSfl8bSIe3S9iAJLA0Q1%2BNjUOmgSwZwHzEIZkV4x1jiSeBqG4V7%2BdtpUo9LZnXyfFqJrHBXBkRZnpz3xVQAVELEHkiG0akwcT%2FF1lD%2F7cIRth%2FH9idfZLMHWAthw%3D%3D&amp;mkcid=1&amp;mkrid=711-53200-19255-0&amp;siteid=0&amp;campid=5338090643&amp;customid=aaawave&amp;toolid=10001&amp;mkevt=1">AAAwave 12 GPU</a></li><li>PCI-E Risers: <a href="https://riser.maxcloudon.com/en/bifurcated-risers/25-bifurcated-riser-x16-to-2x8-set.html">Maxcloudon Bifurcated Risers</a></li><li>PSUs: 3x <a href="https://amzn.to/3GBFqjl">EVGA 1600W G+</a></li></ul>



<p>I’ll talk over these choices:</p>



<p><strong>CPU</strong> – This was an easy choice. With the goal being GPU density, PCIe lanes were of paramount importance. EPYC has no competition in this regard. In terms of choosing core-counts: I deemed 64 cores to be excessive for my needs, and it is fairly hard to come across 24-core EPYCs. I purchased both of my 7502 CPUs used for under $1000 on eBay. I think this was a steal. The other good option is the Threadripper pro, for which the 32 core model retails at $2800. One of my EPYC’s is a retail model, the other is a QS model. I haven’t noticed any difference between the two. If you buy one of these like I did, be very careful not to buy one removed from an American server manufacturer, they are often node-locked.</p>



<p><strong>GPUs </strong>– I use RTX 3090s exclusively. I am not married to any particular version of the 3090, and my servers are a hodge-podge of the OEM NVIDIA 3090 variant and the EVGA FTW variant. The reason I only have these two is because all other manufacturers are scalping us (though I expect that to change soon..) I also like the rear-exhaust design of the OEM model, which lends itself well to multi-GPU configurations. I re-pasted and replaced the thermal pads on all of my GPUs. Both EVGA and NVIDIA did a horrible job with memory thermals and they should frankly be embarrassed with themselves. Selling $2000 GPUs that immediately go to 100% fan power and derate themselves when the memory modules hit 110C is utterly unacceptable. This is not just because I am misusing these GPUs: I have a single-GPU workstation that exhibits the same problems while gaming. Shame. I also added custom heatsinks to the backplates of the OEM 3090s where the memory modules reside. These reduce the memory temps by an additional 10C.</p>



<p><strong>Motherboard</strong> – My primary goal when selecting a motherboard was to find a single-CPU board with the maximum number of possible full-width PCI-E x16 slots. Since I was bound to the EPYC CPU, this basically constrained me to the ROMED8-2T. On paper, this board has fantastic specs and was exactly what I was looking for. In practice, it has a fair number of infuriating bugs that make me wish some other players were in the market. For example, I cannot update the firmware on the board (it always errors out no matter which method I use), the IPMI is garbage, and you cannot use all of the SATA ports without doing a weird configuration hack in the BIOS which has no documentation whatsoever.</p>



<p><strong>RAM</strong> – Server memory is damned expensive! The only nice thing I can say about my memory is that it was cheap. My RAM is slow and the sticks are slowly dying one at a time. This will be the next upgrade when I can scrape together the sheckels..</p>



<p><strong>Storage</strong> – I have a 1TB NVME for the OS drive and a 2TB NVME to store code and model checkpoints. The latter is certainly overkill as everything vital is permanently in RAM anyways. I also have an array of 8x 8TB Samsung QVOs in RAID 5 with 1 redundant drive to store my datasets. Random access is extremely important for machine learning so HDDs were not an option. These are quite pricey these days but I picked them up for under $500/pc on a lucky black friday sale. Kinda wish I had bought some more at this point.</p>



<p><strong>Case</strong> – I originally constructed my two servers in a <a href="https://www.ebay.com/itm/324829932257?hash=item4ba15f6ae1:g:ZI4AAOSw5HthZvwR&amp;amdata=enc%3AAQAHAAAA4BuCn70W1EYPTDdnlWlj9%2BtWajQcNd5yYcBdN56uwgsDSTkBiyzr7djdPtemFKgqXBAtlmcqdHJy8WJhJf4jYVFY6hGKtygeT95xCH0P%2Fj0F%2BPKRbCTCtLH0yZg94q8yTz9cOsOg4ryW%2B7MgJtqXpU2jOORCAIFDJqeIhX%2BnB%2FMLOxzVarQPZLPMVP8LKOOK2d87ZwcA3OpefyNjimR0%2Fp1aXYjWwuMrJt0RpwXK8DMnaqYsPP6L431dJWyYkQG1WCFy7boztmEB6FlIoTRRuFbkv8sGQgzHHORmKDg78R4q%7Ctkp%3ABFBMuqCh3aJg">rackmounted chassis</a> built for mining. I had a lot of trouble with airflow and maintenance was a PITA. At some point I gave up and went for an open-air design, which is what I have stuck with. The AAAwave case I ended up with is basic and fairly cheap, and it gets the job done. I could probably fit 9 3090s total in this case, but I’d probably want to get more clever about airflow if I did so.</p>



<p><strong>PCI-e Risers</strong> – This is another component that is surprisingly tricky to figure out. Because most of the GPUs use a different power supply from the motherboard, you cannot use “normal” PCI-e risers like you would find at your local computer parts store. You need to use risers with an electrically isolated PCI-e slot. I also needed risers with a fairly long length, at least 2 feet. There were two options I found for this: the first are the <a href="https://comino.com/en/risers/">Comino risers</a>. LTT featured these awhile back and they are some slick kit. Unfortunately, they have some kind of issue with 3090 cards (or I am using them wrong). I had three of them burn out at the PCI-e connector before I gave up on them permanently. Fortunately, none of them damaged any GPUs. Lately, I have been using <a href="https://riser.maxcloudon.com/en/bifurcated-risers/25-bifurcated-riser-x16-to-2x8-set.html">these bifurcated risers</a> from maxcloudon. They allow me to split my GPU slots (meaning I can support up to 14 GPUs on a single server!) and have been dead reliable for almost 6 months now. The biggest downside is that all of these risers only work with PCIE gen 3. If anyone has any tips for power-isolated gen 4 compatible risers with bifurcation support, PLEASE contact me. You will have a friend for life.</p>



<p><strong>PSUs</strong> – Naive me thought that I would be able to power 4x “350W” GPUs with a single 1600W PSU. Nope. Doesn’t work, not even on 240V. A lesser-known fact about 3090s is they actually pull burst currents of up to 600W. This means that a 1600W PSU will power-on and even run 4x 3090s, but it will randomly trip the overcurrent protection when all 3090s simultaneously draw their peak power, which happens every couple of hours. This was a fun one to figure out. I now run 3 1600W PSUs, each one powering 3 GPUs (or 2 GPUs+everything else). All PSUs run on 240V circuits I had installed specifically for these servers. I have several 2400W server PSUs that I intend to move to someday, but they are too loud to be used while these servers live in my home.</p>



<h2>Cooling &amp; Power</h2>



<p>When I moved past 6 GPUs, power and thermals started to become a concern for me. I housed these servers in the utility room of my basement, so ventilation was already pretty good and the heat didn’t affect my family too much, but I was worried about component life as the room was regularly sitting at 100F. I had also exhausted what two 120V outlets were able to safely give.</p>



<p>To solve the electricity problem, I had an electrician come in and install two 240V circuits with L6-20P sockets. You can purchase cords that are compatible with most large power supplies for these sockets on eBay. Most high-end power supplies are already dual-voltage compatible so nothing needed to be done there. Some power supplies come with switches on the back to swap between 120V and 240V so RTFM.</p>



<p>Heat was a bit more challenging. My utility room has two ventilation shafts built in which were passive. I opted to install two <a href="http://vortexpowerfans.com/vtx-series">centrifugal air pumps</a>, one hooked to each ventilation shaft to move air out of the room. I built an enclosure around the servers using cinderblocks and sheet metal. I made the enclosure air-tight and the centrifugal pumps pull air directly from inside the enclosure, establishing negative pressure behind the computers. This was highly effective at dealing with the heat problem, and the room is only a few degrees above the rest of the house now. </p>



<figure><img loading="lazy" width="1200" height="992" src="https://nonint.com/wp-content/uploads/2022/05/slot-1.jpg" alt=""><figcaption><em>Each server slots into a cinderblock &amp; sheetmetal enclosure which is ventilated by dual centrifugal fans.</em></figcaption></figure>



<p>I want to provide an operational note that is related to thermals an power: I set the power limit on all of my GPUs to 285W, ~80% of the rated power of a 3090. From testing, this reduces performance by ~6% but greatly improves thermals.</p>



<p>The GPUs do run hot, however. Viewed from the front of the server, the rightmost GPUs run the hottest in the high 70s C, as reported by nvidia-smi. The leftmost operate in the 60s. I justify this by remembering that my A5000 workstation GPU runs at 85C at all times, despite having excellent airflow.</p>



<figure><img loading="lazy" width="1440" height="1080" src="https://nonint.com/wp-content/uploads/2022/05/FLIR_20220530_080006.jpg" alt=""><figcaption><em>Pic of the thermals of a few of the GPUs while training. The hot regions are where the GDDR6X memory contacts the back plate, hence the fins I installed on all of the OEM GPUs. EVGA GPUs are a tad better in this regard.</em></figcaption></figure>



<h2>A practical guide to using multiple PSUs</h2>



<p>Figuring out how to power these servers with multiple PSUs was by far the most nerve-wracking part of the build. If you attempt to do some research about going this route, be prepared to read commentary from hundreds of self-professed electrical engineers telling you “<strong>do not, under any circumstances do this!</strong>“</p>



<p>Being the headstrong and reckless guy that I am, I did it anyways. My line of reasoning was that if I isolated the PSUs into separate “circuits” that only got joined at the ground and data lines, I probably wouldn’t have to worry too much about them fighting with each other and causing failures. I built out these “circuits” using the maxcloudon PCIe powered risers, which allow me to fully power on 3x GPU “subsystems” with each 1600W power supply. All “circuits” are tied at the ground.</p>



<p>One extremely strange issue I ran into at one point was that one of my servers became what I can only describe as “electrically tainted”. If this computer was plugged into a network switch, the switch stopped routing traffic and the entire network behind that switch went dead. The computer was still operating fine with an attached keyboard and monitor. After a lot of experimentation, I isolated the problem to a single power supply “circuit” on the computer. If this circuit (and the attached GPUs) was disabled, the problem disappeared. The only unique thing about this circuit is that it was powered by a different PSU, a corsair AX1600i while the rest of the circuits used EVGA Golds. On a whim, I swapped in a spare 1600 gold and the problem disappeared. Since then, when combining PSUs, I have only used PSUs from the of the same make and model.</p>



<p>Past the above issue, I have not had any other problems in 2 years of near-continuous operation for both servers. Does this mean you should do it? Probably not. I’m not an EE and this is some expensive equipment. You make your own risk calls.</p>



<h2>Why am I not using &lt;x&gt; GPU?</h2>



<p>Because, frankly, the 3090 is a very nice sweet spot for someone like me looking to balance cost and performance. A little known, but fun fact is that it actually has better FP32 performance than even the A100. FP16 performance is dogshit due to software locks NVIDIA put in place. There is little reason to use FP16 except for the small amount of VRAM savings. That’s fine, it means I don’t have to worry about numeric stability. 🙂</p>



<p>I have considered building out a A6000 server. 48GB of VRAM would be quite nice, and fully unlocking FP16 would be great as well. I also prefer the cooling solution on the A6000 (though knowing about the shit NVIDIA pulled with the 3090, I’m sure the thermals are atrocious). It’s honestly a cost problem at this point. An 8x A6000 server will cost me somewhere in the realm of $40k, maybe a little less if NVIDIA gave me some research / SMB discounts. That’s more than both of the servers I currently own cost combined. Just for the GPUs. It’ll be cool if I could scrape that kind of dough together at some point, but for now I’m stuck to consumer GPUs. </p>



<h2>Wrapping up..</h2>



<p>I hate that high performance computing has become synonymous with the hyperscalers and that most people don’t even consider building out their own hardware anymore. Building computers is super cool and more people should do it. It may even become relatively cheap to do so as miners start liquidating their assets after ETH 2.0 goes live. I hope this helps out others who are interested in building deep learning rigs.</p>



<p>One other thing: I hesitated somewhat posting this out of concerns of becoming a target for robbery. To any would be thieves out there: my computers will soon be relocated to a new industrial space so that I can continue building out my operation. Please stay away from my home.</p>

			</div><!-- .entry-content -->
</article><!-- #post-218 -->

		</main><!-- #main -->
	</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Asteroid ZTm0038 with a >3% impact probability (208 pts)]]></title>
            <link>https://newton.spacedys.com/neodys2/NEOScan/risk_page/ZTm0038/index_summary_ZTm0038.html</link>
            <guid>37138102</guid>
            <pubDate>Tue, 15 Aug 2023 19:19:16 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://newton.spacedys.com/neodys2/NEOScan/risk_page/ZTm0038/index_summary_ZTm0038.html">https://newton.spacedys.com/neodys2/NEOScan/risk_page/ZTm0038/index_summary_ZTm0038.html</a>, See on <a href="https://news.ycombinator.com/item?id=37138102">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="mainContent2">

	<!-- #CONTENT-WARNING-NOSIG -->
		
	<table>
	  <tbody><tr>     
	    <!--
		<th align="center" width="50">NEOCP name            </th>
		-->
	    <th>Asteroid name            </th>
	    <th>Number of observations</th>
	    <th>Arc length (h)        </th>
	    <th title="Epoch of the orbit with minimum χ">Epoch (MJD)         </th>
	    <th title="Residuals RMS of the orbit with minimum χ">RMS          </th>
	    <th title="Absolute magnitude of the orbit with minimum χ">H            </th>
	    <th title="MOID of the orbit with minimum χ">&nbsp;MOID&nbsp; (au)    </th>
	    <th title="Closest approach distance of the orbit with minimum χ">CA dist. (LD)</th>
	    <th title="Velocity at infinity of the orbit with minimum χ">V_inf (km/s)</th>
	  </tr>
	  <!-- #CONTENT-GEN -->
<tr>
<td>ZTm0038</td>
<td>8</td>
<td>24.23</td>
<td>60169.002</td>
<td>1.183</td>
<td>19.90</td>
<td>0.0000296</td>
<td></td>
<td>15.84</td>
</tr>
	</tbody></table>

	<br>
	<!--
	    !-------------!
	    ! Scores data !
	    !-------------!
	  -->
	<h3> Probabilities and scores </h3> 
	<center>
	  <table>
	    <tbody><tr>
	      <td>
		<table>
		  <tbody><tr>     
		    <th>NEO score</th>
		    <th>MBO score</th>
		    <th>&nbsp;&nbsp;DO&nbsp;&nbsp; score</th>
		    <th>&nbsp;&nbsp;SO&nbsp;&nbsp; score</th>
		  </tr>
		  <!-- #CONTENT-SCORE-OBJ -->
<tr>
<td>1.00</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00
</td>
</tr>
		</tbody></table>
	      </td>
	      <td></td><td></td><td>
	      </td><td>
		<table>
		  <tbody><tr>     
		    <th>PHA score</th>
		  </tr>
		  <!-- #CONTENT-SCORE-PHA -->
<tr>
<td>1.00</td>
</tr>
		</tbody></table>
	      </td>
	      <td></td><td></td><td>
	      </td><td>
		<table>
		  <tbody><tr>     
		    <th>Geocentric score</th>
		  </tr>
		  <!-- #CONTENT-SCORE-GEOC -->
<tr>
<td> 0.028</td>
</tr>
		</tbody></table>
	      </td>
	      <td></td><td></td><td>
	      </td><td>
		<table>
		  <tbody><tr>     
		    <th>Impact probability</th>
		  </tr>
		  <!-- #CONTENT-IP -->
<tr>
<td>0.034</td>
</tr>
		</tbody></table>
	      </td>
	    </tr>
	  </tbody></table>
	</center>

	<br>
	<!--
	    !-----------------------!
	    ! Auxiliary information !
	    !-----------------------!
	  -->
	<h3> Auxiliary information </h3> 
	<!-- #CONTENT-AUXILIARY-INFO -->
<p>Absolute magnitude of impactors: H_min = 18.84 and H_max = 20.84</p>
<p>Closest approach time of impactors: t_min = 2023/08/14 04:48 TDB and t_max = 2023/08/15 12:22 TDB</p>
<p>Velocity at infinity of impactors: v_inf_min =   7.668 [km/s] and v_inf_max =  55.785 [km/s]</p>
<p>Run started at 2023-08-14 23:51 UTC and ended at 2023-08-15 00:06 UTC</p>

	<br>
	<!-- 
	     !----------!
	     ! Arc data !
	     !----------!
	  -->
	<h3> Arc data </h3>	
	<table>
	  <tbody><tr>     
	    <th rowspan="2">Arc type                 </th>
	    <th colspan="3">Significance of curvature</th>
	  </tr>
  	  <tr>     
	    <th>Geodesic    </th>
	    <th>Acceleration</th>
	    <th>Overall     </th>
	  </tr>
	  <!-- #CONTENT-ARC -->
<tr>
<td>1</td>
<td>-1.93</td>
<td>-3.08</td>
<td>3.65</td>
</tr>
	</tbody></table>

	<br>
	<!--
	    !-------------------!
	    ! MOV sampling data !
	    !-------------------!
	  -->
	<h3> MOV sampling data </h3>
	<table>
	  <tbody><tr>     
	    <th>Number of sample points       </th>
	    <th>Number of MOV orbits          </th>
	    <th>Number of impacting MOV orbits</th>
	  </tr>
	  <!-- #CONTENT-SAMPLING -->
<tr>
<td>6400</td>
<td>969</td>
<td>204</td>
</tr>
	</tbody></table>

	<br>
	
	<!-- #CONTENT-BACK-TO-MAIN -->
<h3><a href="https://newton.spacedys.com/neodys2/NEOScan/index_risk.html">BACK to the Risk Page</a></h3>      </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Probabilistic Machine Learning: Advanced Topics (166 pts)]]></title>
            <link>https://probml.github.io/pml-book/book2.html</link>
            <guid>37137810</guid>
            <pubDate>Tue, 15 Aug 2023 18:57:16 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://probml.github.io/pml-book/book2.html">https://probml.github.io/pml-book/book2.html</a>, See on <a href="https://news.ycombinator.com/item?id=37137810">Hacker News</a></p>
<div id="readability-page-1" class="page">
by <a href="https://www.cs.ubc.ca/~murphyk/">Kevin Patrick Murphy</a>.
<br>
MIT Press, 2023.


	<p>
	  <img src="https://raw.githubusercontent.com/probml/pml2-book/main/cover2.jpg" alt="Book cover">
</p><h2>Key links</h2>

<ul>
	  
	<li> <a href="#toc">Short table of contents</a>
		
	    </li><li> <a href="https://github.com/probml/pml2-book/blob/main/toc2-long-2023-01-19.pdf">
		    Long table of  contents</a>
		    
</li><li> <a href="https://github.com/probml/pml2-book/blob/main/preface2-2023-01-02.pdf">Preface</a>

  </li><li> <a href="https://github.com/probml/pml2-book/releases/latest/download/book2.pdf">
    Draft pdf of the main book</a>, 2023-08-15.  CC-BY-NC-ND license. (Please cite the official reference below.)
       		    
</li><li> <a href="https://github.com/probml/pml-book/blob/main/supp2.md">Supplementary material</a>
	
  </li><li> <a href="https://github.com/probml/pml2-book/issues">Issue tracker</a>. 
	   
	  </li><li> <a href="https://github.com/probml/pyprobml/tree/master/notebooks/book2">
	    Code to reproduce most of the figures</a> 
		 
	  
</li><li> <a href="#ack">Acknowledgements</a>
	
	</li><li> <a href="#endorsements">Endorsements</a>
	
</li></ul>

If you use this book, please be sure to cite
<pre><code>
 @book{pml2Book,
 author = "Kevin P. Murphy",
 title = "Probabilistic Machine Learning: Advanced Topics",
 publisher = "MIT Press",
 year = 2023,
 url = "http://probml.github.io/book2"
}
</code></pre>


<p> Downloads since 2022-02-28. 
  <img src="https://img.shields.io/github/downloads/probml/pml2-book/total" alt="download stats shield">
  
</p><h2><a id="toc">Table of contents</a></h2><a id="toc">


    <img src="https://raw.githubusercontent.com/probml/pml2-book/main/toc2-short-2023-01-02.png" alt="TOC">
    
	  
</a><h2><a id="toc"></a><a id="endorsements"></a>Endorsements</h2>

<ul>
	<li>
			"Kevin Murphy has distilled the vast and confusing literature on machine learning and neural networks
			into a beautifully written 
			and extremely clear textbook that will be a wonderful resource for both new students 
			and seasoned researchers who are trying to keep up with this fast moving field.  
			The chapter on generative models is a masterpiece."
			-- <a href="https://www.cs.toronto.edu/~hinton/">Geoff Hinton</a>, U. Toronto/ Google.
		  
	</li><li> "Kevin Murphy had already impressed and greatly benefited the machine learning community with his introductory
		book on probabilistic ML
		and I am delighted to see the depth and breadth of material in his new sequel on advanced probabilistic ML.
		The book covers topics which I believe are at the heart of past and upcoming advances in our field,
		while often lacking in the training of graduate students in computer science, 
		and I therefore recommend it highly to all of them."
		-- <a href="https://yoshuabengio.org/">Yoshua Bengio</a>, U. Montreal
		
		</li><li> "This book is an amazing tour de force: Murphy and his co-authors have described and systematized virtually 
		all of the important advances in machine learning over the past 30 years. Pick any topic, and they provide a 
		crisp description of the state-of-the-art methods in a common, well-chosen notation and using a set of core concepts 
		in modeling, statistics, and optimization. This book will be a valuable starting point for students entering 
		the field and a wonderful reference for seasoned researchers. It is hard to imagine a better antidote to the vast, 
		confusing, and voluminous literature in machine learning.  This is such an amazing book! I learned things even in the sections
		where I’m fairly up to date with the literature. " --- <a href="https://web.engr.oregonstate.edu/~tgd/">Tom Dietterich</a>,
		Oregon State University
		
	</li><li> "The prior version of Dr. Murphy's book was amongst the 3-4 books I recommended to students and machine learning colleagues 
		at all levels as being essential to own, and, perhaps more importantly, to always have readily at hand. 
		As machine learning has matured and evolved, no other comprehensive resource of this nature has even remotely
		kept pace with modern methodological developments.  This new version is a blessing for the machine learning community and frankly, 
		at this moment in time, is the only truly necessary machine learning book to own. 
		Very few people in the world can do what Dr. Murphy has done here and the world owes him its thanks." 
		-- <a href="https://www.cs.ubc.ca/~fwood/">Frank Wood</a>, UBC. 
		
	</li><li> "Whether teaching machine learning to undergrads, master students, or PhD students, 
		I found myself time and time again choosing the 2012 "Machine Learning: A Probabilistic Perspective" as the primary textbook. 
		When I heard about the new "Probabilistic Machine Learning" series, I was thrilled to see the expanded and modernized set of topics;
		this will be the go-to book for my ML courses at Stanford.  Kevin Murphy has a phenomenal ability to go deep while making topics 
		digestible to a broad audience.  His writing is clear and concise with great visuals throughout.  I highly recommend this as "the book" 
		for anyone wanting to become a well-versed ML expert." -- <a href="https://emilybfox.su.domains/">Emily Fox</a>, Stanford.
	
		
		</li><li> "Murphy’s book is certainly the most comprehensive resource on machine learning available today. 
			With the growing body of research in the field, 
			it is a daunting challenge to provide an organized perspective of the current state of  knowledge. 
			This book achieves this feat by integrating classic material, like MCMC inference, 
			with very recent developments like denoising diffusion models. 
			The material is organized and presented in a very accessible and intuitive manner,
			making the book an asset for any researcher or practitioner in the field." --
			<a href="https://cs3801.wixsite.com/amirgloberson">Amir Globerson</a>, Tel Aviv University.
			
		</li><li> "This new Advanced Topics volume will provide a crucial path from the foundations of machine
		learning to state-of-the-art probabilistic models, many of which have only been described in the research literature.  
		I particularly like the way it draws parallels between variational and Monte Carlo inference,
		and between graphical models and (Bayesian) deep learning, so one can see the deep links between 
		methods that are sometimes cast as competitors.  
		I look forward to the next generations of probabilistic machine learning that this volume inspires." 
		--- <a href="https://www.ics.uci.edu/~sudderth/">Erik Sudderth</a>, UC Irvine.
		
	
		
		</li><li> "This book provides an outstanding and deep tour of the most foundational ideas in probabilistic machine learning. 
		It explains the essential mathematical and computational tools that a student needs to move beyond the basics. 
		With this book, 
		Murphy provides a comprehensive resource that will be great not just to learn from, but also as a reference 
		to return to again and again." -- <a href="https://www.cs.princeton.edu/~rpa/">Ryan Adams</a>, Princeton.
	
	</li><li> "Kevin Murphy's book is a landmark achievement in machine learning. It provides an in-depth coverage of
		a wide range of topics in probabilistic machine learning, from inference methods to generative models
		and decision making. It gives a modern perspective on these topics, bringing them up to date with recent
		advances in deep learning and representation learning. The insights in this 
		book are essential for a solid understanding of the field, 
		and I highly recommend it to students and experts alike." 
		-- <a href="http://mlg.eng.cam.ac.uk/zoubin/">Zoubin Ghahramani</a>, Cambridge/Google.
		
	</li><li> "As a
researcher trained by Murphy's 2012 book, I was excited to read
its sequel "Probabilistic Machine Learning: Advanced Topics." This new
book brings us to the forefront of cutting-edge probabilistic ML,
distilling the recent advances into a systemic exposition. It
communicates the core ideas of these recent advances in an
impressively clear and intuitive way, while managing to convey the
depth of these ideas by situating them in a broad context. It will 
		become a major reference that I constantly return to."
		-- <a href="https://yixinwang.github.io/">Yixin Wang</a>, U. Michigan.
	</li></ul>
		
	
  <h2><a id="ack"></a>Acknowledgements</h2>

I would like to thank the following people for helping with this book.

<ul>

<li> People who helped to write various sections and chapters:
	Alex Alemi (Google),
 Jeff Bilmes (U. Washington), 
	Peter Chang,
 Marco Cuturi (Apple, work done at Google), 
	Alexander D'Amour (Google),
	Finale Doshi-Velez (Harvard),
 Roy Frostig (Google), 
	Justin Gilmer (Google),
	Giles Harper-Donnelly,
	Been Kim (Google),
	Durk Kingma (Google),
	Simon Kornblith (Google),
   Balaji Lakshminarayanan (Google),  
	Lihong Li (Amazon, work done at Google), 
 Xinglong Li (UBC),
	Shakir Mohamed (Deepmind),
	George Papamakarios (Deepmind),
	Zeel Patel (IIT Gandhinagar),
	Ben Poole (Google),
	Mihaela Rosca (Deepmind / UCL),
  Vinayak Rao (Purdue), 
	 Yang Song (Stanford),
	Victor Veitch (Google / U. Chicago),
Andrew Wilson (NYU).
	
		      
      </li><li> Many people who helped make or improve the figures, including:
 Vishal Ghoniya,  Ankita Kumari Jain,  Aleyna Kara,  Zeel Patel, Karm Patel,
  Dhruv Patel, Nitish Sharma, Mahmoud Soliman.
    
</li><li> Participants in the Google Summer of Code (GSOC) for 2021,
including
Ming Liang Ang,
Aleyna Kara, Gerardo Duran-Martin,
Srikar Reddy Jilugu,  Drishti Patel,
and co-mentor Mahmoud Soliman.

</li><li> Participants in the Google Summer of Code (GSOC) for 2022,
  including
  Peter Chang, Giles Harper-Donnelly,
  Xinglong Li,
  Zeel Patel, Karm Patel, Qingyao Sun,
and co-mentors Nipun Batra and Scott Linderman.


</li><li> Many other people who contributed code
	(see auto-generated list <a href="https://github.com/probml/pyprobml#acknowledgements">here</a>).
	
	</li><li> Many people who helped with proof reading (see book preface for list).
	 
  
    </li></ul>
</div>]]></description>
        </item>
        <item>
            <title><![CDATA[The Future of Terraform Must Be Open (127 pts)]]></title>
            <link>https://blog.gruntwork.io/the-future-of-terraform-must-be-open-ab0b9ba65bca?gi=c07f9cd96456</link>
            <guid>37137781</guid>
            <pubDate>Tue, 15 Aug 2023 18:54:38 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://blog.gruntwork.io/the-future-of-terraform-must-be-open-ab0b9ba65bca?gi=c07f9cd96456">https://blog.gruntwork.io/the-future-of-terraform-must-be-open-ab0b9ba65bca?gi=c07f9cd96456</a>, See on <a href="https://news.ycombinator.com/item?id=37137781">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><div><h2 id="c567">Our plan and pledge to keep Terraform open source</h2><div><a href="https://medium.com/@brikis98?source=post_page-----ab0b9ba65bca--------------------------------" rel="noopener follow"><div aria-hidden="false"><p><img alt="Yevgeniy Brikman" src="https://miro.medium.com/v2/resize:fill:88:88/1*7IJ4hkSmGgjeibEpJfbMGQ.jpeg" width="44" height="44" loading="lazy" data-testid="authorPhoto"></p></div></a><a href="https://blog.gruntwork.io/?source=post_page-----ab0b9ba65bca--------------------------------" rel="noopener  ugc nofollow"><div aria-hidden="false"><p><img alt="Gruntwork" src="https://miro.medium.com/v2/resize:fill:48:48/1*d6HE86wu0vvHrTQi_FZ3NQ.jpeg" width="24" height="24" loading="lazy" data-testid="publicationPhoto"></p></div></a></div></div><figure></figure><p id="f23e">On August 10, 2023, HashiCorp announced that after ~9 years of Terraform being open source under the MPL v2 license, they were suddenly switching it to a non open source BSL v1.1 license. We believe the BSL license is a poison pill for Terraform which threatens the entire community and ecosystem, and in this blog post, we’ll introduce <a href="https://opentf.org/" rel="noopener ugc nofollow" target="_blank">OpenTF</a>, our plan for keeping Terraform open source—forever.</p><h2 id="7b5c">Why the BSL license is a poison pill for Terraform</h2><h2 id="b3c6">The virtuous cycle of open source</h2><p id="5ada">Terraform was originally released under the <a href="https://www.mozilla.org/en-US/MPL/2.0/FAQ/" rel="noopener ugc nofollow" target="_blank">Mozilla Public License</a> (MPL) v2.0, which is a well-known, trusted, and permissive open source license: MPL allows you to use Terraform for just about any purpose and incorporate it into any product, including copying, modifying, and redistributing the code. The only limitation is that if you modify the source code of Terraform itself, you have to release those modifications under the same MPL license.</p><p id="a2a2">The permissive terms of this license were a key factor in why the community adopted Terraform:</p><ul><li id="055b">Companies were comfortable in adopting Terraform, as the license ensured there would be no unexpected fees or IP problems.</li><li id="2be6">Developers were comfortable in contributing to <a href="https://github.com/hashicorp/terraform/" rel="noopener ugc nofollow" target="_blank">Terraform core</a> (which had 1,700+ contributors as of this writing) and the hundreds of Terraform providers (the <a href="https://github.com/hashicorp/terraform-provider-aws" rel="noopener ugc nofollow" target="_blank">AWS provider</a> had 2,800+ contributors and the <a href="https://github.com/hashicorp/terraform-provider-azurerm" rel="noopener ugc nofollow" target="_blank">Azure provider</a> had 1,300+ contributors as of this writing), as the license ensured they’d be able to use their work in both their current jobs and any future ones.</li><li id="355c">Vendors created tools, modules, and extensions for Terraform (e.g., at Gruntwork, we created <a href="https://terragrunt.gruntwork.io/" rel="noopener ugc nofollow" target="_blank">Terragrunt</a>, <a href="https://terratest.gruntwork.io/" rel="noopener ugc nofollow" target="_blank">Terratest</a>, and the <a href="https://gruntwork.io/infrastructure-as-code-library/" rel="noopener ugc nofollow" target="_blank">IaC Library</a>), as the license ensured you’d be able to use this work, whether for fun (e.g., as part of a side project) or profit (e.g., as part of a proprietary project).</li></ul><p id="a02b">This led to a virtuous cycle: as more companies adopt Terraform, more developers start using it; those developers contribute to Terraform, fixing bugs, improving security, adding new features, creating new tools and extensions, etc.; that makes Terraform even more compelling, so even more companies adopt it, and the cycle continues. As a result, Terraform has become one of the most popular infrastructure as code (IaC) tools on the market.</p><p id="3112"><strong>But none of this would have happened if Terraform hadn’t been released under a truly open source license</strong>. Those companies wouldn’t have adopted it; those developers wouldn’t have contributed to it; I can say for certain we would’ve never built Terragrunt, Terratest, and the IaC Library, or even written <a href="https://www.terraformupandrunning.com/" rel="noopener ugc nofollow" target="_blank"><em>Terraform: Up &amp; Running</em></a>, if Terraform hadn’t been open source.</p><h2 id="0e18">The move to BSL</h2><p id="920b">After ~9 years of seeing the virtuous cycle of open source in action, we were shocked to hear HashiCorp’s <a href="https://www.hashicorp.com/blog/hashicorp-adopts-business-source-license" rel="noopener ugc nofollow" target="_blank">announcement</a> that they were suddenly switching Terraform to the <a href="https://www.hashicorp.com/bsl" rel="noopener ugc nofollow" target="_blank">Business Source License</a> (BSL) v1.1, which is <em>not</em> an open source license (<a href="https://www.hashicorp.com/license-faq#details-on-nomenclature" rel="noopener ugc nofollow" target="_blank">HashiCorp’s own FAQ</a> even says the BSL doesn’t meet the definition of open source). In fact, not only Terraform, but all other core HashiCorp products are moving to BSL too: e.g., Vault, Consul, Nomad, etc.</p><p id="a744">To some extent, we understand what led HashiCorp in this direction. They are trying to maintain a delicate balance: on the one hand, they are creating amazing value by providing high quality, free, open source software to a community of thousands of developers; on the other hand, they are trying to run a sustainable business, so they need to capture and monetize some of the value they create.</p><p id="0c3f">The tricky part is deciding what to make open source and what to commercialize. If you make too much open source, then you don’t have enough to sell, so you can’t make enough money to pay the very employees who are creating and maintaining these amazing open source projects, so everyone loses; but if you make too little open source, then you never build up a community, and without that community, you can’t sell enough, can’t pay employees, and again, everyone loses. It’s only when you get this balance just right that everyone wins.</p><p id="ed96">Up until last Friday, it seemed like HashiCorp had this balance just right. They did so by making most functionality open source, but reserving some functionality solely for their commercial products, such as Terraform Cloud and Terraform Enterprise. With this approach, the Terraform community grew, companies that used Terraform grew, and, of course, HashiCorp grew into a public, multi-billion dollar company. Everyone wins!</p><p id="d078">That’s why we’re so stumped about the sudden move away from an open source license to a non open source BSL license. We believe that this move away from open source will upset the delicate balance and will lead to a scenario where everyone loses: the community will lose, companies that use Terraform will lose, and ultimately, even HashiCorp will lose. Let’s discuss why.</p><h2 id="44fe">The problems with BSL</h2><p id="8645">The BSL license, along with the additional use grants HashiCorp wrote for it, is generally fairly permissive, allowing you to copy, modify, and redistribute the code. However, there is an exception. The license does <em>not</em> allow you to use Terraform if you meet both of the following conditions:</p><ol><li id="979e">You are building a product that is competitive with HashiCorp.</li><li id="43b3">You embed or host Terraform in your product.</li></ol><p id="e46f"><strong>The first problem is that the terms of the BSL and the use grants are vague.</strong> What does “competitive with HashiCorp” mean and who decides that? And what does “embed or host” mean? If you’re a lawyer and you see this, you start to sweat. The number of questions is infinite. For example, if you’re an independent software vendor (ISV) or managed service provider (MSP) in the DevOps space, and you use Terraform with your customers (but not necessarily Terraform Cloud/Enterprise), are you a competitor? If your company creates a CI / CD product, is that competitive with Terraform Cloud or Waypoint? If your CI / CD product natively supports running Terraform as part of your CI / CD builds, is that embedding or hosting? If you built a wrapper for Terraform, is that a competitor? Is it embedding only if you include the source code or does using the Terraform CLI count as embedding? What if the CLI is installed by the customer? Is it hosting if the customer runs your product on their own servers?</p><p id="a5e5">It’s not an accident that these terms are vague. This is a common practice used by many legal teams to implicitly force you to ask the company for permission, so they can decide on a case-by-case basis: <a href="https://www.hashicorp.com/license-faq#details-on-nomenclature" rel="noopener ugc nofollow" target="_blank">HashiCorp’s FAQ</a> even says that to get clarification on whether what you’re doing is competitive or embedding or hosting, you need to reach out to <a href="mailto:licensing@hashicorp.com" rel="noopener ugc nofollow" target="_blank">licensing@hashicorp.com</a>.</p><p id="500d"><strong>And that leads to the second problem with the BSL: whether your usage complies with the license isn’t determined by the legal terms, but instead is entirely at the whim of HashiCorp.</strong> If HashiCorp doesn’t think you’re a competitor, you’re in the clear. But if they feel threatened by your company: no Terraform for you. If they want to define your usage as embedding or hosting: no Terraform for you. Or perhaps they grant you a license to use Terraform, but only at a fee, and if you can’t pay that fee: no Terraform for you.</p><p id="ee62"><strong>And that brings us to the third, and worst problem with the BSL: HashiCorp can change its decisions at any time. </strong>Perhaps HashiCorp told you your usage was safe before, but a year later, you launched a new product and now they think you’re a competitor, so suddenly, your usage no longer complies with the license. Or perhaps you didn’t change anything on your end, but it’s HashiCorp that launched a new product, which just so happens to be in your market, so now you’re a competitor, and your usage is no longer allowed. Or maybe HashiCorp decides that all the usages that were OK before will now cost money. Or maybe you’ve already been paying them for a license, but suddenly, they decide to raise prices. And no matter what else happens, or what previous decisions or agreements you’ve reached, remember, HashiCorp can just change the license again at any time!</p><p id="7011"><strong>As a result of the change to BSL, there is now no certainty with using Terraform:</strong></p><ul><li id="1fd2">If you’re a CTO, and you’re picking an IaC tool to use at your company, if you see that Terraform is BSL licensed, why take the risk? You’re now much more likely to go with alternative tools that are truly open source and have no licensing headaches.</li><li id="3f81">If you’re on the legal team at a company and reviewing the licenses your dev team wants to use, and you see BSL, why take the risk? You’re now much more likely to push back and put BSL on the banned license list.</li><li id="ae6c">If you’re a developer and considering contributing to open source, why contribute to a BSL project with no guarantee you’d be able to use your own work in the future? You’re now much more likely to contribute to something else.</li><li id="68d6">If you’re a vendor and considering building a product or tooling in the DevOps space, why build it around Terraform, and take the risk that HashiCorp will, now or in the future, consider you competitive? That’s just too shaky of a foundation to build on, so you’re now much more likely to build around something else.</li></ul><p id="3dcf"><strong>In short, BSL breaks the virtuous open source cycle that got Terraform to where it is today.</strong> And once you break that virtuous cycle, everyone loses: adoption will slow, contributions will decrease, and the community and ecosystem will dwindle and wither.</p><h2 id="5e3b">OpenTF: keeping Terraform open source</h2><p id="9908">We believe that the essential building blocks of the modern Internet—tools such as Linux, Kubernetes, and Terraform—must be truly open source. That is the only way to ensure that we are building our industry on top of solid and predictable underpinnings.</p><p id="37f0">Therefore, we have joined forces with a number of other companies to create the <a href="https://opentf.org/" rel="noopener ugc nofollow" target="_blank">OpenTF manifesto</a>. <strong>The goal of the manifesto is to ensure Terraform remains truly open source — always.</strong></p><p id="324e">To this end, the manifesto lays out the following two-step plan:</p><ol><li id="2d67"><strong>Ask HashiCorp to switch Terraform back to open source. </strong>The manifesto is a public request—a petition with signatures—for HashiCorp to do the right thing here and switch Terraform back to a truly open source license (e.g., go back to MPL). Moreover, we want to be sure that it stays that way, so we are asking HashiCorp to commit to keeping Terraform under an open source license forever in the future.</li><li id="59ba"><strong>If they refuse, we will fork Terraform into an open source foundation.</strong> If HashiCorp decides to keep Terraform under the BSL license, then we will fork the MPL-licensed Terraform (Terraform version 1.5.5 and all versions before that are still MPL licensed), and put it into an open source foundation maintained by the community. We are one of many companies who have pledged resources to maintaining this fork, if it comes to it.</li></ol><p id="64a6"><strong>Either way, the future of Terraform is open source</strong>. If you also believe that Terraform should remain open source, please lend us your support, and let HashiCorp know how you feel by signing the OpenTF manifesto at <a href="https://opentf.org/" rel="noopener ugc nofollow" target="_blank">https://opentf.org/</a>!</p><h2 id="0e44">What this means for Gruntwork customers</h2><p id="7d02"><strong>As long as you use Terraform 1.5.5 or older, you can keep using all our commercial and open source products with no changes</strong>. Terraform 1.5.5 and all older versions are still MPL licensed, so you can keep using that version of Terraform with Terragrunt, Terratest, the IaC Library, the Reference Architecture, Gruntwork Pipelines, etc., with no changes of any kind.</p><p id="f16d"><strong>For future versions of Terraform, Gruntwork will use open source Terraform</strong>. For versions of Terraform that come out after 1.5.5, we will switch all our commercial and open source products to work only with open source Terraform: that is, if HashiCorp chooses to switch Terraform back to an open source license, we will use that, and if they don’t, then we will use our open source fork. We are currently waiting to see how HashiCorp responds to OpenTF, and we will share more details once we have them.</p><p id="9dba"><strong>But rest assured: no matter what happens, we are committed to keeping Terraform open source and ensuring all our products will continue to work with it.</strong></p><p id="6f20">For more information, and to join the OpenTF movement, please see <a href="https://opentf.org/" rel="noopener ugc nofollow" target="_blank">https://opentf.org/</a>!</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[We reduced the cost of building Mastodon at Twitter-scale by 100x (882 pts)]]></title>
            <link>https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/</link>
            <guid>37137110</guid>
            <pubDate>Tue, 15 Aug 2023 17:54:13 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/">https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/</a>, See on <a href="https://news.ycombinator.com/item?id=37137110">Hacker News</a></p>
<div id="readability-page-1" class="page"><article id="post-1075">
	<!-- .entry-header -->

	<div>
		




<div><p>I’m going to cover a lot of ground in this post, so here’s the TLDR:</p>
<ul>
<li>We built a Twitter-scale <a href="https://joinmastodon.org/">Mastodon</a> instance from scratch in only 10k lines of code. This is <strong>100x less code</strong> than the ~1M lines Twitter wrote to build and scale their original consumer product, which is very similar to Mastodon. Our instance is located at <a href="https://mastodon.redplanetlabs.com/" rel="nofollow">https://mastodon.redplanetlabs.com</a> and open for anyone to use. The instance has 100M bots posting 3,500 times per second at 403 average fanout to demonstrate its scale.</li>
<li>Our implementation is built on top of a new platform called Rama that we at <a href="https://redplanetlabs.com/">Red Planet Labs</a> have developed over the past 10 years. This is the first time we’re talking about Rama publicly. Rama unifies computation and storage into a coherent model capable of building end-to-end backends at any scale in 100x less code than otherwise. Rama integrates and generalizes data ingestion, processing, indexing, and querying. Rama is a generic platform for building application backends, not just for social networks, and is programmed with a pure Java API. I will be exploring Rama in this post through the example of our Mastodon implementation.</li>
<li>We spent nine person-months building our scalable Mastodon instance. Twitter spent ~200 person-years to build and scale their original consumer product, and <a href="https://www.washingtonpost.com/technology/2023/07/29/meta-threads-mark-zuckerberg-rival-twitter-musk/">Instagram spent ~25 person-years building Threads</a>, a recently launched Twitter competitor. In their effort Instagram was able to leverage infrastructure already powering similar products.</li>
<li>Our scalable Mastodon implementation is also significantly less code than Mastodon’s <a href="https://github.com/mastodon/mastodon">official implementation</a>, which cannot scale anywhere near Twitter-scale.</li>
<li>In one week we will release a version of Rama that anyone can download and use. This version simulates Rama clusters within a single process and can be used to explore the full Rama API and build complete prototypes. We will also release the Rama documentation at that time.</li>
<li>In two weeks we will fully open-source our Mastodon implementation.</li>
<li>Red Planet Labs will be starting a private beta soon to give companies access to the full version of Rama. We will release more details on the private beta later, but companies can <a href="https://docs.google.com/forms/d/e/1FAIpQLSfrhmBwI0YAeaL8u4XmgfscW4UIUUDp2ZHSs4KmPH_TaDt1QQ/viewform">apply here</a> in the meantime.</li>
</ul>
<p>We recognize the way we’re introducing Rama is unusual. We felt that since the 100x cost reduction claim sounds so unbelievable, it wouldn’t do Rama justice to introduce it in the abstract. So we took it upon ourselves to directly demonstrate Rama’s 100x cost reduction by replicating a full application at scale in all its detail.</p>
</div>



<h2>Table of contents</h2>
<div><ul>
<li><a href="#Our_Mastodon_instance">Our Mastodon instance</a></li>
<li><a href="#Performance_and_scalability">Performance and scalability</a></li>
<li><a href="#Rama">Rama</a></li>
<li><a href="#Mastodon_on_Rama">Mastodon on Rama</a>
<ul>
<li><a href="#Following_hashtags">Following hashtags</a></li>
<li><a href="#Social_graph">Social graph</a></li>
<li><a href="#Computing_and_rendering_home_timelines">Computing and rendering home timelines</a></li>
<li><a href="#Personalized_follow_suggestions">Personalized follow suggestions</a></li>
</ul>
</li>
<li><a href="#DevOps_with_Rama">DevOps with Rama</a></li>
<li><a href="#Simple_Rama_code_example">Simple Rama code example</a></li>
<li><a href="#Sample_code_from_our_Mastodon_implementation">Sample code from our Mastodon implementation</a>
<ul>
<li><a href="#Representing_data">Representing data</a></li>
<li><a href="#Following_hashtags_code">Following hashtags code</a></li>
<li><a href="#Social_graph_code">Social graph code</a></li>
<li><a href="#Timeline_fanout_code">Timeline fanout code</a></li>
</ul>
</li>
<li><a href="#Conclusion">Conclusion</a></li>
</ul>
</div>



<h2 id="Our_Mastodon_instance">Our Mastodon instance</h2>



<div><p>First off, we make no comment about whether Mastodon should be scalable. There are good reasons to limit the size of an individual Mastodon instance. It is our belief, however, that such decisions should be product decisions and not forced by technical limitations. What we are demonstrating with our scalable Mastodon instance is that building a complex application at scale doesn’t have to be a costly endeavor and can instead be easily built and managed by individuals or small teams. There’s no reason the tooling you use to most quickly build your prototype should be different from what you use to build your application at scale.</p>
<p>Our Mastodon instance is hosted at <a href="https://mastodon.redplanetlabs.com/">https://mastodon.redplanetlabs.com</a>. We’ve implemented every feature of Mastodon from scratch, including:</p>
<ul>
<li>Home timelines, account timelines, local timeline, federated timeline</li>
<li>Follow / unfollow</li>
<li>Post / delete statuses</li>
<li>Lists</li>
<li>Boosts / favorites / bookmarks</li>
<li>Personalized follow suggestions</li>
<li>Hashtag timelines</li>
<li>Featured hashtags</li>
<li>Notifications</li>
<li>Blocking / muting</li>
<li>Conversations / direct messages</li>
<li>Filters</li>
<li>View followers / following in order (paginated)</li>
<li>Polls</li>
<li>Trending hashtags and links</li>
<li>Search (status / people / hashtags)</li>
<li>Profiles</li>
<li>Image/video attachments</li>
<li>Scheduled statuses</li>
<li>ActivityPub API to integrate with other Mastodon instances</li>
</ul>
<p>There’s huge variety between these features, and they require very different kinds of implementations for how computations are done and how indexes are structured. Of course, every single aspect of our Mastodon implementation is scalable.</p>
<p>To demonstrate the scale of our instance, we’re also running 100M bot accounts which continuously post statuses (Mastodon’s analogue of a “tweet”), replies, boosts (“retweet”), and favorites. 3,500 statuses are posted per second, the average number of followers for each post is 403, and the largest account has over 22M followers. As a comparison, Twitter serves 7,000 tweets per second at 700 average fanout (according to the numbers I could find). With the click of a button we can scale our instance up to handle that load or much larger –&nbsp;it would just cost us more money in server costs. We used the OpenAI API to generate 50,000 statuses for the bots to choose from at random.</p>
<p>Since our instance is just meant to demonstrate Rama and costs money to run, we’re not planning to keep it running for that long. So we don’t recommend using this instance for a primary Mastodon account.</p>
<p>One feature of Mastodon that needed tweaking because of our high rate of new statuses was global timelines, as it doesn’t make sense to flood the UI with thousands of new statuses per second. So for that feature we instead <a href="https://mastodon.redplanetlabs.com/timeline/local">show a small sample</a> of all the statuses on the platform.</p>
<p>The implementation of our instance looks like this:</p>
</div>



<figure><img data-lazy-fallback="1" decoding="async" width="634" height="285" data-attachment-id="1080" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/overall-structure/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/overall-structure.png?fit=634%2C285&amp;ssl=1" data-orig-size="634,285" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="overall-structure" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/overall-structure.png?fit=300%2C135&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/overall-structure.png?fit=634%2C285&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/overall-structure.png?resize=634%2C285&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/overall-structure.png?w=634&amp;ssl=1 634w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/overall-structure.png?resize=300%2C135&amp;ssl=1 300w" sizes="(max-width: 634px) 100vw, 634px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/overall-structure.png?w=634&amp;ssl=1 634w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/overall-structure.png?resize=300%2C135&amp;ssl=1 300w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/overall-structure.png?resize=634%2C285&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<div><p>The Mastodon backend is implemented as Rama modules (explained later on this page), which handles all the data processing, data indexing, and most of the product logic. On top of that is our implementation of the <a href="https://docs.joinmastodon.org/api/">Mastodon API</a> using Spring/Reactor. For the most part, the API implementation just handles HTTP requests with simple calls to the Rama modules and serves responses as JSON. We use <a href="https://soapbox.pub/">Soapbox</a> to serve the frontend since it’s built entirely on top of the Mastodon API.</p>
<p><a href="https://aws.amazon.com/s3/">S3</a> is used only for serving pictures and videos. Though we could serve those from Rama, static content like that is better served via a <a href="https://en.wikipedia.org/wiki/Content_delivery_network">CDN</a>. So we chose to use S3 to mimic that sort of architecture. All other storage is handled by the Rama modules.</p>
<p>Our implementation totals 10k lines of code, about half of which is the Rama modules and half of which is the API server. We will be fully open-sourcing the implementation in two weeks.</p>
<p>Our implementation is a big reduction in code compared to the <a href="https://github.com/mastodon/mastodon">official Mastodon implementation</a>, which is built with Ruby on Rails. That codebase doesn’t always have a clear distinction between frontend and backend code, but just adding up the code for clearcut backend portions (models, workers, services, API controllers, ActivityPub) totals 18k lines of Ruby code. That doesn’t include any of the database schema definition code, configurations needed to run Postgres and Redis, or other controller code, so the true line count for the official Mastodon backend is higher than that. And unlike our Rama implementation, it can’t achieve anywhere near Twitter-scale.</p>
<p>This isn’t a criticism of the Mastodon codebase –&nbsp;building products with existing technologies is just plain expensive. The reason we’ve worked on Rama for so many years is to enable developers to build applications much faster, with much greater quality, and to never have to worry about scaling ever again.</p>
</div>



<h2 id="Performance_and_scalability">Performance and scalability</h2>



<p>Here’s a chart showing the scalability of the most intensive part of Mastodon, processing statuses:</p>



<figure><img data-lazy-fallback="1" decoding="async" width="656" height="407" data-attachment-id="1306" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/mastodon-perf-1-2/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-1-2.png?fit=1934%2C1202&amp;ssl=1" data-orig-size="1934,1202" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="mastodon-perf-1-2" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-1-2.png?fit=300%2C186&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-1-2.png?fit=656%2C407&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-1-2.png?resize=656%2C407&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-1-2.png?resize=1024%2C636&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-1-2.png?resize=300%2C186&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-1-2.png?resize=768%2C477&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-1-2.png?resize=1536%2C955&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-1-2.png?resize=1200%2C746&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-1-2.png?w=1934&amp;ssl=1 1934w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-1-2.png?w=1312&amp;ssl=1 1312w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-1-2.png?resize=1024%2C636&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-1-2.png?resize=300%2C186&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-1-2.png?resize=768%2C477&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-1-2.png?resize=1536%2C955&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-1-2.png?resize=1200%2C746&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-1-2.png?w=1934&amp;ssl=1 1934w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-1-2.png?w=1312&amp;ssl=1 1312w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-1-2.png?resize=656%2C407&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<div><p>As you can see, increasing the number of nodes increases the statuses/second that can be processed. Most importantly, the relationship is linear. Processing statuses is so intensive because of fanout&nbsp;–&nbsp;if you have 15M followers, each of your statuses has to be written to 15M timelines. Each status on our instance is written to an average of 403 timelines (plus additional work to handle replies, lists, and conversations).</p>
<p>Twitter operates at 7,000 tweets per second at 700 average fanout, which is equivalent to about 12,200 tweets / second at 403 average fanout. So you can see we tested our Mastodon instance well above Twitter-scale.</p>
<p>Here’s a chart showing the latency distribution for the time from a status being posted to it being available on follower timelines:</p>
</div>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="411" data-attachment-id="1084" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/mastodon-perf-2/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-2.png?fit=1672%2C1046&amp;ssl=1" data-orig-size="1672,1046" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="mastodon-perf-2" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-2.png?fit=300%2C188&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-2.png?fit=656%2C411&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-2.png?resize=656%2C411&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-2.png?resize=1024%2C641&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-2.png?resize=300%2C188&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-2.png?resize=768%2C480&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-2.png?resize=1536%2C961&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-2.png?resize=1200%2C751&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-2.png?w=1672&amp;ssl=1 1672w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-2.png?w=1312&amp;ssl=1 1312w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-2.png?resize=1024%2C641&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-2.png?resize=300%2C188&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-2.png?resize=768%2C480&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-2.png?resize=1536%2C961&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-2.png?resize=1200%2C751&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-2.png?w=1672&amp;ssl=1 1672w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-2.png?w=1312&amp;ssl=1 1312w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-2.png?resize=656%2C411&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<div><p>These numbers are a bit better than <a href="https://youtu.be/WEgCjwyXvwc?t=255">Twitter’s numbers</a>. Because of how unbalanced the social graph is, getting performance this good and this reliable is <a href="https://twitter.com/elonmusk/status/1624660886572126209">not easy</a>. For example, when someone with 20M followers posts a status, that creates a huge burst of load which could delay other statuses from fanning out. How we handled this is described more below.</p>
<p>Lastly, here’s a chart showing the latency distribution for fetching the data to render a user’s home timeline:</p>
</div>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="410" data-attachment-id="1085" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/mastodon-perf-3/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-3.png?fit=1674%2C1046&amp;ssl=1" data-orig-size="1674,1046" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="mastodon-perf-3" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-3.png?fit=300%2C187&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-3.png?fit=656%2C410&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-3.png?resize=656%2C410&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-3.png?resize=1024%2C640&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-3.png?resize=300%2C187&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-3.png?resize=768%2C480&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-3.png?resize=1536%2C960&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-3.png?resize=1200%2C750&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-3.png?w=1674&amp;ssl=1 1674w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-3.png?w=1312&amp;ssl=1 1312w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-3.png?resize=1024%2C640&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-3.png?resize=300%2C187&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-3.png?resize=768%2C480&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-3.png?resize=1536%2C960&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-3.png?resize=1200%2C750&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-3.png?w=1674&amp;ssl=1 1674w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-3.png?w=1312&amp;ssl=1 1312w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/mastodon-perf-3.png?resize=656%2C410&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>Rendering a home timeline requires a lot of data from the backend: a page of statuses to render that aren’t muted/filtered, stats on each status (number of replies, boosts, and favorites), as well as information on the accounts that posted each status (username, display name, profile pic). Getting all this done in an average of 87ms is extremely efficient and a result of Rama being such an integrated system.</p>



<h2 id="Rama">Rama</h2>



<div><p>The numbers I’ve shared here should be hard to believe: a Twitter-scale Mastodon implementation with extremely strong performance numbers in only 10k lines of code, which is less code than Mastodon’s current backend implementation and 100x less code than Twitter’s scalable implementation of a very similar product? How is it possible that we’ve reduced the cost of building scalable applications by multiple orders of magnitude?</p>
<p>You can begin to understand this by starting with a simple observation: you can describe Mastodon (or Twitter, Reddit, Slack, Gmail, Uber, etc.) in total detail in a matter of hours. It has profiles, follows, timelines, statuses, replies, boosts, hashtags, search, follow suggestions, and so on. It doesn’t take that long to describe all the actions you can take on Mastodon and what those actions do. So the real question you should be asking is: given that software is entirely abstraction and automation, why does it take so long to build something you can describe in hours?</p>
<p>At its core Rama is a coherent set of abstractions for expressing backends end-to-end. All the intricacies of an application backend can be expressed in code that’s much closer to how you describe the application at a high level. Rama’s abstractions allow you to sidestep the mountains of complexity that blow up the cost of existing applications so much. So not only is Rama inherently scalable and fault-tolerant, it’s also far less work to build a backend with Rama than any other technology.</p>
<p>Let’s now dive into Rama. We’ll start with a high-level overview of Rama’s concepts. Then we’ll look at how some of the most important parts of our Mastodon instance are implemented in terms of these concepts. Finally, we’ll look at some code from our Mastodon implementation.</p>
<p>Rama is programmed entirely with a Java API, and Rama’s programming model has four main concepts:</p>
</div>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="354" data-attachment-id="1087" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/rama-concepts/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/rama-concepts.png?fit=1622%2C874&amp;ssl=1" data-orig-size="1622,874" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="rama-concepts" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/rama-concepts.png?fit=300%2C162&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/rama-concepts.png?fit=656%2C354&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/rama-concepts.png?resize=656%2C354&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/rama-concepts.png?resize=1024%2C552&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/rama-concepts.png?resize=300%2C162&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/rama-concepts.png?resize=768%2C414&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/rama-concepts.png?resize=1536%2C828&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/rama-concepts.png?resize=1200%2C647&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/rama-concepts.png?w=1622&amp;ssl=1 1622w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/rama-concepts.png?w=1312&amp;ssl=1 1312w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/rama-concepts.png?resize=1024%2C552&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/rama-concepts.png?resize=300%2C162&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/rama-concepts.png?resize=768%2C414&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/rama-concepts.png?resize=1536%2C828&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/rama-concepts.png?resize=1200%2C647&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/rama-concepts.png?w=1622&amp;ssl=1 1622w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/rama-concepts.png?w=1312&amp;ssl=1 1312w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/rama-concepts.png?resize=656%2C354&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<div><p>On the left are “depots”, which are distributed, durable, and replicated logs of data. All data coming into Rama comes in through depot appends. Depots are like <a href="https://kafka.apache.org/">Apache Kafka</a> except integrated with the rest of Rama.</p>
<p>Next are "ETL"s, extract-transform-load topologies. These process incoming data from depots as it arrives and produce indexed stores called “partitioned states”. Rama offers two types of ETL, streaming and microbatching, which have different performance characteristics. Most of the time spent programming Rama is spent making ETLs. Rama exposes a Java dataflow API for coding topologies that is extremely expressive.</p>
<p>Next are “partitioned states”, which we usually call “PStates”. PStates are how data is indexed in Rama, and just like depots they’re partitioned across many nodes, durable, and replicated. PStates are one of the keys to how Rama is such a general-purpose system. Unlike existing databases, which have rigid indexing models (e.g. “key-value”, “relational”, “column-oriented”, “document”, “graph”, etc.), PStates have a flexible indexing model. In fact, they have an indexing model already familiar to every programmer: <strong>data structures</strong>. A PState is an arbitrary combination of data structures, and every PState you create can have a different combination. With the “subindexing” feature of PStates, nested data structures can efficiently contain hundreds of millions of elements. For example, a “map of maps” is equivalent to a “document database”, and a “map of subindexed sorted maps” is equivalent to a “column-oriented database”. Any combination of data structures and any amount of nesting is valid –&nbsp;e.g. you can have a “map of lists of subindexed maps of lists of subindexed sets”. I cannot emphasize enough how much interacting with indexes as regular data structures instead of magical “data models” liberates backend programming.</p>
<p>The last concept in Rama is “query”. Queries in Rama take advantage of the data structure orientation of PStates with a “path-based” API that allows you to concisely fetch and aggregate data from a single partition. In addition to this, Rama has a feature called “query topologies” which can efficiently do real-time distributed querying and aggregation over an arbitrary collection of PStates. These are the analogue of “predefined queries” in traditional databases, except programmed via the same Java API as used to program ETLs and far more capable.</p>
<p>Individually, none of these concepts are new. I’m sure you’ve seen them all before. You may be tempted to dismiss Rama’s programming model as just a combination of <a href="https://martinfowler.com/eaaDev/EventSourcing.html">event sourcing</a> and <a href="https://en.wikipedia.org/wiki/Materialized_view">materialized views</a>. But what Rama does is integrate and generalize these concepts to such an extent that you can build entire backends end-to-end without any of the impedance mismatches or complexity that characterize and overwhelm existing systems.</p>
<p>All these concepts are implemented by Rama in a linearly scalable way. So if your application needs more resources, you can add them at the click of a button. Rama also achieves fault-tolerance by replicating all data and implementing automatic failover.</p>
<p>Here’s an example of how these concepts fit together. These are all the depots, ETLs, PStates, and query topologies for the portion of our Mastodon implementation handling profiles, statuses, and timelines:</p>
</div>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="577" data-attachment-id="1088" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/timelines-diagram/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram.png?fit=1457%2C1282&amp;ssl=1" data-orig-size="1457,1282" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="timelines-diagram" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram.png?fit=300%2C264&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram.png?fit=656%2C577&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram.png?resize=656%2C577&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram.png?resize=1024%2C901&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram.png?resize=300%2C264&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram.png?resize=768%2C676&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram.png?resize=1200%2C1056&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram.png?w=1457&amp;ssl=1 1457w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram.png?w=1312&amp;ssl=1 1312w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram.png?resize=1024%2C901&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram.png?resize=300%2C264&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram.png?resize=768%2C676&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram.png?resize=1200%2C1056&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram.png?w=1457&amp;ssl=1 1457w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram.png?w=1312&amp;ssl=1 1312w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram.png?resize=656%2C577&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<div><p>This looks intimidating, but this part of the codebase only totals 1,100 lines of code. And it implements a ton of functionality, all scalably: statuses, timelines, boosts, conversations, favorites, bookmarks, mutes, account registration, profile edits, federation, and more. Notice that the PStates are a diverse collection of data structure combinations, and there are 33 of them here. Many of the ETLs produce multiple PStates and consume multiple depots. Making depots, ETLs, and PStates is inexpensive in Rama and can be done liberally.</p>
<p>What you’re seeing in this diagram is a total inversion of control compared to how applications are typically architected today. For example, consider the “fanout” ETL in this diagram which processes incoming statuses and sends them to follower timelines (you’ll see the code for this <a href="#Timeline_fanout_code">later in this post</a>). There are a bunch of rules dictating which statuses go to which followers –&nbsp;boosts never go back to the original author, replies only go to followers who also follow the account being replied to, and so on. Traditionally, that’s accomplished with a “database layer” handling storage and a separate “application layer” implementing the product logic. The “application layer” does reads and writes to the “database layer”, and the two layers are deployed, scaled, and managed separately. But with Rama, the product logic exists inside the system doing the indexing. Computation and storage are colocated. Rama does everything a database does, but it also does so much more.</p>
<p>When building a backend with Rama, you begin with all the use cases you need to support. For example: fetch the number of followers of a user, fetch a page of a timeline, fetch ten follow suggestions, and so on. Then you determine what PState layouts (data structures) you need to support those queries. One PState could support ten of your queries, and another PState may support just one query.</p>
<p>Next you determine what your source data is, and then you make depots to receive that data. Source data usually corresponds to events happening in your application, like “Alice follows Bob”, “James posted the status ‘Hello world’”, or “Bob unfollows Charlie”. You can represent your data however you want, whether Java objects, frameworks like <a href="https://thrift.apache.org/">Thrift</a> or <a href="https://protobuf.dev/">Protocol Buffers</a>, or even unstructured formats like JSON (however, we recommend using structured formats as much as possible).</p>
<p>The last step is writing the ETL topologies that convert source data from your depots into your PStates. When deployed, the ETLs run continuously keeping your PStates up to date. Rama’s ETL API, though just Java, is like a “distributed programming language” with the computational capabilities of any Turing-complete language along with facilities to easily control on which partition computation happens at any given point. You’ll see many examples of this API later in this post.</p>
</div>



<h2 id="Clusters_and_modules">Clusters and modules</h2>



<div><p>Rama is deployed onto a cluster of nodes. There’s a central daemon called the “Conductor” which coordinates deploys, updates, and scaling operations. Every node has a “Supervisor” daemon which manages the launch/teardown of user code.</p>
<p>Applications are deployed onto a Rama cluster as “modules”. A “module” contains an arbitrary combination of depots, ETLs, PStates, and query topologies. Unlike traditional architectures, where the corresponding analogues exist in separate processes and usually on separate nodes, in Rama these are colocated in the same set of processes. This colocation enables fantastic efficiency which has never been possible before. Modules can also consume data from depots and PStates in other modules just as easily as they can from their own. A module runs forever, continuously processing new data from depots, unless you choose to destroy it.</p>
<p>A module is deployed by giving the Conductor a .jar file with user code. Additionally, configuration is provided for the number of nodes to allocate to the module, replication parameters, as well as any other tuning parameters. A module is updated a similar way: a new .jar is provided with the new code, and the Conductor orchestrates an update sequence that launches new processes and transfers depots and PStates to the new module version.</p>
<p>Here’s what a Rama cluster could look like with two modules deployed, “SocialGraphModule” and “TimelineModule”:</p>
</div>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="338" data-attachment-id="1091" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/cluster-overview/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-overview.png?fit=1548%2C796&amp;ssl=1" data-orig-size="1548,796" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="cluster-overview" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-overview.png?fit=300%2C154&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-overview.png?fit=656%2C338&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-overview.png?resize=656%2C338&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-overview.png?resize=1024%2C527&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-overview.png?resize=300%2C154&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-overview.png?resize=768%2C395&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-overview.png?resize=1536%2C790&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-overview.png?resize=1200%2C617&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-overview.png?w=1548&amp;ssl=1 1548w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-overview.png?w=1312&amp;ssl=1 1312w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-overview.png?resize=1024%2C527&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-overview.png?resize=300%2C154&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-overview.png?resize=768%2C395&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-overview.png?resize=1536%2C790&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-overview.png?resize=1200%2C617&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-overview.png?w=1548&amp;ssl=1 1548w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-overview.png?w=1312&amp;ssl=1 1312w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-overview.png?resize=656%2C338&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>For testing and development, Rama provides a class called

<code>InProcessCluster</code>

for simulating Rama clusters within a single process.</p>



<h2 id="Mastodon_on_Rama">Mastodon on Rama</h2>



<p>Let’s look at some of the key parts of how Mastodon is implemented on top of Rama. In this section we’ll focus on the design of Mastodon –&nbsp;what PStates are created, the flow of how data is processed, and how everything is organized. You’ll see how Rama’s capabilities enable some seriously novel ways to architect applications. In the next section we’ll look at some of the code from our implementation.</p>



<h3 id="Following_hashtags">Following hashtags</h3>



<div><p>Let’s start with an extremely simple part of the implementation, tracking followers for hashtags. The implementation for this totals 11 lines of code and supports the following queries:</p>
<ul>
<li>Does user A follow hashtag H?</li>
<li>Who follows hashtag H (paginated)?</li>
<li>How many followers does hashtag H have?</li>
</ul>
</div>



<p>Only a single PState is needed for this, called

<code>$$hashtagToFollowers</code>

(PState names in Rama always begin with

<code>$$</code>

). It is a map from a hashtag to a set of account IDs. Here’s a visualization of what this PState could look like across two partitions. Keep in mind that PStates are distributed across many partitions, with each partition of a PState being the specified data structure:</p>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="536" height="241" data-attachment-id="1120" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/hashtagtofollowers/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/hashtagToFollowers.png?fit=536%2C241&amp;ssl=1" data-orig-size="536,241" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="hashtagToFollowers" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/hashtagToFollowers.png?fit=300%2C135&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/hashtagToFollowers.png?fit=536%2C241&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/hashtagToFollowers.png?resize=536%2C241&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/hashtagToFollowers.png?w=536&amp;ssl=1 536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/hashtagToFollowers.png?resize=300%2C135&amp;ssl=1 300w" sizes="(max-width: 536px) 100vw, 536px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/hashtagToFollowers.png?w=536&amp;ssl=1 536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/hashtagToFollowers.png?resize=300%2C135&amp;ssl=1 300w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/hashtagToFollowers.png?resize=536%2C241&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>There are two events that change this PState: following a hashtag, and unfollowing a hashtag. In our implementation, these are represented by the types

<code>FollowHashtag</code>

and

<code>RemoveFollowHashtag</code>

.</p>



<p>A good way to visualize how data is processed to produce this PState is via a dataflow graph, as you can see how data moves from the start of processing (one or more depots) to the end results of processing (updates to PStates):</p>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="372" height="472" data-attachment-id="1121" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/follow-hashtags/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-hashtags.png?fit=372%2C472&amp;ssl=1" data-orig-size="372,472" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="follow-hashtags" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-hashtags.png?fit=236%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-hashtags.png?fit=372%2C472&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-hashtags.png?resize=372%2C472&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-hashtags.png?w=372&amp;ssl=1 372w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-hashtags.png?resize=236%2C300&amp;ssl=1 236w" sizes="(max-width: 372px) 100vw, 372px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-hashtags.png?w=372&amp;ssl=1 372w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-hashtags.png?resize=236%2C300&amp;ssl=1 236w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-hashtags.png?resize=372%2C472&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<div><p>The logic here is trivial, which is why the implementation is only 11 lines of code. You don’t need to worry about things like setting up a database, establishing database connections, handling serialization/deserialization on each database read/write, writing deploys just to handle this one task, or any of the other tasks that pile up when building backend systems. Because Rama is so integrated and so comprehensive, a trivial feature like this has a correspondingly trivial implementation.</p>
<p>You may be wondering why the follow and unfollow events go onto the same depot instead of separate depots. Though you could implement it that way, it would be a mistake to do so. Data is processed off a depot partition in the order in which it was received, but there are no ordering guarantees across different depots. So if a user was spamming the “Follow” and “Unfollow” buttons on the UI and those events were appended to different depots, it’s possible a later unfollow could be processed before a prior follow. This would result in the PState ending up in the incorrect state according to the order by which the user made actions. By putting both events in the same depot, the data is processed in the same order in which it was created.</p>
<p>As a general rule, Rama guarantees <strong>local ordering</strong>. Data sent between two points are processed in the order in which they were sent. This is true for processing data off a depot, and it’s also true for intra-ETL processing when your processing jumps around to different partitions as part of computation.</p>
<p>This dataflow diagram is literally how you program with Rama, by specifying dataflow graphs in a pure Java API. As you’ll see below, the details of specifying computations like this involve variables, functions, filters, loops, branching, and merging. It also includes fine-grained control over which partitions computation is executing at any given point.</p>
</div>







<div><p>Let’s now look at a slightly more involved part of the implementation, the social graph. The social graph totals 105 lines of code and supports the following queries which power various aspects of Mastodon:</p>
<ul>
<li>Does user A follow user B?</li>
<li>How many followers does user A have?</li>
<li>How many accounts does user A follow?</li>
<li>Who are user A’s followers in the order in which they followed (paginated)?</li>
<li>Who does user A follow in the order in which they followed them (paginated)?</li>
<li>Who is currently requesting to follow user A in the order in which they requested (paginated)?</li>
<li>Does user A block user B?</li>
<li>Does user A mute user B?</li>
<li>Does user A wish to see boosts from user B?</li>
</ul>
<p>Even though the implementation is so simple with Rama, it’s worth noting that Twitter had to write a <a href="https://github.com/twitter-archive/flockdb">custom database from scratch</a> to build their scalable social graph.</p>
</div>



<p>There are four main PStates produced by our social graph implementation, named

<code>$$followerToFollowees</code>

,

<code>$$followeeToFollowers</code>

,

<code>$$accountIdToFollowRequests</code>

, and

<code>$$accountIdToSuppressions</code>

. The first three PStates have the same structure, which is a map from account ID to a linked set of account IDs plus additional information needed about the relationship. For example, for

<code>$$followeeToFollowers</code>

we track whether a follower wants to see boosts from that account in their home timeline (which is one of Mastodon’s features). This PState is also used to compute: whether an account already follows another account, the order in which accounts were followed (which is why a linked set is used rather than a regular set), and the number of followers for an account (which is just the size of the inner set, something Rama computes in fast constant time even if the set has millions of elements).</p>



<p>The

<code>$$accountIdToSuppressions</code>

PState tracks blocks and mutes for each account and has a different structure. It is a map from account ID to a map containing two keys: “blocked” and “muted”. The “blocked” key maps to the set of account IDs the top-level account ID has blocked. The “muted” key is similar but stores a map from account ID to the options for that mute (like expiration time). This PState is used wherever statuses are rendered (e.g. home timeline, notifications) to filter out statuses a user doesn’t want to see.</p>



<p>Here’s a visualization of what the

<code>$$followeeToFollowers</code>

PState could look like in a deployed module:</p>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="261" data-attachment-id="1125" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/followeetofollowers/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/followeeToFollowers.png?fit=1208%2C480&amp;ssl=1" data-orig-size="1208,480" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="followeeToFollowers" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/followeeToFollowers.png?fit=300%2C119&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/followeeToFollowers.png?fit=656%2C261&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/followeeToFollowers.png?resize=656%2C261&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/followeeToFollowers.png?resize=1024%2C407&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/followeeToFollowers.png?resize=300%2C119&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/followeeToFollowers.png?resize=768%2C305&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/followeeToFollowers.png?resize=1200%2C477&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/followeeToFollowers.png?w=1208&amp;ssl=1 1208w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/followeeToFollowers.png?resize=1024%2C407&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/followeeToFollowers.png?resize=300%2C119&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/followeeToFollowers.png?resize=768%2C305&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/followeeToFollowers.png?resize=1200%2C477&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/followeeToFollowers.png?w=1208&amp;ssl=1 1208w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/followeeToFollowers.png?resize=656%2C261&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<div><p>Here you can see that account “1” is followed by accounts “2”, “7”, and “5”, with “2” and “7” having boosts enabled and “5” having boosts disabled. Account “4” is only followed by account “1”, and “1” has boosts enabled for that relationship.</p>
<p>The social graph is constructed based on follow, unfollow, block, unblock, mute, and unmute events. In Mastodon’s design, blocking a user also unfollows in both directions (if currently followed). So the block and unblock events go on the same depot as the follow-related events, while the mute and unmute events go on a separate depot.</p>
<p>Here’s the dataflow graph showing how these PStates are computed based on the source data:</p>
</div>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="704" data-attachment-id="1126" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/social-graph/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph.png?fit=1136%2C1219&amp;ssl=1" data-orig-size="1136,1219" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="social-graph" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph.png?fit=280%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph.png?fit=656%2C704&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph.png?resize=656%2C704&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph.png?resize=954%2C1024&amp;ssl=1 954w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph.png?resize=280%2C300&amp;ssl=1 280w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph.png?resize=768%2C824&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph.png?w=1136&amp;ssl=1 1136w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph.png?resize=954%2C1024&amp;ssl=1 954w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph.png?resize=280%2C300&amp;ssl=1 280w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph.png?resize=768%2C824&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph.png?w=1136&amp;ssl=1 1136w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph.png?resize=656%2C704&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>This is more involved than the hashtag follows dataflow graph since this ETL supports so many more features. Yet it’s still only 105 lines of code to implement. You can see how this ETL makes use of conditionals, branching, and merging in its implementation. Here’s a few notes on the logic within this ETL:</p>



<ul>
<li>When a user follows another user, the

<code>$$followerToFollowees</code>

and

<code>$$followeeToFollowers</code>

PStates are updated. Unfollowing updates the same PStates but removes the relationship instead of adding it.</li>
<li>Blocking is handled specially by implicitly emitting additional unfollow events as part of processing (to unfollow in both directions), as well as tracking who blocks who in the

<code>$$accountIdToSuppressions</code>

PState.</li>
<li>A locked account (where each follower must be individually approved) receives

<code>FollowLockedAccount</code>

events, and unlocked accounts receive

<code>Follow</code>

events.</li>
<li>Attributes of a relationship (e.g. “show boosts”, “notify”) are updated via appending another

<code>Follow</code>

or

<code>FollowLockedAccount</code>

event to the depot. This is why the

<code>FollowLockedAccount</code>

checks if the follow relationship already exists so it can determine whether to update the follow relationship or add a new follow request.</li>
<li>A

<code>Follow</code>

event also removes the corresponding follow request if it exists. This is why an

<code>AcceptFollowRequest</code>

event just converts to a

<code>Follow</code>

event.</li>
</ul>



<p>This ETL interacts with many PStates at the same time. Because of Rama’s integrated nature, these PStates are colocated with one another within the same processes that are executing the ETL logic. So whereas you always have to do a network operation to access most databases, PState operations are local, in-process operations with Rama ETLs. As you’ll see later, you utilize the network in an ETL via “partitioner” operations to get to the right partition of a module, but once you’re on a partition you can perform as many PState operations to as many colocated PStates as you need. This is not only extremely efficient but also liberating due to the total removal of impedance mismatches that characterizes interacting with databases.</p>



<h3 id="Computing_and_rendering_home_timelines">Computing and rendering home timelines</h3>



<p>Next let’s look at the core of Mastodon, computing and rendering home timelines. This powers the primary page of the Mastodon experience:</p>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="411" data-attachment-id="1157" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/home-timeline-screenshot-1/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/home-timeline-screenshot-1.png?fit=3382%2C2122&amp;ssl=1" data-orig-size="3382,2122" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="home-timeline-screenshot-1" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/home-timeline-screenshot-1.png?fit=300%2C188&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/home-timeline-screenshot-1.png?fit=656%2C411&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/home-timeline-screenshot-1.png?resize=656%2C411&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/home-timeline-screenshot-1.png?resize=1024%2C642&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/home-timeline-screenshot-1.png?resize=300%2C188&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/home-timeline-screenshot-1.png?resize=768%2C482&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/home-timeline-screenshot-1.png?resize=1536%2C964&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/home-timeline-screenshot-1.png?resize=2048%2C1285&amp;ssl=1 2048w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/home-timeline-screenshot-1.png?resize=1200%2C753&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/home-timeline-screenshot-1.png?w=1312&amp;ssl=1 1312w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/home-timeline-screenshot-1.png?w=1968&amp;ssl=1 1968w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/home-timeline-screenshot-1.png?resize=1024%2C642&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/home-timeline-screenshot-1.png?resize=300%2C188&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/home-timeline-screenshot-1.png?resize=768%2C482&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/home-timeline-screenshot-1.png?resize=1536%2C964&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/home-timeline-screenshot-1.png?resize=2048%2C1285&amp;ssl=1 2048w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/home-timeline-screenshot-1.png?resize=1200%2C753&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/home-timeline-screenshot-1.png?w=1312&amp;ssl=1 1312w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/home-timeline-screenshot-1.png?w=1968&amp;ssl=1 1968w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/home-timeline-screenshot-1.png?resize=656%2C411&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>This use case is a great example of how to think about building data-intensive systems not just with Rama, but in general. For any backend feature you want to implement, you have to balance what gets precomputed versus what gets computed on the fly at query-time. The more you can precompute, the less work you’ll have to do at query-time and the lower latencies your users will experience. This basic structure looks like this:</p>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="243" data-attachment-id="1133" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/backend-model/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/backend-model.png?fit=1642%2C608&amp;ssl=1" data-orig-size="1642,608" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="backend-model" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/backend-model.png?fit=300%2C111&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/backend-model.png?fit=656%2C243&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/backend-model.png?resize=656%2C243&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/backend-model.png?resize=1024%2C379&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/backend-model.png?resize=300%2C111&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/backend-model.png?resize=768%2C284&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/backend-model.png?resize=1536%2C569&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/backend-model.png?resize=1200%2C444&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/backend-model.png?w=1642&amp;ssl=1 1642w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/backend-model.png?w=1312&amp;ssl=1 1312w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/backend-model.png?resize=1024%2C379&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/backend-model.png?resize=300%2C111&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/backend-model.png?resize=768%2C284&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/backend-model.png?resize=1536%2C569&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/backend-model.png?resize=1200%2C444&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/backend-model.png?w=1642&amp;ssl=1 1642w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/backend-model.png?w=1312&amp;ssl=1 1312w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/backend-model.png?resize=656%2C243&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<div><p>This of course is the programming model of Rama you’ve already seen, and a big part of designing Rama applications is determining what computation goes in the ETL portion versus what goes in the query portion. Because both the ETL and query portions can be arbitrary distributed computations, and since PStates can be any structure you want, you have total flexibility when it comes to choosing what gets precomputed versus what gets computed on the fly.</p>
<p>It’s generally a good idea to work backwards from the needed queries to learn how to best structure things. In the case of querying for a page of a timeline, you need the following information:</p>
<ul>
<li>Content for each status</li>
<li>Stats for each status (number of replies, boosts, and favorites)</li>
<li>Information about the account that posted each status (username, display name, profile pic)</li>
<li>Whether the author of each status is blocked or muted</li>
<li>For boosts, the username of the booster</li>
<li>ID to use to fetch the next page of statuses</li>
</ul>
<p>Since statuses can be edited and profile information can be changed, almost all this information is dynamic and must be fetched for each render of a timeline page.</p>
<p>Let’s consider a typical way to go about this with non-Rama technologies, even scalable ones, which unfortunately is extremely inefficient:</p>
<ul>
<li>Fetch the list of status IDs for a page of the timeline</li>
<li>In parallel, send database requests to fetch:
<ul>
<li>Content for each status</li>
<li>Stats for each status</li>
<li>Information for each author</li>
</ul>
</li>
</ul>
<p>For a page of 20 statuses, this could easily require over 100 database calls with a lot of overhead in the sheer amount of back and forth communication needed to fetch data from each database partition.</p>
<p>We handled this use case with Rama by making use of Rama’s facilities for colocation of PStates. The module is organized such that <strong>all information</strong> for a status and the account who posted it are colocated in the same process. So instead of needing separate requests for status content, status stats, and author information, only one request is needed per status.</p>
</div>



<h4>Structuring the PStates</h4>



<p>Here are all the depots, PStates, and query topologies in the module implementing timelines and profiles (repeated from above):</p>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="577" data-attachment-id="1136" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/timelines-diagram-1/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram-1.png?fit=1457%2C1282&amp;ssl=1" data-orig-size="1457,1282" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="timelines-diagram-1" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram-1.png?fit=300%2C264&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram-1.png?fit=656%2C577&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram-1.png?resize=656%2C577&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram-1.png?resize=1024%2C901&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram-1.png?resize=300%2C264&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram-1.png?resize=768%2C676&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram-1.png?resize=1200%2C1056&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram-1.png?w=1457&amp;ssl=1 1457w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram-1.png?w=1312&amp;ssl=1 1312w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram-1.png?resize=1024%2C901&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram-1.png?resize=300%2C264&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram-1.png?resize=768%2C676&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram-1.png?resize=1200%2C1056&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram-1.png?w=1457&amp;ssl=1 1457w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram-1.png?w=1312&amp;ssl=1 1312w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timelines-diagram-1.png?resize=656%2C577&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>Let’s look at these PStates in closer detail, as the way they’re structured and partitioned is extremely interesting. Let’s start with

<code>$$accountIdToAccount</code>

. This is a map from account ID to profile information, including username, display name, and profile pic. Here’s a picture of what this PState could look like across four partitions:</p>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="401" data-attachment-id="1137" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/accountidtoaccount/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/accountIdToAccount.png?fit=786%2C481&amp;ssl=1" data-orig-size="786,481" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="accountIdToAccount" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/accountIdToAccount.png?fit=300%2C184&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/accountIdToAccount.png?fit=656%2C401&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/accountIdToAccount.png?resize=656%2C401&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/accountIdToAccount.png?w=786&amp;ssl=1 786w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/accountIdToAccount.png?resize=300%2C184&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/accountIdToAccount.png?resize=768%2C470&amp;ssl=1 768w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/accountIdToAccount.png?w=786&amp;ssl=1 786w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/accountIdToAccount.png?resize=300%2C184&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/accountIdToAccount.png?resize=768%2C470&amp;ssl=1 768w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/accountIdToAccount.png?resize=656%2C401&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>This PState is partitioned by the account ID. When I say “partitioned by”, I mean how the Mastodon implementation chooses on which partition to store data for any particular account. The most common way to partition a PState is to hash a partitioning key and modulo the hash by the number of partitions. This deterministically chooses a partition for any particular partitioning key, while evenly spreading out data across all partitions (this “hash/mod” technique is used by most distributed databases). For this PState, the partitioning key is the same as the key in the map, the account ID (as you’ll see soon, it doesn’t have to be).</p>



<p>Next is

<code>$$accountIdToStatuses</code>

. This is a map from account ID to a map from status ID to a list of status content versions. A list of status content versions is stored to capture the edit history of a status, which Mastodon lets you view in its UI. You can visualize this PState like so:</p>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="480" height="554" data-attachment-id="1141" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/accountidtostatuses/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/accountIdToStatuses.png?fit=480%2C554&amp;ssl=1" data-orig-size="480,554" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="accountIdToStatuses" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/accountIdToStatuses.png?fit=260%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/accountIdToStatuses.png?fit=480%2C554&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/accountIdToStatuses.png?resize=480%2C554&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/accountIdToStatuses.png?w=480&amp;ssl=1 480w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/accountIdToStatuses.png?resize=260%2C300&amp;ssl=1 260w" sizes="(max-width: 480px) 100vw, 480px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/accountIdToStatuses.png?w=480&amp;ssl=1 480w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/accountIdToStatuses.png?resize=260%2C300&amp;ssl=1 260w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/accountIdToStatuses.png?resize=480%2C554&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>Whenever a status is edited, a new version is prepended to its respective inner list. Since this PState and

<code>$$accountIdToAccount</code>

are in the same module, each partition is colocated on the same thread within the same process. You can visualize this colocation like so:</p>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="656" data-attachment-id="1143" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/colocated-account-pstates/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/colocated-account-pstates.png?fit=1077%2C1078&amp;ssl=1" data-orig-size="1077,1078" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="colocated-account-pstates" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/colocated-account-pstates.png?fit=300%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/colocated-account-pstates.png?fit=656%2C656&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/colocated-account-pstates.png?resize=656%2C656&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/colocated-account-pstates.png?resize=1024%2C1024&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/colocated-account-pstates.png?resize=300%2C300&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/colocated-account-pstates.png?resize=150%2C150&amp;ssl=1 150w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/colocated-account-pstates.png?resize=768%2C769&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/colocated-account-pstates.png?resize=800%2C800&amp;ssl=1 800w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/colocated-account-pstates.png?resize=400%2C400&amp;ssl=1 400w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/colocated-account-pstates.png?resize=200%2C200&amp;ssl=1 200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/colocated-account-pstates.png?w=1077&amp;ssl=1 1077w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/colocated-account-pstates.png?resize=1024%2C1024&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/colocated-account-pstates.png?resize=300%2C300&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/colocated-account-pstates.png?resize=150%2C150&amp;ssl=1 150w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/colocated-account-pstates.png?resize=768%2C769&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/colocated-account-pstates.png?resize=800%2C800&amp;ssl=1 800w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/colocated-account-pstates.png?resize=400%2C400&amp;ssl=1 400w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/colocated-account-pstates.png?resize=200%2C200&amp;ssl=1 200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/colocated-account-pstates.png?w=1077&amp;ssl=1 1077w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/colocated-account-pstates.png?resize=656%2C656&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>Because of this colocation queries can look at the partitions for both PStates at the same time within the same event instead of needing two roundtrips. You can also have multiple threads per worker process, or multiple worker processes per node.</p>



<p>Now let’s see how things get really interesting.

<code>$$statusIdToFavoriters</code>

is a map from a status ID to a linked set of account IDs. Here’s a visualization of this PState:</p>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="439" height="480" data-attachment-id="1145" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/statusidtofavoriters/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/statusIdToFavoriters.png?fit=439%2C480&amp;ssl=1" data-orig-size="439,480" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="statusIdToFavoriters" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/statusIdToFavoriters.png?fit=274%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/statusIdToFavoriters.png?fit=439%2C480&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/statusIdToFavoriters.png?resize=439%2C480&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/statusIdToFavoriters.png?w=439&amp;ssl=1 439w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/statusIdToFavoriters.png?resize=274%2C300&amp;ssl=1 274w" sizes="(max-width: 439px) 100vw, 439px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/statusIdToFavoriters.png?w=439&amp;ssl=1 439w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/statusIdToFavoriters.png?resize=274%2C300&amp;ssl=1 274w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/statusIdToFavoriters.png?resize=439%2C480&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>Similar to the social graph PStates, this PState is used to compute: the order in which accounts favorited a status (paginated), whether a particular account already favorited a status, and the number of favorites for a status.</p>



<p>What’s interesting is how this PState is partitioned. It is <strong>not</strong> partitioned by the status ID, which is the key of the map. It is instead partitioned by the account ID of the user who posted that status, which is not even in the map! This same partitioning scheme is used for all other PStates tracking status information, like

<code>$$statusIdToReplies</code>

,

<code>$$statusIdToBoosters</code>

, and

<code>$$statusIdToMuters</code>

. This means all information for a user and all information for that user’s statuses exist on the same partition, and performing a query to fetch all the information needed to render a status only needs to perform a single roundtrip.</p>



<p>Here’s a visualization of how all the PStates described could exist in a module deployment:</p>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="528" height="1024" data-attachment-id="1148" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/all-colocated-pstates/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/all-colocated-pstates.png?fit=1074%2C2084&amp;ssl=1" data-orig-size="1074,2084" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="all-colocated-pstates" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/all-colocated-pstates.png?fit=155%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/all-colocated-pstates.png?fit=528%2C1024&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/all-colocated-pstates.png?resize=528%2C1024&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/all-colocated-pstates.png?resize=528%2C1024&amp;ssl=1 528w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/all-colocated-pstates.png?resize=155%2C300&amp;ssl=1 155w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/all-colocated-pstates.png?resize=768%2C1490&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/all-colocated-pstates.png?resize=792%2C1536&amp;ssl=1 792w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/all-colocated-pstates.png?resize=1055%2C2048&amp;ssl=1 1055w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/all-colocated-pstates.png?w=1074&amp;ssl=1 1074w" sizes="(max-width: 528px) 100vw, 528px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/all-colocated-pstates.png?resize=528%2C1024&amp;ssl=1 528w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/all-colocated-pstates.png?resize=155%2C300&amp;ssl=1 155w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/all-colocated-pstates.png?resize=768%2C1490&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/all-colocated-pstates.png?resize=792%2C1536&amp;ssl=1 792w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/all-colocated-pstates.png?resize=1055%2C2048&amp;ssl=1 1055w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/all-colocated-pstates.png?w=1074&amp;ssl=1 1074w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/all-colocated-pstates.png?resize=528%2C1024&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>Notice, for example, how status ID “3” for account ID “10” exists both as a subvalue within

<code>$$accountIdToStatuses</code>

and also as a top-level key for the status-specific states on the same partition.</p>



<p>This use case is a great example of the power of Rama’s integrated approach, achieving incredible efficiency and incredible simplicity. Each of these PStates exists in exactly the perfect shape and partitioning for the use cases it serves.</p>



<h4 id="Home_timelines">Home timelines</h4>



<div><p>Next, let’s explore how home timelines are stored. Materializing home timelines is by far the most intensive part of the application, since statuses are fanned out to all followers. Since the average fanout on our instance is 403, there are over 400x more writes to home timelines than any of the other PStates involved in processing statuses.</p>
<p>PStates are durable, replicated, high-performance structures. They are easy to reason about and ideal for most use cases. In our initial implementation of Mastodon, we stored home timelines in a PState and it worked fine.</p>
<p>However, writing to the home timelines PState was clearly the overwhelming bottleneck in the application because of the sheer amount of data that had to be written to disk and replicated. We also realized that home timelines are unique in that they are somewhat redundant with other PStates. You can reconstruct a home timeline by looking at the statuses of everyone you follow. This can involve a few hundred PState queries across the cluster, so it isn’t cheap, but it’s also not terribly expensive.</p>
<p>As it turns out, what we ended up doing to optimize home timelines is very similar to how Twitter did it for their chronological timelines, and for the exact same reasons. In our revised implementation, we store home timelines in-memory and unreplicated. So instead of needing to persist each timeline write to disk and replicate it to followers, a timeline write is an extremely cheap write to an in-memory buffer. This optimization increased the number of statuses we could process per second by 15x.</p>
<p>Solely storing the timeline in-memory is not sufficient though, as it provides no fault-tolerance in the event of a power loss or other node failure. So a new leader for the partition would not have the timeline info since it’s unreplicated and not persisted to disk. To solve this, we reconstruct the timeline on read if it’s missing or incomplete by querying the recent statuses of all follows. This provides the same fault-tolerance as replication, but in a different way.</p>
<p>Implementing fault-tolerance this way is a tradeoff. For the benefit of massively reduced cost on timeline write, sometimes reads will be much more expensive due to the cost of reconstructing lost timelines. This tradeoff is overwhelmingly worth it because timeline writes are way, way more frequent than timeline reads and lost partitions are rare.</p>
<p>Whereas Twitter stores home timelines in a dedicated in-memory database, in Rama they’re stored in-memory in the same processes executing the ETL for timeline fanout. So instead of having to do network operations, serialization, and deserialization, the reads and writes to home timelines in our implementation are literally just in-memory operations on a hash map. This is dramatically simpler and more efficient than operating a separate in-memory database. The timelines themselves are stored like this:</p>
</div>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br></p></td><td><p><span>public</span> <span>static</span> <span>class</span> Timeline <span>{</span><br>
&nbsp; <span>public</span> <span>long</span><span>[</span><span>]</span> buffer<span>;</span><br>
&nbsp; <span>public</span> <span>int</span> startIndex <span>=</span> <span>0</span><span>;</span> <span>// index within buffer that contains oldest timeline element</span><br>
&nbsp; <span>public</span> <span>int</span> numElems <span>=</span> <span>0</span><span>;</span> <span>// number of elements in this timeline</span><br>
<span>}</span></p></td></tr></tbody></table></div>




<div><p>To minimize memory usage and GC pressure, we use a ring buffer and Java primitives to represent each home timeline. The buffer contains pairs of author ID and status ID. The author ID is stored along with the status ID since it is static information that will never change, and materializing it means that information doesn’t need to be looked up at query time. The home timeline stores the most recent 600 statuses, so the buffer size is 1,200 to accommodate each author ID and status ID pair. The size is fixed since storing full timelines would require a prohibitive amount of memory (the number of statuses times the average number of followers).</p>
<p>Each user utilizes about 10kb of memory to represent their home timeline. For a Twitter-scale deployment of 500M users, that requires about 4.7TB of memory total around the cluster, which is easily achievable.</p>
<p>The in-memory home timelines and other PStates are put together to render a page of a timeline with the following logic:</p>
</div>



<ul>
<li>First, query the in-memory home timeline to fetch a page of

<code>[author ID, statusID]</code>

pairs.</li>
<li>Next, invoke a query topology (a predefined distributed query) that takes in a list of

<code>[author ID, statusID]</code>

pairs and returns all information needed to render each status –&nbsp;status content, status stats, and author information. The query topology goes to all partitions containing requested status IDs in parallel and fetches all needed information with colocated PState queries.</li>
</ul>



<h4 id="timeline-fanout">Implementing fanout</h4>



<div><p>So that’s the story on how timelines are rendered, but how are home timelines and these various PStates computed? If you look back at <a href="#Performance_and_scalability">the performance numbers</a>, you can see our Mastodon implementation has high throughput that scales linearly while also having great, consistent latencies for delivering statuses to follower timelines.</p>
<p>Let’s focus on how statuses are handled, particularly how timelines are materialized. Whenever someone posts a status, that status must be fanned out to all followers and appended to their home timelines.</p>
<p>The tricky part is dealing with bursty load arising from how unbalanced the social graph can get. In our Mastodon instance, for example, the average fanout is 403, but the most popular user has over 22M followers. 3,500 statuses are posted each second, meaning that every second the system usually needs to perform 1.4M timeline writes to keep up. But if a user with 20M followers posts a status, then the number of timeline writes blows up by 15x to about 21.4M. With a naive implementation this can significantly delay other statuses from reaching follower timelines. And since the latency from posting a status to it reaching follower timelines is one of the most important metrics for this product, that’s really bad!</p>
<p>This is essentially a problem of fairness. You don’t want very popular users to hog all the resources on the system whenever they post a status. The key to solving this issue is to limit the amount of resources a status from a popular user can use before allocating those resources to other statuses. The approach we take in our implementation is:</p>
<ul>
<li>For each iteration of timeline processing, fan out each status to at most 64k followers.</li>
<li>If there are more followers left to deliver to for a status, add that status to a PState to continue fanout in the next iteration of processing.</li>
</ul>
<p>With this approach a status from a user with 20M followers will take 312 iterations of processing to complete fanout (about 3 minutes), and fairness is achieved by giving all statuses equal access to resources at any given time. Since the vast majority of users have less than 64k followers, most users will see their statuses delivered in one iteration of processing. Statuses from popular users take longer to deliver to all followers, but that is the tradeoff that has to be made given that the amount of resources is fixed at any given time.</p>
<p>As a side note, Twitter also has special handling for users with lots of followers to address the exact same issue.</p>
<p>With the basic approach understood, let’s look specifically at how statuses are processed in our implementation to materialize timelines. Here’s a dataflow diagram showing the logic:</p>
</div>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="549" height="1024" data-attachment-id="1284" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/timeline-fanout-9/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-9.png?fit=742%2C1384&amp;ssl=1" data-orig-size="742,1384" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="timeline-fanout-9" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-9.png?fit=161%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-9.png?fit=549%2C1024&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-9.png?resize=549%2C1024&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-9.png?resize=549%2C1024&amp;ssl=1 549w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-9.png?resize=161%2C300&amp;ssl=1 161w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-9.png?w=742&amp;ssl=1 742w" sizes="(max-width: 549px) 100vw, 549px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-9.png?resize=549%2C1024&amp;ssl=1 549w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-9.png?resize=161%2C300&amp;ssl=1 161w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-9.png?w=742&amp;ssl=1 742w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-9.png?resize=549%2C1024&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<div><p>This dataflow diagram is a little bit different than the social graph one, as this ETL is implemented with microbatching while the social graph is implemented with streaming. Streaming processes data directly off of depots as it arrives, while microbatching processes data in small batches. “Start iteration” in this diagram signifies the beginning of a microbatch. The tradeoffs between streaming and microbatching are too much to cover for this post, but you’ll be able to learn more about that next week when we release the documentation for Rama.</p>
<p>In this diagram you can see all the steps involved in delivering statuses to followers. There are many product rules implemented here, such as: only fan out statuses with the correct visibility, only send replies to followers who also follow the account being replied to, respect “show boost” settings, and so on.</p>
<p>This dataflow diagram only shows the computation of home timelines, whereas in reality this ETL also handles lists, hashtag timelines, and conversations. Those all work similarly to home timelines and are just additional branches of dataflow computation with slightly differing logic.</p>
</div>



<h4>Processing skew from unbalanced social graph</h4>



<div><p>Fairness issues aren’t the only problem caused by an unbalanced social graph. Another problem is skew: a naive implementation that handles all fanout for a single user from a single partition will lead to some partitions of a module having a lot more overall work to do than others. Without balanced processing, throughput is lowered since some resources are idle while others are being overwhelmed.</p>
<p>In our Mastodon implementation, we put significant effort into balancing fanout computation regardless of how unbalanced a social graph gets. This is a deep topic, so we will explore this further in a subsequent blog post. The optimizations we did in this area increased throughput by about 15%.</p>
</div>



<h3 id="Personalized_follow_suggestions">Personalized follow suggestions</h3>



<p>Let’s now look at another part of Mastodon which works completely differently than timelines: personalized follow suggestions. This powers this section on Mastodon:</p>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="608" height="438" data-attachment-id="1159" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/follow-suggestions-screenshot/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-screenshot.png?fit=608%2C438&amp;ssl=1" data-orig-size="608,438" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="follow-suggestions-screenshot" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-screenshot.png?fit=300%2C216&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-screenshot.png?fit=608%2C438&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-screenshot.png?resize=608%2C438&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-screenshot.png?w=608&amp;ssl=1 608w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-screenshot.png?resize=300%2C216&amp;ssl=1 300w" sizes="(max-width: 608px) 100vw, 608px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-screenshot.png?w=608&amp;ssl=1 608w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-screenshot.png?resize=300%2C216&amp;ssl=1 300w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-screenshot.png?resize=608%2C438&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<div><p>Everything about how data is processed and indexed for follow suggestions is different from what we looked at in the previous sections. Taken together, the implementations of timelines, the social graph, and follow suggestions demonstrate how expressive Rama is as a system. This generality is a result of the total arbitrariness with which you can write ETL computations, structure indexes, and compute queries.</p>
<p>Unlike the social graph and timelines, the behavior of personalized follow suggestions could be specified in very different ways. We’ve chosen to determine follow suggestions like so:</p>
<ul>
<li>Rank accounts to suggest based on who’s most followed by the accounts you already follow</li>
<li>Don’t suggest accounts you already follow</li>
<li>If this doesn’t produce enough suggestions (e.g. because you don’t follow many accounts yet), suggest the most followed accounts on the platform</li>
</ul>
<p>We took a different approach than Mastodon for follow suggestions –&nbsp;the <a href="https://docs.joinmastodon.org/methods/suggestions/">API docs</a> describe follow suggestions as “Accounts that are promoted by staff, or that the user has had past positive interactions with, but is not yet following.” We chose our approach because it’s much more difficult to implement and thus a better demonstration of Rama. Our implementation of personalized follow suggestions totals 141 lines of code.</p>
</div>



<p>The main PState underlying follow suggestions is called

<code>$$whoToFollow</code>

, a map from account ID to a list of up to 80 account ID suggestions. The interesting part of the follow suggestions implementation is how this PState is computed and maintained.</p>



<div><p>Follow suggestions can’t be computed fully incrementally, at least not practically. That is, you can’t receive a new follow or unfollow event and incrementally update all the follow suggestions for affected accounts. Computing follow suggestions is a batch operation that needs to look at everyone an account follows, and everyone they follow, at the same time in a single computation.</p>
<p>With that in mind, there are a few pieces to our implementation. First, everyone’s follow suggestions are recomputed on a regular basis. The ETL for follow suggestions recomputes the suggestions for 1,280 accounts every 30 seconds. Since there are 100M accounts, this means each account has its suggestions updated every 27 days.</p>
<p>In addition to this, we have special handling for new users. When a new user signs up, you want to provide good follow suggestions as soon as possible in order to increase engagement and increase the chance they’ll continue to use the service. So you don’t want to wait 27 days to compute personalized suggestions for a new user. At the same time, you can’t produce good personalized suggestions until the user has followed at least a few accounts. So our implementation tracks milestones which trigger immediate recomputation of follow suggestions: when a user follows 10 accounts and when a user follows 100 accounts.</p>
</div>



<h4>Structuring the PStates</h4>



<p>Here are all the depots, PStates, and query topologies related to the follow suggestions implementation:</p>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="135" data-attachment-id="1161" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/follow-suggestions-diagram/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-diagram.png?fit=1417%2C290&amp;ssl=1" data-orig-size="1417,290" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="follow-suggestions-diagram" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-diagram.png?fit=300%2C61&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-diagram.png?fit=656%2C135&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-diagram.png?resize=656%2C135&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-diagram.png?resize=1024%2C210&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-diagram.png?resize=300%2C61&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-diagram.png?resize=768%2C157&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-diagram.png?resize=1200%2C246&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-diagram.png?w=1417&amp;ssl=1 1417w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-diagram.png?w=1312&amp;ssl=1 1312w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-diagram.png?resize=1024%2C210&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-diagram.png?resize=300%2C61&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-diagram.png?resize=768%2C157&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-diagram.png?resize=1200%2C246&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-diagram.png?w=1417&amp;ssl=1 1417w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-diagram.png?w=1312&amp;ssl=1 1312w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-diagram.png?resize=656%2C135&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>Notice that this ETL also consumes

<code>followAndBlockAccountDepot</code>

, which is the same depot as consumed by the social graph ETL to produce the social graph PStates. Depots are sources of truth that can be consumed by as many topologies as you need.</p>



<p>Here’s what each PState for follow suggestions is used for:</p>



<ul>
<li>

<code>$$whoToFollow</code>

: As described above, this stores a list of up to 80 suggestions for each user.</li>
<li>

<code>$$nextId</code>

: This keeps track of the next group of accounts for which to recompute follow suggestions. This stores a

<code>Long</code>

on each partition that points to a key within the colocated

<code>$$followerToFollowees</code>

PState partition.</li>
<li>

<code>$$followCounts</code>

: This is a map from account ID to the number of follow actions that account has taken. This is used to track when a user has passed 10 or 100 follows and trigger an immediate recompute of their follow suggestions.</li>
<li>

<code>$$forceRecomputeUsers</code>

: This is the set of users (a set per partition) that have recently passed the 10 or 100 follows milestone. Accounts chosen for follow suggestion recomputes come from this PState as well as where

<code>$$nextId</code>

is pointing in

<code>$$followerToFollowees</code>

.</li>
<li>

<code>$$topFollowedUsers</code>

: This is a global list of the top followed users on the platform. These are used to supplement a user’s follow suggestions when not enough are computed via the personalized method.</li>
</ul>



<p>Notice how some of these PStates are not maps at the top-level, which may feel unusual given that pretty much every database that’s ever existed is map-based (with a “key” being the central concept to identify a record or row). But just as data structures other than maps are useful for everyday programming, data structures other than maps are useful for backend programming as well.</p>



<h4>Computing follow suggestions</h4>



<p>Let’s explore in more detail how follow suggestions are recomputed. Unlike the other ETLs we’ve described, this one initiates computations based on time and not on the receipt of data. Every 30 seconds it needs to recompute follow suggestions for a rotating subset of all users and for any users specified in the

<code>$$forceRecomputeUsers</code>

PState.</p>



<div><p>You can think of time as an infinite stream of events, with each event being an instant in time. Rama exposes a special depot for time called a “tick depot” which emits events according to a specified frequency.</p>
<p>For follow suggestions, a tick depot is used to trigger processing every 30 seconds. The subsequent computation then uses the PStates described to recompute follow suggestions for a subset of users. The dataflow looks like this:</p>
</div>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="648" height="1013" data-attachment-id="1165" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/follow-suggestions-dataflow/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-dataflow.png?fit=648%2C1013&amp;ssl=1" data-orig-size="648,1013" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="follow-suggestions-dataflow" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-dataflow.png?fit=192%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-dataflow.png?fit=648%2C1013&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-dataflow.png?resize=648%2C1013&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-dataflow.png?w=648&amp;ssl=1 648w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-dataflow.png?resize=192%2C300&amp;ssl=1 192w" sizes="(max-width: 648px) 100vw, 648px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-dataflow.png?w=648&amp;ssl=1 648w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-dataflow.png?resize=192%2C300&amp;ssl=1 192w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-suggestions-dataflow.png?resize=648%2C1013&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>The key PState is

<code>$$followerToFollowees</code>

. The ETL selects a subset of the keys in that map for processing, and it stores the last key chosen in

<code>$$nextId</code>

. The next iteration will start from that key. When it gets to the end of the PState, it starts over again from the beginning.</p>



<p>The rest of the processing uses

<code>$$followerToFollowees</code>

to fetch follows, fetch the follows of those follows, and aggregate a list of candidates along with how many times each candidate is followed among that subset of users. After filtering out candidates the starting account already follows, the

<code>$$whoToFollow</code>

PState is updated.</p>



<p>Every step of this is done in parallel. So when a subset of users is selected from

<code>$$followerToFollowees</code>

, it’s actually selecting a subset of users from each partition of that PState.</p>



<p>In between recomputes, a user may have followed some of the users in their list of suggestions. This is handled with a query topology that filters a user’s follow suggestions to exclude users they already follow.</p>



<h2 id="DevOps_with_Rama">DevOps with Rama</h2>



<p>
Let’s briefly take a look at how we do DevOps with Rama: managing the deployment, monitoring, and operation of modules in production. Since the steps are the same for all modules, we’ll use as an example how we manage the module handling statuses, timelines, and profiles. The module is implemented in the class

<code>com.rpl.mastodon.modules.Core</code>

and is deployed to a Rama cluster like so:
</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br></p></td><td><p>rama deploy \<br>
--action launch \<br>
--jar target/mastodon.jar \<br>
--module com.rpl.mastodon.modules.Core \<br>
--tasks 128 \<br>
--threads 32 \<br>
--workers 16 \<br>
--replicationFactor 3 \<br>
--configOverrides overrides.yaml</p></td></tr></tbody></table></div>




<div><p>This submits the module and its code to the cluster with the given parallelism, and Rama then launches worker processes around the cluster to run the module. The same cluster is shared by all modules. Once the workers finish starting up, they start reading from depots, executing ETLs, updating PStates, serving query requests, and so on.</p>
<p>The “replication factor” specifies to how many nodes each depot and PState should replicate its data. Replication happens completely behind the scenes and provides automatic failover in case of failures (e.g. hardware issues). Rama provides very strong guarantees with replication –&nbsp;data is not made visible for consumption from depots or PStates until it has been successfully replicated.</p>
</div>



<p>The referenced

<code>overrides.yaml</code>

file has only two lines and just registers with Rama how to serialize/deserialize the custom types used by our implementation (defined using <a href="https://thrift.apache.org/">Thrift</a>, described more below).</p>



<p>After the module finishes launching, the Cluster UI for Rama starts displaying telemetry on the module:</p>



<figure data-carousel-extra="{&quot;blog_id&quot;:1,&quot;permalink&quot;:&quot;https:\/\/blog.redplanetlabs.com\/2023\/08\/15\/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x\/&quot;}">
<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="373" data-attachment-id="1173" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/cluster-ui-modules-2/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-modules.png?fit=3290%2C1870&amp;ssl=1" data-orig-size="3290,1870" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="cluster-ui-modules" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-modules.png?fit=300%2C171&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-modules.png?fit=656%2C373&amp;ssl=1" data-id="1173" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-modules.png?resize=656%2C373&amp;ssl=1" alt="" title="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-modules.png?resize=1024%2C582&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-modules.png?resize=300%2C171&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-modules.png?resize=768%2C437&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-modules.png?resize=1536%2C873&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-modules.png?resize=2048%2C1164&amp;ssl=1 2048w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-modules.png?resize=1200%2C682&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-modules.png?w=1312&amp;ssl=1 1312w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-modules.png?w=1968&amp;ssl=1 1968w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-modules.png?resize=1024%2C582&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-modules.png?resize=300%2C171&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-modules.png?resize=768%2C437&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-modules.png?resize=1536%2C873&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-modules.png?resize=2048%2C1164&amp;ssl=1 2048w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-modules.png?resize=1200%2C682&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-modules.png?w=1312&amp;ssl=1 1312w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-modules.png?w=1968&amp;ssl=1 1968w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-modules.png?resize=656%2C373&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="374" data-attachment-id="1174" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/cluster-ui-telemetry-1-2/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-1.png?fit=3280%2C1870&amp;ssl=1" data-orig-size="3280,1870" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="cluster-ui-telemetry-1" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-1.png?fit=300%2C171&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-1.png?fit=656%2C374&amp;ssl=1" data-id="1174" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-1.png?resize=656%2C374&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-1.png?resize=1024%2C584&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-1.png?resize=300%2C171&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-1.png?resize=768%2C438&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-1.png?resize=1536%2C876&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-1.png?resize=2048%2C1168&amp;ssl=1 2048w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-1.png?resize=1200%2C684&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-1.png?w=1312&amp;ssl=1 1312w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-1.png?w=1968&amp;ssl=1 1968w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-1.png?resize=1024%2C584&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-1.png?resize=300%2C171&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-1.png?resize=768%2C438&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-1.png?resize=1536%2C876&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-1.png?resize=2048%2C1168&amp;ssl=1 2048w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-1.png?resize=1200%2C684&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-1.png?w=1312&amp;ssl=1 1312w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-1.png?w=1968&amp;ssl=1 1968w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-1.png?resize=656%2C374&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="374" data-attachment-id="1179" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/cluster-ui-telemetry-2-2/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-2.png?fit=3286%2C1874&amp;ssl=1" data-orig-size="3286,1874" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="cluster-ui-telemetry-2" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-2.png?fit=300%2C171&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-2.png?fit=656%2C374&amp;ssl=1" data-id="1179" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-2.png?resize=656%2C374&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-2.png?resize=1024%2C584&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-2.png?resize=300%2C171&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-2.png?resize=768%2C438&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-2.png?resize=1536%2C876&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-2.png?resize=2048%2C1168&amp;ssl=1 2048w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-2.png?resize=1200%2C684&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-2.png?w=1312&amp;ssl=1 1312w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-2.png?w=1968&amp;ssl=1 1968w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-2.png?resize=1024%2C584&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-2.png?resize=300%2C171&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-2.png?resize=768%2C438&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-2.png?resize=1536%2C876&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-2.png?resize=2048%2C1168&amp;ssl=1 2048w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-2.png?resize=1200%2C684&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-2.png?w=1312&amp;ssl=1 1312w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-2.png?w=1968&amp;ssl=1 1968w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-2.png?resize=656%2C374&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="375" data-attachment-id="1177" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/cluster-ui-telemetry-3-2/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-3.png?fit=3278%2C1876&amp;ssl=1" data-orig-size="3278,1876" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="cluster-ui-telemetry-3" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-3.png?fit=300%2C172&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-3.png?fit=656%2C375&amp;ssl=1" data-id="1177" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-3.png?resize=656%2C375&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-3.png?resize=1024%2C586&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-3.png?resize=300%2C172&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-3.png?resize=768%2C440&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-3.png?resize=1536%2C879&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-3.png?resize=2048%2C1172&amp;ssl=1 2048w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-3.png?resize=1200%2C687&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-3.png?w=1312&amp;ssl=1 1312w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-3.png?w=1968&amp;ssl=1 1968w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-3.png?resize=1024%2C586&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-3.png?resize=300%2C172&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-3.png?resize=768%2C440&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-3.png?resize=1536%2C879&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-3.png?resize=2048%2C1172&amp;ssl=1 2048w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-3.png?resize=1200%2C687&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-3.png?w=1312&amp;ssl=1 1312w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-3.png?w=1968&amp;ssl=1 1968w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-3.png?resize=656%2C375&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="373" data-attachment-id="1178" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/cluster-ui-telemetry-6-2/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-6.png?fit=3288%2C1870&amp;ssl=1" data-orig-size="3288,1870" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="cluster-ui-telemetry-6" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-6.png?fit=300%2C171&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-6.png?fit=656%2C373&amp;ssl=1" data-id="1178" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-6.png?resize=656%2C373&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-6.png?resize=1024%2C582&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-6.png?resize=300%2C171&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-6.png?resize=768%2C437&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-6.png?resize=1536%2C874&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-6.png?resize=2048%2C1165&amp;ssl=1 2048w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-6.png?resize=1200%2C682&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-6.png?w=1312&amp;ssl=1 1312w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-6.png?w=1968&amp;ssl=1 1968w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-6.png?resize=1024%2C582&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-6.png?resize=300%2C171&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-6.png?resize=768%2C437&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-6.png?resize=1536%2C874&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-6.png?resize=2048%2C1165&amp;ssl=1 2048w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-6.png?resize=1200%2C682&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-6.png?w=1312&amp;ssl=1 1312w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-6.png?w=1968&amp;ssl=1 1968w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-6.png?resize=656%2C373&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="375" data-attachment-id="1175" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/cluster-ui-telemetry-5-2/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-5.png?fit=3272%2C1874&amp;ssl=1" data-orig-size="3272,1874" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="cluster-ui-telemetry-5" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-5.png?fit=300%2C172&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-5.png?fit=656%2C375&amp;ssl=1" data-id="1175" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-5.png?resize=656%2C375&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-5.png?resize=1024%2C586&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-5.png?resize=300%2C172&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-5.png?resize=768%2C440&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-5.png?resize=1536%2C880&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-5.png?resize=2048%2C1173&amp;ssl=1 2048w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-5.png?resize=1200%2C687&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-5.png?w=1312&amp;ssl=1 1312w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-5.png?w=1968&amp;ssl=1 1968w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-5.png?resize=1024%2C586&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-5.png?resize=300%2C172&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-5.png?resize=768%2C440&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-5.png?resize=1536%2C880&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-5.png?resize=2048%2C1173&amp;ssl=1 2048w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-5.png?resize=1200%2C687&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-5.png?w=1312&amp;ssl=1 1312w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-5.png?w=1968&amp;ssl=1 1968w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-5.png?resize=656%2C375&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="373" data-attachment-id="1176" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/cluster-ui-telemetry-4-2/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-4.png?fit=3282%2C1870&amp;ssl=1" data-orig-size="3282,1870" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="cluster-ui-telemetry-4" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-4.png?fit=300%2C171&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-4.png?fit=656%2C373&amp;ssl=1" data-id="1176" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-4.png?resize=656%2C373&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-4.png?resize=1024%2C583&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-4.png?resize=300%2C171&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-4.png?resize=768%2C438&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-4.png?resize=1536%2C875&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-4.png?resize=2048%2C1167&amp;ssl=1 2048w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-4.png?resize=1200%2C684&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-4.png?w=1312&amp;ssl=1 1312w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-4.png?w=1968&amp;ssl=1 1968w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-4.png?resize=1024%2C583&amp;ssl=1 1024w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-4.png?resize=300%2C171&amp;ssl=1 300w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-4.png?resize=768%2C438&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-4.png?resize=1536%2C875&amp;ssl=1 1536w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-4.png?resize=2048%2C1167&amp;ssl=1 2048w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-4.png?resize=1200%2C684&amp;ssl=1 1200w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-4.png?w=1312&amp;ssl=1 1312w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-4.png?w=1968&amp;ssl=1 1968w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/cluster-ui-telemetry-4.png?resize=656%2C373&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>
</figure>



<div><p>Rama tracks and displays telemetry for the module as a whole, as well as specific telemetry for each topology, depot, and PState. The telemetry is extremely useful for understanding the performance of a module and when it needs to be scaled. Rama uses itself to implement telemetry –&nbsp;a built-in module collects telemetry data from all modules into a depot, processes that data with an ETL, and indexes the results into PStates arranged in a time-series structure.</p>
<p>When we want to update the module to add a feature (e.g. add a new PState) or fix a bug, we run a command like the following:</p>
</div>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br></p></td><td><p>rama deploy \<br>
--action update \<br>
--jar target/mastodon.jar \<br>
--module com.rpl.mastodon.modules.Core \<br>
--configOverrides overrides.yaml</p></td></tr></tbody></table></div>




<div><p>This launches a carefully coordinated automated procedure to launch new worker processes and handoff responsibility for depots and PStates to the new version of the module. Clients of the module doing depot appends and PState queries don’t need to be updated and automatically transition themselves to the new module version.</p>
<p>Similarly, when we want to scale the module to have more resources, we run a command like the following:</p>
</div>




<div><table><tbody><tr><td><p>1<br>2<br>3<br></p></td><td><p>rama scaleExecutors \<br>
--module com.rpl.mastodon.modules.Core \<br>
--workers 24</p></td></tr></tbody></table></div>




<div><p>This launches a similar procedure as module update to transition the module to the new version.</p>
<p>And that’s all there is to DevOps with Rama –&nbsp;it’s just a few commands at the terminal to manage everything. You don’t need to invest huge amounts of time writing piles of shell scripts to coordinate changes across dozens of systems. Since Rama is such a cohesive, integrated system it’s able to automate deployment entirely, and it’s able to provide deep and detailed runtime telemetry without needing to lift a finger.</p>
</div>



<h2 id="Simple_Rama_code_example">Simple Rama code example</h2>



<div><p>Let’s look at some code! Before diving into the Mastodon code, let’s look at a simple example of coding with Rama to gain a feeling for what it’s like.</p>
<p>I’m not going to explain every last detail in this code –&nbsp;the API is so rich that it’s too much to explain for this post. Instead, I’ll do my best to summarize what the code is doing. In one week we will be releasing all the documentation for Rama, and this includes a six part tutorial that gently introduces everything. We will also be releasing a build of Rama that anyone can download and use. This build will be able to simulate Rama clusters within a single process but will not be able to run distributed clusters. It has the full Rama API and can be used to experiment with Rama. Once we open-source our Mastodon implementation in two weeks, you’ll be able to run it within a single process using this build.</p>
<p>With that said, let’s look at a simple example. Here’s the complete definition for a “word count module”, which accepts sentences as input and produces a single PState containing the count of all words in those sentences:</p>
</div>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br></p></td><td><div><p><span>public</span> <span>class</span> WordCountModule <span>implements</span> RamaModule <span>{</span><br>
&nbsp; &nbsp; @Override<br>
&nbsp; &nbsp; <span>public</span> <span>void</span> define<span>(</span>Setup setup, Topologies topologies<span>)</span> <span>{</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; setup.<span>declareDepot</span><span>(</span><span>"*sentenceDepot"</span>, Depot.<span>random</span><span>(</span><span>)</span><span>)</span><span>;</span></p><p>

&nbsp; &nbsp; &nbsp; &nbsp; StreamTopology wordCount <span>=</span> topologies.<span>stream</span><span>(</span><span>"wordCount"</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; wordCount.<span>pstate</span><span>(</span><span>"$$wordCounts"</span>, PState.<span>mapSchema</span><span>(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+string"><span>String</span></a>.<span>class</span>, <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+long"><span>Long</span></a>.<span>class</span><span>)</span><span>)</span><span>;</span></p><p>

&nbsp; &nbsp; &nbsp; &nbsp; wordCount.<span>source</span><span>(</span><span>"*sentenceDepot"</span><span>)</span>.<span>out</span><span>(</span><span>"*sentence"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>each</span><span>(</span><span>(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+string"><span>String</span></a> sentence, OutputCollector collector<span>)</span> <span>-&gt;</span> <span>{</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span>for</span><span>(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+string"><span>String</span></a> word<span>:</span> sentence.<span>split</span><span>(</span><span>" "</span><span>)</span><span>)</span> <span>{</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;collector.<span>emit</span><span>(</span>word<span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span>}</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;<span>}</span>, <span>"*sentence"</span><span>)</span>.<span>out</span><span>(</span><span>"*word"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>hashPartition</span><span>(</span><span>"*word"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>compoundAgg</span><span>(</span><span>"$$wordCounts"</span>, CompoundAgg.<span>map</span><span>(</span><span>"*word"</span>, Agg.<span>count</span><span>(</span><span>)</span><span>)</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; <span>}</span><br>
<span>}</span></p></div></td></tr></tbody></table></div>




<p>This module has one ETL named

<code>wordCount</code>

, one depot named

<code>*sentenceDepot</code>

, and one PState named

<code>$$wordCounts</code>

. The ETL receives new sentences from the depot, tokenizes those sentences into words, and then updates the counts for those words in the PState. The PState partitions are updated within a few milliseconds of appending a sentence to the depot.</p>



<p>A module implements the interface

<code>RamaModule</code>

that has a single method

<code>define</code>

on it.

<code>setup</code>

is used to declare depots and any dependencies to depots or PStates in other modules, and

<code>topologies</code>

is used to declare all ETL and query topologies.</p>



<p>The first line of

<code>define</code>

declares the depot. Depot names always begin with a

<code>*</code>

. Strings beginning with

<code>*</code>

are interpreted as variables in Rama code, and they can be passed around and used just like variables in any programming language. The second argument

<code>Depot.random()</code>

specifies the partitioning scheme of the depot. In this case the partitioning scheme causes appended sentences to go to a random partition of the depot. When local ordering is important, like for follow and unfollow events, the partitioning scheme would be set appropriately so events for the same entity go to the same partition.</p>



<p>The next line declares the ETL

<code>wordCount</code>

as a streaming topology.</p>



<p>After that is the declaration of the PState

<code>$$wordCounts</code>

. The PState is declared with a schema that specifies what it stores and how it stores it. In this case it’s just a simple map, but you can specify whatever structure you want here (e.g. a map of subindexed maps of lists of subindexed sets).</p>



<p>Lastly is the definition of the ETL. The line

<code>wordCount.source("*sentenceDepot").out("*sentence")</code>

subscribes the ETL to

<code>*sentenceDepot</code>

and binds any new sentences received to the variable

<code>*sentence</code>

.</p>



<p>The next line tokenizes each sentence into words. Java code is inserted with a lambda to split each sentence on whitespace and emit each word individually as the variable

<code>*word</code>

. Inserting arbitrary Java code into topologies like this is extremely common.</p>



<p>The next line

<code>.hashPartition("*word")</code>

relocates the dataflow to the partition of the module storing the counts for that word. The code before that line and after that line can execute on different machines, and Rama takes care of all the serialization and network transfer involved in moving the computation.</p>



<div><p>Finally, now that the computation is on the correct partition, the last line updates the count for the word in the PState. This PState update is specified in the form of an aggregation template –&nbsp;in this case it says it’s aggregating a map where the key is the word and the value is the count of all events seen for that word.</p>
<p>This is such a basic example that it doesn’t really do justice to the expressive power of Rama. However, it does demonstrate the general workflow of declaring modules, depots, PStates, and topologies. Some of the functionality not shown here includes: consuming depots/PStates from other modules, query topologies, microbatching, branching/merging, joins, loops, shadowing variables, conditionals, and decomposing code with macros.</p>
<p>Let’s now take a look at interacting with Rama modules as a client outside the cluster, similar to how you interact with a database using a database client. Here’s code that connects to a remote cluster, creates handles to the depot and PState of the module, appends some sentences, and then does some PState queries:</p>
</div>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br></p></td><td><div><p><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+map"><span>Map</span></a> config <span>=</span> <span>new</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+hashmap"><span>HashMap</span></a><span>(</span><span>)</span><span>;</span><br>
config.<span>put</span><span>(</span><span>"conductor.host"</span>, <span>"1.2.3.4"</span><span>)</span><span>;</span><br>
RamaClusterManager manager <span>=</span> RamaClusterManager.<span>open</span><span>(</span>config<span>)</span><span>;</span><br>
Depot depot <span>=</span> manager.<span>clusterDepot</span><span>(</span><span>"rama.examples.wordcount.WordCountModule"</span>, <span>"*sentenceDepot"</span><span>)</span><span>;</span><br>
depot.<span>append</span><span>(</span><span>"hello world"</span><span>)</span><span>;</span><br>
depot.<span>append</span><span>(</span><span>"hello world again"</span><span>)</span><span>;</span><br>
depot.<span>append</span><span>(</span><span>"say hello to the planet"</span><span>)</span><span>;</span><br>
depot.<span>append</span><span>(</span><span>"red planet labs"</span><span>)</span><span>;</span></p><p>

PState wc <span>=</span> manager.<span>clusterPState</span><span>(</span><span>"rama.examples.wordcount.WordCountModule"</span>, <span>"$$wordCounts"</span><span>)</span><span>;</span><br>
<a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+system"><span>System</span></a>.<span>out</span>.<span>println</span><span>(</span><span>"'hello' count: "</span> <span>+</span> wc.<span>selectOne</span><span>(</span>Path.<span>key</span><span>(</span><span>"hello"</span><span>)</span><span>)</span><span>)</span><span>;</span><br>
<a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+system"><span>System</span></a>.<span>out</span>.<span>println</span><span>(</span><span>"'world' count: "</span> <span>+</span> wc.<span>selectOne</span><span>(</span>Path.<span>key</span><span>(</span><span>"world"</span><span>)</span><span>)</span><span>)</span><span>;</span><br>
<a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+system"><span>System</span></a>.<span>out</span>.<span>println</span><span>(</span><span>"'planet' count: "</span> <span>+</span> wc.<span>selectOne</span><span>(</span>Path.<span>key</span><span>(</span><span>"planet"</span><span>)</span><span>)</span><span>)</span><span>;</span><br>
<a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+system"><span>System</span></a>.<span>out</span>.<span>println</span><span>(</span><span>"'red' count: "</span> <span>+</span> wc.<span>selectOne</span><span>(</span>Path.<span>key</span><span>(</span><span>"red"</span><span>)</span><span>)</span><span>)</span><span>;</span></p></div></td></tr></tbody></table></div>




<p>

<code>RamaClusterManager</code>

is used to connect to a cluster and retrieve handles to depots and PStates. Depots and PStates are identified by their module name (the class name of the module definition) and their name within the module. By default, depot appends block until all colocated streaming topologies have finished processing the appended data. This is why the PState queries can be executed immediately following the depot appends without further coordination.</p>



<p>The PState queries here fetch the values for the specified keys. PStates are queried using Rama’s “Path” API, and this example barely scratches the surface of what you can do with paths. They allow you to easily reach into a PState, regardless of its structure, and retrieve precisely what you need –&nbsp;whether one value, multiple values, or an aggregation of values. They can also be used for updating PStates within topologies. Mastering paths is one of the keys to mastering Rama development.</p>



<p>Let’s now take a look at how you would run

<code>WordCountModule</code>

in a unit test environment:</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br></p></td><td><div><p><span>public</span> <span>void</span> wordCountTest<span>(</span><span>)</span> <span>throws</span> <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+exception"><span>Exception</span></a> <span>{</span><br>
&nbsp; &nbsp; <span>try</span> <span>(</span>InProcessCluster cluster <span>=</span> InProcessCluster.<span>create</span><span>(</span><span>)</span><span>)</span> <span>{</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; cluster.<span>launchModule</span><span>(</span><span>new</span> WordCountModule<span>(</span><span>)</span>, <span>new</span> LaunchConfig<span>(</span><span>4</span>, <span>2</span><span>)</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+string"><span>String</span></a> moduleName <span>=</span> WordCountModule.<span>class</span>.<span>getName</span><span>(</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; Depot depot <span>=</span> cluster.<span>clusterDepot</span><span>(</span>moduleName, <span>"*sentenceDepot"</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; depot.<span>append</span><span>(</span><span>"hello world"</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; depot.<span>append</span><span>(</span><span>"hello world again"</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; depot.<span>append</span><span>(</span><span>"say hello to the planet"</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; depot.<span>append</span><span>(</span><span>"red planet labs"</span><span>)</span><span>;</span></p><p>

&nbsp; &nbsp; &nbsp; &nbsp; PState wc <span>=</span> cluster.<span>clusterPState</span><span>(</span>moduleName, <span>"$$wordCounts"</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+system"><span>System</span></a>.<span>out</span>.<span>println</span><span>(</span><span>"'hello' count: "</span> <span>+</span> wc.<span>selectOne</span><span>(</span>Path.<span>key</span><span>(</span><span>"hello"</span><span>)</span><span>)</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+system"><span>System</span></a>.<span>out</span>.<span>println</span><span>(</span><span>"'world' count: "</span> <span>+</span> wc.<span>selectOne</span><span>(</span>Path.<span>key</span><span>(</span><span>"world"</span><span>)</span><span>)</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+system"><span>System</span></a>.<span>out</span>.<span>println</span><span>(</span><span>"'planet' count: "</span> <span>+</span> wc.<span>selectOne</span><span>(</span>Path.<span>key</span><span>(</span><span>"planet"</span><span>)</span><span>)</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+system"><span>System</span></a>.<span>out</span>.<span>println</span><span>(</span><span>"'red' count: "</span> <span>+</span> wc.<span>selectOne</span><span>(</span>Path.<span>key</span><span>(</span><span>"red"</span><span>)</span><span>)</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; <span>}</span><br>
<span>}</span></p></div></td></tr></tbody></table></div>




<p>Running this code prints:</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br></p></td><td><p>'hello' count: 3<br>
'world' count: 2<br>
'planet' count: 2<br>
'red' count: 1</p></td></tr></tbody></table></div>




<p>

<code>InProcessCluster</code>

simulates a Rama cluster completely in-process and is ideal for unit testing modules. Here you can see how

<code>InProcessCluster</code>

is used to launch the module and then fetch depots/PStates just like with

<code>RamaClusterManager</code>

. There’s no difference in the functionality available with

<code>InProcessCluster</code>

versus a real cluster, and you’ll be able to try out

<code>InProcessCluster</code>

next week when we release the non-production build of Rama.</p>



<h2 id="Sample_code_from_our_Mastodon_implementation">Sample code from our Mastodon implementation</h2>



<div><p>Now let’s look at some code from our Mastodon implementation. We’ll be looking at bigger code samples in this section utilizing a lot more of the Rama API, so even more than the last section I won’t be able to explain all the details of the code. I’ll summarize what the key parts are, and you’ll be able to learn all the details next week when we release the documentation.</p>
<p>Please don’t be too intimidated by this code. There are a lot of concepts and API methods at work here, and no one could possibly understand this code completely at a first glance. This is especially true without the accompanying documentation. I’m showing this code because it ties together the high-level concepts I’ve discussed in this post by making them real instead of abstract.</p>
</div>



<h3 id="Representing_data">Representing data</h3>



<p>Let’s start by looking at an example of how data is defined. We chose to represent data using <a href="https://thrift.apache.org/">Thrift</a> since it has a nice schema definition language and produces efficient serialization, but you can just as easily use plain Java objects, <a href="https://protobuf.dev/">Protocol Buffers</a>, or anything else you want. We use Thrift-defined objects in both depots and PStates. Here’s how statuses are defined:</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br>24<br>25<br>26<br>27<br>28<br>29<br>30<br>31<br>32<br>33<br>34<br>35<br>36<br>37<br>38<br>39<br>40<br>41<br>42<br>43<br>44<br>45<br>46<br>47<br>48<br>49<br>50<br>51<br>52<br>53<br>54<br>55<br>56<br>57<br>58<br>59<br>60<br>61<br>62<br>63<br>64<br>65<br>66<br>67<br>68<br>69<br>70<br>71<br>72<br>73<br>74<br></p></td><td><div><p>typedef i64 AccountId<br>
typedef i64 StatusId<br>
typedef i64 Timestamp</p><p>

enum StatusVisibility {<br>
&nbsp; Public = 1,<br>
&nbsp; Unlisted = 2,<br>
&nbsp; Private = 3,<br>
&nbsp; Direct = 4<br>
}</p><p>

enum AttachmentKind {<br>
&nbsp; Image = 1,<br>
&nbsp; Video = 2<br>
}</p><p>

struct StatusPointer {<br>
&nbsp; 1: required AccountId authorId;<br>
&nbsp; 2: required StatusId statusId;<br>
&nbsp; 3: optional Timestamp timestamp;<br>
&nbsp; 4: optional bool shouldExclude;<br>
}</p><p>

struct PollContent {<br>
&nbsp; 1: list&lt;string&gt; choices;<br>
&nbsp; 2: required Timestamp expiration;<br>
&nbsp; 3: required bool multipleChoice;<br>
}</p><p>

struct Attachment {<br>
&nbsp; 1: required AttachmentKind kind;<br>
&nbsp; 2: required string extension;<br>
&nbsp; 3: required string description;<br>
}</p><p>

struct AttachmentWithId {<br>
&nbsp; 1: required string uuid;<br>
&nbsp; 2: required Attachment attachment;<br>
}</p><p>

struct NormalStatusContent {<br>
&nbsp; 1: required string text;<br>
&nbsp; 2: required StatusVisibility visibility;<br>
&nbsp; 3: optional PollContent pollContent;<br>
&nbsp; 4: optional list&lt;AttachmentWithId&gt; attachments;<br>
&nbsp; 5: optional string sensitiveWarning;<br>
}</p><p>

struct ReplyStatusContent {<br>
&nbsp; 1: required string text;<br>
&nbsp; 2: required StatusVisibility visibility;<br>
&nbsp; 3: required StatusPointer parent;<br>
&nbsp; 4: optional PollContent pollContent;<br>
&nbsp; 5: optional list&lt;AttachmentWithId&gt; attachments;<br>
&nbsp; 6: optional string sensitiveWarning;<br>
}</p><p>

struct BoostStatusContent {<br>
&nbsp; 1: required StatusPointer boosted;<br>
}</p><p>

union StatusContent {<br>
&nbsp; 1: NormalStatusContent normal;<br>
&nbsp; 2: ReplyStatusContent reply;<br>
&nbsp; 3: BoostStatusContent boost;<br>
}</p><p>

struct Status {<br>
&nbsp; 1: required AccountId authorId;<br>
&nbsp; 2: required StatusContent content;<br>
&nbsp; 3: required Timestamp timestamp;<br>
&nbsp; 4: optional string remoteUrl;<br>
&nbsp; 5: optional string language;<br>
}</p></div></td></tr></tbody></table></div>




<p>Every type of status, including boosts, replies, and statuses with polls is represented by this definition. Being able to represent your data using normal programming practices, as opposed to restrictive database environments where you can’t have nested definitions like this, goes a long way in avoiding impedance mismatches and keeping code clean and comprehensible.</p>



<h3 id="Following_hashtags_code">Following hashtags code</h3>



<p>Next, let’s look at the entire definition of following hashtags (described <a href="#Following_hashtags">earlier</a> in this post). As a reminder, here’s the dataflow diagram for the following hashtags ETL:</p>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="372" height="472" data-attachment-id="1194" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/follow-hashtags-1/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-hashtags-1.png?fit=372%2C472&amp;ssl=1" data-orig-size="372,472" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="follow-hashtags-1" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-hashtags-1.png?fit=236%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-hashtags-1.png?fit=372%2C472&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-hashtags-1.png?resize=372%2C472&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-hashtags-1.png?w=372&amp;ssl=1 372w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-hashtags-1.png?resize=236%2C300&amp;ssl=1 236w" sizes="(max-width: 372px) 100vw, 372px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-hashtags-1.png?w=372&amp;ssl=1 372w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-hashtags-1.png?resize=236%2C300&amp;ssl=1 236w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/follow-hashtags-1.png?resize=372%2C472&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>Here’s the implementation, which is a direct translation of the diagram to code:</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br></p></td><td><div><p>setup.<span>declareDepot</span><span>(</span><span>"*followHashtagDepot"</span>, Depot.<span>hashBy</span><span>(</span>ExtractToken.<span>class</span><span>)</span><span>)</span><span>;</span></p><p>

StreamTopology stream <span>=</span> topologies.<span>stream</span><span>(</span><span>"relationshipsStream"</span><span>)</span><span>;</span></p><p>

stream.<span>pstate</span><span>(</span><span>"$$hashtagToFollowers"</span>, PState.<span>mapSchema</span><span>(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+string"><span>String</span></a>.<span>class</span>, PState.<span>setSchema</span><span>(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+long"><span>Long</span></a>.<span>class</span><span>)</span>.<span>subindexed</span><span>(</span><span>)</span><span>)</span><span>)</span><span>;</span></p><p>

stream.<span>source</span><span>(</span><span>"*followHashtagDepot"</span>, StreamSourceOptions.<span>retryAllAfter</span><span>(</span><span>)</span><span>)</span>.<span>out</span><span>(</span><span>"*data"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; .<span>subSource</span><span>(</span><span>"*data"</span>,<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SubSource.<span>create</span><span>(</span>FollowHashtag.<span>class</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<span>macro</span><span>(</span>extractFields<span>(</span><span>"*data"</span>, <span>"*accountId"</span>, <span>"*token"</span><span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<span>localTransform</span><span>(</span><span>"$$hashtagToFollowers"</span>, Path.<span>key</span><span>(</span><span>"*token"</span><span>)</span>.<span>voidSetElem</span><span>(</span><span>)</span>.<span>termVal</span><span>(</span><span>"*accountId"</span><span>)</span><span>)</span>,<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SubSource.<span>create</span><span>(</span>RemoveFollowHashtag.<span>class</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<span>macro</span><span>(</span>extractFields<span>(</span><span>"*data"</span>, <span>"*accountId"</span>, <span>"*token"</span><span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<span>localTransform</span><span>(</span><span>"$$hashtagToFollowers"</span>, Path.<span>key</span><span>(</span><span>"*token"</span><span>)</span>.<span>setElem</span><span>(</span><span>"*accountId"</span><span>)</span>.<span>termVoid</span><span>(</span><span>)</span><span>)</span><span>)</span><span>;</span></p></div></td></tr></tbody></table></div>




<p>This is extremely simple.

<code>subSource</code>

branches the dataflow graph based on the type of an object. In this code the object in

<code>*data</code>

can be one of two types, and there is a separate branch of dataflow for each type. When a

<code>FollowHashtag</code>

event is received, that account is added to the set of followers for that hashtag. When a

<code>RemoveFollowHashtag</code>

event is received, that account is removed from the set of followers for that hashtag. Because the nested sets are subindexed, they can efficiently contain hundreds of millions of elements or more.</p>



<p>

<code>extractFields</code>

is a helper function in the Mastodon implementation for extracting fields out of Thrift objects by name and binding them to corresponding Rama variables of the same name. So

<code>extractFields("*data", "*accountId", "*token"))</code>

extracts the fields “accountId” and “token” from the Thrift object in

<code>*data</code>

and binds them to the variables

<code>*accountId</code>

and

<code>*token</code>

.</p>



<p>

<code>extractFields</code>

is implemented as a Rama macro, which is a utility for inserting a snippet of dataflow code into another section of dataflow code. It is a mechanism for code reuse that allows the composition of any dataflow elements: functions, filters, aggregation, partitioning, etc.</p>



<div><p>Unlike word count, this code uses paths instead of aggregators to define the writes to the PStates, which is the same API used to read from PStates. You’ll be able to learn more next week when we release Rama’s documentation about the differences between aggregators and paths and when to prefer one over the other.</p>
<p>Note that this code defines a parallel computation just like the word count example earlier. The code runs across many nodes to process data off each partition of the depot and update the PState. Any failures (e.g. a node dying) are handled transparently and Rama guarantees all depot data will be fully processed.</p>
</div>



<p>The partitioning is defined at the depot level (

<code>Depot.hashBy(ExtractToken.class)</code>

), so when the ETL begins processing a piece of data, the computation is already located on the partition of the module storing followers for that hashtag. So no further partitioning is needed in the ETL definition.</p>







<p>Next, let’s look at the entire definition of the social graph as described <a href="#Social_graph">earlier</a>. Here was the dataflow diagram for the social graph ETL:</p>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="704" data-attachment-id="1198" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/social-graph-1/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-1.png?fit=1136%2C1219&amp;ssl=1" data-orig-size="1136,1219" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="social-graph-1" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-1.png?fit=280%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-1.png?fit=656%2C704&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-1.png?resize=656%2C704&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-1.png?resize=954%2C1024&amp;ssl=1 954w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-1.png?resize=280%2C300&amp;ssl=1 280w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-1.png?resize=768%2C824&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-1.png?w=1136&amp;ssl=1 1136w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-1.png?resize=954%2C1024&amp;ssl=1 954w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-1.png?resize=280%2C300&amp;ssl=1 280w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-1.png?resize=768%2C824&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-1.png?w=1136&amp;ssl=1 1136w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-1.png?resize=656%2C704&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>Like hashtag follows, the social graph implementation is also a direct translation of the diagram to code. Since the code for this is longer, let’s look at it section by section in the order in which it’s written. The first part is the declaration of the depots, topology, and PStates:</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br></p></td><td><div><p>setup.<span>declareDepot</span><span>(</span><span>"*followAndBlockAccountDepot"</span>, Depot.<span>hashBy</span><span>(</span>ExtractAccountId.<span>class</span><span>)</span><span>)</span><span>;</span><br>
setup.<span>declareDepot</span><span>(</span><span>"*muteAccountDepot"</span>, Depot.<span>hashBy</span><span>(</span>ExtractAccountId.<span>class</span><span>)</span><span>)</span><span>;</span></p><p>

StreamTopology stream <span>=</span> topologies.<span>stream</span><span>(</span><span>"relationshipsStream"</span><span>)</span><span>;</span></p><p>

KeyToLinkedEntitySetPStateGroup accountIdToFollowRequests <span>=</span> <span>new</span> KeyToLinkedEntitySetPStateGroup<span>(</span><span>"$$accountIdToFollowRequests"</span>, <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+long"><span>Long</span></a>.<span>class</span>, FollowLockedAccount.<span>class</span><span>)</span><br>
&nbsp; &nbsp; .<span>entityIdFunction</span><span>(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+long"><span>Long</span></a>.<span>class</span>, req <span>-&gt;</span> <span>(</span><span>(</span>FollowLockedAccount<span>)</span> req<span>)</span>.<span>requesterId</span><span>)</span><br>
&nbsp; &nbsp; .<span>descending</span><span>(</span><span>)</span><span>;</span><br>
accountIdToFollowRequests.<span>declarePStates</span><span>(</span>stream<span>)</span><span>;</span></p><p>

KeyToLinkedEntitySetPStateGroup followerToFollowees <span>=</span> <span>new</span> KeyToLinkedEntitySetPStateGroup<span>(</span><span>"$$followerToFollowees"</span>, <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+long"><span>Long</span></a>.<span>class</span>, Follower.<span>class</span><span>)</span><br>
&nbsp; &nbsp; .<span>entityIdFunction</span><span>(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+long"><span>Long</span></a>.<span>class</span>, <span>new</span> ExtractAccountId<span>(</span><span>)</span><span>)</span><br>
&nbsp; &nbsp; .<span>descending</span><span>(</span><span>)</span><span>;</span><br>
KeyToLinkedEntitySetPStateGroup followeeToFollowers <span>=</span> <span>new</span> KeyToLinkedEntitySetPStateGroup<span>(</span><span>"$$followeeToFollowers"</span>, <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+long"><span>Long</span></a>.<span>class</span>, Follower.<span>class</span><span>)</span><br>
&nbsp; &nbsp; .<span>entityIdFunction</span><span>(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+long"><span>Long</span></a>.<span>class</span>, <span>new</span> ExtractAccountId<span>(</span><span>)</span><span>)</span><br>
&nbsp; &nbsp; .<span>descending</span><span>(</span><span>)</span><span>;</span><br>
followerToFollowees.<span>declarePStates</span><span>(</span>stream<span>)</span><span>;</span><br>
followeeToFollowers.<span>declarePStates</span><span>(</span>stream<span>)</span><span>;</span></p><p>

stream.<span>pstate</span><span>(</span><span>"$$accountIdToSuppressions"</span>,<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; PState.<span>mapSchema</span><span>(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+long"><span>Long</span></a>.<span>class</span>, PState.<span>fixedKeysSchema</span><span>(</span><span>"muted"</span>, PState.<span>mapSchema</span><span>(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+long"><span>Long</span></a>.<span>class</span>, MuteAccountOptions.<span>class</span><span>)</span>.<span>subindexed</span><span>(</span><span>)</span>,<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>"blocked"</span>, PState.<span>setSchema</span><span>(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+long"><span>Long</span></a>.<span>class</span><span>)</span>.<span>subindexed</span><span>(</span><span>)</span><span>)</span><span>)</span><span>)</span><span>;</span></p></div></td></tr></tbody></table></div>




<p>Note that both hashtag follows and the social graph are part of the same stream topology. The social graph implementation consumes different depots than hashtag follows does, so the code is otherwise completely independent.</p>



<p>The

<code>$$followerToFollowees</code>

and

<code>$$followeeToFollowers</code>

PStates are defined with

<code>KeyToLinkedEntitySetPStateGroup</code>

, which defines the “map to linked set” data structure abstraction as the composition of multiple, more primitive PStates underneath the hood. Its implementation is only 68 lines of code.</p>



<p>The next part defines the root of processing where the branching occurs at the start of the dataflow diagram:</p>




<div><table><tbody><tr><td><p>1<br>2<br></p></td><td><p>stream.<span>source</span><span>(</span><span>"*followAndBlockAccountDepot"</span>, StreamSourceOptions.<span>retryAllAfter</span><span>(</span><span>)</span><span>)</span>.<span>out</span><span>(</span><span>"*initialData"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; .<span>anchor</span><span>(</span><span>"SocialGraphRoot"</span><span>)</span></p></td></tr></tbody></table></div>




<p>As we build up the code for the social graph, let’s also take a look visually at how the dataflow diagram is filled out. This code starts off the dataflow diagram like this:</p>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="100" height="69" data-attachment-id="1201" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/social-graph-1-1/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-1-1.png?fit=100%2C69&amp;ssl=1" data-orig-size="100,69" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="social-graph-1-1" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-1-1.png?fit=100%2C69&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-1-1.png?fit=100%2C69&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-1-1.png?resize=100%2C69&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-1-1.png?resize=100%2C69&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>

<code>anchor</code>

defines a location in a dataflow graph that can later be hooked onto with

<code>hook</code>

. The next section defines the first branch of processing:</p>




<div><table><tbody><tr><td><p>1<br>2<br></p></td><td><p>.<span>each</span><span>(</span>Ops.<span>IDENTITY</span>, <span>"*initialData"</span><span>)</span>.<span>out</span><span>(</span><span>"*data"</span><span>)</span><br>
.<span>anchor</span><span>(</span><span>"Normal"</span><span>)</span></p></td></tr></tbody></table></div>




<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="100" height="485" data-attachment-id="1203" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/social-graph-2/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-2.png?fit=100%2C485&amp;ssl=1" data-orig-size="100,485" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="social-graph-2" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-2.png?fit=62%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-2.png?fit=100%2C485&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-2.png?resize=100%2C485&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-2.png?w=100&amp;ssl=1 100w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-2.png?resize=62%2C300&amp;ssl=1 62w" sizes="(max-width: 100px) 100vw, 100px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-2.png?w=100&amp;ssl=1 100w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-2.png?resize=62%2C300&amp;ssl=1 62w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-2.png?resize=100%2C485&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>This branch passes all data through to the anchor “Normal”, which will later be merged with other branches as you can see in the dataflow diagram.</p>



<p>Rama provides the

<code>Ops</code>

class which has commonly used functions to use within dataflow code. This includes math operations, comparators, and other utilities. Here

<code>Ops.IDENTITY</code>

is used which emits its input unchanged.</p>



<p>The next section defines the branch handling implicit unfollow events for block events:</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br></p></td><td><p>.<span>hook</span><span>(</span><span>"SocialGraphRoot"</span><span>)</span><br>
.<span>keepTrue</span><span>(</span><span>new</span> Expr<span>(</span>Ops.<span>IS_INSTANCE_OF</span>, BlockAccount.<span>class</span>, <span>"*initialData"</span><span>)</span><span>)</span><br>
.<span>each</span><span>(</span><span>(</span>BlockAccount data, OutputCollector collector<span>)</span> <span>-&gt;</span> <span>{</span><br>
&nbsp; &nbsp; collector.<span>emit</span><span>(</span><span>new</span> RemoveFollowAccount<span>(</span>data.<span>getAccountId</span><span>(</span><span>)</span>, data.<span>getTargetId</span><span>(</span><span>)</span>, data.<span>getTimestamp</span><span>(</span><span>)</span><span>)</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; collector.<span>emit</span><span>(</span><span>new</span> RemoveFollowAccount<span>(</span>data.<span>getTargetId</span><span>(</span><span>)</span>, data.<span>getAccountId</span><span>(</span><span>)</span>, data.<span>getTimestamp</span><span>(</span><span>)</span><span>)</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; collector.<span>emit</span><span>(</span><span>new</span> RejectFollowRequest<span>(</span>data.<span>getAccountId</span><span>(</span><span>)</span>, data.<span>getTargetId</span><span>(</span><span>)</span><span>)</span><span>)</span><span>;</span><br>
<span>}</span>, <span>"*initialData"</span><span>)</span>.<span>out</span><span>(</span><span>"*data"</span><span>)</span><br>
.<span>anchor</span><span>(</span><span>"ImplicitUnfollow"</span><span>)</span></p></td></tr></tbody></table></div>




<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="248" height="457" data-attachment-id="1206" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/social-graph-3/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-3.png?fit=248%2C457&amp;ssl=1" data-orig-size="248,457" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="social-graph-3" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-3.png?fit=163%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-3.png?fit=248%2C457&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-3.png?resize=248%2C457&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-3.png?w=248&amp;ssl=1 248w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-3.png?resize=163%2C300&amp;ssl=1 163w" sizes="(max-width: 248px) 100vw, 248px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-3.png?w=248&amp;ssl=1 248w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-3.png?resize=163%2C300&amp;ssl=1 163w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-3.png?resize=248%2C457&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>This uses

<code>hook</code>

to create a branch off the root of processing for this depot that was defined in the previous code section. The

<code>keepTrue</code>

line continues processing on this branch only for block events. It then generates implicit events to unfollow in both directions and remove a follow request if it exists. Lastly, the “ImplicitUnfollow” anchor is declared which will later be used to merge this branch together with “Normal” and other branches.</p>



<p>The next section defines the branch handling accepting a follow request:</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br></p></td><td><p>.<span>hook</span><span>(</span><span>"SocialGraphRoot"</span><span>)</span><br>
.<span>keepTrue</span><span>(</span><span>new</span> Expr<span>(</span>Ops.<span>IS_INSTANCE_OF</span>, AcceptFollowRequest.<span>class</span>, <span>"*initialData"</span><span>)</span><span>)</span><br>
.<span>macro</span><span>(</span>extractFields<span>(</span><span>"*initialData"</span>, <span>"*accountId"</span>, <span>"*requesterId"</span><span>)</span><span>)</span><br>
.<span>localSelect</span><span>(</span><span>"$$accountIdToFollowRequests"</span>, Path.<span>key</span><span>(</span><span>"*accountId"</span><span>)</span>.<span>must</span><span>(</span><span>"*requesterId"</span><span>)</span><span>)</span>.<span>out</span><span>(</span><span>"*followRequestId"</span><span>)</span><br>
.<span>localSelect</span><span>(</span><span>"$$accountIdToFollowRequestsById"</span>, Path.<span>key</span><span>(</span><span>"*accountId"</span>, <span>"*followRequestId"</span><span>)</span><span>)</span>.<span>out</span><span>(</span><span>"*followRequest"</span><span>)</span><br>
.<span>hashPartition</span><span>(</span><span>"*requesterId"</span><span>)</span><br>
.<span>each</span><span>(</span><span>(</span>AcceptFollowRequest data, FollowLockedAccount req<span>)</span> <span>-&gt;</span> <span>{</span><br>
&nbsp; &nbsp; FollowAccount follow <span>=</span> <span>new</span> FollowAccount<span>(</span>data.<span>getRequesterId</span><span>(</span><span>)</span>, data.<span>getAccountId</span><span>(</span><span>)</span>, data.<span>getTimestamp</span><span>(</span><span>)</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; <span>if</span> <span>(</span>req.<span>isSetShowBoosts</span><span>(</span><span>)</span><span>)</span> follow.<span>setShowBoosts</span><span>(</span>req.<span>showBoosts</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; <span>if</span> <span>(</span>req.<span>isSetNotify</span><span>(</span><span>)</span><span>)</span> follow.<span>setNotify</span><span>(</span>req.<span>notify</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; <span>if</span> <span>(</span>req.<span>isSetLanguages</span><span>(</span><span>)</span><span>)</span> follow.<span>setLanguages</span><span>(</span>req.<span>languages</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; <span>return</span> follow<span>;</span><br>
<span>}</span> , <span>"*initialData"</span>, <span>"*followRequest"</span><span>)</span>.<span>out</span><span>(</span><span>"*data"</span><span>)</span><br>
.<span>anchor</span><span>(</span><span>"CompleteFollowRequest"</span><span>)</span></p></td></tr></tbody></table></div>




<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="378" height="457" data-attachment-id="1209" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/social-graph-4/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-4.png?fit=378%2C457&amp;ssl=1" data-orig-size="378,457" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="social-graph-4" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-4.png?fit=248%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-4.png?fit=378%2C457&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-4.png?resize=378%2C457&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-4.png?w=378&amp;ssl=1 378w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-4.png?resize=248%2C300&amp;ssl=1 248w" sizes="(max-width: 378px) 100vw, 378px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-4.png?w=378&amp;ssl=1 378w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-4.png?resize=248%2C300&amp;ssl=1 248w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-4.png?resize=378%2C457&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>This code is structured just like the previous sections by hooking onto the root and then filtering for the data type of interest. Then, this code checks to see if that follow request still exists since a user could retract their follow request at the same time it was accepted. The

<code>must</code>

navigator stops this branch of computation if the follow request no longer exists.</p>



<p>After that, the code generates the implicit

<code>Follow</code>

event which will later perform the actual logic of updating the

<code>$$followerToFollowees</code>

and

<code>$$followeeToFollowers</code>

PStates.</p>



<p>The next section handles follows to a locked account. As a reminder, a locked account requires all followers to be manually approved.</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br></p></td><td><p>.<span>hook</span><span>(</span><span>"SocialGraphRoot"</span><span>)</span><br>
.<span>keepTrue</span><span>(</span><span>new</span> Expr<span>(</span>Ops.<span>IS_INSTANCE_OF</span>, FollowLockedAccount.<span>class</span>, <span>"*initialData"</span><span>)</span><span>)</span><br>
.<span>macro</span><span>(</span>extractFields<span>(</span><span>"*initialData"</span>, <span>"*accountId"</span>, <span>"*requesterId"</span><span>)</span><span>)</span><br>
.<span>localSelect</span><span>(</span><span>"$$followeeToFollowers"</span>, Path.<span>key</span><span>(</span><span>"*accountId"</span>, <span>"*requesterId"</span><span>)</span><span>)</span>.<span>out</span><span>(</span><span>"*existingFollowerId"</span><span>)</span><br>
.<span>ifTrue</span><span>(</span><span>new</span> Expr<span>(</span>Ops.<span>IS_NOT_NULL</span>, <span>"*existingFollowerId"</span><span>)</span>,<br>
&nbsp; &nbsp;Block.<span>each</span><span>(</span><span>(</span>FollowLockedAccount data<span>)</span> <span>-&gt;</span> <span>{</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FollowAccount follow <span>=</span> <span>new</span> FollowAccount<span>(</span>data.<span>requesterId</span>, data.<span>accountId</span>, data.<span>timestamp</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>if</span><span>(</span>data.<span>isSetShowBoosts</span><span>(</span><span>)</span><span>)</span> follow.<span>setShowBoosts</span><span>(</span>data.<span>isShowBoosts</span><span>(</span><span>)</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>if</span><span>(</span>data.<span>isSetNotify</span><span>(</span><span>)</span><span>)</span> follow.<span>setNotify</span><span>(</span>data.<span>isNotify</span><span>(</span><span>)</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>if</span><span>(</span>data.<span>isSetLanguages</span><span>(</span><span>)</span><span>)</span> follow.<span>setLanguages</span><span>(</span>data.<span>getLanguages</span><span>(</span><span>)</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>return</span> follow<span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; <span>}</span>, <span>"*initialData"</span><span>)</span>.<span>out</span><span>(</span><span>"*data"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; .<span>hashPartition</span><span>(</span><span>"*requesterId"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; .<span>anchor</span><span>(</span><span>"UpdatePrivateFollow"</span><span>)</span>,<br>
&nbsp; &nbsp;Block.<span>macro</span><span>(</span>extractFields<span>(</span><span>"*initialData"</span>, <span>"*accountId"</span>, <span>"*requesterId"</span><span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; .<span>macro</span><span>(</span>accountIdToFollowRequests.<span>addToLinkedSet</span><span>(</span><span>"*accountId"</span>, <span>"*initialData"</span><span>)</span><span>)</span><span>)</span></p></td></tr></tbody></table></div>




<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="539" height="1024" data-attachment-id="1211" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/social-graph-5/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-5.png?fit=618%2C1175&amp;ssl=1" data-orig-size="618,1175" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="social-graph-5" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-5.png?fit=158%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-5.png?fit=539%2C1024&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-5.png?resize=539%2C1024&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-5.png?resize=539%2C1024&amp;ssl=1 539w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-5.png?resize=158%2C300&amp;ssl=1 158w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-5.png?w=618&amp;ssl=1 618w" sizes="(max-width: 539px) 100vw, 539px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-5.png?resize=539%2C1024&amp;ssl=1 539w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-5.png?resize=158%2C300&amp;ssl=1 158w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-5.png?w=618&amp;ssl=1 618w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-5.png?resize=539%2C1024&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>When a follow request is done in the UI to a locked account, a

<code>FollowLockedAccount</code>

event is appended to the depot. Otherwise, a

<code>FollowAccount</code>

event is appended.</p>



<p>Follow relationships contain additional information such as whether the follower wants to see boosts from the followee and whether they only want to see statuses in a certain language from the followee (another one of Mastodon’s features). Updating these settings is done via another

<code>Follow</code>

or

<code>FollowLockedAccount</code>

event.</p>



<p>This code uses

<code>ifTrue</code>

to determine if the follower already follows the followee.

<code>ifTrue</code>

works just like

<code>if</code>

in any programming language, with a “then” block and an optional “else” block. If the follow relationship exists, it creates an implicit

<code>FollowAccount</code>

event to update the options on the relationship. The “UpdatePrivateFollow” anchor is used later to merge that branch just like the previous sections.</p>



<div><p>If the follow relationship does not already exist, then the PState tracking follow requests is updated.</p>
<p>The next section merges the prior branches together and begins processing for the rest of the events, whether they came directly off the depot or were created implicitly by one of the branches:</p>
</div>




<div><table><tbody><tr><td><p>1<br>2<br></p></td><td><p>.<span>unify</span><span>(</span><span>"Normal"</span>, <span>"ImplicitUnfollow"</span>, <span>"CompleteFollowRequest"</span>, <span>"UpdatePrivateFollow"</span><span>)</span><br>
.<span>subSource</span><span>(</span><span>"*data"</span>,</p></td></tr></tbody></table></div>




<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="512" height="1024" data-attachment-id="1213" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/social-graph-6/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-6.png?fit=587%2C1175&amp;ssl=1" data-orig-size="587,1175" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="social-graph-6" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-6.png?fit=150%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-6.png?fit=512%2C1024&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-6.png?resize=512%2C1024&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-6.png?resize=512%2C1024&amp;ssl=1 512w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-6.png?resize=150%2C300&amp;ssl=1 150w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-6.png?w=587&amp;ssl=1 587w" sizes="(max-width: 512px) 100vw, 512px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-6.png?resize=512%2C1024&amp;ssl=1 512w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-6.png?resize=150%2C300&amp;ssl=1 150w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-6.png?w=587&amp;ssl=1 587w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-6.png?resize=512%2C1024&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>

<code>unify</code>

merges the specified branches together so they share subsequent computation. Any variables that are in scope in all specified branches are in scope in the code following the

<code>unify</code>

call.</p>



<p>The

<code>subSource</code>

call dispatches subsequent code on the type of the object in

<code>*data</code>

. The following code defines the handling for

<code>FollowAccount</code>

events:</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br></p></td><td><p>SubSource.<span>create</span><span>(</span>FollowAccount.<span>class</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>macro</span><span>(</span>extractFields<span>(</span><span>"*data"</span>, <span>"*accountId"</span>, <span>"*targetId"</span>, <span>"*followerSharedInboxUrl"</span>, <span>"*showBoosts"</span>, <span>"*notify"</span>, <span>"*languages"</span><span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>localSelect</span><span>(</span><span>"$$followerToFollowees"</span>, Path.<span>key</span><span>(</span><span>"*accountId"</span><span>)</span>.<span>view</span><span>(</span>Ops.<span>SIZE</span><span>)</span><span>)</span>.<span>out</span><span>(</span><span>"*followeeCount"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>keepTrue</span><span>(</span><span>new</span> Expr<span>(</span>Ops.<span>LESS_THAN</span>, <span>"*followeeCount"</span>, relationshipCountLimit<span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>localSelect</span><span>(</span><span>"$$followerToFollowees"</span>, Path.<span>key</span><span>(</span><span>"*accountId"</span>, <span>"*targetId"</span><span>)</span><span>)</span>.<span>out</span><span>(</span><span>"*followeeId"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>localSelect</span><span>(</span><span>"$$followerToFolloweesById"</span>, Path.<span>key</span><span>(</span><span>"*accountId"</span>, <span>"*followeeId"</span><span>)</span><span>)</span>.<span>out</span><span>(</span><span>"*existingFollowee"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>each</span><span>(</span>Relationships<span>::</span>makeFollower, <span>"*targetId"</span>, <span>"*showBoosts"</span>, <span>"*languages"</span>, <span>"*followerSharedInboxUrl"</span>, <span>"*existingFollowee"</span><span>)</span>.<span>out</span><span>(</span><span>"*followee"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>macro</span><span>(</span>followerToFollowees.<span>addToLinkedSet</span><span>(</span><span>"*accountId"</span>, <span>"*followee"</span><span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>hashPartition</span><span>(</span><span>"*targetId"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>localSelect</span><span>(</span><span>"$$followeeToFollowers"</span>, Path.<span>key</span><span>(</span><span>"*targetId"</span>, <span>"*accountId"</span><span>)</span><span>)</span>.<span>out</span><span>(</span><span>"*followerId"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>localSelect</span><span>(</span><span>"$$followeeToFollowersById"</span>, Path.<span>key</span><span>(</span><span>"*targetId"</span>, <span>"*followerId"</span><span>)</span><span>)</span>.<span>out</span><span>(</span><span>"*existingFollower"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>each</span><span>(</span>Relationships<span>::</span>makeFollower, <span>"*accountId"</span>, <span>"*showBoosts"</span>, <span>"*languages"</span>, <span>"*followerSharedInboxUrl"</span>, <span>"*existingFollower"</span><span>)</span>.<span>out</span><span>(</span><span>"*follower"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>macro</span><span>(</span>followeeToFollowers.<span>addToLinkedSet</span><span>(</span><span>"*targetId"</span>, <span>"*follower"</span><span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>macro</span><span>(</span>accountIdToFollowRequests.<span>removeFromLinkedSetByEntityId</span><span>(</span><span>"*targetId"</span>, <span>"*accountId"</span><span>)</span><span>)</span>,</p></td></tr></tbody></table></div>




<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="974" data-attachment-id="1215" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/social-graph-7/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-7.png?fit=844%2C1252&amp;ssl=1" data-orig-size="844,1252" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="social-graph-7" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-7.png?fit=202%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-7.png?fit=656%2C974&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-7.png?resize=656%2C974&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-7.png?resize=690%2C1024&amp;ssl=1 690w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-7.png?resize=202%2C300&amp;ssl=1 202w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-7.png?resize=768%2C1139&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-7.png?w=844&amp;ssl=1 844w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-7.png?resize=690%2C1024&amp;ssl=1 690w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-7.png?resize=202%2C300&amp;ssl=1 202w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-7.png?resize=768%2C1139&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-7.png?w=844&amp;ssl=1 844w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-7.png?resize=656%2C974&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>This code adds the relationship to the

<code>$$followerToFollowees</code>

and

<code>$$followerToFollowees</code>

PStates. If the relationship already exists, it updates the options on the relationship. It also removes any corresponding follow request from

<code>$$accountIdToFollowRequests</code>

if it exists.</p>



<p>

<code>relationshipCountLimit</code>

puts an upper limit on the number of follows someone can have and is set to a very conservative limit of 100,000. It exists to prevent abuse of the system.</p>



<p>The next section handles

<code>RemoveFollowAccount</code>

events:</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br>6<br>7<br></p></td><td><p>SubSource.<span>create</span><span>(</span>RemoveFollowAccount.<span>class</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>macro</span><span>(</span>extractFields<span>(</span><span>"*data"</span>, <span>"*accountId"</span>, <span>"*targetId"</span>, <span>"*followerSharedInboxUrl"</span><span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>hashPartition</span><span>(</span><span>"*accountId"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>macro</span><span>(</span>followerToFollowees.<span>removeFromLinkedSetByEntityId</span><span>(</span><span>"*accountId"</span>, <span>"*targetId"</span><span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>hashPartition</span><span>(</span><span>"*targetId"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>macro</span><span>(</span>followeeToFollowers.<span>removeFromLinkedSetByEntityId</span><span>(</span><span>"*targetId"</span>, <span>"*accountId"</span><span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>macro</span><span>(</span>accountIdToFollowRequests.<span>removeFromLinkedSetByEntityId</span><span>(</span><span>"*targetId"</span>, <span>"*accountId"</span><span>)</span><span>)</span>,</p></td></tr></tbody></table></div>




<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="960" data-attachment-id="1218" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/social-graph-8/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-8.png?fit=833%2C1219&amp;ssl=1" data-orig-size="833,1219" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="social-graph-8" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-8.png?fit=205%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-8.png?fit=656%2C960&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-8.png?resize=656%2C960&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-8.png?resize=700%2C1024&amp;ssl=1 700w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-8.png?resize=205%2C300&amp;ssl=1 205w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-8.png?resize=768%2C1124&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-8.png?w=833&amp;ssl=1 833w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-8.png?resize=700%2C1024&amp;ssl=1 700w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-8.png?resize=205%2C300&amp;ssl=1 205w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-8.png?resize=768%2C1124&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-8.png?w=833&amp;ssl=1 833w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-8.png?resize=656%2C960&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<div><p>This code just removes the relationship from all relevant PStates.</p>
<p>Here is the next section:</p>
</div>




<div><table><tbody><tr><td><p>1<br>2<br>3<br></p></td><td><div><p>SubSource.<span>create</span><span>(</span>FollowLockedAccount.<span>class</span><span>)</span>,</p><p>

SubSource.<span>create</span><span>(</span>AcceptFollowRequest.<span>class</span><span>)</span>,</p></div></td></tr></tbody></table></div>




<p>This handles events coming off the depot that were handled already in one of the top-level branches we already looked at.

<code>subSource</code>

requires every data type it sees to have a handler, so this code says to do nothing for those types.</p>



<p>The next section handles

<code>RejectFollowRequest</code>

:</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br></p></td><td><p>SubSource.<span>create</span><span>(</span>RejectFollowRequest.<span>class</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>macro</span><span>(</span>extractFields<span>(</span><span>"*data"</span>, <span>"*accountId"</span>, <span>"*requesterId"</span><span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>macro</span><span>(</span>accountIdToFollowRequests.<span>removeFromLinkedSetByEntityId</span><span>(</span><span>"*accountId"</span>, <span>"*requesterId"</span><span>)</span><span>)</span>,</p></td></tr></tbody></table></div>




<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="960" data-attachment-id="1221" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/social-graph-9/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-9.png?fit=833%2C1219&amp;ssl=1" data-orig-size="833,1219" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="social-graph-9" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-9.png?fit=205%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-9.png?fit=656%2C960&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-9.png?resize=656%2C960&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-9.png?resize=700%2C1024&amp;ssl=1 700w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-9.png?resize=205%2C300&amp;ssl=1 205w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-9.png?resize=768%2C1124&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-9.png?w=833&amp;ssl=1 833w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-9.png?resize=700%2C1024&amp;ssl=1 700w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-9.png?resize=205%2C300&amp;ssl=1 205w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-9.png?resize=768%2C1124&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-9.png?w=833&amp;ssl=1 833w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-9.png?resize=656%2C960&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>This just removes the follow request from the PState.</p>



<p>The next section handles

<code>BlockAccount</code>

:</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br></p></td><td><p>SubSource.<span>create</span><span>(</span>BlockAccount.<span>class</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>macro</span><span>(</span>extractFields<span>(</span><span>"*data"</span>, <span>"*accountId"</span>, <span>"*targetId"</span>, <span>"*timestamp"</span><span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>localSelect</span><span>(</span><span>"$$accountIdToSuppressions"</span>, Path.<span>key</span><span>(</span><span>"*accountId"</span>, <span>"blocked"</span><span>)</span>.<span>view</span><span>(</span>Ops.<span>SIZE</span><span>)</span><span>)</span>.<span>out</span><span>(</span><span>"*blockeeCount"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>keepTrue</span><span>(</span><span>new</span> Expr<span>(</span>Ops.<span>LESS_THAN</span>, <span>"*blockeeCount"</span>, relationshipCountLimit<span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>localTransform</span><span>(</span><span>"$$accountIdToSuppressions"</span>, Path.<span>key</span><span>(</span><span>"*accountId"</span>, <span>"blocked"</span><span>)</span>.<span>voidSetElem</span><span>(</span><span>)</span>.<span>termVal</span><span>(</span><span>"*targetId"</span><span>)</span><span>)</span>,</p></td></tr></tbody></table></div>




<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="914" data-attachment-id="1223" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/social-graph-10/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-10.png?fit=875%2C1219&amp;ssl=1" data-orig-size="875,1219" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="social-graph-10" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-10.png?fit=215%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-10.png?fit=656%2C914&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-10.png?resize=656%2C914&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-10.png?resize=735%2C1024&amp;ssl=1 735w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-10.png?resize=215%2C300&amp;ssl=1 215w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-10.png?resize=768%2C1070&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-10.png?w=875&amp;ssl=1 875w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-10.png?resize=735%2C1024&amp;ssl=1 735w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-10.png?resize=215%2C300&amp;ssl=1 215w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-10.png?resize=768%2C1070&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-10.png?w=875&amp;ssl=1 875w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-10.png?resize=656%2C914&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>

<code>BlockAccount</code>

was handled in one of the initial branches to generate the implicit unfollows between the two accounts. Here,

<code>BlockAccount</code>

is handled again to record the block relationship in the

<code>$$accountIdToSuppressions</code>

PState.</p>



<p>The next section handles

<code>RemoveBlockAccount</code>

events:</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br></p></td><td><p>SubSource.<span>create</span><span>(</span>RemoveBlockAccount.<span>class</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>macro</span><span>(</span>extractFields<span>(</span><span>"*data"</span>, <span>"*accountId"</span>, <span>"*targetId"</span><span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>localTransform</span><span>(</span><span>"$$accountIdToSuppressions"</span>, Path.<span>key</span><span>(</span><span>"*accountId"</span>, <span>"blocked"</span><span>)</span>.<span>setElem</span><span>(</span><span>"*targetId"</span><span>)</span>.<span>termVoid</span><span>(</span><span>)</span><span>)</span><span>)</span><span>;</span></p></td></tr></tbody></table></div>




<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="914" data-attachment-id="1226" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/social-graph-11/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-11.png?fit=875%2C1219&amp;ssl=1" data-orig-size="875,1219" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="social-graph-11" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-11.png?fit=215%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-11.png?fit=656%2C914&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-11.png?resize=656%2C914&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-11.png?resize=735%2C1024&amp;ssl=1 735w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-11.png?resize=215%2C300&amp;ssl=1 215w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-11.png?resize=768%2C1070&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-11.png?w=875&amp;ssl=1 875w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-11.png?resize=735%2C1024&amp;ssl=1 735w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-11.png?resize=215%2C300&amp;ssl=1 215w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-11.png?resize=768%2C1070&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-11.png?w=875&amp;ssl=1 875w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-11.png?resize=656%2C914&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>All this does is remove the block relationship from the

<code>$$accountIdToSuppressions</code>

PState.</p>



<p>That’s all the code for handling social graph updates from events on

<code>followAndBlockAccountDepot</code>

. The next section contains all the logic for handling events from

<code>muteAccountDepot</code>

:</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br></p></td><td><p>stream.<span>source</span><span>(</span><span>"*muteAccountDepot"</span>, StreamSourceOptions.<span>retryAllAfter</span><span>(</span><span>)</span><span>)</span>.<span>out</span><span>(</span><span>"*data"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; .<span>subSource</span><span>(</span><span>"*data"</span>,<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SubSource.<span>create</span><span>(</span>MuteAccount.<span>class</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<span>macro</span><span>(</span>extractFields<span>(</span><span>"*data"</span>, <span>"*accountId"</span>, <span>"*targetId"</span>, <span>"*options"</span><span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<span>localSelect</span><span>(</span><span>"$$accountIdToSuppressions"</span>, Path.<span>key</span><span>(</span><span>"*accountId"</span>, <span>"muted"</span><span>)</span>.<span>view</span><span>(</span>Ops.<span>SIZE</span><span>)</span><span>)</span>.<span>out</span><span>(</span><span>"*muteeCount"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<span>keepTrue</span><span>(</span><span>new</span> Expr<span>(</span>Ops.<span>LESS_THAN</span>, <span>"*muteeCount"</span>, relationshipCountLimit<span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<span>localTransform</span><span>(</span><span>"$$accountIdToSuppressions"</span>, Path.<span>key</span><span>(</span><span>"*accountId"</span>, <span>"muted"</span>, <span>"*targetId"</span><span>)</span>.<span>termVal</span><span>(</span><span>"*options"</span><span>)</span><span>)</span>,<br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SubSource.<span>create</span><span>(</span>RemoveMuteAccount.<span>class</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<span>macro</span><span>(</span>extractFields<span>(</span><span>"*data"</span>, <span>"*accountId"</span>, <span>"*targetId"</span><span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<span>localTransform</span><span>(</span><span>"$$accountIdToSuppressions"</span>, Path.<span>key</span><span>(</span><span>"*accountId"</span>, <span>"muted"</span>, <span>"*targetId"</span><span>)</span>.<span>termVoid</span><span>(</span><span>)</span><span>)</span><span>)</span><span>;</span></p></td></tr></tbody></table></div>




<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="656" height="685" data-attachment-id="1229" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/social-graph-12/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-12.png?fit=1167%2C1219&amp;ssl=1" data-orig-size="1167,1219" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="social-graph-12" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-12.png?fit=287%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-12.png?fit=656%2C685&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-12.png?resize=656%2C685&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-12.png?resize=980%2C1024&amp;ssl=1 980w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-12.png?resize=287%2C300&amp;ssl=1 287w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-12.png?resize=768%2C802&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-12.png?w=1167&amp;ssl=1 1167w" sizes="(max-width: 656px) 100vw, 656px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-12.png?resize=980%2C1024&amp;ssl=1 980w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-12.png?resize=287%2C300&amp;ssl=1 287w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-12.png?resize=768%2C802&amp;ssl=1 768w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-12.png?w=1167&amp;ssl=1 1167w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/social-graph-12.png?resize=656%2C685&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>This is really simple, as all it does is add the mute relationship for

<code>MuteAccount</code>

events and remove the relationship for

<code>RemoveMuteAccount</code>

events.</p>



<p>That’s the complete implementation of the social graph! As you can see, it’s expressed exactly as you saw in the dataflow diagram with branches, merges, and dispatching on the types of events.</p>



<p>It’s worth noting that dataflow code compiles to efficient bytecode when deployed, as efficient as regular Java code. So Rama variables like

<code>*accountId</code>

and

<code>*targetId</code>

become actual variables in the generated bytecode.</p>



<div><p>The code for this ETL is also a great example of why it’s so beneficial to interact with your data layer with an API in a general-purpose language instead of a custom language (like SQL). This code makes use of normal programming practices to factor out reusable functionality or to separate code into separate functions to make it easier to read. This code also demonstrates how easy it is to intermix logic written in Java with logic written in Rama’s dataflow API. Method references, lambdas, and macros are facilities for combining the two.</p>
<p>Let’s look at some of the Mastodon API implementation related to the social graph so you can see how you interact with a Rama cluster to serve the frontend. Here’s how a new unfollow event is added:</p>
</div>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br></p></td><td><p><span>public</span> CompletableFuture<span>&lt;</span>Boolean<span>&gt;</span> postRemoveFollowAccount<span>(</span><span>long</span> followerId, <span>long</span> followeeId, <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+string"><span>String</span></a> sharedInboxUrl<span>)</span> <span>{</span><br>
&nbsp; &nbsp; RemoveFollowAccount removeFollowAccount <span>=</span> <span>new</span> RemoveFollowAccount<span>(</span>followerId, followeeId, <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+system"><span>System</span></a>.<span>currentTimeMillis</span><span>(</span><span>)</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; <span>if</span> <span>(</span>sharedInboxUrl <span>!=</span> <span>null</span><span>)</span> removeFollowAccount.<span>setFollowerSharedInboxUrl</span><span>(</span>sharedInboxUrl<span>)</span><span>;</span><br>
&nbsp; &nbsp; <span>return</span> followAndBlockAccountDepot.<span>appendAsync</span><span>(</span>removeFollowAccount<span>)</span>.<span>thenApply</span><span>(</span>res <span>-&gt;</span> <span>true</span><span>)</span><span>;</span><br>
<span>}</span></p></td></tr></tbody></table></div>




<p>This uses the async API for depots to append unfollow data to

<code>followAndBlockAccountDepot</code>

. Rama’s async API is used almost exclusively in the Mastodon API implementation so as not to block any threads (which would be an inefficient use of resources).</p>



<p>Here’s how a follow event is handled, conditioning the type of data appended depending on if the account is locked or not:</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br>16<br>17<br>18<br>19<br>20<br>21<br>22<br>23<br></p></td><td><p><span>public</span> CompletableFuture<span>&lt;</span>Boolean<span>&gt;</span> postFollowAccount<span>(</span><span>long</span> followerId, <span>long</span> followeeId, <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+string"><span>String</span></a> sharedInboxUrl, PostFollow params<span>)</span> <span>{</span><br>
&nbsp; &nbsp; <span>return</span> getAccountWithId<span>(</span>followeeId<span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; .<span>thenCompose</span><span>(</span><span>(</span>followee<span>)</span> <span>-&gt;</span> <span>{</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>if</span> <span>(</span>followee <span>!=</span> <span>null</span> <span>&amp;&amp;</span> followee.<span>account</span> <span>!=</span> <span>null</span> <span>&amp;&amp;</span> followee.<span>account</span>.<span>locked</span><span>)</span> <span>{</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FollowLockedAccount req <span>=</span> <span>new</span> FollowLockedAccount<span>(</span>followeeId, followerId, <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+system"><span>System</span></a>.<span>currentTimeMillis</span><span>(</span><span>)</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>if</span> <span>(</span>params <span>!=</span> <span>null</span><span>)</span> <span>{</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>if</span> <span>(</span>params.<span>reblogs</span> <span>!=</span> <span>null</span><span>)</span> req.<span>setShowBoosts</span><span>(</span>params.<span>reblogs</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>if</span> <span>(</span>params.<span>notify</span> <span>!=</span> <span>null</span><span>)</span> req.<span>setNotify</span><span>(</span>params.<span>notify</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>if</span> <span>(</span>params.<span>languages</span> <span>!=</span> <span>null</span><span>)</span> req.<span>setLanguages</span><span>(</span>params.<span>languages</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>}</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>return</span> followAndBlockAccountDepot.<span>appendAsync</span><span>(</span>req<span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>}</span> <span>else</span> <span>{</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; FollowAccount req <span>=</span> <span>new</span> FollowAccount<span>(</span>followerId, followeeId, <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+system"><span>System</span></a>.<span>currentTimeMillis</span><span>(</span><span>)</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>if</span> <span>(</span>params <span>!=</span> <span>null</span><span>)</span> <span>{</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>if</span> <span>(</span>params.<span>reblogs</span> <span>!=</span> <span>null</span> <span>)</span> req.<span>setShowBoosts</span><span>(</span>params.<span>reblogs</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>if</span> <span>(</span>params.<span>notify</span> <span>!=</span> <span>null</span><span>)</span> req.<span>setNotify</span><span>(</span>params.<span>notify</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>if</span> <span>(</span>params.<span>languages</span> <span>!=</span> <span>null</span><span>)</span> req.<span>setLanguages</span><span>(</span>params.<span>languages</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>}</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>if</span> <span>(</span>sharedInboxUrl <span>!=</span> <span>null</span><span>)</span> req.<span>setFollowerSharedInboxUrl</span><span>(</span>sharedInboxUrl<span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>return</span> followAndBlockAccountDepot.<span>appendAsync</span><span>(</span>req<span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>}</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; <span>}</span><span>)</span>.<span>thenApply</span><span>(</span>res <span>-&gt;</span> <span>true</span><span>)</span><span>;</span><br>
<span>}</span></p></td></tr></tbody></table></div>




<p>This first calls the helper function

<code>getAccountWithId</code>

which uses a query topology to get all information about that account. If the account is locked, a

<code>FollowLockedAccount</code>

is appended with any options appropriately set. Otherwise, a

<code>FollowAccount</code>

events is appended.</p>



<p>The helper function

<code>getAccountWithId</code>

is implemented like this:</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br></p></td><td><div><p><span>public</span> CompletableFuture<span>&lt;</span>AccountWithId<span>&gt;</span> getAccountWithId<span>(</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+long"><span>Long</span></a> requestAccountIdMaybe, <span>long</span> accountId<span>)</span> <span>{</span><br>
&nbsp; &nbsp; <span>return</span> getAccountsFromAccountIds.<span>invokeAsync</span><span>(</span>requestAccountIdMaybe, <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+arrays"><span>Arrays</span></a>.<span>asList</span><span>(</span>accountId<span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .<span>thenApply</span><span>(</span>accounts <span>-&gt;</span> <span>{</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>if</span> <span>(</span>accounts.<span>size</span><span>(</span><span>)</span> <span>==</span> <span>0</span><span>)</span> <span>return</span> <span>null</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>return</span> accounts.<span>get</span><span>(</span><span>0</span><span>)</span><span>;</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <span>}</span><span>)</span><span>;</span><br>
<span>}</span></p><p>

<span>public</span> CompletableFuture<span>&lt;</span>AccountWithId<span>&gt;</span> getAccountWithId<span>(</span><span>long</span> accountId<span>)</span> <span>{</span><br>
&nbsp; &nbsp; <span>return</span> <span>this</span>.<span>getAccountWithId</span><span>(</span><span>null</span>, accountId<span>)</span><span>;</span><br>
<span>}</span></p></div></td></tr></tbody></table></div>




<p>The query topology can optionally be invoked with a “requesting account ID”, because in some circumstances an account should not be visible to another account (e.g. the requesting account is blocked by that user). In this case, it just needs to check if the account is locked or not so it passes

<code>null</code>

for the requesting account ID. The query topology client is fetched like so:</p>




<div><table><tbody><tr><td><p>1<br></p></td><td><p>QueryTopologyClient<span>&lt;</span>List<span>&gt;</span> getAccountsFromAccountIds <span>=</span> cluster.<span>clusterQuery</span><span>(</span><span>"com.rpl.mastodon.modules.Core"</span>, <span>"getAccountsFromAccountIds"</span><span>)</span><span>;</span></p></td></tr></tbody></table></div>




<p>As you can see, a query topology client is fetched just like how you fetch a handle to a depot or PState. Invoking a query topology is like invoking a regular function –&nbsp;you pass it some arguments and you get a result back. Unlike a regular function, a query topology executes on a cluster across potentially many nodes. Here the result is received asynchronously, but you can also do a blocking call with

<code>invoke</code>

.</p>



<h3 id="Timeline_fanout_code">Timeline fanout code</h3>



<p>Lastly, let’s look at the code implementing timeline fanout, as described <a href="#timeline-fanout">earlier</a>. This implementation is only 51 lines of code. As a reminder, here’s the dataflow diagram for timeline fanout:</p>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="549" height="1024" data-attachment-id="1285" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/timeline-fanout-10/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-10.png?fit=742%2C1384&amp;ssl=1" data-orig-size="742,1384" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="timeline-fanout-10" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-10.png?fit=161%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-10.png?fit=549%2C1024&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-10.png?resize=549%2C1024&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-10.png?resize=549%2C1024&amp;ssl=1 549w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-10.png?resize=161%2C300&amp;ssl=1 161w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-10.png?w=742&amp;ssl=1 742w" sizes="(max-width: 549px) 100vw, 549px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-10.png?resize=549%2C1024&amp;ssl=1 549w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-10.png?resize=161%2C300&amp;ssl=1 161w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-10.png?w=742&amp;ssl=1 742w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-10.png?resize=549%2C1024&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>Once again, since this is a longer piece of code let’s look at it section by section. Let’s start with the subscription to the depot containing all the statuses:</p>




<div><table><tbody><tr><td><p>1<br>2<br></p></td><td><p>fan.<span>source</span><span>(</span><span>"*statusWithIdDepot"</span><span>)</span>.<span>out</span><span>(</span><span>"*microbatch"</span><span>)</span><br>
&nbsp; &nbsp;.<span>anchor</span><span>(</span><span>"FanoutRoot"</span><span>)</span></p></td></tr></tbody></table></div>




<p>Like in the social graph example, let’s see visually how the dataflow diagram gets filled out. This code starts off the dataflow diagram like this:</p>



<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="83" height="68" data-attachment-id="1239" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/timeline-fanout-1-1/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-1-1.png?fit=83%2C68&amp;ssl=1" data-orig-size="83,68" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="timeline-fanout-1-1" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-1-1.png?fit=83%2C68&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-1-1.png?fit=83%2C68&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-1-1.png?resize=83%2C68&amp;ssl=1" alt="" data-recalc-dims="1" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-1-1.png?resize=83%2C68&amp;is-pending-load=1#038;ssl=1" srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>Unlike the previous examples, this topology is implemented with microbatching. Microbatching guarantees exactly-once processing semantics even in the case of failures. That is, even if there are node or network outages and computation needs to be retried, the resulting PState updates will be as if each depot record was processed exactly once.</p>



<p>The variable

<code>*microbatch</code>

represents a batch of data across all partitions of the depot. This code simply binds that variable and marks the root of computation with the label “FanoutRoot”. As you can see in the dataflow diagram, there are two branches off the root of processing.</p>



<p>The next section implements the first branch, which handles continuing fanout for statuses with too many followers from the previous iteration:</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br></p></td><td><p>.<span>allPartition</span><span>(</span><span>)</span><br>
.<span>localSelect</span><span>(</span><span>"$$statusIdToLocalFollowerFanouts"</span>, Path.<span>all</span><span>(</span><span>)</span><span>)</span>.<span>out</span><span>(</span><span>"*keyAndVal"</span><span>)</span><br>
.<span>each</span><span>(</span>Ops.<span>EXPAND</span>, <span>"*keyAndVal"</span><span>)</span>.<span>out</span><span>(</span><span>"*statusId"</span>, <span>"*followerFanouts"</span><span>)</span><br>
.<span>localTransform</span><span>(</span><span>"$$statusIdToLocalFollowerFanouts"</span>, Path.<span>key</span><span>(</span><span>"*statusId"</span><span>)</span>.<span>termVoid</span><span>(</span><span>)</span><span>)</span><br>
.<span>each</span><span>(</span>Ops.<span>EXPLODE</span>, <span>"*followerFanouts"</span><span>)</span>.<span>out</span><span>(</span><span>"*followerFanout"</span><span>)</span><br>
.<span>macro</span><span>(</span>extractFields<span>(</span><span>"*followerFanout"</span>, <span>"*authorId"</span>, <span>"*nextIndex"</span>, <span>"*fanoutAction"</span>, <span>"*status"</span>, <span>"*task"</span><span>)</span><span>)</span><br>
.<span>each</span><span>(</span>FanoutAction<span>::</span>getValue, <span>"*fanoutAction"</span><span>)</span>.<span>out</span><span>(</span><span>"*fanoutActionValue"</span><span>)</span><br>
.<span>macro</span><span>(</span>extractFields<span>(</span><span>"*status"</span>, <span>"*content"</span>, <span>"*language"</span><span>)</span><span>)</span><br>
.<span>each</span><span>(</span><span>(</span>RamaFunction2<span>&lt;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+long"><span>Long</span></a>, <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+long"><span>Long</span></a>, StatusPointer<span>&gt;</span><span>)</span> StatusPointer<span>::</span><span>new</span>, <span>"*authorId"</span>, <span>"*statusId"</span><span>)</span>.<span>out</span><span>(</span><span>"*statusPointer"</span><span>)</span><br>
.<span>directPartition</span><span>(</span><span>"$$partitionedFollowers"</span>, <span>"*task"</span><span>)</span><br>
.<span>anchor</span><span>(</span><span>"LocalFollowerFanoutContinue"</span><span>)</span></p></td></tr></tbody></table></div>




<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="331" height="258" data-attachment-id="1241" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/timeline-fanout-2/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-2.png?fit=331%2C258&amp;ssl=1" data-orig-size="331,258" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="timeline-fanout-2" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-2.png?fit=300%2C234&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-2.png?fit=331%2C258&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-2.png?resize=331%2C258&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-2.png?w=331&amp;ssl=1 331w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-2.png?resize=300%2C234&amp;ssl=1 300w" sizes="(max-width: 331px) 100vw, 331px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-2.png?w=331&amp;ssl=1 331w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-2.png?resize=300%2C234&amp;ssl=1 300w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-2.png?resize=331%2C258&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>Whenever a status has too many followers for one iteration of fanout, it is added to the

<code>$$statusIdToLocalFollowerFanouts</code>

PState. This PState is a map from status ID to the type

<code>FollowerFanout</code>

, which contains the information needed to continue fanout starting with the next unhanded follower. As you can see in this code, it reads everything from that PState using

<code>Path.all()</code>

and then deletes everything from that PState.</p>



<p>As you’ll see later, adding to

<code>$$statusIdToLocalFollowerFanouts</code>

is done on whatever partition followers were read for that status. So this code uses

<code>allPartition</code>

to access every partition of the PState.

<code>allPartition</code>

is a partitioner like

<code>hashPartition</code>

, except instead of the subsequent code executing on one partition, the subsequent code executes on all partitions. This allows the ETL to fetch all statuses that required continued fanout from the last iteration. You have to be careful when using

<code>allPartition</code>

as you can create non-scalable topologies if you were to use it for every piece of data on a high throughput depot. In this case

<code>allPartition</code>

is used just once per iteration, so it doesn’t affect the scalability of the topology.</p>



<p>At the end of this block of code is some handling related to

<code>$$partitionedFollowers</code>

. We didn’t mention this PState in the earlier discussion of fanout, but it’s an additional optimization to balance load for handling of users with large amounts of followers. In short, this is an additional view of the social graph where users with more than 1,000 followers have their followers spread among multiple partitions of this PState. This balances the load of processing for fanout by reducing variance among partitions. We will be publishing another blog post in the future exploring this optimization and others.</p>



<p>The next section begins the other branch of processing at the root of the dataflow diagram:</p>




<div><table><tbody><tr><td><p>1<br>2<br></p></td><td><p>.<span>hook</span><span>(</span><span>"FanoutRoot"</span><span>)</span><br>
.<span>explodeMicrobatch</span><span>(</span><span>"*microbatch"</span><span>)</span>.<span>out</span><span>(</span><span>"*data"</span><span>)</span></p></td></tr></tbody></table></div>




<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="537" height="263" data-attachment-id="1244" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/timeline-fanout-3/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-3.png?fit=537%2C263&amp;ssl=1" data-orig-size="537,263" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="timeline-fanout-3" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-3.png?fit=300%2C147&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-3.png?fit=537%2C263&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-3.png?resize=537%2C263&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-3.png?w=537&amp;ssl=1 537w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-3.png?resize=300%2C147&amp;ssl=1 300w" sizes="(max-width: 537px) 100vw, 537px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-3.png?w=537&amp;ssl=1 537w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-3.png?resize=300%2C147&amp;ssl=1 300w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-3.png?resize=537%2C263&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>This creates the branch and reads all new statuses for this iteration from the microbatch.

<code>explodeMicrobatch</code>

here reads all data from the microbatch across all partitions and binds each piece of data to the variable

<code>*data</code>

. This operation emits across all partitions of the module.</p>



<p>The next section begins processing of new statuses:</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br></p></td><td><p>.<span>macro</span><span>(</span>extractFields<span>(</span><span>"*data"</span>, <span>"*statusId"</span>, <span>"*status"</span><span>)</span><span>)</span><br>
.<span>macro</span><span>(</span>extractFields<span>(</span><span>"*status"</span>, <span>"*authorId"</span>, <span>"*content"</span>, <span>"*language"</span><span>)</span><span>)</span><br>
.<span>each</span><span>(</span>MastodonHelpers<span>::</span>getStatusVisibility, <span>"*status"</span><span>)</span>.<span>out</span><span>(</span><span>"*visibility"</span><span>)</span><br>
.<span>keepTrue</span><span>(</span><span>new</span> Expr<span>(</span>Ops.<span>NOT_EQUAL</span>, <span>"*visibility"</span>, StatusVisibility.<span>Direct</span><span>)</span><span>)</span><br>
.<span>each</span><span>(</span>Ops.<span>IDENTITY</span>, <span>-</span>1L<span>)</span>.<span>out</span><span>(</span><span>"*nextIndex"</span><span>)</span><br>
.<span>each</span><span>(</span>Ops.<span>IDENTITY</span>, FanoutAction.<span>Add</span>.<span>getValue</span><span>(</span><span>)</span><span>)</span>.<span>out</span><span>(</span><span>"*fanoutActionValue"</span><span>)</span><br>
.<span>each</span><span>(</span><span>(</span>RamaFunction2<span>&lt;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+long"><span>Long</span></a>, <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+long"><span>Long</span></a>, StatusPointer<span>&gt;</span><span>)</span> StatusPointer<span>::</span><span>new</span>, <span>"*authorId"</span>, <span>"*statusId"</span><span>)</span>.<span>out</span><span>(</span><span>"*statusPointer"</span><span>)</span><br>
.<span>each</span><span>(</span>HomeTimelines<span>::</span>addTimelineItem, <span>"*homeTimelines"</span>, <span>"*authorId"</span>, <span>"*statusPointer"</span>, <span>new</span> Expr<span>(</span>Ops.<span>CURRENT_MICROBATCH_ID</span><span>)</span><span>)</span></p></td></tr></tbody></table></div>




<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="547" height="1024" data-attachment-id="1287" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/timeline-fanout-4-1/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-4-1.png?fit=733%2C1372&amp;ssl=1" data-orig-size="733,1372" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="timeline-fanout-4-1" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-4-1.png?fit=160%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-4-1.png?fit=547%2C1024&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-4-1.png?resize=547%2C1024&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-4-1.png?resize=547%2C1024&amp;ssl=1 547w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-4-1.png?resize=160%2C300&amp;ssl=1 160w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-4-1.png?w=733&amp;ssl=1 733w" sizes="(max-width: 547px) 100vw, 547px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-4-1.png?resize=547%2C1024&amp;ssl=1 547w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-4-1.png?resize=160%2C300&amp;ssl=1 160w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-4-1.png?w=733&amp;ssl=1 733w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-4-1.png?resize=547%2C1024&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>This code specifies to only perform fanout for statuses with visibility other than

<code>Direct</code>

, which is for direct messages and handled elsewhere. It then adds the status to the author’s own home timeline, which implements self-fanout.</p>



<p>The next section reads a batch of followers for the status:</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br></p></td><td><div><p>.<span>select</span><span>(</span><span>"$$partitionedFollowersControl"</span>, Path.<span>key</span><span>(</span><span>"*authorId"</span><span>)</span><span>)</span>.<span>out</span><span>(</span><span>"*tasks"</span><span>)</span><br>
.<span>each</span><span>(</span>Ops.<span>EXPLODE_INDEXED</span>, <span>"*tasks"</span><span>)</span>.<span>out</span><span>(</span><span>"*i"</span>, <span>"*task"</span><span>)</span><br>
.<span>ifTrue</span><span>(</span><span>new</span> Expr<span>(</span>Ops.<span>NOT_EQUAL</span>, <span>0</span>, <span>"*i"</span><span>)</span>, Block.<span>directPartition</span><span>(</span><span>"$$partitionedFollowers"</span>, <span>"*task"</span><span>)</span><span>)</span><br>
.<span>anchor</span><span>(</span><span>"NormalFanout"</span><span>)</span></p><p>

.<span>unify</span><span>(</span><span>"NormalFanout"</span>, <span>"LocalFollowerFanoutContinue"</span><span>)</span><br>
.<span>macro</span><span>(</span>safeFetchMapLocalFollowers<span>(</span><span>"$$partitionedFollowers"</span>, <span>"*authorId"</span>, <span>"*nextIndex"</span>, rangeQueryLimit, <span>"*fetchedFollowers"</span>, <span>"*nextFollowerId"</span><span>)</span><span>)</span><br>
.<span>ifTrue</span><span>(</span><span>new</span> Expr<span>(</span>Ops.<span>IS_NOT_NULL</span>, <span>"*nextFollowerId"</span><span>)</span>,<br>
&nbsp; &nbsp; &nbsp; &nbsp; Block.<span>each</span><span>(</span><span>(</span>RamaFunction5<span>&lt;</span><a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+long"><span>Long</span></a>, <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+long"><span>Long</span></a>, FanoutAction, Status, <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+integer"><span>Integer</span></a>, FollowerFanout<span>&gt;</span><span>)</span> FollowerFanout<span>::</span><span>new</span>, <span>"*authorId"</span>, <span>"*nextFollowerId"</span>, <span>new</span> Expr<span>(</span>FanoutAction<span>::</span>findByValue, <span>"*fanoutActionValue"</span><span>)</span>, <span>"*status"</span>, <span>"*task"</span><span>)</span>.<span>out</span><span>(</span><span>"*followerFanout"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>localTransform</span><span>(</span><span>"$$statusIdToLocalFollowerFanouts"</span>, Path.<span>key</span><span>(</span><span>"*statusId"</span><span>)</span>.<span>nullToList</span><span>(</span><span>)</span>.<span>afterElem</span><span>(</span><span>)</span>.<span>termVal</span><span>(</span><span>"*followerFanout"</span><span>)</span><span>)</span><span>)</span></p></div></td></tr></tbody></table></div>




<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="512" height="1024" data-attachment-id="1288" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/timeline-fanout-5-1/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-5-1.png?fit=690%2C1381&amp;ssl=1" data-orig-size="690,1381" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="timeline-fanout-5-1" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-5-1.png?fit=150%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-5-1.png?fit=512%2C1024&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-5-1.png?resize=512%2C1024&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-5-1.png?resize=512%2C1024&amp;ssl=1 512w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-5-1.png?resize=150%2C300&amp;ssl=1 150w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-5-1.png?w=690&amp;ssl=1 690w" sizes="(max-width: 512px) 100vw, 512px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-5-1.png?resize=512%2C1024&amp;ssl=1 512w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-5-1.png?resize=150%2C300&amp;ssl=1 150w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-5-1.png?w=690&amp;ssl=1 690w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-5-1.png?resize=512%2C1024&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>As mentioned earlier, in a future post we’ll explore the

<code>$$partitionedFollowers</code>

optimization. As will be explored in that future post, the first section of this code determines from which tasks to read followers in parallel for the status’s author.</p>
<p>The

<code>unify</code>

call merges processing for statuses from both last iteration and new statuses from this iteration.

<code>safeFetchMapLocalFollowers</code>

is a small helper function reading up to

<code>rangeQueryLimit</code>

followers from this partition for that author (

<code>rangeQueryLimit</code>

is a constant set to 1,000). Since followers are read in parallel across many partitions for users with more than 1,000 followers, and since we deployed this module with 64 partitions, this means up to 64k followers are read per status per iteration.</p>
<p>The

<code>ifTrue</code>

line writes to the

<code>$$statusIdToLocalFollowerFanouts</code>

PState to continue fanout next iteration if there are still more followers to handle. This is the same PState you saw used in the earlier section.</p>



<p>The next section handles follower-specified options on the types of statuses they wish to see from this author:</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br></p></td><td><p>.<span>each</span><span>(</span>Ops.<span>EXPLODE</span>, <span>"*fetchedFollowers"</span><span>)</span>.<span>out</span><span>(</span><span>"*follower"</span><span>)</span><br>
.<span>each</span><span>(</span><span>(</span>Follower follower<span>)</span> <span>-&gt;</span> follower.<span>accountId</span>, <span>"*follower"</span><span>)</span>.<span>out</span><span>(</span><span>"*followerId"</span><span>)</span><br>
.<span>each</span><span>(</span><span>(</span>Follower follower<span>)</span> <span>-&gt;</span> follower.<span>sharedInboxUrl</span>, <span>"*follower"</span><span>)</span>.<span>out</span><span>(</span><span>"*followerSharedInboxUrl"</span><span>)</span><br>
.<span>each</span><span>(</span><span>(</span>Follower follower<span>)</span> <span>-&gt;</span> follower.<span>isShowBoosts</span><span>(</span><span>)</span>, <span>"*follower"</span><span>)</span>.<span>out</span><span>(</span><span>"*showBoosts"</span><span>)</span><br>
.<span>each</span><span>(</span><span>(</span>Follower follower<span>)</span> <span>-&gt;</span> follower.<span>getLanguages</span><span>(</span><span>)</span>, <span>"*follower"</span><span>)</span>.<span>out</span><span>(</span><span>"*languages"</span><span>)</span><br>
.<span>keepTrue</span><span>(</span><span>new</span> Expr<span>(</span>Ops.<span>IS_NULL</span>, <span>"*followerSharedInboxUrl"</span><span>)</span><span>)</span> <span>// skip remote followers</span><br>
.<span>ifTrue</span><span>(</span><span>new</span> Expr<span>(</span>Ops.<span>IS_INSTANCE_OF</span>, BoostStatusContent.<span>class</span>, <span>"*content"</span><span>)</span>,<br>
&nbsp; &nbsp; &nbsp; &nbsp; Block.<span>macro</span><span>(</span>extractFields<span>(</span><span>"*content"</span>, <span>"*boostedAuthorId"</span><span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>keepTrue</span><span>(</span><span>new</span> Expr<span>(</span>Ops.<span>NOT_EQUAL</span>, <span>"*boostedAuthorId"</span>, <span>"*followerId"</span><span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>keepTrue</span><span>(</span><span>"*showBoosts"</span><span>)</span><span>)</span><br>
.<span>keepTrue</span><span>(</span><span>new</span> Expr<span>(</span><span>(</span>List<span>&lt;</span>String<span>&gt;</span> languages, <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+string"><span>String</span></a> statusLanguage<span>)</span> <span>-&gt;</span> languages <span>==</span> <span>null</span> <span>||</span> statusLanguage <span>==</span> <span>null</span> <span>||</span> languages.<span>contains</span><span>(</span>statusLanguage<span>)</span>, <span>"*languages"</span>, <span>"*language"</span><span>)</span><span>)</span></p></td></tr></tbody></table></div>




<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="489" height="1024" data-attachment-id="1289" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/timeline-fanout-6-1/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-6-1.png?fit=659%2C1381&amp;ssl=1" data-orig-size="659,1381" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="timeline-fanout-6-1" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-6-1.png?fit=143%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-6-1.png?fit=489%2C1024&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-6-1.png?resize=489%2C1024&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-6-1.png?resize=489%2C1024&amp;ssl=1 489w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-6-1.png?resize=143%2C300&amp;ssl=1 143w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-6-1.png?w=659&amp;ssl=1 659w" sizes="(max-width: 489px) 100vw, 489px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-6-1.png?resize=489%2C1024&amp;ssl=1 489w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-6-1.png?resize=143%2C300&amp;ssl=1 143w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-6-1.png?w=659&amp;ssl=1 659w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-6-1.png?resize=489%2C1024&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>This filters this follower out of fanout for this status if: it’s a boost and they don’t wish to see boosts from this author, it’s a boost and they’re the original author of the status, or they specified they only wish to see certain languages from this author and the status doesn’t match.</p>



<p>Notice how all the information needed to do the filtering is on the

<code>Follower</code>

structure that was retrieved as part of fetching followers for fanout. No extra PState queries need to be done for this information, which is one of the reasons our implementation has such high throughput. The average amount of fanout per status on our instance is 403, so any work post-fanout (after the

<code>Ops.EXPLODE</code>

call, which emits once per follower in the

<code>*fetchedFollowers</code>

list) is multiplied by 403 compared to work pre-fanout. This is why we went out of our way to materialize as much information on the follow relationship as possible to minimize the work post-fanout.</p>



<p>The next section handles additional filtering required for replies:</p>




<div><table><tbody><tr><td><p>1<br>2<br>3<br>4<br>5<br>6<br></p></td><td><p>.<span>ifTrue</span><span>(</span><span>new</span> Expr<span>(</span>Ops.<span>IS_INSTANCE_OF</span>, ReplyStatusContent.<span>class</span>, <span>"*content"</span><span>)</span>,<br>
&nbsp; &nbsp; &nbsp; &nbsp; Block.<span>macro</span><span>(</span>extractFields<span>(</span><span>"*content"</span>, <span>"*parentAuthorId"</span><span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>hashPartition</span><span>(</span><span>"*followerId"</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>macro</span><span>(</span>fetchBloomMacro<span>(</span><span>"*followerId"</span>, <span>"*rbloom"</span><span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>keepTrue</span><span>(</span><span>new</span> Expr<span>(</span><span>(</span>RBloomFilter rbloom, <a href="http://www.google.com/search?hl=en&amp;q=allinurl%3Adocs.oracle.com+javase+docs+api+long"><span>Long</span></a> accountId<span>)</span> <span>-&gt;</span> rbloom.<span>bloom</span>.<span>isPresent</span><span>(</span><span>""</span> <span>+</span> accountId<span>)</span>, <span>"*rbloom"</span>, <span>"*parentAuthorId"</span><span>)</span><span>)</span><br>
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;.<span>select</span><span>(</span><span>"$$followerToFollowees"</span>, Path.<span>key</span><span>(</span><span>"*followerId"</span><span>)</span>.<span>must</span><span>(</span><span>"*parentAuthorId"</span><span>)</span><span>)</span><span>)</span></p></td></tr></tbody></table></div>




<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="489" height="1024" data-attachment-id="1290" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/timeline-fanout-7-1/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-7-1.png?fit=659%2C1381&amp;ssl=1" data-orig-size="659,1381" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="timeline-fanout-7-1" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-7-1.png?fit=143%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-7-1.png?fit=489%2C1024&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-7-1.png?resize=489%2C1024&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-7-1.png?resize=489%2C1024&amp;ssl=1 489w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-7-1.png?resize=143%2C300&amp;ssl=1 143w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-7-1.png?w=659&amp;ssl=1 659w" sizes="(max-width: 489px) 100vw, 489px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-7-1.png?resize=489%2C1024&amp;ssl=1 489w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-7-1.png?resize=143%2C300&amp;ssl=1 143w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-7-1.png?w=659&amp;ssl=1 659w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-7-1.png?resize=489%2C1024&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>Replies are delivered to a follower only if they also follow the account being replied to. This code queries

<code>$$followerToFollowees</code>

to perform that check, with the

<code>must</code>

navigator only emitting if the follow relationship exists.</p>



<div><p>Before the PState query, there’s a bloom filter check to minimize the amount of PState queries done here. This is another optimization that we didn’t mention in the earlier discussion of fanout, and we’ll discuss it more in a future post. In short, a bloom filter is materialized and cached in-memory on this module for each account with all follows for the account. If the bloom filter returns false, the follow relationship definitely does not exist and no PState query is necessary. If it returns true, the PState query is done to weed out false positives. The bloom filter reduces PState queries for replies by 99%.</p>
<p>The next section completes this ETL by writing to the home timelines of followers that have passed each of the preceding filters:</p>
</div>




<div><table><tbody><tr><td><p>1<br>2<br></p></td><td><p>.<span>hashPartition</span><span>(</span><span>"*followerId"</span><span>)</span><br>
.<span>each</span><span>(</span>HomeTimelines<span>::</span>addTimelineItem, <span>"*homeTimelines"</span>, <span>"*followerId"</span>, <span>"*statusPointer"</span>, <span>new</span> Expr<span>(</span>Ops.<span>CURRENT_MICROBATCH_ID</span><span>)</span><span>)</span><span>;</span></p></td></tr></tbody></table></div>




<figure><img data-lazy-fallback="1" decoding="async" loading="lazy" width="489" height="1024" data-attachment-id="1291" data-permalink="https://blog.redplanetlabs.com/2023/08/15/how-we-reduced-the-cost-of-building-twitter-at-twitter-scale-by-100x/timeline-fanout-8-1/" data-orig-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-8-1.png?fit=659%2C1381&amp;ssl=1" data-orig-size="659,1381" data-comments-opened="1" data-image-meta="{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}" data-image-title="timeline-fanout-8-1" data-image-description="" data-image-caption="" data-medium-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-8-1.png?fit=143%2C300&amp;ssl=1" data-large-file="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-8-1.png?fit=489%2C1024&amp;ssl=1" src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-8-1.png?resize=489%2C1024&amp;ssl=1" alt="" srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-8-1.png?resize=489%2C1024&amp;ssl=1 489w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-8-1.png?resize=143%2C300&amp;ssl=1 143w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-8-1.png?w=659&amp;ssl=1 659w" sizes="(max-width: 489px) 100vw, 489px" data-recalc-dims="1" data-lazy-srcset="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-8-1.png?resize=489%2C1024&amp;ssl=1 489w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-8-1.png?resize=143%2C300&amp;ssl=1 143w, https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-8-1.png?w=659&amp;ssl=1 659w" data-lazy-src="https://i0.wp.com/blog.redplanetlabs.com/wp-content/uploads/2023/07/timeline-fanout-8-1.png?resize=489%2C1024&amp;is-pending-load=1#038;ssl=1" data-old-srcset="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></figure>



<p>This simply routes to the appropriate partition hosting each follower’s home timeline and then adds to it. That

<code>.hashPartition</code>

call is actually the most expensive part of this ETL because of the huge volume of messages that flow through it. Due to the average of 403 fanout on our instance and our incoming rate of 3,500 statuses / second, 1.4M messages go across that partitioner every second.</p>



<div><p>When we open-source our Mastodon instance in two weeks, you’ll see that this ETL also handles hashtags, lists, conversations, and federation. We excluded those from this code example since they’re all pretty similar to home timeline fanout, with slightly different rules. They’re just additional branches of computation on this ETL.</p>
<p>That’s all we’ll show for now. As mentioned, in two weeks we’ll be open-sourcing our entire Mastodon implementation.</p>
</div>



<h2 id="Conclusion">Conclusion</h2>



<div><p>I’ve covered a lot in this post, but I’ve barely scratched the surface on Rama and our Mastodon implementation. For example, I didn’t mention “fine-grained reactivity”, a new capability provided by Rama that’s never existed before. It allows for true incremental reactivity from the backend up through the frontend. Among other things it will enable UI frameworks to be fully incremental instead of doing expensive diffs to find out what changed. We use reactivity in our Mastodon implementation to power much of <a href="https://docs.joinmastodon.org/methods/streaming/">Mastodon’s streaming API</a>.</p>
<p>I also didn’t mention Rama’s integration API. Because of my description of Rama as being able to build an entire backend on its own, you may have the impression that Rama is an “all-or-nothing” tool. However, just because Rama can do so much doesn’t mean it has to be used to do everything. We’ve designed Rama to be able to seamlessly integrate with any other tool (e.g. databases, queues, monitoring systems, etc.). This allows Rama to be introduced gradually into any architecture.</p>
</div>



<p>To reiterate what’s to come: in one week we will be releasing the full Rama documentation as well as a build of Rama that exposes the full API for use with

<code>InProcessCluster</code>

, and in two weeks we will be fully open-sourcing our Mastodon implementation (which can run on

<code>InProcessCluster</code>

). Additionally, we will be publishing more posts exploring Rama and our Mastodon implementation in greater depth.</p>



<div><p>You can keep track of developments with Rama by joining <a href="https://redplanetlabs.us13.list-manage.com/subscribe?u=68cd3e63bd4533d0db57922c5&amp;id=fae70c7c5b">our newsletter</a> or following us on Twitter at <a href="https://twitter.com/redplanetlabs">@redplanetlabs</a>. We’ve also started the Google group <a href="https://groups.google.com/u/1/g/rama-user">rama-user</a>, where you can discuss Rama or ask questions.</p>
<p>Lastly, Red Planet Labs will be starting a private beta in the coming months to give companies access to the full version of Rama. We plan to work closely with our private beta users to help them build new systems or reimplement existing systems at massively reduced cost. We will be releasing more details on the private beta later, but you can <a href="https://docs.google.com/forms/d/e/1FAIpQLSfrhmBwI0YAeaL8u4XmgfscW4UIUUDp2ZHSs4KmPH_TaDt1QQ/viewform">apply here</a> in the meantime.</p>
</div>
			</div><!-- .entry-content -->

	<!-- .entry-footer -->

	</article></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Opendream: A layer-based UI for Stable Diffusion (412 pts)]]></title>
            <link>https://github.com/varunshenoy/opendream</link>
            <guid>37136898</guid>
            <pubDate>Tue, 15 Aug 2023 17:38:10 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://github.com/varunshenoy/opendream">https://github.com/varunshenoy/opendream</a>, See on <a href="https://news.ycombinator.com/item?id=37136898">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><h2 tabindex="-1" dir="auto">Opendream: A Web UI For the Rest of Us <g-emoji alias="thought_balloon" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4ad.png">💭</g-emoji> <g-emoji alias="art" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f3a8.png">🎨</g-emoji></h2>
<p dir="auto">Opendream brings much needed and familiar features, such as layering, non-destructive editing, portability, and easy-to-write extensions, to your Stable Diffusion workflows. Check out our <a href="https://twitter.com/varunshenoy_/status/1691506322360201216?s=20" rel="nofollow">demo video</a>.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/varunshenoy/opendream/blob/main/images/hero.png"><img src="https://github.com/varunshenoy/opendream/raw/main/images/hero.png" alt="hero"></a></p>
<h2 tabindex="-1" dir="auto">Getting started</h2>
<ol dir="auto">
<li>Clone this repository.</li>
<li>Navigate to this project within your terminal and run <code>sh ./run_opendream.sh</code>. After ~30 seconds, both the frontend and backend of the Opendream system should be up and running.</li>
</ol>
<h2 tabindex="-1" dir="auto">Features</h2>
<p dir="auto">Diffusion models have emerged as powerful tools in the world of image generation and manipulation. While they offer significant benefits, these models are often considered black boxes due to their inherent complexity. The current diffusion image generation ecosystem is defined by tools that allow one-off image manipulation tasks to control these models - text2img, in-painting, pix2pix, among others.</p>
<p dir="auto">For example, popular interfaces like <a href="https://github.com/AUTOMATIC1111/stable-diffusion-webui">Automatic1111</a>, <a href="https://midjourney.com/" rel="nofollow">Midjourney</a>, and <a href="https://beta.dreamstudio.ai/generate" rel="nofollow">Stability.AI's DreamStudio</a> only support destructive editing: each edit "consumes" the previous image. This means users cannot easily build off of previous images or run multiple experiments on the same image, limiting their options for creative exploration.</p>
<h3 tabindex="-1" dir="auto">Layering and Non-destructive Editing</h3>
<p dir="auto">Non-destructive editing is a method of image manipulation that preserves the original image data while allowing users to make adjustments and modifications without overwriting previous work. This approach facilitates experimentation and provides more control over the editing process by using layers and masks. When you delete a layer, all layers after it also get deleted. This guarantees that all layers currently on the canvas are a product of other existing layers. This also allows one to deterministically "replay" a workflow.</p>
<p dir="auto">Like Photoshop, Opendream supports non-destructive editing out of the box. Learn more about the principles of non-destructive editing in Photoshop <a href="https://helpx.adobe.com/photoshop/using/nondestructive-editing.html" rel="nofollow">here</a>.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/varunshenoy/opendream/blob/main/images/editing.png"><img src="https://github.com/varunshenoy/opendream/raw/main/images/editing.png" alt="layers"></a></p>
<h3 tabindex="-1" dir="auto">Save and Share Workflows</h3>
<p dir="auto">Users can also save their current workflows into a portable file format that can be opened up at a later time or shared with collaborators. In this context, a "state" is just a JSON file describing all of the current layers and how they were created.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/varunshenoy/opendream/blob/main/images/workflow.png"><img src="https://github.com/varunshenoy/opendream/raw/main/images/workflow.png" alt="workflow"></a></p>
<h3 tabindex="-1" dir="auto">Support Simple to Write, Easy to Install Extensions</h3>
<p dir="auto">As the open-source ecosystem flourishes around these models and tools, extensibility has also become a major concern. While Automatic1111 does offer extensions, they are often difficult to program, use, and install. It is far from being as full-featured as an application like Adobe Photoshop.</p>
<p dir="auto">As new features for Stable Diffusion, like ControlNet, are released, users should be able to seamlessly integrate them into their artistic workflows with minimal overload and time.</p>
<p dir="auto">Opendream makes writing and using new diffusion features as simple as writing a Python function. Keep reading to learn how.</p>
<h2 tabindex="-1" dir="auto">Extensions</h2>
<p dir="auto">From the get-go, Opendream supports two key primitive operations baked into the core system: <code>dream</code> and <code>mask_and_inpaint</code>. In this repository, extensions for <code>instruct_pix2pix</code>, <code>controlnet_canny</code>, <code>controlnet_openpose</code>, and <code>sam</code> (Segment Anything) are provided.</p>
<p dir="auto">Any image manipulation logic can be easily written as an extension. With extensions, you can also decide how certain operations work. For example, you can override the <code>dream</code> operation to use OpenAI's DALL-E instead or call a serverless endpoint on a service like AWS or Replicate. <a href="https://gist.githubusercontent.com/varunshenoy/f029c55536bb7e4fac61a595e836d930/raw/f7e693c8aa42a814d05198c28a843a97c8f6a4c6/baseten_stable_diffusion.py" rel="nofollow">Here's an example using Baseten</a>.</p>
<h3 tabindex="-1" dir="auto">Loading an Existing Extension</h3>
<p dir="auto">There are two ways to load extensions.</p>
<ol dir="auto">
<li>Install a pre-written one through the Web UI.</li>
<li><em>(Manual)</em> Download a valid extension file (or write one yourself!) and add it to the <code>opendream/extensions</code> folder. Instructions for writing your own extension are below.</li>
</ol>
<p dir="auto">Here is a sampling of currently supported extensions. You can use the links to install any given extension through the Web UI.</p>
<table>
<thead>
<tr>
<th><strong>Extension</strong></th>
<th><strong>Link</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>OpenAI's DALL-E</td>
<td><a href="https://gist.githubusercontent.com/varunshenoy/4a9a6bbfedfa7def28178a8f0563320a/raw/d2d10faa0fad8c2d251e599d962b0c7f62c06db0/dalle.py" rel="nofollow">File</a></td>
</tr>
<tr>
<td>Serverless Stable Diffusion</td>
<td><a href="https://gist.githubusercontent.com/varunshenoy/f029c55536bb7e4fac61a595e836d930/raw/f7e693c8aa42a814d05198c28a843a97c8f6a4c6/baseten_stable_diffusion.py" rel="nofollow">File</a></td>
</tr>
<tr>
<td>Instruct Pix2Pix</td>
<td><a href="https://gist.githubusercontent.com/varunshenoy/894c7a723de6b4651380dd7fa2a81724/raw/fa678d8d6c430421fb481f7023ad76898dd27ad6/instruct_pix2pix.py" rel="nofollow">File</a></td>
</tr>
<tr>
<td>ControlNet Canny</td>
<td><a href="https://gist.githubusercontent.com/varunshenoy/0b0455449454e5856021fe2971b78352/raw/1c08b376b499c25c84976eade71db9aa355dba47/controlnet_canny.py" rel="nofollow">File</a></td>
</tr>
<tr>
<td>ControlNet Openpose</td>
<td><a href="https://gist.githubusercontent.com/varunshenoy/380722906b8ff184569af57e06fd37b7/raw/728832370db0448bc2807ffc9e267635749e6a9f/controlnet_openpose.py" rel="nofollow">File</a></td>
</tr>
<tr>
<td>Segment Anything</td>
<td><a href="https://gist.githubusercontent.com/varunshenoy/5fbc883360e5ab2a3c023ce1e286ddd5/raw/efbc92d27ae2209b15948fb52f657e88c185b349/sam.py" rel="nofollow">File</a></td>
</tr>
<tr>
<td>PhotoshopGPT</td>
<td><a href="https://gist.github.com/varunshenoy/63054e7a479f256974416ef45a51e6a0">Gist</a></td>
</tr>
</tbody>
</table>
<p dir="auto">Note that extensions may have their own requirements you would need to include in the <code>requirements.txt</code> file. For example, you would need to add <code>openai</code> if you want to use the DALL-E extension.</p>
<p dir="auto">Feel free to make a PR if you create a useful extension!</p>
<h3 tabindex="-1" dir="auto">Writing Your Own Extension</h3>
<p dir="auto">Users can write their own extensions as follows:</p>
<ol dir="auto">
<li>Create a new Python file in the <code>opendream/extensions</code> folder.</li>
<li>Write a method with type hints and a <code>@opendream.define_op</code> decorator. This decorator registers this method with the Opendream backend.</li>
</ol>
<p dir="auto">The method has a few requirements:</p>
<ul dir="auto">
<li>Parameters must have type hints. These enable the backend to generate a schema for the input which is parsed into form components on the frontend. Valid types include: <code>str</code>, <code>int</code>, <code>float</code>, <code>Layer</code>, <code>MaskLayer</code>, or <code>ImageLayer</code>.</li>
<li>The only valid return types are a <code>Layer</code> or a list of <code>Layer</code> objects.</li>
</ul>
<h2 tabindex="-1" dir="auto">Contributions and Licensing</h2>
<p dir="auto"><em>Opendream was built by Varun Shenoy, Eric Lou, Shashank Rammoorthy, and Rahul Shiv as a part of Stanford's <a href="https://cs348k.stanford.edu/" rel="nofollow">CS 348K</a>.</em></p>
<p dir="auto">Feel free to provide any contibutions you deem necessary or useful. This project is licensed under the MIT License.</p>
</article>
          </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Elon Musk’s X is throttling traffic to news and websites he dislikes (185 pts)]]></title>
            <link>https://www.washingtonpost.com/technology/2023/08/15/twitter-x-links-delayed/</link>
            <guid>37136858</guid>
            <pubDate>Tue, 15 Aug 2023 17:33:52 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.washingtonpost.com/technology/2023/08/15/twitter-x-links-delayed/">https://www.washingtonpost.com/technology/2023/08/15/twitter-x-links-delayed/</a>, See on <a href="https://news.ycombinator.com/item?id=37136858">Hacker News</a></p>
Couldn't get https://www.washingtonpost.com/technology/2023/08/15/twitter-x-links-delayed/: Error [ERR_FR_TOO_MANY_REDIRECTS]: Maximum number of redirects exceeded]]></description>
        </item>
        <item>
            <title><![CDATA["About 67k” sites are banned from submission on HN, the list is kept secret (106 pts)]]></title>
            <link>https://news.ycombinator.com/item?id=37130147</link>
            <guid>37136111</guid>
            <pubDate>Tue, 15 Aug 2023 16:41:51 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://news.ycombinator.com/item?id=37130147">https://news.ycombinator.com/item?id=37130147</a>, See on <a href="https://news.ycombinator.com/item?id=37136111">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
            <tbody><tr id="37130398"><td></td></tr>
                <tr id="37137757"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_37137757" href="https://news.ycombinator.com/vote?id=37137757&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>HN operates, based on a number of reasons, on numerous dynamics of friction and nudges.  Mostly for the better.  I've had my disagreements about things in the past, though as I watch the site and have studied it (particularly over the past few months, see: &lt;<a href="https://news.ycombinator.com/item?id=36843900">https://news.ycombinator.com/item?id=36843900</a>&gt;) I mostly agree with it.<p>The parts that <i>don't</i> work especially well, most particularly discussion of difficult-but-important topics (in my view) ... have also been acknowledged by its creator pg (Paul Graham) and mods (publicly, dang, though there are a few others).</p><p>In general:  if you submit a story and it doesn't go well, drop a note to the moderators:  hn@ycombinator.com.  They typically reply within a few hours, perhaps a day or if things are busy or for complex.</p><p>You can verify that a submission did or didn't go through by checking on the link from an unauthenticated (logged-out) session.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="37130484"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_37130484" href="https://news.ycombinator.com/vote?id=37130484&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>What is it if the information is freely available, to anyone asking, for a single domain they are trying to post at that time?<p>It’s not secret, because they’ll be provided an answer if they email the mod team.</p><p>It’s not free as in open source, because it isn’t available for anyone to download and study in full.</p><p>So, since it’s not secret, is it public, or private? Since it’s not published in full but any query of LIMIT 1 is answered, is that open, closed, or other?</p><p>Restrictions to publication don’t necessarily equate to secrecy, but the best I’ve got is “available upon request”, which isn’t quite right either. Suggestions welcome.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37130600"><td></td></tr>
                <tr id="37131149"><td></td></tr>
                <tr id="37134237"><td></td></tr>
                  <tr id="37130675"><td><table>  <tbody><tr>    <td indent="3"><img src="https://news.ycombinator.com/s.gif" height="1" width="120"></td><td>
      <center><a id="up_37130675" href="https://news.ycombinator.com/vote?id=37130675&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>There’s a protection system in place that can result in that; I don’t have the details at hand (since I’m not associated with HN/YC) but I remember seeing it once before on a highly contentious post, and an email to the mods helped explain/correct whatever was up.</span></p></div></td></tr>
        </tbody></table></td></tr>
                  <tr id="37130613"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_37130613" href="https://news.ycombinator.com/vote?id=37130613&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>&gt; Suggestions welcome<p>"This domain is not allowed on HN" as an error message upon submission.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37130643"><td><table>  <tbody><tr>    <td indent="3"><img src="https://news.ycombinator.com/s.gif" height="1" width="120"></td><td>
      <center><a id="up_37130643" href="https://news.ycombinator.com/vote?id=37130643&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>That’s not going to work, because now that’s an API for spammers to bulk process against a domain list. The only available API must be human communication to the mod team, or the spammers will overcome it with automation.</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="37130730"><td><table>  <tbody><tr>    <td indent="4"><img src="https://news.ycombinator.com/s.gif" height="1" width="160"></td><td>
      <center><a id="up_37130730" href="https://news.ycombinator.com/vote?id=37130730&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>Spammers can already do that API call and see if the domain shows up. This only puts human users at the same level of consideration as spammer automation.</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="37130772"><td><table>  <tbody><tr>    <td indent="5"><img src="https://news.ycombinator.com/s.gif" height="1" width="200"></td><td>
      <center><a id="up_37130772" href="https://news.ycombinator.com/vote?id=37130772&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>Seriously dedicated spammers can, yes! But antispam is about reducing the noise threshold, and eliminating low-effort spam opportunities that can be done to a single HTTP endpoint with a bash script is a big win. Simply having to access two pages is already too much to bother with for the vast majority.</span></p></div></td></tr>
        </tbody></table></td></tr>
                        <tr id="37130705"><td></td></tr>
                        <tr id="37130606"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_37130606" href="https://news.ycombinator.com/vote?id=37130606&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>There's a lot of user hostile moderation practices that occur on this site, manual and automatic. They're not often, or really at all, discussed. Some of them don't work well, and haven't for as long as they've existed.</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="37131198"><td></td></tr>
                <tr id="37133548"><td><table>  <tbody><tr>    <td indent="3"><img src="https://news.ycombinator.com/s.gif" height="1" width="120"></td><td>
      <center><a id="up_37133548" href="https://news.ycombinator.com/vote?id=37133548&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>I would consider any moderation action that isn't visible to users to be user hostile.<p>If you're going to censor someone, you owe it to them to be honest about what you're doing to them.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37136341"><td><table>  <tbody><tr>    <td indent="4"><img src="https://news.ycombinator.com/s.gif" height="1" width="160"></td><td>
      <center><a id="up_37136341" href="https://news.ycombinator.com/vote?id=37136341&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>You possibly haven't experienced how devious and determined and dishonest and unpleasant some bad actors are, including SPAMmers.<p>(Even when doing the RightThing(TM) would probably be easier...)</p><p>And, BTW, I occasionally get blocked by the mechanisms here, even though not doing anything bad, but understand that there is a trade-off.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37137135"><td></td></tr>
                <tr id="37139801"><td><table>  <tbody><tr>    <td indent="6"><img src="https://news.ycombinator.com/s.gif" height="1" width="240"></td><td>
      <center><a id="up_37139801" href="https://news.ycombinator.com/vote?id=37139801&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>And it is so high that over the ~25Y+* that I have been running my own sites I have not had UGC on any of them, other then a very brief experiment, which showed me what utter relentless turds the bad actors are.<p>Congrats to HN for striking a reasonable pragmatic balance.</p><p>*I had some of the first live (non-academic) Internet connectivity in the UK, and the very very first packets were hacking attempts...
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="37137674"><td><table>  <tbody><tr>    <td indent="6"><img src="https://news.ycombinator.com/s.gif" height="1" width="240"></td><td>
      <center><a id="up_37137674" href="https://news.ycombinator.com/vote?id=37137674&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>The HN moderation policies are clearly effective, because the site is mostly full of useful information that attracts a wide audience of readers.<p>I really like this take on moderation:</p><p>"The essential truth of every social network is that the product is content moderation, and everyone hates the people who decide how content moderation works. Content moderation is what Twitter makes — it is the thing that defines the user experience."</p><p>From Nilay Patel in <a href="https://www.theverge.com/2022/10/28/23428132/elon-musk-twitter-acquisition-problems-speech-moderation" rel="nofollow noreferrer">https://www.theverge.com/2022/10/28/23428132/elon-musk-twitt...</a>
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="37137731"><td><table>  <tbody><tr>    <td indent="6"><img src="https://news.ycombinator.com/s.gif" height="1" width="240"></td><td>
      <center><a id="up_37137731" href="https://news.ycombinator.com/vote?id=37137731&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>I agree with you both. The only thing I'd add is that it's a tradeoff - if we do it this way, it's only because the alternative would be even more user-hostile.</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="37138692"><td><table>  <tbody><tr>    <td indent="7"><img src="https://news.ycombinator.com/s.gif" height="1" width="280"></td><td>
      <center><a id="up_37138692" href="https://news.ycombinator.com/vote?id=37138692&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>Does HN ever show a user that their comment was submitted, but the comment is not visible for anyone else? Or it’s not visible for most people? Without having the flagged tag</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="37138887"><td></td></tr>
                                    <tr id="37137040"><td><table>  <tbody><tr>    <td indent="4"><img src="https://news.ycombinator.com/s.gif" height="1" width="160"></td><td>
      <center><a id="up_37137040" href="https://news.ycombinator.com/vote?id=37137040&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>&gt;If you're going to censor someone<p>unless HN is suddenly the government what you've misnomered is moderation, not censorship. Calling censorship just exaggerates your opinion and makes you look unhinged. It's a private website not national news.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37137128"><td></td></tr>
                <tr id="37137680"><td></td></tr>
            <tr id="37137214"><td></td></tr>
                <tr id="37139254"><td><table>  <tbody><tr>    <td indent="7"><img src="https://news.ycombinator.com/s.gif" height="1" width="280"></td><td>
      <center><a id="up_37139254" href="https://news.ycombinator.com/vote?id=37139254&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>I like Scott Alexander's definition[1]. Quoting directly:<p>&gt; Moderation is the normal business activity of ensuring that your customers like using your product. If a customer doesn’t want to receive harassing messages, or to be exposed to disinformation, then a business can provide them the service of a harassment-and-disinformation-free platform.</p><p>&gt; Censorship is the abnormal activity of ensuring that people in power approve of the information on your platform, regardless of what your customers want. If the sender wants to send a message and the receiver wants to receive it, but some third party bans the exchange of information, that’s censorship.</p><p>Censorship is somewhat subjective, something that you might find offensive and want moderated might not be considered so by others. Therefore, Alexander further argues that the simplest mechanism that turns censorship into moderation is a switch that, when enabled, lets you see the banned content, which is exactly what HN does. Alexander further argues that there are kinds of censorship that aren't necessarily bad, by this definition, disallowing pedophiles from sharing child porn with each other is censorship, but it's something that we should still do.</p><p>[1] <a href="https://astralcodexten.substack.com/p/moderation-is-different-from-censorship" rel="nofollow noreferrer">https://astralcodexten.substack.com/p/moderation-is-differen...</a>
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="37138738"><td><table>  <tbody><tr>    <td indent="7"><img src="https://news.ycombinator.com/s.gif" height="1" width="280"></td><td>
      <center><a id="up_37138738" href="https://news.ycombinator.com/vote?id=37138738&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>In my head, censorship is the removal of an idea that is offensive to a particular ideology but isn’t objectively harmful.<p>Moderation is the removal of content that objectively doesn’t belong in context, eg spam</p><p>Obviously that moderation definition is nuanced bc some could argue that Marxist ideas don’t belong in the context of a site with a foundation in startups. And indeed Marxist ideas often get flagged here
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="37137828"><td></td></tr>
                                          <tr id="37131304"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_37131304" href="https://news.ycombinator.com/vote?id=37131304&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>I've twice had some "user hostile moderation practice" used against me on HN. Both times an email to the right person cleared it up - and one of those times in fact I had crossed a boundary that I shouldn't have crossed. Any long-time community member here knows what to do.</span></p></div></td></tr>
        </tbody></table></td></tr>
                        <tr id="37137642"><td></td></tr>
            <tr id="37136798"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_37136798" href="https://news.ycombinator.com/vote?id=37136798&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>Understandable, but I think there should be some discriminating system for another class of sites, the "you can submit but not discuss" ones.<p>For example, a recent submission (of mine):</p><p>"Luis Buñuel: The Master of Film Surrealism"</p><p>it had no discussion space because (I guess) it comes from fairobserver.com . Now, I understand that fairobserver.com may had been an hive of dubious publishing historically, but it makes little sense we cannot discuss Buñuel...</p><p>Maybe a rough discriminator (function approximator, Bayesian etc.) could try and decide (based at least on the title) whether a submission from "weak editorial board" sites seems to be material to allow posts or not.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37137830"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_37137830" href="https://news.ycombinator.com/vote?id=37137830&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>Oh I agree - <a href="https://news.ycombinator.com/item?id=36924205">https://news.ycombinator.com/item?id=36924205</a> was a fine submission. Can you please email  hn@ycombinator.com so I can send you a repost invite for it?<p>That domain is a borderline case. Sometimes the leopard really changes its spots, i.e. a site goes from offtopic or spam to one that at least occasionally produces good-for-HN articles. In such cases we simply unban it. Other times, the general content is still so bad for HN that we have to rely on users to vouch for the occasional good submission, or to email us and get us to restore it. I can't quite tell where fairobserver.com is on this spectrum because the most recent submission (yours) is good, the previous one (from 7 months ago) is borderline, and before that it was definitely not good. But I've unbanned it now and moved it into the downweighted category, i.e. one notch less penalized.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                  <tr id="37136419"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_37136419" href="https://news.ycombinator.com/vote?id=37136419&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>Do you have get-out-of-jail or N-strikes-and-you're-out policies? What if someone's legitimate website gets caught in this?
I've also long wondered about user specific shadow bans. Can you please shed light on this?</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="37137747"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_37137747" href="https://news.ycombinator.com/vote?id=37137747&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>There's no automatic unban. That would require writing code that knows how to tell a good (for HN) site apart from a bad one, and if we could write such code, we wouldn't need to keep a list of banned sites in the first place. However, we're always happy to unban a site when we notice that it's actually fine for HN, or when someone points this out to us.<p>Re shadowbanning (i.e. banning a user without telling them), see the past explanations at <a href="https://hn.algolia.com/?dateRange=all&amp;page=0&amp;prefix=true&amp;query=by%3Adang%20shadowb&amp;sort=byDate&amp;type=comment" rel="nofollow noreferrer">https://hn.algolia.com/?dateRange=all&amp;page=0&amp;prefix=true&amp;que...</a> and let me know if you still have questions. The short version is that when an account has an established history, we tell them we're banning them and why. We only shadowban when it's a spammer or a new account that we have reason to guess is a serial abuser.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37138012"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_37138012" href="https://news.ycombinator.com/vote?id=37138012&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>Thanks for the thoughtful reply. Is it also true that users with certain karma count or special permissions have more significant - and potentially lasting - downvoting weight that impacts to the downvoted party's long term reputation?</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="37139032"><td><table>  <tbody><tr>    <td indent="3"><img src="https://news.ycombinator.com/s.gif" height="1" width="120"></td><td>
      <center><a id="up_37139032" href="https://news.ycombinator.com/vote?id=37139032&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>I'm interpreting your question as "are there privileged HN members with supervotes", excluding moderators, and who can single-handedly kill submissions or comments.<p>So far as I'm aware, no, and there are comments from dang and pg going back through the site history which argue strongly <i>against</i> distinguishing groups of profiles in any way.</p><p>The one possible exception is that YC founder's handles appear orange to one another at one point in time (pg discusses this in January 2013: &lt;<a href="https://news.ycombinator.com/item?id=5025168">https://news.ycombinator.com/item?id=5025168</a>&gt;).  The feature was disabled <i>for performance reasons</i>.</p><p>Dang mentions the feature still being active as of a year ago:  &lt;<a href="https://news.ycombinator.com/item?id=31727636">https://news.ycombinator.com/item?id=31727636</a>&gt;</p><p>I seem to recall a pg or dang discussion where showing this <i>publicly</i> created a social tension on the site, as in, one set of people distinguished from another.</p><p>dang discusses the (general lack of) secret superpowers here:  &lt;<a href="https://news.ycombinator.com/item?id=22767204">https://news.ycombinator.com/item?id=22767204</a>&gt;, which reiterates what's in the FAQ:</p><p><i>HN gives three features to YC: job ads (see above) and startup launches get placed on the front page, and YC founder names are displayed to other YC alumni in orange.</i></p><p>&lt;<a href="https://news.ycombinator.com/newsfaq.html">https://news.ycombinator.com/newsfaq.html</a>&gt;</p><p>Top-100 karma lands you on the leaderboard:  &lt;<a href="https://news.ycombinator.com/leaders">https://news.ycombinator.com/leaders</a>&gt;.  That's currently 41,815+ karma.  There are also no special privileges here other than occasionally being contacted by someone.  (I've had inquiries about dealing with the head-trip of being on the leaderboard, and a couple of requests to boost submissions, which I forward to the moderation team).
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="37138283"><td><table>  <tbody><tr>    <td indent="3"><img src="https://news.ycombinator.com/s.gif" height="1" width="120"></td><td>
      <center><a id="up_37138283" href="https://news.ycombinator.com/vote?id=37138283&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>I'm afraid I don't understand your question but here are the basics: HN has downvotes (on comments, not submissions). The ability to downvote requires &gt; 500 karma. When a comment gets downvoted, both its point score and the commenter's karma go down (in most cases - it's more complicated than that but this is the principle). Does that help?</span></p></div></td></tr>
        </tbody></table></td></tr>
                  <tr id="37137929"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_37137929" href="https://news.ycombinator.com/vote?id=37137929&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>You forgot to mention that you are also shadowbanning the ability of users to upvote or downvote things when you dislike their upvotes or downvotes—instances that you perceive as not contributing to the discussion or that are escalating the conversation.</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="37138287"><td><table>  <tbody><tr>    <td indent="3"><img src="https://news.ycombinator.com/s.gif" height="1" width="120"></td><td>
      <center><a id="up_37138287" href="https://news.ycombinator.com/vote?id=37138287&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>I didn't forget to mention that - it's simply not what the word shadowban means, as I've always understood and used it.<p>This is a big problem with trying to explain these things - people mean very different things by the same words, and it leads to misunderstanding.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37138736"><td><table>  <tbody><tr>    <td indent="4"><img src="https://news.ycombinator.com/s.gif" height="1" width="160"></td><td>
      <center><a id="up_37138736" href="https://news.ycombinator.com/vote?id=37138736&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>Which other word do you think would be suitable here? In my view, 'shadowban' aligns with the definition in this context, as you aren't notifying people about it (hence 'shadow') and their actions of upvoting or downvoting have no impact (so same as shadowbanning comments or submissions etc).</span></p></div></td></tr>
        </tbody></table></td></tr>
                                    <tr id="37134742"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_37134742" href="https://news.ycombinator.com/vote?id=37134742&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>That's a lot of domains! Did you source that from some other list, or is that a result of 67k individual entries? Either way, I appreciate it.<p>Out of curiosity, what's the rationale for blocking archive.is? Legal reasons I assume?
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37136514"><td></td></tr>
            <tr id="37138324"><td></td></tr>
            <tr id="37136281"><td></td></tr>
                <tr id="37136526"><td></td></tr>
                <tr id="37136690"><td></td></tr>
                <tr id="37139215"><td><table>  <tbody><tr>    <td indent="4"><img src="https://news.ycombinator.com/s.gif" height="1" width="160"></td><td>
      <center><a id="up_37139215" href="https://news.ycombinator.com/vote?id=37139215&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>0.02% of a big number ... is still a big number<p>0.02% of 10,000 is 2 - pretty small</p><p>0.02% of 1,000,000,000 is 200,000 ... kinda big :)
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                                    <tr id="37131476"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_37131476" href="https://news.ycombinator.com/vote?id=37131476&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>Well that explains why all those links I posted to maximizedlivingdrlabrecque.com never got any traction…</span></p></div></td></tr>
        </tbody></table></td></tr>
            <tr id="37135813"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_37135813" href="https://news.ycombinator.com/vote?id=37135813&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>Maybe "major media" should include tech media like The Register, Ars Technica, Tech Dirt, etc.. Unlike with media like the NYT, Bloomberg or Reuters, I've never seen a story for which these sites were the best source and much of what they publish is blogspam summarizing stories that have already been posted on HN, usually with a votebait title.</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="37139781"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_37139781" href="https://news.ycombinator.com/vote?id=37139781&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>Yes, those sites are all downweighted. Whether they count as "major media" or not, they're classified the same way by HN's software, for more or less the same reason: they produce a lot of derivative and/or sensational and/or otherwise not-great-for-HN content, and they also produce substantive articles that are good for HN.</span></p></div></td></tr>
        </tbody></table></td></tr>
            <tr id="37136386"><td></td></tr>
                  <tr id="37136474"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_37136474" href="https://news.ycombinator.com/vote?id=37136474&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>So, is there an algorithm to be features in the front page? —other than upvotes. If a site can be banned, can another one be promoted?</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="37139764"><td></td></tr>
            <tr id="37136594"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_37136594" href="https://news.ycombinator.com/vote?id=37136594&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>I could be wrong, but I was always under the impression that companies that are in ycombinator get an inital boast in the jobs posts but also quickly fall off as such links don't allow comments.</span></p></div></td></tr>
        </tbody></table></td></tr>
                  <tr id="37130472"><td></td></tr>
            <tr id="37130834"><td></td></tr>
                <tr id="37131157"><td></td></tr>
            <tr id="37131153"><td></td></tr>
            <tr id="37131215"><td></td></tr>
                  <tr id="37130185"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_37130185" href="https://news.ycombinator.com/vote?id=37130185&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>Would be nice if the lists were published though with a link to the list from the submission form.</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="37130234"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_37130234" href="https://news.ycombinator.com/vote?id=37130234&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>The problem is that if you publish the lists it leads to more abuses. For example if spammers find out which sites are banned then they just post other ones.</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="37131669"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_37131669" href="https://news.ycombinator.com/vote?id=37131669&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>I think there are two different types of sites you are blocking: (1) those which are just pure spam; (2) news/opinion/etc websites that you’ve decided are not suitable for HN for various reasons (such as being low quality and tending to produce more ideological flame-wars than curiosity), for example Breitbart<p>I agree that publishing case (1) causes harm (spammers will just use a different domain if they know you’ve blocked theirs.) But case (2) is rather different. I don’t think the same justification for lack of transparency exists in this case. And I think shadow-banning the submission in case (2) is not very user-friendly. It would be better to just display an error, e.g. “submissions from this site are blocked because we do not believe it is suitable for HN” (or whatever). A new user might post stuff like (2) out of misunderstanding what the site is about rather than malevolence, so better to directly educate them than potentially leave them ignorant. Also, while Breitbart is rather obviously garbage, since we don’t know everything in category (2) on the list, maybe there are some sites on it whose suitability is more debatable or mixed, and its inappropriateness may be less obvious to someone than Breitbart’s (hopefully) is
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37137883"><td><table>  <tbody><tr>    <td indent="3"><img src="https://news.ycombinator.com/s.gif" height="1" width="120"></td><td>
      <center><a id="up_37137883" href="https://news.ycombinator.com/vote?id=37137883&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>That's a good argument and subtle enough that I'm not sure whether I agree or disagree.</span></p></div></td></tr>
        </tbody></table></td></tr>
                  <tr id="37130270"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_37130270" href="https://news.ycombinator.com/vote?id=37130270&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>&gt; For example if spammers find out which sites are banned then they just post other ones.<p>I don't think that makes sense. The supposed spammers can just try looking up whether their submissions show up or not when not logged in.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37130279"><td></td></tr>
                <tr id="37130516"><td><table>  <tbody><tr>    <td indent="4"><img src="https://news.ycombinator.com/s.gif" height="1" width="160"></td><td>
      <center><a id="up_37130516" href="https://news.ycombinator.com/vote?id=37130516&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>Increasing cost of attacks is effective against good faith people, not spammers.<p>Even Cory Doctorow made this case in "Como is Infosec" [1].</p><p>The only problem with Cory's argument is, he points people to the SC Principles [2]. The SCP contain exceptions for not notifying about "spam, phishing or malware." But anything can be considered spam, and transparency-with-exceptions has always been platforms' position. They've always argued they can secretly remove content when it amounts to "spam." Nobody has challenged them on that point. The reality is, platforms that use secretive moderation lend themselves to spammers.</p><p>[1] <a href="https://doctorow.medium.com/como-is-infosec-307f87004563" rel="nofollow noreferrer">https://doctorow.medium.com/como-is-infosec-307f87004563</a></p><p>[2] <a href="https://santaclaraprinciples.org/" rel="nofollow noreferrer">https://santaclaraprinciples.org/</a>
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37136408"><td><table>  <tbody><tr>    <td indent="5"><img src="https://news.ycombinator.com/s.gif" height="1" width="200"></td><td>
      <center><a id="up_37136408" href="https://news.ycombinator.com/vote?id=37136408&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>In my experience, increasing cost or delay even a <i>little</i> bit cuts out a disproportionate amount of bad stuff.<p>I once had the domain 'moronsinahurry' registered, though not with this group in mind...
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="37131955"><td><table>  <tbody><tr>    <td indent="5"><img src="https://news.ycombinator.com/s.gif" height="1" width="200"></td><td>
      <center><a id="up_37131955" href="https://news.ycombinator.com/vote?id=37131955&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span><i>platforms that use secretive moderation lend themselves to spammers</i><p>how is that? i can understand it not being useful, but how would it help spammers?
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37132012"><td><table>  <tbody><tr>    <td indent="6"><img src="https://news.ycombinator.com/s.gif" height="1" width="240"></td><td>
      <center><a id="up_37132012" href="https://news.ycombinator.com/vote?id=37132012&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>Spammers game the system while good-faith users get edged out. Spammers are determined actors who perceive threats everywhere, whereas good-faith users never imagine that a platform would secretly remove their content. Today, you see low quality content on social media, not because the world is dumb, but because the people who get their message out know the secret tricks.<p>Secret suppression is extremely common [1].</p><p>Many of today's content moderators say exceptions for shadowbans are needed [2]. They think lying to users promotes reality. That's bologna.</p><p>[1] <a href="https://www.removednews.com/p/hate-online-censorship-its-way-worse" rel="nofollow noreferrer">https://www.removednews.com/p/hate-online-censorship-its-way...</a></p><p>[2] <a href="https://twitter.com/rhaksw/status/1689887293002379264" rel="nofollow noreferrer">https://twitter.com/rhaksw/status/1689887293002379264</a>
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37133790"><td><table>  <tbody><tr>    <td indent="7"><img src="https://news.ycombinator.com/s.gif" height="1" width="280"></td><td>
      <center><a id="up_37133790" href="https://news.ycombinator.com/vote?id=37133790&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>so to spammers shadowbanning makes no difference, but good-faith users somehow get discouraged even if they don't know they are shadowbanned just because they get no reaction to their posts? how is an explicit ban any less discouraging?<p>i can't see how shadowbanning makes things worse for good-faith users. and evidently it does work against spammers here on HN (though we don't know if it is the shadow or the banning that makes it effective, but i'll believe dang when he says that it does help)
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37135288"><td><table>  <tbody><tr>    <td indent="8"><img src="https://news.ycombinator.com/s.gif" height="1" width="320"></td><td>
      <center><a id="up_37135288" href="https://news.ycombinator.com/vote?id=37135288&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>&gt; how is an explicit ban any less discouraging?<p>It's about whose messages are sidelined, not who gets discouraged.</p><p>With shadow removals, good-faith users' content is elbowed out without their knowledge. Since they don't know about it, they don't adjust behavior and do not bring their comments elsewhere.</p><p>Over 50% of Reddit users have removed content they don't know about. Just look at what people say when they find out [1].</p><p>&gt; and evidently it does work against spammers here on HN</p><p>It doesn't. It benefits people who know how to work the system. The more secret it is, the more special knowledge you need.</p><p>[1] <a href="https://www.reveddit.com/#say" rel="nofollow noreferrer">https://www.reveddit.com/#say</a>
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                                          <tr id="37130814"><td><table>  <tbody><tr>    <td indent="3"><img src="https://news.ycombinator.com/s.gif" height="1" width="120"></td><td>
      <center><a id="up_37130814" href="https://news.ycombinator.com/vote?id=37130814&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>It has made sense since the internet was invented, spammers need everything thrown at them because they will abuse every nook and cranny of your system to get paid 1 cent more</span></p></div></td></tr>
        </tbody></table></td></tr>
            <tr id="37130460"><td><table>  <tbody><tr>    <td indent="3"><img src="https://news.ycombinator.com/s.gif" height="1" width="120"></td><td>
      <center><a id="up_37130460" href="https://news.ycombinator.com/vote?id=37130460&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>You're correct again. Spammers and bots are the most determined actors, so these secretive measures don't impact them.<p>In fact, such secrecy <i>benefits</i> spammers. Good-faith users never imagine that platforms would secretly action content. So when you look at overall trends, bots, spammers and trolls are winning while genuine users are being pushed aside.</p><p>I argued that secrecy benefits trolls in a blog post, but I don't want to spam links to my posts in the comments.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37130494"><td><table>  <tbody><tr>    <td indent="4"><img src="https://news.ycombinator.com/s.gif" height="1" width="160"></td><td>
      <center><a id="up_37130494" href="https://news.ycombinator.com/vote?id=37130494&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>Most spammers aren’t that competent. Hiding their posts without telling them used to be very effective on Reddit (now Reddit tells them). I guess it’s the same on HN.</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="37130519"><td><table>  <tbody><tr>    <td indent="5"><img src="https://news.ycombinator.com/s.gif" height="1" width="200"></td><td>
      <center><a id="up_37130519" href="https://news.ycombinator.com/vote?id=37130519&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>Spammers are more competent than genuine users. They are advertisers, so they are more likely to be tracking metrics.</span></p></div></td></tr>
        </tbody></table></td></tr>
                  <tr id="37131311"><td></td></tr>
                <tr id="37131678"><td><table>  <tbody><tr>    <td indent="5"><img src="https://news.ycombinator.com/s.gif" height="1" width="200"></td><td>
      <center><a id="up_37131678" href="https://news.ycombinator.com/vote?id=37131678&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>So you think secretive measures more often defeat spammers than trusting users? I'd argue HN's content could be a lot better than it currently is.<p>Content curation is necessary, but shadow moderation is not helping. When a forum removes visible consequences, it does not prepare its users to learn from their mistakes.</p><p>I'll admit, I find HN to be more transparently moderated than Reddit and Twitter, but let's not pretend people have stopped trying to game the system. The more secret the rules (and how they are applied), the more a system serves a handful of people who have learned the secret tricks.</p><p>Meanwhile, regular users who are not platform experts trust these systems to be transparent. Trustful users spend more time innovating elsewhere, and they are all disrupted by unexpected secretive tricks.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37136670"><td><table>  <tbody><tr>    <td indent="6"><img src="https://news.ycombinator.com/s.gif" height="1" width="240"></td><td>
      <center><a id="up_37136670" href="https://news.ycombinator.com/vote?id=37136670&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>&gt; <i>So you think secretive measures more often defeat spammers than trusting users?</i><p>Yes. And it's really not a close question.</p><p>"Regular users" don't have to be platform experts and learn tricks and stuff. They just post normal links and comments and never run into moderation at all.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                                                <tr id="37132430"><td></td></tr>
            <tr id="37130261"><td></td></tr>
                <tr id="37131212"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_37131212" href="https://news.ycombinator.com/vote?id=37131212&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>By that logic, the fact that penispowerworldwide.com is banned on HN* means we're biased against your politics.<p>Of the 67k sites banned on HN I would guess that fewer than 0.1% are "news sources", left- or right- or any wing. Why would you expect them to show up in a random sample of 10?</p><p>* which it is! I've unkilled <a href="https://news.ycombinator.com/item?id=1236054">https://news.ycombinator.com/item?id=1236054</a> for the occasion.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="37130315"><td></td></tr>
                <tr id="37131261"><td></td></tr>
                <tr id="37136828"><td></td></tr>
                        <tr id="37130365"><td></td></tr>
            <tr id="37130597"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_37130597" href="https://news.ycombinator.com/vote?id=37130597&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>That's what "random 10 out of 67k sites" gives you. Your set was cherry-picked, dang's wasn't.<p>That said, dailykos.com seems to be banned. Happy now?
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37130645"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_37130645" href="https://news.ycombinator.com/vote?id=37130645&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>&gt; Your set was cherry-picked<p>Not exactly cherry-picked, these were from things I submitted myself and noticed that were shadow flagged.</p><p>&gt; That said, dailykos.com seems to be banned. Happy now?</p><p>No, I'd be happy when archive.is, Federalist and the rest of the non-spammy ones are unbanned. (Also, even if "balanced" censorship was the desired goal, having a single unreliable left-wing source banned vs a ton of right-wing ones doesn't really achieve that.)
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37135652"><td><table>  <tbody><tr>    <td indent="3"><img src="https://news.ycombinator.com/s.gif" height="1" width="120"></td><td>
      <center><a id="up_37135652" href="https://news.ycombinator.com/vote?id=37135652&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>Turn on show dead, browse <a href="https://news.ycombinator.com/newest">https://news.ycombinator.com/newest</a> and take the affirmative community moderation steps of vouching for those that are good.<p>Archive.is shouldn't ever need to be the primary site.  Post a link to the original and then a comment to the archive site if there's the possibility of take down or issues with paywalls.</p><p>It is likely that people were using archive.is for trying to avoid posting the original domain and masking the content that it presented.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="37130688"><td><table>  <tbody><tr>    <td indent="3"><img src="https://news.ycombinator.com/s.gif" height="1" width="120"></td><td>
      <center><a id="up_37130688" href="https://news.ycombinator.com/vote?id=37130688&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>&gt; Not exactly cherry-picked, these were from things I submitted myself and noticed that were shadow flagged.<p>Definitely not random, in any case.</p><p>&gt; Also, even if "balanced" censorship was the desired goal,</p><p>Nobody claimed that. You merely stated that "I don't see a single left-wing new source in there." and I offered a counter-point.</p><p>&gt; having one left-wing source vs a ton of right-wing one doesn't achieve that</p><p>I didn't do an exhaustive search for "left-wing domains" that are banned to present you a complete list, this was attempt 1 of 1.</p><p>Following your model, I could claim that 100% of left-wing domains are banned, but I won't.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="37130701"><td><table>  <tbody><tr>    <td indent="3"><img src="https://news.ycombinator.com/s.gif" height="1" width="120"></td><td>
      <center><a id="up_37130701" href="https://news.ycombinator.com/vote?id=37130701&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>The people behind Federalist can just start a new site where they produce content that’s more interesting to HN users and won’t get banned. It’s a free world. Nobody’s entitled to get their pet domain promoted on another private web site.</span></p></div></td></tr>
        </tbody></table></td></tr>
            <tr id="37130849"><td><table>  <tbody><tr>    <td indent="3"><img src="https://news.ycombinator.com/s.gif" height="1" width="120"></td><td>
      <center><a id="up_37130849" href="https://news.ycombinator.com/vote?id=37130849&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><br><div>
                  <p><span>Have you considered that may speak more to your biases than the site's? How many far left-wing news sites do you regular?</span></p></div></td></tr>
        </tbody></table></td></tr>
                        <tr id="37131422"><td></td></tr>
                  <tr id="37130150"><td></td></tr>
                <tr id="37130210"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_37130210" href="https://news.ycombinator.com/vote?id=37130210&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>The word censorship has so many meanings that I have to ask what you mean by it before I can say whether I see it that way.<p>Is it censorship that the rules of chess say you can't poke someone's queen off the board? We're trying to play a particular game here.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37130254"><td></td></tr>
            <tr id="37131166"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_37131166" href="https://news.ycombinator.com/vote?id=37131166&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>Censorship has a very defined meaning. To take the chess analogy, it would be like allowing one side to poke the queen off the board, and not allow the other. This is very much like what happens at HN today.<p>You're dang right, trying to play a particular [rigged] game here.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37136705"><td><table>  <tbody><tr>    <td indent="3"><img src="https://news.ycombinator.com/s.gif" height="1" width="120"></td><td>
      <center><a id="up_37136705" href="https://news.ycombinator.com/vote?id=37136705&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>What is the "very defined meaning" that you're thinking of?<p>The one that I think makes the most clear sense is "censorship" by a state power. But you must be thinking of something different, because HN is not a state power.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="37131329"><td></td></tr>
                  <tr id="37130250"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_37130250" href="https://news.ycombinator.com/vote?id=37130250&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>&gt; The word censorship has so many meanings that I have to ask what you mean by it before I can say whether I see it that way.<p>Perhaps its one of those things that are hard to define. [1] But that doesn't mean clear cases don't exist.</p><p>&gt; Is it censorship that the rules of chess say you can't poke someone's queen off the board? We're trying to play a particular game here.</p><p>No, but it is clearly political censorship if you only apply the unwritten and secret "rules" of the game to a particular political faction. Also, banning entire domain names is definitely heavy-handed.</p><p>[1]: <a href="https://en.wikipedia.org/wiki/I_know_it_when_I_see_it" rel="nofollow noreferrer">https://en.wikipedia.org/wiki/I_know_it_when_I_see_it</a>
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="37130414"><td><table>  <tbody><tr>    <td indent="3"><img src="https://news.ycombinator.com/s.gif" height="1" width="120"></td><td>
      <center><a id="up_37130414" href="https://news.ycombinator.com/vote?id=37130414&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>&gt; political faction<p>I remember some words that succinctly express something I often observe. To paraphrase:</p><p>&gt; Left-wing and Right-wing are terms which make a lot of people falsely believe that they disagree with each other.</p><p>It is worth trying to find common ground with people “on the other side”.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="37130427"><td><table>  <tbody><tr>    <td indent="3"><img src="https://news.ycombinator.com/s.gif" height="1" width="120"></td><td>
      <center><a id="up_37130427" href="https://news.ycombinator.com/vote?id=37130427&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>&gt; censorship if you only apply the unwritten and secret "rules"<p>I mostly agree. I argued in an article [1] that it's only censorship if the author of the content is not told about the action taken against the content.</p><p>These days though, mods and platforms will generally argue that they're being transparent by telling you that it happens. <i>When</i> it happens is another story altogether that is often not shared.</p><p>[1] <a href="https://www.removednews.com/p/twitters-throttling-of-what-is-a" rel="nofollow noreferrer">https://www.removednews.com/p/twitters-throttling-of-what-is...</a>
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                        <tr id="37130160"><td></td></tr>
                <tr id="37138549"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_37138549" href="https://news.ycombinator.com/vote?id=37138549&amp;how=up&amp;goto=item%3Fid%3D37130147"></a></center>    </td><td><p><span>That's true, but it's a bit of an interesting question because "free speech" has different meanings in different contexts. The thing to understand about HN is that we're trying to optimize for one thing: intellectual curiosity (<a href="https://hn.algolia.com/?dateRange=all&amp;page=0&amp;prefix=true&amp;sort=byDate&amp;type=comment&amp;query=curiosity%20optimiz%20by:dang" rel="nofollow noreferrer">https://hn.algolia.com/?dateRange=all&amp;page=0&amp;prefix=true&amp;sor...</a>). Given that, we're obviously not "free speech" in the sense of "post anything about anything" - we have to moderate things like spam, flamewar, and lame comments like "ok boomer" or whatever, because those detract from intellectually curious discussion.<p>On the other hand, no single political or ideological position has a monopoly on intellectual curiosity either—so by the same principle, HN can't be moderated for political or ideological position.</p><p>It's tricky because working this way conflicts with how everyone's mind works. When people see a politically charged post X that they don't like, or when they see a politically charged post Y that they do like, but which we've moderated, it's basically irresistible not to jump to the conclusion "the mods are biased against Y in favor of X". This is because what people see in the first place is conditioned by their own preferences - we're more likely to notice and to put weight on things we dislike (<a href="https://hn.algolia.com/?dateRange=all&amp;page=0&amp;prefix=true&amp;query=by%3Adang%20notice%20dislike&amp;sort=byDate&amp;type=story&amp;type=comment" rel="nofollow noreferrer">https://hn.algolia.com/?dateRange=all&amp;page=0&amp;prefix=true&amp;que...</a>). People with opposite preferences notice opposite data points and therefore "see" opposite biases. It's the same mechanism at work in each case.</p><p>In reality, though, we're just trying to solve an optimization problem: how can you operate a public internet forum to maximize intellectual curiosity? That's basically all there is to it. It's not so easy to solve though.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                        </tbody></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Ball milling destroys PFAS in contaminated soil (125 pts)]]></title>
            <link>https://phys.org/news/2023-08-chemicals.html</link>
            <guid>37134563</guid>
            <pubDate>Tue, 15 Aug 2023 14:40:13 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://phys.org/news/2023-08-chemicals.html">https://phys.org/news/2023-08-chemicals.html</a>, See on <a href="https://news.ycombinator.com/item?id=37134563">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
										
<div data-thumb="https://scx1.b-cdn.net/csz/news/tmb/2023/forever-chemicals-mayb.jpg" data-src="https://scx2.b-cdn.net/gfx/news/hires/2023/forever-chemicals-mayb.jpg" data-sub-html="Heavily modified shipping containers at EDL's research and development facility in Henderson, Auckland, house the company's patented Mechanochemical Destruction (MCD) reactors. Credit: EDL Ltd">
        <figure>
            <img src="https://scx1.b-cdn.net/csz/news/800a/2023/forever-chemicals-mayb.jpg" alt="`Forever chemicals'? Maybe not" title="Heavily modified shipping containers at EDL's research and development facility in Henderson, Auckland, house the company's patented Mechanochemical Destruction (MCD) reactors. Credit: EDL Ltd" width="800" height="530">
             <figcaption>
                Heavily modified shipping containers at EDL's research and development facility in Henderson, Auckland, house the company's patented Mechanochemical Destruction (MCD) reactors. Credit: EDL Ltd
            </figcaption>        </figure>
    </div>
<p>Dangerous "forever chemicals" left in the soil from firefighting foam could be destroyed by grinding, according to a proof-of-concept study by University of Auckland scientists collaborating with the U.S. Environmental Protection Agency.

										  
											        </p>
										 
										 											  
<p>"Ball milling" appears viable for decontaminating soil from <a href="https://phys.org/tags/military+bases/" rel="tag">military bases</a>, airports, and refineries around the world where the foam was used over decades, according to the University and Environmental Decontamination (NZ) Limited (EDL).
</p><p>Contaminant chemicals called PFAS (per- and polyfluoroalkyl substances) don't break down naturally and, at certain levels, have been linked to cancers, reduced fertility, liver damage and other adverse health effects.
</p><p>"Cleaning up PFAS from the environment is a massive task that will require our continuous and dedicated investment in the coming years," US President Joe Biden's White House said in March. Individual sites can have thousands of tons of contaminated soil, with the US Department of Defense estimating in 2021 that its clean-up could cost $31 billion.
</p><p>Ball milling in a University of Auckland chemistry laboratory destroyed 99.88 percent to 100 percent of PFAS in soil from a decommissioned New Zealand Defence Force firefighting training site and in firefighting foam.
</p><p>Intense grinding at an extremely high speed by metal balls left a safe by-product, according to Dr. Kapish Gobindlal, an honorary academic at the University and the chief scientist for the company EDL.
</p><p>Published in the <a href="https://phys.org/tags/academic+journal/" rel="tag">academic journal</a> <i>Environmental Science: Advances</i>, the research was by Gobindlal and his Ph.D. supervisors, Professor Jon Sperry and Dr. Cameron Weber, of the University's Centre for Green Chemical Science. Collaborating were scientists Erin Shields and Andrew Whitehill of the US EPA.
</p><p>"We've established proof-of-concept and believe this method can be scaled up faster and cheaper than alternatives," says Gobindlal. "There is a massive need—the US alone has thousands of contaminated sites and regulation is shifting toward mandating remediation of these sites."
</p><p>It's exactly what Sperry hoped to achieve when the University set up the Centre for Green Chemical Science, which puts the environment at the forefront.
</p><p>"Work in the lab is flowing quickly toward real-world benefits," Sperry said. "This is an example of green chemistry that can help communities, the environment and, in fact, the world."


											  													    </p>
											  
											  <p>Numbering in their thousands, forever chemicals resist water, oil and heat, famously featuring in Teflon non-stick pans but also in everything from burger wrappers and pizza boxes to waterproof clothing.
</p><p>Firefighters used "aqueous film-forming foam" containing PFAS to blanket and smother flammable liquid fires.
</p><p>PFAS are in animals—even plankton—and in humans' blood and <a href="https://phys.org/tags/breast+milk/" rel="tag">breast milk</a> because of carbon-fluorine bonds which prevent the chemicals breaking down. Like microplastics, they are ubiquitous, turning up in drinking water and even rain.
</p><p>While contaminated soil is only part of the problem, it's a big part.
</p><p>In some ways, "ball milling" is not all that different from the grinding of a mortar and pestle, but at an extremely high intensity, with the balls moving at incredible speeds to degrade the PFAS at a <a href="https://phys.org/tags/molecular+level/" rel="tag">molecular level</a>, says Gobindlal.
</p><p>Crucial to ramping up is cost, including whether the grinding process requires expensive additives. Affordable and easy-to-source quartz sand was used as part of the treatment for firefighting foam, says Gobindlal, while no additive was needed for soil.
</p><p>Laboratory benchtop experiments at the University from 2018 to 2023 typically involved 10 to 30 small metal balls colliding to destroy PFAS in soil, in firefighting foam, and in media such as activated carbon, which is used to remove PFAS from water. The process left an inert powder suitable for being a grinding additive or non-hazardous fill.
</p><p>Heavily modified shipping containers at EDL's research and development facility in Henderson, Auckland, house the company's patented Mechanochemical Destruction (MCD) reactors, intended to treat contaminated soil at speed and scale—potentially dealing with several tons per hour.
</p><p>In New Zealand, PFAS soil contamination occurred at locations such as Royal New Zealand Air Force bases Woodbourne (west of Blenheim) and Ohakea (near Palmerston North). Banned in New Zealand in 2011, the firefighting foams were still found at sites including airports years later, according to New Zealand's Environmental Protection Agency.
</p><p>Last year, Channel Infrastructure NZ, an operator of the Marsden Point Oil Refinery in Northland, was fined for using firefighting foam containing PFAS.
</p><p>"In addition to the known PFAS-contaminated locations, there are likely many more unknown sites yet to be identified through active investigation from both governmental and private entities," according to Gobindlal. "We're likely just at the tip of the iceberg."
</p><p>In the US, the chemical and manufacturing company 3M negotiated a $10 billion settlement with cities and towns over PFAS pollution in water. In Europe, a group of news organisations including Le Monde say at least 17,000 sites across Europe and the UK are contaminated with PFAS.
</p><p>New Zealand's EPA has proposed a ban on PFAS in cosmetics. The chemicals are in our drinking water, but at lower concentrations than in other countries.
</p><p>Levels in water "are still concerning because PFAS bioaccumulate and biomagnify; they build up in our bodies, environment, and food web," wrote Dr. Lokesh Padhye, Dr. Erin Leitao, and Dr. Melanie Kah, of the University's faculties of science and engineering, in <i>Newsroom</i> in March
										 																				
																				</p><p><strong>More information:</strong>
												Kapish Gobindlal et al, Mechanochemical destruction of per- and polyfluoroalkyl substances in aqueous film-forming foams and contaminated soil, <i>Environmental Science: Advances</i> (2023).  <a data-doi="1" href="https://dx.doi.org/10.1039/D3VA00099K" target="_blank">DOI: 10.1039/D3VA00099K</a>
																						
																					</p>
                               											
																					
                              										                                        
										<!-- print only -->
										<div>
											 <p><strong>Citation</strong>:
												'Forever chemicals'? Maybe not (2023, August 14)
												retrieved 15 August 2023
												from https://phys.org/news/2023-08-chemicals.html
											 </p>
											 <p>
											 This document is subject to copyright. Apart from any fair dealing for the purpose of private study or research, no
											 part may be reproduced without the written permission. The content is provided for information purposes only.
											 </p>
										</div>
                                        
									</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Code Is Not Literature (2014) (202 pts)]]></title>
            <link>https://gigamonkeys.com/code-reading/</link>
            <guid>37134520</guid>
            <pubDate>Tue, 15 Aug 2023 14:36:35 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://gigamonkeys.com/code-reading/">https://gigamonkeys.com/code-reading/</a>, See on <a href="https://news.ycombinator.com/item?id=37134520">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
                
                
                <p>I have started code reading groups at the last two companies I’ve worked at, Etsy and Twitter, and some folks have asked for my advice about code reading and running code reading groups. Tl;dr: don’t start a code reading group. What you should start instead I’ll get to in a moment but first I need to explain how I arrived at my current opinion.</p>
                <p>As a former English major and a sometimes writer, I had always been drawn to the idea that code is like literature and that we ought to learn to write code the way we learn to write English: by reading good examples. And I’m certainly not the only one to have taken this point of view—Donald Knuth, in addition to his work on <i>The Art of Computer Programming</i> and TeX, has long been a proponent of what he calls Literate Programming and has published several of his large programs as books.</p>
                <p>On the other hand, long before I got to Etsy and started my first code reading group I had in hand several pieces of evidence that should have suggested to me that this was the wrong way to look at things.</p>
                <p>First, when I did my book of interviews with programmers, <a href="http://www.codersatwork.com/">Coders at Work</a>, I asked pretty much everyone about code reading. And while most of them said it was important and that programmers should do it more, when I asked them about what code they had read recently, very few of them had any great answers. Some of them had done some serious code reading as young hackers but almost no one seemed to have a regular habit of reading code. Knuth, the great synthesizer of computer science, does seem to read a lot of code and Brad Fitzpatrick was able to talk about several pieces of open source code that he had read just for the heck of it. But they were the exceptions.</p>
                <p>If that wasn’t enough, after I finished <i>Coders</i> I had a chance to <a href="http://www.gigamonkeys.com/code-quarterly/2011/hal-abelson/">interview Hal Abelson</a>, the famous MIT professor and co-author of the <i>Structure and Interpretation of Computer Programs</i>. The first time I talked to him I asked my usual question about reading code and he gave the standard answer—that it was important and we should do it more. But he too failed to name any code he had read recently other than code he was obliged to: reviewing co-workers’ code at Google where he was on sabbatical and grading student code at MIT. Later I asked him about this disconnect:</p>
                <blockquote>
                <div>
                    <p><i>Seibel:</i> I’m still curious about this split between what people say and what they actually do. Everyone says, “People should read code” but few people seem to actually do it. I’d be surprised if I interviewed a novelist and asked them what the last novel they had read was, and they said, “Oh, I haven’t really read a novel since I was in grad school.” Writers actually read other writers but it doesn’t seem that programmers really do, even though we say we should.</p>
                    <p><i>Abelson:</i> Yeah. You’re right. But remember, a lot of times you crud up a program to make it finally work and do all of the things that you need it to do, so there’s a lot of extraneous stuff around there that isn’t the core idea.</p>
                    <p><i>Seibel:</i> So basically you’re saying that in the end, most code isn’t worth reading?</p>
                    <p><i>Abelson:</i> Or it’s built from an initial plan or some kind of pseudocode. A lot of the code in books, they have some very cleaned-up version that doesn’t do all the stuff it needs to make it work.</p>
                    <p><i>Seibel:</i> I’m thinking of the preface to SICP, where it says, “programs must be written for people to read and only incidentally for machines to execute.” But it seems the reality you just described is that in fact, most programs are written for machines to execute and only incidentally, if at all, for people to read.</p>
                    <p><i>Abelson:</i> Well, I think they start out for people to read, because there’s some idea there. You explain stuff. That’s a little bit of what we have in the book. There are some fairly significant programs in the book, like the compiler. And that’s partly because we think the easiest way to explain what it’s doing is to express that in code.</p>
                </div>
                </blockquote>
                <p>Yet somehow even this explicit acknowledgement that most real code isn’t actually in a form that can be simply read wasn’t enough to lead me to abandon the literature seminar model when I got to Etsy. For our first meeting I picked Jeremy Ashkenas’s backbone.js because many of the Etsy developers would be familiar with Javascript and because I know Jeremy is particularly interested in writing readable code. I still envisioned something like a literature seminar but I figured that a lot of people wouldn’t actually have done the reading in advance (well, maybe not so different from a literature seminar) so I decided to start things off by presenting the code myself before the group discussion.</p>
                <p>As I prepared my presentation, I found myself falling into my usual pattern when trying to really understand a piece of code—in order to grok it I have to essentially rewrite it. I’ll start by renaming a few things so they make more sense to me and then I’ll move things around to suit my ideas about how to organize code. Pretty soon I’ll have gotten deep into the abstractions (or lack thereof) of the code and will start making bigger changes to the structure of the code. Once I’ve completely rewritten the thing I usually understand it pretty well and can even go back to the original and understand it too. I have always felt kind of bad about this approach to code reading but it's the only thing that's ever worked for me.</p>
                <p>My presentation to the code reading group started with stock backbone.js and then walked through the changes I would make to it to make it, by my lights, more understandable. At one point I asked if people thought we should move on to the group discussion but nobody seemed very interested. Hopefully seeing my refactoring gave people some of the same insights into the underlying structure of the original that I had obtained by doing the refactoring.</p>
                <p>The second meeting of the Etsy code reading group featured Avi Bryant demonstrating how to use the code browsing capabilities of Smalltalk to navigate through some code. In that case, because few of the Etsy engineers had any experience with Smalltalk, we had no expectation that folks would read the code in advance. But the presentation was an awesome chance for folks to get exposed to the power of the Smalltalk development environment and for me to heckle Avi about Smalltalk vs Lisp differences.</p>
                <hr>
                <p>When I got to Twitter I inexplicably still had the literature seminar model in mind even though neither of the two meetings of the Etsy reading group—which folks seemed to like pretty well—followed that model at all. When I sent out the email inviting Twitter engineers to join a code reading group the response was pretty enthusiastic. The first meeting was, yet again, a presentation of some code, in this case the internals of the Scala implementation of Future that is used throughout Twitter’s many services, presented by Marius Eriksen, who wrote most of it.</p>
                <p>It was sometime after that presentation that I finally realized the obvious: code is not literature. We don’t read code, we <i>decode</i> it. We examine it. A piece of code is not literature; it is a specimen. Knuth said something that should have pointed me down this track when I asked him about his own code reading:</p>
                <blockquote>
                <p><i>Knuth:</i> But it’s really worth it for what it builds in your brain. So how do I do it? There was a machine called the Bunker Ramo 300 and somebody told me that the Fortran compiler for this machine was really amazingly fast, but nobody had any idea why it worked. I got a copy of the source-code listing for it. I didn’t have a manual for the machine, so I wasn’t even sure what the machine language was.</p>
                <p>But I took it as an interesting challenge. I could figure out <code>BEGIN</code> and then I would start to decode. The operation codes had some two-letter mnemonics and so I could start to figure out “This probably was a load instruction, this probably was a branch.” And I knew it was a Fortran compiler, so at some point it looked at column seven of a card, and that was where it would tell if it was a comment or not.</p>
                <p>After three hours I had figured out a little bit about the machine. Then I found these big, branching tables. So it was a puzzle and I kept just making little charts like I’m working at a security agency trying to decode a secret code. But I knew it worked and I knew it was a Fortran compiler—it wasn’t encrypted in the sense that it was intentionally obscure; it was only in code because I hadn’t gotten the manual for the machine.</p>
                <p>Eventually I was able to figure out why this compiler was so fast. Unfortunately it wasn’t because the algorithms were brilliant; it was just because they had used unstructured programming and hand optimized the code to the hilt.</p>
                <p>It was just basically the way you solve some kind of an unknown puzzle—make tables and charts and get a little more information here and make a hypothesis. In general when I’m reading a technical paper, it’s the same challenge. I’m trying to get into the author’s mind, trying to figure out what the concept is. The more you learn to read other people’s stuff, the more able you are to invent your own in the future, it seems to me.</p>
                </blockquote>
                <p>He’s not describing reading literature; he’s describing a scientific investigation. So now I have a new mode for how people should get together to gain insights from code which I explained to the Twitter code reading group like this:</p>
                <blockquote>
                <p>Preparing for the talk I’m going to give to the Girls who Code cohort, I started thinking about what to tell them about code reading and code they should read. And once again it struck me that for all the lip service we pay to the idea of reading code, most programmers really don’t read that much code, at least not just for the sake of reading it. As a simple proof: name me one piece of code that you’ve read and that you can be reasonably sure that most other good programmers will have read or will at least have heard of. Not many, right? Probably none.</p>
                <p>But then it hit me. Code is not literature and we are not readers. Rather, interesting pieces of code are specimens and we are naturalists. So instead of trying to pick out a piece of code and reading it and then discussing it like a bunch of Comp Lit. grad students, I think a better model is for one of us to play the role of a 19th century naturalist returning from a trip to some exotic island to present to the local scientific society a discussion of the crazy beetles they found: “Look at the antenna on this monster! They look incredibly ungainly but the male of the species can use these to kill small frogs in whose carcass the females lay their eggs.”</p>
                <p>The point of such a presentation is to take a piece of code that the presenter has understood deeply and for them to help the audience understand the core ideas by pointing them out amidst the layers of evolutionary detritus (a.k.a. kluges) that are also part of almost all code. One reasonable approach might be to show the real code and then to show a stripped down reimplementation of just the key bits, kind of like a biologist staining a specimen to make various features easier to discern.</p>
                <p>The ideal presentation should be aimed at an audience of gentleman and lady programmers—smart, and generally capable but without, necessarily, any specific knowledge of the domain from which the code comes. Presentations should provide enough context for the audience to to understand what the code is and should explain any details of the implementation language that may be obscure to the average programmer.</p>
                </blockquote>
                <p>Since I had my epiphany we’ve had several meetings of the code reading group, now known as the Royal Society of Twitter for Improving Coding Knowledge, along the new lines. We’re still learning about the best ways to present code but the model feels very right. Also, I no longer feel bad about my dissection-based approach to reading code.</p>
                <p>The biggest lesson so far is that code is very dense. A half hour presentation is just enough time to present maybe a dozen meaty lines of code and one main idea. It is also almost certainly the case that the presenters, who have to actually really dig down into a piece of code, get more out of it than anybody. But it does seem that a good presentation can at least expose people to the main ideas and maybe give them a head start if they do decide to read the code themselves.</p>
                <hr>
            </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Schizophrenia drugs may have been off target for decades, study finds (140 pts)]]></title>
            <link>https://www.msn.com/en-us/health/medical/schizophrenia-drugs-may-have-been-off-target-for-decades-study-finds/ar-AA1fh9Nt</link>
            <guid>37134373</guid>
            <pubDate>Tue, 15 Aug 2023 14:24:13 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.msn.com/en-us/health/medical/schizophrenia-drugs-may-have-been-off-target-for-decades-study-finds/ar-AA1fh9Nt">https://www.msn.com/en-us/health/medical/schizophrenia-drugs-may-have-been-off-target-for-decades-study-finds/ar-AA1fh9Nt</a>, See on <a href="https://news.ycombinator.com/item?id=37134373">Hacker News</a></p>
&lt;Unparsable&gt;]]></description>
        </item>
        <item>
            <title><![CDATA[Show HN: Layerform – Open-source development environments using Terraform files (107 pts)]]></title>
            <link>https://github.com/ergomake/layerform</link>
            <guid>37134293</guid>
            <pubDate>Tue, 15 Aug 2023 14:15:51 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://github.com/ergomake/layerform">https://github.com/ergomake/layerform</a>, See on <a href="https://news.ycombinator.com/item?id=37134293">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><p dir="auto">
  <a href="https://layerform.dev/" rel="nofollow">
  <themed-picture data-catalyst-inline="true"><picture>
    <source width="320px" media="(prefers-color-scheme: dark)" srcset="https://github.com/ergomake/layerform/raw/main/assets/img/layerformspawn-dark-sm.png">
    <source width="320px" media="(prefers-color-scheme: light)" srcset="https://github.com/ergomake/layerform/raw/main/assets/img/layerformspawn-light-sm.png">
    <img width="320px" alt="layerform logo" src="https://github.com/ergomake/layerform/raw/main/assets/img/layerformspawn-light-sm.png">
    </picture></themed-picture>
  </a>
</p>
<h2 tabindex="-1" dir="auto">
  Layerform
</h2>
<p dir="auto">
    <strong>
        Layerform helps engineers create reusable environment stacks using plain `.tf` files.
    </strong>
</p>
<br>
<h4 tabindex="-1" dir="auto">
  <a href="https://layerform.dev/" rel="nofollow">Home Page</a> |
  <a href="https://docs.layerform.dev/" rel="nofollow">Documentation</a> |
  <a href="https://discord.gg/daGzchUGDt" rel="nofollow">Discord</a>
</h4>
<p dir="auto">
  <a href="https://github.com/ergomake/layerform/blob/main/LICENSE">
    <img src="https://camo.githubusercontent.com/2d89d818e6da8da6bfa2d293d8773e7e23d823fbb8d4980efb9e1e01f3eb63e9/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f6c6963656e73652f6572676f6d616b652f6c61796572666f726d" alt="Layerform is released under the GNU GPLv3 license." data-canonical-src="https://img.shields.io/github/license/ergomake/layerform">
  </a>
  <a href="https://discord.gg/daGzchUGDt" rel="nofollow">
    <img src="https://camo.githubusercontent.com/0129a2a4521a92b747ea0077af48a84eaaa3a91a9f684aa1f0fbf96f61abfc84/68747470733a2f2f696d672e736869656c64732e696f2f646973636f72642f31303535383336313433373333373036383734" alt="Discord Chat" data-canonical-src="https://img.shields.io/discord/1055836143733706874">
  </a>
  <a href="https://twitter.com/intent/follow?screen_name=GetErgomake" rel="nofollow">
    <img src="https://camo.githubusercontent.com/99a370bbb8631b9bcb02282d9cc3bc6d1cbafa561852aaa0c00da280ffe14836/68747470733a2f2f696d672e736869656c64732e696f2f747769747465722f666f6c6c6f772f4765744572676f6d616b652e7376673f6c6162656c3d466f6c6c6f77253230404765744572676f6d616b65" alt="Follow @GetErgomake" data-canonical-src="https://img.shields.io/twitter/follow/GetErgomake.svg?label=Follow%20@GetErgomake">
  </a>
</p>

<p dir="auto"><strong>After HashiCorp's announcement that they're not using the MPL license anymore, we'll be building on top of a community-supported fork.</strong></p>
<br>
<h2 tabindex="-1" dir="auto">What is Layerform?</h2>
<p dir="auto"><strong>Layerform is a Terraform wrapper that helps engineers build reusable infrastructure using plain Terraform files.</strong></p>
<p dir="auto">To enable reuse, Layerform introduces the concept of <em>layers</em>. Each layer contains some infrastructure and can be stacked up on top of another layer.</p>
<p dir="auto">In addition to being much easier to use, Layerform allows teams to reuse core-pieces of infrastructure. That way, development infrastructure is much cheaper and quicker to spin up. With Layerform, Engineers only spawn the infrastructure layers they need.</p>
<p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://github.com/ergomake/layerform/blob/main/assets/img/dev-environments.png"><img width="600px" src="https://github.com/ergomake/layerform/raw/main/assets/img/dev-environments.png"></a>
</p>
<blockquote>
<p dir="auto">For those wanting development environments: we don't want to run your text-editor. Layerform is the standard tool for development <em>infrastructure</em>. You can keep using your text-editors, IDEs, and other local development directly on your machine.</p>
</blockquote>
<br>
<h2 tabindex="-1" dir="auto">Why use Layerform</h2>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/ergomake/layerform/blob/main/assets/img/crocodile-spawn.png"><img width="384px" src="https://github.com/ergomake/layerform/raw/main/assets/img/crocodile-spawn.png"></a></p>
<h3 tabindex="-1" dir="auto">Cheaper and quicker development infrastructure</h3>
<p dir="auto">Layerform is much cheaper and quicker than spinning up an entire <code>staging</code> environment for each engineer.</p>
<p dir="auto">When using Layerform, engineers can share the same core-pieces of infrastructure, and only spin up the layers they need on top of it.</p>
<p dir="auto">For example, if you run applications in a Kubernetes cluster, you don't have to create a brand new cluster for each engineer's environment. Instead, you can reuse the same cluster and have multiple engineers spin up their applications on top of it.</p>
<br>
<h3 tabindex="-1" dir="auto">It's just like production, every time</h3>
<p dir="auto">Layerform's environments are just like production because they are spun up from plain <code>.tf</code> files.</p>
<p dir="auto">Whatever you can set up using a <code> .tf</code> file, you can set up in a Layerform layer.</p>
<p dir="auto">That way, <strong>your development infrastructure will be just like production, including Lambdas, DynamoDB instances, and whatever else that you need</strong>.</p>
<br>
<h3 tabindex="-1" dir="auto">You own the infrastructure and permissions</h3>
<p dir="auto">Layerform runs in <em>your</em> infrastructure. Layerform will store state and spin up resources in <em>your</em> cloud providers. Therefore, you have full control over who gets access to what, and what resources are currently running, and how much they cost.</p>
<br>
<h3 tabindex="-1" dir="auto">Encapsulation / Isolation of concerns</h3>
<p dir="auto">By breaking infrastructure into layers, your organization can define clearer boundaries between teams. Consequently, it will be easier to <a href="https://martinfowler.com/bliki/ConwaysLaw.html" rel="nofollow">mirror your organization's structure into your system's structure</a>.</p>
<p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://github.com/ergomake/layerform/blob/main/assets/img/layers-vs-org.png"><img width="600px" src="https://github.com/ergomake/layerform/raw/main/assets/img/layers-vs-org.png"></a>
</p>
<br>
<h3 tabindex="-1" dir="auto">Cost attribution and cost savings</h3>
<p dir="auto">In addition to saving costs by reusing infrastructure, Layerform allows you to automatically track costs for each layer instance.</p>
<p dir="auto">When applying layers, Layerform will automatically tag the resources it creates with the actual name assigned to the layer instance. If you have <code>production</code> and <code>development</code> base layers, for example, each of those two will contain the tags <code>layerform_layer_name</code> and <code>layerform_layer_instance</code> with their respective names.</p>
<p dir="auto">That way, Layerform can recursively traverse layers' resources to collect cost management information. Consequently, it will be able to tell the cost of your whole <code>production</code> and <code>development</code> layers, as well as an aggregate cost report of everything on top of those layers.</p>
<br>
<h2 tabindex="-1" dir="auto">Getting started</h2>
<p dir="auto">First, install the Layerform CLI.</p>
<div data-snippet-clipboard-copy-content="$ go install github.com/ergomake/layerform@latest"><pre><code>$ go install github.com/ergomake/layerform@latest
</code></pre></div>
<p dir="auto">Then, create the Terraform files you'll use to create each layer of infrastructure. In the example below, we have two layers: <code>eks</code>, which is the "base" layer, and <code>services</code>.</p>
<div data-snippet-clipboard-copy-content="layerform/
├─ services/
│ ├─ pods.tf
│ ├─ outputs.tf
│ └─ inputs.tf
├─ eks/
│ ├─ eks.tf
│ ├─ vpc.tf
│ ├─ inputs.tf
│ └─ outputs.tf
├─ services.tf
└─ eks.tf"><pre><code>layerform/
├─ services/
│ ├─ pods.tf
│ ├─ outputs.tf
│ └─ inputs.tf
├─ eks/
│ ├─ eks.tf
│ ├─ vpc.tf
│ ├─ inputs.tf
│ └─ outputs.tf
├─ services.tf
└─ eks.tf
</code></pre></div>
<p dir="auto">Once you have your infrastructure defined as code, you'll create the layer definitions that the CLI will use when spawning instances of each layer.</p>
<div dir="auto" data-snippet-clipboard-copy-content="{
    &quot;layers&quot;: [
        {
            &quot;name&quot;: &quot;base&quot;,
            &quot;files&quot;: [&quot;./layerform/eks.tf&quot;, &quot;./layerform/eks/**&quot;]
        },
        {
            &quot;name&quot;: &quot;services&quot;,
            &quot;files&quot;: [&quot;./layerform/services.tf&quot;, &quot;./layerform/services/**&quot;],
            &quot;dependencies&quot;: [&quot;base&quot;]
        }
    ]
}"><pre>{
    <span>"layers"</span>: [
        {
            <span>"name"</span>: <span><span>"</span>base<span>"</span></span>,
            <span>"files"</span>: [<span><span>"</span>./layerform/eks.tf<span>"</span></span>, <span><span>"</span>./layerform/eks/**<span>"</span></span>]
        },
        {
            <span>"name"</span>: <span><span>"</span>services<span>"</span></span>,
            <span>"files"</span>: [<span><span>"</span>./layerform/services.tf<span>"</span></span>, <span><span>"</span>./layerform/services/**<span>"</span></span>],
            <span>"dependencies"</span>: [<span><span>"</span>base<span>"</span></span>]
        }
    ]
}</pre></div>
<p dir="auto">Now, configure the place in which the generated layer definitions will be saved.</p>
<div dir="auto" data-snippet-clipboard-copy-content="# In config inside ~/.layerform
currentContext: remote-context
contexts:
    remote-context:
        type: s3
        bucket: layerform-bucket-example"><pre><span><span>#</span> In config inside ~/.layerform</span>
<span>currentContext</span>: <span>remote-context</span>
<span>contexts</span>:
    <span>remote-context</span>:
        <span>type</span>: <span>s3</span>
        <span>bucket</span>: <span>layerform-bucket-example</span></pre></div>
<p dir="auto">Finally, you should provision S3 with your layer definitions using <code>layerform configure</code>.</p>
<p dir="auto">The Layerform CLI will then take care of creating unique IDs for each layer and sending the Terraform files' contents to the Layerform back-end, which, in this case, is an S3 bucket.</p>
<p dir="auto">After provisioning layer definitions, you can use <code>layerform spawn &lt;definition_name&gt; &lt;desired_id&gt;</code> to create an instance of that particular layer.</p>
<div data-snippet-clipboard-copy-content="$ layerform spawn services my-dev-infra"><pre><code>$ layerform spawn services my-dev-infra
</code></pre></div>
<p dir="auto">Each instance of a layer contains all the pieces of infrastructure defined within that layer's files.</p>
<p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://github.com/ergomake/layerform/blob/main/assets/img/default-base-layer.png"><img width="500px" src="https://github.com/ergomake/layerform/raw/main/assets/img/default-base-layer.png"></a>
</p>
<p dir="auto">In this example, running that command will cause Layerform to also create an instance of the underlying <code>eks</code> layer and assign it the ID <code>default</code>.</p>
<p dir="auto">To spawn yet another <code>services</code> layer, just run <code>layerform spawn services another-dev-infra</code>. By default, Layerform will try to use underlying layers whose ID is <code>default</code> as base layers.</p>
<p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://github.com/ergomake/layerform/blob/main/assets/img/multiple-top-layers.png"><img width="600px" src="https://github.com/ergomake/layerform/raw/main/assets/img/multiple-top-layers.png"></a>
</p>
<p dir="auto">As a general rule, underlying layers are always the ones whose ID is <code>default</code>. To specify the desired ID for each underlying layer, you'll have to use the <code>--base</code> parameter. For example:</p>
<div data-snippet-clipboard-copy-content="# Creates:
# 1. An eks layer with ID &quot;one&quot;
# 2. A services layer with ID &quot;two&quot;

$ layerform spawn services two --base &quot;eks=one&quot;"><pre><code># Creates:
# 1. An eks layer with ID "one"
# 2. A services layer with ID "two"

$ layerform spawn services two --base "eks=one"
</code></pre></div>
<p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://github.com/ergomake/layerform/blob/main/assets/img/one-two-layers.png"><img src="https://github.com/ergomake/layerform/raw/main/assets/img/one-two-layers.png"></a>
</p>
<br>
<h2 tabindex="-1" dir="auto">Layer immutability and layer rebasing</h2>
<p dir="auto">A layer can only mutate itself or the layers above. For example, if you have a <code>base</code> layer and a <code>backend</code> layer, the <code>backend</code> layer's Terraform files will <em>not</em> be able to mutate any infrastructure in a <code>base</code> layer instance. Still, the <code>base</code> layer files can mutate any instances of the layers above it.</p>
<p dir="auto">The way Layerform prevents undesirable mutations is by analyzing each <code>terraform plan</code> and detecting whether any mutation's target belongs to an underlying layer.</p>
<p dir="auto">The reason Layerform prevents a layer from mutating its underlying layer is to avoid breaking sibling pieces of infrastructure.</p>
<p dir="auto">This design allows for platform teams to "rebase" layer instances on top of theirs. For example, assume you have multiple application layers on top of a Kubernetes cluster belonging to a <code>base</code> layer. In that case, if the platform team wants to update the Kubernetes version and needs to patch existing application's manifests, they can do so from their own layer by referencing and patching other Terraform resources.</p>
<p dir="auto">On the other hand, product engineers on the layers above cannot modify the <code>base</code> layer containing the Kubernetes cluster. Otherwise, they could break everyone else's applications.</p>
<p dir="auto">In addition to preventing failures, immutability defines clearer communication interfaces between teams and helps organizations avoid lots of lateral channels.</p>
<br>
<h2 tabindex="-1" dir="auto">How Layerform works</h2>
<p dir="auto">Layerform has three major components. The <code>layerform-provider</code>, the Layerform Back-end, and Layerform CLI.</p>
<blockquote>
<p dir="auto">For now, we're only using the JSON file for configurations. The provider will be made publicly available soon.</p>
</blockquote>
<p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://github.com/ergomake/layerform/blob/main/assets/img/all-components.png"><img width="700px" src="https://github.com/ergomake/layerform/raw/main/assets/img/all-components.png"></a>
</p>
<p dir="auto">The <code>layerform-provider</code> is used by Terraform to provision the Layerform Back-end with all the metadata for each layer, like its name and dependencies, and all the Terraform files associated with that layer.</p>
<p dir="auto">The Layerform Back-end stores the data for each layer definition and stores the state for each instance of each layer so that new layers know which base state to use.</p>
<blockquote>
<p dir="auto">There can be multiple types of back-ends. The most common types of back-end are <code>local</code>, for storing data locally, and <code>s3</code>, for storing data on the cloud, in an S3 bucket.</p>
</blockquote>
<p dir="auto">Finally, the Layerform CLI talks to the Layerform Back-end to fetch the files for the layer it wants to apply, and the state for the underlying layer.</p>
<p dir="auto">The way the Layerform CLI creates new layers on top of the correct existing layers is by injecting the underlying layer's state when applying each layer.</p>
<br>
<h2 tabindex="-1" dir="auto">Layerform design philosophy</h2>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/ergomake/layerform/blob/main/assets/img/bear-spawn.png"><img width="384px" src="https://github.com/ergomake/layerform/raw/main/assets/img/bear-spawn.png"></a></p>
<p dir="auto">Our main goal with Layerform was to make it as easy as possible for engineers to create and share different parts of their infrastructure. That way, we'd empower teams to create their own environments without burdening their organization with unnecessary costs or complex configuration files.</p>
<p dir="auto">When developing Layerform, we also determined it should support virtually <em>any</em> type of infrastructure, including infrastructure for serverless applications. That's why we decided to create a wrapper on top of a comunity fork of Terraform, which supports Kubernetes/Helm, and already has established providers for all major public clouds.</p>
<p dir="auto">Third, we decided Layerform should be simple and intuitive. Engineers shouldn't have to learn new proprietary languages or configuration formats to use Layerform. Whenever possible, we should allow them to reuse their existing configurations. Layerform concepts are the only thing engineers will need to learn about. Everything else should be "just Terraform".</p>
<p dir="auto">Finally, we decided Layerform needs to be open and free. It's for that reason we're using a GPL license for the wrapper and using a community-maintained fork. That's also why you don't necessarily need to pay for anything before you can extract value from Layerform.</p>
<p dir="auto">For the sake of transparency, the way we intend to make money in the future is by providing a managed service with governance, management, and cost-control features.</p>
<p dir="auto">If you wish to bundle the Layerform wrapper itself, the GPL license will take care of ensuring ourselves and the community gets value back.</p>
<br>
<h2 tabindex="-1" dir="auto">Issues &amp; Support</h2>
<p dir="auto">You can find Layerform's users and maintainers in <a href="https://github.com/ergomake/layerform/discussions">GitHub Discussions</a>. There you can ask how to set up Layerform, ask us about the roadmap, and discuss any other related topics.</p>
<p dir="auto">You can also reach us directly (and more quickly) on our <a href="https://discord.gg/daGzchUGDt" rel="nofollow">Discord server</a>.</p>
<br>
<h2 tabindex="-1" dir="auto">Other channels</h2>
<ul dir="auto">
<li><a href="https://github.com/ergomake/layerform/issues">Issue Tracker</a></li>
<li><a href="https://twitter.com/GetErgomake" rel="nofollow">Twitter</a></li>
<li><a href="https://www.linkedin.com/company/layerform" rel="nofollow">LinkedIn</a></li>
<li><a href="https://ergomake.dev/blog" rel="nofollow">Ergomake Engineering Blog</a></li>
</ul>
<br>
<h2 tabindex="-1" dir="auto">License</h2>
<p dir="auto">Layerform is open-source.</p>
<p dir="auto">Licensed under the <a href="https://github.com/layerform/layerform/blob/main/LICENSE">GNU GPLv3 License</a>.</p>
<p dir="auto">
  <a target="_blank" rel="noopener noreferrer" href="https://github.com/ergomake/layerform/blob/main/assets/img/lgtm-gnu.png"><img src="https://github.com/ergomake/layerform/raw/main/assets/img/lgtm-gnu.png" alt="" width="384px"></a>
</p>
<p dir="auto">Layerform is not associated with Terraform. Terraform is a registered trademark of HashiCorp, Inc.</p>
</article>
          </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Firefox finally outperforming Google Chrome in SunSpider (799 pts)]]></title>
            <link>https://www.phoronix.com/news/Firefox-Faster-SunSpider</link>
            <guid>37134092</guid>
            <pubDate>Tue, 15 Aug 2023 13:58:44 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.phoronix.com/news/Firefox-Faster-SunSpider">https://www.phoronix.com/news/Firefox-Faster-SunSpider</a>, See on <a href="https://news.ycombinator.com/item?id=37134092">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
<p><img alt="MOZILLA" src="https://www.phoronix.com/assets/categories/mozilla.webp" width="100" height="100"></p><p>
Mozilla developers are celebrating that they are now faster than Google Chrome with the SunSpider JavaScript benchmark, although that test has been superseded by the JetStream benchmark.
</p><p>
Last week a new Firefox Nightly News was published that outlines that "We’re now apparently beating Chrome on the SunSpider JavaScript benchmark!" The provided numbers now show Firefox easily beating Chrome in this decade-old JavaScript benchmark.
</p><p><img src="https://www.phoronix.net/image.php?id=2023&amp;image=firefox_faster_sunspider" alt="SunSpider browser benchmark results"></p>
<p>The benchmarks come from <a href="https://arewefastyet.com/win10/benchmarks/overview?numDays=60">AreWeFastYet.com</a>. Meanwhile for the newer and more demanding JetStream 2.0 benchmark, Google Chrome continues to win easily over Firefox:
</p><p><img src="https://www.phoronix.net/image.php?id=2023&amp;image=chrome_jetstream_win" alt="Chrome much faster in JetStream 2"></p>
<p>Besides Firefox running the JavaScript SunSpider benchmark much faster over the roughly past month, there's been work on the HTTP/2 upload speed improvements, and various other enhancements.
</p><p>
Learn about the latest Firefox Nightly build advancements via the <a href="https://blog.nightly.mozilla.org/2023/08/10/a-view-to-a-better-faster-web-these-weeks-in-firefox-issue-143/">Firefox Nightly News</a>.</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Entrepreneurship for Engineers: Selling Open Source Software (174 pts)]]></title>
            <link>https://thenewstack.io/entrepreneurship-for-engineers-selling-open-source-software/</link>
            <guid>37134089</guid>
            <pubDate>Tue, 15 Aug 2023 13:58:17 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://thenewstack.io/entrepreneurship-for-engineers-selling-open-source-software/">https://thenewstack.io/entrepreneurship-for-engineers-selling-open-source-software/</a>, See on <a href="https://news.ycombinator.com/item?id=37134089">Hacker News</a></p>
Couldn't get https://thenewstack.io/entrepreneurship-for-engineers-selling-open-source-software/: Error: Request failed with status code 403]]></description>
        </item>
        <item>
            <title><![CDATA[Stellar Developers (602 pts)]]></title>
            <link>https://stellarsamurai.com/</link>
            <guid>37133872</guid>
            <pubDate>Tue, 15 Aug 2023 13:38:51 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://stellarsamurai.com/">https://stellarsamurai.com/</a>, See on <a href="https://news.ycombinator.com/item?id=37133872">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="MainContent" role="main" tabindex="-1">
      <div id="shopify-section-template--19422400577876__41a3ff50-b491-469f-8cd8-eaebc2dacd24"><p>
        <h2 id="SectionHeading-template--19422400577876__41a3ff50-b491-469f-8cd8-eaebc2dacd24">
          Favorite Categories
        </h2></p><slider-component>
      <ul id="Slider-template--19422400577876__41a3ff50-b491-469f-8cd8-eaebc2dacd24" role="list"><li id="Slide-template--19422400577876__41a3ff50-b491-469f-8cd8-eaebc2dacd24-1" data-cascade="">


          </li><li id="Slide-template--19422400577876__41a3ff50-b491-469f-8cd8-eaebc2dacd24-2" data-cascade="">


          </li><li id="Slide-template--19422400577876__41a3ff50-b491-469f-8cd8-eaebc2dacd24-3" data-cascade="">


          </li></ul></slider-component></div><div id="shopify-section-template--19422400577876__256b0e40-e01d-4353-8ed0-5b40603a99f1">
    <div>
      <p><img src="https://stellarsamurai.com/cdn/shop/files/StellarSamuraiGrafittiW1.png?v=1691489553&amp;width=1500" alt="" srcset="https://stellarsamurai.com/cdn/shop/files/StellarSamuraiGrafittiW1.png?v=1691489553&amp;width=198 198w, https://stellarsamurai.com/cdn/shop/files/StellarSamuraiGrafittiW1.png?v=1691489553&amp;width=432 432w, https://stellarsamurai.com/cdn/shop/files/StellarSamuraiGrafittiW1.png?v=1691489553&amp;width=642 642w, https://stellarsamurai.com/cdn/shop/files/StellarSamuraiGrafittiW1.png?v=1691489553&amp;width=900 900w, https://stellarsamurai.com/cdn/shop/files/StellarSamuraiGrafittiW1.png?v=1691489553&amp;width=1284 1284w" width="1500" height="1500" loading="lazy" sizes="(min-width: 1200px) 659.9868002639947px,
              (min-width: 750px) calc((100vw - 130px) / 1.667), calc((100vw - 50px) / 1.667)">
</p>
    </div>
    <div id="ImageWithText--template--19422400577876__256b0e40-e01d-4353-8ed0-5b40603a99f1"><h2>
                Our Vision
              </h2><div>
                <p>We aim to portray the essence of ancient warriors know as Samurai into everyday clothing and accessories.</p><p>Each  design holds a story, wisdom and energy that we want to share with the world.</p><p>Unique clothing, accessories and home décor that gives a new feeling and an elegant touch. </p>
              </div><p><a href="https://stellarsamurai.com/pages/about">
                  Learn more about us
                </a></p></div>
  </div><div id="shopify-section-template--19422400577876__c5052349-f3ac-4407-aee0-d90ebc946611"><p>As a part of our launch, all customers get:</p><h2 data-cascade="">
                20% Discount for orders over 150$!
              </h2></div><div id="shopify-section-template--19422400577876__9207cebc-a5dc-4b77-8753-369fdc80294f">
    <h2>
      Find your style!
    </h2>
    
  </div><div data-cascade="" id="shopify-section-template--19422400577876__195040ff-b3b8-4bbb-86a4-1e9bd99b70b3"><slider-component>
      <ul id="Slider-template--19422400577876__195040ff-b3b8-4bbb-86a4-1e9bd99b70b3" role="list"><li id="Slide-template--19422400577876__195040ff-b3b8-4bbb-86a4-1e9bd99b70b3-1" data-cascade="">
            <div><h3>Quality</h3><p>Each product is tested and reviewed before it reaches your home. We do our best to ensure the quality of each item meets our standards.</p></div>
          </li><li id="Slide-template--19422400577876__195040ff-b3b8-4bbb-86a4-1e9bd99b70b3-2" data-cascade="">
            <div><h3>Durability</h3><p>We optimize for better and not cheaper materials. This type of approach makes sure that each design will last for as long as possible.</p></div>
          </li><li id="Slide-template--19422400577876__195040ff-b3b8-4bbb-86a4-1e9bd99b70b3-3" data-cascade="">
            <div><h3>Style</h3><p>Whether it's a backpack, T-Shirt or phone case each product holds it's own unique look that catches the eye and makes you stand out.</p></div>
          </li><li id="Slide-template--19422400577876__195040ff-b3b8-4bbb-86a4-1e9bd99b70b3-4" data-cascade="">
            <div><h3>Uniqueness</h3><p>No two designs are the same. Explore our various palettes and be pleasantly surprised with the volume of variety that we have prepared!</p></div>
          </li></ul></slider-component>
    
  </div>
    </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Why host your own LLM? (243 pts)]]></title>
            <link>http://marble.onl/posts/why_host_your_own_llm.html</link>
            <guid>37133504</guid>
            <pubDate>Tue, 15 Aug 2023 13:06:31 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="http://marble.onl/posts/why_host_your_own_llm.html">http://marble.onl/posts/why_host_your_own_llm.html</a>, See on <a href="https://news.ycombinator.com/item?id=37133504">Hacker News</a></p>
<div id="readability-page-1" class="page">

<p>Andrew Marble<br><a href="http://marble.onl/">marble.onl</a><br>andrew@willows.ai<br>August 13, 2023</p>
<p>In the Terminator movies, good relationships beat technological superiority. Kyle Reese and Sarah Connor outwit the advanced T-800 who in turn helps Sarah and John beat the ultra-advanced T-1000. OpenAI’s GPT-4 is currently the most advanced publicly available language model. There are also analyses showing it’s generally cheaper to run than self-hosting comparable models. I want to argue that despite everything OpenAI’s models have going for them, it’s worth considering self-hosting anyway, especially if you’re building a product or an internal capability.</p>
<p>If you’re using language models for custom applications, you can use an API from companies like OpenAI or Anthropic, where you submit your prompt, get a response, and pay usage based fees. Or you can configure your own model and host it locally or in the cloud. There are many models available for self-hosting. A few recent analyses have made a case for using OpenAI’s API based on cost and performance<a href="#fn1" id="fnref1" role="doc-noteref"><sup>1</sup></a><sup>,</sup><a href="#fn2" id="fnref2" role="doc-noteref"><sup>2</sup></a>. Very detailed cost calculations are possible, but the obvious cost advantage of a usage based API is that you only pay for the hardware when you use it. Most self-hosted applications will be challenged to get good utilization from dedicated GPUs and so are paying a lot for idle time.</p>
<p>There’s a lot of subtlety in gauging performance – personally I think there’s not a 1:1 relationship between rankings in the various benchmarks and “leaderboards”<a href="#fn3" id="fnref3" role="doc-noteref"><sup>3</sup></a> and performance on specific commercially relevant tasks. But GPT-4 is unequivocally better than the rest across a wide range of skills and only the best publicly available models compete with Claude (Anthropic’s model) and GPT-3.5.</p>
<p>Despite the advantages, there is still a compelling case for working with publicly available models. (Note I don’t say open source, many have other limitations that disqualify them from being labeled as such<a href="#fn4" id="fnref4" role="doc-noteref"><sup>4</sup></a>, but I won’t dwell on that here.) To me it boils down to a the “relationship”. Using APIs means you’re a taker of whatever OpenAI et al. are offering. Model features, customizations, values (censorship and world view) etc. are all dictated by those companies. You can only build a front-end. This also means you don’t have access to internal states and so are limited, for example in applying advanced accountability techniques or guardrails on top. All of this could be good, it means you don’t have to worry about it. But it also makes whatever you build utterly dependent on a start-up company.</p>
<p>For “relationship-based” development, there are good reasons to use self-hosted models. Having control over the model architecture and weights removes uncertainty about future changes, and means you don’t have to take what OpenAI decides to give you. There is a rich ecosystem of different models to experiment with, as well as the ability to customize – for example by fine-tuning on your own terms. The construct ultimately lets you build a long-term relationship with your AI model and adapt your product around it, having clarity that what you build is going to keep working with the model that you’ve chosen and giving you control over when and if you decide to make changes. It lets you build something that isn’t just a front-end on somebody else’s language model but is deeply integrated.</p>
<p>Also, for many applications, the well-rounded superiority of a GPT-like model is not what’s driving value. Running a model as big as GPT-4 is potentially $10,000’s per month. But it’s possible to run 7B and 13B models (models with 7 and 13 billion parameters, common sizes for LLaMA and other public models) on a laptop. These models are big enough to perform many tasks competently and can be cost-effective as part of local systems.</p>
<p>“Responsible” use of AI has many meanings. Tech companies have often focused on political correctness and superficial notions of bias, largely to avoid controversy in broadly capable public models like chat-GPT. For many applications, particularly specialized knowledge work<a href="#fn5" id="fnref5" role="doc-noteref"><sup>5</sup></a>, those concerns are mostly irrelevant and give way to real issues about factual accuracy, completeness, or simply staying on-topic. Many techniques for “keeping models in line” require access to internal states, gradients, and intermediate outputs<a href="#fn6" id="fnref6" role="doc-noteref"><sup>6</sup></a>. Using an API-based model limits the kind of experimentation and augmentation that is possible.</p>
<p>The same holds true for various optimizations such as caching internal model states, as well as model fine-tuning. APIs offer options, but they are limited compared to what is available. The technology is evolving so quickly still that new models and techniques are becoming available every day. For those that are using the LLM as a tightly integrated part of a product or tool, the only way to have the flexibility to evolve with the technology is to have a self-hosted model.</p>
<p>An additional aspect of the fast pace of change in language models right now is that the skills and knowledge required to work with the technology are evolving quickly. Working with self-hosted models gives institutional and individual experience in this evolving landscape, in a way that APIs don’t. For professional development of employees as well as adaptability to change, keeping “AI” at a deeper technical level is important for many companies, particularly those that are building applications. It’s not a mature technology, and part of the “moat” that we practitioners have is simply knowing what’s going on. I’ll actually go further and say that any organization making nontrivial use of AI should internally or through advisers have access to some deep knowledge of the technology, not just the API reference, to be able to understand what it fundamentally does best. As AI gets commodified and hyped-up, there often ends up being a big disconnect between what it can do and what it’s used or proposed for.</p>
<p>In a few years, I expect the landscape will look very different – there will be agreed upon things that are critical to be able to do with a model, and APIs will support this. For a new, still experimental, and rapidly evolving technology, real participation requires deep access to the models and code. This doesn’t mean that all companies or products require such access – there are many valuable things that can be built on top of an API and would probably be a waste of time to self-host. But these are different kinds of products.</p>
<p>Back to the Terminator, Reese and the T-800 both built strong relationships that led to their successful completion of their missions. The Skynet-tasked Terminators just went around flexing their superior technological prowess, and it wasn’t enough to win the day. Part of building the relationships is access. I know it’s a silly analogy, but I believe the same is true with these models, it’s about being able to deeply understand the strengths of the tool and built something tightly integrated, and you can’t do that with an API.</p>
<section role="doc-endnotes">
<hr>
<ol>
<li id="fn1" role="doc-endnote"><p><a href="https://betterprogramming.pub/you-dont-need-hosted-llms-do-you-1160b2520526">https://betterprogramming.pub/you-dont-need-hosted-llms-do-you-1160b2520526</a><a href="#fnref1" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p><a href="https://www.cursor.so/blog/llama-inference">https://www.cursor.so/blog/llama-inference</a><a href="#fnref2" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p><a href="https://huggingface.co/spaces/lmsys/chatbot-arena-leaderboard">https://huggingface.co/spaces/lmsys/chatbot-arena-leaderboard</a><a href="#fnref3" role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p><a href="http://marble.onl/posts/software-licenses-masquerading-as-open-source.html">http://marble.onl/posts/software-licenses-masquerading-as-open-source.html</a><a href="#fnref4" role="doc-backlink">↩︎</a></p></li>
<li id="fn5" role="doc-endnote"><p>https://a16z.com/2023/06/20/emerging-architectures-for-llm-applications/<a href="#fnref5" role="doc-backlink">↩︎</a></p></li>
<li id="fn6" role="doc-endnote"><p>There is a wide range of literature and research into model accountability. For a narrow example, see “The Internal State of an LLM Knows When its Lying” <a href="https://arxiv.org/pdf/2304.13734.pdf">https://arxiv.org/pdf/2304.13734.pdf</a> but also <a href="https://arxiv.org/pdf/2307.00175.pdf">https://arxiv.org/pdf/2307.00175.pdf</a><a href="#fnref6" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>


</div>]]></description>
        </item>
        <item>
            <title><![CDATA[Show HN: Llama2 Embeddings FastAPI Server (158 pts)]]></title>
            <link>https://github.com/Dicklesworthstone/llama_embeddings_fastapi_service</link>
            <guid>37133163</guid>
            <pubDate>Tue, 15 Aug 2023 12:31:27 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://github.com/Dicklesworthstone/llama_embeddings_fastapi_service">https://github.com/Dicklesworthstone/llama_embeddings_fastapi_service</a>, See on <a href="https://news.ycombinator.com/item?id=37133163">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><h2 tabindex="-1" dir="auto">Llama2 Embeddings FastAPI Service</h2>
<h2 tabindex="-1" dir="auto">Introduction</h2>
<p dir="auto">The Llama2 Embedding Server is designed to facilitate and optimize the process of obtaining text embeddings using different LLMs via llama_cpp and langchain. To avoid wasting computation, these embeddings are cached in SQlite and retrieved if they have already been computed before. To speed up the process of loading multiple LLMs, optional RAM Disks can be used, and the process for creating and managing them is handled automatically for you.</p>
<p dir="auto">Some additional useful endpoints are provided, such as computing semantic similarity between submitted text strings (using various measures of similarity, such as cosine similarity, but also more esoteric measures like <a href="https://blogs.sas.com/content/iml/2021/05/03/examples-hoeffding-d.html" rel="nofollow">Hoeffding's D</a> and <a href="https://www.sciencedirect.com/science/article/abs/pii/S0950705121008297" rel="nofollow">HSIC</a>, and semantic search across all your cached embeddings using FAISS vector searching.</p>
<p dir="auto">You can also submit a plaintext file or PDF file (not requiring OCR) and get back a zip file containing all of the embeddings for each sentence as JSON, organized in various ways such <code>records</code>, <code>table</code>, etc. (i.e., all the export options from the Pandas <code>to_json()</code> function). The results of getting the embeddings for all sentences in a document can be returned either as a zip file containing a JSON file (so it won't crash Swagger among other things), or as a direct JSON response if you're using curl or similar.</p>
<p dir="auto">In addition to fixed-sized embedding vectors, we also expose functionality that allows you to get back token-level embeddings, where each token in the input stream is embedded with its context in the string as a full sized vector, thus producing a matrix that has a number of rows equal to the number of tokens in the input string. This includes far more nuanced information about the contents of the string at the expense of much greater compute and storage requirements. The other drawback is that, instead of having the same sized output for every string, regardless of length (which makes it very easy to compare unequal length strings using cosine similarity and other measures), the token-level embedding matrix obviously differs in dimensions for two different strings if the strings have different numbers of tokens. To deal with this, we introduce combined feature vectors, which compute the column-wise mean, min, max, and std. deviation of the token-level emeddding matrix, and concatenate these together in to a single huge matrix; this allows you to compare strings of different lengths while still capturing more nuance. The combined results, including the embedding matrix and associated combined feature vector, can similarly be returned as either a zip file or direct JSON response.</p>
<h2 tabindex="-1" dir="auto">Screenshot</h2>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/Dicklesworthstone/llama_embeddings_fastapi_service/raw/main/Llama2-FastAPI-Service-%20Swagger%20Screenshot.png"><img src="https://github.com/Dicklesworthstone/llama_embeddings_fastapi_service/raw/main/Llama2-FastAPI-Service-%20Swagger%20Screenshot.png" alt="Llama2 FastAPI Service Swagger UI"></a></p>
<p dir="auto"><em>TLDR:</em> If you just want to try it very quickly on a fresh Ubuntu 22+ machine (warning, this will install docker using apt):</p>
<div dir="auto" data-snippet-clipboard-copy-content="git clone https://github.com/Dicklesworthstone/llama_embeddings_fastapi_service
cd llama_embeddings_fastapi_service
chmod +x setup_dockerized_app_on_fresh_machine.sh
sudo ./setup_dockerized_app_on_fresh_machine.sh"><pre>git clone https://github.com/Dicklesworthstone/llama_embeddings_fastapi_service
<span>cd</span> llama_embeddings_fastapi_service
chmod +x setup_dockerized_app_on_fresh_machine.sh
sudo ./setup_dockerized_app_on_fresh_machine.sh</pre></div>
<p dir="auto">Then open a browser to <code>&lt;your_static_ip_address&gt;:8089</code> if you're using a VPS.</p>
<p dir="auto">Or to <code>localhost:8089</code> if you're using your own machine-- but, really, you should never run untrusted code with sudo on your own machine! Just get a cheap VPS to experiment with for $30/month.</p>
<p dir="auto">Watch the the automated setup process in action <a href="https://asciinema.org/a/601603" rel="nofollow">here</a>.</p>
<hr>
<h2 tabindex="-1" dir="auto">Features</h2>
<ol dir="auto">
<li><strong>Text Embedding Computation</strong>: Utilizes pre-trained LLama2 and other LLMs via llama_cpp and langchain to generate embeddings for any provided text, including token-level embeddings that capture more nuanced information about the content.</li>
<li><strong>Embedding Caching</strong>: Efficiently stores and retrieves computed embeddings in SQLite, minimizing redundant computations. It supports caching both fixed-sized embedding vectors and token-level embeddings.</li>
<li><strong>Advanced Similarity Measurements and Retrieval</strong>: Offers various measures of similarity like cosine similarity, Hoeffding's D, HSIC, and semantic search across cached embeddings using FAISS vector searching.</li>
<li><strong>File Processing for Documents</strong>: Submit plaintext files or PDFs (not requiring OCR) to get back a ZIP file or JSON response containing embeddings for each sentence, organized in various ways like <code>records</code>, <code>table</code>, etc., using Pandas <code>to_json()</code> function.</li>
<li><strong>Token-Level Embeddings and Combined Feature Vectors</strong>: Provides token-level embeddings to capture the context of each token in the input string. Introduces combined feature vectors by computing the column-wise mean, min, max, and std. deviation of the token-level embedding matrix, allowing comparison of unequal length strings.</li>
<li><strong>RAM Disk Usage</strong>: Optionally uses RAM Disk to store models for faster access and execution. Automatically handles the creation and management of RAM Disks.</li>
<li><strong>Robust Exception Handling</strong>: Features comprehensive exception management to ensure system resilience.</li>
<li><strong>Interactive API Documentation</strong>: Integrates with Swagger UI for an interactive and user-friendly experience, accommodating large result sets without crashing.</li>
<li><strong>Scalability and Concurrency</strong>: Built on the FastAPI framework, handles concurrent requests and supports parallel inference with configurable concurrency levels.</li>
<li><strong>Flexible Configurations</strong>: Offers configurable settings through environment variables and input parameters, including response formats like JSON or ZIP files.</li>
<li><strong>Comprehensive Logging</strong>: Captures essential information with detailed logs, without overwhelming storage or readability.</li>
<li><strong>Support for Multiple Models and Measures</strong>: Accommodates multiple embedding models and similarity measures, allowing flexibility and customization based on user needs.</li>
</ol>
<h2 tabindex="-1" dir="auto">Demo Screen Recording in Action:</h2>
<p dir="auto"><a href="https://asciinema.org/a/39dZ8vv9nkcNygasUl35wnBPq" rel="nofollow">Here</a> is the live console output while I interact with it from the Swagger page to make requests.</p>
<hr>
<h2 tabindex="-1" dir="auto">Requirements:</h2>
<div data-snippet-clipboard-copy-content="fastapi
pydantic
uvicorn
sqlalchemy
python-decouple
psutil
aiosqlite
faiss-cpu
pandas
PyPDF2
python-multipart
python-magic
langchain
scikit-learn
llama-cpp-python
httpx
numba
scipy
hyppo"><pre><code>fastapi
pydantic
uvicorn
sqlalchemy
python-decouple
psutil
aiosqlite
faiss-cpu
pandas
PyPDF2
python-multipart
python-magic
langchain
scikit-learn
llama-cpp-python
httpx
numba
scipy
hyppo
</code></pre></div>
<h2 tabindex="-1" dir="auto">Running the Application</h2>
<p dir="auto">You can run the application using the following command:</p>
<div dir="auto" data-snippet-clipboard-copy-content="python llama_2_embeddings_fastapi_server.py"><pre>python llama_2_embeddings_fastapi_server.py</pre></div>
<p dir="auto">The server will start on <code>0.0.0.0</code> at the port defined by the <code>LLAMA_EMBEDDING_SERVER_LISTEN_PORT</code> variable.</p>
<p dir="auto">Access the Swagger UI:</p>
<div data-snippet-clipboard-copy-content="http://localhost:<LLAMA_EMBEDDING_SERVER_LISTEN_PORT>"><pre><code>http://localhost:&lt;LLAMA_EMBEDDING_SERVER_LISTEN_PORT&gt;
</code></pre></div>
<h2 tabindex="-1" dir="auto">Configuration</h2>
<p dir="auto">You can configure the service easily by editing the included <code>.env</code> file. Here's a list of available configuration options:</p>
<ul dir="auto">
<li><code>USE_SECURITY_TOKEN</code>: Whether to use a hardcoded security token. (e.g., <code>True</code>)</li>
<li><code>USE_PARALLEL_INFERENCE_QUEUE</code>: Use parallel processing. (e.g., <code>True</code>)</li>
<li><code>MAX_CONCURRENT_PARALLEL_INFERENCE_TASKS</code>: Maximum number of parallel inference tasks. (e.g., <code>30</code>)</li>
<li><code>DEFAULT_MODEL_NAME</code>: Default model name to use. (e.g., <code>llama2_7b_chat_uncensored</code>)</li>
<li><code>LLM_CONTEXT_SIZE_IN_TOKENS</code>: Context size in tokens for LLM. (e.g., <code>512</code>)</li>
<li><code>LLAMA_EMBEDDING_SERVER_LISTEN_PORT</code>: Port number for the service. (e.g., <code>8089</code>)</li>
<li><code>MINIMUM_STRING_LENGTH_FOR_DOCUMENT_EMBEDDING</code>: Minimum string length for document embedding. (e.g., <code>15</code>)</li>
<li><code>MAX_RETRIES</code>: Maximum retries for locked database. (e.g., <code>10</code>)</li>
<li><code>DB_WRITE_BATCH_SIZE</code>: Database write batch size. (e.g., <code>25</code>)</li>
<li><code>RETRY_DELAY_BASE_SECONDS</code>: Retry delay base in seconds. (e.g., <code>1</code>)</li>
<li><code>JITTER_FACTOR</code>: Jitter factor for retries. (e.g., <code>0.1</code>)</li>
<li><code>USE_RAMDISK</code>: Use RAM disk. (e.g., <code>True</code>)</li>
<li><code>RAMDISK_PATH</code>: Path to the RAM disk. (e.g., <code>"/mnt/ramdisk"</code>)</li>
<li><code>RAMDISK_SIZE_IN_GB</code>: RAM disk size in GB. (e.g., <code>40</code>)</li>
</ul>
<h2 tabindex="-1" dir="auto">Contributing</h2>
<p dir="auto">If you'd like to contribute to the project, please submit a pull request.</p>
<h2 tabindex="-1" dir="auto">License</h2>
<p dir="auto">This project is licensed under the MIT License.</p>
<hr>
<h2 tabindex="-1" dir="auto">Setup and Configuration</h2>
<h3 tabindex="-1" dir="auto">RAM Disk Configuration</h3>
<p dir="auto">To enable password-less sudo for RAM Disk setup and teardown, edit the <code>sudoers</code> file with <code>sudo visudo</code>. Add the following lines, replacing <code>username</code> with your actual username:</p>
<div data-snippet-clipboard-copy-content="username ALL=(ALL) NOPASSWD: /bin/mount -t tmpfs -o size=*G tmpfs /mnt/ramdisk
username ALL=(ALL) NOPASSWD: /bin/umount /mnt/ramdisk"><pre lang="plaintext"><code>username ALL=(ALL) NOPASSWD: /bin/mount -t tmpfs -o size=*G tmpfs /mnt/ramdisk
username ALL=(ALL) NOPASSWD: /bin/umount /mnt/ramdisk
</code></pre></div>
<p dir="auto">The application provides functionalities to set up, clear, and manage RAM Disk. RAM Disk is used to store models in memory for faster access. It calculates the available RAM and sets up the RAM Disk accordingly. The functions <code>setup_ramdisk</code>, <code>copy_models_to_ramdisk</code>, and <code>clear_ramdisk</code> manage these tasks.</p>
<h2 tabindex="-1" dir="auto">API Endpoints</h2>
<p dir="auto">The following endpoints are available:</p>
<ul dir="auto">
<li><strong>GET <code>/get_list_of_available_model_names/</code></strong>: Retrieve Available Model Names. Retrieves the list of available model names for generating embeddings.</li>
<li><strong>GET <code>/get_all_stored_strings/</code></strong>: Retrieve All Strings. Retrieves a list of all stored strings from the database for which embeddings have been computed.</li>
<li><strong>GET <code>/get_all_stored_documents/</code></strong>: Retrieve All Stored Documents. Retrieves a list of all stored documents from the database for which embeddings have been computed.</li>
<li><strong>POST <code>/get_embedding_vector_for_string/</code></strong>: Retrieve Embedding Vector for a Given Text String. Retrieves the embedding vector for a given input text string using the specified model.</li>
<li><strong>POST <code>/get_token_level_embeddings_matrix_and_combined_feature_vector_for_string/</code></strong>: Retrieve Token-Level Embeddings and Combined Feature Vector for a Given Input String. Retrieve the token-level embeddings and combined feature vector for a given input text using the specified model.</li>
<li><strong>POST <code>/compute_similarity_between_strings/</code></strong>: Compute Similarity Between Two Strings. Compute the similarity between two given input strings using specified model embeddings and a selected similarity measure.</li>
<li><strong>POST <code>/search_stored_embeddings_with_query_string_for_semantic_similarity/</code></strong>: Get Most Similar Strings from Stored Embeddings in Database. Find the most similar strings in the database to the given input "query" text.</li>
<li><strong>POST <code>/get_all_embedding_vectors_for_document/</code></strong>: Get Embeddings for a Document. Extract text embeddings for a document, supporting both plain text and PDF files (PDFs requiring OCR are not supported).</li>
<li><strong>POST <code>/clear_ramdisk/</code></strong>: Clear Ramdisk Endpoint. Clears the RAM Disk if it is enabled.</li>
</ul>
<p dir="auto">For detailed request and response schemas, please refer to the Swagger UI available at the root URL or the section at the end of this <code>README</code>.</p>
<h2 tabindex="-1" dir="auto">Exception Handling</h2>
<p dir="auto">The application has robust exception handling to deal with various types of errors, including database errors and general exceptions. Custom exception handlers are defined for <code>SQLAlchemyError</code> and general <code>Exception</code>.</p>
<h2 tabindex="-1" dir="auto">Logging</h2>
<p dir="auto">Logging is configured at the INFO level to provide detailed logs for debugging and monitoring. The logger provides information about the state of the application, errors, and activities.</p>
<p dir="auto">The logs are stored in a file named <code>llama2_embeddings_fastapi_service.log</code>, and a log rotation mechanism is implemented to handle log file backups. The rotating file handler is configured with a maximum file size of 10 MB, and it keeps up to 5 backup files.</p>
<p dir="auto">When a log file reaches its maximum size, it is moved to the <code>old_logs</code> directory, and a new log file is created. The log entries are also printed to the standard output stream.</p>
<p dir="auto">Here are some details of the logging configuration:</p>
<ul dir="auto">
<li>Log Level: INFO</li>
<li>Log Format: <code>%(asctime)s - %(levelname)s - %(message)s</code></li>
<li>Max Log File Size: 10 MB</li>
<li>Backup Count: 5</li>
<li>Old Logs Directory: <code>old_logs</code></li>
</ul>
<p dir="auto">Additionally, the log level for SQLAlchemy's engine is set to WARNING to suppress verbose database logs.</p>
<h2 tabindex="-1" dir="auto">Database Structure</h2>
<p dir="auto">The application uses a SQLite database via SQLAlchemy ORM. Here are the data models used, which can be found in the <code>embeddings_data_models.py</code> file:</p>
<h3 tabindex="-1" dir="auto">TextEmbedding Table</h3>
<p dir="auto">This table stores individual text embeddings.</p>
<ul dir="auto">
<li><code>id</code>: Primary Key</li>
<li><code>text</code>: Text for which the embedding was computed</li>
<li><code>text_hash</code>: Hash of the text, computed using SHA3-256</li>
<li><code>model_name</code>: Model used to compute the embedding</li>
<li><code>embedding_json</code>: The computed embedding in JSON format</li>
<li><code>ip_address</code>: Client IP address</li>
<li><code>request_time</code>: Timestamp of the request</li>
<li><code>response_time</code>: Timestamp of the response</li>
<li><code>total_time</code>: Total time taken to process the request</li>
<li><code>document_id</code>: Foreign Key referencing the DocumentEmbedding table</li>
<li>Unique Constraint on <code>text_hash</code> and <code>model_name</code></li>
</ul>
<h3 tabindex="-1" dir="auto">DocumentEmbedding Table</h3>
<p dir="auto">This table stores embeddings for entire documents.</p>
<ul dir="auto">
<li><code>id</code>: Primary Key</li>
<li><code>document_id</code>: Foreign Key referencing the Documents table</li>
<li><code>filename</code>: Name of the document file</li>
<li><code>mimetype</code>: MIME type of the document file</li>
<li><code>file_hash</code>: Hash of the file</li>
<li><code>model_name</code>: Model used to compute the embedding</li>
<li><code>file_data</code>: Binary data of the original file</li>
<li><code>document_embedding_results_json</code>: The computed embedding results in JSON format</li>
<li><code>ip_address</code>: Client IP address</li>
<li><code>request_time</code>: Timestamp of the request</li>
<li><code>response_time</code>: Timestamp of the response</li>
<li><code>total_time</code>: Total time taken to process the request</li>
<li>Unique Constraint on <code>file_hash</code> and <code>model_name</code></li>
</ul>
<h3 tabindex="-1" dir="auto">Document Table</h3>
<p dir="auto">This table represents a document.</p>
<ul dir="auto">
<li><code>id</code>: Primary Key</li>
<li><code>model_name</code>: Model name associated with the document</li>
<li><code>document_hash</code>: Hash of the document (concatenation of specific attributes from the <code>document_embeddings</code> relationship)</li>
</ul>
<h3 tabindex="-1" dir="auto">TokenLevelEmbedding Table</h3>
<p dir="auto">This table stores token-level embeddings.</p>
<ul dir="auto">
<li><code>id</code>: Primary Key</li>
<li><code>token</code>: Token for which the embedding was computed</li>
<li><code>token_hash</code>: Hash of the token, computed using SHA3-256</li>
<li><code>model_name</code>: Model used to compute the embedding</li>
<li><code>token_level_embedding_json</code>: The computed token-level embedding in JSON format</li>
<li><code>ip_address</code>: Client IP address</li>
<li><code>request_time</code>: Timestamp of the request</li>
<li><code>response_time</code>: Timestamp of the response</li>
<li><code>total_time</code>: Total time taken to process the request</li>
<li><code>token_level_embedding_bundle_id</code>: Foreign Key referencing the TokenLevelEmbeddingBundle table</li>
<li>Unique Constraint on <code>token_hash</code> and <code>model_name</code></li>
</ul>
<h3 tabindex="-1" dir="auto">TokenLevelEmbeddingBundle Table</h3>
<p dir="auto">This table stores token-level embedding bundles.</p>
<ul dir="auto">
<li><code>id</code>: Primary Key</li>
<li><code>input_text</code>: Input text associated with the token-level embeddings</li>
<li><code>input_text_hash</code>: Hash of the input text</li>
<li><code>model_name</code>: Model used to compute the embeddings</li>
<li><code>token_level_embeddings_bundle_json</code>: JSON containing the token-level embeddings</li>
<li><code>ip_address</code>: Client IP address</li>
<li><code>request_time</code>: Timestamp of the request</li>
<li><code>response_time</code>: Timestamp of the response</li>
<li><code>total_time</code>: Total time taken to process the request</li>
<li>Unique Constraint on <code>input_text_hash</code> and <code>model_name</code></li>
</ul>
<h3 tabindex="-1" dir="auto">TokenLevelEmbeddingBundleCombinedFeatureVector Table</h3>
<p dir="auto">This table stores combined feature vectors for token-level embedding bundles.</p>
<ul dir="auto">
<li><code>id</code>: Primary Key</li>
<li><code>token_level_embedding_bundle_id</code>: Foreign Key referencing the TokenLevelEmbeddingBundle table</li>
<li><code>model_name</code>: Model name associated with the combined feature vector</li>
<li><code>combined_feature_vector_json</code>: JSON containing the combined feature vector</li>
<li><code>combined_feature_vector_hash</code>: Hash of the combined feature vector</li>
<li>Unique Constraint on <code>combined_feature_vector_hash</code> and <code>model_name</code></li>
</ul>
<h2 tabindex="-1" dir="auto">Performance Optimizations</h2>
<p dir="auto">This section highlights the major performance enhancements integrated into the provided code to ensure swift responses and optimal resource management.</p>
<h3 tabindex="-1" dir="auto">1. <strong>Asynchronous Programming</strong>:</h3>
<ul dir="auto">
<li><strong>Benefit</strong>: Handles multiple tasks concurrently, enhancing efficiency for I/O-bound operations like database transactions and network requests.</li>
<li><strong>Implementation</strong>: Utilizes Python's <code>asyncio</code> library for asynchronous database operations.</li>
</ul>
<h3 tabindex="-1" dir="auto">2. <strong>Database Optimizations</strong>:</h3>
<ul dir="auto">
<li><strong>Write-Ahead Logging (WAL) Mode</strong>: Enables concurrent reads and writes, optimizing for applications with frequent write demands.</li>
<li><strong>Retry Logic with Exponential Backoff</strong>: Manages locked databases by retrying operations with progressive waiting times.</li>
<li><strong>Batch Writes</strong>: Aggregates write operations for more efficient database interactions.</li>
<li><strong>DB Write Queue</strong>: Uses an asynchronous queue to serialize write operations, ensuring consistent and non-conflicting database writes.</li>
</ul>
<h3 tabindex="-1" dir="auto">3. <strong>RAM Disk Utilization</strong>:</h3>
<ul dir="auto">
<li><strong>Benefit</strong>: Speeds up I/O-bound tasks by prioritizing operations in RAM over disk.</li>
<li><strong>Implementation</strong>: Detects and prioritizes a RAM disk (<code>/mnt/ramdisk</code>) if available, otherwise defaults to the standard file system.</li>
</ul>
<h3 tabindex="-1" dir="auto">4. <strong>Model Caching</strong>:</h3>
<ul dir="auto">
<li><strong>Benefit</strong>: Reduces overhead by keeping loaded models in memory for subsequent requests.</li>
<li><strong>Implementation</strong>: Uses a global <code>model_cache</code> dictionary to store and retrieve models.</li>
</ul>
<h3 tabindex="-1" dir="auto">5. <strong>Parallel Inference</strong>:</h3>
<ul dir="auto">
<li><strong>Benefit</strong>: Enhances processing speed for multiple data units, like document sentences.</li>
<li><strong>Implementation</strong>: Employs <code>asyncio.gather</code> for concurrent inferences, regulated by a semaphore (<code>MAX_CONCURRENT_PARALLEL_INFERENCE_TASKS</code>).</li>
</ul>
<h3 tabindex="-1" dir="auto">6. <strong>Embedding Caching</strong>:</h3>
<ul dir="auto">
<li><strong>Benefit</strong>: Once embeddings are computed for a particular text, they are stored in the database, eliminating the need for re-computation during subsequent requests.</li>
<li><strong>Implementation</strong>: When a request is made to compute an embedding, the system first checks the database. If the embedding for the given text is found, it is returned immediately, ensuring faster response times.</li>
</ul>
<hr>
<h3 tabindex="-1" dir="auto">Dockerized Llama2 Embeddings API Service App</h3>
<p dir="auto">A bash script is included in this repo, <code>setup_dockerized_app_on_fresh_machine.sh</code>, that will automatically do everything for you, including installing docker with apt install.</p>
<p dir="auto">To use it, first make the script executable and then run it like this:</p>
<div dir="auto" data-snippet-clipboard-copy-content="chmod +x setup_dockerized_app_on_fresh_machine.sh
sudo ./setup_dockerized_app_on_fresh_machine.sh"><pre>chmod +x setup_dockerized_app_on_fresh_machine.sh
sudo ./setup_dockerized_app_on_fresh_machine.sh</pre></div>
<p dir="auto">If you prefer a manual setup, then read the following instructions:</p>
<h4 tabindex="-1" dir="auto">Prerequisites</h4>
<p dir="auto">Ensure that you have Docker installed on your system. If not, follow these steps to install Docker on Ubuntu:</p>
<div dir="auto" data-snippet-clipboard-copy-content="sudo apt-get update
sudo apt-get install docker.io
sudo systemctl start docker
sudo docker --version
sudo usermod -aG docker $USER"><pre>sudo apt-get update
sudo apt-get install docker.io
sudo systemctl start docker
sudo docker --version
sudo usermod -aG docker <span>$USER</span></pre></div>
<p dir="auto">You may need to log out and log back in or restart your system to apply the new group permissions, or use sudo in the following steps to build and run the container.</p>
<h4 tabindex="-1" dir="auto">Setup and Running the Application</h4>
<ol dir="auto">
<li>
<p dir="auto"><strong>Clone the Repository:</strong></p>
<p dir="auto">Clone the Llama2 Embeddings API Service repository to your local machine:</p>
<div dir="auto" data-snippet-clipboard-copy-content="git clone https://github.com/Dicklesworthstone/llama_embeddings_fastapi_service
cd llama_embeddings_fastapi_service"><pre>git clone https://github.com/Dicklesworthstone/llama_embeddings_fastapi_service
<span>cd</span> llama_embeddings_fastapi_service</pre></div>
</li>
<li>
<p dir="auto"><strong>Build the Docker Image:</strong></p>
<p dir="auto">Build the Docker image using the provided Dockerfile:</p>
<div dir="auto" data-snippet-clipboard-copy-content="sudo docker build -t llama-embeddings ."><pre>sudo docker build -t llama-embeddings <span>.</span></pre></div>
</li>
<li>
<p dir="auto"><strong>Run the Docker Container:</strong></p>
<p dir="auto">Run the Docker container, mapping the container's port 8089 to the host's port 8089:</p>
<div dir="auto" data-snippet-clipboard-copy-content="sudo docker run -p 8089:8089 llama-embeddings"><pre>sudo docker run -p 8089:8089 llama-embeddings</pre></div>
</li>
<li>
<p dir="auto"><strong>Accessing the Application:</strong></p>
<p dir="auto">The FastAPI application will now be accessible at <code>http://localhost:8089</code> or at the static IP address of your VPS instance if you're running on one (You can get a 10-core, 30gb RAM, 1tb SSD with a static IP running Ubuntu 22.04 at Contabo for around $30/month, which is the cheapest I've found so far).</p>
<p dir="auto">You can interact then with the API using tools like <code>curl</code> or by accessing the FastAPI documentation at <code>http://localhost:8089/docs</code>.</p>
</li>
<li>
<p dir="auto"><strong>Viewing Logs:</strong></p>
<p dir="auto">Logs from the application can be viewed directly in the terminal where you ran the <code>docker run</code> command.</p>
</li>
</ol>
<h4 tabindex="-1" dir="auto">Stopping and Managing the Container</h4>
<ul dir="auto">
<li>To stop the running container, press <code>Ctrl+C</code> in the terminal or find the container ID using <code>docker ps</code> and run <code>sudo docker stop &lt;container_id&gt;</code>.</li>
<li>To remove the built image, use <code>sudo docker rmi llama-embeddings</code>.</li>
</ul>
<hr>
<p dir="auto">Based on the provided code, I'll help you update the <code>Startup Procedures</code> section of your <code>readme.md</code> file. Here's the updated version:</p>
<hr>
<h2 tabindex="-1" dir="auto">Startup Procedures</h2>
<p dir="auto">During startup, the application performs the following tasks:</p>
<ol dir="auto">
<li><strong>Database Initialization</strong>:
<ul dir="auto">
<li>The application initializes the SQLite database, setting up tables and executing important PRAGMAs to optimize performance.</li>
<li>Some of the important SQLite PRAGMAs include setting the database to use Write-Ahead Logging (WAL) mode, setting synchronous mode to NORMAL, increasing cache size to 1GB, setting the busy timeout to 2 seconds, and setting the WAL autocheckpoint to 100.</li>
</ul>
</li>
<li><strong>Initialize Database Writer</strong>:
<ul dir="auto">
<li>A dedicated database writer (<code>DatabaseWriter</code>) is initialized with a dedicated asynchronous queue to handle the write operations.</li>
<li>A set of hashes is created which represents the operations that are currently being processed or have already been processed. This avoids any duplicate operations in the queue.</li>
</ul>
</li>
<li><strong>RAM Disk Setup</strong>:
<ul dir="auto">
<li>If the <code>USE_RAMDISK</code> variable is enabled and the user has the required permissions, the application sets up a RAM Disk.</li>
<li>The application checks if there's already a RAM Disk set up at the specified path, if not, it calculates the optimal size for the RAM Disk and sets it up.</li>
<li>If the RAM Disk is enabled but the user lacks the required permissions, the RAM Disk feature is disabled and the application proceeds without it.</li>
</ul>
</li>
<li><strong>Model Downloads</strong>:
<ul dir="auto">
<li>The application downloads the required models.</li>
</ul>
</li>
<li><strong>Model Loading</strong>:
<ul dir="auto">
<li>Each downloaded model is loaded into memory. If any model file is not found, an error log is recorded.</li>
</ul>
</li>
<li><strong>Build FAISS Indexes</strong>:
<ul dir="auto">
<li>The application creates FAISS indexes for efficient similarity search using the embeddings from the database.</li>
<li>Separate FAISS indexes are built for token-level embeddings.</li>
<li>Associated texts are stored by model name for further use.</li>
</ul>
</li>
</ol>
<p dir="auto">Note:</p>
<ul dir="auto">
<li>If the RAM Disk feature is enabled but the user lacks the required permissions, the application will disable the RAM Disk feature and proceed without it.</li>
<li>For any database operations, if the database is locked, the application will attempt to retry the operation a few times with an exponential backoff and a jitter.</li>
</ul>
<hr>
<h2 tabindex="-1" dir="auto">Endpoint Functionality and Workflow Overview</h2>
<p dir="auto">Here's a detailed breakdown of the main endpoints provided by the FastAPI server, explaining their functionality, input parameters, and how they interact with underlying models and systems:</p>
<h3 tabindex="-1" dir="auto">1. <code>/get_embedding_vector_for_string/</code> (POST)</h3>
<h4 tabindex="-1" dir="auto">Purpose</h4>
<p dir="auto">Retrieve the embedding vector for a given input text string using the specified model.</p>
<h4 tabindex="-1" dir="auto">Parameters</h4>
<ul dir="auto">
<li><code>text</code>: The input text for which the embedding vector is to be retrieved.</li>
<li><code>model_name</code>: The model used to calculate the embedding (optional, will use the default model if not provided).</li>
<li><code>token</code>: Security token (optional).</li>
<li><code>client_ip</code>: Client IP address (optional).</li>
</ul>
<h4 tabindex="-1" dir="auto">Workflow</h4>
<ol dir="auto">
<li><strong>Retrieve Embedding</strong>: The function retrieves or computes the embedding vector for the provided text using the specified or default model.</li>
<li><strong>Return Result</strong>: The embedding vector for the input text string is returned in the response.</li>
</ol>
<h3 tabindex="-1" dir="auto">2. <code>/compute_similarity_between_strings/</code> (POST)</h3>
<h4 tabindex="-1" dir="auto">Purpose</h4>
<p dir="auto">Compute the similarity between two given input strings using specified model embeddings and a selected similarity measure.</p>
<h4 tabindex="-1" dir="auto">Parameters</h4>
<ul dir="auto">
<li><code>text1</code>: The first input text.</li>
<li><code>text2</code>: The second input text.</li>
<li><code>model_name</code>: The model used to calculate embeddings (optional).</li>
<li><code>similarity_measure</code>: The similarity measure to be used. It can be <code>cosine_similarity</code>, <code>hoeffdings_d</code>, or <code>hsic</code> (optional, default is <code>cosine_similarity</code>).</li>
<li><code>token</code>: Security token (optional).</li>
</ul>
<h4 tabindex="-1" dir="auto">Workflow</h4>
<ol dir="auto">
<li><strong>Retrieve Embeddings</strong>: The embeddings for <code>text1</code> and <code>text2</code> are retrieved or computed using the specified or default model.</li>
<li><strong>Compute Similarity</strong>: The similarity between the two embeddings is calculated using the specified similarity measure.</li>
<li><strong>Return Result</strong>: The similarity score, along with the embeddings and input texts, is returned in the response.</li>
</ol>
<h3 tabindex="-1" dir="auto">3. <code>/search_stored_embeddings_with_query_string_for_semantic_similarity/</code> (POST)</h3>
<h4 tabindex="-1" dir="auto">Purpose</h4>
<p dir="auto">Find the most similar strings in the database to the given input "query" text. This endpoint uses a pre-computed FAISS index to quickly search for the closest matching strings.</p>
<h4 tabindex="-1" dir="auto">Parameters</h4>
<ul dir="auto">
<li><code>query_text</code>: The input text for which to find the most similar string.</li>
<li><code>model_name</code>: The model used to calculate embeddings.</li>
<li><code>number_of_most_similar_strings_to_return</code>: (Optional) The number of most similar strings to return, defaults to 10.</li>
<li><code>token</code>: Security token (optional).</li>
</ul>
<h4 tabindex="-1" dir="auto">Workflow</h4>
<ol dir="auto">
<li><strong>Search FAISS Index</strong>: The FAISS index, built on stored embeddings, is searched to find the most similar embeddings to the <code>query_text</code>.</li>
<li><strong>Return Result</strong>: The most similar strings found in the database, along with the similarity scores, are returned in the response.</li>
</ol>
<h3 tabindex="-1" dir="auto">4. <code>/get_all_embedding_vectors_for_document/</code> (POST)</h3>
<h4 tabindex="-1" dir="auto">Purpose</h4>
<p dir="auto">Extract text embeddings for a document. This endpoint supports both plain text and PDF files. OCR is not supported.</p>
<h4 tabindex="-1" dir="auto">Parameters</h4>
<ul dir="auto">
<li><code>file</code>: The uploaded document file (either plain text or PDF).</li>
<li><code>model_name</code>: (Optional) The model used to calculate embeddings.</li>
<li><code>json_format</code>: (Optional) The format of the JSON response.</li>
<li><code>send_back_json_or_zip_file</code>: Whether to return a JSON file or a ZIP file containing the embeddings file (optional, defaults to <code>zip</code>).</li>
<li><code>token</code>: Security token (optional).</li>
</ul>
<h3 tabindex="-1" dir="auto">5. <code>/get_list_of_available_model_names/</code> (GET)</h3>
<h4 tabindex="-1" dir="auto">Purpose</h4>
<p dir="auto">Retrieve the list of available model names for generating embeddings.</p>
<h4 tabindex="-1" dir="auto">Parameters</h4>
<ul dir="auto">
<li><code>token</code>: Security token (optional).</li>
</ul>
<h3 tabindex="-1" dir="auto">6. <code>/get_all_stored_strings/</code> (GET)</h3>
<h4 tabindex="-1" dir="auto">Purpose</h4>
<p dir="auto">Retrieve a list of all stored strings from the database for which embeddings have been computed.</p>
<h4 tabindex="-1" dir="auto">Parameters</h4>
<ul dir="auto">
<li><code>token</code>: Security token (optional).</li>
</ul>
<h3 tabindex="-1" dir="auto">7. <code>/get_all_stored_documents/</code> (GET)</h3>
<h4 tabindex="-1" dir="auto">Purpose</h4>
<p dir="auto">Retrieve a list of all stored documents from the database for which embeddings have been computed.</p>
<h4 tabindex="-1" dir="auto">Parameters</h4>
<ul dir="auto">
<li><code>token</code>: Security token (optional).</li>
</ul>
<h3 tabindex="-1" dir="auto">8. <code>/clear_ramdisk/</code> (POST)</h3>
<h4 tabindex="-1" dir="auto">Purpose</h4>
<p dir="auto">Clear the RAM Disk to free up memory.</p>
<h4 tabindex="-1" dir="auto">Parameters</h4>
<ul dir="auto">
<li><code>token</code>: Security token (optional).</li>
</ul>
<h3 tabindex="-1" dir="auto">9. <code>/get_token_level_embeddings_matrix_and_combined_feature_vector_for_string/</code> (POST)</h3>
<h4 tabindex="-1" dir="auto">Purpose</h4>
<p dir="auto">Retrieve the token-level embeddings and combined feature vector for a given input text using the specified model.</p>
<h4 tabindex="-1" dir="auto">Parameters</h4>
<ul dir="auto">
<li><code>text</code>: The input text for which the embeddings are to be retrieved.</li>
<li><code>model_name</code>: The model used to calculate the embeddings (optional).</li>
<li><code>db_writer</code>: Database writer instance for managing write operations (internal use).</li>
<li><code>req</code>: HTTP request object (optional).</li>
<li><code>token</code>: Security token (optional).</li>
<li><code>client_ip</code>: Client IP address (optional).</li>
<li><code>json_format</code>: Format for JSON response of token-level embeddings (optional).</li>
<li><code>send_back_json_or_zip_file</code>: Whether to return a JSON response or a ZIP file containing the JSON file (optional, defaults to <code>zip</code>).</li>
</ul>
</article>
          </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[The OpenTF Manifesto (496 pts)]]></title>
            <link>https://opentf.org/</link>
            <guid>37133054</guid>
            <pubDate>Tue, 15 Aug 2023 12:19:33 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://opentf.org/">https://opentf.org/</a>, See on <a href="https://news.ycombinator.com/item?id=37133054">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
        <p>
          Terraform was open-sourced in 2014 under the Mozilla Public License (v 2.0) (the “MPL”).
          Over the next ~9 years, it built up a community that included thousands of users, contributors, customers,
          certified practitioners, vendors, and an ecosystem of open-source modules, plugins,
          libraries, and extensions.

          Then, on August 10th, 2023, with little or no advance notice or chance for much, if not all,
          of the community to have any input, HashiCorp switched the license for Terraform from the
          MPL to the Business Source License (v1.1) (the “BSL”), a non-open source license. In our
          opinion, this change threatens the entire community and ecosystem that’s built up around
          Terraform over the last 9 years.
        </p>

        <p>
          Our concern: the BSL license is a poison pill for Terraform.
        </p>

        <p>
          Overnight, tens of thousands of businesses, ranging from one-person shops to the
          Fortune 500, woke up to a new reality where the underpinnings of their infrastructure
          suddenly became a potential legal risk. The BSL and the additional use grant written by
          the HashiCorp team are vague, and now every company, vendor, and developer using Terraform
          has to wonder whether what they are doing could be construed as competitive with HashiCorp’s
          offerings. The FAQ provides some solace for end-customers and systems integrators today,
          but even if you might be in the clear now, how can you build confidence that your usage
          won't violate the license terms in the future? What if your products or HashiCorp's products
          change? What if HashiCorp changes how they interpret competitive? What if they change the
          license again? As a result, everything that uses Terraform is on shaky ground.
        </p>

        <p>
          It is clear to us that under the new license, the thriving ecosystem built up around the
          open source Terraform will dwindle and wither. As developers consider what tools to learn
          and what ecosystems to contribute to, and as companies consider what tools to use to manage
          their infrastructure, more and more, they'll pick alternatives that are genuinely open-source.
          Existing Terraform codebases will turn into outdated liabilities, independent tooling will
          all but disappear, and the community will fracture and disappear.
        </p>

        <p>
          This sort of change also harms all similar open-source projects. Every company and every
          developer now needs to think twice before adopting and investing in an open-source project
          in case the creator suddenly decides to change the license. Imagine if the creators of Linux
          or Kubernetes suddenly switched to a non-open-source license that only permitted
          non-competitive usage.
        </p>

        <p>
          We believe that the essential building blocks of the modern Internet, such as Linux, Kubernetes, 
          and Terraform need to be truly open source: that is the only way to ensure
          that we are building our industry on top of solid and predictable underpinnings.
        </p>

        <p>
          Our goal: ensure Terraform remains truly open source—always.
        </p>

        <p>
          Our aim with this manifesto is to return Terraform to a fully open source license. BSL 
          is <em>not</em> open source, so this would mean moving Terraform back to the MPL license, 
          or some other well-known, widely accepted open source license (e.g., Apache License 2.0). 
          Moreover, we want to be confident that Terraform will always remain open source, so you 
          don't have to worry about another sudden license change putting everything at risk. 
        </p>

        <p>
          Our request to HashiCorp: switch Terraform back to an open source license.
        </p>

        <p>
          We ask HashiCorp to do the right thing by the community: instead of going forward with the
          BSL license change, switch Terraform back to a truly open source license, and commit to keeping
          it that way forever going forward. That way, instead of fracturing the community, we end up with 
          a single, impartial, reliable home for Terraform where the whole community can unite to keep 
          building this amazing ecosystem.
        </p>

        <p>
          Our fallback plan: fork Terraform into a foundation.
        </p>

        <p>
          If HashiCorp is unwilling to switch Terraform back to an open source license, we propose to fork
          the legacy MPL-licensed Terraform and maintain the fork in the foundation. This is similar to how 
          Linux and Kubernetes are managed by foundations (the Linux Foundation and the Cloud Native 
          Computing Foundation, respectively), which are run by multiple companies, ensuring the tool stays 
          truly open source and neutral, and not at the whim of any one company.
        </p>

        <p>
          In particular, we want to create a foundation for Terraform that is:
        </p>

        <ul>
          <li>
            <span>Truly open source</span> - under a well-known and widely-accepted license that companies can trust,
            that won't suddenly change in the future, and isn't subject to the whims of a single vendor
          </li>
          <li>
            <span>Community-driven</span> - so that the community governs the project for the community, where pull
            requests are regularly reviewed and accepted on their merit
          </li>
          <li>
            <span>Impartial</span> - so that valuable features and fixes are accepted based on their value to the community,
            regardless of their impact on any particular vendor
          </li>
          <li>
            <span>Layered and modular</span> - with a programmer-friendly project structure
            to encourage building on top, enabling a new vibrant ecosystem of
            tools and integrations
          </li>
          <li>
            <span>Backwards-compatible</span> - so that the existing code can drive value for years to come
          </li>
        </ul>

        <h2>LIST OF PLEDGING COMPANIES AND PLEDGED RESOURCES:</h2>

        <p>
          We acknowledge that maintaining an open source project such as Terraform takes a considerable investment 
          in terms of time, skill, effort, and coordination. We are grateful to HashiCorp for creating Terraform
          and their leadership in getting it to this point, and to the thousands of community members for their 
          contributions so far. The next step for Terraform must be to remain open source, either by HashiCorp 
          switching it back to a truly open source license or by us forking it into a foundation. Whichever way 
          it turns out, to ensure that there is sufficient investment to grow and evolve Terraform, the 
          signatories below pledge to pool our resources to build a more open, inclusive future 
          for an open source Terraform.
        </p>

        <p>
          If you’re willing to join our cause, please sign the manifesto by
          <a href="https://github.com/opentffoundation/manifesto">creating a
            PR</a> and adding yourself at the bottom of this page and optionally
          let us know how you’d like to help, either as an individual or as an
          organization.
        </p>

        <h2>Pledged Companies</h2>

        <ul>
          <li><a href="https://gruntwork.io/">Gruntwork</a></li>
          <li><a href="https://spacelift.io/">Spacelift</a></li>
          <li><a href="https://env0.com/">env0</a></li>
          <li><a href="https://scalr.com/">Scalr</a></li>
          <li><a href="https://digger.dev/">Digger</a></li>
          <li><a href="https://doppler.com/">Doppler</a></li>
          <li><a href="https://massdriver.cloud/">Massdriver</a></li>
          <li><a href="https://www.qovery.com/">Qovery</a></li>
          <li><a href="https://rivet.gg/">Rivet</a></li>
          <li><a href="https://terramate.io/">Terramate</a></li>
          <li><a href="https://terrateam.io/">Terrateam</a></li>    
          <li><a href="https://verifa.io/">Verifa</a></li>    
          <li><a href="https://finisterra.io/">Finisterra</a></li>
        </ul>

        <h2>Contact us</h2>

        <p>
          If you are a member of the community, a member of the press, an employee of HashiCorp, or anyone else
          with questions or feedback to share, you can reach the team behind this manifesto by emailing us at
          <a href="mailto:pledge@opentf.org">pledge@opentf.org</a>.
        </p>

        <h2>Share</h2>

        
        <p>
          August 14th, 2023
        </p>
      </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Nintendo DS cameras are the best lo-fi photo trend (134 pts)]]></title>
            <link>https://www.polygon.com/23827844/nintendo-ds-dsi-3ds-camera-lofi-photo-trend</link>
            <guid>37133033</guid>
            <pubDate>Tue, 15 Aug 2023 12:17:14 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.polygon.com/23827844/nintendo-ds-dsi-3ds-camera-lofi-photo-trend">https://www.polygon.com/23827844/nintendo-ds-dsi-3ds-camera-lofi-photo-trend</a>, See on <a href="https://news.ycombinator.com/item?id=37133033">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
  <p id="5yq28G">Sometimes I miss the unique charms of the <a href="https://www.polygon.com/23818670/nintendo-3ds-eshop-closure-game-sales-2023">Nintendo DS and 3DS handhelds</a>. They were <em>weird</em>. I liked the wonky touch controls, and some games featured weird gimmicks with the built-in mic and cameras. Now the <a href="https://www.polygon.com/2016/1/6/10718652/best-nintendo-3ds-games-2016">family of handhelds</a> has newfound relevance; people are using the cameras on the Nintendo DSi, Nintendo 3DS, and other DS consoles to take photos and videos. As it turns out, the cameras are the perfect way to nostalgically capture the low-fidelity look of the 2010s. </p>
<p id="7cpJk8">My first real brush with the resurgence of the Nintendo DS camera was when a hip-hop duo called Joey Valence &amp; Brae recorded an entire music video on a Nintendo DS. The two musicians seem to really lean into a classic ’90s vibe sound-wise, and they recorded the entire music video for a song called “Punk Tactics” on a Nintendo DS. The crunchy, pixelated, lo-fi look seemed to connect with audiences; a teaser for the video got over 2.1 million views on <a href="https://www.polygon.com/tiktok">TikTok</a> and over 7.2 million views on YouTube, and the song went on to inspire its own viral trend. </p>
<div id="6r0qR6"><p><iframe src="https://www.youtube.com/embed/OklSZmIx9-o?rel=0" allowfullscreen="" scrolling="no" allow="accelerometer; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share;"></iframe></p></div>
<p id="eRWjDK">Since the release of this video, it’s become trendy to use the Nintendo DSi and 3DS handhelds as cameras. The first DS with a built-in camera was the Nintendo DSi, which Nintendo released globally in 2009. It contained two 0.3-megapixel cameras, one facing outwards and the other in. The cameras were pretty rudimentary even for the time, but for many who had the device (especially children), it could have been their first time having their own camera. Fast-forward to 2023, almost a decade since these consoles came out, and now the aging gen Z population can look back at that time period with <a href="https://www.tiktok.com/@joeystechtime/video/7227258242089471274">an air of romance</a>. </p>

<p id="kDj04I">Modern phone cameras are getting more and more advanced. Yet, some people still want something that looks stylized or isn’t picture-perfect. This inspires some to use old film cameras, but others might still have a Nintendo DS sitting around somewhere. These lo-fi cameras take extra-crunchy and pixelated photos that easily evoke a nostalgic aesthetic. </p>
<p id="ZrrlUY">In one viral video, a person shows off <a href="https://www.tiktok.com/@theaaroncain/video/7265386902071790894">photos they took during a trip to Yosemite</a>. The photos have a dreamy, painting-like quality. “This is the Gen Z version of Polaroids and I love it,” one user commented. </p>

<p id="VWRzuy">So if you happen to have a Nintendo DSi or 3Ds laying around, maybe try taking it out to take photos. I’ve seen people take <a href="https://www.tiktok.com/@geniewishes25/video/7237950772879691054">them to concerts</a> or <a href="https://www.tiktok.com/@heybentai/video/7162559435406134571">car shows</a>, but these devices are small enough to bring anywhere. I personally took mine on my last walk, and although I felt a little silly holding it up, I got some lovely shots of flowers. </p>
<div data-cid="apps/image_gallery-1692134788_4062_43293" data-cdata="{&quot;routing&quot;:false,&quot;keyboard&quot;:false,&quot;two_col&quot;:false,&quot;display_headline&quot;:false,&quot;expandable&quot;:false,&quot;svg_logo_data&quot;:null,&quot;anthem_component_id&quot;:2149989,&quot;entry_id&quot;:23591885}" id="z9GHn7">
    
    
    <div data-ui="viewer">
      <p><img src="" alt="">
      </p>
      </div>
    
    <div data-ui="scroller">
        <ul>
          
          <li data-ui="thumb" data-asset="24843462" data-slug="0" data-index="0">
            <a href="https://cdn.vox-cdn.com/uploads/chorus_asset/file/24843462/HNI_0021.JPG" role="button">
              
            </a>
            <span>
               
            </span>
            <span>
              Photo: Ana Diaz/Polygon
            </span>
          </li>
          
          <li data-ui="thumb" data-asset="24843464" data-slug="1" data-index="1">
            <a href="https://cdn.vox-cdn.com/uploads/chorus_asset/file/24843464/HNI_0026.JPG" role="button">
              
            </a>
            <span>
               
            </span>
            <span>
              Photo: Ana Diaz/Polygon
            </span>
          </li>
          
          <li data-ui="thumb" data-asset="24843467" data-slug="2" data-index="2">
            <a href="https://cdn.vox-cdn.com/uploads/chorus_asset/file/24843467/HNI_0025.JPG" role="button">
              
            </a>
            <span>
               
            </span>
            <span>
              Photo: Ana Diaz/Polygon
            </span>
          </li>
          
        </ul>
      </div>
  </div>



  
</div></div>]]></description>
        </item>
    </channel>
</rss>