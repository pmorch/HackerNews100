<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>HN100 - Readable Contents</title>
        <link>https://hn.algolia.com/api/v1/search_by_date?tags=%28story,poll%29&amp;numericFilters=points%3E100</link>
        <description>Uses Readability to add bodies to the RSS feed</description>
        <lastBuildDate>Sat, 10 Aug 2024 01:30:03 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[DARPA wants to bypass the thermal middleman in nuclear power systems (114 pts)]]></title>
            <link>https://www.ans.org/news/article-6276/darpa-wants-to-bypass-the-thermal-middleman-in-nuclear-power-systems/</link>
            <guid>41205439</guid>
            <pubDate>Fri, 09 Aug 2024 21:12:34 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.ans.org/news/article-6276/darpa-wants-to-bypass-the-thermal-middleman-in-nuclear-power-systems/">https://www.ans.org/news/article-6276/darpa-wants-to-bypass-the-thermal-middleman-in-nuclear-power-systems/</a>, See on <a href="https://news.ycombinator.com/item?id=41205439">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="expand_6276"><p>DARPA is interested in ideas to take alpha, beta, gamma, and neutron radiation from “any type of reactor,” including fission and fusion, and from nuclear processes and radioisotope decay, and directly convert those radioactive emissions to electricity to meet the specific power and lifetime requirements of a range of nuclear power systems. Respondents have until Aug. 30 to share their ideas.</p><p><strong>There’s got to be a better way:</strong> “Methods to convert the energy of nuclear fission reactions and the decay of radioisotopes into electricity have not evolved since the invention of radioisotope power systems and fission reactors over 70 years ago and remain unoptimized,” the RFI says. They rely on thermal heat transfer, and “in each step of this indirect conversion method neutrons, heat, and energy are lost to the shielding material, working fluid, and other system materials.”</p><p>Advanced reactor designs that use alternative coolants, including helium, sodium, and salts, would still use what DARPA calls “heritage nuclear power conversion technology” with water and steam as the working fluids, as would the fusion power plants being planned today.</p><p><strong>Why now? </strong>Tabitha Dodson, the program manager for DARPA DSO, which is launching the RFI, told <em>Nuclear News</em> that “two big things” are driving the interest.</p><p>“One is the extreme surge of investment in small and advanced nuclear technologies, such as in fusion and space reactors, which do not have a concurrent pairing of advanced power generation methods that doesn’t involve liquid-based heat transfer,” she said. “Next, there has been an order of magnitude improvement in radiation tolerance and efficiency for voltaics in recent years with encouraging performance that indicates radiovoltaics could scale up as an array usable in nuclear reactors.”</p><p><strong>Exploring radiovoltaics:</strong> The RFI points to research in direct energy conversion based on radiation, or radiovoltaics, which includes semiconductor-based neutron, gamma, beta, and alpha voltaics. In radiovoltaics, radiation indirectly excites electron-hole pairs in a semiconductor lattice—a process that resembles but is distinct from how photons accomplish energy conversion in photovoltaics.</p><p>Radiovoltaics has been used to generate electricity from small amounts of decaying radioisotopes to produce commercially available microelectronics and small batteries at the nanowatt to milliwatt levels. “At least two challenges, however, [prevent] these from being viable solutions today for simultaneous high-power, long-duration applications,” according to the RFI. Those challenges are efficiency—"in most cases the efficiencies of radiovoltaics are 1–3 percent per radiation emission”—and the lifespan of candidate semiconductor materials, which is limited by their ability to withstand excess radiation energy over time and maintain performance.</p><p>That’s where the order of magnitude improvement in performance that Dodson noted comes in. Recent years have seen “the discovery of radiation-resilient materials that are still able to carry electrons into the conduction band to drive current despite the incursion of radiation-driven defects,” she said. Now, DARPA is interested in the possibility of applying direct energy conversion beyond the milliwatt power levels that have been demonstrated, and in solutions optimized for neutron and gamma radiation from a fission or fusion reactor.</p><p><strong>Scaled to fit:</strong> If durable, efficient radiovoltaics can be developed, Dodson sees the potential for them to fit a range of electricity needs. “If we could make an array of cells that could be scaled to any broad area, this power generation method could be paired with any sized nuclear reactor or even nuclear radioisotope power system. It could even be scaled up to a commercial-sized power plant or down to tiny-sized microelectronics. What’s appealing about voltaics versus thermoelectrics or working-fluid methods are how thin, light, pliable, and scalable they could be to any size or form factor,” Dodson said.</p><p>Dodson’s work at DARPA has included <a href="https://www.ans.org/news/article-4842/leading-draco-to-launch-an-interview-with-darpas-tabitha-dodson/">a key role</a> in establishing and then serving as program manager of the nuclear thermal propulsion rocket program DRACO—the Demonstration Rocket for Agile Cislunar Operations. Space missions and deployments stand to gain from a scalable high power direct energy conversion technology.</p><p>“The issues that come with outdated power generation equipment on the ground are magnified for space nuclear technologies since space reactors are size constrained and have to carry all of that equipment with them,” according to Dodson.</p><p>Here on Earth, progress in neutron- and gamma-based radiovoltaics could lead to greater availability of small neutron and gamma detectors for reactor instrumentation and control, she noted. The RFI suggests that, with systems scaled for large-scale electricity generation and with improved material lifetimes and energy conversion efficiency, “one could create energy-generating ‘smart shields’ for nuclear systems that simultaneously cut down on nuclear waste.” In such shields, “neutron radiation from a fusion or fission reactor could transmute and decay radiovoltaic lattice materials doped or layered with isotopes that are tuned to absorb the reactor’s neutrons, thereafter generating secondary emission alpha or beta particles to further energize radiovoltaics.”</p><p><strong>What is the ask?</strong> The RFI asks: “Is it possible to achieve [a] direct energy conversion nuclear power system, ranging in power from 10s of watts electric (We) to 100s of kWe?” DARPA wants information “on the potential to improve specific power greater than 1 We/kg conversion from watts-thermal per radiation emission product,” and information on the potential to improve damage tolerance of the voltaic to nuclear radiation to reach an operating lifetime comparable to the life of its nuclear source, on the scale of decades.</p><p>“We will learn what our boundary conditions are when respondents tell us what technologies in the field of voltaics are possible, and we’ll use that to see if there is sufficient scientific rationale make a case to present for further DARPA investment,” Dodson said. “I also hope people are going to start thinking about nuclear systems that use electromagnetic versus thermal-kinetic methods to harvest nuclear energetic reactions.”</p><p>Responses can be submitted until 4 p.m. (EDT) on August 30. Questions can be directed to Dodson at <a href="mailto:DARPA-SS-24-01@darpa.mil">DARPA-SS-24-01@darpa.mil</a>.</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Show HN: Attaching to a virtual GPU over TCP (161 pts)]]></title>
            <link>https://www.thundercompute.com/</link>
            <guid>41203475</guid>
            <pubDate>Fri, 09 Aug 2024 16:50:41 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.thundercompute.com/">https://www.thundercompute.com/</a>, See on <a href="https://news.ycombinator.com/item?id=41203475">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><div id="Intro-section"><div><p><h2>One cloud instance for any task</h2></p></div><div id="w-node-_9ca3ddf5-0c6b-ee93-9de7-e2c6a345a5f5-0f15f585"><div id="w-node-_9ca3ddf5-0c6b-ee93-9de7-e2c6a345a5f6-0f15f585"><p><h3>Scalable</h3></p><p>Scale your usage up or down instantly, without limits, while only being billed for what you use</p></div><div id="w-node-_9ca3ddf5-0c6b-ee93-9de7-e2c6a345a606-0f15f585"><p><h3>Flexible</h3></p><p>Switch GPUs instantly with a single command without leaving your instance</p></div><div id="w-node-_9ca3ddf5-0c6b-ee93-9de7-e2c6a345a616-0f15f585"><p><h3>Simple</h3></p><p>Run your existing code on Thunder Compute without changes or config</p></div></div></div><div><div><p><h3>Switch from CPU-only to GPU with one command</h3></p><p>Save money by developing on your CPU. When you want to scale, access a cluster of GPUs on-demand.</p><div><div><p><h6>Flexible</h6></p><p>Switch to the GPUs you need, when you need them</p></div><div><p><h6>Serverless</h6></p><p>Never worry about config, quotas, or reservations again</p></div></div></div><p><img src="https://cdn.prod.website-files.com/65862b088e807ceb0f15f514/66b538824d3f378b4bd80c3f_Multi-gpu-ezgif.com-crop.webp" loading="lazy" sizes="(max-width: 767px) 90vw, (max-width: 991px) 43vw, 41vw" srcset="https://cdn.prod.website-files.com/65862b088e807ceb0f15f514/66b538824d3f378b4bd80c3f_Multi-gpu-ezgif.com-crop-p-500.webp 500w, https://cdn.prod.website-files.com/65862b088e807ceb0f15f514/66b538824d3f378b4bd80c3f_Multi-gpu-ezgif.com-crop.webp 800w" alt=""></p></div><div id="w-node-_9ca3ddf5-0c6b-ee93-9de7-e2c6a345a64c-0f15f585"><p><h2>Same budget, more impact</h2></p><p>With Thunder Compute, never pay for idle GPUs. Give developers direct access to GPUs, with the freedom to scale quickly.</p></div><div><div><p><h3>Industry partners</h3></p></div><p><a href="https://www.ycombinator.com/"><img src="https://cdn.prod.website-files.com/65862b088e807ceb0f15f514/6688a801e138560c10aa94ff_Svg_YCombinator-svg.svg" loading="lazy" alt="" height="75"></a><a href="https://aws.amazon.com/"><img src="https://cdn.prod.website-files.com/65862b088e807ceb0f15f514/6688aaaf72f4780a482b3547_AmazonWebservices_Logo-svg.svg" loading="lazy" alt="" height="75"></a><a href="https://cloud.google.com/"><img src="https://cdn.prod.website-files.com/65862b088e807ceb0f15f514/6688a7beb3b8db193b1367ec_google-cloud-3-svg.svg" loading="lazy" alt="" height="75"></a><a href="https://azure.microsoft.com/"><img src="https://cdn.prod.website-files.com/65862b088e807ceb0f15f514/6688a9b17edba368b93c0559_Microsoft_Azure-Logo.wine-svg%20(1).svg" loading="lazy" width="Auto" height="75" alt=""></a></p></div><div><div><p><h3>Get more out of every card</h3></p><p>GPUs at other cloud providers are utilized on-average 15% of the time, while 85% of what you pay goes to waste. With long-term reservations you have to guess how many GPUs you will need, resulting in shortages and overpayment.</p><div><div><p><h6>For Developers</h6></p><p>A cluster of high-performance GPUs at your fingertips without ever having to talk to IT</p></div><div><p><h6>For Enterprises</h6></p><p>Shrink your cloud budget by eliminating idle GPU time</p></div></div></div><p><img src="https://cdn.prod.website-files.com/65862b088e807ceb0f15f514/66b5436c663990b66dbfac1a_image%20(2).png" loading="lazy" sizes="(max-width: 767px) 90vw, (max-width: 991px) 43vw, 41vw" srcset="https://cdn.prod.website-files.com/65862b088e807ceb0f15f514/66b5436c663990b66dbfac1a_image%20(2)-p-500.png 500w, https://cdn.prod.website-files.com/65862b088e807ceb0f15f514/66b5436c663990b66dbfac1a_image%20(2)-p-800.png 800w, https://cdn.prod.website-files.com/65862b088e807ceb0f15f514/66b5436c663990b66dbfac1a_image%20(2)-p-1080.png 1080w, https://cdn.prod.website-files.com/65862b088e807ceb0f15f514/66b5436c663990b66dbfac1a_image%20(2)-p-1600.png 1600w, https://cdn.prod.website-files.com/65862b088e807ceb0f15f514/66b5436c663990b66dbfac1a_image%20(2).png 1818w" alt=""></p></div><div><div><h2>How it works</h2></div><div data-w-id="9ca3ddf5-0c6b-ee93-9de7-e2c6a345a69c"><div data-w-id="9ca3ddf5-0c6b-ee93-9de7-e2c6a345a69f"><p><h6>Run your code</h6></p><p>Use the Thunder Compute CLI to run your existing GPU code without any setup</p></div><div data-w-id="9ca3ddf5-0c6b-ee93-9de7-e2c6a345a6aa"><p><h6>Match with GPUs</h6></p><p>Behind the scenes, we automatically match your request to a GPU. Never worry about setting up an instance again</p></div><div data-w-id="9ca3ddf5-0c6b-ee93-9de7-e2c6a345a6b5"><p><h6>Securely process request</h6></p><p>Thunder never stores your data and uses end-to-end encryption for all data transfers</p></div><div data-w-id="9ca3ddf5-0c6b-ee93-9de7-e2c6a345a6c0"><p><h6>Pay less</h6></p><p>Thunder shares GPUs to reach utilization over 5x greater than other cloud platforms, saving you money</p></div></div></div><div><p><h2>Contact us</h2></p><p>Have any questions or want to see a demo? Contact our team to learn more</p></div></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[.INTERNAL is now reserved for private-use applications (168 pts)]]></title>
            <link>https://www.icann.org/en/board-activities-and-meetings/materials/approved-resolutions-special-meeting-of-the-icann-board-29-07-2024-en#section2.a</link>
            <guid>41203368</guid>
            <pubDate>Fri, 09 Aug 2024 16:36:50 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.icann.org/en/board-activities-and-meetings/materials/approved-resolutions-special-meeting-of-the-icann-board-29-07-2024-en#section2.a">https://www.icann.org/en/board-activities-and-meetings/materials/approved-resolutions-special-meeting-of-the-icann-board-29-07-2024-en#section2.a</a>, See on <a href="https://news.ycombinator.com/item?id=41203368">Hacker News</a></p>
<div id="readability-page-1" class="page"><section _ngcontent-ng-c3323332204="" main-content="" _ngcontent-ng-c507697319=""><!----><iti-sectioned-page _ngcontent-ng-c3323332204="" _nghost-ng-c2837300113=""><!----><!----><iti-fragment-container _ngcontent-ng-c2837300113="" _nghost-ng-c2540813831=""><div _ngcontent-ng-c2837300113="" id="section1"><h2 _ngcontent-ng-c2837300113=""><span _ngcontent-ng-c2837300113="">1. Consent Agenda</span><a _ngcontent-ng-c2837300113=""></a><!----><!----></h2><!----><!----><!----><!----><!----><div _ngcontent-ng-c2837300113="" id="section1.a"><!----><h3 _ngcontent-ng-c2837300113=""><span _ngcontent-ng-c2837300113="">a. Competition, Consumer Trust and Consumer Choice (CCT) Review Pending Recommendations</span><a _ngcontent-ng-c2837300113=""></a><!----><!----></h3><!----><!----><!----><!----><p>Whereas, on 1 March 2019, the Board <a href="https://www.icann.org/en/board-activities-and-meetings/materials/approved-resolutions-special-meeting-of-the-icann-board-01-03-2019-en#1.a">took action</a> on each of the 35 recommendations issued within the <a href="https://www.icann.org/en/system/files/files/cct-final-08sep18-en.pdf">Competition, Consumer Trust, and Consumer Choice (CCT) Review Team Final Report</a> dated 8 September 2018, as specified within the scorecard titled "<a href="https://www.icann.org/en/system/files/files/resolutions-final-cct-recs-scorecard-01mar19-en.pdf">Final CCT Recommendations: Board Action (1 March 2019)</a>". The Board resolved to place 17 CCT recommendations into pending status (in whole or in part), and committed to take further action on these recommendations subsequent to the completion of intermediate steps identified in the scorecard.</p>
<p>Whereas, on 22 October 2020, the Board <a href="https://www.icann.org/en/board-activities-and-meetings/materials/approved-resolutions-regular-meeting-of-the-icann-board-22-10-2020-en#2.a.rationale">resolved</a> to take action on 11 of the 17 CCT pending recommendations, as specified within the scorecard titled <a href="https://www.icann.org/en/system/files/files/cct-pending-recs-board-action-22oct20-en.pdf">"Competition, Consumer Trust, Consumer Choice Review Team (CCT-RT) Pending Recommendations: Board Action on 11 Recommendations"</a>.</p>
<p>Whereas, on 10 September 2023, the Board took <a href="https://www.icann.org/en/board-activities-and-meetings/materials/approved-resolutions-regular-meeting-of-the-icann-board-10-09-2023-en#section1.d">action</a> on two CCT pending recommendations as specified within the scorecard titled "<a href="https://www.icann.org/en/system/files/files/scorecard-board-action-assessment-cct-pending-ssr2-recs-10sep23-en.pdf">Board Action/Rationale on &amp; ICANN org Assessment of Competition, Consumer Trust, Consumer Choice Review (CCT) Pending Recommendations 14 and 15, and Second Security, Stability and Resiliency of DNS Review (SSR2) Recommendations 9.2, 9.3, 12.1, 12.2, 12.3, 12.4, 13.1, 13.2 and 14.2</a>".</p>
<p>Whereas, on 23 May 2024, the Board Organizational Effectiveness Committee (OEC) considered the study ICANN org commissioned to address the Board's 1 March 2019 request on CCT Recommendations 2, 3, 4, and 5 to "identify what types of data would be relevant in examining the potential impacts on competition and, whether that data is available, and how it could be collected [...]", and the resulting ICANN org assessment. The study identified that domain name price, including the types of pricing as requested by the CCT recommendations, is just one element that may signal competition in the domain name market. The study noted the potential limitations of studying pricing and suggested non-pricing related data elements that could be used to assess competition and inform the work of the next CCT Review Team.</p>
<p>Whereas, on 18 July 2024, the OEC made a recommendation to the ICANN Board to reject CCT Recommendations 2, 3, 4, and 5.</p>
<p>Resolved (2024.07.29.01), the Board rejects CCT Recommendations 2, 3, 4, and 5, as documented in the <a href="https://www.icann.org/en/system/files/files/scorecard-cct-pending-recs-29jul24-en.pdf">Board Action/Rationale on &amp; ICANN org Assessment of Competition, Consumer Trust, Consumer Choice Review (CCT) Pending Recommendations 2, 3, 4, 5</a>. The Board directs the ICANN Interim President and CEO, or her designee(s), to continue to evaluate and supplement existing metrics with additional data elements such as those identified within the study that would be indicative of competition and consumer welfare, as available and feasible.</p><div _ngcontent-ng-c2837300113="" id="section1.a.rationale"><!----><!----><h4 _ngcontent-ng-c2837300113=""><span _ngcontent-ng-c2837300113="">Rationale for Resolution 2024.07.29.01</span><a _ngcontent-ng-c2837300113=""></a><!----><!----></h4><!----><!----><!----><p><strong>Why is the Board addressing the issue?</strong></p>
<p>The Competition, Consumer Trust and Consumer Choice (CCT) Review is one of the four <a href="https://www.icann.org/resources/reviews/specific-reviews">Specific Reviews</a> anchored in Article 4, Section 4.6 of the ICANN Bylaws. Specific Reviews are conducted by community-led review teams, which assess ICANN's performance in fulfilling its commitments. Reviews contribute to ensuring that ICANN serves the public interest, are critical to maintaining an effective multistakeholder model, and help ICANN achieve its mission, as detailed in Article 1 of the Bylaws.</p>
<p>The CCT Review is the first iteration of this effort. It was initiated under the Affirmation of Commitments (AoC), and calls for an assessment of the extent to which the expansion of generic top-level domains (gTLDs) has promoted competition, consumer trust and consumer choice. It also serves to assess the effectiveness of the application and evaluation process during the 2012 round of the New gTLD Program.</p>
<p><strong>What is the proposal being considered?</strong></p>
<p>This proposed action is in furtherance of <a href="https://www.icann.org/en/board-activities-and-meetings/materials/approved-resolutions-special-meeting-of-the-icann-board-01-03-2019-en#1.a">resolution</a> 2019.03.01.04 to place 17 CCT recommendations in "pending" status.</p>
<p>CCT Recommendations 2, 3, 4, and 5 respectively call for ICANN org to collect data on wholesale pricing for legacy gTLDs, transactional pricing for the gTLD marketplace, retail pricing for the domain marketplace, and secondary market data.</p>
<p>The Board recalls the Registries Stakeholder Group (<a href="https://mm.icann.org/pipermail/comments-cct-final-recs-08oct18/2018q4/000007.html">RySG</a><a href="https://mm.icann.org/pipermail/comments-cct-final-recs-08oct18/2018q4/000007.html">)</a>'s comment on the CCT Final Report that expressed some concerns, notably that "price information is generally business sensitive", and there is a lack of clarity on who will have access to such data once collected, who will "arbitrate access to the data, and to what extent" ICANN commissioned a report to identify what types of information are probative to assess the competition within the DNS market. The report demonstrates that domain name price, including the different types of pricing data as requested by the CCT, is just one of the elements that may signal competition in the domain name market. While lower prices could be one measure of benefit, offering innovation or a better product (not necessarily at a lower price) is another key element of measuring possible consumer benefit and competitive impact. The report discusses that some innovations within new gTLDs introduced after the 2012 New gTLD round, provide enhanced safeguards to consumers, such as those associated with special use TLDs such as .bank, providing heightened registration requirements within those TLDs. The Board notes that contracts with gTLD Registry Operators and accredited Registrars do not provide ICANN with the ability to collect the requested pricing data. Further, ICANN does not have access to pricing data related to country code top-level domains (ccTLDs), either through ccTLD managers or the registrars through which most of them are offering registrations. ICANN also does not have access to secondary market data on sales of domain names, which are not governed by ICANN agreements, either. Moreover, the Board notes that the Registries Stakeholder Group, <a href="https://mm.icann.org/pipermail/comments-cct-final-recs-08oct18/2018q4/000007.html">RySG</a>, stated that "not only should ICANN not involve itself with pricing studies, using parties' contracts with ICANN as a mechanism to force its production is terribly inappropriate". The Board is mindful that even if ICANN were to have access to such pricing data, the risks of collection and maintenance of such data within ICANN raise questions about the propriety of ICANN becoming a clearinghouse for pricing-related data, and the potential for ICANN to be used as a source for competitors to access sensitive pricing data on their competitors. The Board acknowledges that the CCT Review Team suggests that ICANN could outsource the compilation and storage of pricing related data to a third party, however that still creates a clearinghouse of pricing data under ICANN's control and does not mitigate the Board's concerns.</p>
<p>As a result, the Board rejects CCT Recommendations 2, 3, 4, and 5.</p>
<p>The Board acknowledges that the report provides substantial information on the types of non-pricing data elements that might support an evaluation of competition in the DNS market. The report states that, in forming the list of non-pricing data elements, the author "[has] not determined whether ICANN is able to access the items on the list. To the extent that a given item is not available to ICANN, obviously no analysis based on that item could be conducted." The Board notes that the ICANN org has already started an evaluation of the data points identified to assess if the data is available to ICANN, could be made available through contracts, or might be available through third-party data sources. Through this, ICANN has the opportunity to collect and maintain data that could meet the CCT Review Team's goal "to have access to data for use in evaluating competition within future reviews," beyond pricing.</p>
<p><strong>Which stakeholders or others were consulted?</strong></p>
<p>The Board received community feedback as part of the <a href="https://www.icann.org/en/public-comment/proceeding/competition-consumer-trust-and-consumer-choice-review-team-cct-final-report--recommendations-08-10-2018">public comment proceeding</a> on the CCT Final Report.</p>
<p>ICANN commissioned a third party, an economist, to address the ICANN Board's 1 March 2019 request to "identify what types of data would be relevant in examining the potential impacts on competition and, whether that data is available, and how it could be collected [...]" to inform the Board's decision.</p>
<p><strong>What significant materials did the Board review?</strong></p>
<p>The Board considered various significant materials and documents. In addition to the study, the Board consulted the review team's final report, and the <a href="https://itp.cdn.icann.org/en/files/specific-reviews/report-comments-cct-final-recs-01feb19-en.pdf" data-linktype="fileRedirectUrl">Staff Report of Public Comment Proceeding on Competition, Consumer Trust, and Consumer Choice Review Team (CCT) Final Report &amp; Recommendations</a>.</p>
<p><strong>Are there positive or negative community impacts?</strong></p>
<p>Taking action on the four CCT pending recommendations contributes to further addressing the outcome of the Specific Review, and enhancing ICANN's accountability.</p>
<p><strong>Are there fiscal impacts or ramifications on ICANN (strategic plan, operating plan, budget); the community; and/or the public?</strong></p>
<p>None.</p>
<p><strong>Are there any security, stability or resiliency issues relating to the DNS?</strong></p>
<p>None.</p>
<p><strong>Is this decision in the public interest and within ICANN's mission?</strong></p>
<p>This action is in the public interest as it is a fulfillment of ICANN Bylaws, as articulated in Section 4.6. It is also within ICANN's mission and mandate. ICANN reviews are an important and essential part of how ICANN upholds its commitments.</p>
<p><strong>Is this either a defined policy process within ICANN's Supporting Organizations or ICANN's Organizational Administrative Function decision requiring public comment or not requiring public comment?</strong></p>
<p>None required.</p><!----><!----></div><!----><!----></div><div _ngcontent-ng-c2837300113="" id="section1.b"><!----><h3 _ngcontent-ng-c2837300113=""><span _ngcontent-ng-c2837300113="">b. Contract Extension with Provider for Implementation and gTLD Application Process Management Resources for New gTLD Program: Next Round</span><a _ngcontent-ng-c2837300113=""></a><!----><!----></h3><!----><!----><!----><!----><p>Whereas, ICANN org has identified a critical need for qualified vendors with specialized expertise and capabilities to manage the size, scope, and complexities of the New gTLD Program: Next Round (Next Round) as they relate to development and management of the governance structure at a program level and to help deliver the scope of the project and achieve project objectives.</p>
<p>Whereas, the resources provided by the selected vendor have already demonstrated their value and expertise as part of the initial engagement that org entered into.</p>
<p>Whereas, ICANN org and the Board Finance Committee have recommended that the ICANN Board authorize the ICANN Interim President and CEO, or her designee(s), to take all steps necessary to extend the contract with the selected vendor through [Redacted – Confidential Negotiation Information], and make disbursements in furtherance of that extension, in an amount not to exceed [Redacted – Confidential Negotiation Information].</p>
<p>Resolved (2024.07.29.02), the Board authorizes the Interim President and CEO, or her designee(s), to take all steps necessary to extend the contract with the selected vendor through [Redacted – Confidential Negotiation Information], and make disbursements in furtherance of that extension, in an amount not to exceed [Redacted – Confidential Negotiation Information].</p>
<p>Resolved (2024.07.29.03), specific items within this resolution shall remain confidential for negotiation purposes pursuant to Article 3, section 3.5(b) of the ICANN Bylaws until the President and CEO determines that the confidential information may be released.</p><div _ngcontent-ng-c2837300113="" id="section1.b.rationale"><!----><!----><h4 _ngcontent-ng-c2837300113=""><span _ngcontent-ng-c2837300113="">Rationale for Resolutions 2024.07.29.02 – 2024.07.29.03</span><a _ngcontent-ng-c2837300113=""></a><!----><!----></h4><!----><!----><!----><p>In order to facilitate the New gTLD Program: Next Round (Next Round) governance structure outlined above, ICANN org has a need for external resources to be dedicated full-time to how the work gets done, including maintenance of project schedules, budget and human resource tracking, reporting, decision logs, and other areas of implementation management.</p>
<p>Following review and conversations with various firms through a targeted Request for Proposal (RFP) process, the designated provider was selected. The provider was engaged under an initial contract, which was then extended. Based on a positive outcome of the work performed thus far, and to ensure a natural continuation of work carried out, an extension is recommended through [Redacted – Confidential Negotiation Information].</p>
<p>The program implementation manager was engaged by ICANN org in October 2023 and has been supporting the Program with the overall management and oversight of the New gTLD Program. To date, the externally sourced implementation manager has established effective planning and controls for the program and provided the structure needed to drive a successful program.</p>
<p>The gTLD Application Process (GAP) senior project manager was contracted in June 2024 and has been working with the ICANN GAP project lead, the project team and numerous external vendors, providing the structure, tools, and processes to enable the project team to successfully deliver the scope of the project and achieve project objectives. The GAP project is the largest project within the Next Round, responsible for the design, development and implementation of the gTLD application process and system. ICANN is anticipating an extension of the GAP Project Manager contract through [Redacted – Confidential Negotiation Information].</p>
<p>The total value of a contract extension with the selected vendor will be in an amount not exceed [Redacted – Confidential Negotiation Information].</p>
<p>This action is within ICANN's Mission and is in the public interest as it is important to ensure that, in carrying out its Mission, ICANN utilizes available funding in the most effective and efficient manner so as to be in the best interests of ICANN and the global Internet community.</p>
<p>This decision will have a fiscal impact, but the impact has already been accounted for in the FY25 New gTLD Program budget and will be for the future budgets as well. Further, this decision should not have a negative impact on the security, stability or resiliency of the domain name system, and likely will have a positive impact.</p>
<p>This is an Organizational Administrative Function that does not require public comment.</p><!----><!----></div><!----><!----></div><div _ngcontent-ng-c2837300113="" id="section1.c"><!----><h3 _ngcontent-ng-c2837300113=""><span _ngcontent-ng-c2837300113="">c. Contract Extension with Provider for Vendor Management Resources for New gTLD Program: Next Round</span><a _ngcontent-ng-c2837300113=""></a><!----><!----></h3><!----><!----><!----><!----><p>Whereas, to help ensure cost efficiencies and risk mitigation, ICANN organization has identified a critical need for qualified vendors with specialized expertise and capabilities to manage the development of the vendor strategy and the Request for Proposal (RFP) requirements design for the evaluation of the New gTLD Program: Next Round (Next Round) applications.</p>
<p>Whereas, ICANN org and the Board Finance Committee (BFC) recommends that the ICANN Board authorize the Interim President and CEO, or her designee(s), to enter into an agreement with the selected vendor for an additional [Redacted – Confidential Negotiation Information], in an amount not to exceed [Redacted – Confidential Negotiation Information].</p>
<p>Resolved (2024.07.29.04), the Board authorizes the Interim President and CEO, or her designee(s), to contract for, and make disbursement in furtherance of, a [Redacted – Confidential Negotiation Information] of an existing contract with the selected vendor to provide a vendor strategist and a vendor sourcing consultant, in an amount not to exceed [Redacted – Confidential Negotiation Information].</p>
<p>Resolved (2024.07.29.05), specific items within this resolution shall remain confidential for negotiation purposes pursuant to Article 3, section 3.5(b) of the ICANN Bylaws until the President and CEO determines that the confidential information may be released.</p><div _ngcontent-ng-c2837300113="" id="section1.c.rationale"><!----><!----><h4 _ngcontent-ng-c2837300113=""><span _ngcontent-ng-c2837300113="">Rationale for Resolutions 2024.07.29.04 – 2024.07.29.05</span><a _ngcontent-ng-c2837300113=""></a><!----><!----></h4><!----><!----><!----><p>In order to support the New gTLD Program: Next Round (Next Round), ICANN org has a need for a vendor strategist and a vendor sourcing consultant to help define the Next Round vendor risk management and sourcing strategy in line with the New gTLD Program's objectives and needs. This includes the mitigation model for conflict of interest and subjectivities of certain deliverables, segregation of duty requirements, determination of overall number of vendors required to execute the Program with cost effectiveness in mind, and risk mitigation for the unknown volume and duration of work assigned to each vendor.</p>
<p>Following review and conversations with various firms, through a targeted RFP process, the designated provider was selected. The provider has been engaged under a 3-month initial contract. Upon a positive outcome of the initial contract, an extension is recommended in order to continue working with the existing vendor strategist and the vendor sourcing consultant for the following reasons:</p>
<ul>
<li>Experience and quality of resources leading organizations through vendor strategy and RFP development.</li>
<li>Lower cost of resources compared with other vendors.</li>
<li>Most experienced candidates, with the most applicable skillset, at the lowest cost.</li>
<li>Internal ICANN staff have limited experience in sourcing contracts of this size with large and experienced firms.</li>
<li>Expertise in how to set the strategy on utilization of vendors and techniques to structure RFPs in a way to minimize cost and risk.</li>
</ul>
<p>The vendor strategist will develop the vendor sourcing strategy and pricing model for multiple vendors delivering the gTLD application process capabilities, manage the development of vendor requirements and performance criteria to be included in the Request for Proposals (RFPs), and support ICANN staff in the negotiation of vendor contracts, and establishment of vendor governance and oversight, for the New gTLD Program Next Round.</p>
<p>The vendor sourcing consultant will work closely with the vendor strategist, vendor management team, procurement team, and various subject matter experts to ensure timely and effective development of RFP materials, training and on-boarding of vendors, and engagement with a number of vendors to carry on the application processing of the Next Round.</p>
<p>The total value of the [Redacted – Confidential Negotiation Information] contract extension with the selected vendor will be in an amount not exceed [Redacted – Confidential Negotiation Information].</p>
<p>This action is within ICANN's Mission and is in the public interest as it is important to ensure that, in carrying out its Mission, ICANN utilizes available funding in the most effective and efficient manner so as to be in the best interests of ICANN and the global Internet community.</p>
<p>This decision will have a fiscal impact, but the impact has already been accounted for in the FY25 New gTLD Program budget and will be for the future budgets as well. Further, this decision should not have a negative impact on the security, stability or resiliency of the domain name system, and likely will have a positive impact.</p>
<p>This is an Organizational Administrative Function that does not require public comment.</p><!----><!----></div><!----><!----></div><!----><!----></div><div _ngcontent-ng-c2837300113="" id="section2"><h2 _ngcontent-ng-c2837300113=""><span _ngcontent-ng-c2837300113="">2. Main Agenda</span><a _ngcontent-ng-c2837300113=""></a><!----><!----></h2><!----><!----><!----><!----><!----><div _ngcontent-ng-c2837300113="" id="section2.a"><!----><h3 _ngcontent-ng-c2837300113=""><span _ngcontent-ng-c2837300113="">a. Reserving .INTERNAL for Private-Use Applications</span><a _ngcontent-ng-c2837300113=""></a><!----><!----></h3><!----><!----><!----><!----><p>Whereas, on 18 September 2020, the Security and Stability Advisory Committee (SSAC) published <a href="https://www.icann.org/en/system/files/files/sac-113-en.pdf">SAC113: SSAC Advisory on Private-Use TLDs</a> (SAC113), recommending that the ICANN Board ensure a string is identified and reserved at the top level of the Domain Name System (DNS) for private use, and that this particular string must never be delegated.</p>
<p>Whereas, the Board Technical Committee and ICANN organization have evaluated the feasibility of the SSAC's advice in <a href="https://www.icann.org/en/system/files/files/sac-101-v2-en.pdf">SAC113</a> and developed a proposed approach for implementing the advice.</p>
<p>Whereas, on 20 October 2020, Göran Marby, President and Chief Executive Officer of ICANN org <a href="https://www.icann.org/en/system/files/correspondence/marby-to-cooper-kuhlewind-22oct20-en.pdf">wrote</a> Alissa Cooper, Chair, Internet Engineering Task Force (IETF) and Mirja Kühlewind, Chair, Internet Architecture Board (IAB) requesting further discussion on the recommendation of SAC113.</p>
<p>Whereas, on 12 November, 2020 Alissa Cooper on behalf of the Internet Engineering Steering Group and Mirja Kühlewind on behalf of the IAB <a href="https://www.icann.org/en/system/files/correspondence/cooper-kuhlewind-to-marby-12nov20-en.pdf">responded</a>.</p>
<p>Whereas, on 22 September 2022, the Board passed <a href="https://www.icann.org/en/board-activities-and-meetings/materials/approved-resolutions-regular-meeting-of-the-icann-board-22-09-2022-en#2.b">resolution 2022.09.22.08</a> directing ICANN org to conduct a Public Comment proceeding on a proposed procedure to identify and reserve a string for private use in accordance with the recommendation contained in SAC113.</p>
<p>Whereas, the Board has considered the letter received from the <a href="https://www.icann.org/en/system/files/correspondence/cooper-kuhlewind-to-marby-12nov20-en.pdf">Internet Architecture Board</a>, the comments received during the <a href="https://itp.cdn.icann.org/en/files/root-system/public-comment-summary-report-proposed-procedure-selecting-top-level-domain-string-private-use-27-03-2023-en.pdf" data-linktype="fileRedirectUrl">public comment proceeding</a>, the additional input the SSAC provided in <a href="https://www.icann.org/en/system/files/correspondence/rasmussen-to-davies-26apr23-en.pdf">SAC2023-05</a>, ICANN org's <a href="https://www.icann.org/en/system/files/correspondence/davies-to-rasmussen-16may23-en.pdf">response to SAC2023-05</a>, and the implementation recommendations from the Board Technical Committee and ICANN org relating to this advice.</p>
<p>Whereas, the Board resolved (<a href="https://www.icann.org/en/board-activities-and-meetings/materials/approved-resolutions-regular-meeting-of-the-icann-board-10-09-2023-en#section1.e">2023.09.10.09</a>) to direct the "Interim President and CEO, or her designee(s), to assess SAC113 candidate strings using the assessment criteria IANA has developed. This work is expected to involve the IANA functions that ICANN operates. After IANA has selected a string, the Board directs the Interim President and CEO, or her designee(s), to conduct a Public Comment proceeding to gather feedback on whether the string proposed by IANA meets the criteria defined in SAC113 Section 4.1. The Interim President and CEO, or her designee(s) shall then prepare and submit a report on the public comments received during this proceeding to assist the Board in determining whether to permanently reserve the string or not."</p>
<p>Whereas, the Board has considered the comments received during the <a href="https://itp.cdn.icann.org/en/files/root-system/public-comment-summary-report-proposed-top-level-domain-string-private-use-16-04-2024-en.pdf" data-linktype="fileRedirectUrl">second public comment proceeding</a> on the proposed string for reservation .INTERNAL.</p>
<p>Resolved (2024.07.29.06), the Board reserves .INTERNAL from delegation in the DNS root zone permanently to provide for its use in private-use applications. The Board recommends that efforts be undertaken to raise awareness of its reservation for this purpose through the organization's technical outreach.</p><div _ngcontent-ng-c2837300113="" id="section2.a.rationale"><!----><!----><h4 _ngcontent-ng-c2837300113=""><span _ngcontent-ng-c2837300113="">Rationale for Resolution 2024.07.29.06</span><a _ngcontent-ng-c2837300113=""></a><!----><!----></h4><!----><!----><!----><p><strong><em>Why is the Board addressing the issue now?</em></strong></p>
<p>In resolution 2022.09.22.08, the Board approved a four-step process to implement the recommendation contained in SAC113.</p>
<p>The four proposed steps were:</p>
<ol>
<li>Conduct a Public Comment proceeding on the proposed approach in steps 2, 3 and 4;</li>
<li>Instruct IANA to choose the string using the criteria described in SAC113;</li>
<li>Conduct a Public Comment proceeding on the proposed string chosen by IANA in step 2; and</li>
<li>Pass a Board resolution to reserve the proposed string.</li>
</ol>
<p>ICANN org completed the Public Comment of the first step and published a report on its outcome. The Board then instructed ICANN org to choose a string using the criteria described in SAC113. IANA chose the string .INTERNAL. ICANN org then completed a second Public Comment on the chosen string and published a report on its outcome.</p>
<p><strong><em>What is the proposal being considered?</em></strong></p>
<p>The Board is considering whether to reserve .INTERNAL from insertion in the DNS root zone permanently. Applicants of the next and subsequent gTLD application rounds will not be able to apply for the .INTERNAL top-level domain.</p>
<p><strong><em>Which stakeholders or others were consulted?</em></strong></p>
<p>SAC113 discusses many of the efforts, both ongoing and abandoned, in the Internet Engineering Task Force (IETF) to try and resolve this issue. Since the publication of SAC113 the ICANN Board and the Internet Architecture Board (IAB) have exchanged correspondence about SAC113, briefly summarized below.</p>
<p>In the <a href="https://www.icann.org/en/system/files/correspondence/marby-to-cooper-kuhlewind-22oct20-en.pdf">first correspondence</a> from the ICANN Board to the IETF/IAB Chairs, the Board asked for clarification on what the definition of a 'technical use' was for domain names. Since the <a href="https://datatracker.ietf.org/doc/html/rfc2860">Memorandum of Understanding (MoU)</a> between ICANN and the IETF considers 'assignments of domain names for technical uses' something the ICANN Board cannot delegate, assign, or instruct IANA to reserve unilaterally.</p>
<p>In its <a href="https://www.icann.org/en/system/files/correspondence/cooper-kuhlewind-to-marby-12nov20-en.pdf">response</a>, the IAB/IETF states:</p>
<blockquote>
<p>We understand SAC113 to be a proposal for the ICANN [B]oard to allocate an ICANN Reserved Name, and we believe that it being reserved by ICANN would necessarily require that the chosen string also be removed from consideration for any technical use specified by the IETF. In keeping with our commitment to a single, global namespace (RFC 2826), such a reservation would ensure that the IETF would not consider any special-use name with the same string. Procedurally, if the ICANN board chooses to reserve a string following the advice of SAC113, we would expect the string to be reserved within the IANA-managed reserved domain registry rather than the special-use domain names registry.</p>
</blockquote>
<p>The IAB/IETF did not voice any objection to the ICANN Board permanently reserving a top-level string.</p>
<p>During the first Public Comment Proceeding on the Proposed Procedure for Selecting a Top-Level Domain String for Private Use, ICANN received comments from the following groups.</p>
<ul>
<li>Business Constituency (BC)</li>
<li>Governmental Advisory Committee (GAC)</li>
<li>Intellectual Property Constituency (IPC)</li>
<li>Network Information Centre for United Kingdom of Great Britain and Northern Ireland (UKGBNI)</li>
<li>Registries Stakeholder Group (RySG)</li>
<li>Security and Stability Advisory Committee (SSAC)</li>
</ul>
<p>Two individuals also provided feedback in their individual capacities.</p>
<p>During the second Public Comment Proceeding ICANN received comments from the following groups.</p>
<ul>
<li>At-Large Advisory Committee (ALAC)</li>
<li>Amazon.com, Inc.</li>
<li>Business Constituency (BC)</li>
<li>Google</li>
<li>I Love Domains - United States o' America (ILDUSA)</li>
<li>The IO Foundation (IO)</li>
<li>Registries Stakeholder Group (RySG)</li>
<li>Security and Stability Advisory Committee (SSAC)</li>
</ul>
<p>24 individuals also provided feedback in their individual capacities.</p>
<p><strong><em>What concerns or issues were raised by the community?</em></strong></p>
<p>Community members have noted that, even if a top-level string is reserved for technical use, there is no way to compel equipment vendors, protocol designers, and others to use it. It is also not possible to determine the extent to which the chosen string will be used. It is therefore conceivable that implementing SAC113 could ultimately have no material effect on the DNS.</p>
<p>It is also likely not possible to choose a single string that will enjoy universal agreement as being the most appropriate string for this purpose. Different stakeholders and individuals may have different ideas of what the best string is for this purpose, and it will not be possible to identify a single string that will be acceptable to all stakeholders. This consequence is, however, distinct from the ability to choose a string that adheres to the criteria set forth in SAC113.</p>
<p>ICANN org initiated the first public comment proceeding on the proposed process and published a <a href="https://itp.cdn.icann.org/en/files/root-system/public-comment-summary-report-proposed-procedure-selecting-top-level-domain-string-private-use-27-03-2023-en.pdf" data-linktype="fileRedirectUrl">report on the public comment proceeding</a>.</p>
<p>In response to the report of the first public comment proceeding the SSAC provided additional input via a correspondence, <a href="https://www.icann.org/en/system/files/correspondence/rasmussen-to-davies-26apr23-en.pdf">SSAC2023-05: SSAC Response to Public Comment Summary Report on Proposed Procedure for Selecting a Private Use TLD</a> in which the SSAC commented:</p>
<blockquote>
<p>The SSAC certainly acknowledges that much expertise exists within ICANN org to implement policy decisions. However, implementation plans, e.g., the work products of Implementation Review Teams, are routinely published for public comment before actual implementation. Therefore, it is disappointing that [the summary] response effectively dismisses the request to provide a more detailed selection process (implementation plan) and make that available for Public Comment before that process is undertaken.</p>
</blockquote>
<p>ICANN org sent a <a href="https://www.icann.org/en/system/files/correspondence/davies-to-rasmussen-16may23-en.pdf">response to SSAC2023-05</a> describing the procedure and noting that the Board still had to make a decision on whether or not to proceed with instructing IANA to select a string for reservation.</p>
<p>The Board then proceeded with instructing ICANN org to proceed with choosing a string for reservation with Board resolution 2023.09.10.09. IANA then proposed .INTERNAL and initiated a <a href="https://itp.cdn.icann.org/en/files/root-system/public-comment-summary-report-proposed-top-level-domain-string-private-use-16-04-2024-en.pdf" data-linktype="fileRedirectUrl">second public comment proceeding</a>. Two themes were identified in the comments received that did not agree with the proposal.</p>
<p>The first was that .INTERNAL was too long. Six respondents to the Public Comment believed the selected string to be too long.</p>
<p>Additionally, one respondent believed that the string was not meaningful enough. This respondent viewed the analysis as insufficient to demonstrate the meaningfulness of the string, and concluded the assessment may need to be performed again.</p>
<p><strong><em>What significant materials did the Board review?</em></strong></p>
<p>The Board has reviewed SAC113, an Options Paper developed by ICANN org staff, correspondence between ICANN and the IAB, the MoU between ICANN and the IETF, the Public Comment Summary Report of the Proposed Procedure for Selecting a Top-Level Domain String for Private Use Public Comment, SSAC2023-05, ICANN org's response to SSAC2023-05, and the summary report on the second Public Comment Proceeding.</p>
<p><strong><em>What factors did the Board find to be significant?</em></strong></p>
<p>The Board recognizes that the problem highlighted in SAC113 is a legitimate and significant one that could, if not addressed, materially affect the DNS. Reserving .INTERNAL will not only close out SAC113, but also resolve a longstanding issue. Network administrators unable to use a name in the global DNS for their private, or internal, uses can now safely use .INTERNAL.</p>
<p><strong><em>Are there positive or negative community impacts?</em></strong></p>
<p>A positive impact from this Board resolution is to complete the process to provide a designated namespace for the private use of vendors and other users of the DNS. A negative impact is that there will be one fewer meaningful names available for delegation in the root zone.</p>
<p><strong><em>Are there fiscal impacts or ramifications on ICANN (strategic plan, operating plan, budget); the community; and/or the public?</em></strong></p>
<p>No additional fiscal impact is anticipated as a result of reserving .INTERNAL for private use.</p>
<p><strong><em>Are there any security, stability or resiliency issues relating to the DNS?</em></strong></p>
<p>The SSAC has identified many security, stability, and resiliency issues associated with the uncoordinated use of private-use names in SAC113. It is impossible to determine the extent to which reserving a string for private use will alleviate these issues. However, it will not introduce any new security, stability or resiliency issues. It will also not increase the severity of any known and existing security, stability, or resiliency issues.</p>
<p><strong><em>Is this decision in the public interest and within ICANN's mission?</em></strong></p>
<p>Reserving a string from delegation permanently is in the public interest for the reasons outlined in this resolution and rationale. It is also within the scope of ICANN's mission as described in the Bylaws. Specifically, Section 1.1 (a) (i) which states: "[ICANN] Coordinates the allocation and assignment of names in the root zone of the Domain Name System [..]".</p>
<p>In its <a href="https://www.icann.org/en/system/files/correspondence/cooper-kuhlewind-to-marby-12nov20-en.pdf">letter to the Board</a>, the IAB/IETF agreed that this reservation was within the scope of ICANN based on <a href="https://datatracker.ietf.org/doc/html/rfc2860">ICANN's MoU with the IETF</a>.</p>
<p>During the <a href="https://itp.cdn.icann.org/en/files/root-system/public-comment-summary-report-proposed-procedure-selecting-top-level-domain-string-private-use-27-03-2023-en.pdf" data-linktype="fileRedirectUrl">first public comment proceeding</a> there were no comments received stating that this reservation was not in the public interest or that it was not within ICANN's mission.</p>
<p><strong><em>Is this either a defined policy process within ICANN's Supporting Organizations or ICANN's Organizational Administrative Function decision requiring public comment or not requiring public comment?</em></strong></p>
<p>Reserving a string from delegation permanently is neither a defined policy process with ICANN's supporting organizations nor an ICANN administrative function. The Public Comment proceedings outlined in the four-step implementation plan are not required by the ICANN Bylaws, but are part of the proposed process for implementing SAC113. The purpose of this specific Board action is to finalize this process by reserving .INTERNAL permanently, thereby preventing applicants of the next and subsequent gTLD application rounds from applying for it.</p><!----><!----></div><!----><!----></div><div _ngcontent-ng-c2837300113="" id="section2.b"><!----><h3 _ngcontent-ng-c2837300113=""><span _ngcontent-ng-c2837300113="">b. GAC Advice in ICANN80 Communiqué Regarding the Applicant Support Program</span><a _ngcontent-ng-c2837300113=""></a><!----><!----></h3><!----><!----><!----><!----><p>Whereas, the Governmental Advisory Committee (GAC) met during the ICANN80 meeting in Kigali, Rwanda and issued advice to the ICANN Board in a <a href="https://gac.icann.org/advice/communiques/ICANN80%20GAC%20Communique-zh.pdf">communiqué</a> on 17 June 2024 (ICANN80 Kigali Communiqué).</p>
<p>Whereas, the ICANN80 Kigali Communiqué was the subject of an exchange between the Board and the GAC on 15 July 2024.</p>
<p>Whereas, in a 12 July 2024 <a href="https://gnso.icann.org/sites/default/files/policy/2024/correspondence/dibiase-to-sinha-12jul24-en.pdf">letter</a>, the GNSO Council provided its feedback to the Board concerning advice in the ICANN80 Kigali Communiqué relevant to Applicant Support Program (ASP) and Auctions: Mechanisms of Last Resort/Private Resolution of Contention Sets in New gTLDs.</p>
<p>Whereas, the Board developed a scorecard to respond to the GAC's advice in the ICANN80 Kigali Communiqué, taking into account the dialogue between the Board and the GAC and the information provided by the GNSO Council.</p>
<p>Whereas, the Board has noted that GAC Consensus Advice item 1.a.i does not align with the Board-adopted GNSO Guidance Process ("GGP") for Applicant Support Guidance Recommendation 9 as well as the New gTLD Subsequent Procedures ("SubPro") Policy Development Process Recommendation 17.1.</p>
<p>Whereas, the Board has identified concerns with GAC Consensus Advice item 1.a.ii including concerns regarding the feasibility of implementation and potentially significantly increasing the risks of conflicts of interest and legal challenges over ASP evaluation and related decision-making.</p>
<p>Whereas, the Bylaws <a href="https://www.icann.org/resources/pages/governance/bylaws-en/#article12">require</a> that "[i]n the event that the Board determines to take an action that is not consistent with Governmental Advisory Committee advice, it shall so inform the Governmental Advisory Committee and state the reasons why it decided not to follow that advice" and the Board and GAC are required to enter into a Bylaws Consultation process.</p>
<p>Resolved (2024.07.29.07), the Board adopts the scorecard titled "<a href="https://www.icann.org/en/system/files/files/scorecard-gac-advice-kigali-communique-board-action-29jul24-en.pdf">GAC Advice – ICANN80 Kigali Communiqué: Actions and Updates (29 July 2024)</a>" in response to items of GAC advice in the ICANN80 Kigali Communiqué.</p>
<p>Resolved (2024.07.29.08), the Board has determined that it intends to take an action that is not consistent or may not be consistent with GAC Consensus Advice item 1.a.i. and 1.a.ii in the ICANN80 Kigali Communiqué concerning the ASP, and hereby initiates the required Board-GAC Bylaws Consultation Process. The Board will provide written notice to the GAC to initiate the process as required by the Bylaws Consultation Process.</p><div _ngcontent-ng-c2837300113="" id="section2.b.rationale"><!----><!----><h4 _ngcontent-ng-c2837300113=""><span _ngcontent-ng-c2837300113="">Rationale for Resolutions 2024.07.29.07 – 2024.07.29.08</span><a _ngcontent-ng-c2837300113=""></a><!----><!----></h4><!----><!----><!----><p><a href="https://www.icann.org/resources/pages/governance/bylaws-en/#article12">Article 12, Section 12.2(a)(ix)</a> of the ICANN Bylaws permits the GAC to "put issues to the Board directly, either by way of comment or prior advice, or by way of specifically recommending action or new policy development or revision to existing policies." In its ICANN80 Kigali Communiqué (17 June 2024), the GAC issued advice to the Board regarding the Applicant Support Program (ASP) and Auctions: Mechanisms of Last Resort/Private Resolution of Contention Sets in New gTLDs. The GAC also provided a follow-up to previous advice regarding the Applicant Support Program and Urgent Requests for Disclosure of Registration Data. Article 12, Section 12.2(a)(x) of the ICANN Bylaws states that the</p>
<blockquote>
<p>advice of the Governmental Advisory Committee on public policy matters shall be duly taken into account, both in the formulation and adoption of policies. In the event that the Board determines to take an action that is not consistent with Governmental Advisory Committee advice, it shall so inform the Governmental Advisory Committee and state the reasons why it decided not to follow that advice. Any Governmental Advisory Committee advice approved by a full Governmental Advisory Committee consensus, understood to mean the practice of adopting decisions by general agreement in the absence of any formal objection ("GAC Consensus Advice"), may only be rejected by a vote of no less than 60% of the Board, and the Governmental Advisory Committee and the Board will then try, in good faith and in a timely and efficient manner, to find a mutually acceptable solution. The Governmental Advisory Committee will state whether any advice it gives to the Board is GAC Consensus Advice.</p>
</blockquote>
<p>The ICANN Bylaws require the Board to take into account the GAC's advice on public policy matters in the formulation and adoption of policies. At this time, the Board's current thinking and approach to implementing SubPro recommendations related Topic 17 and GNSO Guidance Process Recommendations concerning the Applicant Support Program is inconsistent or could be viewed as inconsistent with item 1.a.i and 1.a.ii of the GAC's advice in the ICANN80 Kigali Communiqué. Regarding item 1.a.i, the Board notes concerns that changes to the processing and evaluation of ASP applications at this stage may reduce the time supported applicants will have to access resources, would not solve the challenge of how to decide which applicants receive support over others, and may delay the opening of the New gTLD Program: Next Round. Regarding item 1.a.ii, the Board notes concerns that implementing this advice may substantially increase the risk of conflict of interest and legal challenges over the evaluation and related decision-making of ASP applications. Furthermore, the Board notes that ICANN org is conducting a Request-for-Proposal (RFP) process to contract an independent Standing Application Review Panel (SARP) and that changes to this established plan and approach may delay the launch of the ASP. The Board is taking action today on the GAC Consensus Advice to the ICANN Board in the ICANN80 Kigali Communiqué, including the items related to the ASP and Auctions: Mechanisms of Last Resort/Private Resolution of Contention Sets in New gTLDs as described in the <a href="https://www.icann.org/en/system/files/files/scorecard-gac-advice-kigali-communique-board-action-29jul24-en.pdf">scorecard</a> dated 29 July 2024. This decision is in the public interest and within ICANN's mission, as it is fully consistent with ICANN's Bylaws for considering and acting on advice issued by the GAC.</p>
<p>In adopting its response to the GAC advice in the ICANN80 Kigali Communiqué, the Board reviewed various materials, including, but not limited to, the following materials and documents:</p>
<ul>
<li>ICANN80 Kigali Communiqué (17 June 2024): <a href="https://gac.icann.org/advice/communiques/ICANN80%20GAC%20Communique-zh.pdf">https://gac.icann.org/advice/communiques/ICANN80%20GAC%20Communique-zh.pdf</a></li>
<li>GAC Response to ICANN80 Kigali GAC Communiqué and Initial Feedback for Consideration (08 July 2024): <a href="https://gac.icann.org/contentMigrated/gac-response-to-icann80-kigali-gac-communique-and-initial-feedback-for-consideration">https://gac.icann.org/contentMigrated/gac-response-to-icann80-kigali-gac-communique-and-initial-feedback-for-consideration</a></li>
<li>The GNSO Council's review of the advice in the ICANN80 Kigali Communiqué as presented in the 12 July 2024 letter to the Board: <a href="https://gnso.icann.org/sites/default/files/policy/2024/correspondence/dibiase-to-sinha-12jul24-en.pdf">https://gnso.icann.org/sites/default/files/policy/2024/correspondence/dibiase-to-sinha-12jul24-en.pdf</a></li>
</ul>
<p>The adoption of the <a href="https://www.icann.org/en/system/files/files/scorecard-gac-advice-kigali-communique-board-action-29jul24-en.pdf">GAC scorecard</a> will have a positive impact on the community because it will assist with resolving the advice from the GAC concerning gTLDs and other matters. There are no foreseen fiscal impacts associated with the adoption of this resolution. Approval of the resolution will not impact security, stability or resiliency issues relating to the DNS. This is an Organizational Administrative function that does not require public comment.</p><!----><!----></div><!----><!----></div><div _ngcontent-ng-c2837300113="" id="section2.c"><!----><h3 _ngcontent-ng-c2837300113=""><span _ngcontent-ng-c2837300113="">c. Re-initiation of Fundamental Bylaws Amendment on Accountability Mechanisms</span><a _ngcontent-ng-c2837300113=""></a><!----><!----></h3><!----><!----><!----><!----><p>Whereas, the ICANN community, through the Cross Community Working Group on New gTLD Auction Proceeds (CCWG-AP), made a recommendation that utilization of ICANN's Reconsideration and Independent Review processes (collectively, ICANN Accountability Mechanisms) should be limited in certain circumstances (Recommendation 7). During ICANN organization's (ICANN org) work to implement the ICANN Grant Program aligned with the CCWG-AP's full set of recommendations, Recommendation 7 posed a unique challenge, as the CCWG-AP's language was too narrow based on the implementation design.</p>
<p>Whereas, the ICANN Board has taken a series of actions and communications to move forward with the ICANN Grant Program while trying to address the issues presented by the original language of Recommendation 7, including:</p>
<ul>
<li>26 October 2023 resolutions revisiting the Board's prior approval of Recommendation 7 and directing the development of a more general process for the ICANN community to indicate when ICANN's Accountability Mechanisms should not be available;</li>
<li><a href="https://www.icann.org/en/system/files/correspondence/sinha-to-clemente-et-al-02mar24-en.pdf">2 March 2024 letter</a> to the CCWG-AP's Chartering Organizations specifying a proposed change to Recommendation 7 to remove a reference to the "Independent Application Assessment Panel" so that Recommendation 7 could better achieve its goal of preserving auction proceeds for grants instead of funding challenges to decisions on grant applications; and</li>
<li><a href="https://www.icann.org/en/board-activities-and-meetings/materials/approved-resolutions-regular-meeting-of-the-icann-board-21-01-2024-en#section2.d">21 January 2024 initiation</a> of a Fundamental Bylaws amendment process setting forth the general process for the ICANN community to limit access to ICANN's Accountability Mechanisms.</li>
</ul>
<p>Whereas, ICANN received <a href="https://www.icann.org/en/public-comment/proceeding/proposed-bylaws-updates-to-limit-access-to-accountability-mechanisms-27-02-2024">Public Comment</a> on the proposal for a general process on limitation of access to ICANN Accountability Mechanisms, and the community was <a href="https://itp.cdn.icann.org/en/files/governance/public-comment-summary-report-proposed-bylaws-updates-limit-access-accountability-mechanisms-02-07-2024-en.pdf" data-linktype="fileRedirectUrl">not supportive</a> of that proposal. Multiple commenters urged ICANN to present a Fundamental Bylaws amendment drafted to specifically implement the anticipated update to Recommendation 7 as set forth in the Board's <a href="https://www.icann.org/en/system/files/correspondence/sinha-to-clemente-et-al-02mar24-en.pdf">March 2024 letter</a>.</p>
<p>Whereas, in response to the outreach to the Chartering Organizations of the CCWG-AP on a proposal to update Recommendation 7, many of the Chartering Organizations to the CCWG-AP have already indicated their support or non-objection. One Chartering Organization still seeks further information about the relationship between the updating of Recommendation 7 and the amendment of the ICANN Bylaws.</p>
<p>Whereas, in response to the ICANN community's comments and input, the updated Fundamental Bylaws amendment now under consideration will, if approved, amend the ICANN Reconsideration process (at ICANN Bylaws, Article 4, Section 4.2) and the Independent Review process (at ICANN Bylaws, Article 4, Section 4.3) to specifically exclude claims or disputes "relating to decisions to approve or not approve an application to the ICANN Grant Program" from each of the relevant mechanisms.</p>
<p>Whereas, the Board will not be in a position to approve the Fundamental Bylaws amendments unless and until it has adopted an updated Recommendation 7 from the CCWG-AP.</p>
<p>Resolved (2024.07.29.09), the ICANN Board directs the ICANN Interim President and CEO, or her designee(s), to re-initiate a Fundamental Bylaws Amendment Process under Article 25, Section 25.2 of the ICANN Bylaws, through the posting of the proposed amendments to Article 4, Section 4.2(d) and Section 4.3(c) of the Bylaws for public comment. The ICANN Board confirms that it is no longer pursuing the previously posted amendment to Article 4, Section 4.1 of the Bylaws.</p><div _ngcontent-ng-c2837300113="" id="section2.c.rationale"><!----><!----><h4 _ngcontent-ng-c2837300113=""><span _ngcontent-ng-c2837300113="">Rationale for Resolution 2024.07.29.09</span><a _ngcontent-ng-c2837300113=""></a><!----><!----></h4><!----><!----><!----><p>The Fundamental Bylaws amendment process initiated today is not a decision on the Bylaws language. It is instead the clearance for posting for public comment the proposed amendments to Article 4, Section 4.2(d) (Reconsideration) and 4.3(c) (Independent Review) that will specifically exclude the ICANN Accountability Mechanisms from being available for challenges to decisions to approve or not approve an application to the ICANN Grant Program.</p>
<p>The Cross-Community Working Group on New gTLD Auction Proceeds '(CCWG-AP) Final Report included Recommendation 7, which states in relevant part "Existing ICANN accountability mechanisms such as IRP or other appeal mechanisms cannot be used to challenge a decision from the Independent Project Applications Evaluation Panel to approve or not approve an application. Applicants not selected should receive further details about where information can be found about the next round of applications as well as any educational materials that may be available to assist applicants. The CCWG recognizes that there will need to be an amendment to the Fundamental Bylaws to eliminate the opportunity to use the Request for Reconsideration and Independent Review Panel to challenge grant decisions." Though the Board previously accepted Recommendation 7 on 12 June 2022, on 23 October 2023, the Board revisited that action because of implementation challenges that arose during the design of the ICANN Grant Program. The Board explained:</p>
<blockquote>
<p>In order to account for the design work that has progressed since the Board's June 2022 action which defines different stages of assessment of individual applications, from admissibility to eligibility to substantive evaluation by an Independent Application Assessment Panel, the Board expects the limitation to restrict access to ICANN's accountability mechanisms for all decisions on those individual applications, not limited only to those made by the Independent Application Assessment Panel (as stated within the CCWG-AP recommendation). Anything short of this comprehensive view makes it possible that some applicants could have access to ICANN's accountability mechanisms for decisions on their individual applications as long as that action wasn't taken by the Independent Application Assessment Panel. If allowed, this uneven access to the accountability mechanisms still risks the use of auction proceeds to defend against accountability challenges on individual application decisions in a manner the CCWG-AP wished to protect against.</p>
</blockquote>
<p>The Board, considering alternative means to achieve the CCWG-AP's stated goal, asked ICANN org to produce a more general Bylaws amendment that would provide a process through which the ICANN community could signal its intent to limit the use of ICANN's Accountability Mechanisms. A draft Bylaws amendment to Article 4, Section 4.1, drafted to support this more general approach was posted for Public Comment in April 2024. The comments received in that forum confirmed the ICANN community was not satisfied with and did not support the general process approach.</p>
<p>The ICANN Board also, in March 2024, sent a letter to the Chartering Organizations to the CCWG-AP explaining that an update to the CCWG-AP's Recommendation 7 to remove the words "from the Independent Project Applications Evaluation Panel" would cure much of the Board's concerns in supporting full implementation of the CCWG-AP's Recommendation 7. That letter confirmed that there are two dependencies to the Board approving the distribution of any grants within the ICANN Grant Program: (1) updating Recommendation 7 and (2) amending the Bylaws to confirm the restriction access to ICANN's Accountability Mechanisms. To date, ICANN has heard back from all Chartering Organizations, with all but one stating either support or non-objection to proceeding with the updated text. The seventh Chartering Organization noted a need for further clarification of how the Board would resolve the issue of the disfavored Bylaws proposal as posted for comment in April.</p>
<p>Today's action makes clear that the Board has heard the community's dissatisfaction with the proposal posted for public comment in April 2024. Multiple commenters to the April Public Comment forum suggested that the preferred path would be for ICANN to pursue a Fundamental Bylaws amendment that specifically excluded decisions on individual applications from the reach of each of ICANN's Accountability Mechanisms. That is exactly the option that the Board is moving forward today. As both the Reconsideration and Independent Review processes already enumerate excluded topics for claims or disputes, the proposed amendment set forth today adds to each of those exclusions, relying on language as likely to be approved within an updated Recommendation 7 ("cannot be used to challenge a decision to approve or not approve an application").</p>
<p>This is a further procedural step necessary to meet the community's conversation on the Fundamental Bylaws amendment process. The Board is not taking any substantive action today on the ICANN Grant Program, as such a decision on updating Recommendation 7 still requires further input from the ICANN community.</p>
<p>The ICANN Board looks forward to the community discussion over these proposed changes.</p>
<p>Today's action is directly related to how the ICANN community may hold ICANN accountable to its mission and work. It is in the public interest, and is aligned with ICANN's Bylaws, to seek public comment on changes to ICANN's Bylaws and the ICANN Accountability Mechanisms defined therein.</p>
<p>Initiating the Fundamental Bylaws Amendment process is not anticipated to result in any impact to the security, stability or resiliency of the Internet's DNS. Nor is this action anticipated to result in any budgetary or financial implications.</p>
<p>This is an Organizational Administrative Function decision requiring public comment.</p><!----><!----></div><!----><!----></div><!----><!----></div><div _ngcontent-ng-c2837300113="" id="section3"><h2 _ngcontent-ng-c2837300113=""><span _ngcontent-ng-c2837300113="">3. Executive Session</span><a _ngcontent-ng-c2837300113=""></a><!----><!----></h2><!----><!----><!----><!----><!----><div _ngcontent-ng-c2837300113="" id="section3.a"><!----><h3 _ngcontent-ng-c2837300113=""><span _ngcontent-ng-c2837300113="">a. Interim President and CEO At-Risk Compensation for Second Half of FY24</span><a _ngcontent-ng-c2837300113=""></a><!----><!----></h3><!----><!----><!----><!----><p>Whereas, all Board members have confirmed that they do not have a conflict of interest with respect to establishing the amount of payment to the Interim President and CEO for the second half of FY24 at-risk compensation component.</p>
<p>Whereas, the Compensation Committee recommended that the Board approve payment to the Interim President and CEO her annual at-risk compensation component for the second half of FY24.</p>
<p>Resolved (2024.07.29.10), the Board hereby approves a payment to the Interim President and CEO for her annual at-risk compensation component for the second half of FY24.</p>
<p>Resolved (2024.07.29.11), specific items within this resolution shall remain confidential as an action "relating to personnel or employment matters", pursuant to Article 3, section 3.5.b of the ICANN Bylaws.</p><div _ngcontent-ng-c2837300113="" id="section3.a.rationale"><!----><!----><h4 _ngcontent-ng-c2837300113=""><span _ngcontent-ng-c2837300113="">Rationale for Resolutions 2024.07.29.10 – 2024.07.29.11</span><a _ngcontent-ng-c2837300113=""></a><!----><!----></h4><!----><!----><!----><p>When the Interim President and CEO was engaged, both in her role as Special Advisor to the President and SVP Global Stakeholder Engagement, and again as Interim President and CEO, she was offered a base salary, plus an at-risk component of her compensation package. Consistent with all personnel with the ICANN organization, the Interim President and CEO is to be evaluated against specific goals, which the Interim President and CEO established in coordination with the Compensation Committee, which were previously approved by the Board.</p>
<p>The Interim President and CEO provided to the Compensation Committee her assessment of the progress toward her FY24 goals. The Compensation Committee discussed and agreed that the Interim President and CEO should be awarded her at-risk compensation for the second half of FY24 and recommended that the Board approve such payment to the Interim President and CEO. The Board agrees with the Compensation Committee's recommendation.</p>
<p>Taking this decision is in furtherance of ICANN's Mission and is in the public interest in that it helps ensure that Interim President and CEO is sufficiently compensated in line with her performance in furtherance of the Mission, and which reflects that her goals are consistent with ICANN's Strategic and Operating plans.</p>
<p>While the decision to pay the Interim President and CEO her at-risk compensation for the second half of FY24 will have a fiscal impact on ICANN, it is an impact that was contemplated in the FY24 budget. This decision will not have an impact on the security, stability or resiliency of the domain name system.</p>
<p>This is an Organizational Administrative Function that does not require public comment.</p><!----><!----></div><!----><!----></div><!----><!----></div><!----><!----></iti-fragment-container></iti-sectioned-page><p> Published on 31 July 2024 </p><!----><!----><iti-link-callout-container _ngcontent-ng-c3323332204="" _nghost-ng-c3766845712=""><iti-callout-container _ngcontent-ng-c3766845712="" _nghost-ng-c2288160836=""></iti-callout-container></iti-link-callout-container><!----></section></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Show HN: LLM Aided OCR (Correcting Tesseract OCR Errors with LLMs) (292 pts)]]></title>
            <link>https://github.com/Dicklesworthstone/llm_aided_ocr</link>
            <guid>41203306</guid>
            <pubDate>Fri, 09 Aug 2024 16:28:39 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://github.com/Dicklesworthstone/llm_aided_ocr">https://github.com/Dicklesworthstone/llm_aided_ocr</a>, See on <a href="https://news.ycombinator.com/item?id=41203306">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text"><p dir="auto"><h2 tabindex="-1" dir="auto">LLM-Aided OCR Project</h2><a id="user-content-llm-aided-ocr-project" aria-label="Permalink: LLM-Aided OCR Project" href="#llm-aided-ocr-project"></a></p>
<p dir="auto"><h2 tabindex="-1" dir="auto">Introduction</h2><a id="user-content-introduction" aria-label="Permalink: Introduction" href="#introduction"></a></p>
<p dir="auto">The LLM-Aided OCR Project is an advanced system designed to significantly enhance the quality of Optical Character Recognition (OCR) output. By leveraging cutting-edge natural language processing techniques and large language models (LLMs), this project transforms raw OCR text into highly accurate, well-formatted, and readable documents.</p>
<p dir="auto"><h2 tabindex="-1" dir="auto">Example Outputs</h2><a id="user-content-example-outputs" aria-label="Permalink: Example Outputs" href="#example-outputs"></a></p>
<p dir="auto">To see what the LLM-Aided OCR Project can do, check out these example outputs:</p>
<ul dir="auto">
<li><a href="https://github.com/Dicklesworthstone/llm_aided_ocr/blob/main/160301289-Warren-Buffett-Katharine-Graham-Letter.pdf">Original PDF</a></li>
<li><a href="https://github.com/Dicklesworthstone/llm_aided_ocr/blob/main/160301289-Warren-Buffett-Katharine-Graham-Letter__raw_ocr_output.txt">Raw OCR Output</a></li>
<li><a href="https://github.com/Dicklesworthstone/llm_aided_ocr/blob/main/160301289-Warren-Buffett-Katharine-Graham-Letter_llm_corrected.md">LLM-Corrected Markdown Output</a></li>
</ul>
<p dir="auto"><h2 tabindex="-1" dir="auto">Features</h2><a id="user-content-features" aria-label="Permalink: Features" href="#features"></a></p>
<ul dir="auto">
<li>PDF to image conversion</li>
<li>OCR using Tesseract</li>
<li>Advanced error correction using LLMs (local or API-based)</li>
<li>Smart text chunking for efficient processing</li>
<li>Markdown formatting option</li>
<li>Header and page number suppression (optional)</li>
<li>Quality assessment of the final output</li>
<li>Support for both local LLMs and cloud-based API providers (OpenAI, Anthropic)</li>
<li>Asynchronous processing for improved performance</li>
<li>Detailed logging for process tracking and debugging</li>
<li>GPU acceleration for local LLM inference</li>
</ul>
<p dir="auto"><h2 tabindex="-1" dir="auto">Detailed Technical Overview</h2><a id="user-content-detailed-technical-overview" aria-label="Permalink: Detailed Technical Overview" href="#detailed-technical-overview"></a></p>
<p dir="auto"><h3 tabindex="-1" dir="auto">PDF Processing and OCR</h3><a id="user-content-pdf-processing-and-ocr" aria-label="Permalink: PDF Processing and OCR" href="#pdf-processing-and-ocr"></a></p>
<ol dir="auto">
<li>
<p dir="auto"><strong>PDF to Image Conversion</strong></p>
<ul dir="auto">
<li>Function: <code>convert_pdf_to_images()</code></li>
<li>Uses <code>pdf2image</code> library to convert PDF pages into images</li>
<li>Supports processing a subset of pages with <code>max_pages</code> and <code>skip_first_n_pages</code> parameters</li>
</ul>
</li>
<li>
<p dir="auto"><strong>OCR Processing</strong></p>
<ul dir="auto">
<li>Function: <code>ocr_image()</code></li>
<li>Utilizes <code>pytesseract</code> for text extraction</li>
<li>Includes image preprocessing with <code>preprocess_image()</code> function:
<ul dir="auto">
<li>Converts image to grayscale</li>
<li>Applies binary thresholding using Otsu's method</li>
<li>Performs dilation to enhance text clarity</li>
</ul>
</li>
</ul>
</li>
</ol>
<p dir="auto"><h3 tabindex="-1" dir="auto">Text Processing Pipeline</h3><a id="user-content-text-processing-pipeline" aria-label="Permalink: Text Processing Pipeline" href="#text-processing-pipeline"></a></p>
<ol dir="auto">
<li>
<p dir="auto"><strong>Chunk Creation</strong></p>
<ul dir="auto">
<li>The <code>process_document()</code> function splits the full text into manageable chunks</li>
<li>Uses sentence boundaries for natural splits</li>
<li>Implements an overlap between chunks to maintain context</li>
</ul>
</li>
<li>
<p dir="auto"><strong>Error Correction and Formatting</strong></p>
<ul dir="auto">
<li>Core function: <code>process_chunk()</code></li>
<li>Two-step process:
a. OCR Correction:
<ul dir="auto">
<li>Uses LLM to fix OCR-induced errors</li>
<li>Maintains original structure and content
b. Markdown Formatting (optional):</li>
<li>Converts text to proper markdown format</li>
<li>Handles headings, lists, emphasis, and more</li>
</ul>
</li>
</ul>
</li>
<li>
<p dir="auto"><strong>Duplicate Content Removal</strong></p>
<ul dir="auto">
<li>Implemented within the markdown formatting step</li>
<li>Identifies and removes exact or near-exact repeated paragraphs</li>
<li>Preserves unique content and ensures text flow</li>
</ul>
</li>
<li>
<p dir="auto"><strong>Header and Page Number Suppression (Optional)</strong></p>
<ul dir="auto">
<li>Can be configured to remove or distinctly format headers, footers, and page numbers</li>
</ul>
</li>
</ol>
<p dir="auto"><h3 tabindex="-1" dir="auto">LLM Integration</h3><a id="user-content-llm-integration" aria-label="Permalink: LLM Integration" href="#llm-integration"></a></p>
<ol dir="auto">
<li>
<p dir="auto"><strong>Flexible LLM Support</strong></p>
<ul dir="auto">
<li>Supports both local LLMs and cloud-based API providers (OpenAI, Anthropic)</li>
<li>Configurable through environment variables</li>
</ul>
</li>
<li>
<p dir="auto"><strong>Local LLM Handling</strong></p>
<ul dir="auto">
<li>Function: <code>generate_completion_from_local_llm()</code></li>
<li>Uses <code>llama_cpp</code> library for local LLM inference</li>
<li>Supports custom grammars for structured output</li>
</ul>
</li>
<li>
<p dir="auto"><strong>API-based LLM Handling</strong></p>
<ul dir="auto">
<li>Functions: <code>generate_completion_from_claude()</code> and <code>generate_completion_from_openai()</code></li>
<li>Implements proper error handling and retry logic</li>
<li>Manages token limits and adjusts request sizes dynamically</li>
</ul>
</li>
<li>
<p dir="auto"><strong>Asynchronous Processing</strong></p>
<ul dir="auto">
<li>Uses <code>asyncio</code> for concurrent processing of chunks when using API-based LLMs</li>
<li>Maintains order of processed chunks for coherent final output</li>
</ul>
</li>
</ol>
<p dir="auto"><h3 tabindex="-1" dir="auto">Token Management</h3><a id="user-content-token-management" aria-label="Permalink: Token Management" href="#token-management"></a></p>
<ol dir="auto">
<li>
<p dir="auto"><strong>Token Estimation</strong></p>
<ul dir="auto">
<li>Function: <code>estimate_tokens()</code></li>
<li>Uses model-specific tokenizers when available</li>
<li>Falls back to <code>approximate_tokens()</code> for quick estimation</li>
</ul>
</li>
<li>
<p dir="auto"><strong>Dynamic Token Adjustment</strong></p>
<ul dir="auto">
<li>Adjusts <code>max_tokens</code> parameter based on prompt length and model limits</li>
<li>Implements <code>TOKEN_BUFFER</code> and <code>TOKEN_CUSHION</code> for safe token management</li>
</ul>
</li>
</ol>
<p dir="auto"><h3 tabindex="-1" dir="auto">Quality Assessment</h3><a id="user-content-quality-assessment" aria-label="Permalink: Quality Assessment" href="#quality-assessment"></a></p>
<ol dir="auto">
<li><strong>Output Quality Evaluation</strong>
<ul dir="auto">
<li>Function: <code>assess_output_quality()</code></li>
<li>Compares original OCR text with processed output</li>
<li>Uses LLM to provide a quality score and explanation</li>
</ul>
</li>
</ol>
<p dir="auto"><h3 tabindex="-1" dir="auto">Logging and Error Handling</h3><a id="user-content-logging-and-error-handling" aria-label="Permalink: Logging and Error Handling" href="#logging-and-error-handling"></a></p>
<ul dir="auto">
<li>Comprehensive logging throughout the codebase</li>
<li>Detailed error messages and stack traces for debugging</li>
<li>Suppresses HTTP request logs to reduce noise</li>
</ul>
<p dir="auto"><h2 tabindex="-1" dir="auto">Configuration and Customization</h2><a id="user-content-configuration-and-customization" aria-label="Permalink: Configuration and Customization" href="#configuration-and-customization"></a></p>
<p dir="auto">The project uses a <code>.env</code> file for easy configuration. Key settings include:</p>
<ul dir="auto">
<li>LLM selection (local or API-based)</li>
<li>API provider selection</li>
<li>Model selection for different providers</li>
<li>Token limits and buffer sizes</li>
<li>Markdown formatting options</li>
</ul>
<p dir="auto"><h2 tabindex="-1" dir="auto">Output and File Handling</h2><a id="user-content-output-and-file-handling" aria-label="Permalink: Output and File Handling" href="#output-and-file-handling"></a></p>
<ol dir="auto">
<li><strong>Raw OCR Output</strong>: Saved as <code>{base_name}__raw_ocr_output.txt</code></li>
<li><strong>LLM Corrected Output</strong>: Saved as <code>{base_name}_llm_corrected.md</code> or <code>.txt</code></li>
</ol>
<p dir="auto">The script generates detailed logs of the entire process, including timing information and quality assessments.</p>
<p dir="auto"><h2 tabindex="-1" dir="auto">Requirements</h2><a id="user-content-requirements" aria-label="Permalink: Requirements" href="#requirements"></a></p>
<ul dir="auto">
<li>Python 3.12+</li>
<li>Tesseract OCR engine</li>
<li>PDF2Image library</li>
<li>PyTesseract</li>
<li>OpenAI API (optional)</li>
<li>Anthropic API (optional)</li>
<li>Local LLM support (optional, requires compatible GGUF model)</li>
</ul>
<p dir="auto"><h2 tabindex="-1" dir="auto">Installation</h2><a id="user-content-installation" aria-label="Permalink: Installation" href="#installation"></a></p>
<ol dir="auto">
<li>Install Pyenv and Python 3.12 (if needed):</li>
</ol>
<div dir="auto" data-snippet-clipboard-copy-content="# Install Pyenv and python 3.12 if needed and then use it to create venv:
if ! command -v pyenv &amp;> /dev/null; then
    sudo apt-get update
    sudo apt-get install -y build-essential libssl-dev zlib1g-dev libbz2-dev \
    libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev libncursesw5-dev \
    xz-utils tk-dev libffi-dev liblzma-dev python3-openssl git

    git clone https://github.com/pyenv/pyenv.git ~/.pyenv
    echo 'export PYENV_ROOT=&quot;$HOME/.pyenv&quot;' >> ~/.zshrc
    echo 'export PATH=&quot;$PYENV_ROOT/bin:$PATH&quot;' >> ~/.zshrc
    echo 'eval &quot;$(pyenv init --path)&quot;' >> ~/.zshrc
    source ~/.zshrc
fi
cd ~/.pyenv &amp;&amp; git pull &amp;&amp; cd -
pyenv install 3.12"><pre><span><span>#</span> Install Pyenv and python 3.12 if needed and then use it to create venv:</span>
<span>if</span> <span>!</span> <span>command</span> -v pyenv <span>&amp;</span><span>&gt;</span> /dev/null<span>;</span> <span>then</span>
    sudo apt-get update
    sudo apt-get install -y build-essential libssl-dev zlib1g-dev libbz2-dev \
    libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev libncursesw5-dev \
    xz-utils tk-dev libffi-dev liblzma-dev python3-openssl git

    git clone https://github.com/pyenv/pyenv.git <span>~</span>/.pyenv
    <span>echo</span> <span><span>'</span>export PYENV_ROOT="$HOME/.pyenv"<span>'</span></span> <span>&gt;&gt;</span> <span>~</span>/.zshrc
    <span>echo</span> <span><span>'</span>export PATH="$PYENV_ROOT/bin:$PATH"<span>'</span></span> <span>&gt;&gt;</span> <span>~</span>/.zshrc
    <span>echo</span> <span><span>'</span>eval "$(pyenv init --path)"<span>'</span></span> <span>&gt;&gt;</span> <span>~</span>/.zshrc
    <span>source</span> <span>~</span>/.zshrc
<span>fi</span>
<span>cd</span> <span>~</span>/.pyenv <span>&amp;&amp;</span> git pull <span>&amp;&amp;</span> <span>cd</span> -
pyenv install 3.12</pre></div>
<ol start="2" dir="auto">
<li>Set up the project:</li>
</ol>
<div dir="auto" data-snippet-clipboard-copy-content="# Use pyenv to create virtual environment:
git clone https://github.com/Dicklesworthstone/llm_aided_ocr    
cd llm_aided_ocr          
pyenv local 3.12
python -m venv venv
source venv/bin/activate
python -m pip install --upgrade pip
python -m pip install wheel
python -m pip install --upgrade setuptools wheel
pip install -r requirements.txt"><pre><span><span>#</span> Use pyenv to create virtual environment:</span>
git clone https://github.com/Dicklesworthstone/llm_aided_ocr    
<span>cd</span> llm_aided_ocr          
pyenv <span>local</span> 3.12
python -m venv venv
<span>source</span> venv/bin/activate
python -m pip install --upgrade pip
python -m pip install wheel
python -m pip install --upgrade setuptools wheel
pip install -r requirements.txt</pre></div>
<ol start="3" dir="auto">
<li>
<p dir="auto">Install Tesseract OCR engine (if not already installed):</p>
<ul dir="auto">
<li>For Ubuntu: <code>sudo apt-get install tesseract-ocr</code></li>
<li>For macOS: <code>brew install tesseract</code></li>
<li>For Windows: Download and install from <a href="https://github.com/UB-Mannheim/tesseract/wiki">GitHub</a></li>
</ul>
</li>
<li>
<p dir="auto">Set up your environment variables in a <code>.env</code> file:</p>
<div data-snippet-clipboard-copy-content="USE_LOCAL_LLM=False
API_PROVIDER=OPENAI
OPENAI_API_KEY=your_openai_api_key
ANTHROPIC_API_KEY=your_anthropic_api_key"><pre><code>USE_LOCAL_LLM=False
API_PROVIDER=OPENAI
OPENAI_API_KEY=your_openai_api_key
ANTHROPIC_API_KEY=your_anthropic_api_key
</code></pre></div>
</li>
</ol>
<p dir="auto"><h2 tabindex="-1" dir="auto">Usage</h2><a id="user-content-usage" aria-label="Permalink: Usage" href="#usage"></a></p>
<ol dir="auto">
<li>
<p dir="auto">Place your PDF file in the project directory.</p>
</li>
<li>
<p dir="auto">Update the <code>input_pdf_file_path</code> variable in the <code>main()</code> function with your PDF filename.</p>
</li>
<li>
<p dir="auto">Run the script:</p>

</li>
<li>
<p dir="auto">The script will generate several output files, including the final post-processed text.</p>
</li>
</ol>
<p dir="auto"><h2 tabindex="-1" dir="auto">How It Works</h2><a id="user-content-how-it-works" aria-label="Permalink: How It Works" href="#how-it-works"></a></p>
<p dir="auto">The LLM-Aided OCR project employs a multi-step process to transform raw OCR output into high-quality, readable text:</p>
<ol dir="auto">
<li>
<p dir="auto"><strong>PDF Conversion</strong>: Converts input PDF into images using <code>pdf2image</code>.</p>
</li>
<li>
<p dir="auto"><strong>OCR</strong>: Applies Tesseract OCR to extract text from images.</p>
</li>
<li>
<p dir="auto"><strong>Text Chunking</strong>: Splits the raw OCR output into manageable chunks for processing.</p>
</li>
<li>
<p dir="auto"><strong>Error Correction</strong>: Each chunk undergoes LLM-based processing to correct OCR errors and improve readability.</p>
</li>
<li>
<p dir="auto"><strong>Markdown Formatting</strong> (Optional): Reformats the corrected text into clean, consistent Markdown.</p>
</li>
<li>
<p dir="auto"><strong>Quality Assessment</strong>: An LLM-based evaluation compares the final output quality to the original OCR text.</p>
</li>
</ol>
<p dir="auto"><h2 tabindex="-1" dir="auto">Code Optimization</h2><a id="user-content-code-optimization" aria-label="Permalink: Code Optimization" href="#code-optimization"></a></p>
<ul dir="auto">
<li><strong>Concurrent Processing</strong>: When using API-based models, chunks are processed concurrently to improve speed.</li>
<li><strong>Context Preservation</strong>: Each chunk includes a small overlap with the previous chunk to maintain context.</li>
<li><strong>Adaptive Token Management</strong>: The system dynamically adjusts the number of tokens used for LLM requests based on input size and model constraints.</li>
</ul>
<p dir="auto"><h2 tabindex="-1" dir="auto">Configuration</h2><a id="user-content-configuration" aria-label="Permalink: Configuration" href="#configuration"></a></p>
<p dir="auto">The project uses a <code>.env</code> file for configuration. Key settings include:</p>
<ul dir="auto">
<li><code>USE_LOCAL_LLM</code>: Set to <code>True</code> to use a local LLM, <code>False</code> for API-based LLMs.</li>
<li><code>API_PROVIDER</code>: Choose between "OPENAI" or "CLAUDE".</li>
<li><code>OPENAI_API_KEY</code>, <code>ANTHROPIC_API_KEY</code>: API keys for respective services.</li>
<li><code>CLAUDE_MODEL_STRING</code>, <code>OPENAI_COMPLETION_MODEL</code>: Specify the model to use for each provider.</li>
<li><code>LOCAL_LLM_CONTEXT_SIZE_IN_TOKENS</code>: Set the context size for local LLMs.</li>
</ul>
<p dir="auto"><h2 tabindex="-1" dir="auto">Output Files</h2><a id="user-content-output-files" aria-label="Permalink: Output Files" href="#output-files"></a></p>
<p dir="auto">The script generates several output files:</p>
<ol dir="auto">
<li><code>{base_name}__raw_ocr_output.txt</code>: Raw OCR output from Tesseract.</li>
<li><code>{base_name}_llm_corrected.md</code>: Final LLM-corrected and formatted text.</li>
</ol>
<p dir="auto"><h2 tabindex="-1" dir="auto">Limitations and Future Improvements</h2><a id="user-content-limitations-and-future-improvements" aria-label="Permalink: Limitations and Future Improvements" href="#limitations-and-future-improvements"></a></p>
<ul dir="auto">
<li>The system's performance is heavily dependent on the quality of the LLM used.</li>
<li>Processing very large documents can be time-consuming and may require significant computational resources.</li>
</ul>
<p dir="auto"><h2 tabindex="-1" dir="auto">Contributing</h2><a id="user-content-contributing" aria-label="Permalink: Contributing" href="#contributing"></a></p>
<p dir="auto">Contributions to this project are welcome! Please fork the repository and submit a pull request with your proposed changes.</p>
<p dir="auto"><h2 tabindex="-1" dir="auto">License</h2><a id="user-content-license" aria-label="Permalink: License" href="#license"></a></p>
<p dir="auto">This project is licensed under the MIT License.</p>
</article></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Base 3 Computing Beats Binary (134 pts)]]></title>
            <link>https://www.quantamagazine.org/how-base-3-computing-beats-binary-20240809/</link>
            <guid>41201922</guid>
            <pubDate>Fri, 09 Aug 2024 14:01:19 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.quantamagazine.org/how-base-3-computing-beats-binary-20240809/">https://www.quantamagazine.org/how-base-3-computing-beats-binary-20240809/</a>, See on <a href="https://news.ycombinator.com/item?id=41201922">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><p>The hallmark feature of ternary notation is that it’s ruthlessly efficient. With two binary bits, you can represent four numbers. Two “trits” — each with three different states — allow you to represent nine different numbers. A number that requires 42 bits would need only 27 trits.</p>
<p>If a three-state system is so efficient, you might imagine that a four-state or five-state system would be even more so. But the more digits you require, the more space you’ll need. It turns out that ternary is the most economical of all possible integer bases for representing big numbers.</p>
<p>To see why, consider an important metric that tallies up how much room a system will need to store data. You start with the base of the number system, which is called the radix, and multiply it by the number of digits needed to represent some large number in that radix. For example, the number 100,000 in base 10 requires six digits. Its “radix economy” is therefore 10 × 6 = 60. In base 2, the same number requires 17 digits, so its radix economy is 2 × 17 = 34. And in base 3, it requires 11 digits, so its radix economy is 3 × 11 = 33. For large numbers, base 3 has a lower radix economy than any other integer base. (Surprisingly, if you allow a base to be any real number, and not just an integer, then the most efficient computational base is the irrational number <em>e</em>.)</p>
<p>In addition to its numerical efficiency, base 3 offers computational advantages. It suggests a way to reduce the number of queries needed to answer questions with more than two possible answers. A binary logic system can only answer “yes” or “no.” So if you’re comparing two numbers, <em>x</em> and <em>y</em>, to find out which is larger, you might first ask the computer “Is <em>x</em> less than <em>y</em>?” If the answer is no, you need a second query: “Is <em>x</em> equal to <em>y</em>?” If the answer is yes, then they’re equal; if the answer is no, then <em>y</em> is less than <em>x</em>.</p>
<p>A system using ternary logic can give one of three answers. Because of this, it requires only one query: “Is <em>x</em> less than, equal to, or greater than <em>y</em>?”</p>
<p>Despite its natural advantages, base 3 computing never took off, even though many mathematicians marveled at its efficiency. In 1840, an English printer, inventor, banker and self-taught mathematician named Thomas Fowler invented a ternary computing machine to calculate weighted values of taxes and interest. “After that, very little was done for years,” said <a href="https://mira.nau.edu/bertrand-cambou/">Bertrand Cambou</a>, an applied physicist at Northern Arizona University.</p>
<p>In 1950, at the dawn of the digital age, a <a href="http://bitsavers.trailing-edge.com/pdf/era/High_Speed_Computing_Devices_1950.pdf">book-length report</a> on the computing technology of the time suggested a computing advantage for ternary. And in the fall of 1958, visitors to the Soviet Union reported that engineers there had been developing a ternary computer called Setun — the first modern computer based on ternary logic and hardware. Soviet scientists <a href="https://www.computer-museum.ru/english/setun.htm">built</a> dozens of Setun computers.</p>

<p>Why didn’t ternary computing catch on? The primary reason was convention. Even though Soviet scientists were building ternary devices, the rest of the world focused on developing hardware and software based on switching circuits — the foundation of binary computing. Binary was easier to implement.</p>
<p>But the past few years have brought flashes of progress. Engineers have <a href="https://ieeexplore.ieee.org/document/9640614">proposed</a> ways to build ternary logical systems even on binary-based hardware. And Cambou, with the support of the U.S. military, has been developing cybersecurity systems that use base 3 computing. In papers published in <a href="https://in.nau.edu/wp-content/uploads/sites/223/2019/11/Ternary-Computing-to-Stengthen-Cybersecurity-Development-of-Ternary-State-based-Public-Key-Exchange.pdf">2018</a> and <a href="https://ieeexplore.ieee.org/document/8666511">2019</a>, he and his collaborators rigorously described a ternary-based system that could replace the existing public key infrastructure, which includes the digital keys needed to encrypt or decrypt cybercommunications. Switching from bits to trits, he said, significantly reduces the error rate, because ternary states better manage erratic information.</p>
<p><em>Schoolhouse Rock!</em> turned out to be prophetic. “The past and the present and the future,” the cartoon characters sang. “You get three as a magic number.”</p>
</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Jake Seliger has died (708 pts)]]></title>
            <link>https://marginalrevolution.com/marginalrevolution/2024/08/jake-seliger-is-dead.html</link>
            <guid>41201555</guid>
            <pubDate>Fri, 09 Aug 2024 13:19:03 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://marginalrevolution.com/marginalrevolution/2024/08/jake-seliger-is-dead.html">https://marginalrevolution.com/marginalrevolution/2024/08/jake-seliger-is-dead.html</a>, See on <a href="https://news.ycombinator.com/item?id=41201555">Hacker News</a></p>
Couldn't get https://marginalrevolution.com/marginalrevolution/2024/08/jake-seliger-is-dead.html: Error: Request failed with status code 403]]></description>
        </item>
        <item>
            <title><![CDATA[OTranscribe: A free and open tool for transcribing audio interviews (389 pts)]]></title>
            <link>https://otranscribe.com/</link>
            <guid>41199567</guid>
            <pubDate>Fri, 09 Aug 2024 07:31:15 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://otranscribe.com/">https://otranscribe.com/</a>, See on <a href="https://news.ycombinator.com/item?id=41199567">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="textbox" contenteditable="true">
        <p data-l10n-id="d-txt1">Enter your transcript here...</p>
        
        
        <p data-l10n-id="d-txt2">Protips:</p>
        
        <p data-l10n-id="d-txt3">- <em>Ctrl+I</em> adds <em>italic</em> formatting and <b>Ctrl+B</b> adds <b>bold</b> formatting.</p>
        <p data-l10n-id="d-txt4">- Press ESC to play/pause, and Ctrl+J to insert the current timestamp.</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Sonic Pi: Ruby as a Composition Tool (190 pts)]]></title>
            <link>https://bhmt.dev/blog/sonic_pi/</link>
            <guid>41198491</guid>
            <pubDate>Fri, 09 Aug 2024 03:08:48 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://bhmt.dev/blog/sonic_pi/">https://bhmt.dev/blog/sonic_pi/</a>, See on <a href="https://news.ycombinator.com/item?id=41198491">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
      <p>Like the blip of an intro on the front page says, my degree was originally in music. My running joke as a web dev is that neither has meaningfully required me to count past 32. And while my main concentration was vocals, I've since realized I should probably <em>stop</em> strictly calling this a nontechnical field, because my actual major was recording — even if I <em>did</em> primarily branch out into this for the sake of tracking my own material.</p>
<p>That last part fell off for a <em>few</em> reasons. First of all, I pretty quickly fell into tech work just by happenstance, and it happened to take. I also didn't have the space or resources or skillset to realistically amass a <em>lot</em> of different instruments. (Or other audio equipment.) I did pick up bass competently enough after a peer-pressure-induced lark, which happened to stick after picking up Scott Pilgrim (that was a joke... <a href="https://www.youtube.com/watch?v=RtDhGuEGgyc">it was FLCL</a>), and I picked up piano in the course of my major enough to passably self-accompany, but six-string guitars elude me about as much as consistently organizing with a group of other people who play things.</p>
<p>But I also mostly learned to <em>track</em> live instruments, and the small, disorganized experiments I took at electronic music never stuck. Something about a whole other set of overwhelm around picking synths up as <em>instruments,</em> I guess, even if I'm pretty familiar with audio workstations conceptually. But more recently, after a series of constraints that put all the instruments I <em>do</em> have into storage, I've taken a dive back into what was <em>also</em> one of my first attempts to learn how to code: <a href="https://sonic-pi.org/">Sonic Pi</a>. Ironically enough, as I've started making better sense of the language that underpins it, I've also started feeling some of my prior knowledge around audio engineering click in new and different ways.</p>
<p>Sonic Pi, created by Sam Aaron, is a <em>very</em> different beast from most audio applications: it's a software synth controlled entirely through code. It comes with its own control language (a <em>domain-specific language</em>, or DSL) that extends Ruby to map various music and audio concepts onto it. So for instance, you'll find note names as symbols, like <code>:c4</code>, corresponding to their equivalent MIDI codes. You'll find <code>chord</code> and <code>scale</code> constructors that take notes and chord/scale structures as arguments, such as <code>chord(:d3, :maj7)</code>. There's a <code>play</code> that's used in conjunction with Ruby's native <code>sleep</code> (sort of... more on that in a second), and a <code>play_pattern_timed</code> that abridges this for you by taking a list of notes and a time interval. (Quarter/half/etc notes are just plain numbers here, and hopefully don't require more explanation.)</p>
<p>The goal of this project was to track one demo. Compose one instrumental backing, purely by writing code, without the use of anything this this tool didn't come with out of the box. Because I could <em>use</em> MIDI, or external samples, but then I'm back to rabbit-holing about other audio tools.</p>
<p>I did accomplish this, but it's a little long for this piece, so for now let's do something simpler. (And a little less depressing. Besides, my mic was missing for a while during that same storage shuffle, so I never got around to tracking vocals for that anyway.)</p>
<p>If you install the app itself, you can follow along by copy-pasting the code below. (Note that for length I won't be repeating everything, so at points that I mention I'm reusing sections, or for persistent values like bpm or synth settings, just scroll up.) <em>Also</em> out of the box, you get a detailed set of documentation for the language as well as a series of tutorials.</p>
<pre><code><span># bpm defaults to 60, but we can change this</span>
<span># other time values will scale accordingly,</span>
<span># including the time interval going into `sleep`</span>
use_bpm <span>70</span>
  use_synth <span>:pulse</span> <span># this defaults to a sine wave</span>

play <span>:c2</span>
sleep <span>0.25</span>
play <span>:d2</span>
sleep <span>0.25</span>
play <span>:e2</span>
sleep <span>0.25</span>
play <span>:g2</span>
sleep <span>0.25</span>

<span># these are mostly equivalent, except that this</span>
<span>#  also sets a `sustain` of 0.25 to each note</span>
<span># (more on options in a second)</span>
play_pattern_timed [ <span>:c3</span>, <span>:d3</span>, <span>:e3</span>, <span>:g3</span> ], <span>0.25</span>
</code></pre>
<p>Of course, I can also just demonstrate the audio itself:</p>
<p>(Note: Some examples below won't be full blocks of code, or just don't demonstrate audible changes, so I won't be doing this for <em>all</em> of them.)</p>
<p>Since this is built on top of plain Ruby, we can abridge this, and make it more flexible so we're not repeating a lot of code.</p>
<p>We'll define the whole sequence here:</p>
<pre><code>
<span>def</span> <span>arpeggiate</span> <span>do</span> root, is_minor = <span>false</span>
  <span># ascending sequence</span>
  <span># repeat the same pattern,</span>
  <span>#  at different octaves</span>
  <span>4</span>.times <span>do</span>
    <span># modify the third based on the optional second argument</span>
    <span>#  we'll use this later</span>
    third = <span>4</span>
    third -= <span>1</span> <span>if</span> is_minor
    <span># Ruby supports trailing conditional statements. in addition to</span>
    <span>#  `if`, you can also check if the condition is *false*</span>
    <span>#  using `unless`</span>

    sequence = [ <span>0</span>, <span>2</span>, third, <span>7</span> ].map { |<span>note</span>| root + note }
    
    play_pattern_timed sequence, <span>0.25</span>

    <span># move the root of the sequence up one octave</span>
    root += <span>12</span>
  <span>end</span>

  <span># descending sequence</span>
  <span># the same pattern, in reverse</span>
  <span>4</span>.times <span>do</span>
    third = <span>8</span>
    third += <span>1</span> <span>if</span> is_minor
    
    sequence = [ <span>0</span>, <span>5</span>, third, <span>10</span> ].map { |<span>note</span>| root - note }

    play_pattern_timed sequence, <span>0.25</span>

    root -= <span>12</span>
  <span>end</span>
<span>end</span>

</code></pre>
<p>And we can then can run through this same pattern several times, at different starting points:</p>
<pre><code>in_thread <span>do</span>
  <span># define synth tones</span>
  <span># you can pass additional options into `play` </span>
  <span>#  or `play_pattern_timed` directly, but you </span>
  <span>#  can also set them as defaults up front</span>
  <span># (amp indicates volume level, but there are of course more)</span>
  use_synth <span>:pulse</span>
  use_synth_defaults <span>amp:</span> <span>0.1</span>

  <span>2</span>.times <span>do</span>
    <span># parentheses are optional for functions in Ruby</span>
    <span># `play 60` is the same as `play(60)`</span>
    <span># but in some cases you may need clearer separation</span>
    <span>#  like `play chord(:a3, maj7)`</span>
    arpeggiate(<span>:c3</span>)
    arpeggiate(<span>:a2</span>, <span>:min</span>)
  <span>end</span>

  arpeggiate(<span>:f2</span>)
  arpeggiate(<span>:g2</span>)
  arpeggiate(<span>:ab2</span>)
  arpeggiate(<span>:bb2</span>)
<span>end</span> 
</code></pre>
<p>You might be wondering about that <code>in_thread do</code> block.</p>
<p>Sonic Pi also uses loops to run code in parallel. So by wrapping the above in one, we can run two separate "instruments" in parallel.</p>
<p>We could <em>also</em>, say...</p>
<pre><code>
in_thread <span>do</span>
  <span># ...the block from earlier?</span>
<span>end</span>

in_thread <span>do</span>
  use_synth <span>:saw</span>
  use_synth_defaults <span>amp:</span> <span>0.2</span>

  melody = [
    <span>:c5</span>, <span>:b4</span>, <span>:d5</span>,
    <span>:c5</span>,
    <span>:c5</span>, <span>:b4</span>, <span>:d5</span>,
    <span>:d5</span>, <span>:e5</span>, <span>:c5</span>,
    <span>:a4</span>, <span>:g4</span>, <span>:a4</span>,
    <span>:b4</span>, <span>:c5</span>, <span>:d5</span>, <span>:g5</span>,
    <span>:f5</span>, <span>:eb5</span>, <span>:d5</span>, <span>:c5</span>,
    <span>:g5</span>, <span>:f5</span>, <span>:eb5</span>, <span>:d5</span>,
  ]
  
  <span># play_pattern_timed can also take a list of time intervals</span>
  <span># you can also build that list out of smaller lists</span>
  
  rhythm_a = [ <span>4</span>, <span>2</span>, <span>2</span> ]

  
  <span># the math operations here operate on the list's length — multiplying</span>
  <span>#  a list will extend its length and wrap its contents</span>
  <span># so `[1] * 2` gives you `[1, 1]` and so on</span>
  <span># (this is also equivalent to `Array.new(1, 2)`)</span>
  <span># `play_pattern_timed doesn't take nested arrays...  </span>
  rhythm = [
    rhythm_a,
    <span>8</span>,
    rhythm_a,
    [<span>0.5</span>] * <span>2</span>, <span>7</span>,
    rhythm_a,
    <span>3</span>, <span>1</span>, [<span>2</span>] * <span>2</span>,
    [ <span>1</span>, [<span>0.5</span>] * <span>2</span>, <span>6</span> ] * <span>2</span>
  ].flatten
  <span># ...*but*, by using `flatten`, we can spread its contents</span>
  <span>#  into a single layer</span>
  
  play_pattern_timed melody, rhythm
in_thread <span>do</span>
</code></pre>
<p>We could layer these in a couple of different ways to get a "choir" here. You can manually specify chords to play, but you might not have <em>every part</em> of one in a single section, or might want them spread out in specific ways. In that case, you could construct layered notes manually using <code>ring</code> and then just pass them into one list:</p>
<pre><code>choir = [
  ring(<span>:c5</span>, <span>:e5</span>), ring(<span>:c5</span>, <span>:e5</span>), ring(<span>:d5</span>, <span>:f5</span>)
  ring(<span>:c5</span>, <span>:e5</span>)
  <span># ...and so on</span>
]

<span># play_pattern_timed choir, [ 4, 2, 2, 8 ]</span>

<span># as a side note, the `flatten` trick above wouldn't work here</span>
<span>#  because `ring`s are also lists, so they'd also get merged</span>
<span># while `flatten` does allow you to specify depth, your</span>
<span>#  patterns might not be uniform enough for that</span>
<span># instead, you can also spread out a single list's contents</span>
<span>#  (or splat, I guess, as the operator is called in Ruby)</span>
<span>#  into its parent by adding a leading `*`, such as:</span>
<span>#  `[ *[ ring(:c5, :e5) ] * 4, *[ ring(:b4, :d5) ] * 2 ]`</span>
<span>#  which would produce a single list of 6 rings</span>
</code></pre>
<p>But real choirs don't all sing in singular rhythmic patterns, and this doesn't need to either. We can also nest threads, to share parts across different voices.</p>
<p>&lt;!—</p>
<pre><code>  <span># effects also run in similar blocks. Signal flow starts at the deepest layer,</span>
  <span>#  and effects chains run from inner layers out.</span>
  <span># mix represents the level of blend between wet and dry signal —</span>
  <span>#  that is, signal *with* the effect, and signal *without* it</span>
  with_fx <span>:reverb</span>, <span>mix:</span> <span>0.2</span> <span>do</span>
    <span># so if I added another one here, it would run before the reverb</span>
    <span># with_fx :echo do</span>
</code></pre>
<p>—&gt;</p>
<pre><code>in_thread <span>do</span>
  use_synth <span>:saw</span>
  
  <span># using the outer scope that the depeer levels can access,</span>
  <span>#  we can construct shared rhythmic or melodic sections</span>

  rhythm_a = [ <span>2</span>, <span>1</span>, <span>1</span> ]

  <span># we could also wrap the whole group in a single effect</span>
  <span>#  in a similar fashion to buses on a DAW</span>
  <span># however, deeper grouping than that is pretty manual;</span>
  <span>#  there's no routing to speak of, and scopes limit</span>
  <span>#  you to working in a mostly top-down fashion</span>
  <span># you can duplicate these things to a reasonable degree,</span>
  <span>#  but I'd personally recommend treating it as less</span>
  <span>#  of a production tool and more of an instrument</span>

    <span># soprano</span>
    in_thread <span>do</span>
      use_synth_defaults <span>amp:</span> <span>0.25</span>
        
      melody = [
        <span>:c5</span>, <span>:b4</span>, <span>:d5</span>,
        <span>:c5</span>, <span>#...</span>
      ]

      <span># here we can take the pieces from above</span>
      <span>#  and construct a variation that exists</span>
      <span>#  only inside this block</span>
      rhythm = [
        rhythm_a, <span>#...</span>
      ].flatten
        
    <span>end</span>

    <span># alto</span>
    in_thread <span>do</span>
      use_synth_defaults <span>amp:</span> <span>0.2</span>

      <span># each block has its own scope, so they can each</span>
      <span>#  use these same variable names</span>
      <span># because neither can directly access the other</span>
      melody = [
        <span>:c5</span>, <span>:b4</span>, <span>:d5</span>,
        <span>:c5</span>, <span>#...</span>
      ]
        
      <span># you can assemble a different pattern here, using pieces</span>
      <span>#  from the outer layer</span>
      
      <span># you could also construct longer ones outside — like, say:</span>
      <span>#  `rhythm_a = [rhythm_a1, rhythm_a2].flatten`</span>
      <span>#  and then modify them using list operations</span>
      <span>#  but I'm not going to get too deep into that here</span>

      <span># the important part is:</span>
      <span>#  we can keep referencing the pieces used in the</span>
      <span>#  outer scope, while still being able to reuse *names*</span>
      <span>#  in each inner scope</span>
      rhythm = [
        rhythm_a <span>#...</span>
      ].flatten
    <span>end</span>
  <span>end</span>
<span>end</span>

</code></pre>
<p>We <em>could</em> give them different voicings with distinct rhythmic patterns. But the source piece (the Prelude, from Final Fantasy) has numerous arrangements that don't always add that much complexity to its layers, so we don't have to do that <em>here</em>.</p>
<p>So let's go back to the rings. Since <code>play_pattern_timed</code> adds a <code>sustain</code> value, we <em>could</em> set that manually. It would look like:</p>
<pre><code><span># amp applies to the total volume of this synth — each individual</span>
<span>#  note will be quieter if you're playing multiple layers together</span>
use_synth_defaults <span>release:</span> <span>0.2</span>, <span>amp:</span> <span>0.2</span>

<span># these rings have to be nested, because if not, `play_pattern_timed`</span>
<span>#  will see the underlying list and play the notes in a sequence</span>
<span>#  instead of together</span>
play_pattern_timed [ring(<span>:c5</span>, <span>:e5</span>)], <span>4</span>, <span>sustain:</span> <span>3.8</span>
play_pattern_timed [ring(<span>:b4</span>, <span>:d5</span>)], <span>2</span>, <span>sustain:</span> <span>1.8</span>
play_pattern_timed [ring(<span>:d5</span>, <span>:f5</span>)], <span>2</span>, <span>sustain:</span> <span>1.8</span>
play_pattern_timed [ring(<span>:c5</span>, <span>:e5</span>)], <span>8</span>, <span>sustain:</span> <span>7.8</span>

<span># ...and so on</span>

<span># this *could* be:</span>

<span># play ring(notes), sustain: length</span>
<span># sleep length</span>

<span># but we don't *need* that if we're overriding sustain anyway</span>

</code></pre>
<p>But that's kind of verbose, and manually handling the offsetting is kind of a pain in the ass, and we can define a function for this.</p>
<p>Before I get to that, though, let me explain some of these parameters above a little more. This is called an <em>envelope</em> — specifically an ADSR (Attack, Decay, Sustain, Release) envelope — and it refers to how the volume levels of a sound are shaped. The Sonic Pi docs have more detail on this, but to give you a simplified explanation of each:</p>
<p><em>Attack</em> is the initial "strike" of a sound, and represents the time that it takes to reach its initial peak, coming from 0. Quick examples would be like the pluck of a guitar string, or the hammer of a piano. Slower ones would be the press of an accordion, or a bowed string that's slowly increasing in volume.</p>
<p><em>Decay</em> is the time the sound takes to leave that peak. Think when you're holding down a piano key or a guitar string <em>after</em> it's first hit. The note is continuing, but it still has a slow fade to it. The sound won't just continue indefinitely, even if you're still <em>holding</em> the key that made it ring out.</p>
<p><em>Sustain</em> is the time a sound is held at a stable level, <em>without</em> the fadeout that makes a decay. Examples of sustain include a string being bowed at a consistent volume, or vocals that are being held.</p>
<p><em>Release</em> is the time between letting go of the sound and it actually going silent. A piano key that you hit <em>without</em> holding it will still ring out for a brief moment. A vocalist may still let out a short exhale after letting go of a note. And so on.</p>
<p>Not every sound has every one of these. Synths, for instance, are generated tones that don't necessarily have any initial build or lingering trail to them. Other, more natural instruments will have these things (or not) in different proportions depending on how you play them. Here, we're simulating a choir section, but the goal isn't really to make it lifelike, so the only real aim is to make sure it's holding for the correct time and has a <em>little</em> bit of separation between chords.</p>
<p>All of that being said, back to the function at hand. We can take the notes that make each chord and define shorthand for them, because</p>
<pre><code><span>def</span> <span>choral_rings</span> notes, sus
  offset = sus &lt; <span>1</span> ? <span>0.1</span> : <span>0.2</span>
  
  <span># remember the `*` splat operator I mentioned before?</span>
  <span># you can also use it to spread lists out into arguments</span>
  play ring(*notes), <span>sustain:</span> sus - offset, <span>release:</span> offset
  sleep sus
<span>end</span>
</code></pre>
<p>Going further, we can make all of this loop indefinitely, like an <em>actual</em> video game, with <code>live_loop</code>.</p>
<p>Sonic Pi is largely built for live performance — the code inside a <code>live_loop</code> will run until you tell the program to stop. You can alter the contents as it's playing, and by rerunning the start command, the loop will update the on the next run.</p>
<p>To do this, you'd replace the outer <code>in_thread</code> loops with <code>live_loop :some_unique_name</code>. This gets a little more complex when we're talking about effects chains — they're recreated each time the loop runs, so it's cheaper on resources to run the effects outside the <code>live_loop</code> block, especially as you stack them. But we're not here to get deep into audio or software engineering right now. We're here to make blips blip.</p>
<p>&lt;!— (TORYAH!) —&gt;</p>
<pre><code>live_loop <span>:harp</span> <span>do</span>
  <span># the same blocks...</span>
<span>end</span>

live_loop <span>:choir</span> <span>do</span>
  <span># ...we just wrote</span>

  <span># to make it game-accurate, only play this every</span>
  <span>#  *other* time the other loop runs:</span>
  
  <span># sleep 64</span>
<span>end</span>
</code></pre>
<p>Ultimately, the whole thing looks like this:</p>
<pre><code>
use_bpm <span>75</span>

<span>def</span> <span>arpeggiate</span> note, is_minor = <span>false</span>
  <span># there's probably a cleaner way to reverse this</span>
  <span># and the map operation *could* be nested</span>
  <span># but for illustrative purposes, this is fine</span>
  
  ascending_three = is_minor ? note + <span>3</span> : note + <span>4</span>
  
  ascending = [note, note + <span>2</span>, ascending_three, note + <span>7</span>]
  ascending_arp = [
    *ascending,
    *ascending.map { |<span>note</span>| note + <span>12</span> },
    *ascending.map { |<span>note</span>| note + <span>24</span> },
    *ascending.map { |<span>note</span>| note + <span>36</span> }
  ]
  
  top = note + <span>48</span>
  descending_three = is_minor ? top - <span>9</span> : top - <span>8</span>
  
  descending = [top, top - <span>5</span>, descending_three, top - <span>10</span>]
  
  descending_arp = [
    *descending,
    *descending.map { |<span>note</span>| note - <span>12</span> },
    *descending.map { |<span>note</span>| note - <span>24</span> },
    *descending.map { |<span>note</span>| note - <span>36</span> }
  ]
  
  <span># unlike the version above, this just outputs a value</span>
  <span>#  to then be played in the next block, instead of playing</span>
  <span>#  them directly within the function</span>
  <span># Ruby supports implicit returns — you can simply declare</span>
  <span>#  the value you want from the function on its last line,</span>
  <span>#  without needing to specify as much</span>
  [*ascending_arp, *descending_arp]

  <span># this is equivalent:</span>
  <span># return [*ascending_arp, *descending_arp]</span>
<span>end</span>

arp_c = arpeggiate <span>:c3</span>
arp_a = arpeggiate <span>:a2</span>, <span>true</span>
arp_f = arpeggiate <span>:f2</span>
arp_g = arpeggiate <span>:g2</span>
arp_ab = arpeggiate <span>:ab2</span>
arp_bb = arpeggiate <span>:bb2</span>

live_loop <span>:harp</span> <span>do</span>
  use_synth <span>:square</span> <span># ha</span>
  use_synth_defaults <span>amp:</span> <span>0.15</span>
  
  <span>2</span>.times <span>do</span>
    play_pattern_timed (arp_c), <span>0.25</span>
    play_pattern_timed (arp_a), <span>0.25</span>
  <span>end</span>
  play_pattern_timed (arp_f), <span>0.25</span>
  play_pattern_timed (arp_g), <span>0.25</span>
  play_pattern_timed (arp_ab), <span>0.25</span>
  play_pattern_timed (arp_bb), <span>0.25</span>
<span>end</span>

<span>def</span> <span>choral_rings</span> notes, sus
  offset = sus &lt; <span>1</span> ? <span>0.1</span> : <span>0.2</span>
  
  play ring(*notes), <span>sustain:</span> sus - offset, <span>release:</span> offset
  sleep sus
<span>end</span>

live_loop <span>:choir</span> <span>do</span>
  use_synth <span>:saw</span>
  use_synth_defaults <span>amp:</span> <span>0.35</span>
  
  sleep <span>64</span>
  
  with_fx <span>:reverb</span>, <span>mix:</span> <span>0.75</span> <span>do</span>
    choral_rings [<span>:c5</span>, <span>:e5</span>], <span>4</span>
    choral_rings [<span>:b4</span>, <span>:d5</span>], <span>2</span>
    choral_rings [<span>:d5</span>, <span>:f5</span>], <span>2</span>
    choral_rings [<span>:c5</span>, <span>:e5</span>], <span>8</span>
    
    choral_rings [<span>:c5</span>, <span>:e5</span>], <span>4</span>
    choral_rings [<span>:b4</span>, <span>:d5</span>], <span>2</span>
    choral_rings [<span>:d5</span>, <span>:f5</span>], <span>2</span>
    choral_rings [<span>:d5</span>, <span>:f5</span>], <span>0.5</span>
    choral_rings [<span>:e5</span>, <span>:g5</span>], <span>0.5</span>
    choral_rings [<span>:c5</span>, <span>:e5</span>], <span>7</span>
    
    choral_rings [<span>:a4</span>, <span>:c5</span>], <span>4</span>
    choral_rings [<span>:g4</span>, <span>:b4</span>], <span>2</span>
    choral_rings [<span>:a4</span>, <span>:c5</span>], <span>2</span>
    choral_rings [<span>:b4</span>, <span>:d5</span>], <span>3</span>
    choral_rings [<span>:c5</span>, <span>:e5</span>], <span>1</span>
    choral_rings [<span>:d5</span>, <span>:f5</span>], <span>2</span>
    choral_rings [<span>:b4</span>, <span>:g5</span>], <span>2</span>
    
    choral_rings [<span>:d5</span>, <span>:f5</span>], <span>1</span>
    choral_rings [<span>:c5</span>, <span>:eb5</span>], <span>0.5</span>
    choral_rings [<span>:bb4</span>, <span>:d5</span>], <span>0.5</span>
    choral_rings [<span>:ab4</span>, <span>:c5</span>], <span>6</span>
    
    choral_rings [<span>:eb5</span>, <span>:g5</span>], <span>1</span>
    choral_rings [<span>:d5</span>, <span>:f5</span>], <span>0.5</span>
    choral_rings [<span>:c5</span>, <span>:eb5</span>], <span>0.5</span>
    choral_rings [<span>:bb4</span>, <span>:d5</span>], <span>6</span>
  <span>end</span>
<span>end</span>

</code></pre>
<p>And sounds like this.</p>
<p>As much as tech work is usually discussed in terms of computer <em>science</em> (and as much as I've had ex bosses neg me for my major in college), programming is also art. And it's not even just art when you're using it to purposely do something creative — such as generating audio like this, or something more visual like designing layouts using CSS. What's understated is that writing code is a creative act, much like writing anything else. See, you're not <em>just</em> talking to a machine in the most optimized fashion possible. You're <em>also</em> talking to other people. And even talking to yourself. (You're <em>not</em> crazy though — you're just a little unwell.) Code is ultimately text, and organized text at that. Ultimately, it's <em>read</em> and not just written — so writing <em>good</em> code is about writing code that can be understood at a glance, whether that's to other people, or to you in six months.</p>
<p>But once in a while though, the art of it really <em>is</em> the point in itself.</p>

    </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[SQLite FTS5 Extension (125 pts)]]></title>
            <link>https://www.sqlite.org/fts5.html</link>
            <guid>41198422</guid>
            <pubDate>Fri, 09 Aug 2024 02:49:18 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.sqlite.org/fts5.html">https://www.sqlite.org/fts5.html</a>, See on <a href="https://news.ycombinator.com/item?id=41198422">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>







<h2 id="overview_of_fts5"><span>1. </span>Overview of FTS5</h2>

<p>FTS5 is an SQLite <a href="https://www.sqlite.org/c3ref/module.html">virtual table module</a> that provides
<a href="https://en.wikipedia.org/wiki/Full_text_search">full-text search</a>
functionality to database applications. In their most elementary form,
full-text search engines allow the user to efficiently search a large
collection of documents for the subset that contain one or more instances of a
search term. The search functionality provided to world wide web users by
<a href="https://www.google.com/">Google</a> is, among other things, a full-text search
engine, as it allows users to search for all documents on the web that contain,
for example, the term "fts5".

</p><p>To use FTS5, the user creates an FTS5 virtual table with one or more
columns. For example:

</p><div><pre>CREATE VIRTUAL TABLE email USING fts5(sender, title, body);
</pre></div>

<p>It is an error to add types, constraints or <a href="https://www.sqlite.org/lang_createtable.html#primkeyconst">PRIMARY KEY</a> declarations to
a CREATE VIRTUAL TABLE statement used to create an FTS5 table. Once created,
an FTS5 table may be populated using <a href="https://www.sqlite.org/lang_insert.html">INSERT</a>, <a href="https://www.sqlite.org/lang_update.html">UPDATE</a> or <a href="https://www.sqlite.org/lang_delete.html">DELETE</a> statements
like any other table. Like any other table with no PRIMARY KEY declaration, an
FTS5 table has an implicit INTEGER PRIMARY KEY field named rowid.

</p><p>Not shown in the example above is that there are also
<a href="https://www.sqlite.org/fts5.html#fts5_table_creation_and_initialization">various options</a> that may be provided to FTS5 as
part of the CREATE VIRTUAL TABLE statement to configure various aspects of the
new table. These may be used to modify the way in which the FTS5 table extracts
terms from documents and queries, to create extra indexes on disk to speed up
prefix queries, or to create an FTS5 table that acts as an index on content
stored elsewhere.

</p><p>Once populated, there are three ways to execute a full-text query against
the contents of an FTS5 table:

</p><ul><li> Using a MATCH operator in the WHERE clause of a SELECT statement, or
    </li><li> Using an equals ("=") operator in the WHERE clause of a SELECT statement, or
    </li><li> using the <a href="https://www.sqlite.org/vtab.html#tabfunc2">table-valued function</a> syntax.
</li></ul>

<p>If using the MATCH or = operators, the expression to the left of the MATCH
   operator is usually the name of the FTS5 table (the exception is when
   <a href="https://www.sqlite.org/fts5.html#fts5_column_filters">specifying a column-filter</a>). The expression on the right
   must be a text value specifying the term to search for. For the table-valued
   function syntax, the term to search for is specified as the first table argument.
   For example:

</p><div><pre><i>-- Query for all rows that contain at least once instance of the term</i>
<i>-- "fts5" (in any column). The following three queries are equivalent.</i>
SELECT * FROM email WHERE email MATCH 'fts5';
SELECT * FROM email WHERE email = 'fts5';
SELECT * FROM email('fts5');
</pre></div>

<p> By default, FTS5 full-text searches are case-independent. Like any other
SQL query that does not contain an ORDER BY clause, the example above returns
results in an arbitrary order. To sort results by relevance (most to least
relevant), an ORDER BY may be added to a full-text query as follows:

</p><div><pre><i>-- Query for all rows that contain at least once instance of the term</i>
<i>-- "fts5" (in any column). Return results in order from best to worst</i>
<i>-- match.  </i>
SELECT * FROM email WHERE email MATCH 'fts5' ORDER BY rank;
</pre></div>

<p> As well as the column values and rowid of a matching row, an application
may use <a href="https://www.sqlite.org/fts5.html#_auxiliary_functions_">FTS5 auxiliary functions</a> to retrieve extra information regarding
the matched row. For example, an auxiliary function may be used to retrieve
a copy of a column value for a matched row with all instances of the matched
term surrounded by html &lt;b&gt;&lt;/b&gt; tags. Auxiliary functions are
invoked in the same way as SQLite <a href="https://www.sqlite.org/lang_corefunc.html">scalar functions</a>, except that the name
of the FTS5 table is specified as the first argument. For example:

</p><div><pre><i>-- Query for rows that match "fts5". Return a copy of the "body" column</i>
<i>-- of each row with the matches surrounded by &lt;b&gt;&lt;/b&gt; tags.</i>
SELECT highlight(email, 2, '&lt;b&gt;', '&lt;/b&gt;') FROM email('fts5');
</pre></div>

<p>A description of the available auxiliary functions, and more details
regarding configuration of the special "rank" column, are
<a href="https://www.sqlite.org/fts5.html#_auxiliary_functions_">available below</a>. <a href="https://www.sqlite.org/fts5.html#custom_auxiliary_functions">Custom auxiliary functions</a> may also be implemented in C and registered with
FTS5, just as custom SQL functions may be registered with the SQLite core.

</p><p> As well as searching for all rows that contain a term, FTS5 allows
the user to search for rows that contain:

</p><ul>
  <li> any terms that begin with a specified prefix,
  </li><li> "phrases" - sequences of terms or prefix terms that must feature in a
       document for it to match the query,
  </li><li> sets of terms, prefix terms or phrases that appear within a specified
       proximity of each other (these are called "NEAR queries"), or
  </li><li> boolean combinations of any of the above.
</li></ul>

<p> Such advanced searches are requested by providing a more complicated
FTS5 query string as the text to the right of the MATCH operator (or =
operator, or as the first argument to a table-valued function syntax). The
full query syntax is <a href="https://www.sqlite.org/fts5.html#full_text_query_syntax">described here</a>.

</p><h2 tags="FTS5 building" id="compiling_and_using_fts5"><span>2. </span>Compiling and Using FTS5</h2>

<h2 id="building_fts5_as_part_of_sqlite"><span>2.1. </span>Building FTS5 as part of SQLite</h2>

<p>As of <a href="https://www.sqlite.org/releaselog/3_9_0.html">version 3.9.0</a> (2015-10-14),
FTS5 is included as part of the SQLite <a href="https://www.sqlite.org/amalgamation.html">amalgamation</a>.
If using one of the two autoconf build system, FTS5 is
enabled by specifying the "--enable-fts5" option when running the configure
script.  (FTS5 is currently disabled by default for the
source-tree configure script and enabled by default for
the amalgamation configure script, but these defaults might
change in the future.)

</p><p>Or, if sqlite3.c is compiled using some other build system, by arranging for
the SQLITE_ENABLE_FTS5 pre-processor symbol to be defined.

</p><h2 id="building_a_loadable_extension"><span>2.2. </span>Building a Loadable Extension</h2>

<p>Alternatively, FTS5 may be built as a loadable extension.

</p><p>The canonical FTS5 source code consists of a series of *.c and other files
in the "ext/fts5" directory of the SQLite source tree. A build process reduces
this to just two files - "fts5.c" and "fts5.h" - which may be used to build an
SQLite loadable extension.

</p><ol>
  <li> Obtain the latest SQLite code from fossil.
  </li><li> Create a Makefile as described in <a href="https://www.sqlite.org/howtocompile.html">How To Compile SQLite</a>.
  </li><li> Build the "fts5.c" target. Which also creates fts5.h.
</li></ol>

<div><pre>$ wget -c https://www.sqlite.org/src/tarball/SQLite-trunk.tgz?uuid=trunk -O SQLite-trunk.tgz
.... output ...
$ tar -xzf SQLite-trunk.tgz
$ cd SQLite-trunk
$ ./configure &amp;&amp; make fts5.c
... lots of output ...
$ ls fts5.[ch]
fts5.c        fts5.h
</pre></div>

<p>
  The code in "fts5.c" may then be compiled into a loadable extension or
  statically linked into an application as described in
  <a href="https://www.sqlite.org/loadext.html#build">Compiling Loadable Extensions</a>. There are two entry points defined, both
  of which do the same thing:

</p><ul>
  <li> sqlite3_fts_init
  </li><li> sqlite3_fts5_init
</li></ul>

<p>
  The other file, "fts5.h", is not required to compile the FTS5 extension.
  It is used by applications that implement <a href="https://www.sqlite.org/fts5.html#extending_fts5">custom FTS5 tokenizers or auxiliary functions</a>.

</p><h2 tags="FTS5 query syntax" id="full_text_query_syntax"><span>3. </span>Full-text Query Syntax</h2>

<p>
The following block contains a summary of the FTS query syntax in BNF form.
A detailed explanation follows.

</p><div><pre>&lt;phrase&gt;    := string [*]
&lt;phrase&gt;    := &lt;phrase&gt; + &lt;phrase&gt;
&lt;neargroup&gt; := NEAR ( &lt;phrase&gt; &lt;phrase&gt; ... [, N] )
&lt;query&gt;     := [ [-] &lt;colspec&gt; :] [^] &lt;phrase&gt;
&lt;query&gt;     := [ [-] &lt;colspec&gt; :] &lt;neargroup&gt;
&lt;query&gt;     := [ [-] &lt;colspec&gt; :] ( &lt;query&gt; )
&lt;query&gt;     := &lt;query&gt; AND &lt;query&gt;
&lt;query&gt;     := &lt;query&gt; OR &lt;query&gt;
&lt;query&gt;     := &lt;query&gt; NOT &lt;query&gt;
&lt;colspec&gt;   := colname
&lt;colspec&gt;   := { colname1 colname2 ... }
</pre></div>

<h2 tags="FTS5 Strings" id="fts5_strings"><span>3.1. </span>FTS5 Strings</h2>
<p>
Within an FTS expression a <b>string</b> may be specified in one of two ways:

</p><ul>
  <li> <p>By enclosing it in double quotes ("). Within a string, any embedded
       double quote characters may be escaped SQL-style - by adding a second
       double-quote character.

  </p></li><li> <p>As an FTS5 bareword that is not "AND", "OR" or "NOT" (case sensitive).
       An FTS5 bareword is a string of one or more consecutive characters that
       are all either:

       </p><ul>
         <li> Non-ASCII range characters (i.e. unicode codepoints greater
              than 127), or
         </li><li> One of the 52 upper and lower case ASCII characters, or
         </li><li> One of the 10 decimal digit ASCII characters, or
         </li><li> The underscore character (unicode codepoint 96).
         </li><li> The substitute character (unicode codepoint 26).
       </li></ul>

       Strings that include any other characters must be quoted. Characters
       that are not currently allowed in barewords, are not quote characters and
       do not currently serve any special purpose in FTS5 query expressions may
       at some point in the future be allowed in barewords or used to implement
       new query functionality. This means that queries that are currently
       syntax errors because they include such a character outside of a quoted
       string may be interpreted differently by some future version of FTS5.
</li></ul>

<h2 tags="FTS5 Phrases" id="fts5_phrases"><span>3.2. </span>FTS5 Phrases</h2>
<p>
Each string in an fts5 query is parsed ("tokenized") by the 
<a href="https://www.sqlite.org/fts5.html#tokenizers">tokenizer</a> and a list of zero or more <b>tokens</b>, or
terms, extracted. For example, the default tokenizer tokenizes the string "alpha
beta gamma" to three separate tokens - "alpha", "beta" and "gamma" - in that
order.

</p><p>
FTS queries are made up of <b>phrases</b>. A phrase is an ordered list of
one or more tokens. The tokens from each string in the query each make up a
single phrase. Two phrases can be concatenated into a single large phrase
using the "+" operator. For example, assuming the tokenizer module being used
tokenizes the input "one.two.three" to three separate tokens, the following
four queries all specify the same phrase:

</p><div><pre>... MATCH '"one two three"'
... MATCH 'one + two + three'
... MATCH '"one two" + three'
... MATCH 'one.two.three'
</pre></div>

<p>
A phrase matches a document if the document contains at least one sub-sequence
of tokens that matches the sequence of tokens that make up the phrase.

</p><h2 tags="FTS5 prefix queries" id="fts5_prefix_queries"><span>3.3. </span>FTS5 Prefix Queries</h2>
<p>
If a "*" character follows a string within an FTS expression, then the final
token extracted from the string is marked as a <b>prefix token</b>. As you
might expect, a prefix token matches any document token of which it is a
prefix. For example, the first two queries in the following block will match
any document that contains the token "one" immediately followed by the token
"two" and then any token that begins with "thr".

</p><div><pre>... MATCH '"one two thr" * '
... MATCH 'one + two + thr*'
... MATCH '"one two thr*"'      <b>-- May not work as expected!</b>
</pre></div>

<p>The final query in the block above may not work as expected. Because the
"*" character is inside the double-quotes, it will be passed to the tokenizer,
which will likely discard it (or perhaps, depending on the specific tokenizer
in use, include it as part of the final token) instead of recognizing it as
a special FTS character.

<a name="carrotq"></a>

</p><h2 tags="FTS5 initial token queries" id="fts5_initial_token_queries"><span>3.4. </span>FTS5 Initial Token Queries</h2>
<p>
If a "^" character appears immediately before a phrase that is not part of a
NEAR query, then that phrase only matches a document only if it starts at the
first token in a column. The "^" syntax may be combined with a
<a href="https://www.sqlite.org/fts5.html#fts5_column_filters">column filter</a>, but may not be inserted into the middle of
a phrase.

</p><div><pre>... MATCH '^one'              <i>-- first token in any column must be "one"</i>
... MATCH '^ one + two'       <i>-- phrase "one two" must appear at start of a column</i>
... MATCH '^ "one two"'       <i>-- same as previous </i>
... MATCH 'a : ^two'          <i>-- first token of column "a" must be "two"</i>
... MATCH 'NEAR(^one, two)'   <b>-- syntax error! </b>
... MATCH 'one + ^two'        <b>-- syntax error! </b>
... MATCH '"^one two"'        <b>-- May not work as expected!</b>
</pre></div>

<h2 tags="FTS5 NEAR queries" id="fts5_near_queries"><span>3.5. </span>FTS5 NEAR Queries</h2>

<p>Two or more phrases may be grouped into a <b>NEAR group</b>. A NEAR group
is specified by the token "NEAR" (case sensitive) followed by an open
parenthesis character, followed by two or more whitespace separated phrases, optionally followed by a comma and the numeric parameter <i>N</i>, followed by
a close parenthesis. For example:

</p><div><pre>... MATCH 'NEAR("one two" "three four", 10)'
... MATCH 'NEAR("one two" thr* + four)'
</pre></div>

<p>If no <i>N</i> parameter is supplied, it defaults to 10. A NEAR group
matches a document if the document contains at least one clump of tokens that:

</p><ol>
  <li> contains at least one instance of each phrase, and
  </li><li> for which the number of tokens between the end of the first phrase
       and the beginning of the last phrase in the clump is less than or equal to <i>N</i>.
</li></ol>

<p>For example:

</p><div><pre>CREATE VIRTUAL TABLE f USING fts5(x);
INSERT INTO f(rowid, x) VALUES(1, 'A B C D x x x E F x');

... MATCH 'NEAR(e d, 4)';                      <i>-- Matches!</i>
... MATCH 'NEAR(e d, 3)';                      <i>-- Matches!</i>
... MATCH 'NEAR(e d, 2)';                      <i>-- Does not match!</i>

... MATCH 'NEAR("c d" "e f", 3)';              <i>-- Matches!</i>
... MATCH 'NEAR("c"   "e f", 3)';              <i>-- Does not match!</i>

... MATCH 'NEAR(a d e, 6)';                    <i>-- Matches!</i>
... MATCH 'NEAR(a d e, 5)';                    <i>-- Does not match!</i>

... MATCH 'NEAR("a b c d" "b c" "e f", 4)';    <i>-- Matches!</i>
... MATCH 'NEAR("a b c d" "b c" "e f", 3)';    <i>-- Does not match!</i>
</pre></div>

<h2 tags="FTS5 column filters" id="fts5_column_filters"><span>3.6. </span>FTS5 Column Filters</h2>

<p>
A single phrase or NEAR group may be restricted to matching text within a
specified column of the FTS table by prefixing it with the column name
followed by a colon character. Or to a set of columns by prefixing it
with a whitespace separated list of column names enclosed in parenthesis
("curly brackets") followed by a colon character. Column names may be specified
using either of the two forms described for strings above. Unlike strings that
are part of phrases, column names are not passed to the tokenizer module.
Column names are case-insensitive in the usual way for SQLite column names -
upper/lower case equivalence is understood for ASCII-range characters only.

</p><div><pre>... MATCH 'colname : NEAR("one two" "three four", 10)'
... MATCH '"colname" : one + two + three'

... MATCH '{col1 col2} : NEAR("one two" "three four", 10)'
... MATCH '{col2 col1 col3} : one + two + three'
</pre></div>

<p>
If a column filter specification is preceded by a "-" character, then
it is interpreted as a list of column not to match against. For example:

</p><div><pre><i>-- Search for matches in all columns except "colname"</i>
... MATCH '- colname : NEAR("one two" "three four", 10)'

<i>-- Search for matches in all columns except "col1", "col2" and "col3"</i>
... MATCH '- {col2 col1 col3} : one + two + three'
</pre></div>

<p>
Column filter specifications may also be applied to arbitrary expressions
enclosed in parenthesis. In this case the column filter applies to all
phrases within the expression. Nested column filter operations may only
further restrict the subset of columns matched, they can not be used to
re-enable filtered columns. For example:

</p><div><pre><i>-- The following are equivalent:</i>
... MATCH '{a b} : ( {b c} : "hello" AND "world" )'
... MATCH '(b : "hello") AND ({a b} : "world")'
</pre></div>

<p>
Finally, a column filter for a single column may be specified by using
the column name as the LHS of a MATCH operator (instead of the usual
table name). For example:

</p><div><pre><i>-- Given the following table</i>
CREATE VIRTUAL TABLE ft USING fts5(a, b, c);

<i>-- The following are equivalent</i>
SELECT * FROM ft WHERE b MATCH 'uvw AND xyz';
SELECT * FROM ft WHERE ft MATCH 'b : (uvw AND xyz)';

<i>-- This query cannot match any rows (since all columns are filtered out): </i>
SELECT * FROM ft WHERE b MATCH 'a : xyz';
</pre></div>

<h2 tags="FTS5 boolean operators" id="fts5_boolean_operators"><span>3.7. </span>FTS5 Boolean Operators</h2>

<p>
Phrases and NEAR groups may be arranged into expressions using <b>boolean
operators</b>. In order of precedence, from highest (tightest grouping) to
lowest (loosest grouping), the operators are:

</p><table striped="1">
  <tbody><tr><th>Operator </th><th>Function

  </th></tr><tr><td><code>&lt;query1&gt; NOT &lt;query2&gt;</code>
      </td><td>Matches if query1 matches and query2 does not match.

  </td></tr><tr><td><code>&lt;query1&gt; AND &lt;query2&gt;</code>
      </td><td>Matches if both query1 and query2 match.

  </td></tr><tr><td><code>&lt;query1&gt; OR &lt;query2&gt;</code>
      </td><td>Matches if either query1 or query2 match.

</td></tr></tbody></table>

<p>
Parenthesis may be used to group expressions in order to modify operator
precedence in the usual ways. For example:

</p><div><pre><i>-- Because NOT groups more tightly than OR, either of the following may</i>
<i>-- be used to match all documents that contain the token "two" but not</i>
<i>-- "three", or contain the token "one".  </i>
... MATCH 'one OR two NOT three'
... MATCH 'one OR (two NOT three)'

<i>-- Matches documents that contain at least one instance of either "one"</i>
<i>-- or "two", but do not contain any instances of token "three".</i>
... MATCH '(one OR two) NOT three'
</pre></div>

<p>
Phrases and NEAR groups may also be connected by <b>implicit AND operators</b>.
For simplicity, these are not shown in the BNF grammar above. Essentially, any
sequence of phrases or NEAR groups (including those restricted to matching
specified columns) separated only by whitespace are handled as if there were an
implicit AND operator between each pair of phrases or NEAR groups. Implicit
AND operators are never inserted after or before an expression enclosed in
parenthesis. Implicit AND operators group more tightly than all other
operators, including NOT. For example:

</p><div><pre>... MATCH 'one two three'         <i>-- 'one AND two AND three'</i>
... MATCH 'three "one two"'       <i>-- 'three AND "one two"'</i>
... MATCH 'NEAR(one two) three'   <i>-- 'NEAR(one two) AND three'</i>
... MATCH 'one OR two three'      <i>-- 'one OR two AND three'</i>
... MATCH 'one NOT two three'     <i>-- 'one NOT (two AND three)'</i>

... MATCH '(one OR two) three'    <i>-- Syntax error!</i>
... MATCH 'func(one two)'         <i>-- Syntax error!</i>
</pre></div>

<h2 tags="FTS5 CREATE TABLE Options" id="fts5_table_creation_and_initialization"><span>4. </span>FTS5 Table Creation and Initialization</h2>

<p>Each argument specified as part of a "CREATE VIRTUAL TABLE ... USING fts5
..." statement is either a column declaration or a configuration option. A
<b>column declaration</b> consists of one or more whitespace separated FTS5
barewords or string literals quoted in any manner acceptable to SQLite.

</p><p>The first string or bareword in a column declaration is the column name. It
is an error to attempt to name an fts5 table column "rowid" or "rank", or to
assign the same name to a column as is used by the table itself. This is not
supported.

</p><p>Each subsequent string or bareword in a column declaration is a column
option that modifies the behaviour of that column. Column options are
case-independent. Unlike the SQLite core, FTS5 considers unrecognized column
options to be errors. Currently, the only option recognized is
<a href="https://www.sqlite.org/fts5.html#the_unindexed_column_option">"UNINDEXED" (see below)</a>.

</p><p>A <b>configuration option</b> consists of an FTS5 bareword - the option name -
followed by an "=" character, followed by the option value. The option value is
specified using either a single FTS5 bareword or a string literal, again quoted
in any manner acceptable to the SQLite core. For example:

</p><div><pre>CREATE VIRTUAL TABLE mail USING fts5(sender, title, body, tokenize = 'porter ascii');
</pre></div>

<p> There are currently the following configuration options:

</p><ul>
  <li> The "tokenize" option, used to configure a <a href="https://www.sqlite.org/fts5.html#tokenizers">custom tokenizer</a>.
  </li><li> The "prefix" option, used to add <a href="https://www.sqlite.org/fts5.html#prefix_indexes">prefix indexes</a>
       to an FTS5 table.
  </li><li> The "content" option, used to make the FTS5 table an
       <a href="https://www.sqlite.org/fts5.html#external_content_and_contentless_tables">external content or contentless table</a>.
  </li><li> The "content_rowid" option, used to set the rowid field of an
       <a href="https://www.sqlite.org/fts5.html#external_content_tables">external content table</a>.
  </li><li> The <a href="https://www.sqlite.org/fts5.html#the_columnsize_option">"columnsize" option</a>, used to configure
       whether or not the size in tokens of each value in the FTS5 table is
       stored separately within the database.
  </li><li> The <a href="https://www.sqlite.org/fts5.html#the_detail_option">"detail" option</a>. This option may be used
       to reduce the size of the FTS index on disk by omitting some information
       from it.
</li></ul>

<h2 tags="unindexed" id="the_unindexed_column_option"><span>4.1. </span>The UNINDEXED column option</h2>

<p>The contents of columns qualified with the UNINDEXED column option are not
added to the FTS index. This means that for the purposes of MATCH queries and
<a href="https://www.sqlite.org/fts5.html#_auxiliary_functions_">FTS5 auxiliary functions</a>, the column contains no matchable tokens.

</p><p>For example, to avoid adding the contents of the "uuid" field to the FTS
index:
</p><div><pre>CREATE VIRTUAL TABLE customers USING fts5(name, addr, uuid UNINDEXED);
</pre></div>

<h2 tags="FTS5 prefix indexes" id="prefix_indexes"><span>4.2. </span>Prefix Indexes</h2>

<p> By default, FTS5 maintains a single index recording the location of each
token instance within the document set. This means that querying for complete
tokens is fast, as it requires a single lookup, but querying for a prefix
token can be slow, as it requires a range scan. For example, to query for
the prefix token "abc*" requires a range scan of all tokens greater than
or equal to "abc" and less than "abd".

</p><p> A prefix index is a separate index that records the location of all
instances of prefix tokens of a certain length in characters used to speed
up queries for prefix tokens. For example, optimizing a query for prefix
token "abc*" requires a prefix index of three-character prefixes.

</p><p> To add prefix indexes to an FTS5 table, the "prefix" option is set to
either a single positive integer or a text value containing a white-space
separated list of one or more positive integer values. A prefix index is
created for each integer specified. If more than one "prefix" option is
specified as part of a single CREATE VIRTUAL TABLE statement, all apply.

</p><div><pre><i>-- Two ways to create an FTS5 table that maintains prefix indexes for
-- two and three character prefix tokens.</i>
CREATE VIRTUAL TABLE ft USING fts5(a, b, prefix='2 3');
CREATE VIRTUAL TABLE ft USING fts5(a, b, prefix=2, prefix=3);
</pre></div>

<h2 tags="FTS5 tokenizers" id="tokenizers"><span>4.3. </span>Tokenizers</h2>

<p> The CREATE VIRTUAL TABLE "tokenize" option is used to configure the
specific tokenizer used by the FTS5 table. The option argument must be either
an FTS5 bareword, or an SQL text literal. The text of the argument is itself
treated as a white-space series of one or more FTS5 barewords or SQL text
literals. The first of these is the name of the tokenizer to use. The second
and subsequent list elements, if they exist, are arguments passed to the
tokenizer implementation.

</p><p> Unlike option values and column names, SQL text literals intended as
tokenizers must be quoted using single quote characters. For example:

</p><div><pre><i>-- The following are all equivalent</i>
CREATE VIRTUAL TABLE t1 USING fts5(x, tokenize = 'porter ascii');
CREATE VIRTUAL TABLE t1 USING fts5(x, tokenize = "porter ascii");
CREATE VIRTUAL TABLE t1 USING fts5(x, tokenize = "'porter' 'ascii'");
CREATE VIRTUAL TABLE t1 USING fts5(x, tokenize = '''porter'' ''ascii''');

<i>-- But this will fail:</i>
CREATE VIRTUAL TABLE t1 USING fts5(x, tokenize = '"porter" "ascii"');

<i>-- This will fail too:</i>
CREATE VIRTUAL TABLE t1 USING fts5(x, tokenize = 'porter' 'ascii');
</pre></div>


<p>
FTS5 features four built-in tokenizer modules, described in subsequent
sections:

</p><ul>
  <li> The <b>unicode61</b> tokenizer, based on the Unicode 6.1 standard. This
       is the default.

  </li><li> The <b>ascii</b> tokenizer, which assumes all characters outside of
  the ASCII codepoint range (0-127) are to be treated as token characters.

  </li><li> The <b>porter</b> tokenizer, which implements the
<a href="https://tartarus.org/martin/PorterStemmer" ="1"="">porter stemming algorithm</a>.

  </li><li> The <b>trigram</b> tokenizer, which treats each contiguous sequence of
  three characters as a token, allowing FTS5 to support more general substring matching.
</li></ul>

<p> It is also possible to create custom tokenizers for FTS5. The API for doing so is <a href="https://www.sqlite.org/fts5.html#custom_tokenizers">described here</a>.

</p><h3 id="unicode61_tokenizer"><span>4.3.1. </span>Unicode61 Tokenizer</h3>

<p> The unicode tokenizer classifies all unicode characters as either
"separator" or "token" characters. By default all space and punctuation
characters, as defined by Unicode 6.1, are considered separators, and all
other characters as token characters. More specifically, all unicode
characters assigned to a
<a href="https://en.wikipedia.org/wiki/Unicode_character_property#General_Category">
general category</a> beginning with "L" or "N" (letters and numbers,
specifically) or to category "Co" ("other, private use") are considered tokens.
All other characters are separators.

</p><p>Each contiguous run of one or more token characters is considered to be a
token. The tokenizer is case-insensitive according to the rules defined by
Unicode 6.1.

</p><p> By default, diacritics are removed from all Latin script characters. This
means, for example, that "A", "a", "À", "à", "Â" and "â"
are all considered to be equivalent.

</p><p> Any arguments following "unicode61" in the token specification are treated
as a list of alternating option names and values. Unicode61 supports the
following options:

</p><table striped="1">
  <tbody><tr><th> Option </th><th> Usage
  </th></tr><tr><td> remove_diacritics
  </td><td>This option should be set to "0", "1" or "2". The default value is "1".
  If it is set to "1" or "2", then diacritics are removed from Latin script
  characters as described above. However, if it is set to "1", then diacritics
  are not removed in the fairly uncommon case where a single unicode codepoint
  is used to represent a character with more that one diacritic. For example,
  diacritics are not removed from codepoint 0x1ED9 ("LATIN SMALL LETTER O WITH
  CIRCUMFLEX AND DOT BELOW"). This is technically a bug, but cannot be fixed
  without creating backwards compatibility problems. If this option is set to
  "2", then diacritics are correctly removed from all Latin characters.

  </td></tr><tr><td> categories
  </td><td>This option may be used to modify the set of Unicode general categories
  that are considered to correspond to token characters. The argument must
  consist of a space separated list of two-character general category
  abbreviations (e.g. "Lu" or "Nd"), or of the same with the second character
  replaced with an asterisk ("*"), interpreted as a glob pattern. The default
  value is "L* N* Co".

  </td></tr><tr><td> tokenchars
  </td><td> This option is used to specify additional unicode characters that
  should be considered token characters, even if they are white-space or
  punctuation characters according to Unicode 6.1. All characters in the
  string that this option is set to are considered token characters.

  </td></tr><tr><td> separators
  </td><td> This option is used to specify additional unicode characters that
  should be considered as separator characters, even if they are token
  characters according to Unicode 6.1. All characters in the string that
  this option is set to are considered separators.
</td></tr></tbody></table>

<p> For example:

</p><div><pre><i>-- Create an FTS5 table that does not remove diacritics from Latin
-- script characters, and that considers hyphens and underscore characters
-- to be part of tokens. </i>
CREATE VIRTUAL TABLE ft USING fts5(a, b,
    tokenize = "unicode61 remove_diacritics 0 tokenchars '-_'"
);
</pre></div>

<p> or:

</p><div><pre><i>-- Create an FTS5 table that, as well as the default token character classes,</i>
<i>-- considers characters in class "Mn" to be token characters.</i>
CREATE VIRTUAL TABLE ft USING fts5(a, b,
    tokenize = "unicode61 categories 'L* N* Co Mn'"
);
</pre></div>

<p> The fts5 unicode61 tokenizer is byte-for-byte compatible with the fts3/4
unicode61 tokenizer.

</p><h3 id="ascii_tokenizer"><span>4.3.2. </span>Ascii Tokenizer</h3>

<p> The Ascii tokenizer is similar to the Unicode61 tokenizer, except that:

</p><ul>
  <li> All non-ASCII characters (those with codepoints greater than 127) are
  always considered token characters. If any non-ASCII characters are specified
  as part of the separators option, they are ignored.

  </li><li> Case-folding is only performed for ASCII characters. So while "A" and
  "a" are considered to be equivalent, "Ã" and "ã" are distinct.

  </li><li> The remove_diacritics option is not supported.
</li></ul>

<p> For example:

</p><div><pre><i>-- Create an FTS5 table that uses the ascii tokenizer, but does not
-- consider numeric characters to be part of tokens.</i>
CREATE VIRTUAL TABLE ft USING fts5(a, b,
    tokenize = "ascii separators '0123456789'"
);
</pre></div>

<h3 id="porter_tokenizer"><span>4.3.3. </span>Porter Tokenizer</h3>

<p> The porter tokenizer is a wrapper tokenizer. It takes the output of some
other tokenizer and applies the
<a href="https://tartarus.org/martin/PorterStemmer/">porter stemming algorithm</a>
to each token before it returns it to FTS5. This allows search terms like
"correction" to match similar words such as "corrected" or "correcting". The
porter stemmer algorithm is designed for use with English language terms
only - using it with other languages may or may not improve search utility.

</p><p> By default, the porter tokenizer operates as a wrapper around the default
tokenizer (unicode61). Or, if one or more extra arguments are added to the
"tokenize" option following "porter", they are treated as a specification for
the underlying tokenizer that the porter stemmer uses. For example:

</p><div><pre><i>-- Two ways to create an FTS5 table that uses the porter tokenizer to
-- stem the output of the default tokenizer (unicode61). </i>
CREATE VIRTUAL TABLE t1 USING fts5(x, tokenize = porter);
CREATE VIRTUAL TABLE t1 USING fts5(x, tokenize = 'porter unicode61');

<i>-- A porter tokenizer used to stem the output of the unicode61 tokenizer,
-- with diacritics removed before stemming.</i>
CREATE VIRTUAL TABLE t1 USING fts5(x, tokenize = 'porter unicode61 remove_diacritics 1');
</pre></div>

<h3 id="the_trigram_tokenizer"><span>4.3.4. </span>The Trigram Tokenizer</h3>

<p>
The trigram tokenizer extends FTS5 to support substring
matching in general, instead of the usual token matching. When using the
trigram tokenizer, a query or phrase token may match any sequence of characters
within a row, not just a complete token. For example:

</p><div><pre>CREATE VIRTUAL TABLE tri USING fts5(a, tokenize="trigram");
INSERT INTO tri VALUES('abcdefghij KLMNOPQRST uvwxyz');

<i>-- The following queries all match the single row in the table</i>
SELECT * FROM tri('cdefg');
SELECT * FROM tri('cdefg AND pqr');
SELECT * FROM tri('"hij klm" NOT stuv');
</pre></div>

<p>
The trigram tokenizer supports the following options: 

</p><table striped="1">
  <tbody><tr><th> Option </th><th> Usage
  </th></tr><tr><td> case_sensitive
      </td><td> This value may be set to 1 or 0 (the default). If it is set to 1,
      then matching is case sensitive. Otherwise, if this option is set to
      0, matching is case insensitive.

  </td></tr><tr><td> remove_diacritics
      </td><td> This value may also be set to 1 or 0 (the default). It may only
      be set to 1 if the case_sensitive options is set to 0 - setting both
      options to 1 is an error. If this option is set, then diacritics are
      removed from the text before matching (e.g. so that "á" matches "a").
</td></tr></tbody></table>

<div><pre><i>-- A case-sensitive trigram index</i>
CREATE VIRTUAL TABLE tri USING fts5(a, tokenize="trigram case_sensitive 1");
</pre></div>

<p>
Unless the remove_diacritics option is set, FTS5 tables that use the trigram
tokenizer also support indexed GLOB and LIKE pattern matching. For example:

</p><div><pre>SELECT * FROM tri WHERE a LIKE '%cdefg%';
SELECT * FROM tri WHERE a GLOB '*ij klm*xyz';
</pre></div>

<p>
If an FTS5 trigram tokenizer is created with the case_sensitive option set to 1,
it may only index GLOB queries, not LIKE.

</p><p>
Notes:

</p><ul>
  <li> Substrings consisting of fewer than 3 unicode characters do not match any
       rows when used with a full-text query. If a LIKE or GLOB pattern does not
       contain at least one sequence of non-wildcard unicode characters, FTS5
       falls back to a linear scan of the entire table.

  </li><li> If the FTS5 table is created with the detail=none or detail=column option
       specified, full-text queries may not contain any tokens longer than 3
       unicode characters. LIKE and GLOB pattern matching may be slightly slower,
       but still works. If the index is to be used only for LIKE and/or GLOB
       pattern matching, these options are worth experimenting with to reduce
       the index size.

  </li><li> The index cannot be used to optimize LIKE patterns if the LIKE operator
       has an ESCAPE clause.
</li></ul>

<h2 tags="FTS5 content option" id="external_content_and_contentless_tables"><span>4.4. </span>External Content and Contentless Tables</h2>

<p>
Normally, when a row is inserted into an FTS5 table, in addition to building
the index, FTS5 makes a copy of the original row content.
When column values are requested from the FTS5 table by the user or by an
auxiliary function implementation, those values are
read from that private copy of the content.  The "content" option may be used
to create an FTS5 table that stores only FTS full-text index entries.
Because the column values themselves are usually much larger than the
associated full-text index entries, this can save significant database space.

</p><p>
There are two ways to use the "content" option:
</p><ul>
  <li> By setting it to an empty string to create a contentless FTS5 table. In
       this case FTS5 assumes that the original column values are unavailable
       to it when processing queries. Full-text queries and some auxiliary
       functions can still be used, but no column values apart from the rowid
       may be read from the table.

  </li><li> By setting it to the name of a database object (table, virtual table or
       view) that may be queried by FTS5 at any time to retrieve the column
       values. This is known as an "external content" table. In this case all
       FTS5 functionality may be used, but it is the responsibility of the user
       to ensure that the contents of the full-text index are consistent with
       the named database object. If they are not, query results may be
       unpredictable.
</li></ul>

<h3 tags="FTS5 contentless tables" id="contentless_tables"><span>4.4.1. </span>Contentless Tables</h3>

<p> A contentless FTS5 table is created by setting the "content" option to
an empty string. For example:

</p><div><pre>CREATE VIRTUAL TABLE f1 USING fts5(a, b, c, content='');
</pre></div>

<p> Contentless FTS5 tables do not support UPDATE or DELETE statements, or
INSERT statements that do not supply a non-NULL value for the rowid field.
Contentless tables do not support REPLACE conflict handling. REPLACE
and INSERT OR REPLACE statements are treated as regular INSERT statements.
Rows may be deleted from a contentless table using an <a href="https://www.sqlite.org/fts5.html#the_delete_command">FTS5 delete command</a>.

</p><p> Attempting to read any column value except the rowid from a contentless
FTS5 table returns an SQL NULL value.

<a name="clssdeltab"></a>

</p><h3 tags="FTS5 contentless-delete tables" id="contentless_delete_tables"><span>4.4.2. </span>Contentless-Delete Tables</h3>

<p>As of version 3.43.0, also available are contentless-delete tables.
A contentless-delete table is created by setting the content option to an
empty string and also setting the contentless_delete option to 1. For example:

</p><div><pre>CREATE VIRTUAL TABLE f1 USING fts5(a, b, c, content='', contentless_delete=1);
</pre></div>

<p>A contentless-delete table differs from a contentless table in that:

</p><ul>
  <li> Contentless-delete tables support both DELETE and "INSERT OR REPLACE
       INTO" statements.
  </li><li> Contentless-delete tables support UPDATE statements, but only if new
       values are supplied for all user-defined columns of the fts5 table.
  </li><li> Contentless-delete tables do <b>not</b> support the 
       <a href="https://www.sqlite.org/fts5.html#the_delete_command">FTS5 delete command</a>.
</li></ul>

<div><pre><i>-- Supported UPDATE statement:</i>
UPDATE f1 SET a=?, b=?, c=? WHERE rowid=?;

<i>-- This UPDATE is not supported, as it does not supply a new value</i>
<i>-- for column "c".</i>
UPDATE f1 SET a=?, b=? WHERE rowid=?;
</pre></div>

<p> Unless backwards compatibility is required, new code should prefer
contentless-delete tables to contentless tables.

</p><h3 tags="FTS5 external content tables" id="external_content_tables"><span>4.4.3. </span>External Content Tables</h3>

<p> An external content FTS5 table is created by setting the content
option to the name of a table, virtual table or view (hereafter the "content
table") within the same database. Whenever column values are required by
FTS5, it queries the content table as follows, with the rowid of the row
for which values are required bound to the SQL variable:

</p><div><pre>SELECT &lt;content_rowid&gt;, &lt;cols&gt; FROM &lt;content&gt; WHERE &lt;content_rowid&gt; = ?;
</pre></div>

<p> In the above, &lt;content&gt; is replaced by the name of the content table.
By default, &lt;content_rowid&gt; is replaced by the literal text "rowid". Or,
if the "content_rowid" option is set within the CREATE VIRTUAL TABLE statement,
by the value of that option. &lt;cols&gt; is replaced by a comma-separated list
of the FTS5 table column names. For example:

</p><div><pre><i>-- If the database schema is: </i>
CREATE TABLE tbl (a, b, c, d INTEGER PRIMARY KEY);
CREATE VIRTUAL TABLE fts USING fts5(a, c, content=tbl, content_rowid=d);

<i>-- Fts5 may issue queries such as:</i>
SELECT d, a, c FROM tbl WHERE d = ?;
</pre></div>

<p> The content table may also be queried as follows:

</p><div><pre>SELECT &lt;content_rowid&gt;, &lt;cols&gt; FROM &lt;content&gt; ORDER BY &lt;content_rowid&gt; ASC;
SELECT &lt;content_rowid&gt;, &lt;cols&gt; FROM &lt;content&gt; ORDER BY &lt;content_rowid&gt; DESC;
</pre></div>

<p> It is still the responsibility of the user to ensure that the contents of
an external content FTS5 table are kept up to date with the content table.
One way to do this is with triggers. For example:

</p><div><pre><i>-- Create a table. And an external content fts5 table to index it.</i>
CREATE TABLE tbl(a INTEGER PRIMARY KEY, b, c);
CREATE VIRTUAL TABLE fts_idx USING fts5(b, c, content='tbl', content_rowid='a');

<i>-- Triggers to keep the FTS index up to date.</i>
CREATE TRIGGER tbl_ai AFTER INSERT ON tbl BEGIN
  INSERT INTO fts_idx(rowid, b, c) VALUES (new.a, new.b, new.c);
END;
CREATE TRIGGER tbl_ad AFTER DELETE ON tbl BEGIN
  INSERT INTO fts_idx(fts_idx, rowid, b, c) VALUES('delete', old.a, old.b, old.c);
END;
CREATE TRIGGER tbl_au AFTER UPDATE ON tbl BEGIN
  INSERT INTO fts_idx(fts_idx, rowid, b, c) VALUES('delete', old.a, old.b, old.c);
  INSERT INTO fts_idx(rowid, b, c) VALUES (new.a, new.b, new.c);
END;
</pre></div>

<p> Like contentless tables, external content tables do not support REPLACE
conflict handling. Any operations that specify REPLACE conflict handling are
handled using ABORT.

</p><h3 tags="FTS5 external content pitfalls" id="external_content_table_pitfalls"><span>4.4.4. </span>External Content Table Pitfalls</h3>

<p>
It is the responsibility of the user to ensure that an FTS5 external content
table (one with a non-empty content= option) is kept consistent with the
content table itself (the table named by the content= option). If these are
allowed to become inconsistent, then the results of queries against the FTS5
table may become unintuitive and appear inconsistent.

</p><p>
In these situations, the apparently inconsistent results produced by queries
against the FTS5 external content table may be understood as follows:

</p><ul>
  <li><p> If the query does not use the full-text index - does not contain a 
  MATCH operator or equivalent table-valued function syntax - then the
  query is effectively passed through to the external content table. In
  this case the contents of the FTS index have no effect on the results
  of the query.

  </p></li><li><p> If the query does use the full text index, then the FTS5 module
  queries it for the set of rowid values corresponding to documents that match
  the query. For each such rowid, it then runs a query similar to the following
  to retrieve any required column values, where '?' is replaced by the rowid
  value, and &lt;content&gt; and &lt;content_rowid&gt; by the values specified
  for the content= and content_rowid= options:
</p></li></ul>

<div><pre>SELECT &lt;content_rowid&gt;, &lt;cols&gt; FROM &lt;content&gt; WHERE &lt;content_rowid&gt; = ?;
</pre></div>

<p>
For example, if a database is created using the following script:

</p><div><pre><i>-- Create and populate a table. </i>
CREATE TABLE tbl(a INTEGER PRIMARY KEY, t TEXT);
INSERT INTO tbl VALUES(1, 'all that glitters');
INSERT INTO tbl VALUES(2, 'is not gold');

<i>-- Create an external content FTS5 table </i>
CREATE VIRTUAL TABLE ft USING fts5(t, content='tbl', content_rowid='a');
</pre></div>

<p>then the content table contains two rows, but the FTS index contains no
entries corresponding to them. In this case the following queries will return
inconsistent results as follows:

</p><div><pre><i>-- Returns 2 rows.  Because the query does not use the FTS index, it is</i>
<i>-- effectively executed against table 'tbl' directly, and so returns</i>
<i>-- both rows.</i>
SELECT * FROM t1;

<i>-- Returns 0 rows.  This query does use the FTS index, which currently</i>
<i>-- contains no entries. So it returns 0 rows.</i>
SELECT rowid, t FROM t1('gold')
</pre></div>

<p>
Alternatively, if the database were created and populated as follows:

</p><div><pre><i>-- Create and populate a table. </i>
CREATE TABLE tbl(a INTEGER PRIMARY KEY, t TEXT);

<i>-- Create an external content FTS5 table </i>
CREATE VIRTUAL TABLE ft USING fts5(t, content='tbl', content_rowid='a');
INSERT INTO ft(rowid, t) VALUES(1, 'all that glitters');
INSERT INTO ft(rowid, t) VALUES(2, 'is not gold');
</pre></div>

<p>then the content table is empty, but the FTS index contains entries for
6 different tokens. In this case the following queries will return
inconsistent results as follows:

</p><div><pre><i>-- Returns 0 rows.  Since it does not use the FTS index, the query is</i>
<i>-- passed directly through to table 'tbl', which contains no data.</i>
SELECT * FROM t1;

<i>-- Returns 1 row. The "rowid" field of the returned row is 2, and</i>
<i>-- the "t" field set to NULL. "t" is set to NULL because when the external</i>
<i>-- content table "tbl" was queried for the data associated with the row</i>
<i>-- with a=2 ("a" is the content_rowid column), none could be found.</i>
SELECT rowid, t FROM t1('gold')
</pre></div>

<p>As described in the previous section, triggers on the content table are
a good way to ensure that an FTS5 external content table is kept consistent.
However, triggers are only fired when rows are inserted, updated or deleted
in the content table. This means that if, for example, a database is created
as follows:

</p><div><pre><i>-- Create and populate a table. </i>
CREATE TABLE tbl(a INTEGER PRIMARY KEY, t TEXT);
INSERT INTO tbl VALUES(1, 'all that glitters');
INSERT INTO tbl VALUES(2, 'is not gold');

<i>-- Create an external content FTS5 table </i>
CREATE VIRTUAL TABLE ft USING fts5(t, content='tbl', content_rowid='a');

<i>-- Create triggers to keep the FTS5 table up to date</i>
CREATE TRIGGER tbl_ai AFTER INSERT ON tbl BEGIN
  INSERT INTO ft(rowid, t) VALUES (new.a, new.t);
END;
&lt;similar triggers for update + delete&gt;
</pre></div>

<p>then the content table and external content FTS5 table are inconsistent, as
creating the triggers does not copy existing rows from the content table
into the FTS index. The triggers are only able to ensure that updates made to
the content table after they are created are reflected in the FTS index.

</p><p>In this, and any other situation where the FTS index and its content table
have become inconsistent, the <a href="#the_rebuild_command">'rebuild'</a>
command may be used to completely discard the contents of the FTS index and
rebuild it based on the current contents of the content table.

</p><h2 tags="FTS5 columnsize option" id="the_columnsize_option"><span>4.5. </span>The Columnsize Option</h2>

<p>Normally, FTS5 maintains a special backing table within the database that
stores the size of each column value in tokens inserted into the main FTS5
table in a separate table. This backing table is used by the
<a href="#xColumnSize">xColumnSize</a><a> API function, which is in turn used by
the built-in </a><a href="https://www.sqlite.org/fts5.html#the_bm25_function">bm25 ranking function</a> (and is likely to be useful
to other ranking functions as well).

</p><p>In order to save space, this backing table may be omitted by setting the
columnsize option to zero. For example:

</p><div><pre><i>-- A table without the xColumnSize() values stored on disk:</i>
CREATE VIRTUAL TABLE ft USING fts5(a, b, c, columnsize=0);

<i>-- Three equivalent ways of creating a table that does store the</i>
<i>-- xColumnSize() values on disk:</i>
CREATE VIRTUAL TABLE ft USING fts5(a, b, c);
CREATE VIRTUAL TABLE ft USING fts5(a, b, c, columnsize=1);
CREATE VIRTUAL TABLE ft USING fts5(a, b, columnsize='1', c);
</pre></div>

<p> It is an error to set the columnsize option to any value other than
0 or 1.

</p><p> If an FTS5 table is configured with columnsize=0 but is not a
<a href="https://www.sqlite.org/fts5.html#contentless_tables">contentless table</a>, the xColumnSize API function
still works, but runs much more slowly. In this case, instead of reading
the value to return directly from the database, it reads the text value
itself and count the tokens within it on demand.

</p><p>Or, if the table is also a <a href="https://www.sqlite.org/fts5.html#contentless_tables">contentless table</a>,
then the following apply:

</p><ul>
  <li> <p>The xColumnSize API always returns -1. There is no way to determine
       the number of tokens in a value stored within a contentless FTS5 table
       configured with columnsize=0.

  </p></li><li> <p>Each inserted row must be accompanied by an explicitly specified rowid
       value. If a contentless table is configured with columnsize=0,
       attempting to insert a NULL value into the rowid is an SQLITE_MISMATCH
       error.

  </p></li><li> <p>All queries on the table must be full-text queries. In other words,
       they must use the MATCH or = operator with the table-name column as the
       left-hand operand, or else use the table-valued function syntax. Any
       query that is not a full-text query results in an error.
</p></li></ul>

<p> The name of the table in which the xColumnSize values are stored
(unless columnsize=0 is specified) is "&lt;name&gt;_docsize", where
&lt;name&gt; is the name of the FTS5 table itself. The
<a href="https://www.sqlite.org/download.html">sqlite3_analyzer</a>
tool may be used on an existing database in order to determine how much
space might be saved by recreating an FTS5 table using columnsize=0.

</p><h2 tags="FTS5 detail option" id="the_detail_option"><span>4.6. </span>The Detail Option</h2>

<p> For each term in a document, the FTS index maintained by FTS5
stores the rowid of the document, the column number of the column that contains
the term and the offset of the term within the column value. The "detail"
option may be used to omit some of this information. This reduces the space
that the index consumes within the database file, but also reduces the
capability and efficiency of the system.

</p><p> The detail option may be set to "full" (the default value), "column" or
"none". For example:

</p><div><pre><i>-- The following two lines are equivalent (because the default value</i>
<i>-- of "detail" is "full". </i>
CREATE VIRTUAL TABLE ft1 USING fts5(a, b, c);
CREATE VIRTUAL TABLE ft1 USING fts5(a, b, c, detail=full);

CREATE VIRTUAL TABLE ft2 USING fts5(a, b, c, detail=column);
CREATE VIRTUAL TABLE ft3 USING fts5(a, b, c, detail=none);
</pre></div>

<p>If the detail option is set to <b>column</b>, then for each term the FTS
index records the rowid and column number only, omitting the term offset
information. This results in the following restrictions:

</p><ul>
  <li> NEAR queries are not available.
  </li><li> Phrase queries are not available.
  </li><li> Assuming the table is not also a
  <a href="https://www.sqlite.org/fts5.html#contentless_tables">contentless table</a>, the
  <a href="#xInstCount">xInstCount</a>, <a href="#xInst">xInst</a>,
  <a href="#xPhraseFirst">xPhraseFirst</a> and <a href="#xPhraseNext">xPhraseNext</a>
  are slower than usual. This is because instead of reading the required data
  directly from the FTS index they have to load and tokenize the document text
  on demand.
  </li><li> If the table is also a contentless table, the xInstCount, xInst,
  xPhraseFirst and xPhraseNext APIs behave as if the current row contains no
  phrase matches at all (i.e. xInstCount() returns 0).
</li></ul>

<p>If the detail option is set to <b>none</b>, then for each term the FTS
index records just the rowid is stored. Both column and offset information
are omitted. As well as the restrictions itemized above for detail=column
mode, this imposes the following extra limitations:

</p><ul>
  <li> Column filter queries are not available.
  </li><li> Assuming the table is not also a contentless table, the
  <a href="#xPhraseFirstColumn">xPhraseFirstColumn</a> and
  <a href="#xPhraseNextColumn">xPhraseNextColumn</a> are slower than usual.

  </li><li> If the table is also a contentless table, the xPhraseFirstColumn and
  xPhraseNextColumn APIs behave as if the current row contains no phrase
  matches at all (i.e. xPhraseFirstColumn() sets the iterator to EOF).
</li></ul>

<p> In one test that indexed a large set of emails (1636 MiB on disk), the FTS
index was 743 MiB on disk with detail=full, 340 MiB with detail=column and 134
MiB with detail=none.

</p><h2 tags="FTS5 tokendata option" id="the_tokendata_option"><span>4.7. </span>The Tokendata Option</h2>

<p>This option is only useful to applications that implement 
<a href="#custom_tokenizers">custom tokenizers</a>. Usually, tokenizers may
return tokens that consist of any sequence of bytes, including 0x00 bytes.
However, if the table specifies the tokendata=1 option, then fts5 ignores
the first 0x00 byte and any trailing data in the token for the purposes
of matching. It still stores the entire token as returned by the tokenizer,
but it is ignored by the fts5 core.

</p><p>The full version of the token, including any 0x00 byte and trailing data,
is available to <a href="#custom_auxiliary_functions">custom auxiliary 
functions</a> via the <a href="#xQueryToken">xQueryToken</a> and 
<a href="#xInstToken">xInstToken</a> APIs. 

</p><p>This may be useful for ranking functions. A custom tokenizer may
add extra data to some document tokens allowing a ranking function to give
more weight to hits of some tokens (e.g. those in document headings).

</p><p>Alternatively, the combination of a custom tokenizer and a custom auxiliary
function may be used to implement 
<a href="https://www.unicode.org/reports/tr10/tr10-41.html#Asymmetric_Search">
asymmetric search</a>. The tokenizer could (say) for each document token return
the case-normalized and unmarked version of the token, followed by an 0x00
byte, followed by the full text of the token from the document. When queried,
fts5 would provide results as if all characters in the query were
case-normalized and unmarked. The custom auxiliary function could then be used
in the WHERE clause of the query to filter out any rows that do not match based
on secondary or tertiary markings in the document or query terms.

</p><h2 tags="FTS5 auxiliary functions" id="_auxiliary_functions_"><span>5. </span> Auxiliary Functions </h2>

<p> Auxiliary functions are similar to <a href="https://www.sqlite.org/lang_corefunc.html">SQL scalar functions</a>,
except that they may only be used within full-text queries (those that use
the MATCH operator, or LIKE/GLOB with the trigram tokenizer) on an FTS5 table.
Their results are calculated based not only on the arguments passed to them,
but also on the current match and matched row. For example, an auxiliary
function may return a numeric value indicating the accuracy of the match (see
the <a href="https://www.sqlite.org/fts5.html#the_bm25_function">bm25()</a> function), or a fragment of text from the matched row
that contains one or more instances of the search terms (see the <a href="https://www.sqlite.org/fts5.html#the_snippet_function">snippet()</a> function).

</p><p>To invoke an auxiliary function, the name of the FTS5 table should be
specified as the first argument. Other arguments may follow the first,
depending on the specific auxiliary function being invoked. For example, to
invoke the "highlight" function:

</p><div><pre>SELECT highlight(email, 2, '&lt;b&gt;', '&lt;/b&gt;') FROM email WHERE email MATCH 'fts5'
</pre></div>

<p>The built-in auxiliary functions provided as part of FTS5 are described in
the following section. Applications may also implement
<a href="https://www.sqlite.org/fts5.html#custom_auxiliary_functions">custom auxiliary functions in C</a>.

</p><h2 id="built_in_auxiliary_functions"><span>5.1. </span>Built-in Auxiliary Functions</h2>

<p> FTS5 provides three built-in auxiliary functions:

</p><ul>
  <li> The <a href="https://www.sqlite.org/fts5.html#the_bm25_function">bm25() auxiliary function</a> returns a real value
       reflecting the accuracy of the current match. Better matches are
       assigned numerically lower values.

  </li><li> The <a href="https://www.sqlite.org/fts5.html#the_highlight_function">highlight() auxiliary function</a> returns a copy
       of the text from one of the columns of the current match with each
       instance of a queried term within the result surrounded by specified
       markup (for example "&lt;b&gt;" and "&lt;/b&gt;").

  </li><li> The <a href="https://www.sqlite.org/fts5.html#the_snippet_function">snippet() auxiliary function</a> selects a short
       fragment of text from one of the columns of the matched row and returns
       it with each instance of a queried term surrounded by markup in
       the same manner as the highlight() function. The fragment of text is
       selected so as to maximize the number of distinct queried terms it
       contains. Higher weight is given to snippets that occur at the start
       of a column value, or that immediately follow "." or ":" characters
       in the text.
</li></ul>

<h3 tags="FTS5 bm25" id="the_bm25_function"><span>5.1.1. </span>The bm25() function</h3>

<p> The built-in auxiliary function bm25() returns a real value indicating
how well the current row matches the full-text query. The better the match,
the numerically smaller the value returned. A query such as the following may
be used to return matches in order from best to worst match:

</p><div><pre>SELECT * FROM fts WHERE fts MATCH ? ORDER BY bm25(fts)
</pre></div>

<p> In order to calculate a documents score, the full-text query is separated
    into its component phrases. The bm25 score for document <i>D</i> and
    query <i>Q</i> is then calculated as follows:

</p><p> <img src="https://www.sqlite.org/images/fts5_formula1.png">

</p><p> In the above, <i>nPhrase</i> is the number of phrases in the query.
    <i>|D|</i> is the number of tokens in the current document, and
    <i>avgdl</i> is the average number of tokens in all documents within the
    FTS5 table.  <i>k<sub>1</sub></i> and <i>b</i> are both constants,
    hard-coded at 1.2 and 0.75 respectively.

</p><p> The "-1" term at the start of the formula is not found in most
implementations of the BM25 algorithm. Without it, a better match is assigned
a numerically higher BM25 score. Since the default sorting order is
"ascending", this means that appending "ORDER BY bm25(fts)" to a query would
cause results to be returned in order from worst to best. The "DESC" keyword
would be required in order to return the best matches first. In order to
avoid this pitfall, the FTS5 implementation of BM25 multiplies the result
by -1 before returning it, ensuring that better matches are assigned
numerically lower scores.

</p><p> <i>IDF(q<sub>i</sub>)</i> is the inverse-document-frequency of query
    phrase <i>i</i>. It is calculated as follows, where <i>N</i> is the total
    number of rows in the FTS5 table and <i>n(q<sub>i</sub>)</i> is the total
    number of rows that contain at least one instance of phrase <i>i</i>:

</p><p> <img src="https://www.sqlite.org/images/fts5_formula2.png">

</p><p> Finally, <i>f(q<sub>i</sub>,D)</i> is the phrase frequency of phrase
<i>i</i>. By default, this is simply the number of occurrences of the phrase
within the current row. However, by passing extra real value arguments to
the bm25() SQL function, each column of the table may be assigned a different
weight and the phrase frequency calculated as follows:

</p><p> <img src="https://www.sqlite.org/images/fts5_formula3.png">

</p><p> where <i>w<sub>c</sub></i> is the weight assigned to column <i>c</i> and
<i>n(q<sub>i</sub>,c)</i> is the number of occurrences of phrase <i>i</i> in
column <i>c</i> of the current row. The first argument passed to bm25()
following the table name is the weight assigned to the leftmost column of
the FTS5 table. The second is the weight assigned to the second leftmost
column, and so on. If there are not enough arguments for all table columns,
remaining columns are assigned a weight of 1.0. If there are too many
trailing arguments, the extras are ignored. For example:

</p><div><pre><i>-- Assuming the following schema:</i>
CREATE VIRTUAL TABLE email USING fts5(sender, title, body);

<i>-- Return results in bm25 order, with each phrase hit in the "sender"</i>
<i>-- column considered the equal of 10 hits in the "body" column, and</i>
<i>-- each hit in the "title" column considered as valuable as 5 hits in</i>
<i>-- the "body" column.</i>
SELECT * FROM email WHERE email MATCH ? ORDER BY bm25(email, 10.0, 5.0);
</pre></div>

<p>Refer to wikipedia for
<a href="https://en.wikipedia.org/wiki/Okapi_BM25">more information regarding
BM25</a> and its variants.

</p><h3 tags="FTS5 highlight" id="the_highlight_function"><span>5.1.2. </span>The highlight() function</h3>

<p> The highlight() function returns a copy of the text from a specified
column of the current row with extra markup text inserted to mark the start
and end of phrase matches.

</p><p>The highlight() must be invoked with exactly three arguments following
the table name. To be interpreted as follows:

</p><ol>
  <li> An integer indicating the index of the FTS table column to read the
       text from. Columns are numbered from left to right starting at zero.

  </li><li> The text to insert before each phrase match.

  </li><li> The text to insert after each phrase match.
</li></ol>

<p>For example:

</p><div><pre><i>-- Return a copy of the text from the leftmost column of the current</i>
<i>-- row, with phrase matches marked using html "b" tags.</i>
SELECT highlight(fts, 0, '&lt;b&gt;', '&lt;/b&gt;') FROM fts WHERE fts MATCH ?
</pre></div>

<p>In cases where two or more phrase instances overlap (share one or more
tokens in common), a single open and close marker is inserted for each set
of overlapping phrases. For example:

</p><div><pre><i>-- Assuming this:</i>
CREATE VIRTUAL TABLE ft USING fts5(a);
INSERT INTO ft VALUES('a b c x c d e');
INSERT INTO ft VALUES('a b c c d e');
INSERT INTO ft VALUES('a b c d e');

<i>-- The following SELECT statement returns these three rows:</i>
<i>--   '[a b c] x [c d e]'</i>
<i>--   '[a b c] [c d e]'</i>
<i>--   '[a b c d e]'</i>
SELECT highlight(ft, 0, '[', ']') FROM ft WHERE ft MATCH 'a+b+c AND c+d+e';
</pre></div>

<h3 tags="FTS5 snippet" id="the_snippet_function"><span>5.1.3. </span>The snippet() function</h3>

<p>The snippet() function is similar to highlight(), except that instead of
returning entire column values, it automatically selects and extracts a
short fragment of document text to process and return. The snippet() function
must be passed five parameters following the table name argument:

</p><ol>
  <li> An integer indicating the index of the FTS table column to select
       the returned text from. Columns are numbered from left to right
       starting at zero. A negative value indicates that the column should
       be automatically selected.

  </li><li> The text to insert before each phrase match within the returned text.

  </li><li> The text to insert after each phrase match within the returned text.

  </li><li> The text to add to the start or end of the selected text to indicate
       that the returned text does not occur at the start or end of its column,
       respectively.

  </li><li> The maximum number of tokens in the returned text. This must be greater
       than zero and equal to or less than 64.
</li></ol>

<h2 tags="auxiliary function mapping" id="sorting_by_auxiliary_function_results"><span>5.2. </span>Sorting by Auxiliary Function Results</h2>

<p> All FTS5 tables feature a special hidden column named "rank". If the
current query is not a full-text query (i.e. if it does not include a MATCH
operator), the value of the "rank" column is always NULL. Otherwise, in a
full-text query, column rank contains by default the same value as would be
returned by executing the bm25() auxiliary function with no trailing
arguments.

</p><p> The difference between reading from the rank column and using the bm25()
function directly within the query is only significant when sorting by the
returned value. In this case, using "rank" is faster than using bm25().

</p><div><pre><i>-- The following queries are logically equivalent. But the second may</i>
<i>-- be faster, particularly if the caller abandons the query before</i>
<i>-- all rows have been returned (or if the queries were modified to </i>
<i>-- include LIMIT clauses).</i>
SELECT * FROM fts WHERE fts MATCH ? ORDER BY bm25(fts);
SELECT * FROM fts WHERE fts MATCH ? ORDER BY rank;
</pre></div>

<p> Instead of using bm25() with no trailing arguments, the specific auxiliary
function mapped to the rank column may be configured either on a per-query
basis, or by setting a different persistent default for the FTS table.

</p><p> In order to change the mapping of the rank column for a single query,
a term similar to either of the following is added to the WHERE clause of a
query:

</p><div><pre>rank MATCH 'auxiliary-function-name(arg1, arg2, ...)'
rank = 'auxiliary-function-name(arg1, arg2, ...)'
</pre></div>

<p> The right-hand-side of the MATCH or = operator must be a constant
expression that evaluates to a string consisting of the auxiliary function to
invoke, followed by zero or more comma separated arguments within parenthesis.
Arguments must be SQL literals. For example:

</p><div><pre><i>-- The following queries are logically equivalent. But the second may</i>
<i>-- be faster. See above. </i>
SELECT * FROM fts WHERE fts MATCH ? ORDER BY bm25(fts, 10.0, 5.0);
SELECT * FROM fts WHERE fts MATCH ? AND rank MATCH 'bm25(10.0, 5.0)' ORDER BY rank;
</pre></div>

<p> The table-valued function syntax may also be used to specify an alternative
ranking function. In this case the text describing the ranking function should
be specified as the second table-valued function argument. The following three
queries are equivalent:

</p><div><pre>SELECT * FROM fts WHERE fts MATCH ? AND rank MATCH 'bm25(10.0, 5.0)' ORDER BY rank;
SELECT * FROM fts WHERE fts = ? AND rank = 'bm25(10.0, 5.0)' ORDER BY rank;
SELECT * FROM fts WHERE fts(?, 'bm25(10.0, 5.0)') ORDER BY rank;
</pre></div>

<p> The default mapping of the rank column for a table may be modified
using the <a href="https://www.sqlite.org/fts5.html#the_rank_configuration_option">FTS5 rank configuration option</a>.

</p><h2 id="special_insert_commands"><span>6. </span>Special INSERT Commands</h2>

<h2 tags="FTS5 automerge option" id="the_automerge_configuration_option"><span>6.1. </span>The 'automerge' Configuration Option</h2>

<p>
  Instead of using a single data structure on disk to store the full-text
  index, FTS5 uses a series of b-trees. Each time a new transaction is
  committed, a new b-tree containing the contents of the committed transaction
  is written into the database file. When the full-text index is queried, each
  b-tree must be queried individually and the results merged before being
  returned to the user.

</p><p>
  In order to prevent the number of b-trees in the database from becoming too
  large (slowing down queries), smaller b-trees are periodically merged into
  single larger b-trees containing the same data. By default, this happens
  automatically within INSERT, UPDATE or DELETE statements that modify the
  full-text index. The 'automerge' parameter determines how many smaller
  b-trees are merged together at a time. Setting it to a small value can
  speed up queries (as they have to query and merge the results from fewer
  b-trees), but can also slow down writing to the database (as each INSERT,
  UPDATE or DELETE statement has to do more work as part of the automatic
  merging process).

</p><p>
  Each of the b-trees that make up the full-text index is assigned to a "level"
  based on its size. Level-0 b-trees are the smallest, as they contain the
  contents of a single transaction. Higher level b-trees are the result of
  merging two or more level-0 b-trees together and so they are larger. FTS5
  begins to merge b-trees together once there exist <i>M</i> or more b-trees
  with the same level, where <i>M</i> is the value of the 'automerge'
  parameter.

</p><p>
  The maximum allowed value for the 'automerge' parameter is 16. The default
  value is 4. Setting the 'automerge' parameter to 0 disables the automatic
  incremental merging of b-trees altogether.

</p><div><pre>INSERT INTO ft(ft, rank) VALUES('automerge', 8);
</pre></div>

<h2 id="the_crisismerge_configuration_option"><span>6.2. </span>The 'crisismerge' Configuration Option</h2>

<p>The 'crisismerge' option is similar to 'automerge', in that it determines
how and how often the component b-trees that make up the full-text index are
merged together. Once there exist <i>C</i> or more b-trees on a single level
within the full-text index, where <i>C</i> is the value of the 'crisismerge'
option, all b-trees on the level are immediately merged into a single b-tree.

</p><p>The difference between this option and the 'automerge' option is that when
the 'automerge' limit is reached FTS5 only begins to merge the b-trees
together. Most of the work is performed as part of subsequent INSERT,
UPDATE or DELETE operations. Whereas when the 'crisismerge' limit is reached,
the offending b-trees are all merged immediately. This means that an INSERT,
UPDATE or DELETE that triggers a crisis-merge may take a long time to
complete.

</p><p>The default 'crisismerge' value is 16. There is no maximum limit. Attempting
to set the 'crisismerge' parameter to a value of 0 or 1 is equivalent to
setting it to the default value (16). It is an error to attempt to set the
'crisismerge' option to a negative value.

</p><div><pre>INSERT INTO ft(ft, rank) VALUES('crisismerge', 16);
</pre></div>

<h2 tags="FTS5 delete command" id="the_delete_command"><span>6.3. </span>The 'delete' Command</h2>

<p> This command is only available with <a href="https://www.sqlite.org/fts5.html#external_content_tables">external content</a> and <a href="https://www.sqlite.org/fts5.html#contentless_tables">contentless</a> tables. It
is used to delete the index entries associated with a single row from the
full-text index. This command and the <a href="https://www.sqlite.org/fts5.html#the_delete_all_command">delete-all</a>
command are the only ways to remove entries from the full-text index of a
contentless table.

</p><p> In order to use this command to delete a row, the text value 'delete'
must be inserted into the special column with the same name as the table.
The rowid of the row to delete is inserted into the rowid column. The
values inserted into the other columns must match the values currently
stored in the table. For example:

</p><div><pre><i>-- Insert a row with rowid=14 into the fts5 table.</i>
INSERT INTO ft(rowid, a, b, c) VALUES(14, $a, $b, $c);

<i>-- Remove the same row from the fts5 table.</i>
INSERT INTO ft(ft, rowid, a, b, c) VALUES('delete', 14, $a, $b, $c);
</pre></div>

<p> If the values "inserted" into the text columns as part of a 'delete'
command are not the same as those currently stored within the table, the
results may be unpredictable.

</p><p> The reason for this is easy to understand: When a document is inserted
into the FTS5 table, an entry is added to the full-text index to record the
position of each token within the new document. When a document is removed,
the original data is required in order to determine the set of entries that
need to be removed from the full-text index. So if the data supplied to FTS5
when a row is deleted using this command is different from that used to
determine the set of token instances when it was inserted, some full-text
index entries may not be correctly deleted, or FTS5 may try to remove index
entries that do not exist. This can leave the full-text index in an
unpredictable state, making future query results unreliable.

</p><h2 tags="FTS5 delete-all command" id="the_delete_all_command"><span>6.4. </span>The 'delete-all' Command</h2>

<p> This command is only available with <a href="https://www.sqlite.org/fts5.html#external_content_tables">external content</a> and <a href="https://www.sqlite.org/fts5.html#contentless_tables">contentless</a> tables (including
<a href="https://www.sqlite.org/fts5.html#contentless_delete_tables">contentless-delete</a> tables. It deletes all
entries from the full-text index.

</p><div><pre>INSERT INTO ft(ft) VALUES('delete-all');
</pre></div>

<h2 tags="deletemerge" id="the_deletemerge_configuration_option"><span>6.5. </span>The 'deletemerge' Configuration Option</h2>

<p> The 'deletemerge' option is only used by 
<a href="https://www.sqlite.org/fts5.html#contentless_delete_tables">contentless-delete</a> tables. 

</p><p> When a row is deleted from a contentless-delete table, the entries
associated with its tokens are not immediately removed from the FTS index.
Instead, a "tombstone" marker containing the rowid of the deleted row is
attached to the b-tree that contains the row's FTS index entries. When the
b-tree is queried, any query result rows for which there exist tombstone
markers are omitted from the results. When the b-tree is merged with other
b-trees, both the deleted rows and their tombstone markers are discarded.

</p><p> This option specifies a minimum percentage of rows in a b-tree that must
have tombstone markers before the b-tree is made eligible for merging -
either by <a href="#the_automerge_configuration_option">automatic</a> merges or
explicit user <a href="https://www.sqlite.org/the_merge_command">'merge'</a> commands - even if it
does not meet the usual criteria as determined by the 'automerge' and 
<a href="#the_usermerge_configuration_option">'usermerge'</a> options.

</p><p> For example, to specify that FTS5 should consider merging a component
b-tree after 15% of its rows have associated tombstone markers:

</p><div><pre>INSERT INTO ft(ft, rank) VALUES('deletemerge', 15);
</pre></div>

<p> The default value of this option is 10. Attempting to set it to less than 
zero restores the default value. Setting this option to 0 or to greater than
100 ensures that b-trees are never made eligible for merging due to tombstone
markers.

</p><h2 id="the_integrity_check_command"><span>6.6. </span>The 'integrity-check' Command</h2>

<p> This command is used to verify that the full-text index is internally
consistent, and, optionally, that it is consistent with any
<a href="https://www.sqlite.org/fts5.html#external_content_tables">external content</a> table.

</p><p>The integrity-check command is invoked by inserting the text value
'integrity-check' into the special column with the same name as the FTS5
table. If a value is supplied for the "rank" column, it must be either
0 or 1. For example:

</p><div><pre>INSERT INTO ft(ft) VALUES('integrity-check');
INSERT INTO ft(ft, rank) VALUES('integrity-check', 0);
INSERT INTO ft(ft, rank) VALUES('integrity-check', 1);
</pre></div>

<p>The three forms above are equivalent for all FTS tables that are
not external content tables. They check that the index data structures are
not corrupt, and, if the FTS table is not contentless, that the contents of
the index match the contents of the table itself.

</p><p>For an external content table, the contents of the index are only
compared to the contents of the external content table if the value
specified for the rank column is 1.

</p><p>In all cases, if any discrepancies are found, the command fails
with an <a href="https://www.sqlite.org/rescode.html#corrupt_vtab">SQLITE_CORRUPT_VTAB</a> error.

</p><h2 tags="FTS5 merge command" id="the_merge_command"><span>6.7. </span>The 'merge' Command</h2>

<div><pre>INSERT INTO ft(ft, rank) VALUES('merge', 500);
</pre></div>

<p> This command merges b-tree structures together until roughly N pages
of merged data have been written to the database, where N is the absolute
value of the parameter specified as part of the 'merge' command. The size of
each page is as configured by the <a href="https://www.sqlite.org/fts5.html#the_pgsz_configuration_option">FTS5 pgsz option</a>.

</p><p> If the parameter is a positive value, B-tree structures are only eligible
for merging if one of the following is true:

</p><ul>
  <li> There are U or more such b-trees on a
       single level (see the documentation for the <a href="https://www.sqlite.org/fts5.html#the_automerge_configuration_option">FTS5 automerge option</a>
       for an explanation of b-tree levels), where U is the value assigned
       to the <a href="https://www.sqlite.org/fts5.html#the_usermerge_configuration_option">FTS5 usermerge option</a> option.
  </li><li> A merge has already been started (perhaps by a 'merge' command that
       specified a negative parameter).
</li></ul>

<p> It is possible to tell whether or not the 'merge' command found any
b-trees to merge together by checking the value returned by the
<a href="https://www.sqlite.org/c3ref/total_changes.html">sqlite3_total_changes()</a> API before and after the command is executed. If
the difference between the two values is 2 or greater, then work was performed.
If the difference is less than 2, then the 'merge' command was a no-op. In this
case there is no reason to execute the same 'merge' command again, at least
until after the FTS table is next updated.

</p><p> If the parameter is negative, and there are B-tree structures on more than
one level within the FTS index, all B-tree structures are assigned to the same
level before the merge operation is commenced. Additionally, if the parameter
is negative, the value of the usermerge configuration option is not
respected - as few as two b-trees from the same level may be merged together.

</p><p> The above means that executing the 'merge' command with a negative
parameter until the before and after difference in the return value of
<a href="https://www.sqlite.org/c3ref/total_changes.html">sqlite3_total_changes()</a> is less than two optimizes the FTS index in the
same way as the <a href="https://www.sqlite.org/fts5.html#the_optimize_command">FTS5 optimize command</a>. However, if a new b-tree is added
to the FTS index while this process is ongoing, FTS5 will move the new
b-tree to the same level as the existing b-trees and restart the merge. To
avoid this, only the first call to 'merge' should specify a negative parameter.
Each subsequent call to 'merge' should specify a positive value so that the
merge started by the first call is run to completion even if new b-trees are
added to the FTS index.

</p><h2 tags="FTS5 optimize command" id="the_optimize_command"><span>6.8. </span>The 'optimize' Command</h2>

<p>This command merges all individual b-trees that currently make up the
full-text index into a single large b-tree structure. This ensures that the
full-text index consumes the minimum space within the database and is in the
fastest form to query.

</p><p>Refer to the documentation for the <a href="https://www.sqlite.org/fts5.html#the_automerge_configuration_option">FTS5 automerge option</a> for more details
regarding the relationship between the full-text index and its component
b-trees.

</p><div><pre>INSERT INTO ft(ft) VALUES('optimize');
</pre></div>

<p>Because it reorganizes the entire FTS index, the optimize command can
take a long time to run. The <a href="https://www.sqlite.org/fts5.html#the_merge_command">FTS5 merge command</a> can be used to divide
the work of optimizing the FTS index into multiple steps. To do this:

</p><ul>
  <li> Invoke the 'merge' command once with the parameter set to -N, then
  </li><li> Invoke the 'merge' command zero or more times with the parameter set to N.
</li></ul>

<p>where N is the number of pages of data to merge within each invocation of
the merge command. The application should stop invoking merge when the
difference in the value returned by the sqlite3_total_changes() function before
and after the merge command drops to below two. The merge commands may be
issued as part of the same or separate transactions, and by the same or
different database clients. Refer to the documentation for the
<a href="https://www.sqlite.org/fts5.html#the_merge_command">merge command</a> for further details.

</p><h2 tags="FTS5 pgsz option" id="the_pgsz_configuration_option"><span>6.9. </span>The 'pgsz' Configuration Option</h2>

<p> This command is used to set the persistent "pgsz" option.

</p><p> The full-text index maintained by FTS5 is stored as a series of fixed-size
blobs in a database table. It is not strictly necessary for all blobs that make
up a full-text index to be the same size. The pgsz option determines the size
of all blobs created by subsequent index writers. The default value is 1000.

</p><div><pre>INSERT INTO ft(ft, rank) VALUES('pgsz', 4072);
</pre></div>

<h2 tags="FTS5 rank configuration option" id="the_rank_configuration_option"><span>6.10. </span>The 'rank' Configuration Option</h2>

<p> This command is used to set the persistent "rank" option.

</p><p> The rank option is used to change the default auxiliary function mapping
for the rank column. The option should be set to a text value in the same
format as described for <a href="https://www.sqlite.org/fts5.html#sorting_by_auxiliary_function_results">"rank MATCH ?"</a> terms
above. For example:

</p><div><pre>INSERT INTO ft(ft, rank) VALUES('rank', 'bm25(10.0, 5.0)');
</pre></div>

<h2 tags="FTS5 rebuild command" id="the_rebuild_command"><span>6.11. </span>The 'rebuild' Command</h2>

<p> This command first deletes the entire full-text index, then rebuilds it
based on the contents of the table or <a href="https://www.sqlite.org/fts5.html#external_content_tables">content
table</a>.  It is not available with <a href="https://www.sqlite.org/fts5.html#contentless_tables">contentless
tables</a>.

</p><div><pre>INSERT INTO ft(ft) VALUES('rebuild');
</pre></div>

<h2 tags="FTS5 secure-delete command" id="the_secure_delete_configuration_option"><span>6.12. </span>The 'secure-delete' Configuration Option</h2>

<p> This command is used to set the persistent boolean "secure-delete" option.
For example:

</p><div><pre>INSERT INTO ft(ft, rank) VALUES('secure-delete', 1);
</pre></div>

<p> Normally, when an entry in an fts5 table is updated or deleted, instead
of removing entries from the full-text index, delete-keys are added to the <a href="#the_automerge_configuration_option">new b-tree</a> created by the
transaction. This is efficient, but it means that the old full-text index
entries remain in the database file until they are eventually removed
by merge operations on the full-text index. Anyone with access to the
database can use these entries to trivially reconstruct the contents of
deleted FTS5 table rows. However, if the 'secure-delete' option is set
to 1, then full-text entries are actually removed from the database when
existing FTS5 table rows are updated or deleted. This is slower, but
it prevents old full-text entries from being used to reconstruct deleted
table rows.

</p><p> This option ensures that old full-text entries are not available to
attackers with SQL access to the database. To also ensure that they may
not be recovered by attackers with access to the SQLite database file 
itself, the application must also enable the SQLite core secure-delete
option with a command like <a href="https://www.sqlite.org/pragma.html#pragma_secure_delete">
"PRAGMA secure_delete = 1"</a>.

</p><p> <b>Warning:</b> Once one or more table rows have been updated or
deleted with this option set, the FTS5 table may no longer be read or
written by any version of FTS5 earlier than 3.42.0 (the first version
in which this option was available). Attempting to do so results in
an error, with an error message like "invalid fts5 file format (found 5,
expected 4) - run 'rebuild'". The FTS5 file format may be reverted, so
that it may be read by earlier versions of FTS5, by running the 
<a href="#the_rebuild_command">'rebuild' command</a> on the table using 
version 3.42.0 or later.

</p><p>The default value of the secure-delete option is 0.

</p><h2 tags="FTS5 usermerge option" id="the_usermerge_configuration_option"><span>6.13. </span>The 'usermerge' Configuration Option</h2>

<p> This command is used to set the persistent "usermerge" option.

</p><p> The usermerge option is similar to the automerge and crisismerge options.
It is the minimum number of b-tree segments that will be merged together by
a 'merge' command with a positive parameter. For example:

</p><div><pre>INSERT INTO ft(ft, rank) VALUES('usermerge', 4);
</pre></div>

<p> The default value of the usermerge option is 4. The minimum allowed value
is 2, and the maximum 16.

</p><h2 tags="Extending FTS5" id="extending_fts5"><span>7. </span>Extending FTS5</h2>

<p>FTS5 features APIs allowing it to be extended by:

</p><ul>
  <li> Adding new auxiliary functions implemented in C, and
  </li><li> Adding new tokenizers, also implemented in C.
</li></ul>

<p> The built-in tokenizers and auxiliary functions described in this
document are all implemented using the publicly available API described
below.

</p><p> Before a new auxiliary function or tokenizer implementation may be
registered with FTS5, an application must obtain a pointer to the "fts5_api"
structure. There is one fts5_api structure for each database connection with
which the FTS5 extension is registered. To obtain the pointer, the application
invokes the SQL user-defined function fts5() with a single argument.  That
argument must be set to a pointer to a pointer to an fts5_api object
using the <a href="https://www.sqlite.org/c3ref/bind_blob.html">sqlite3_bind_pointer()</a> interface.
The following example code demonstrates the technique:

</p><div><pre><i>/*
** Return a pointer to the fts5_api pointer for database connection db.
** If an error occurs, return NULL and leave an error in the database
** handle (accessible using sqlite3_errcode()/errmsg()).
*/</i>
fts5_api *fts5_api_from_db(sqlite3 *db){
  fts5_api *pRet = 0;
  sqlite3_stmt *pStmt = 0;

  if( SQLITE_OK==sqlite3_prepare(db, "SELECT fts5(?1)", -1, &amp;pStmt, 0) ){
    sqlite3_bind_pointer(pStmt, 1, (void*)&amp;pRet, "fts5_api_ptr", NULL);
    sqlite3_step(pStmt);
  }
  sqlite3_finalize(pStmt);
  return pRet;
}
</pre></div>

<p><b>Backwards Compatibility Warning:</b>
Prior to SQLite version 3.20.0 (2017-08-01), the fts5() worked slightly
differently.  Older applications that extend FTS5 must be revised to use
the new technique shown above.

</p><p> The fts5_api structure is defined as follows. It exposes three methods,
one each for registering new auxiliary functions and tokenizers, and one for
retrieving existing tokenizer. The latter is intended to facilitate the
implementation of "tokenizer wrappers" similar to the built-in
porter tokenizer.

</p><div><pre>typedef struct fts5_api fts5_api;
struct fts5_api {
  int iVersion;                   <i>/* Currently always set to 2 */</i>

  <i>/* Create a new tokenizer */</i>
  int (*xCreateTokenizer)(
    fts5_api *pApi,
    const char *zName,
    void *pUserData,
    fts5_tokenizer *pTokenizer,
    void (*xDestroy)(void*)
  );

  <i>/* Find an existing tokenizer */</i>
  int (*xFindTokenizer)(
    fts5_api *pApi,
    const char *zName,
    void **ppUserData,
    fts5_tokenizer *pTokenizer
  );

  <i>/* Create a new auxiliary function */</i>
  int (*xCreateFunction)(
    fts5_api *pApi,
    const char *zName,
    void *pUserData,
    fts5_extension_function xFunction,
    void (*xDestroy)(void*)
  );
};
</pre></div>

<p> To invoke a method of the fts5_api object, the fts5_api pointer itself
should be passed as the methods first argument followed by the other, method
specific, arguments. For example:

</p><div><pre>rc = pFts5Api-&gt;xCreateTokenizer(pFts5Api, ... other args ...);
</pre></div>

<p> The fts5_api structure methods are described individually in the following
sections.

</p><h2 tags="custom tokenizers" id="custom_tokenizers"><span>7.1. </span>Custom Tokenizers</h2>

<p> To create a custom tokenizer, an application must implement three
functions: a tokenizer constructor (xCreate), a destructor (xDelete) and a
function to do the actual tokenization (xTokenize). The type of each
function is as for the member variables of the fts5_tokenizer struct:

</p><div><pre>typedef struct Fts5Tokenizer Fts5Tokenizer;
typedef struct fts5_tokenizer fts5_tokenizer;
struct fts5_tokenizer {
  int (*xCreate)(void*, const char **azArg, int nArg, Fts5Tokenizer **ppOut);
  void (*xDelete)(Fts5Tokenizer*);
  int (*xTokenize)(Fts5Tokenizer*, 
      void *pCtx,
      int flags,            <i>/* Mask of FTS5_TOKENIZE_* flags */</i>
      const char *pText, int nText, 
      int (*xToken)(
        void *pCtx,         <i>/* Copy of 2nd argument to xTokenize() */</i>
        int tflags,         <i>/* Mask of FTS5_TOKEN_* flags */</i>
        const char *pToken, <i>/* Pointer to buffer containing token */</i>
        int nToken,         <i>/* Size of token in bytes */</i>
        int iStart,         <i>/* Byte offset of token within input text */</i>
        int iEnd            <i>/* Byte offset of end of token within input text */</i>
      )
  );
};

<i>/* Flags that may be passed as the third argument to xTokenize() */</i>
#define FTS5_TOKENIZE_QUERY     0x0001
#define FTS5_TOKENIZE_PREFIX    0x0002
#define FTS5_TOKENIZE_DOCUMENT  0x0004
#define FTS5_TOKENIZE_AUX       0x0008

<i>/* Flags that may be passed by the tokenizer implementation back to FTS5
** as the third argument to the supplied xToken callback. */</i>
#define FTS5_TOKEN_COLOCATED    0x0001      <i>/* Same position as prev. token */</i>
</pre></div>

<p> The implementation is registered with the FTS5 module by calling the
xCreateTokenizer() method of the fts5_api object. If there is already a
tokenizer with the same name, it is replaced.  If a non-NULL xDestroy parameter
is passed to xCreateTokenizer(), it is invoked with a copy of the pUserData
pointer passed as the only argument when the database handle is closed or when
the tokenizer is replaced.

</p><p> If successful, xCreateTokenizer() returns SQLITE_OK. Otherwise, it
returns an SQLite error code. In this case the xDestroy function is <b>not</b>
invoked.

</p><p> When an FTS5 table uses the custom tokenizer, the FTS5 core calls xCreate()
once to create a tokenizer, then xTokenize() zero or more times to tokenize
strings, then xDelete() to free any resources allocated by xCreate(). More
specifically:

</p><dl>
<dt><b>xCreate:</b></dt><dd><p>
   This function is used to allocate and initialize a tokenizer instance.
   A tokenizer instance is required to actually tokenize text.
</p><p>
   The first argument passed to this function is a copy of the (void*)
   pointer provided by the application when the fts5_tokenizer object
   was registered with FTS5 (the third argument to xCreateTokenizer()). 
   The second and third arguments are an array of nul-terminated strings
   containing the tokenizer arguments, if any, specified following the
   tokenizer name as part of the CREATE VIRTUAL TABLE statement used
   to create the FTS5 table.
</p><p>
   The final argument is an output variable. If successful, (*ppOut) 
   should be set to point to the new tokenizer handle and SQLITE_OK
   returned. If an error occurs, some value other than SQLITE_OK should
   be returned. In this case, fts5 assumes that the final value of *ppOut 
   is undefined.
</p></dd><dt><b> xDelete:</b></dt><dd><p>
   This function is invoked to delete a tokenizer handle previously
   allocated using xCreate(). Fts5 guarantees that this function will
   be invoked exactly once for each successful call to xCreate().
</p></dd><dt><b> xTokenize:</b></dt><dd><p>
   This function is expected to tokenize the nText byte string indicated 
   by argument pText. pText may or may not be nul-terminated. The first
   argument passed to this function is a pointer to an Fts5Tokenizer object
   returned by an earlier call to xCreate().
</p><p>
   The second argument indicates the reason that FTS5 is requesting
   tokenization of the supplied text. This is always one of the following
   four values:
</p><ul><li> <b>FTS5_TOKENIZE_DOCUMENT</b> - A document is being inserted into
            or removed from the FTS table. The tokenizer is being invoked to
            determine the set of tokens to add to (or delete from) the
            FTS index.
</li><li> <b>FTS5_TOKENIZE_QUERY</b> - A MATCH query is being executed 
            against the FTS index. The tokenizer is being called to tokenize 
            a bareword or quoted string specified as part of the query.
</li><li> <b>(FTS5_TOKENIZE_QUERY | FTS5_TOKENIZE_PREFIX)</b> - Same as
            FTS5_TOKENIZE_QUERY, except that the bareword or quoted string is
            followed by a "*" character, indicating that the last token
            returned by the tokenizer will be treated as a token prefix.
</li><li> <b>FTS5_TOKENIZE_AUX</b> - The tokenizer is being invoked to 
            satisfy an fts5_api.xTokenize() request made by an auxiliary
            function. Or an fts5_api.xColumnSize() request made by the same
            on a columnsize=0 database.  
   </li></ul>
<p>
   For each token in the input string, the supplied callback xToken() must
   be invoked. The first argument to it should be a copy of the pointer
   passed as the second argument to xTokenize(). The third and fourth
   arguments are a pointer to a buffer containing the token text, and the
   size of the token in bytes. The 4th and 5th arguments are the byte offsets
   of the first byte of and first byte immediately following the text from
   which the token is derived within the input.
</p><p>
   The second argument passed to the xToken() callback ("tflags") should
   normally be set to 0. The exception is if the tokenizer supports 
   synonyms. In this case see the discussion below for details.
</p><p>
   FTS5 assumes the xToken() callback is invoked for each token in the 
   order that they occur within the input text.
</p><p>
   If an xToken() callback returns any value other than SQLITE_OK, then
   the tokenization should be abandoned and the xTokenize() method should
   immediately return a copy of the xToken() return value. Or, if the
   input buffer is exhausted, xTokenize() should return SQLITE_OK. Finally,
   if an error occurs with the xTokenize() implementation itself, it
   may abandon the tokenization and return any error code other than
   SQLITE_OK or SQLITE_DONE.
</p></dd></dl><h3 id="synonym_support"><span>7.1.1. </span>Synonym Support</h3>
<p>
   Custom tokenizers may also support synonyms. Consider a case in which a
   user wishes to query for a phrase such as "first place". Using the 
   built-in tokenizers, the FTS5 query 'first + place' will match instances
   of "first place" within the document set, but not alternative forms
   such as "1st place". In some applications, it would be better to match
   all instances of "first place" or "1st place" regardless of which form
   the user specified in the MATCH query text.
</p><p>
   There are several ways to approach this in FTS5:
</p><ol><li> By mapping all synonyms to a single token. In this case, using
            the above example, this means that the tokenizer returns the
            same token for inputs "first" and "1st". Say that token is in
            fact "first", so that when the user inserts the document "I won
            1st place" entries are added to the index for tokens "i", "won",
            "first" and "place". If the user then queries for '1st + place',
            the tokenizer substitutes "first" for "1st" and the query works
            as expected.
</li><li> By querying the index for all synonyms of each query term
            separately. In this case, when tokenizing query text, the
            tokenizer may provide multiple synonyms for a single term 
            within the document. FTS5 then queries the index for each 
            synonym individually. For example, faced with the query:

<p>
            the tokenizer offers both "1st" and "first" as synonyms for the
            first token in the MATCH query and FTS5 effectively runs a query 
            similar to:
</p><div><pre>... MATCH '(first OR 1st) place'
</pre></div>
<p>
            except that, for the purposes of auxiliary functions, the query
            still appears to contain just two phrases - "(first OR 1st)" 
            being treated as a single phrase.
</p></li><li> By adding multiple synonyms for a single term to the FTS index.
            Using this method, when tokenizing document text, the tokenizer
            provides multiple synonyms for each token. So that when a 
            document such as "I won first place" is tokenized, entries are
            added to the FTS index for "i", "won", "first", "1st" and
            "place".
<p>
            This way, even if the tokenizer does not provide synonyms
            when tokenizing query text (it should not - to do so would be
            inefficient), it doesn't matter if the user queries for 
            'first + place' or '1st + place', as there are entries in the
            FTS index corresponding to both forms of the first token.
   </p></li></ol>
<p>
   Whether it is parsing document or query text, any call to xToken that
   specifies a <i>tflags</i> argument with the FTS5_TOKEN_COLOCATED bit
   is considered to supply a synonym for the previous token. For example,
   when parsing the document "I won first place", a tokenizer that supports
   synonyms would call xToken() 5 times, as follows:
</p><div><pre>xToken(pCtx, 0, "i",                      1,  0,  1);
xToken(pCtx, 0, "won",                    3,  2,  5);
xToken(pCtx, 0, "first",                  5,  6, 11);
xToken(pCtx, FTS5_TOKEN_COLOCATED, "1st", 3,  6, 11);
xToken(pCtx, 0, "place",                  5, 12, 17);
</pre></div>
<p>
   It is an error to specify the FTS5_TOKEN_COLOCATED flag the first time
   xToken() is called. Multiple synonyms may be specified for a single token
   by making multiple calls to xToken(FTS5_TOKEN_COLOCATED) in sequence. 
   There is no limit to the number of synonyms that may be provided for a
   single token.
</p><p>
   In many cases, method (1) above is the best approach. It does not add 
   extra data to the FTS index or require FTS5 to query for multiple terms,
   so it is efficient in terms of disk space and query speed. However, it
   does not support prefix queries very well. If, as suggested above, the
   token "first" is substituted for "1st" by the tokenizer, then the query:
</p>
<p>
   will not match documents that contain the token "1st" (as the tokenizer
   will probably not map "1s" to any prefix of "first").
</p><p>
   For full prefix support, method (3) may be preferred. In this case, 
   because the index contains entries for both "first" and "1st", prefix
   queries such as 'fi*' or '1s*' will match correctly. However, because
   extra entries are added to the FTS index, this method uses more space
   within the database.
</p><p>
   Method (2) offers a midpoint between (1) and (3). Using this method,
   a query such as '1s*' will match documents that contain the literal 
   token "1st", but not "first" (assuming the tokenizer is not able to
   provide synonyms for prefixes). However, a non-prefix query like '1st'
   will match against "1st" and "first". This method does not require
   extra disk space, as no extra entries are added to the FTS index. 
   On the other hand, it may require more CPU cycles to run MATCH queries,
   as separate queries of the FTS index are required for each synonym.
</p><p>
   When using methods (2) or (3), it is important that the tokenizer only
   provide synonyms when tokenizing document text (method (3)) or query
   text (method (2)), not both. Doing so will not cause any errors, but is
   inefficient.



</p><h2 tags="FTS5 custom auxiliary functions" id="custom_auxiliary_functions"><span>7.2. </span>Custom Auxiliary Functions</h2>

<p> Implementing a custom auxiliary function is similar to implementing a
<a href="https://www.sqlite.org/appfunc.html">scalar SQL function</a>. The implementation
should be a C function of type fts5_extension_function, defined as follows:

</p><div><pre>typedef struct Fts5ExtensionApi Fts5ExtensionApi;
typedef struct Fts5Context Fts5Context;
typedef struct Fts5PhraseIter Fts5PhraseIter;

typedef void (*fts5_extension_function)(
  const Fts5ExtensionApi *pApi,   <i>/* API offered by current FTS version */</i>
  Fts5Context *pFts,              <i>/* First arg to pass to pApi functions */</i>
  sqlite3_context *pCtx,          <i>/* Context for returning result/error */</i>
  int nVal,                       <i>/* Number of values in apVal[] array */</i>
  sqlite3_value **apVal           <i>/* Array of trailing arguments */</i>
);
</pre></div>

<p> The implementation is registered with the FTS5 module by calling the
xCreateFunction() method of the fts5_api object. If there is already an
auxiliary function with the same name, it is replaced by the new function.
If a non-NULL xDestroy parameter is passed to xCreateFunction(), it is invoked
with a copy of the pUserData pointer passed as the only argument when the
database handle is closed or when the registered auxiliary function is
replaced.

</p><p> If successful, xCreateFunction() returns SQLITE_OK. Otherwise, it
returns an SQLite error code. In this case the xDestroy function is <b>not</b>
invoked.

</p><p> The final three arguments passed to the auxiliary function callback 
(pCtx, nVal and apVal above) are similar to the three arguments passed to the
implementation of a scalar SQL function. The apVal[] array contains all
SQL arguments except the first passed to the auxiliary function. The
implementation should return a result or error via the content handle pCtx.

</p><p> The first argument passed to an auxiliary function callback is a pointer
to a structure (pApi above) containing methods that may be invoked
in order to obtain information regarding the current query or row. The second
argument is an opaque handle (pFts above) that should be passed as the
first argument to any such method invocation. For example, the following
auxiliary function returns the total number of tokens in all columns of the
current row:

</p><div><pre><i>/*
** Implementation of an auxiliary function that returns the number
** of tokens in the current row (including all columns).
*/</i>
static void column_size_imp(
  const Fts5ExtensionApi *pApi,
  Fts5Context *pFts,
  sqlite3_context *pCtx,
  int nVal,
  sqlite3_value **apVal
){
  int rc;
  int nToken;
  rc = pApi-&gt;xColumnSize(pFts, -1, &amp;nToken);
  if( rc==SQLITE_OK ){
    sqlite3_result_int(pCtx, nToken);
  }else{
    sqlite3_result_error_code(pCtx, rc);
  }
}
</pre></div>

<p>The following section describes the API offered to auxiliary function
implementations in detail. Further examples may be found in the "fts5_aux.c"
file of the source code.

</p><h3 tags="custom auxiliary overview" id="custom_auxiliary_functions_api_overview"><span>7.2.1. </span>Custom Auxiliary Functions API Overview</h3>

<p>This section provides an overview of the capabilities of the auxiliary
function API. It does not describe every function. Refer to the <a href="#custom_auxiliary_functions_api_reference">reference text</a> below for a
complete description.

</p><p>When invoked, an auxiliary function implementation has access to APIs that
allow it to query FTS5 for various information. Some of these APIs return
information relating to the current row of the FTS5 table being visited,
some relating to the entire set of rows that will be visited by the FTS5
query, and some relating to the FTS5 table. Given an FTS5 table populated as
follows:

</p><div><pre>CREATE VIRTUAL TABLE ft USING fts5(a, b);
INSERT INTO ft(rowid, a, b) VALUES
        (1, 'ab cd', 'cd de one'),
        (2, 'de fg', 'fg gh'),
        (3, 'gh ij', 'ij ab three four');
</pre></div>

<p>and the query:

</p><div><pre>SELECT my_aux_function(ft) FROM ft('ab')
</pre></div>

<p>then the custom auxiliary function will be invoked for rows 1 and 3 (all
rows that contain the token "ab" and therefore match the query). 

</p><p><b>Number of rows/columns in table: xRowCount, xColumnCount

</b></p><p>The system may be queried for the total number of rows in the FTS5 table
using the <a href="#xRowCount">xRowCount</a> API. This provides the total number
of rows in the table, not the number that match the current query.

</p><p>Table columns are numbered from left to right starting from 0. The
"rowid" column does not count - only user declared columns - so in the example
above column "a" is column 0 and column "b" is column 1. From within an
auxiliary function implementation, the <a href="#xColumnCount">xColumnCount</a>
API may be used to determine how many columns the table being queried has. If
the xColumnCount() API is invoked from within the implementation of the
auxiliary function my_aux_function in the example above, it returns 2.

</p><p><b>Data From Current Row: xColumnText, xRowid

</b></p><p>The <a href="#xRowid">xRowid</a> API may be used to find the rowid value
for the current row. The <a href="#xColumnText">xColumnText</a> may be used
to obtain the text stored in a specified column of the current row.

</p><p><b>Token Counts: xColumnSize, xColumnTotalSize

</b></p><p>FTS5 divides documents inserted into an fts table into tokens. These are
usually just words, perhaps folded to either upper or lower case and with any
punctuation removed. For example, the default 
<a href="#unicode61_tokenizer">unicode61 tokenizer</a> tokenizes the text "The
tokenizer is case-insensitive" to a list of 5 tokens - "the", "tokenizer", is",
"case" and "insensitive". Exactly how tokens are extracted from text is 
determined by the <a href="#tokenizers">tokenizer</a>.

</p><p>The auxiliary functions API provides functions to query for both the number
of tokens in a specified column of the current row (the 
<a href="#xColumnSize">xColumnSize</a> API), or for the number of tokens in a 
specified column of all rows of the table (the <a href="#xColumnTotalSize">xColumnTotalSize</a> API). For the example at the
top of this section, when visiting row 1, xColumnSize returns 2 for column 0
and 3 for column 1. xColumnTotalSize returns 6 for column 0 and 9 for column 1
regardless of the current row.

</p><p><b>The Current Full-Text Query: xPhraseCount, xPhraseSize, xQueryToken

</b></p><p>An FTS5 query contains one or more <a href="#fts5_phrases">phrases</a>. The 
<a href="#xPhraseCount">xPhraseCount</a>, <a href="#xPhraseSize">xPhraseSize</a>
and <a href="#xQueryToken">xQueryToken</a> APIs allow an auxiliary function
implementation to query the system for details of the current query. The
xPhraseCount API returns the number of phrases in the current query. For
example, if an FTS5 table is queried as follows:

</p><div><pre>SELECT my_aux_function(ft) FROM ft('ab AND "cd ef gh" OR ij + kl')
</pre></div>

<p>and the xPhraseCount() API invoked from within the implementation of the
auxiliary function, it returns 3 (the three phrases being "ab", "ce ef gh" and
"ij kl"). 

</p><p>Phrases are numbered in order of appearance within a query starting from 0.
The xPhraseSize() API may be used to query for the number of tokens in a
specified phrase of the query. In the example above, phrase 0 contains 1 token,
phrase 1 contains 3 tokens, and phrase 2 contains 2.

</p><p>The xQueryToken API may be used to access the text of a specified token
within a specified phrase of the query. Tokens are numbered within their
phrases from left to right starting from 0. For example, if the xQueryToken
API is used to request token 1 of phrase 2 in the example above, it returns
the text "kl". Token 0 of phrase 0 is "ab".

</p><p><b>Phrase Hits in the Current Row: xPhraseFirst, xPhraseNext

</b></p><p>These two API functions may be used to iterate through the matches for
a specified phrase of the query within the current row. Phrase matches are
identified by the column and token offset within the current row. For
example, say the following example table:

</p><div><pre>CREATE VIRTUAL TABLE ft2 USING fts5(x, y);
INSERT INTO ft2(rowid, x, y) VALUES
        (1, 'xxx one two xxx five xxx six', 'seven four'),
        (2, 'five four four xxx six', 'three four five six four five six');
</pre></div>

<p>is queried with:

</p><div><pre>SELECT my_aux_function(ft2) FROM ft2(
    '("one two" OR "three") AND y:four NEAR(five six, 2)'
);
</pre></div>

<p>The query above contains 5 phrases - "one two", "three", "four", 
"five" and "six". It matches all rows of the table, so the auxiliary 
function is invoked for each row.

</p><p>In row 1, for phrase 0, "one two", there is exactly one match to iterate
through -  at column 0 token offset 1. The column number is 0 because the 
match appears in the left most column. The token offset is 1 because there 
is exactly one token ("xxx") before the phrase match in the column value.
For phrase 1, "three", there are no matches. Phrase 2, "four", has one
match, at column 1, token offset 0. Phrase 3, "five", has one match at
column 0, token offset 4, and phrase 4, "six", has one match at column 0
token offset 6.

</p><p>The set of matches for each phrase in each row of the example is presented
in the table below. Each match is notated as (column-number, token-offset):

</p><table striped="1">
  <tbody><tr><th>Row</th><th>Phrase 0</th><th>Phrase 1</th><th>Phrase 2</th><th>Phrase 3</th><th>Phrase 4
  </th></tr><tr><td>1</td><td>(0, 1)    </td><td></td><td>(1, 1)</td><td>(0, 4)</td><td>(0, 6)
  </td></tr><tr><td>2</td><td></td><td>(1,0)</td><td>(1, 1), (1,4)</td><td>(1, 2), (1, 5)</td><td>(1, 3), (1, 6)
</td></tr></tbody></table>

<p>The second row is slightly more complicated. There were no occurrences of
phrase 0. Phrase 1 ("three") appears once, at column 1 token offset 0. Although
there are instances of phrase 2 ("four") in column 0, none of them are reported
by the API, as phrase 4 has a <a href="#fts5_column_filters">column filter</a> -
"y:". Matches that are filtered out by column filters do not count. Similarly,
although phrases 3 and 4 do occur in column "x" of row 2, they are filtered
out by the <a href="#fts5_near_queries">NEAR filter</a>. Matches that are
filtered out by NEAR filters do not count either.

</p><p><b>Phrase Hits in the Current Row (2): xInstCount, xInst

</b></p><p>The <a href="#xInstCount">xInstCount</a> and <a href="#xInst">xInst</a> APIs
provide access to the same information as the xPhraseFirst and xPhraseNext
described above. The difference is that instead of iterating through the
matches for a single, specified phrase, the xInstCount/xInst APIs collate
all matches into a single flat array, sorted in order of occurrence within
the current row. Elements of this array may then be accessed randomly.

</p><p>Each array element consists of three values:

</p><ul>
  <li> A phrase number,
  </li><li> A column number, and
  </li><li> A token offset
</li></ul>

<p>Using the same example data and query as for xPhraseFirst/xPhraseNext
above, the array accessible via xInstCount/xInst consists of the following
entries for each row:

</p><table striped="1">
  <tbody><tr><th>Row</th><th>xInstCount/xInst array
  </th></tr><tr><td>1</td><td>(0, 0, 1), (3, 0, 4), (4, 0, 6), (2, 1, 1)
  </td></tr><tr><td>2</td><td>(1, 1, 0), (2, 1, 1), (3, 1, 2), (4, 1, 3), (2, 1, 4), (3, 1, 5), (4, 1, 6)
</td></tr></tbody></table>

<p>Each entry of the array is called a phrase match. Phrase matches are
numbered in order, starting from 0. So, in the example above, in row 2, phrase
match 3 is (4, 1, 3) - phrase 4 of the query matches at column 1, token offset
3.

</p><h3 tags="custom auxiliary functions" id="custom_auxiliary_functions_api_reference"><span>7.2.2. </span>Custom Auxiliary Functions API Reference</h3>

<div><pre>struct Fts5ExtensionApi {
  int iVersion;                   <i>/* Currently always set to 3 */</i>

  void *(*<a href="#xUserData">xUserData</a>)(Fts5Context*);

  int (*<a href="#xColumnCount">xColumnCount</a>)(Fts5Context*);
  int (*<a href="#xRowCount">xRowCount</a>)(Fts5Context*, sqlite3_int64 *pnRow);
  int (*<a href="#xColumnTotalSize">xColumnTotalSize</a>)(Fts5Context*, int iCol, sqlite3_int64 *pnToken);

  int (*<a href="#xTokenize">xTokenize</a>)(Fts5Context*, 
    const char *pText, int nText, <i>/* Text to tokenize */</i>
    void *pCtx,                   <i>/* Context passed to xToken() */</i>
    int (*xToken)(void*, int, const char*, int, int, int)       <i>/* Callback */</i>
  );

  int (*<a href="#xPhraseCount">xPhraseCount</a>)(Fts5Context*);
  int (*<a href="#xPhraseSize">xPhraseSize</a>)(Fts5Context*, int iPhrase);

  int (*<a href="#xInstCount">xInstCount</a>)(Fts5Context*, int *pnInst);
  int (*<a href="#xInst">xInst</a>)(Fts5Context*, int iIdx, int *piPhrase, int *piCol, int *piOff);

  sqlite3_int64 (*<a href="#xRowid">xRowid</a>)(Fts5Context*);
  int (*<a href="#xColumnText">xColumnText</a>)(Fts5Context*, int iCol, const char **pz, int *pn);
  int (*<a href="#xColumnSize">xColumnSize</a>)(Fts5Context*, int iCol, int *pnToken);

  int (*<a href="#xQueryPhrase">xQueryPhrase</a>)(Fts5Context*, int iPhrase, void *pUserData,
    int(*)(const Fts5ExtensionApi*,Fts5Context*,void*)
  );
  int (*<a href="#xSetAuxdata">xSetAuxdata</a>)(Fts5Context*, void *pAux, void(*xDelete)(void*));
  void *(*<a href="#xGetAuxdata">xGetAuxdata</a>)(Fts5Context*, int bClear);

  int (*<a href="#xPhraseFirst">xPhraseFirst</a>)(Fts5Context*, int iPhrase, Fts5PhraseIter*, int*, int*);
  void (*<a href="#xPhraseNext">xPhraseNext</a>)(Fts5Context*, Fts5PhraseIter*, int *piCol, int *piOff);

  int (*<a href="#xPhraseFirstColumn">xPhraseFirstColumn</a>)(Fts5Context*, int iPhrase, Fts5PhraseIter*, int*);
  void (*<a href="#xPhraseNextColumn">xPhraseNextColumn</a>)(Fts5Context*, Fts5PhraseIter*, int *piCol);

  <i>/* Below this point are iVersion&gt;=3 only */</i>
  int (*<a href="#xQueryToken">xQueryToken</a>)(Fts5Context*, 
      int iPhrase, int iToken, 
      const char **ppToken, int *pnToken
  );
  int (*<a href="#xInstToken">xInstToken</a>)(Fts5Context*, int iIdx, int iToken, const char**, int*);
};
</pre></div>

<dl>
<dt id="xUserData">
<b>void *(*xUserData)(Fts5Context*)</b></dt><dd>
<p>
Return a copy of the pUserData pointer passed to the xCreateFunction()
   API when the extension function was registered.
</p>
</dd>
<dt id="xColumnTotalSize">
<b>int (*xColumnTotalSize)(Fts5Context*, int iCol, sqlite3_int64 *pnToken)</b></dt><dd>
<p>
If parameter iCol is less than zero, set output variable *pnToken
   to the total number of tokens in the FTS5 table. Or, if iCol is
   non-negative but less than the number of columns in the table, return
   the total number of tokens in column iCol, considering all rows in 
   the FTS5 table.
</p>

<p>
   If parameter iCol is greater than or equal to the number of columns
   in the table, SQLITE_RANGE is returned. Or, if an error occurs (e.g.
   an OOM condition or IO error), an appropriate SQLite error code is 
   returned.
</p>
</dd>
<dt id="xColumnCount">
<b>int (*xColumnCount)(Fts5Context*)</b></dt><dd>
<p>
Return the number of columns in the table.
</p>
</dd>
<dt id="xColumnSize">
<b>int (*xColumnSize)(Fts5Context*, int iCol, int *pnToken)</b></dt><dd>
<p>
If parameter iCol is less than zero, set output variable *pnToken
   to the total number of tokens in the current row. Or, if iCol is
   non-negative but less than the number of columns in the table, set
   *pnToken to the number of tokens in column iCol of the current row.
</p>

<p>
   If parameter iCol is greater than or equal to the number of columns
   in the table, SQLITE_RANGE is returned. Or, if an error occurs (e.g.
   an OOM condition or IO error), an appropriate SQLite error code is 
   returned.
</p>

<p>
   This function may be quite inefficient if used with an FTS5 table
   created with the "columnsize=0" option.
</p>
</dd>
<dt id="xColumnText">
<b>int (*xColumnText)(Fts5Context*, int iCol, const char **pz, int *pn)</b></dt><dd>
<p>
If parameter iCol is less than zero, or greater than or equal to the
   number of columns in the table, SQLITE_RANGE is returned. 
</p>

<p>
   Otherwise, this function attempts to retrieve the text of column iCol of
   the current document. If successful, (*pz) is set to point to a buffer
   containing the text in utf-8 encoding, (*pn) is set to the size in bytes
   (not characters) of the buffer and SQLITE_OK is returned. Otherwise,
   if an error occurs, an SQLite error code is returned and the final values
   of (*pz) and (*pn) are undefined.
</p>
</dd>
<dt id="xPhraseCount">
<b>int (*xPhraseCount)(Fts5Context*)</b></dt><dd>
<p>
Returns the number of phrases in the current query expression.
</p>
</dd>
<dt id="xPhraseSize">
<b>int (*xPhraseSize)(Fts5Context*, int iPhrase)</b></dt><dd>
<p>
If parameter iCol is less than zero, or greater than or equal to the
   number of phrases in the current query, as returned by xPhraseCount, 
   0 is returned. Otherwise, this function returns the number of tokens in
   phrase iPhrase of the query. Phrases are numbered starting from zero.
</p>
</dd>
<dt id="xInstCount">
<b>int (*xInstCount)(Fts5Context*, int *pnInst)</b></dt><dd>
<p>
Set *pnInst to the total number of occurrences of all phrases within
   the query within the current row. Return SQLITE_OK if successful, or
   an error code (i.e. SQLITE_NOMEM) if an error occurs.
</p>

<p>
   This API can be quite slow if used with an FTS5 table created with the
   "detail=none" or "detail=column" option. If the FTS5 table is created 
   with either "detail=none" or "detail=column" and "content=" option 
   (i.e. if it is a contentless table), then this API always returns 0.
</p>
</dd>
<dt id="xInst">
<b>int (*xInst)(Fts5Context*, int iIdx, int *piPhrase, int *piCol, int *piOff)</b></dt><dd>
<p>
Query for the details of phrase match iIdx within the current row.
   Phrase matches are numbered starting from zero, so the iIdx argument
   should be greater than or equal to zero and smaller than the value
   output by xInstCount(). If iIdx is less than zero or greater than
   or equal to the value returned by xInstCount(), SQLITE_RANGE is returned.
</p>

<p>
   Otherwise, output parameter *piPhrase is set to the phrase number, *piCol
   to the column in which it occurs and *piOff the token offset of the
   first token of the phrase. SQLITE_OK is returned if successful, or an
   error code (i.e. SQLITE_NOMEM) if an error occurs.
</p>

<p>
   This API can be quite slow if used with an FTS5 table created with the
   "detail=none" or "detail=column" option.
</p>
</dd>
<dt id="xRowid">
<b>sqlite3_int64 (*xRowid)(Fts5Context*)</b></dt><dd>
<p>
Returns the rowid of the current row.
</p>
</dd>
<dt id="xTokenize">
<b>int (*xTokenize)(Fts5Context*, 
    const char *pText, int nText, 
    void *pCtx,                   
    int (*xToken)(void*, int, const char*, int, int, int)       
)</b></dt><dd>
<p>
Tokenize text using the tokenizer belonging to the FTS5 table.
</p>
</dd>
<dt id="xQueryPhrase">
<b>int (*xQueryPhrase)(Fts5Context*, int iPhrase, void *pUserData,
    int(*)(const Fts5ExtensionApi*,Fts5Context*,void*)
)</b></dt><dd>
<p>
This API function is used to query the FTS table for phrase iPhrase
   of the current query. Specifically, a query equivalent to:
</p>

<div><pre>... FROM ftstable WHERE ftstable MATCH $p ORDER BY rowid
</pre></div>

<p>
   with $p set to a phrase equivalent to the phrase iPhrase of the
   current query is executed. Any column filter that applies to
   phrase iPhrase of the current query is included in $p. For each 
   row visited, the callback function passed as the fourth argument 
   is invoked. The context and API objects passed to the callback 
   function may be used to access the properties of each matched row.
   Invoking Api.xUserData() returns a copy of the pointer passed as 
   the third argument to pUserData.
</p>

<p>
   If parameter iPhrase is less than zero, or greater than or equal to
   the number of phrases in the query, as returned by xPhraseCount(),
   this function returns SQLITE_RANGE.
</p>

<p>
   If the callback function returns any value other than SQLITE_OK, the
   query is abandoned and the xQueryPhrase function returns immediately.
   If the returned value is SQLITE_DONE, xQueryPhrase returns SQLITE_OK.
   Otherwise, the error code is propagated upwards.
</p>

<p>
   If the query runs to completion without incident, SQLITE_OK is returned.
   Or, if some error occurs before the query completes or is aborted by
   the callback, an SQLite error code is returned.
</p>
</dd>
<dt id="xSetAuxdata">
<b>int (*xSetAuxdata)(Fts5Context*, void *pAux, void(*xDelete)(void*))</b></dt><dd>
<p>
Save the pointer passed as the second argument as the extension function's 
   "auxiliary data". The pointer may then be retrieved by the current or any
   future invocation of the same fts5 extension function made as part of
   the same MATCH query using the xGetAuxdata() API.
</p>

<p>
   Each extension function is allocated a single auxiliary data slot for
   each FTS query (MATCH expression). If the extension function is invoked 
   more than once for a single FTS query, then all invocations share a 
   single auxiliary data context.
</p>

<p>
   If there is already an auxiliary data pointer when this function is
   invoked, then it is replaced by the new pointer. If an xDelete callback
   was specified along with the original pointer, it is invoked at this
   point.
</p>

<p>
   The xDelete callback, if one is specified, is also invoked on the
   auxiliary data pointer after the FTS5 query has finished.
</p>

<p>
   If an error (e.g. an OOM condition) occurs within this function,
   the auxiliary data is set to NULL and an error code returned. If the
   xDelete parameter was not NULL, it is invoked on the auxiliary data
   pointer before returning.
</p>
</dd>
<dt id="xGetAuxdata">
<b>void *(*xGetAuxdata)(Fts5Context*, int bClear)</b></dt><dd>
<p>
Returns the current auxiliary data pointer for the fts5 extension 
   function. See the xSetAuxdata() method for details.
</p>

<p>
   If the bClear argument is non-zero, then the auxiliary data is cleared
   (set to NULL) before this function returns. In this case the xDelete,
   if any, is not invoked.
</p>
</dd>
<dt id="xRowCount">
<b>int (*xRowCount)(Fts5Context*, sqlite3_int64 *pnRow)</b></dt><dd>
<p>
This function is used to retrieve the total number of rows in the table.
   In other words, the same value that would be returned by:
</p>

<div><pre>SELECT count(*) FROM ftstable;
</pre></div>
</dd>
<dt id="xPhraseFirst">
<b>int (*xPhraseFirst)(Fts5Context*, int iPhrase, Fts5PhraseIter*, int*, int*)</b></dt><dd>
<p>
This function is used, along with type Fts5PhraseIter and the xPhraseNext
   method, to iterate through all instances of a single query phrase within
   the current row. This is the same information as is accessible via the
   xInstCount/xInst APIs. While the xInstCount/xInst APIs are more convenient
   to use, this API may be faster under some circumstances. To iterate 
   through instances of phrase iPhrase, use the following code:
</p>

<div><pre>Fts5PhraseIter iter;
int iCol, iOff;
for(pApi-&gt;xPhraseFirst(pFts, iPhrase, &amp;iter, &amp;iCol, &amp;iOff);
    iCol&gt;=0;
    pApi-&gt;xPhraseNext(pFts, &amp;iter, &amp;iCol, &amp;iOff)
){
  // An instance of phrase iPhrase at offset iOff of column iCol
}
</pre></div>

<p>
   The Fts5PhraseIter structure is defined above. Applications should not
   modify this structure directly - it should only be used as shown above
   with the xPhraseFirst() and xPhraseNext() API methods (and by
   xPhraseFirstColumn() and xPhraseNextColumn() as illustrated below).
</p>

<p>
   This API can be quite slow if used with an FTS5 table created with the
   "detail=none" or "detail=column" option. If the FTS5 table is created 
   with either "detail=none" or "detail=column" and "content=" option 
   (i.e. if it is a contentless table), then this API always iterates
   through an empty set (all calls to xPhraseFirst() set iCol to -1).
</p>
</dd>
<dt id="xPhraseNext">
<b>void (*xPhraseNext)(Fts5Context*, Fts5PhraseIter*, int *piCol, int *piOff)</b></dt><dd>
<p>
See xPhraseFirst above.
</p>
</dd>
<dt id="xPhraseFirstColumn">
<b>int (*xPhraseFirstColumn)(Fts5Context*, int iPhrase, Fts5PhraseIter*, int*)</b></dt><dd>
<p>
This function and xPhraseNextColumn() are similar to the xPhraseFirst()
   and xPhraseNext() APIs described above. The difference is that instead
   of iterating through all instances of a phrase in the current row, these
   APIs are used to iterate through the set of columns in the current row
   that contain one or more instances of a specified phrase. For example:
</p>

<div><pre>Fts5PhraseIter iter;
int iCol;
for(pApi-&gt;xPhraseFirstColumn(pFts, iPhrase, &amp;iter, &amp;iCol);
    iCol&gt;=0;
    pApi-&gt;xPhraseNextColumn(pFts, &amp;iter, &amp;iCol)
){
  // Column iCol contains at least one instance of phrase iPhrase
}
</pre></div>

<p>
   This API can be quite slow if used with an FTS5 table created with the
   "detail=none" option. If the FTS5 table is created with either 
   "detail=none" "content=" option (i.e. if it is a contentless table), 
   then this API always iterates through an empty set (all calls to 
   xPhraseFirstColumn() set iCol to -1).
</p>

<p>
   The information accessed using this API and its companion
   xPhraseFirstColumn() may also be obtained using xPhraseFirst/xPhraseNext
   (or xInst/xInstCount). The chief advantage of this API is that it is
   significantly more efficient than those alternatives when used with
   "detail=column" tables.
</p>
</dd>
<dt id="xPhraseNextColumn">
<b>void (*xPhraseNextColumn)(Fts5Context*, Fts5PhraseIter*, int *piCol)</b></dt><dd>
<p>
See xPhraseFirstColumn above.
</p>
</dd>
<dt id="xQueryToken">
<b>int (*xQueryToken)(Fts5Context*, 
      int iPhrase, int iToken, 
      const char **ppToken, int *pnToken
)</b></dt><dd>
<p>
This is used to access token iToken of phrase iPhrase of the current
   query. Before returning, output parameter *ppToken is set to point
   to a buffer containing the requested token, and *pnToken to the
   size of this buffer in bytes.
</p>

<p>
   If iPhrase or iToken are less than zero, or if iPhrase is greater than
   or equal to the number of phrases in the query as reported by 
   xPhraseCount(), or if iToken is equal to or greater than the number of
   tokens in the phrase, SQLITE_RANGE is returned and *ppToken and *pnToken
     are both zeroed.
</p>

<p>
   The output text is not a copy of the query text that specified the
   token. It is the output of the tokenizer module. For tokendata=1
   tables, this includes any embedded 0x00 and trailing data.
</p>
</dd>
<dt id="xInstToken">
<b>int (*xInstToken)(Fts5Context*, int iIdx, int iToken, const char**, int*)</b></dt><dd>
<p>
This is used to access token iToken of phrase hit iIdx within the
   current row. If iIdx is less than zero or greater than or equal to the
   value returned by xInstCount(), SQLITE_RANGE is returned.  Otherwise,
   output variable (*ppToken) is set to point to a buffer containing the
   matching document token, and (*pnToken) to the size of that buffer in 
   bytes. This API is not available if the specified token matches a 
   prefix query term. In that case both output variables are always set 
   to 0.
</p>

<p>
   The output text is not a copy of the document text that was tokenized.
   It is the output of the tokenizer module. For tokendata=1 tables, this 
   includes any embedded 0x00 and trailing data.
</p>

<p>
   This API can be quite slow if used with an FTS5 table created with the
   "detail=none" or "detail=column" option.
</p>
</dd>
</dl>


<h2 tags="fts5vocab" id="the_fts5vocab_virtual_table_module"><span>8. </span>The fts5vocab Virtual Table Module</h2>

<p> The fts5vocab virtual table module allows users to extract information from
an FTS5 full-text index directly. The fts5vocab module is a part of FTS5 - it
is available whenever FTS5 is.

</p><p> Each fts5vocab table is associated with a single FTS5 table. An fts5vocab
table is usually created by specifying two arguments in place of column names
in the CREATE VIRTUAL TABLE statement - the name of the associated FTS5 table
and the type of fts5vocab table. Currently there are three types of fts5vocab
table; "row", "col" and "instance". Unless the fts5vocab table is created
within the "temp" database, it must be part of the same database as the
associated FTS5 table.

</p><div><pre><i>-- Create an fts5vocab "row" table to query the full-text index belonging
-- to FTS5 table "ft1".</i>
CREATE VIRTUAL TABLE ft1_v USING fts5vocab('ft1', 'row');

<i>-- Create an fts5vocab "col" table to query the full-text index belonging
-- to FTS5 table "ft2".</i>
CREATE VIRTUAL TABLE ft2_v USING fts5vocab(ft2, col);

<i>-- Create an fts5vocab "instance" table to query the full-text index
-- belonging to FTS5 table "ft3".</i>
CREATE VIRTUAL TABLE ft3_v USING fts5vocab(ft3, instance);
</pre></div>

<p> If an fts5vocab table is created in the temp database, it may be associated
with an FTS5 table in any attached database. In order to attach the fts5vocab
table to an FTS5 table located in a database other than "temp", the name of the
database is inserted before the FTS5 table name in the CREATE VIRTUAL TABLE
arguments. For example:

</p><div><pre><i>-- Create an fts5vocab "row" table to query the full-text index belonging
-- to FTS5 table "ft1" in database "main".</i>
CREATE VIRTUAL TABLE temp.ft1_v USING fts5vocab(main, 'ft1', 'row');

<i>-- Create an fts5vocab "col" table to query the full-text index belonging
-- to FTS5 table "ft2" in attached database "aux".</i>
CREATE VIRTUAL TABLE temp.ft2_v USING fts5vocab('aux', ft2, col);

<i>-- Create an fts5vocab "instance" table to query the full-text index
-- belonging to FTS5 table "ft3" in attached database "other".</i>
CREATE VIRTUAL TABLE temp.ft2_v USING fts5vocab('aux', ft3, 'instance');
</pre></div>

<p> Specifying three arguments when creating an fts5vocab table in any database
other than "temp" results in an error.

</p><p> An fts5vocab table of type "row" contains one row for each distinct term
in the associated FTS5 table. The table columns are as follows:

</p><table striped="1">
  <tbody><tr><th>Column</th><th>Contents
  </th></tr><tr><td>term</td><td> The term, as stored in the FTS5 index.
  </td></tr><tr><td>doc</td><td>  The number of rows that contain at least one instance of the term.
  </td></tr><tr><td>cnt</td><td>  The total number of instances of the term in the entire FTS5 table.
</td></tr></tbody></table>

<p> An fts5vocab table of type "col" contains one row for each distinct term/column
combination in the associated FTS5 table. Table columns are as follows:

</p><table striped="1">
  <tbody><tr><th>Column</th><th>Contents
  </th></tr><tr><td>term</td><td> The term, as stored in the FTS5 index.
  </td></tr><tr><td>col</td><td>  The name of the FTS5 table column that contains the term.
  </td></tr><tr><td>doc</td><td>  The number of rows in the FTS5 table for which column $col
                   contains at least one instance of the term.
  </td></tr><tr><td>cnt</td><td>  The total number of instances of the term that appear in
                   column $col of the FTS5 table (considering all rows).
</td></tr></tbody></table>

<p> An fts5vocab table of type "instance" contains one row for each term
instance stored in the associated FTS index. Assuming the FTS5 table is
created with the 'detail' option set to 'full', table columns are as follows:

</p><table striped="1">
  <tbody><tr><th>Column</th><th>Contents
  </th></tr><tr><td>term</td><td>   The term, as stored in the FTS5 index.
  </td></tr><tr><td>doc</td><td>    The rowid of the document that contains the term instance.
  </td></tr><tr><td>col</td><td>    The name of the column that contains the term instance.
  </td></tr><tr><td>offset</td><td> The index of the term instance within its column. Terms
                     are numbered in order of occurrence starting from 0.
</td></tr></tbody></table>

<p> If the FTS5 table is created with the 'detail' option set to 'col', then
the <i>offset</i> column of an instance virtual table always contains NULL.
In this case there is one row in the table for each unique term/doc/col
combination. Or, if the FTS5 table is created with 'detail' set to 'none',
then both <i>offset</i> and <i>col</i> always contain NULL values. For
detail=none FTS5 tables, there is one row in the fts5vocab table for each
unique term/doc combination.

</p><p>Example:

</p><div><pre><i>-- Assuming a database created using:</i>
CREATE VIRTUAL TABLE ft1 USING fts5(c1, c2);
INSERT INTO ft1 VALUES('apple banana cherry', 'banana banana cherry');
INSERT INTO ft1 VALUES('cherry cherry cherry', 'date date date');

<i>-- Then querying the following fts5vocab table (type "col") returns:
--
--    apple  | c1 | 1 | 1
--    banana | c1 | 1 | 1
--    banana | c2 | 1 | 2
--    cherry | c1 | 2 | 4
--    cherry | c2 | 1 | 1
--    date   | c3 | 1 | 3
--</i>
CREATE VIRTUAL TABLE ft1_v_col USING fts5vocab(ft1, col);

<i>-- Querying an fts5vocab table of type "row" returns:
--
--    apple  | 1 | 1
--    banana | 1 | 3
--    cherry | 2 | 5
--    date   | 1 | 3
--</i>
CREATE VIRTUAL TABLE ft1_v_row USING fts5vocab(ft1, row);

<i>-- And, for type "instance"
INSERT INTO ft1 VALUES('apple banana cherry', 'banana banana cherry');
INSERT INTO ft1 VALUES('cherry cherry cherry', 'date date date');
--
--    apple  | 1 | c1 | 0
--    banana | 1 | c1 | 1
--    banana | 1 | c2 | 0
--    banana | 1 | c2 | 1
--    cherry | 1 | c1 | 2
--    cherry | 1 | c2 | 2
--    cherry | 2 | c1 | 0
--    cherry | 2 | c1 | 1
--    cherry | 2 | c1 | 2
--    date   | 2 | c2 | 0
--    date   | 2 | c2 | 1
--    date   | 2 | c2 | 2
--</i>
CREATE VIRTUAL TABLE ft1_v_instance USING fts5vocab(ft1, instance);
</pre></div>

<h2 id="fts5_data_structures"><span>9. </span>FTS5 Data Structures</h2>

<p>This section describes at a high-level the way the FTS module stores its
index and content in the database. It is not necessary to read or understand
the material in this section in order to use FTS in an application. However, it
may be useful to application developers attempting to analyze and understand
FTS performance characteristics, or to developers contemplating enhancements to
the existing FTS feature set.

</p><p>
When an FTS5 virtual table is created in a database, between 3 and 5 real
tables are created in the database. These are known as "<a href="https://www.sqlite.org/vtab.html#xshadowname">shadow tables</a>", and
are used by the virtual table module to store persistent data. They should not
be accessed directly by the user. Many other virtual table modules, including
<a href="https://www.sqlite.org/fts3.html">FTS3</a> and <a href="https://www.sqlite.org/rtree.html">rtree</a>, also create and use shadow tables.

</p><p>FTS5 creates the following shadow tables. In each case the actual table name
is based on the name of the FTS5 virtual table (in the following, replace
% with the name of the virtual table to find the actual shadow table name).

</p><div><pre><i>-- This table contains most of the full-text index data. </i>
CREATE TABLE %_data(id INTEGER PRIMARY KEY, block BLOB);

<i>-- This table contains the remainder of the full-text index data. </i>
<i>-- It is almost always much smaller than the %_data table. </i>
CREATE TABLE %_idx(segid, term, pgno, PRIMARY KEY(segid, term)) WITHOUT ROWID;

<i>-- Contains the values of persistent configuration parameters.</i>
CREATE TABLE %_config(k PRIMARY KEY, v) WITHOUT ROWID;

<i>-- Contains the size of each column of each row in the virtual table</i>
<i>-- in tokens. This shadow table is not present if the "columnsize"</i>
<i>-- option is set to 0.</i>
CREATE TABLE %_docsize(id INTEGER PRIMARY KEY, sz BLOB);

<i>-- Contains the actual data inserted into the FTS5 table. There</i>
<i>-- is one "cN" column for each indexed column in the FTS5 table.</i>
<i>-- This shadow table is not present for contentless or external </i>
<i>-- content FTS5 tables. </i>
CREATE TABLE %_content(id INTEGER PRIMARY KEY, c0, c1...);
</pre></div>

<p>The following sections describe in more detail how these five tables are
used to store FTS5 data.

</p><h2 id="varint_format"><span>9.1. </span>Varint Format</h2>

<p>The sections below refer to 64-bit signed integers stored in "varint" form.
FTS5 uses the same varint format as used in various places by the SQLite core.

</p><p>A varint is between 1 and 9 bytes in length. The varint consists of either
zero or more bytes which have the high-order bit set followed by a single byte
with the high-order bit clear, or nine bytes, whichever is shorter. The lower
seven bits of each of the first eight bytes and all 8 bits of the ninth byte
are used to reconstruct the 64-bit twos-complement integer. Varints are
big-endian: bits taken from the earlier byte of the varint are more significant
than bits taken from the later bytes.

</p><h2 id="the_fts_index_idx_and_data_tables_"><span>9.2. </span>The FTS Index (%_idx and %_data tables)</h2>

<p>The FTS index is an ordered key-value store where the keys are document
terms or term prefixes and the associated values are "doclists". A doclist is a
packed array of varints that encodes the position of each instance of the term
within the FTS5 table. The position of a single term instance is defined as the
combination of:

</p><ul>
  <li> The rowid of the FTS5 table row it appears in,
  </li><li> The index of the column the term instance appears in (columns are
       numbered from left to right starting from zero), and
  </li><li> The offset of the term within the column value (i.e. the number of
       tokens that appear within the column value before this one).
</li></ul>

<p>The FTS index contains up to (nPrefix+1) entries for each token in the
data set, where nPrefix is the number of defined <a href="#prefix_indexes">
prefix indexes</a>.

</p><p>Keys associated with the main FTS index (the one that is not a prefix
index) are prefixed with the character "0". Keys for the first prefix
index are prefixed with "1". Keys for the second prefix index are
prefixed with "2", and so on. For example, if the token "document" is
inserted into an FTS5 table with <a href="#prefix_indexes">prefix indexes</a>
specified by prefix="2 4", then the keys added to the FTS index would be
"0document", "1do" and "2docu".

</p><p>The FTS index entries are not stored in a single tree or hash table
structure. Instead, they are stored in a series of immutable b-tree like
structures referred to as "segment b-trees". Each time a write to the FTS5
table is committed, one or more (but usually just one) new segment b-trees
are added containing both the new entries and tombstones for any deleted
entries. When the FTS index is queried, the reader queries each segment
b-tree in turn and merges the results, giving priority to newer data.

</p><p>Each segment b-tree is assigned a numerical level. When a new segment
b-tree is written to the database as part of committing a transaction,
it is assigned to level 0. Segment b-trees belonging to a single level are
periodically merged together to create a single, larger segment b-tree
that is assigned to the next level (i.e. level 0 segment b-trees are
merged to become a single level 1 segment b-tree). Thus the numerically
larger levels contain older data in (usually) larger segment b-trees.
Refer to the
<a href="#the_automerge_configuration_option">'automerge'</a>,
<a href="#the_crisismerge_configuration_option">'crisismerge'</a> and
<a href="#the_usermerge_configuration_option">'usermerge'</a> options, along
with the
<a href="#the_merge_command">'merge'</a> and
<a href="#the_optimize_command">'optimize'</a> commands for details on how to
control the merging.

</p><p>In cases where the doclist associated with a term or term prefix is very
large, there may be an associated <a href="#doclist_index_format">doclist
index</a>. A doclist index is similar to the set of internal nodes of a b-tree.
It allows a large doclist to be efficiently queried for rowids or ranges of
rowids. For example, when processing a query like:

</p><div><pre>SELECT ... FROM fts_table('term') WHERE rowid BETWEEN ? AND ?
</pre></div>

<p>FTS5 uses the segment b-tree index to locate the doclist for term "term",
then uses its doclist index (assuming it is present) to efficiently identify
the subset of matches with rowids in the required range.

</p><h3 id="data_structure"><span>9.2.1. </span>The %_data Table Rowid Space</h3>

<div><pre>CREATE TABLE %_data(
  id INTEGER PRIMARY KEY,
  block BLOB
);
</pre></div>

<p>The %_data table is used to store three types of records:

</p><ul>
  <li> The special <a href="#structure_record_format">structure record</a>,
       stored with id=10.
  </li><li> The special <a href="#averages_record_format">averages record</a>,
       stored with id=1.
  </li><li> A record to store each <a href="#segment_b_tree_format">segment b-tree</a>
       leaf and <a href="#doclist_index_format">doclist index</a> leaf and
       internal node. See below for how id values are calculated for these
       records.
</li></ul>

<p>Each segment b-tree in the system is assigned a unique 16-bit segment id.
Segment ids may only be reused after the original owner segment b-tree is
completely merged into a higher level segment b-tree. Within a segment b-tree,
each leaf page is assigned a unique page number - 1 for the first leaf page, 2
for the second, and so on.

</p><p>Each doclist index leaf page is also assigned a page number. The first
(leftmost) leaf page in a doclist index is assigned the same page number as
the segment b-tree leaf page on which its term appears (because doclist indexes
are only created for terms with very long doclists, at most one term per
segment b-tree leaf has an associated doclist index). Call this page number P.
If the doclist is so large that it requires a second leaf, the second leaf is
assigned page number P+1. The third leaf P+2. Each tier of a doclist index
b-tree (leaves, parents of leaves, grandparents etc.) is assigned page numbers
in this fashion, starting with page number P.

</p><p>The "id" value used in the %_data table to store any given segment b-tree
leaf or doclist index leaf or node is composed as follows:

</p><table striped="1">
<tbody><tr><th>Rowid&nbsp;Bits </th><th>Contents
</th></tr><tr><td>38..43 </td><td> (16 bit) Segment b-tree id value.
</td></tr><tr><td>37 </td><td> (1 bit) Doclist index flag. Set for doclist index pages, clear
                for segment b-tree leaves.
</td></tr><tr><td>32..36 </td><td> (5 bits) Height in tree. This is set to 0 for segment b-tree
                    and doclist index leaves, to 1 for the parents of doclist
                    index leaves, 2 for the grandparents, etc.
</td></tr><tr><td>0..31 </td><td> (32 bits) Page number
</td></tr></tbody></table>

<h3 id="structure_record_format"><span>9.2.2. </span>Structure Record Format</h3>

<p>The structure record identifies the set of segment b-trees that make up the
current FTS index, along with details of any ongoing incremental merge
operations. It is stored in the %_data table with id=10.

A structure record begins with a single 32-bit unsigned value - the cookie
value.  This value is incremented each time the structure is modified.
Following the cookie value are three varint values, as follows:

</p><ul>
  <li> The number of levels in the index (i.e. the maximum level associated
       with any segment b-tree plus one).
  </li><li> The total number of segment b-trees in the index.
  </li><li> The total number of segment b-tree leaves written to level 0 trees
       since the FTS5 table was created.
</li></ul>

<p>Then, for each level from 0 to nLevel:

</p><ul>
  <li> The number of input segments from the previous level being used as
       inputs for the current incremental merge, or zero if there is no
       ongoing incremental merge to create a new segment b-tree for this level.
  </li><li> The total number of segment b-trees on the level.
  </li><li> Then, for each segment b-tree, from oldest to newest:
  <ul>
    <li> The segment id.
    </li><li> Page number of first leaf (often 1, always &gt;0).
    </li><li> Page number of last leaf (always &gt;0).
  </li></ul>
</li></ul>

<h3 id="averages_record_format"><span>9.2.3. </span>Averages Record Format</h3>

<p>The averages record, which is always stored with id=1 in the %_data table,
does not store the average of anything. Instead, it contains a vector of
(nCol+1) packed varint values, where nCol is the number of columns in the FTS5
table, including unindexed columns. The first varint contains the total
number of rows in the FTS5 table. The second contains the total number of
tokens in all values stored in the leftmost FTS5 table column. The third the
number of tokens in all values for the next leftmost, and so on. The value for
unindexed columns is always zero.

</p><h3 id="segment_b_tree_format"><span>9.2.4. </span>Segment B-Tree Format</h3>

<h4 id="the_key_doclist_format"><span>9.2.4.1. </span>The Key/Doclist Format</h4>

<p>The key/doclist format is a format used to store a series of keys (document
terms or term prefixes prefixed by a single character to indentify the specific
index to which they belong) in sorted order, each with their associated
doclist. The format consists of alternating keys and doclists packed together.

</p><p>The first key is stored as:
</p><ul>
  <li> A varint indicating the number of bytes in the key (N), followed by
  </li><li> The key data itself (N bytes).
</li></ul>

<p>Each subsequent key is stored as:
</p><ul>
  <li> A varint indicating the size of the prefix that the key has in common
       with the previous key in bytes,
  </li><li> A varint indicating the number of bytes in the key following the
       common prefix (N), followed by
  </li><li> The key suffix data itself (N bytes).
</li></ul>

<p>For example, if the first two keys in an FTS5 key/doclist record are
"0challenger" and "0chandelier", then the first key is stored as varint 11
followed by the 11 bytes "0challenger", and the second key is stored as varints
4 and 7, followed by the 7 bytes "ndelier".

</p><center><p><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 956.102 126.72">
<path d="M62,77L91,77L91,48L62,48Z" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<path d="M91,77L149,77L149,48L91,48Z" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<path d="M149,77L437,77L437,48L149,48Z" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<text x="293" y="63" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">doclist&nbsp;0</text>
<path d="M437,77L466,77L466,48L437,48Z" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<path d="M466,77L494,77L494,48L466,48Z" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<path d="M494,77L538,77L538,48L494,48Z" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<path d="M538,77L826,77L826,48L538,48Z" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<text x="682" y="63" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">doclist&nbsp;1</text>
<text x="892" y="63" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">key/doclist&nbsp;2...</text>
<path d="M826,48L883,48" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<path d="M826,77L883,77" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<text x="120" y="114" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">key&nbsp;0&nbsp;data</text>
<polygon points="120,77 124,89 116,89" style="fill:rgb(0,0,0)"></polygon>
<path d="M120,99L120,83" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<text x="77" y="12" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">key&nbsp;0&nbsp;size&nbsp;(varint)</text>
<polygon points="77,48 72,37 81,37" style="fill:rgb(0,0,0)"></polygon>
<path d="M77,27L77,43" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<text x="358" y="114" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">key&nbsp;1&nbsp;prefix&nbsp;size&nbsp;(varint)</text>
<polygon points="451,77 441,84 439,76" style="fill:rgb(0,0,0)"></polygon>
<path d="M358,99L446,79" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<text x="480" y="12" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">key&nbsp;1&nbsp;suffix&nbsp;size&nbsp;(varint)</text>
<polygon points="480,48 476,37 484,37" style="fill:rgb(0,0,0)"></polygon>
<path d="M480,27L480,43" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<text x="585" y="114" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">key&nbsp;1&nbsp;prefix&nbsp;data</text>
<polygon points="516,77 528,77 526,85" style="fill:rgb(0,0,0)"></polygon>
<path d="M585,99L521,79" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
</svg>
</p>
<p><i>Figure 1 - Term/Doclist Format
</i></p></center>

<p>Each doclist identifies the rows (by their rowid values) that contain at
least one instance of the term or term prefix and an associated position list,
or "poslist" enumerating the position of each term instance within the row. In
this sense a "position" is defined as a column number and term offset within
the column value.

</p><p>Within a doclist, documents are always stored in order sorted by rowid.  The
first rowid in a doclist is stored as is, as a varint. It is immediately
followed by its associated position list. Following this, the difference
between the first rowid and the second, as a varint, followed by the doclist
associated with the second rowid in the doclist. And so on.

</p><p>There is no way to determine the size of a doclist by parsing it. This must
be stored externally. See the <a href="#data_pagination">section below</a> for
details of how this is accomplished in FTS5.

</p><center><p><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 889.459 79.92">
<path d="M46,77L89,77L89,48L46,48Z" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<path d="M89,77L377,77L377,48L89,48Z" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<text x="233" y="63" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">position&nbsp;list&nbsp;0</text>
<path d="M377,77L420,77L420,48L377,48Z" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<path d="M420,77L708,77L708,48L420,48Z" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<text x="564" y="63" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">position&nbsp;list&nbsp;1</text>
<path d="M708,77L751,77L751,48L708,48Z" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<text x="822" y="63" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">position&nbsp;list&nbsp;2...</text>
<path d="M751,48L809,48" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<path d="M751,77L809,77" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<text x="67" y="12" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">rowid&nbsp;0&nbsp;(varint)</text>
<polygon points="67,48 63,37 72,37" style="fill:rgb(0,0,0)"></polygon>
<path d="M67,27L67,43" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<text x="398" y="12" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">rowid&nbsp;1&nbsp;(delta-encoded&nbsp;varint)</text>
<polygon points="398,48 394,37 403,37" style="fill:rgb(0,0,0)"></polygon>
<path d="M398,27L398,43" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<text x="730" y="12" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">rowid&nbsp;3&nbsp;(delta-encoded&nbsp;varint)</text>
<polygon points="730,48 725,37 734,37" style="fill:rgb(0,0,0)"></polygon>
<path d="M730,27L730,43" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
</svg>
</p>
<p><i>Figure 2 - Doclist Format
</i></p></center>

<p>A position list - often shortened to "poslist" - identifies the column
and token offset within the row of each instance of the token in question.
The format of a poslist is:

</p><ul>
  <li> Varint set to twice the size of the poslist, not including this field,
       plus one if the "delete" flag is set on the entry.
  </li><li> A (possibly empty) list of offsets for column 0 (the leftmost column) of
       the row. Each offset is stored as a varint. The first varint contains
       the value of the first offset, plus 2. The second variant contains the
       difference between the second and first offsets, plus 2. etc. For
       example, if the offset list is to contain offsets 0, 10, 15 and 16, it
       is encoded by packing the following values, encoded as varints, end to
       end:
       <pre>           2, 12, 7, 3
</pre>
  </li><li> For each column other than column 0 that contains one of more instances
       of the token:
  <ul>
    <li> Byte value 0x01.
    </li><li> The column number, as a varint.
    </li><li> An offset list, in the same format as the offset list for column 0.
  </li></ul>
</li></ul>

<center><p><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 785.606 133.92">
<path d="M77,77L121,77L121,48L77,48Z" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<path d="M121,77L409,77L409,48L121,48Z" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<text x="265" y="63" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">col&nbsp;0&nbsp;offset-list</text>
<path d="M409,77L452,77L452,48L409,48Z" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<text x="430" y="63" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">0x01</text>
<path d="M452,77L495,77L495,48L452,48Z" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<path d="M495,77L783,77L783,48L495,48Z" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<text x="639" y="63" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">col&nbsp;i&nbsp;offset-list</text>
<text x="99" y="12" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">nSize*2&nbsp;+&nbsp;bDel&nbsp;(varint)</text>
<polygon points="99,48 95,37 103,37" style="fill:rgb(0,0,0)"></polygon>
<path d="M99,27L99,43" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<text x="473" y="12" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">column&nbsp;number&nbsp;(i)</text>
<polygon points="473,48 469,37 478,37" style="fill:rgb(0,0,0)"></polygon>
<path d="M473,27L473,43" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<path d="M121,92L121,106L783,106L783,92" style="fill:none;stroke-width:2.16;stroke-linejoin:round;stroke:rgb(0,0,0);"></path>
<text x="452" y="121" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">nSize&nbsp;bytes</text>
</svg>
</p>
<p><i>Figure 3 - Position List (poslist) With Offsets in Columns 0 and i
</i></p></center>



<p>If it is small enough (by default this means smaller than 4000 bytes), the
entire contents of a segment b-tree may be stored in the key/doclist format
described in the previous section as a single blob within the %_data table.
Otherwise, the key/doclist is split into pages (by default, of approximately
4000 bytes each) and stored in a contiguous set of entries in the %_data table
(<a href="#data_structure">see above</a> for details).

</p><p>When a key/doclist is divided into pages, the following modifications are
made to the format:

</p><ul>
  <li> A single varint or key data field never spans two pages.
  </li><li> The first key on each page is not prefix-compressed. It is stored in
       the format described above for the first key of a doclist - its size as
       a varint followed by the key data.
  </li><li> If there are one or more rowids on a page before the first key, then
       the first of them is not delta compressed. It is stored as is, just as
       if it were the first rowid of its doclist (which it may or may not be).
</li></ul>

<p>Each page also has fixed-size 4-byte header and a variably-sized footer.
The header is divided into 2 16-bit big-endian integer fields. They
contain:

</p><ul>
  <li> The byte offset of the first rowid value on the page, if it occurs
       before the first key, or 0 otherwise.
  </li><li> The byte offset of the page footer.
</li></ul>

<p>The page footer consists of a series of varints containing the byte offset
of each key that appears on the page. The page footer is zero bytes in size
if there are no keys on the page.

</p><center><p><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 721.267 79.92">
<path d="M10,30L54,30L54,2L10,2Z" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<text x="32" y="16" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">hdr</text>
<path d="M54,30L630,30L630,2L54,2Z" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<text x="342" y="16" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">modified&nbsp;key/doclist&nbsp;data</text>
<path d="M630,30L702,30L702,2L630,2Z" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<text x="666" y="16" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">footer</text>
<text x="32" y="67" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">4&nbsp;bytes</text>
<text x="666" y="67" text-anchor="middle" fill="rgb(0,0,0)" dominant-baseline="central">variable&nbsp;size</text>
<polygon points="32,30 36,42 28,42" style="fill:rgb(0,0,0)"></polygon>
<path d="M32,52L32,36" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
<polygon points="666,30 670,42 661,42" style="fill:rgb(0,0,0)"></polygon>
<path d="M666,52L666,36" style="fill:none;stroke-width:2.16;stroke:rgb(0,0,0);"></path>
</svg>
</p>
<p><i>Figure 4 - Page Format
</i></p></center>

<h4 id="data_term_index"><span>9.2.4.3. </span>Segment Index Format</h4>

<p>The result of formatting the contents of the segment b-tree in the
key/doclist format and then splitting it into pages is something very
similar to the leaves of a b+tree. Instead of creating a format for
the internal nodes of this b+tree and storing them in the %_data table
alongside the leaves, the keys that would have been stored on such nodes are
added to the %_idx table, defined as:

</p><div><pre>CREATE TABLE %_idx(
  segid INTEGER,              <i>-- segment id</i>
  term TEXT,                  <i>-- prefix of first key on page</i>
  pgno INTEGER,               <i>-- (2*pgno + bDoclistIndex)</i>
  PRIMARY KEY(segid, term)
);
</pre></div>

<p>For each "leaf" page that contains at least one key, an entry is added
to the %_idx table. Fields are set as follows:

</p><table striped="1">
  <tbody><tr><th>Column</th><th>Contents
  </th></tr><tr><td>segid</td><td>   The integer segment id.
  </td></tr><tr><td>term</td><td>    The smallest prefix of the first key on the page that
                      is larger than all keys on the previous page. For the
                      first page in a segment, this prefix is zero bytes in
                      size.
  </td></tr><tr><td>pgno</td><td>    This field encodes both the page number (within the
                      segment - starting from 1) and the doclist index flag.
                      The doclist index flag is set if the final key on the
                      page has an <a href="#doclist_index_format">associated
                      doclist index</a>. The value of this field is:
                      <pre>       (pgno*2 + bDoclistIndexFlag)
</pre>
</td></tr></tbody></table>

<p>Then, to find the leaf for segment i that may contain term t, instead of
searching through internal nodes, FTS5 runs the query:

</p><div><pre>SELECT pgno FROM %_idx WHERE segid=$i AND term&gt;=$t ORDER BY term LIMIT 1
</pre></div>

<h4 id="doclist_index_format"><span>9.2.4.4. </span>Doclist Index Format</h4>

<p>The segment index described in the <a href="#data_term_index">previous
section</a> allows a segment b-tree to be efficiently queried by term or,
assuming there is a prefix index of the required size, a term prefix. The data
structure described in this section, doclist indexes, allows FTS5 to
efficiently search for a rowid or range or rowids within the doclist associated
with a single term or term prefix.

</p><p>Not all keys have associated doclists indexes. By default, a doclist index
is only added for a key if its doclist spans more than 4 segment b-tree leaf
pages. Doclist indexes are themselves b-trees, with both leaves and internal
nodes stored as entries in the %_data table, but in practice most doclists are
small enough to fit on a single leaf. FTS5 uses the same rough size for doclist
index node and leaves as it does for segment b-tree leaves (by default 4000
bytes).

</p><p>Doclist index leaves and internal nodes use the same page format. The first
byte is a "flags" byte. This is set to 0x00 for the root page of the doclist
index b-tree, and 0x01 for all other pages. The remainder of the page is a
series of tightly packed varints, as follows:

</p><ul>
  <li> page number of leftmost child page, followed by
  </li><li> the smallest rowid value on the left most child page, followed by
  </li><li> one varint for each subsequent child page, containing the value:
  <ul>
    <li> 0x00 if there are no rowids on the child page (this can only happen
         when the "child" page is actually a segment b-tree leaf), or
    </li><li> the difference between the smallest rowid on the child page and
         the previous rowid value stored on the doclist index page.
  </li></ul>
</li></ul>

<p>For the leftmost doclist index leaf in a doclist index, the leftmost child
page is the first segment b-tree leaf after the one that contains the key
itself.

</p><h2 id="document_sizes_table_docsize_table_"><span>9.3. </span>Document Sizes Table (%_docsize table)</h2>

<div><pre>CREATE TABLE %_docsize(
    id INTEGER PRIMARY KEY,   -- id of FTS5 row this record pertains to
    sz BLOB                   -- blob containing nCol packed varints
);
</pre></div>

<p>Many common search result ranking functions require as an input the size
in tokens of the result document (as a search term hit in a short document is
considered more significant than one in a long document). To provide fast
access to this information, for each row in the FTS5 table there exists a
corresponding record (with the same rowid) in the %_docsize shadow table
that contains the size of each column value in the row, in tokens.

</p><p>The column value sizes are stored in a blob containing one packed varint for
each column of the FTS5 table, from left to right. The varint contains, of
course, the total number of tokens in the corresponding column value. Unindexed
columns are included in this vector of varints; for them the value is always
set to zero.

</p><p>This table is used by the <a href="#xColumnSize">xColumnSize</a> API. It can
be omitted altogether by specifying the
<a href="#the_columnsize_option">columnsize=0</a> option. In that case the
xColumnSize API is still available to auxiliary functions, but runs much more
slowly.

</p><h2 id="the_table_contents_content_table_"><span>9.4. </span>The Table Contents (%_content table)</h2>

<div><pre>CREATE TABLE %_content(id INTEGER PRIMARY KEY, c0, c1...);
</pre></div>

<p>The actual table content - the values inserted into the FTS5 table, is
stored in the %_content table. This table is created with one "c*" column for
each column of the FTS5 table, including any unindexed columns. The values for
the leftmost FTS5 table column are stored in column "c0" of the %_content
table, the values from the next FTS5 table column in column "c1", and so on.

</p><p>This table is omitted completely for
<a href="#external_content_and_contentless_tables">
external content or contentless</a> FTS5 tables.
tables.

</p><h2 id="configuration_options_config_table_"><span>9.5. </span>Configuration Options (%_config table)</h2>

<div><pre>CREATE TABLE %_config(k PRIMARY KEY, v) WITHOUT ROWID;
</pre></div>

<p>This table stores the values of any persistent configuration options.
Column "k" stores the name of the option (text) and column "v" the value.
Example contents:

</p><div><pre>sqlite&gt; SELECT * FROM fts_tbl_config;
┌─────────────┬──────┐
│      k      │  v   │
├─────────────┼──────┤
│ crisismerge │ 8    │
│ pgsz        │ 8000 │
│ usermerge   │ 4    │
│ version     │ 4    │
└─────────────┴──────┘
</pre></div>

<h2 id="appendix_a" nonumber="1" tags="comparison with fts4">
  Appendix A: Comparison with FTS3/4
</h2>

<p> Also available is the similar but more mature <a href="https://www.sqlite.org/fts3.html">FTS3/4</a> module.
FTS5 is a new version of FTS4 that includes various fixes and solutions for
problems that could not be fixed in FTS4 without sacrificing backwards
compatibility. Some of these problems are
<a href="https://www.sqlite.org/fts5.html#_summary_of_technical_differences_">described below</a>.

</p><h2 nonumber="1" id="_application_porting_guide_"> Application Porting Guide </h2>

<p> In order to use FTS5 instead of FTS3 or FTS4, applications usually require
minimal modifications. Most of these fall into three categories - changes
required to the CREATE VIRTUAL TABLE statement used to create the FTS table,
changes required to SELECT queries used to execute queries against the table,
and changes required to applications that use <a href="https://www.sqlite.org/fts3.html#snippet">FTS auxiliary functions</a>.

</p><h3 nonumber="1" id="_changes_to_create_virtual_table_statements_"> Changes to CREATE VIRTUAL TABLE statements </h3>

<ol>
<li> <p>The module name must be changed from "fts3" or "fts4" to "fts5".

</p></li><li> <p>All type information or constraint specifications must be removed from
     column definitions. FTS3/4 ignores everything following the column name in
     a column definition, FTS5 attempts to parse it (and will report an error
     if it fails to).

</p></li><li> <p>The "matchinfo=fts3" option is not available. The
     <a href="https://www.sqlite.org/fts5.html#the_columnsize_option">"columnsize=0"</a> option is equivalent.

</p></li><li> <p>The notindexed= option is not available. Adding <a href="https://www.sqlite.org/fts5.html#the_unindexed_column_option">UNINDEXED</a>
     to the column definition is equivalent.

</p></li><li> <p>The ICU tokenizer is not available.

</p></li><li> <p>The compress=, uncompress= and languageid= options are not available.
     There is as of yet no equivalent for their functionality.
</p></li></ol>

<div><pre><i> -- FTS3/4 statement </i>
CREATE VIRTUAL TABLE t1 USING fts4(
  linkid INTEGER,
  header CHAR(20),
  text VARCHAR,
  notindexed=linkid,
  matchinfo=fts3,
  tokenizer=unicode61
);

<i> -- FTS5 equivalent (note - the "tokenizer=unicode61" option is not</i>
<i> -- required as this is the default for FTS5 anyway)</i>
CREATE VIRTUAL TABLE t1 USING fts5(
  linkid UNINDEXED,
  header,
  text,
  columnsize=0
);
</pre></div>

<h3 nonumber="1" id="_changes_to_select_statements_"> Changes to SELECT statements </h3>

<ol>
  <li> <p>The "docid" alias does not exist. Applications must use "rowid"
          instead.

  </p></li><li> <p>The behaviour of queries when a column-filter is specified both as
          part of the FTS query and by using a column as the LHS of a MATCH
          operator is slightly different. For a table with columns "a" and "b"
          and a query similar to:
</p>
       <p>FTS3/4 searches for matches in column "b". However, FTS5 always
          returns zero rows, as results are first filtered for column "b", then
          for column "a", leaving no results. In other words, in FTS3/4 the
          inner filter overrides the outer, in FTS5 both filters are applied.

  </p></li><li> <p>The FTS query syntax (right hand side of the MATCH operator) has
          changed in some ways. The FTS5 syntax is quite close to the FTS4
          "enhanced syntax". The main difference is that FTS5 is fussier
          about unrecognized punctuation characters and similar within query
          strings. Most queries that work with FTS3/4 should also work with
          FTS5, and those that do not should return parse errors.
</p></li></ol>

<h3 nonumber="1" id="_auxiliary_function_changes_"> Auxiliary Function Changes </h3>

<p> FTS5 has no matchinfo() or offsets() function, and the snippet() function
is not as fully-featured as in FTS3/4. However, since FTS5 does provide
an API allowing applications to create <a href="https://www.sqlite.org/fts5.html#custom_auxiliary_functions_api_reference">custom auxiliary functions</a>, any
required functionality may be implemented within the application code.

</p><p> The set of built-in auxiliary functions provided by FTS5 may be
improved upon in the future.

</p><h3 nonumber="1" id="_other_issues"> Other Issues</h3>

<ol>
  <li><p> The functionality provided by the fts4aux module is now provided
          by <a href="https://www.sqlite.org/fts5.html#the_fts5vocab_virtual_table_module">fts5vocab</a>. The schema of these two tables is slightly different.

  </p></li><li><p> The FTS3/4 "merge=X,Y" command has been replaced by the
          <a href="https://www.sqlite.org/fts5.html#the_merge_command">FTS5 merge command</a>.

  </p></li><li><p> The FTS3/4 "automerge=X" command has been replaced by the
          <a href="https://www.sqlite.org/fts5.html#the_automerge_configuration_option">FTS5 automerge option</a>.
</p></li></ol>

<h2 nonumber="1" tags="fts5 technical differences" id="_summary_of_technical_differences_">
  Summary of Technical Differences
</h2>

<p>FTS5 is similar to FTS3/4 in that the primary task of each is to maintain
an index mapping from each unique token to a list of instances of that token
within a set of documents, where each instance is identified by the document
in which it appears and its position within that document. For example:

</p><div><pre><i>-- Given the following SQL:</i>
CREATE VIRTUAL TABLE ft USING fts5(a, b);
INSERT INTO ft(rowid, a, b) VALUES(1, 'X Y', 'Y Z');
INSERT INTO ft(rowid, a, b) VALUES(2, 'A Z', 'Y Y');

<i>-- The FTS5 module creates the following mapping on disk:</i>
A --&gt; (2, 0, 0)
X --&gt; (1, 0, 0)
Y --&gt; (1, 0, 1) (1, 1, 0) (2, 1, 0) (2, 1, 1)
Z --&gt; (1, 1, 1) (2, 0, 1)
</pre></div>

<p>In the example above, each triple identifies the location of a token
instance by rowid, column number (columns are numbered sequentially
starting at 0 from left to right) and position within the column value (the
first token in a column value is 0, the second is 1, and so on). Using this
index, FTS5 is able to provide timely answers to queries such as "the set
of all documents that contain the token 'A'", or "the set of all documents
that contain the sequence 'Y Z'". The list of instances associated with a
single token is called an "instance-list".

</p><p>The principle difference between FTS3/4 and FTS5 is that in FTS3/4,
each instance-list is stored as a single large database record, whereas
in FTS5 large instance-lists are divided between multiple database records.
This has the following implications for dealing with large databases that
contain large lists:

</p><ul>
  <li> <p>FTS5 is able to load instance-lists into memory incrementally in
       order to reduce memory usage and peak allocation size. FTS3/4 very
       often loads entire instance-lists into memory.

  </p></li><li> <p>When processing queries that feature more than one token, FTS5 is
       sometimes able to determine that the query can be answered by
       inspecting a subset of a large instance-list. FTS3/4 almost always
       has to traverse entire instance-lists.

  </p></li><li> If an instance-list grows so large that it exceeds
       the <a href="https://www.sqlite.org/limits.html#max_length">SQLITE_MAX_LENGTH</a> limit, FTS3/4 is unable to handle it. FTS5
       does not have this problem.
</li></ul>

<p>For these reasons, many complex queries may use less memory and run faster
using FTS5.

</p><p>Some other ways in which FTS5 differs from FTS3/4 are:

</p><ul>
  <li> <p>FTS5 supports "ORDER BY rank" for returning results in order of
       decreasing relevancy.

  </p></li><li> <p>FTS5 features an API allowing users to create custom auxiliary
       functions for advanced ranking and text processing applications. The
       special "rank" column may be mapped to a custom auxiliary function
       so that adding "ORDER BY rank" to a query works as expected.

  </p></li><li> <p>FTS5 recognizes unicode separator characters and case equivalence by
       default. This is also possible using FTS3/4, but must be explicitly
       enabled.

  </p></li><li> <p>The query syntax has been revised where necessary to remove
       ambiguities and to make it possible to escape special characters
       in query terms.

  </p></li><li> <p>By default, FTS3/4 occasionally merges together two or more of the
       b-trees that make up its full-text index within an INSERT, UPDATE or
       DELETE statement executed by the user. This means that any operation
       on an FTS3/4 table may turn out to be surprisingly slow, as FTS3/4
       may unpredictably choose to merge together two or more large b-trees
       within it. FTS5 uses incremental merging by default, which limits
       the amount of processing that may take place within any given
       INSERT, UPDATE or DELETE operation.
</p></li></ul>
<p><small><i>This page last modified on  <a href="https://sqlite.org/docsrc/honeypot" id="mtimelink" data-href="https://sqlite.org/docsrc/finfo/pages/fts5.in?m=39d9a3b727">2024-05-22 18:42:01</a> UTC </i></small></p>

</div></div>]]></description>
        </item>
    </channel>
</rss>