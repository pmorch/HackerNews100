<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>HN100 - Readable Contents</title>
        <link>https://hn.algolia.com/api/v1/search_by_date?tags=%28story,poll%29&amp;numericFilters=points%3E100</link>
        <description>Uses Readability to add bodies to the RSS feed</description>
        <lastBuildDate>Sat, 22 Mar 2025 17:30:03 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[PyTorch Internals: Ezyang's Blog (105 pts)]]></title>
            <link>https://blog.ezyang.com/2019/05/pytorch-internals/</link>
            <guid>43445931</guid>
            <pubDate>Sat, 22 Mar 2025 14:39:04 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://blog.ezyang.com/2019/05/pytorch-internals/">https://blog.ezyang.com/2019/05/pytorch-internals/</a>, See on <a href="https://news.ycombinator.com/item?id=43445931">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>


<!-- -*- mode: rst -*- -->
<p>This post is a long form essay version of a talk about PyTorch internals, that I gave at the PyTorch NYC meetup on May 14, 2019.</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-01.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-01.png"></p></div>
<p>Hi everyone!  Today I want to talk about the internals of <a href="https://pytorch.org/">PyTorch</a>.</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-02.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-02.png"></p></div>
<p>This talk is for those of you who have used PyTorch, and thought to yourself, "It would be great if I could contribute to PyTorch," but were scared by PyTorch's behemoth of a C++ codebase.  I'm not going to lie: the PyTorch codebase can be a bit overwhelming at times. The purpose of this talk is to put a map in your hands: to tell you about the basic conceptual structure of a "tensor library that supports automatic differentiation", and give you some tools and tricks for finding your way around the codebase.  I'm going to assume that you've written some PyTorch before, but haven't necessarily delved deeper into how a machine learning library is written.</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-03.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-03.png"></p></div>
<p>The talk is in two parts: in the first part, I'm going to first introduce you to the conceptual universe of a tensor library.  I'll start by talking about the tensor data type you know and love, and give a more detailed discussion about what exactly this data type provides, which will lead us to a better understanding of how it is actually implemented under the hood.  If you're an advanced user of PyTorch, you'll be familiar with most of this material.  We'll also talk about the trinity of "extension points", layout, device and dtype, which guide how we think about extensions to the tensor class.  In the live talk at PyTorch NYC, I skipped the slides about autograd, but I'll talk a little bit about them in these notes as well.</p>
<p>The second part grapples with the actual nitty gritty details involved with actually coding in PyTorch.  I'll tell you how to cut your way through swaths of autograd code, what code actually matters and what is legacy, and also all of the cool tools that PyTorch gives you for writing kernels.</p>
<hr>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-04.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-04.png"></p></div>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-05.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-05.png"></p></div>
<p>The tensor is the central data structure in PyTorch.  You probably have a pretty good idea about what a tensor intuitively represents: its an n-dimensional data structure containing some sort of scalar type, e.g., floats, ints, et cetera.  We can think of a tensor as consisting of some data, and then some metadata describing the size of the tensor, the type of the elements in contains (dtype), what device the tensor lives on (CPU memory? CUDA memory?)</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-06.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-06.png"></p></div>
<p>There's also a little piece of metadata you might be less familiar with: the stride.  Strides are actually one of the distinctive features of PyTorch, so it's worth discussing them a little more.</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-07.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-07.png"></p></div>
<p>A tensor is a mathematical concept.  But to represent it on our computers, we have to define some sort of physical representation for them.  The most common representation is to lay out each element of the tensor contiguously in memory (that's where the term contiguous comes from), writing out each row to memory, as you see above. In the example above, I've specified that the tensor contains 32-bit integers, so you can see that each integer lies in a physical address, each offset four bytes from each other.  To remember what the actual dimensions of the tensor are, we have to also record what the sizes are as extra metadata.</p>
<p>So, what do strides have to do with this picture?</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-08.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-08.png"></p></div>
<p>Suppose that I want to access the element at position <tt>tensor[1, 0]</tt> in my logical representation.  How do I translate this logical position into a location in physical memory?  Strides tell me how to do this: to find out where any element for a tensor lives, I multiply each index with the respective stride for that dimension, and sum them all together.  In the picture above, I've color coded the first dimension blue and the second dimension red, so you can follow the index and stride in the stride calculation.  Doing this sum, I get two (zero-indexed), and indeed, the number three lives two below the beginning of the contiguous array.</p>
<p>(Later in the talk, I'll talk about TensorAccessor, a convenience class that handles the indexing calculation.  When you use TensorAccessor, rather than raw pointers, this calculation is handled under the covers for you.)</p>
<p>Strides are the fundamental basis of how we provide views to PyTorch users.  For example, suppose that I want to extract out a tensor that represents the second row of the tensor above:</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-09.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-09.png"></p></div>
<p>Using advanced indexing support, I can just write <tt>tensor[1, :]</tt> to get this row.  Here's the important thing: when I do this, I don't create a new tensor; instead, I just return a tensor which is a different view on the underlying data.  This means that if I, for example, edit the data in that view, it will be reflected in the original tensor.  In this case, it's not too hard to see how to do this: three and four live in contiguous memory, and all we need to do is record an offset saying that the data of this (logical) tensor lives two down from the top.  (Every tensor records an offset, but most of the time it's zero, and I'll omit it from my diagrams when that's the case.)</p>
<!--  -->
<blockquote>
<p>Question from the talk: If I take a view on a tensor, how do I free the memory of the underlying tensor?</p>
<p>Answer: You have to make a copy of the view, thus disconnecting it from the original physical memory.  There's really not much else you can do.  By the way, if you have written Java in the old days, taking substrings of strings has a similar problem, because by default no copy is made, so the substring retains the (possibly very large string). Apparently, they <a href="https://stackoverflow.com/questions/14161050/java-string-substring-method-potential-memory-leak">fixed this in Java 7u6</a>.</p>
</blockquote>
<p>A more interesting case is if I want to take the first column:</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-10.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-10.png"></p></div>
<p>When we look at the physical memory, we see that the elements of the column are not contiguous: there's a gap of one element between each one.  Here, strides come to the rescue: instead of specifying a stride of one, we specify a stride of two, saying that between one element and the next, you need to jump two slots.  (By the way, this is why it's called a "stride": if we think of an index as walking across the layout, the stride says how many locations we stride forward every time we take a step.)</p>
<p>The stride representation can actually let you represent all sorts of interesting views on tensors; if you want to play around with the possibilities, check out the <a href="https://ezyang.github.io/stride-visualizer/index.html">Stride Visualizer</a>.</p>
<p>Let's step back for a moment, and think about how we would actually implement this functionality (after all, this is an internals talk.)  If we can have views on tensor, this means we have to decouple the notion of the tensor (the user-visible concept that you know and love), and the actual physical data that stores the data of the tensor (called storage):</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-11.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-11.png"></p></div>
<p>There may be multiple tensors which share the same storage.  Storage defines the dtype and physical size of the tensor, while each tensor records the sizes, strides and offset, defining the logical interpretation of the physical memory.</p>
<p>One thing to realize is that there is always a pair of Tensor-Storage, even for "simple" cases where you don't really need a storage (e.g., you just allocated a contiguous tensor with <tt>torch.zeros(2, 2)</tt>).</p>
<!--  -->
<blockquote>
By the way, we're interested in making this picture not true; instead of having a separate concept of storage, just define a view to be a tensor that is backed by a base tensor.  This is a little more complicated, but it has the benefit that contiguous tensors get a much more direct representation without the Storage indirection.  A change like this would make PyTorch's internal representation a bit more like Numpy's.</blockquote>
<hr>
<p>We've talked quite a bit about the data layout of tensor (some might say, if you get the data representation right, everything else falls in place).  But it's also worth briefly talking about how operations on the tensor are implemented.  At the very most abstract level, when you call <tt>torch.mm</tt>, two dispatches happen:</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-12.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-12.png"></p></div>
<p>The first dispatch is based on the device type and layout of a tensor: e.g., whether or not it is a CPU tensor or a CUDA tensor (and also, e.g., whether or not it is a strided tensor or a sparse one).  This is a dynamic dispatch: it's a virtual function call (exactly where that virtual function call occurs will be the subject of the second half of this talk).  It should make sense that you need to do a dispatch here: the implementation of CPU matrix multiply is quite different from a CUDA implementation.  It is a <em>dynamic</em> dispatch because these kernels may live in separate libraries (e.g., <tt>libcaffe2.so</tt> versus <tt>libcaffe2_gpu.so</tt>), and so you have no choice: if you want to get into a library that you don't have a direct dependency on, you have to dynamic dispatch your way there.</p>
<p>The second dispatch is a dispatch on the dtype in question.  This dispatch is just a simple switch-statement for whatever dtypes a kernel chooses to support.  Upon reflection, it should also make sense that we need to a dispatch here: the CPU code (or CUDA code, as it may) that implements multiplication on <tt>float</tt> is different from the code for <tt>int</tt>.  It stands to reason you need separate kernels for each dtype.</p>
<p>This is probably the most important mental picture to have in your head, if you're trying to understand the way operators in PyTorch are invoked.  We'll return to this picture when it's time to look more at code.</p>
<hr>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-13.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-13.png"></p></div>
<p>Since we have been talking about Tensor, I also want to take a little time to the world of tensor extensions.  After all, there's more to life than dense, CPU float tensors.  There's all sorts of interesting extensions going on, like XLA tensors, or quantized tensors, or MKL-DNN tensors, and one of the things we have to think about, as a tensor library, is how to accommodate these extensions.</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-14.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-14.png"></p></div>
<p>Our current model for extensions offers four extension points on tensors.  First, there is the trinity three parameters which uniquely determine what a tensor is:</p>
<ul>
<li>The <strong>device</strong>, the description of where the tensor's physical memory is actually stored, e.g., on a CPU, on an NVIDIA GPU (cuda), or perhaps on an AMD GPU (hip) or a TPU (xla).  The distinguishing characteristic of a device is that it has its own allocator, that doesn't work with any other device.</li>
<li>The <strong>layout</strong>, which describes how we logically interpret this physical memory.  The most common layout is a strided tensor, but sparse tensors have a different layout involving a pair of tensors, one for indices, and one for data; MKL-DNN tensors may have even more exotic layout, like blocked layout, which can't be represented using merely strides.</li>
<li>The <strong>dtype</strong>, which describes what it is that is actually stored in each element of the tensor.  This could be floats or integers, or it could be, for example, quantized integers.</li>
</ul>
<p>If you want to add an extension to PyTorch tensors (by the way, if that's what you want to do, please talk to us!  None of these things can be done out-of-tree at the moment), you should think about which of these parameters you would extend.  The Cartesian product of these parameters define all of the possible tensors you can make.  Now, not all of these combinations may actually have kernels (who's got kernels for sparse, quantized tensors on FPGA?) but in <em>principle</em> the combination could make sense, and thus we support expressing it, at the very least.</p>
<p>There's one last way you can make an "extension" to Tensor functionality, and that's write a wrapper class around PyTorch tensors that implements your object type.  This perhaps sounds obvious, but sometimes people reach for extending one of the three parameters when they should have just made a wrapper class instead.  One notable merit of wrapper classes is they can be developed entirely out of tree.</p>
<p>When should you write a tensor wrapper, versus extending PyTorch itself?  The key test is whether or not you need to pass this tensor along during the autograd backwards pass.  This test, for example, tells us that sparse tensor should be a true tensor extension, and not just a Python object that contains an indices and values tensor: when doing optimization on networks involving embeddings, we want the gradient generated by the embedding to be sparse.</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-15.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-15.png"></p></div>
<p>Our philosophy on extensions also has an impact of the data layout of tensor itself.  One thing we really want out of our tensor struct is for it to have a fixed layout: we don't want fundamental (and very frequently called) operations like "What's the size of a tensor?" to require virtual dispatches.  So when you look at the actual layout of a Tensor (defined in the <a href="https://github.com/pytorch/pytorch/blob/master/c10/core/TensorImpl.h">TensorImpl struct</a>),  what we see is a common prefix of all fields that we consider all "tensor"-like things to universally have, plus a few fields that are only really applicable for strided tensors, but are <em>so</em> important that we've kept them in the main struct, and then a suffix of custom fields that can be done on a per-Tensor basis.  Sparse tensors, for example, store their indices and values in this suffix.</p>
<hr>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-16.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-16.png"></p></div>
<p>I told you all about tensors, but if that was the only thing PyTorch provided, we'd basically just be a Numpy clone.  The distinguishing characteristic of PyTorch when it was originally released was that it provided automatic differentiation on tensors (these days, we have other cool features like TorchScript; but back then, this was it!)</p>
<p>What does automatic differentiation do?  It's the machinery that's responsible for taking a neural network:</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-17.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-17.png"></p></div>
<p>...and fill in the missing code that actually computes the gradients of your network:</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-18.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-18.png"></p></div>
<p>Take a moment to study this diagram.  There's a lot to unpack; here's what to look at:</p>
<ol>
<li>First, rest your eyes on the variables in red and blue.  PyTorch implements <a href="https://en.wikipedia.org/wiki/Automatic_differentiation#Reverse_accumulation">reverse-mode automatic differentiation</a>, which means that we effectively walk the forward computations "backward" to compute the gradients.  You can see this if you look at the variable names: at the bottom of the red, we compute <tt>loss</tt>; then, the first thing we do in the blue part of the program is compute <tt>grad_loss</tt>.  <tt>loss</tt> was computed from <tt>next_h2</tt>, so we compute <tt>grad_next_h2</tt>.  Technically, these variables which we call <tt>grad_</tt> are not really gradients; they're really Jacobians left-multiplied by a vector, but in PyTorch we just call them <tt>grad</tt> and mostly everyone knows what we mean.</li>
<li>If the structure of the code stays the same, the behavior doesn't: each line from forwards is replaced with a different computation, that represents the derivative of the forward operation.  For example, the <tt>tanh</tt> operation is translated into a <tt>tanh_backward</tt> operation (these two lines are connected via a grey line on the left hand side of the diagram).  The inputs and outputs of the forward and backward operations are swapped: if the forward operation produced <tt>next_h2</tt>, the backward operation takes <tt>grad_next_h2</tt> as an input.</li>
</ol>
<p>The whole point of autograd is to do the computation that is described by this diagram, but without actually ever generating this source.  PyTorch autograd doesn't do a source-to-source transformation (though PyTorch JIT does know how to do symbolic differentiation).</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-19.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-19.png"></p></div>
<p>To do this, we need to store more metadata when we carry out operations on tensors.  Let's adjust our picture of the tensor data structure: now instead of just a tensor which points to a storage, we now have a variable which wraps this tensor, and also stores more information (AutogradMeta), which is needed for performing autograd when a user calls <tt>loss.backward()</tt> in their PyTorch script.</p>
<!--  -->
<blockquote>
This is yet another slide which will hopefully be out of date in the near future.  Will Feng is working on a <a href="https://github.com/pytorch/pytorch/issues/13638">Variable-Tensor merge in C++</a>, following a simple merge which happened to PyTorch's frontend interface.</blockquote>
<p>We also have to update our picture about dispatch:</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-20.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-20.png"></p></div>
<p>Before we dispatch to CPU or CUDA implementations, there is another dispatch on variables, which is responsible for unwrapping variables, calling the underlying implementation (in green), and then rewrapping the results into variables and recording the necessary autograd metadata for backwards.</p>
<p>Some implementations don't unwrap; they just call into other variable implementations.  So you might spend a while in the Variable universe.  However, once you unwrap and go into the non-Variable Tensor universe, that's it; you never go back to Variable (except by returning from your function.)</p>
<hr>
<p>In my NY meetup talk, I skipped the following seven slides.  I'm also going to delay writeup for them; you'll have to wait for the sequel for some text.</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-21.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-21.png"></p></div>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-22.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-22.png"></p></div>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-23.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-23.png"></p></div>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-24.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-24.png"></p></div>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-25.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-25.png"></p></div>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-26.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-26.png"></p></div>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-27.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-27.png"></p></div>
<hr>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-28.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-28.png"></p></div>
<p>Enough about concepts, let's look at some code.</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-29.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-29.png"></p></div>
<p>PyTorch has a lot of folders, and there is a very detailed description of what they are in the <a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md#codebase-structure">CONTRIBUTING</a> document, but really, there are only four directories you really need to know about:</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-30.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-30.png"></p></div>
<ul>
<li>First, <tt>torch/</tt> contains what you are most familiar with: the actual Python modules that you import and use.  This stuff is Python code and easy to hack on (just make a change and see what happens).  However, lurking not too deep below the surface is...</li>
<li><tt>torch/csrc/</tt>, the C++ code that implements what you might call the frontend of PyTorch.  In more descriptive terms, it implements the binding code that translates between the Python and C++ universe, and also some pretty important pieces of PyTorch, like the autograd engine and the JIT compiler.  It also contains the C++ frontend code.</li>
<li><tt>aten/</tt>, short for "A Tensor Library" (coined by Zachary DeVito), is a C++ library that implements the operations of Tensors.  If you're looking for where some kernel code lives, chances are it's in ATen.  ATen itself bifurcates into two neighborhoods of operators: the "native" operators, which are modern, C++ implementations of operators, and the "legacy" operators (TH, THC, THNN, THCUNN), which are legacy, C implementations.  The legacy operators are the bad part of town; try not to spend too much time there if you can.</li>
<li><tt>c10/</tt>, which is a pun on Caffe2 and A"Ten" (get it? Caffe 10) contains the core abstractions of PyTorch, including the actual implementations of the Tensor and Storage data structures.</li>
</ul>
<p>That's a lot of places to look for code; we should probably simplify the directory structure, but that's how it is.  If you're trying to work on operators, you'll spend most of your time in <tt>aten</tt>.</p>
<p>Let's see how this separation of code breaks down in practice:</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-31.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-31.png"></p></div>
<p>When you call a function like <tt>torch.add</tt>, what actually happens?  If you remember the discussion we had about dispatching, you already have the basic picture in your head:</p>
<ol>
<li>We have to translate from Python realm to the C++ realm (Python argument parsing)</li>
<li>We handle <strong>variable</strong> dispatch (VariableType--Type, by the way, doesn't really have anything to do programming language types, and is just a gadget for doing dispatch.)</li>
<li>We handle <strong>device type / layout</strong> dispatch (Type)</li>
<li>We have the actual kernel, which is either a modern native function, or a legacy TH function.</li>
</ol>
<p>Each of these steps corresponds concretely to some code.  Let's cut our way through the jungle.</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-32.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-32.png"></p></div>
<p>Our initial landing point in the C++ code is the C implementation of a Python function, which we've exposed to the Python side as something like <tt>torch._C.VariableFunctions.add</tt>.  <tt>THPVariable_add</tt> is the implementation of one such implementation.</p>
<p>One important thing to know about this code is that it is auto-generated.  If you search in the GitHub repository, you won't find it, because you have to actually build PyTorch to see it.  Another important thing is, you don't have to really deeply understand what this code is doing; the idea is to skim over it and get a sense for what it is doing.  Above, I've annotated some of the most important bits in blue: you can see that there is a use of a class <tt>PythonArgParser</tt> to actually pull out C++ objects out of the Python <tt>args</tt> and <tt>kwargs</tt>; we then call a <tt>dispatch_add</tt> function (which I've inlined in red); this releases the global interpreter lock and then calls a plain old method on the C++ Tensor <tt>self</tt>.  On its way back, we rewrap the returned <tt>Tensor</tt> back into a <tt>PyObject</tt>.</p>
<p>(At this point, there's an error in the slides: I'm supposed to tell you about the Variable dispatch code.  I haven't fixed it here yet.  Some magic happens, then...)</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-33.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-33.png"></p></div>
<p>When we call the <tt>add</tt> method on the <tt>Tensor</tt> class, no virtual dispatch happens yet.  Instead, we have an inline method which calls a virtual method on a "Type" object.  This method is the actual virtual method (this is why I say Type is just a "gadget" that gets you dynamic dispatch.)  In the particular case of this example, this virtual call dispatches to an implementation of add on a class named <tt>TypeDefault</tt>.  This happens to be because we have an implementation of <tt>add</tt> that is the same for every device type (both CPU and CUDA); if we had happened to have different implementations, we might have instead landed on something like <tt><span>CPUFloatType::add</span></tt>.  It is this implementation of the virtual method that finally gets us to the actual kernel code.</p>
<!--  -->
<blockquote>
Hopefully, this slide will be out-of-date very soon too; Roy Li is working on replacing <tt>Type</tt> dispatch with another mechanism which will help us better support PyTorch on mobile.</blockquote>
<p>It's worth reemphasizing that all of the code, until we got to the kernel, is automatically generated.</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-34.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-34.png"></p></div>
<p>It's a bit twisty and turny, so once you have some basic orientation about what's going on, I recommend just jumping straight to the kernels.</p>
<hr>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-35.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-35.png"></p></div>
<p>PyTorch offers a lot of useful tools for prospective kernel writers.  In this section, we'll walk through a few of them.  But first of all, what do you need to write a kernel?</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-36.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-36.png"></p></div>
<p>We generally think of a kernel in PyTorch consisting of the following parts:</p>
<ol>
<li>First, there's some metadata which we write about the kernel, which powers the code generation and lets you get all the bindings to Python, without having to write a single line of code.</li>
<li>Once you've gotten to the kernel, you're past the device type / layout dispatch. The first thing you need to write is error checking, to make sure the input tensors are the correct dimensions.  (Error checking is really important!  Don't skimp on it!)</li>
<li>Next, we generally have to allocate the result tensor which we are going to write the output into.</li>
<li>Time for the kernel proper.  At this point, you now should do the second, dtype dispatch, to jump into a kernel which is specialized per dtype it operates on.  (You don't want to do this too early, because then you will be uselessly duplicating code that looks the same in any case.)</li>
<li>Most performant kernels need some sort of parallelization, so that you can take advantage of multi-CPU systems.  (CUDA kernels are "implicitly" parallelized, since their programming model is built on top of massive parallelization).</li>
<li>Finally, you need to access the data and do the computation you wanted to do!</li>
</ol>
<p>In the subsequent slides, we'll walk through some of the tools PyTorch has for helping you implementing these steps.</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-37.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-37.png"></p></div>
<p>To take advantage of all of the code generation which PyTorch brings, you need to write a <em>schema</em> for your operator.  The schema gives a mypy-esque type of your function, and also controls whether or not we generate bindings for methods or functions on Tensor.  You also tell the schema what implementations of your operator should be called for given device-layout combinations.  Check out the <a href="https://github.com/pytorch/pytorch/blob/master/aten/src/ATen/native/README.md">README in native</a> is for more information about this format.</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-38.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-38.png"></p></div>
<p>You also may need to define a derivative for your operation in <a href="https://github.com/pytorch/pytorch/blob/master/tools/autograd/derivatives.yaml">derivatives.yaml</a>.</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-39.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-39.png"></p></div>
<p>Error checking can be done by way of either a low level or a high level API.  The low level API is just a macro, <tt>TORCH_CHECK</tt>, which takes a boolean, and then any number of arguments to make up the error string to render if the boolean is not true.  One nice thing about this macro is that you can intermix strings with non-string data; everything is formatted using their implementation of <tt>operator&lt;&lt;</tt>, and most important data types in PyTorch have <tt>operator&lt;&lt;</tt> implementations.</p>
<p>The high level API saves you from having to write up repetitive error messages over and over again.  The way it works is you first wrap each <tt>Tensor</tt> into a <tt>TensorArg</tt>, which contains information about where the tensor came from (e.g., its argument name).  It then provides a number of pre-canned functions for checking various properties; e.g., <tt>checkDim()</tt> tests if the tensor's dimensionality is a fixed number.  If it's not, the function provides a user-friendly error message based on the <tt>TensorArg</tt> metadata.</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-40.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-40.png"></p></div>
<p>One important thing to be aware about when writing operators in PyTorch, is that you are often signing up to write <em>three</em> operators: <tt>abs_out</tt>, which operates on a preallocated output (this implements the <tt>out=</tt> keyword argument), <tt>abs_</tt>, which operates inplace, and <tt>abs</tt>, which is the plain old functional version of an operator.</p>
<p>Most of the time, <tt>abs_out</tt> is the real workhorse, and <tt>abs</tt> and <tt>abs_</tt> are just thin wrappers around <tt>abs_out</tt>; but sometimes writing specialized implementations for each case are warranted.</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-41.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-41.png"></p></div>
<p>To do dtype dispatch, you should use the <tt>AT_DISPATCH_ALL_TYPES</tt> macro.  This takes in the dtype of the tensor you want to dispatch over, and a lambda which will be specialized for each dtype that is dispatchable from the macro.  Usually, this lambda just calls a templated helper function.</p>
<p>This macro doesn't just "do dispatch", it also decides what dtypes your kernel will support.  As such, there are actually quite a few versions of this macro, which let you pick different subsets of dtypes to generate specializations for.  Most of the time, you'll just want <tt>AT_DISPATCH_ALL_TYPES</tt>, but keep an eye out for situations when you might want to dispatch to some more types.  There's guidance in <a href="https://github.com/pytorch/pytorch/blob/21ef4cc615a7d9d772ade52a5023900718b09e92/aten/src/ATen/Dispatch.h#L62">Dispatch.h</a> for how to select the correct one for your use-case.</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-43.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-43.png"></p></div>
<p>On CPU, you frequently want to parallelize your code.  In the past, this was usually done by directly sprinkling OpenMP pragmas in your code.</p>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-42.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-42.png"></p></div>
<p>At some point, we have to actually access the data.  PyTorch offers quite a few options for doing this.</p>
<ol>
<li>If you just want to get a value at some specific location, you should use <tt>TensorAccessor</tt>.  A tensor accessor is like a tensor, but it hard codes the dimensionality and dtype of the tensor as template parameters.  When you retrieve an accessor like <tt>x.accessor&lt;float, <span>3&gt;();</span></tt>, we do a runtime test to make sure that the tensor really is this format; but after that, every access is unchecked.  Tensor accessors handle strides correctly, so you should prefer using them over raw pointer access (which, unfortunately, some legacy kernels do.)  There is also a <tt>PackedTensorAccessor</tt>, which is specifically useful for sending an accessor over a CUDA launch, so that you can get accessors from inside your CUDA kernel.  (One notable gotcha: <tt>TensorAccessor</tt> defaults to 64-bit indexing, which is much slower than 32-bit indexing in CUDA!)</li>
<li>If you're writing some sort of operator with very regular element access, for example, a pointwise operation, you are much better off using a higher level of abstraction, the <tt>TensorIterator</tt>.   This helper class automatically handles broadcasting and type promotion for you, and is quite handy.</li>
<li>For true speed on CPU, you may need to write your kernel using vectorized CPU instructions.  We've got helpers for that too!  The <tt>Vec256</tt> class represents a vector of scalars and provides a number of methods which perform vectorized operations on them all at once.  Helpers like <tt>binary_kernel_vec</tt> then let you easily run vectorized operations, and then finish everything that doesn't round nicely into vector instructions using plain old instructions.  The infrastructure here also manages compiling your kernel multiple times under different instruction sets, and then testing at runtime what instructions your CPU supports, and using the best kernel in those situations.</li>
</ol>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-44.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-44.png"></p></div>
<p>A lot of kernels in PyTorch are still written in the legacy TH style.  (By the way, TH stands for TorcH.  It's a pretty nice acronym, but unfortunately it is a bit poisoned; if you see TH in the name, assume that it's legacy.)  What do I mean by the legacy TH style?</p>
<ol>
<li>It's written in C style, no (or very little) use of C++.</li>
<li>It's manually refcounted (with manual calls to <tt>THTensor_free</tt> to decrease refcounts when you're done using tensors), and</li>
<li>It lives in <tt>generic/</tt> directory, which means that we are actually going to compile the file multiple times, but with different <tt>#define scalar_t</tt>.</li>
</ol>
<p>This code is pretty crazy, and we hate reviewing it, so please don't add to it.  One of the more useful tasks that you can do, if you like to code but don't know too much about kernel writing, is to port some of these TH functions to ATen.</p>
<hr>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-45.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-45.png"></p></div>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-46.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-46.png"></p></div>
<p>To wrap up, I want to talk a little bit about working efficiently on PyTorch.  If the largeness of PyTorch's C++ codebase is the first gatekeeper that stops people from contributing to PyTorch, the efficiency of your workflow is the second gatekeeper.  If you try to work on C++ with Python habits, <strong>you will have a bad time</strong>: it will take forever to recompile PyTorch, and it will take you forever to tell if your changes worked or not.</p>
<p>How to work efficiently could probably be a talk in and of itself, but this slide calls out some of the most common anti-patterns I've seen when someone complains: "It's hard to work on PyTorch."</p>
<ol>
<li>If you edit a header, especially one that is included by many source files (and especially if it is included by CUDA files), expect a very long rebuild.  Try to stick to editing cpp files, and edit headers sparingly!</li>
<li>Our CI is a very wonderful, zero-setup way to test if your changes worked or not. But expect to wait an hour or two before you get back signal.  If you are working on a change that will require lots of experimentation, spend the time setting up a local development environment.  Similarly, if you run into a hard to debug problem on a specific CI configuration, set it up locally.  You can <a href="https://github.com/pytorch/ossci-job-dsl">download and run the Docker images locally</a></li>
<li>The <a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md#use-ccache">CONTRIBUTING guide explains how to setup ccache</a>; this is highly recommended, because sometimes it will help you get lucky and avoid a massive recompile when you edit a header.  It also helps cover up bugs in our build system, when we recompile files when we shouldn't.</li>
<li>At the end of the day, we have a lot of C++ code, and you will have a much more pleasant experience if you build on a beefy server with CPUs and RAM.  In particular, I don't recommend doing CUDA builds on a laptop; building CUDA is sloooooow and laptops tend to not have enough juice to turnaround quickly enough.</li>
</ol>
<hr>
<div><p><img alt="http://blog.ezyang.com/img/pytorch-internals/slide-47.png" src="https://blog.ezyang.com/img/pytorch-internals/slide-47.png"></p></div>
<p>So that's it for a whirlwind tour of PyTorch's internals!  Many, many things have been omitted; but hopefully the descriptions and explanations here can help you get a grip on at least a substantial portion of the codebase.</p>
<p>Where should you go from here?  What kinds of contributions can you make?  A good place to start is our issue tracker.  Starting earlier this year, we have been triaging issues; issues labeled <strong>triaged</strong> mean that at least one PyTorch developer has looked at it and made an initial assessment about the issue.  You can use these labels to find out what issues we think are <a href="https://github.com/pytorch/pytorch/issues?q=is%3Aopen+is%3Aissue+label%3A%22high+priority%22+label%3Atriaged">high priority</a> or look up issues specific to some module, e.g., <a href="https://github.com/pytorch/pytorch/issues?q=is%3Aopen+is%3Aissue+label%3Atriaged+label%3A%22module%3A+autograd%22">autograd</a> or find issues which we think are <a href="https://github.com/pytorch/pytorch/issues?q=is%3Aopen+is%3Aissue+label%3Atriaged+label%3Asmall">small</a> (word of warning: we're sometimes wrong!)</p>
<p>Even if you don't want to get started with coding right away, there are many other useful activities like improving documentation (I <em>love</em> merging documentation PRs, they are so great), helping us reproduce bug reports from other users, and also just helping us discuss RFCs on the issue tracker. PyTorch would not be where it is today without our open source contributors; we hope you can join us too!</p>
</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Scallop – A Language for Neurosymbolic Programming (154 pts)]]></title>
            <link>https://www.scallop-lang.org/</link>
            <guid>43443640</guid>
            <pubDate>Sat, 22 Mar 2025 04:45:08 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.scallop-lang.org/">https://www.scallop-lang.org/</a>, See on <a href="https://news.ycombinator.com/item?id=43443640">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
      
      <div>
          <div>
                <p><img src="https://www.scallop-lang.org/img/icon-language.png"></p><h2>Language</h2>
                <p>
                  Scallop is a declarative language designed to support rich symbolic reasoning in AI applications.
		  It is based on Datalog, a logic rule-based query language for relational databases.
                </p>
              </div>
          <div>
                <p><img src="https://www.scallop-lang.org/img/icon-solver.png"></p><h2>Solver</h2>
                <p>
                  Scallop is a scalable Datalog solver equipped with support for discrete, probabilistic, and
                  differentiable modes of reasoning.
                  These modes are configurable to suit the needs of different AI applications.
                </p>
              </div>
          <div>
                <p><img src="https://www.scallop-lang.org/img/icon-framework.png"></p><h2>Framework</h2>
                <p>
                  Scallop provides bindings to support logic reasoning modules within Python programs.
                  As a result, Scallop can be deeply integrated with existing PyTorch machine
                  learning pipelines.
                </p>
              </div>
        </div>
      <div>
          <h2>Wide Range of Applications</h2>
          <p>
              Scallop can be used to develop a wide variety of applications in vision and NLP that involve symbolic reasoning.
              The reasoning component is specified via logic rules which can then be deeply
              integrated with machine learning models, such as convolutional neural networks and transformers.
            </p>
        </div>
      
      
      
    </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[George Foreman, Boxer Turned Foreman Grill Infomercial Star, Dies at 76 (294 pts)]]></title>
            <link>https://variety.com/2025/tv/news/george-foreman-boxer-infomercial-star-dies-1236345523/</link>
            <guid>43442917</guid>
            <pubDate>Sat, 22 Mar 2025 02:56:09 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://variety.com/2025/tv/news/george-foreman-boxer-infomercial-star-dies-1236345523/">https://variety.com/2025/tv/news/george-foreman-boxer-infomercial-star-dies-1236345523/</a>, See on <a href="https://news.ycombinator.com/item?id=43442917">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><p>
	<a href="https://variety.com/t/george-foreman/" id="auto-tag_george-foreman" data-tag="george-foreman">George Foreman</a>, the charismatic boxer turned infomercial star who had a retail hit with his Foreman Grill product line, died Friday. He was 76.</p>



<p>
	The Texas-born Foreman became Heavyweight Champion of the World, and segued into a TV staple and pop culture icon. He was swept up in the swirl of decade-defining events surrounding Muhammad Ali as well as Joe Frazier and other high-wattage pugilists of the 1970s. In the 1990s, Foreman took advantage of the availablity of low-cost TV time to launch his Foreman Grill home grill product through a series of  infomercials that he hosted. </p>



<p>
	Foreman famously had a close call in the ring in 1977 that drove him to quit boxing and declare himself a born-again Christian. He became an ordained minister in 1978 and began preaching in his hometown of Houston. He shocked the sports world when he returned to boxing in 1987 and wound up reclaiming his Heavyweight Champion title in 1994. Foreman retired from the sweet science for good in 1997.

	</p>






<p>
	In addition to his business ventures, Foreman led Houston’s Church of the Lord Jesus Christ, where he preached four times a week.


</p><div data-pmc-adm-ad-id="1234758890">
			<h3>
			Popular on Variety		</h3>
	
		
	</div>




<p>
	In recent years, Foreman had been involved with numerous documentary projects about his life, boxing and the era of his greatest fame. He was also the subject of the 2023 biopic “Big George Foreman,” from director George Tillman Jr. Khris Davis played Foreman in the Mandalay Pictures drama that focused on his improbable return to the ring in the 1980s and ’90s.</p>



<p>
	Foreman’s family confirmed his death in an Instagram post on Friday.</p>



<figure><div>
<blockquote data-instgrm-captioned="" data-instgrm-permalink="https://www.instagram.com/p/DHe5UtIJ4IQ/?utm_source=ig_embed&amp;utm_campaign=loading" data-instgrm-version="14"></blockquote>
</div></figure>



<p>
	Born Jan. 10, 1949, Foreman grew up in extreme poverity in the east Texas city of Marshall, about 40 miles west of Shreveport, La. He first gained national fame after winning an Olympic gold medal in boxing at the 1968 Summer Games in Mexico City.</p>



<p>
	“Foreman often bullied younger children and didn’t like getting up early for school. Foreman became a mugger and brawler on the hard streets of Houston’s Fifth Ward by age 15,” according to <a href="https://www.georgeforeman.com/pages/biography" rel="nofollow" target="_blank"><strong>Foreman’s official website.</strong></a></p>



<p>
	He was eventually steered into boxing through the Lone Star state’s Lyndon B. Johnson Job Corps program. Foreman gained stature in the late 1960s and ultimately secured the Heavyweight Championship in January 1973 by defeating Frazier with six knockouts in a bout held in Kingston, Jamaica. The event also had the distinction of being the first boxing broadcast to air on the then-fledgling pay TV service HBO.

	</p>




<p>
	The following year, Foreman faced a resurgent Ali in the event that received worldwide attention as the “Rumble in the Jungle,” held in what is now the Democratic Republic of Congo. Ali pummelled Foreman in the ring and dominated him on the PR front as well. Foreman went on to went his next five fights by knockout.</p>



<p>
	After his triumph of becoming the world’s oldest Heavyweight Champion, Foreman became a boldface name staple on TV, from daytime talk shows to “The Tonight Show” and “Late Night With David Letterman.” He was known for his folksy charm and for having a sprawling family of children and grandchildren. And his low-cost cooking device that allowed for easy indoor grilling — the George Foreman Lean Mean Grilling Machine — became a retail and direct response sales juggernaut starting in the early 1990s.</p>



<p>
	Foreman also starred in the short-lived 1993 ABC family comedy “George,” playing a retired boxer who runs an after-school program for troubled students. He hosted NBC’s “Saturday Night Live” in 1994.</p>



<p>
	Foreman had cameos and small roles in a host of TV shows and movies over the years, playing himself or a similar character, including “Night at the Museum: Battle of the Smithsonian,” “The Fighter,” “The Masked Singer,” “The Larry Sanders Show,” “Home Improvement” and “King of the Hill.”</p>
















</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Monster Cables picked the wrong guy to threaten (2008) (459 pts)]]></title>
            <link>https://www.oncontracts.com/monster-cables-picked-the-wrong-guy-to-threaten/</link>
            <guid>43442178</guid>
            <pubDate>Sat, 22 Mar 2025 00:30:37 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.oncontracts.com/monster-cables-picked-the-wrong-guy-to-threaten/">https://www.oncontracts.com/monster-cables-picked-the-wrong-guy-to-threaten/</a>, See on <a href="https://news.ycombinator.com/item?id=43442178">Hacker News</a></p>
<div id="readability-page-1" class="page"><div itemprop="articleBody" id="post-113" itemscope="" itemtype="https://schema.org/BlogPosting"><p>Monster Cables, which makes extremely high-priced stereo cables, has apparently sent a <a href="http://www.audioholics.com/news/industry-news/monster-sues-blue-jeans-cable" target="_blank">cease-and-desist letter</a> to <a href="http://www.bluejeanscable.com/">Blue Jeans Cable</a>, alleging various kinds of infringement.  Bad move – the president of Blue Jeans Cable, Kurt Denke, is a former litigator who <a href="http://www.audioholics.com/news/industry-news/blue-jeans-strikes-back">responded pretty forcefully</a>:</p><blockquote><p><em>… Once I have received the above materials and explanations from you, I will undertake to analyze this information and let you know whether we are willing to accede to any of the demands made in your letter. <strong>If my analysis shows that there is any reasonable likelihood that we have infringed in any way any of Monster Cable’s intellectual property rights, we will of course take any and all action necessary to resolve the situation. </strong> If I do not hear from you within the next fourteen days, or if I do hear from you but do not receive </em><em>all of the information requested above, I will assume that you have abandoned these claims and closed your file.</em></p><p><em> As for your requests for information, or for action, directed to me: I would remind you that it is you, not I, who are making claims; and it is you, not I, who must substantiate those claims.  You have not done so.</em></p><p><em> I have seen Monster Cable take untenable IP positions in various different scenarios in the past, and am generally familiar with what seems to be Monster Cable’s </em><em>modus operandi in these matters.  I therefore think that it is important that, before closing, I make you aware of a few points.</em></p><p><em> After graduating from the University of Pennsylvania Law School in 1985, I spent nineteen years in litigation practice, with a focus upon federal litigation involving large damages and complex issues.  My first seven years were spent primarily on the defense side, where <strong>I developed an intense frustration with insurance carriers who would settle meritless claims for nuisance value when the better long-term view would have been to fight against vexatious litigation as a matter of principle.</strong> In plaintiffs’ practice, likewise, I was always a strong advocate of standing upon principle and taking cases all the way to judgment, even when substantial offers of settlement were on the table.  I am “uncompromising” in the most literal sense of the word.  If Monster Cable proceeds with litigation against me I will pursue the same merits-driven approach; I do not compromise with bullies and <strong>I would rather spend fifty thousand dollars on defense than give you a dollar of unmerited settlement funds.</strong> As for signing a licensing agreement for intellectual property which I have not infringed: that will not happen, under any circumstances, whether it makes economic sense or not.</em></p><p><em> I say this because my observation has been that Monster Cable typically operates in a hit-and-run fashion.  Your client threatens litigation, expecting the victim to panic and plead for mercy; and what follows is a quickie negotiation session that ends with payment and a licensing agreement.  Your client then uses this collection of licensing agreements to convince others under similar threat to accede to its demands.  Let me be clear about this: <strong>there are only two ways for you to get anything out of me.  You will either need to (1) convince me that I have infringed, or (2) obtain a final judgment to that effect from a court of competent jurisdiction. </strong>It may be that my inability to see the pragmatic value of settling frivolous claims is a deep character flaw, and I am sure a few of the insurance carriers for whom I have done work have seen it that way; but it is how I have done business for the last quarter-century and you are not going to change my mind.  If you sue me, the case will go to judgment, and I will hold the court’s attention upon the merits of your claims–or, to speak more precisely, the absence of merit from your claims–from start to finish. <strong>Not only am I unintimidated by litigation; I sometimes rather miss it.</strong></em></p></blockquote><p>(Emphasis added; hat tip: Jeff Nolan at <a href="http://jeffnolan.com/wp/2008/04/15/monster-cables-gets-soundly-beaten/#comment-258095">Venture Chronicles</a>.)</p><p>I can relate to Denke’s final comment quoted above ….  I wonder what the attendant publicity is doing for his sales.</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Not OK Cupid – A story of poor email address validation (110 pts)]]></title>
            <link>https://www.fastmail.com/blog/not-ok-cupid/</link>
            <guid>43441961</guid>
            <pubDate>Fri, 21 Mar 2025 23:54:30 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.fastmail.com/blog/not-ok-cupid/">https://www.fastmail.com/blog/not-ok-cupid/</a>, See on <a href="https://news.ycombinator.com/item?id=43441961">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-pagefind-body="" data-cms-edit="content"> <p>I don’t usually like to call out the bad behaviour of specific companies, but the egregious mis-design and lack of acknowledging it justify this case.</p> <h2 id="welcome-to-ok-cupid" tabindex="-1">Welcome to OkCupid</h2> <p>A couple of weeks ago, I started seeing many “Welcome to OkCupid” emails, both on my personal address and a couple of related addresses, but also to multiple Fastmail official contact addresses — legal, partnerships, press, etc. Specifically, this list included <code>trash@brong.net</code> — an address that has never been used to send or receive email and appears in precisely one place — <a href="https://www.fastmail.com/blog/a-tangled-path-of-workarounds/" target="_blank" rel="noopener">an article on our blog</a>! It seems quite clear that somebody scraped our website and used the addresses to sign up. I’m aware of at least 10 addresses, but there are likely others that either go to someone else or addresses that no longer exist.</p> <p>It didn’t stop there, though. I’ve been getting tons of “someone likes you”, “you have an intro,” and even an “IMPORTANT: We removed your photo on OkCupid.” email saying that inappropriate content was posted to “our” account!</p> <h2 id="the-real-world-consequences-of-poor-email-validation" tabindex="-1">The real-world consequences of poor email validation</h2> <p>This isn’t just an inconvenience — it has real security implications. Websites that fail to properly validate email ownership can be exploited for malicious purposes. Attackers can use unverified sign-ups to flood inboxes, making it easier to hide critical emails among the noise — something we’ve discussed our own experience of in our post on <a href="https://www.fastmail.com/blog/when-two-factor-authentication-is-not-enough/" target="_blank" rel="noopener">2FA vulnerabilities</a>. There are established <a href="https://www.m3aawg.org/sites/default/files/document/M3AAWG_Senders_BCP_Ver3-2015-02.pdf" target="_blank" rel="noopener">best practices</a> (PDF) for handling email sign-ups responsibly, practices that OkCupid is failing to follow.</p> <h2 id="no-way-out" tabindex="-1">No way out</h2> <p>When I tried to unsubscribe using the one-click unsubscribe button in one of the emails, I was met with an error: “Something went wrong, please try again later.”</p> <p>Curious, I tried to recover a password on one of these accounts (the one with my personal email address) and successfully changed the password. Then, I was asked to confirm my login with a message sent to the number associated with the account. A number I didn’t know. A number that wasn’t mentioned on that page, so I still don’t know anything about it — not even which country it was from.</p> <p>This raises further security concerns; the attacker could have also caused random recovery numbers to be texted to another poor victim’s phone. Alternatively, they could confirm that my email address is actively monitored, increasing its value for further attacks. Either way, what I couldn’t do was actually close the account.</p> <h2 id="whack-a-mole" tabindex="-1">Whack-a-mole</h2> <p>So, I contacted OkCupid’s support. Here’s what they said:</p> <p><em>I’ve removed the user from the site and banned the email address to prevent any new accounts from being created. That should resolve the issue, but if you encounter anything like this again in the future, please don’t hesitate to reach out, and we’ll address it right away.</em></p> <p>So, I need to contact support manually for each new email address. This is neither scalable nor acceptable; people don’t have this amount of time.</p> <p>Furthermore, my email address is now on another random blocklist somewhere on the internet, where I have no control and no way to unblock it. I don’t anticipate wanting to use OkCupid’s service, but if I did in the future, I would have to go through another dance to get the address unlocked again — or more likely, treat that particular email address as soiled and create another one.</p> <h2 id="not-ok" tabindex="-1">Not OK</h2> <p>So I say, not OK, OkCupid. Not OK.</p> <p>The usefulness of email depends on responsible behaviour from all service providers. Companies that engage in shady or outright inappropriate practices make the internet worse for everyone.</p> <p>OkCupid’s failure to implement even the <a href="https://en.wikipedia.org/wiki/Opt-in_email#Confirmed_opt-in_(COI)/double_opt-in_(DOI)" target="_blank" rel="noopener">simplest form</a> of email validation is unacceptable. Until they address these issues properly (not through the support response provided here), they remain part of the problem, not the solution.</p> <h2 id="could-we-have-avoided-this" tabindex="-1">Could we have avoided this?</h2> <p>In this case, we published those addresses online. There’s always a risk of receiving spam when you do that, one could even reasonably say “we were asking for it”. We expected spam. If you want to reduce your risk of being spammed, it helps to not publish your email address on the public web!</p> <p>What we we didn’t was expect a relatively reputable service being used to facilitate us being spammed.</p> <p>One great protection is using different address for each different organisation you deal with — that way if your address leaks (or they sell it), you know where the breach happened, and you can more easily block just the problem messages.</p> <p>Fastmail’s masked email feature is a great way to implement this strategy. Masked emails are designed, particularly when integrated with a password manager, to make it very easy to create new addresses, and track where they are expected to be used.</p> <p>Being a good internet citizen is one of <a href="https://www.fastmail.com/company/values/" target="_blank" rel="noopener">Fastmail’s core values</a>. We require verification for sending identities, ensuring that only legitimate users can send from an address they claim they own. This is the level of responsibility every email provider should uphold, and we applaud the others who also do.</p> </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[EFF Border Search Pocket Guide (116 pts)]]></title>
            <link>https://www.eff.org/document/eff-border-search-pocket-guide</link>
            <guid>43441895</guid>
            <pubDate>Fri, 21 Mar 2025 23:41:15 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.eff.org/document/eff-border-search-pocket-guide">https://www.eff.org/document/eff-border-search-pocket-guide</a>, See on <a href="https://news.ycombinator.com/item?id=43441895">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
            <p>
            <h2>EFF Border Search Pocket Guide</h2>
    </p>
<div><div><p>This is a handy guide designed to be printed, folded, and carried in your pocket while traveling.</p></div>

<div><p><span><img alt="PDF icon" title="application/pdf" src="https://www.eff.org/modules/file/icons/application-pdf.png"> <a href="https://www.eff.org/files/2018/01/11/border-pocket-guide-2.pdf" type="application/pdf; length=799017">border-pocket-guide-2.pdf</a></span></p></div>
</div>
      </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[MySQL transactions per second vs. fsyncs per second (2020) (102 pts)]]></title>
            <link>https://sirupsen.com/napkin/problem-10-mysql-transactions-per-second</link>
            <guid>43440920</guid>
            <pubDate>Fri, 21 Mar 2025 21:18:39 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://sirupsen.com/napkin/problem-10-mysql-transactions-per-second">https://sirupsen.com/napkin/problem-10-mysql-transactions-per-second</a>, See on <a href="https://news.ycombinator.com/item?id=43440920">Hacker News</a></p>
<div id="readability-page-1" class="page"><article><p><time datetime="2020-07-17">Jul 2020</time></p><p><strong>Just wondering how many transactions or writes per second MySQL can handle?</strong> While it depends on many factors, fundamentally, about as many transactions as MySQL can commit to disk per second. A modern disk can do <a href="https://github.com/sirupsen/napkin-math#numbers">~1000 fsyncs per second</a>, but MySQL will group multiple writes with each fsync. An okay rule-of-thumb would be 5000-15,000 writes per second, depending on things like writes per transaction, number of indexes, hardware, size of writes, etc. Read the article to understand this in more depth!</p><nav><ol><li><a href="https://sirupsen.com/napkin/problem-10-mysql-transactions-per-second#problem-10-is-mysqls-maximum-transactions-per-second-equivalent-to-fsyncs-per-second">Problem 10: Is MySQL’s maximum transactions per second equivalent to fsyncs per second?</a></li><li><a href="https://sirupsen.com/napkin/problem-10-mysql-transactions-per-second#problem-9-inverted-index">Problem 9: Inverted Index</a></li></ol></nav><p>Napkin friends, from near and far, it’s time for another napkin problem!</p>
<p>Since the beginning of this newsletter I’ve posed problems for you to try to
answer. Then in the next month’s edition, you hear my answer. Talking with a few
of you, it seems many of you read these as posts regardless of their
problem-answer format.</p>
<p>That’s why I’ve decided to experiment with a simpler format: posts where I both
present a problem and solution in one go. This one will be long, since it’ll
include an answer to last month’s.</p>
<p>Hope you enjoy this format! As always, you are encouraged to reach out with
feedback.</p>
<h2 id="problem-10-is-mysqls-maximum-transactions-per-second-equivalent-to-fsyncs-per-second">Problem 10: Is MySQL’s maximum transactions per second equivalent to fsyncs per second?<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M9.199 13.599a5.99 5.99 0 0 0 3.949 2.345 5.987 5.987 0 0 0 5.105-1.702l2.995-2.994a5.992 5.992 0 0 0 1.695-4.285 5.976 5.976 0 0 0-1.831-4.211 5.99 5.99 0 0 0-6.431-1.242 6.003 6.003 0 0 0-1.905 1.24l-1.731 1.721a.999.999 0 1 0 1.41 1.418l1.709-1.699a3.985 3.985 0 0 1 2.761-1.123 3.975 3.975 0 0 1 2.799 1.122 3.997 3.997 0 0 1 .111 5.644l-3.005 3.006a3.982 3.982 0 0 1-3.395 1.126 3.987 3.987 0 0 1-2.632-1.563A1 1 0 0 0 9.201 13.6zm5.602-3.198a5.99 5.99 0 0 0-3.949-2.345 5.987 5.987 0 0 0-5.105 1.702l-2.995 2.994a5.992 5.992 0 0 0-1.695 4.285 5.976 5.976 0 0 0 1.831 4.211 5.99 5.99 0 0 0 6.431 1.242 6.003 6.003 0 0 0 1.905-1.24l1.723-1.723a.999.999 0 1 0-1.414-1.414L9.836 19.81a3.985 3.985 0 0 1-2.761 1.123 3.975 3.975 0 0 1-2.799-1.122 3.997 3.997 0 0 1-.111-5.644l3.005-3.006a3.982 3.982 0 0 1 3.395-1.126 3.987 3.987 0 0 1 2.632 1.563 1 1 0 0 0 1.602-1.198z"></path></svg></h2>
<p>How many transactions (‘writes’) per second is MySQL capable of?</p>
<p>A naive model of how a write (a SQL insert/update/delete) to an ACID-compliant
database like MySQL works might be the following (this applies equally to
Postgres, or any other relational/ACID-compliant databases, but we’ll
proceed to work with MySQL as it’s the one I know best):</p>
<ol>
<li>Client sends query to MySQL over an existing connection: <code>INSERT INTO products (name, price) VALUES ('Sneaker', 100)</code></li>
<li>MySQL inserts the new record to the write-ahead-log (WAL) and calls
<code>fsync(2)</code> to tell the operating system to tell the filesystem to tell the
disk to make <em>sure</em> that this data is <em>for sure</em>, pinky-swear committed to
the disk. This step, being the most complex, is depicted below.</li>
<li>MySQL inserts the record into an in-memory page in the backing storage engine
(InnoDB) so the record will be visible to subsequent queries. Why commit to
the storage engine <em>and</em> the WAL? The storage engine is optimized for serving
query results the data, and the WAL for writing it in a safe manner — we
can’t serve a <code>SELECT</code> efficiently from the WAL!</li>
<li>MySQL returns <code>OK</code> to the client.</li>
<li>MySQL eventually calls <code>fsync(2)</code> to ensure InnoDB commits the page to disk.</li>
</ol>
<figure><img alt="Napkin_10" fetchpriority="high" width="1759" height="1198" decoding="async" data-nimg="1" sizes="(min-width: 36rem) 36rem 100vw" srcset="https://sirupsen.com/_next/image?url=%2Fimages%2F87759326-21adeb00-c7dc-11ea-89c7-559ca11530e8.png&amp;w=640&amp;q=75 640w, https://sirupsen.com/_next/image?url=%2Fimages%2F87759326-21adeb00-c7dc-11ea-89c7-559ca11530e8.png&amp;w=750&amp;q=75 750w, https://sirupsen.com/_next/image?url=%2Fimages%2F87759326-21adeb00-c7dc-11ea-89c7-559ca11530e8.png&amp;w=828&amp;q=75 828w, https://sirupsen.com/_next/image?url=%2Fimages%2F87759326-21adeb00-c7dc-11ea-89c7-559ca11530e8.png&amp;w=1080&amp;q=75 1080w, https://sirupsen.com/_next/image?url=%2Fimages%2F87759326-21adeb00-c7dc-11ea-89c7-559ca11530e8.png&amp;w=1200&amp;q=75 1200w, https://sirupsen.com/_next/image?url=%2Fimages%2F87759326-21adeb00-c7dc-11ea-89c7-559ca11530e8.png&amp;w=1920&amp;q=75 1920w, https://sirupsen.com/_next/image?url=%2Fimages%2F87759326-21adeb00-c7dc-11ea-89c7-559ca11530e8.png&amp;w=2048&amp;q=75 2048w, https://sirupsen.com/_next/image?url=%2Fimages%2F87759326-21adeb00-c7dc-11ea-89c7-559ca11530e8.png&amp;w=3840&amp;q=75 3840w" src="https://sirupsen.com/_next/image?url=%2Fimages%2F87759326-21adeb00-c7dc-11ea-89c7-559ca11530e8.png&amp;w=3840&amp;q=75"></figure>
<p>In the event of power-loss at any of these points, the behaviour can be defined
without nasty surprises, upholding our dear ACID-compliance.</p>
<p>Splendid! Now that we’ve constructed a naive model of how a relational database
might handle writes safely, we can consider the latency of inserting a new
record into the database. When we consult <a href="https://github.com/sirupsen/napkin-math">the reference napkin numbers</a>, we
see that the <code>fsync(2)</code> in step (2) is by <em>far</em> the slowest operation in the
blocking chain at 1 ms.</p>
<p>For example, the network handling at step (1) takes roughly ~10 μs (TCP Echo
Server is what we can classify as ‘the TCP overhead’). The <code>write(2)</code> itself
prior to the <code>fsync(2)</code> is also negligible at ~10 μs, since this system call
essentially just writes to an in-memory buffer (the ‘page cache’) in the kernel.
This doesn’t guarantee the actual bits are committed on disk, which means an
unexpected loss of power would erase the data, dropping our ACID-compliance on
the floor. Calling <code>fsync(2)</code> guarantees us the bits are persisted on the disk,
which will survive an unexpected system shutdown.  Downside is that it’s 100x
slower.</p>
<p>With that, we should be able to form a simple hypothesis on the maximum
throughput of MySQL:</p>
<blockquote>
<p>The maximum theoretical throughput of MySQL is equivalent to the maximum
number of <code>fsync(2)</code> per second.</p>
</blockquote>
<p>We know that <code>fsync(2)</code> takes 1 ms from earlier, which means we would naively
expect that MySQL would be able to perform in the neighbourhood of: <code>1s / 1ms/fsync = 1000 fsyncs/s = 1000 transactions/s</code> .</p>
<p>Excellent. We followed the first three of the napkin math steps: (1) Model the
system, (2) Identify the relevant latencies, (3) Do the napkin math, (4) Verify
the napkin calculations against reality.</p>
<p>On to (4: Verifying)! We’ll write a simple benchmark in Rust that writes to
MySQL with 16 threads, doing 1,000 insertions each:</p>
<pre><code><span>for</span> i <span>in</span> <span>0</span><span>..</span><span>16</span> <span>{</span>
    handles<span>.</span><span>push</span><span>(</span><span>thread<span>::</span></span><span>spawn</span><span>(</span><span>{</span>
        <span>let</span> pool <span>=</span> pool<span>.</span><span>clone</span><span>(</span><span>)</span><span>;</span>
        <span>move</span> <span><span>|</span><span>|</span></span> <span>{</span>
            <span>let</span> <span>mut</span> conn <span>=</span> pool<span>.</span><span>get_conn</span><span>(</span><span>)</span><span>.</span><span>unwrap</span><span>(</span><span>)</span><span>;</span>
            <span>// TODO: we should ideally be popping these off a queue in case of a stall</span>
            <span>// in a thread, but this is likely good enough.</span>
            <span>for</span> _ <span>in</span> <span>0</span><span>..</span><span>1000</span> <span>{</span>
                conn<span>.</span><span>exec_drop</span><span>(</span>
                    <span>r"INSERT INTO products (shop_id, title) VALUES (:shop_id, :title)"</span><span>,</span>
                    <span>params!</span> <span>{</span> <span>"shop_id"</span> <span>=&gt;</span> <span>123</span><span>,</span> <span>"title"</span> <span>=&gt;</span> <span>"aerodynamic chair"</span> <span>}</span><span>,</span>
                <span>)</span>
                <span>.</span><span>unwrap</span><span>(</span><span>)</span><span>;</span>
            <span>}</span>
        <span>}</span>
    <span>}</span><span>)</span><span>)</span><span>;</span>

    <span>for</span> handle <span>in</span> handles <span>{</span>
      handle<span>.</span><span>join</span><span>(</span><span>)</span><span>.</span><span>unwrap</span><span>(</span><span>)</span><span>;</span>
    <span>}</span>
    <span>// 3 seconds, 16,000 insertions</span>
<span>}</span>
</code></pre>
<p>This takes ~3 seconds to perform 16,000 insertions, or ~5,300 insertions per
second. This is <strong>5x</strong> more than the 1,000 <code>fsync</code> per second our napkin math
told us would be the theoretical maximum transactional throughput!</p>
<p>Typically with napkin math we aim for being within an order of magnitude, which
we are. But, when I do napkin math it usually establishes a lower-bound for the
system, i.e. from first-principles, how fast <em>could</em> this system perform in
ideal circumstances?</p>
<p>Rarely is the system 5x faster than napkin math. When we identify a
significant-ish gap between the real-life performance and the expected
performance, I call it the “first-principle gap.” This is where curiosity sets
in. It typically means there’s (1) an opportunity to improve the system, or (2)
a flaw in our model of the system. In this case, only (2) makes sense, because
the system is faster than we predicted.</p>
<p>What’s wrong with our model of how the system works? Why aren’t fsyncs per
second equal to transactions per second?</p>
<p>First I examined the benchmark… is something wrong? Nope <code>SELECT COUNT(*) FROM products</code> says 16,000. Is the MySQL I’m using configured to not <code>fsync</code> on every
write? Nope, it’s at the <a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-parameters.html#sysvar_innodb_flush_log_at_trx_commit">safe default</a>.</p>
<p>Then I sat down and thought about it. Perhaps MySQL is <em>not</em> doing an <code>fsync</code>
for every <em>single</em> write? If it’s processing 5,300 insertions per second,
perhaps it’s batching multiple writes together as part of writing to the WAL,
step (2) above? Since each transaction is so short, MySQL would benefit from
waiting a few microseconds to see if other transactions want to ride along
before calling the expensive <code>fsync(2)</code>.</p>
<p>We can test this hypothesis by writing a simple <code>bpftrace</code> script to observe the
number of <code>fsync(1)</code> for the ~16,000 insertions:</p>
<pre><code>tracepoint<span>:</span>syscalls<span>:</span>sys_enter_fsync<span>,</span>tracepoint<span>:</span>syscalls<span>:</span>sys_enter_fdatasync
<span>/</span>comm <span>==</span> <span>"mysqld"</span><span>/</span>
<span>{</span>
        <span>@fsyncs</span> <span>=</span> <span>count</span><span>(</span><span>)</span><span>;</span>
<span>}</span>
</code></pre>
<p>Running this during the ~3 seconds it takes to insert the 16,000 records we get
~8,000 <code>fsync</code> calls:</p>
<pre><code>$ <span>sudo</span> bpftrace fsync_count.d
Attaching <span>2</span> probes<span>..</span>.
^C

@fsyncs: <span>8037</span>
</code></pre>
<p>This is a peculiar number. If MySQL was batching fsyncs, we’d expect something
far lower. This number means that we’re on average doing ~2,500 <code>fsync</code> per
second, at a latency of ~0.4ms. This is twice as fast as the <code>fsync</code> latency we
expect, the 1ms mentioned earlier. For sanity, I ran the script to benchmark
<code>fsync</code> outside MySQL again, no, <a href="https://github.com/sirupsen/napkin-math/blob/fe780331c6f0c6f225a70c8a37c21e0740f7c73c/src/main.rs#L491">still 1ms</a>. <a href="https://gist.github.com/sirupsen/9fd5fe9466e82df073ed8a13ed1f661f#file-napkin-bash">Looked at the
distribution</a>, and it was consistently ~1ms.</p>
<p>So there’s two things we can draw from this: (1) We’re able to <code>fsync</code> more than
twice as fast as we expect, (2) Our hypothesis was correct that MySQL is more
clever than doing one <code>fsync</code> per transaction, however, since <code>fsync</code> also was
faster than expected, this didn’t explain everything.</p>
<p>If you remember from above, while committing the transaction could theoretically
be a single <code>fsync</code>, other features of MySQL might also call <code>fsync</code>. Perhaps
they’re adding noise?</p>
<p>We need to group <code>fsync</code> by file descriptor to get a better idea of how MySQL
uses <code>fsync</code>. However, the raw file descriptor number doesn’t tell us much. We
can use <code>readlink</code> and the <code>proc</code> file-system to obtain the file name the file
descriptor points to. Let’s write a <a href="https://github.com/iovisor/bpftrace"><code>bpftrace</code> script</a> to see what’s being
<code>fsync</code>‘ed:</p>
<pre><code>tracepoint<span>:</span>syscalls<span>:</span>sys_enter_fsync<span>,</span>tracepoint<span>:</span>syscalls<span>:</span>sys_enter_fdatasync
<span>/</span>comm <span>==</span> <span>str</span><span>(</span><span>$</span><span>1</span><span>)</span><span>/</span>
<span>{</span>
  <span>@fsyncs</span><span>[</span>args<span>-</span><span>&gt;</span>fd<span>]</span> <span>=</span> <span>count</span><span>(</span><span>)</span><span>;</span>
  <span>if</span> <span>(</span><span>@fd_to_filename</span><span>[</span>args<span>-</span><span>&gt;</span>fd<span>]</span><span>)</span> <span>{</span>
  <span>}</span> <span>else</span> <span>{</span>
    <span>@fd_to_filename</span><span>[</span>args<span>-</span><span>&gt;</span>fd<span>]</span> <span>=</span> <span>1</span><span>;</span>
    <span>system</span><span>(</span><span>"echo -n 'fd %d -&gt; ' &amp;1&gt;&amp;2 | readlink /proc/%d/fd/%d"</span><span>,</span>
           args<span>-</span><span>&gt;</span>fd<span>,</span> pid<span>,</span> args<span>-</span><span>&gt;</span>fd<span>)</span><span>;</span>
  <span>}</span>
<span>}</span>

END <span>{</span>
  <span>clear</span><span>(</span><span>@fd_to_filename</span><span>)</span><span>;</span>
<span>}</span>
</code></pre>
<p>Running this while inserting the 16,000 transactions into MySQL gives us:</p>
<pre><code>personal@napkin:~$ <span>sudo</span> bpftrace --unsafe fsync_count_by_fd.d mysqld
Attaching <span>5</span> probes<span>..</span>.
fd <span>5</span> -<span>&gt;</span> /var/lib/mysql/ib_logfile0 <span># redo log, or write-ahead-log</span>
fd <span>9</span> -<span>&gt;</span> /var/lib/mysql/ibdata1 <span># shared mysql tablespace</span>
fd <span>11</span> -<span>&gt;</span> /var/lib/mysql/<span>#ib_16384_0.dblwr # innodb doublewrite-buffer</span>
fd <span>13</span> -<span>&gt;</span> /var/lib/mysql/undo_001 <span># undo log, to rollback transactions</span>
fd <span>15</span> -<span>&gt;</span> /var/lib/mysql/undo_002 <span># undo log, to rollback transactions</span>
fd <span>27</span> -<span>&gt;</span> /var/lib/mysql/mysql.ibd <span># tablespace </span>
fd <span>34</span> -<span>&gt;</span> /var/lib/mysql/napkin/products.ibd <span># innodb storage for our products table</span>
fd <span>99</span> -<span>&gt;</span> /var/lib/mysql/binlog.000019 <span># binlog for replication</span>
^C

@fsyncs<span>[</span><span>9</span><span>]</span>: <span>2</span>
@fsyncs<span>[</span><span>12</span><span>]</span>: <span>2</span>
@fsyncs<span>[</span><span>27</span><span>]</span>: <span>12</span>
@fsyncs<span>[</span><span>34</span><span>]</span>: <span>47</span>
@fsyncs<span>[</span><span>13</span><span>]</span>: <span>86</span>
@fsyncs<span>[</span><span>15</span><span>]</span>: <span>93</span>
@fsyncs<span>[</span><span>11</span><span>]</span>: <span>103</span>
@fsyncs<span>[</span><span>99</span><span>]</span>: <span>2962</span>
@fsyncs<span>[</span><span>5</span><span>]</span>: <span>4887</span>
</code></pre>
<p>What we can observe here is that the majority of the writes are to the “redo
log”, what we call the “write-ahead-log” (WAL). There’s a few <code>fsync</code> calls to
commit the InnoDB table-space, not nearly as often, as we can always recover
this from the WAL in case we crash between them. Reads work just fine prior to
the <code>fsync</code>, as the queries can simply be served out of memory from InnoDB.</p>
<p>The only surprising thing here is the substantial volume of writes to the
binlog, which we haven’t mentioned before. You can think of the binlog as the
“replication stream.” It’s a stream of events such as <code>row a changed from x to y</code>, <code>row b was deleted</code>, and <code>table u added column c</code>. The primary replica
streams this to the read-replicas, which use it to update their own data.</p>
<p>When you think about it, the <code>binlog</code> and the WAL need to be kept exactly in
sync. We can’t have something committed on the primary replica, but not
committed to the replicas. If they’re not in sync, this could cause loss of data
due to drift in the read-replicas. The primary could commit a change to the WAL,
lose power, recover, and never write it to the binlog.</p>
<p>Since <code>fsync(1)</code> can only sync a single file-descriptor at a time, how can you
possibly ensure that the <code>binlog</code> and the WAL contain the transaction?</p>
<p>One solution would be to merge the <code>binlog</code> and the <code>WAL</code> into one log. I’m not
entirely sure why that’s not the case, but likely the reasons are historic. If
you know, let me know!</p>
<p>The solution employed by MySQL is to use a 2-factor commit. This requires three
<code>fsync</code>s to commit the transaction. <a href="https://www.burnison.ca/notes/fun-mysql-fact-of-the-day-everything-is-two-phase">This</a> and <a href="https://kristiannielsen.livejournal.com/12254.html">this reference</a> explain
this process in more detail. Because the WAL is touched twice as part of the
2-factor commit, it explains why we see roughly ~2x the number of <code>fsync</code> to
that over the bin-log from the bpftrace output above. The process of grouping
multiple transactions into one 2-factor commit in MySQL is called ‘group commit.’</p>
<p>What we can gather from these numbers is that it seems the ~16,000 transactions
were, thanks to group commit, reduced into ~2885 commits, or ~5.5 transactions
per commit on average.</p>
<p>But there’s still one other thing remaining… why was the average latency per
<code>fsync</code> twice as fast as in our benchmark? Once again, we write a simple
<code>bpftrace</code> script:</p>
<pre><code>tracepoint:syscalls:sys_enter_fsync,tracepoint:syscalls:sys_enter_fdatasync
/comm == "mysqld"/
{
        @start[tid] = nsecs;
}

tracepoint:syscalls:sys_exit_fsync,tracepoint:syscalls:sys_exit_fdatasync
/comm == "mysqld"/
{
        @bytes = lhist((nsecs - @start[tid]) / 1000, 0, 1500, 100);
        delete(@start[tid]);
}
</code></pre>
<p>Which throws us this histogram, confirming that we’re seeing some <em>very</em> fast
<code>fsync</code>s:</p>
<pre><code><span><span><span>personal@napkin</span><span>:</span><span>~</span></span><span>$</span> <span><span>sudo</span> bpftrace fsync_latency.d</span></span>
<span>Attaching 4 probes...
^C

@bytes:
[0, 100)             439 |@@@@@@@@@@@@@@@                                     |
[100, 200)             8 |                                                    |
[200, 300)             2 |                                                    |
[300, 400)           242 |@@@@@@@@                                            |
[400, 500)          1495 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@|
[500, 600)           768 |@@@@@@@@@@@@@@@@@@@@@@@@@@                          |
[600, 700)           376 |@@@@@@@@@@@@@                                       |
[700, 800)           375 |@@@@@@@@@@@@@                                       |
[800, 900)           379 |@@@@@@@@@@@@@                                       |
[900, 1000)          322 |@@@@@@@@@@@                                         |
[1000, 1100)         256 |@@@@@@@@                                            |
[1100, 1200)         406 |@@@@@@@@@@@@@@                                      |
[1200, 1300)         690 |@@@@@@@@@@@@@@@@@@@@@@@@                            |
[1300, 1400)         803 |@@@@@@@@@@@@@@@@@@@@@@@@@@@                         |
[1400, 1500)         582 |@@@@@@@@@@@@@@@@@@@@                                |
[1500, ...)         1402 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@    |
</span></code></pre>
<p>To understand exactly what’s going on here, we’d have to dig into the
file-system we’re using. This is going to be out of scope (otherwise I’m never
going to be sending anything out). But, to not leave you completely hanging,
presumably, <code>ext4</code> is using techniques similar to MySQL’s group commit to batch
writes together in the journal (equivalent to the write-ahead-log of MySQL). In
ext4’s vocabulary, this seems to be called <a href="https://www.kernel.org/doc/Documentation/filesystems/ext4.txt"><code>max_batch_time</code></a>, but the
documentation on this is scanty at best. The disk could also be doing this in
addition/instead of the file-system. If you know more about this, please
enlighten me!</p>
<p>The bottom-line is that <code>fsync</code> can perform faster during real-life workloads than the
1 ms I obtain on this machine from repeatedly writing and <code>fsync</code>ing a file. Most
likely from the ext4 equivalent of group commit, which we won’t see on a
benchmark that never does multiple <code>fsync</code>s in parallel.</p>
<p>This brings us back around to explaining the discrepancy between real-life and
the napkin-math of MySQL’s theoretical, maximum throughput. We are able to
achieve an at least 5x increase in throughput from raw <code>fsync</code> calls due to:</p>
<ol>
<li>MySQL merging multiple transactions into fewer <code>fsync</code>s through ‘group commits.’</li>
<li>The file-system and/or disk merging multiple <code>fsync</code>s performed in parallel
through its own ‘group commits’, yielding faster performance.</li>
</ol>
<p>In essence, the same technique of batching is used at every layer to improve
performance.</p>
<p>While we didn’t manage to explain <em>everything</em> that’s going on here, I certainly
learned a lot from this investigation. It’d be interesting light of this to play
with changing the <a href="https://mariadb.com/kb/en/group-commit-for-the-binary-log/#changing-group-commit-frequency">group commit settings</a> to optimize MySQL for throughput over
latency. This could also be tuned at the file-system level.</p>
<h2 id="problem-9-inverted-index">Problem 9: Inverted Index<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 24 24"><path d="M9.199 13.599a5.99 5.99 0 0 0 3.949 2.345 5.987 5.987 0 0 0 5.105-1.702l2.995-2.994a5.992 5.992 0 0 0 1.695-4.285 5.976 5.976 0 0 0-1.831-4.211 5.99 5.99 0 0 0-6.431-1.242 6.003 6.003 0 0 0-1.905 1.24l-1.731 1.721a.999.999 0 1 0 1.41 1.418l1.709-1.699a3.985 3.985 0 0 1 2.761-1.123 3.975 3.975 0 0 1 2.799 1.122 3.997 3.997 0 0 1 .111 5.644l-3.005 3.006a3.982 3.982 0 0 1-3.395 1.126 3.987 3.987 0 0 1-2.632-1.563A1 1 0 0 0 9.201 13.6zm5.602-3.198a5.99 5.99 0 0 0-3.949-2.345 5.987 5.987 0 0 0-5.105 1.702l-2.995 2.994a5.992 5.992 0 0 0-1.695 4.285 5.976 5.976 0 0 0 1.831 4.211 5.99 5.99 0 0 0 6.431 1.242 6.003 6.003 0 0 0 1.905-1.24l1.723-1.723a.999.999 0 1 0-1.414-1.414L9.836 19.81a3.985 3.985 0 0 1-2.761 1.123 3.975 3.975 0 0 1-2.799-1.122 3.997 3.997 0 0 1-.111-5.644l3.005-3.006a3.982 3.982 0 0 1 3.395-1.126 3.987 3.987 0 0 1 2.632 1.563 1 1 0 0 0 1.602-1.198z"></path></svg></h2>
<p><a href="https://sirupsen.com/napkin/problem-9/">Last month, we looked at the inverted
index.</a> This data-structure is what’s
behind full-text search, and the way the documents are packed works well for set
intersections.</p>
<figure><img alt="" loading="lazy" width="1007" height="648" decoding="async" data-nimg="1" sizes="(min-width: 36rem) 36rem 100vw" srcset="https://sirupsen.com/_next/image?url=%2Fimages%2F66641ef5-efe4-440a-a616-0d30310e7540.png&amp;w=640&amp;q=75 640w, https://sirupsen.com/_next/image?url=%2Fimages%2F66641ef5-efe4-440a-a616-0d30310e7540.png&amp;w=750&amp;q=75 750w, https://sirupsen.com/_next/image?url=%2Fimages%2F66641ef5-efe4-440a-a616-0d30310e7540.png&amp;w=828&amp;q=75 828w, https://sirupsen.com/_next/image?url=%2Fimages%2F66641ef5-efe4-440a-a616-0d30310e7540.png&amp;w=1080&amp;q=75 1080w, https://sirupsen.com/_next/image?url=%2Fimages%2F66641ef5-efe4-440a-a616-0d30310e7540.png&amp;w=1200&amp;q=75 1200w, https://sirupsen.com/_next/image?url=%2Fimages%2F66641ef5-efe4-440a-a616-0d30310e7540.png&amp;w=1920&amp;q=75 1920w, https://sirupsen.com/_next/image?url=%2Fimages%2F66641ef5-efe4-440a-a616-0d30310e7540.png&amp;w=2048&amp;q=75 2048w, https://sirupsen.com/_next/image?url=%2Fimages%2F66641ef5-efe4-440a-a616-0d30310e7540.png&amp;w=3840&amp;q=75 3840w" src="https://sirupsen.com/_next/image?url=%2Fimages%2F66641ef5-efe4-440a-a616-0d30310e7540.png&amp;w=3840&amp;q=75"></figure>
<p><strong>(A) How long do you estimate it’d take to get the ids for <code>title AND see</code> with 2
million ids for title, and 1 million for see?</strong></p>
<p>Let’s assume that each document id is stored as a 64-bit integer. Then we’re
dealing with <code>1 * 10^6 * 64bit = 8 Mb</code> and <code>2 * 10^6 * 64 bit = 16 Mb</code>. If we
use an exceptionally simple set intersection algorithm of essentially two nested
for-loops, we need to scan ~<code>24Mb</code> of sequential memory. According to the
<a href="https://github.com/sirupsen/napkin-math">reference</a>, we can do this in <code>1Mb/100us * 24Mb = 2.4ms</code>.</p>
<p>Strangely, the Lucene <a href="https://home.apache.org/~mikemccand/lucenebench/AndHighHigh.html">nightly benchmarks</a> are performing these queries at
roughly 22 QPS, or <code>1000ms/22 = 45ms</code> per query. That’s substantially worse than
our prediction. I was ready to explain why Lucene might be <em>faster</em> (e.g. by
compressing postings to less than 64-bit), but not why it might be 20x slower!
We’ve got ourselves another first-principle gap.</p>
<p>Some slowness can be due to reading from disk, but since the access pattern is
sequential, it <a href="https://github.com/sirupsen/napkin-math">should only be 2-3x slower</a>. The hardware could be different
than the reference, but hardly anything that’d explain 20x. Sending the data to
the client might incur a large penalty, but again, 20x seems enormous. This type
of gap points towards missing something fundamental (as we saw with MySQL).
Unfortunately, this month I didn’t have time to dig much deeper than this, as I
prioritized the MySQL post.</p>
<p><strong>(B) What about title OR see?</strong></p>
<p>In this case we’d have to scan roughly as much memory, but handle more documents
and potentially transfer more back to the client. We’d expect to roughly be in
the same ballpark for performance ~<code>2.4ms</code>.</p>
<p>Lucene in this case is doing <a href="https://home.apache.org/~mikemccand/lucenebench/OrHighHigh.html">roughly half the throughput</a>, which aligns with
our relative expectations. But again, in absolute terms, Lucene’s handling these
queries in ~100ms, which is much, much higher than we expect.</p>
<p><strong>(C) How do the Lucene nightly benchmarks compare for (A) and (B)? This file
shows some of the actual terms used. If they don’t line up, how might you
explain the discrepency?</strong></p>
<p>Answered inline with (A) and (B).</p>
<p><strong>(D) Let’s imagine that we want title AND see and order the results by the last
modification date of each document. How long would you expect that to take?</strong></p>
<p>If the postings are not stored in that order, we’d naively expect in the worst
case we’d need to sort roughly ~24Mb of memory, <a href="https://github.com/sirupsen/napkin-math#numbers">at
5ms/Mb</a>. This would land us in the
<code>5mb/mb * 24mb ~= 120ms</code> query time ballpark.</p>
<p>In reality, this seems like an unintentional trick question. If ordered by last
modification date, they’d already be sorted in roughly that order, since new
documents are inserted to the end of the list. Which means they’re already
stored in <em>roughly</em> the right order, meaning our sort has to move far less bits
around. Even if that wasn’t the case, we could store sorted list for just this
column, which e.g. Lucene allows with doc values.</p><div><p>Subscribe through email,</p><!-- --> <p><a href="https://sirupsen.com/atom.xml">RSS</a></p><!-- --><p>or</p><!-- --> <p><a href="https://twitter.com/Sirupsen" title="Twitter" target="_blank" rel="noopener noreferrer">Twitter</a></p><!-- --><p>to new articles!</p><p> <!-- -->3,637<!-- --> <!-- -->subscribers</p></div><p><i>You might also like...</i></p><ul><li><a href="https://sirupsen.com/napkin/problem-14-using-checksums-to-verify">Using checksums to verify syncing 100M database records</a></li><li><a href="https://sirupsen.com/shitlists">Shitlist Driven Development</a></li><li><a href="https://sirupsen.com/napkin/neural-net">Neural Network From Scratch</a></li><li><a href="https://sirupsen.com/napkin/problem-9">Inverted Index Performance and Merkle Tree Syncronization</a></li><li><a href="https://sirupsen.com/napkin/problem-15">Increase HTTP Performance by Fitting In the Initial TCP Slow Start Window</a></li></ul></article></div>]]></description>
        </item>
        <item>
            <title><![CDATA[France rejects backdoor mandate (880 pts)]]></title>
            <link>https://www.eff.org/deeplinks/2025/03/win-encryption-france-rejects-backdoor-mandate</link>
            <guid>43440513</guid>
            <pubDate>Fri, 21 Mar 2025 20:35:11 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.eff.org/deeplinks/2025/03/win-encryption-france-rejects-backdoor-mandate">https://www.eff.org/deeplinks/2025/03/win-encryption-france-rejects-backdoor-mandate</a>, See on <a href="https://news.ycombinator.com/item?id=43440513">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
            <article role="article">
  
  
  <div><p><span>In a moment of clarity after initially moving forward a deeply flawed piece of legislation, the French National Assembly has done the right thing: it rejected a dangerous proposal that would have gutted end-to-end encryption in the name of fighting drug trafficking. Despite heavy pressure from the Interior Ministry, </span><a href="https://www.lemonde.fr/societe/article/2025/03/21/l-assemblee-vote-pour-le-maintien-de-la-confidentialite-des-messageries-cryptees-lors-d-une-nuit-agitee_6584121_3224.html"><span>lawmakers voted Thursday night</span></a><span> (article in French) to strike down a provision that would have forced messaging platforms like Signal and WhatsApp to allow hidden access to private conversations.</span></p>
<p><span>The vote is a victory for digital rights, for privacy and security, and for common sense.</span></p>
<p><span>The proposed law was a surveillance wishlist disguised as anti-drug legislation. Tucked into its text was a resurrection of the </span><a href="https://www.eff.org/deeplinks/2019/01/give-ghost-backdoor-another-name"><span>widely discredited "ghost” participant model</span></a><span>—a backdoor that pretends not to be one. Under this scheme, law enforcement could silently join encrypted chats, undermining the very idea of private communication. Security experts have </span><a href="https://www.justsecurity.org/64968/why-the-ghost-keys-solution-to-encryption-is-no-solution/"><span>condemned</span></a><span> the approach, </span><a href="https://www.internetsociety.org/resources/doc/2020/fact-sheet-ghost-proposals/"><span>warning</span></a><span> it would introduce systemic vulnerabilities, damage trust in secure communication platforms, and create tools ripe for abuse.</span></p>
<p><span>The French lawmakers who voted this provision down deserve credit. They listened—not only to </span><a href="https://www.laquadrature.net/en/warondrugslaw/"><span>French digital rights organizations</span></a><span> and technologists, but also to basic principles of cybersecurity and civil liberties. They understood that encryption protects everyone, not just activists and dissidents, but also journalists, medical professionals, abuse survivors, and ordinary citizens trying to live private lives in an increasingly surveilled world.</span></p>
<h3><b>A Global Signal</b></h3>
<p><span>France’s rejection of the backdoor provision should send a message to legislatures around the world: you don’t have to sacrifice fundamental rights in the name of public safety. Encryption is not the enemy of justice; it’s a tool that </span><a href="https://www.eff.org/deeplinks/2024/03/european-court-human-rights-confirms-undermining-encryption-violates-fundamental"><span>supports our fundamental human rights</span></a><span>, including the right to have a private conversation. It is a pillar of modern democracy and cybersecurity.</span></p>
<p><span>As governments in the U.S., U.K., Australia, and elsewhere </span><a href="https://www.eff.org/deeplinks/2024/12/defending-encryption-us-and-abroad"><span>continue to flirt with anti-encryption laws</span></a><span>, this decision should serve as a model—and a warning. Undermining encryption doesn’t make society safer. It makes everyone more vulnerable.</span></p>
<p><span>This victory was not inevitable. It came after sustained public pressure, expert input, and tireless advocacy from civil society. It shows that pushing back works. But for the foreseeable future, misguided lobbyists for police national security agencies will continue to push similar proposals—perhaps repackaged, or rushed through quieter legislative moments.</span></p>
<p><span>Supporters of privacy should celebrate this win today. Tomorrow, we will continue to keep watch. </span></p>

</div>

          </article>
    </div><div>
          <h2>Join EFF Lists</h2>
        
    </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[The little book about OS development (352 pts)]]></title>
            <link>https://littleosbook.github.io/</link>
            <guid>43440473</guid>
            <pubDate>Fri, 21 Mar 2025 20:30:32 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://littleosbook.github.io/">https://littleosbook.github.io/</a>, See on <a href="https://news.ycombinator.com/item?id=43440473">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="wrapper">
<div id="TOC">
<h2>Contents</h2>
<ul>
<li><a href="#introduction"><span>1</span> Introduction</a><ul>
<li><a href="#about-the-book"><span>1.1</span> About the Book</a></li>
<li><a href="#the-reader"><span>1.2</span> The Reader</a></li>
<li><a href="#credits-thanks-and-acknowledgements"><span>1.3</span> Credits, Thanks and Acknowledgements</a></li>
<li><a href="#contributors"><span>1.4</span> Contributors</a></li>
<li><a href="#changes-and-corrections"><span>1.5</span> Changes and Corrections</a></li>
<li><a href="#issues-and-where-to-get-help"><span>1.6</span> Issues and where to get help</a></li>
<li><a href="#license"><span>1.7</span> License</a></li>
</ul></li>
<li><a href="#first-steps"><span>2</span> First Steps</a><ul>
<li><a href="#tools"><span>2.1</span> Tools</a><ul>
<li><a href="#quick-setup"><span>2.1.1</span> Quick Setup</a></li>
<li><a href="#programming-languages"><span>2.1.2</span> Programming Languages</a></li>
<li><a href="#host-operating-system"><span>2.1.3</span> Host Operating System</a></li>
<li><a href="#build-system"><span>2.1.4</span> Build System</a></li>
<li><a href="#virtual-machine"><span>2.1.5</span> Virtual Machine</a></li>
</ul></li>
<li><a href="#booting"><span>2.2</span> Booting</a><ul>
<li><a href="#bios"><span>2.2.1</span> BIOS</a></li>
<li><a href="#the-bootloader"><span>2.2.2</span> The Bootloader</a></li>
<li><a href="#the-operating-system"><span>2.2.3</span> The Operating System</a></li>
</ul></li>
<li><a href="#hello-cafebabe"><span>2.3</span> Hello Cafebabe</a><ul>
<li><a href="#compiling-the-operating-system"><span>2.3.1</span> Compiling the Operating System</a></li>
<li><a href="#linking-the-kernel"><span>2.3.2</span> Linking the Kernel</a></li>
<li><a href="#obtaining-grub"><span>2.3.3</span> Obtaining GRUB</a></li>
<li><a href="#building-an-iso-image"><span>2.3.4</span> Building an ISO Image</a></li>
<li><a href="#running-bochs"><span>2.3.5</span> Running Bochs</a></li>
</ul></li>
<li><a href="#further-reading"><span>2.4</span> Further Reading</a></li>
</ul></li>
<li><a href="#getting-to-c"><span>3</span> Getting to C</a><ul>
<li><a href="#setting-up-a-stack"><span>3.1</span> Setting Up a Stack</a></li>
<li><a href="#calling-c-code-from-assembly"><span>3.2</span> Calling C Code From Assembly</a><ul>
<li><a href="#packing-structs"><span>3.2.1</span> Packing Structs</a></li>
</ul></li>
<li><a href="#compiling-c-code"><span>3.3</span> Compiling C Code</a></li>
<li><a href="#build-tools"><span>3.4</span> Build Tools</a></li>
<li><a href="#further-reading-1"><span>3.5</span> Further Reading</a></li>
</ul></li>
<li><a href="#output"><span>4</span> Output</a><ul>
<li><a href="#interacting-with-the-hardware"><span>4.1</span> Interacting with the Hardware</a></li>
<li><a href="#the-framebuffer"><span>4.2</span> The Framebuffer</a><ul>
<li><a href="#writing-text"><span>4.2.1</span> Writing Text</a></li>
<li><a href="#moving-the-cursor"><span>4.2.2</span> Moving the Cursor</a></li>
<li><a href="#the-driver"><span>4.2.3</span> The Driver</a></li>
</ul></li>
<li><a href="#the-serial-ports"><span>4.3</span> The Serial Ports</a><ul>
<li><a href="#configuring-the-serial-port"><span>4.3.1</span> Configuring the Serial Port</a></li>
<li><a href="#configuring-the-line"><span>4.3.2</span> Configuring the Line</a></li>
<li><a href="#configuring-the-buffers"><span>4.3.3</span> Configuring the Buffers</a></li>
<li><a href="#configuring-the-modem"><span>4.3.4</span> Configuring the Modem</a></li>
<li><a href="#writing-data-to-the-serial-port"><span>4.3.5</span> Writing Data to the Serial Port</a></li>
<li><a href="#configuring-bochs"><span>4.3.6</span> Configuring Bochs</a></li>
<li><a href="#the-driver-1"><span>4.3.7</span> The Driver</a></li>
</ul></li>
<li><a href="#further-reading-2"><span>4.4</span> Further Reading</a></li>
</ul></li>
<li><a href="#segmentation"><span>5</span> Segmentation</a><ul>
<li><a href="#accessing-memory"><span>5.1</span> Accessing Memory</a></li>
<li><a href="#the-global-descriptor-table-gdt"><span>5.2</span> The Global Descriptor Table (GDT)</a></li>
<li><a href="#loading-the-gdt"><span>5.3</span> Loading the GDT</a></li>
<li><a href="#further-reading-3"><span>5.4</span> Further Reading</a></li>
</ul></li>
<li><a href="#interrupts-and-input"><span>6</span> Interrupts and Input</a><ul>
<li><a href="#interrupts-handlers"><span>6.1</span> Interrupts Handlers</a></li>
<li><a href="#creating-an-entry-in-the-idt"><span>6.2</span> Creating an Entry in the IDT</a></li>
<li><a href="#handling-an-interrupt"><span>6.3</span> Handling an Interrupt</a></li>
<li><a href="#creating-a-generic-interrupt-handler"><span>6.4</span> Creating a Generic Interrupt Handler</a></li>
<li><a href="#loading-the-idt"><span>6.5</span> Loading the IDT</a></li>
<li><a href="#programmable-interrupt-controller-pic"><span>6.6</span> Programmable Interrupt Controller (PIC)</a></li>
<li><a href="#reading-input-from-the-keyboard"><span>6.7</span> Reading Input from the Keyboard</a></li>
<li><a href="#further-reading-4"><span>6.8</span> Further Reading</a></li>
</ul></li>
<li><a href="#the-road-to-user-mode"><span>7</span> The Road to User Mode</a><ul>
<li><a href="#loading-an-external-program"><span>7.1</span> Loading an External Program</a><ul>
<li><a href="#grub-modules"><span>7.1.1</span> GRUB Modules</a></li>
</ul></li>
<li><a href="#executing-a-program"><span>7.2</span> Executing a Program</a><ul>
<li><a href="#a-very-simple-program"><span>7.2.1</span> A Very Simple Program</a></li>
<li><a href="#compiling"><span>7.2.2</span> Compiling</a></li>
<li><a href="#finding-the-program-in-memory"><span>7.2.3</span> Finding the Program in Memory</a></li>
<li><a href="#jumping-to-the-code"><span>7.2.4</span> Jumping to the Code</a></li>
</ul></li>
<li><a href="#the-beginning-of-user-mode"><span>7.3</span> The Beginning of User Mode</a></li>
</ul></li>
<li><a href="#a-short-introduction-to-virtual-memory"><span>8</span> A Short Introduction to Virtual Memory</a><ul>
<li><a href="#virtual-memory-through-segmentation"><span>8.1</span> Virtual Memory Through Segmentation?</a></li>
<li><a href="#further-reading-5"><span>8.2</span> Further Reading</a></li>
</ul></li>
<li><a href="#paging"><span>9</span> Paging</a><ul>
<li><a href="#why-paging"><span>9.1</span> Why Paging?</a></li>
<li><a href="#paging-in-x86"><span>9.2</span> Paging in x86</a><ul>
<li><a href="#identity-paging"><span>9.2.1</span> Identity Paging</a></li>
<li><a href="#enabling-paging"><span>9.2.2</span> Enabling Paging</a></li>
<li><a href="#a-few-details"><span>9.2.3</span> A Few Details</a></li>
</ul></li>
<li><a href="#paging-and-the-kernel"><span>9.3</span> Paging and the Kernel</a><ul>
<li><a href="#reasons-to-not-identity-map-the-kernel"><span>9.3.1</span> Reasons to Not Identity Map the Kernel</a></li>
<li><a href="#the-virtual-address-for-the-kernel"><span>9.3.2</span> The Virtual Address for the Kernel</a></li>
<li><a href="#placing-the-kernel-at-0xc0000000"><span>9.3.3</span> Placing the Kernel at <code>0xC0000000</code></a></li>
<li><a href="#higher-half-linker-script"><span>9.3.4</span> Higher-half Linker Script</a></li>
<li><a href="#entering-the-higher-half"><span>9.3.5</span> Entering the Higher Half</a></li>
<li><a href="#running-in-the-higher-half"><span>9.3.6</span> Running in the Higher Half</a></li>
</ul></li>
<li><a href="#virtual-memory-through-paging"><span>9.4</span> Virtual Memory Through Paging</a></li>
<li><a href="#further-reading-6"><span>9.5</span> Further Reading</a></li>
</ul></li>
<li><a href="#page-frame-allocation"><span>10</span> Page Frame Allocation</a><ul>
<li><a href="#managing-available-memory"><span>10.1</span> Managing Available Memory</a><ul>
<li><a href="#how-much-memory-is-there"><span>10.1.1</span> How Much Memory is There?</a></li>
<li><a href="#managing-available-memory-1"><span>10.1.2</span> Managing Available Memory</a></li>
</ul></li>
<li><a href="#how-can-we-access-a-page-frame"><span>10.2</span> How Can We Access a Page Frame?</a></li>
<li><a href="#a-kernel-heap"><span>10.3</span> A Kernel Heap</a></li>
<li><a href="#further-reading-7"><span>10.4</span> Further reading</a></li>
</ul></li>
<li><a href="#user-mode"><span>11</span> User Mode</a><ul>
<li><a href="#segments-for-user-mode"><span>11.1</span> Segments for User Mode</a></li>
<li><a href="#setting-up-for-user-mode"><span>11.2</span> Setting Up For User Mode</a></li>
<li><a href="#entering-user-mode"><span>11.3</span> Entering User Mode</a></li>
<li><a href="#using-c-for-user-mode-programs"><span>11.4</span> Using C for User Mode Programs</a><ul>
<li><a href="#a-c-library"><span>11.4.1</span> A C Library</a></li>
</ul></li>
<li><a href="#further-reading-8"><span>11.5</span> Further Reading</a></li>
</ul></li>
<li><a href="#file-systems"><span>12</span> File Systems</a><ul>
<li><a href="#why-a-file-system"><span>12.1</span> Why a File System?</a></li>
<li><a href="#a-simple-read-only-file-system"><span>12.2</span> A Simple Read-Only File System</a></li>
<li><a href="#inodes-and-writable-file-systems"><span>12.3</span> Inodes and Writable File Systems</a></li>
<li><a href="#a-virtual-file-system"><span>12.4</span> A Virtual File System</a></li>
<li><a href="#further-reading-9"><span>12.5</span> Further Reading</a></li>
</ul></li>
<li><a href="#system-calls"><span>13</span> System Calls</a><ul>
<li><a href="#designing-system-calls"><span>13.1</span> Designing System Calls</a></li>
<li><a href="#implementing-system-calls"><span>13.2</span> Implementing System Calls</a></li>
<li><a href="#further-reading-10"><span>13.3</span> Further Reading</a></li>
</ul></li>
<li><a href="#multitasking"><span>14</span> Multitasking</a><ul>
<li><a href="#creating-new-processes"><span>14.1</span> Creating New Processes</a></li>
<li><a href="#cooperative-scheduling-with-yielding"><span>14.2</span> Cooperative Scheduling with Yielding</a></li>
<li><a href="#preemptive-scheduling-with-interrupts"><span>14.3</span> Preemptive Scheduling with Interrupts</a><ul>
<li><a href="#programmable-interval-timer"><span>14.3.1</span> Programmable Interval Timer</a></li>
<li><a href="#separate-kernel-stacks-for-processes"><span>14.3.2</span> Separate Kernel Stacks for Processes</a></li>
<li><a href="#difficulties-with-preemptive-scheduling"><span>14.3.3</span> Difficulties with Preemptive Scheduling</a></li>
</ul></li>
<li><a href="#further-reading-11"><span>14.4</span> Further Reading</a></li>
</ul></li>
</ul>
</div>
<h2 id="introduction"> Introduction</h2>
<p>This text is a practical guide to writing your own x86 operating system. It is designed to give enough help with the technical details while at the same time not reveal too much with samples and code excerpts. We’ve tried to collect parts of the vast (and often excellent) expanse of material and tutorials available, on the web and otherwise, and add our own insights into the problems we encountered and struggled with.</p>
<p>This book is not about the theory behind operating systems, or how any specific operating system (OS) works. For OS theory we recommend the book <em>Modern Operating Systems</em> by Andrew Tanenbaum <span>[1]</span>. Lists and details on current operating systems are available on the Internet.</p>
<p>The starting chapters are quite detailed and explicit, to quickly get you into coding. Later chapters give more of an outline of what is needed, as more and more of the implementation and design becomes up to the reader, who should now be more familiar with the world of kernel development. At the end of some chapters there are links for further reading, which might be interesting and give a deeper understanding of the topics covered.</p>
<p>In <a href="#first-steps">chapter 2</a> and <a href="#getting-to-c">3</a> we set up our development environment and boot up our OS kernel in a virtual machine, eventually starting to write code in C. We continue in <a href="#output">chapter 4</a> with writing to the screen and the serial port, and then we dive into segmentation in <a href="#segmentation">chapter 5</a> and interrupts and input in <a href="#interrupts-and-input">chapter 6</a>.</p>
<p>After this we have a quite functional but bare-bones OS kernel. In <a href="#the-road-to-user-mode">chapter 7</a> we start the road to user mode applications, with virtual memory through paging (<a href="#a-short-introduction-to-virtual-memory">chapter 8</a> and <a href="#paging">9</a>), memory allocation (<a href="#page-frame-allocation">chapter 10</a>), and finally running a user application in <a href="#user-mode">chapter 11</a>.</p>
<p>In the last three chapters we discuss the more advanced topics of file systems (<a href="#file-systems">chapter 12</a>), system calls (<a href="#system-calls">chapter 13</a>), and multitasking (<a href="#multitasking">chapter 14</a>).</p>

<p>The OS kernel and this book were produced as part of an advanced individual course at the Royal Institute of Technology <span>[2]</span>, Stockholm. The authors had previously taken courses in OS theory, but had only minor practical experience with OS kernel development. In order to get more insight and a deeper understanding of how the theory from the previous OS courses works out in practice, the authors decided to create a new course, which focused on the development of a small OS. Another goal of the course was writing a thorough tutorial on how to develop a small OS basically from scratch, and this short book is the result.</p>
<p>The x86 architecture is, and has been for a long time, one of the most common hardware architectures. It was not a difficult choice to use the x86 architecture as the target of the OS, with its large community, extensive reference material and mature emulators. The documentation and information surrounding the details of the hardware we had to work with was not always easy to find or understand, despite (or perhaps due to) the age of the architecture.</p>
<p>The OS was developed in about six weeks of full-time work. The implementation was done in many small steps, and after each step the OS was tested manually. By developing in this incremental and iterative way, it was often easier to find any bugs that were introduced, since only a small part of the code had changed since the last known good state of the code. We encourage the reader to work in a similar way.</p>
<p>During the six weeks of development, almost every single line of code was written by the authors together (this way of working is also called <em>pair-programming</em>). It is our belief that we managed to avoid a lot of bugs due to this style of development, but this is hard to prove scientifically.</p>
<h2 id="the-reader"> The Reader</h2>
<p>The reader of this book should be comfortable with UNIX/Linux, systems programming, the C language and computer systems in general (such as hexadecimal notation <span>[3]</span>). This book could be a way to get started learning those things, but it will be more difficult, and developing an operating system is already challenging on its own. Search engines and other tutorials are often helpful if you get stuck.</p>
<h2 id="credits-thanks-and-acknowledgements"> Credits, Thanks and Acknowledgements</h2>
<p>We’d like to thank the OSDev community <span>[4]</span> for their great wiki and helpful members, and James Malloy for his eminent kernel development tutorial <span>[5]</span>. We’d also like to thank our supervisor Torbjörn Granlund for his insightful questions and interesting discussions.</p>
<p>Most of the CSS formatting of the book is based on the work by Scott Chacon for the book Pro Git, <a href="http://progit.org/">http://progit.org/</a>.</p>
<h2 id="contributors"> Contributors</h2>
<p>We are very grateful for the patches that people send us. The following users have all contributed to this book:</p>
<ul>
<li><a href="https://github.com/alexschneider">alexschneider</a></li>
<li><a href="https://github.com/Avidanborisov">Avidanborisov</a></li>
<li><a href="https://github.com/nirs">nirs</a></li>
<li><a href="https://github.com/kedarmhaswade">kedarmhaswade</a></li>
<li><a href="https://github.com/vamanea">vamanea</a></li>
<li><a href="https://github.com/ansjob">ansjob</a></li>
</ul>
<h2 id="changes-and-corrections"> Changes and Corrections</h2>
<p>This book is hosted on Github - if you have any suggestions, comments or corrections, just fork the book, write your changes, and send us a pull request. We’ll happily incorporate anything that makes this book better.</p>
<h2 id="issues-and-where-to-get-help"> Issues and where to get help</h2>
<p>If you run into problems while reading the book, please check the issues on Github for help: <a href="https://github.com/littleosbook/littleosbook/issues">https://github.com/littleosbook/littleosbook/issues</a>.</p>
<h2 id="license"> License</h2>
<p>All content is under the Creative Commons Attribution Non Commercial Share Alike 3.0 license, <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/us/">http://creativecommons.org/licenses/by-nc-sa/3.0/us/</a>. The code samples are in the public domain - use them however you want. References to this book are always received with warmth.</p>
<h2 id="first-steps"> First Steps</h2>
<p>Developing an operating system (OS) is no easy task, and the question “How do I even begin to solve this problem?” is likely to come up several times during the course of the project for different problems. This chapter will help you set up your development environment and booting a very small (and primitive) operating system.</p>

<h3 id="quick-setup"> Quick Setup</h3>
<p>We (the authors) have used Ubuntu <span>[6]</span> as the operating system for doing OS development, running it both physically and virtually (using the virtual machine VirtualBox <span>[7]</span>). A quick way to get everything up and running is to use the same setup as we did, since we know that these tools work with the samples provided in this book.</p>
<p>Once Ubuntu is installed, either physical or virtual, the following packages should be installed using <code>apt-get</code>:</p>
<pre><code>    <span>sudo</span> apt-get install build-essential nasm genisoimage bochs bochs-sdl</code></pre>
<h3 id="programming-languages"> Programming Languages</h3>
<p>The operating system will be developed using the C programming language <span>[8]</span><span>[9]</span>, using GCC <span>[10]</span>. We use C because developing an OS requires a very precise control of the generated code and direct access to memory. Other languages that provide the same features can also be used, but this book will only cover C.</p>
<p>The code will make use of one type attribute that is specific for GCC:</p>
<pre><code>    __attribute__((packed))</code></pre>
<p>This attribute allows us to ensure that the compiler uses a memory layout for a <code>struct</code> exactly as we define it in the code. This is explained in more detail in the next chapter.</p>
<p>Due to this attribute, the example code might be hard to compile using a C compiler other than GCC.</p>
<p>For writing assembly code, we have chosen NASM <span>[11]</span> as the assembler, since we prefer NASM’s syntax over GNU Assembler.</p>
<p>Bash <span>[12]</span> will be used as the scripting language throughout the book.</p>
<h3 id="host-operating-system"> Host Operating System</h3>
<p>All the code examples assumes that the code is being compiled on a UNIX like operating system. All code examples have been successfully compiled using Ubuntu <span>[6]</span> versions 11.04 and 11.10.</p>
<h3 id="build-system"> Build System</h3>
<p>Make <span>[13]</span> has been used when constructing the Makefile examples.</p>
<h3 id="virtual-machine"> Virtual Machine</h3>
<p>When developing an OS it is very convenient to be able to run your code in a <em>virtual machine</em> instead of on a physical computer, since starting your OS in a virtual machine is much faster than getting your OS onto a physical medium and then running it on a physical machine. Bochs <span>[14]</span> is an emulator for the x86 (IA-32) platform which is well suited for OS development due to its debugging features. Other popular choices are QEMU <span>[15]</span> and VirtualBox <span>[7]</span>. This book uses Bochs.</p>
<p>By using a virtual machine we cannot ensure that our OS works on real, physical hardware. The environment simulated by the virtual machine is designed to be very similar to their physical counterparts, and the OS can be tested on one by just copying the executable to a CD and finding a suitable machine.</p>
<h2 id="booting"> Booting</h2>
<p>Booting an operating system consists of transferring control along a chain of small programs, each one more “powerful” than the previous one, where the operating system is the last “program”. See the following figure for an example of the boot process:</p>
<div>
<p><img src="https://littleosbook.github.io/images/boot_chain.png" alt="An example of the boot process. Each box is a program."></p><p>An example of the boot process. Each box is a program.</p>
</div>
<h3 id="bios"> BIOS</h3>
<p>When the PC is turned on, the computer will start a small program that adheres to the <em>Basic Input Output System</em> (BIOS) <span>[16]</span> standard. This program is usually stored on a read only memory chip on the motherboard of the PC. The original role of the BIOS program was to export some library functions for printing to the screen, reading keyboard input etc. Modern operating systems do not use the BIOS’ functions, they use drivers that interact directly with the hardware, bypassing the BIOS. Today, BIOS mainly runs some early diagnostics (power-on-self-test) and then transfers control to the bootloader.</p>
<h3 id="the-bootloader"> The Bootloader</h3>
<p>The BIOS program will transfer control of the PC to a program called a <em>bootloader</em>. The bootloader’s task is to transfer control to us, the operating system developers, and our code. However, due to some restrictions<a href="#fn1" id="fnref1"><sup>1</sup></a> of the hardware and because of backward compatibility, the bootloader is often split into two parts: the first part of the bootloader will transfer control to the second part, which finally gives control of the PC to the operating system.</p>
<p>Writing a bootloader involves writing a lot of low-level code that interacts with the BIOS. Therefore, an existing bootloader will be used: the GNU GRand Unified Bootloader (GRUB) <span>[17]</span>.</p>
<p>Using GRUB, the operating system can be built as an ordinary ELF <span>[18]</span> executable, which will be loaded by GRUB into the correct memory location. The compilation of the kernel requires that the code is laid out in memory in a specific way (how to compile the kernel will be discussed later in this chapter).</p>
<h3 id="the-operating-system"> The Operating System</h3>
<p>GRUB will transfer control to the operating system by jumping to a position in memory. Before the jump, GRUB will look for a magic number to ensure that it is actually jumping to an OS and not some random code. This magic number is part of the <em>multiboot specification</em> <span>[19]</span> which GRUB adheres to. Once GRUB has made the jump, the OS has full control of the computer.</p>
<h2 id="hello-cafebabe"> Hello Cafebabe</h2>
<p>This section will describe how to implement of the smallest possible OS that can be used together with GRUB. The only thing the OS will do is write <code>0xCAFEBABE</code> to the <code>eax</code> register (most people would probably not even call this an OS).</p>
<h3 id="compiling-the-operating-system"> Compiling the Operating System</h3>
<p>This part of the OS has to be written in assembly code, since C requires a stack, which isn’t available (the chapter <a href="#getting-to-c">“Getting to C”</a> describes how to set one up). Save the following code in a file called <code>loader.s</code>:</p>
<pre><code>    <span>global</span> loader                   <span>; the entry symbol for ELF</span>

    MAGIC_NUMBER <span>equ</span> <span>0x1BADB002</span>     <span>; define the magic number constant</span>
    FLAGS        <span>equ</span><span> 0x0            </span><span>; multiboot flags</span>
    CHECKSUM     <span>equ</span> -MAGIC_NUMBER  <span>; calculate the checksum</span>
                                    <span>; (magic number + checksum + flags should equal 0)</span>

    <span>section</span> .text:                  <span>; start of the text (code) section</span>
    <span>align</span> <span>4</span>                         <span>; the code must be 4 byte aligned</span>
        <span>dd</span> MAGIC_NUMBER             <span>; write the magic number to the machine code,</span>
        <span>dd</span> FLAGS                    <span>; the flags,</span>
        <span>dd</span> CHECKSUM                 <span>; and the checksum</span>

<span>    loader:</span>                         <span>; the loader label (defined as entry point in linker script)</span>
        <span>mov</span> <span>eax</span>, <span>0xCAFEBABE</span>         <span>; place the number 0xCAFEBABE in the register eax</span>
<span>    .loop:</span>
        <span>jmp</span> .<span>loop</span>                   <span>; loop forever</span></code></pre>
<p>The only thing this OS will do is write the very specific number <code>0xCAFEBABE</code> to the <code>eax</code> register. It is <em>very</em> unlikely that the number <code>0xCAFEBABE</code> would be in the <code>eax</code> register if the OS did <em>not</em> put it there.</p>
<p>The file <code>loader.s</code> can be compiled into a 32 bits ELF <span>[18]</span> object file with the following command:</p>
<pre><code>    <span>nasm</span> -f elf32 loader.s</code></pre>
<h3 id="linking-the-kernel"> Linking the Kernel</h3>
<p>The code must now be linked to produce an executable file, which requires some extra thought compared to when linking most programs. We want GRUB to load the kernel at a memory address larger than or equal to <code>0x00100000</code> (1 megabyte (MB)), because addresses lower than 1 MB are used by GRUB itself, BIOS and memory-mapped I/O. Therefore, the following linker script is needed (written for GNU LD <span>[20]</span>):</p>
<pre><code>ENTRY(loader)                /* the name of the entry label */

SECTIONS {
    . = 0x00100000;          /* the code should be loaded at 1 MB */

    .text ALIGN (0x1000) :   /* align at 4 KB */
    {
        *(.text)             /* all text sections from all files */
    }

    .rodata ALIGN (0x1000) : /* align at 4 KB */
    {
        *(.rodata*)          /* all read-only data sections from all files */
    }

    .data ALIGN (0x1000) :   /* align at 4 KB */
    {
        *(.data)             /* all data sections from all files */
    }

    .bss ALIGN (0x1000) :    /* align at 4 KB */
    {
        *(COMMON)            /* all COMMON sections from all files */
        *(.bss)              /* all bss sections from all files */
    }
}</code></pre>
<p>Save the linker script into a file called <code>link.ld</code>. The executable can now be linked with the following command:</p>
<pre><code>    <span>ld</span> -T link.ld -melf_i386 loader.o -o kernel.elf</code></pre>
<p>The final executable will be called <code>kernel.elf</code>.</p>
<h3 id="obtaining-grub"> Obtaining GRUB</h3>
<p>The GRUB version we will use is GRUB Legacy, since the OS ISO image can then be generated on systems using both GRUB Legacy and GRUB 2. More specifically, the GRUB Legacy <code>stage2_eltorito</code> bootloader will be used. This file can be built from GRUB 0.97 by downloading the source from <a href="ftp://alpha.gnu.org/gnu/grub/grub-0.97.tar.gz">ftp://alpha.gnu.org/gnu/grub/grub-0.97.tar.gz</a>. However, the <code>configure</code> script doesn’t work well with Ubuntu <span>[21]</span>, so the binary file can be downloaded from <a href="http://littleosbook.github.com/files/stage2_eltorito">http://littleosbook.github.com/files/stage2_eltorito</a>. Copy the file <code>stage2_eltorito</code> to the folder that already contains <code>loader.s</code> and <code>link.ld</code>.</p>
<h3 id="building-an-iso-image"> Building an ISO Image</h3>
<p>The executable must be placed on a media that can be loaded by a virtual or physical machine. In this book we will use ISO <span>[22]</span> image files as the media, but one can also use floppy images, depending on what the virtual or physical machine supports.</p>
<p>We will create the kernel ISO image with the program <code>genisoimage</code>. A folder must first be created that contains the files that will be on the ISO image. The following commands create the folder and copy the files to their correct places:</p>
<pre><code>    <span>mkdir</span> -p iso/boot/grub              <span># create the folder structure</span>
    <span>cp</span> stage2_eltorito iso/boot/grub/   <span># copy the bootloader</span>
    <span>cp</span> kernel.elf iso/boot/             <span># copy the kernel</span></code></pre>
<p>A configuration file <code>menu.lst</code> for GRUB must be created. This file tells GRUB where the kernel is located and configures some options:</p>
<pre><code>    default=0
    timeout=0

    title os
    kernel /boot/kernel.elf</code></pre>
<p>Place the file <code>menu.lst</code> in the folder <code>iso/boot/grub/</code>. The contents of the <code>iso</code> folder should now look like the following figure:</p>
<pre><code>    iso
    |-- boot
      |-- grub
      | |-- menu.lst
      | |-- stage2_eltorito
      |-- kernel.elf</code></pre>
<p>The ISO image can then be generated with the following command:</p>
<pre><code>    genisoimage -R                              \
                -b boot/grub/stage2_eltorito    \
                -no-emul-boot                   \
                -boot-load-size 4               \
                -A os                           \
                -input-charset utf8             \
                -quiet                          \
                -boot-info-table                \
                -o os.iso                       \
                iso</code></pre>
<p>For more information about the flags used in the command, see the manual for <code>genisoimage</code>.</p>
<p>The ISO image <code>os.iso</code> now contains the kernel executable, the GRUB bootloader and the configuration file.</p>
<h3 id="running-bochs"> Running Bochs</h3>
<p>Now we can run the OS in the Bochs emulator using the <code>os.iso</code> ISO image. Bochs needs a configuration file to start and an example of a simple configuration file is given below:</p>
<pre><code>    megs:            32
    display_library: sdl
    romimage:        file=/usr/share/bochs/BIOS-bochs-latest
    vgaromimage:     file=/usr/share/bochs/VGABIOS-lgpl-latest
    ata0-master:     type=cdrom, path=os.iso, status=inserted
    boot:            cdrom
    log:             bochslog.txt
    clock:           sync=realtime, time0=local
    cpu:             count=1, ips=1000000</code></pre>
<p>You might need to change the path to <code>romimage</code> and <code>vgaromimage</code> depending on how you installed Bochs. More information about the Bochs config file can be found at Boch’s website <span>[23]</span>.</p>
<p>If you saved the configuration in a file named <code>bochsrc.txt</code> then you can run Bochs with the following command:</p>
<pre><code>    bochs -f bochsrc.txt -q</code></pre>
<p>The flag <code>-f</code> tells Bochs to use the given configuration file and the flag <code>-q</code> tells Bochs to skip the interactive start menu. You should now see Bochs starting and displaying a console with some information from GRUB on it.</p>
<p>After quitting Bochs, display the log produced by Boch:</p>
<pre><code>    cat bochslog.txt</code></pre>
<p>You should now see the contents of the registers of the CPU simulated by Bochs somewhere in the output. If you find <code>RAX=00000000CAFEBABE</code> or <code>EAX=CAFEBABE</code> (depending on if you are running Bochs with or without 64 bit support) in the output then your OS has successfully booted!</p>
<h2 id="further-reading"> Further Reading</h2>
<ul>
<li>Gustavo Duertes has written an in-depth article about what actually happens when a x86 computer boots up, <a href="http://duartes.org/gustavo/blog/post/how-computers-boot-up">http://duartes.org/gustavo/blog/post/how-computers-boot-up</a></li>
<li>Gustavo continues to describe what the kernel does in the very early stages at <a href="http://duartes.org/gustavo/blog/post/kernel-boot-process">http://duartes.org/gustavo/blog/post/kernel-boot-process</a></li>
<li>The OSDev wiki also contains a nice article about booting an x86 computer: <a href="http://wiki.osdev.org/Boot_Sequence">http://wiki.osdev.org/Boot_Sequence</a></li>
</ul>
<h2 id="getting-to-c"> Getting to C</h2>
<p>This chapter will show you how to use C instead of assembly code as the programming language for the OS. Assembly is very good for interacting with the CPU and enables maximum control over every aspect of the code. However, at least for the authors, C is a much more convenient language to use. Therefore, we would like to use C as much as possible and use assembly code only where it make sense.</p>
<h2 id="setting-up-a-stack"> Setting Up a Stack</h2>
<p>One prerequisite for using C is a stack, since all non-trivial C programs use a stack. Setting up a stack is not harder than to make the <code>esp</code> register point to the end of an area of free memory (remember that the stack grows towards lower addresses on the x86) that is correctly aligned (alignment on 4 bytes is recommended from a performance perspective).</p>
<p>We could point <code>esp</code> to a random area in memory since, so far, the only thing in the memory is GRUB, BIOS, the OS kernel and some memory-mapped I/O. This is not a good idea - we don’t know how much memory is available or if the area <code>esp</code> would point to is used by something else. A better idea is to reserve a piece of uninitialized memory in the <code>bss</code> section in the ELF file of the kernel. It is better to use the <code>bss</code> section instead of the <code>data</code> section to reduce the size of the OS executable. Since GRUB understands ELF, GRUB will allocate any memory reserved in the <code>bss</code> section when loading the OS.</p>
<p>The NASM pseudo-instruction <code>resb</code> <span>[24]</span> can be used to declare uninitialized data:</p>
<pre><code>    KERNEL_STACK_SIZE <span>equ</span> <span>4096</span>                  <span>; size of stack in bytes</span>

    <span>section</span> .bss
    <span>align</span> <span>4</span>                                     <span>; align at 4 bytes</span>
<span>    kernel_stack:</span>                               <span>; label points to beginning of memory</span>
        <span>resb</span> KERNEL_STACK_SIZE                  <span>; reserve stack for the kernel</span></code></pre>
<p>There is no need to worry about the use of uninitialized memory for the stack, since it is not possible to read a stack location that has not been written (without manual pointer fiddling). A (correct) program can not pop an element from the stack without having pushed an element onto the stack first. Therefore, the memory locations of the stack will always be written to before they are being read.</p>
<p>The stack pointer is then set up by pointing <code>esp</code> to the end of the <code>kernel_stack</code> memory:</p>
<pre><code>    <span>mov</span> <span>esp</span>, kernel_stack + KERNEL_STACK_SIZE   <span>; point esp to the start of the</span>
                                                <span>; stack (end of memory area)</span></code></pre>
<h2 id="calling-c-code-from-assembly"> Calling C Code From Assembly</h2>
<p>The next step is to call a C function from assembly code. There are many different conventions for how to call C code from assembly code <span>[25]</span>. This book uses the <em>cdecl</em> calling convention, since that is the one used by GCC. The cdecl calling convention states that arguments to a function should be passed via the stack (on x86). The arguments of the function should be pushed on the stack in a right-to-left order, that is, you push the rightmost argument first. The return value of the function is placed in the <code>eax</code> register. The following code shows an example:</p>
<pre><code>    <span>/* The C function */</span>
    <span>int</span> sum_of_three(<span>int</span> arg1, <span>int</span> arg2, <span>int</span> arg3)
    {
        <span>return</span> arg1 + arg2 + arg3;
    }</code></pre>
<pre><code>    <span>; The assembly code</span>
    external sum_of_three   <span>; the function sum_of_three is defined elsewhere</span>

    <span>push</span> <span>dword</span> <span>3</span>            <span>; arg3</span>
    <span>push</span> <span>dword</span> <span>2</span>            <span>; arg2</span>
    <span>push</span> <span>dword</span> <span>1</span>            <span>; arg1</span>
    <span>call</span> sum_of_three       <span>; call the function, the result will be in eax</span></code></pre>
<h3 id="packing-structs"> Packing Structs</h3>
<p>In the rest of this book, you will often come across “configuration bytes” that are a collection of bits in a very specific order. Below follows an example with 32 bits:</p>
<pre><code>Bit:     | 31     24 | 23          8 | 7     0 |
Content: | index     | address       | config  |</code></pre>
<p>Instead of using an unsigned integer, <code>unsigned int</code>, for handling such configurations, it is much more convenient to use “packed structures”:</p>
<pre><code>    <span>struct</span> example {
        <span>unsigned</span> <span>char</span> config;   <span>/* bit 0 - 7   */</span>
        <span>unsigned</span> <span>short</span> address; <span>/* bit 8 - 23  */</span>
        <span>unsigned</span> <span>char</span> index;    <span>/* bit 24 - 31 */</span>
    };</code></pre>
<p>When using the <code>struct</code> in the previous example there is no guarantee that the size of the <code>struct</code> will be exactly 32 bits - the compiler can add some padding between elements for various reasons, for example to speed up element access or due to requirements set by the hardware and/or compiler. When using a <code>struct</code> to represent configuration bytes, it is very important that the compiler does <em>not</em> add any padding, because the <code>struct</code> will eventually be treated as a 32 bit unsigned integer by the hardware. The attribute <code>packed</code> can be used to force GCC to <em>not</em> add any padding:</p>
<pre><code>    <span>struct</span> example {
        <span>unsigned</span> <span>char</span> config;   <span>/* bit 0 - 7   */</span>
        <span>unsigned</span> <span>short</span> address; <span>/* bit 8 - 23  */</span>
        <span>unsigned</span> <span>char</span> index;    <span>/* bit 24 - 31 */</span>
    } __attribute__((packed));</code></pre>
<p>Note that <code>__attribute__((packed))</code> is not part of the C standard - it might not work with all C compilers.</p>
<h2 id="compiling-c-code"> Compiling C Code</h2>
<p>When compiling the C code for the OS, a lot of flags to GCC need to be used. This is because the C code should <em>not</em> assume the presence of a standard library, since there is no standard library available for our OS. For more information about the flags, see the GCC manual.</p>
<p>The flags used for compiling the C code are:</p>
<pre><code>    -m32 -nostdlib -nostdinc -fno-builtin -fno-stack-protector -nostartfiles
    -nodefaultlibs</code></pre>
<p>As always when writing C programs we recommend turning on all warnings and treat warnings as errors:</p>
<pre><code>    -Wall -Wextra -Werror</code></pre>
<p>You can now create a function <code>kmain</code> in a file called <code>kmain.c</code> that you call from <code>loader.s</code>. At this point, <code>kmain</code> probably won’t need any arguments (but in later chapters it will).</p>

<p>Now is also probably a good time to set up some build tools to make it easier to compile and test-run the OS. We recommend using <code>make</code> <span>[13]</span>, but there are plenty of other build systems available. A simple Makefile for the OS could look like the following example:</p>
<pre><code>    <span>OBJECTS </span><span>=</span><span> loader.o kmain.o</span>
    <span>CC </span><span>=</span><span> gcc</span>
    <span>CFLAGS </span><span>=</span><span> -m32 -nostdlib -nostdinc -fno-builtin -fno-stack-protector </span><span>\</span>
             <span>-</span><span>nostartfiles -nodefaultlibs -Wall -Wextra -Werror -c</span>
    <span>LDFLAGS </span><span>=</span><span> -T link.ld -melf_i386</span>
    <span>AS </span><span>=</span><span> nasm</span>
    <span>ASFLAGS </span><span>=</span><span> -f elf</span>

    all: kernel.elf

    kernel.elf: <span>$(</span><span>OBJECTS</span><span>)</span>
        ld <span>$(</span><span>LDFLAGS</span><span>)</span> <span>$(</span><span>OBJECTS</span><span>)</span> -o kernel.elf

    os.iso: kernel.elf
        cp kernel.elf iso/boot/kernel.elf
        genisoimage -R                              \
                    <span>-</span><span>b boot/grub/stage2_eltorito    </span><span>\</span>
                    <span>-</span><span>no-emul-boot                   </span><span>\</span>
                    <span>-</span><span>boot-load-size 4               </span><span>\</span>
                    <span>-</span><span>A os                           </span><span>\</span>
                    <span>-</span><span>input-charset utf8             </span><span>\</span>
                    <span>-</span><span>quiet                          </span><span>\</span>
                    <span>-</span><span>boot-info-table                </span><span>\</span>
                    <span>-</span><span>o os.iso                       </span><span>\</span>
                    iso

    run: os.iso
        bochs -f bochsrc.txt -q

    %.o: %.c
        <span>$(</span><span>CC</span><span>)</span> <span>$(</span><span>CFLAGS</span><span>)</span>  <span>$&lt;</span> -o <span>$@</span>

    %.o: %.s
        <span>$(</span><span>AS</span><span>)</span> <span>$(</span><span>ASFLAGS</span><span>)</span> <span>$&lt;</span> -o <span>$@</span>

    clean:
        rm -rf *.o kernel.elf os.iso</code></pre>
<p>The contents of your working directory should now look like the following figure:</p>
<pre><code>    .
    |-- bochsrc.txt
    |-- iso
    |   |-- boot
    |     |-- grub
    |       |-- menu.lst
    |       |-- stage2_eltorito
    |-- kmain.c
    |-- loader.s
    |-- Makefile</code></pre>
<p>You should now be able to start the OS with the simple command <code>make run</code>, which will compile the kernel and boot it up in Bochs (as defined in the Makefile above).</p>
<h2 id="further-reading-1"> Further Reading</h2>
<ul>
<li>Kernigan &amp; Richie’s book, <em>The C Programming Language, Second Edition</em>, <span>[8]</span> is great for learning about all the aspects of C.</li>
</ul>
<h2 id="output"> Output</h2>
<p>This chapter will present how to display text on the console as well as writing data to the serial port. Furthermore, we will create our first <em>driver</em>, that is, code that acts as a layer between the kernel and the hardware, providing a higher abstraction than communicating directly with the hardware. The first part of this chapter is about creating a driver for the <em>framebuffer</em> <span>[26]</span> to be able to display text on the console. The second part shows how to create a driver for the serial port. Bochs can store output from the serial port in a file, effectively creating a logging mechanism for the operating system.</p>
<h2 id="interacting-with-the-hardware"> Interacting with the Hardware</h2>
<p>There are usually two different ways to interact with the hardware, <em>memory-mapped I/O</em> and <em>I/O ports</em>.</p>
<p>If the hardware uses memory-mapped I/O then you can write to a specific memory address and the hardware will be updated with the new data. One example of this is the framebuffer, which will be discussed in more detail later. For example, if you write the value <code>0x410F</code> to address <code>0x000B8000</code>, you will see the letter A in white color on a black background (see the section on <a href="#the-framebuffer">the framebuffer</a> for more details).</p>
<p>If the hardware uses I/O ports then the assembly code instructions <code>out</code> and <code>in</code> must be used to communicate with the hardware. The instruction <code>out</code> takes two parameters: the address of the I/O port and the data to send. The instruction <code>in</code> takes a single parameter, the address of the I/O port, and returns data from the hardware. One can think of I/O ports as communicating with hardware the same way as you communicate with a server using sockets. The cursor (the blinking rectangle) of the framebuffer is one example of hardware controlled via I/O ports on a PC.</p>
<h2 id="the-framebuffer"> The Framebuffer</h2>
<p>The framebuffer is a hardware device that is capable of displaying a buffer of memory on the screen <span>[26]</span>. The framebuffer has 80 columns and 25 rows, and the row and column indices start at 0 (so rows are labelled 0 - 24).</p>
<h3 id="writing-text"> Writing Text</h3>
<p>Writing text to the console via the framebuffer is done with memory-mapped I/O. The starting address of the memory-mapped I/O for the framebuffer is <code>0x000B8000</code> <span>[27]</span>. The memory is divided into 16 bit cells, where the 16 bits determine both the character, the foreground color and the background color. The highest eight bits is the ASCII <span>[28]</span> value of the character, bit 7 - 4 the background and bit 3 - 0 the foreground, as can be seen in the following figure:</p>
<pre><code>Bit:     | 15 14 13 12 11 10 9 8 | 7 6 5 4 | 3 2 1 0 |
Content: | ASCII                 | FG      | BG      |</code></pre>
<p>The available colors are shown in the following table:</p>
<table>
<thead>
<tr>
<th>Color</th>
<th>Value</th>
<th>Color</th>
<th>Value</th>
<th>Color</th>
<th>Value</th>
<th>Color</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Black</td>
<td>0</td>
<td>Red</td>
<td>4</td>
<td>Dark grey</td>
<td>8</td>
<td>Light red</td>
<td>12</td>
</tr>
<tr>
<td>Blue</td>
<td>1</td>
<td>Magenta</td>
<td>5</td>
<td>Light blue</td>
<td>9</td>
<td>Light magenta</td>
<td>13</td>
</tr>
<tr>
<td>Green</td>
<td>2</td>
<td>Brown</td>
<td>6</td>
<td>Light green</td>
<td>10</td>
<td>Light brown</td>
<td>14</td>
</tr>
<tr>
<td>Cyan</td>
<td>3</td>
<td>Light grey</td>
<td>7</td>
<td>Light cyan</td>
<td>11</td>
<td>White</td>
<td>15</td>
</tr>
</tbody>
</table>
<p>The first cell corresponds to row zero, column zero on the console. Using an ASCII table, one can see that A corresponds to 65 or <code>0x41</code>. Therefore, to write the character A with a green foreground (2) and dark grey background (8) at place (0,0), the following assembly code instruction is used:</p>
<pre><code>    <span>mov</span> [<span>0x000B8000</span>]<span>, 0x4128</span></code></pre>
<p>The second cell then corresponds to row zero, column one and its address is therefore:</p>
<pre><code>    0x000B8000 + 16 = 0x000B8010</code></pre>
<p>Writing to the framebuffer can also be done in C by treating the address <code>0x000B8000</code> as a char pointer, <code>char *fb = (char *) 0x000B8000</code>. Then, writing A at place (0,0) with green foreground and dark grey background becomes:</p>
<pre><code>    fb[<span>0</span>] = <span>'A'</span><span>;</span>
    fb[<span>1</span>] = <span>0x28</span><span>;</span></code></pre>
<p>The following code shows how this can be wrapped into a function:</p>
<pre><code>    <span>/** fb_write_cell:</span>
<span>     *  Writes a character with the given foreground and background to position i</span>
<span>     *  in the framebuffer.</span>
<span>     *</span>
<span>     *  </span><span>@param</span><span> </span><span>i</span><span>  The location in the framebuffer</span>
<span>     *  </span><span>@param</span><span> </span><span>c</span><span>  The character</span>
<span>     *  </span><span>@param</span><span> </span><span>fg</span><span> The foreground color</span>
<span>     *  </span><span>@param</span><span> </span><span>bg</span><span> The background color</span>
<span>     */</span>
    <span>void</span> fb_write_cell(<span>unsigned</span> <span>int</span> i, <span>char</span> c, <span>unsigned</span> <span>char</span> fg, <span>unsigned</span> <span>char</span> bg)
    {
        fb[i] = c;
        fb[i + <span>1</span>] = ((fg &amp; <span>0x0F</span>) &lt;&lt; <span>4</span>) | (bg &amp; <span>0x0F</span>)
    }</code></pre>
<p>The function can then be used as follows:</p>
<pre><code>    <span>#define FB_GREEN     2</span>
    <span>#define FB_DARK_GREY 8</span>

    fb_write_cell(<span>0</span>, 'A', FB_GREEN, FB_DARK_GREY);</code></pre>
<h3 id="moving-the-cursor"> Moving the Cursor</h3>
<p>Moving the cursor of the framebuffer is done via two different I/O ports. The cursor’s position is determined with a 16 bits integer: 0 means row zero, column zero; 1 means row zero, column one; 80 means row one, column zero and so on. Since the position is 16 bits large, and the <code>out</code> assembly code instruction argument is 8 bits, the position must be sent in two turns, first 8 bits then the next 8 bits. The framebuffer has two I/O ports, one for accepting the data, and one for describing the data being received. Port <code>0x3D4</code> <span>[29]</span> is the port that describes the data and port <code>0x3D5</code> <span>[29]</span> is for the data itself.</p>
<p>To set the cursor at row one, column zero (position <code>80 = 0x0050</code>), one would use the following assembly code instructions:</p>
<pre><code>    <span>out</span> <span>0x3D4</span>, <span>14</span>      <span>; 14 tells the framebuffer to expect the highest 8 bits of the position</span>
    <span>out</span> <span>0x3D5, 0x00    </span><span>; sending the highest 8 bits of 0x0050</span>
    <span>out</span> <span>0x3D4</span>, <span>15</span>      <span>; 15 tells the framebuffer to expect the lowest 8 bits of the position</span>
    <span>out</span> <span>0x3D5, 0x50    </span><span>; sending the lowest 8 bits of 0x0050</span></code></pre>
<p>The <code>out</code> assembly code instruction can’t be executed directly in C. Therefore it is a good idea to wrap <code>out</code> in a function in assembly code which can be accessed from C via the cdecl calling standard <span>[25]</span>:</p>
<pre><code>    <span>global</span> outb             <span>; make the label outb visible outside this file</span>

    <span>; outb - send a byte to an I/O port</span>
    <span>; stack: [esp + 8] the data byte</span>
    <span>;        [esp + 4] the I/O port</span>
    <span>;        [esp    ] return address</span>
<span>    outb:</span>
        <span>mov</span> <span>al</span>, [<span>esp</span> + <span>8</span>]    <span>; move the data to be sent into the al register</span>
        <span>mov</span> <span>dx</span>, [<span>esp</span> + <span>4</span>]    <span>; move the address of the I/O port into the dx register</span>
        <span>out</span> <span>dx</span>, <span>al</span>           <span>; send the data to the I/O port</span>
        <span>ret</span>                  <span>; return to the calling function</span></code></pre>
<p>By storing this function in a file called <code>io.s</code> and also creating a header <code>io.h</code>, the <code>out</code> assembly code instruction can be conveniently accessed from C:</p>
<pre><code>    <span>#ifndef INCLUDE_IO_H</span>
    <span>#define INCLUDE_IO_H</span>

    <span>/** outb:</span>
<span>     *  Sends the given data to the given I/O port. Defined in io.s</span>
<span>     *</span>
<span>     *  </span><span>@param</span><span> </span><span>port</span><span> The I/O port to send the data to</span>
<span>     *  </span><span>@param</span><span> </span><span>data</span><span> The data to send to the I/O port</span>
<span>     */</span>
    <span>void</span> outb(<span>unsigned</span> <span>short</span> port, <span>unsigned</span> <span>char</span> data);

    <span>#endif </span><span>/* INCLUDE_IO_H */</span></code></pre>
<p>Moving the cursor can now be wrapped in a C function:</p>
<pre><code>    <span>#include "io.h"</span>

    <span>/* The I/O ports */</span>
    <span>#define FB_COMMAND_PORT         0x3D4</span>
    <span>#define FB_DATA_PORT            0x3D5</span>

    <span>/* The I/O port commands */</span>
    <span>#define FB_HIGH_BYTE_COMMAND    14</span>
    <span>#define FB_LOW_BYTE_COMMAND     15</span>

    <span>/** fb_move_cursor:</span>
<span>     *  Moves the cursor of the framebuffer to the given position</span>
<span>     *</span>
<span>     *  </span><span>@param</span><span> </span><span>pos</span><span> The new position of the cursor</span>
<span>     */</span>
    <span>void</span> fb_move_cursor(<span>unsigned</span> <span>short</span> pos)
    {
        outb(FB_COMMAND_PORT, FB_HIGH_BYTE_COMMAND);
        outb(FB_DATA_PORT,    ((pos &gt;&gt; <span>8</span>) &amp; <span>0x00FF</span>));
        outb(FB_COMMAND_PORT, FB_LOW_BYTE_COMMAND);
        outb(FB_DATA_PORT,    pos &amp; <span>0x00FF</span>);
    }</code></pre>
<h3 id="the-driver"> The Driver</h3>
<p>The driver should provide an interface that the rest of the code in the OS will use for interacting with the framebuffer. There is no right or wrong in what functionality the interface should provide, but a suggestion is to have a <code>write</code> function with the following declaration:</p>
<pre><code>    <span>int</span> write(<span>char</span> *buf, <span>unsigned</span> <span>int</span> len);</code></pre>
<p>The <code>write</code> function writes the contents of the buffer <code>buf</code> of length <code>len</code> to the screen. The <code>write</code> function should automatically advance the cursor after a character has been written and scroll the screen if necessary.</p>
<h2 id="the-serial-ports"> The Serial Ports</h2>
<p>The serial port <span>[30]</span> is an interface for communicating between hardware devices and although it is available on almost all motherboards, it is seldom exposed to the user in the form of a DE-9 connector nowadays. The serial port is easy to use, and, more importantly, it can be used as a logging utility in Bochs. If a computer has support for a serial port, then it usually has support for multiple serial ports, but we will only make use of one of the ports. This is because we will only use the serial ports for logging. Furthermore, we will only use the serial ports for output, not input. The serial ports are completely controlled via I/O ports.</p>
<h3 id="configuring-the-serial-port"> Configuring the Serial Port</h3>
<p>The first data that need to be sent to the serial port is configuration data. In order for two hardware devices to be able to talk to each other they must agree upon a couple of things. These things include:</p>
<ul>
<li>The speed used for sending data (bit or baud rate)</li>
<li>If any error checking should be used for the data (parity bit, stop bits)</li>
<li>The number of bits that represent a unit of data (data bits)</li>
</ul>
<h3 id="configuring-the-line"> Configuring the Line</h3>
<p>Configuring the line means to configure how data is being sent over the line. The serial port has an I/O port, the <em>line command port</em>, that is used for configuration.</p>
<p>First the speed for sending data will be set. The serial port has an internal clock that runs at 115200 Hz. Setting the speed means sending a divisor to the serial port, for example sending 2 results in a speed of <code>115200 / 2 = 57600</code> Hz.</p>
<p>The divisor is a 16 bit number but we can only send 8 bits at a time. We must therefore send an instruction telling the serial port to first expect the highest 8 bits, then the lowest 8 bits. This is done by sending <code>0x80</code> to the line command port. An example is shown below:</p>
<pre><code>    <span>#include "io.h" </span><span>/* io.h is implement in the section "Moving the cursor" */</span>

    <span>/* The I/O ports */</span>

    <span>/* All the I/O ports are calculated relative to the data port. This is because</span>
<span>     * all serial ports (COM1, COM2, COM3, COM4) have their ports in the same</span>
<span>     * order, but they start at different values.</span>
<span>     */</span>

    <span>#define SERIAL_COM1_BASE                0x3F8      </span><span>/* COM1 base port */</span>

    <span>#define SERIAL_DATA_PORT(base)          (base)</span>
    <span>#define SERIAL_FIFO_COMMAND_PORT(base)  (base + 2)</span>
    <span>#define SERIAL_LINE_COMMAND_PORT(base)  (base + 3)</span>
    <span>#define SERIAL_MODEM_COMMAND_PORT(base) (base + 4)</span>
    <span>#define SERIAL_LINE_STATUS_PORT(base)   (base + 5)</span>

    <span>/* The I/O port commands */</span>

    <span>/* SERIAL_LINE_ENABLE_DLAB:</span>
<span>     * Tells the serial port to expect first the highest 8 bits on the data port,</span>
<span>     * then the lowest 8 bits will follow</span>
<span>     */</span>
    <span>#define SERIAL_LINE_ENABLE_DLAB         0x80</span>

    <span>/** serial_configure_baud_rate:</span>
<span>     *  Sets the speed of the data being sent. The default speed of a serial</span>
<span>     *  port is 115200 bits/s. The argument is a divisor of that number, hence</span>
<span>     *  the resulting speed becomes (115200 / divisor) bits/s.</span>
<span>     *</span>
<span>     *  </span><span>@param</span><span> </span><span>com</span><span>      The COM port to configure</span>
<span>     *  </span><span>@param</span><span> </span><span>divisor</span><span>  The divisor</span>
<span>     */</span>
    <span>void</span> serial_configure_baud_rate(<span>unsigned</span> <span>short</span> com, <span>unsigned</span> <span>short</span> divisor)
    {
        outb(SERIAL_LINE_COMMAND_PORT(com),
             SERIAL_LINE_ENABLE_DLAB);
        outb(SERIAL_DATA_PORT(com),
             (divisor &gt;&gt; <span>8</span>) &amp; <span>0x00FF</span>);
        outb(SERIAL_DATA_PORT(com),
             divisor &amp; <span>0x00FF</span>);
    }</code></pre>
<p>The way that data should be sent must be configured. This is also done via the line command port by sending a byte. The layout of the 8 bits looks like the following:</p>
<pre><code>Bit:     | 7 | 6 | 5 4 3 | 2 | 1 0 |
Content: | d | b | prty  | s | dl  |</code></pre>
<p>A description for each name can be found in the table below (and in <span>[31]</span>):</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>d</td>
<td>Enables (<code>d = 1</code>) or disables (<code>d = 0</code>) DLAB</td>
</tr>
<tr>
<td>b</td>
<td>If break control is enabled (<code>b = 1</code>) or disabled (<code>b = 0</code>)</td>
</tr>
<tr>
<td>prty</td>
<td>The number of parity bits to use</td>
</tr>
<tr>
<td>s</td>
<td>The number of stop bits to use (<code>s = 0</code> equals 1, <code>s = 1</code> equals 1.5 or 2)</td>
</tr>
<tr>
<td>dl</td>
<td>Describes the length of the data</td>
</tr>
</tbody>
</table>
<p>We will use the mostly standard value <code>0x03</code> <span>[31]</span>, meaning a length of 8 bits, no parity bit, one stop bit and break control disabled. This is sent to the line command port, as seen in the following example:</p>
<pre><code>    <span>/** serial_configure_line:</span>
<span>     *  Configures the line of the given serial port. The port is set to have a</span>
<span>     *  data length of 8 bits, no parity bits, one stop bit and break control</span>
<span>     *  disabled.</span>
<span>     *</span>
<span>     *  </span><span>@param</span><span> </span><span>com</span><span>  The serial port to configure</span>
<span>     */</span>
    <span>void</span> serial_configure_line(<span>unsigned</span> <span>short</span> com)
    {
        <span>/* Bit:     | 7 | 6 | 5 4 3 | 2 | 1 0 |</span>
<span>         * Content: | d | b | prty  | s | dl  |</span>
<span>         * Value:   | 0 | 0 | 0 0 0 | 0 | 1 1 | = 0x03</span>
<span>         */</span>
        outb(SERIAL_LINE_COMMAND_PORT(com), <span>0x03</span>);
    }</code></pre>
<p>The article on OSDev <span>[31]</span> has a more in-depth explanation of the values.</p>
<h3 id="configuring-the-buffers"> Configuring the Buffers</h3>
<p>When data is transmitted via the serial port it is placed in buffers, both when receiving and sending data. This way, if you send data to the serial port faster than it can send it over the wire, it will be buffered. However, if you send too much data too fast the buffer will be full and data will be lost. In other words, the buffers are FIFO queues. The FIFO queue configuration byte looks like the following figure:</p>
<pre><code>Bit:     | 7 6 | 5  | 4 | 3   | 2   | 1   | 0 |
Content: | lvl | bs | r | dma | clt | clr | e |</code></pre>
<p>A description for each name can be found in the table below:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>lvl</td>
<td>How many bytes should be stored in the FIFO buffers</td>
</tr>
<tr>
<td>bs</td>
<td>If the buffers should be 16 or 64 bytes large</td>
</tr>
<tr>
<td>r</td>
<td>Reserved for future use</td>
</tr>
<tr>
<td>dma</td>
<td>How the serial port data should be accessed</td>
</tr>
<tr>
<td>clt</td>
<td>Clear the transmission FIFO buffer</td>
</tr>
<tr>
<td>clr</td>
<td>Clear the receiver FIFO buffer</td>
</tr>
<tr>
<td>e</td>
<td>If the FIFO buffer should be enabled or not</td>
</tr>
</tbody>
</table>
<p>We use the value <code>0xC7 = 11000111</code> that:</p>
<ul>
<li>Enables FIFO</li>
<li>Clear both receiver and transmission FIFO queues</li>
<li>Use 14 bytes as size of queue</li>
</ul>
<p>The WikiBook on serial programming <span>[32]</span> explains the values in more depth.</p>
<h3 id="configuring-the-modem"> Configuring the Modem</h3>
<p>The modem control register is used for very simple hardware flow control via the Ready To Transmit (RTS) and Data Terminal Ready (DTR) pins. When configuring the serial port we want RTS and DTR to be 1, which means that we are ready to send data.</p>
<p>The modem configuration byte is shown in the following figure:</p>
<pre><code>Bit:     | 7 | 6 | 5  | 4  | 3   | 2   | 1   | 0   |
Content: | r | r | af | lb | ao2 | ao1 | rts | dtr |</code></pre>
<p>A description for each name can be found in the table below:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>r</td>
<td>Reserved</td>
</tr>
<tr>
<td>af</td>
<td>Autoflow control enabled</td>
</tr>
<tr>
<td>lb</td>
<td>Loopback mode (used for debugging serial ports)</td>
</tr>
<tr>
<td>ao2</td>
<td>Auxiliary output 2, used for receiving interrupts</td>
</tr>
<tr>
<td>ao1</td>
<td>Auxiliary output 1</td>
</tr>
<tr>
<td>rts</td>
<td>Ready To Transmit</td>
</tr>
<tr>
<td>dtr</td>
<td>Data Terminal Ready</td>
</tr>
</tbody>
</table>
<p>We don’t need to enable interrupts, because we won’t handle any received data. Therefore we use the configuration value <code>0x03 = 00000011</code> (RTS = 1 and DTS = 1).</p>
<h3 id="writing-data-to-the-serial-port"> Writing Data to the Serial Port</h3>
<p>Writing data to the serial port is done via the data I/O port. However, before writing, the transmit FIFO queue has to be empty (all previous writes must have finished). The transmit FIFO queue is empty if bit 5 of the line status I/O port is equal to one.</p>
<p>Reading the contents of an I/O port is done via the <code>in</code> assembly code instruction. There is no way to use the <code>in</code> assembly code instruction from C, therefore it has to be wrapped (the same way as the <code>out</code> assembly code instruction):</p>
<pre><code>    <span>global</span> inb

    <span>; inb - returns a byte from the given I/O port</span>
    <span>; stack: [esp + 4] The address of the I/O port</span>
    <span>;        [esp    ] The return address</span>
<span>    inb:</span>
        <span>mov</span> <span>dx</span>, [<span>esp</span> + <span>4</span>]       <span>; move the address of the I/O port to the dx register</span>
        <span>in</span>  <span>al</span>, <span>dx</span>              <span>; read a byte from the I/O port and store it in the al register</span>
        <span>ret</span>                     <span>; return the read byte</span></code></pre>
<pre><code>    <span>/* in file io.h */</span>

    <span>/** inb:</span>
<span>     *  Read a byte from an I/O port.</span>
<span>     *</span>
<span>     *  </span><span>@param</span><span>  </span><span>port</span><span> The address of the I/O port</span>
<span>     *  </span><span>@return</span><span>      The read byte</span>
<span>     */</span>
    <span>unsigned</span> <span>char</span> inb(<span>unsigned</span> <span>short</span> port);</code></pre>
<p>Checking if the transmit FIFO is empty can then be done from C:</p>
<pre><code>    <span>#include "io.h"</span>

    <span>/** serial_is_transmit_fifo_empty:</span>
<span>     *  Checks whether the transmit FIFO queue is empty or not for the given COM</span>
<span>     *  port.</span>
<span>     *</span>
<span>     *  </span><span>@param</span><span>  </span><span>com</span><span> The COM port</span>
<span>     *  </span><span>@return</span><span> 0 if the transmit FIFO queue is not empty</span>
<span>     *          1 if the transmit FIFO queue is empty</span>
<span>     */</span>
    <span>int</span> serial_is_transmit_fifo_empty(<span>unsigned</span> <span>int</span> com)
    {
        <span>/* 0x20 = 0010 0000 */</span>
        <span>return</span> inb(SERIAL_LINE_STATUS_PORT(com)) &amp; <span>0x20</span>;
    }</code></pre>
<p>Writing to a serial port means spinning as long as the transmit FIFO queue isn’t empty, and then writing the data to the data I/O port.</p>
<h3 id="configuring-bochs"> Configuring Bochs</h3>
<p>To save the output from the first serial serial port the Bochs configuration file <code>bochsrc.txt</code> must be updated. The <code>com1</code> configuration instructs Bochs how to handle first serial port:</p>
<pre><code>    com1: enabled=1, mode=file, dev=com1.out</code></pre>
<p>The output from serial port one will now be stored in the file <code>com1.out</code>.</p>
<h3 id="the-driver-1"> The Driver</h3>
<p>We recommend that you implement a <code>write</code> function for the serial port similar to the <code>write</code> function in the driver for the framebuffer. To avoid name clashes with the <code>write</code> function for the framebuffer it is a good idea to name the functions <code>fb_write</code> and <code>serial_write</code> to distinguish them.</p>
<p>We further recommend that you try to write a <code>printf</code>-like function, see section 7.3 in <span>[8]</span>. The <code>printf</code> function could take an additional argument to decide to which device to write the output (framebuffer or serial).</p>
<p>A final recommendation is that you create some way of distinguishing the severeness of the log messages, for example by prepending the messages with <code>DEBUG</code>, <code>INFO</code> or <code>ERROR</code>.</p>
<h2 id="further-reading-2"> Further Reading</h2>
<ul>
<li>The book “Serial programming” (available on WikiBooks) has a great section on programming the serial port, <a href="http://en.wikibooks.org/wiki/Serial_Programming/8250_UART_Programming#UART_Registers">http://en.wikibooks.org/wiki/Serial_Programming/8250_UART_Programming#UART_Registers</a></li>
<li>The OSDev wiki has a page with a lot of information about the serial ports, <a href="http://wiki.osdev.org/Serial_ports">http://wiki.osdev.org/Serial_ports</a></li>
</ul>
<h2 id="segmentation"> Segmentation</h2>
<p><em>Segmentation</em> in x86 means accessing the memory through segments. Segments are portions of the address space, possibly overlapping, specified by a base address and a limit. To address a byte in segmented memory you use a 48-bit <em>logical address</em>: 16 bits that specifies the segment and 32-bits that specifies what offset within that segment you want. The offset is added to the base address of the segment, and the resulting linear address is checked against the segment’s limit - see the figure below. If everything works out fine (including access-rights checks ignored for now) the result is a <em>linear address</em>. When paging is disabled, then the linear address space is mapped 1:1 onto the <em>physical address</em> space, and the physical memory can be accessed. (See the chapter <a href="#paging">“Paging”</a> for how to enable paging.)</p>
<div>
<p><img src="https://littleosbook.github.io/images/intel_3_5_logical_to_linear.png" alt="Translation of logical addresses to linear addresses."></p><p>Translation of logical addresses to linear addresses.</p>
</div>
<p>To enable segmentation you need to set up a table that describes each segment - a <em>segment descriptor table</em>. In x86, there are two types of descriptor tables: the <em>Global Descriptor Table</em> (GDT) and <em>Local Descriptor Tables</em> (LDT). An LDT is set up and managed by user-space processes, and all processes have their own LDT. LDTs can be used if a more complex segmentation model is desired - we won’t use it. The GDT is shared by everyone - it’s global.</p>
<p>As we discuss in the sections on virtual memory and paging, segmentation is rarely used more than in a minimal setup, similar to what we do below.</p>
<h2 id="accessing-memory"> Accessing Memory</h2>
<p>Most of the time when accessing memory there is no need to explicitly specify the segment to use. The processor has six 16-bit segment registers: <code>cs</code>, <code>ss</code>, <code>ds</code>, <code>es</code>, <code>gs</code> and <code>fs</code>. The register <code>cs</code> is the code segment register and specifies the segment to use when fetching instructions. The register <code>ss</code> is used whenever accessing the stack (through the stack pointer <code>esp</code>), and <code>ds</code> is used for other data accesses. The OS is free to use the registers <code>es</code>, <code>gs</code> and <code>fs</code> however it want.</p>
<p>Below is an example showing implicit use of the segment registers:</p>
<pre><code><span>    func:</span>
        <span>mov</span> <span>eax</span>, [<span>esp</span><span>+4</span>]
        <span>mov</span> <span>ebx</span>, [<span>eax</span>]
        <span>add</span> <span>ebx</span>, <span>8</span>
        <span>mov</span> [<span>eax</span>], <span>ebx</span>
        <span>ret</span></code></pre>
<p>The above example can be compared with the following one that makes explicit use of the segment registers:</p>
<pre><code><span>    func:</span>
        <span>mov</span> <span>eax</span>, [<span>ss</span>:<span>esp</span><span>+4</span>]
        <span>mov</span> <span>ebx</span>, [<span>ds</span>:<span>eax</span>]
        <span>add</span> <span>ebx</span>, <span>8</span>
        <span>mov</span> [<span>ds</span>:<span>eax</span>], <span>ebx</span>
        <span>ret</span></code></pre>
<p>You don’t need to use <code>ss</code> for storing the stack segment selector, or <code>ds</code> for the data segment selector. You could store the stack segment selector in <code>ds</code> and vice versa. However, in order to use the implicit style shown above, you must store the segment selectors in their indented registers.</p>
<p>Segment descriptors and their fields are described in figure 3-8 in the Intel manual <span>[33]</span>.</p>
<h2 id="the-global-descriptor-table-gdt"> The Global Descriptor Table (GDT)</h2>
<p>A GDT/LDT is an array of 8-byte segment descriptors. The first descriptor in the GDT is always a null descriptor and can never be used to access memory. At least two segment descriptors (plus the null descriptor) are needed for the GDT, because the descriptor contains more information than just the base and limit fields. The two most relevant fields for us are the <em>Type</em> field and the <em>Descriptor Privilege Level</em> (DPL) field.</p>
<p>Table 3-1 in chapter 3 of the Intel manual <span>[33]</span> specifies the values for the Type field. The table shows that the Type field can’t be both writable <em>and</em> executable at the same time. Therefore, two segments are needed: one segment for executing code to put in <code>cs</code> (Type is Execute-only or Execute-Read) and one segment for reading and writing data (Type is Read/Write) to put in the other segment registers.</p>
<p>The DPL specifies the <em>privilege levels</em> required to use the segment. x86 allows for four privilege levels (PL), 0 to 3, where PL0 is the most privileged. In most operating systems (eg. Linux and Windows), only PL0 and PL3 are used. However, some operating system, such as MINIX, make use of all levels. The kernel should be able to do anything, therefore it uses segments with DPL set to 0 (also called kernel mode). The current privilege level (CPL) is determined by the segment selector in <code>cs</code>.</p>
<p>The segments needed are described in the table below.</p>
<table>
<caption>The segment descriptors needed.</caption>
<thead>
<tr>
<th>Index</th>
<th>Offset</th>
<th>Name</th>
<th>Address range</th>
<th>Type</th>
<th>DPL</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td><code>0x00</code></td>
<td>null descriptor</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>1</td>
<td><code>0x08</code></td>
<td>kernel code segment</td>
<td><code>0x00000000 - 0xFFFFFFFF</code></td>
<td>RX</td>
<td>PL0</td>
</tr>
<tr>
<td>2</td>
<td><code>0x10</code></td>
<td>kernel data segment</td>
<td><code>0x00000000 - 0xFFFFFFFF</code></td>
<td>RW</td>
<td>PL0</td>
</tr>
</tbody>
</table>
<p>Note that the segments overlap - they both encompass the entire linear address space. In our minimal setup we’ll only use segmentation to get privilege levels. See the Intel manual <span>[33]</span>, chapter 3, for details on the other descriptor fields.</p>
<h2 id="loading-the-gdt"> Loading the GDT</h2>
<p>Loading the GDT into the processor is done with the <code>lgdt</code> assembly code instruction, which takes the address of a struct that specifies the start and size of the GDT. It is easiest to encode this information using a <a href="#packing-structs">“packed struct”</a> as shown in the following example:</p>
<pre><code>    <span>struct</span> gdt {
        <span>unsigned</span> <span>int</span> address;
        <span>unsigned</span> <span>short</span> size;
    } __attribute__((packed));</code></pre>
<p>If the content of the <code>eax</code> register is the address to such a struct, then the GDT can be loaded with the assembly code shown below:</p>
<pre><code>    <span>lgdt</span> [<span>eax</span>]</code></pre>
<p>It might be easier if you make this instruction available from C, the same way as was done with the assembly code instructions <code>in</code> and <code>out</code>.</p>
<p>After the GDT has been loaded the segment registers needs to be loaded with their corresponding segment selectors. The content of a segment selector is described in the figure and table below:</p>
<pre><code>Bit:     | 15                                3 | 2  | 1 0 |
Content: | offset (index)                      | ti | rpl |</code></pre>
<table>
<caption>The layout of segment selectors.</caption>
<colgroup><col width="23%">
<col width="76%">
</colgroup><thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>rpl</td>
<td>Requested Privilege Level - we want to execute in PL0 for now.</td>
</tr>
<tr>
<td>ti</td>
<td>Table Indicator. 0 means that this specifies a GDT segment, 1 means an LDT Segment.</td>
</tr>
<tr>
<td>offset (index)</td>
<td>Offset within descriptor table.</td>
</tr>
</tbody>
</table>
<p>The offset of the segment selector is added to the start of the GDT to get the address of the segment descriptor: <code>0x08</code> for the first descriptor and <code>0x10</code> for the second, since each descriptor is 8 bytes. The Requested Privilege Level (RPL) should be <code>0</code> since the kernel of the OS should execute in privilege level 0.</p>
<p>Loading the segment selector registers is easy for the data registers - just copy the correct offsets to the registers:</p>
<pre><code>    <span>mov</span> <span>ds</span><span>, 0x10</span>
    <span>mov</span> <span>ss</span><span>, 0x10</span>
    <span>mov</span> <span>es</span><span>, 0x10</span>
    .
    .
    .</code></pre>
<p>To load <code>cs</code> we have to do a “far jump”:</p>
<pre><code>    <span>; code here uses the previous cs</span>
    <span>jmp</span> <span>0x08</span>:flush_cs   <span>; specify cs when jumping to flush_cs</span>

<span>    flush_cs:</span>
        <span>; now we've changed cs to 0x08</span></code></pre>
<p>A far jump is a jump where we explicitly specify the full 48-bit logical address: the segment selector to use and the absolute address to jump to. It will first set <code>cs</code> to <code>0x08</code> and then jump to <code>flush_cs</code> using its absolute address.</p>
<h2 id="further-reading-3"> Further Reading</h2>
<ul>
<li>Chapter 3 of the Intel manual <span>[33]</span> is filled with low-level and technical details about segmentation.</li>
<li>The OSDev wiki has a page about segmentation: <a href="http://wiki.osdev.org/Segmentation">http://wiki.osdev.org/Segmentation</a></li>
<li>The Wikipedia page on x86 segmentation might be worth looking into: <a href="http://en.wikipedia.org/wiki/X86_memory_segmentation">http://en.wikipedia.org/wiki/X86_memory_segmentation</a></li>
</ul>
<h2 id="interrupts-and-input"> Interrupts and Input</h2>
<p>Now that the OS can produce <em>output</em> it would be nice if it also could get some <em>input</em>. (The operating system must be able to handle <em>interrupts</em> in order to read information from the keyboard). An interrupt occurs when a hardware device, such as the keyboard, the serial port or the timer, signals the CPU that the state of the device has changed. The CPU itself can also send interrupts due to program errors, for example when a program references memory it doesn’t have access to, or when a program divides a number by zero. Finally, there are also <em>software intterupts</em>, which are interrupts that are caused by the <code>int</code> assembly code instruction, and they are often used for system calls.</p>
<h2 id="interrupts-handlers"> Interrupts Handlers</h2>
<p>Interrupts are handled via the <em>Interrupt Descriptor Table</em> (IDT). The IDT describes a handler for each interrupt. The interrupts are numbered (0 - 255) and the handler for interrupt <em>i</em> is defined at the <em>ith</em> position in the table. There are three different kinds of handlers for interrupts:</p>
<ul>
<li>Task handler</li>
<li>Interrupt handler</li>
<li>Trap handler</li>
</ul>
<p>The task handlers use functionality specific to the Intel version of x86, so they won’t be covered here (see the Intel manual <span>[33]</span>, chapter 6, for more info). The only difference between an interrupt handler and a trap handler is that the interrupt handler disables interrupts, which means you cannot get an interrupt while at the same time handling an interrupt. In this book, we will use trap handlers and disable interrupts manually when we need to.</p>
<h2 id="creating-an-entry-in-the-idt"> Creating an Entry in the IDT</h2>
<p>An entry in the IDT for an interrupt handler consists of 64 bits. The highest 32 bits are shown in the figure below:</p>
<pre><code>Bit:     | 31              16 | 15 | 14 13 | 12 | 11 | 10 9 8 | 7 6 5 | 4 3 2 1 0 |
Content: | offset high        | P  | DPL   | 0  | D  | 1  1 0 | 0 0 0 | reserved  |</code></pre>
<p>The lowest 32 bits are presented in the following figure:</p>
<pre><code>Bit:     | 31              16 | 15              0 |
Content: | segment selector   | offset low        |</code></pre>
<p>A description for each name can be found in the table below:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>offset high</td>
<td>The 16 highest bits of the 32 bit address in the segment.</td>
</tr>
<tr>
<td>offset low</td>
<td>The 16 lowest bits of the 32 bits address in the segment.</td>
</tr>
<tr>
<td>p</td>
<td>If the handler is present in memory or not (1 = present, 0 = not present).</td>
</tr>
<tr>
<td>DPL</td>
<td>Descriptor Privilige Level, the privilege level the handler can be called from (0, 1, 2, 3).</td>
</tr>
<tr>
<td>D</td>
<td>Size of gate, (1 = 32 bits, 0 = 16 bits).</td>
</tr>
<tr>
<td>segment selector</td>
<td>The offset in the GDT.</td>
</tr>
<tr>
<td>r</td>
<td>Reserved.</td>
</tr>
</tbody>
</table>
<p>The offset is a pointer to code (preferably an assembly code label). For example, to create an entry for a handler whose code starts at <code>0xDEADBEEF</code> and that runs in privilege level 0 (therefore using the same code segment selector as the kernel) the following two bytes would be used:</p>
<pre><code>    0xDEAD8E00
    0x0008BEEF</code></pre>
<p>If the IDT is represented as an <code>unsigned integer idt[512]</code> then to register the above example as an handler for interrupt 0 (divide-by-zero), the following code would be used:</p>
<pre><code>    idt[<span>0</span>] = <span>0xDEAD8E00</span>
    idt[<span>1</span>] = <span>0x0008BEEF</span></code></pre>
<p>As written in the chapter <a href="#getting-to-c">“Getting to C”</a>, we recommend that you instead of using bytes (or unsigned integers) use packed structures to make the code more readable.</p>
<h2 id="handling-an-interrupt"> Handling an Interrupt</h2>
<p>When an interrupt occurs the CPU will push some information about the interrupt onto the stack, then look up the appropriate interrupt hander in the IDT and jump to it. The stack at the time of the interrupt will look like the following:</p>
<pre><code>    [esp + 12] eflags
    [esp + 8]  cs
    [esp + 4]  eip
    [esp]      error code?</code></pre>
<p>The reason for the question mark behind error code is that not all interrupts create an <em>error code</em>. The specific CPU interrupts that put an error code on the stack are 8, 10, 11, 12, 13, 14 and 17. The error code can be used by the interrupt handler to get more information on what has happened. Also, note that the interrupt <em>number</em> is <em>not</em> pushed onto the stack. We can only determine what interrupt has occurred by knowing what code is executing - if the handler registered for interrupt 17 is executing, then interrupt 17 has occurred.</p>
<p>Once the interrupt handler is done, it uses the <code>iret</code> instruction to return. The instruction <code>iret</code> expects the stack to be the same as at the time of the interrupt (see the figure above). Therefore, any values pushed onto the stack by the interrupt handler must be popped. Before returning, <code>iret</code> restores <code>eflags</code> by popping the value from the stack and then finally jumps to <code>cs:eip</code> as specified by the values on the stack.</p>
<p>The interrupt handler has to be written in assembly code, since all registers that the interrupt handlers use must be preserved by pushing them onto the stack. This is because the code that was interrupted doesn’t know about the interrupt and will therefore expect that its registers stay the same. Writing all the logic of the interrupt handler in assembly code will be tiresome. Creating a handler in assembly code that saves the registers, calls a C function, restores the registers and finally executes <code>iret</code> is a good idea!</p>
<p>The C handler should get the state of the registers, the state of the stack and the number of the interrupt as arguments. The following definitions can for example be used:</p>
<pre><code>    <span>struct</span> cpu_state {
        <span>unsigned</span> <span>int</span> eax;
        <span>unsigned</span> <span>int</span> ebx;
        <span>unsigned</span> <span>int</span> ecx;
        .
        .
        .
        <span>unsigned</span> <span>int</span> esp;
    } __attribute__((packed));

    <span>struct</span> stack_state {
        <span>unsigned</span> <span>int</span> error_code;
        <span>unsigned</span> <span>int</span> eip;
        <span>unsigned</span> <span>int</span> cs;
        <span>unsigned</span> <span>int</span> eflags;
    } __attribute__((packed));

    <span>void</span> interrupt_handler(<span>struct</span> cpu_state cpu, <span>struct</span> stack_state stack, <span>unsigned</span> <span>int</span> interrupt);</code></pre>
<h2 id="creating-a-generic-interrupt-handler"> Creating a Generic Interrupt Handler</h2>
<p>Since the CPU does not push the interrupt number on the stack it is a little tricky to write a generic interrupt handler. This section will use macros to show how it can be done. Writing one version for each interrupt is tedious - it is better to use the macro functionality of NASM <span>[34]</span>. And since not all interrupts produce an error code the value 0 will be added as the “error code” for interrupts without an error code. The following code shows an example of how this can be done:</p>
<pre><code>    <span>%macro no_error_code_interrupt_handler %1</span>
    <span>global</span> interrupt_handler_<span>%1</span>
    interrupt_handler_<span>%1:</span>
        <span>push</span>    <span>dword</span> <span>0</span>                     <span>; push 0 as error code</span>
        <span>push</span>    <span>dword</span> <span>%1                    ; push the interrupt number</span>
        <span>jmp</span>     common_interrupt_handler    <span>; jump to the common handler</span>
    <span>%endmacro</span>

    <span>%macro error_code_interrupt_handler %1</span>
    <span>global</span> interrupt_handler_<span>%1</span>
    interrupt_handler_<span>%1:</span>
        <span>push</span>    <span>dword</span> <span>%1                    ; push the interrupt number</span>
        <span>jmp</span>     common_interrupt_handler    <span>; jump to the common handler</span>
    <span>%endmacro</span>

<span>    common_interrupt_handler:</span>               <span>; the common parts of the generic interrupt handler</span>
        <span>; save the registers</span>
        <span>push</span>    <span>eax</span>
        <span>push</span>    <span>ebx</span>
        .
        .
        .
        <span>push</span>    <span>ebp</span>

        <span>; call the C function</span>
        <span>call</span>    interrupt_handler

        <span>; restore the registers</span>
        <span>pop</span>     <span>ebp</span>
        .
        .
        .
        <span>pop</span>     <span>ebx</span>
        <span>pop</span>     <span>eax</span>

        <span>; restore the esp</span>
        <span>add</span>     <span>esp</span>, <span>8</span>

        <span>; return to the code that got interrupted</span>
        <span>iret</span>

    no_error_code_interrupt_handler <span>0</span>       <span>; create handler for interrupt 0</span>
    no_error_code_interrupt_handler <span>1</span>       <span>; create handler for interrupt 1</span>
    .
    .
    .
    error_code_handler              <span>7</span>       <span>; create handler for interrupt 7</span>
    .
    .
    .</code></pre>
<p>The <code>common_interrupt_handler</code> does the following:</p>
<ul>
<li>Push the registers on the stack.</li>
<li>Call the C function <code>interrupt_handler</code>.</li>
<li>Pop the registers from the stack.</li>
<li>Add 8 to <code>esp</code> (because of the error code and the interrupt number pushed earlier).</li>
<li>Execute <code>iret</code> to return to the interrupted code.</li>
</ul>
<p>Since the macros declare global labels the addresses of the interrupt handlers can be accessed from C or assembly code when creating the IDT.</p>
<h2 id="loading-the-idt"> Loading the IDT</h2>
<p>The IDT is loaded with the <code>lidt</code> assembly code instruction which takes the address of the first element in the table. It is easiest to wrap this instruction and use it from C:</p>
<pre><code>    <span>global</span>  load_idt

    <span>; load_idt - Loads the interrupt descriptor table (IDT).</span>
    <span>; stack: [esp + 4] the address of the first entry in the IDT</span>
    <span>;        [esp    ] the return address</span>
<span>    load_idt:</span>
        <span>mov</span>     <span>eax</span>, [<span>esp</span><span>+4</span>]    <span>; load the address of the IDT into register eax</span>
        <span>lidt</span>    <span>eax</span>             <span>; load the IDT</span>
        <span>ret</span>                     <span>; return to the calling function</span></code></pre>
<h2 id="programmable-interrupt-controller-pic"> Programmable Interrupt Controller (PIC)</h2>
<p>To start using hardware interrupts you must first configure the Programmable Interrupt Controller (PIC). The PIC makes it possible to map signals from the hardware to interrupts. The reasons for configuring the PIC are:</p>
<ul>
<li>Remap the interrupts. The PIC uses interrupts 0 - 15 for hardware interrupts by default, which conflicts with the CPU interrupts. Therefore the PIC interrupts must be remapped to another interval.</li>
<li>Select which interrupts to receive. You probably don’t want to receive interrupts from all devices since you don’t have code that handles these interrupts anyway.</li>
<li>Set up the correct mode for the PIC.</li>
</ul>
<p>In the beginning there was only one PIC (PIC 1) and eight interrupts. As more hardware were added, 8 interrupts were too few. The solution chosen was to chain on another PIC (PIC 2) on the first PIC (see interrupt 2 on PIC 1).</p>
<p>The hardware interrupts are shown in the table below:</p>
<table>
<thead>
<tr>
<th>PIC 1</th>
<th>Hardware</th>
<th>PIC 2</th>
<th>Hardware</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>Timer</td>
<td>8</td>
<td>Real Time Clock</td>
</tr>
<tr>
<td>1</td>
<td>Keyboard</td>
<td>9</td>
<td>General I/O</td>
</tr>
<tr>
<td>2</td>
<td>PIC 2</td>
<td>10</td>
<td>General I/O</td>
</tr>
<tr>
<td>3</td>
<td>COM 2</td>
<td>11</td>
<td>General I/O</td>
</tr>
<tr>
<td>4</td>
<td>COM 1</td>
<td>12</td>
<td>General I/O</td>
</tr>
<tr>
<td>5</td>
<td>LPT 2</td>
<td>13</td>
<td>Coprocessor</td>
</tr>
<tr>
<td>6</td>
<td>Floppy disk</td>
<td>14</td>
<td>IDE Bus</td>
</tr>
<tr>
<td>7</td>
<td>LPT 1</td>
<td>15</td>
<td>IDE Bus</td>
</tr>
</tbody>
</table>
<p>A great tutorial for configuring the PIC can be found at the SigOPS website <span>[35]</span>. We won’t repeat that information here.</p>
<p>Every interrupt from the PIC has to be acknowledged - that is, sending a message to the PIC confirming that the interrupt has been handled. If this isn’t done the PIC won’t generate any more interrupts.</p>
<p>Acknowledging a PIC interrupt is done by sending the byte <code>0x20</code> to the PIC that raised the interrupt. Implementing a <code>pic_acknowledge</code> function can thus be done as follows:</p>
<pre><code>    <span>#include "io.h"</span>

    <span>#define PIC1_PORT_A 0x20</span>
    <span>#define PIC2_PORT_A 0xA0</span>

    <span>/* The PIC interrupts have been remapped */</span>
    <span>#define PIC1_START_INTERRUPT 0x20</span>
    <span>#define PIC2_START_INTERRUPT 0x28</span>
    <span>#define PIC2_END_INTERRUPT   PIC2_START_INTERRUPT + 7</span>

    <span>#define PIC_ACK     0x20</span>

    <span>/** pic_acknowledge:</span>
<span>     *  Acknowledges an interrupt from either PIC 1 or PIC 2.</span>
<span>     *</span>
<span>     *  </span><span>@param</span><span> </span><span>num</span><span> The number of the interrupt</span>
<span>     */</span>
    <span>void</span> pic_acknowledge(<span>unsigned</span> integer interrupt)
    {
        <span>if</span> (interrupt &lt; PIC1_START_INTERRUPT || interrupt &gt; PIC2_END_INTERRUPT) {
          <span>return</span>;
        }

        <span>if</span> (interrupt &lt; PIC2_START_INTERRUPT) {
          outb(PIC1_PORT_A, PIC_ACK);
        } <span>else</span> {
          outb(PIC2_PORT_A, PIC_ACK);
        }
    }</code></pre>
<h2 id="reading-input-from-the-keyboard"> Reading Input from the Keyboard</h2>
<p>The keyboard does not generate ASCII characters, it generates scan codes. A scan code represents a button - both presses and releases. The scan code representing the just pressed button can be read from the keyboard’s data I/O port which has address <code>0x60</code>. How this can be done is shown in the following example:</p>
<pre><code>    <span>#include "io.h"</span>

    <span>#define KBD_DATA_PORT   0x60</span>

    <span>/** read_scan_code:</span>
<span>     *  Reads a scan code from the keyboard</span>
<span>     *</span>
<span>     *  </span><span>@return</span><span> The scan code (NOT an ASCII character!)</span>
<span>     */</span>
    <span>unsigned</span> <span>char</span> read_scan_code(<span>void</span>)
    {
        <span>return</span> inb(KBD_DATA_PORT);
    }</code></pre>
<p>The next step is to write a function that translates a scan code to the corresponding ASCII character. If you want to map the scan codes to ASCII characters as is done on an American keyboard then Andries Brouwer has a great tutorial <span>[36]</span>.</p>
<p>Remember, since the keyboard interrupt is raised by the PIC, you must call <code>pic_acknowledge</code> at the end of the keyboard interrupt handler. Also, the keyboard will not send you any more interrupts until you read the scan code from the keyboard.</p>
<h2 id="further-reading-4"> Further Reading</h2>
<ul>
<li>The OSDev wiki has a great page on interrupts, <a href="http://wiki.osdev.org/Interrupts">http://wiki.osdev.org/Interrupts</a></li>
<li>Chapter 6 of Intel Manual 3a <span>[33]</span> describes everything there is to know about interrupts.</li>
</ul>
<h2 id="the-road-to-user-mode"> The Road to User Mode</h2>
<p>Now that the kernel boots, prints to screen and reads from keyboard - what do we do? Usually, a kernel is not supposed to do the application logic itself, but leave that for applications. The kernel creates the proper abstractions (for memory, files, devices) to make application development easier, performs tasks on behalf of applications (system calls) and <a href="#scheduling">schedules processes</a>.</p>
<p>User mode, in contrast with kernel mode, is the environment in which the user’s programs execute. This environment is less privileged than the kernel, and will prevent (badly written) user programs from messing with other programs or the kernel. Badly written kernels are free to mess up what they want.</p>
<p>There’s quite a way to go until the OS created in this book can execute programs in user mode, but this chapter will show how to easily execute a small program in kernel mode.</p>
<h2 id="loading-an-external-program"> Loading an External Program</h2>
<p>Where do we get the external program from? Somehow we need to load the code we want to execute into memory. More feature-complete operating systems usually have drivers and file systems that enable them to load the software from a CD-ROM drive, a hard disk or other persistent media.</p>
<p>Instead of creating all these drivers and file systems we will use a feature in GRUB called modules to load the program.</p>
<h3 id="grub-modules"> GRUB Modules</h3>
<p>GRUB can load arbitrary files into memory from the ISO image, and these files are usually referred to as <em>modules</em>. To make GRUB load a module, edit the file <code>iso/boot/grub/menu.lst</code> and add the following line at the end of the file:</p>
<pre><code>    module /modules/program</code></pre>
<p>Now create the folder <code>iso/modules</code>:</p>
<pre><code>    mkdir -p iso/modules</code></pre>
<p>The application <code>program</code> will be created later in this chapter.</p>
<p>The code that calls <code>kmain</code> must be updated to pass information to <code>kmain</code> about where it can find the modules. We also want to tell GRUB that it should align all the modules on page boundaries when loading them (see the chapter <a href="#paging">“Paging”</a> for details about page alignment).</p>
<p>To instruct GRUB how to load our modules, the “multiboot header” - the first bytes of the kernel - must be updated as follows:</p>
<pre><code>    <span>; in file `loader.s`</span>


    MAGIC_NUMBER    <span>equ</span> <span>0x1BADB002</span>      <span>; define the magic number constant</span>
    ALIGN_MODULES   <span>equ</span><span> 0x00000001      </span><span>; tell GRUB to align modules</span>

    <span>; calculate the checksum (all options + checksum should equal 0)</span>
    CHECKSUM        <span>equ</span> -(MAGIC_NUMBER + ALIGN_MODULES)

    <span>section</span> .text:                      <span>; start of the text (code) section</span>
    <span>align</span> <span>4</span>                             <span>; the code must be 4 byte aligned</span>
        <span>dd</span> MAGIC_NUMBER                 <span>; write the magic number</span>
        <span>dd</span> ALIGN_MODULES                <span>; write the align modules instruction</span>
        <span>dd</span> CHECKSUM                     <span>; write the checksum</span></code></pre>
<p>GRUB will also store a pointer to a <code>struct</code> in the register <code>ebx</code> that, among other things, describes at which addresses the modules are loaded. Therefore, you probably want to push <code>ebx</code> on the stack before calling <code>kmain</code> to make it an argument for <code>kmain</code>.</p>
<h2 id="executing-a-program"> Executing a Program</h2>
<h3 id="a-very-simple-program"> A Very Simple Program</h3>
<p>A program written at this stage can only perform a few actions. Therefore, a very short program that writes a value to a register suffices as a test program. Halting Bochs after a while and then check that register contains the correct number by looking in the Bochs log will verify that the program has run. This is an example of such a short program:</p>
<pre><code>    <span>; set eax to some distinguishable number, to read from the log afterwards</span>
    <span>mov</span> <span>eax</span>, <span>0xDEADBEEF</span>

    <span>; enter infinite loop, nothing more to do</span>
    <span>; $ means "beginning of line", ie. the same instruction</span>
    <span>jmp</span> <span>$</span></code></pre>
<h3 id="compiling"> Compiling</h3>
<p>Since our kernel cannot parse advanced executable formats we need to compile the code into a flat binary. NASM can do this with the flag <code>-f</code>:</p>
<pre><code>    nasm -f bin program.s -o program</code></pre>
<p>This is all we need. You must now move the file <code>program</code> to the folder <code>iso/modules</code>.</p>
<h3 id="finding-the-program-in-memory"> Finding the Program in Memory</h3>
<p>Before jumping to the program we must find where it resides in memory. Assuming that the contents of <code>ebx</code> is passed as an argument to <code>kmain</code>, we can do this entirely from C.</p>
<p>The pointer in <code>ebx</code> points to a <em>multiboot</em> structure <span>[19]</span>. Download the <code>multiboot.h</code> file from <a href="http://www.gnu.org/software/grub/manual/multiboot/html_node/multiboot.h.html">http://www.gnu.org/software/grub/manual/multiboot/html_node/multiboot.h.html</a>, which describes the structure.</p>
<p>The pointer passed to <code>kmain</code> in the <code>ebx</code> register can be cast to a <code>multiboot_info_t</code> pointer. The address of the first module is in the field <code>mods_addr</code>. The following code shows an example:</p>
<pre><code>    <span>int</span> kmain(<span>/* additional arguments */</span> <span>unsigned</span> <span>int</span> ebx)
    {
        multiboot_info_t *mbinfo = (multiboot_info_t *) ebx;
        <span>unsigned</span> <span>int</span> address_of_module = mbinfo-&gt;mods_addr;
    }</code></pre>
<p>However, before just blindly following the pointer, you should check that the module got loaded correctly by GRUB. This can be done by checking the <code>flags</code> field of the <code>multiboot_info_t</code> structure. You should also check the field <code>mods_count</code> to make sure it is exactly 1. For more details about the multiboot structure, see the multiboot documentation <span>[19]</span>.</p>
<h3 id="jumping-to-the-code"> Jumping to the Code</h3>
<p>The only thing left to do is to jump to the code loaded by GRUB. Since it is easier to parse the multiboot structure in C than assembly code, calling the code from C is more convenient (it can of course be done with <code>jmp</code> or <code>call</code> in assembly code as well). The C code could look like this:</p>
<pre><code>    <span>typedef</span> <span>void</span> (*call_module_t)(<span>void</span>);
    <span>/* ... */</span>
    call_module_t start_program = (call_module_t) address_of_module;
    start_program();
    <span>/* we'll never get here, unless the module code returns */</span></code></pre>
<p>If we start the kernel, wait until it has run and entered the infinite loop in the program, and then halt Bochs, we should see <code>0xDEADBEEF</code> in the register <code>eax</code> via the Bochs log. We have successfully started a program in our OS!</p>
<h2 id="the-beginning-of-user-mode"> The Beginning of User Mode</h2>
<p>The program we’ve written now runs at the same privilege level as the kernel - we’ve just entered it in a somewhat peculiar way. To enable applications to execute at a different privilege level we’ll need to, beside <a href="#segmentation"><em>segmentation</em></a>, do <a href="#paging"><em>paging</em></a> and <a href="#page-frame-allocation"><em>page frame allocation</em></a>.</p>
<p>It’s quite a lot of work and technical details to go through, but in a few chapters you’ll have working user mode programs.</p>
<h2 id="a-short-introduction-to-virtual-memory"> A Short Introduction to Virtual Memory</h2>
<p><em>Virtual memory</em> is an abstraction of physical memory. The purpose of virtual memory is generally to simplify application development and to let processes address more memory than what is actually physically present in the machine. We also don’t want applications messing with the kernel or other applications’ memory due to security.</p>
<p>In the x86 architecture, virtual memory can be accomplished in two ways: <em>segmentation</em> and <em>paging</em>. Paging is by far the most common and versatile technique, and we’ll implement it the next chapter. Some use of segmentation is still necessary to allow for code to execute under different privilege levels.</p>
<p>Managing memory is a big part of what an operating system does. <a href="#paging">Paging</a> and <a href="#page-frame-allocation">page frame allocation</a> deals with that.</p>
<p>Segmentation and paging is described in the <span>[33]</span>, chapter 3 and 4.</p>
<h2 id="virtual-memory-through-segmentation"> Virtual Memory Through Segmentation?</h2>
<p>You could skip paging entirely and just use segmentation for virtual memory. Each user mode process would get its own segment, with base address and limit properly set up. This way no process can see the memory of another process. A problem with this is that the physical memory for a process needs to be contiguous (or at least it is very convenient if it is). Either we need to know in advance how much memory the program will require (unlikely), or we can move the memory segments to places where they can grow when the limit is reached (expensive, causes fragmentation - can result in “out of memory” even though enough memory is available). Paging solves both these problems.</p>
<p>It is interesting to note that in x86_64 (the 64-bit version of the x86 architecture), segmentation is almost completely removed.</p>
<h2 id="further-reading-5"> Further Reading</h2>
<ul>
<li>LWN.net has an article on virtual memory: <a href="http://lwn.net/Articles/253361/">http://lwn.net/Articles/253361/</a></li>
<li>Gustavo Duarte has also written an article about virtual memory: <a href="http://duartes.org/gustavo/blog/post/memory-translation-and-segmentation">http://duartes.org/gustavo/blog/post/memory-translation-and-segmentation</a></li>
</ul>
<h2 id="paging"> Paging</h2>
<p>Segmentation translates a logical address into a linear address. <em>Paging</em> translates these linear addresses onto the physical address space, and determines access rights and how the memory should be cached.</p>
<h2 id="why-paging"> Why Paging?</h2>
<p>Paging is the most common technique used in x86 to enable virtual memory. Virtual memory through paging means that each process will get the impression that the available memory range is <code>0x00000000</code> - <code>0xFFFFFFFF</code> even though the actual size of the memory might be much less. It also means that when a process addresses a byte of memory it will use a virtual (linear) address instead of physical one. The code in the user process won’t notice any difference (except for execution delays). The linear address gets translated to a physical address by the MMU and the page table. If the virtual address isn’t mapped to a physical address, the CPU will raise a page fault interrupt.</p>
<p>Paging is optional, and some operating systems do not make use of it. But if we want to mark certain areas of memory accessible only to code running at a certain privilege level (to be able to have processes running at different privilege levels), paging is the neatest way to do it.</p>
<h2 id="paging-in-x86"> Paging in x86</h2>
<p>Paging in x86 (chapter 4 in the Intel manual <span>[33]</span>) consists of a <em>page directory</em> (PDT) that can contain references to 1024 <em>page tables</em> (PT), each of which can point to 1024 sections of physical memory called <em>page frames</em> (PF). Each page frame is 4096 byte large. In a virtual (linear) address, the highest 10 bits specifies the offset of a page directory entry (PDE) in the current PDT, the next 10 bits the offset of a page table entry (PTE) within the page table pointed to by that PDE. The lowest 12 bits in the address is the offset within the page frame to be addressed.</p>
<p>All page directories, page tables and page frames need to be aligned on 4096 byte addresses. This makes it possible to address a PDT, PT or PF with just the highest 20 bits of a 32 bit address, since the lowest 12 need to be zero.</p>
<p>The PDE and PTE structure is very similar to each other: 32 bits (4 bytes), where the highest 20 bits points to a PTE or PF, and the lowest 12 bits control access rights and other configurations. 4 bytes times 1024 equals 4096 bytes, so a page directory and page table both fit in a page frame themselves.</p>
<p>The translation of linear addresses to physical addresses is described in the figure below.</p>
<p>While pages are normally 4096 bytes, it is also possible to use 4 MB pages. A PDE then points directly to a 4 MB page frame, which needs to be aligned on a 4 MB address boundary. The address translation is almost the same as in the figure, with just the page table step removed. It is possible to mix 4 MB and 4 KB pages.</p>
<div>
<p><img src="https://littleosbook.github.io/images/intel_4_2_linear_address_translation.png" alt="Translating virtual addresses (linear addresses) to physical addresses."></p><p>Translating virtual addresses (linear addresses) to physical addresses.</p>
</div>
<p>The 20 bits pointing to the current PDT is stored in the register <code>cr3</code>. The lower 12 bits of <code>cr3</code> are used for configuration.</p>
<p>For more details on the paging structures, see chapter 4 in the Intel manual <span>[33]</span>. The most interesting bits are <em>U/S</em>, which determine what privilege levels can access this page (PL0 or PL3), and <em>R/W</em>, which makes the memory in the page read-write or read-only.</p>
<h3 id="identity-paging"> Identity Paging</h3>
<p>The simplest kind of paging is when we map each virtual address onto the same physical address, called <em>identity paging</em>. This can be done at compile time by creating a page directory where each entry points to its corresponding 4 MB frame. In NASM this can be done with macros and commands (<code>%rep</code>, <code>times</code> and <code>dd</code>). It can of course also be done at run-time by using ordinary assembly code instructions.</p>
<h3 id="enabling-paging"> Enabling Paging</h3>
<p>Paging is enabled by first writing the address of a page directory to <code>cr3</code> and then setting bit 31 (the PG “paging-enable” bit) of <code>cr0</code> to <code>1</code>. To use 4 MB pages, set the PSE bit (Page Size Extensions, bit 4) of <code>cr4</code>. The following assembly code shows an example:</p>
<pre><code>    <span>; eax has the address of the page directory</span>
    <span>mov</span> <span>cr3</span>, <span>eax</span>

    <span>mov</span> <span>ebx</span>, <span>cr4</span>        <span>; read current cr4</span>
    <span>or</span>  <span>ebx</span><span>, 0x00000010 </span><span>; set PSE</span>
    <span>mov</span> <span>cr4</span>, <span>ebx</span>        <span>; update cr4</span>

    <span>mov</span> <span>ebx</span>, <span>cr0</span>        <span>; read current cr0</span>
    <span>or</span>  <span>ebx</span><span>, 0x80000000 </span><span>; set PG</span>
    <span>mov</span> <span>cr0</span>, <span>ebx</span>        <span>; update cr0</span>

    <span>; now paging is enabled</span></code></pre>
<h3 id="a-few-details"> A Few Details</h3>
<p>It is important to note that all addresses within the page directory, page tables and in <code>cr3</code> need to be physical addresses to the structures, never virtual. This will be more relevant in later sections where we dynamically update the paging structures (see the chapter <a href="#user-mode">“User Mode”</a>).</p>
<p>An instruction that is useful when an updating a PDT or PT is <code>invlpg</code>. It invalidates the <em>Translation Lookaside Buffer</em> (TLB) entry for a virtual address. The TLB is a cache for translated addresses, mapping physical addresses corresponding to virtual addresses. This is only required when changing a PDE or PTE that was previously mapped to something else. If the PDE or PTE had previously been marked as not present (bit 0 was set to 0), executing <code>invlpg</code> is unnecessary. Changing the value of <code>cr3</code> will cause all entries in the TLB to be invalidated.</p>
<p>An example of invalidating a TLB entry is shown below:</p>
<pre><code>    <span>; invalidate any TLB references to virtual address 0</span>
    <span>invlpg</span> [<span>0</span>]</code></pre>
<h2 id="paging-and-the-kernel"> Paging and the Kernel</h2>
<p>This section will describe how paging affects the OS kernel. We encourage you to run your OS using identity paging before trying to implement a more advanced paging setup, since it can be hard to debug a malfunctioning page table that is set up via assembly code.</p>
<h3 id="reasons-to-not-identity-map-the-kernel"> Reasons to Not Identity Map the Kernel</h3>
<p>If the kernel is placed at the beginning of the virtual address space - that is, the virtual address space (<code>0x00000000</code>, <code>"size of kernel"</code>) maps to the location of the kernel in memory - there will be issues when linking the user mode process code. Normally, during linking, the linker assumes that the code will be loaded into the memory position <code>0x00000000</code>. Therefore, when resolving absolute references, <code>0x00000000</code> will be the base address for calculating the exact position. But if the kernel is mapped onto the virtual address space (<code>0x00000000</code>, <code>"size of kernel"</code>), the user mode process cannot be loaded at virtual address <code>0x00000000</code> - it must be placed somewhere else. Therefore, the assumption from the linker that the user mode process is loaded into memory at position <code>0x00000000</code> is wrong. This can be corrected by using a linker script which tells the linker to assume a different starting address, but that is a very cumbersome solution for the users of the operating system.</p>
<p>This also assumes that we want the kernel to be part of the user mode process’ address space. As we will see later, this is a nice feature, since during system calls we don’t have to change any paging structures to get access to the kernel’s code and data. The kernel pages will of course require privilege level 0 for access, to prevent a user process from reading or writing kernel memory.</p>
<h3 id="the-virtual-address-for-the-kernel"> The Virtual Address for the Kernel</h3>
<p>Preferably, the kernel should be placed at a very high virtual memory address, for example <code>0xC0000000</code> (3 GB). The user mode process is not likely to be 3 GB large, which is now the only way that it can conflict with the kernel. When the kernel uses virtual addresses at 3 GB and above it is called a <em>higher-half kernel</em>. <code>0xC0000000</code> is just an example, the kernel can be placed at any address higher than 0 to get the same benefits. Choosing the correct address depends on how much virtual memory should be available for the kernel (it is easiest if all memory above the kernel virtual address should belong to the kernel) and how much virtual memory should be available for the process.</p>
<p>If the user mode process is larger than 3 GB, some pages will need to be swapped out by the kernel. Swapping pages is not part of this book.</p>
<h3 id="placing-the-kernel-at-0xc0000000"> Placing the Kernel at <code>0xC0000000</code></h3>
<p>To start with, it is better to place the kernel at <code>0xC0100000</code> than <code>0xC0000000</code>, since this makes it possible to map (<code>0x00000000</code>, <code>0x00100000</code>) to (<code>0xC0000000</code>, <code>0xC0100000</code>). This way, the entire range (<code>0x00000000</code>, <code>"size of kernel"</code>) of memory is mapped to the range (<code>0xC0000000</code>, <code>0xC0000000  + "size of kernel"</code>).</p>
<p>Placing the kernel at <code>0xC0100000</code> isn’t hard, but it does require some thought. This is once again a linking problem. When the linker resolves all absolute references in the kernel, it will assume that our kernel is loaded at physical memory location <code>0x00100000</code>, not <code>0x00000000</code>, since relocation is used in the linker script (see the section <a href="#linking-the-kernel">“Linking the kernel”</a>). However, we want the jumps to be resolved using <code>0xC0100000</code> as base address, since otherwise a kernel jump will jump straight into the user mode process code (remember that the user mode process is loaded at virtual memory <code>0x00000000</code>).</p>
<p>However, we can’t simply tell the linker to assume that the kernel starts (is loaded) at <code>0xC01000000</code>, since we want it to be loaded at the physical address <code>0x00100000</code>. The reason for having the kernel loaded at 1 MB is because it can’t be loaded at <code>0x00000000</code>, since there is BIOS and GRUB code loaded below 1 MB. Furthermore, we cannot assume that we can load the kernel at <code>0xC0100000</code>, since the machine might not have 3 GB of physical memory.</p>
<p>This can be solved by using both relocation (<code>.=0xC0100000</code>) and the <code>AT</code> instruction in the linker script. Relocation specifies that non-relative memory-references should should use the relocation address as base in address calculations. <code>AT</code> specifies where the kernel should be loaded into memory. Relocation is done at link time by GNU ld <span>[37]</span>, the load address specified by <code>AT</code> is handled by GRUB when loading the kernel, and is part of the ELF format <span>[18]</span>.</p>
<h3 id="higher-half-linker-script"> Higher-half Linker Script</h3>
<p>We can modify the <a href="#linking-the-kernel">first linker script</a> to implement this:</p>
<pre><code>    ENTRY(loader)           /* the name of the entry symbol */

    . = 0xC0100000          /* the code should be relocated to 3GB + 1MB */

    /* align at 4 KB and load at 1 MB */
    .text ALIGN (0x1000) : AT(ADDR(.text)-0xC0000000)
    {
        *(.text)            /* all text sections from all files */
    }

    /* align at 4 KB and load at 1 MB + . */
    .rodata ALIGN (0x1000) : AT(ADDR(.text)-0xC0000000)
    {
        *(.rodata*)         /* all read-only data sections from all files */
    }

    /* align at 4 KB and load at 1 MB + . */
    .data ALIGN (0x1000) : AT(ADDR(.text)-0xC0000000)
    {
        *(.data)            /* all data sections from all files */
    }

    /* align at 4 KB and load at 1 MB + . */
    .bss ALIGN (0x1000) : AT(ADDR(.text)-0xC0000000)
    {
        *(COMMON)           /* all COMMON sections from all files */
        *(.bss)             /* all bss sections from all files */
    }</code></pre>
<h3 id="entering-the-higher-half"> Entering the Higher Half</h3>
<p>When GRUB jumps to the kernel code, there is no paging table. Therefore, all references to <code>0xC0100000 + X</code> won’t be mapped to the correct physical address, and will therefore cause a general protection exception (GPE) at the very best, otherwise (if the computer has more than 3 GB of memory) the computer will just crash.</p>
<p>Therefore, assembly code that doesn’t use relative jumps or relative memory addressing must be used to do the following:</p>
<ul>
<li>Set up a page table.</li>
<li>Add identity mapping for the first 4 MB of the virtual address space.</li>
<li>Add an entry for <code>0xC0100000</code> that maps to <code>0x0010000</code></li>
</ul>
<p>If we skip the identity mapping for the first 4 MB, the CPU would generate a page fault immediately after paging was enabled when trying to fetch the next instruction from memory. After the table has been created, an jump can be done to a label to make <code>eip</code> point to a virtual address in the higher half:</p>
<pre><code>    <span>; assembly code executing at around 0x00100000</span>
    <span>; enable paging for both actual location of kernel</span>
    <span>; and its higher-half virtual location</span>

    <span>lea</span> <span>ebx</span>, [higher_half] <span>; load the address of the label in ebx</span>
    <span>jmp</span> <span>ebx</span>                <span>; jump to the label</span>

<span>    higher_half:</span>
        <span>; code here executes in the higher half kernel</span>
        <span>; eip is larger than 0xC0000000</span>
        <span>; can continue kernel initialisation, calling C code, etc.</span></code></pre>
<p>The register <code>eip</code> will now point to a memory location somewhere right after <code>0xC0100000</code> - all the code can now execute as if it were located at <code>0xC0100000</code>, the higher-half. The entry mapping of the first 4 MB of virtual memory to the first 4 MB of physical memory can now be removed from the page table and its corresponding entry in the TLB invalidated with <code>invlpg [0]</code>.</p>
<h3 id="running-in-the-higher-half"> Running in the Higher Half</h3>
<p>There are a few more details we must deal with when using a higher-half kernel. We must be careful when using memory-mapped I/O that uses specific memory locations. For example, the frame buffer is located at <code>0x000B8000</code>, but since there is no entry in the page table for the address <code>0x000B8000</code> any longer, the address <code>0xC00B8000</code> must be used, since the virtual address <code>0xC0000000</code> maps to the physical address <code>0x00000000</code>.</p>
<p>Any explicit references to addresses within the multiboot structure needs to be changed to reflect the new virtual addresses as well.</p>
<p>Mapping 4 MB pages for the kernel is simple, but wastes memory (unless you have a really big kernel). Creating a higher-half kernel mapped in as 4 KB pages saves memory but is harder to set up. Memory for the page directory and one page table can be reserved in the <code>.data</code> section, but one needs to configure the mappings from virtual to physical addresses at run-time. The size of the kernel can be determined by exporting labels from the linker script <span>[37]</span>, which we’ll need to do later anyway when writing the page frame allocator (see the chapter <a href="#page-frame-allocation">“Page Frame Allocation</a>).</p>
<h2 id="virtual-memory-through-paging"> Virtual Memory Through Paging</h2>
<p>Paging enables two things that are good for virtual memory. First, it allows for fine-grained access control to memory. You can mark pages as read-only, read-write, only for PL0 etc. Second, it creates the illusion of contiguous memory. User mode processes, and the kernel, can access memory as if it were contiguous, and the contiguous memory can be extended without the need to move data around in memory. We can also allow the user mode programs access to all memory below 3 GB, but unless they actually use it, we don’t have to assign page frames to the pages. This allows processes to have code located near <code>0x00000000</code> and the stack at just below <code>0xC0000000</code>, and still not require more than two actual pages.</p>
<h2 id="further-reading-6"> Further Reading</h2>
<ul>
<li>Chapter 4 (and to some extent chapter 3) of the Intel manual <span>[33]</span> are your definitive sources for the details about paging.</li>
<li>Wikipedia has an article on paging: <a href="http://en.wikipedia.org/wiki/Paging">http://en.wikipedia.org/wiki/Paging</a></li>
<li>The OSDev wiki has a page on paging: <a href="http://wiki.osdev.org/Paging">http://wiki.osdev.org/Paging</a> and a tutorial for making a higher-half kernel: <a href="http://wiki.osdev.org/Higher_Half_bare_bones">http://wiki.osdev.org/Higher_Half_bare_bones</a></li>
<li>Gustavo Duarte’s article on how a kernel manages memory is well worth a read: <a href="http://duartes.org/gustavo/blog/post/anatomy-of-a-program-in-memory">http://duartes.org/gustavo/blog/post/anatomy-of-a-program-in-memory</a></li>
<li>Details on the linker command language can be found at Steve Chamberlain’s website <span>[37]</span>.</li>
<li>More details on the ELF format can be found in this presentation: <a href="http://flint.cs.yale.edu/cs422/doc/ELF_Format.pdf">http://flint.cs.yale.edu/cs422/doc/ELF_Format.pdf</a></li>
</ul>
<h2 id="page-frame-allocation"> Page Frame Allocation</h2>
<p>When using virtual memory, how does the OS know which parts of memory are free to use? That is the role of the page frame allocator.</p>
<h2 id="managing-available-memory"> Managing Available Memory</h2>
<h3 id="how-much-memory-is-there"> How Much Memory is There?</h3>
<p>First we need to know how much memory is available on the computer the OS is running on. The easiest way to do this is to read it from the multiboot structure <span>[19]</span> passed to us by GRUB. GRUB collects the information we need about the memory - what is reserved, I/O mapped, read-only etc. We must also make sure that we don’t mark the part of memory used by the kernel as free (since GRUB doesn’t mark this memory as reserved). One way to know how much memory the kernel uses is to export labels at the beginning and the end of the kernel binary from the linker script:</p>
<pre><code>    ENTRY(loader)           /* the name of the entry symbol */

    . = 0xC0100000          /* the code should be relocated to 3 GB + 1 MB */

    /* these labels get exported to the code files */
    kernel_virtual_start = .;
    kernel_physical_start = . - 0xC0000000;

    /* align at 4 KB and load at 1 MB */
    .text ALIGN (0x1000) : AT(ADDR(.text)-0xC0000000)
    {
        *(.text)            /* all text sections from all files */
    }

    /* align at 4 KB and load at 1 MB + . */
    .rodata ALIGN (0x1000) : AT(ADDR(.rodata)-0xC0000000)
    {
        *(.rodata*)         /* all read-only data sections from all files */
    }

    /* align at 4 KB and load at 1 MB + . */
    .data ALIGN (0x1000) : AT(ADDR(.data)-0xC0000000)
    {
        *(.data)            /* all data sections from all files */
    }

    /* align at 4 KB and load at 1 MB + . */
    .bss ALIGN (0x1000) : AT(ADDR(.bss)-0xC0000000)
    {
        *(COMMON)           /* all COMMON sections from all files */
        *(.bss)             /* all bss sections from all files */
    }

    kernel_virtual_end = .;
    kernel_physical_end = . - 0xC0000000;</code></pre>
<p>These labels can directly be read from assembly code and pushed on the stack to make them available to C code:</p>
<pre><code>    <span>extern</span> kernel_virtual_start
    <span>extern</span> kernel_virtual_end
    <span>extern</span> kernel_physical_start
    <span>extern</span> kernel_physical_end

    <span>; ...</span>

    <span>push</span> kernel_physical_end
    <span>push</span> kernel_physical_start
    <span>push</span> kernel_virtual_end
    <span>push</span> kernel_virtual_start

    <span>call</span> kmain</code></pre>
<p>This way we get the labels as arguments to <code>kmain</code>. If you want to use C instead of assembly code, one way to do it is to declare the labels as functions and take the addresses of these functions:</p>
<pre><code>    <span>void</span> kernel_virtual_start(<span>void</span>);

    <span>/* ... */</span>

    <span>unsigned</span> <span>int</span> vaddr = (<span>unsigned</span> <span>int</span>) &amp;kernel_virtual_start;</code></pre>
<p>If you use GRUB modules you need to make sure the memory they use is marked as reserved as well.</p>
<p>Note that the available memory does not need to be contiguous. In the first 1 MB there are several I/O-mapped memory sections, as well as memory used by GRUB and the BIOS. Other parts of the memory might be similarly unavailable.</p>
<p>It’s convenient to divide the memory sections into complete page frames, as we can’t map part of pages into memory.</p>
<h3 id="managing-available-memory-1"> Managing Available Memory</h3>
<p>How do we know which page frames are in use? The page frame allocator needs to keep track of which are free and which aren’t. There are several ways to do this: bitmaps, linked lists, trees, the Buddy System (used by Linux) etc. For more information about the different algorithms see the article on OSDev <span>[38]</span>.</p>
<p>Bitmaps are quite easy to implement. One bit is used for each page frame and one (or more) page frames are dedicated to store the bitmap. (Note that this is just one way to do it, other designs might be better and/or more fun to implement.)</p>
<h2 id="how-can-we-access-a-page-frame"> How Can We Access a Page Frame?</h2>
<p>The page frame allocator returns the physical start address of the page frame. This page frame is not mapped in - no page table points to this page frame. How can we read and write data to the frame?</p>
<p>We need to map the page frame into virtual memory, by updating the PDT and/or PT used by the kernel. What if all available page tables are full? Then we can’t map the page frame into memory, because we’d need a new page table - which takes up an entire page frame - and to write to this page frame we’d need to map its page frame… Somehow this circular dependency must be broken.</p>
<p>One solution is to reserve a part of the first page table used by the kernel (or some other higher-half page table) for temporarily mapping page frames to make them accessible. If the kernel is mapped at <code>0xC0000000</code> (page directory entry with index 768), and 4 KB page frames are used, then the kernel has at least one page table. If we assume - or limit us to - a kernel of size at most 4 MB minus 4 KB we can dedicate the last entry (entry 1023) of this page table for temporary mappings. The virtual address of pages mapped in using the last entry of the kernel’s PT will be:</p>
<pre><code>    (768 &lt;&lt; 22) | (1023 &lt;&lt; 12) | 0x000 = 0xC03FF000</code></pre>
<p>After we’ve temporarily mapped the page frame we want to use as a page table, and set it up to map in our first page frame, we can add it to the paging directory, and remove the temporary mapping.</p>
<h2 id="a-kernel-heap"> A Kernel Heap</h2>
<p>So far we’ve only been able to work with fixed-size data, or directly with raw memory. Now that we have a page frame allocator we can implement <code>malloc</code> and <code>free</code> to use in the kernel.</p>
<p>Kernighan and Ritchie <span>[8]</span> have an example implementation in their book <span>[8]</span> that we can draw inspiration from. The only modification we need to do is to replace calls to <code>sbrk</code>/<code>brk</code> with calls to the page frame allocator when more memory is needed. We must also make sure to map the page frames returned by the page frame allocator to virtual addresses. A correct implementation should also return page frames to the page frame allocator on call to <code>free</code>, whenever sufficiently large blocks of memory are freed.</p>
<h2 id="further-reading-7"> Further reading</h2>
<ul>
<li>The OSDev wiki page on page frame allocation: <a href="http://wiki.osdev.org/Page_Frame_Allocation">http://wiki.osdev.org/Page_Frame_Allocation</a></li>
</ul>
<h2 id="user-mode"> User Mode</h2>
<p>User mode is now almost within our reach, there are just a few more steps required to get there. Although these steps might seem easy they way they are presented in this chapter, they can be tricky to implement, since there are a lot of places where small errors will cause bugs that are hard to find.</p>
<h2 id="segments-for-user-mode"> Segments for User Mode</h2>
<p>To enable user mode we need to add two more segments to the GDT. They are very similar to the kernel segments we added when we <a href="#the-global-descriptor-table-gdt">set up the GDT</a> in the <a href="#segmentation">chapter about segmentation</a>:</p>
<table>
<caption>The segment descriptors needed for user mode.</caption>
<thead>
<tr>
<th>Index</th>
<th>Offset</th>
<th>Name</th>
<th>Address range</th>
<th>Type</th>
<th>DPL</th>
</tr>
</thead>
<tbody>
<tr>
<td>3</td>
<td><code>0x18</code></td>
<td>user code segment</td>
<td><code>0x00000000 - 0xFFFFFFFF</code></td>
<td>RX</td>
<td>PL3</td>
</tr>
<tr>
<td>4</td>
<td><code>0x20</code></td>
<td>user data segment</td>
<td><code>0x00000000 - 0xFFFFFFFF</code></td>
<td>RW</td>
<td>PL3</td>
</tr>
</tbody>
</table>
<p>The difference is the DPL, which now allows code to execute in PL3. The segments can still be used to address the entire address space, just using these segments for user mode code will not protect the kernel. For that we need paging.</p>
<h2 id="setting-up-for-user-mode"> Setting Up For User Mode</h2>
<p>There are a few things every user mode process needs:</p>
<ul>
<li><p>Page frames for code, data and stack. At the moment it suffices to allocate one page frame for the stack and enough page frames to fit the program’s code. Don’t worry about setting up a stack that can be grow and shrink at this point in time, focus on getting a basic implementation work first.</p></li>
<li><p>The binary from the GRUB module has to be copied to the page frames used for the programs code.</p></li>
<li><p>A page directory and page tables are needed to map the page frames described above into memory. At least two page tables are needed, because the code and data should be mapped in at <code>0x00000000</code> and increasing, and the stack should start just below the kernel, at <code>0xBFFFFFFB</code>, growing towards lower addresses. The U/S flag has to be set to allow PL3 access.</p></li>
</ul>
<p>It might be convenient to store this information in a <code>struct</code> representing a process. This process <code>struct</code> can be dynamically allocated with the kernel’s <code>malloc</code> function.</p>
<h2 id="entering-user-mode"> Entering User Mode</h2>
<p>The only way to execute code with a lower privilege level than the current privilege level (CPL) is to execute an <code>iret</code> or <code>lret</code> instruction - interrupt return or long return, respectively.</p>
<p>To enter user mode we set up the stack as if the processor had raised an inter-privilege level interrupt. The stack should look like the following:</p>
<pre><code>    [esp + 16]  ss      ; the stack segment selector we want for user mode
    [esp + 12]  esp     ; the user mode stack pointer
    [esp +  8]  eflags  ; the control flags we want to use in user mode
    [esp +  4]  cs      ; the code segment selector
    [esp +  0]  eip     ; the instruction pointer of user mode code to execute</code></pre>
<p>See the Intel manual <span>[33]</span>, section 6.2.1, figure 6-4 for more information.</p>
<p>The instruction <code>iret</code> will then read these values from the stack and fill in the corresponding registers. Before we execute <code>iret</code> we need to change to the page directory we setup for the user mode process. It is important to remember that to continue executing kernel code after we’ve switched PDT, the kernel needs to be mapped in. One way to accomplish this is to have a separate PDT for the kernel, which maps all data at <code>0xC0000000</code> and above, and merge it with the user PDT (which only maps below <code>0xC0000000</code>) when performing the switch. Remember that physical address of the PDT has to be used when setting the register <code>cr3</code>.</p>
<p>The register <code>eflags</code> contains a set of different flags, specified in section 2.3 of the Intel manual <span>[33]</span>. Most important for us is the interrupt enable (IF) flag. The assembly code instruction <code>sti</code> can’t be used in privilege level 3 for enabling interrupts. If interrupts are disabled when entering user mode, then interrupts can’t enabled once user mode is entered. Setting the IF flag in the <code>eflags</code> entry on the stack will enable interrupts in user mode, since the assembly code instruction <code>iret</code> will set the register <code>eflags</code> to the corresponding value on the stack.</p>
<p>For now, we should have interrupts disabled, as it requires a little more work to get inter-privilege level interrupts to work properly (see the section <a href="#system-calls">“System calls”</a>).</p>
<p>The value <code>eip</code> on the stack should point to the entry point for the user code - <code>0x00000000</code> in our case. The value <code>esp</code> on the stack should be where the stack starts - <code>0xBFFFFFFB</code> (<code>0xC0000000 - 4</code>).</p>
<p>The values <code>cs</code> and <code>ss</code> on the stack should be the segment selectors for the user code and user data segments, respectively. As we saw in the <a href="#creating-and-loading-the-gdt">segmentation chapter</a>, the lowest two bits of a segment selector is the RPL - the Requested Privilege Level. When using <code>iret</code> to enter PL3, the RPL of <code>cs</code> and <code>ss</code> should be <code>0x3</code>. The following code shows an example:</p>
<pre><code>    USER_MODE_CODE_SEGMENT_SELECTOR <span>equ</span><span> 0x18</span>
    USER_MODE_DATA_SEGMENT_SELECTOR <span>equ</span><span> 0x20</span>
    <span>mov</span> <span>cs</span>, USER_MODE_CODE_SEGMENT_SELECTOR |<span> 0x3</span>
    <span>mov</span> <span>ss</span>, USER_MODE_DATA_SEGMENT_SELECTOR |<span> 0x3</span></code></pre>
<p>The register <code>ds</code>, and the other data segment registers, should be set to the same segment selector as <code>ss</code>. They can be set the ordinary way, with the <code>mov</code> assembly code instruction.</p>
<p>We are now ready to execute <code>iret</code>. If everything has been set up right, we should now have a kernel that can enter user mode.</p>
<h2 id="using-c-for-user-mode-programs"> Using C for User Mode Programs</h2>
<p>When C is used as the programming language for user mode programs, it is important to think about the structure of the file that will be the result of the compilation.</p>
<p>The reason we can use ELF <span>[18]</span> as the file format for for the kernel executable is because GRUB knows how to parse and interpret the ELF file format. If we implemented an ELF parser, we could compile the user mode programs into ELF binaries as well. We leave this as an exercise for the reader.</p>
<p>One thing we can do to make it easier to develop user mode programs is to allow the programs to be written in C, but compile them to flat binaries instead of ELF binaries. In C the layout of the generated code is more unpredictable and the entry point, <code>main</code>, might not be at offset 0 in the binary. One common way to work around this is to add a few assembly code lines placed at offset 0 which calls <code>main</code>:</p>
<pre><code>    <span>extern</span> main

    <span>section</span> .text
        <span>; push argv</span>
        <span>; push argc</span>
        <span>call</span> main
        <span>; main has returned, eax is return value</span>
        <span>jmp</span>  <span>$</span>    <span>; loop forever</span></code></pre>
<p>If this code is saved in a file called <code>start.s</code>, then the following code show an example of a linker script that places these instructions first in executable (remember that <code>start.s</code> gets compiled to <code>start.o</code>):</p>
<pre><code>    OUTPUT_FORMAT("binary")    /* output flat binary */

    SECTIONS
    {
        . = 0;                 /* relocate to address 0 */

        .text ALIGN(4):
        {
            start.o(.text)     /* include the .text section of start.o */
            *(.text)           /* include all other .text sections */
        }

        .data ALIGN(4):
        {
            *(.data)
        }

        .rodata ALIGN(4):
        {
            *(.rodata*)
        }
    }</code></pre>
<p><em>Note</em>: <code>*(.text)</code> will not include the <code>.text</code> section of <code>start.o</code> again.</p>
<p>With this script we can write programs in C or assembler (or any other language that compiles to object files linkable with <code>ld</code>), and it is easy to load and map for the kernel (<code>.rodata</code> will be mapped in as writeable, though).</p>
<p>When we compile user programs we want the following GCC flags:</p>
<pre><code>    -m32 -nostdlib -nostdinc -fno-builtin -fno-stack-protector -nostartfiles
    -nodefaultlibs</code></pre>
<p>For linking, the followings flags should be used:</p>
<pre><code>    -T link.ld -melf_i386  # emulate 32 bits ELF, the binary output is specified
                           # in the linker script</code></pre>
<p>The option <code>-T</code> instructs the linker to use the linker script <code>link.ld</code>.</p>
<h3 id="a-c-library"> A C Library</h3>
<p>It might now be interesting to start thinking about writing a small “standard library” for your programs. Some of the functionality requires <a href="#system-calls">system calls</a> to work, but some, such as the functions in <code>string.h</code>, does not.</p>
<h2 id="further-reading-8"> Further Reading</h2>
<ul>
<li>Gustavo Duarte has an article on privilege levels: <a href="http://duartes.org/gustavo/blog/post/cpu-rings-privilege-and-protection">http://duartes.org/gustavo/blog/post/cpu-rings-privilege-and-protection</a></li>
</ul>
<h2 id="file-systems"> File Systems</h2>
<p>We are not required to have file systems in our operating system, but it is a very usable abstraction, and it often plays a central part of many operating systems, especially UNIX-like operating systems. Before we start the process of supporting multiple processes and system calls we might want to consider implementing a simple file system.</p>
<h2 id="why-a-file-system"> Why a File System?</h2>
<p>How do we specify what programs to run in our OS? Which is the first program to run? How do programs output data or read input?</p>
<p>In UNIX-like systems, with their almost-everything-is-a-file convention, these problems are solved by the file system. (It might also be interesting to read a bit about the Plan 9 project, which takes this idea one step further.)</p>
<h2 id="a-simple-read-only-file-system"> A Simple Read-Only File System</h2>
<p>The simplest file system might be what we already have - one file, existing only in RAM, loaded by GRUB before the kernel starts. When the kernel and operating system grows this is probably too limiting.</p>
<p>A file system that is slightly more advanced than just the bits of one file is a file with metadata. The metadata can describe the type of the file, the size of the file and so on. A utility program can be created that runs at build time, adding this metadata to a file. This way, a “file system in a file” can be constructed by concatenating several files with metadata into one large file. The result of this technique is a read-only file system that resides in memory (once GRUB has loaded the file).</p>
<p>The program constructing the file system can traverse a directory on the host system and add all subdirectories and files as part of the target file system. Each object in the file system (directory or file) can consist of a header and a body, where the body of a file is the actual file and the body of a directory is a list of entries - names and “addresses” of other files and directories.</p>
<p>Each object in this file system will become contiguous, so they will be easy to read from memory for the kernel. All objects will also have a fixed size (except for the last one, which can grow), therefore it is difficult to add new files or modify existing ones.</p>
<h2 id="inodes-and-writable-file-systems"> Inodes and Writable File Systems</h2>
<p>When the need for a writable file system arises, then it is a good idea to look into the concept of an <em>inode</em>. See the section <a href="#further-reading-6">“Further Reading”</a> for recommended reading.</p>
<h2 id="a-virtual-file-system"> A Virtual File System</h2>
<p>What abstraction should be used for reading and writing to devices such as the screen and the keyboard?</p>
<p>A virtual file system (VFS) creates an abstraction on top of the concrete file systems. A VFS mainly supplies the path system and file hierarchy, it delegates operations on files to the underlying file systems. The original paper on VFS is succinct and well worth a read. See the section <a href="#further-reading-6">“Further Reading”</a> for a reference.</p>
<p>With a VFS we could mount a special file system on the path <code>/dev</code>. This file system would handle all devices such as keyboards and the console. However, one could also take the traditional UNIX approach, with major/minor device numbers and <code>mknod</code> to create special files for devices. Which approach you think is the most appropriate is up to you, there is no right or wrong when building abstraction layers (although some abstractions turn out way more useful than others).</p>
<h2 id="further-reading-9"> Further Reading</h2>
<ul>
<li>The ideas behind the Plan 9 operating systems is worth taking a look at: <a href="http://plan9.bell-labs.com/plan9/index.html">http://plan9.bell-labs.com/plan9/index.html</a></li>
<li>Wikipedia’s page on inodes: <a href="http://en.wikipedia.org/wiki/Inode">http://en.wikipedia.org/wiki/Inode</a> and the inode pointer structure: <a href="http://en.wikipedia.org/wiki/Inode_pointer_structure">http://en.wikipedia.org/wiki/Inode_pointer_structure</a>.</li>
<li>The original paper on the concept of vnodes and a virtual file system is quite interesting: <a href="http://www.arl.wustl.edu/~fredk/Courses/cs523/fall01/Papers/kleiman86vnodes.pdf">http://www.arl.wustl.edu/~fredk/Courses/cs523/fall01/Papers/kleiman86vnodes.pdf</a></li>
<li>Poul-Henning Kamp discusses the idea of a special file system for <code>/dev</code> in <a href="http://static.usenix.org/publications/library/proceedings/bsdcon02/full_papers/kamp/kamp_html/index.html">http://static.usenix.org/publications/library/proceedings/bsdcon02/full_papers/kamp/kamp_html/index.html</a></li>
</ul>
<h2 id="system-calls"> System Calls</h2>
<p><em>System calls</em> is the way user-mode applications interact with the kernel - to ask for resources, request operations to be performed, etc. The system call API is the part of the kernel that is most exposed to the users, therefore its design requires some thought.</p>
<h2 id="designing-system-calls"> Designing System Calls</h2>
<p>It is up to us, the kernel developers, to design the system calls that application developers can use. We can draw inspiration from the POSIX standards or, if they seem like too much work, just look at the ones for Linux, and pick and choose. See the section <a href="#further-reading-7">“Further Reading”</a> at the end of the chapter for references.</p>
<h2 id="implementing-system-calls"> Implementing System Calls</h2>
<p>System calls are traditionally invoked with software interrupts. The user applications put the appropriate values in registers or on the stack and then initiates a pre-defined interrupt which transfers execution to the kernel. The interrupt number used is dependent on the kernel, Linux uses the number <code>0x80</code> to identify that an interrupt is intended as a system call.</p>
<p>When system calls are executed, the current privilege level is typically changed from PL3 to PL0 (if the application is running in user mode). To allow this, the DPL of the entry in the IDT for the system call interrupt needs to allow PL3 access.</p>
<p>Whenever inter-privilege level interrupts occur, the processor pushes a few important registers onto the stack - the same ones we used to enter user mode <a href="#user-mode">before</a>, see figure 6-4, section 6.12.1, in the Intel manual <span>[33]</span>. What stack is used? The same section in <span>[33]</span> specifies that if an interrupt leads to code executing at a numerically lower privilege level, a stack switch occurs. The new values for the registers <code>ss</code> and <code>esp</code> is loaded from the current Task State Segment (TSS). The TSS structure is specified in figure 7-2, section 7.2.1 of the Intel manual <span>[33]</span>.</p>
<p>To enable system calls we need to setup a TSS before entering user mode. Setting it up can be done in C by setting the <code>ss0</code> and <code>esp0</code> fields of a “packed struct” that represents a TSS. Before loading the “packed struct” into the processor, a TSS descriptor has to be added to the GDT. The structure of the TSS descriptor is described in section 7.2.2 in <span>[33]</span>.</p>
<p>You specify the current TSS segment selector by loading it into the <code>tr</code> register with the <code>ltr</code> assembly code instruction. If the TSS segment descriptor has index 5, and thus offset <code>5 * 8 = 40 = 0x28</code>, this is the value that should be loaded into the register <code>tr</code>.</p>
<p>When we entered user mode before in the chapter <a href="#entering-user-mode">“Entering User Mode”</a> we disabled interrupts when executing in PL3. Since system calls are implemented using interrupts, interrupts must be enabled in user mode. Setting the IF flag bit in the <code>eflags</code> value on the stack will make <code>iret</code> enable interrupts (since the <code>eflags</code> value on the stack will be loaded into the <code>eflags</code> register by the assembly code instruction <code>iret</code>).</p>
<h2 id="further-reading-10"> Further Reading</h2>
<ul>
<li>The Wikipedia page on POSIX, with links to the specifications: <a href="http://en.wikipedia.org/wiki/POSIX">http://en.wikipedia.org/wiki/POSIX</a></li>
<li>A list of system calls used in Linux: <a href="http://bluemaster.iu.hio.no/edu/dark/lin-asm/syscalls.html">http://bluemaster.iu.hio.no/edu/dark/lin-asm/syscalls.html</a></li>
<li>The Wikipedia page on system calls: <a href="http://en.wikipedia.org/wiki/System_call">http://en.wikipedia.org/wiki/System_call</a></li>
<li>The Intel manual <span>[33]</span> sections on interrupts (chapter 6) and TSS (chapter 7) are where you get all the details you need.</li>
</ul>
<h2 id="multitasking"> Multitasking</h2>
<p>How do you make multiple processes appear to run at the same time? Today, this question has two answers:</p>
<ul>
<li>With the availability of multi-core processors, or on system with multiple processors, two processes can actually run at the same time by running two processes on different cores or processors.</li>
<li>Fake it. That is, switch rapidly (faster than a human can notice) between the processes. At any given moment there is only one process executing, but the rapid switching gives the impression that they are running “at the same time”.</li>
</ul>
<p>Since the operating system created in this book does not support multi-core processors or multiple processors the only option is to fake it. The part of the operating system responsible for rapidly switching between the processes is called the <em>scheduling algorithm</em>.</p>
<h2 id="creating-new-processes"> Creating New Processes</h2>
<p>Creating new processes is usually done with two different system calls: <code>fork</code> and <code>exec</code>. <code>fork</code> creates an exact copy of the currently running process, while <code>exec</code> replaces the current process with one that is specified by a path to the location of a program in the file system. Of these two we recommend that you start implementing <code>exec</code>, since this system call will do almost exactly the same steps as described in the section <a href="#setting-up-for-user-mode">“Setting up for user mode”</a> in the chapter <a href="#user-mode">“User Mode”</a>.</p>
<h2 id="cooperative-scheduling-with-yielding"> Cooperative Scheduling with Yielding</h2>
<p>The easiest way to achieve rapid switching between processes is if the processes themselves are responsible for the switching. The processes run for a while and then tell the OS (via a system call) that it can now switch to another process. Giving up the control of CPU to another process is called <em>yielding</em> and when the processes themselves are responsible for the scheduling it’s called <em>cooperative scheduling</em>, since all the processes must cooperate with each other.</p>
<p>When a process yields the process’ entire state must be saved (all the registers), preferably on the kernel heap in a structure that represents a process. When changing to a new process all the registers must be restored from the saved values.</p>
<p>Scheduling can be implemented by keeping a list of which processes are running. The system call <code>yield</code> should then run the next process in the list and put the current one last (other schemes are possible, but this is a simple one).</p>
<p>The transfer of control to the new process is done via the <code>iret</code> assembly code instruction in exactly the same way as explained in the section <a href="#entering-user-mode">“Entering user mode”</a> in the chapter <a href="#user-mode">“User Mode”</a>.</p>
<p>We <strong>strongly</strong> recommend that you start to implement support for multiple processes by implementing cooperative scheduling. We further recommend that you have a working solution for both <code>exec</code>, <code>fork</code> and <code>yield</code> before implementing preemptive scheduling. Since cooperative scheduling is deterministic, it is much easier to debug than preemptive scheduling.</p>
<h2 id="preemptive-scheduling-with-interrupts"> Preemptive Scheduling with Interrupts</h2>
<p>Instead of letting the processes themselves manage when to change to another process the OS can switch processes automatically after a short period of time. The OS can set up the <em>programmable interval timer</em> (PIT) to raise an interrupt after a short period of time, for example 20 ms. In the interrupt handler for the PIT interrupt the OS will change the running process to a new one. This way the processes themselves don’t need to worry about scheduling. This kind of scheduling is called <em>preemptive scheduling</em>.</p>
<h3 id="programmable-interval-timer"> Programmable Interval Timer</h3>
<p>To be able to do preemptive scheduling the PIT must first be configured to raise interrupts every <em>x</em> milliseconds, where <em>x</em> should be configurable.</p>
<p>The configuration of the PIT is very similar to the configuration of other hardware devices: a byte is sent to an I/O port. The command port of the PIT is <code>0x43</code>. To read about all the configuration options, see the article about the PIT on OSDev <span>[39]</span>. We use the following options:</p>
<ul>
<li>Raise interrupts (use channel 0)</li>
<li>Send the divider as low byte then high byte (see next section for an explanation)</li>
<li>Use a square wave</li>
<li>Use binary mode</li>
</ul>
<p>This results in the configuration byte <code>00110110</code>.</p>
<p>Setting the interval for how often interrupts are to be raised is done via a <em>divider</em>, the same way as for the serial port. Instead of sending the PIT a value (e.g.&nbsp;in milliseconds) that says how often an interrupt should be raised you send the divider. The PIT operates at 1193182 Hz as default. Sending the divider 10 results in the PIT running at <code>1193182 / 10 = 119318</code> Hz. The divider can only be 16 bits, so it is only possible to configure the timer’s frequency between 1193182 Hz and <code>1193182 / 65535 = 18.2</code> Hz. We recommend that you create a function that takes an interval in milliseconds and converts it to the correct divider.</p>
<p>The divider is sent to the channel 0 data I/O port of the PIT, but since only one byte can be sent at at a time, the lowest 8 bits of the divider has to sent first, then the highest 8 bits of the divider can be sent. The channel 0 data I/O port is located at <code>0x40</code>. Again, see the article on OSDev <span>[39]</span> for more details.</p>
<h3 id="separate-kernel-stacks-for-processes"> Separate Kernel Stacks for Processes</h3>
<p>If all processes uses the same kernel stack (the stack exposed by the TSS) there will be trouble if a process is interrupted while still in kernel mode. The process that is being switched to will now use the same kernel stack and will overwrite what the previous process have written on the stack (remember that TSS data structure points to the <em>beginning</em> of the stack).</p>
<p>To solve this problem every process should have it’s own kernel stack, the same way that each process have their own user mode stack. When switching process the TSS must be updated to point to the new process’ kernel stack.</p>
<h3 id="difficulties-with-preemptive-scheduling"> Difficulties with Preemptive Scheduling</h3>
<p>When using preemptive scheduling one problem arises that doesn’t exist with cooperative scheduling. With cooperative scheduling every time a process yields, it must be in user mode (privilege level 3), since yield is a system call. With preemptive scheduling, the processes can be interrupted in either user mode or kernel mode (privilege level 0), since the process itself does not control when it gets interrupted.</p>
<p>Interrupting a process in kernel mode is a little bit different than interrupting a process in user mode, due to the way the CPU sets up the stack at interrupts. If a privilege level change occurred (the process was interrupted in user mode) the CPU will push the value of the process <code>ss</code> and <code>esp</code> register on the stack. If <em>no</em> privilege level change occurs (the process was interrupted in kernel mode) the CPU won’t push the <code>esp</code> register on the stack. Furthermore, if there was no privilege level change, the CPU won’t change stack to the one defined it the TSS.</p>
<p>This problem is solved by calculating what the value of <code>esp</code> was <em>before</em> the interrupt. Since you know that the CPU pushes 3 things on the stack when no privilege change happens and you know how much you have pushed on the stack, you can calculate what the value of <code>esp</code> was at the time of the interrupt. This is possible since the CPU won’t change stacks if there is no privilege level change, so the content of <code>esp</code> will be the same as at the time of the interrupt.</p>
<p>To further complicate things, one must think of how to handle case when switching to a new process that should be running in kernel mode. Since <code>iret</code> is being used without a privilege level change the CPU won’t update the value of <code>esp</code> with the one placed on the stack - you must update <code>esp</code> yourself.</p>
<h2 id="further-reading-11"> Further Reading</h2>
<ul>
<li>For more information about different scheduling algorithms, see <a href="http://wiki.osdev.org/Scheduling_Algorithms">http://wiki.osdev.org/Scheduling_Algorithms</a></li>
</ul>
<div>
<h2> References</h2>
<p>[1] Andrew Tanenbaum, 2007. <em>Modern operating systems, 3rd edition</em>. Prentice Hall, Inc.,</p>
<p>[2] <em>The royal institute of technology</em>, <a href="http://www.kth.se/">http://www.kth.se</a>,</p>
<p>[3] Wikipedia, <em>Hexadecimal</em>, <a href="http://en.wikipedia.org/wiki/Hexadecimal">http://en.wikipedia.org/wiki/Hexadecimal</a>,</p>
<p>[4] OSDev, <em>OSDev</em>, <a href="http://wiki.osdev.org/Main_Page">http://wiki.osdev.org/Main_Page</a>,</p>
<p>[5] James Molloy, <em>James m’s kernel development tutorial</em>, <a href="http://www.jamesmolloy.co.uk/tutorial_html/">http://www.jamesmolloy.co.uk/tutorial_html/</a>,</p>
<p>[6] Canonical Ltd, <em>Ubuntu</em>, <a href="http://www.ubuntu.com/">http://www.ubuntu.com/</a>,</p>
<p>[7] Oracle, <em>Oracle vM virtualBox</em>, <a href="http://www.virtualbox.org/">http://www.virtualbox.org/</a>,</p>
<p>[8] Dennis M. Ritchie Brian W. Kernighan, 1988. <em>The c programming language, second edition</em>. Prentice Hall, Inc.,</p>
<p>[9] Wikipedia, <em>C (programming language)</em>, <a href="http://en.wikipedia.org/wiki/C_(programming_language)">http://en.wikipedia.org/wiki/C_(programming_language)</a>,</p>
<p>[10] Free Software Foundation, <em>GCC, the gNU compiler collection</em>, <a href="http://gcc.gnu.org/">http://gcc.gnu.org/</a>,</p>
<p>[11] NASM, <em>NASM: The netwide assembler</em>, <a href="http://www.nasm.us/">http://www.nasm.us/</a>,</p>
<p>[12] Wikipedia, <em>Bash</em>, <a href="http://en.wikipedia.org/wiki/Bash_%28Unix_shell%29">http://en.wikipedia.org/wiki/Bash_%28Unix_shell%29</a>,</p>
<p>[13] Free Software Foundation, <em>GNU make</em>, <a href="http://www.gnu.org/software/make/">http://www.gnu.org/software/make/</a>,</p>
<p>[14] Volker Ruppert, <em>bochs: The open souce iA-32 emulation project</em>, <a href="http://bochs.sourceforge.net/">http://bochs.sourceforge.net/</a>,</p>
<p>[15] QEMU, <em>QEMU</em>, <a href="http://wiki.qemu.org/Main_Page">http://wiki.qemu.org/Main_Page</a>,</p>
<p>[16] Wikipedia, <em>BIOS</em>, <a href="https://en.wikipedia.org/wiki/BIOS">https://en.wikipedia.org/wiki/BIOS</a>,</p>
<p>[17] Free Software Foundation, <em>GNU gRUB</em>, <a href="http://www.gnu.org/software/grub/">http://www.gnu.org/software/grub/</a>,</p>
<p>[18] Wikipedia, <em>Executable and linkable format</em>, <a href="http://en.wikipedia.org/wiki/Executable_and_Linkable_Format">http://en.wikipedia.org/wiki/Executable_and_Linkable_Format</a>,</p>
<p>[19] Free Software Foundation, <em>Multiboot specification version 0.6.96</em>, <a href="http://www.gnu.org/software/%20%20%20%20%20%20%20%20%20%20%20grub/manual/multiboot/multiboot.html">http://www.gnu.org/software/
           grub/manual/multiboot/multiboot.html</a>,</p>
<p>[20] GNU, <em>GNU binutils</em>, <a href="http://www.gnu.org/software/binutils/">http://www.gnu.org/software/binutils/</a>,</p>
<p>[21] Lars Nodeen, <em>Bug #426419: configure: error: GRUB requires a working absolute objcopy</em>, <a href="https://bugs.launchpad.net/ubuntu/+source/grub/+bug/426419">https://bugs.launchpad.net/ubuntu/+source/grub/+bug/426419</a>,</p>
<p>[22] Wikipedia, <em>ISO image</em>, <a href="http://en.wikipedia.org/wiki/ISO_image">http://en.wikipedia.org/wiki/ISO_image</a>,</p>
<p>[23] Bochs, <em>bochsrc</em>, <a href="http://bochs.sourceforge.net/doc/docbook/user/bochsrc.html">http://bochs.sourceforge.net/doc/docbook/user/bochsrc.html</a>,</p>
<p>[24] NASM, <em>RESB and friends: Declaring uninitialized data</em>, <a href="http://www.nasm.us/doc/nasmdoc3.htm">http://www.nasm.us/doc/nasmdoc3.htm</a>,</p>
<p>[25] Wikipedia, <em>x86 calling conventions</em>, <a href="http://en.wikipedia.org/wiki/X86_calling_conventions">http://en.wikipedia.org/wiki/X86_calling_conventions</a>,</p>
<p>[26] Wikipedia, <em>Framebuffer</em>, <a href="http://en.wikipedia.org/wiki/Framebuffer">http://en.wikipedia.org/wiki/Framebuffer</a>,</p>
<p>[27] Wikipedia, <em>VGA-compatible text mode</em>, <a href="http://en.wikipedia.org/wiki/VGA-compatible_text_mode">http://en.wikipedia.org/wiki/VGA-compatible_text_mode</a>,</p>
<p>[28] Wikipedia, <em>ASCII</em>, <a href="https://en.wikipedia.org/wiki/Ascii">https://en.wikipedia.org/wiki/Ascii</a>,</p>
<p>[29] OSDev, <em>VGA hardware</em>, <a href="http://wiki.osdev.org/VGA_Hardware">http://wiki.osdev.org/VGA_Hardware</a>,</p>
<p>[30] Wikipedia, <em>Serial port</em>, <a href="http://en.wikipedia.org/wiki/Serial_port">http://en.wikipedia.org/wiki/Serial_port</a>,</p>
<p>[31] OSDev, <em>Serial ports</em>, <a href="http://wiki.osdev.org/Serial_ports">http://wiki.osdev.org/Serial_ports</a>,</p>
<p>[32] WikiBooks, <em>Serial programming/8250 uART programming</em>, <a href="http://en.wikibooks.org/wiki/Serial_Programming/%20%20%20%20%20%208250_UART_Programming">http://en.wikibooks.org/wiki/Serial_Programming/
      8250_UART_Programming</a>,</p>
<p>[33] Intel, <em>Intel 64 and iA-32 architectures software developer’s manual vol. 3A</em>, <a href="http://www.intel.com/content/www/us/en/architecture-and-technology/64-ia-32-architectures-software-developer-vol-3a-part-1-manual.html/">http://www.intel.com/content/
www/us/en/architecture-and-technology/64-ia-32-architectures-software-developer-vol-3a-part-1-manual.html/</a>,</p>
<p>[34] NASM, <em>Multi-line macros</em>, <a href="http://www.nasm.us/doc/nasmdoc4.html#section-4.3">http://www.nasm.us/doc/nasmdoc4.html#section-4.3</a>,</p>
<p>[35] SIGOPS, <em>i386 interrupt handling</em>, <a href="http://www.acm.uiuc.edu/sigops/roll_your_own/i386/irq.html">http://www.acm.uiuc.edu/sigops/roll_your_own/i386/irq.html</a>,</p>
<p>[36] Andries Brouwer, <em>Keyboard scancodes</em>, <a href="http://www.win.tue.nl/">http://www.win.tue.nl/</a>,</p>
<p>[37] Steve Chamberlain, <em>Using ld, the gNU linker</em>, <a href="http://www.math.utah.edu/docs/info/ld_toc.html">http://www.math.utah.edu/docs/info/ld_toc.html</a>,</p>
<p>[38] OSDev, <em>Page frame allocation</em>, <a href="http://wiki.osdev.org/Page_Frame_Allocation">http://wiki.osdev.org/Page_Frame_Allocation</a>,</p>
<p>[39] OSDev, <em>Programmable interval timer</em>, <a href="http://wiki.osdev.org/Programmable_Interval_Timer">http://wiki.osdev.org/Programmable_Interval_Timer</a>,</p>
</div>

</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Pen and Paper Exercises in Machine Learning (2022) (365 pts)]]></title>
            <link>https://arxiv.org/abs/2206.13446</link>
            <guid>43440267</guid>
            <pubDate>Fri, 21 Mar 2025 20:07:12 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://arxiv.org/abs/2206.13446">https://arxiv.org/abs/2206.13446</a>, See on <a href="https://news.ycombinator.com/item?id=43440267">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="content-inner">
    
    
                
    <p><a href="https://arxiv.org/pdf/2206.13446">View PDF</a></p><blockquote>
            <span>Abstract:</span>This is a collection of (mostly) pen-and-paper exercises in machine learning. The exercises are on the following topics: linear algebra, optimisation, directed graphical models, undirected graphical models, expressive power of graphical models, factor graphs and message passing, inference for hidden Markov models, model-based learning (including ICA and unnormalised models), sampling and Monte-Carlo integration, and variational inference.
    </blockquote>

    <!--CONTEXT-->
    
  </div><div>
      <h2>Submission history</h2><p> From: Michael Gutmann [<a href="https://arxiv.org/show-email/abaa720a/2206.13446" rel="nofollow">view email</a>]      <br>    <strong>[v1]</strong>
        Mon, 27 Jun 2022 16:53:18 UTC (1,679 KB)<br>
</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Use Long Options in Scripts (221 pts)]]></title>
            <link>https://matklad.github.io/2025/03/21/use-long-options-in-scripts.html</link>
            <guid>43440184</guid>
            <pubDate>Fri, 21 Mar 2025 19:57:00 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://matklad.github.io/2025/03/21/use-long-options-in-scripts.html">https://matklad.github.io/2025/03/21/use-long-options-in-scripts.html</a>, See on <a href="https://news.ycombinator.com/item?id=43440184">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
  <article>

<h2><span>Use Long Options in Scripts</span> <time datetime="2025-03-21">Mar 21, 2025</time></h2>
<p><span>Many command line utilities support short form options (</span><code>-f</code><span>) and long form options (</span><code>--force</code><span>).</span>
<span>Short form is for interactive usage. In scripts, use the long form.</span></p>
<p><span>That is, in your terminal, type </span><span><code>$ git switch -c my-new-branch</code></span></p>
<p><span>In your release infrastructure script, write</span></p>

<figure>


<pre><code><span><span>try</span> shell.exec(<span>"git fetch origin --quiet"</span>, .{});</span>
<span><span>try</span> shell.exec(</span>
<span>    <span>"git switch --create release-{today} origin/main"</span>,</span>
<span>    .{ .today = stdx.DateUTC.now() },</span>
<span>);</span></code></pre>

</figure>
<p><span>Long form options are much more self-explanatory for the reader.</span></p>
</article>
  </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[I want a good parallel computer (167 pts)]]></title>
            <link>https://raphlinus.github.io/gpu/2025/03/21/good-parallel-computer.html</link>
            <guid>43440174</guid>
            <pubDate>Fri, 21 Mar 2025 19:55:42 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://raphlinus.github.io/gpu/2025/03/21/good-parallel-computer.html">https://raphlinus.github.io/gpu/2025/03/21/good-parallel-computer.html</a>, See on <a href="https://news.ycombinator.com/item?id=43440174">Hacker News</a></p>
<div id="readability-page-1" class="page"><div aria-label="Content">
        <article itemscope="" itemtype="http://schema.org/BlogPosting">

  

  <div itemprop="articleBody">
    <p>The GPU in your computer is about 10 to 100 times more powerful than the CPU, depending on workload. For real-time graphics rendering and machine learning, you are enjoying that power, and doing those workloads on a CPU is not viable. Why aren’t we exploiting that power for other workloads? What prevents a GPU from being a more general purpose computer?</p>

<p>I believe there are two main things holding it back. One is an impoverished execution model, which makes certain tasks difficult or impossible to do efficiently; GPUs excel at big blocks of data with predictable shape, such as dense matrix multiplication, but struggle when the workload is dynamic. Second, our languages and tools are inadequate. Programming a parallel computer is just a lot harder.</p>

<p>Modern GPUs are also extremely complex, and getting more so rapidly. New features such as mesh shaders and work graphs are two steps forward one step back; for each new capability there is a basic task that isn’t fully supported.</p>

<p>I believe a simpler, more powerful parallel computer is possible, and that there are signs in the historical record. In a slightly alternate universe, we would have those computers now, and be doing the work of designing algorithms and writing programs to run well on them, for a very broad range of tasks.</p>

<p>Last April, I gave a <a href="https://www.youtube.com/watch?v=c52ziyKOArc">colloquium</a> (video) at the UCSC CSE program with the same title. This blog is a companion to that.</p>

<h2 id="memory-efficiency-of-sophisticated-gpu-programs">Memory efficiency of sophisticated GPU programs</h2>

<p>I’ve been working on Vello, an advanced 2D vector graphics renderer, for many years. The CPU uploads a scene description in a simplified binary SVG-like format, then the compute shaders take care of the rest, producing a 2D rendered image at the end. The compute shaders <a href="https://arxiv.org/abs/2205.11659">parse</a> tree structures, do advanced computational geometry for <a href="https://linebender.org/gpu-stroke-expansion-paper/">stroke expansion</a>, and sorting-like algorithms for binning. Internally, it’s essentially a simple compiler, producing a separate optimized byte-code like program for each 16x16 pixel tile, then interpreting those programs. What it cannot do, a problem I am increasingly frustrated by, is run in bounded memory. Each stage produces intermediate data structures, and the number and size of these structures depends on the input in an unpredictable way. For example, changing a single transform in the encoded scene can result in profoundly different rendering plans.</p>

<p>The problem is that the buffers for the intermediate results need to be allocated (under CPU control) before kicking off the pipeline. There are a number of imperfect potential solutions. We could estimate memory requirements on the CPU before starting a render, but that’s expensive and may not be precise, resulting either in failure or waste. We could try a render, detect failure, and retry if buffers were exceeded, but doing readback from GPU to CPU is a big performance problem, and creates a significant architectural burden on other engines we’d interface with.</p>

<p>The details of the specific problem are interesting but beyond the scope of this blog post. The interested reader is directed to the <a href="https://docs.google.com/document/d/1gEqf7ehTzd89Djf_VpkL0B_Fb15e0w5fuv_UzyacAPU/edit?usp=sharing">Potato</a> design document, which explores the question of how far you can get doing scheduling on CPU, respecting bounded GPU resources, while using the GPU for actual pixel wrangling. It also touches on several more recent extensions to the standard GPU execution model, all of which are complex and non-portable, and none of which quite seem to solve the problem.</p>

<p>Fundamentally, it shouldn’t be necessary to allocate large buffers to store intermediate results. Since they will be consumed by downstream stages, it’s far more efficient to put them in queues, sized large enough to keep enough items in flight to exploit available parallelism. Many GPU operations internally work as queues (the standard vertex shader / fragment shader / rasterop pipeline being the classic example), so it’s a question of exposing that underlying functionality to applications. The <a href="https://dl.acm.org/doi/10.1145/1477926.1477930">GRAMPS</a> paper from 2009 suggests this direction, as did the <a href="https://graphics.stanford.edu/papers/brookgpu/brookgpu.pdf">Brook</a> project, a predecessor to CUDA.</p>

<p>There are a lot of potential solutions to running Vello-like algorithms in bounded memory; most have a fatal flaw on hardware today. It’s interesting to speculate about changes that would unlock the capability. It’s worth emphasizing, I’m not feeling held back by the amount of parallelism I can exploit, as my approach of breaking the problem into variants of prefix sum easily scales to hundreds of thousands of threads. Rather, it’s the inability to organize the overall as stages operating in parallel, connected through queues tuned to use only the amount of buffer memory needed to keep everything smoothly, as opposed to the compute shader execution model of large dispatches separated by pipeline barriers.</p>

<h2 id="parallel-computers-of-the-past">Parallel computers of the past</h2>

<p>The lack of a good parallel computer today is especially frustrating because there were some promising designs in the past, which failed to catch on for various complex reasons, leaving us with overly complex and limited GPUs, and extremely limited, though efficient, AI accelerators.</p>

<h3 id="connection-machine">Connection Machine</h3>

<p>I’m listing this not because it’s a particularly promising design, but because it expressed the dream of a good parallel computer in the clearest way. The first Connection Machine shipped in 1985, and contained up to 64k processors, connected in a hypercube network. The number of individual threads is large even by today’s standards, though each individual processor was extremely underpowered.</p>

<p>Perhaps more than anything else, the CM spurred tremendous research into parallel algorithms. The pioneering work by Blelloch on <a href="https://www.cs.cmu.edu/~guyb/papers/Ble93.pdf">prefix sum</a> was largely done on the Connection Machine, and I find early paper on <a href="https://www.cs.umd.edu/class/fall2019/cmsc714/readings/Blelloch-sorting.pdf">sorting on CM-2</a> to be quite fascinating.</p>

<p><img src="https://raphlinus.github.io/assets/teco_connection_machine.jpg" alt="Photo of Connection Machine 1 computer, with lots of flashing red LEDs"> <br>
<a href="https://www.flickr.com/photos/teco_kit/24095266110/">Connection Machine 1 (1985) at KIT / Informatics / TECO</a> • by KIT TECO • CC0</p>

<h3 id="cell">Cell</h3>

<p>Another important pioneering parallel computer was Cell, which shipped as part of the PlayStation 3 in 2006. That device shipped in fairly good volume (about 87.4 million units), and had fascinating applications including <a href="https://en.wikipedia.org/wiki/PlayStation_3_cluster">high performance computing</a>, but was a dead end; the Playstation 4 switched to a fairly vanilla Radeon GPU.</p>

<p>Probably one of the biggest challenges in the Cell was the programming model. In the version shipped on the PS3, there were 8 parallel cores, each with 256kB of static RAM, and each with 128 bit wide vector SIMD. The programmer had to manually copy data into local SRAM, where a kernel would then do some computation. There was little or no support for high level programming; thus people wanting to target this platform had to painstakingly architect and implement parallel algorithms.</p>

<p>All that said, the Cell basically met my requirements for a “good parallel computer.” The individual cores could run effectively arbitrary programs, and there was a global job queue.</p>

<p>The Cell had approximately 200 GFLOPS of total throughput, which was impressive at the time, but pales in comparison to modern GPUs or even a modern CPU (Intel i9-13900K is approximately 850 GFLOPS, with a medium-high end Ryzen 7 is 3379 GFLOPS).</p>

<h3 id="larrabee">Larrabee</h3>

<p>Perhaps the most poignant road not taken in the history of GPU design is Larrabee. The <a href="https://web.archive.org/web/20210307230536/https://software.intel.com/sites/default/files/m/9/4/9/larrabee_manycore.pdf">2008 SIGGRAPH paper</a> makes a compelling case, but ultimately the project failed. It’s hard to say why exactly, but I think it’s possible it was just poor execution on Intel’s part, and with more persistence and a couple of iterations to improve the shortcomings in the original version, it might well have succeeded. At heart, Larrabee is a standard x86 computer with wide (512 bit) SIMD units and just a bit of special hardware to optimize graphics tasks. Most graphics functions are implemented in software. If it had succeeded, it would very easily fulfill my wishes; work creation and queuing is done in software and can be entirely dynamic at a fine level of granularity.</p>

<p>Bits of Larrabee live on. The upcoming AVX10 instruction set is an evolution of Larrabee’s AVX-512, and supports 32 lanes of f16 operations. In fact, Tom Forsyth, one of its creators, argues that <a href="https://tomforsyth1000.github.io/blog.wiki.html#%5B%5BWhy%20didn%27t%20Larrabee%20fail%3F%5D%5D">Larrabee did not indeed fail</a> but that its legacy is a success. Another valuable facet of legacy is ISPC, and Matt Pharr’s blog on <a href="https://pharr.org/matt/blog/2018/04/18/ispc-origins">The story of ispc</a> sheds light on the Larrabee project.</p>

<p>Likely one of the problems of Larrabee was power consumption, which has emerged as one of the limiting factors in parallel computer performance. The fully coherent (total store order) memory hierarchy, while making software easier, also added to the cost of the system, and since then we’ve gained a lot of knowledge in how to write performant software in weaker memory models.</p>

<p>Another aspect that definitely held Larrabee back was the software, which is always challenging, especially for innovative directions. The drivers didn’t expose the special capabilities of the highly programmable hardware, and performance on traditional triangle-based 3D graphics scenes was underwhelming. Even so, it did quite well on CAD workloads involving lots of antialiased lines, driven by a standard OpenGL interface.</p>

<h2 id="the-changing-workload">The changing workload</h2>

<p>Even within games, compute is becoming a much larger fraction of the total workload (for AI, it’s everything). Analysis of <a href="https://chipsandcheese.com/2023/10/15/starfield-on-the-rx-6900-xt-rx-7600-and-rtx-2060-mobile/">Starfield</a> by Chips and Cheese shows that about half the time is in compute. The <a href="https://advances.realtimerendering.com/s2021/Karis_Nanite_SIGGRAPH_Advances_2021_final.pdf">Nanite</a> renderer also uses compute even for rasterization of small triangles, as hardware is only more efficient for triangles above a certain size. As games do more image filtering, global illumination, and primitives such as Gaussian splatting, the trend will almost certainly continue.</p>

<p>In 2009, Tim Sweeney gave a thought-provoking talk entitled <a href="https://web.archive.org/web/20090823200347/http://graphics.cs.williams.edu/archive/SweeneyHPG2009/TimHPG2009.pdf">The end of the GPU roadmap</a>, in which he proposed that the concept of GPU would go away entirely, replaced by a highly parallel general purpose computer. That has not come to pass, though there has been some movement in that direction: the Larrabee project (as described above), the groundbreaking <a href="https://research.nvidia.com/publication/2011-08_high-performance-software-rasterization-gpus">cudaraster</a> paper from 2011 implemented the traditional 3D rasterization pipeline entirely in compute, and found (simplifying quite a bit) that it was about 2x slower than using fixed function hardware, and more recent academic GPU designs based on grids of RISC-V cores. It’s worth noting, a more recent <a href="https://tellusim.com/compute-raster/">update from Tellusim</a> suggests that cudaraster-like rendering in compute can be close to parity on modern hardware.</p>

<p>An excellent 2017 presentation, <a href="https://openproblems.realtimerendering.com/s2017/index.html">Future Directions for Compute-for-Graphics</a> by Andrew Lauritzen, highlighted many of the challenges of incorporating advanced compute techniques into graphics pipelines. There’s been some progress since then, but it speaks to many of the same problems I’m raising in this blog post. Also see <a href="http://www.joshbarczak.com/blog/?p=1317">comments by Josh Barczak</a>, which also links the <a href="https://dl.acm.org/doi/10.1145/1477926.1477930">GRAMPS</a> work and discusses issues with language support.</p>

<h2 id="paths-forward">Paths forward</h2>

<p>I can see a few ways to get from the current state to a good parallel computer. Each basically picks a starting point that might have been on the right track but got derailed.</p>

<h3 id="big-grid-of-cores-cell-reborn">Big grid of cores: Cell reborn</h3>

<p>The original promise of the Cell still has some appeal. A modern high end CPU chip has north of 100 billion transistors, while a reasonably competent RISC CPU can be made with orders of magnitude fewer. Why not place hundreds or even thousands of cores on a chip? For maximum throughput, put a vector (SIMD) unit on each core. Indeed, there are at least two AI accelerator chips based on this idea: <a href="https://www.esperanto.ai/wp-content/uploads/2022/05/Dave-IEEE-Micro.pdf">Esperanto</a> and Tenstorrent. I’m particularly interested in the latter because its <a href="https://github.com/tenstorrent-metal/tt-metal/">software stack</a> is open source.</p>

<p>That said, there are most definitely challenges. A CPU by itself isn’t enough, it also needs high bandwidth local memory and communications with other cores. One reason the Cell was so hard to program is that the local memory was small and needed to be managed explicitly - your program needed to do explicit transfers through the network to get data in and out. The trend in CPU (and GPU) design is to virtualize everything, so that there’s an abstraction of a big pool of memory that all the cores share. You’ll still want to make your algorithm cache-aware for performance, but if not, the program will still run. It’s <em>possible</em> a sufficiently smart compiler can adapt a high-level description of the problem to the actual hardware (and this is the approach taken by Tenstorrent’s <a href="https://tenstorrent.com/en/software/tt-buda">TT-Buda</a> stack, specialized to AI workloads). In analogy to exploiting instruction-level parallelism through VLIW, the Itanium stands as a cautionary tale.</p>

<p>From my read of the Tenstorrent docs, the matrix unit is limited to just matrix multiplication and a few supporting operations such as transpose, so it’s not clear it would be a significant speedup for complex algorithms as needed in 2D rendering. But I think it’s worth exploring, to see how far it can be pushed, and perhaps whether practical extensions to the matrix unit to support permutations and so on would unlock more algorithms.</p>

<p>Most of the “big grid of cores” designs are targeted toward AI acceleration, and for good reason: it is hungry for raw throughput with low power costs, so alternatives to traditional CPU approaches are appealing. See the <a href="https://www.youtube.com/watch?v=w3xNLj6nRgs">New Silicon for Supercomputers</a> talk by Ian Cutress for a great survey of the field.</p>

<h3 id="running-vulkan-commands-from-gpu-side">Running Vulkan commands from GPU-side</h3>

<p>A relatively small delta to existing GPUs would be the ability to dispatch work from a controller mounted on the GPU and sharing address space with the shaders. In its most general form, users would be able to run threads on this controller that could run the full graphics API (for example, Vulkan). The programming model could be similar to now, just that the thread submitting work is running close to the compute units and therefore has dramatically lower latency.</p>

<p>In their earliest form, GPU’s were not distributed systems, they were co-processors, tightly coupled to the host CPU’s instruction stream. These days, work is issued to the GPU by the equivalent of async remote procedure calls, with end-to-end latency often as high as 100µs. This proposal essentially calls for a return to less of a distributed system model, where work can efficiently be issued on a much finer grain and with much more responsiveness to the data. For dynamic work creation, latency is the most important blocker.</p>

<p>Note that GPU APIs are slowly inventing a more complex, more limited version of this anyway. While it’s not possible to run the Vulkan API directly from a shader, with a recent Vulkan extension (<a href="https://registry.khronos.org/vulkan/specs/latest/man/html/VK_EXT_device_generated_commands.html">VK_EXT_device_generated_commands</a>) it is possible to encode some commands into a command buffer from a shader. Metal has this capability as well (see <a href="https://github.com/gpuweb/gpuweb/issues/431">gpuweb#431</a> for more details about portability). It’s worth noting that the ability to run indirect commands to recursively generate more work is one of the missing functions; it seems that the designers did not take Hofstadter to heart.</p>

<p>It is interesting to contemplate actually running Vulkan API directly from a shader. Since the Vulkan API is expressed in terms of C, one of the requirements is the ability to run C. This is being done on an experimental basis (see the <a href="https://shady-gang.github.io/vcc/">vcc</a> project), but is not yet practical. Of course, CUDA <em>can</em> run C. CUDA 12.4 also has support for <a href="https://developer.nvidia.com/blog/dynamic-control-flow-in-cuda-graphs-with-conditional-nodes/">conditional nodes</a>, and as of 12.0 it had support for <a href="https://developer.nvidia.com/blog/enabling-dynamic-control-flow-in-cuda-graphs-with-device-graph-launch/">device graph launch</a>, which reduces latency considerably.</p>

<h3 id="work-graphs">Work graphs</h3>

<p><a href="https://devblogs.microsoft.com/directx/d3d12-work-graphs/">Work graphs</a> are a recent new extension to the GPU execution model. Briefly, the program is structured as a graph of nodes (kernel programs) and edges (queues) all running in parallel. As a node generates output, filling its output queues, the GPU dispatches kernels (at workgroup granularity) to process those outputs further. To a large extent, this is a modern reinvention of the <a href="https://dl.acm.org/doi/10.1145/1477926.1477930">GRAMPS</a> idea.</p>

<p>While exciting, and very likely useful for an increasing range of graphics tasks, work graphs also have serious limitations; I researched whether I could use them for the existing Vello design and found three major problems. First, they cannot easily express joins, where progress of a node is dependent on synchronized input from two different queues. Vello uses joins extensively, for example one kernel to compute a bounding box of a draw object (aggregating multiple path segments), and another to process the geometry within that bounding box. Second, there is no ordering guarantee between the elements pushed into a queue, and 2D graphics ultimately does require ordering (the whiskers of the tiger must be drawn over the tiger’s face). Third, work graphs don’t support variable-size elements.</p>

<p>The lack of an ordering guarantee is particularly frustrating, because the traditional 3D pipeline <em>does</em> maintain ordering, among other reasons, to prevent Z-fighting artifacts (for a fascinating discussion of how GPU hardware preserves the blend order guarantee, see <a href="https://fgiesen.wordpress.com/2011/07/12/a-trip-through-the-graphics-pipeline-2011-part-9/">A trip through the Graphics Pipeline part 9</a>). It is not possible to faithfully emulate the traditional vertex/fragment pipeline using the new capability. Obviously, maintaining ordering guarantees in parallel systems is expensive, but ideally there is a way to opt in when needed, or at least couple work graphs with another mechanism (some form of sorting, which is possible to implement efficiently on GPUs) to re-establish ordering as needed. Thus, I see work graphs as two steps forward, one step back.</p>

<h3 id="cpu-convergent-evolution">CPU convergent evolution</h3>

<p>In theory, when running highly parallel workloads, a traditional multi-core CPU design is doing the same thing as a GPU, and if fully optimized for efficiency, should be competitive. That, arguably, is the design brief for Larrabee, and also motivation for more recent academic work like <a href="https://vortex.cc.gatech.edu/">Vortex</a>. Probably the biggest challenge is power efficiency. As a general trend, CPU designs are diverging into those optimizing single-core performance (performance cores) and those optimizing power efficiency (efficiency cores), with cores of both types commonly present on the same chip. As E-cores become more prevalent, algorithms designed to exploit parallelism at scale may start winning, incentivizing provision of even larger numbers of increasingly efficient cores, even if underpowered for single-threaded tasks.</p>

<p>An advantage of this approach is that it doesn’t change the execution model, so existing languages and tools can still be used. Unfortunately, most existing languages are poor at expressing and exploiting parallelism at both the SIMD and thread level – shaders have a more limited execution model but at least it’s clear how to execute them in parallel efficiently. And for thread-level parallelism, avoiding performance loss from context switches is challenging. Hopefully, newer languages such as <a href="https://en.wikipedia.org/wiki/Mojo_(programming_language)">Mojo</a> will help, and potentially can be adapted to GPU-like execution models as well.</p>

<p>I’m skeptical this approach will actually become competitive with GPUs and AI accelerators, as there is just a huge gap in throughput per watt compared with GPUs – about an order of magnitude. Also, GPUs and AI accelerators won’t be standing still either.</p>

<h3 id="maybe-the-hardware-is-already-there">Maybe the hardware is already there?</h3>

<p>It’s possible that there is hardware currently shipping that meets my criteria for a good parallel computer, but its potential is held back by software. GPUs generally have a “command processor” onboard, which, in cooperation with the host-side driver, breaks down the rendering and compute commands into chunks to be run by the actual execution units. Invariably, this command processor is hidden and cannot run user code. Opening that up could be quite interesting. A taste of that is in Hans-Kristian Arntzen’s notes on implementing work graphs in open source drivers: <a href="https://github.com/HansKristian-Work/vkd3d-proton/blob/workgraphs/docs/workgraphs.md">Workgraphs in vkd3d-proton</a>.</p>

<p>GPU designs vary in how much is baked into the hardware and how much is done by a command processor. Programmability is a good way to make things more flexible. The main limiting factor is the secrecy around such designs. Even in GPUs with open source drivers, the firmware (which is what runs on the command processor) is very locked down. Of course, a related challenge is security; opening up the command processor to user code increases the vulnerability surface area considerably. But from a research perspective, it should be interesting to explore what’s possible aside from security concerns.</p>

<p>Another interesting direction is the rise of “Accelerated Processing Units” which integrate GPUs and powerful CPUs in the same address space. Conceptually, these are similar to integrated graphics chips, but those rarely have enough performance to be interesting. From what I’ve seen, running existing APIs on such hardware (Vulkan for compute shaders, or one of the modern variants of OpenCL) would not have significant latency advantages for synchronizing work back to the CPU, due to context switching overhead. It’s possible a high priority or dedicated thread might quickly process items placed in a queue by GPU-side tasks. The key idea is queues running at full throughput, rather than async remote procedure calls with potentially huge latency.</p>

<h2 id="complexity">Complexity</h2>

<p>Taking a step back, one of the main features of the GPU ecosystem is a dizzying level of complexity. There’s the core parallel computer, then lots of special function hardware (and the scope of this is increasing, especially with newer features such as ray tracing), then big clunky mechanisms to get work scheduled and run. Those start with the basic compute shader dispatch mechanism (a 3D grid of x, y, z dimensions, 16 bits each), and then augment that with various <a href="https://developer.nvidia.com/blog/new-vulkan-device-generated-commands/">indirect command encoding</a> extensions.</p>

<p><a href="https://devblogs.microsoft.com/directx/d3d12-work-graphs/">Work graphs</a> also fit into the category of complexifying the execution model to work around the limitations of the primitive 3D grid. I was initially excited about their prospect, but when I took a closer look, I found they were inadequate for expressing any of the producer/consumer relationships in Vello.</p>

<p>There’s a lot of accidental complexity as well. There are multiple competing APIs, each with subtly different semantics, which makes it especially hard to write code once and have it just work.</p>

<p>CUDA is adding lots of new features, some of which improve autonomy as I’ve been wanting, and there is a tendency for graphics APIs to adopt features from CUDA. However, there’s also a lot of divergence between these ecosystems (work graphs can’t be readily adapted to CUDA, and it’s very unlikely graphics shaders will get independent thread scheduling any time soon).</p>

<p>The complexity of the GPU ecosystem has many downstream effects. Drivers and shader compilers are buggy and <a href="https://chromium.googlesource.com/chromium/src/+/main/docs/security/research/graphics/webgpu_technical_report.md">insecure</a>, and there is probably no path to really fixing that. Core APIs tend to be very limited in functionality and performance, so there’s a dazzling array of extensions that need to be detected at runtime, and the most appropriate permutation selected. This in turn makes it far more likely to run into bugs that appear only with specific combinations of features, or on particular hardware.</p>

<p>All this is in fairly stark contrast to the CPU world. A modern CPU is also dazzlingly complex, with billions of transistors, but it is rooted in a much simpler computational model. From a programmer perspective, writing code for a 25 billion transistor Apple M3 isn’t that different from, say, a Cortex M0, which can be made with about 48,000 transistors. Similarly, a low performance RISC-V implementation is a reasonable student project. Obviously the M3 is doing a lot more with branch prediction, superscalar issue, memory hierarchies, op fusion, and other performance tricks, but it’s recognizably doing the same thing as a vastly smaller and simpler chip.</p>

<p>In the past, there were economic pressures towards replacing special-purpose circuitry with general purpose compute performance, but those incentives are shifting. Basically, if you’re optimizing for number of transistors, then somewhat less efficient general purpose compute can be kept busy almost all the time, while special purpose hardware is only justified if there is high enough utilization in the workload. However, as Dennard scaling has ended and we’re more constrained by power than transistor count, special purpose hardware starts winning more; it can simply be powered down if it isn’t used by the workload. The days of a purely RISC computational model are probably over. What I’d <em>like</em> to see replacing it is an agile core (likely RISC-V) serving as the control function for a bunch of special-purpose accelerator extensions. That certainly is the model of the <a href="https://vortex.cc.gatech.edu/">Vortex</a> project among others.</p>

<h2 id="conclusion">Conclusion</h2>

<p>In his talk shortly before retirement, Nvidia GPU architect Erik Lindholm <a href="https://ubc.ca.panopto.com/Panopto/Pages/Viewer.aspx?id=880a1d92-30d7-4683-80e7-b1e000f501d3">said</a> (in the context of work creation and queuing systems), “my career has been about making things more flexible, more programmable. It’s not finished yet. There’s one more step that I feel that needs to be done, and I’ve been pursuing this at Nvidia Research for many years.” I agree, and my own work would benefit greatly. Now that he has retired, it is not clear who will take up the mantle. It may be Nvidia disrupting their previous product line with a new approach as they have in the past. It may be an upstart AI accelerator making a huge grid of low power processors with vector units, that just happens to be programmable. It might be CPU efficiency cores evolving to become so efficient they compete with GPUs.</p>

<p>Or it might not happen at all. On the current trajectory, GPUs will squeeze out incremental improvements on existing graphics workloads at the cost of increasing complexity, and AI accelerators will focus on improving the throughput of slop generation to the exclusion of everything else.</p>

<p>In any case, there is an opportunity for intellectually curious people to explore the alternate universe in which the good parallel computer exists; architectures can be simulated on FPGA like Vortex, and algorithms can be prototyped on multicore wide-SIMD CPUs. We can also start to think about what a proper programming language for such a machine might look like, as frustrating as it is to not have real hardware to run it on.</p>

<p>Progress on a good parallel computer would help my own little sliver of work, trying to make a fully parallel 2D renderer with modest resource requirements. I’ve got to imagine it would in addition help AI efforts, potentially unlocking sparse techniques that can’t run on existing hardware. I also think there’s a golden era of algorithms that <em>can</em> be parallel but aren’t a win on current GPUs, waiting to be developed.</p>


  </div>
</article>

      </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Frink (174 pts)]]></title>
            <link>https://frinklang.org/</link>
            <guid>43440046</guid>
            <pubDate>Fri, 21 Mar 2025 19:39:17 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://frinklang.org/">https://frinklang.org/</a>, See on <a href="https://news.ycombinator.com/item?id=43440046">Hacker News</a></p>
<div id="readability-page-1" class="page">
  
  <p>
   <a href="https://frinklang.org/whatsnew.html">What's&nbsp;New</a> *
   <a href="https://frinklang.org/faq.html">FAQ</a> *
   <a href="#JavaWebStart">Download</a> *
   <a href="https://frinklang.org/FrinkApplet.html">Frink&nbsp;Applet</a> *
   <a href="https://frinklang.org/fsp/frink.fsp">Web&nbsp;Interface</a> *
   <a href="https://frinklang.org/fsp/samples.fsp">Sample&nbsp;Programs</a> *
   <a href="https://frinklang.org/fspdocs.html">Frink&nbsp;Server&nbsp;Pages</a> *
   <a href="https://frinklang.org/android.html">Frink&nbsp;on&nbsp;Android</a> *
   <a href="https://frinklang.org/donate.html">Donate</a>
  </p>

  <h2><a name="AboutFrink">About Frink</a></h2>
  <p>
   Frink is a practical calculating tool and programming language designed to
   make physical calculations simple, to help ensure that answers come out
   right, and to make a tool that's really useful in the real world.  It
   tracks units of measure (feet, meters, kilograms, watts, etc.) through all
   calculations, allowing you to mix units of measure transparently, and helps
   you easily verify that your answers make sense.  It also contains a large
   <a href="https://frinklang.org/frinkdata/units.txt">data file</a> of physical quantities,
   freeing you from having to look them up, and freeing you to make
   effortless calculations without getting bogged down in the mechanics.
  </p>

  <p>
   Perhaps you'll get the best idea of what Frink can do if you skip down to
   the <a href="#SampleCalculations">Sample Calculations</a> further on this
   document.  Come back up to the top when you're done.
  </p>

  <p>
   Frink was named after one of my personal heroes, and great scientists of
   our time, the brilliant Professor John Frink.  Professor Frink noted,
   decades ago:
  </p>

  <blockquote>
   <p>
    <i>"I predict that within 100 years, computers will be twice as powerful,
     ten <b>thousand</b> times larger, and so expensive that only the five
     richest kings of Europe will own them."</i>
   </p>
  </blockquote>

  <h2><a name="Features">Features</a></h2>
  <p>
   For those with a short attention span like me, here are some of the
   features of Frink.
  </p>

  <ul>
   <li><a href="#HowFrinkIsDifferent">Tracks units of measure</a> (feet,
    meters, tons, dollars, watts, etc.) through all calculations and allows
    you to add, subtract, multiply, and divide them effortlessly, and makes
    sure the answer comes out correct, even if you mix units like gallons and
    liters.

   </li><li><a href="#NumericTypes">Arbitrary-precision math</a>, including huge
    integers and floating-point numbers, rational numbers (that is, fractions
    like 1/3 are kept without loss of precision,) complex numbers, and
    intervals.

   </li><li><a href="#CommonFunctions">Advanced mathematical functions</a>
    including trigonometric functions (even for complex numbers,) <a href="#NumberTheory">factoring and primality testing</a>, and <a href="#AllYourBaseConversions">base conversions</a>.

   </li><li><a href="#Conversions">Unit Conversion</a> between thousands of unit
     types with a <em>huge</em> built-in <a href="https://frinklang.org/frinkdata/units.txt">data
      file</a>.

   </li><li><a href="#DateTimeHandling">Date/time math</a> (add offsets to dates,
    find out intervals between times,) timezone conversions, and
    user-modifiable date formats.

   </li><li><a href="#TextTranslation">Translates</a> between several human
    languages, including English, French, German, Spanish, Portuguese, Dutch,
    Korean, Japanese, Russian, Chinese, Swedish, and Arabic.

   </li><li>Calculates historical buying power of the <a href="#HistoricalUSPriceData">U.S. dollar</a> and <a href="#HistoricalBritishPriceData">British pound</a>.

   </li><li>Calculates <a href="#InternationalExchangeRates">exchange rates</a>
    between most of the world's currencies.

   </li><li>Powerful <a href="#RegularExpressions">regular expression</a>
    capabilities and text processing.

   </li><li>Supports <a href="#UnicodeInFrink">Unicode</a> throughout, allowing
    processing of almost all of the world's languages.

   </li><li>Supports <a href="#IntervalArithmetic">Interval Arithmetic</a> (also
    known as <em>Interval Computations</em>) in calculations, allowing you to
    automagically calculate error bounds and uncertainties in all of your
    calculations.

   </li><li>Reads <a href="#InputAndOutput">HTTP and FTP-based URLs</a> as easily
    as reading local files, allowing fetching of live web-based data.

   </li><li>Runs on most major operating systems (anything with Java 1.1 or later,)
    as an <a href="https://frinklang.org/FrinkApplet.html">applet</a>, through a <a href="https://frinklang.org/fsp/frink.fsp">web-based interface</a>, on <a href="https://frinklang.org/android.html">Android</a>, and on <a href="#SmallDevices">many
     mobile  phones and hand-held devices</a>.

   </li><li>Installs itself on your system in seconds using <a href="#JavaWebStart">Java Web Start</a> and automatically keeps itself
    updated when new versions of Frink are released.

   </li><li>Runs with a <a href="#UserInterfaceOptions">Graphical User
     Interface</a> (Swing, AWT, and <a href="https://frinklang.org/android.html">Android</a>) or a
     command-line interface. 

   </li><li>User interface has a <a href="#ProgrammingMode">Programming Mode</a>
    which allows you to write, edit, save, and run extremely powerful programs
    even on a handheld device.

   </li><li>Frink has a simple but powerful system for drawing <a href="#Graphics">graphics</a> which are resizable, support transparency
    and anti-aliasing, and can be printed or written to image files.  Graphics
    can also have exact lengths, so that a 3-centimeter line is three
    centimeters long when printed.

   </li><li>Powers <a href="https://frinklang.org/fspdocs.html">Frink Server Pages</a>, a system for
    providing dynamic web pages powered by Frink.

   </li><li>Frink is a full-fledged programming language with <a href="#Arrays">arrays</a>, <a href="#Dictionaries">dictionaries</a>,
    <a href="#Sets">sets</a>,
    <a href="#Functions">functions</a>, <a href="#Loops">loops</a>, even
    object-oriented programming and <a href="#SelfEvaluation">self-evaluation</a>.

   </li><li>Frink allows <a href="#ObjectOrientedProgramming">Object-Oriented
     Programming</a>, which allows you to create complex data structures that
    are still easy to use.

   </li><li><a href="#JavaIntrospection">Java Introspection</a> layer allows you to
    call any Java code from within Frink.

   </li><li>Frink can also be <a href="#EmbeddingFrink">embedded in a Java
     program</a>, giving your Java programs all the power of Frink.
  </li></ul>

  <h2><a name="GetNotified">Get Notified</a></h2>
  <p>
   Frink follows a rapid release schedule and is updated often.  That
   doesn't mean that old programs will be invalidated, but that new, useful
   features and optimizations are added all the time.
  </p>

  <p>
   Keep an eye on the <a href="https://frinklang.org/whatsnew.html">What's New</a>
   page to see new features and keep abreast of its developments.
  </p>

  <p>
   While that page is the most detailed and constantly-updated source of
   information about changes in Frink, I also announce new features on
   Twitter at <a href="https://twitter.com/frinklang">@frinklang</a>.  And if
   you want to follow Alan's personal ramblings for some reason, those are at <a href="https://twitter.com/aeliasen">@aeliasen</a>.
  </p>

  <h2><a name="Donate">Donate</a></h2>
  <p>
   If you find Frink useful, there are lots of ways you can <a href="https://frinklang.org/donate.html">donate to its further development.</a> I'd really
   appreciate it!
  </p>

  <!--
  <H2><A NAME="MailingLists">Mailing Lists</A></H2>
  <H3>General Frink list (low-traffic):</H3>
  <P>
   To receive periodic notifications of general interest about
   the Frink language, please join the <A
   HREF="https://groups.yahoo.com/group/frink/" TARGET="_blank"><B>Frink</B>
    mailing list</A>.  (Hosted by Yahoo! Groups.  Link opens in new window.)
   This is a lower-traffic list, mostly for announcements.
  </P>

  <form method="get" action="https://groups.yahoo.com/subscribe/frink"
   TARGET="_blank">
   <table cellspacing="0" cellpadding="2" border="0" bgcolor="#ffffcc"
    SUMMARY="Useless formatting table for Yahoo Groups">
     <tr>
      <th colspan="2" align="center">
       Subscribe to Frink
      </th>
     </tr>
     <tr>
      <td>
       <LABEL FOR="user0">Enter Email Address:</LABEL>
       <input type="text" id="user0" name="user" size="20"
        onFocus="if (value=='enter email address') value='';">
      </td>
      <td>
       <input type="image" alt="Click here to join Frink group at Yahoo"
        name="Click here to join Frink group at Yahoo"
        src="images/joinyahoo.gif">
      </td>
     </tr>
   </table>
  </form>

  <H3>Detailed Frink list (higher-traffic):</H3>
  <P>
    For detailed discussions about particular programs, programming help,
    algorithms, and details of the Frink language, please join the <A
    HREF="https://groups.yahoo.com/group/frink-discuss/"
    TARGET="_blank"><B>Frink-discuss</B> mailing list</A>.  (Hosted by Yahoo! 
    Groups.  Link opens in new window.)  This is the appropriate place for
    posting programming questions and will probably be a higher-traffic list.
  </P>
  
  <form method="get" action="https://groups.yahoo.com/subscribe/frink-discuss"
   TARGET="_blank">
   <table cellspacing="0" cellpadding="2" border="0" bgcolor="#ffffcc"
    SUMMARY="Useless formatting table for Yahoo Groups">
     <tr>
      <th colspan="2" align="center">
       Subscribe to Frink-discuss
      </th>
     </tr>
     <tr>
      <td>
       <LABEL FOR="user1">Enter Email Address:</LABEL>
       <input type="text" id="user1" name="user" size="20"
        onFocus="if (value=='enter email address') value='';">
      </td>
      <td>
       <input type="image" alt="Click here to join Frink-discuss group at Yahoo"
        name="Click here to join Frink-discuss group at Yahoo"
        src="images/joinyahoo.gif">
      </td>
     </tr>
   </table>
  </form>

  <H3><A NAME="FrinkScience">OoooOoo Frink Science:</A></H3>
  <P>
   This list is intended to discuss problems in math, science, and
   physics and explore solutions using the Frink language.<BR>

   <A
   HREF="https://groups.yahoo.com/group/FrinkScience/" TARGET="_blank"><B>Frink
    Science</B> mailing list</A>.  (Hosted by Yahoo! Groups.  Link opens in
   new window.) 
  </P>

  <form method="get" action="https://groups.yahoo.com/subscribe/FrinkScience"
   TARGET="_blank">
   <table cellspacing="0" cellpadding="2" border="0" bgcolor="#ffffcc"
    SUMMARY="Useless formatting table for Yahoo Groups">
     <tr>
      <th colspan="2" align="center">
       Subscribe to FrinkScience
      </th>
     </tr>
     <tr>
      <td>
       <LABEL FOR="user2">Enter Email Address:</LABEL>
       <input type="text" id="user2" name="user" size="20"
        onFocus="if (value=='enter email address') value='';">
      </td>
      <td>
       <input type="image" alt="Click here to join FrinkScience group at Yahoo"
        name="Click here to join FrinkScinece group at Yahoo"
        src="images/joinyahoo.gif">
      </td>
     </tr>
   </table>
  </form>
  -->
  
  <h2><a name="PresentationsAndPapers">Presentations and Papers</a></h2>
  <p>
   You can read (and watch using RealPlayer) my presentation <a href="https://frinklang.org/LL4.html" target="_blank"><i>Frink -- A Language for Understanding the
   Physical World</i></a> that I gave on Frink at the Lightweight Languages 4
   conference at MIT.  This discusses some of the design decisions of Frink,
   how it has evolved, implementation details, and future directions for the
   language.
  </p>
  
  <!--TOC begin-->
  <h2>Table of Contents</h2>

  <ul>
   <li><a href="#AboutFrink">About Frink</a>
   </li><li><a href="#Features">Features</a>
   </li><li><a href="#GetNotified">Get Notified</a>
   <!-- <LI CLASS="dense"><A HREF="#MailingLists">Mailing Lists</A> -->
    
   </li><li>Using Frink
    <ul>
     <li><a href="#TryAsYouRead">Try as you read</a>
     </li><li><a href="#JavaWebStart">Download Using Java Web Start</a>
     </li><li><a href="#UserInterfaceOptions">User Interface Options</a>
      <ul>
       <li><a href="#SwingUserInterface">Swing User Interface</a>
       </li><li><a href="#AWTUserInterface">AWT User Interface</a>
      </li></ul>
     </li><li><a href="#FrinkAsAnApplet">Frink As An Applet</a>
     </li><li><a href="#WebInterface">Web Interface</a>
    </li></ul>
   </li><li><a href="#DownloadingFrink">Downloading Frink</a>
    <ul>
     <li><a href="#SmallDevices">Small Devices</a>
    </li></ul>
   </li><li><a href="#ExperimentalVersions">Experimental Versions</a>
   </li><li><a href="#ProgrammingMode">Programming Mode</a>
   </li><li><a href="#RunningFrink">Running Frink</a>
    <ul>
     <li><a href="#CommandLineOptions">Command-Line Options</a>
     </li><li><a href="#HandlingCommandLineArguments">Handling Command-Line Arguments</a>
     </li><li><a href="#GUIOptions">GUI Options</a>
     </li><li><a href="#PerformanceTips">Performance Tips</a>
     </li><li><a href="#ProxyConfiguration">Proxy Configuration</a>
    </li></ul>
   </li><li><a href="#HowFrinkIsDifferent">How Frink is Different</a>
   </li><li><a href="#NumericTypes">Numeric Types</a>
   </li><li><a href="#DataLibraries">Data Libraries</a>
   </li><li><a href="#IntegratedHelp">Integrated Help</a>
   </li><li><a href="#EditingFrink">Editing Frink</a>
   </li><li><a href="#Conversions">Conversions</a>
    <ul>
     <li><a href="#MultipleConversions">Multiple Conversions</a>
    </li></ul>
   </li><li><a href="#MathOperators">Math Operators</a>
    <ul>
        <li><a href="#Factorials">Factorials</a>
    </li></ul>
   </li><li><a href="#Variables">Variables</a>
    <ul>
     <li><a href="#DeclaringVariables">Declaring Variables</a>
     </li><li><a href="#ConstraintsOnVariables">Constraints on
       Variables</a>
      <ul>
       <li><a href="#ConstrainingByDimensions">Constraining by Dimensions</a>
       </li><li><a href="#ConstrainingToBuiltInTypes">Constraining to
         Built-in Types</a>
       </li><li><a href="#ConstrainingByObjectType">Constraining by
         Object Type</a>
       </li><li><a href="#ConstraintFunctions">Constraint Functions</a>
      </li></ul>
     </li><li><a href="#TestingVariables">Testing Variables</a>
     </li><li><a href="#GlobalVariables">Global Variables</a>
    </li></ul>
    <ul>
     <li><a href="#UnicodeInFrink">Unicode in Frink</a>
    </li></ul>
   </li><li><a href="#SettingDisplayUnits">Setting Display Units</a>
   </li><li><a href="#SettingPrecision">Setting Precision</a>
   </li><li><a href="#SettingNumberFormats">Setting Number Formats</a>
   </li><li><a href="#Comments">Comments</a>
   </li><li><a href="#Functions">Functions</a>
    <ul>
     <li><a href="#MultiLineFunctions">Multi-line Functions</a>
     </li><li><a href="#DefaultValues">Default Values</a>
     </li><li><a href="#MultipleReturnValues">Multiple Return Values</a>
     </li><li><a href="#RecursiveFunctions">Recursive Functions</a>
     </li><li><a href="#ConstrainingFunctionArguments">Constraining Function Arguments</a>
    </li></ul>
   </li><li><a href="#IfThenElse">If/Then/Else</a>
   </li><li><a href="#Truth">Truth</a>
   </li><li><a href="#Loops">Loops</a>
    <ul>
     <li><a href="#WhileLoop">While Loop</a>
     </li><li><a href="#UntilLoop">Until Loop</a>
     </li><li><a href="#DoWhileLoop">Do...While Loop</a>
     </li><li><a href="#DoUntilLoop">Do...Until Loop</a>
     </li><li><a href="#ForLoop">For Loop</a>
     </li><li><a href="#MultiforLoop">Multifor Loop</a>
     </li><li><a href="#GrayCodes">Gray Codes</a>
    </li></ul>
   </li><li><a href="#SelfEvaluation">Self-Evaluation</a>
    <ul>
     <li><a href="#SecurityRestrictionsOnEval">Security Restrictions on eval[]</a>
    </li></ul>
   </li><li><a href="#Arrays">Arrays</a>
    <ul>
     <li><a href="#InitializingArrays">Initializing Arrays</a>
     </li><li><a href="#ArrayMethods">Array Methods</a>
      <ul>
       <li><a href="#Copying">Copying</a>
       </li><li><a href="#PushingAndPopping">Pushing and Popping</a>
       </li><li><a href="#Dimensions">Dimensions</a>
       </li><li><a href="#ColumnOperations">Column Operations</a>
       </li><li><a href="#Concatenating">Concatenating</a>
       </li><li><a href="#InsertingAndRemoving">Inserting and Removing</a>
       </li><li><a href="#SearchingArrays">Searching Arrays</a>
       </li><li><a href="#Permutations">Permutations</a>
       </li><li><a href="#Combinations">Combinations</a>
       </li><li><a href="#SlicingArrays">Slicing Arrays</a>
       </li><li><a href="#Flattening">Flattening</a>
       </li><li><a href="#Subsets">Subsets</a>
       </li><li><a href="#Shuffling">Shuffling</a>
       </li><li><a href="#Clearing">Clearing</a>
       </li><li><a href="#Transpose">Transpose</a>
       </li><li><a href="#AdditionalArrayFunctions">Additional Array Functions</a>
      </li></ul>
    </li></ul>
   </li><li><a href="#EnumeratingExpressions">Enumerating Expressions</a>
    <ul>
     <li><a href="#EnumeratingExpressionFunctions">Enumerating Expression Functions</a>
    </li></ul>
   </li><li><a href="#OrderedList">OrderedList</a>
    <ul>
     <li><a href="#InitializingOrderedList">Initializing OrderedList</a>
     </li><li><a href="#OrderedListMethods">OrderedList Methods</a>
    </li></ul>
   </li><li><a href="#RingBuffer">RingBuffer</a>
    <ul>
     <li><a href="#RingBufferMethods">RingBuffer Methods</a>
    </li></ul>
   </li><li><a href="#Input">Input</a>
    <ul>
     <li><a href="#MultiInput">Multi-Input</a>
     </li><li><a href="#MakingInteractiveInterfaces">Making Interactive Interfaces</a>
    </li></ul>
   </li><li><a href="#Output">Output</a>
   </li><li><a href="#BooleanOperators">Boolean Operators</a>
   </li><li><a href="#ThreeWayComparison">Three-Way Comparison</a>
   </li><li><a href="#Dictionaries">Dictionaries</a>
    <ul>
     <li><a href="#DictionaryConstructors">Dictionary Constructors</a>
     </li><li><a href="#DictionaryMethods">Dictionary Methods</a>
    </li></ul>
   </li><li><a href="#Sets">Sets</a>
    <ul>
     <li><a href="#SetFunctions">Set Functions</a>
    </li></ul>
   </li><li><a href="#CommonFunctions">Common Functions</a>
    <ul>
     <li><a href="#FormattingFunctions">Formatting Functions</a>
     </li><li><a href="#FormattingTables">Formatting Tables</a>
     </li><li><a href="#RoundingFunctions">Rounding Functions</a>
     </li><li><a href="#NumberTheory">Number Theory</a>
     </li><li><a href="#OtherFunctions">Other Functions</a>
     </li><li><a href="#FourierTransforms">Fourier Transforms</a>
     </li><li><a href="#CryptographicFunctions">Cryptographic Functions</a>      
     </li><li><a href="#AllYourBaseConversions">All Your Base Conversions...</a>
      <ul>
       <li><a href="#CustomBaseConversions">Custom Base Conversions</a>
       </li><li><a href="#CustomBaseConversionExamples">Custom Base Conversion Examples</a>
        <ul>
         <li><a href="#Devanagari">Devanagari</a>
         </li><li><a href="#UnicodeSuperscripts">Unicode Superscripts</a>
         </li><li><a href="#UnicodeSubscripts">Unicode Subscripts</a>
        </li></ul>
      </li></ul>
    </li></ul>
   </li><li><a href="#UnicodeOperators">Unicode Operators</a>
   </li><li><a href="#Strings">Strings</a>
    <ul>
     <li><a href="#UnicodeInStrings">Unicode in Strings</a>
     </li><li><a href="#UnicodeCharacterCodes">Unicode Character Codes</a>
     </li><li><a href="#CorrectStringParsing">Correct String
       Parsing</a>
      <ul>
       <li><a href="#LanguageSpecifiers">Language Specifiers</a>
      </li></ul>
     </li><li><a href="#UpperLowerCase">Upper/Lower Case</a>
     </li><li><a href="#Substrings">Substrings</a>
     </li><li><a href="#OtherStringFunctions">Other String Functions</a>
     </li><li><a href="#UnicodeProperties">Unicode Properties</a>
     </li><li><a href="#MultiLineStrings">Multi-Line Strings</a>
     </li><li><a href="#StringInterpolation">String Interpolation</a>
    </li></ul>
   </li><li><a href="#TextTranslation">Text Translation</a>
    <ul>
     <li><a href="#TranslationPairs">Translation Pairs</a>
     </li><li><a href="#TranslatorProgram">Translator Program</a>
    </li></ul>
   </li><li><a href="#ParsingJSON">Parsing JSON</a>
    <ul>
     <li><a href="#Bitcoin">Bitcoin</a>
    </li></ul>
   </li><li><a href="#DateTimeHandling">Date/Time Handling</a>
    <ul>
     <li><a href="#SpecifyingTimezones">Specifying Timezones</a>
      <ul>
       <li><a href="#CustomTimezones">Custom Timezones</a>
       </li><li><a href="#TimezoneWarning">Timezone Warning</a>
      </li></ul>
     </li><li><a href="#ListingTimezones">Listing Timezones</a>
      <!--
     <LI CLASS="dense"><A HREF="#SettingDefaultTimezone">Setting Default
Timezone</A>
      -->
     </li><li><a href="#SloppyTimeSpecifications">Sloppy Time Specifications</a>
     </li><li><a href="#CurrentTime">Current Time</a>
     </li><li><a href="#TimezoneConversions">Timezone Conversions</a>
     </li><li><a href="#DateTimeArithmetic">Date/Time Arithmetic</a>
     </li><li><a href="#CalendarFunctions">Calendar Functions</a>
     </li><li><a href="#NotesOnDates">Notes on Dates</a>
    </li></ul>
   </li><li><a href="#DefiningNewDateTimeFormats">Defining New Date/Time Formats</a>
    <ul>
     <li><a href="#OtherDateFormats">Other Date Formats</a>
     </li><li><a href="#DynamicalTime">Dynamical Time</a>
     </li><li><a href="#InternationalAtomicTime">International Atomic
       Time (TAI)</a>
     </li><li><a href="#LeapSeconds">Leap Seconds</a>
     </li><li><a href="#OtherTimeSystems">Other Time Systems</a>
    </li></ul>
   </li><li><a href="#RegularExpressions">Regular Expressions</a>
    <ul>
     <li><a href="#RegularExpressionReference">Regular
       Expression Reference</a>
      <ul>
        <li><a href="#BasicPatternsAndMetacharacters">Basic Patterns and
         Metacharacters</a>
       </li><li><a href="#SpecialCharacterClasses">Special Character Classes</a>
       </li><li><a href="#UnicodeCharacterClasses">Unicode Character Classes</a>
       </li><li><a href="#Quantifiers">Quantifiers</a>
       </li><li><a href="#PatternMatchModifiers">Pattern Match Modifiers</a>
      </li></ul>
       </li><li><a href="#IteratingMatches">Iterating Matches</a>
    </li></ul>
   </li><li><a href="#SearchAndReplace">Search and Replace</a>
    <ul>
     <li><a href="#SubstitutionWithExpressions">Substitution with Expressions</a>
    </li></ul>
   </li><li><a href="#InputAndOutput">Input and Output</a>
    <ul>
     <li><a href="#ReadingLines">Reading Lines</a>
     </li><li><a href="#ReadingEntireFiles">Reading Entire Files</a>
     </li><li><a href="#SpecifyingAlternateEncodings">Specifying Alternate Encodings</a>
     </li><li><a href="#WritingFiles">Writing Files</a>
     </li><li><a href="#WriterConstructors">Writer Constructors</a>
     </li><li><a href="#WriterMethods">Writer Methods</a>
     </li><li><a href="#CompressingDecompressingFiles">Compressing/Decompressing Files</a>
     </li><li><a href="#EmailHarvesting">E-mail Harvesting</a>
     </li><li><a href="#StrippingHTML">Stripping HTML</a>
     </li><li><a href="#URLManipulation">URL Manipulation</a>
     </li><li><a href="#IOFunctions">I/O Functions</a>
    </li></ul>
   </li><li><a href="#AnonymousFunctions">Anonymous Functions</a>
   </li><li><a href="#Sorting">Sorting</a>
    <ul>
     <li><a href="#LexicalSorting">Lexical Sorting</a>
    </li></ul>
   </li><li><a href="#ListComprehensions">List Comprehensions</a>
    <ul>
     <li><a href="#select">select</a>
     </li><li><a href="#remove">remove</a>
     </li><li><a href="#map">map</a>
     </li><li><a href="#split">split</a>
     </li><li><a href="#join">join</a>
     </li><li><a href="#joinln">joinln</a>
     </li><li><a href="#zip">zip</a>
     </li><li><a href="#unzip">unzip</a>
    </li></ul>
   </li><li><a href="#IncludingOtherFiles">Including Other Files</a>
   </li><li><a href="#ObjectOrientedProgramming">Object-Oriented
     Programming</a>
   </li><li><a href="#TryFinally">Try/Finally</a>
   </li><li><a href="#Formatters">Formatters</a>
    <ul>
     <li><a href="#InputForm">InputForm</a>
     </li><li><a href="#InputFormUnicode">InputFormUnicode</a>
    </li></ul>
   </li><li><a href="#Graphics">Graphics</a>
    <ul>
     <li><a href="#IntroductionToGraphics">Introduction to
       Graphics</a>
     </li><li><a href="#Coordinates">Coordinates</a>
     </li><li><a href="#ShapesAndColors">Shapes and Colors</a>
     </li><li><a href="#AdvancedShapes">Advanced Shapes</a>
      <ul>
       <li><a href="#PolygonsAndPolylines">Polygons and Polylines</a>
       </li><li><a href="#PolygonMethods">Polygon Methods</a>
      </li></ul>
     </li><li><a href="#GraphicsWithText">Graphics with Text</a>
     </li><li><a href="#ComposingGraphics">Composing Graphics</a>
     </li><li><a href="#TransformingGraphics">Transforming Graphics</a>
     </li><li><a href="#ClippingGraphics">Clipping Graphics</a>
     </li><li><a href="#ConstrainingViewport">Constraining Viewport</a>
     </li><li><a href="#Antialiasing">Antialiasing</a>
     </li><li><a href="#ShowingGraphics">Showing Graphics</a>
     </li><li><a href="#GraphicsFunctions">Graphics Functions</a>
     </li><li><a href="#Images">Images</a>
      <ul>
       <li><a href="#ImageMethods">Image Methods</a>
       </li><li><a href="#DrawingImagesIntoGraphics">Drawing images into graphics</a>
      </li></ul>
     </li><li><a href="#Animation">Animation</a>
     </li><li><a href="#SampleGraphicsPrograms">Sample Graphics Programs</a>
    </li></ul>
   </li><li><a href="#TemperatureScales">Temperature Scales</a>
   </li><li><a href="#OtherDataSources">Other Data Sources</a>
    <ul>
     <li><a href="#HistoricalUSPriceData">Historical U.S. Price Data</a>
     </li><li><a href="#HistoricalBritishPriceData">Historical British Price Data</a>
     </li><li><a href="#InternationalExchangeRates">International Exchange Rates</a>
    </li></ul>
   </li><li><a href="#IntervalArithmetic">Interval Arithmetic</a>
    <ul>
     <li><a href="#IntervalArithmeticExample">Interval Arithmetic Example</a>
     </li><li><a href="#IntervalComparisonOperators">Interval Comparison Operators</a>
     </li><li><a href="#IntervalArithmeticStatus">Interval Arithmetic
       Status</a>
     </li><li><a href="#DateTimeIntervals">Date/Time Intervals</a>
    </li></ul>
   </li><li><a href="#JavaIntrospection">Java Introspection</a>
    <ul>
     <li><a href="#CreatingJavaObjects">Creating Java Objects</a>
     </li><li><a href="#CallingStaticJavaMethods">Calling Static Java Methods</a>
     </li><li><a href="#AccessingStaticJavaFields">Accessing Static Java Fields</a>
     </li><li><a href="#CallingFunctionsAndMethodsByName">Calling
       Functions and Methods by Name</a>      
     </li><li><a href="#IteratingOverJavaCollections">Iterating Over
      Java Collections</a>      
    </li></ul>
   </li><li><a href="#EmbeddingFrink">Embedding Frink</a>
   </li><li><a href="#SampleCalculations">Sample Calculations</a>
    <ul>
     <li><a href="#MassAndVolume">Mass and Volume</a>
     </li><li><a href="#Liquor">Liquor</a>
     </li><li><a href="#MoreLiquor">More Liquor</a>
     </li><li><a href="#MovieMagic">Movie Magic</a>
     </li><li><a href="#FiscalCalculations">Fiscal Calculations</a>
     </li><li><a href="#Ouch">Ouch!</a>
     </li><li><a href="#SnipingEBayAuctions">Sniping eBay Auctions</a>
     </li><li><a href="#JunkyardWars">Junkyard Wars</a>
     </li><li><a href="#BodyHeat">Body Heat</a>
     </li><li><a href="#MicrowaveCookery">Microwave Cookery</a>
     </li><li><a href="#Superman">Why is Superman so Lazy?</a>
     </li><li><a href="#FartJokes">Fart Jokes</a>
     </li><li><a href="#AdvancedFarting">Advanced Farting</a>
     </li><li><a href="#MoreIncorrectFacts">More Incorrect Facts</a>
      <ul>
       <li><a href="#QE2">QE2</a>
       </li><li><a href="#HamburgersAndCars">Hamburgers and Cars</a>
       </li><li><a href="#GetTheProvisions">"Get The Provisions..."</a>
       </li><li><a href="#Typing">Typing</a>
      </li></ul>
     </li><li><a href="#BiblicalReferences">Biblical References</a>
     </li><li><a href="#Emc2">E=mc<sup>2</sup></a>
     </li><li><a href="#DaysOld">Days Old</a>
     </li><li><a href="#ModelSolarSystem">Model Solar System</a>
     </li><li><a href="#MCO">Saving Hundreds of Millions of Dollars</a>
    </li></ul>
   </li><li><a href="#ChangingSyntax">Changing Syntax</a>
   </li><li><a href="#Acknowledgements">Acknowledgements</a>
   </li><li><a href="#DonateToFrink">Donate to Frink</a>
  </li></ul>
  <!--TOC end-->

  <h2>Using Frink</h2>
  <h3><a name="TryAsYouRead">Try as you read</a></h3>
  <p>
   If you want to try the calculations as you're reading,
   <a href="https://frinklang.org/fsp/frink.fsp" target="_blank">click here to open the web-based
    interface in a new window.</a>  The web-based interface gives hints for
   new users, which may make it the easiest way to learn how to use Frink.
  </p>
  
  <p>
   If you have a frames-enabled browser, and you don't see a Frink sidebar to
   the left, you can also <a href="https://frinklang.org/frinkframe.html">click here to try Frink in
    a sidebar</a> as you read this.  (The sidebar mode doesn't give as many
   hints, though.)
  </p>

  <h3><a name="JavaWebStart">Download using Java Web Start</a></h3>
  <p>
   <b>Quick Start:</b> On many platforms, if you already have Java installed,
   you can start Frink in the GUI mode by simply downloading and
   double-clicking the <a href="https://frinklang.org/frinkjar/frink.jar"><code>frink.jar</code></a> file.  For more
   startup options, see the <a href="#DownloadingFrink">Downloading Frink</a>
   section.
  </p>

  <p>
   Another method of installation requires Java Web Start, which is installed
   with most versions of Java.  Using Java Web Start <del>is</del> used to
   be a great way to run Frink if you don't need to run programs from the
   command-line.  (But you <em>can</em> still write and run programs from the
   GUI using Java Web Start!)  If you do want to run programs from the
   command-line, see the <a href="#DownloadingFrink">Downloading Frink</a>
   section below.  Java Web Start will allow you to automatically get the
   latest version of Frink and will update Frink automatically when new
   versions are available.
  </p>

  <h4>Installation Steps</h4>
  <ol>
   <li>If you <em>don't</em> have a recent version of Java, you can <a target="_blank" href="https://java.com/">get it from Sun.</a>
    (Link opens in new window.)
     
   </li><li>(<i>Optional</i>) If you've never installed anything with Java Web
   Start, please read and understand the <a target="_blank" href="https://frinklang.org/faq.html#AboutSecurityWarnings">FAQ entry about the security warnings
   you'll see</a> (link opens in new window) and your alternate download
    options.

   </li><li><b>Warning:</b>  Most major browsers have now disallowed Java plugins to
    run in the browser.  However, if you have a Java Virtual Machine
    installed, you probably still have Java Web Start installed, which you
    need to invoke from the command-line with the command
    <code>javaws</code>.  In Fedora, you can make sure this is installed by
    installing the <code>icedtea-web</code> package from your package manager,
    <i>e.g.</i> as root, typing <code>dnf install icedtea-web</code> and then
    one of the commands below.  In Debian-like environments, you may install
    this by installing the <code>icedtea-netx</code> package, <i>e.g.</i> as
    root, typing <code>apt-get install icedtea-netx</code> and then one of the
    commands below.

   </li><li><b>Warning:</b> If you're using Java version 7u51 or later, they
    silently and incompatibly decided to change default security settings so
    you'll need to open the Java Control Panel to allow Frink to run.
    Otherwise you will see a dialog that says something like "Application
    blocked by security settings" or "Your security settings have blocked a
    self-signed application from running."  (This silent change was made after
    12+ years of the aforementioned method working fine.)
    <p>
     The best way to allow Frink to run is to follow the instructions <a href="https://blogs.oracle.com/java-platform-group/entry/upcoming_exception_site_list_in" target="_blank">listed here</a> and add <code>http://futureboy.us</code>
     to the exceptions list in step 7.
     
     </p><p><b>Note:</b> As always, Java's instructions and installer are
     terrible, and the Java Control panel on Windows may actually be under
     your Start menu as <code>Java</code> | <code>Configure Java</code>, or
     under your Windows Control Panel, or if you start your Control Panel and
     don't see it, Java's control panel will be hidden under "32-bit Control
     Panel."  And sometimes you'll have multiple versions of Java installed
     and the one that gets started isn't the latest version. I had
     <em>lots</em> of problems until I manually uninstalled <em>all</em> the
     versions of Java on the Windows machine, reinstalled the latest version,
     and uninstalled Frink and reinstalled it.  Sorry about that.  Windows and
     Java integration is terrible.  (The <code>icedtea-web</code> package for
     Fedora and other installations contains a vastly better implementation of
     Java Web Start.)

   </p></li><li>Click one of the options below to install Frink: (see the screenshots below):
    <ul>
     <li><a href="https://frinklang.org/frinkjar/frink.jnlp">Swing Interface</a>
      Prettier.  Requires Java 1.5.0 or later.
      <p>
       <b>Note:</b> If your browser no longer supports Java in the browser,
       you can probably install this from the command-line by typing:
      </p>

      <p>
       <code>javaws https://futureboy.us/frinkjar/frink.jnlp</code>
      </p>
      
     </li><li><a href="https://frinklang.org/frinkjar/frinkwithlibs.jnlp">Swing Interface with standard
       libraries</a>.  This is a version of Frink that contains a variety of <a href="https://frinklang.org/fsp/frinklibs.fsp">standard libraries</a> and useful programs.
      It's a larger download, but the standard libraries change somewhat
      infrequently and should only get downloaded when changes are made.

      <p>
       <b>Note:</b> If your browser no longer supports Java in the browser,
       you can probably install this from the command-line by typing:
      </p>

      <p>
       <code>javaws https://futureboy.us/frinkjar/frinkwithlibs.jnlp</code>
      </p>

      
     </li><li><a href="https://frinklang.org/frinkjar/frinkawt.jnlp">AWT Interface</a> -
      Not as pretty as the Swing mode, but will run on older JVMs.
      <p>
       <b>Note:</b> If your browser no longer supports Java in the browser,
       you can probably install this from the command-line by typing:
      </p>

      <p>
       <code>javaws https://futureboy.us/frinkjar/frinkawt.jnlp</code>
      </p>
    </li></ul>
  </li></ol>

  <p>
   If you've read those <a target="_blank" href="https://frinklang.org/faq.html#AboutSecurityWarnings">security notes</a>, and understood
   what the security messages are telling you, and the warnings are still too
   scary, (and you don't want to send me the $400 per year it would cost me to
   remove at least one of them,) and you'd rather download a limited version
   of Frink that runs in the most restrictive security sandbox (breaking some
   features), then <a href="https://frinklang.org/frinkjar/frinklimited.jnlp">click here to install
   a limited version of Frink.</a> Again, please read those <a target="_blank" href="https://frinklang.org/faq.html#AboutSecurityWarnings">security notes</a> to see what
   features will be unavailable if you choose this option.  You can always get
   the full version of Frink later if you need those features.
  </p>

  <p>
   If someone wants to send me the $400 necessary to get a VeriSign "Code
   Signing Cerificate", I'll sign it just for you.  It won't work any
   differently.)
  </p>

  <p>
   If you have an old version of Java Web Start, Frink will probably show up
   in the "Downloaded Applications" section of the Java Web Start panel which
   isn't immediately visible.  Use the <code>View</code> menu option to select
   the Downloaded Applications tab.  It will also let you create a Frink
   shortcut on your desktop or in your start menu.  The defaults in Java Web
   Start before version 1.4.2 are set oddly so that the <em>second</em> time
   you run Frink, it will ask you if you want to make a shortcut.
  </p>

  <p>
   If you're using Linux, and Sun's Java release, only Java version 1.5 beta
   and later will install shortcuts onto your desktop and start menu.  Highly
   recommended.
  </p>
  
  <h2><a name="UserInterfaceOptions">User Interface Options</a></h2>
  
  <h3><a name="SwingUserInterface">Swing User Interface</a></h3>
  
  <p>
   The Swing version allows mixed fonts and colors.  Due to some performance
   bugs in Sun's Swing implementation (like large paragraphs taking several
   minutes to paint every time you resize or scroll,) it can be problematic.
   As of 2008-08-25, the capabilities of the Swing and AWT interfaces are
   about the same.
  </p>
  
  <p>
   <img src="https://frinklang.org/images/swing.png" width="500" height="400" alt="Swing GUI Screenshot">
  </p>
  
  <h3><a name="AWTUserInterface">AWT User Interface</a></h3>

  <p>
   The AWT user interface has several modes.  The two-line conversion mode and
   <a href="#ProgrammingMode">programming mode</a> are shown below.  Small
   devices usually can't run Swing, but all Java platforms should be able to
   run AWT.
  </p>
  
  <p>
   <img src="https://frinklang.org/images/awtconvert.png" width="500" height="400" alt="AWT Two-line conversion screenshot">
  </p>

  <p>
   <img src="https://frinklang.org/images/awtprogram.png" width="500" height="400" alt="AWT Programming Mode screenshot">
  </p>


  <h3><a name="FrinkAsAnApplet">Frink As An Applet</a></h3>
  <p>
   If your web browser supports Java 1.3.1 or later, try the <a href="https://frinklang.org/FrinkApplet.html">Java Applet-based interface</a>.  It looks and
   works just like the GUI above, but it requires you to be connected to the
   internet and must download for each session.

   Your browser must support Java 1.3.1 or later, or you will need to get <a target="_blank" href="https://java.com/">download a newer version of Java
    from Sun.</a>  It is extremely highly recommended that you have Java 1.5.0
   update 2 or later.  This has been tested with Internet Explorer, Netscape
   4.x, Netscape 6+, Mozilla (Windows and Linux), and Opera.
  </p>

  <p>
   If you don't have a recent version of Java, you can <a target="_blank" href="https://java.com/">get it from Sun.</a> (Link opens in
   new window.)
  </p>
  
  <p>
   (The certificate is just signed by me, so you'll get a warning.
   Network access is necessary to use the network portions of Frink... like
   currency calculations, translations, etc.  If you deny network access, the
   non-network parts of Frink will work just fine.  If someone wants to send
   me the $400 necessary to get a VeriSign "Code Signing Cerificate", I'll
   sign it just for you.  It won't work any differently.)
  </p>
  
  <h3><a name="WebInterface">Web Interface</a></h3>
  <p>
   If the applet doesn't work for you, try the
   <a href="https://frinklang.org/fsp/frink.fsp">web interface.</a>
   It should allow you to use the latest version of the Frink engine.  It is
   now powered by <a href="https://frinklang.org/fspdocs.html">Frink Server Pages</a>.
  </p>

  <p>
   In this web interface, you can enter any Frink expression in the "From:"
   box.  If you also enter a value in the "To:" box, it is treated as the
   right-hand side of a conversion expression (that is, to the right of the
   conversion operator <code>-&gt;</code> )
  </p>

  <p>
   Thus, to convert 10 meters to feet, you can enter
   <code>10&nbsp;meters</code> in the "From" box and
   <code>feet</code> in the "To" box, or, equivalently, type
   <code>10&nbsp;meters&nbsp;-&gt;&nbsp;feet</code> in the
   "From" box and leave the "To" box empty.  It does exactly the same thing.
  </p>


  <h2><a name="DownloadingFrink">Downloading Frink</a></h2>
  <p>
   <b>Quick Start:</b> On many platforms, if you already have Java installed,
   you can start Frink in the GUI mode by simply downloading and
   double-clicking the <a href="https://frinklang.org/frinkjar/frink.jar"><code>frink.jar</code></a> file.
  </p>
  
  <p>
   If you're just using Frink for interactive calculations, or are happy using
   the built-in programming mode and you're not writing running programs from
   the command-line, see the 
   <a href="#JavaWebStart">Java Web Start</a> section above.
  </p>

  <p>
   (If you're looking for an installer for handheld devices, like Android, see
   the <a href="#SmallDevices">Small Devices</a> section below.)
  </p>

  <p>
   If you want to write full Frink programs <em>and</em> run them from
   the commmand-line, you will need to get your own copy of Frink, and
   have a Java 1.1 or later runtime environment on your machine,
   1.4.2+ is recommended as it's less buggy.  The date calculations in
   anything before Java 1.3 are rather bad,) you may download the
   latest executable <code>jar</code> file.  (Note that this changes
   almost daily as I do more work, so download often.)
  </p>

  <p>
   Otherwise, here are the steps to downloading Frink:
  </p>

  <ul>
   <li>
    If you don't have a recent version of Java, you can <a target="_blank" href="https://java.com/">get it from Sun.</a> (Link opens in
    new window.)

   </li><li><a href="https://frinklang.org/frinkjar/frink.jar">Download frink.jar</a>.

   </li><li>(Double-clicking the file you just downloaded might start Frink in GUI
    mode, depending on your operating system.  If that's not enough, read on.)

   </li><li>
    See the <a href="#RunningFrink">Running Frink</a> section below for
    directions for starting full Frink programs, running from the
    command-line, etc. 
  </li></ul>


  <h2><a name="RunningFrink">Running Frink</a></h2>
  <p>
   <b>Quick Start:</b> On many platforms, if you already have Java installed,
   you can start Frink in the GUI mode by simply downloading and
   double-clicking the <a href="https://frinklang.org/frinkjar/frink.jar"><code>frink.jar</code></a> file.
  </p>

  <p>If you want to run Frink in command-line mode, here are a couple of
   sample scripts you can use to start Frink.  <em>You will need to edit them
    to match the paths on your system!</em>
  </p>

  <ul>
   <li>(Windows batch file) <b><a href="https://frinklang.org/frinkjar/frink.bat">frink.bat</a></b>
   </li><li>(Linux/Unix shell script) <b><a href="https://frinklang.org/frinkjar/frink">frink</a></b>
  </li></ul>

  <p>
   (Note that the Linux/Unix shell script above has the option to run with
   the <code>rlwrap</code> program, which gives you the ability to use the
   up/down arrows to repeat and edit calculations, and even perform unit and
   function completion!  See the instructions inside that file for configuring
   rlwrap, and downloading the optional associated
   files:   <a href="https://frinklang.org/frinkjar/unitnames.txt">unitnames.txt</a> and <a href="https://frinklang.org/frinkjar/functionnames.txt">functionnames.txt</a>)
  </p>

  <p>
   In the samples below, you may need to replace <code>java</code> or
   <code>javaw</code> with the full path to your Java Virtual Machine,
   whatever that may be.  Note that <code>javaw</code> is a Windows-only
   command that simply starts Java without opening a console window.  You'll
   probably replace this with <code>java</code> on other platforms.
  </p>

  <p>
   The most general way to start Frink is to launch the
   <code>frink.gui.FrinkStarter</code> class:
  </p>
   
  <p>
   <code>java -cp frink.jar frink.gui.FrinkStarter
    <i>[options]</i></code>
  </p>

  <p>
   (The above starter scripts use this class.  Look at them first.)  By
   default, this starts in text mode but allows many command-line options to
   start in different modes:
  </p>
  
  <table summary="FrinkStarter options">
    <tbody><tr><th>Switch</th><th>Description
    </th></tr><tr><td>--swing</td><td>Starts in Swing GUI mode
    </td></tr><tr><td>--gui</td><td>Starts in Swing GUI mode
    </td></tr><tr><td>--awt</td><td>Starts in AWT GUI mode
    </td></tr><tr><td>--fullscreen</td><td>Starts fullscreen
    </td></tr><tr><td>--prog</td><td>Starts in programming mode with a blank program
      
    </td></tr><tr><td>-open <i>filename</i></td><td>Starts the specified filename
      in programming mode (this option is passed by double-clicking a file in
      Windows if you have file associations set up.)
    </td></tr><tr><td>-1</td><td>Starts Frink in Swing mode, using the one-line
      input mode (default is two-line input mode).  This is similar to
      starting Frink and choosing the menu item <b>Mode | One-Line</b> or
      hitting <code>Ctrl-1</code>.
    </td></tr><tr><td>-3</td><td>Starts Frink in Swing mode, using the multi-line
      input mode (default is two-line input mode.)  This is similar to
      starting Frink and choosing the menu item <b>Mode | Multi-Line</b> or
      hitting <code>Ctrl-3</code>.
  </td></tr></tbody></table>

  <p>
   Other start options are listed below, if you want to use them.  I'd suggest
   using one of the scripts above and modifying it.
  </p>
   
  <p>
   To run the jar file in text mode (only), use: <br>
   <code>java -cp frink.jar frink.parser.Frink <i>[options]</i></code>
  </p>

  <p>
   To run the jar file with the Swing GUI, (shown above under
   <a href="#JavaWebStart">Java Web Start</a>,) use: <br>
   <code>javaw -cp frink.jar frink.gui.SwingInteractivePanel <i>[options]</i></code>
  </p>

  <p>
   The Swing GUI is the default action for the jar file, so this is the same as
   saying:<br>
    <code>javaw -jar frink.jar <i>[options]</i></code>
  </p>
  
  <p>
   To run the jar file with the AWT GUI, which gives access to several modes,
   including programming mode, use: <br>
   <code>javaw -cp frink.jar frink.gui.InteractivePanel
    <i>[options]</i></code>
  </p>

  <p>
   To run the jar file and start the AWT GUI in programming mode, use: <br>
   <code>javaw -cp frink.jar frink.gui.ProgrammingPanel
    <i>[filename]</i></code>
  </p>

  <p>
   To run the jar file and start the Swing GUI in programming mode, use: <br>
   <code>javaw -cp frink.jar frink.gui.SwingProgrammingPanel
    <i>[filename]</i></code>
  </p>
  
  <p>
   If a single filename is specified in programming mode, this file will be
   loaded into the interface.
  </p>

  <p>
   To run the AWT GUI in full-screen size (this is primarily for small
   devices,) use: <br>
   <code>javaw -cp frink.jar frink.gui.FullScreenAWTStarter
    <i>[options]</i></code>
  </p>

  <p>
   Depending on your operating system, I recommend that you write a shell
   script, batch file, or create a shortcut to let you run this even more
   easily (see below for samples.)  To exit, use Ctrl-C, or send your
   platform's end-of-file character (usually Ctrl-Z or Ctrl-D), possibly
   followed by carriage return.  Or just close the window.
  </p>

  <p>
   See the <a href="#ProxyConfiguration">Proxy Configuration</a> below for
   additional options if you're running behind a HTTP or FTP proxy server.
  </p>

  <p>
   Also see the <a href="#PerformanceTips">Performance Tips</a> section below
   to see how to improve speed.
  </p>

  <h3><a name="CommandLineOptions">Command-Line Options</a></h3>
  <p>
   Arguments passed in on the command-line are treated as names of Frink
   programs to be executed.  Other command-line options are listed below.
  </p>
  
  <p>
   If you just want to have Frink calculate something and exit, you can pass
   arguments on the command line using the <code>-e <i>[string]</i></code>
   switch. Each command-line argument following the -e will be interpreted as
   a Frink expression, making it easy to run Frink from other applications:
  </p>

  <p>
   <code>java -cp frink.jar frink.parser.Frink -e "78 yards -&gt; feet"</code><br>
   <code>234.0 </code>
  </p>

  <p>
   Other command-line options:
  </p>
  
  <table summary="Command-line options">
    <tbody><tr><th>Switch</th><th>Description

    </th></tr><tr><td>-f&nbsp;<i>filename</i></td><td> Allows you to specify
    multiple Frink source files to load and run.  Multiple <code>-f&nbsp;<i>filename</i></code> options may be specified.  If this option is
    specified, the specified file will <em>not</em> receive any following
    command-line arguments. <em>The <code>-f</code> switch is no longer
    required or recommended unless you are loading multiple files.</em>
    Normally, you will just specify the filename to load as the last
      command-line argument.
      <p>
       For example, to load your own definitions from
       <code>mydefs.frink</code> before loading the main program
       <code>main.frink</code>, you may do something like:
      </p>

      <p>
       <code>frink -f mydefs.frink main.frink <i>args</i></code>
      </p>
     </td>
     
   </tr><tr><td>-k</td><td>Remain in interactive mode
      after loading files or parsing command-line arguments.  This is very
      useful if you want to load definitions from one or more files and then
      go into an interactive session.

   </td></tr><tr><td>-u&nbsp;<i>filename</i></td><td>Specify a different
      units file than the default.  This allows you to change the fundamental
      dimensions that you like to use, or change my definitions that you don't
      agree with.  You can download my 
      <a href="https://frinklang.org/frinkdata/units.txt">latest data file</a> (normally included
      in the <code>.jar</code> file) and modify it to suit your needs.</td>

    </tr><tr><td>--nounits<br>-nu</td><td>Don't load a units file at all
      on startup.  This will improve startup time, but will break all programs
      that use any of the standard units.  No units of measure will be defined
      at all.

    </td></tr><tr><td>-I&nbsp;<i>path</i></td>
     <td>Appends the specified path to the paths that will be searched when a
      <code>use</code> statement is encountered in a program.  This may be
      either an absolute or relative file path.  You may specify multiple
      <code>-I</code> arguments on the command-line, and the paths will be
      searched in the order they are specified.
     
    </td></tr><tr><td>--encoding&nbsp;<i>str</i>

     </td><td>Specify the character encoding of all following Frink program files.
     <em>This option must precede the filename that it modifies.</em> Frink
      programs can now be more directly written in any language and encoding
      system.  This switch is only necessary if your system's default encoding
      (as detected by Java) is different than that of the program file you're
      loading.

      <p>
       The encoding is a string representing any encoding that your version of
       Java supports, <i>e.g.</i> <code>"UTF-8"</code>,
       <code>"US-ASCII"</code>, <code>"ISO-8859-1"</code>,
       <code>"UTF-16"</code>, <code>"UTF-16BE"</code>,
       <code>"UTF-16LE"</code>.  Your release of Java may support more
       charsets, but all implementations of Java are required to support the
       above.  The sample program  
           <a href="https://frinklang.org/fsp/colorize.fsp?f=encodings.frink">encodings.frink</a> also demonstrates how to list all of the encodings available on your system (and 
   their aliases.)
      </p>      

      <p>
       If you specify multiple files having different encodings using multiple
       <code>-f</code> directives, you can use something like
       <code>--encoding&nbsp;""</code> to set the encoding back to your
       system's default.
      </p>

      <p>
       This flag does <em>not</em> alter the behavior of files opened using
       commands like <code>read[]</code> or <code>lines[]</code>.  To change
       their behavior, use the
       <a href="#SpecifyingAlternateEncodings">two-argument versions of these
        commands.</a>
      </p>
     </td>

   </tr><tr><td><code>-v</code><br><code>--version</code></td><td>Print out
      the Frink version and exit.  (From inside a program, you can call the
      function <code>FrinkVersion[]</code> to return the current version.)

   </td></tr><tr><td>--sandbox</td><td>Enables Frink's internal "sandbox" mode
    so you can run untrusted code.  This is different from Java's sandbox, in
    that it enables only Frink's notions of what should and shouldn't be 
    allowed.  It disallows programs to define functions and many other things,
    so it's rarely useful to the end-user, and hardly any programs will run
       this way.  It's really more for my testing.

   </td></tr><tr><td>--ignore-errors</td><td>Ignores syntax errors when parsing a
    program and attempts to ignore those lines and recover and run the
    program.  Generally a very bad idea, but this flag was added to preserve
    old, excessively-permissive behavior.
  </td></tr></tbody></table>

  <h3><a name="HandlingCommandLineArguments">Handling Command-Line Arguments</a></h3>
  <p>
   Any command-line arguments after the name of the program to be executed
   are passed to the program as an <a href="#Arrays">array</a> called
   <code>ARGS</code>.
  </p>

  <h3><a name="ExperimentalVersions">Experimental Versions</a></h3>
  <p>
   For those who want a standalone, all-in-one Frink download, there is an
   <em>experimental, unsupported</em> version of Frink compiled for Windows
   only using an experimental, unreleased version of the GNU compiler for Java
   (GCJ).  This only works in command-line mode, but requires no other
   downloads and may start up more quickly.  It is appropriate for quick
   calculations and command-line scripts.  Not all functions may work.  Let me
   know about parts that do or don't work for you.  It is compressed with UPX
   to reduce the file size (possibly at the cost of some startup time.)  This
   version starts up more quickly than the Sun JVM, but runs programs about
   5-6 times slower.
  </p>

  <ul>
   <li><b>Experimental, Unsupported</b> executable for Windows: <a href="https://frinklang.org/frinkjar/frinkx.exe">frinkx.exe</a>.
  </li></ul>

  <p>(Unfortunately, it's compiled without optimization, because that pegs the
  CPU for over 72 minutes, and then blows out my system after trying to use
  over a gigabyte of virtual memory.  Anyone want to donate me a new computer
  with tons of memory?  Or try compiling it with -O3?)  For Windows, you can
  use this experimental <a href="http://www.thisiscool.com/gcc_mingw.htm#gcj43ecj">gcj 4.3
  eclipse-merge-branch</a> version.
  </p>
    
  <p>
   Hint:  If you install the gcj package linked above, or have a working GCJ
   (4.3 or later is required) for other platforms, the command line to
   compile with full optimization will be something like:
  </p>

  <p>
   <code>
    gcj -O3 -fomit-frame-pointer --main=frink.parser.Frink -o frinkx.exe <a href="https://frinklang.org/frinkjar/frink.jar">frink.jar</a>
   </code>
  </p>
   
  <h3><a name="SmallDevices">Small Devices</a></h3>
  <p>
   Frink can run entirely on handheld devices like the any phone running
   the Android platform, Sony Ericcson P800,
   P802, or P900 smartphone, the Nokia 92x0 Communicator (Nokia 9210,
   9210i, and 9290), and the Sharp Zaurus.
  </p>

  <p>
   The installer is built as part of the Frink release process, so these
   versions will be up-to-date with the latest Frink.  (The version numbers in
   the installers may not change, though.)
  </p>

  <p>
   Download the installer for the following platforms:
  </p>
  
  <ul>
   <li><b><a href="https://futureboy.us/temp/frink.apk">Android</a></b> - All of Frink's
    functionality, including graphics, is available on the Android mobile
    phone platform.  See the <a href="https://frinklang.org/android.html">Frink on Android</a> page
    for more information on using Frink on Android.  As Android is a stable,
    complete, widely-available, well-designed, multi-platform and multi-vendor
    environment, it will probably be the primary platform for Frink on
    handheld devices in the future.  Other proprietary platforms that require
    extensive porting and packaging for every phone model may go away.
       
   </li><li><b><a href="https://frinklang.org/frinkjar/frink.sis">Sony Ericsson P800, P802 or P900, and
    Motorola A920 or A925</a></b> (and perhaps other Symbian 7.0 devices with
    the UIQ2 user interface.)
    
   </li><li><b><a href="https://frinklang.org/frinkjar/frinkcrystal.sis">Nokia Communicator 92xx (Nokia
     9210, 9210i, and 9290)</a></b> (and perhaps other Symbian 6.0 devices
    with the "Crystal" (wide-screen) user interface).  You need 3 to 4
    megabytes of free memory to run Frink.

   </li><li><b><a href="https://frinklang.org/frinkjar/frink_arm.ipk">Sharp Zaurus</a></b> (despite the
    filename, this isn't ARM-processor specific--it's pure Java, and might
    work on other platforms that use the <code>.ipk</code> package format.)
    Note:  I need help testing and improving this installation package.
    Please contact <a href="mailto:eliasen@mindspring.com">Alan Eliasen</a> if
    you have experience with Zaurus installer packages.  <i>Hint for
     helpers:</i>  an <code>.ipk</code> file is just a <code>.tar.gz</code>
    file, so you can open it up and poke around, but I don't have a Zaurus to
    test on.

   </li><li><b>Experimental:</b> <b><a href="https://frinklang.org/frinkjar/frink80.jar">Nokia 9300,
      Nokia 9500 Communicator</a></b> (and perhaps other Symbian Series 80
    devices.)  I need help testing this one.  The Series 80 devices evidently
    crash when you try to add menubars, so some functions are impossible to
    access.  This is a jar file customized for Series 80, and not an
    <code>.sis</code> installer.
  </li></ul>

  <p>
   Notes about running Frink on other devices, including notes about why I
   probably <em>won't</em> provide releases for newer Symbian devices that
   require their "Symbian Signed" abomination, please see <a href="https://frinklang.org/faq.html#WillFrinkRun">this FAQ entry</a>.
  </p>
  
  <p>
   If you have problems running any of these, please contact <a href="mailto:eliasen@mindspring.com">Alan Eliasen</a>.  Since I don't own
   any of these devices, I rely on others for testing and detailed bug
   reports.  (The emulators don't always work like the real devices!)  It's
   possible for bugs to slip in that work under normal testing, but cause
   problems on the limited/different JVMs on these devices.
  </p>

  <p>
   If anyone knows of a Symbian 6.0 device with the "Quartz" user interface
   that supports PersonalJava, please let me know and I can give you an
   installer to test.
  </p>

  <p>
   If you know of a device that supports PersonalJava 1.1 or better, including
   the <code>java.math</code> package and floating-point math, and you think
   Frink would run on this device and you would like to help test it, please
   <a href="mailto:eliasen@mindspring.com">suggest it to me.</a>.
  </p>

  <!--
  <P>
   <IMG SRC="images/p800photo.jpg" WIDTH="287" HEIGHT="640"
    ALT="Photograph of Frink running on a real SonyEricsson P800 Smartphone">
  </P>

  <P>
   <IMG CLASS="top" SRC="images/epoq.png" WIDTH="261" HEIGHT="518"
    ALT="Screenshot of Frink on a SonyEricsson P800 Smartphone Emulator">
  </P>
   
  <P>
   <A HREF="images/nokiaemulator.png">
   <IMG SRC="images/nokiaemulator_th.png" WIDTH="400" HEIGHT="174"
        ALT="Screenshot of Frink on a Nokia 92xx Emulator"></A>
  </P>
  -->

  <h2><a name="ProgrammingMode">Programming Mode</a></h2>
  <p>
   If you want a unified environment to write, run, save, and load Frink
   programs, try the programming mode.  You can either start this mode
   explicitly (see the <a href="#RunningFrink">Running Frink</a> section
   below) or, from the AWT GUI, choose the menu option <code>Mode |
    Programming</code>.
  </p>

  <p>
   This mode is primarily designed to allow programming on small devices, but
   can run on any platform.
  </p>

  <!--
  <P>
   <A HREF="images/progcrystal.jpg">
   <IMG CLASS="top" SRC="images/progcrystal_th.jpg" WIDTH="476" HEIGHT="197"
     ALT="Programming mode running on a Nokia 92xx Emulator"></A>
  </P>

  <P>
   <IMG CLASS="top" SRC="images/progmodeepoc.png" WIDTH="262" HEIGHT="516"
    ALT="Programming mode running on a SonyEricsson P800 Emulator">
  </P>
  -->

  <p>
   The <code>Data</code> menu option allows you to choose between the <a href="https://frinklang.org/frinkdata/units.txt">standard data file</a> and an alternate data
   file.  You'll usually want to use the standard data file, but on small
   devices, it can take a long time to start your program, and may use a fair
   amount of memory.  The standard data file is big.  In that case, you may
   want to make a pared-down (or even empty) units file and use that when
   running your programs.
  </p>

  <p>
   For now, selecting a different data file is not a persistent setting.  This
   setting will only remain in place until you exit Frink.
  </p>
  
  <h3><a name="GUIOptions">GUI Options</a></h3>
  <p>
   You can specify the width or the height of the window for
   <code>frink.gui.InteractivePanel</code> or
   <code>frink.gui.SwingInteractivePanel</code> or 
   <code>frink.gui.FullScreenAWTStarter</code>.
   You may specify width or height or both.  For example:
  </p>

  <p>
   <code>java -cp frink.jar frink.gui.SwingInteractivePanel
    --width <i>500</i> --height <i>400</i></code>
  </p>

  <table summary="GUI Options">
   <tbody><tr><th>Option</th><th>Description
   </th></tr><tr><td>--width <i>int</i></td><td>Sets the width of the window in
      pixels. 
   </td></tr><tr><td>--height <i>int</i></td><td>Sets the height of the window in
      pixels. 
   </td></tr><tr><td>--fontsize <i>int</i></td><td>Sets the font size in points.
  </td></tr></tbody></table>

  <h3><a name="PerformanceTips">Performance Tips</a></h3>
  <p>
   There are several things you can do to make your Java Virtual Machine (JVM)
   run Frink more quickly:
  </p>

  <ul>
   <li>
    Java 8 contains my algorithmic improvements to make large integers work
    <em>much</em> more quickly for multiplication, base conversion, etc.  (It
    only took the Java people 11+ years to import my patches.)  If you want
    faster integer and decimal performance, make sure you are
    using <a href="https://frinklang.org/experimental.html">Frink:The Next Generation</a> and Java
    1.8 or later which uses my vastly improved algorithms.
    
   </li><li>For long-running programs, if you're using Sun's Java Virtual Machine
    (JVM), use the <code>-server</code> command-line switch to the
    <code>java</code> executable.  This starts the Server VM which optimizes
    more aggressively and often improves performance of long-running programs
    by a factor of 2, but at the expense of increased start-up time.  Note that
    the server VM may not be available if you just downloaded the Java Runtime
    Environment (JRE), and not the full Java Software Development Kit (SDK).

   </li><li>If you're <em>not</em> starting long-running programs, and want the
    fastest start-up time, <em>don't</em> use the Server VM.
    
   </li><li>Like all Java programs, Frink can often run much faster if you allow
    the JVM to use more memory at startup, leading to less-frequent garbage
    collection.  In Sun's implementation, this is achieved by passing the
    options <code>-Xmx<i>&lt;size&gt;</i></code> (for maximum Java heap size)
    and <code>-Xms<i>&lt;size&gt;</i></code> (for initial Java heap size) to
    the <code>java</code> executable.  The <i>size</i> arguments are something
    like <code>256M</code> for 256 megabytes.  Note that this is at the expense
    of other processes running on your system, and should be used sparingly
    because allocating too much memory may cause your system to swap
    excessively or run out of memory if set too high.
    
   </li><li>(<i>Probably obsolete</i>) If you're doing mostly large integer work
   (factoring, primality testing, other number theory,) where most of the
   runtime is spent in mathematical operations on very large integers, the <a href="http://www.kaffe.org/">Kaffe</a> Virtual Machine compiled with the
   incredibly fast <a href="https://gmplib.org/">GMP</a> numerical libraries
   works literally thousands of times faster than Sun's VM and its horribly
   naïve algorithms.
    
    <p><b>Warning:</b> Make sure that GMP is compiled with the
     configure option <code>--enable-alloca=malloc-reentrant</code> or you'll
     blow out the stack and crash with very large integers.

    </p><p><b>Warning:</b> As of the 2004-07-18 release of Kaffe, you must now
     explicitly pass the <code>-Xnative-big-math</code> argument when running
     Kaffe in order to use the GMP libraries.
  </p></li></ul>

  <h3><a name="ProxyConfiguration">Proxy Configuration</a></h3>
  <p>
   If you use a HTTP or FTP proxy server, you need to add some options to your
   command lines (say, right after the word <code>java</code>) to use the
   proxy if you want certain functions to work.  HTTP and FTP are used for the
   following:

  </p><ul>
   <li><a href="#TextTranslation">Language translations</a> (HTTP)
   </li><li><a href="#InternationalExchangeRates">Currency/Exchange Rate
     conversions</a> (HTTP, will fall back to static file if unavailable)
   </li><li><a href="#HistoricalUSPriceData">Historical values of the
     U.S. dollar</a> (FTP, will fall back to static file if unavailable)
  </li></ul>

  <p>
   The following are settings for Sun's distribution of Java 1.4.1.  You may
   need different options depending on your Java distribution.  See
   <a href="http://download.oracle.com/javase/1.4.2/docs/guide/net/properties.html">Sun's
    Networking Properties documentation</a> for more properties you may need
   if you're on a network that requires more proxy settings.
  </p>

  <p>
   HTTP proxy:<br>
   <code>-Dhttp.proxyHost=<i>proxyname</i>
    -Dhttp.proxyPort=<i>portnum</i></code><br>
  </p>

  <p>
   FTP proxy:<br>
   <code>-Dftp.proxyHost=<i>proxyname</i>
    -Dftp.proxyPort=<i>portnum</i></code><br>
  </p>

  <p>
   These settings should <em>not</em> be necessary when using the applet
   version or the Java Web Start version, as these inherit the proxy settings
   from your browser or the Java Web Start Application Manager respectively.
  </p>

  <h2><a name="HowFrinkIsDifferent">How Frink is Different</a></h2>
  <p>
   Frink is, first and foremost, designed to make it easy to figure out
   things.  If there's a unifying principle in Frink, it could be considered
   to be the <em>normalization of information</em>.  I'm trying to
   simplify and unify the representation of data so that you can perform all
   sorts of interesting operations on them.  Whatever that means.
  </p>

  <p>
   Frink is optimized for doing quick, off-the-cuff calculations with a
   minimum of typing, primarily so it can be used with handheld devices which
   can make text entry difficult (especially symbols).  This doesn't mean that
   Frink is unsuitable for doing large, very high accuracy calculations.  It
   does those well, too, and the complicated calculations look just like the
   simple ones.
  </p>

  <p>
   To give an example, Frink represents <em>all</em> numerical quantities as
   not simply a number, but a number and the units of measurement that
   quantity represents.  So you can enter things such as "3 feet" or "40
   acres" or "4 tons", and add, subtract, multiply, etc. these things
   together.  Frink will track the resulting quantities through all
   calculations, eliminating a large category of errors.  You can add feet,
   meters, or rods all in the same calculation and the details are handled
   transparently and correctly.
  </p>

  <p>
   It also knows the ways that these units are interrelated-- a length times a
   length is an area; length<sup>3</sup> is a volume (if you believe in the
   hypothetical Z axis); mass times distance times acceleration is energy.  If
   you know something in one system of measurement you can convert it to any
   other system of measurement.
  </p>

  <p>
   All units are standardized and normalized into combinations a small number
   of several "Fundamental Dimensions" that cannot be reduced any further.
   These are completely arbitrary and configurable but are currently:
  </p>
   
  <table summary="Fundamental Units">
   <tbody><tr><th>Quantity</th><th>Fundamental Unit</th><th>Name
   </th></tr><tr><td>length    </td><td>m </td><td>meter
   </td></tr><tr><td>mass      </td><td>kg </td><td>kilogram
   </td></tr><tr><td>time      </td><td>s </td><td>second
   </td></tr><tr><td>current </td><td>A </td><td>ampere
   </td></tr><tr><td>luminous_intensity </td><td>cd </td><td>candela
   </td></tr><tr><td>substance </td><td>mol </td><td>mole
   </td></tr><tr><td>temperature </td><td>K </td><td>Kelvin
   </td></tr><tr><td>information </td><td>bit </td><td>bit
   </td></tr><tr><td>currency </td><td>USD </td><td>U.S. dollar
  </td></tr></tbody></table>

  <p>
   Look at the <a href="https://frinklang.org/frinkdata/units.txt">data file</a> for these
   definitions (and my editorializing on the boneheadedness of many these
   choices.)  The data file recursively defines all measurements in terms of
   the fundamental units.
  </p>

  <p>
   An exponent can be attached to each dimension.  For example, an area is
   length * length which might be represented as <code>meters^2</code>.  Of
   course, a negative exponent indicates <em>division</em> by that quantity,
   so meters/second will be displayed as <code>m s^-1</code>, or acceleration
   (which can be represented as meters per second per second) is represented
   as <code>m s^-2</code>.
  </p>

  <p>
   A subtle but important design goal of Frink is to "do the right thing" with
   numbers.  Numeric values are automatically promoted to and from integers,
   rational numbers, floating-point numbers, complex numbers and more, all
   without overflow or undefined behavior or rounding error.  Frink tries to
   get the <em>right</em> answer, not the wrong answer as fast as possible.
  </p>

  <h2><a name="NumericTypes">Numeric Types</a></h2>
  <p>
   Numeric values in Frink are represented in one of several ways:
  </p>

  <dl>
   <dt>Integer</dt> <dd>An arbitrarily large number with no decimal part.
   Represented as a number with no decimal point, (<i>e.g.</i>
   <code>1000000000</code>) or the special "exact exponent" form
   <code>1ee9</code>.  An integer can also contain underscores for better
   readability, <i>e.g.</i> <code>1_000_000_000</code></dd>
   
   <dt>Rational</dt>
   <dd>An arbitrarily large number which can be written as
    integer/integer ( such as <code>1/3</code> or <code>22/7</code> ).
    Rational numbers are first reduced to smallest terms; that is,
    <code>2/10</code> is stored as <code>1/5</code> and <code>5/5</code> is
    stored as the integer <code>1</code></dd>
   
   <dt>Floating Point</dt>
   <dd>An arbitrary-precision floating-point number.
    Currently, the number of decimal places calculated or displayed is limited
    to 20 for efficiency reasons.  Any number containing a decimal point is a
    floating-point number, such as <code>1.</code> or <code>1.01132</code>, as
    well as any approximate exponential such as <code>2e10</code> or
    <code>6.02e23</code>.
    
    <p>
     As of the 2018-12-11 release, if a number with a decimal point has the
     "exact exponent" indicator <code>ee</code>, it is turned into an exact
     rational number or integer.  For example, the new exact SI value for
     Avogadro's number <code>6.02214076ee23</code> will become an exact
     integer.  The exponents can also be negative, which will usually lead to
     an exact rational number, such as <code>6ee-1</code> which produces the
     exact rational number <code>3/5 (exactly 0.6)</code>.
    </p> 
   </dd>

   <dt>Complex Numbers</dt>
   <dd>Complex numbers are any number with an imaginary part.  The imaginary
    unit is specified by the symbol <code>i</code>.  For example, <code>40 +
     3 i</code>.  The real and imaginary parts of a complex number can be any
    of the numerical types listed above.</dd>

   <dt>Intervals</dt>
   <dd>An interval represents a range of values, such as <code>[2.1, 3]</code>
    where, depending on your interpretation, the actual number is unknown, but
    contained within this range, or the number simultaneously takes on all
    values within the range.  See the <a href="#IntervalArithmetic">Interval
    Arithmetic</a> section of the documentation for more information.</dd>
  </dl>


  <h2><a name="DataLibraries">Data Libraries</a></h2>
  <p>
   Frink knows about a wide variety of measurements.  You can usually type a
   unit of measurement in a variety of ways.  Plurals are usually understood.
   Case is important (and somewhat arbitrary until I do some normalization and
   cleanup of the units file, but usually lowercase is your best choice.)  The
   following are all examples of valid units:
  </p>

  <ul>
   <li><code>1</code>
   </li><li><code>1000000</code>
   </li><li><code>1_000_000</code> (also one million, just maybe more readable.)
   </li><li><code>1E6</code> (1.0x10<sup>6</sup>, or approximately a million (floating-point))
   </li><li><code>1EE6</code> (1x10<sup>6</sup>, or exactly a million (integer))
   </li><li><code>million</code>
   </li><li><code>1 million</code>
   </li><li><code>24.5E-10</code> (24.5 x 10<sup>-10</sup>)
   </li><li><code>eighty</code>
   </li><li><code>four score + seven</code>
   </li><li><code>1</code> (a dimensionless exact integer)
   </li><li><code>1.0</code> (a floating-point number)
   </li><li><code>1.</code> (also a floating-point number)
   </li><li><code>1/3</code> (a rational number, preserved as a fraction)
   </li><li><code>1 quadrillion</code>
   </li><li><code>gallon</code>
   </li><li><code>1 gallon</code>
   </li><li><code>56 gallon</code>
   </li><li><code>56 gallons</code>
   </li><li><code>foot</code>
   </li><li><code>54.2 feet</code>
   </li><li><code>furlong</code>
   </li><li><code>hogshead</code>
   </li><li><code>2 USD</code> ("USD" is the ISO-4217 currency code for the U.S. Dollar)
   </li><li><code>2 dollars</code> (for now, shorthand for the U.S. dollar)
   </li><li><code>16 tons</code>
   </li><li><code>6 ounces</code>
   </li><li><code>1 gram</code>
   </li><li><code>8 milligrams</code> (most common prefixes are allowed.)
   </li><li><code>8 mg</code>    (abbreviations of most prefixes and units are also allowed)
   </li><li><code>7 kilowatts</code>
   </li><li><code>7 kW</code>
   </li><li><code>1.21 gigawatts</code>
   </li><li><code>1.21 GW</code>
   </li><li><code>9 seconds</code>
   </li><li><code>9 sec</code>
   </li><li><code>9 s</code>
   </li><li><code>1/24 day</code>
   </li><li><code>100001000101111111101101\\2</code> (a number in base 2)
   </li><li><code>1000_0100_0101_1111_1110_1101\\2</code> (a number in base 2 with
    underscores for readability)
   </li><li><code>845FED\\16</code>  (a number in base 16... bases from 2 to 36 are allowed)
   </li><li><code>845fed\\16</code>  (a number in base 16)
   </li><li><code>845_fed\\16</code>  (a number in base 16 with underscores for readability)
   </li><li><code>0x845fed</code>  (Common hexadecimal notation)
   </li><li><code>0x845FED</code>  (Common hexadecimal notation)
   </li><li><code>0xFEED_FACE</code>  (Hexadecimal with underscores for readability)
   </li><li><code>0b100001000101111111101101</code> (Common binary notation)
   </li><li><code>0b1000_0100_0101_1111_1110_1101</code> (Binary with underscores for readability)
  </li></ul>

  <p>
   If you're looking for a specific unit, and don't know how it's spelled or
   capitalized, see the <a href="#IntegratedHelp">Integrated Help</a> section
   below.
  </p>

  <p>
   Or, if you're using the <a href="https://frinklang.org/fsp/frink.fsp">web interface</a>,
   type part or all of the name in the "Lookup:" field and click "lookup".
   Selecting the "exact" checkbox will only return exact matches, otherwise
   you will get all lines containing that substring.  Try it for something
   like "<a href="https://frinklang.org/fsp/frink.fsp?lookup=cubit">cubit</a>" and you'll see that
   there are often lots of variations.
  </p>

  <p>
   <b>Important:</b> You'll learn the most if you look at the voluminous and
   fascinating <a href="https://frinklang.org/frinkdata/units.txt">data file</a> for more examples
   of things you can do, and measurements that Frink knows about.
  </p>

  <h2><a name="IntegratedHelp">Integrated Help</a></h2>
  <p>
   If you don't know the name of a unit or function, but can guess at it, you
   can either read the <a href="https://frinklang.org/frinkdata/units.txt">data file</a> for more
   information, or use the integrated help.  Keep in mind that Frink is
   case-sensitive, so you'll need to use the right capitalization of the names.
  </p>

  <p>
   Unit or function names can be looked up by preceding part or all of the
   name with a question mark.  This will return a list of all units and
   function names <em>containing</em> that string, in upper- or lower-case.
   For example, to find the different types of cubits:
  </p>
   
  <p>
   <code>?cubit</code><br>
   <code>[homericcubit, assyriancubit, egyptianshortcubit,
    greekcubit, shortgreekcubit, romancubit, persianroyalcubit, hebrewcubit,
    northerncubit, blackcubit, olympiccubit, egyptianroyalcubit,
    sumeriancubit, irishcubit, biblicalcubit, hashimicubit]</code>
  </p>

  <p>
   Or, if you want to know the name of the currency used in Iran,
  </p>

  <p>
   <code>?iran</code><br>
   <code>[Iran_Rial, Iran_currency, Iran]</code>
  </p>

  <p>
   Simply enter the name of the unit you're interested in to see its value:
  </p>

  <p>
   <code>biblicalcubit</code><br>
   <code>0.55372 m (length)</code>
  </p>

  <p>
   If you want to see the results in specific units of measurement, you
   can use the arrow operator <code>-&gt;</code> as described in the
   <a href="#Conversions">Conversions</a> section below:
  </p>
  
  <p>
   <code>biblicalcubit -&gt; inches</code><br>
   <code>21.8</code>
  </p>

  <p>
   Or, if you want to see the sizes of all the units as a single unit type,
   and they're all the same, you can use the arrow operator on the list.  The
   following sample shows all the different types of cubits the world
   has defined and converts them to inches:
  </p>

  <p>
   <code>?cubit -&gt; inches</code><br>
   <code>[homericcubit = 15.5625,<br>
    &nbsp;assyriancubit = 21.6,<br>
    &nbsp;egyptianshortcubit = 17.682857142857142857,<br>
    &nbsp;greekcubit = 18.675,<br>
    &nbsp;shortgreekcubit = 14.00625,<br>
    &nbsp;romancubit = 2220/127 (approx. 17.480314960629922),<br>
    &nbsp;persianroyalcubit = 25.2,<br>
    &nbsp;hebrewcubit = 17.58,<br>
    &nbsp;northerncubit = 26.6,<br>
    &nbsp;blackcubit = 21.28,<br>
    &nbsp;olympiccubit = 18.225,<br>
    &nbsp;egyptianroyalcubit = 20.63,<br>
    &nbsp;sumeriancubit = 2475/127 (approx. 19.488188976377952),<br>
    &nbsp;irishcubit = 500000000/27777821 (approx. 17.99997199204358),<br>
    &nbsp;biblicalcubit = 21.8,<br>
    &nbsp;hashimicubit = 25.56]</code>
  </p>

  <p>
   If you don't want to see exact fractions, you can (as always) multiply the
   right-hand-side by <code>1.0</code> or <code>1.</code> (without a zero
   after the decimal point) to get approximate numbers:
  </p>

  <p>
   <code>?cubit -&gt; 1.0 inches</code><br>
  </p>

  <p>
   If you use two question marks, the units that match that pattern will be
   displayed <em>and their values in the <a href="#SettingDisplayUnits">current
     display units</a>:</em>
  </p>

  <p>
   <code>??moon</code><br>
   <code>
    moonlum = 2500 m^-2 cd (illuminance),<br>
    moondist = 0.002569555301823481845 au,<br>
    moonmass = 73.483E+21 kg (mass),<br>
    moonradius = 0.000011617812472864754024 au,<br>
    moongravity = 1.62 m s^-2 (acceleration)</code>
  </p>

  <p>
   <b>Note:</b> If you use the form with two question marks, you
   <em>cannot</em> convert them to a specified unit with the
   <code>-&gt;</code> operator, as they have already been converted to a
   single string.
  </p>

  <p>
   <b>Note:</b> As of the 2016-07-06 release, the double-question-mark
   operator now returns <em>a single string</em> with newlines separating each
   entry, instead of a list of strings.
  </p>

  <p>
   Note that functions are displayed at the end of the list, and can be
   distinguished from units by the square brackets following them:
  </p>

  <p>
   <code>??call</code><br>
   <code>
   callistodist = 1.883000000e+9 m (length),<br>
   callistoradius = 2.400000e+6 m (length),<br>
   callistomass = 1.08e+23 kg (mass),<br>
   callJava[arg1,arg2,arg3]</code>
  </p>

  <p>
   In addition, the <code>functions[]</code> function will produce a list of
   all functions.
  </p>

  <h2><a name="EditingFrink">Editing Frink</a></h2>
  <p>
   If you're writing Frink programs, you can edit Frink files in your favorite
   text editor.  If that happens to be Emacs or XEmacs, you can download the
   rudimentary <a href="https://frinklang.org/frinktools/emacs/frink-mode.el">Frink mode for
    Emacs</a>.  It's somewhat rough at this moment, but it has syntax
   highlighting, automatic indenting, ability to run interactive Frink
   sessions or programs.  Screenshot is below.
  </p>

  <p>
   <a href="https://frinklang.org/images/emacs.png">
    <img src="https://frinklang.org/images/emacs_th.png" width="336" height="363" alt="Screenshot of Frink emacs mode">
   </a>
  </p>
  
  <h2><a name="Conversions">Conversions</a></h2>
  <p>
   By default, the output is in terms of the "fundamental units".  To convert
   to whatever units you want, simply use the "arrow" operator
   <code>-&gt;</code> (that's a minus sign followed by a greater-than sign,)
   with the target units on the right-hand side:
  </p>

  <p>
   <code>38 feet -&gt; meters</code><br>
   <code>11.5824</code>
  </p>

  <p>
   <b>Formatting Shortcut:</b> If the right-hand-side of the conversion is in
   double quotes, the conversion operator will both evaluate the value in
   quotes as a unit and append the quoted value to the result.  So, the above
   example could be performed as:
  </p>

  <p>
   <code>38 feet -&gt; "meters"</code><br>
   <code>7239/625 (exactly 11.5824) meters</code>
  </p>

  <p>
   In this case, because the ratio between feet and meters is an
   exactly-defined quantity, so the answer comes out as an exact rational
   number.  This is also displayed as a decimal number for your convenience.
   If you just want the decimal value, you can multiply by an approximate
   decimal number (any number containing a decimal point) such as
   <code>1.0</code> or <code>1.</code> without anything after the 
   decimal point:
  </p>

  <p>
   <code>38. feet -&gt; "meters"</code><br>
   <code>11.5824 meters</code>
  </p>

  <p>
   <b>Note:</b> If you are using the web-based interface, simply enter
   everything left of the arrow in the "From:" box and everything to the right
   of the arrow in the "To:" box.  Or you can enter the whole expression
   <em>including</em> the arrow in the "From:" box and leave the "To:" box
   empty.  It does the exact same thing.
  </p>

  <p>
   If the units on either side of a conversion are not of the same type, Frink
   may try to help you by suggesting conversion factors:
  </p>
  
  <p>
   <code>55 mph -&gt; yards</code><br>
   <code>
    &nbsp;Conformance error -<br>
    &nbsp;&nbsp;&nbsp;Left side is: 15367/625 (exactly 24.5872) m s^-1 (velocity)<br>
    &nbsp;&nbsp;Right side is: 1143/1250 (exactly 0.9144) m (length)<br>
    &nbsp;&nbsp;&nbsp;&nbsp;Suggestion: multiply left side by time<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; or divide left side by
    frequency<p>
    
    &nbsp;For help, type:<br>
    &nbsp;&nbsp;&nbsp;&nbsp;units[time]<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or<br>
    &nbsp;&nbsp;&nbsp;&nbsp;units[frequency]<br>
    &nbsp;&nbsp;&nbsp;&nbsp;to list known units with these dimensions.
   </p></code>
  </p>

  <p>
   If you get an error like this, you can list all the units that have the
   specified dimensions by typing <code>units[time]</code> or
   <code>units[frequency]</code>.
  </p>

  <p>
   Yes, sometimes it gives digits which aren't significant in results.  As I
   improve the symbolic reduction of expressions, this will get better,
   although I still need to work out ways of specifying and tracking precision
   (and uncertainty?) throughout all calculations.
  </p>

  <h3><a name="MultipleConversions">Multiple Conversions</a></h3>
  <p>
   If the right-hand-side of the conversion is a comma-separated list in
   square brackets, the value will be broken down into the constituent
   units.  For example, to find out how long it takes the earth to rotate on
   its axis:
  </p>

  <p>
   <code>siderealday -&gt; [hours, minutes, seconds]</code><br>
   <code>23, 56, 4.0899984</code>
  </p>

  <p>
   or, to maintain symmetry with the quoted-right-hand-side behavior noted
   above, arguments on the right-hand-side can be quoted:
  </p>
   
  <p>
   <code>siderealday -&gt; ["hours", "minutes", "seconds"]</code><br>
   <code>23 hours, 56 minutes, 4.0899984 seconds</code>
  </p>

  <p>
   This behavior can also be used to break fractions into constituent parts:
  </p>

  <p>
   <code>13/4 -&gt; [1,1]</code><br>
   <code>3, 1/4 (exactly 0.25)</code>
  </p>

  <p>
   If the first term is the integer <code>0</code> (zero), any leading terms
   with zero magnitude will be suppressed:
  </p>

  <p>
   <code>siderealday -&gt; [0, "weeks", "days", "hours", "minutes", "seconds"]</code><br>
   <code>23 hours, 56 minutes, 4.0899984 seconds</code>
  </p>
  
  <p>
   If the last term is the integer <code>0</code> (zero), any remaining
   fractional part  will be suppressed:
  </p>

  <p>
   <code>siderealday -&gt; ["hours", "minutes", "seconds", 0]</code><br>
   <code>23 hours, 56 minutes, 4 seconds</code>
  </p>

  <h2><a name="MathOperators">Math Operators</a></h2>
  <p>
   Math is very straightforward: the current parser accepts the normal
   mathematical operators, with normal operator precedence.  (Exponentiation
   first (see notes below,) then multiplication and division, then addition
   and subtraction.  And more tightly parenthesized expressions are performed
   before anything else.)  All expressions can be arbitrarily complex.
   Parentheses can be used to group expressions.
  </p>

  <p>
   <b>Important:</b> Whitespace between any two units implies multiplication!
   This has the same precedence as multiplication or division.  If there's one
   thing you need to keep in mind, it's this.  You <em>must</em> parenthesize
   units on the right-hand-side of a division operation, if you expect them to
   be multiplied before the division takes place.
  </p>

  <p>
   The following are all valid expressions.  (Note
   that if you are using the web-based interface you can enter the right-hand
   side of the arrow operator in the "To:" box.)
  </p>

  <table summary="Mathematical operators">
   <tbody><tr><th>Example</th><th>Description
   </th></tr><tr><td>1+1        </td><td>addition
   </td></tr><tr><td>1-1        </td><td>subtraction
   </td></tr><tr><td>3*4        </td><td>multiplication
   </td></tr><tr><td>3 4        </td><td><b>Important:</b> whitespace implies
      multiplication 
   </td></tr><tr><td>3 days     </td><td>multiplication also.
   </td></tr><tr><td>foot meter </td><td>multiplication also (result is an area)
   </td></tr><tr><td>1/3        </td><td>division (note this maintains an exact
      rational number)
   </td></tr><tr><td>week/day   </td><td>division (result is 7)
   </td></tr><tr><td>3^4        </td><td>exponentiation.  Note that chained
      exponentiations such as <code>2^3^4</code> are, following normal
      mathematical rules of precedence, performed right-to-left, that is,
      <code>2^(3^4)</code>.
   </td></tr><tr><td>3^200      </td><td>exponentiation... note that arbitrary
      precision is supported.
   </td></tr><tr><td>10⁻²³</td><td>exponentiation using
      Unicode superscript characters.  This is equivalent to
      <code>10^-23</code>.  See the <a href="#UnicodeOperators">Unicode
       Operators</a> section below for more details.
   </td></tr><tr><td>365 % 7    </td><td>modulus (remainder) defined by <code>x -
       y * floor[x/y]</code>.  Note that this means the result shares the same
       sign as the <em>right-hand-side.</em>
   </td></tr><tr><td>365 mod 7  </td><td>Also modulus
   </td></tr><tr><td>year mod day  </td><td>Also modulus; both sides need to be
      units having same dimensions (<i>e.g.</i> both length.)
   </td></tr><tr><td>365 div 7  </td><td>Truncating divide, defined by
     <code>floor[x/y]</code>
   </td></tr><tr><td>year div day  </td><td>Also truncating divide; both sides
      need to be units of same type.
   </td></tr><tr><td>6!          </td><td>Factorial: 6 * 5 * 4 * 3 * 2 * 1.  Note
      that factorials have a higher precedence than exponentiation.
   </td></tr><tr><td>foot -&gt; m </td><td>Conversion operator (for unit
      conversions, works just like a very low-precedence divide operator but
      returns a string.)

   </td></tr><tr><td>4^(1/2)    </td><td>square root (note parentheses needed
      because precedence of exponentiation is higher than that of division.
      The function <code>sqrt[<i>x</i>]</code> does the same thing.)

   </td></tr><tr><td>1/2 + 1/3 </td><td>Result is <code>5/6</code>.  Note that
      Frink maintains rational numbers if it can.

   </td></tr><tr><td>1/2 + 1/3. </td><td>Result is <code>.083333333</code> The
      decimal point indicates an uncertain number.

   </td></tr><tr><td>gallon^(1/3) -&gt; inches </td><td>Cube root:  how big of a
      cube (or Frinkahedron) is a gallon?

   </td></tr><tr><td>(20 thousand gallons)^(1/3) -&gt; feet </td><td>How big of a
      cube is 20000 gallons?  Note necessary parentheses because exponentiation
      is usually done before multiplication or division.

   </td></tr><tr><td>20 thousand gallons water -&gt; pounds </td><td>How much does
      that much water weigh?  ("water" is a measure of density for now.)
   </td></tr><tr><td>250 grams / sugar -&gt; cups</td><td>Sample recipe
      conversion ("sugar" is a density for now.)
   </td></tr><tr><td>1/4 mile / (4.23 seconds) -&gt; miles/hour</td><td>Dragster
      average speed.  Note the parentheses required because space is
      multiplication which has same precedence as division.
   </td></tr><tr><td>329 mph / (4.23 seconds) -&gt; gravity</td><td>Dragster
      average acceleration in g's.
   </td></tr><tr><td>foot <b>conforms</b> meters</td><td>Conformance operator;
      returns <code>true</code> if the left-hand-side is a unit that has the
      same dimensions as the named DimensionList (e.g. <code>length</code> or
      <code>velocity</code>) on the right-hand-side (the right-hand-side can
      also be a string.)  If the right-hand-side
      is a unit, this returns true if both sides are units with same
      dimensions, <code>false</code> otherwise.  Hint:  use the
      <code>dimensions[]</code> function to list all known dimension types or
      the <code>dimensionsWithValues[]</code> to list the dimensions types
      with their values in the base dimensions.
   </td></tr><tr><td>3 <b>square</b> feet</td><td>Equals <code>3 (feet^2)</code>
      or, more simply, <code>3 feet^2</code>.  Square squares the unit on its
      immediate right-hand side.
   </td></tr><tr><td>3 <b>sq</b> feet</td><td>Same as <code>square</code>
   </td></tr><tr><td>3 <b>cubic</b> feet</td><td>Equals <code>3 (feet^3)</code>
      or, more simply, <code>3 feet^3</code>.  Cubic cubes the unit on its
      immediate right-hand side.
   </td></tr><tr><td>3 <b>cu</b> feet</td><td>Same as <code>cubic</code>
    </td></tr><tr><td>3 feet <b>squared</b></td><td>Equals <code>(3
       feet)^2</code>, indicating a square 3 feet on a side, or 9 square
      feet.  This squares the multiplicative terms on its left-hand-side.
      Squared has a precedence between multiplication and addition.
   </td></tr><tr><td>3 feet <b>cubed</b></td><td>Equals <code>(3
       feet)^3</code>, indicating a cube 3 feet on a side, or 27 cubic feet.
      This cubes the multiplicative terms on its left-hand-side.  Cubed has a
      precedence between multiplication and addition.
  </td></tr></tbody></table>

  <p>
   <b>Note:</b> If a number comes out as a fraction, like
   <code>20/193209</code>, you can get a decimal result by repeating the
   calculation with a non-integer number (that is, one with a decimal point in
   it like <code>20./193209</code>) or by multiplying by <code>1.0</code>, or
   simply <code>1.</code> (without anything after the decimal point.)
  </p>

  <p>
   Both sides of a conversion can be arbitrarily complex.
  </p>

  <h3><a name="Factorials">Factorials</a></h3>
  <p>
   The implementation of factorials is subtle and important enough to warrant
   a few notes.  The factorial operator <code>!</code>
   follows after an expression and has a precedence <em>above</em>
   exponentiation, following normal mathematical precedence rules.  Yeah, when
   I say <code>6!</code> or <code>n!</code> or <code>(n-m)!</code>, I'm not
   just being super-enthusiastic about that number.  It's a common
   mathematical operator.
  </p>

  <p>
   <i>Reminder:</i> the factorial of a non-negative integer <code>n!</code> is
   the product of all the numbers from <code>1</code> to <code>n</code>.  For
   example, the factorial <code>6!</code> is equal to
   <code>1*2*3*4*5*6=720</code>.  These grow rapidly and become hard to
   calculate, but Frink calculates them exactly.
  </p>

  <p>
   Here are some notes about the implementation of factorials:
  
  </p><ul>
   <li>Factorials are calculated once and cached in memory so further
    recalculation is fast.

   </li><li>There is a limit to the size of factorials that gets cached in memory.
    Currently this limit is <code>10000!</code>.  Numbers larger than this
    will not be cached, but re-calculated on demand.

   </li><li>When calculating a factorial within the caching limit, say,
    <code>5000!</code>, all of the factorials smaller than this will get
    calculated and cached in memory.

   </li><li>As of the 2017-04-04 release, calculations of huge factorials larger
    than the cache limit <code>10000!</code> are now calculated by a <a href="https://frinklang.org/fsp/colorize.fsp?f=BinarySplittingFactorial.frink">binary splitting
     algorithm</a> which makes them significantly faster on Java 1.8 and later.
    (Did you know that Java 1.8's BigInteger calculations got drastically
    faster because Frink's internal algorithms were contributed to it?)

   </li><li>As of the 2017-04-04 release, functions that calculate binomial
     coefficients like <code>binomial[<i>m,n</i>]</code> are more efficient
     because of the use of <a href="https://frinklang.org/fsp/colorize.fsp?f=BinarySplittingFactorial.frink">binary
     splitting algorithms,</a> especially for large numbers.

     <p>
       <b>Note:</b>  <code>binomial[<i>m,n</i>]</code> is of the number of ways
       <code>m</code> things can be chosen <code>n</code> at a time, with
       order being unimportant.  This is sometimes called "m choose n" or "m C
       n".  This is equivalent to <code>m!/(n!&nbsp;(m-n)!)</code> although
       calculating that way 
       often leads to way-too-big numbers.  For example, <code>binomial[10000,
         9998]</code> is equal to 49995000, but if you calculated it naively,
       you'd have to calculate 10000! which is a 35660-digit number, and divide
       it by another huge number, which could be inefficient and slow.
     
     </p></li><li>The function <code>factorialRatio[<i>a</i>, <i>b</i>]</code> allows
    <em>efficient</em> calculation of the ratio of two factorials <code>a! /
     b!</code>, using a <a href="https://frinklang.org/fsp/colorize.fsp?f=BinarySplittingFactorial.frink">binary
     splitting algorithm</a>.
  </li></ul>

  <h2><a name="Variables">Variables</a></h2>
  <p>
   By default, all variables in Frink can contain any type.  Variable names
   begin with any (Unicode) letter followed by 0 or more letters, digits, or
   the underscore (<code>_</code>) character.
  </p>

  <p>
   You do not need to declare variables before using them.  The variable will
   be defined in the smallest containing scope.
  </p>

  <p>
   To assign a value to a variable, use the <code>=</code> operator:
  </p>

  <p>
   <code>a = 10 feet</code>  (assigns a single value)<br>
   <code>b = [30 yards, 3 inches]</code>  (assigns an array)
  </p>

  <h3><a name="DeclaringVariables">Declaring Variables</a></h3>
  <p>
   Variables <em>may</em> be declared before they are used using the
   <code>var</code> keyword.  For example, to
   declare a variable called <code>t</code>:
  </p>

  <p>
   <code>var t</code>
  </p>

  <p>
   This defines the variable t in the smallest containing scope and sets its
   initial value to the special value <code>undef</code>.  You may also
   specify an initial value:
  </p>

  <p>
   <code>var t = 10 seconds</code>
  </p>

  <h3><a name="ConstraintsOnVariables">Constraints on Variables</a></h3>
  <p>
   When a variable is declared, you can constrain the type of values that it
   can contain.  The constraints are checked at runtime.  If you try to set a
   value that does not meet the constraints, a runtime error occurs.  For
   example, to make sure that the variable <code>t</code> only contains values
   with dimensions of time, you can declare it using the <code>is</code>
   keyword which defines constraints.
  </p>
    
  <p>
   <code>var t is time = 10 seconds</code>
  </p>

  <p>
   In this case, the initial value is necessary to ensure that <code>t</code>
   contains a value with dimensions of time <em>at all times</em>.  (The
   special value <code>undef</code> is applied if no initial value is
   supplied.)  If a valid initial value is not supplied, this will produce an
   error at runtime.
  </p>

  <p>
   Multiple constraints can be specified by placing them in square brackets.
   <em>All</em> constraints must be met.  (If you want to do an "OR" of
   constraints, see the <a href="#ConstraintFunctions">Constraint
    Functions</a> section below.)
  </p>

  <p>
   <code>var t is [time, positive] = 10 seconds</code>
  </p>
  
  <h4><a name="ConstrainingByDimensions">Constraining by Dimensions</a></h4>
  <p>
   Built-in constraint types include all of the dimension types defined in
   your program.  For example, you can list all of the defined dimension types
   (<i>e.g.</i> <code>length, mass, power, energy</code>) with the
   <code>dimensions[]</code> or the <code>dimensionsWithValues[]</code>
   functions.  All of these defined types can be used as constraints.
  </p>

  <h4><a name="ConstrainingToBuiltInTypes">Constraining to Built-In Types</a></h4>
  <p>
   The following built-in constraints can be used to verify that the value is
   of one of the built-in types.  For example,
  </p>

  <p>
   <code>var name is string = "Frink"</code>
  </p>

  <table summary="Built-in Constraint Types">
    <tbody><tr><th>Name</th><th>Description
    </th></tr><tr><td>array</td><td>Value must be an <a href="#Arrays">array</a>.
    </td></tr><tr><td>boolean</td><td>Value must be a boolean value
      <code>true</code> or <code>false</code> (and not just
      a type that can be coerced to boolean; see the <a href="#Truth">Truth</a> section.)
    </td></tr><tr><td>date</td><td>Value must be a <a href="#DateTimeHandling">date/time</a>.
    </td></tr><tr><td>dict</td><td>Value must be a <a href="#Dictionaries">dictionary</a>.
    </td></tr><tr><td>set</td><td>Value must be a <a href="#Sets">set</a>.
    </td></tr><tr><td>regexp</td><td>Value must be a <a href="#RegularExpressions">regular expression</a>.
    </td></tr><tr><td>subst</td><td>Value must be a <a href="#SearchAndReplace">substitution</a> (search-and-replace) expression.
    </td></tr><tr><td>string</td><td>Value must be a <a href="#Strings">string</a>.
    </td></tr><tr><td>unit</td><td>Value must be a <a href="#DataLibraries">unit of measure</a> of any type (including
      dimensionless numbers).  You will probably use this rarely; it's more
      likely that you'll want to constrain based on <a href="#ConstrainingByDimensions">dimension type</a>.
  </td></tr></tbody></table>

  <h4><a name="ConstrainingByObjectType">Constraining by Object Type</a></h4>
  <p>
   A class name can also be a constraint name.  If, for example, you've
   defined a class called <code>Sphere</code>, the following will work.
  </p>

  <p>
   <code>a is Sphere = new Sphere[]</code>
  </p>

  <p>
   This constraint check also works with interface names.  If the name of the
   constraint is the name of an interface, this check will ensure that any
   object assigned to the variable implements that interface.  See the <a href="https://frinklang.org/fsp/colorize.fsp?f=interfacetest.frink">interfacetest.frink</a> file for an example.
  </p>
  
  <h4><a name="ConstraintFunctions">Constraint Functions</a></h4>
  <p>
   You may define your own functions that will be used as constraints.  The
   function must take one argument and return a <code>true</code> value if the
   constraint is met.  Returning <code>false</code> or another value will
   cause the constraint to fail.  The following defines a function called
   <code>positive</code> that returns <code>true</code> if a value is a
   positive dimensionless value.
  </p>

  <div>
   <p><br>
   <code>positive[x] := x &gt; 0</code></p><p>
   
   <br>
   <code>var x is positive = 1</code></p></div>
  
  <h3><a name="TestingVariables">Testing Variables</a></h3>
  <p>
   You can test to see if a variable is defined using the following functions:
  </p>

  <table summary="Variable Testing Functions">
    <tbody><tr><th>Function</th><th>Definition
    </th></tr><tr><td>isDefined[<i>x</i>]</td><td>Returns true if the symbol is
      defined either as a local variable in the current scope (i.e. with the
      <code>=</code> operator), or as a unit (i.e. with the <code>:=</code>
      operator.)
    </td></tr><tr><td>isVariableDefined[<i>x</i>]</td><td>Returns true if the
      symbol is defined as a local variable in the current scope (i.e. with the
      <code>=</code> operator).
  </td></tr></tbody></table>

  <p>
   Both functions can be called either with a raw variable name or with a
   string.  For example:
  </p>
  
  <p>
   <code>
    isVariableDefined[a]<br>
    isVariableDefined["a"]
   </code>
  </p>
  
  <h3><a name="GlobalVariables">Global Variables</a></h3>
  <p>
   Ha ha...just kidding.  There are no global variables in Frink.  However, if
   you need to access some sort of "global" values from anywhere in your
   program, without passing them explicitly to each function, you can simulate
   it with class-level variables in a class that you define.  These are
   defined using the <code>class var</code> keywords, and are similar to
   <code>static</code> class-level variables in languages like C++ and Java.
  </p>

  <p>
   If you want to use a "global" variable in only a few functions, you can
   encapsulate those functions into a <code>class</code>.
  </p>
  
  <p>
   For samples of class-level variables and how to access them, see <a href="https://frinklang.org/fsp/colorize.fsp?f=classtest.frink">classtest.frink</a>.
  </p>
  
  <h3><a name="UnicodeInFrink">Unicode in Frink</a></h3>
  <p>
   For internationalization, Frink allows <a href="http://www.unicode.org/">Unicode</a> characters anywhere.  For
   maximum portability, and maximum editability with non-Unicode-aware
   editors, you can use Unicode escapes to embed these characters in program
   files.

  </p><p>
   Variable names can contain Unicode characters, indicated by
   <code>\u</code> followed by exactly 4 hexadecimal digits [0-9a-fA-F]
   indicating the Unicode code-point, for example: <code>\u210e</code> .  In
   addition, a Unicode character can be specified with anywhere from one to
   six hexadecimal digits by placing the digits in brackets, for example:
   <code>\u{FF}</code> or <code>\u{1f638}</code> (this is the Unicode
   character "GRINNING CAT FACE WITH SMILING EYES".  So, yes, you can have
   kitty faces as variable names!)  This allows Unicode characters to be
   placed into any ASCII text file, and edited by programs that don't
   understand Unicode.  It also allows <em>any</em> Unicode character to be
   used in an identifier.
  </p>

  <p>
   If you <em>do</em> have a nifty editor that handles Unicode, or other
   character encodings, you can write your Frink program in full Unicode, and
   load it using the <a href="#CommandLineOptions"><code>--encoding
    <i>str</i></code></a> command-line switch.  Keep in mind that in this
   case, identifiers can only consist of Unicode letters, digits, "other
   symbols" and the underscore.  You still have to use the <code>\u00a5</code>
   Unicode escape trick if your identifier contains other classes of
   characters.
  </p>

  <p>
   For example, Unicode defines the character <code>\u201e</code> for Planck's
   constant.  In the data file, we define Planck's constant as the normal
   character <code>h</code> (which is easier to type) and also as the Unicode
   character.  These definitions look like:
  </p>

  <p>
   <code>
    h := 6.62606876e-34 J s</code> <br>
    <code>\u210e := h</code> 
  </p>

  <p>
   <em>Note:</em> The <code>:=</code> notation simply defines a
   <em>global</em> unit, that is available from all functions.
  </p>

  <h2><a name="SettingDisplayUnits">Setting Display Units</a></h2>
  <p>
   By default, units are displayed with their dimensions given as multiples of
   the
   <a href="http://physics.nist.gov/cuu/Units/units.html">International System
    of Units (SI)</a> base units.  These are often not very intuitive.  For
   example, volts are displayed as:
  </p>

  <p>
   <code>1 volt</code><br>
   <code>1 m^2 s^-3 kg A^-1 (electric_potential)</code>
  </p>

  <p>
   Of course, you could convert to volts explicitly using the
   <code>-&gt;</code> operator, but if you have to do that repeatedly, it's a
   hassle.  Instead, you can define the default output format for a unit type
   by using the <code>:-&gt;</code> operator:
  </p>

  <p>
   <code>electric_potential :-&gt; "volts"</code><br>
   <code>10 volt</code><br>
   <code>10 volts</code>
  </p>

  <p>
   The left-hand side is the dimension list identifier like
   <code>electric_potential</code> or <code>time</code> or <code>power</code>
   (you can see what this is named for any given unit by entering an
   expression of that type--see the first "volt" sample above.)
  </p>

  <p>
   The right-hand side is any expression that can go on the right-hand-side of
   a conversion operator <code>-&gt;</code> , including multiple conversions:
  </p>

  <p>
   <code>time :-&gt; [0, "days", "hours", "minutes", "seconds"]</code><br>
   <code>siderealyear</code><br>
   <code>365 days, 6 hours, 9 minutes, 9.5400288 seconds</code><br>
   <code>siderealday</code><br>
   <code>23 hours, 56 minutes, 4.0899984 seconds</code>
  </p>

  <p>
   The right-hand-side can even be a function that takes a single argument:
  </p>
  
  <p>
   <code>HMS[x] := x -&gt; [0, "hours", "minutes", "seconds"]</code><br>
   <code>time :-&gt; HMS</code><br>
  </p>

  <p>
   If you want, you can define a function that displays distances in
   millimeters if it's small, kilometers if it's bigger, and light-years if
   it's huge.
  </p>

  <h2><a name="SettingPrecision">Setting Precision</a></h2>
  <p>
   Floating-point calculations are performed to a limited number of digits.
   You can change the number of digits of working precision by the
   <code>setPrecision[<i>digits</i>]</code> function:
  </p>

  <p>
   <code>
    setPrecision[50]<br>
    1 / 3.0<br>
   </code>
   <code>0.33333333333333333333333333333333333333333333333333</code>
  </p>

  <p>
   Note that this will only affect calculations performed <em>after</em> this
   flag is set, of course.  Currently, not all operations (notably
   trigonometric functions) can be performed to arbitrary precision.
  </p>

  <p>
   You can also see the current working precision by calling the
   <code>getPrecision[]</code> function:
  </p>

  <p>
   <code>
    getPrecision[]<br>
   </code>
   <code>50</code>
  </p>
  
  <h2><a name="SettingNumberFormats">Setting Number Formats</a></h2>
  <p>
   By default, floating-point numbers are displayed in scientific notation
   with one digit before the decimal point.  This can be changed to
   "engineering" format where 1 to 3 digits are placed before the decimal
   point and the exponent is a multiple of 3.  This allows you to more easily
   see it as "milli-", "micro-", "million", etc.  The call to enable this is:
  </p>

  <p>
    <code>setEngineering[true]</code>
  </p>

  <p>
   Example without engineering mode:
  </p>

  <p>
    <code>d = 140.5 million meters</code><br>
    <code>1.405000000e+8 m (length)</code>
  </p>

  <p>
   Now notice the change if you set "engineering mode" to true.  The result
   comes out so you can more easily read it as "140.5 million meters":

  </p><p>
    <code>setEngineering[true]</code><br>
    <code>d</code><br>
    <code>140.5000000e+6 m (length)</code>
  </p>

  <p>
   In addition, rational numbers are, by default, displayed with a
   floating-point approximation to their values:
  </p>
  
  <p>
   <code>1/10</code><br>
   <code>1/10 (exactly 0.1)</code>
  </p>
  
  <p>
   <code>1/3</code><br>
   <code>1/3 (approx. 0.3333333333333333)</code>
  </p>

  <p>
   This behavior can be suppressed by calling
   <code>showApproximations[<i>false</i>]</code>.
  </p>
  
  <p>
   <code>showApproximations[<i>false</i>]</code><br>
   <code>1/10</code><br>
   <code>1/10</code>
  </p>

  <p>
   You can tell Frink to always <em>display</em> rational numbers as
   floating-point approximations by calling
   <code>rationalAsFloat[true]</code>.  The numbers will still continue to be
   represented internally as rational numbers.
  </p>

  <p>
   <code>rationalAsFloat[<i>true</i>]</code><br>
   <code>1/3</code><br>
   <code>0.33333333333333</code>
  </p>

  <p>
   Frink tries to produce a human-readable description of units of measure,
   such as "power" or "energy" or "temperature":
  </p>
  
  <p>
   <code>1 K</code><br>
   <code>1 K (temperature)</code>
  </p>

  <p>
   This suggestion can be suppressed by calling
   <code>showDimensionName[false]</code>
  </p>
  
  <p>
   <code>showDimensionName[false]</code><br>
   <code>1 K</code><br>
   <code>1 K</code>
  </p>

  <h2><a name="Comments">Comments</a></h2>
  <p>
   Frink allows C/C++/Java-style comments:
  </p>

  <p>
   <code>
    <code>/* This is a block comment.<br>
    &nbsp;&nbsp;&nbsp;It may span multiple lines.<br>
     &nbsp;&nbsp;&nbsp;This type of comment can be nested. */
    </code><br>
   c = 1
   </code><br>
  </p>

  <p>
   <code>a = 1 <code>&nbsp;&nbsp;&nbsp;//&nbsp;This&nbsp;comments&nbsp;to&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;line.</code><br>
    b = 2
   </code>
  </p>
  

  <h2><a name="Functions">Functions</a></h2>
  <p>
   If you repeat a calculation, you may want to define it as a function.
   Functions in Frink are denoted by the function name followed by arguments
   in square brackets, separated by commas.  A function can be defined like
   the following:
  </p>

  <p>
   <code>circlearea[radius] := pi radius^2</code><br>
  </p>

  <p>
   Then, to call the function, say, to find the area of my telescope mirror,
   which has a radius of 2 inches:
  </p>

  <p>
   <code>circlearea[2 inches]</code><br>
   <code>0.008107319665559965 m^2 (area)</code>
  </p>

  <p>
   But that comes out in standard units... let's try again, converting to
   square inches.
  </p>
  
  <p>
   <code>circlearea[2 inches] -&gt; in^2</code><br>
   <code>12.566370</code>
  </p>

  <p>
   You may define multiple functions with the same name but different number
   of arguments.
  </p>

  <h3><a name="MultiLineFunctions">Multi-line Functions</a></h3>
  <p>
   Multi-line functions can be built; just put the body in curly braces.  It
   may be more legible to use the <code>return</code> statement in your
   function.  For example, the factorial function could be written as:
  </p>

  <p>
   <code>
   factorial[x] :=<br>
   {<br>
   &nbsp;&nbsp;&nbsp;if x&gt;1<br>
   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return x * factorial[x-1]<br>
   &nbsp;&nbsp;&nbsp;else<br>
   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return 1<br>
    }
    </code>
  </p>

  <p>
   If a function does not explicitly return a value, the value returned is the
   value of the last expression evaluated.  A <code>return</code> statement
   with no value on the right-hand-side returns a special void type.
  </p>

  <h3><a name="DefaultValues">Default Values</a></h3>
  <p>
   Function declarations can have default values.  Default values are
   specified by putting "<code>= <i>value</i></code>" after a parameter name
   in the function declaration.  For example, if your Willard pocket organizer
   goes out, you can use Frink to calculate the tip on your dinner check, and,
   to make it easy, you can default the tip rate to 15 percent of the bill.
   The function declaration with default parameters is:
  </p>

  <p>
   <code>tip[amount, rate=15 percent] := amount * rate</code><br>
  </p>

  <p>
   Now, when you get to the restaurant, you can easily calculate the tip using
   the default rate:
  </p>
  
  <p>
   <code>tip[80.75 dollars]</code><br>
   <code>12.1125 dollar (currency)</code>
  </p>

  <p>
   Or, if service is outstanding and you want to tip at 20%, you can specify
   the second argument instead of leaving it at the default:
  </p>

  <p>
   <code>tip[80.75 dollars, 20 percent]</code><br>
   <code>16.15 dollar (currency)</code>
  </p>

  <h3><a name="MultipleReturnValues">Multiple Return Values</a></h3>
  <p>
   The previous tip example probably has you thinking, "Well, it would be nice
   if it calculated the total too!"  I'm bad at math, also... that's why I'm
   developing Frink.
  </p>

  <p>
   In Frink, values surrounded by square brackets and separated by commas form
   a list of values.  These lists can be returned from a function, assigned to
   a variable, or whatever.  A better version of the above function would
   be defined to return a list containing the tip <em>and</em> the total as a
   list:
  </p>

  <p>
   <code>tipandtotal[amount, rate=15 percent] := [amount * rate,
   amount * (1+rate)]</code><br>
  </p>

  <p>
   Note the square brackets on the right-hand-side of the definition.  Then, to
   calculate the tip, it's as easy as before:
  </p>
  
  <p>
   <code>tipandtotal[80.75 dollars]</code><br>
   <code>[12.1125 dollar (currency), 92.8625 dollar (currency)]</code>
  </p>

  <p>
   I'll let you do the rounding in your head, or you can use the
   <a href="#RoundingFunctions">rounding functions</a> below.
  </p>

  <h3><a name="RecursiveFunctions">Recursive Functions</a></h3>
  <p>
   Yes indeedy-o, functions can be recursive.  The classic example is the
   factorial:
  </p>

  <p>
   <code>factorial[x] := x&gt;1  ?  x factorial[x-1]  :  1</code><br>
  </p>

  <p>
   This uses the conditional expression <code>condition ? trueClause :
    falseClause</code>.  The condition is first evaluated (it should evaluate
   to a boolean value,) and if it's true, the true clause is evaluated and
   returned, the false clause otherwise.  Let's try a big number, just big
   enough that it would overflow my old solar calculator:
  </p>

  <p>
   <code>factorial[70]</code><br>
   <code>119785716699698917960727837216890987364589381425464258
    57555362864628009582789845319680000000000000000</code>
  </p>

  <p>
   You can still blow out the stack if you go too deep, or forget to put in a
   condition such that the function terminates.  Don't come crying to me.
  </p>
  
  <h3><a name="ConstrainingFunctionArguments">Constraining Function Arguments</a></h3>
  <p>
   Like other variables, formal arguments to functions can have constraints.
   The syntax for constraining is just the same as setting <a href="#ConstraintsOnVariables">Constraints on variables.</a>  For example,
   if you want to make sure that a function that calculates the volume of a
   sphere is passed a radius, the declaration looks like:
  </p>

  <p>
   <code>sphereVolume[radius is length] := 4/3 pi radius^3</code>
  </p>

  <p>
   The constraint(s) are checked at runtime, and if all constraints are not
   met, the function call produces an error.
  </p>

  <p>
   At some point in the future, I'd like to have this choose an appropriate
   function based on the constraints, if more than one is possible.  My
   underlying function dispatching is designed to allow this, but functions
   with constraints may be slower to resolve.
  </p>

  <h2><a name="IfThenElse">If/Then/Else</a></h2>
  <p>
   You can control program flow with the if/then/else construct.  If the
   condition is true, it will execute the first clause, otherwise, if there is
   an (optional) <code>else</code> clause, it will execute the
   <code>else</code> clause.
  </p>

  <p>
   <code>
    if a&lt;10<br>
    {<br>
    &nbsp;&nbsp;&nbsp;println["Less than ten"]<br>
    } else<br>
    {<br>
    &nbsp;&nbsp;&nbsp;println["Greater than ten."]<br>
    }
   </code>
  </p>

  <p>
   <b>Note:</b> Note that putting the brackets and statements on separate
   lines is currently important.  Also, please note that the <code>else</code>
   keyword goes on the same line as the closing bracket of the
   <code>then</code> clause.
  </p>

  <p>
   If either the <code>then</code> or <code>else</code> clause is a single
   line, the curly braces for that clause can be eliminated.  The following is
   the same as the code above:
  </p>
   
  <p>
   <code>
    if a&lt;10<br>
    &nbsp;&nbsp;&nbsp;println["Less than ten"]<br>
    else<br>
    &nbsp;&nbsp;&nbsp;println["Greater than ten."]<br>
   </code>
  </p>

  <p>
   The condition must be able to be turned into a boolean value.  When testing
   for equality, be sure to use the double equals sign, (a single equals
   indicates assignment) <i>e.g.</i>:
  </p>

  <p>
   <code>
    if a==b<br>
    &nbsp;&nbsp;&nbsp;println["Equal."]
   </code>
  </p>

  <p>
   If, for some reason, you need to jam everything into one line, you need to
   add the <code>then</code> keyword:
  </p>

  <p>
   <code>
    if a==b then println["Equal."] else println["Not equal."]
   </code>
  </p>

  <p>
   Alternatively, there is a conditional operator (sometimes called the
   "ternary operator") that can be placed inside an expression.
  </p>

  <p>
   <code>
    <i>condition</i> ? <i>trueClause</i> : <i>falseClause</i>
   </code>
  </p>

  <p>
   If <code>condition</code> evaluates to <code>true</code>, then the result
   is <code>trueClause</code>, otherwise the result
   is <code>falseClause</code>.
  </p>

  <p>
   The ternary conditional operator can be used in any expression:
  </p>

  <p>
   <code>
    println["I have $numCats " + ( numCats == 1 ? "cat" : "cats" ) + "."]
   </code>
  </p>

  <h2><a name="Truth">Truth</a></h2>
  <p>
   The condition in an if/then/else statement or a loop needs to be a boolean
   (true/false) value.  This can either be represented by the special values
   <code>true</code> and <code>false</code>, or the following types can be
   used in places where a boolean value is required:
  </p>

  <table summary="Boolean-Equivalent Expressions">
    <tbody><tr><th>True</th><th>False
    </th></tr><tr><td>true</td><td>false
    </td></tr><tr><td>Any non-empty string</td><td>The empty string <code>""</code>
    </td></tr><tr><td>Any list (even a zero-element list)</td><td>
    </td></tr><tr><td></td><td>The special undefined value <code>undef</code>
  </td></tr></tbody></table>

  <p>
   Any other value will cause a runtime error.  See the <a href="#BooleanOperators">Boolean Operators</a> section below for operators
   that return boolean values.
  </p>

  <h2><a name="Loops">Loops</a></h2>

  <h3><a name="WhileLoop">While Loop</a></h3>
  <p>
   The <code>while</code> loop is a loop with a condition and a body.  The
   body is executed repeatedly while the condition is true.
  </p>
  
  <p>
   <code>
    i=0<br>
    while i&lt;1000000<br>
    {<br>
    &nbsp;&nbsp;&nbsp;i = i+1<br>
    }<br>
   </code>
  </p>

  <p>
   If the body is a single line, the braces can be omitted:
  </p>
  
  <p>
   <code>
    i=0<br>
    while i&lt;1000000<br>
    &nbsp;&nbsp;&nbsp;i = i+1<br>
   </code>
  </p>

  <p>
   You can use the <code>next</code> statement to prematurely jump to the next
   iteration of a <code>while</code> loop.  You can use a labeled
   <code>next</code> statement to jump to the next iteration of a higher
   loop.  See the <a href="#ForLoop">for loop</a> section for an
   example.
  </p>
  
  <p>
   You can use the <code>break</code> statement to exit the smallest
   containing loop.  You can also use labeled break statements to break out to
   a higher loop:
  </p>

  <p>
   <code>
    i=0<p>
    
    OUTERLOOP:<br>
    while i&lt;1000000<br>
    {<br>
    &nbsp;&nbsp;&nbsp;i = i+1<br>
    &nbsp;&nbsp;&nbsp;j = i<br>
    &nbsp;&nbsp;&nbsp;while j&lt;1000000<br>
    &nbsp;&nbsp;&nbsp;{<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j = j+1<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if i+j &gt; 1000000<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break OUTERLOOP //
    Breaks out of both loops<br>
    &nbsp;&nbsp;&nbsp;}<br>
    }
   </p></code>
  </p>

  <p>
   The label must precede the loop <em>on a separate line</em> and be followed
   by a colon.
  </p>

  <h3><a name="UntilLoop">Until Loop</a></h3>
  <p>
   The <code>until</code> loop is a loop with a condition and a body.  The
   body is executed repeatedly until the condition is true.
  </p>
  
  <p>
   <code>
    i=0<br>
    until i&gt;1000000<br>
    {<br>
    &nbsp;&nbsp;&nbsp;i = i+1<br>
    }<br>
   </code>
  </p>

  <p>
   If the body is a single line, the braces can be omitted:
  </p>
  
  <p>
   <code>
    i=0<br>
    until i&gt;1000000<br>
    &nbsp;&nbsp;&nbsp;i = i+1<br>
   </code>
  </p>

  <p>
   You can break out of an <code>until</code> loop using <code>break</code>
   and <code>next</code> statements exactly as specified in
   the <a href="#WhileLoop"><code>while</code></a> loop documentation above.
  </p>
  
  <h3><a name="DoWhileLoop">Do...While Loop</a></h3>
  <p>
   The <code>do...while</code> loop is much like the <code>while</code> loop,
   the only difference being that with the <code>do</code> loop, the body of
   the loop is always executed at least once, and then the condition is
   checked.  The body of the loop then repeats as long as the condition is
   true.
  </p>
  
  <p>
   <code>
    i=0<br>
    do<br>
    {<br>
    &nbsp;&nbsp;&nbsp;i = i+1<br>
    } while i&lt;1000
   </code>
  </p>

  <p>
   If the body is a single line, the braces can be omitted, but each part of
   the loop has to be on a different line:
  </p>
  
  <p>
   <code>
    i=0<br>
    do<br>
    &nbsp;&nbsp;&nbsp;i = i+1<br>
    while i&lt;1000
   </code>
  </p>

  <p>
   You can use the <code>next</code> statement to prematurely jump to the next
   iteration of a <code>do...while</code> loop.  You can use a labeled
   <code>next</code> statement to jump to the next iteration of a higher
   loop.  See the <a href="#ForLoop">for loop</a> section for an
   example.
  </p>

  <p>
   You can use the <code>break</code> statement to exit the smallest
   containing loop.  You can also use labeled break statements to break out to
   a higher loop.  See the <a href="#WhileLoop">while loop</a> section of the
   documentation for an example.
  </p>

  <h3><a name="DoUntilLoop">Do...Until Loop</a></h3>
  <p>
   The <code>do...until</code> loop is much like the <code>do...while</code>
   loop, the only difference being that the body of the loop repeats until the
   condition becomes true.
  </p>
  
  <p>
   <code>
    i=0<br>
    do<br>
    {<br>
    &nbsp;&nbsp;&nbsp;i = i+1<br>
    } until i == 1000
   </code>
  </p>

  <p>
   If the body is a single line, the braces can be omitted, but each part of
   the loop has to be on a different line:
  </p>
  
  <p>
   <code>
    i=0<br>
    do<br>
    &nbsp;&nbsp;&nbsp;i = i+1<br>
    until i == 1000
   </code>
  </p>
  
  <p>
   You can break out of a <code>do..until</code> loop using <code>break</code>
   and <code>next</code> statements exactly as specified in
   the <code>while</code> loop documentation above.
  </p>
  
  <h3><a name="ForLoop">For Loop</a></h3>
  <p>
   The above <code>while</code> loop can also be written as:
  </p>

  <p>
   <code>
    for i = 1 to 1000000<br>
    {<br>
    &nbsp;&nbsp;&nbsp;<i>body</i><br>
    }
   </code>
  </p>

  <p>
   If the body is a single line, the curly braces can be omitted.  The above
   sample can be written as:
  </p>
  
  <p>
   <code>
    for i = 1 to 1000000<br>
    &nbsp;&nbsp;&nbsp;<i>body</i>
   </code>
  </p>


  <p>
   The range and step size can be specified using the <code>step</code>
   keyword:
  </p>
  
  <p>
   <code>for i = 1 to 1000 step 3</code>
  </p>

  <p>
   The step is <em>required</em> to be specified for any range in which the
   limits are not dimensionless integers.  For example:
  </p>
  
  <p>
   <code>for i = 0 miles to 1 mile step 1 foot</code>
  </p>

  <p>
   This also works with a date range, but the step <em>must</em> be specified
   and it must have dimensions of time:
  </p>

  <p>
   <code>for time = #2001-01-01# to #2002-01-01# step 1 day</code>
  </p>

  <p>
   A loop can loop over single-character strings.  The loop will normally loop
   upwards, but this can be changed by specifying a negative integer for
   the <code>step</code>.  Each value will be a single-character string.  This
   cannot be used to iterate over undefined Unicode codepoints.
  </p>

  <p>
   <code>
    for c = "a" to "z"<br>
    &nbsp;&nbsp;&nbsp;print[c]<br>
   </code>
   <code>abcdefghijklmnopqrstuvwxyz</code>
  </p>

  <p>
   <code>
    for c = "z" to "a" step -1<br>
    &nbsp;&nbsp;&nbsp;print[c]<br>
   </code>
   <code>zyxwvutsrqponmlkjihgfedcba</code>
  </p>
  
  <p>
   The boundaries of a loop may also be boolean values:
  </p>

  <p>
   <code>for x = false to true</code>
  </p>
  
  <p>
   Other orderings are allowed such as <code>true to false</code> or
   <code>true to true</code> (the latter only goes through the loop once.)
  </p>
  
  <p>
   The <code>for</code> loop is also used to iterate over the contents of
   an <a href="#EnumeratingExpressions">enumerating expression</a> or array.  (You can think of it as a "for each"
   loop, which is really what it is.)
  </p>

  <p>
   <code>a = ["zero", "one", "two"]<br>
    for x = a<br>
    &nbsp;&nbsp;&nbsp;println[x]<br>
   </code>
   <code>
    zero<br>
    one<br>
    two<br>
   </code>
  </p>

  <p>
   The <code>rangeOf[<i>array</i>]</code> function returns an enumeration of
   all the indices in an array.
  </p>

  <p>
   <code>a = ["zero", "one", "two"]<br>
    for i = rangeOf[a]<br>
    &nbsp;&nbsp;&nbsp;println["index $i contains " + a@i]<br>
   </code>
   <code>
    index 0 contains zero<br>
    index 1 contains one<br>
    index 2 contains two<br>
   </code>
  </p>

  <p>
   You can also use the <code>for</code>
   loop to iterate over the contents of Java objects.  See the <a href="#IteratingOverJavaCollections">Iterating over Java Collections</a>
   section of the documentation for more.
  </p>

  <p>
   If the <a href="#EnumeratingExpressions">enumerating expression</a> produces a list, and you want to break apart
   that list into named variables in the <code>for</code> loop, write it as:
  </p>

  <p>
   <code>
    for [<i>var1</i>, <i>var2, ...</i>] = <i>enumerating_expression</i><br>
    {<br>
    &nbsp;&nbsp;&nbsp;<i>body</i><br>
    }
   </code>
  </p>

  <p>
   Again, if the body is a single line, the curly braces may be
   omitted:
  </p>

  <p>
   <code>
    for [var1, var2] = <i>enum</i><br>
    &nbsp;&nbsp;&nbsp;<i>body</i>
   </code>
  </p>

  <p>
   See the <a href="#InputAndOutput">Input and Output</a> section below for a
   sample of its use.
  </p>

  <p>
   You can use the <code>next</code> statement to prematurely jump to the next
   iteration of a <code>for</code> loop.  You can use a labeled
   <code>next</code> statement to jump to the next iteration of a higher loop:
  </p>

  <p>
   <code>
    OUTERLOOP:<br>
    for i = 1 to 1000<br>
    {<br>
    &nbsp;&nbsp;&nbsp;for j = i to 1001<br>
    &nbsp;&nbsp;&nbsp;{<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if i+j &gt; 1000<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;next OUTERLOOP <code>// Jumps to next iteration of outer loop</code><br>
    &nbsp;&nbsp;&nbsp;}<br>
    }
   </code>
  </p>

  <p>
   The label must precede the loop <em>on a separate line</em> and be followed
   by a colon.
  </p>
  
  <p>
   You can use the <code>break</code> statement to exit the smallest
   containing loop.  You can also use labeled break statements to break out to
   a higher loop.  See the <a href="#WhileLoop">while loop</a> section of the
   documentation for an example.
  </p>
  
  <p>
   (<i>Note to programmers:</i> The special keyword <code>to</code> creates an
   <a href="#EnumeratingExpressions">enumerating expression</a> that successively takes on all values from the
   beginning to the end, inclusive, with the default step being 1.  (The step
   size can be changed as shown below.)  You can use this <code>to</code>
   notation anywhere to create an <a href="#EnumeratingExpressions">enumerating expression</a> that takes on
   successive values.  You can even make it into an array using the
   <code>array</code> function:)
  </p>

  <p>
   <code>
    a = array[1 to 10]<br></code>
    <code>[1, 2, 3, 4, 5, 6, 7, 8, 9, 10]</code>
  </p>

  <p>
   You can create an more flexible <a href="#EnumeratingExpressions">enumerating expression</a> that does the same
   as the above by using the format: <code>new range[1, 10]</code> or
   <code>new range[1, 10, 2]</code> formats.  Use this if you're going to
   assign to variables or use the range symbolically.
  </p>

  <h3><a name="MultiforLoop">Multifor Loop</a></h3>
  <p>
   For programs that require nested <code>for</code> loops for which it's not
   known in advance how many nested loops will be needed, the
   <code>multifor</code> construct allows multiple loops to be created simply:
  </p>

  <p>
   <code>
    multifor [a, b, c] = [1 to 2, 1 to 3, 1 to 5]<br>
    &nbsp;&nbsp;&nbsp;println["$a $b $c"]
   </code>
  </p>

  <p>
   An similar (and technically better in almost all ways) way of writing
   the loop above would be to create new <code>range</code> objects:
  </p>

  <p>
   <code>
    bounds = [new range[1,2], new range[1,3], new range[1,5]]<br>
    multifor [a, b, c] = <i>bounds</i><br>
    &nbsp;&nbsp;&nbsp;<i>println["$a $b $c"]</i>
   </code>
  </p>

  <p>
   A typical idiom for creating a multi-loop is to use the
   <code>makeArray</code> function to create array bounds.  For example, the
   following creates in effect 8 nested loops, each running from 1 to 2.  The
   results are assigned as an array to the variable <code>d</code>.
  </p>

  <p>
   <code>
    upper = 2<br>
    bounds = makeArray[[8], new range[1,upper]]<br>
    multifor d = bounds<br>
    &nbsp;&nbsp;&nbsp;println[d]
   </code>
  </p>

  <p>
   As of the 2012-09-04 release, the bounds of one loop can now depend on the
   bounds of the loops to its left, for example:
  </p>

  <p>
   <code>
    multifor [f,g] = [new range[1,3], new range[f+1,3]]<br>
    &nbsp;&nbsp;&nbsp;println["$f $g"]
   </code>
  </p>

  <p>
   You can use the <code>next</code> statement to prematurely jump to the next
   iteration of a <code>multifor</code> loop.  You can use a labeled
   <code>next</code> statement to jump to the next iteration of a higher
   loop.  See the <a href="#ForLoop">for loop</a> section for an
   example.
  </p>

  <p>
   There's a version of the <code>next</code> statement that jumps to a
   specified level of a <code>multifor</code> loop.  The leftmost/highest
   level is level 0, and the next levels increment to the right.  The loop
   must be labeled and the index to jump to follows the label in the
   <code>next</code> statement.  For example <code>next LOOP i</code> 
  </p>

  <p>
   The program <a href="https://frinklang.org/fsp/colorize.fsp?f=multinexttest.frink">multinexttest.frink</a>
   demonstrates the use of this construct.
  </p>

  <h3><a name="GrayCodes">Gray Codes</a></h3>
  <p>
   A Gray code is a sequence in which only one element of the sequence changes
   at a time.  The best-known Gray code is called the "binary reflected Gray
   code" but a large number of different Gray codes are possible.  You can
   iterate through finite and infinite Gray code sequences using
   the <code>grayCode</code> function.
  </p>

  <p>
   The <code>grayCode</code> functions return an <a href="#EnumeratingExpressions">enumerating expression</a> that
   returns an array of values.
  </p>

  <p>
   <b>Finite-length (n, k) Gray Code</b>:  An (n, k) Gray Code is a Gray code
   with <code>n</code> states per element and <code>k</code> elements.  For
   example, the typical binary reflected Gray code is a (2, k) code.  This is
   generated by calling <code>grayCode[<i>n</i>, <i>k</i>]</code>
   where <code>n</code> and <code>k</code> are integers.  For example to
   generate a binary Gray code with 3 digits:
  </p>

  <p>
   <code>
    for c = grayCode[2, 3]<br>
    &nbsp;&nbsp;&nbsp;println[c]</code>
   <code>
    [0, 0, 0]<br>
    [0, 0, 1]<br>
    [0, 1, 1]<br>
    [0, 1, 0]<br>
    [1, 1, 0]<br>
    [1, 1, 1]<br>
    [1, 0, 1]<br>
    [1, 0, 0]<br>
   </code>
  </p>

  <p>
   <b>Finite-length Gray Code with arbitrary states</b>:  You can generate a
   finite-length Gray code where each element can have an arbitrary set of
   states, specified as an array of arrays:
  </p>
  
  <p>
   <code>
    args = [ ["A", "B"], [1, 3, 5] ]<br>
    for c = grayCode[args]<br>
    &nbsp;&nbsp;&nbsp;println[c]</code>
   <code>
    [A, 1]<br>
    [A, 3]<br>
    [A, 5]<br>
    [B, 5]<br>
    [B, 3]<br>
    [B, 1]<br>
   </code>
  </p>
  
  <p>
   <b>Infinite-length Gray Code</b>:  You can generate a
   infinite-length Gray code where each element has the same number of
   states.  This is different from the other Gray code examples because the
   least-significant element is returned as element 0 in the array, which gets
   longer as more elements are needed.  For example, to generate a binary
   reflected Gray code, use <code>grayCode[2]</code>:
  </p>
  
  <p>
   <code>
    for c = grayCode[2]<br>
    &nbsp;&nbsp;&nbsp;println[c]</code>
   <code>
    [0]<br>
    [1]<br>
    [1, 1]<br>
    [0, 1]<br>
    [0, 1, 1]<br>
    [1, 1, 1]<br>
    [1, 0, 1]<br>
    [0, 0, 1]<br>
    [0, 0, 1, 1]<br>
    [1, 0, 1, 1]<br>
    [1, 1, 1, 1]<br>
    [0, 1, 1, 1]<br>
    ...<br>
   </code>
  </p>
  
  <h2><a name="SelfEvaluation">Self-Evaluation</a></h2>
  <p>
   Frink can evaluate a string as a Frink expression.  If that means something
   to you, good.  It's cool.  You can make programs that write and run their
   own programs.  Frink became self-aware on December 7, 2001 at 9:26 PM MST.
   This is 1561.926 days after Skynet became self-aware.  History will be the
   judge if <em>this</em> December 7th is another date that will live in
   infamy.
  </p>

  <p>
   <code>eval["2 + 2"]</code><br>
   <code>4</code>
  </p>

  <p>
   This behavior can also be used to convert a string into a number.  It
   allows users to enter information as any Frink expression such as <code>"6
    billion tons"</code> or <code>2+2</code> and have it handled correctly.
   See the <a href="#Input">Input</a> section below for examples of its use.
  </p>

  <p>
   <code>eval[]</code> can also be used to perform another layer of evaluation
   on a value that is not a string.
  </p>

  <p>
   If <code>eval[]</code> is passed an array, all elements of the array will
   be individually evaluated and the result will be returned in an array.
  </p>

  <p>
   There is also a two-argument version, <code>eval[<i>expression</i>,
   <i>rethrows</i>]</code> where the <code>rethrows</code> argument is a
   boolean flag indicating if we want evaluation errors to be thrown or just
   suppressed and <code>undef</code> returned.  If it is true, errors will be
   rethrown as Java exceptions, otherwise an error returns <code>undef</code>.
  </p>

  <p>
   There is also a three-argument version, <code>eval[<i>expression</i>,
   <i>rethrows</i>, <i>hidesLocals</i>]</code> where the
   <code>hidesLocal</code> argument is a boolean flag indicating if we want
   to hide local variables before evaluation.
  </p>
  <h3><a name="SecurityRestrictionsOnEval">Security Restrictions on eval[]</a></h3>
  <p>
   The <code>eval[]</code> function restricts some insecure operations from
   being performed (<i>e.g.</i> you can't read files from the local
   filesystem.)  If you need all functions to be available from your
   evaluation, use the intentionally frighteningly-named
   <code>unsafeEval[<i>str</i>]</code>
  </p>

  <h2><a name="Arrays">Arrays</a></h2>
  <p>
   Arbitrarily-dimensional, non-rectangular, heterogeneous arrays are
   possible.  (If you're playing "buzzword bingo," you just won.)  Array
   indices are zero-based.  Arrays are indicated by square brackets.
  </p>

  <p>
   <code>c = [1, 2, 3]</code><br>
  </p>

  <p>
   You can break arrays into multiple lines by inserting newlines after the
   commas:
  </p>
   
  <p>
   <code>b = [1, 2, 3,<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4, 5, 6,<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7, 8, 9]</code>
  </p>

  <p>
   Think of multidimensional arrays as being a list of lists.  For example,
   to create a 2-dimensional array:
  </p>

  <p>
   <code>a = [[1, 2, 3],<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[4, 5, 6],<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[7, 8, 9]]</code>
  </p>

  <p>
   To get elements out, use the lovely @ operator (yes, I'm running out of
   bracket types... square brackets would be indistinguishable from function
   calls):
  </p>

  <p>
   <code>a@0</code><br>
   <code>[1, 2, 3]</code><br>
   <code>a@0@2</code><br>
   <code>3</code><br>
  </p>

  <p>
   The method <code><i>array</i>.get[<i>index</i>, <i>altValue</i>]</code>
   can be used to look up the value corresponding to
   the non-negative integer <code>index</code> or return the alternate
   value <code>altValue</code> if the array does not contain that index.
  </p>
  
  <p>
   Arrays can be modified in place and automatically extended:
  </p>
  
  <p>
   <code>a@3= "Monkey"</code><br>
   <code>[[1, 2, 3], [4, 5, 6], [7, 8, 9], Monkey]</code><br>
   <code>a@0@2 = 42</code><br>
   <code>[[1, 2, 42], [4, 5, 6], [7, 8, 9], Monkey]</code><br>
  </p>

  <p>
   To get the length of an array, use the <code>length</code> function:<br>
   <code>length[a]</code><br>
   <code>4</code><br>
  </p>

  <p>
   With the advent of array manipulation, I've proven to myself that Frink is
   capable of simulating a Turing machine, and thus, as of December 12, 2001,
   at 10:16 PM MST, Frink is theoretically capable of calculating anything
   calculable by any other programming language.
  </p>

  <p>
   To create a new empty array, use the notation:
  </p>

  <p>
   <code>a = new array</code>
  </p>

  <p>
   or use one of the <code>makeArray</code> functions described in the next
   section to create arrays and initialize them.
  </p>

  <h3><a name="InitializingArrays">Initializing Arrays</a></h3>
  <p>
   One-dimensional or multi-dimensional "rectangular" arrays can be
   constructed with the <code>makeArray[<i>dims</i>,
   <i>initialValue</i>]</code> function where <code>dims</code> is an
   <em>array</em> of integers indicating the dimensions of the array, and
   <code>initialValue</code> is the initial value to set in each cell.
   Multi-dimensional arrays are implemented as arrays of arrays.
  </p>

  <p>
   Create a 1-dimensional array with 10 elements, with each element
   initialized to 0:
  </p>

  <p>
   <code>a = makeArray[[10], 0]</code><br>
   <code>[0,0,0,0,0,0,0,0,0,0]</code>
  </p>

  <p>
   Create a 2-dimensional array with size 3x4, initialized to 0:
  </p>

  <p>
   <code>a = makeArray[[3,4], 0]</code><br>
   <code>[[0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0]]</code>
  </p>
  
  <p>
   If called without an initial value, the array is initialized as sparse and
   compact to conserve memory, but you may get errors if reading elements
   you haven't initialized.
  </p>

  <p>
   <code>a = makeArray[[3,4]]</code><br>
   <code>[[], [], []]</code>
  </p>

  <p>
   Array elements can still be assigned to, and the appropriate rows will get
   extended to fit them:
  </p>

  <p>
   <code>a@2@2 = 0</code><br>
   <code>[[], [], [undef, undef, 0]]</code>
  </p>

  <p>
   <b>Note</b>: <em>All</em> arrays can still be automatically extended by
   assigning to a value outside their currently-defined range.  Creating an
   array with the <code>makeArray</code> methods does <em>not</em> prevent
   arrays from being extended nor prevent them from becoming non-rectangular.
   It is <em>never</em> necessary to pre-allocate a one-dimensional array of a
   specific size, as all arrays will automatically resize on assignment.
  </p>

  <p>
   If <code>initialValue</code> is a function (it can be
   an <a href="#AnonymousFunctions">Anonymous Function</a>), then that
   function is called to provide the value for each cell.  The function must
   have the same number of arguments as the dimensions of the array, and it is
   passed the indices of the cell.  For example, element [0,0] of the array
   will be passed the arguments [0,0].
  </p>

  <p>
   The following makes a cell with each value initialized to twice its index.
  </p>

  <p>
   <code>makeArray[[10], {|x| 2x}]</code><br>
   <code>[0, 2, 4, 6, 8, 10, 12, 14, 16, 18]</code>
  </p>

  <p>
   A two-dimensional array requires a function with 2 arguments.  The
   following builds a multiplication table:
  </p>

  <p>
   <code>makeArray[[5,5], {|a,b| a*b}]</code><br>
   <code>[[0, 0, 0, 0, 0], [0, 1, 2, 3, 4], [0, 2, 4, 6, 8], [0, 3, 6, 9, 12], [0, 4, 8, 12, 16]]</code>
  </p>

  <p>
   If the <code>makeArray</code> function needs additional data, you can use
   the three-argument
   version <code>makeArray[<i>dimensions</i>, <i>function</i>, <i>data</i>]</code>
   which passes an arbitrary <code>data</code> expression to
   <code>function</code> as a last argument.  For example, the following
   creates a "diagonal" matrix with the specified values passed in as an array
   as the diagonal entries:
  </p>

  <p>
   <code>
    array = [1,2,3]<br>
    d = length[array]<br>
    m = makeArray[[d,d], {|a,b,data| a==b ? data@a : 0}, array]<br>
   </code>
   <code>[[1, 0, 0], [0, 2, 0], [0, 0, 3]]</code>
  </p>
  
  
  <h3><a name="ArrayMethods">Array Methods</a></h3>
  <h4><a name="Copying">Copying</a></h4>
  <p>It is very important to note that arrays are normally passed by
   reference.  This means that if you assign an array to another variable, and
   modify the second variable, then you are modifying the original!
  </p>

  <p>
   <code>a = [3,2,1]<br>
    b = a<br>
    sort[b]<br>
    println[a]   // a is also sorted!</code><br>
   <code>[1,2,3]</code>
  </p>

  <p>
   To avoid this behavior, use the method
   <code><i>array</i>.shallowCopy[]</code>.  This makes a shallow copy of the
   object.
  </p>
  
  <p>
   <code>a = [3,2,1]<br>
    b = a.shallowCopy[]<br>
    sort[b]<br>
    println[a]   // a is now not sorted.</code><br>
   <code>[3,2,1]</code>
  </p>
  
  <h4><a name="PushingAndPopping">Pushing and Popping</a></h4>
  <p>
   Arrays can be automatically extended and used as a stack by using the
   methods:
  </p>
  
  <ul>
   <li><code><i>array</i>.push[<i>x</i>]</code> : Appends an item to the end
    of the array (top of stack).
    
   </li><li><code><i>array</i>.pop[]</code> : Removes an item from the end of the
    array (top of stack) and returns it.
    
   </li><li><code><i>array</i>.peek[]</code> : Returns the item from the end of
    the array (top of stack) <em>without</em> removing it from the
    array/stack.   If the array is empty, this will
    return <code>undef</code>.
    
   </li><li><code><i>array</i>.isEmpty[]</code> : returns <code>true</code> if the
    array is empty, <code>false</code> othewise.

   </li><li><code><i>array</i>.pushFirst[<i>x</i>]</code> : pushes an item onto
    the <em>beginning</em> of an array.

   </li><li><code><i>array</i>.popFirst[]</code> : removes an item from
    the <em>beginning</em> of an array and returns it.

   </li><li><code><i>array</i>.pushAll[<i>array1</i>]</code> : pushes all the
    items from <code>array1</code> onto the end of <code>array</code>,
    modifying it in-place.  You can also use
    the <a href="#Concatenating"><code>concat[<i>a</i>, <i>b</i>]</code></a>
    function if you do not want to modify in-place.
  </li></ul>

  <p>
   <code>array = [1, 2]<br>
    array.push[3]</code><br>
   <code>[1, 2, 3]</code>
  </p>

  <p>
   <code>array = [1, 2, 3]<br>
    c = array.pop[]<br>
   array</code> now contains <code>[1, 2]</code><br>
   <code>c</code> now contains <code>3</code>
  </p>

  <p>
   Items can also be inserted or popped from the <em>front</em> of an array by
   using the methods <code><i>array</i>.pushFirst[<i>x</i>]</code> and
   <code>a.popFirst[]</code> methods.
  </p>

  <p>
   The contents of one array can be appended to another array using the
   <code><i>array</i>.pushAll[<i>array1</i>]</code> method, which modifies the
   original array in place:
  </p>
  
  <p>
   <code>
    a = [1, 2, 3]<br>
    b = [4, 5, 6]<br>
    a.pushAll[b]<br>
   </code>
   <code>[1, 2, 3, 4, 5, 6]</code><br>
  </p>

  <p>
   You can also use
   the <a href="#Concatenating"><code>concat[<i>a</i>, <i>b</i>]</code></a>
   function if you do not want to modify in-place.
  </p>
  
  <h4><a name="Dimensions">Dimensions</a></h4>
  <p>
   The dimensions of a possibly-multi-dimensional array can be obtained with
   the <code><i>array</i>.dimensions[]</code> method.  The arrays do not have
   to be rectangular; this returns the highest index of any sub-array.
  </p>

  <p>
   <b>Warning:</b>  This may be a computationally-expensive call because it
   must traverse every element of every sub-array.  Do not use it repeatedly
   in a tight loop on large arrays.
  </p>

  <p>
   For example, the following array has 2 rows and 3 columns so it
   returns <code>[2, 3]</code>.
  </p>

  <p>
   <code>
    a = [[1, 2, 3], [4, 5, 6]]<br>
    a.dimensions[]<br>
   </code>
   <code>[2, 3]</code><br>
  </p>

  <h4><a name="ColumnOperations">Column Operations</a></h4>
  <p>
   You can retrieve and set all of the values in a column of a 2-dimensional
   (or higher) array using the <code>getColumn</code>
   and <code>setColumn</code> functions, and in most cases, with
   the <code>getColumn</code> and <code>setColumn</code> methods of
   the <code>array</code> class.
  </p>

  <table summary="Column Functions">
    <tbody><tr><th>Function</th><th>Definition
    </th></tr><tr><td>getColumn[<i>array2D</i>, <i>colNum</i>, <i>default=undef</i>]</td><td>From
      the two-dimensional (or higher) array <code>array2D</code>, return column
      number <code>colNum</code> (0-indexed), or, if that column does not exist,
      create a new column with the same number of rows as the rest of the table
      where each value is <code>default</code>.   The returned array is a
      one-dimensional array in row (not column) form so it can easily be passed
      to functions like <code>sum</code>.

    </td></tr><tr><td>setColumn[<i>array2D</i>, <i>newCol</i>, <i>colNum</i>]</td><td>Into
      the two-dimensional (or higher) array <code>array2D</code>, set the
      one-dimensional array <code>newCol</code> (in row form) as column
      number <code>colNum</code> (0-indexed), replacing any data that may
      already be there.  If that column does not exist, create a new column in
      that place.
      
    </td></tr><tr><td>insertColumn[<i>array2D</i>, <i>colNum</i>,
      <i>value</i>]</td><td>Inserts a column <em>before</em> column
      number <code>colNum</code> (0-indexed) in
      the two-dimensional (or higher) array, setting the values in the column
      to <code>value</code>.  If inserting beyond the end of the table,
      multiple columns will be created if necessary.  This modifies the array
      in place.

    </td></tr><tr><td>removeColumn[<i>array2D</i>, <i>colNum</i>]</td><td>From
      a two-dimensional (or higher) array, remove the column number specified
      by <code>colNum</code>.  If this index does not exist, do nothing.  This
      modifies the array in place.
  </td></tr></tbody></table>

  <p>
   The following are <em>methods</em> on most implementations of
   the <code>array</code> class.  If these are not supported in some
   implementations of arrays, the functions above can be used instead.
  </p>

  <table summary="Column Functions">
    <tbody><tr><th>Method</th><th>Definition
    </th></tr><tr><td><i>array</i>.getColumn[<i>colNum</i>, <i>default=undef</i>]</td><td>From
      the two-dimensional (or higher) array, return column
      number <code>colNum</code> (0-indexed), or, if that column does not
      exist, create a new column with the same number of rows as the rest of
      the table where each value is <code>default</code>.  The returned array
      is a one-dimensional array in row (not column) form so it can easily be
      passed to functions like <code>sum</code>.

    </td></tr><tr><td><i>array</i>.setColumn[<i>newCol</i>, <i>colNum</i>]</td><td>Into
      the two-dimensional (or higher) array, set the one-dimensional
      array <code>newCol</code> (in row form) as column
      number <code>colNum</code> (0-indexed), replacing any data that may
      already be there.  If that column does not exist, create a new column in
      that place.

    </td></tr><tr><td><i>array</i>.insertColumn[<i>colNum</i>,
      <i>value</i>]</td><td>Inserts a column <em>before</em> column
      number <code>colNum</code> (0-indexed) in
      the two-dimensional (or higher) array, setting the values in the column
      to <code>value</code>.  If inserting beyond the end of the table,
      multiple columns will be created if necessary.  This modifies the array
      in place.

    </td></tr><tr><td><i>array</i>.removeColumn[<i>colNum</i>]</td><td>From a
      two-dimensional (or higher) array, remove the column number specified
      by <code>colNum</code>.  If this index does not exist, do nothing.  This
      modifies the array in place.
  </td></tr></tbody></table>
  
  <p>
   Note that there not corresponding <code>getRow</code>
   and <code>setRow</code> operations because rows in a 2-dimensional array
   are already arrays and can be obtained with the <code>@</code>
   array-dereferencing operator.  For example, row 0 of the two-dimensional
   array <code>ary</code> can be obtained and set with <code>ary@0</code>.
  </p>

  <p>
   The following example performs a spreadsheet-like operation of summing each
   of the columns of a two-dimensional array and appending the totals of each
   row in a new row.
  </p>

  <p>
   <code>
    a = [[1,2,3],<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[3,4,5]]<br>
    [rows, cols] = a.dimensions[]<br>
    for colNum = 0 to cols-1<br>
    {<br>
    &nbsp;&nbsp;&nbsp;col = a.getColumn[colNum, 0]<br>
    &nbsp;&nbsp;&nbsp;sum = sum[col]<br>
    &nbsp;&nbsp;&nbsp;col.push[sum]<br>
    &nbsp;&nbsp;&nbsp;a.setColumn[col, colNum]<br>
    }<p>
    
    println[formatTable[a]]</p></code>
   <code>1 2 3<br>
3 4 5<br>
4 6 8<br></code>
  </p>


  <h4><a name="Concatenating">Concatenating</a></h4>
  <p>
   You can concatenate two arrays (or
   other <a href="#EnumeratingExpressions">enumerating expressions</a>) using
   the 
   <code>concat[<i>array1</i>, <i>array2</i>]</code> function.  (Note that
   this is a <em>function</em>, not a method on arrays!)  This returns a new
   array that is the concatenation of the elements of both arrays.  For now,
   the result is always an array, but this may change
   to be more memory-efficient by letting arbitrary <a href="#EnumeratingExpressions">enumerating expressions</a>
   to follow each other.
  </p>

  <p>
   This does not do any deep copying of the elements.
  </p>

  <p>
   <code>
    a = [1, 2, 3]<br>
    b = [4, 5, 6]<br>
    c = concat[a,b]<br>
    println[c]<br>
   </code>
   <code>[1, 2, 3, 4, 5, 6]</code><br>
  </p>

  <h4><a name="InsertingAndRemoving">Inserting And Removing</a></h4>
  <p>Items can be inserted into an array using the method
   <code><i>array</i>.insert[<i>index</i>, <i>value</i>]</code>.  This inserts
   the specified value <em>before</em> the item at the specified index.  If the
   index is greater than or equal to the size of the array, the array is
   extended to fit the new elements, setting any unspecified values to the
   undefined value <code>undef</code>.
  </p>

  <p>
   <code>array = [0, 1, 2]<br>
    array.insert[0, "first"]<br>
   array</code> now contains <code>[first, 0, 1, 2]</code>
  </p>

  <p>
   Items can be removed from an array using the method
   <code><i>array</i>.remove[<i>index</i>]</code>.  This removes the item with
   the specified index and returns it, so you can do something with the value
   if desired.  If the specified index does not exist, this generates an error.
  </p>
  
  <p>
   <code>array = ["a", "b", "c"]<br>
    n = array.remove[1]<br>
   array</code> now contains <code>["a", "c"]</code>
  </p>

  <p>
   A range of values can be removed with the
   <code><i>array</i>.remove[<i>start</i>, <i>end</i>]</code> method which
   removes elements starting with index <code>start</code> (inclusive) and
   ending <em>before</em> index <code>end</code> (exclusive.)  The number of
   items that will be removed is <code>start-end</code>.  The return value is
   the number of items that were actually removed.  (The end index is allowed
   to run off the end of the array.)
  </p>

  <p>
   <code>array = [0, 1, 2, 3, 4, 5]<br>
    array.remove[2,4]<br>
   array</code> now contains <code>[0, 1, 4, 5]</code>
  </p>
  
  <p>
   Similarly, a range of values can be removed with the
   <code><i>array</i>.removeLen[<i>start</i>, <i>length</i>]</code> method
   which removes elements starting with index <code>start</code> (inclusive)
   and removes <code>length</code> number of items.  The return value is the
   number of items that were actually removed (the length may run off the end
   of the array.)
  </p>

  <p>
   <code>array = [0, 1, 2, 3, 4, 5]<br>
    array.removeLen[2,2]<br>
   array</code> now contains <code>[0, 1, 4, 5]</code>
  </p>
  
  <p>
   Items with a specified <em>value</em> can be removed from an array using
   the method <code><i>array</i>.removeValue[<i>value</i>]</code>.  This
   removes the first item having the specified <em>value</em> from the array.
   If a matching item is found, this returns <code>true</code>, otherwise
   returns <code>false</code>.
  </p>

  <p>
   <code>array = ["one", "two", "three"]<br>
   array.removeValue["two"]<br> array</code> now contains <code>["one", "three"]</code>
  </p>

  <p>
   The <code><i>array</i>.removeAll[<i>value</i>]</code> method removes
   <em>all</em> elements in the array which have the specified value.
  </p>
  
  <p>
   <code>array = [1,2,3,1]<br>
    n = array.removeAll[1]<br></code>
   <code>[2, 3]</code>
  </p>

  <p>
   A random item can be removed from an array using the method
   <code><i>array</i>.removeRandom[]</code>.  This removes a random item and
   returns its value.
  </p>

  <p>
   <code>array = ["a", "b", "c"]<br>
    n = array.removeRandom[]</code>
  </p>

  <h4><a name="SearchingArrays">Searching Arrays</a></h4>
  <p>
   You can test if an item is contained in an array with the
   <code><i>array</i>.contains[<i>value</i>]</code> method:
  </p>
  
  <p>
   <code>array = [1,2,3,1]<br>
    n = array.contains[3]<br></code>
   <code>true</code>
  </p>
  
  <p>
   You can find the first indexes of items in an array with the methods:
  </p>
  
  <p>
   <code>
    <i>array</i>.indexOf[<i>value</i>]<br>
    <i>array</i>.indexOf[<i>value</i>,&nbsp;<i>startIndex</i>]<br>
    <i>array</i>.lastIndexOf[<i>value</i>]<br>
    <i>array</i>.lastIndexOf[<i>value</i>,&nbsp;<i>startIndex</i>]<br>
   </code>
  </p>

  <p>
   If the item does not exist, these return <code>-1</code>.
  </p>

  <h4><a name="Permutations">Permutations</a></h4>
  <p>
   You can obtain all of the permutations of the array by using the
   <code>permute[]</code> method.  This returns an <a href="#EnumeratingExpressions">enumerating expression</a> that
   lazily generates the permutations.  Note that the permutations are
   currently in reflected Gray code order, but this may change.
  </p>

  <p>
   The number of items returned will
   be <code>permutationCount[<i>m,m</i>]</code> (which equals <code>m!</code>
   in this case where all items are taken) where <code>m</code> is the length
   of the array.
  </p>

  <p>
   <code>array = [1, 2, 3]<br>
    array.permute[]<br></code>
   <code>[[1, 2, 3], [1, 3, 2], [3, 1, 2], [3, 2, 1], [2, 3, 1], [2, 1, 3]]</code>
  </p>
  
  <p>
   If you need the results in lexicographical order, with duplicates removed,
   you can obtain all of the permutations of the array by using the
   <code>lexicographicPermute</code> method.
   This returns an <a href="#EnumeratingExpressions">enumerating expression</a> that lazily generates the
   permutations.  Note that all of the elements of the array <em>must be
    comparable to each other</em>, a constraint which is not necessary in the
   <code>permute</code> method.
  </p>

  <p>
   <code>array = [1, 2, 3]<br>
    array.lexicographicPermute[]<br></code>
   <code>[[1, 2, 3], [1, 3, 2], [2, 1, 3], [2, 3, 1], [3, 1, 2], [3, 2, 1]]</code>
  </p>

  <p>
   You can also specify an ordering function to be used by the
   <code>lexicographicPermute</code> method.  The function should take two
   arguments and return -1, 0, or 1 to indicate if item <code>a</code> is less
   than, equal to, or greater than item <code>b</code> respectively.  The
   following example sorts by length.
  </p>

  <p>
   <code>
    array = ["aa", "bbb", "c"]<br>
    f = {|a,b| length[a] &lt;=&gt; length[b]}<br>
    array.lexicographicPermute[f]<br>
   </code>
   <code>
    [[c, aa, bbb], [c, bbb, aa], [aa, c, bbb], [aa, bbb, c], [bbb, c, aa], [bbb, aa, c]]
    </code>
  </p>
  
  <h4><a name="Combinations">Combinations</a></h4>
  <p>
   You can obtain all of the combinations of the array by using the
   <code>combinations[<i>take</i>]</code> method.  This returns an enumerating
   expression that lazily generates combinations.  Note that the combinations
   are currently in lexicographical order, (without duplicates removed,) but
   this may change.  For example, to take 3 items at a time from a list:
  </p>

  <p>
   <code>array = [1, 2, 3, 4]<br>
    array.combinations[3]<br></code>
   <code>[[1, 2, 3], [1, 2, 4], [1, 3, 4], [2, 3, 4]]</code>
  </p>

  <p>
   The number of combinations that will be generated
   is <code>binomial[num,take]</code> where <code>num</code> is the number of
   items in the array and <code>take</code> is the number of items to take at
   a time.
  </p>

  <p>
   The sample program <a href="https://frinklang.org/fsp/colorize.fsp?f=pokerhands.frink">pokerhands.frink</a>
   demonstrates using this method to enumerate all possible 5-card poker hands.
  </p>

  <h4><a name="SlicingArrays">Slicing Arrays</a></h4>
  <p>
   You can take the first items from an array (or any <a href="#EnumeratingExpressions">enumerating expression</a>)
   using the <code>first[<i>expr</i>, <i>num</i>]</code> function.  This
   returns an <a href="#EnumeratingExpressions">enumerating expression</a> that returns the first <code>num</code>
   items and discards the rest.
  </p>

  <p>
   <code>
    a = new range[1, 10]<br>
    println[first[a, 4]]<br>
   </code>
   <code>
    [1, 2, 3, 4]
   </code>
  </p>

  <p>
   The opposite of <code>first[<i>expr</i>, <i>num</i>]</code>
   is <code>rest[<i>expr</i>, <i>num</i>]</code>.  This returns
   everything <em>after</em> the first <code>num</code> elements in the list.
  </p>
  
  <p>
   <code>
    a = new range[1, 10]<br>
    println[rest[a, 4]]<br>
   </code>
   <code>
    [5, 6, 7, 8, 9, 10]
   </code>
  </p>

  <p>
   If you only want the first element as as single expression, you can
   use <code>first[<i>expr</i>]</code> .  This is like the
   ridiculously-named <code>car</code> function in other languages (whose name
   is a badly-chosen name from a 1950s-era computer.  <em>Please stop using the
   names <code>car</code> and <code>cdr</code> in modern languages.</em>)
  </p>

  <p>
   The opposite of <code>first[<i>expr</i>]</code>
   is <code>rest[<i>expr</i>]</code>.  This returns everything <em>after</em>
   the first element in the list.
  </p>

  <p>
   <code>
    a = [1, 2, 3]<br>
    println[first[a]]<br>
   </code>
   <code>
    1
   </code>
  </p>

  <p>
   You can take the last items from an array (or any <a href="#EnumeratingExpressions">enumerating expression</a>)
   using the <code>last[<i>expr</i>, <i>num</i>]</code> function.  This
   returns an array that returns the last <code>num</code> items and discards
   the rest.
  </p>
  
  <p>
   <code>
    a = new range[1, 10]<br>
    println[last[a, 5]]<br>
   </code>
   <code>
    [6, 7, 8, 9, 10]
   </code>
  </p>
  
  <p>
   If you only want the last element as as single expression, you can
   use <code>last[<i>expr</i>]</code> .
  </p>
  
  <p>
   You can get an arbitrary "slice" out of an array using
   the <code>slice</code> and
   <code>sliceLength</code> functions.  (Note that these are functions, not
   methods.)
  </p>

  <p>
   The <code>slice[<i>array</i>, <i>start</i>, <i>end</i>]</code> function
   returns a slice of an array starting with index <code>start</code> and
   ending <em>before</em> index <code>end</code>.  If the indices are beyond
   the ends of the array, only existing items will be returned.
  </p>

  <p>
   <code>array = [0, 1, 2, 3, 4]<br>
    slice[array, 1, 3]<br></code>
   <code>[1,2]</code>
  </p>

  <p>
   If <code>start</code> or <code>end</code> are the special value
   <code>undef</code>, then the slice will contain the start of the array
   or the end of the array respectively.
  </p>

  <p>
   The <code>sliceLength[<i>array</i>, <i>start</i>, <i>length</i>]</code>
   function returns a slice of an array starting with index <code>start</code>
   and containing <code>length</code> items.  If the indices are beyond the
   end of the array, only existing items will be returned.
  </p>

  <p>
   <code>array = [0, 1, 2, 3, 4]<br>
    sliceLength[array, 1, 3]<br></code>
   <code>[1,2,3]</code>
  </p>

  <p>
   The inverse of <code>slice</code> and <code>sliceLength</code> are the
   functions <code>removeSlice</code> and <code>removeSliceLength</code> which
   <em>remove</em> the parts specified by the <code>slice</code> commands and
   return the rest.
  </p>

  <p>
   The <code>removeSlice[<i>array</i>, <i>start</i>, <i>end</i>]</code>
   function removes array elements starting with index <code>start</code>
   and ending <em>before</em> index <code>end</code>.  If the indices are
   beyond the ends of the array, only existing items will be removed.
   (Note that this is the inverse of what is returned by <code>slice</code>
   with the same arguments.)
  </p>
  
  <p>
   If <code>start</code> or <code>end</code> are the special value
   <code>undef</code>, then the function will remove from the beginning of the
   array or to the end of the array respectively.
  </p>
  
  <p>
   <code>array = [0, 1, 2, 3, 4]<br>
    removeSlice[array, 1, 3]<br></code>
   <code>[0, 3, 4]</code>
  </p>
  
  <p>
   The <code>removeSliceLength[<i>array</i>, <i>start</i>,
    <i>length</i>]</code> function removes a slice of an array starting with
   index <code>start</code> and containing <code>length</code> items.  If the
   indices are beyond the end of the array, only existing items will be
   removed.  (Note that this is the inverse of what is returned by
   <code>sliceLength</code> with the same arguments.)
  </p>

  <p>
   <code>array = [0, 1, 2, 3, 4]<br>
    removeSliceLength[array, 1, 3]<br></code>
   <code>[0,4]</code>
  </p>

  <h4><a name="Flattening">Flattening</a></h4>
  <p>
   A list of lists can be flattened with the <code>flatten[<i>list</i>]</code>
   function:
  </p>

  <p>
   <code>
    a = [ [1,2], 3, [4, [5,6]] ]<br>
    println[flatten[a]]<br>
   </code>
   <code>
    [1, 2, 3, 4, 5, 6]
   </code>
  </p>

  <h4><a name="Subsets">Subsets</a></h4>
  <p>
   To obtain all of the possible subsets of the elements in the array (this is
   also called the "power set",) you can use
   the <code><i>array</i>.subsets[]</code> method.  This returns an
   <a href="#EnumeratingExpressions">enumerating expression</a> which iterates through all the subsets of items in
   the array, including the empty set and the original set itself.  Each
   return value is itself an array of elements, with the elements preserving
   the same order as in the original array:
  </p>

  <p>
   <code>
    a = [1,2,3]<br>
    println[a.subsets[]]<br>
   </code>
   <code>
    [[], [1], [2], [1, 2], [3], [1, 3], [2, 3], [1, 2, 3]]
   </code>
  </p>

  <p>
   You can also request the subsets of the array and exclude either the empty
   set or the original set by using the
   <code><i>array</i>.subsets[<i>allowEmptySet</i>,&nbsp;<i>allowOriginalSet</i>]</code>
   method.  If <code>allowEmptySet</code> is <code>true</code>, the empty set
   will be returned as one of the elements.  If <code>false</code>, the empty
   set will be excluded. If <code>allowOriginalSet</code> is
   <code>true</code>, the full original set will be returned as one of the
   elements.  If <code>false</code>, the full original set will be excluded,
   and only "proper" subsets will be returned.
  </p>
  
  <p>
   <code>
    a = [1,2,3]<br>
    println[a.subsets[false, false]]<br>
   </code>
   <code>
    [[1], [2], [1, 2], [3], [1, 3], [2, 3]]
   </code>
  </p>

  <p>
   Note that output of the empty set and the original set are suppressed in
   the example above.
  </p>

  <h4><a name="Shuffling">Shuffling</a></h4>
  <p>
   The contents of an array can be shuffled randomly with the
   <code><i>array</i>.shuffle[]</code> method (using the Fisher-Yates-Knuth
   algorithm):
  </p>

  <p>
   <code>
    a = [1,2,3]<br>
    a.shuffle[]<br>
    a<br>
   </code>
   <code>
    [3, 1, 2]
   </code>
  </p>

  <h4><a name="Clearing">Clearing</a></h4>
  <p>
   The contents of an array can be cleared with the
   <code><i>array</i>.clear[]</code> method:
  </p>

  <p>
   <code>
    a = [1,2,3]<br>
    a.clear[]<br>
    a<br>
   </code>
   <code>
    []
   </code>
  </p>

  <h4><a name="Transpose">Transpose</a></h4>
  <p>
   While Frink does not have a complete implementation of matrix operations,
   (for an external class with some matrix operations, see <a href="https://frinklang.org/fsp/colorize.fsp?f=Matrix.frink">Matrix.frink</a>, and please
   contribute algorithms to that file,) it has some built-in methods that
   support matrix calculations.
  </p>

  <p>
   The <code><i>array</i>.transpose[]</code> method transposes the
    elements of a 2-dimensional array, like in matrix calculations.  This
    means that rows and columns are switched.  In other words, the element at
    <code><i>array</i>@i@j</code> becomes the element at
    <code><i>array</i>@j@i</code>.
  </p>

  <p>
   <code>
    array = [[1,2], [3, 4], [5,6]]<br>
    array.transpose[]<br>
   </code>
   <code>[[1, 3, 5], [2, 4, 6]]</code>
  </p>
  
  <h4><a name="AdditionalArrayFunctions">Additional Array Functions</a></h4>
  <p>
   Since arrays are also <a href="#EnumeratingExpressions">enumerating
   expressions</a>, any of
   the <a href="#EnumeratingExpressionFunctions">enumerating expression
   functions</a> such as <code>first</code>, <code>last</code>, etc. will work
   on arrays.  Note that they are <em>functions</em> that work on a
   variety of data types, and not methods on the array.  That is, you call
   them as <code>first[<i>array</i>]</code> and
   <em>not</em> <code><i>array</i>.first[]</code>.  See the following section
   for more information.
  </p>
  
  <h2><a name="EnumeratingExpressions">Enumerating Expressions</a></h2>
  <p>
   Some functions can return a lazily-produced list of results.  These may be
   finite or infinite, and you often don't know in advance how long they will
   be, so the <code>length</code> function does not work on them.  Frink calls
   these "Enumerating Expressions".  For example, the
   function <code>primes[]</code> returns an infinite list of prime numbers.
   Other enumerating expressions may be finite, such as the
   commonly-seen <code>1 to 10</code> notation, usually used in
   a <code>for</code> loop, which sequentially returns the integers from 1 to
   10.
  </p>

  <p>
   You usually don't want to print out all of the values of an enumerating
   expression directly (because they may be infinite), but rather use it in
   a <code>for</code> loop and handle each value individually.  After a value
   is returned from an enumerating expression, it is "forgotten", which helps
   reduce memory usage.
  </p>

  <p>
   It is important to note that many or most enumerating expressions are
   "use-once"; the values produced by the expression are only produced once.
   Even printing the values in Frink's interactive mode causes the values to
   be consumed.  If you need the values multiple times, it is beneficial to
   wrap them in something like a <code>toArray[<i>expr</i>]</code> call.
  </p>

  <p>
   You can test if an expression is an enumerating expression with
   the <code>isEnumerating[<i>expr</i>]</code> function.  Note that many of
   Frink's data types are also enumerating expressions,
   including <code>array</code>, <code>dict</code>,
   <code>set</code>, <code><a href="#OrderedList">OrderedList</a></code>, <code>RingBuffer</code>, etc.,
   and will return <code>true</code> to this query.
  </p>

  <h3><a name="EnumeratingExpressionFunctions">Enumerating Expression Functions</a></h3>
  <p>
   This is a partial list of functions that have special behavior that makes
   them useful for working with (possibly infinite) enumerating expression.
   Note that arrays are enumerating expressions, so all of these will work
   with arrays.
  </p>

  <ul>
   <li><code>first[<i>expr</i>]</code> returns the first element of an array
    or enumerating expression as a single expression.

   </li><li><code>first[<i>expr</i>, <i>count</i>]</code> returns the
    first <code>count</code> elements of an array or enumerating expression.
    If the expression passed in is an array, the result is an array,
    otherwise it is a (possibly-infinite) enumerating expression.

   </li><li><code>rest[<i>expr</i>]</code> returns everything <em>after</em> the
    first element of an array or enumerating expression.  If the expression
    passed in is an array, the result is an array, otherwise it is a
    (possibly-infinite) enumerating expression.  This is the opposite of
    <code>first[<i>expr</i>]</code>
    
   </li><li><code>rest[<i>expr</i>, <i>num</i>]</code> returns
    everything <em>after</em> the first <code>num</code> elements of an array
    or enumerating expression.  If the expression passed in is an array, the
    result is an array, otherwise it is a (possibly-infinite) enumerating
    expression.  This is the opposite of <code>first[<i>expr</i>, <i>num</i>]</code>
    
   </li><li><code>last[<i>expr</i>]</code> returns the last element of an array
    or enumerating expression as a single expression.

   </li><li><code>last[<i>expr</i>, <i>count</i>]</code> returns the
    last <code>count</code> elements of an array or enumerating expression.
    The result is an array.

   </li><li><code>slice[<i>expr</i>, <i>begin</i>, <i>end</i>]</code> returns a
    slice of an array or enumerating expression starting with
    index <code>start</code> and ending <em>before</em>
    index <code>end</code>.  If the indices are beyond the ends of the
    array, only existing items will be returned.  If <code>begin</code>
    or <code>end</code> is the value <code>undef</code>, the results will
    include the beginning or end of the expression respectively.  If the
    expression passed in is an array, the result is an array, otherwise it
    is a (possibly-infinite) enumerating expression.

   </li><li><code>sliceLength[<i>expr</i>, <i>begin</i>, <i>length</i>]</code>
    returns a slice of an array or enumerating expression starting with
    index <code>start</code> and having <code>length</code> items.  If the
    expression passed in is an array, the result is an array, otherwise it
    is an enumerating expression.

   </li><li><code>chunks[<i>expr</i>, <i>size</i>]</code> returns an enumerating
    expression which breaks <code>expr</code> into a series of chunks of
    length <code>size</code>, where each chunk is an array.

    <p>
     For example, <br>
     <code>chunks[1 to 9, 3]</code><br>
     returns an enumerating expression which produces:<br>
     <code>[[1, 2, 3], [4, 5, 6], [7, 8, 9]]</code>
    </p>
    
   </li><li><code>chunks[<i>expr</i>, <i>size</i>, <i>step</i>]</code> returns an
    enumerating expression which breaks <code>expr</code> into a series of
    chunks of length <code>size</code>, advancing by <code>step</code>
    elements at each step, where each chunk is an array.
    
    <p>
     For example, <br>
     <code>chunks[1 to 6, 3, 1]</code><br>
     returns an enumerating expression which produces:<br>
     <code>[[1, 2, 3], [2, 3, 4], [3, 4, 5], [4, 5, 6]]</code>
    </p>
    
   </li><li><code>nth0[<i>expr</i>, <i>index</i>]</code> returns the specified
    element of an array or enumerating expression, treating the first element
    as element 0.  This replaces the function called <code>nth</code> (which
    is still available but deprecated.)

   </li><li><code>nth1[<i>expr</i>, <i>index</i>]</code> returns the specified
    element of an array or enumerating expression, treating the first element
    as element 1.  For example, to return the millionth
    prime:  <code>nth[primes[], million]</code>
    
   </li><li><code>toArray[<i>expr</i>]</code> turns a finite enumerating expression
    into an array.

   </li><li><code>countToArray[<i>expr</i>]</code> counts the number of times that
    each unique expression occurs in an enumeration and returns the count as a
    sorted array of <code>[<i>element</i>, <i>count</i>]</code> pairs with the most
    common items first.  This can be used to count letter frequencies
    (with <code>charList</code>,) word frequencies
    (with <code>wordList</code>,) occurrences of repeated lines in 
    a file (with <code>lines</code>,) etc.  See also
    the <code>countToDict</code> function below.

    <p>
     For example, counting the array <br>
     <code>[11,12,13,11,12,12]</code><br>
     returns the array<br>
     <code>[[12, 3], [11, 2], [13, 1]]</code>
    </p>
    
   </li><li><code>countToDict[<i>expr</i>]</code> counts the number of times that
    each unique expression occurs in an enumeration and returns the count as a
    dictionary where the key is the element and the value is the count.  See
    also the <code>countToArray</code> function above.

    <p>
     For example, counting the array<br>
     <code>[11,12,13,11,12,12]</code><br>
     returns the dictionary with mappings:<br>
     <code>[[12, 3], [11, 2], [13, 1]]</code>
    </p>

   </li><li><code>mostCommon[<i>expr</i>]</code> counts the number of times that
    each unique expression occurs in an enumeration and returns only the
    item(s) that occur the most commonly.  This returns <code>[vals,
    count]</code> where <code>vals</code> is an array of only the items which
    occur the most often and <code>count</code> is the number of their count.
    For more general counting, see the <code>countToArray</code>
    and <code>countToDict</code> functions above.

    <p>
     For example, <br>
     <code>mostCommon[[1, 1, 1, 2, 4, 4, 4]]</code><br>
      will return <code>[[1,4], 3]</code> as elements 1 and 4 both occur 3
      times.  If the input is empty, this returns <code>[[], 0]</code><br>
    </p>

    <p>
     This can be used to find the <i>mode</i> of a distribution (that is,
     similar to mean and median, the statistical definition of the <i>mode</i>
     is the value(s) that occur the most times in a distribution.)
    </p>

    <p>
     <code>modes[nums] := mostCommon[nums]@0<br>
     modes[[1, 1, 1, 2, 4, 4, 4]]</code>
     <code>[1, 4]</code>
    </p>

   </li><li><code>leastCommon[<i>expr</i>]</code> counts the number of times that
    each unique expression occurs in an enumeration and returns only the
    item(s) that occur the least commonly.  This returns <code>[vals,
    count]</code> where <code>vals</code> is an array of only the items which
    occur the least often and <code>count</code> is the number of their count.
    For more general counting, see the <code>countToArray</code>
    and <code>countToDict</code> functions above.

    <p>
     For example, <br>
     <code>leastCommon[[1, 1, 1, 2, 4, 4, 4, 5]]</code><br>
      will return <code>[[2, 5], 1]</code> as elements 2 and 5 both occur 1
      time.  If the input is empty, this returns <code>[[], 0]</code><br>
    </p>

    <p>
     <code>a =  [1, 1, 1, 2, 4, 4, 4, 5]<br>
      [vals, count] = leastCommon[a]<br>
      for v = vals<br>
      &nbsp;&nbsp;&nbsp;println["$v occurs $count times"]</code>
     <code>
      2 occurs 1 times<br>
      5 occurs 1 times<br>
     </code>
    </p>
     
   </li><li><code>count[<i>start</i>]</code> creates an
    infinte <a href="#EnumeratingExpressions">enumerating expression</a> that
    counts up from the specified number, incrementing by 1 each time.  Note
    that this will produce infinite output if you even try to print it, so you
    probably want to call it from a <code>for</code> loop (perhaps with
    a <code>break</code> statement) or from something
    like <code>first[count[1], 100]</code>

   </li><li><code>count[<i>start</i>, <i>step</i>]</code> creates an
    infinte <a href="#EnumeratingExpressions">enumerating expression</a> that
    counts from the specified number, adding <code>step</code> (which
    can be negative) each time.  Note
    that this will produce infinite output if you even try to print it, so you
    probably want to call it from a <code>for</code> loop (perhaps with
    a <code>break</code> statement) or from something
    like <code>first[count[2, 2], 100]</code>
    
   </li><li><code>allSame[<i>expr</i>]</code> returns <code>true</code> if all of
    the items in an EnumeratingExpression are all the same.  This
    returns <code>true</code> for an empty list.  If the argument is not an
    enumerating expression, this returns <code>true</code>.
    
   </li><li><code>allDifferent[<i>expr</i>]</code> Returns <code>true</code> if all
    of the items in an EnumeratingExpression are all different.  All items in
    the list must be HashingExpressions.  This returns <code>true</code> for
    an empty list.  If the argument is not an enumerating expression, this
    returns <code>true</code>.

   </li><li><code>allEqual[<i>list</i>, <i>target</i>]</code>
    Returns <code>true</code> if all of the items in the EnumeratingExpression
    <code>list</code> are equal to <code>target</code>. This
    returns <code>true</code> for an empty list.  If the argument is not an
    enumerating expression, this returns <code>true</code>.
  </li></ul>
  
  <h2><a name="OrderedList">OrderedList</a></h2>
  <p>
   An <code>OrderedList</code> is an array that is always kept in order.  Of
   course, this implies that all items in an <code>OrderedList</code> must be
   comparable with each other.  It extends the <code>array</code> class and
   almost all methods and functions that operate on <code>array</code> will
   work with <code>OrderedList</code>, unless those methods would violate the
   ordering (e.g. <code>pushFirst</code>).
  </p>

  <p>
   By default, the ordering is the default ordering produced by the
   <code>&lt;=&gt;</code> <a href="#ThreeWayComparison">three-way
   comparison</a> operator.  If another user-defined ordering is desired, it
   can be specified by one of the constructors explained in the next section.
  </p>

  <h3><a name="InitializingOrderedList">Initializing OrderedList</a></h3>
  <p>
   An <code>OrderedList</code> with the default ordering (that is, identical
   to the <code>&lt;=&gt;</code> <a href="#ThreeWayComparison">three-way
   comparison</a> operator) can be created by
   calling <code>new&nbsp;OrderedList</code>:
  </p>

  <p>
   <code>
    a = new OrderedList
   </code>
  </p>

  <p>
   If you want to specify a user-defined ordering, you can pass a (possibly <a href="#AnonymousFunctions">anonymous</a>) function as the first argument to
   the constructor.  This function must take two arguments (we'll call them)
   <code>[a,b]</code>, and return -1 if <code>a&lt;b</code>, 0 if
   <code>a==b</code>, and 1 if <code>a&gt;b</code>.  (These are the values
   returned by
   the <code>&lt;=&gt;</code> <a href="#ThreeWayComparison">three-way
   comparison</a> operator, so you may be able to use it in your comparison
   function.)
  </p>

  <p>
   For example, if you want to use an ordering that simply sorts shorter
   strings before longer strings, (say that six times speedily,) you can do the
   following:
  </p>

  <p>
   <code>
    <code>// Define a function that sorts by length</code><br>
    f = { |a,b|&nbsp;&nbsp;length[a] &lt;=&gt; length[b] }<p>
    
    x = new OrderedList[f] <code>// Specify ordering function</code><br>
    x.insert["aa"]<br>
    x.insert["bbb"]<br>
    x.insert["z"]<br>
    x</p></code>
   <code>
    [z, aa, bbb] <code>// results sorted by length</code>
   </code>
  </p>

  <p>
   An OrderedList can also take a piece of arbitrary data that is passed to
   the comparison function.  This data is passed as the second argument to the
   constructor.  If the first argument to the constructor is
   <code>undef</code>, the default orderer will be used.  The data will be
   passed as a third argument to the comparison function.
  </p>
  
  <p>
   <code>
    <code>// Define a function that sorts by distance from data</code><br>
    f = { |a,b,data|&nbsp;&nbsp;(abs[a-data] &lt;=&gt; abs[b-data]}<p>
    
    x = new OrderedList[f, 3] <code>// Specify ordering function</code><br>
    x.insert[1]<br>
    x.insert[4]<br>
    x.insert[3]<br>
    x.insert[-2]<br>
    x</p></code>
   <code>
    [3, 4, 1, -2] <code>// results sorted by distance from 3</code>
   </code>
  </p>

  <h3><a name="OrderedListMethods">OrderedList Methods</a></h3>
  <p>
   Since <code>OrderedList</code> extends <code>array</code>, <a href="#ArrayMethods">array methods</a> are available on OrderedList unless
   they would interfere with preserving ordering.  New methods and methods
   with altered effects are listed below.
  </p>

  <table summary="OrderedList Methods">
    <tbody><tr><th>Method</th><th>Definition
      
    </th></tr><tr><td>binarySearch[<i>expr</i>]</td><td>Returns the index of the
      item to insert <em>before</em> to put the item in the right order.  If
      the item is found anywhere in the list, this returns the index of the
      matching item in the list.  If the item is not found in the list, this
      still returns the index before which it should be inserted.
      
    </td></tr><tr><td>contains[<i>value</i>]</td><td>Returns true if the list
      contains 1 or more instances of the specified value, false if it does
      not.
      
    </td></tr><tr><td>indexOf[<i>expr</i>]</td><td>Returns the index of one of
      the occurrences of the specified value in the list, <code>undef</code>
      if it does not occur.  If multiple instances of the same value occur in
      the list, this may return the index of any of the instances.
      
    </td></tr><tr><td>insert[<i>value</i>]</td><td>Inserts the specified value
      into the appropriate place in the list.  If it's already there, this
      inserts a duplicate before the existing element.  (See the
      <code>insertUnique</code> method if you don't want duplicates.) Returns
      the index where the item was inserted, but this behavior may change.

    </td></tr><tr><td>insertUnique[<i>value</i>]</td><td>Inserts the specified
      value into the appropriate place in the list.  If it's already there, a
      new value is not added.  Returns the index where the item was inserted,
      but this behavior may change.
      
    </td></tr><tr><td>insert[<i>pos</i>, <i>value</i>]</td><td><b>Disallowed</b>
      in <a href="#OrderedList">OrderedList</a> as it could violate proper ordering.
      
    </td></tr><tr><td>insertAll[<i>expr</i>]</td><td>Inserts all of the elements
      of the specified expression (which can be an array or
      <a href="#EnumeratingExpressions">enumerating expression</a>) into this <a href="#OrderedList">OrderedList</a>, with the correct ordering.
      If duplicates exist, duplicates will be inserted.
      
    </td></tr><tr><td>insertAllUnique[<i>expr</i>]</td><td>Inserts all of the
      elements of the specified expression (which can be an array or
      <a href="#EnumeratingExpressions">enumerating expression</a>) into this <a href="#OrderedList">OrderedList</a>, with the correct ordering.
      No duplicates will be allowed.

    </td></tr><tr><td>push[<i>value</i>]</td><td><b>Disallowed</b> in
      <a href="#OrderedList">OrderedList</a> as it could violate proper ordering.
      
    </td></tr><tr><td>pushAll[<i>array</i>]</td><td><b>Disallowed</b> in
      <a href="#OrderedList">OrderedList</a> as it could violate proper ordering.

    </td></tr><tr><td>pushFirst[<i>value</i>]</td><td><b>Disallowed</b> in
      <a href="#OrderedList">OrderedList</a> as it could violate proper ordering.
      
    </td></tr><tr><td>shuffle[]</td><td>This differs from the behavior of
      <code><i>array</i>.shuffle[]</code> in that it does not modify the
      structure in place, but rather returns a new (unordered)
      <code>array</code> which is shuffled randomly.
  </td></tr></tbody></table>

  <h2><a name="RingBuffer">RingBuffer</a></h2>
  <p>
   A <code>RingBuffer</code> is a type of array, but with a fixed maximum
   size.  It is efficient to append items to the end of the list using the
   <code>push[<i>item</i>]</code> method, and to remove them from the beginning
   using the <code>popFirst[<i>item</i>]</code>, which is how it will usually
   be used.  If more items are pushed than the fixed capacity allows, the item
   at the front of the buffer is discarded.
  </p>

  <p>
   Items can also be accessed randomly using the array index <code>@</code>
   operator.  The first item is always element 0.  When an item is popped from
   the beginning of the list using the <code>popFirst[]</code> method, the
   item that was previously at index 1 becomes index 0, and so on.  If you
   attempt to access an item that does not exist, this raises an error, but
   this behavior may change.
  </p>

  <p>
   A <code>RingBuffer</code> is constructed by specifying its size as a
   positive integer:
  </p>

  <p>
   <code>rb = new RingBuffer[10]</code><br>
  </p>

  <p>
   Like other Frink collections, you can find out how many items are contained
   with the <code>length[<i>expr</i>]</code> function.  You can also turn it
   into a traditional array with the <code>toArray[<i>ringBuffer</i>]</code>
   function.  Its elements can be enumerated with a <code>for</code> loop.
  </p>

  <p>
   The following demonstrates using a RingBuffer to capture the last
   <code>n</code> elements of an <a href="#EnumeratingExpressions">enumerating expression</a> (this could be a list,
   or the lines of a file from the <code>lines</code> function, etc.)
  </p>

  <p>
   <code>
    last[expr, n]:=<br>
    {<br>
    &nbsp;&nbsp;&nbsp;b = new RingBuffer[n]<br>
    &nbsp;&nbsp;&nbsp;b.pushAll[expr]<br>
    &nbsp;&nbsp;&nbsp;return b<br>
    }
   </code>
  </p>

  <h3><a name="RingBufferMethods">RingBuffer Methods</a></h3>
  <p>
   The following methods operate on <code>RingBuffer</code>.  They are mostly
   the same as the corresponding <a href="#ArrayMethods">array methods</a>,
   with differences as noted below:
  </p>
  <table summary="RingBuffer Methods">
    <tbody><tr><th>Method</th><th>Description
    </th></tr><tr><td>push[<i>expr</i>]</td><td>Pushes the specified expression
      onto the end of the list.  If the <code>RingBuffer</code> is at
      capacity, this will throw away the item at the beginning and change the
      indices of the array.  The first element is always element 0 of the list.
      
    </td></tr><tr><td>pushFirst[<i>expr</i>]</td><td>Pushes the specified
      expression to the beginning of the list.  If the <code>RingBuffer</code>
      is at capacity, this will throw away the item at the end.  The new
      element becomes element 0 of the list.

    </td></tr><tr><td>pop[]</td><td>Removes the last element from the list and
      returns its value.  If the list is empty, this currently throws an error
      but this behavior may change.

    </td></tr><tr><td>popFirst[]</td><td>Removes the first element from the list
      and returns its value.  This will change the indices for the remaining
      items.   If the list is empty, this currently throws an error
      but this behavior may change.

    </td></tr><tr><td>pushAll[<i>collection</i>]</td><td>Pushes all the elements
      in the specified collection (which can be an <a href="#EnumeratingExpressions">enumerating expression</a>,)
      individually, onto the end of the list.  If the collection is an array
      with known length, this is done efficiently.

    </td></tr><tr><td>isEmpty[]</td><td>Returns true if the
      <code>RingBuffer</code> is empty, false otherwise.
      
    </td></tr><tr><td>isFull[]</td><td>Returns true if the
      <code>RingBuffer</code> is full, false otherwise.

    </td></tr><tr><td>contains[<i>expr</i>]</td><td>Returns true if the given
      expression is contained in the list.  This is a linear search.

    </td></tr><tr><td>indexOf[<i>expr</i>]</td><td>Returns the index of the first
      occurrence of the specified expression in the list, <code>-1</code> if
      it does not exist in the list.

    </td></tr><tr><td>indexOf[<i>expr</i>, <i>startIndex</i>]</td><td>Returns the
      index of the first occurrence of the specified expression in the list,
      beginning the search at index <code>startIndex</code>.  This returns
      <code>-1</code> if it does not exist at that point or later in the list.
      
    </td></tr><tr><td>lastIndexOf[<i>expr</i>]</td><td>Returns the index of the
      last occurrence of the specified expression in the list, <code>-1</code>
      if it does not exist in the list.

    </td></tr><tr><td>lastIndexOf[<i>expr</i>, <i>startIndex</i>]</td><td>Returns
      the index of the last occurrence of the specified expression in the list,
      beginning the search at index <code>startIndex</code>.  This returns
      <code>-1</code> if it does not exist at that point or earlier in the
      list.
  </td></tr></tbody></table>
  
  <h2><a name="Input">Input</a></h2>
  <p>
   You can request input from the user with the
   <code>input[<i>prompt</i>]</code> or
   <code>input[<i>prompt</i>,&nbsp;<i>defaultValue</i>]</code> function.
   The result always comes back as a string, but you can parse it into a unit,
   a date, or whatever, using the <code>eval[str]</code> function:
  </p>

  <p>
   <code>radius = input["Enter the radius of a sphere: "]</code><br>
   <code>volume = 4/3 pi eval[radius]^3</code><br>
  </p>

  <p>
   This allows your users to enter things like "3 inches" or "1 mile" or any
   units that Frink knows about (like "earthradius",) and everything will Just
   Work.  (That "Self-Evaluation" section above seemed irrelevant at the time,
   but it turns out it's quite useful.)
  </p>

  <p>
   If the user cancels the input dialog, or, for text input, if end-of-file is
   reached, this returns the special value <code>undef</code>.
  </p>

  <p>
   In command-line mode, these <code>input</code> functions also allow you to
   read from standard input (stdin).  (User input is actually taken from stdin
   in command-line mode, as you may expect.)  Lines can be read one at a time,
   <em>and have trailing carriage returns/linefeeds removed.</em>  On
   end-of-file (EOF), the input function returns the special value
   <code>undef</code>.  A short-program to read from standard in and echo its
   output may look like:
  </p>

  <p>
   <code>while (line = input[""]) != undef<br>
    &nbsp;&nbsp;&nbsp;println[line]
   </code>
  </p>

  <p>
   If, for some reason, you're in a GUI mode and you still want to read from
   standard input, you can call <code>readStdin[]</code> to read one line
   from standard input.  This is just like calling <code>input[""]</code> from
   command-line mode, which is what you really want to be calling if you're
   trying to make programs that work both interactively and non-interactively,
   and in GUI mode and non-GUI mode.  But if you're sure you only ever want to
   read from standard input, and don't want to trigger a GUI input window, use
   <code>readStdin[]</code>
  </p>

  <p>
   <code>while (line = readStdin[]) != undef<br>
    &nbsp;&nbsp;&nbsp;println[line]
   </code>
  </p>
  
  <h3><a name="MultiInput">Multi-Input</a></h3>
  <p>
   If you want to request multiple input items from the user, you can use the
   "multi-input" version of the input function, where the second argument is an
   array of items you're going to prompt for:
  </p><p>
   <code>[first, last] = input["What is your name", ["First Name", "Last Name"]]</code><br>
  </p>

  <p>
   This will produce a graphical user interface which prompts the user for
   their input.  This works on AWT, Swing, Android, and in text mode if you're
   running in a pure text environment.
  </p>
  
  <p>
   The results will be returned as an array of strings, in the same order as
   they were specified.  As in the <a href="#Input">Input</a> section above,
   you can use the <code>eval[<i>str</i>]</code> function to parse them into
   numeric or other values.
  </p>

  <p>
   If the user cancels the input dialog, or, for text input, if end-of-file is
   reached, this returns the special value <code>undef</code> instead of an
   array.  When in text mode, if end-of-file is reached before filling the
   second or later item, then partial results will be returned (with the
   special value <code>undef</code> being returned for each incomplete value.)
  </p>

  <p>
   If any of the items in the array is a two-element array, the second
   argument will be used as the default value:
  </p>

  <p>
   <code>[first, last] = input["What is your name",[["First
    Name", "Jeff"], ["Last Name", "Albertson"]]]</code>
  </p>

  <p>
   <img src="https://frinklang.org/images/multiinput.png" width="316" height="140" alt="Multi-Input screenshot">
  </p>

  <h3><a name="MakingInteractiveInterfaces">Making Interactive Interfaces</a></h3>
  <p>
   The following program demonstrates an idiom for creating a simple
   interactive GUI that finds roots of numbers until you cancel.  The
   <code>while</code> loop exits when the user cancels calculations.  Previous
   results are displayed to the user at the top of the input dialog, and the
   user's previous input is maintained (verbatim) in the input fields.
  </p>

  <p>
   <code>
    n = "10000"<br>
    r = "2"<br>
    message = "Find roots of a number"<br>
    while&nbsp;[n,&nbsp;r]&nbsp;=&nbsp;results&nbsp;=&nbsp;input[message,&nbsp;[["Number",&nbsp;n],&nbsp;["Root",&nbsp;r]]]<br>
    {<br>
    &nbsp;&nbsp;&nbsp;[num, root] = eval[results]&nbsp;&nbsp;<code>// Turn into numbers</code><br>
    &nbsp;&nbsp;&nbsp;val = num^(1/root)<br>
    &nbsp;&nbsp;&nbsp;message = "$n^(1/$r) = $val"<br>
    &nbsp;&nbsp;&nbsp;println[message]<br>
    }<br>
   </code>
  </p>

  <p>
   This code works whether the user is running with a Swing or AWT or Android
   GUI, or in text mode.  The user cancels input by closing the input dialog
   (in Swing or AWT), hitting the "back" button on Android, or with
   end-of-file (EOF) in text mode (EOF can be simulated by Control-D on
   Unixlike systems, Control-Z on Windows.)
  </p>

  <p>
   Note that the idiomatic use of the "eval" function to turn the string
   inputs into Frink expressions.  This means that the user can enter any
   expression that Frink understands, such as "<code>2+2</code>", "<code>1
    trillion</code>", "<code>sin[30 degrees]</code>" or "<code>32
    m^2</code>".  It's like a generalized calculator inside of a specialized
   calculator!
  </p>

  <h2><a name="Output">Output</a></h2>
  <p>
   To print, use the <code>print</code> or <code>println</code> functions,
   each of which take one argument.  The only difference is that
   <code>println</code> sends a linefeed afterwards.
  </p>

  <p>
   <code>println["The volume of the sphere is " + (volume -&gt;
    ft^3) + " cubic feet."]</code><br>
  </p>

  <h2><a name="BooleanOperators">Boolean Operators</a></h2>
  <p>
   I'm just going to list a forest of cryptic boolean expressions here without
   explanation.  You pick out the ones you like.  They all work, and there are
   usually multiple equivalents for the same thing, taken from different
   languages.  I've tried to keep precedence the same as Java.  There is no
   difference between the different versions of, say,
   <code>and</code>, <code>AND</code>,
   and <code>&amp;&amp;</code> .
  </p>

  <p>
   <code>
    true TRUE false FALSE == != &lt;&gt; &lt; &lt;= &gt; &gt;= &amp;&amp; and
    AND || or OR ! NOT not nand NAND nor NOR xor XOR implies IMPLIES
   </code>
  </p>

  <h2><a name="ThreeWayComparison">Three-Way Comparison</a></h2>
  <p>
   The three-way comparison operator, <code>&lt;=&gt;</code>, also called the
   "spaceship" operator, compares two arguments and returns their relative
   ordering:
  </p>

  <p>
   For <code>a &lt;=&gt; b</code>, this returns:
  </p>

  <ul>
   <li><code>-1</code> if <code>a &lt; b</code>
   </li><li><code> 0</code> if <code>a == b</code>
   </li><li><code> 1</code> if <code>a &gt; b</code>
  </li></ul>

  <p>
   These are the values expected by ordering functions, such as those used in
   user-defined <a href="#Sorting">sorting</a>.
  </p>

  <h2><a name="Dictionaries">Dictionaries</a></h2>
  <p>
   A dictionary is an associative data structure that lets you map arbitrary
   keys to values (currently, keys can be strings, units, (that is, numbers),
   <a href="#Sets">sets</a>, other dictionaries, arrays, date/time values, or
   objects created from a <code>class</code>.)
  </p>
  
  <p>
   The syntax is identical to the syntax for array element manipulation.  (This
   means that you can switch back and forth between an array and (sparse)
   dictionary representation for integer-indexed data structures!)
  </p>

  <p>
   Create an empty dictionary using <code>new dict</code>
  </p>

  <p>
   <code>
    a = new dict</code>  <br>
   <code>
    a@"one" = 1<br>
    a@"two" = 2<br>
    a@"three" = 3<br>
   </code>
   <code>
    a@"one"<br>
   </code>
   <code>
    1<br></code>
  </p>

  <p>
   <code>
    b = new dict</code>  <br>
   <code>
    b@1 = "one"<br>
    b@2 = "two"<br>
    b@3 = "three"<br>
   </code>
   <code>
    b@1<br>
   </code>
   <code>
    one<br></code>
  </p>

  <p>
   You can also enumerate over <code>[key, value]</code> pairs directly in a
   dictionary.  They are not returned in any guaranteed order.
  </p>
  
  <p>
   <code>for [key, value] = a<br>
    &nbsp;&nbsp;&nbsp;println["$key = $value"]</code><br>
   <code>
    two = 2<br>
    one = 1<br>
    three = 3<br>
   </code>
  </p>
  
  <h3><a name="DictionaryConstructors">Dictionary Constructors</a></h3>
  <p>
   Create an empty dictionary:
  </p>

  <p>
   <code>a = new dict</code>
  </p>

  <p>
   Create a dictionary from an array (or <a href="#EnumeratingExpressions">enumerating expression</a>) where each
   element in the array is a two-item list which are treated as a key and a
   value:
  </p>

  <p>
   <code>
    array = [["one", 1], ["two", 2]]  <code>// A literal array</code><br>
    d = new dict[array] <code>// Create a dict from the array</code><br>
    d@"one"  <code>// Look up an item</code><br>
   </code>
   <code>1</code>
  </p>
  
  <p>
   You can also turn an array (or other types) into a dictionary by calling
   the <code>toDict[<i>array</i>]</code> function on it, which behaves exactly
   like calling the single-argument constructor above.
  </p>
   
  <p>
   Create a dictionary from two arrays (or <a href="#EnumeratingExpressions">enumerating expressions</a>) where the
   first array contains keys and the second array contains values.  The first
   element in the keys array will be matched with the first element in the
   values array.
  </p>

  <p>
   <code>
    keys = ["one", "two"]<br>
    values = [1,2]<br>
    d = new dict[keys, values]<br>
    d@"one"<code>// Look up an item</code><br>
   </code>
   <code>1</code><br>
   <code>
    d  <code>// print the dictionary</code><br>
   </code>
   <code>[[one, 1], [two, 2]]</code>
  </p>

  
  <h3><a name="DictionaryMethods">Dictionary Methods</a></h3>
  <p>
   You can get an enumeration of the keys in a dictionary by using the
   <code>keys</code> method.  This method does not return the keys in any
   defined order, but you can sort them with the <a href="#Sorting">sorting
    functions</a> below.
  </p>
  
  <p>
   <code>for key = a.keys[]<br>
    &nbsp;&nbsp;&nbsp;println[ "$key = " + a@key]</code><br>
   <code>
    two = 2<br>
    one = 1<br>
    three = 3<br>
   </code>
  </p>

  <p>
   The following enumerates through key, value pairs sorted by key.  This
   works because the <code>sort</code> function works by coercing
   an <a href="#EnumeratingExpressions">enumerating expression</a> (of
   which <code>dict</code> is one) into an array
   of <code>[<i>key</i>, <i>value</i>]</code> pairs and sorting by column 0
   which is the key:
  </p>
  
  <p>
   <code>for [key, val] = sort[a, byColumn[0]]<br>
    &nbsp;&nbsp;&nbsp;println["$key = $val"]</code><br>
   <code>
    1 = one<br>
    2 = two<br>
    3 = three<br>
   </code>
  </p>
  
  <p>
   You can get an enumeration of the values in a dictionary by using the
   <code>values</code> method.  This method does not return the keys in any
   defined order, but you can sort them with the <a href="#Sorting">sorting
    functions</a> below.
  </p>

  <p>
   <code>println[join[", ", a.values[]]</code><br>
   <code>
    2, 1, 3
   </code>
  </p>

  <p>
   The following enumerates through key, value pairs sorted by key.  This
   works because the <code>sort</code> function works by coercing
   an <a href="#EnumeratingExpressions">enumerating expression</a> (of
   which <code>dict</code> is one) into an array
   of <code>[<i>key</i>, <i>value</i>]</code> pairs and sorting by column 1
   which is the key:
  </p>
  
  <p>
   <code>for [key, val] = sort[a, byColumn[1]]<br>
    &nbsp;&nbsp;&nbsp;println["$key = $val"]</code><br>
   <code>
    one = 1<br>
    two = 2<br>
    three = 3<br>
   </code>
  </p>
  
  <p>
   The syntax <code><i>dict</i>@<i>key</i></code> looks up the value of an
   dictionary corresponding to a specific key and returns it
   or the special value <code>undef</code> if the dictionary does not contain
   that key.  The method <code><i>dict</i>.get[<i>key</i>,
   altValue=undef]</code> can be used to look up the value corresponding to
   the key or return the alternate value <code>altValue</code> if the
   dictionary does not contain that key.
  </p>

  <div>
   <p><code>a.get[4]</code><br>
   <code>undef</code></p><p>
   <code>a.get[4, "nonexistent"]</code><br>
   <code>nonexistent</code></p></div>
  
  <p>
   A dictionary can be queried to see if it contains a specific key using the
   <code>containsKey[<i>key</i>]</code> method:
  </p>
  
  <p>
   <code>b.containsKey[1]</code><br>
   <code>true</code><br>
   <code>b.containsKey[4]</code><br>
   <code>false</code>
  </p>

  <p>
   Entries in a dictionary can be removed with the
   <code>remove[<i>key</i>]</code> method.  This returns the value
   corresponding to the key, or the special value <code>undef</code> if that
   key is not in the dictionary.
  </p>
  
  <p>
   <code>b.remove[1]</code><br>
   <code>one</code><br>
   <code>b.remove[4]</code><br>
   <code>undef</code>
  </p>

  <p>
   You can invert the contents of a dictionary by using the
   <code>invert</code> method which returns a new dictionary with key-value
   pairs reversed.  If the values are not hashable, this will print a
   warning.  If the same value appears multiple times, this will print a
   warning.
  </p>

  <p>
   <code>c = b.invert[]</code><br>
   <code>[[one, 1], [two, 2], [three, 3]]</code><br>
  </p>
  
  <p>
   A dictionary can be cleared by using the <code>clear</code> method:
  </p>
  
  <p>
   <code>
    a.clear[]<br>
    a<br>
   </code>
   <code>
    []
   </code>
  </p>

  <p>
    A dictionary is often used to count occurrences of an item.  The
    methods <code>increment[<i>key</i>]</code>
    and <code>increment[<i>key</i>, <i>increment</i>]</code> method increments
    the value corresponding to the specified key by the specified count (in
    the first method, it increments by 1.)  It returns the new total.
  </p>
  
  <p>
   <code>
    d=new dict<br>
    d.increment["a", 1]<br>
    d.increment["a"]  <code>// Same as above, increments by 1</code><br>
    d.increment["b", 1]<br>
    d<br>
   </code>
   <code>
    [[a,2],<br>
    &nbsp;[b,1]]
   </code>
  </p>

  <p>
   A dictionary is often used to store a list of occurrences corresponding to
   the specified key.  The
   functions <code>addToList[<i>key</i>, <i>value</i>]</code>
   or <code>addToSet[<i>key</i>, <i>value</i>]</code> pushes the specified
   value onto the list or set corresponding to the key and returns the new
   list or set.
  </p>
  
  <p>
   <code>
    d=new dict<br>
    d.addToList["a", 1]<br>
    d.addToList["a", 2]<br>
    d.addToList["b", 3]<br>
    d<br>
   </code>
   <code>
    [[a, [1, 2]],<br>
    &nbsp;[b, [3]]]
   </code>
  </p>
  
  <p>
   <code>
    d=new dict<br>
    d.addToSet["a", 1]<br>
    d.addToSet["a", 2]<br>
    d.addToSet["b", 3]<br>
    d<br>
   </code>
   <code>
    [[a, [1, 2]],<br>
    &nbsp;[b, [3]]]
   </code>
  </p>
  
  <h2><a name="Sets">Sets</a></h2>
  <p>
   A set is a data structure that contains items with no duplicates.  A set
   can currently contain strings, units, (that is, numbers),
   other sets, dictionaries, arrays, date/time values, or
   objects created from a <code>class</code>.
  </p>

  <p>
   You simply create an empty set using <code>new set</code>, a literal set by
   calling something like <code>new set[1,2,3]</code>, or turn an array or
   <a href="#EnumeratingExpressions">enumerating expression</a> into a set by calling
   <code>toSet[<i>expr</i>]</code>.

  </p><p>
   <code>
    a = new set</code>  <br>
  </p>

  <p>
   <code>
    b = new set[1,2,3]</code>  <br>
  </p>

    <p>
     <code>
      c = [3,6,9]  <code>// Create an array</code><br>
      d = toSet[c] <code>// Create a set from the
       array</code><br>
      </code>
    </p>
  
  <p>
   Note that sets
   do not preserve any order of the items contained in them.  There are a
   variety of methods for modifying sets:
  </p>

  <p>
   Items are inserted into a set using the <code>put</code> method:
  </p>
  
  <p>
   <code>
    a.put[1]<br>
    a.put[2]<br>
   </code>
   <code>
    [1,2]
   </code>
  </p>

  <p>
   Multiple items from an array, set, or other <a href="#EnumeratingExpressions">enumerating expression</a> can be
   inserted into a set as separate items using the <code>putAll</code> method: 
  </p>
  
  <p>
   <code>
    b = new set<br>
    c = [1,2,3]<br>
    b.putAll[c]<br>
   </code>
   <code>
    [2,3,1]
   </code>
  </p>

  <p>
   Items are removed from a set using the <code>remove</code> method:
  </p>
  
  <p>
   <code>
    a.remove[2]<br>
    a<br>
   </code>
   <code>
    [1]
   </code>
  </p>

  <p>
   A set can be tested to see if it contains a value by using the
   <code>contains</code> method:
  </p>
  
  <p>
   <code>
    a.contains[1]<br>
   </code>
   <code>
    true
   </code>
  </p>

  <p>
   You can get a shallow copy of a set by calling its
   <code>.shallowCopy[]</code> method.
  </p>
  
  <p>
   <code>
    b = a.shallowCopy[]<br>
    b.put[2]<br>
    b<br>
   </code>
   <code>
    [1,2]
   </code>
  </p>

  <p>
   You can make a shallow copy of a set and then add or remove an item from
   the set using its <code>.copyAndPut[<i>value</i>]</code>
   and <code>.copyAndRemove[<i>value</i>]</code>methods.  These are often
   useful in recursive routines.
  </p>
  
  <p>
   A set can be cleared by using the <code>clear</code> method:
  </p>
  
  <p>
   <code>
    a.clear[]<br>
    a<br>
   </code>
   <code>
    []
   </code>
  </p>
  
  <p>
   You can also enumerate over values contained in a set:
  </p>
  
  <p>
   <code>for value = a<br>
    &nbsp;&nbsp;&nbsp;println[value]</code>
  </p>

  <p>
   The following demonstrates turning an <a href="#EnumeratingExpressions">enumerating expression</a> into a set (the
   <code>lines[<i>url</i>]</code> function returns an <a href="#EnumeratingExpressions">enumerating expression</a>
   of all of the lines in a file,) turning that into an set (to remove
   duplicates) and sorting it (implicitly turning it into an array in the
   process.) The result is a sorted array containing all of the unique lines
   in a file, discarding duplicates.
  </p>

  <p>
   <code>
    sort[toSet[lines["file:myfile.txt"]]]
   </code>
  </p>

  <p>
   To obtain all of the possible subsets of the elements in the set, you
   can use the <code><i>set</i>.subsets[]</code> method.  This returns an
   <a href="#EnumeratingExpressions">enumerating expression</a> which iterates through allt he subsets of items in
   the set, including the empty set and the original set itself.  Each
   return value is itself an set of elements.
  </p>

  <p>
   <code>
    a = new set[1,2,3]<br>
    println[a.subsets[]]<br>
   </code>
   <code>
    [[], [1], [2], [1, 2], [3], [1, 3], [2, 3], [1, 2, 3]]
   </code>
  </p>

  <p>
   You can also request the subsets of the set and exclude either the empty
   set or the original set by using the
   <code><i>set</i>.subsets[<i>allowEmptySet</i>,&nbsp;<i>allowOriginalSet</i>]</code>
   method.  If <code>allowEmptySet</code> is <code>true</code>, the empty set
   will be returned as one of the elements.  If <code>false</code>, the empty
   set will be excluded. If <code>allowOriginalSet</code> is
   <code>true</code>, the full original set will be returned as one of the
   elements.  If <code>false</code>, the full original set will be excluded,
   and only "proper" subsets will be returned.
  </p>
  
  <p>
   <code>
    a = [1,2,3]<br>
    println[a.subsets[false, false]]<br>
   </code>
   <code>
    [[1], [2], [1, 2], [3], [1, 3], [2, 3]]
   </code>
  </p>

  <p>
   Note that output of the empty set and the original set are suppressed in
   the example above.
  </p>

  
  <h3><a name="SetFunctions">Set Functions</a></h3>
  <p>
   The following functions operate on sets:
  </p>
  <table summary="Set Functions">
    <tbody><tr><th>Function</th><th>Description

    </th></tr><tr><td>union[<i>a</i>, <i>b</i>]</td><td>Returns a new set whose
      value is the union of sets <code>a</code> and <code>b</code>.
      (Sometimes written <code>a ∪ b</code>.) In other
      words, the new set contains all of the elements that exist in
      <em>either</em> set <code>a</code> <em>or</em> set <code>b</code>.

    </td></tr><tr><td>intersection[<i>a</i>, <i>b</i>]</td><td>Returns a new set
      whose value is the intersection of sets <code>a</code> and
      <code>b</code>. (Sometimes written <code>a ∩ b</code>.)
      In other words, the new set contains only the elements
      that exist in <em>both</em> set <code>a</code> <em>and</em> set
      <code>b</code>.

    </td></tr><tr><td>setsIntersect[<i>a</i>, <i>b</i>]</td><td>Returns true if
      the two sets have a non-empty intersection.  That is, both sets contain
      at least one element in common.
      
    </td></tr><tr><td>setDifference[<i>a</i>, <i>b</i>]</td><td>Returns a new set
      whose value is the difference of sets <code>a</code> and
      <code>b</code>. (Sometimes written <code>a - b</code> or
      <code>a \ b</code>.) 
      In other words, the new set contains only the elements
      that exist in set <code>a</code> <em>but not</em> in set
      <code>b</code>.  If the arguments are not sets, this tries to coerce the
      arguments into sets, so it can be used to get the differences of arrays
      as sets, for instance.  Note that ordering will be lost when
      differencing arrays.

    </td></tr><tr><td>symmetricDifference[<i>a</i>, <i>b</i>]</td><td>Returns a
      new set whose value is the "symmetric difference", also known as the
      "disjunctive union" of sets <code>a</code> and
      <code>b</code>.  In other words, the new set contains only the elements
      that are in either set <code>a</code> or <code>b</code> <em>but not</em>
      in both.  For example, the symmetric difference of the sets {1,2,3} and
      {3,4} is {1,2,4}.  If the arguments are not sets, this tries to coerce
      the arguments into sets, so it can be used to get the differences of
      arrays as sets, for instance.  Note that ordering will be lost when
      differencing arrays.

    </td></tr><tr><td>isSubset[<i>a</i>, <i>b</i>]</td><td>Returns true if
      sets <code>a</code> is a subset of set <code>b</code>. (Sometimes
      written <code>a ⊆ b</code>.)  In other words, this returns true if
      all of the elements in set <code>a</code> are also contained in set
      <code>b</code>.  <em>Note that this does not test that this is a
       "proper" subset.</em>  See below.

    </td></tr><tr><td>isProperSubset[<i>a</i>, <i>b</i>]</td><td>Returns true if
      sets <code>a</code> is a <em>proper</em> subset of set
      <code>b</code>. (Sometimes written <code>a ⊂ b</code>.)  In other
      words, this returns true if  all of the elements in set <code>a</code>
      are also contained in set <code>b</code> <em>and</em> set <code>a</code>
      also has fewer members than b.
      
    </td></tr><tr><td>toSet[<i>x</i>]</td><td>Turns the specified expression into
      a set, if possible. This works with <a href="#EnumeratingExpressions">enumerating expressions</a>, arrays, or
      simple expressions (making a single-item set out of the latter.)
      
    </td></tr><tr><td>length[<i>a</i>]</td><td>Returns the cardinality of the
      set, that is, the number of items it contains.
  </td></tr></tbody></table>
  
  <h2><a name="CommonFunctions">Common Functions</a></h2>
  <p>
   The most common trigonometric functions are built in.  They, as everything
   else in Frink, are best used when you explicitly specify the units.  For
   the following functions, input should be an angle, and output will come out
   dimensionless.  (If no unit is specified for input, it should act like
   radians, because radians <em>are</em> dimensionless units and really
   indistinguishable from pure numbers.)
  </p>

  <p>
   <code>sin[90 degrees]</code><br>
   <code>cos[2 pi radians]</code><br>
   <code>tan[30 arcsec]</code><br>
   <code>sec[45 degrees]</code><br>
   <code>csc[pi/2 radians]</code><br>
   <code>cot[30 arcsec]</code><br>
   <code>sinh[90 degrees]</code><br>
   <code>cosh[2 pi radians]</code><br>
   <code>sech[2 pi radians]</code><br>
   <code>tanh[30 arcsec]</code><br>
   <code>coth[.2]</code><br>
   <code>csch[.1]</code><br>
  </p>

  <p>
   For inverse operations, the input must be dimensionless, and the output
   will come out in angular units.  (Radians, by default.)  This is easily
   converted to whatever angular units you want, as above.  You don't see that
   the output is in radians because radians are essentially dimensionless
   numbers.  You just gotta be a bit careful with angles.
  </p>

  <p>
   <code>arcsin[.1] -&gt; degrees</code><br>
   <code>arccos[1/2] -&gt; radians</code><br>
   <code>arcsec[3/2] -&gt; radians</code><br>
   <code>arccsc[3/2] -&gt; radians</code><br>
   <code>arccot[1/2] -&gt; radians</code><br>
   <code>arctan[3 inches/(1 foot)] -&gt; arcminutes</code><br>
   (Returns a value in the range [-π/2, π/2])<br>
   <code>arctan[3 inches, 1 foot] -&gt; degrees</code><br>
   (Calculates <code>arctan[arg1/arg2]</code> corrected for the proper quadrant.
   Returns a value in the range [-π, π])<br>
   <code>arcsinh[.1]</code><br>
   <code>arccosh[6]</code><br>
   <code>arcsech[1]</code><br>
   <code>arctanh[1/10]</code><br>
   <code>arccoth[3]</code><br>
   <code>arccsch[.1]</code><br>
  </p>

  <h3><a name="FormattingFunctions">Formatting Functions</a></h3>
  <p>
   The following functions can be used to format numeric and unit expressions
   to a variety of formats.
  </p>
  <p>
   <i>Note:</i> the <code>-&gt;</code> operator is a formatting operator
   that <em>always returns a string</em>, so you can't format it any
   further.
  </p>

  <p>
   <em>This is wrong:</em><br>
   <code>
    a = 10 USD -&gt; Euro&nbsp;&nbsp;&nbsp;<code>// Creates a string (don't do this!)</code><br>
    format[a, "Euro", 2]&nbsp;<code>// format won't work on a string!</code>
   </code>
  </p>

  <p>
   This is right, and only converts and formats on output, which is
   usually what you want to do:<br>
   <code>
    a = 10 USD<br>
    format[a, "Euro", 2]
   </code>
  </p>

  <p>
   In the following functions, the value can be number with units of measure,
    or any <a href="#EnumeratingExpressions">enumerating expression</a>
    (array, set, <a href="#OrderedList">OrderedList</a>, etc.) with numerical values.  If the value is
    an array or other collection, these functions return an array of
    strings, which can then be formatted using other functions
    like <code>join</code>, <code>joinln</code>, etc.
  </p>
  
  <table summary="Formatting Functions">
   <tbody><tr><th>Function</th><th>Definition
      </th></tr><tr><td>format[value,&nbsp;divideBy,&nbsp;decPlaces]<br>formatFix[value,&nbsp;divideBy,&nbsp;decPlaces]<br>formatFixed[value,&nbsp;divideBy,&nbsp;decPlaces]</td><td><b>Fixed-decimal-places format:</b>  Divides
      <code>value</code> by <code>divideBy</code> and returns a string with a
       fixed number (<code>decPlaces</code>) of digits <em>after</em> the
       decimal point.  If the value is
       an array or other collection, these functions return an array of
       strings, which can then be formatted using other functions
       like <code>join</code>, <code>joinln</code>, etc.  If the number is
       dimensionless without size, <code>divideBy</code> should be
      <code>1</code>. For example:
      
      <p>
       <code>format[3 meters, feet, 2]<br></code>
       <code>9.84</code>
      </p>

      <p>
       <code>a = [[1/2, 1/3], [1/6, 1/7]]<br>
        joinln[format[a, 1, 5]]<br></code>
       <code>[0.50000, 0.33333]<br>[0.16667, 0.14286]</code>
      </p>

      <p>If <code>divideBy</code> is a string, this evaluates the string,
       expecting a unit to be returned, and both divides by this unit and
       concatenates the string after the result:
      </p>

      <p>
       <code>format[3 meters, "feet", 2]<br></code>
       <code>9.84 feet</code>
      </p>

      <p><b>Note:</b> This function is somewhat deprecated for several
       reasons:
      </p>

      <ul>
       <li>It requires additional work behind the scenes which makes it
        slower.  (That is, it needs to predict how many digits will be
        in the result after division, and then has to increase its working
        precision to calculate the full number of digits after the decimal
        point.)
       </li><li>It is not a very readable representation for very large or very
        small numbers.
       </li><li>It loses information for small numbers (less-significant digits
        may be lost or rounded or the number may be lost entirely.)
       </li><li>It is rarely a good choice for large numbers, as many of the
        decimal places will be meaningless or displayed as zero.
       </li><li>It's not quite as flexible as the other functions. It will not work
        if its arguments are not real numbers (<i>e.g.</i> complex numbers or
        intervals.  The other formatting functions <em>will</em> work in this
        case.)
      </li></ul>

      <p>
       The previous behavior of the <code>format</code> function was preserved
       to keep old programs working, but the default behavior of
       <code>format</code> <em>may</em> change in the future to another one of
       the formatting functions below.  The <code>formatFix</code> and
       <code>formatFixed</code> functions (which are identical to each other)
       will keep their current behavior, so it's probably better to use
       <code>formatFix</code> instead of <code>format</code> to future-proof
       your programs if this is the behavior your want to keep.
      </p>

    </td></tr><tr><td>formatSci[value, divideBy, decPlaces]</td><td><b>Scientific
       Notation:</b>   Divides
      <code>value</code> by <code>divideBy</code> and returns a string in
      scientific notation with <code>decPlaces</code> decimal
      digits.  (If the value is dimensionless without size,
      <code>divideBy</code> should be <code>1</code>). For example:
      
      <p>
       <code>formatSci[1 mm, feet, 3]<br></code>
       <code>3.33e-3</code>
      </p>

      <p>If <code>divideBy</code> is a string, this evaluates the string,
       expecting a unit to be returned, and both divides by this unit and
       concatenates the string after the result:
      </p>

      <p>
       <code>formatSci[1 mm, "feet", 4]<br></code>
       <code>3.281e-3 feet</code>
      </p>
      
    </td></tr><tr><td>formatSig[value, divideBy, decPlaces]</td><td><b>Significant
       Figures format:</b>  Divides
      <code>value</code> by <code>divideBy</code> and returns a string
      with <code>decPlaces</code> significant digits.  This may be a normal
      number or a number in scientific format, depending on the size of the
      number.  (If the number is dimensionless without size,
      <code>divideBy</code> should be <code>1</code>). For example:
      
      <p>
       <code>formatSig[100 mm, feet, 2]<br></code>
       <code>0.34</code>
      </p>

      <p>If <code>divideBy</code> is a string, this evaluates the string,
       expecting a unit to be returned, and both divides by this unit and
       concatenates the string after the result:
      </p>

      <p>
       <code>formatSig[100 mm, "feet", 3]<br></code>
       <code>0.328 feet</code>
      </p>

    </td></tr><tr><td>formatEng[value, divideBy, decPlaces]</td><td><b>Engineering
       format:</b> Divides
      <code>value</code> by <code>divideBy</code> and returns a string in
      "engineering" format (that is, in scientific mode or normal mode where
      exponents are a multiple of 3,) so that they can be easily read as
       milli-, kilo-, mega-, etc. with <code>decPlaces</code> significant
      digits.  (If the number is dimensionless without size,
      <code>divideBy</code> should be <code>1</code>). For example:
      
      <p>
       <code>formatEng[1000 miles, m, 4]<br></code>
       <code>1.609e+6</code>
      </p>

      <p>If <code>divideBy</code> is a string, this evaluates the string,
       expecting a unit to be returned, and both divides by this unit and
       concatenates the string after the result:
      </p>

      <p>
       <code>formatEng[29000 feet, "meters", 4]<br></code>
       <code>8.840e+3 meters</code>
      </p>
  </td></tr></tbody></table>

  <p>
   The following compares the output of the various formatting functions by
   displaying <code>-2/3 * 10^n</code> for various integer values of
   <code>n</code>.
  </p>
  
  <table summary="Formatting Examples">
  <tbody><tr><th><code>formatSig</code></th><th><code>formatSci</code></th><th><code>formatEng</code></th><th><code>format</code>, <code>formatFix</code>
   </th></tr><tr><td>-6.66667e-12         </td><td>-6.66667e-12         </td><td>-6.66667e-12         </td><td>0.000000             
   </td></tr><tr><td>-6.66667e-11         </td><td>-6.66667e-11         </td><td>-66.6667e-12         </td><td>0.000000             
   </td></tr><tr><td>-6.66667e-10         </td><td>-6.66667e-10         </td><td>-666.667e-12         </td><td>0.000000             
   </td></tr><tr><td>-6.66667e-9          </td><td>-6.66667e-9          </td><td>-6.66667e-9          </td><td>0.000000             
   </td></tr><tr><td>-6.66667e-8          </td><td>-6.66667e-8          </td><td>-66.6667e-9          </td><td>0.000000             
   </td></tr><tr><td>-6.66667e-7          </td><td>-6.66667e-7          </td><td>-666.667e-9          </td><td>-0.000001            
   </td></tr><tr><td>-6.66667e-6          </td><td>-6.66667e-6          </td><td>-6.66667e-6          </td><td>-0.000007            
   </td></tr><tr><td>-6.66667e-5          </td><td>-6.66667e-5          </td><td>-66.6667e-6          </td><td>-0.000067            
   </td></tr><tr><td>-6.66667e-4          </td><td>-6.66667e-4          </td><td>-666.667e-6          </td><td>-0.000667            
   </td></tr><tr><td>-6.66667e-3          </td><td>-6.66667e-3          </td><td>-6.66667e-3          </td><td>-0.006667            
   </td></tr><tr><td>-6.66667e-2          </td><td>-6.66667e-2          </td><td>-66.6667e-3          </td><td>-0.066667            
   </td></tr><tr><td>-0.666667            </td><td>-6.66667e-1          </td><td>-666.667e-3          </td><td>-0.666667            
   </td></tr><tr><td>-6.66667             </td><td>-6.66667             </td><td>-6.66667             </td><td>-6.666667            
   </td></tr><tr><td>-66.6667             </td><td>-6.66667e+1          </td><td>-66.6667             </td><td>-66.666667           
   </td></tr><tr><td>-666.667             </td><td>-6.66667e+2          </td><td>-666.667             </td><td>-666.666667          
   </td></tr><tr><td>-6666.67             </td><td>-6.66667e+3          </td><td>-6.66667e+3          </td><td>-6666.666667         
   </td></tr><tr><td>-66666.7             </td><td>-6.66667e+4          </td><td>-66.6667e+3          </td><td>-66666.666667        
   </td></tr><tr><td>-666667              </td><td>-6.66667e+5          </td><td>-666.667e+3          </td><td>-666666.666667       
   </td></tr><tr><td>-6.66667e+6          </td><td>-6.66667e+6          </td><td>-6.66667e+6          </td><td>-6666666.666667      
   </td></tr><tr><td>-6.66667e+7          </td><td>-6.66667e+7          </td><td>-66.6667e+6          </td><td>-66666666.666667     
   </td></tr><tr><td>-6.66667e+8          </td><td>-6.66667e+8          </td><td>-666.667e+6          </td><td>-666666666.666667    
   </td></tr><tr><td>-6.66667e+9          </td><td>-6.66667e+9          </td><td>-6.66667e+9          </td><td>-6666666666.666667   
   </td></tr><tr><td>-6.66667e+10         </td><td>-6.66667e+10         </td><td>-66.6667e+9          </td><td>-66666666666.666667  
   </td></tr><tr><td>-6.66667e+11         </td><td>-6.66667e+11         </td><td>-666.667e+9          </td><td>-666666666666.666667 
   </td></tr><tr><td>-6.66667e+12         </td><td>-6.66667e+12         </td><td>-6.66667e+12         </td><td>-6666666666666.666667
  </td></tr></tbody></table>

  <h3><a name="FormattingTables">Formatting Tables</a></h3>
  <p>
   Two-dimensional (and higher) arrays can be easily formatted into a table
   form.  This is more flexible and space-efficient than, say, trying to
   format with tab characters.  Each cell is allowed to contain embedded
   newline characters making this especially flexible.
  </p>
  
  <table summary="Table Formatting">
   <tbody><tr><th>Function</th><th>Definition
   </th></tr><tr><td>formatTable[<i>array</i>, <i>horizAlign</i>="center", <i>vertAlign</i>="center", <i>horizSep</i>="", <i>vertSep</i>="
     "]<p>formatTableLines[<i>array</i>, <i>horizAlign</i>="center", <i>vertAlign</i>="center", <i>horizSep</i>="", <i>vertSep</i>="&nbsp;"]
    </p></td><td>The <code>formatTable</code> and <code>formatTableLines</code>
     functions will format a two-dimensional (or higher) array as a
     two-dimensional table.  It will also format a one-dimensional array into
     a column.  The difference is that <code>formatTable</code>
     returns the result as a single string with embedded newlines
     and <code>formatTableLines</code> returns an array of strings with no
     newlines so you can layout and compose more complicated layouts.

     <p>
      Formats the specified 2-dimensional or higher array as a table, using
      the specified alignment within each cell and optional separators.
     </p>
     
     <p>
      <code>array</code>: The array to be formatted.  This can now also be
      any <a href="#EnumeratingExpressions">enumerating expression</a>.
     </p>

     <p>
     <code>horizAlign</code>: The horizontal alignment within the
     cell.  This must be one of the
     strings <code>"left"</code>, <code>"right"</code>,
     or <code>"center"</code> (the default.)
     </p>

     <p>
     <code>vertAlign</code>:  The vertical alignment within the cell.
     This is only applied if the table cell contains multiple lines.  This
     must be one of the strings <code>"top"</code>, <code>"bottom"</code>,
     or <code>"center"</code> (the default.)
     </p>

     <p>
     <code>horizSep</code>:  An optional character to draw optional horizontal
     lines separating cells.  This should be a one-character string.  If this
     is the empty string <code>""</code> (the default,) no horizontal lines
     are drawn separating cells.  A good suggestion is <code>"\u2500"</code>,
     the Unicode horizontal line box drawing character.
     </p>
     <p>
      
     <code>vertSep</code>:  The string that will be used to separate columns
     from each other.  The default is a single space, <code>"&nbsp;"</code>.
     This string can be of arbitrary length.
     </p>

     <p>
     <code>b = [[1,2], [3,10]]<br>
      println[formatTable[b, "right"]]
     </code>
    </p>

  <p>
   <code>
   1&nbsp;&nbsp;2<br>
3&nbsp;10</code>
  </p>

   </td></tr><tr><td>formatTableBoxed[<i>array</i>, <i>horizAlign</i>="center", <i>vertAlign</i>="center"]</td><td>Formats
     a table as the functions above, but with Unicode box-drawing characters
     surrounding and separating the cells.
     <p>
      <code>b = [[1,2], [3,10]]<br>
       println[formatTableBoxed[b, "right"]]
      </code>
     </p>

     <p>
      <code>
┌─┬──┐<br>
│1│&nbsp;2│<br>
├─┼──┤<br>
│3│10│<br>
└─┴──┘
      </code>
     </p>

   </td></tr><tr><td>formatTableBoxedHeavy[<i>array</i>, <i>horizAlign</i>="center", <i>vertAlign</i>="center"]</td><td>Formats
     a boxed table as the functions above, but with <em>heavy</em> Unicode
     box-drawing characters surrounding and separating the cells.
     <p>
      <code>b = [[1,2], [3,10]]<br>
       println[formatTableBoxedHeavy[b, "right"]]
      </code>
     </p>

     <p>
      <code>
┏━┳━━┓<br>
┃1┃&nbsp;2┃<br>
┣━╋━━┫<br>
┃3┃10┃<br>
┗━┻━━┛
    </code>
     </p>

   </td></tr><tr><td>formatMatrix[<i>array</i>, <i>horizAlign</i>="center", <i>vertAlign</i>="center"]</td><td>Formats
     a table as the functions above, but with Unicode box-drawing characters
     making traditional matrix brackets around it.
     <p>
      <code>b = [[1,2], [3,10]]<br>
       println[formatMatrix[b, "right"]]
      </code>
     </p>
     
     <p>
      <code>
┌&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;┐<br>
│1&nbsp;&nbsp;&nbsp;2│<br>
│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;│<br>
│3&nbsp;&nbsp;10│<br>
└&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;┘
     </code>
     </p>
     
   </td></tr><tr><td>formatMatrixCompact[<i>array</i>, <i>horizAlign</i>="center", <i>vertAlign</i>="center"]</td><td>Formats
     a table as the functions above, but with smaller bracket characters
     making traditional matrix brackets around it.  This eliminates two lines
     relative to <code>formatMatrix</code>.
     <p>
      <code>b = [[1,2], [3,10]]<br>
       println[formatMatrixCompact[b, "right"]]
      </code>
     </p>
     
     <p>
      <code>
⎡1&nbsp;&nbsp;&nbsp;2⎤<br>
⎢&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;⎥<br>
⎣3&nbsp;&nbsp;10⎦
     </code>
     </p>
     
   </td></tr><tr><td>formatMatrixVeryCompact[<i>array</i>, <i>horizAlign</i>="center", <i>vertAlign</i>="center"]</td><td>Formats
     a table as the functions above, but with smaller bracket characters
     making traditional matrix brackets around it.  The columns are seperated
     by only a single space and the rows have no separators.
     <p>
      <code>b = [[1,2], [3,10]]<br>
       println[formatMatrixVeryCompact[b, "right"]]
      </code>
     </p>
     
     <p>
      <code>
⎡1&nbsp;&nbsp;2⎤<br>
⎣3&nbsp;10⎦
     </code>
     </p>
   </td></tr><tr><td>formatParens[<i>array</i>, <i>horizAlign</i>="center", <i>vertAlign</i>="center"]</td><td>Formats
     a table as the functions above, but with Unicode vertical parenthesis
     characters surrounding it.
     <p>
      <code>b = [[1,2], [3,10]]<br>
       println[formatParens[b, "right"]]
      </code>
     </p>
     
     <p>
      <code>
⎛&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;⎞<br>
⎜1&nbsp;&nbsp;&nbsp;2⎟<br>
⎜&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;⎟<br>
⎜3&nbsp;&nbsp;10⎟<br>
⎝&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;⎠
     </code>
     </p>
     
   </td></tr><tr><td>formatParensCompact[<i>array</i>, <i>horizAlign</i>="center", <i>vertAlign</i>="center"]</td><td>Formats
     a table with Unicode vertical parenthesis characters surrounding it,
     similar to <code>formatParens</code> above, but if the table contains a
     single line of text, this collapses it to use ordinary parentheses.  Also
     note that parentheses are smaller than <code>formatParens</code>.
     <p>
      <code>b = [[1,2]]<br>
       println[formatParensCompact[b, "right"]]
      </code>
     </p>
     
     <p>
      <code>(1 2)</code>
     </p>
     
     <p>
      <code>c = [[1,2], [3,4]]<br>
       println[formatParensCompact[b]
      </code>
     </p>
     
     <p>
      <code>
⎛1&nbsp;&nbsp;2⎞<br>
⎜&nbsp;&nbsp;&nbsp;&nbsp;⎟<br>
⎝3&nbsp;&nbsp;4⎠
      </code>
     </p>
     
   </td></tr><tr><td>formatBracketsCompact[<i>array</i>, <i>horizAlign</i>="center", <i>vertAlign</i>="center"]</td><td>Formats
     a table with Unicode square brackets characters surrounding it, similar
     to <code>formatMatrix</code> above, but if the table contains a single
     line of text, this collapses it to use ordinary square brackets.  Note
     that this function currently does not have horizontal spacing for
     multi-line arrays.  (This is because it is primarily used
     by <a href="https://frinklang.org/fsp/colorize.fsp?f=formatEquation.frink">formatEquation.frink</a>
     to format array arguments and which demonstrates more formatting of
     expressions using these functions.)  Also note that brackets are smaller
     than <code>formatMatrix</code>.

     <p>
      <code>b = [[1,2]]<br>
       println[formatBracketsCompact[b, "right"]]
      </code>
     </p>
     
     <p>
      <code>[1 2]</code>
     </p>
     
     <p>
      <code>c = [[1,2],[3,4]]<br>
       println[formatBracketsCompact[c]]
      </code>
     </p>
     
     <p>
      <code>
⎡12⎤<br>
⎢&nbsp;&nbsp;⎥<br>
⎣34⎦
      </code>
     </p>
     
   </td></tr><tr><td>formatTableInput[<i>array</i>, <i>horizAlign</i>="center", <i>vertAlign</i>="center"]</td><td>Formats
     a table as the functions above, but in
     Frink's <a href="#InputForm"><code>inputForm</code></a> so that it can be
     parsed by Frink, passed to the <a href="#SelfEvaluation">eval</a>
     function, pasted into a Frink program, etc.
     <p>
      <code>b = [["one", "two"], ["three", "four"]]<br>
       println[formatTableInput[b]]
      </code>
     </p>
     
     <p>
      <code>
       [[&nbsp;"one"&nbsp;,&nbsp;"two"&nbsp;],<br>
&nbsp;["three",&nbsp;"four"]]
     </code>
    </p>

    </td></tr><tr><td>columnize[<i>array</i>, <i>columns</i>]</td><td>Turns a
      one-dimensional array (or <a href="#EnumeratingExpressions">enumerating
      expression</a>) into a two-dimensional array with <code>columns</code>
      number of columns.  This can be used with the table formatting functions
      above to pretty-print a large array in columns for display.  For
      example, the following prints the first 25 prime numbers in 5 columns:
      
     <p>
      <code>formatTable[columnize[first[primes[], 25], 5], "right"]</code><br>
      <code>
&nbsp;2&nbsp;&nbsp;3&nbsp;&nbsp;5&nbsp;&nbsp;7&nbsp;11<br>
13&nbsp;17&nbsp;19&nbsp;23&nbsp;29<br>
31&nbsp;37&nbsp;41&nbsp;43&nbsp;47<br>
53&nbsp;59&nbsp;61&nbsp;67&nbsp;71<br>
73&nbsp;79&nbsp;83&nbsp;89&nbsp;97
      </code>
    </p>

     To make the values in the table increase top-to-bottom then
     left-to-right, call the <code>.transpose[]</code> method on the output
     of <code>columnize</code>:
     <p>
      <code>formatTable[columnize[first[primes[], 25], 5].transpose[], "right"]</code><br>
      <code>
&nbsp;2&nbsp;13&nbsp;31&nbsp;53&nbsp;73<br>
&nbsp;3&nbsp;17&nbsp;37&nbsp;59&nbsp;79<br>
&nbsp;5&nbsp;19&nbsp;41&nbsp;61&nbsp;83<br>
&nbsp;7&nbsp;23&nbsp;43&nbsp;67&nbsp;89<br>
11&nbsp;29&nbsp;47&nbsp;71&nbsp;97<br>
      </code>
    </p>
  </td></tr></tbody></table>

  <p>
   For example, to format a simple multiplication table:
  </p>

  <p>
   <code>a = new array[[10,10],{|a,b| (a+1)*(b+1)}]<br>
    println[formatTable[a, "right"]]
   </code>
  </p>
  
  <p>
   <code>&nbsp;1&nbsp;&nbsp;2&nbsp;&nbsp;3&nbsp;&nbsp;4&nbsp;&nbsp;5&nbsp;&nbsp;6&nbsp;&nbsp;7&nbsp;&nbsp;8&nbsp;&nbsp;9&nbsp;&nbsp;10<br>
&nbsp;2&nbsp;&nbsp;4&nbsp;&nbsp;6&nbsp;&nbsp;8&nbsp;10&nbsp;12&nbsp;14&nbsp;16&nbsp;18&nbsp;&nbsp;20<br>
&nbsp;3&nbsp;&nbsp;6&nbsp;&nbsp;9&nbsp;12&nbsp;15&nbsp;18&nbsp;21&nbsp;24&nbsp;27&nbsp;&nbsp;30<br>
&nbsp;4&nbsp;&nbsp;8&nbsp;12&nbsp;16&nbsp;20&nbsp;24&nbsp;28&nbsp;32&nbsp;36&nbsp;&nbsp;40<br>
&nbsp;5&nbsp;10&nbsp;15&nbsp;20&nbsp;25&nbsp;30&nbsp;35&nbsp;40&nbsp;45&nbsp;&nbsp;50<br>
&nbsp;6&nbsp;12&nbsp;18&nbsp;24&nbsp;30&nbsp;36&nbsp;42&nbsp;48&nbsp;54&nbsp;&nbsp;60<br>
&nbsp;7&nbsp;14&nbsp;21&nbsp;28&nbsp;35&nbsp;42&nbsp;49&nbsp;56&nbsp;63&nbsp;&nbsp;70<br>
&nbsp;8&nbsp;16&nbsp;24&nbsp;32&nbsp;40&nbsp;48&nbsp;56&nbsp;64&nbsp;72&nbsp;&nbsp;80<br>
&nbsp;9&nbsp;18&nbsp;27&nbsp;36&nbsp;45&nbsp;54&nbsp;63&nbsp;72&nbsp;81&nbsp;&nbsp;90<br>
10&nbsp;20&nbsp;30&nbsp;40&nbsp;50&nbsp;60&nbsp;70&nbsp;80&nbsp;90&nbsp;100<br>
 </code>
  </p>

  <p>
   This can be combined with the formatting functions to, say, format a table
   of numbers to 5 significant digits:
  </p>

  <p>
   <code>c = makeArray[[5,5], {|a,b| randomFloat[a,b]}]<br>
    println[formatTable[formatSig[c,1,5]]]</code>
  </p>

  <p>
   <code>0.0000&nbsp;&nbsp;0.70580&nbsp;0.56481&nbsp;6.0658e-2&nbsp;0.95933<br>
0.62126&nbsp;1.0000&nbsp;&nbsp;1.0118&nbsp;&nbsp;&nbsp;2.7759&nbsp;&nbsp;&nbsp;1.7738&nbsp;<br>
1.0864&nbsp;&nbsp;1.2141&nbsp;&nbsp;2.0000&nbsp;&nbsp;&nbsp;2.3813&nbsp;&nbsp;&nbsp;3.3547&nbsp;<br>
2.9476&nbsp;&nbsp;1.6989&nbsp;&nbsp;2.8562&nbsp;&nbsp;&nbsp;3.0000&nbsp;&nbsp;&nbsp;3.6287&nbsp;<br>
0.95502&nbsp;3.2701&nbsp;&nbsp;2.6403&nbsp;&nbsp;&nbsp;3.3168&nbsp;&nbsp;&nbsp;4.0000&nbsp;</code>
  </p>

  <p>
   Or, with <code>formatTableBoxed</code>, the table can be drawn with Unicode
   box-drawing characters.  These of course require a monospaced font and
   require your environment to be configured for Unicode output.
  </p>

  <p>
   <code>b = [[1,2], [3,10]]<br>
    println[formatTableBoxed[b, "right"]]
   </code>
  </p>

  <p>
   <code>
┌─┬──┐<br>
│1│&nbsp;2│<br>
├─┼──┤<br>
│3│10│<br>
└─┴──┘
   </code>
  </p>

  <p>
   If passed a one-dimensional array, <code>formatTable</code> will format it
   into column form, with optional alignment.
  </p>

  <p>
   <code>b = makeArray[[5], {|a| 10^a}]<br>
    println[formatTable[b, "right"]]
   </code>
  </p>
  
  <p>
   <code>&nbsp;&nbsp;&nbsp;&nbsp;1<br>
&nbsp;&nbsp;&nbsp;10<br>
&nbsp;&nbsp;100<br>
&nbsp;1000<br>
10000</code>
  </p>
  
  <p>
   This can also be used for formatting fractions.
  </p>

  <p>
   <code>symbolicMode[true]<br>
    b = noEval[1/2 F freq^-1 pi^-1 v^-1]<br>
    println[formatTable[numeratorDenominator[b],"center","center","\u2500"]<br>
   </code>
  </p>
  
  <p>
   <code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;F&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
───────────<br>
2&nbsp;freq&nbsp;pi&nbsp;v
   </code>
  </p>

  <p>
   These formatting functions can work with multi-line strings, and as a
   result, they can be called recursively to typeset equations.  This is quite
   powerful.  See the sample
   program, <a href="https://frinklang.org/fsp/colorize.fsp?f=formatEquation.frink">formatEquation.frink</a>,
   which demonstrates more formatting of expressions using these functions.
  </p><p>
   <code>symbolicMode[true]<br>
    b = noEval[1/2 F freq^-1 pi^-1 v^-1]<br>
    frac = formatTable[numeratorDenominator[b],"center","center","\u2500"]<br>
    println[formatTable[[["phase =", frac]]]]
   </code>
  </p>

  <p>
   <code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;F&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br>
phase&nbsp;=&nbsp;───────────<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2&nbsp;freq&nbsp;pi&nbsp;v
    </code>
  </p>

  <p>
   Similarly, it can be used to format tables in Frink source code.
  </p>
   
  <p>
   <code>
    c = new array[[4,4], {|a,b| (a+1)*(b+1)}]<br>
    d  = formatTableInput[c, "right"]<br>
    println[formatTable[[["c =", d]], "right", "top"]]
   </code>
  </p>
  
  <p>
   <code>c&nbsp;=&nbsp;[[1,&nbsp;2,&nbsp;&nbsp;3,&nbsp;&nbsp;4],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[2,&nbsp;4,&nbsp;&nbsp;6,&nbsp;&nbsp;8],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[3,&nbsp;6,&nbsp;&nbsp;9,&nbsp;12],<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[4,&nbsp;8,&nbsp;12,&nbsp;16]]
   </code>
  </p>
  
  <h3><a name="RoundingFunctions">Rounding Functions</a></h3>
  <table summary="Rounding Functions">
   <tbody><tr><th>Function</th><th>Definition
    </th></tr><tr><td>floor[x]</td><td>Returns largest integer &lt;= x
    </td></tr><tr><td>floor[x,y]</td><td>Rounds x down to the nearest multiple of
      y.  For example, <code>floor[3.14159, 0.001]</code>
      returns <code>3.141</code>  This can be used with units of measure, for
      example:  <code>floor[23 hours, day]</code> returns a unit equal
      to <code>0 days</code>.
    </td></tr><tr><td>ceil[x]</td><td>Returns smallest integer &gt;= x
    </td></tr><tr><td>ceil[x,y]</td><td>Rounds x up to the nearest multiple of
      y.  For example, <code>ceil[3.14159, 0.01]</code>
      returns <code>3.15</code>.  This can be used with units of measure, for
      example:  <code>ceil[13 hours, day]</code> returns a unit equal
      to <code>1 day</code>.
    </td></tr><tr><td>round[x]</td><td>Rounds to nearest integer
    </td></tr><tr><td>round[x,y]</td><td>Rounds <code>x</code> to nearest
      multiple of <code>y</code>.  This can be used with units of measure, for
      example:  <code>round[13 hours, day]</code> returns a unit equal
      to <code>1 day</code>.
    </td></tr><tr><td>int[x]</td><td>Truncates decimal places to produce integer
    </td></tr><tr><td>trunc[x]</td><td>Truncates decimal places to produce
      integer
    </td></tr><tr><td>negate[x]</td><td>Negates a number (that is, multiplies it
      by -1) while preserving precision.
  </td></tr></tbody></table>

  <h3><a name="NumberTheory">Number Theory</a></h3>
  <p>
   Some functions for number theory and factorization are available.
  </p>

  <p>
   <b>Note:</b> If you're doing number-theoretical work with very large
   integers, please see the <a href="#PerformanceTips">Performance Tips</a>
   section of the documentation for ways to greatly improve integer
   performance.
  </p>
  
  <table summary="Other Functions">
    <tbody><tr><th>Function</th><th>Description

    </th></tr><tr><td>bitLength[<i>x</i>]</td><td>Returns the number of bits in
      the minimal two's-complement representation of an integer,
      <em>excluding</em> a sign bit.  In other words, this returns the index
      of the highest bit that differs from the sign bit.
      
    </td></tr><tr><td>getBit[<i>num</i>,&nbsp;<i>bit</i>]</td><td>Returns an
      integer, either 0 or 1, indicating the value of the specified bit in an
      integer.  Bit 0 is the least-significant bit.  The number is treated as
      a two's-complement representation with infinite length.  That is, the
      high bits on a negative number will always be 1, and the high bits on a
      positive number or zero will always be 0.

    </td></tr><tr><td>getBitBool[<i>num</i>,&nbsp;<i>bit</i>]</td><td>Returns a
      boolean value, either false for 0 or true for 1, indicating the value of
      the specified bit in an integer.  Bit 0 is the least-significant bit.
      The number is treated as a two's-complement representation with infinite
      length.  That is, the high bits on a negative number will always be true,
      and the high bits on a positive number or zero will always be false.
      
    </td></tr><tr><td>getLowestSetBit[<i>num</i>]</td><td>Returns the index of
      the rightmost (lowest-order) one bit in an integer (the number of
      zero bits to the right of the rightmost one bit). Returns -1 if the
      integer contains no one bits.

    </td></tr><tr><td>shiftLeft[<i>num</i>, <i>bits</i>]</td><td>Shifts the bits
      of an integer left by the specified number of bits.  New bits will
      contain zero.  This is equivalent to multiplying by 2<sup>bits</sup> but
      is usually more efficient.

    </td></tr><tr><td>shiftRight[<i>num</i>, <i>bits</i>]</td><td>Shifts the bits
      of an integer right by the specified number of bits, losing the bits
      pushed off the right side.  This is equivalent to performing a
      <code>div</code> by 2<sup>bits</sup> but is usually more efficient.
      
    </td></tr><tr><td>bitAnd[<i>n</i>,&nbsp;<i>m</i>]</td><td>Returns the bitwise
      <code>AND</code> of two integers, treated as two's complement numbers
      with infinite sign bits.
      
    </td></tr><tr><td>bitOr[<i>n</i>,&nbsp;<i>m</i>]</td><td>Returns the bitwise
      <code>OR</code> of two integers, treated as two's complement numbers
      with infinite sign bits.
      
    </td></tr><tr><td>bitXor[<i>n</i>,&nbsp;<i>m</i>]</td><td>Returns the bitwise
      <code>XOR</code> (exclusive-or) of two integers, treated as two's
      complement numbers with infinite sign bits.
      
    </td></tr><tr><td>bitNot[<i>n</i>]</td><td>Returns the bitwise
      <code>NOT</code> of an integer, treated as a two's complement number with
      infinite sign bits.  This means that performing a <code>bitNot</code> on
      a positive number will return a negative number, and vice-versa.  This
      may be unexpected if you're unfamiliar with two's complement notation,
      but functions like <code>getBit[<i>num</i>,&nbsp;<i>bit</i>]</code> and
      <code>bitLength[<i>num</i>]</code> will do the right thing, and will
      handle all leading sign bits correctly without you needing to specify
      the length of your numbers.  Please look up two's complement
      number representation if you're unfamiliar with this.
      
    </td></tr><tr><td>bitNand[<i>n</i>,&nbsp;<i>m</i>]</td><td>Returns the bitwise
      <code>NAND</code> (an AND followed by a NOT) of two integers, treated as
      two's complement numbers with infinite sign bits.  See notes about
      <code>bitNot[<i>num</i>]</code> above.
      
    </td></tr><tr><td>bitNor[<i>n</i>,&nbsp;<i>m</i>]</td><td>Returns the
      bitwise <code>NOR</code> (an OR followed by a NOT) of two integers,
      treated as two's complement numbers with infinite sign bits.  See notes
      about <code>bitNot[<i>num</i>]</code> above.

    </td></tr><tr><td>setBit[<i>n</i>,&nbsp;<i>bit</i>]</td><td>Sets the
      specified bit of a number (least significant bit is 0) to 1 and returns
      a new number. This is equivalent to
      <code>bitOr[<i>n</i>,&nbsp;shiftLeft[1,&nbsp;<i>bit</i>]]</code>.
      <code>n</code> is treated as a two's complement number with infinite
      sign bits.  See notes about <code>bitNot[<i>num</i>]</code> above.
      
    </td></tr><tr><td>clearBit[<i>n</i>,&nbsp;<i>bit</i>]</td><td>Clears the
      specified bit of a number (least significant bit is 0) to 0 and returns
      a new number. This is equivalent to
      <code>bitAnd[<i>n</i>,&nbsp;bitNot[shiftLeft[1,&nbsp;<i>bit</i>]]]</code>.
      <code>n</code> is treated as a two's complement number with infinite
      sign bits.  See notes about <code>bitNot[<i>num</i>]</code> above.
      
    </td></tr><tr><td>flipBit[<i>n</i>,&nbsp;<i>bit</i>]</td><td>Flips the
      specified bit of a number (least significant bit is 0) and returns
      a new number. This is equivalent to
      <code>bitXor[<i>n</i>,&nbsp;shiftLeft[1,&nbsp;<i>bit</i>]]</code>.
      <code>n</code> is treated as a two's complement number with infinite
      sign bits.  See notes about <code>bitNot[<i>num</i>]</code> above.
      
    </td></tr><tr><td>rotateLeft[<i>n</i>, <i>bits</i>, <i>bitLength</i>]</td><td>Rotates
      the bits of an integer <code>n</code> left by <code>bits</code> bits,
      treating the number as <code>bitLength</code> (e.g. 32 is common) bits
      wide.
      
    </td></tr><tr><td>rotateRight[<i>n</i>, <i>bits</i>, <i>bitLength</i>]</td><td>Rotates
      the bits of an integer <code>n</code> right by <code>bits</code> bits,
      treating the number as <code>bitLength</code> (e.g. 32 is common) bits
      wide.
      
    </td></tr><tr><td>gcd[<i>x</i>,&nbsp;<i>y</i>]</td><td>Returns the greatest
      common divisor of the integers <code>x</code> and <code>y</code>.

    </td></tr><tr><td>gcd[<i>array</i>]</td><td>Returns the greatest common
      denominator of an array
      (or <a href="#EnumeratingExpressions">enumerating expression</a>) of
      integers.
      
    </td></tr><tr><td>lcm[<i>x</i>,&nbsp;<i>y</i>]</td><td>Returns the least
      common multiple of the integers <code>x</code> and <code>y</code>.

    </td></tr><tr><td>lcm[<i>array</i>]</td><td>Returns the least
      common multiple of an array
      (or <a href="#EnumeratingExpressions">enumerating expression</a>) of
      integers.
      
    </td></tr><tr><td>isPrime[<i>x</i>]</td><td>Returns false if the integer
      <code>x</code> is composite, true if the number is prime (or probably
      prime.)  This test uses trial division and then Rabin-Miller strong
      pseudoprime tests to determine primality.  The bases used in the
      Rabin-Miller test are known to <em>prove</em> primality for numbers
      smaller than 3,317,044,064,679,887,385,961,981, (see <a target="_blank" href="https://arxiv.org/abs/1509.00864">Sorenson and Webster</a>) but for larger numbers
      this function can erroneously declare a composite number to be prime.
      (If it returns false, the number is definitely composite.)
      
      <p>
       If the number is larger than this, the test is performed against 78
       random prime bases.  This gives a <em>very</em> small probability of
       about 1 in 10<sup>47</sup> that the function may return
       <code>true</code> for a composite number.  (And that's a worst-case;
       for randomly-chosen large numbers, the probability of error is actually
       far, far lower for most numbers, especially big ones.  The above
       assumes the ridiculously low estimate that the pseudoprime test fails
       1/4 of the time.  The reality is orders of magnitude lower.  For better
       estimates, see <a href="https://primes.utm.edu/notes/prp_prob.html" target="_blank">Probable primes: How Probable?</a>)
      </p>
      
      <p>
       It is more likely that any of the following will happen:
      </p>

      <ul>
       <li>You cut-and-pasted the wrong number to be tested, maybe missing one
        digit.  (In my experience in prime number groups, this is <em>by
         far</em> the most likely source of error.)
        
       </li><li>Your hardware will fail and return the wrong answer (perhaps due to
        a cosmic ray hitting it.)

       </li><li>You'll flip a coin 156 times in a row and it will land on "heads"
        every time.

       </li><li>You'll play roulette and your number will get picked 29 times in a
        row.

       </li><li>You'll test a trillion numbers every second for the known lifetime
        of the universe and you'll still only have a miniscule 1 in
        10<sup>17</sup> chance of getting a single wrong answer.
      </li></ul>

      <p>
       And these are ridiculously generous estimates.  The actual probability
       of failure is usually astronomically lower than this.
      </p>

      <p>
       As of the 2005-11-13 release, <code>isPrime[<i>x</i>]</code> was
       extended to automatically use a faster Lucas-Lehmer test if <i>x</i> is
       of the form 2<sup>n</sup>-1 (<i>i.e.</i> Mersenne numbers).  Note that
       the Lucas-Lehmer test is sufficient to <em>prove</em> primality for
       numbers of this form, regardless of their size.
      </p>

      <p>
       Also note that <code>isPrime[1]</code> will return <code>true</code>.
       This simplifies recursive factor-finding algorithms, but I know it may
       not match the modern definition of primes.  This behavior may change,
       so try not to rely on it.
      </p>

      <p>
       Frink is not vulnerable to the attacks in the very
       interesting <a href="https://eprint.iacr.org/2018/749.pdf">Prime and
       Prejudice</a> paper.  You can test it with the <a href="https://frinklang.org/fsp/colorize.fsp?f=PrimeAndPrejudice.frink">PrimeAndPrejudice.frink</a>
       sample program.
      </p>
      
    </td></tr><tr><td>factor[<i>x</i>]</td><td>Returns the prime factors of an
      integer <code>x</code> as a two-dimensional list.  This uses trial
      division, then the Pollard <i>p-1</i> method, and then the Pollard Rho
      method to find factors.  The factor list consists of a list of pairs of
      prime factors and the exponent of each factor:

      <p>
       <code>factor[1000]</code><br>
       <code>[[2, 3], [5, 3]]</code>
      </p>

      <p>
       This indicates that the prime factors of 1000 are 2<sup>3</sup> *
       5<sup>3</sup>.
      </p>
      
    </td></tr><tr><td>factorFlat[<i>x</i>]</td><td>Returns the prime factors of an
      integer <code>x</code> as a one-dimensional list.  This uses trial
      division, then the Pollard <i>p-1</i> method, and then the Pollard Rho
      method to find factors.  The factor list consists of a list of prime
      factors, each possibly repeated.  This performs identically to the
      <code>factor[<i>x</i>]</code> function above; the output format is just
      different.

      <p>
       <code>factorFlat[1000]</code><br>
       <code>[2, 2, 2, 5, 5, 5]</code>
      </p>
      
    </td></tr><tr><td>allFactors[<i>n</i>, <i>include1=true</i>,
      <i>includeN=true</i>, <i>sort=true</i>, <i>onlyToSqrt=false</i>]</td><td>Returns <em>all</em> factors
      of the integer <code>n</code>, <em>not just prime factors</em>.  The
      optional arguments <code>include1</code> and <code>includeN</code>
      indicate if the numbers 1 and n are to be included in the results.  If
      the optional argument <code>sort</code> is true, the results will be
      sorted. If the optional argument <code>onlyToSqrt</code>=true, then only
      the factors less than or equal to the square root of the number will be
      produced.  It currently returns an array, but that may change to an
      <a href="#EnumeratingExpressions">enumerating expression</a> someday to be more memory-efficient for numbers
      with huge amounts of factors.
      
    </td></tr><tr><td>JacobiSymbol[<i>a,n</i>]</td><td>Returns the Jacobi symbol
      (often written as (a/n) ) of the integers <code>a</code> and
      <code>n</code>.  <code>n</code> must be a positive, odd integer.  This
      function is used in factorization and primality testing.  The Jacobi
      symbol is a generalization of the Legendre symbol, so it can be used to
      calculate the Legendre symbol of two numbers.  (The Legendre symbol is
      only defined if <code>n</code> is prime.)

    </td></tr><tr><td>isStrongPseudoprime[<i>num</i>, <i>base(s)</i>]</td><td>
      Returns true if <code>num</code> is a strong pseudoprime to base
      <code>base</code>.  If this returns false, the number is definitely
      composite.  If it returns true, the number <em>may</em> be prime.  This
      does <em>not</em> prove that a number is actually prime, as
      numbers can fail this test for up to 1/4 of bases.  This can be used as a
      component of a prime sieving algorithm (but be sure to do things like
      verify that the number is odd first!)

      <p>
       The argument <code>base</code> can also be an array of integers, in
       which case all of the bases are tested, bailing out when the number is
       known to be composite.  This may be slightly faster (and easier to
       code) in some cases.  You may be able to use this along
       with <a href="https://miller-rabin.appspot.com/" target="_blank">minimal sets of bases</a> (link opens in new window) to
       make an even faster primality test.

      </p><p>
       While the above paragraph correctly states that this test can fail for
       <em>up to</em> 1/4 of bases, the actual failure rate for larger numbers
       is many orders of magnitude smaller than that!  See <a href="http://primes.utm.edu/notes/prp_prob.html" target="_blank">Probable primes: How Probable?</a> (link opens in new
       window) for an estimate of how much lower the failure rate becomes.

    </p></td></tr><tr><td><code>nextPrime[<i>n</i>]</code></td><td>Returns the next
      prime number <em>greater than</em> <code>n</code>.  The value of
      <code>n</code> may be any real number.  This method uses a wheel
      factoring method to completely avoid testing composite numbers with
      small factors.

    </td></tr><tr><td><code>previousPrime[<i>n</i>]</code></td><td>Returns the
      previous prime number <em>smaller than</em> <code>n</code>.  The value
      of <code>n</code> may be any real number.  If <code>n</code> is smaller
      than 2, this returns <code>undef</code>.  This method uses a wheel
      factoring method to completely avoid testing composite numbers with
      small factors.

    </td></tr><tr><td><code>primes[]</code></td><td>Returns an infinite
      <a href="#EnumeratingExpressions">enumerating expression</a> that lists
      all of the prime numbers in ascending order.  Note that this will
      produce infinite output if you even try to print it, so you probably
      want to call it from a <code>for</code> loop or from something
      like <code>first[primes[], 100]</code>
      
    </td></tr><tr><td><code>primes[<i>begin</i>]</code></td><td>Returns an
      infinite <a href="#EnumeratingExpressions">enumerating expression</a>
      that lists all of the prime numbers greater than or equal
      to <code>begin</code> in ascending order.  Note that this will produce
      infinite output if you even try to print it, so you probably want to
      call it from a <code>for</code> loop or from something
      like <code>first[primes[3], 100]</code>
      
    </td></tr><tr><td><code>primes[<i>begin</i>, <i>end</i>]</code></td><td>Returns
      a finite <a href="#EnumeratingExpressions">enumerating expression</a>
      that lists all of the prime numbers greater than or equal
      to <code>begin</code> and less than or equal to <code>end</code>.
      If <code>begin</code> is <code>undef</code>, the enumeration begins with
      2.  If <code>end</code> is <code>undef</code>, the enumeration is
      potentially infinite.
      
    </td></tr><tr><td><code>nthPrime[<i>num</i>]</code></td><td>Returns the nth
      prime number (indexed with 1, that is, <code>nthPrime[1]</code> returns
      2 and <code>nthPrime[2]</code> returns 3.)
        
    </td></tr><tr><td><code>partitionCount[<i>n</i>]</code></td><td>Returns the
      number of ways that the integer n can be partitioned.  This uses Euler's
      pentagonal number algorithm to find the partition count somewhat
      efficiently, and caches the results so subsequent calls to this function
      will be efficient.

    </td></tr><tr><td><code>partitions[<i>n</i>]</code></td><td>Returns an
      enumeration of the partitions of the integer n.  For example:

      <p>
       <code>
        for a = partitions[4]<br>
        &nbsp;&nbsp;&nbsp;println[a]<br>
       </code>
       <code>
        [4]<br>
        [3, 1]<br>
        [2, 2]<br>
        [2, 1, 1]<br>
        [1, 1, 1, 1]
       </code>
      </p>

    </td></tr><tr><td><code>partitionsCompact[<i>n</i>,
       <i>countPermutations=false</i>]</code></td><td>Like the
      <code>partitions</code> 
      function above, but returns a more compact enumeration of the partitions
      of the integer n.  Each list contains [num, count] pairs indicating the
      number and its count in a partition.  For example, compare the following
      representation with the one from the <code>partitions</code> function
      above.

      <p>
       <code>
        for a = partitionsCompact[4]<br>
        &nbsp;&nbsp;&nbsp;println[a]<br>
       </code>
       <code>
        [[4, 1]]<br>
        [[3, 1], [1, 1]]<br>
        [[2, 2]]<br>
        [[2, 1], [1, 2]]<br>
        [[1, 4]]
       </code>
      </p>

      <p>
       If the optional argument <code>countPermutations</code> is
       <code>true</code>, then each element also contains the number of
       possible permutations of the list.
      </p>

      <p>
       <code>
        for a = partitionsCompact[4, true]<br>
        &nbsp;&nbsp;&nbsp;println[a]<br>
       </code>
       <code>
        [[[4, 1]], 1]<br>
[[[3, 1], [1, 1]], 2]<br>
[[[2, 2]], 1]<br>
[[[2, 1], [1, 2]], 3]<br>
[[[1, 4]], 1]
       </code>
      </p>
      
    </td></tr><tr><td><code>binomial[<i>m,n</i>]</code></td><td>Returns the
     binomial coefficient.  This is of the number of ways <code>m</code>
     things can be chosen <code>n</code> at a time, with order being
     unimportant.  This is sometimes called "m choose n" or "m C n".  This is
     equivalent to <code>m!/(n!*(m-n)!)</code> although calculating that way
     often leads to way-too-big numbers.  For example, <code>binomial[10000,
     9998]</code> is equal to 49995000, but if you calculated it naively,
     you'd have to calculate 10000! which is a 35660-digit number, and divide
      it by another huge number, which could be inefficient and slow.
      <p>
       This will give the number of items returned by the
       the <a href="#Combinations"><code><i>array</i>.combinations[<i>take</i>]</code></a>
       method where <code>m</code> is the length of the array
       and <code>n</code> is the number of items to take.

      </p><p>
       See the sample
       program <a href="https://frinklang.org/fsp/colorize.fsp?f=Pochhammer.frink">Pochhammer.frink</a>
       for generalizations of the binomial function to non-integer types.
      </p>
                                 
    </td></tr><tr><td><code>permutationCount[<i>m,n</i>]</code></td><td>Returns
     the number of permutations of <code>m</code> things being
     taken <code>n</code> at a time, with order being important. This is
     sometimes called "mPn".  This is equivalent to <code>m!/((m-n)!)</code>
     but calculated efficiently by calling <code>factorialRatio[m,m-n]</code>
     internally.
      <p>
       This will give the number of items returned by the
       the <a href="#Permutations"><code><i>array</i>.permute[]</code></a>
       method when <code>m</code> and <code>n</code> are both the length of
       the array.

    </p></td></tr><tr><td><code>eulerPhi[<i>n</i>]</code></td><td>Returns Euler's
     Totient (also known as the phi function or Euler's Phi) of the given
     integer.  This is the number of positive integers less than n that share
      no factors with n.

    </td></tr><tr><td><code>factorial[<i>n</i>]</code></td><td>Returns the
      factorial of the specified non-negative integer.  This is the same as
      the factorial operator <code>!</code>.
      
      <p>
       <i>Reminder:</i> the factorial
       of a non-negative integer <code>n</code> is the product of all the
       numbers from 1 to <code>n</code>.  For example, the factorial
       <code>6!</code> is equal to <code>1 * 2 * 3 * 4 * 5 * 6</code> , or
       <code>720</code>
      </p>

    </td></tr><tr><td><code>factorialRatio[<i>m</i>,
       <i>n</i>]</code></td><td>Efficiently calculates the ratio of two
      factorials <code>m! / n!</code>, using a <a href="https://frinklang.org/fsp/colorize.fsp?f=BinarySplittingFactorial.frink">binary
       splitting algorithm</a>.  This is used internally in functions like
      <code>binomial[<i>m</i>, <i>n</i>]</code>.  Using this function is
      <em>much</em> faster than calculating the result naïvely.
  </td></tr></tbody></table>

  <p>
   Other number-theoretical functions, such as those for calculating the
   values of the <a href="https://frinklang.org/fsp/colorize.fsp?f=RiemannZeta.frink">Riemann Zeta</a>
   function may be available in the <a href="https://frinklang.org/fsp/samples.fsp">Sample&nbsp;Programs</a> library.
  </p>

  
  <h3><a name="OtherFunctions">Other Functions</a></h3>
  <table summary="Other Functions">
   <tbody><tr><th>Function</th><th>Definition
    </th></tr><tr><td>array[x]<br>toArray[x]</td><td>Turns the specified
      expression into an array. This works with <a href="#EnumeratingExpressions">enumerating expressions</a>, <a href="#Sets">sets</a>,
      dictionaries, objects created from a <code>class</code>, or simple
      expressions (making a single-item array out of the latter.) 
    </td></tr><tr><td>flatten[array]</td><td>Flattens a possibly
      multi-dimensional array into a 1-dimensional array.  For example,
      flattening the array <code>[1,[2,[3,4]],5]</code> results in <code>[1,2,3,4,5]</code>.
    </td></tr><tr><td>toString[x]</td><td>Turns the specified expression into a
      string.  The string representation is exactly the same as it would be
      from printing the expression or <a href="#StringInterpolation">interpolating it into a string.</a>
    </td></tr><tr><td>deepCopy[x]</td><td>Perform a recursive
      deep copy of all the parts of a container class.  The function can be
      called with any expression type.  The function currently deep copies
      everything contained in arrays, dictionaries, <a href="#Sets">sets</a>, <a href="#OrderedList">OrderedList</a>s,
      RingBuffers, and objects created from a <code>class</code>
      specification, and everything contained within them.  It is thus useful
      for copying nested data structures, multi-dimensional arrays (which are
      arrays of arrays, etc.) and prevents modification of the original or the
      copy from changing the other.  It does <em>not</em> currently deep copy
      Java objects, nor Java arrays.
    </td></tr><tr><td>inv[x]</td><td>Reciprocal 1/x
    </td></tr><tr><td>recip[x]</td><td>Reciprocal 1/x
    </td></tr><tr><td>sqrt[x]</td><td>Square root
    </td></tr><tr><td>sqrt[x, digits]</td><td>Arbitrary-precision square root to
      the specified number of digits.  This can take arbitrarily-large and
      small arguments.  This function only works with real-valued inputs.
    </td></tr><tr><td>sqrtExact[x, digits]</td><td>Arbitrary-precision square
      root to the specified number of digits.  This can take arbitrarily-large
      and small arguments.  If the input is an integer, this attempts to
      return an exact integer result when possible.  This function only works
      with real-valued inputs. 
    </td></tr><tr><td>sqrtNearestInteger[x]</td><td>This is a fast function
      (faster than taking the square root) that takes a non-negative integer
      and returns the largest integer less than or equal to the square root of
      x.
    </td></tr><tr><td>log[x]</td><td>Common logarithm, base 10.  This returns
      exact integers or rational numbers in cases when arguments are integers
      and results are integers or 1 divided by an integer.
    </td></tr><tr><td>ln[x]</td><td>Natural logarithm, base <i>e</i>
    </td></tr><tr><td>log[x, b]</td><td>Logarithm of the number <code>x</code> to
     the base <code>b</code>, which could also be written <code>ln[x] /
     ln[b]</code> (which works for any base as long as the logarithms are
     taken to the same base) but this version returns exact integers or
     exact rational numbers when arguments are integers when the result is an
     integer or 1 divided by an integer.
    </td></tr><tr><td>approxLog2[x]</td><td>This is a fast algorithm to return a
      value in the vicinity of the logarithm of <code>x</code> to base 2.
      This works efficiently for arbitrary-sized values and is only intended
      to give an approximate "first guess" to numerical algorithms that
      calculate to arbitrary precision.  If you want the <em>actual</em>
      logarithm to base 2, use <code>log[x,2]</code>.
    </td></tr><tr><td>digitLength[x]</td><td>Returns the number of decimal digits
      in a number.  This is intended to support algorithms that calculate to
      arbitrary precision.
    </td></tr><tr><td>exp[x]</td><td><i>e<sup>x</sup></i>
    </td></tr><tr><td>Re[x]</td><td>The real part of x.  Note that the result
      will have the same dimensions as the argument.
    </td></tr><tr><td>Im[x]</td><td>The imaginary part of x as a real number.
      Note that the result will have the same dimensions as the argument.
    </td></tr><tr><td>conjugate[x]</td><td>Returns the complex conjugate of the
      specified number.  Note that the result will have the same dimensions as
      the argument.
    </td></tr><tr><td>sinh[x]</td><td>Hyperbolic sine of x, or
      (e<sup>x</sup> - e<sup>-x</sup>)/2
    </td></tr><tr><td>csch[x]</td><td>Hyperbolic cosecant of x, or 1/sinh[x], or
      2/(e<sup>x</sup> - e<sup>-x</sup>)
    </td></tr><tr><td>cosh[x]</td><td>Hyperbolic cosine of x, or 1/sech[x], or
      (e<sup>x</sup> + e<sup>-x</sup>)/2
    </td></tr><tr><td>sech[x]</td><td>Hyperbolic secant of x, or 1/cosh[x], or
      2/(e<sup>x</sup> + e<sup>-x</sup>)
    </td></tr><tr><td>tanh[x]</td><td>Hyperbolic tangent of x, or
      <code>sinh[x]/cosh[x]</code>
    </td></tr><tr><td>coth[x]</td><td>Hyperbolic cotangent of x, or (e<sup>2z</sup> + 1) / (e<sup>2z</sup> - 1)
    </td></tr><tr><td>arcsinh[x], asinh[x]</td><td>Inverse hyperbolic sine of x,
      or ln[x + sqrt[1 + x^2]]
    </td></tr><tr><td>arccosh[x], acosh[x]</td><td>Inverse hyperbolic cosine of x,
      or ln[x + sqrt[x-1] sqrt[x+1]]
    </td></tr><tr><td>arcsech[x], asech[x]</td><td>Inverse hyperbolic secant of x,
      or ln[sqrt[1/x - 1]*sqrt[1 + 1/x] + 1/x]
    </td></tr><tr><td>arccsch[x], acsch[x]</td><td>Inverse hyperbolic cosecant of
      x, or ln[sqrt[1 + 1/x^2] + 1/x]
    </td></tr><tr><td>arctanh[x], atanh[x]</td><td>Inverse hyperbolic tangent of
      x, or 1/2 (ln[1+x] - ln[1-x])
    </td></tr><tr><td>arccoth[x], acoth[x]</td><td>Inverse hyperbolic cotangent of
      x, or 1/2 ( ln[1 + 1/x] - ln[1 - 1/x] )
    </td></tr><tr><td>abs[x]</td><td>Absolute value.  For complex arguments,
      returns complex number <code>abs[x + iy] = sqrt[x^2 + y^2]</code>.  For
      interval arguments, returns an interval (which may contain zero if the
      interval contains zero.) Note that the result will also have the same
      dimensions as the argument!
    </td></tr><tr><td>signum[x]</td><td>Returns the sign of the argument.  For
      real-valued arguments, this returns (-1 if x&lt;0), (0 if x==0), (1 if
      x&gt;0).
      For complex arguments, returns <code>x/abs[x]</code>.  For intervals,
      returns an interval containing the signum of each endpoint (which may be
      collapsed to a single value if both endpoints have the same sign.)  Note
      that the result will also have the same dimensions as the argument!
      
    </td></tr><tr><td>realSignum[x]</td><td>This is a more limited function that
      returns the sign of a real number, ignoring units of measure if they are
      present.  For
      real-valued arguments, this returns (-1 if x&lt;0), (0 if x==0), (1 if
      x&gt;0).
      For all other arguments, this returns <code>undef</code>.
      
    </td></tr><tr><td>random[x]</td><td>Pick a random integer between 0
      (inclusive) and <code>x</code> (exclusive.)  If <code>x</code> is an
      array, this returns a random item from the array.
    </td></tr><tr><td>random[min, max]</td><td>Pick a random integer between min
      (inclusive) and max (inclusive.)

      <p><b>Note:</b> To pick items from a discrete probability distribution,
       see the <a href="https://frinklang.org/fsp/colorize.fsp?f=DiscreteDistribution.frink">DiscreteDistribution.frink</a>
       sample program.
       
    </p></td></tr><tr><td>randomFloat[<i>lower</i>, <i>upper</i>]</td><td>Pick a 
      uniformly-distributed random floating-point value in the specifed range.
    </td></tr><tr><td>randomGaussian[<i>mean</i>, <i>sd</i>]</td><td>Pick a 
      normally-distributed (i.e. "bell curve") random floating-point value
      with the specified mean and standard deviation.
    </td></tr><tr><td>randomBits[<i>numBits</i>]</td><td>Generate a random
      positive integer containing <i>numBits</i> evenly-distributed binary
      bits.
    </td></tr><tr><td>randomBytes[<i>numBytes</i>]</td><td>Generate an array of
      random bytes containing <i>numBytes</i> elements as a Java array of byte.
    </td></tr><tr><td>randomSeed[<i>seed</i>]</td><td>To obtain repeatable
      results with a program that generates random numbers, sometimes it is
      desirable to use the same random sequence.  This function seeds the
      random number generator with a known value.  The seed must a number from
      -2<sup>63</sup> to 2<sup>63</sup>-1 (both inclusive.)
    </td></tr><tr><td>bitLength[<i>int</i>]</td><td>Returns the number of bits in
      the minimal two's-complement representation of an integer,
      <em>excluding</em> a sign bit.
    </td></tr><tr><td>modPow[<i>base</i>,<i>exponent</i>,
      <i>modulus</i>]</td><td>Perform the integer modular exponentiation
      (<i>base<sup>exponent</sup>&nbsp;</i>mod&nbsp;<i>modulus</i>) in an
      efficient manner.
    </td></tr><tr><td>modDiv[<i>n</i>,<i>m</i>,<i>modulus</i>]</td><td>Performs
      the integer modular division 
      <i>n/m&nbsp;</i>mod&nbsp;<i>modulus</i> and returns the integer result
      if one exists, otherwise returns <code>undef</code>.
    </td></tr><tr><td>modInverse[<i>n</i>,<i>modulus</i>]
     </td><td>Finds the integer modular inverse of <i>n</i> to the base
      <i>modulus</i> and returns the integer result
      if it is invertible, otherwise returns <code>undef</code>.  In other
      words, <code>modInverse[<i>n</i>,<i>m</i>]</code> returns an
      integer <code>x</code> such that <code>(x * n) mod m == 1</code>.
    </td></tr><tr><td>min[<i>arg1</i>,&nbsp;<i>arg2</i>]</td><td>Returns the
      smaller of the two arguments, or the first argument if they're equal.
    </td></tr><tr><td>min[<i>array</i>]</td><td>Returns the smallest item in the
      array.
    </td></tr><tr><td>max[<i>arg1</i>,&nbsp;<i>arg2</i>]</td><td>Returns the
      larger of the two arguments, or the first argument if they're equal.
    </td></tr><tr><td>max[<i>array</i>]</td><td>Returns the largest item in the
      array.
    </td></tr><tr><td>minmax[<i>array</i>]</td><td>Returns the smallest and
      largest elements in an array as a two-item
      array <code>[<i>min</i>, <i>max</i>]</code>.
    </td></tr><tr><td>clamp[<i>num</i>, <i>min</i>, <i>max</i>]</td><td>Returns
      the specified number, but limiting its value to lie between the
      specified minimum and maximum.  This also works correctly
      when <i>num</i> is an interval.
    </td></tr><tr><td>intersection[<i>arg1</i>,&nbsp;<i>arg2</i>]</td><td>Returns
      the intersection of two intervals, or an interval and a real number.
      (Or two real numbers, but that rarely makes sense.)  The return type
      in this case will be an interval or an ordinary real number.  If there is
      no intersection between the arguments, the function will currently return
      <code>undef</code> although this behavior may change to return an empty
      interval in the future.  This function also works with dates and date
      intervals.
    </td></tr><tr><td>union[<i>arg1</i>,&nbsp;<i>arg2</i>]</td><td>Returns
      the union of two intervals, or an interval and a real number.
      (Or two real numbers, in which case an interval containing both real
      numbers is returned.)  The return type will be an interval or an
      ordinary real number if the two numbers are the same real number.  This
      function also works with dates and date intervals.
    </td></tr><tr><td>isInteger[<i>expr</i>]</td><td>Returns true if the argument
      is a dimensionless integer, false otherwise.
    </td></tr><tr><td>isRational[<i>expr</i>]</td><td>Returns true if the argument
      is a dimensionless rational number (and <em>not</em> an integer,) false
      otherwise.
    </td></tr><tr><td>isReal[<i>expr</i>]</td><td>Returns true if the argument is
      a real number (with or without dimensions, and not an interval,) false
      otherwise.
    </td></tr><tr><td>isComplex[<i>expr</i>]</td><td>Returns true if the argument
      is a complex number (with or without dimensions,) false otherwise.
    </td></tr><tr><td>isInterval[<i>expr</i>]</td><td>Returns true if the argument
      is an interval (with or without dimensions,) false otherwise.
    </td></tr><tr><td>isNegative[<i>expr</i>]</td><td>Returns true if the argument
      is a dimensionless negative number, false otherwise.
    </td></tr><tr><td>isPositive[<i>expr</i>]</td><td>Returns true if the argument
      is a dimensionless positive number, false otherwise.
    </td></tr><tr><td>isUnit[<i>expr</i>]</td><td>Returns true if the number is
      a unit of any type, including dimensionless numbers.
    </td></tr><tr><td>isNegativeUnit[<i>expr</i>]</td><td>Returns true if the
      argument is a unit of any type (including dimensionless numbers) with a
      negative sign, false otherwise.
    </td></tr><tr><td>isArray[<i>expr</i>]</td><td>Returns true if the expression
      is an array, false otherwise.
    </td></tr><tr><td>isDict[<i>expr</i>]</td><td>Returns true if the
      expression is a dictionary, false otherwise.
    </td></tr><tr><td>isSet[<i>expr</i>]</td><td>Returns true if the expression
      is a set, false otherwise.
    </td></tr><tr><td>isDate[<i>expr</i>]</td><td>Returns true if the expression
      is a date/time, false otherwise.
    </td></tr><tr><td>isString[<i>expr</i>]</td><td>Returns true if the expression
      is a string, false otherwise.
    </td></tr><tr><td>isEnumerating[<i>expr</i>]</td><td>Returns true if the
      expression is an <a href="#EnumeratingExpressions">enumerating
      expression</a>, (which includes many types, including arrays, dicts, and
      <a href="#Sets">sets</a>.)
    </td></tr><tr><td>isOperator[<i>expr</i>]</td><td>Returns true if the
      expression is an operator like <code>+</code> or <code>*</code>, false
      otherwise.
    </td></tr><tr><td>getOperatorPrecedence[<i>expr</i>]</td><td>If the
      expression is an operator like <code>+</code> or <code>*</code>, this
      returns the precedence of the operator as an integer.  Higher numbers
      indicate higher precedence.  If the expression is not an operator, this
      returns <code>undef</code>.
    </td></tr><tr><td>getOperatorSymbol[<i>expr</i>]</td><td>If the expression is
      an operator like <code>"+"</code> or <code>"*"</code>, this returns the
      symbol of the operator as an string.  If the expression is not an
      operator, this returns <code>undef</code>.
    </td></tr><tr><td><code>sum[<i>x</i>]</code></td><td>Returns the sum of the
      elements of <code>x</code>, which can currently be an array or an
      <a href="#EnumeratingExpressions">enumerating expression</a>.  If <code>x</code> is of any other type, this
      simply returns <code>x</code>.  If the list is empty, this returns
      <code>undef</code>.  (There is no universal identity element for
      addition when units of measure may be present.)
    </td></tr><tr><td><code>sum[<i>x</i>, <i>emptyValue</i>]</code>
     </td><td>Returns the sum of the 
      elements of <code>x</code>, which can currently be an array or an
      <a href="#EnumeratingExpressions">enumerating expression</a>.  If <code>x</code> is of any other type, this
      simply returns <code>x</code>.  If the list is empty, this returns
      <code>emptyValue</code>.
    </td></tr><tr><td><code>product[<i>x</i>]</code></td><td>Returns the product
      of the elements of <code>x</code>, which can currently be an array or an
      <a href="#EnumeratingExpressions">enumerating expression</a>.  If <code>x</code> is of any other type, this
      simply returns <code>x</code>.  If the list is empty, returns 1.
    </td></tr><tr><td><code>product[<i>x</i>, <i>emptyValue</i>]</code>
     </td><td>Returns the product
      of the elements of <code>x</code>, which can currently be an array or an
      <a href="#EnumeratingExpressions">enumerating expression</a>.  If <code>x</code> is of any other type, this
      simply returns <code>x</code>.  If the list is empty, returns
      <code>emptyValue</code>.
    </td></tr><tr><td><code>hypotenuse[<i>x</i>]</code>
       </td><td>Returns the hypotenuse (also called the Euclidean norm) of the
        elements of array x.  The result is normally a scalar value but can
        return a symbolic expression.
    </td></tr><tr><td><code>mean[<i>x</i>]</code>
     </td><td>Returns the mean (average) value of the elements of <code>x</code>, which can currently be an array or an
      <a href="#EnumeratingExpressions">enumerating expression</a>.  This
      function preserves units of measure and can be used symbolically.  It
      uses Welford's algorithm for numerical stability.
    </td></tr><tr><td><code>meanAndSD[<i>x</i>, <i>sample</i>]</code>
     </td><td>Calculates the mean and standard deviation of the elements of the
     list <code>x</code>, which can currently be an array or an
      <a href="#EnumeratingExpressions">enumerating
      expression</a>.  <code>sample</code> is a boolean flag indicating if we
      want the standard deviation to be the <em>sample</em> standard deviation
      (<code>true</code>) or the <em>population</em> standard deviation
      (<code>false</code>).  If you are in doubt, it's probably safer and more
      conservative to set this to <code>true</code> (for sample standard
      deviation) giving a larger standard deviation.  This function preserves
      units of measure and can be used symbolically.  It uses Welford's
      algorithm for numerical stability.
      <p>
      Returns an array <code>[<i>mean</i>, <i>sd</i>, <i>number</i>]</code>
      where <code>mean</code> is the mean (average) value, <code>sd</code> is
      the standard deviation, and <code>number</code> is the count
      of items in the list.
      </p>
    </td></tr><tr><td><code>modes[<i>x</i>]</code>
     </td><td>Calculates the mode(s) of a list <code>x</code>, which can currently
       be an array or an <a href="#EnumeratingExpressions">enumerating
       expression</a>.  The modes are the value(s) that occur the most times.
       Each element of the list must be a hashing expression, that is, can be
       used as a key in a dictionary.

      <p>
       This always returns an array because there are potentially multiple
       modes in a list.  This uses the more general
       <code>mostCommon[<i>list</i>]</code> function to do the work.  The
       modes are not returned in any specific order (because they might
       actually be non-comparable to each other.)
   </p></td></tr><tr><td>sleep[<i>time</i>]</td><td>Sleeps for the specified amount
    of time.  The argument <code><i>time</i></code> must have units of time,
    such as <code>1 s</code> or <code>4.9 minutes</code>
      or <code>1/30 s</code>.
    </td></tr><tr><td>binaryToGray[<i>num</i>]</td><td>Converts the specified
      number into its corresponding value in binary reflected Gray code.
      Example usage:  <code>binaryToGray[0b1111] -&gt; binary</code>
    </td></tr><tr><td>grayToBinary[<i>num</i>]</td><td>Converts a number from its
      value in binary reflected Gray code to its equivalent numeric value.
    </td></tr><tr><td>browse[<i>url</i>]</td><td>Launches the specified URL in
      the browser (or however your computer is set up to launch URLs.)  This
      requires that your Java Virtual Machine and your operating system are
      configured correctly.
    </td></tr><tr><td>integerDigits[<i>num</i>]</td><td>Returns an array of the
      digits of the non-negative integer <code>num</code> in base 10.
    </td></tr><tr><td>integerDigits[<i>num</i>, <i>base</i>]</td><td>Returns an
      array of the digits of the non-negative integer <code>num</code> in the
      specified base.
    </td></tr><tr><td>getExponent[<i>unit</i>,
      <i>baseUnit</i>]</td><td>Returns the exponent for the specified base
      unit.  The base unit can be specified as a string indicating the name of
      a base unit (e.g. <code>"m"</code> for meters), a unit of measure,
      e.g. (<code>m</code>), or a string indicating the name of a base
      dimension (e.g. <code>"length"</code> or <code>"mass"</code> or
      <code>"time"</code>.  See the <a href="#HowFrinkIsDifferent">default
       base dimension names.</a>)

      <p>
       For example, to get the exponent corresponding to length (default unit
       is meters) all of the following are equivalent:
      </p>

      <p>
       <code>
        getExponent[3 m/s^2, "length"]<br>
        getExponent[3 m/s^2, "m"]<br>
        getExponent[3 m/s^2, "meters"]<br>
        getExponent[3 m/s^2, "feet"]<br>
        getExponent[3 m/s^2, m]<br>
        getExponent[3 m/s^2, 123.4 m]<br>
        getExponent[3 m/s^2, 3 feet]<br>
       </code>
      </p>

      <p>
       All of the above return the integer <code>1</code>, which is the
       exponent for 
       length in the provided expression.  Asking for <code>"time"</code> or
       <code>"s"</code> or <code>s</code> would return <code>-2</code>, the
       exponent for the time dimension.  Also note that exponents may be
       rational numbers or zero.
      </p>

      <p>
       <b>Warning:</b> You will very likely never need this function.  If
       you're using it, you may be doing something sketchy and unwise and
       physically unrealistic, or attempting to subvert unit-checking, or
       missing better input/output routines.  Stop and reconsider your life
       choices.
      </p>
      
    </td></tr><tr><td>dimensionsToArray[<i>unit</i>]</td><td>Returns an array
      of <code>[string, num]</code> pairs which indicate the exponents of the
      base dimensions of a unit of measure.  For example, for the joule:

      <p>
       <code>dimensionsToArray[joule]</code><br>
       <code>[[m, 2], [s, -2], [kg, 1]]</code>
      </p>

      <p>
       If the input is dimensionless, this returns an empty array.  If the
       input is not a unit of measure, this returns <code>undef</code>.
      </p>

      <p>
       <b>Warning:</b> You will very likely never need this function.  If
       you're using it, you may be doing something sketchy and unwise and
       physically unrealistic, or attempting to subvert unit-checking.  Please
       reconsider.  You may need it if you are creating your own output
       formats
       like <a href="https://frinklang.org/fsp/colorize.fsp?f=MathML.frink">MathML.frink</a>, and
       using it with the <code>getScale[<i>unit</i>]</code> function below.
      </p></td></tr><tr><td>getScale[<i>unit</i>]</td><td>Returns a dimensionless
      number indicating the scale of a unit of measure as a multiple of the
      base units.  For example, for the kilometer, whose base unit is the
      meter:
      
      <p>
       <code>getScale[km]</code><br>
       <code>1000</code>
      </p>

      <p>
       If the expression is not a unit, this returns <code>undef</code>.
      </p>

      <p>
       <b>Warning:</b> You will very likely never need this function.  If
       you're using it, you may be doing something sketchy and unwise and
       physically unrealistic, or attempting to subvert unit-checking.  Please
       reconsider.  You may need it if you are creating your own output
       formats
       like <a href="https://frinklang.org/fsp/colorize.fsp?f=MathML.frink">MathML.frink</a>, and
       using it with the <code>dimensionsToArray[<i>unit</i>]</code> function
       above.
      </p></td></tr><tr><td>factorUnits[<i>unit</i>]</td><td>Factors a unit into a array
      of [<code>scale</code>, <code>dimensions</code>]
      where <code>scale</code> is a dimensionless number indicating a scale
      and <code>dimensions</code> is a unit with scale of 1 and the basic
      dimensions of the original unit.  For example, for the speed of light:
         
      <p>
       <code>factorUnits[c]</code><br>
       <code>[299792458, 1 m s^-1 (velocity)]</code>
      </p>

      <p>
       The resulting values can be multiplied with each other to obtain the
       original value.
      </p>
      
      <p>
       <b>Warning:</b> You will very likely never need this function.  If
       you're using it, you may be doing something sketchy and unwise and
       physically unrealistic, or attempting to subvert unit-checking.  Please
       reconsider.
      </p></td></tr><tr><td>baseUnitNames[]</td><td>Returns an array
      of names of the base units in a known order.  For example, this normally
      returns <code>[m, s, kg, A, K, dollar, mol, bit, cd]</code>.
      
    </td></tr><tr><td>baseDimensionNames[]</td><td>Returns an array of names of
      the basic dimensions in a known order.  For example, this normally
      returns <code>[length, time, mass, current, temperature, currency,
      amount_of_substance, information, luminous_intensity]</code>.
       
    </td></tr><tr><td>numerator[<i>x</i>, <i>splitRationals=true</i>, <i>splitDimensions=true</i>]</td><td>Returns the numerator of an
      expression.  This works on rational numbers, integers, units, and
      arbitrary symbolic expressions.  This collects multiplicative terms that
      are not obviously divisions or negative powers.  See the more
      efficient <code>numeratorDenominator[<i>x</i>]</code> below for usage
      and examples.
    </td></tr><tr><td>denominator[<i>x</i>, <i>splitRationals=true</i>, <i>splitDimensions=true</i>]</td><td>Returns the denominator of an
      expression.  This works on rational numbers, integers, units, and
      arbitrary symbolic expressions.  This collects multiplicative terms that
      are obviously divisions or negative powers.  If the expression is not
      rational, this returns 1.  See the more
      efficient <code>numeratorDenominator[<i>x</i>]</code> below for usage
      and examples.
    </td></tr><tr><td>numeratorDenominator[<i>x</i>, <i>splitRationals=true</i>, <i>splitDimensions=true</i>]</td><td>Returns the numerator and
      denominator of an expression as a two-item
      array <code>[<i>numerator</i>, <i>denominator</i>]</code> This works on
      rational numbers, integers, units, and arbitrary symbolic expressions.
      It is better to use this function than to call <code>numerator</code>
      and <code>denominator</code> separately, as it's more efficient.

      <p>
       If <code>splitRationals</code> is <code>true</code> (the default), the
       numerator and denominators of rational numbers will be split into the
       numerator and denominator of the result.  If <code>false</code>, the
       rational numbers will be kept as rational numbers in the numerator of
       the result.
      </p>

      <p>
       If <code>splitDimensions</code> is <code>true</code> (the default),
       dimensions of units of measure with positive exponents will be split
       into the numerator and units of measure with negative exponents will be
       put into the denominator of the result.  If <code>false</code>, the
       dimensions will be kept together in the numerator of the result.
      </p>
      
      <p>
       <code>[n,d] = numeratorDenominator[noEval[1/4 G^-1 a^-1 c^4]]</code><br>
       <code>[c^4, 4 G a]<br></code>
      </p>

      <p>
       The following demonstrates the different options when
       splitting <code>1/10 c</code>:
      </p>
       
      <table summary="numeratorDenominator options">
       <tbody><tr><th>splitRationals</th><th>splitDimensions</th><th>result
       </th></tr><tr><td>true</td><td>true</td><td>[149896229 m (length), 5 s (time)]
       </td></tr><tr><td>false</td><td>true</td><td>[149896229/5 (exactly 2.99792458e+7) m (length), 1 s (time)]
       </td></tr><tr><td>true</td><td>false</td><td>[149896229 m s^-1 (velocity), 5]
       </td></tr><tr><td>false</td><td>false</td><td>[149896229/5 (exactly 2.99792458e+7) m s^-1
       (velocity), 1]
      </td></tr></tbody></table>

      <p>
       As you can see, sometimes it's more helpful to set both options
       to <code>false</code> when displaying results that are units of
       measure, and to set both to <code>true</code> when formatting symbolic
       equations.
      </p>

      <p>
       See the
       <a href="https://frinklang.org/fsp/colorize.fsp?f=formatEquation.frink">formatEquation.frink</a>
       sample program to see how <code>numeratorDenominator</code> is used
       with <a href="#FormattingTables"><code>formatTable</code></a> to
       recursively format mathematical expressions.
      </p>
       
   </td></tr><tr><td>FrinkVersion[]</td><td>Returns the current version of Frink
     as a string.
     
   </td></tr><tr><td>FrinkGeneration[]</td><td>Returns the current generation
     number of Frink as an integer.  0=Frink original,
     1=<a href="https://frinklang.org/experimental.html">Frink:The Next Generation</a>

     <p>
      Programs can use this flag to warn that, say, calculating thousands of
      digits will be slow in the original version, or even switch behavior
      (e.g. use an integer-based routine in original Frink and a floating-point
      routine in Frink:TNG, which has much faster floating-point routines for
      numbers with many digits.)
     </p>

     <p>
      To support old versions of Frink before this function exists, you should
      probably wrap it in a call to <code>eval</code>:
     </p>

     <p>
      <code>if eval["FrinkGeneration[]"] != 1<br>
       &nbsp;&nbsp;&nbsp;println["""Note: this program will be orders of magnitude faster with Frink:The Next Generation, available at: https://frinklang.org/experimental.html"""]
      </code>
     </p>
  </td></tr></tbody></table>

  <h2><a name="FourierTransforms">Fourier Transforms</a></h2>
  <p>
   Frink can perform Fourier transforms on 1- or 2- dimensional arrays, or on
   images (by calling their <code>toComplexArray[]</code> method.  See the <a href="https://frinklang.org/fsp/colorize.fsp?f=FourierImage.frink">FourierImage.frink</a>
   sample progam for a demonstration.)  The functions are:
  </p>

  <table summary="Fourier Transform Functions">
    <tbody><tr><th>Function</th><th>Description
     </th></tr><tr><td><code>DFT[<i>array, divFactor=-1,
     direction=1</i>]</code><p><code>inverseDFT[<i>array, divFactor=-1,
     direction=1</i>]</code></p></td><td>Performs a Discrete Fourier Transform of the
     given array.  The array may be 1- or 2-dimensional.
      
      <p>Since different fields of mathematics and engineering use
       different conventions for the Fourier transform, these
       functions allow you to (optionally) specify the scaling factor and
        sign convention.
      </p><p>
      The (optional) second argument divFactor sets the scaling factor for
      the results:
      
      </p><table summary="DFT divFactor Options">
       <tbody><tr><th>divFactor</th><th>DFT</th><th>inverseDFT

       </th></tr><tr><td>divFactor = -1 <i>(default)</i></td><td>1/n</td><td>1
       </td></tr><tr><td>divFactor = 0</td><td>1/sqrt[n]</td><td>1/sqrt[n]
       </td></tr><tr><td>divFactor =  1</td><td>1</td><td>1/n
      </td></tr></tbody></table>
      
      <p>
      The (optional) third argument direction sets the sign used in the
      exponent.
      
      </p><table summary="DFT direction Options">
      <tbody><tr><th>direction</th><th>DFT</th><th>inverseDFT
      </th></tr><tr><td>direction =  1 <i>(default)</i></td><td>e<sup>2 pi i j k / n</sup></td><td>e<sup>-2 pi i j k / n</sup>
      </td></tr><tr><td>direction = -1</td><td>e<sup>-2 pi i j k / n</sup></td><td>e<sup>2 pi i j k / n</sup>
      </td></tr></tbody></table>

      <p>
       The <code>inverseDFT</code> function produces the inverse of the DFT
       given by the DFT function.  In fact, it just calls the DFT function
       with appropriately-reversed parameters.
      </p>
      
      <p>
        If you specified the optional second or third arguments for the DFT
        function, you will need to pass in the <em>same</em> arguments to the
        <code>inverseDFT</code> function to get the inverse operation.  This
        function takes care of reversing them appropriately.
      </p>
     </td></tr><tr><td><code>FFT[<i>array, divFactor=-1,
      direction=1</i>]</code><p><code>inverseFFT[<i>array, divFactor=-1,
      direction=1</i>]</code></p></td><td>Performs a Fast Fourier Transform of the
      given array.  The array may be 1- or 2-dimensional.  The meaning of all
      the arguments are the same as for the <code>DFT</code>
      and <code>inverseDFT</code> functions above.

         <p>
          While this function is much faster than <code>DFT</code>, be warned
          that <em>this will pad the array with zeroes to the next largest
          power of 2.</em>  It will thus give a result that is different than
          DFT, often with more terms.
         </p>

         <p>
          FFT is O(n log n) while DFT is O(n<sup>2</sup>).
         </p>
    </td></tr></tbody></table>

  <h2><a name="CryptographicFunctions">Cryptographic Functions</a></h2>
  <p>
   The <code>messageDigest[...]</code> functions can calculate a variety of
   cryptographic hashes of various strings or arrays of bytes.  The parameters
   for all are of the form:
  </p><p>
   <code>messageDigest[<i>input</i>,<i>algorithm</i>]</code>
  </p>

  <p>
   Each function can take as input either a string or an array of Java bytes.
   The <code>algorithm</code> parameter is a string containing one of any
   hashing algorithms your Java platform supports, which probably includes:
   <code>"MD2", "MD5", "SHA", "SHA-256", "SHA-384", "SHA-512"</code>.  You
   can see the <a href="https://frinklang.org/fsp/colorize.fsp?f=cryptoProviders.frink">cryptoProviders.frink</a>
   sample program to see how to dump all message digest types available on
   your virtual machine.
  </p>

  <p>
   <b>Note:</b> As of the 2016-09-29 release, the behavior of the
   <code>messageDigest</code> functions may have changed.  Previously, to turn
   the characters of a Unicode string into bytes, the function used your
   platform's default character encoding.  Now the functions always convert
   the bytes to UTF-8 before creating the digest.  (Your default was likely to
   have been UTF-8 already.)  Using the default encoding made programs
   non-repeatable from one machine to another.  If you want to force a certain
   encoding of Unicode strings into bytes, use the <a href="#OtherStringFunctions"> <code>stringToBytes[<i>string</i>,
   <i>encoding</i>]</code></a> function before calling these functions.
  </p>

  <p>
   The following calculates the MD5 hash of the string <code>"abc"</code> and
   returns it as a hexadecimal string:
  </p>

  <p>
   <code>messageDigest["abc", "MD5"]</code><br>
   <code>900150983cd24fb0d6963f7d28e17f72</code>
  </p>

  <p>
   The <code>messageDigestInt</code> function returns the value as an integer,
   which can then be displayed in various bases, have its individual bits
   tested, etc.
  </p>

  <p>
   <code>messageDigestInt["abc","MD5"] -&gt; octal</code><br>
   <code>2200025023017151117541532261767645070277562</code>
  </p>

  <p>
   The <code>messageDigestBytes</code> function returns the value as an
   array of Java bytes.  <b>Note:</b> Most of the underlying cryptography
   routines in Java work with arrays of bytes, as these are safer than Strings
   which are immutable after construction and are eventually
   garbage-collected.  Using arrays of bytes means that you can zero-out input
   buffers as soon as you're done with them.
  </p>

  <p>
   <code>messageDigestBytes["abc", "SHA-1"]</code><br>
  </p>
  
  <h2><a name="AllYourBaseConversions">All Your Base Conversions...</a></h2>
  <p>
   Integer values can be converted to and from other bases (from 2 to 36
   inclusive) in several ways.  The following functions can be used to convert
   to or from other arbitrary bases.
  </p>
  
  <table summary="General Base Conversion Functions">
    <tbody><tr><th>Function</th><th>Description
    </th></tr><tr><td>base[x, b]</td><td>Returns a string representing the
      integer <code>x</code> in base <code>b</code>
    </td></tr><tr><td>base2[x] ... base36[x]</td><td>Returns a string
      representing the integer <code>x</code> in the specified base.
    </td></tr><tr><td>base64[x]</td><td>Converts between integer and base-64
      encoded strings.  If passed an integer, returns a string
      representing the integer as a base 64-encoded value.
      This uses standard base-64 indices in the order A-Za-z0-9+/.  If passed
      a base-64 encoded string, this returns an integer with the corresponding
      value.
    </td></tr><tr><td>parseInt[<i>str</i>]</td><td>Parses a string
      (or <a href="#EnumeratingExpressions">enumerating expression</a> of
      strings,) containing digits 0-9 only, to an integer in base 10.  This
      should contain no spaces or other text.
    </td></tr><tr><td>parseInt[<i>str</i>,&nbsp;<i>base</i>]</td><td>Parses a
      string (or <a href="#EnumeratingExpressions">enumerating expression</a> of
      strings,), treating it as if it's a number in the specified base.  The
      string should contain no spaces or other text.  The base can from 2-36
      (inclusive) or 64, in which case it will use standard base64 encoding.
  </td></tr></tbody></table>

  <p>
   The following named base conversion functions can also be used.  In the
   cases where several names are commonly used, all options are listed.  All
   functions return strings.
  </p>
  
  <table summary="Named Base Conversion Functions">
    <tbody><tr><th>Base</th><th>Function Name(s)
    </th></tr><tr><td>2</td><td>binary
    </td></tr><tr><td>3</td><td>ternary, trinary
    </td></tr><tr><td>4</td><td>quaternary
    </td></tr><tr><td>5</td><td>quinary
    </td></tr><tr><td>6</td><td>senary, sexenary
    </td></tr><tr><td>7</td><td>septenary
    </td></tr><tr><td>8</td><td>octal, oct, octonary
    </td></tr><tr><td>9</td><td>nonary
    </td></tr><tr><td>10</td><td>decimal, denary
    </td></tr><tr><td>11</td><td>undenary
    </td></tr><tr><td>12</td><td>duodecimal, duodenary
    </td></tr><tr><td>13</td><td>tridecimal
    </td></tr><tr><td>14</td><td>quattuordecimal
    </td></tr><tr><td>15</td><td>quindecimal
    </td></tr><tr><td>16</td><td>hexadecimal, sexadecimal, hex
    </td></tr><tr><td>17</td><td>septendecimal
    </td></tr><tr><td>18</td><td>octodecimal
    </td></tr><tr><td>19</td><td>nonadecimal
    </td></tr><tr><td>20</td><td>vigesimal
  </td></tr></tbody></table>

  <p>
   The conversions can be performed by calling the named function, or by using
   the conversion operator ( <code>-&gt;</code> ).  The following are all
   equivalent, and all convert the number specified by the variable
   <code>number</code> to a string in base 8.
  </p>

  <p>
   <code>
    base[number, 8]<br>
    base8[number]<br>
    number -&gt; base8<br>
    octal[number]<br>
    number -&gt; octal<br>
    oct[number]<br>
    number -&gt; oct<br>
   </code>
  </p>

  <p>
   Use whichever is most convenient for you.  (Note: the function version will
   be slighly faster.)
  </p>

  <p>
   As noted above in the <a href="#DataLibraries">Data Libraries</a> section,
   you may <em>input</em> numbers in a specified base by following the number
   with two backslashes and the specified base:
  </p>

  <ul>
   <li><code>100001000101111111101101\\2</code> (a number in
    base 2)
   </li><li><code>1000_0100_0101_1111_1110_1101\\2</code> (a number in base 2 with
    underscores for readability)
   </li><li><code>845FED\\16</code>  (a number in base 16... bases
    from 2 to 36 are allowed) 
   </li><li><code>845fed\\16</code>  (The same number in base
    16... upper or lowercase are allowed.)
   </li><li><code>845_fed\\16</code>  (a number in base 16 with underscores for readability)
   </li><li><code>0x845fed</code>  (Common hexadecimal notation)
   </li><li><code>0x845FED</code>  (Common hexadecimal notation)
   </li><li><code>0xFEED_FACE</code>  (Hexadecimal with underscores for readability)
   </li><li><code>0b100001000101111111101101</code>  (Common binary notation)
   </li><li><code>0b1000_0100_0101_1111_1110_1101</code> (Binary with underscores for readability)
  </li></ul>

  <h3><a name="CustomBaseConversions">Custom Base Conversions</a></h3>
  <p>
   The above base conversions assume that the characters are taken from an
   alphabet like the one for base 36:
   <code>"0123456789abcdefghijklmnopqrstuvwxyz"</code>, which is common and
   reasonable.  For example, hexadecimal uses the first 16 characters of
   this, <code>"0123456789abcdef"</code>.  However, it's not as clear when you
   go beyond base 36 what characters should be used.  You can declare a custom
   "alphabet" of any size to be used in base conversions.
  </p>

  <p>
   For example, Bitcoin addresses use a base-58 alphabet consisting of the
   characters:
  </p>

  <p>
   <code>"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"</code>
  </p>

  <p>
   Note that this alphabet does not include <code>0</code> (zero),
   <code>O</code> (uppercase o), <code>I</code> (uppercase i), <code>l</code>
   (lowercase L), as those are indistinguishable in some fonts.
  </p>

  <p>
   To convert a number to a string using this alphabet, you can use the
   <code>base[<i>num</i>, <i>alphabet</i>]</code> function where
   <code>alphabet</code> is a string which contains the character for the
   "zero" position first.  The radix will be equal to the number of characters
   in the alphabet string.  (In the below example, base 58.)  The following
   turns a numeric value into a Bitcoin address string:
  </p>

  <p>
   <code>alphabet&nbsp;=&nbsp;"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"<br>
    number = 0x00010966776006953D5567439E5E39F86A0D273BEED61967F6<br>
    base[number, alphabet]<br>
   </code>
   <code>6UwLL9Risc3QfPqBUvKofHmBQ7wMtjvM</code>
  </p>

  <p>
   (Note that this alphabet does not have a zero as the first character (it
   has a 1,) so if you need to pad it to a certain length, you need to pad
   with the first character in the alphabet.)
  </p>

  <p>
   Conversely, you can parse an integer with a custom alphabet by using the
   <code>parseInt[<i>str</i>, <i>alphabet</i>]</code> function, which takes
   the same format for its alphabet string.  The example below parses a
   Bitcoin address.
  </p>

  <p>
   <code>alphabet&nbsp;=&nbsp;"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"<br>
    str = "6UwLL9Risc3QfPqBUvKofHmBQ7wMtjvM"<br>
    parseInt[str, alphabet]<br>
   </code>
   <code>25420294593250030202636073700053352635053786165627414518</code>
  </p>

  <p>
   (Note that the number obtained above is the decimal equivalent of the
   Bitcoin address encoded above; it could instead be formatted in hexadecimal
   or other formats.)
  </p>

  <p>
   The strings are allowed to contain any Unicode characters.  If you attempt
   to parse a string that contains characters outside your alphabet, the
   special value <code>undef</code> will be returned.
  </p>

  <h3><a name="CustomBaseConversionExamples">Custom Base Conversion
    Examples</a></h3>
  <p>
   This section demonstrates some custom base conversions.
  </p>

  <h4><a name="Devanagari">Devanagari</a></h4>
  <p>
   Devanagari digits are used in Hindi and Sanskrit, and occur in the Unicode
   standard from <code>\u0966</code> (zero) through <code>\u096f</code>
   (nine).  To output a Devanagari integer:
  </p>

  <p>
   <code>alphabet&nbsp;=&nbsp;char[0x0966 to 0x096f]<br>
    base[1234567890, alphabet]<br>
   </code>
   <code>१२३४५६७८९०</code>
  </p>

  <p>
   Conversely, a Devanagari integer can be parsed with:
  </p>

  <p>
   <code>alphabet&nbsp;=&nbsp;char[0x0966 to 0x096f]<br>
    parseInt["१२३४५६७८९०", alphabet]<br>
   </code>
   <code>1234567890</code>
  </p>

  <h4><a name="UnicodeSuperscripts">Unicode Superscripts</a></h4>
  <p>
   The Unicode standard has a non-contiguous hodgepodge collection of numerals
   that represent superscript numerals, like 10¹².  If you want
   to typeset a string of numbers as superscripts on a Unicode-aware system,
   you can do something like this:
  </p>

  <p>
   <code>supAlphabet&nbsp;=&nbsp;"\u2070\u00b9\u00b2\u00b3" + char[0x2074 to 0x2079]<br>
    "10" + base[23, supAlphabet]<br>
   </code>
   <code>10²³</code>
  </p>

  <p>
   Or, conversely, to parse a stream of these superscript numerals as a single
   number:
  </p>

  <p>
   <code>supAlphabet&nbsp;=&nbsp;"\u2070\u00b9\u00b2\u00b3" + char[0x2074 to 0x2079]<br>
    parseInt["²³", supAlphabet]<br>
   </code>
   <code>23</code>
  </p>

  <p>
   <b>Complaint:</b>: Note that almost all fonts make Unicode superscript
   numbers look different and not line up.  Does your font look uniform here?
   Mine decidedly does not.
  </p>

  <p>
   10¹²³⁴⁵⁶⁷⁸⁹⁰
  </p>
   
  <h4><a name="UnicodeSubscripts">Unicode Subscripts</a></h4>
  <p>
   Unicode numerical subscripts are more uniform and contiguous than
   superscripts, thankfully.  They occupy a contiguous range from
   <code>\u2080</code> to <code>\u2089</code>.
  </p>

  <p>
   If you want to typeset a string of numbers as subscripts on a
   Unicode-aware system, you can do something like this:
  </p>

  <p>
   <code>
    subAlphabet&nbsp;=&nbsp;char[0x2080 to 0x2089]<br>
    "1000" + base[24, subAlphabet]<br>
   </code>
   <code>1000₂₄</code>
  </p>

  <p>
   If you want to parse a string of these subscripts as a single number, you
   can do something like this:
  </p>
  
  <p>
   <code>subAlphabet&nbsp;=&nbsp;char[0x2080 to 0x2089]<br>
    parseInt["₄₂", subAlphabet]<br>
   </code>
   <code>42</code>
  </p>

  <h2><a name="UnicodeOperators">Unicode Operators</a></h2>
  <p>
   Frink can parse Unicode characters that are commonly used as mathematical
   operators.  This allows you to cut-and-paste some mathematical expressions
   without modification and handle them correctly.
  </p>

  <p>
   Unicode superscript numerals can be used to perform exponentiation, such as
   <code>10⁻²³</code>, which is equivalent to
   <code>10^-23</code>, or <code>x³</code>, which is equivalent to
   <code>x^3</code>.
  </p>

  <p><b>Note:</b> Web pages usually <em>won't</em> use Unicode superscript
   numerals, but rather <code>&lt;SUP&gt;</code> tags for superscripts which
   means that you probably won't be able to paste equations in directly.
  </p>
  
  <p>
   The Unicode standard has a non-contiguous hodgepodge collection of numerals
   that represent superscript numerals.  The only superscript characters
   currently recognized are the following:
  </p>

  <table summary="Unicode numeric superscripts">
    <tbody><tr><th>Character</th><th>Unicode Codepoint</th><th>Description
    </th></tr><tr><td>⁰</td><td>\u2070</td><td>Superscript 0
    </td></tr><tr><td>¹</td><td>\u00b9</td><td>Superscript 1
    </td></tr><tr><td>²</td><td>\u00b2</td><td>Superscript 2
    </td></tr><tr><td>³</td><td>\u00b3</td><td>Superscript 3
    </td></tr><tr><td>⁴</td><td>\u2074</td><td>Superscript 4
    </td></tr><tr><td>⁵</td><td>\u2075</td><td>Superscript 5
    </td></tr><tr><td>⁶</td><td>\u2076</td><td>Superscript 6
    </td></tr><tr><td>⁷</td><td>\u2077</td><td>Superscript 7
    </td></tr><tr><td>⁸</td><td>\u2078</td><td>Superscript 8
    </td></tr><tr><td>⁹</td><td>\u2079</td><td>Superscript 9
    </td></tr><tr><td>⁺</td><td>\u207a</td><td>Superscript plus
      (must precede digits)
    </td></tr><tr><td>⁻</td><td>\u207b</td><td>Superscript minus
      (must precede digits)
  </td></tr></tbody></table>

  <p>
   You can use the <code>toUnicodeSuperscript[<i>int</i>]</code> function to
   turn an integer into a string composed of Unicode superscript digits in
   base 10.
  </p>

  <p>
   You can use the <code>toUnicodeSubscript[<i>int</i>]</code> function to
   turn an integer into a string composed of Unicode subscript digits in
   base 10.
  </p>
  
  <p>
   In addition, some Unicode characters can be used as synonyms for other
   mathematical operators.
  </p>

  <table summary="Unicode mathematical operators">
    <tbody><tr><th>Character</th><th>Unicode Codepoint</th><th>Description
    </th></tr><tr><td>×</td><td>\u00d7</td><td>Unicode
      MULTIPLICATION SIGN, synonym for multiplication <code>*</code> operator
    </td></tr><tr><td>⋅</td><td>\u22c5</td><td>Unicode
      DOT OPERATOR, synonym for multiplication <code>*</code> operator.
      Unicode says "preferred to \u00b7 for denotation of multiplication"
    </td></tr><tr><td>·</td><td>\u00b7</td><td>Unicode
      MIDDLE DOT, synonym for multiplication <code>*</code> operator
      <!--<TR><TD CLASS="lit">&#x2062;<TD CLASS="lit">\u00d7<TD>Unicode
      INVISIBLE TIMES, synonym for multiplication <CODE>*</CODE> operator -->
    </td></tr><tr><td>÷</td><td>\u00f7</td><td>Unicode DIVISION
      SIGN, synonym for division <code>/</code> operator
  </td></tr></tbody></table>

  <p>
   As an example, the following is parsed correctly by Frink, as it uses
   Unicode (and not HTML) markup:
  </p>

  <p>
   <code>ρ = 6.02×10²³ amu ⋅ (6 m³)⁻¹</code>
  </p>

  <p>
   Note that Frink does not currently output Unicode, nor give you simplified
   ways to key in Unicode characters.
  </p>
  
  <h2><a name="Strings">Strings</a></h2>
  <p>
   Text surrounded by double quotes is a string.
  </p>
  
  <p>
   <code>"My hovercraft is full of eels."</code><br>
   <code>My hovercraft is full of eels.</code>
  </p>

  <p>
   If you need to put a literal double-quote inside a string, precede it with
   a backslash:
  </p>

  <p>
   <code>"If you believe in the hypothetical \"Z-Axis\""</code><br>
   <code>If you believe in the hypothetical "Z-Axis"</code>
  </p>

  <p>
   Backslashes have a special meaning within double-quoted and triple-quoted
   strings.  They may precede a special character, as follows:
  </p>

  <table summary="Special Backslash Codes">
    <tbody><tr>
     <th>String</th><th>Description
    </th></tr><tr>
     <td>\\</td><td>Places a <em>single</em> backslash into the string.
    </td></tr><tr>
     <td>\t</td><td>Places a tab character into the string.
    </td></tr><tr>
     <td>\n</td><td>Places a newline character(s) into the string.  The
      exact characters inserted follow your platforms's Java-defined settings
      for the newline character, which may be one character or two.
    </td></tr><tr>
     <td>\r</td><td>Places a return character into the string.
    </td></tr><tr>
     <td>\"</td><td>Places a double-quote character into the string.
    </td></tr><tr>
     <td>\u<i>XXXX</i></td><td>Places a Unicode character into the
      string, where <i>XXXX</i> is a 4-digit hex value for the Unicode
      codepoint.  For more information, see the <a href="#UnicodeInStrings">Unicode in Strings</a> section of the
      documentation. 
    </td></tr><tr>
     <td>\u{<i>XXXXXX</i>}</td><td>Places a Unicode character into the
      string, where <i>XXXXXX</i> is a 1- to 6-digit hex value for the Unicode
      codepoint.  For example, to create a string with a cat face, you would
      use <code>"\u{1f638}"</code> (this is the Unicode character "GRINNING
      CAT FACE WITH SMILING EYES".)  For more information, see the <a href="#UnicodeInStrings">Unicode in Strings</a> section of the
      documentation.
  </td></tr></tbody></table>

  <p>
   A single backslash preceding any other character simply inserts the
   following character into the string (and removes the backslash.)
  </p>

  <p>
   Strings can be concatenated using the <code>+</code> operator.  If either
   side of a <code>+</code> operator is a string, the values will be
   converted to strings before concatenation.
  </p>

  <h3><a name="UnicodeInStrings">Unicode in Strings</a></h3>
  <p>
   For internationalization, Frink allows
   <a href="http://www.unicode.org/">Unicode</a> characters anywhere.
   Strings can contain Unicode characters, indicated in one of a few ways:

  </p><ul>
   <li>Directly entered with a Unicode-aware editor. If you <em>do</em> have a
    nifty editor that handles Unicode, or other character encodings, you can
    write your Frink program in full Unicode, and load it using the <a href="#CommandLineOptions"><code>--encoding <i>str</i></code></a>
    command-line switch.
    
   </li><li><code>\u</code>
    followed by exactly 4 hexadecimal digits [0-9a-fA-F] indicating the Unicode
    code-point.  For example, <code>"\u2764"</code> indicates the Unicode
      character "HEAVY BLACK HEART".

   </li><li><code>\u{<i>XXXXXX</i>}</code> where <code>XXXXXX</code> is anywhere
    from 1 to 6 hexadecimal digits.  For example, <code>"\u{1f435}"</code> is
    the Unicode character "MONKEY FACE".  Note that using this format is
    required because the hexadecimal value has more than 4 digits.

   </li><li>High Unicode characters (those with value higher than
    <code>\uFFFF</code>) can also be represented as a Unicode "surrogate
    pair."  For example, the Unicode character "MONKEY FACE" can also be
    represented as two 4-hex-digit characters: <code>"\ud83d\udc35"</code>.
    This is for compatibility with environments (such as Java) that represent
    a character as 16 bits.  (The <a href="#InputForm"><code>inputForm[<i>expr</i>]</code></a> function
    will produce this format for cross-platform and cross-Java-version
    compatibility.)
  </li></ul>

  <p>
   The latter two allow Unicode characters to be placed into any ASCII text
   file, and edited by programs that don't understand Unicode.
  </p>

  <p>
   <code>"The symbol for micro is \u00b5"</code><br>
   <code>The symbol for micro is µ</code>
  </p>

  <h3><a name="UnicodeCharacterCodes">Unicode Character Codes</a></h3>
  <p>
   You can convert a character to its Unicode character code by using the
   <code>char[<i>x</i>]</code> function.
  </p>

  <p>
   If passed an integer, it returns the character with that Unicode character
   code:
  </p>

  <p>
   <code>char[00b5\\16]</code><br>
   <code>µ</code>
  </p>

  <p>
   If passed a single-character string, it returns the Unicode character code:
  </p>

  <p>
   <code>char["A"]</code><br>
   <code>65</code>
  </p>

  <p>
   If passed a multiple-character string, it returns the Unicode character
   code for each character in an array:
  </p>

  <p>
   <code>char["Frink"]</code><br>
   <code>[70, 114, 105, 110, 107]</code>
  </p>

  <p>
   If you always need an array of character codes, use the
   <code>chars[<i>x</i>]</code> function which turns a string into an array of
   character codes, even when passed a string containing only one character.
  </p>

  <p>
   <code>chars["F"]</code><br>
   <code>[70]</code>
  </p>

  <p>
   You can also obtain the results in a different base:
  </p>

  <p>
   <code>hex[chars["Frink"]]</code><br>
   <code>[46, 72, 69, 6e, 6b]</code>
  </p>

  <p>
   If passed an array of integers, the <code>char[<i>x</i>]</code> function
   returns a string:
  </p>

  <p>
   <code>char[ [70, 114, 105, 110, 107] ]</code><br>
   <code>Frink</code>
  </p>

  <p>
   The <code>charList[<i>str</i>]</code> function returns a list of the
   characters in a string, each as a string of a single codepoint length.  As
   of the 2024-10-17 release, it uses an efficient cache to return results.
  </p>
  
  <p>
   <code>charList["Frink"]</code><br>
   <code>[F, r, i, n, k]</code>
  </p>

  <p>
   The <code>charNames[<i>str</i>]</code> function returns a list of the
   Unicode names of the characters (codepoints) in a string.  (Requires Java
   1.7 or later.)  This returns an empty string if a Unicode codepoint is
   undefined or if the Java Virtual Machine does not know its name (JVMs lag
   far behind the latest Unicode definitions.)
  </p>
  
  <p>
   <code>charNames["\u{1f63a}!"]</code><br>
   <code>[SMILING CAT FACE WITH OPEN MOUTH, EXCLAMATION MARK]</code>
  </p>

  <p>
   If passed an array of positive
   integers, <code>charNames[<i>ints</i>]</code> returns a list of the Unicode
   names of the characters in a string.  (Requires Java 1.7 or later.)  Note
   that Unicode characters are usually specified in hexadecimal, which
   requires prefixing hexadecimal integer values with <code>0x</code>:
  </p>
  
  <p>
   <code>charNames[[0x1f63a, 0x21]]</code><br>
   <code>[SMILING CAT FACE WITH OPEN MOUTH, EXCLAMATION MARK]</code>
  </p>

  <p>
   The <code>charName[<i>str</i>]</code> function works similarly to
   the <code>charNames</code> functions above but if passed a single-character
   string, it will return a single string.  (Requires Java 1.7 or later.)
   This returns an empty string if a Unicode codepoint is undefined or if the
   Java Virtual Machine does not know its name (JVMs lag far behind the latest
   Unicode definitions.)
  </p>
   
  <p>
   <code>charName["X"]</code><br>
   <code>LATIN CAPITAL LETTER X</code>
  </p>

  <p>
   If passed a multiple-character string, <code>charName[<i>str</i>]</code>
   behaves the same as the <code>charNames</code> function and returns an
   array of character names.
  </p>
  
  <p>
   The <code>charName[<i>int</i>]</code> function can also take a single
   integer as an argument.  It returns the name of the specified Unicode
   codepoint. (Requires Java 1.7 or later.)  Note that Unicode characters are
   usually specified in hexadecimal, which requires prefixing hexadecimal
   integer values with <code>0x</code>:
  </p>
  
  <p>
   <code>charName[0x1f63a]</code><br>
   <code>SMILING CAT FACE WITH OPEN MOUTH</code>
  </p>
   
  <h3><a name="CorrectStringParsing">Correct String Parsing</a></h3>
  <p>
   Frink provides several functions to process strings correctly using Unicode
   rules.  When working with Unicode, almost all algorithms should work on
   entire <em>strings</em> to be correct, not individual characters.  (This is
   why Frink doesn't even have a character type.)
  </p>

  <p>
   The following functions operate on strings and allow you to enumerate
   through their parts.  Each of the following returns an enumerating
   expression that allows you to loop through the contents of a string in
   different, Unicode-correct ways:
  </p>

  <table summary="Correct string parsing functions">
    <tbody><tr>
     <th>Function</th><th>Description
    </th></tr><tr>
     <td>graphemeList[<i>string</i>]
     </td><td>This returns an enumerating list of the <i>graphemes</i> in a string,
      each as a string of 1 or more Unicode codepoints.

      <p>
       To quote the Unicode standard:
      </p>

      <blockquote>
       <p>
        "It is important to recognize that what the user thinks of as a
        'character'--a basic unit of a writing system for a language--may not
        be just a single Unicode code point. Instead, that basic unit may be
        made up of multiple Unicode code points. To avoid ambiguity with the
        computer use of the term character, this is called a user-perceived
        character. For example, 'G' + acute-accent is a user-perceived
        character: users think of it as a single character, yet is actually
        represented by two Unicode code points. These user-perceived
        characters are approximated by what is called a grapheme cluster,
        which can be determined programmatically."
       </p>
      </blockquote>

      <p>
       For example, the string <code>"g\u0308o"</code>
       represents a <code>g</code> with combining diaeresis followed by the
       letter <code>o</code>.  Or, in other words,
       <code>"g̈o"</code>.  Note that while there are three
       Unicode codepoints, only two "graphemes" are displayed.
      </p>

      <p>
       As another example, the Devanagari string
       <code>"\u0915\u094D\u0937\u093F"</code>
       (shown as क्षि ) is recognized as a single
       grapheme and should generally be kept intact and counted as a single
       display glyph in functions like <code>graphemeLength[<i>str</i>]</code>
       below.
      </p>

      <p>
       The <code>reverse[<i>string</i>]</code> function now uses a
       grapheme-based reverse algorithm.  See below.
      </p>

    </td></tr><tr><td>graphemeLength[<i>str</i>]</td><td>Returns the length of a
      string in <em>graphemes</em>, counting multiple Unicode codepoints that
      should be combined together as a single display glyph as a single
      character.
      
    </td></tr><tr><td>reverse[<i>str</i>]</td><td>Reverses the characters in a
      string.
      <p>
       <b>Note:</b>As of the 2016-05-27 release, this is a smarter reversal
       that follows Unicode rules to keep combining characters together and
       properly ordered.
      </p>

      <p>
       For example, the string <code>"g\u0308o"</code>
       represents a <code>g</code> with combining diaeresis followed by the
       letter <code>o</code>.  Or, in other words,
       <code>"g̈o"</code>.
       Reversing this naïvely would cause the diaeresis to incorrectly
       show over the <code>o</code> instead of the <code>g</code>.
      </p>

      <p>
       As another example, the Devanagari string
       <code>"\u0915\u094D\u0937\u093F"</code>
       (shown as क्षि ) is recognized as a single
       grapheme and the 4 Unicode codepoints that make it up are kept intact
       and not reversed.
      </p>

      <p>
       Yes, this stuff is tricky.  It may not always reverse strings to the
       exact rules used in your language, but it will attempt to reverse the
       string according to the rules encoded in the Unicode standard.
      </p>

      <p>
       If you, for some reason, need a naïve and broken string reversal,
       you can do something like:
      </p>

      <p>
       <code>reverse[charList[<i>string</i>]]</code>
      </p>

      <p>
       but keep in mind that this will <em>still</em> do the right thing like
       keeping surrogate pairs ordered correctly.  You'll have to try hard to
       make Frink do the wrong thing.  Don't do this.  It's never right for
       Unicode strings.  Frink tries to always work on Unicode
       <em>strings</em>, and not individual characters, as working on
       individual characters or codepoints is almost always the wrong thing to
       do when processing Unicode.
      </p>

       
    </td></tr><tr>
     <td>wordList[<i>string</i>]
     </td><td>Returns an enumeration of the words in a string.  This function
      provides correct interpretaion of punctuation marks within and following
      words.  It also correctly handles hyphenated words.  Note that this
      returns words, spacing, and punctuation marks.

      <p>
       The following example solves a typical programming interview task:
       reversing the words in a string.  It throws away any words that don't
       contain an alphanumeric value, and collapses multiple spaces into one.
      </p>

      <p>
       <code>a = "This does a Unicode-correct word reversal (wasn't that easy?)"<br>
        join[" ", reverse[select[wordList[a], %r/[[:alnum:]]/ ]]]<br>
       </code>
       <code>easy that wasn't reversal word Unicode-correct a does This</code>
      </p>

    </td></tr><tr>
     <td>wordList[<i>string</i>, <i>language</i>]
     </td><td>Same as <code>wordList</code> above but <code>language</code>
      specifies  a language specifier. See
      the <a href="#LanguageSpecifiers">Language Specifiers</a> section below. 

    </td></tr><tr>
     <td>sentenceList[<i>string</i>]
     </td><td>This returns an enumeration of the sentences in a string.  Sentences
      are parsed with correct interpretation of periods within numbers and
      abbreviations, and trailing punctuation marks such as quotation marks
      and parentheses.
      
    </td></tr><tr>
     <td>sentenceList[<i>string</i>, <i>language</i>]
     </td><td>Same as <code>sentenceList</code> above but <code>language</code>
      specifies  a language specifier. See
      the <a href="#LanguageSpecifiers">Language Specifiers</a> section below. 

    </td></tr><tr>
     <td>lineBreakList[<i>string</i>]
     </td><td>Returns an enumeration of the places that a line can be broken.  It
      correctly handles punctuation, numbers, and hyphenated words.
      
    </td></tr><tr>
     <td>lineBreakList[<i>string</i>, <i>language</i>]
     </td><td>Same as <code>lineBreakList</code> above but <code>language</code>
      specifies  a language specifier. See
      the <a href="#LanguageSpecifiers">Language Specifiers</a> section below. 
      
    </td></tr><tr><td>lexicalCompare[<i>string1</i>, <i>string2</i>]
     </td><td>Compares 2 strings using a comparison method that understands human
      languages.  This version uses the default locale and language settings
      defined on <em>your</em> Java Virtual Machine to perform the comparison.

      <p>
       The function is similar to, but much smarter than the
       <code>&lt;=&gt;</code> <a href="#ThreeWayComparison">three-way
        comparison</a> operator.  Like the three-way comparison operator, it
        returns
       <code>-1</code> if, lexicographically, <code>a &lt; b</code>,
       <code>0</code> if
       <code>a == b</code>, and <code>1</code> if <code>a &gt; b</code> and
       can thus be used in <a href="#Sorting">sorting functions</a>.
      </p>

      <p>
       As of the 2024-07-11 release, <code>lexicalCompare</code> now compares
       sub-arrays also.  For example, in an array of
       arrays, <code>[1,2,3]</code> sorts before <code>[2,1,3]</code>.
       Shorter arrays sort before longer ones.
      </p>
      
      <p>
       See the <a href="#LexicalSorting">Lexical Sorting</a> section of the
       documentation for more on lexical comparisons.
      </p>
      
    </td></tr><tr><td>lexicalCompare[<i>string1</i>, <i>string2</i>, <i>languageCode</i>]
     </td><td>Like the previous function, this compares 2 strings using a
      comparison method that understands human languages.  This version uses a
      specified language.  The argument <code>languageCode</code> can be one
      of three types:

      <ul>
       <li>A string containing a
         2-letter <a href="https://www.loc.gov/standards/iso639-2/php/code_list.php" target="_blank">ISO 639-1</a> code for the language, such
        as <code>"en"</code> for English.
       </li><li>A longer language specifier such as <code>"en_US"</code> (English,
        US region)
       </li><li>A 
        <a href="https://docs.oracle.com/javase/8/docs/api/java/text/Collator.html" target="_blank"><code>java.text.Collator</code></a>
         
       </li><li>A <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Locale.html" target="_blank">
         <code>java.util.Locale</code></a>
      </li></ul>

      <p>
       See the <a href="#LexicalSorting">Lexical Sorting</a> section of the
       documentation for more on lexical comparisons.
      </p>
    </td></tr><tr><td>normalizeUnicode[<i>string</i>, <i>method="NFC"</i>]
     </td><td>Normalizes the characters in a Unicode string using one of the
      methods described in the Unicode standard,
      specifically <a href="http://unicode.org/reports/tr15/" target="_blank">Unicode Standard Annex #15,
       <i>Unicode Normalization Forms</i></a>.

      <p>
       A Unicode string can use various methods to encode what is essentially
       the same character/glyph.  For example, the character
       <code>ô</code> can be represented as either <code>"\u00F4"</code>
       or <code>"\u006F\u0302"</code>.  The former is a "precomposed"
       character, "LATIN SMALL LETTER O WITH CIRCUMFLEX", and the latter is
       two Unicode codepoints, an <code>o</code> followed by "COMBINING
       CIRCUMFLEX ACCENT".  (This is usually referred to as a "decomposed"
       representation.)   Unicode normalization rules can convert these
       "equivalent" encodings into a canonical representation.
      </p>

      <p><a href="http://unicode.org/reports/tr15/" target="_blank">Unicode
       Standard Annex #15</a> currently defines four different methods of
       converting between these representations.  (You might get the best idea
       of the differences between these by looking at figure 6 in the
       document.)
      </p>

      <p>The <code>method</code> parameter is a string containing the names of
       one of these conversion methods, which can consist of
       <code>"NFC"</code> (the default), <code>"NFD"</code>,
       <code>"NFKD"</code>, and <code>"NFKC"</code>.  Please read <a href="http://unicode.org/reports/tr15/">Unicode Standard Annex #15</a>
       for a description of the differences in these algorithms, as the
       procedures involved are quite detailed and beyond the scope of this
       document.  Again, figure 6 in that document will give you a quick idea
       of the diferences.
      </p>

      <p>
       In short, for many purposes, <code>"NFC"</code> is recommended for
       interchange, and for its compactness and simplicity, and is thus the
       default.
      </p>

      <p>
       If the string is already normalized to the requested form, the
       original string is returned unmodified.
      </p>

      <p>
       This normalization process is useful when, say, using Unicode strings
       as dictionary keys.  Two different keys that might be considered
       identical may not have the same representation without normalization.
      </p>
     </td></tr></tbody></table>


  <h4><a name="LanguageSpecifiers">Language Specifiers</a></h4>
  <p>
   The <code>wordList</code>, <code>lineBreakList</code>, and
   <code>sentenceList</code> functions above can take an optional "Language
   specifier" to allow Frink to process text using a different human
   language's rules.  A language specifier can be one of the following:
  </p>
  
  <ul>
   <li>A string containing a
    2-letter <a href="https://www.loc.gov/standards/iso639-2/php/code_list.php" target="_blank">ISO 639-1</a> code for the language, such
    as <code>"en"</code> for English.
    
   </li><li>A longer language specifier such as <code>"en_US"</code> (English,
       US region)
         
   </li><li>A <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Locale.html" target="_blank"><code>java.util.Locale</code></a>
  </li></ul>

  <h3><a name="UpperLowerCase">Upper/Lower Case</a></h3>
  <p>
    The functions <code>uppercase[<i>str</i>]</code> or
    <code>uc[<i>str</i>]</code> and <code>lowercase[<i>str</i>]</code> or
    <code>lc[<i>str</i>]</code> convert a string to upper- or lowercase.
    These functions use Unicode single- and multiple-character mapping tables
    and thus try to do the right thing with Unicode, possibly making the
    string longer in some cases:
  </p>
  
  <p>
   <code>uc["Imbiß"]</code> <br>
   <code>IMBISS</code>
  </p>

  <p>
   As the <a href="http://www.unicode.org/charts/case/">Unicode standard for
   casing</a> states, "it is important to note that no casing operations on
   strings are reversible:"
  </p>

  <p>
   <code>lc[ uc["Imbiß"] ]</code><br>
   <code>imbiss</code>
  </p>

  <h3><a name="Substrings">Substrings</a></h3>
  <p>
   The following functions return substrings of a string.
  </p>

  <p>
   <b>Note:</b> as of the 2014-07-01 release, all Frink functions handle high
   Unicode codepoints (that is, above <code>\uFFFF</code>,) correctly as a
   single character (unlike Java.)  These are easier to use in almost all
   situations.  If you need the more cumbersome Java-style
   behavior, such as to communicate with Java methods, use the functions in
   the <a href="#RawStringFunctions">Raw String Functions</a> section.
  </p>

  <table summary="Substring functions">
    <tbody><tr>
     <th>Function</th><th>Description
    </th></tr><tr>
     <td>substr[<i>string</i>,&nbsp;<i>startPos</i>,&nbsp;<i>endBefore</i>]<br>
      substring[<i>string</i>,&nbsp;<i>startPos</i>,&nbsp;<i>endBefore</i>]
     </td><td>
      Takes the substring of string <code>str</code> beginning with
      <code>startPos</code> and ending <em>before</em> the character position
      <code>endBefore</code>.
      The length of the substring will be <code>endBefore-startPos</code>.

    </td></tr><tr>
     <td>substrLen[<i>string</i>,&nbsp;<i>startPos</i>,&nbsp;<i>len</i>]<br>
      substringLen[<i>string</i>,&nbsp;<i>startPos</i>,&nbsp;<i>len</i>]
     </td><td>
      Takes the substring of string <code>str</code> beginning with
      <code>startPos</code> and containing <code>len</code> characters.

    </td></tr><tr>
     <td>left[<i>string</i>,&nbsp;<i>len</i>]<br>
      right[<i>string</i>,&nbsp;<i>len</i>]
     </td><td>
      Returns a string containing the leftmost or rightmost characters of the
      given string with the specified length.  If <code>len</code> is
      negative, it returns a string with <code>-len</code> characters removed,
      that is, if the original string is 5 characters long, and
      <code>len</code> is <code>-1</code>, 4 characters are returned.  In any
      case, if the original string is shorter than the number of characters
      requested, the string returned will contain only the number of
      characters available, but will not return an error.

    </td></tr><tr>
     <td>indexOf[<i>string</i>,&nbsp;<i>substr</i>]
     </td><td>
      Returns the index (zero-based) of the first occurrence of a substring in
      a string.  This returns -1 if the substring is not found in the string.

    </td></tr><tr>
     <td>indexOf[<i>string</i>,&nbsp;<i>substr</i>,&nbsp;<i>startPos</i>]
     </td><td>
      Returns the index (zero-based) of the first occurrence of a substring in
      a string starting with position <code>startPos</code>.  This returns -1
      if the substring is not found in the string.
      
    </td></tr><tr>
     <td>lastIndexOf[<i>string</i>,&nbsp;<i>substr</i>]
     </td><td>
      Returns the index (zero-based) of the last occurrence of a substring in
      a string.  This returns -1 if the substring is not found in the string.

    </td></tr><tr>
     <td>lastIndexOf[<i>string</i>,&nbsp;<i>substr</i>,&nbsp;<i>startPos</i>]
     </td><td>
      Returns the index (zero-based) of the last occurrence of a substring in
      a string starting backwards from position <code>startPos</code>.  This
      returns -1 if the substring is not found in the
      string.  <code>startPos</code> should be no larger
      than <code>length[string]</code>.

    </td></tr><tr>
     <td>startsWith[<i>string</i>,&nbsp;<i>prefix</i>]
     </td><td>
      Returns true if <code>string</code> begins with <code>prefix</code>.
      If <code>prefix</code> is the empty string, this returns true.
      
    </td></tr><tr>
     <td>startsWith[<i>string</i>,&nbsp;<i>prefix</i>,&nbsp;<i>startPos</i>]
     </td><td>
      Returns true if <code>string</code> begins with <code>prefix</code>,
      starting from integer position <code>startPos</code>, false otherwise.
      If <code>prefix</code> is the empty string, this returns true.
      <code>startPos</code> should be no larger than
      <code>length[string]</code>.
      
    </td></tr><tr>
     <td>endsWith[<i>string</i>,&nbsp;<i>suffix</i>]
     </td><td>
      Returns true if <code>string</code> ends with <code>suffix</code>.
      If <code>suffix</code> is the empty string, this returns true.
  </td></tr></tbody></table>

  <h3><a name="RawStringFunctions">Raw String Functions</a></h3>
  <p>
   <b>Note:</b> as of the 2014-07-01 release, all Frink functions handle high
   Unicode codepoints (that is, above <code>\uFFFF</code>,) correctly as a
   single character (unlike Java.)  If you need the more cumbersome Java-style
   behavior, such as to communicate with Java, these functions behave more
   like the Java versions, possibly treating high Unicode characters as two
   separate characters.
  </p>

  <table summary="Raw string functions">
    <tbody><tr>
     <th>Function</th><th>Description
    </th></tr><tr>
     <td>lengthRaw[<i>string</i>]
     </td><td>Returns the Java-style raw UTF-16-style length of a String, as
      reported by Java.
      
    </td></tr><tr>
     <td>charsRaw[<i>string</i>]
     </td><td>Returns an array of the raw Java-style UTF-16 encoded characters in a
      string.
      
    </td></tr><tr>
     <td>substrRaw[<i>string</i>,&nbsp;<i>startPos</i>,&nbsp;<i>endBefore</i>]<br>
      substringRaw[<i>string</i>,&nbsp;<i>startPos</i>,&nbsp;<i>endBefore</i>]
     </td><td>
      Takes the substring of string <code>str</code> beginning with the raw
      position <code>startPos</code> and ending <em>before</em> the raw
      character position <code>endBefore</code>, using the raw Java offset
      indices.  The length of the substring will be
      <code>endBefore-startPos</code> raw Java characters long.

    </td></tr><tr>
     <td>substrLenRaw[<i>string</i>,&nbsp;<i>startPos</i>,&nbsp;<i>len</i>]<br>
      substringLenRaw[<i>string</i>,&nbsp;<i>startPos</i>,&nbsp;<i>len</i>]
     </td><td>
      Takes the substring of string <code>str</code> beginning with the raw
      character position <code>startPos</code> and containing <code>len</code>
      raw Java-style characters.

    </td></tr><tr>
     <td>indexOfRaw[<i>string</i>,&nbsp;<i>substr</i>]
     </td><td>Returns the index (zero-based) of the first occurrence of a substring
      in a string.  This returns -1 if the substring is not found in the
      string.
      
    </td></tr><tr>
     <td>indexOfRaw[<i>string</i>,&nbsp;<i>substr</i>,&nbsp;<i>startPos</i>]
     </td><td>Returns the index (zero-based) of the first occurrence of a substring
      after position <code>startPos</code> in a string.  This returns -1 if
      the substring is not found in the string. 
  </td></tr></tbody></table>


  <h3><a name="OtherStringFunctions">Other String Functions</a></h3>
  <p>
   Additional functions for manipulating strings are listed below.
  </p>

  <table summary="Other String Functions">
    <tbody><tr><th>Function</th><th>Description
    </th></tr><tr><td>trim[<i>str</i>]</td><td>Returns a string with whitespace
      trimmed from the left and right ends.
    </td></tr><tr><td>length[<i>str</i>]</td><td>Returns the length of a string
      in Unicode codepoints.  This correctly counts characters above Unicode
      <code>\uFFFF</code> as a single character, which is different than the
      somewhat messy Java behavior.  

      <p>
       <b>Note:</b> However, this may not be the length of characters that a
        user sees.  For that, see the following
       <code>graphemeLength[<i>str</i>]</code> function which handles Unicode
       more correctly.
      </p>

      <p>
       <b>Note:</b> If you need the more cumbersome Java-style behavior, such
       as to communicate with Java methods, use the functions in the <a href="#RawStringFunctions">Raw String Functions</a> section.
      </p>

    </td></tr><tr><td>graphemeLength[<i>str</i>]</td><td>Returns the length of a
      string in <em>graphemes</em>, counting multiple Unicode codepoints that
      should be combined together as a single display glyph as a single
      character.
      
      <p>
       To quote the Unicode standard:
      </p>

      <blockquote>
       <p>
        "It is important to recognize that what the user thinks of as a
        'character'--a basic unit of a writing system for a language--may not
        be just a single Unicode code point. Instead, that basic unit may be
        made up of multiple Unicode code points. To avoid ambiguity with the
        computer use of the term character, this is called a user-perceived
        character. For example, 'G' + acute-accent is a user-perceived
        character: users think of it as a single character, yet is actually
        represented by two Unicode code points. These user-perceived
        characters are approximated by what is called a grapheme cluster,
        which can be determined programmatically."
       </p>
      </blockquote>

      <p>
       Also see the <a href="#CorrectStringParsing">Correct String Parsing</a>
       section of the documentation for more functions for parsing Unicode
       strings correctly.
      </p>
       
    </td></tr><tr><td>parseInt[<i>str</i>]</td><td>Parses a string, containing
      digits 0-9 only, to an integer in base 10.  This is much less powerful
      and less forgiving than using <code><a href="#SelfEvaluation">eval[<i>str</i>]</a></code>, but faster. 
    </td></tr><tr><td>parseInt[<i>str</i>,&nbsp;<i>base</i>]</td><td>Parses a
      string, treating it as if it's a number in the specified base.
    </td></tr><tr><td>repeat[<i>str</i>, <i>times</i>]</td><td>Repeats the string
      the specified number of times and returns it as a string.
    </td></tr><tr><td>padLeft[<i>str</i>, <i>width</i>,
      <i>padChar</i>]</td><td>Pads the left side of the string to the specified
      width, using the one-character string <i>padChar</i> as the character to
      pad with.  If the string is already longer than the specified width, it
      returns the original string unchanged.  If the first argument is not
      already a string, it is converted to a string.
    </td></tr><tr><td>padRight[<i>str</i>, <i>width</i>,
      <i>padChar</i>]</td><td>Pads the right side of the string to the specified
      width, using the one-character string <i>padChar</i> as the character to
      pad with.  If the string is already longer than the specified width, it
      returns the original string unchanged.  If the first argument is not
      already a string, it is converted to a string.
    </td></tr><tr><td>editDistance[<i>str1</i>,&nbsp;<i>str2</i>]</td><td>Returns
      the <i>edit distance</i> or <i>Levenshtein distance</i> between two
      strings.  This is the minimum number of operations needed to transform
      one string into the other, where an operation is an insertion, deletion,
      or replacement.  It can be used to aid in spell checking, fuzzy
      spelling, plagiarism detection, and determining similarity of two
      strings.  The algorithm used runs in O(n*m) time, where n and m are the
      lengths of each string.  It uses O(m) space when processing.  The
      comparison <em>is</em> case-sensitive.  The following are examples of
      edit distances between strings: 
      <table summary="Description of editDistance edits">
        <tbody><tr><th>String 1</th><th>String 2</th><th>Edit Distance</th><th>Description
        </th></tr><tr>
         <td>Fr<b>i</b>nk
         </td><td>Fr<b>a</b>nk
         </td><td>1
         </td><td>Replacement
          
        </td></tr><tr>
         <td>Frink
         </td><td>Frink<b>y</b>
         </td><td>1
         </td><td>Insertion
          
        </td></tr><tr>
         <td>F<b>r</b>ink
         </td><td>Fink
         </td><td>1
         </td><td>Deletion
          
        </td></tr><tr>
         <td>Frink
         </td><td>
          Fr<b>a</b>nk<b>s</b>
         </td><td>2
         </td><td>1 Replacement + 1 Insertion
      </td></tr></tbody></table>

    </td></tr><tr><td>editDistanceDamerau[<i>str1</i>,&nbsp;<i>str2</i>]</td><td>Returns the Levenshtein-Damerau edit distance between two strings.  This is
    similar to the <code>editDistance</code> function above, but also allows
      <em>swaps</em> between two adjoining characters, which count as an edit
      distance of 1.  This may make distances between some strings shorter, by
      say, treating transposition errors in a word as a less expensive
      operation than in the pure Levenshtein algorithm.
      
      <table summary="Description of editDistance edits">
        <tbody><tr><th>String 1</th><th>String 2</th><th>Edit Distance</th><th>Description
        </th></tr><tr>
         <td>F<b>ri</b>nk
         </td><td>F<b>ir</b>nk
         </td><td>1
         </td><td>Swap of adjoining characters
      </td></tr></tbody></table>
      
    </td></tr><tr><td>editDistanceDamerau[<i>str1</i>,&nbsp;<i>str2</i>,
      <i>deleteCost</i>, <i>insertCost</i>, <i>replaceCost</i>,
      <i>swapCost</i>]</td><td>Returns the Levenshtein-Damerau edit distance
      between two strings as above, but allows you to specify the
      <em>cost</em> of the delete, insert, replace, and swap operations as
      integers.  (Default is 1 for each in the above algorithm.)
      
      <p>
       For stability, <code>swapCost*2</code> must be &gt;= <code>insertCost +
        deleteCost</code>.
      </p>
      
      <p>
       If you want to, say, disallow replacements, you can set the cost for
       the replacement parameter to be higher than the length of either
       string.  For example:
      </p>

      <p>
       <code>
        editDistanceDamerau["ABCD", "CBAD", 1, 1, 1000, 1]<br>
       </code>
       <code>3</code>
      </p>

    </td></tr><tr><td>base64Encode[<i>expression</i>,&nbsp;<i>encoding</i>]</td><td>Encodes the specified expression (which is probably a string, but can also be a Java array of bytes) to base-64 encoding,
      first converting Unicode characters to raw bytes using the specified
      encoding.  (Hint: "UTF-8" is probably good for the encoding.  The
      receiver will have to use the same encoding to make Unicode work
      correctly.  If the input is a Java array of bytes, the encoding should
      be <code>undef</code>.)

    </td></tr><tr><td>base64Encode[<i>expression</i>,&nbsp;<i>encoding</i>,<i>lineLength</i>]</td><td>Encodes to base-64 as above, wrapping lines at the specified line length.

    </td></tr><tr><td>base64Decode[<i>string</i>,&nbsp;<i>encoding</i>]</td><td>Decodes
    the specified base-64 text into a string.  Raw bytes are converted to
    Unicode characters using the specified encoding. (Hint: This encoding will
    have to match the encoding used in the <code>base64Encode</code> function
    above to make non-ASCII characters work correctly.  "UTF-8" might be a
    good choice.)

    </td></tr><tr><td>base64DecodeToBytes[<i>string</i>]</td><td>Decodes
      the string (which should contain base-64 encoded text) into an array of
      raw bytes.

    </td></tr><tr><td>toASCII[<i>string</i>]</td><td>Encodes a string into an
      ASCII-safe equivalent, with characters outside the ASCII range turned
      into Unicode escapes.  Note that, unlike <code>toASCIIHigh</code>, this
      function splits Unicode codepoints above <code>\uFFFF</code> into
      surrogate pairs for portability.  Also see
      the <a href="#Formatters">Formatters</a> section of the documentation,
      especially <a href="#InputForm">inputForm</a> for a safer way to quote
      and encode strings.

    </td></tr><tr><td>toASCIIHigh[<i>string</i>]</td><td>Encodes a string into an
      ASCII-safe equivalent, with characters outside the ASCII range turned
      into Unicode escapes.  Unlike <code>toASCII</code>, this preserves
      Unicode codepoints above <code>\uFFFF</code> as a single codepoint in
      Frink's input format <code>\u{HHHHHH}</code> that may contain from 1 to 6
      hexadecimal digits.  Also see the <a href="#Formatters">Formatters</a>
      section of the documentation,
      especially <a href="#InputForm">inputForm</a> for a safer way to quote
      and encode strings.

    </td></tr><tr><td>toUnicodeSuperscript[<i>int</i>]</td><td>Turns an integer
      into a string containing the equivalent Unicode superscript digits in
      base 10.

    </td></tr><tr><td>toUnicodeSubscript[<i>int</i>]</td><td>Turns an integer
      into a string containing the equivalent Unicode subscript digits in
      base 10.

    </td></tr><tr><td>stringToBytes[<i>str</i>, <i>encoding="UTF-8"</i>]
     </td><td>Turns a string into an array of Java bytes using the specified
      encoding to turn a Unicode string into bytes.  The encoding defaults to
      UTF-8, but can be a string indicating any encoding supported on your
      system.
      <p>
       See the <a href="https://frinklang.org/fsp/colorize.fsp?f=encodings.frink">encodings.frink</a> sample
      program to see how to list all character encodings (and their aliases)
       available on your system.
       
    </p></td></tr><tr><td>bytesToString[<i>bytes</i>, <i>encoding="UTF-8"</i>]
     </td><td>Turns a an array of bytes (either a Java array of bytes or an array
      of Frink integers that all fit into a byte) into a string using the
      specified encoding.  The encoding defaults to UTF-8, but can be a string
      indicating any encoding supported on your system.
      <p>
       See the <a href="https://frinklang.org/fsp/colorize.fsp?f=encodings.frink">encodings.frink</a> sample
      program to see how to list all character encodings (and their aliases)
       available on your system.
  </p></td></tr></tbody></table>

  <h3><a name="UnicodeProperties">Unicode Properties</a></h3>
  <p>
   The Unicode standard defines various properties of each character (called
   codepoints).  Frink gives you several functions to query properties of
   each codepoint.
  </p>

  <p>
   The Unicode "General Category" property defines long and short category
   names for each type of character, for example, "<code>Letter, uppercase</code>" and
   "<code>Lu</code>".  See
   the <a href="https://www.unicode.org/versions/Unicode13.0.0/ch04.pdf">The
   Unicode Standard, section 4.5</a>.
  </p>

  <p>
   For example, the following program prints a table of all currency symbols
   (general category "<code>Sc</code>") defined in Unicode :
  </p>

  <p>
   <code>for i=0 to 0x1FFFF<br>
&nbsp;&nbsp;&nbsp;if charCategoryShort[i] == "Sc"<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;println[char[i] + "\t" + toASCIIHigh[char[i]] + "\t" + charName[i]]
   </code>
  </p>
  
  <p>
   <code>$&nbsp;&nbsp;&nbsp;&nbsp;$&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DOLLAR SIGN<br>
¢&nbsp;&nbsp;&nbsp;&nbsp;\u00a2&nbsp;&nbsp;&nbsp;&nbsp;CENT SIGN<br>
£&nbsp;&nbsp;&nbsp;&nbsp;\u00a3&nbsp;&nbsp;&nbsp;&nbsp;POUND SIGN<br>
¤&nbsp;&nbsp;&nbsp;&nbsp;\u00a4&nbsp;&nbsp;&nbsp;&nbsp;CURRENCY SIGN<br>
¥&nbsp;&nbsp;&nbsp;&nbsp;\u00a5&nbsp;&nbsp;&nbsp;&nbsp;YEN SIGN<br>
֏&nbsp;&nbsp;&nbsp;&nbsp;\u058f&nbsp;&nbsp;&nbsp;&nbsp;ARMENIAN DRAM SIGN<br>
؋&nbsp;&nbsp;&nbsp;&nbsp;\u060b&nbsp;&nbsp;&nbsp;&nbsp;AFGHANI SIGN<br>
৲&nbsp;&nbsp;&nbsp;&nbsp;\u09f2&nbsp;&nbsp;&nbsp;&nbsp;BENGALI RUPEE MARK<br>
৳&nbsp;&nbsp;&nbsp;&nbsp;\u09f3&nbsp;&nbsp;&nbsp;&nbsp;BENGALI RUPEE SIGN<br>
৻&nbsp;&nbsp;&nbsp;&nbsp;\u09fb&nbsp;&nbsp;&nbsp;&nbsp;BENGALI GANDA MARK<br>
૱&nbsp;&nbsp;&nbsp;&nbsp;\u0af1&nbsp;&nbsp;&nbsp;GUJARATI RUPEE SIGN<br>
    ... <i>plus 40 more</i> ...
   </code>
  </p>
  
  <table summary="Unicode Property Functions">
    <tbody><tr><th>Function</th><th>Description
    </th></tr><tr><td>charCategoryShort[<i>expr</i>]</td><td>Returns the short
      Unicode general category as a string, e.g. <code>"Lu"</code> for
      "Letter, uppercase".  If <code><i>expr</i></code> is a single-character
      string, this returns a single string.  If <code><i>expr</i></code> is a
      multi-character string, this returns an array of strings.
      If <code><i>expr</i></code> is an integer, this returns the category for
      that codepoint.
    </td></tr><tr><td>charCategoryLong[<i>expr</i>]</td><td>Returns the long
      Unicode general category as a string, e.g. <code>"Letter,
      uppercase"</code>.  The interpretation of the argument is the same as
      for <code>charCategoryShort</code> above.
    </td></tr><tr><td>charCategoriesShort[<i>expr</i>]</td><td>Returns the short
      Unicode general category as an array of strings.  This differs
      from <code>charCategoryShort</code> in that it always returns
      an <em>array</em> of strings, even when passed a single-character
      string.  In addition, if passed an array of integers (indicating Unicode
      codepoints), or a single integer, this will return an <em>array</em> of
      short category strings for each codepoint.
    </td></tr><tr><td>charCategoriesLong[<i>expr</i>]</td><td>Returns the long
      Unicode general category as an array of strings.  The interpretation of
      the argument is the same as for <code>charCategoriesShort</code> above.
    </td></tr><tr><td>charBlock[<i>expr</i>]</td><td>Returns the Unicode block
      name as a string, e.g. <code>"BASIC_LATIN"</code>, <code>"ARABIC"</code>,
      or <code>"CURRENCY_SYMBOLS"</code>.  If <code><i>expr</i></code> is a
      single-character string, this returns a single string.
      If <code><i>expr</i></code> is a multi-character string, this returns an
      array of strings.  If <code><i>expr</i></code> is an integer, this
      returns the block for that codepoint.
    </td></tr><tr><td>charBlocks[<i>expr</i>]</td><td>Returns the Unicode block
      name as an array of strings.  This differs from <code>charBlock</code>
      in that it always returns an <em>array</em> of strings, even when passed
      a single-character string.  In addition, if passed an array of integers
      (indicating Unicode codepoints), or a single integer, this will return
      an <em>array</em> of block names for each codepoint.
  </td></tr></tbody></table>
  
  <h3><a name="MultiLineStrings">Multi-Line Strings</a></h3>
  <p>
   Text surrounded by three sets of double-quotes is a multi-line string (like
   in Python.)  Newlines are allowed and retained in the string. Hopefully,
   this is less burdensome and error-prone than Perl's "here-document" syntax.
   For example:
  </p>

  <p>
   <code>
    lyrics = """Oh, Danny Boy,<br>
    The pipes, the pipes are calling<br>
    From glen to glen and down the mountainside"""<br>
   </code>
  </p>

  <p>
   This is also useful when you have strings that contain double quotes, as it
   eliminates the need for escaping those quotes:
  </p>

  <p>
   <code>quote = """We will say "ni" to you again if you do not appease us."""</code>
  </p>
  
  <h3><a name="StringInterpolation">String Interpolation</a></h3>
  <p>
   If a double-quoted string or multi-line string contains a dollar sign
   (<code>$</code>) followed by a variable name (which must begin with a
   letter), the value of that variable is replaced in the string at evaluation
   time.  This is (probably) faster than string concatenation which could be
   used to get the same effect.  There are certain optimizations to make sure
   that this isn't significantly more inefficient if the string doesn't need
   replacement.  (The string is checked for dollar signs at compile time.)
  </p>

  <p>
   <code>first = "Inigo"<br>
    last = "Montoya"<br>
    "My name is $first $last."</code><br>
   <code>My name is Inigo Montoya.</code>
  </p>

  <p>
   If you need to explicitly mark where the variable name begins and ends, you
   can put it in curly braces as below:
  </p>

  <p>
   <code>last="Frink"<br>
    "You can call me the ${last}meister."</code><br>
   <code>You can call me the Frinkmeister.</code>
  </p>

  <p>
   Since a variable name must begin with a letter, it's fine to put a quantity
   like <code>$2.00</code> into the string, and no substitution will be
   attempted, and there will be no runtime performance penalty.  To put a
   literal dollar sign into the string immediately preceding an letter
   character, use two dollar signs:
  </p>

  <p>
   <code>"I want my $$USD 2.00.  Plus tip."</code><br>
   <code>I want my $USD 2.00.  Plus tip.</code>
  </p>

  <p>
   For best performance, <em>don't</em> use double dollar signs like this
   unless they directly precede an letter character.
  </p>

  <p>
   You can always use this technique to coerce a numeric value, or a unit, or
   a date, etc., to a string representation by enclosing it in quotes:
  </p>

  <p>
   <code>n = 2^13367-1<br>
   stringRep = "$n"</code>
  </p>

  <p>
   After the above code, the variable <code>stringRep</code> contains the
   result of the calculation <em>as a string</em> which you can use to grab
   certain characters, truncate, etc. Note that the
   <code>toString[<i>expr</i>]</code> function does the same thing, and can
   often be used on the same line.
  </p>
  
  <h2><a name="TextTranslation">Text Translation</a></h2>

  <p>
   <b>Obligatory Disclaimer:</b> This feature requires connection to the
   internet.  If you are using Frink on a handheld device, you may incur
   connection charges.  Also, since I cannot guarantee the availability of any
   internet sites, this feature is intended only as a bonus that may not work
   reliably if at all.  You may also require some
   <a href="#ProxyConfiguration">proxy configuration</a> if you use an HTTP
   proxy server to access the web.
  </p>
  
  <p>
   Text can be translated into other languages:
  </p>

  <p>
   <code>"My hovercraft is full of eels." -&gt; German</code><br>
   <code><span lang="de">Mein Luftkissenfahrzeug ist von den
     Aalen voll.</span></code>
  </p>

  <p>
   <code>"I will not buy this record; it is scratched." -&gt; Spanish</code><br>
   <code><span lang="es">No compraré este expediente;
     se rasguña.</span></code>
  </p>

  <p>
   Nice translation.  All of these are equivalent to calling the same-named
   function:
  </p>

  <p>
   <code>German["My hovercraft is full of eels."]</code><br>
   <code><span lang="de">Mein Luftkissenfahrzeug ist von den
     Aalen voll.</span></code>
  </p>

  <p>
   Or, to translate <em>from</em> another language, use the
   <code>From<i>Language</i></code> conversion, or the appropriate keyword:
  </p>

  <p>
   <code><span lang="es">"Yo quiero un burrito."</span> -&gt;
    FromSpanish</code><br>
   or<br>
   <code><span lang="es">"Yo quiero un burrito." -&gt;
    Ingles</span></code><br> 
   <code>I love a young donkey.</code>
  </p>

  <p>
   (Thanks to Brian C. White discovering the above gem of translation, which
   is literally correct.)  So it's not perfect, and it sure helps if your
   operating system is set up to display Unicode characters correctly.  Or,
   you can do round-trips:
  </p>

  <p>
   <code>"The spirit is willing but the flesh is weak." -&gt;
    Spanish -&gt; <span lang="es">Ingles</span></code><br>
   <code>The alcohol is arranged but the meat is weak.</code>
  </p>

  <p>
   You can also define a function to do the same as the above:
  </p>

  <p>
   <code>corrupt[x] := x -&gt; Spanish -&gt; <span lang="es">Ingles</span></code><br>
   or<br>
   <code>corrupt[x] := Ingles[Spanish[x]]</code><br>
  </p>

  <p>
   You can also build up more complex strings:
  </p>

  <p>
   <code>"The German word for \"dog\" is \"" + German["dog"] + ".\""</code><br>
   <code>The German word for "dog" is "<span lang="de">Hund</span>."</code>
  </p>

  <p>
   And you can use Frink to not just translate the words, but the words and
   the units:
  </p>
  
  <p>
   <code>"My farm is " + (220000 acres -&gt; "hectares") + ",
    but it's not arable land." -&gt; German</code><br>
   <code><span lang="de">Mein Bauernhof ist 89031,19741723355
     Hektars, aber es ist nicht urbares Land.</span></code>
  </p>

  <p>
   <code>"Gasoline costs " + (round[1.37 USD/gallon /
    (EUR/liter), 0.01]) + " Euro/liter in the United States." -&gt; German</code><br>
   <code><span lang="de">Benzin kostet 0,33
     Euro/liter in den Vereinigten Staaten.</span></code>
  </p>

  <p>
   Ooh, that's cool.  If I had this when I lived in Germany, I might have
   seemed semi-literate.
  </p>

  <h3><a name="TranslationPairs">Translation Pairs</a></h3>
  <p>
   The following table summarizes the language pairs that can be translated
   and their keywords.  The <i>default</i> translations use your operating
   system's language setting, which <em>should</em> detect your default
   language and Do The Right Thing most of the time.  When you're translating
   <em>from</em> another language, you need to indicate what the foreign
   language is.  Keywords like <code>Inglese</code> (the Italian word for
   English) imply that you're translating from Italian to English.
  </p>

  <table summary="Language Translation Pairs">
    <tbody><tr><th>From</th><th>To</th><th>Keywords
    </th></tr><tr><td><i>Default</i></td><td>English</td><td>English, en
    </td></tr><tr><td><i>Default</i></td><td>German</td><td>German,
      <span lang="de">Deutsch</span>, de 
    </td></tr><tr><td><i>Default</i></td><td>Spanish</td><td>Spanish,
      <span lang="es">Espanol, Español,</span> es
    </td></tr><tr><td><i>Default</i></td><td>French</td><td>French,
      <span lang="fr">Francais, Français</span>, fr
    </td></tr><tr><td><i>Default</i></td><td>Italian</td><td>Italian,
      <span lang="it">Italiano</span>, it
    </td></tr><tr><td><i>Default</i></td><td>Portuguese</td><td>Portuguese, pt
    </td></tr><tr><td><i>Default</i></td><td>Korean</td><td>Korean, ko
    </td></tr><tr><td><i>Default</i></td><td>Simplified Chinese
     </td><td>SimplifiedChinese, Chinese, zh
    </td></tr><tr><td><i>Default</i></td><td>Traditional Chinese
     </td><td>TraditionalChinese, zt
    </td></tr><tr><td><i>Default</i></td><td>Russian</td><td>Russian, ru
    </td></tr><tr><td><i>Default</i></td><td>Japanese</td><td>Japanese, jp
    </td></tr><tr><td><i>Default</i></td><td>Dutch</td><td>Dutch, Nederlands, nl
    </td></tr><tr><td><i>Default</i></td><td>Swedish</td><td>Swedish, Svenska, sv
    </td></tr><tr><td><i>Default</i></td><td>Arabic</td><td>Arabic, ar
    </td></tr><tr><td><i>Default</i></td><td>Polish</td><td>Polish, pl
    </td></tr><tr><td><i>Default</i></td><td>Greek</td><td>Greek, el

    </td></tr><tr><td>English</td><td><i>Default</i></td><td>FromEnglish, from_en
    </td></tr><tr><td>German</td><td><i>Default</i></td><td>FromGerman, from_de
    </td></tr><tr><td>Spanish</td><td><i>Default</i></td><td>FromSpanish, from_es
    </td></tr><tr><td>French</td><td><i>Default</i></td><td>FromFrench, from_fr
    </td></tr><tr><td>Italian</td><td><i>Default</i></td><td>FromItalian, from_it
    </td></tr><tr><td>Portuguese</td><td><i>Default</i></td><td>FromPortuguese, from_pt
    </td></tr><tr><td>Japanese</td><td><i>Default</i></td><td>FromJapanese, from_ja
    </td></tr><tr><td>Korean</td><td><i>Default</i></td><td>FromKorean, from_ko
    </td></tr><tr><td>Russian</td><td><i>Default</i></td><td>FromRussian, from_ru
    </td></tr><tr><td>Simplified Chinese</td><td><i>Default</i></td><td>FromSimplifiedChinese, FromChinese, from_zh
    </td></tr><tr><td>Traditional Chinese</td><td><i>Default</i>
     </td><td>FromTraditionalChinese, from_zt
    </td></tr><tr><td>Dutch</td><td><i>Default</i></td><td>FromDutch, from_nl
    </td></tr><tr><td>Swedish</td><td><i>Default</i></td><td>FromSwedish, from_sv
    </td></tr><tr><td>Arabic</td><td><i>Default</i></td><td>FromArabic, from_ar
    </td></tr><tr><td>Polish</td><td><i>Default</i></td><td>FromPolish, from_pl
    </td></tr><tr><td>Greek</td><td><i>Default</i></td><td>FromGreek, from_el
      

    </td></tr><tr><td>English</td><td>German</td><td>EnglishToGerman, en_de
    </td></tr><tr><td>English</td><td>Spanish</td><td>EnglishToSpanish, en_es
    </td></tr><tr><td>English</td><td>French</td><td>EnglishToFrench, en_fr
    </td></tr><tr><td>English</td><td>Italian</td><td>EnglishToItalian, en_it
    </td></tr><tr><td>English</td><td>Portuguese</td><td>EnglishToPortuguese, en_pt
    </td></tr><tr><td>English</td><td>Korean</td><td>EnglishToKorean, en_ko
    </td></tr><tr><td>English</td><td>Japanese</td><td>EnglishToJapanese, en_ja
    </td></tr><tr><td>English</td><td>Russian</td><td>EnglishToRussian, en_ru
    </td></tr><tr><td>English</td><td>Simplified Chinese
     </td><td>EnglishToSimplifiedChinese, EnglishtToChinese, en_zh
    </td></tr><tr><td>English</td><td>Traditional Chinese
     </td><td>EnglishToTraditionalChinese, en_zt
    </td></tr><tr><td>English</td><td>Dutch</td><td>EnglishToDutch, en_nl
    </td></tr><tr><td>English</td><td>Swedish</td><td>EnglishToSwedish, en_sv
    </td></tr><tr><td>English</td><td>Arabic</td><td>EnglishToArabic, en_ar
    </td></tr><tr><td>English</td><td>Polish</td><td>EnglishToPolish, en_pl
    </td></tr><tr><td>English</td><td>Greek</td><td>EnglishToGreek, en_el

    </td></tr><tr><td>German</td><td>English</td><td>GermanToEnglish,
      <span lang="de">Englisch</span>, de_en
    </td></tr><tr><td>German</td><td>French</td><td>GermanToFrench,
      <span lang="de">franzoesisch,
       Franzoesisch, französisch, Französisch,</span> de_fr
      
    </td></tr><tr><td>Spanish</td><td>English</td><td>SpanishToEnglish,
      <span lang="es">Inglés, Ingles,</span> es_en
    </td></tr><tr><td>Spanish</td><td>French</td><td>SpanishToFrench,
      <span lang="es">frances, Frances, francés, Francés,</span>
      es_fr
      
    </td></tr><tr><td>French</td><td>English</td><td>FrenchToEnglish,
      <span lang="fr">Anglais,</span> fr_en
    </td></tr><tr><td>French</td><td>German</td><td>FrenchToGerman,
      <span lang="fr">Allemand, allemand,</span> fr_de
    </td></tr><tr><td>French</td><td>Spanish</td><td>FrenchToSpanish,
      <span lang="fr">Espagnol, espagnol,</span> fr_es
    </td></tr><tr><td>French</td><td>Portuguese</td><td>FrenchToPortuguese,
      <span lang="fr">Portugais, portugais,</span>  fr_pt
    </td></tr><tr><td>French</td><td>Italian</td><td>FrenchToItalian,
      <span lang="fr">Italien, italien,</span> fr_it
      
    </td></tr><tr><td>Italian</td><td>English</td><td>ItalianToEnglish,
      <span lang="it">Inglese,</span> it_en
    </td></tr><tr><td>Italian</td><td>French</td><td>ItalianToFrench,
      <span lang="it">Francese, francese,</span> it_fr
      
    </td></tr><tr><td>Portuguese</td><td>English</td><td>PortugueseToEnglish,
      <span lang="pt">Inglês,</span> pt_en
    </td></tr><tr><td>Portuguese</td><td>French</td><td>PortugueseToFrench,
      <span lang="pt">francês, Francês,</span> pt_fr

    </td></tr><tr><td>Japanese</td><td>English</td><td>JapaneseToEnglish, ja_en
    </td></tr><tr><td>Korean</td><td>English</td><td>KoreanToEnglish, ko_en
    </td></tr><tr><td>Russian</td><td>English</td><td>RussianToEnglish, ru_en
    </td></tr><tr><td>Simplified Chinese</td><td>English
     </td><td>SimplifiedChineseToEnglish, ChineseToEnglish, zh_en
    </td></tr><tr><td>Traditional Chinese</td><td>English
     </td><td>TraditionalChineseToEnglish, zt_en
    </td></tr><tr><td>Dutch</td><td>English</td><td>DutchToEnglish,
      <span lang="nl">Engels</span>, nl_en
    </td></tr><tr><td>Swedish</td><td>English</td><td>SwedishToEnglish, <span lang="sv">Engelska, engelska</span>, sv_en
    </td></tr><tr><td>Arabic</td><td>English</td><td>ArabicToEnglish, ar_en
    </td></tr><tr><td>Polish</td><td>English</td><td>PolishToEnglish, pl_en
    </td></tr><tr><td>Greek</td><td>English</td><td>GreekToEnglish, el_en
  </td></tr></tbody></table>

  <h3><a name="GoogleTranslations">Google Translations</a></h3>
  <p>
   As of 2011-12-01, Google has eliminated free access to their translation
   APIs, so they are no longer available through Frink.
  </p>
  
  <h3><a name="TranslatorProgram">Translator Program</a></h3>
  <p>
   Here's a small program that can be used to make a mini-translator for a
   specific language.  It allows you to enter phrases to be translated without
   entering the quotes and other bits.  It will continue to translate phrases
   until you click the "OK" button without entering a phrase, or until you
   cancel the dialog using your windowing system's methods.  (See <a href="#MakingInteractiveInterfaces">Making Interactive Interfaces</a> for
   more details.)
  </p>

  <p>
   <code>while phrase=input["Enter phrase in Portuguese: "]<br>
    &nbsp;&nbsp;&nbsp;println[phrase -&gt; FromPortuguese]</code>
  </p>

  <h2><a name="ParsingJSON">Parsing JSON</a></h2>
  <p>
   Even though <a href="http://www.json.org/" target="_blank">JSON</a>
   (JavaScript Object Notation) is a terrible standard based on an even more
   terrible language, (JavaScript doesn't even have <em>integers</em>, if
   you can believe that,) you can still parse it easily in Frink.
  </p>

  <p>
   <code>parseJSON[<i>string</i>]</code> will parse a JSON document and return
   it as a Frink datatype.  Objects are converted to a Frink <code>dict</code>
   with the keys stored as strings.  The <code>null</code> type is converted
   to <code>undef</code>.
  </p>

  <h3><a name="Bitcoin">Bitcoin</a></h3>  
  <p>
   As a demonstration of JSON parsing, the following example reads from a
   remote URL which returns a JSON document, making the current value of
   Bitcoin into a globally-accessible Frink unit according to the CoinDesk
   Bitcoin Index (Powered by <a href="http://www.coindesk.com/price/" target="_blank">CoinDesk</a>).  See the <a href="http://www.coindesk.com/api/" target="_blank">CoinDesk API</a> for
   information about the various data sources available.
  </p>

  <p>
   Note that the following program is essentially a one-line program that
   parses a JSON document and extracts its data with correct units of measure
   in the result.
  </p>

  <p>
   <code>
    bitcoin&nbsp;:=&nbsp;parseJSON[read["http://api.coindesk.com/v1/bpi/currentprice/USD.json"]]@"bpi"@"USD"@"rate_float"&nbsp;USD<p>
    
    BTC := bitcoin  <code>// Add a common alias</code></p><p>
    
    XBT := bitcoin  <code>// Add a ISO-4217-compatible alias</code></p><p>
    
    satoshi := 1e-8 bitcoin
   </p></code>
  </p>

  <p>
   The value of a certain number of Bitcoins can be then converted like any
   other currency.
  </p>

  <p>
   <code>0.1 bitcoin</code><br>
   <code>63.29625 dollar (currency)</code><br>
  </p>

  <p>
   Or, you can convert in the reverse direction, for example, if you want to
   pay someone 10 Euro:
  </p>

  <p>
   <code>10 Euro -&gt; bitcoin</code><br>
   <code>0.02189559</code><br>
  </p>
  

  <p>
   This code is available, with more comments, in the <a href="https://frinklang.org/fsp/colorize.fsp?f=bitcoin.frink">bitcoin.frink</a> sample program.
  </p>

  <p>
   Also, if this is useful to you, you can pay me in Bitcoin at the address: <code>1dersa3eR2tXQATLCqTrqQ84aecpQBVmm</code>

  </p><h2><a name="DateTimeHandling">Date/Time Handling</a></h2>
  <p>
   Frink has the ability to define specific points in time and add time
   intervals to them, to convert between timezones, or to subtract dates from
   each other.  Date literals are surrounded by pound signs (<code>#</code>)
   and can be entered in a wide variety of formats, but I prefer a format like:
  </p>

  <p>
   <code># yyyy-MM-dd HH:mm:ss #</code>
  </p>

  <p>
   Note that I've chosen to have most-significant digits first, as is only
   logical (the world will realize this someday.) You can have whitespace
   preceding or following the # signs for readability.  All of the predefined
   formats are defined in
   <a href="https://frinklang.org/frinkdata/dateformats.txt"><code>/data/dateformats.txt</code></a>.
   Check that file first to see the formats that are already defined.  If the
   format you want is not there, see below for ways to define your own
   formats.
  </p>

  <p>
   You can also parse a string into a date using the
   <code>parseDate[<i>string</i>]</code> function.  This returns the string
   parsed into a date/time datatype, or returns <code>undef</code> if the
   string cannot be parsed as a date using any of the defined date formats.
  </p>

  <h3><a name="SpecifyingTimezones">Specifying Timezones</a></h3>
  <p>
   All date/time formats also allow a timezone specifier at the end.  This
   timezone specifier can be a 3-letter code like "UTC" or "MST", but you can
   also use the name of a country or U.S. state (if the country or state has a
   single time zone) or a selected city (of course, not all cities are
   available.)  This means that you don't have to know when daylight savings
   time starts and ends.  The names are chosen from the globally-used Olson
   timezone database, and Frink allows shortening of the Olson timezones, say,
   from "Europe/Paris" to simply "Paris".  The following are all valid inputs:
  </p>

  <p>
   <code># 2002-01-03 10:00 AM New York #</code><br>
   <code># 2002-01-03 10:00 AM Colorado #</code><br>
   <code># 2002-01-03 10:00 AM US/Mountain #</code><br>
   <code># 2002-01-03 10:00 AM Eastern #</code><br>
   <code># 2002-01-03 10:00 AM Hawaii #</code><br>
   <code># 2002-01-03 10:00 AM America/New_York #</code><br>
   <code># 2002-01-03 10:00 AM France #</code><br>
   <code># 2002-01-03 10:00 AM Paris #</code><br>
   <code># 2002-01-03 10:00 AM Europe/Paris #</code>
  </p>

  <p>
   If you do <em>not</em> specify a timezone, the timezone used will be the
   timezone obtained from your Java Virtual Machine (which is probably the
   timezone set on <em>your</em> computer.)
  </p>

  <h4><a name="CustomTimezones">Custom Timezones</a></h4>
  <p>
   While the Olson timezone database is very complete, and has named rules for
   basically all official timezones in the world, sometimes your data source
   only tells you the offset from UTC or GMT, or may even have custom offsets
   in minutes.  If this is the case, the timezone offset from UTC can be
   specified in one of the following formats:
  </p>

  <ul>
   <li>+0700
   </li><li>-0700
   </li><li>+07:00
   </li><li>-07:00
   </li><li>GMT+0700
   </li><li>GMT-0700
   </li><li>GMT+07:00
   </li><li>GMT-07:00
  </li></ul>

  <p>
   (Please note that, due to the plus and minus symbols, these timezone
   specification must be in double quotes on the right-hand-side of
   the <code>-&gt;</code> operator:)
  </p>

  <p>
   <code># August 25, 2019 16:00 # -&gt; "GMT+07:00"</code>
  </p>

  <p>
   So, for example, if your data source is in the ISO-8601 format that doesn't
   allow you to use named timezones (it only allows only numbered timezones or
   the letter <code>Z</code>) and looks like:
  </p>

  <p>
   <code>2014-06-02T02:24:10-06:00</code>
  </p>

  <p>
   Then Frink will parse the trailing <code>-06:00</code> as a timezone
   specification.  (Again, see all the date formats that Frink parses by
   default in the <a href="https://frinklang.org/frinkdata/dateformats.txt"><code>/dateformats.txt</code></a> file.)
  </p>

  <p>
   The trailing <code>Z</code> (for "Zulu time", an alias for UTC,) in the
   following ISO-8601 format indicates that the time is in UTC.
  </p>

  <p>
   <code>2014-06-02T02:24:10Z</code>
  </p>

  <h4><a name="TimezoneWarning">Timezone Warning</a></h4>
  <p>
   <b>Warning:</b> The Olson timezone database and the POSIX standard (and the
   Java Virtual Machine) define timezones called something like
   <code>Etc/GMT+7</code> (or, using Frink's shorter notation,
   <code>GMT+7</code>), but you must be <em>most strongly warned</em> that the
   sign convention of these zones is <em>opposite</em> of what any rational
   person would choose, and <em>opposite</em> of the other sign conventions in
   Frink!  In the Olson/POSIX/Java world, <code>GMT-7</code> is actually 7
   hours <em>ahead/east</em> of GMT.  Yes, in that weird world,
   <code>GMT-7</code> means GMT <em>plus</em> seven hours.  Augh.  (And you
   wonder why all of my documentation is full of diatribes against the
   stupidity of almost every major standard.)
  </p>

  <p>
   This is a horrible, insane convention and it <em>will</em> bite you or the
   people you try to communicate with (unless you both accidentally share the
   same random form of insanity and wrongness.)  They will think you are crazy
   if you follow this convention.  Yet it's the convention used by a large
   fraction of the world's software, so Frink keeps these timezones around
   (for now) in case you have to communicate with other software that uses the
   insane Olson/POSIX conventions.  But <em>do not</em> use these conventions
   otherwise.
  </p>

  <p>
   The 4-digit timezone formats listed in the <a href="#CustomTimezones">Custom Timezones</a> section above use correct and
   rational definitions of these sign conventions.  If you are using custom
   timezones, you are most strongly warned to use the 4-digit versions like
   <code>GMT+0200</code> or <code>GMT+12:00</code>.  These will be correct.
   <code>GMT+0200</code> will mean GMT <em>plus</em> 2 hours.  But don't
   confuse these 4-digit versions with the shorter 1- or 2-digit
   Olson/POSIX/Java versions like <code>GMT+2</code> or <code>GMT+12</code> or
   <code>Etc/GMT+2</code> which should be considered weird and wrong (unless
   you're communicating with a source that produces these timezone names
   according to the weird and wrong Olson/POSIX/Java rules.  For now, Frink
   will let you use those weird conventions, but it will scowl and furrow its
   brow at you and someday in the future it may not allow them at all.  I might
   completely disallow the shorter versions of these timezone names
   (<i>i.e.</i> reject <code>GMT+7</code> while still allowing the more
   foolhardy <code>Etc/GMT+7</code>)
  </p>

  <h3><a name="ListingTimezones">Listing Timezones</a></h3>
  <p>
   The function <code>timezones[]</code> will return an enumeration of all
   known time zone names.
  </p>

  <p>
   Please note that your Java implementation may not
   have all of the timezones named in these examples.  Notably, Java 1.1
   distributions tended to use only a small number of three-letter timezones,
   like <code>JST</code>.
  </p>

  <p>
   The function <code>timezones[<i>pattern</i>]</code> with one argument will
   return all timezone names that match the specified pattern.  The pattern
   can be anything matched by the <a href="#select">select</a> function: that
   is, a function (that returns <code>true</code> for matches,) a regular
   expression, or an exact substring.  The following returns all the names of
   all timezones that contain the exact string <code>"Central"</code>:
  </p>

  <p>
   <code>timezones["Central"]</code><br>
   <code>[Canada/Central, Central, Central_African_Republic, Central African Republic, US/Central]</code>
  </p>

  <p>
   The following example will return the timezones that contain the specified
   string "Den" with a case-insensitive match, using the <a href="#select"><code>select</code></a> function and a <a href="#RegularExpressions">regular expression</a>.
  </p>

  <p>
   <code>select[timezones[], %r/Den/i]</code><br>
   <code>[Aden, Sweden, Denver, America/Denver, Asia/Aden, Brazil/DeNoronha, Denmark, DeNoronha]</code>
  </p>

  <p>
   The function <code>timezone[]</code> with no arguments will return the name
   of the default timezone.
  </p>
  
  <!-- Let's consider this not working. 
  <H3><A NAME="SettingDefaultTimezone">Setting Default Timezone</A></H3>
  <P>
   By default, Frink displays and parses all dates using the timezone
   specified by your operating system, unless the date string being parsed
   contains an explicit timezone (see <A HREF="#SpecifyingTimezones">
   "Specifying Timezones"</A> section above,) or if the output format contains 
   an explicit timezone name (see <A HREF="#TimezoneConversions">"Timezone
   Conversions"</A> section.)
  </P>

  <P>
   You can change the default timezone (used for parsing <EM>and</EM> output)
   by calling the function:
  </P>
  
  <P CLASS="code">
   <CODE CLASS="input">setDefaultTimezone[<I>tzstring</I>]</CODE>
  </P>

  <P>
   where <CODE><I>tzstring</I></CODE> is the name of a timezone that Frink
   recognizes.  If the timezone name is not recognized, an error will be
   displayed and the default timezone will be unchanged.  For example, if you
   want all times to be parsed and displayed as if they were in Universal
   Coordinated Time (unless an explicit timezone identifier is given,) you can
   call:
  </P>

  <P CLASS="code">
   <CODE CLASS="input">setDefaultTimezone["UTC"]</CODE>
  </P>
  -->

  <h3><a name="SloppyTimeSpecifications">Sloppy Time Specifications</a></h3>
  <p>
   If you don't specify an exact date, the date will be treated roughly as
   "today."  This is useful for getting a quick-and-dirty timezone conversion,
   but if you want to get the day right, you should specify the date as above.
  </p>

  <p>
   Conversion to local timezone, assuming today:<br>
   <code># 6:00 PM Bosnia #</code><br>
   <code>AD 2002-01-06 10:00:00.000 AM (Sun) Mountain Standard
    Time</code>
  </p>

  <p>
   Conversion of local time to another timezone:<br>
   <code># 6:00 PM # -&gt; Japan</code><br>
   <code>AD 2002-01-07 10:00:00.000 AM (Mon) Japan Standard
    Time</code>
  </p>
   
  <p>
   Conversion between arbitrary timezones:<br>
   <code># 6:00 PM Bosnia # -&gt; "New York"</code><br>
   <code>AD 2002-01-06 12:00:00.000 PM (Sun) Eastern Standard
    Time</code>
  </p>

  <p>
   Note that running the above simplified conversions at different times of
   the year will give you different results because of differences in the
   Daylight Savings Time rules for each country.
  </p>
  
  <p>
   Also, please note that your Java implementation may not
   have all of the timezones named in these examples.  Notably, Java 1.1
   distributions tended to use only a small number of three-letter timezones,
   like <code>JST</code>.  Use the <a href="#ListingTimezones"><code>timezones[]</code></a> function to list the
   timezones defined on your system.
  </p>
  
  <h3><a name="CurrentTime">Current Time</a></h3>
  <p>
   The function <code>now[]</code> will return the current
   date/time.
  </p>
  
  <p>
   In an interactive session, you can use the string <code>##</code> as shorthand for "now."  This should evaluate to
   the time at which the value was <em>parsed</em>, which is why it won't
   usually do what you intend in a program... the value would be the time the
   program was originally run and parsed.
  </p>

  <p>
   Time is only as accurate as your computer's clock
   setting.  (I use <a href="http://www.atomtime.com/">AtomTime</a> on Windows
   machines to keep the clock synchronized to the atomic clock.)
  </p>


  <h3><a name="TimezoneConversions">Timezone Conversions</a></h3>
  <p>
   By default, times are displayed in the local timezone and using your locale
   information (but are internally stored correctly in Julian Day relative to
   Universal Time.)  You can also convert to another time format by specifying
   it after the arrow operator.  "JD" for Julian Day, "JDE" for Julian Day
   (Ephemeris) referenced to Dynamical Time, "MJD" for Modified
   Julian Day are supported, as well as finding the times in selected
   timezones, cities and countries:
  </p>

  <p>Example: <i>Sky &amp; Telescope</i> predicted 
   that the peak of this year's Perseid meteor shower might be around August
   12, 2001 at 0400 UTC:
  </p>

  <p>Converting to local time (the default behavior:)<br>
   <code># 2001-08-12 04:00 UTC #</code><br>
   <code>AD 2001-08-11 10:00:00.000 PM (Sat) Mountain Daylight Time</code>
  </p>

  <p>Converting to another time zone:<br>
   <code># 2001-08-12 04:00 UTC # -&gt; Japan</code><br>
   <code>AD 2001-08-12 01:00:00.000 PM (Sun) Japan Standard Time</code>
  </p>

  <p>
   Current time in Germany:<br>
   <code>now[] -&gt; Germany</code><br>
   <code>AD 2001-12-28 07:20:01.508 AM (Fri) Central European Time</code><br>
  </p>

  <p>
   Current time in another state that just has a single timezone:<br>
   <code>now[] -&gt; Hawaii</code><br>
   <code>AD 2010-12-28 07:20:01.508 AM (Fri) Hawaii Standard Time</code><br>
  </p>

  <p>
   Current Julian Day:<br>
   <code>now[] -&gt; JD</code><br>
   <code>JD 2452824.5679731136</code><br>
  </p>

  <p>
   Current Julian Day Ephemeris:<br>
   <code>now[] -&gt; JDE</code><br>
   <code>JD 2452824.578919213</code><br>
  </p>

  <p>
   Convert Julian Day Ephemeris to a date:<br>
   <code>JDE[2451545.0]</code><br>
   <code>AD 2000-01-01 04:58:56.170 AM (Sat) Mountain Standard Time</code>
  </p>

  <p>
   Actually, since 2003-06-12, Frink uses full precision (usually rational
   numbers) when storing dates, so the Julian day may come out as a rational
   number like:
  </p>

  <p>
   <code>JD 211924042672877/86400000 (approx. 2452824.5679731136)</code>
  </p>

  <p>
   If you don't desire this much precision, you can use the
   <code>JD[<i>date</i>]</code> or <code>MJD[<i>date</i>]</code> function and
   divide by <code>1.0 days</code> to get the Julian date as a
   floating-point number, not a string or a rational number:
  </p>

  <p>
   <code>JD[now[]] / (1.0 days)</code><br>
   <code>2452824.5679731136</code>
  </p>

  <h3><a name="DateTimeArithmetic">Date/Time Arithmetic</a></h3>
  <p>
   You can subtract one date from another, or add/subtract a time interval to
   a date.  So, if I wanted to find out when I was 1 billion seconds old, I
   add it to my birthdate:
  </p>

  <p>
   <code>#1969-08-19 16:54 Mountain# + 1 billion seconds</code><br>
   <code>AD 2001-04-27 06:40:40.000 PM (Fri) Mountain Daylight Time</code>
  </p>

  <p>
   That was pretty recently.  You not only forgot my birthday but you forgot
   my 1-billion-second-anniversary.  Bastard.  I have a 
   <a href="https://www.amazon.com/exec/obidos/wishlist/1HBWTNB5L6H3J/ref=wl_em_to?add-fav=1">wish list</a> at Amazon.com if you still want to buy me something.
  </p>

  <p>
   <b>Note:</b> You may notice that adding units of months or years (or
   commonyear, etc.)  may not give you the results you expect--that is because
   months and years are <em>not</em> fixed-size units, and even having a unit
   called "month" or "year" is inherently ill-advised.  Perhaps later there
   will be "increment/decrement" of these individual fields on Date objects,
   but it's better to make sure that you understand these are <em>also</em>
   inherently troublesome and often meaningless operations.  (<i>e.g.</i> what
   does it mean to increment the month on a date representing Jan. 31?)  Use
   fixed-size units if you can.
  </p>

  <p>
   You can subtract one date from another, and receive an answer as a Unit
   with dimensions of time (that you can convert to any scale you
   want... you're used to this by now.)  For example, if you want to know how
   many days until Christmas:
  </p>

  <p>
   <code>#2002-12-25# - now[] -&gt; days</code><br>
   <code>105.70975056709</code>
  </p>

  <p>
   (Try inverting the above calculation to see exactly when I wrote this!)
  </p>

  <p>
   Note that these calculations do not take leap seconds into account by
   default.  If you want these calculations to take leap seconds into account,
   see the <a href="#LeapSeconds">Leap Seconds</a> section of the
   documentation.
  </p>

  <h3><a name="CalendarFunctions">Calendar Functions</a></h3>
  <p>
   The human-defined Gregorian (and Julian) calendars are full of weirdnesses
   and inconsistencies.
  </p>
  
  <p>
   However, sometimes you still need to iterate through these varying-length
   units.  Frink gives a variety of functions to manipulate calendar dates.
   The functions are intentionally chosen to be functions that make sense, and
   Frink tries to avoid providing functions that don't make sense (for
   example, some date/time libraries let you take a date like January 31, 2019
   and increment the month field.  Since there is no Feburary 31, the results
   simply don't and can't make any sense.)
  </p>

  <p>
   Note that these functions will sometimes produce surprising (but
   consistent) results!  Years and months are of varying length.  Some years
   are longer than others by a day (because of leap days.)  Some years are
   longer than others by a second (because of leap seconds).  Some days or
   months are longer or shorter than others depending on your Daylight Saving
   / Summer Time rules!  For example, in the "US/Mountain" timezone, the month
   of March, 2019 is only 30 days, 23 hours long, not 31 days!  Similarly,
   November, 2019 is 31 days, 1 hour long!  In another timezone, it may be
   exactly 31 days!  Some days are 25 hours long, while others are 23 hours
   long!  Yay calendars!
  </p>
  
  <table summary="Calendar Functions">
    <tbody><tr><th>Function</th><th>Description
    </th></tr><tr><td>beginPlusOffset[<i>date</i>, <i>field</i>, <i>offset=0</i>, <i>timezone=undef</i>]
     </td><td>Returns a date/time corresponding to the beginning of the specific
      timestep (e.g. year, month, day, hour, minute, second, millisecond) and
      (optionally) allows you to increment or decrement that timestep by an
      integer amount.  The parameters are:

      <ul>
       <li><code>date</code>:  A date/time indicating an instance in time.
        
       </li><li><code>field</code>: One of the constants in Calendar.fields that
        indicates which field we're going to increment.  This is limited to
        the following: Calendar.YEAR, Calendar.MONTH, Calendar.DAY_OF_MONTH,
        Calendar.HOUR_OF_DAY, Calendar.MINUTE, Calendar.SECOND,
        Calendar.MILLISECOND.  This field also controls the timestep we're
        finding the beginning of.  For example, if called with Calendar.YEAR,
        the initial time calculated will be the beginning of the calendar year
        that contains <code>date</code>.  The field constants can be obtained
        by something like:

        <p>
         <code>staticJava["java.util.Calendar", "MONTH"]</code>
        </p>

        </li><li><code>offset</code> An integer to offset the specified field by.
         This may be positive, negative, or zero, but it must fit into a
         signed 32-bit int due to restrictions in the Java API.

         <p>
          For example,
          if <code>field</code> is <code>Calendar.YEAR</code> and 
          <code>offset</code> is <code>0</code>, this function returns a
          date/time corresponding to the beginning of the calendar year that
          contains <code>date</code>.
         </p>

         <p>
          If <code>offset</code> is <code>1</code>, this function returns
          a date/time corresponding to the beginning of the <em>next</em>
          calendar year after the year that contains <code>date</code>.
          Similarly, if <code>offset</code> is <code>-1</code>, this returns
          the beginning of the <em>previous</em> year.
         </p>

        </li><li><code>tz</code>: A string indicating the timezone of the result.
         If this is the special/default value <code>undef</code>, we use the
         system's default <a href="#SpecifyingTimezones">timezone</a>.
      </li></ul>

      <p>
       This is a highly general function.  There are some convenience
       functions for common cases listed below.
      </p>

     </td></tr><tr>
       <td>
        beginningOfYearPlus[<i>date</i>,<i>offset</i>,<i>timezone=undef</i>]<br>
        beginningOfMonthPlus[<i>date</i>,<i>offset</i>,<i>timezone=undef</i>]<br>
        beginningOfDayPlus[<i>date</i>,<i>offset</i>,<i>timezone=undef</i>]<br>
        beginningOfHourPlus[<i>date</i>,<i>offset</i>,<i>timezone=undef</i>]<br>
        beginningOfMinutePlus[<i>date</i>,<i>offset</i>,<i>timezone=undef</i>]<br>
        beginningOfSecondPlus[<i>date</i>,<i>offset</i>,<i>timezone=undef</i>]<br>
        beginningOfMillisecondPlus[<i>date</i>,<i>offset</i>,<i>timezone=undef</i>]
        
      </td><td>These are convenience methods for the <code>beginPlusOffset</code>
        function above.  Returns a date/time corresponding to the beginning of
        the specific timestep (e.g. year, month, day, hour, minute, second,
        millisecond) and (optionally) allows you to increment or decrement
        that timestep by an integer amount.  The parameters are:

      <ul>
       <li><code>date</code>:  A date/time indicating an instance in time.

       </li><li><code>offset</code> An integer to offset the specified field by.
        This may be positive, negative, or zero, but it must fit into a
        signed 32-bit int due to restrictions in the Java API.

        <p>
         For example,
         if <code>field</code> is <code>Calendar.YEAR</code> and 
         <code>offset</code> is <code>0</code>, this function returns a
         date/time corresponding to the beginning of the calendar year that
         contains <code>date</code>.
        </p>

        <p>
         If <code>offset</code> is <code>1</code>, this function returns
         a date/time corresponding to the beginning of the <em>next</em>
         calendar year after the year that contains <code>date</code>.
         Similarly, if <code>offset</code> is <code>-1</code>, this returns
         the beginning of the <em>previous</em> year.
        </p>

        </li><li><code>tz</code>: A string indicating the timezone of the result.
         If this is the special/default value <code>undef</code>, we use the
         system's default <a href="#SpecifyingTimezones">timezone</a>.
      </li></ul>
      </td></tr><tr>
       <td>
        beginningOfYear[<i>date</i>,<i>timezone=undef</i>]<br>
        beginningOfMonth[<i>date</i>,<i>timezone=undef</i>]<br>
        beginningOfDay[<i>date</i>,<i>timezone=undef</i>]<br>
        beginningOfHour[<i>date</i>,<i>timezone=undef</i>]<br>
        beginningOfMinute[<i>date</i>,<i>timezone=undef</i>]<br>
        beginningOfSecond[<i>date</i>,<i>timezone=undef</i>]<br>
        beginningOfMillisecond[<i>date</i>,<i>timezone=undef</i>]<br>
       </td><td>Returns the beginning of the timestep
        containing <code>date</code>, e.g. the beginning of the year or month.
        The <a href="#SpecifyingTimezones">timezone</a> should be a string.
        If the timezone contains the special/default value <code>undef</code>,
        this uses the system's default timezone.

      </td></tr><tr>
       <td>
        beginningOfNextYear[<i>date</i>,<i>timezone=undef</i>]<br>
        beginningOfNextMonth[<i>date</i>,<i>timezone=undef</i>]<br>
        beginningOfNextDay[<i>date</i>,<i>timezone=undef</i>]<br>
        beginningOfNextHour[<i>date</i>,<i>timezone=undef</i>]<br>
        beginningOfNextMinute[<i>date</i>,<i>timezone=undef</i>]<br>
        beginningOfNextSecond[<i>date</i>,<i>timezone=undef</i>]<br>
        beginningOfNextMillisecond[<i>date</i>,<i>timezone=undef</i>]<br>
       </td><td>Returns the beginning of the <em>next</em> timestep
        containing <code>date</code>, e.g. the beginning of the next year or
        month.  The <a href="#SpecifyingTimezones">timezone</a> should be a
        string.  If the timezone contains the special/default
        value <code>undef</code>, this uses the system's default timezone.

     </td></tr><tr>
       <td>
        beginningOfPreviousYear[<i>date</i>,<i>timezone=undef</i>]<br>
        beginningOfPreviousMonth[<i>date</i>,<i>timezone=undef</i>]<br>
        beginningOfPreviousDay[<i>date</i>,<i>timezone=undef</i>]<br>
        beginningOfPreviousHour[<i>date</i>,<i>timezone=undef</i>]<br>
        beginningOfPreviousMinute[<i>date</i>,<i>timezone=undef</i>]<br>
        beginningOfPreviousSecond[<i>date</i>,<i>timezone=undef</i>]<br>
        beginningOfPreviousMillisecond[<i>date</i>,<i>timezone=undef</i>]<br>
       </td><td>Returns the beginning of the <em>previous</em> timestep
        containing <code>date</code>, e.g. the beginning of the previous year or
        month.  The <a href="#SpecifyingTimezones">timezone</a> should be a
        string.  If the timezone contains the special/default
        value <code>undef</code>, this uses the system's default timezone.
        
     </td></tr><tr>
      <td>
       lengthOfYear[<i>date</i>,<i>timezone=undef</i>]<br>
       lengthOfMonth[<i>date</i>,<i>timezone=undef</i>]<br>
       lengthOfDay[<i>date</i>,<i>timezone=undef</i>]
      </td><td>Returns the length of the (year, month, or day)
       containing <code>date</code>.  This function does not correct for leap
       seconds, but see the functions below if you need this.
       The <a href="#SpecifyingTimezones">timezone</a> should be a string.
       If the timezone contains the special/default value <code>undef</code>,
       this uses the system's default timezone.

       <p>
        The result is a unit with dimensions of time that can be added to
        dates, divided into days, hours, minutes, seconds, etc.
       </p>

       <p>
        Note that this may produce surprising results!  Under some timezone
        rules, some days (and months) may be an hour longer or shorter than
        you expect due to Daylight Saving / Summer Time rules!  For example,
        in most US timezones, March is one hour shorter than 31 days because
        the clocks are set forward one hour (at 2:00 AM on the second Sunday
        of March)!  In other timezones, (like UTC) this shift may not
        occur.  Handling the varying lengths is necessary for consistency in
        date/time math.
       </p>
       
       <p>
        The following demonstrates the calendar correction due to Daylight
        Saving time in March, 2019 in the US/Mountain timezone.
       </p>

       <p>
        <code>lengthOfMonth[#2019-03 US/Mountain#, "US/Mountain"] -&gt; ["days","hours"]</code><br>
        <code>30 days, 23 hours</code>
       </p>
       
     </td></tr><tr>
      <td>
       lengthOfYearLeap[<i>date</i>,<i>timezone=undef</i>]<br>
       lengthOfMonthLeap[<i>date</i>,<i>timezone=undef</i>]<br>
       lengthOfDayLeap[<i>date</i>,<i>timezone=undef</i>]
      </td><td>Returns the length of the (year, month, or day)
       containing <code>date</code>.  These functions are identical to the
       functions above with the exception that they <em>do correct for
        leap seconds.</em>

       <p>
        The following demonstrates the leap second added at the end of 2016
        (which was also a leap year):
       </p>

       <p>
        <code>lengthOfYearLeap[#2016#] -&gt; ["days","hours","min","sec"]</code><br>
        <code>366 days, 0 hours, 0 min, 1 sec</code>
       </p>
  </td></tr></tbody></table>

  <p>
   The following sample demonstrates iterating through the beginning of
   months, starting from the beginning of "this year" (for any value of "this
   year") and continuing to the end of "next year".
  </p>

  <p>
   <code>date = beginningOfYear[now[]]<br>
    enddate = beginningOfYearPlus[date, 2]<p>
    
    while (date &lt; enddate)<br>
    {<br>
&nbsp;&nbsp;&nbsp;println[date]<br>
&nbsp;&nbsp;&nbsp;date = beginningOfNextMonth[date]<br>
    }
   </p></code>                 
  </p>

  <p>
   Lest you think this is simpler than it is, these functions also handle
   historical transformations like the switch between the Julian and Gregorian
   calendar in the year 1582 in which 10 days were removed from the calendar
   (but we kept the days of the week.)
  </p>

  <p>
   <code>a = #1582-10#<br>
    b = beginningOfNextMonth[a]<p>
    
    while (a &lt; b)<br>
&nbsp;&nbsp;&nbsp;println[a = beginningOfNextDay[a] -&gt; ###yyyy-MM-dd EEE###]</p></code>
  </p>

  <p>
   <code>
    1582-10-02 Tue<br>
    1582-10-03 Wed<br>
    1582-10-04 Thu<br>
    <b>&nbsp;&nbsp;(Note the 10 day calendar offset which Frink handles correctly)</b><br>
    1582-10-15 Fri<br>
    1582-10-16 Sat<br>
    1582-10-17 Sun<br>
    ...
   </code>
  </p>
 
  
  <h3><a name="NotesOnDates">Notes on Dates</a></h3>
  <p>
   <b>Note:</b>  The following notes apply to Frink release 2008-08-02 and
   later.  Previous releases may have handled the transition between Julian
   and Gregorian dates and large BC years inconsistently.
  </p>

  <ul>
   <li>Frink models the switch between the Julian and Gregorian calendars.
    This switch occurs between October 4, 1582 (Julian) which
    was followed immediately by October 15, 1582 (Gregorian).  However, you
    should be warned that many countries observed the switch from the Julian
    to the Gregorian calendar in later years. (As late as 1918 in Russia, or
    1923 for Greece.)  When reviewing historical dates, you need to verify and
    double-check your author's assumptions about dates and calendar systems.

   </li><li>Dates prior to this switch date are parsed and displayed as their dates
    in the Julian calendar.

   </li><li>Frink follows Julian leap year rules before the switch date (all years
    divisible by 4 are leap years) and Gregorian leap year rules after the
    switch (if a year is divisible by 100, it is only a leap year if it is
    also divisible by 400.  Otherwise, all other years divisible by 4 are leap
    years.)

   </li><li>Parsing a date between the switch dates will result in undefined
    behavior.

   </li><li>Julian date <code># AD 0001-01-01 #</code> (Julian) was preceded
    immediately by <code># BC 0001-12-31 #</code> (Julian).  There is no year
    0, and negative years are intentionally disallowed when parsing, as they
    are often treated inconsistently by authors and scholars.  Again, if you
    encounter a negative year in a publication, you need to examine your
    author's assumptions about years before AD 0001.
  </li></ul>

  <h2><a name="DefiningNewDateTimeFormats">Defining New Date/Time Formats</a></h2>
  <p>
   If you want to enter date/time values in a specific format, you can enter
   new date formats on the fly.  Date formats are enclosed between sets of 3
   pound signs: <code>###<i>pattern</i>###</code>.  After defining a new
   pattern, dates between pound signs should be recognized.  For readability,
   you may have leading or trailing space in your formats or dates.  For
   example:
  </p>

  <p>
   <code>### yyyy-MM-dd ###</code><br>
   <code>#2001-09-10#</code><br>
   <code>Sep 10, 2001 12:00:00 AM</code>
  </p>

  <p>
   You can also define the default <em>output</em> format with 4 pound signs.
   Without a definition in the <a href="https://frinklang.org/frinkdata/dateformats.txt">dateformats.txt</a> file, you get the
   Java default (which should theoretically get it from your system's
   settings, or mine if you're using the web interface,) but for lots of info,
   try something like:
  </p>

  <p>
   <code>#### G yyyy-MM-dd hh:mm:ss.SSS a (E) zzzz ####</code>
  </p>

  <p>
   Date format expressions can be assigned to variables and/or used on the
   right-hand side of a conversion operator ( <code>-&gt;</code> ).  To output
   a date in a specified format, use something like:
  </p>

  <p>
   <code>fmt = ### HH:mm ###<br>
    now[] -&gt; fmt</code><br>
   <code>23:55</code>
  </p>

  <p>
   If you want to format a date with both a specific format and a timezone,
   make the right-hand-side of the conversion operator into a 2-argument
   bracketed list with the first argument indicating the date format and the
   second a <em>string</em> indicating the timezone name:
  </p>

  <p>
   <code>fmt = ### yyyy-MM-dd hh:mm a (E) zzzz ###<br>
    # 2003-06-12 02:25 PM Mountain # -&gt; [fmt, "Japan"]</code><br>
   <code>2003-06-13 05:25 AM (Fri) Japan Standard Time</code>
  </p>

  <p>
   In these patterns, all ASCII letters are reserved as pattern letters,
   which are defined as the following:
  </p>

  <table summary="Date format patterns">
    <tbody><tr>
     <th>Symbol</th><th>Meaning               </th><th>Presentation      </th><th>Example
    </th></tr><tr><td>G</td><td>era designator    </td><td>Text              </td><td>AD
    </td></tr><tr><td>y</td><td>year              </td><td>Number            </td><td>1996
      <i>(Please don't use 2-digit years.  It's just wrong.  Always
       use <code>yyyy</code>. This will still work for years like 12 AD.  Fix
       your data source if you can.)</i>
    </td></tr><tr><td>M</td><td>month in year     </td><td>Text &amp; Number
     </td><td>July &amp; 07 <i>(See below.  3 or more: use text, otherwise use
       number.)</i> 
    </td></tr><tr><td>d</td><td>day in month      </td><td>Number            </td><td>10
    </td></tr><tr><td>h</td><td>hour in am/pm (1-12)  </td><td>Number        </td><td>12
    </td></tr><tr><td>K</td><td>hour in am/pm (0-11)  </td><td>Number        </td><td>0
    </td></tr><tr><td>H</td><td>hour in day (0-23)</td><td>Number            </td><td>0
    </td></tr><tr><td>k</td><td>hour in day (1-24)</td><td>Number            </td><td>24
    </td></tr><tr><td>m</td><td>minute in hour    </td><td>Number            </td><td>30
    </td></tr><tr><td>s</td><td>second in minute  </td><td>Number            </td><td>55
    </td></tr><tr><td>S</td><td>millisecond       </td><td>Number            </td><td>978
      <p><b>Warning:</b>  Due to bugs/features in Java's
       java.date.SimpleDateParser class, you should only use a single
       <code>S</code> in patterns, (which will match up to 3 digits) 
       because if you have an <code>".SSS"</code> specifier but just pass,
       say, <code>".3"</code> for the milliseconds, Java will parse that as
       <code>".003"</code> for some insane reason!
      </p>
    </td></tr><tr><td>E</td><td>day name in week  </td><td>Text             </td><td>Tuesday
    </td></tr><tr><td>u</td><td>day number in week (1=Monday, ... 7=Sunday)</td><td>Number </td><td>1
    </td></tr><tr><td>D</td><td>day in year       </td><td>Number            </td><td>189
    </td></tr><tr><td>F</td><td>day of week in month </td><td>Number         </td><td>2 (2nd Wed in July)
    </td></tr><tr><td>w</td><td>week in year      </td><td>Number            </td><td>27
    </td></tr><tr><td>W</td><td>week in month     </td><td>Number            </td><td>2
    </td></tr><tr><td>a</td><td>am/pm marker      </td><td>Text              </td><td>PM
    </td></tr><tr><td>'</td><td>escape for text   </td><td>Delimiter
    </td></tr><tr><td>''</td><td>single quote     </td><td>Literal           </td><td>'

      </td></tr><tr><th colspan="4">For use in output specifications only:
    </th></tr><tr><td>z</td><td>General timezone  </td><td>String   </td><td>Pacific
      Standard Time, PST, GMT-08:00 (<code>z</code> through <code>zzz</code>
      will usually give you the short form like <code>PST</code> while
      <code>zzzz</code> or longer will give you the full name like
      <code>Mountain Daylight Time</code>)
      </td></tr><tr><td>Z</td><td>RFC 822 timezone  </td><td>String           </td><td>-0800
      </td></tr><tr><td>X</td><td>ISO 8601 timezone  </td><td>String          </td><td>-08; -0800; -08:00
</td></tr></tbody></table>

  <p>
   The count of pattern letters determine the format:
  </p>
  
  <table summary="Time format character count description">
    <tbody><tr>
     <th>Type</th><th>Meaning
    </th></tr><tr><td>Text</td><td>4 or more pattern letters: use full form,
      less than 4: use short or abbreviated form if one exists.

    </td></tr><tr><td>Number</td><td>The minimum number of digits. Shorter
      numbers are zero-padded to this amount. Year is handled specially;
      that is, if the count of <code>y</code> is 2, the year will be truncated
      to 2 digits.

      <p>
       <b>Diatribe:</b> However, don't ever use truncated 2-digit years in
       input or output.  It's simply wrong and ambiguous and causes parsing
       problems.  Fix your data source if you can.  Did we learn nothing from
       Y2K?  When using 2-digit years, it's often impossible for a
       <em>human</em> to reliably guess which format is intended, so obviously
       Frink can't guess right either.
      </p>

    </td></tr><tr><td>Text &amp; Number</td><td>3 or more: use text, otherwise use number.
      
    </td></tr><tr><td>Timezone</td><td><b>For output:</b>  If there are 4 or more "z"
      characters in a row, use the full name of the timezone, otherwise use
      the (usually 3-character) abbreviation.

       <p><b>For input:</b>  Timezone specifiers are not necessary in a date
       format and should not be used when specifying an input format string.
       Timezones will always be allowed at the end of any date literal.
  </p></td></tr></tbody></table>

  <p>
   See the documentation for <a href="https://docs.oracle.com/javase/8/docs/api/index.html?java/text/SimpleDateFormat.html">java.text.SimpleDateFormat</a> for more information.
  </p>

  <h3><a name="OtherDateFormats">Other Date Formats</a></h3>
  <p>
   Internally, all dates are represented as the Julian Day (which is
   essentially just a numeric value indicating the number of days and
   fractions of days since Julian Day 0, which began at noon UTC on January 1,
   4713 B.C. as reckoned on the Julian Calendar.  Yes, <em>noon</em> is the
   beginning of the day in the Julian Day system.)  So noon UTC on September
   10, 2001 is JD 2452163.0.
  </p>

  <p>
   Julian Day (JD) and Modified Julian Day (MJD) can also be parsed.  MJD is
   defined as Julian Day - 2400000.5.  Note that <em>midnight</em> is the start
   of a <em>Modified</em> Julian Day.
  </p>

  <p>
   Many astronomical calculations use Julian Day (Ephemeris), usually
   abbreviated JDE, which is Julian Day with reference to <a href="#DynamicalTime">Dynamical Time</a>, not Universal Coordinated Time
   (UTC).  This can be parsed using the prefix <code>JDE</code>:
  </p>

  <p>
   <code># JD 2452163.0 #</code><br>
   <code># JDE 2452163.0 #</code><br>
   <code># MJD 52162.5 #</code><br>
   <code># JD 24521631/10 #</code>&nbsp;&nbsp;&nbsp;<br>
   <code># JD [212263942933679/86400000,
     70754647644893/28800000] #</code>&nbsp;&nbsp;&nbsp;<br>
  </p>

  <p>
   You can also use the JDE function to convert a number to the corresponding
   Julian Day Ephemeris value:
  </p>

  <p>
   <code>JDE[2451545.0]</code><br>
   <code>AD 2000-01-01 04:58:56.170 AM (Sat) Mountain Standard Time</code>
  </p>


  <p>
   <b>Note:</b> Do not confuse the Julian Day, (which is a single continuous
   numbering system often used by astronomers, who like the day number to
   change at noon when they're not working,) with a date in the Julian
   Calendar, which is almost identical to the Gregorian Calendar we use today,
   except without the centuries-divisible-by-400 leap-year rules.  (The
   differences are deeper, but that's the big one.)
  </p>

  <h3><a name="DynamicalTime">Dynamical Time</a></h3>
  <p>
   Dynamical Time is a time system that adjusts for the varying rotation rate
   of the earth!  This is one of the most accurate time systems and is
   necessary for calculating astronomical events to high accuracy in the past,
   present, and future.
  </p>

  <p>
   The offset ΔT between UTC and Dynamical Time
   (that is, the time that must be <em>added</em> to UTC to get Dynamical
   Time) can be obtained by the function:
  </p>

  <p>
   <code>deltaT[<i>date</i>]</code>
  </p>

  <p>
   You usually won't use this directly, but instead parse dates in Dynamical
   Time by appending the <code>TD</code> or <code>Dynamical Time</code>
   timezone specifiers when parsing a date.  The <code><a href="#OtherDateFormats">JDE</a></code> (Julian Date Ephemeris) format is
   also referenced to Dynamical Time.  For example, the time represented by
   the Dynamical Time at the year 2000 epoch is:
  </p>

  <p>
   <code>epoch = # 2000-01-01 00:00 TD #</code>
  </p>

  <p>
   Internally, all times are represented as the Julian Day referenced to UTC,
   but can be displayed in Dynamical Time if you specify Dynamical Time as the
   timezone on the right-hand-side of the conversion operator:
  </p>

  <p>
   <code># 2003-10-10 11:26 PM Mountain # -&gt; TD</code><br>
   <code>AD 2003-10-11 05:27:04.184 AM (Sat) GMT+00:01</code>
  </p>

  <h3><a name="InternationalAtomicTime">International Atomic Time (TAI)</a></h3>
  <p>
   International Atomic Time (TAI) is a system of time based on the "proper
   time" on earth's geoid.  While dates and times in Frink are internally
   represented as a Julian day referenced to UTC, you can convert between UTC
   and TAI for any given date using the function
   <code>TAIMinusUTC[<i>date</i>]</code> which returns the value TAI-UTC.
   This is the cumulative number of leap seconds that have been introduced
   into the calendar.
  </p>

  <p>
   <code>TAIMinusUTC[# 2008-12-01 00:00 UTC#]</code><br>
   <code>33 s (time)</code>
  </p>

  <p>
   This facility allows you to adjust for leap seconds, as TAI does not use
   leap seconds, but UTC does.  For more information on handling leap seconds,
   read on.
  </p>

  <h3><a name="LeapSeconds">Leap Seconds</a></h3>
  <p>
   By default, Frink's date/time math (using the <code>+</code> and
   <code>-</code> operators)  does <em>not</em> correct for leap
   seconds, but it can track leap seconds when requested.  The following
   functions add and subtract dates, taking leap seconds into account:
  </p>

  <table summary="Leap Second Functions">
    <tbody><tr><th>Function</th><th>Description
    </th></tr><tr><td>addLeap[<i>date</i>, <i>offset</i>]</td><td>Adds the
      specified offset (given as a time) to the specified date, taking leap
      seconds into account.  This is equivalent to:
      <p>
       <code>date + offset + TAIMinusUTC[date] - TAIMinusUTC[date+offset]
       </code>
      </p>
       
    </td></tr><tr><td>subtractLeap[<i>date2</i>, <i>date1</i>]</td><td>Returns
      date2-date1 with leap seconds taken into account. (d2 is normally the
      later date.)  This returns a time interval between the dates. This is
      equivalent to: 
      <p>
       <code>date2 - date1 + TAIMinusUTC[date2] - TAIMinusUTC[date1]
       </code>
      </p>
  </td></tr></tbody></table>
  
  <p>
   For example, to find the exact time between two dates nominally a year
   apart:
  </p>

  <p>
   <code>
    d1 = # 2008-12-01 00:00 UTC #<br>
    d2 = # 2009-12-01 00:00 UTC #<br>
    diff = subtractLeap[d2,d1]<br>
    diff -&gt; ["days", "s"]<br>
   </code>
   <code>365 days, 1 s</code>
  </p>

  <p>
   Note that the duration is slightly longer due to the leap second being
   introduced at the end of 2008.
  </p>

  <p>
   Or, to add a specified duration to a date:
  </p>

  <p>
   <code>
    addLeap[d1, 365 days] -&gt; UTC<br>
   </code>
   <code>AD 2009-11-30 PM 11:59:59.000 (Mon) Coordinated Universal Time</code>
  </p>

  <p>
   The functions <code>lengthOfYearLeap, lengthOfMonthLeap,
   lengthOfDayLeap</code> also calculate the length of years, months, days,
   etc.,
   <em>with leap seconds taken into account.</em>  See
   the <a href="#CalendarFunctions">Calendar Functions</a> section of the
   documentation for their use.
  </p>

  <p>
   Note that the resulting time is one second earlier than without leap
   seconds, due to the leap second introduced at the end of 2008.  Note that
   the exact second of the resultant date/time value is undefined on the leap
   second boundary (which this calculation includes.)  Frink does <em>not</em>
   represent the leap second as something like <code>23:59:60.1</code>.
  </p>

  <p>
   Modern leap seconds were first introduced on
   1972 January 1, where the value of TAI-UTC became exactly 10 seconds, and
   leap seconds have been introduced at irregular intervals since then.  Leap
   seconds may be added just before January 1 or July 1 of each year.
  </p>

  <p>
   It should be noted that from 1961 January 1 to 1972 January 1, instead of
   introducing discrete leap seconds, you had to do linear interpolation to
   convert between TAI and UTC.  <i>Be warned that Frink follows this
   interpolation process between these dates, and the value of UTC-TAI will
   not be an integer during this period!</i> Before 1961 Jan 1, this function
   returns 0 seconds.  For dates after the last known leap second is
   introduced, this function will return the value of TAI-UTC for the
   last-published leap second (<i>e.g.</i> 37 seconds after 2017-01-01.)
  </p>

  <p>
   For more information on the interpolation,
   see <strike><a href="https://maia.usno.navy.mil/ser7/tai-utc.dat" target="_blank">Down
   indefinitely?</a></strike> <strike><a href="http://toshi.nofs.navy.mil/ser7/tai-utc.dat">Official
   backup also down indefinitely
   LOL</a></strike> <a href="ftp://cddis.gsfc.nasa.gov/pub/products/iers/tai-utc.dat">A <em>really
   slow</em> tertiary backup copy of the US Naval Observatory's tabulation of
   leap seconds.</a>  (Good job, USNO)
   This is the file that Frink uses to perform these conversions.
  </p>

  <p>
   The <a href="#DynamicalTime"><code>deltaT[<i>date</i>]</code></a> and <a href="#InternationalAtomicTime"><code>TAIMinusUTC[<i>date</i>]</code></a>
   functions <em>do</em> take leap seconds into account, though.
  </p>

  <p>
   The <code>TAI</code> timezone specifier can be used to convert to/from
   International Atomic Time:
  </p>

  <p>
   Converting a UTC time to TAI:
  </p>
  
  <p>
   <code>
    d1 = # 2017-11-01 00:00 UTC #<br>
    d1 -&gt; TAI<br>
   </code>
   <code>AD 2017-11-01 AM 12:00:37.000 (Wed) International Atomic Time</code>
  </p>

  <p>
   Converting a TAI time to UTC:
  </p>

  <p>
   <code>
    d2 = # 2017-11-01 00:00 TAI #<br>
    d2 -&gt; UTC<br>
   </code>
   <code>AD 2017-10-31 PM 11:59:23.000 (Tue) Coordinated Universal Time</code>
  </p>

  <h3><a name="OtherTimeSystems">Other Time Systems</a></h3>
  <p>Additional conversions between time systems can be performed using the
   following relations:
  </p>

  <ul>
   <li><b>Terrestrial Time/Dynamical Time:</b> TT = TAI + 32.184 seconds
    <i>(Terrestrial Time is a more modern name for Dynamical Time.  See
     <a href="#DynamicalTime">Dynamical Time</a> section above.)</i>
    
   </li><li><b>DeltaT:</b> DeltaT = 32.184 s + (TAI-UTC) - (UT1-UTC)  <i>(See
     <a href="#DynamicalTime">Dynamical Time</a> section above.  Also note you
     can find the value of (TAI-UTC) using the <code>TAIMinusUTC[date]</code>
     function discussed in the <a href="#InternationalAtomicTime">International
      Atomic Time</a> section above.)</i>

    <p>
     The current values of UT1 are available
     in <a href="https://www.iers.org/IERS/EN/Publications/Bulletins/bulletins.html" target="_blank">IERS Bulletin B.</a>
    </p>

   </li><li><b>GPS Time:</b> GPS = TAI - 19 s
  </li></ul>
   
  <h2><a name="RegularExpressions">Regular Expressions</a></h2>
  <p>
   Regular expressions allow you to match complex patterns in strings.  Frink
   matches most all of the regular expressions matched by Perl, and most
   regular expressions are portable between languages like Perl, Ruby, Python,
   Frink, etc.  Frink internally uses the OROMatcher regular expression
   library, which attempts to match as much of Perl 5's syntax as possible.
  </p>   

  <p>
   There is a quick <a href="#RegularExpressionReference">Regular Expression
    Reference</a> below which describes most of the features available.
  </p>

  <p>
   If a pattern matches, it returns an array (possibly empty) of all of the
   "saved" matches inside parentheses.  If a pattern does <em>not</em> match,
   it returns the value <code>undef</code>.  Since any array (even an empty
   named one) is treated as a <code>true</code> value, and <code>undef</code>
   is treated as <code>false</code> (see the <a href="#Truth">Truth</a>
   section of the documentation,) this makes it easy to test within an
   <code>if</code> statement:
  </p>

  <p>
   <code>
   for line = lines["https://frinklang.org/"]<br>
   &nbsp;&nbsp;&nbsp;if [email] = line =~ %r/(\w+@\w+\.\w+)/<br>
   &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;println["Matched email $email"]
   </code>
  </p>

  <p>
   (Since a matched pattern always returns an array of values, putting
   <code>[email]</code> in square brackets assigns the result, as a single
   string, to the variable named <code>email</code>.  Without the brackets, it
   would assign <em>the whole array</em> to the variable <code>email</code>.)
  </p>

  <p>
   The matching syntax is similar to Perl or Ruby, with the exception that the
   pattern is denoted by <code>%r/<i>pattern</i>/<i>options</i></code> as
   below:
  </p>

  <p>
   <code>
   line = "New Zealand"<br>
   if line =~ %r/Alan/i&nbsp;&nbsp;&nbsp;<code>// Case-insensitive
     match</code><br>
   &nbsp;&nbsp;&nbsp;println["Matched"]<br>
   </code>
  </p>

  <p>
   In the form listed above, no variable interpolation is done in the string.
   If you need to build up a variable regular expression from a string, use
   the <code>regex[<i>string</i>]</code> or <code>regex[<i>string</i>,
    <i>options</i>]</code> functions.  The sample below is identical to the
   sample above:
  </p>

  <p>
   <code>
    line = "New Zealand"<br>
    re = regex["Alan", "i"]<br>
    if line =~ re<br>
    &nbsp;&nbsp;&nbsp;println["Matched"]<br>
   </code>
  </p>

  <p>
   Any part of the pattern surrounded by parentheses are saved off and
   returned as an <em>array</em> (even if only one item is returned.)  There
   aren't shortcut <code>$1</code>... variables like in Perl, and probably
   never will be, as it's too easy to break code without knowing it.
  </p>

  <p>
   The usual idiom is to get return values by breaking apart the array that is
   returned:
  </p>
  
  <p>
   <code>
   line = "My name is Inigo Montoya."<p>
   if [first, last] = line =~ %r/my name is (\w+) (\w+)/i<br>
   {<br>
   &nbsp;&nbsp;&nbsp;println["First name is: $first"]<br>
   &nbsp;&nbsp;&nbsp;println["Last  name is: $last"]<br>
   }
   </p></code>
  </p>

  <p>
   If you don't assign the results to an array in square brackets (even a
   single-element array,) all matching results are assigned as an array to a
   single variable:

  </p><p>
   <code>
   line = "My name is Inigo Montoya."<p>
   results = line =~ %r/my name is (\w+) (\w+)/i<br>
   if results<br>
   {<br>
   &nbsp;&nbsp;&nbsp;println["First name is: " + results@0]<br>
   &nbsp;&nbsp;&nbsp;println["Last  name is: " + results@1]<br>
   }
   </p></code>
  </p>

  <p>
   If the <code>/g</code> modifier is used at the end of the pattern,
   (indicating return <em>all</em> times matched, not just the first,) this
   will return an <a href="#EnumeratingExpressions">enumerating expression</a> of the items matched, and you should
   change the <code>if</code> statement to a <code>for</code> statement:
  </p>

  <p>
   <code>
   line = "My name is Inigo Montoya."<p>
   for [first, last] = line =~ %r/my name is (\w+) (\w+)/ig<br>
   {<br>
   &nbsp;&nbsp;&nbsp;println["First name is: $first"]<br>
   &nbsp;&nbsp;&nbsp;println["Last  name is: $last"]<br>
   }
   </p></code>
  </p>
  
  <p>
   See the <a href="#IteratingMatches">Iterating Matches</a> section of the
    documentation below for more ways to handle this case.
  </p>
  
  <h3><a name="RegularExpressionReference">Regular Expression Reference</a></h3>
  <p>
   This section is a quick tutorial on the parts that create a regular
   expression.
  </p>

  <h4><a name="BasicPatternsAndMetacharacters">Basic Patterns and Metacharacters</a></h4>
  <table summary="Basic Regular Expression patterns">
    <tbody><tr><th>Pattern</th><th>Description
    </th></tr><tr><td>abc</td><td>Matches the literal string <code>abc</code>
    </td></tr><tr><td>dog|cat</td><td>Matches the literal string <code>dog</code>
      <em>or</em> the literal string <code>cat</code>.
    </td></tr><tr><td>[abz]</td><td>Character class, matches any of the
      characters <code>a</code> or <code>b</code> or <code>z</code> (once
      only.)
    </td></tr><tr><td>[A-Z]</td><td>Character class (with range), matches any
      uppercase character from A to Z inclusive.  (Once only)
    </td></tr><tr><td>[A-Fa-f0-9_]</td><td>Character class (with multiple
      ranges), matches any character from A to F <em>or</em> any character
      from a to f, or any digit from 0 to 9 or the underscore character.
    </td></tr><tr><td>[^A-Z]</td><td><em>Inverting</em> character class:  matches
      any character <em>except</em> those from A to Z.
    </td></tr><tr><td>\</td><td>Quote the next metacharacter.  Necessary if you
      want to, say, match a literal character in this table (such as periods,
      parentheses, question marks, etc.)
    </td></tr><tr><td>.</td><td>Match any character (except newline).  To match a
      literal period, you must write <code>\.</code>  If the <code>/s</code>
      (single-line) <a href="#PatternMatchModifiers">modifier</a> is used in
      the search, this will also match the newline.
    </td></tr><tr><td>^</td><td>Match the beginning of the string
    </td></tr><tr><td>$</td><td>Match the end of the string
    </td></tr><tr><td>()</td><td>Save the matched text contained in the
      parentheses and return it.
    </td></tr><tr><td>(?:<i>pattern</i>)</td><td>Grouping only: allows grouping
      but does not save the result.
    </td></tr><tr><td>(?=<i>pattern</i>)</td><td>A zero-width positive look-ahead
      match.  For example, <code>(\w+(?=!))</code> matches a word followed by
      an exclamation point, <em>without</em> including the exclamation point in
      the results, and without consuming the exclamation point.
    </td></tr><tr><td>(?!<i>pattern</i>)</td><td>Matches patterns that <em>do not
       match</em> the pattern.  This is a zero-width look-ahead match, so it
      never has any width by itself.  For example, <code>a(?!b)c</code> will
      match <code>ac</code> because <code>a</code> is followed by a character
      that is not <code>b</code>, (<code>c</code>), and the zero-width
      look-ahead match is followed by a <code>c</code>.  See the documentation
      for the <a href="#remove"><code>remove</code></a> function for a sample
      of its use.
    </td></tr><tr><td>(?#<i>Text</i>)</td><td>An embedded comment, which is
      ignored.
  </td></tr></tbody></table>
      
  <h4><a name="SpecialCharacterClasses">Special Character Classes</a></h4>
  <p>
   The following characters classes are available.  They are all
   Unicode-aware: for example, the <code>\d</code> will match a Sanskrit or
   Devanagari digit as well.
  </p>

  <p>
   Note that a capitalized letter usually matches the inverse of a lowercase
   letter.  For example, <code>\d</code> matches a digit, while
   <code>\D</code> matches a non-digit.
  </p>

  <table summary="Special Character Classes">
    <tbody><tr><th>Pattern</th><th>Description
   </th></tr><tr><td>\w</td><td>Match a "word" character (alphanumeric plus "_")
   </td></tr><tr><td>\W</td><td>Match a non-"word" character (see above)
   </td></tr><tr><td>\s</td><td>Match a whitespace character
   </td></tr><tr><td>\S</td><td>Match a non-whitespace character
   </td></tr><tr><td>\d</td><td>Match a digit
   </td></tr><tr><td>\D</td><td>Match a non-digit
   </td></tr><tr><td>\1, \2, etc</td><td>Backreference to an already-matched
      pattern (contained in parentheses.)
   </td></tr><tr><td>\b</td><td>Match a word boundary
   </td></tr><tr><td>\B</td><td>Match except at a word boundary
   </td></tr><tr><td>\A</td><td>Match at beginning of string
   </td></tr><tr><td>\Z</td><td>Match at end of string
   </td></tr><tr><td>\u<i>HHHH</i></td><td>Match the specified Unicode character,
     where <code><i>HHHH</i></code> is a 4-digit hexadecimal code indicating
     a Unicode codepoint.
   </td></tr><tr><td>\u{<i>H...H</i>}</td><td>Match the specified Unicode
     character, where <code><i>H...H</i></code> is a 1-to-6 digit hexadecimal
     code indicating a Unicode codepoint.
   </td></tr><tr><td>\x{<i>H...H</i>}</td><td>Match the specified Unicode
     character, where <code><i>H...H</i></code> is a 1-to-6 digit hexadecimal
     code indicating a Unicode codepoint.
   </td></tr><tr><td>\x<i>HH</i></td><td>Match the specified character,
     where <code><i>HH</i></code> is a 2-digit hexadecimal code indicating a
     Unicode codepoint.
  </td></tr></tbody></table>

  <h4><a name="UnicodeCharacterClasses">Unicode Character Classes</a></h4>
  <p>
   The following Unicode/POSIX character classes are available.  They are
   written as <code>[:alpha:]</code> or its negation <code>[:^alpha:]</code>.
   <em>They must always be used inside a character class expression</em>
   surrounded by square brackets <code>[]</code>, which means that you'll
   usually see the brackets doubled:
  </p>

  <div>
   <p><br>
   <code>%r/[[:digit:]]/</code></p><p>
   <br>
   <code>%r/[:digit:]/</code></p><p>
   <br>
   <code>%r/[[:word:][:digit:]]/</code></p></div>

  <table summary="Unicode Character Classes">
    <tbody><tr><th>Pattern</th><th>Description
   </th></tr><tr><td>[:alpha:]</td><td>Any alphabetical character.
   </td></tr><tr><td>[:alnum:]</td><td>Any alphanumerical character.
   </td></tr><tr><td>[:ascii:]</td><td>Any character in the ASCII character set.
   </td></tr><tr><td>[:blank:]</td><td>A GNU extension, equal to a space or a horizontal tab
   </td></tr><tr><td>[:cntrl:]</td><td>Any control character.
   </td></tr><tr><td>[:digit:]</td><td>Any decimal digit, equivalent to "\d".
   </td></tr><tr><td>[:graph:]</td><td>Any printable character, excluding a space.
   </td></tr><tr><td>[:lower:]</td><td>Any lowercase character.
   </td></tr><tr><td>[:print:]</td><td>Any printable character, including a space.
   </td></tr><tr><td>[:punct:]</td><td>Any graphical character excluding "word" characters.
   </td></tr><tr><td>[:space:]</td><td>Any whitespace character. "\s" plus vertical tab ("\cK").
   </td></tr><tr><td>[:upper:]</td><td>Any uppercase character.
   </td></tr><tr><td>[:word:]</td><td>Equivalent to "\w".
    </td></tr><tr><td>[:xdigit:]</td><td>Any hexadecimal digit
  </td></tr></tbody></table>

  <h4><a name="Quantifiers">Quantifiers</a></h4>
  <p>
   The following symbols modify the pattern immediately previous to it, and
   allow you to specify that a pattern is matched multiple times:
  </p>
  
  <table summary="Quantifiers">
    <tbody><tr><th>Pattern</th><th>Description
    </th></tr><tr><td>*</td><td>Match 0 or more times
    </td></tr><tr><td>+</td><td>Match 1 or more times
    </td></tr><tr><td>?</td><td>Match 0 or 1 times
    </td></tr><tr><td>{n}</td><td>Match exactly n times
    </td></tr><tr><td>{n,}</td><td>Match at least n times
    </td></tr><tr><td>{n,m}</td><td>Match at least n but not more than m times
    </td></tr><tr><td>*?</td><td>Match 0 or more times, not greedily
    </td></tr><tr><td>+?</td><td>Match 1 or more times, not greedily
    </td></tr><tr><td>??</td><td>Match 0 or 1 times, not greedily
    </td></tr><tr><td>{n}?</td><td>Match exactly n times, not greedily
    </td></tr><tr><td>{n,}?</td><td>Match at least n times, not greedily
    </td></tr><tr><td>{n,m}?</td><td>Match at least n but not more than m times,
      not greedily
  </td></tr></tbody></table>

  <h4><a name="PatternMatchModifiers">Pattern Match Modifiers</a></h4>
  <p>
   Zero or more of these modifiers may follow the trailing <code>/</code> of a
   pattern match, and affect the behavior of the match, for example:
  </p>

  <p>
   <code>%r/<i>pattern</i>/igmsx</code><br>
  </p>
  
  <p>
   <code>%s/<i>from</i>/<i>to</i>/igmsxe</code><br>
  </p>
  
  <table summary="Pattern Match Modifiers">
    <tbody><tr><th>Modifier</th><th>Description
    </th></tr><tr><td>i</td><td>Case-<em>in</em>sensitive pattern-matching.
      Normally patterns are case-sensitive.
      
    </td></tr><tr><td>g</td><td>Global matching.  Normally, a pattern only
      matches the first time it is encountered in a string.  This forces the
      pattern to match as many times as it occurs, requiring a loop.  See the
      <a href="#IteratingMatches">Iterating Matches</a> section below for more
      information.

    </td></tr><tr><td>m</td><td>Treat string as multiple lines.  This means that
      <code>^</code> and <code>$</code> change from matching the start of the
      string to matching the start or end of any line anywhere in the string.

    </td></tr><tr><td>s</td><td>Treat string as a single line.  This means that
      the period character "<code>.</code>" will match any possible character,
      <em>including</em> the newline (which it doesn't match otherwise.)

    </td></tr><tr><td>x</td><td>Extended pattern:  Allows pattern to include
      whitespace, newlines and comments.  Comments must begin with the
      <code>#</code> character!

      <p>
       <code>
        %r/my name is\s+&nbsp;&nbsp;&nbsp;        # Phrase followed by 1 or more space characters<br>
        &nbsp;&nbsp;&nbsp;(\w+)&nbsp;&nbsp;&nbsp; # First name is all word characters<br>
        &nbsp;&nbsp;&nbsp;\s+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;   # One or more spaces<br>
        &nbsp;&nbsp;&nbsp;(\w+)&nbsp;&nbsp;&nbsp; # Last name is all word characters<br>
        /ix<br>
       </code>
    </p></td></tr><tr><td>e</td><td>Treat the right-hand-side of a search-and-replace
      as an expression to be evaluated.  See <a href="#SubstitutionWithExpressions">Substitution with Expressions</a>
      below.
  </td></tr></tbody></table>
  
  <h3><a name="IteratingMatches">Iterating Matches</a></h3>
  <p>
   Repeating regular expression matches (those with the <code>/g</code>
   modifier) can be used in an enumerating context (<i>e.g.</i> in a
   <code>for</code> loop,) in which case each pass through the loop will
   return a match.  The following returns:
  </p>
   
  <p>
   <code>
   for [email] = read["https://frinklang.org/"] =~ %r/(\w+@(?:\w|\.)+\.\w+)/g<br>
   &nbsp;&nbsp;&nbsp;println[email]<br>
   </code>

   <code>
    eliasen@mindspring.com<br>
    eliasen@mindspring.com
   </code>
  </p>

  <p>
   (The above URL contains the e-mail address twice.)  Note that pattern
   matches always return a <em>list</em> of values, (even if only one item is
   returned,) so to get only the first match, the variable <code>email</code>
   must be placed in square brackets.
  </p>

  <p>
   If used in a non-enumerating context (such as simple assignment,) the match
   will return a list-of-lists:
  </p>

  <p>
   <code>
    list = read["http://futureboy.us/"] =~ %r/(\w+@(?:\w|\.)+\.\w+)/g<br>
    println[list]<br>
   </code>
   <code>
    [[eliasen@mindspring.com], [eliasen@mindspring.com]]
   </code>
  </p>

  <p>
   This list can be flattened with the <code>flatten[<i>list</i>]</code>
   function:
  </p>

  <p>
   <code>
    println[flatten[list]]<br>
   </code>
   <code>
    [eliasen@mindspring.com, eliasen@mindspring.com]
   </code>
  </p>

  <h2><a name="SearchAndReplace">Search and Replace</a></h2>
  <p>
   A Perl-like search-and-replace operator also exists.  The syntax is:
  </p>

  <p>
   <code>line =~
    %s/<i>pattern</i>/<i>replacement</i>/<i>opts</i></code>
  </p>

  <p>
   If the expression on the left-hand-side of <code>=~</code> is assignable,
   it will be modified in-place.  The following fixes a spelling mistake:
  </p>

  <p>
   <code>
    line =~ %s/Frank/Frink/g
   </code>
  </p>

  <p>
   In the form listed above, no variable interpolation is done in the
   <i>from</i> string.  If you need to build up a variable replacement
   expression from a string, use the <code>subst[<i>fromStr</i>,
   <i>toStr</i>]</code> or <code>subst[<i>fromStr</i>, <i>toStr</i>,
    <i>options</i>]</code> 
   functions.  Note that these <em>do not</em> actually perform the
   substitution, but create an object that can be used later to perform the
   substitution.  The sample below is identical to the sample above:
  </p>
  
  <p>
   <code>
    fromStr = "Frank"<br>
    rep = subst[fromStr, "Frink", "g"]<br>
    line =~ rep<br>
   </code>
  </p>

  <p>
   You can even use the Perl 5 behavior of replacing parenthesized parts of an
   expression.  The first parenthesized pattern on the left-hand side can be
   denoted by <code>$1</code> in the replacement, the second by
   <code>$2</code> and so on.  For example, to change a file with names like
   "Frink, John" to "John Frink":
  </p>

  <p>
   <code>
    line =~ %s/(\w+), (\w+)/$2 $1/
   </code>
  </p>

  <p>
   You can't use <code>$1</code> and <code>$2</code> outside of the pattern
   match, like you can in Perl, though.  Another difference from Perl is that
   the return value of a search-and-replace is the replaced string, and not
   the number of times replaced.  This may change.
  </p>

  <h3><a name="SubstitutionWithExpressions">Substitution with Expressions</a></h3>
  <p>
   If the <code>/e</code> modifier exists on a search-and-replace operation,
   the right-hand-side of the substitution is treated as an expression.  The
   values saved on the left-hand side in parentheses are put into the
   variables <code>$1</code> , <code>$2</code> , etc.  (<em>Note that these
   variables are only available in the right-hand side of the
   substitution!</em>)
  </p>

  <p>
   The following sample increments every integer it finds in the line.
  </p>
  
  <p>
   <code>
    "There are 3 lights.  My ship is the NCC-1701-D." =~ %s/(\d+)/eval[$1]+1/eg
   </code><br>
   <code>
    There are 4 lights.  My ship is the NCC-1702-D.
   </code>
  </p>

  <h2><a name="InputAndOutput">Input and Output</a></h2>

  <h3><a name="ReadingLines">Reading Lines</a></h3>
  <p>
   Frink has a useful file/URL input function called
   <code>lines[<i>URL</i>]</code> which reads lines one at a time from the
   specified URL or <code>java.io.InputStream</code>.  The URL can be an HTTP,
   file, or FTP URL.  It is best used with the <a href="#ForLoop"><code>for</code></a> loop.  For example, to fetch and
   display the contents of a web page:
  </p>

  <p>
   <code>
   for line = lines["https://frinklang.org/"]<br>
   &nbsp;&nbsp;&nbsp;println[line] 
   </code>
  </p>

  <p>
   By default, the <code>lines[<i>URL</i>]</code> function returns an
   <a href="#EnumeratingExpressions">enumerating expression</a> which returns each line as requested, and forgets
   about previous lines.  If you want to store each line in an array for later
   use, use the <code>array[]</code> function:
  </p>

  <p>
   <code>
    a = array[ lines["file:data/units.txt"] ]<br>
    println["The data file contains " + length[a] + " lines."]
   </code>
  </p>

  <p>
   Hint:  You can use the <a href="#URLManipulation"><code>filenameToURL[<i>filename</i>]</code></a>
    function to turn a filename into a correctly-escaped URL, even if it has
    spaces or weird punctuation in it.
  </p>

  <p>
   If the first argument is the special string <code>"-"</code>, then the
   function will return an enumeration which reads lines from standard input
   (stdin) one at a time.  The following implements a simple "echo" program:
  </p>

  <p>
   <code>
    for line = lines["-"]<br>
    &nbsp;&nbsp;&nbsp;println[line]
   </code>
  </p>

  <p>
   Or, a simple program to read in and sort the lines from standard input, and
   print them back out:
  </p><p>
   
   <code>
    println[joinln[sort[lines["-"]]]]
   </code>
  </p>

  <p>
   The argument to the function may also be a <code>java.io.InputStream</code>
   or a <code>java.io.Reader</code> which simplifies reading from other input
   streams (for example, reading from a <code>URLConnection</code> or an
   external process, or a pipe.)  See
   the <a href="#CompressingDecompressingFiles">Compressing/Decompressing
   Files</a> section of the documentation on how to use functions like
   <code>gunzip</code> to decompress files while reading them.
  </p>

  <p>
   See the <a href="#SpecifyingAlternateEncodings">Specifying Alternate
    Encodings</a> section of the documentation to see how to specify the
   encoding of the file.
  </p>

  <h3><a name="ReadingEntireFiles">Reading Entire Files</a></h3>
  <p>
   If you're carefree and have lots of memory, you can load the entire
   contents of an URL (again, file, HTTP, or FTP URL),
   a <code>java.io.Reader</code>, or a <code>java.io.InputStream</code>,
   a <code>java.io.File</code> or a <code>java.net.URL</code> into
   a single big honkin' string using the <code>read[<i>source</i>]</code>
   function: 
  </p>

  <p>
   <code>
    bigstring = read["https://frinklang.org/"]
   </code>
  </p>

  <p>
   The <code>read</code> function can also take
   a <code>java.io.Reader</code>, or a <code>java.io.InputStream</code>,
   a <code>java.io.File</code> or a <code>java.net.URL</code> as an
   argument.
  </p>
   
  <p>
   If the argument is a string, note that this function expects a URL, so to
   open a file, you must provide an absolute or relative file URL beginning
   with <code>file:</code>
  </p>
  
  <p>
   <code>
    bigstring = read["file:///absolute/path/to/file"]
   </code>
  </p>

  <p>
   <code>
    bigstring = read["file:relative.html"]
   </code>
  </p>

  <p>
   Hint:  You can use the <a href="#URLManipulation"><code>filenameToURL[<i>filename</i>]</code></a>
    function to turn a filename into a correctly-escaped URL, even if it has
    spaces or weird punctuation in it.
  </p>

  <p>
   The <code>readLines[<i>source</i>]</code> functions will read the contents
   of an entire URL, <code>java.io.Reader</code>, or
   a <code>java.io.InputStream</code>, a <code>java.io.File</code> or
   a <code>java.net.URL</code> into an array with one line per entry.
  </p>

  <p>
   <code>
    array = readLines["https://frinklang.org/"]
   </code>
  </p>

  <p>
   Note that the same result could be achieved by calling
  </p>
  
  <p>
   <code>
    array[lines["https://frinklang.org/"]]
   </code>
  </p>
  
  <p>
   Needless to say, this may use up large amounts of memory.
  </p>

  <p>
   If the string is the special value <code>"-"</code> these functions will
   read all the data passed to standard input (stdin) in one fell swoop.  For
   example, the following implements a simple "echo" program:
  </p>
  
  <p>
   <code>
    println[read["-"]]
   </code>
  </p>
  
  <p>
   The argument to the <code>read</code> and <code>readLines</code> functions
   may also be
   a <code>java.io.InputStream</code>, <code>java.io.Reader</code>, or
   a <code>java.io.File</code> or a <code>java.net.URL</code> which simplifies
   the manipulation of other input streams (for example, reading from
   a <code>URLConnection</code> or an external process, or a pipe.  See
   the <a href="#CompressingDecompressingFiles">Compressing/Decompressing
   Files</a> section of the documentation on how to use functions like
   <code>gunzip</code> to decompress files while reading them.
  </p>

  <p>
   See the next section for information about specifying the encoding of the
   file.
  </p>

  <p>
   You can also read the contents of a URL (which may be a file) to an array
   of <code>byte</code> by calling <code>readBytes[<i>url</i>]</code>.
  </p>

  <h3><a name="SpecifyingAlternateEncodings">Specifying Alternate Encodings</a></h3>
  <p>
   The functions <code>lines</code> and <code>read</code>
   and <code>readLines</code> that take a URL
   or <code>java.io.InputStream</code> will attempt to set the character
   encoding correctly based on the
   <code>Content-Type</code> HTTP header.  If you are not requesting an HTTP
   URL, or the encoding is not properly specified, or not set in the HTTP
   headers, these functions will use your system's default character encoding.
   If the default charset is not appropriate for a file or URL, you can
   explicitly specify the character encoding of the file using the
   two-argument versions of the above functions:
  </p>

  <p>
   <code>lines[<i>URL</i>,&nbsp;<i>encoding</i>]<br>
    read[<i>URL</i>,&nbsp;<i>encoding</i>]</code>
  </p>

  <p>
   The encoding is a string representing any character encoding that your
   version of Java supports, <i>e.g.</i> <code>"UTF-8"</code>,
   <code>"US-ASCII"</code>, <code>"ISO-8859-1"</code>, <code>"UTF-16"</code>,
   <code>"UTF-16BE"</code>, <code>"UTF-16LE"</code>.  Your release of Java may
   support more charsets, but all implementations of Java are required to
   support the above.  Check the release notes for your Java implementation to
   see if other charsets are supported.
  </p>

  <p>
   In addition, see the sample program  
   <a href="https://frinklang.org/fsp/colorize.fsp?f=encodings.frink">encodings.frink</a> which
   demonstrates how to list all of the encodings available on your system (and
   their aliases.)
  </p>

  <h2><a name="WritingFiles">Writing Files</a></h2>
  <p>
   Text files can be written with the <code>Writer</code> class.  For example:
  </p>

  <p>
   <code>
    w = new Writer["filename.txt"]<br>
    w.print[2]<br>
    w.println[" monkeys."]<br>
    w.close[]<br>
   </code>
  </p>

  <p>
   The <code>Writer</code> class can write out any Unicode text properly in
   the encoding that you specify (or your system's default encoding, if you
   don't specify an encoding.)  You can also read in files in one encoding and
   translate them to another encoding.
  </p><p>
   For example, the following simple program reads in a file in the UTF-8
   encoding and writes it out in the UTF-16 encoding (or you can use it to
   convert between any encodings that your Java Virtual Machine supports):
  </p>

  <p>
   <code>
    w = new Writer["outfile.txt", "UTF-16"]<br>
    w.print[read["file:infile.txt", "UTF-8"]]<br>
    w.close[]<br>
   </code>
  </p>

  <p>
   See <a href="#SpecifyingAlternateEncodings">Specifying Alternate Encodings</a>
   for information about supported encodings.
  </p>

  <h3><a name="WriterConstructors">Writer Constructors</a></h3>
  <p>
   Note that calling any of the constructors below immediately checks
   permissions and opens the file if allowed.  Your operating system may only
   allow one process to open a file for writing at a time.
  </p>
   
  <table summary="Writer constructors">
    <tbody><tr><th>Signature</th><th>Description
    </th></tr><tr><td>new Writer[<i>filename</i>]</td><td>Constructs a
      <code>Writer</code> that opens and will write to the specified filename
      using the operating system's default encoding.
      
    </td></tr><tr><td>new
      Writer[<i>filename</i>,<i>encoding</i>]</td><td>Constructs a
      <code>Writer</code> that opens and will write to the specified filename
      using the specified encoding, for example <code>"UTF-8"</code>  See <a href="#SpecifyingAlternateEncodings">Specifying Alternate Encodings</a>
      for information about supported encodings.
      
    </td></tr><tr><td>new
      Writer[<i>filename</i>,<i>encoding</i>,<i>append</i>]</td><td>Constructs a
      <code>Writer</code> that opens and will write to the specified filename
      using the specified encoding.  If the encoding is <code>undef</code>
      this will use the operating system's default encoding.
      <code>append</code> is a boolean value which is <code>true</code> if you
      want to append to the file, <code>false</code> to overwrite it if it
      exists.
      
    </td></tr><tr><td>new
      Writer[<i>filename</i>,<i>encoding</i>,<i>append</i>,<i>bufferSize</i>]</td><td><p>Constructs
       a <code>Writer</code> that opens and will write to the specified
       filename using the specified encoding.  If the encoding is
       <code>undef</code> this will use the operating system's default
       encoding.  <code>append</code> is a boolean value which is
       <code>true</code> if you want to append to the file, <code>false</code>
       to overwrite it if it exists. <code>bufferSize</code> is the size of
       the internal buffer to use in bytes, and must be greater than 0.
       
      </p><p>
       If you specify a buffer size, the file will not be automatically
       flushed after each <code>println</code> (which is the default
       behavior,) so you must remember to close or flush the file before it
       will all be written.  (This is to let you squeeze out a bit more
       performance.)  Note that if the program is interrupted or exits before
       you call the <code>close[]</code> method, your changes will not be
       guaranteed to be written!  If you use this constructor, it is
       recommended to wrap the code in a <a href="#TryFinally"><code>try/finally</code></a> block and call
       <code>close[]</code> in the <code>finally</code> block.
     </p>
      <p>
       If no buffer is specified, the file will be flushed after every
       <code>println</code> or <code>writeln</code>.
      </p>

    </td></tr><tr><td>new Writer[<i>java.io.Writer</i>]</td><td>Constructs a
      <code>Writer</code> that wraps the already-opened
      <code>java.io.Writer</code> using its already-set encoding.

    </td></tr><tr><td>new Writer[<i>java.io.OutputStream</i>]</td><td>Constructs
      a <code>Writer</code> wraps the already-opened
      <code>java.io.OutputStream</code> using the operating system's default
      encoding.
      
    </td></tr><tr><td>new
      Writer[<i>java.io.OutputStream</i>,<i>encoding</i>]</td><td>Constructs a
      <code>Writer</code> wraps the already-opened
      <code>java.io.OutputStream</code> 
      using the specified encoding, for example <code>"UTF-8"</code>.  See <a href="#SpecifyingAlternateEncodings">Specifying Alternate Encodings</a>
      for information about supported encodings.
  </td></tr></tbody></table>

  <h3><a name="WriterMethods">Writer Methods</a></h3>
  <p>
   After successful construction of a <code>Writer</code>, you may call the
   following methods.
  </p>
  
  <table summary="Writer methods">
    <tbody><tr><th>Method</th><th>Description
    </th></tr><tr><td>write[<i>expression</i>]<br>print[<i>expression</i>]
     </td><td>Writes the specified expression to the file.  Both methods are
      identical.
    </td></tr><tr><td>writeln[<i>expression</i>]<br>println[<i>expression</i>] 
     </td><td>Writes the specified expression to the file and adds a trailing
      newline.  If no buffer has been specified in the constructor, this also
      flushes the output.
    </td></tr><tr><td>writeln[]<br>println[] 
     </td><td>Simply appends a newline to the file.  If no buffer has been
      specified in the constructor, this also flushes the output.
    </td></tr><tr><td>writeAndClose[<i>expression</i>]<br>printAndClose[<i>expression</i>]
     </td><td>Writes the specified expression to the file and then closes the file.
      Both methods are identical.  This is useful for a one-liner that writes
      an expression to a file.
    </td></tr><tr><td>flush[]</td><td>Flushes any buffered output to the
      underlying device.
    </td></tr><tr><td>close[]</td><td>Closes the file, flushing any buffered
      output first.  No more writing is possible after calling this method.
      <em>Don't forget to close your files, or your output is
       not guaranteed to be written!</em>
  </td></tr></tbody></table>
  
  <p>
   If you need to use some more complicated file I/O classes, such as for
   random I/O or writing raw bytes, you can use Frink's <a href="#JavaIntrospection">Java Introspection</a> facilities to access
   Java's wide variety of I/O classes, even ones that I haven't conceived of
   yet. See <a href="https://frinklang.org/fsp/colorize.fsp?f=Writer.frink">Writer.frink</a>
   for a simple example.  More classes for lower-level I/O may be
   forthcoming.  Suggestions are welcome.
  </p>

  <h3><a name="CompressingDecompressingFiles">Compressing/Decompressing Files</a></h3>
  <p>
   You can read and write to GZIP-compressed files without first compressing or
   decompressing them on the disk.  Files can be compressed or decompressed
   in memory while reading or writing to/from the disk.
  </p>
  <table summary="Compressing/uncompressing functions">
    <tbody><tr><th>Method</th><th>Description </th></tr><tr><td>gunzip[<i>URL</i>]</td><td>Opens the URL (specified as a string)
    and returns a <a href="https://docs.oracle.com/javase/8/docs/api/index.html?java/util/zip/GZIPInputStream.html" target="_blank"><code>java.util.zip.GZIPInputStream</code></a> that
    decompresses the contents of the URL.  This can be passed to functions
    that take a <code>java.io.InputStream</code> such as <code>read[]</code>
    and <code>lines[]</code>.

    </td></tr><tr><td>gunzip[<i>java.io.InputStream</i>]</td><td>Returns a <a href="https://docs.oracle.com/javase/8/docs/api/index.html?java/util/zip/GZIPInputStream.html" target="_blank"><code>java.util.zip.GZIPInputStream</code></a> that
    decompresses the specified <code>InputStream</code>.  This can be passed
    to functions that take a <code>java.io.InputStream</code> such as
    <code>read[]</code> and <code>lines[]</code>.

    </td></tr><tr><td>gzip[<i>filename</i>]</td><td>Opens the specified filename
    for writing, compressing any data to it with a <a href="https://docs.oracle.com/javase/8/docs/api/index.html?java/util/zip/GZIPOutputStream.html" target="_blank"><code>java.util.zip.GZIPOutputStream</code></a>.  The
    <code>GZIPOutputStream</code> is returned, and can be passed to any
    function that takes a <code>java.io.OutputStream</code> such as <a href="#WriterConstructors"><code>new
    Writer[<i>OutputStream</i>]</code></a>.

    </td></tr><tr><td>gzip[<i>java.io.OutputStream</i>]</td><td>Returns a <a href="https://docs.oracle.com/javase/8/docs/api/index.html?java/util/zip/GZIPOutputStream.html" target="_blank"><code>java.util.zip.GZIPOutputStream</code></a> that wraps
    the specified (already-opened) <code>OutputStream</code> and compresses
    any data sent to it.  The returned <code>GZIPOutputStream</code> can be
    passed to any function that takes a <code>java.io.OutputStream</code> such
    as <a href="#WriterConstructors"><code>new
    Writer[<i>OutputStream</i>]</code></a>.
  </td></tr></tbody></table>

  <p>
   For example, to write to a compressed file:
  </p>

  <p>
   <code>file = "compressed.txt.gz"<br>
    out = new Writer[gzip[file]]<br>
    out.println["Knitting and knitting and knitting and knitting and knitting"]<br>
    out.println["and knitting and knitting and knitting..."]<br>
    out.close[]
   </code>
  </p>

  <p>
   And to read back the contents of the above compressed file:
  </p>

  <p>
   <code>file = "compressed.txt.gz"<br>
    url = filenameToURL[file]<br>
    println[read[gunzip[url]]]
   </code>
  </p>

  <p>
   Or, similarly,
  </p>
  
  <p>
   <code>for line = lines[gunzip["file:compressed.txt.gz"]]<br>
    &nbsp;&nbsp;&nbsp;println[line]
   </code>
  </p>

  <p>
   These files can be read/written using standard <code>gzip</code> and
   <code>gunzip</code> tools on your operating system.
  </p>

  <p>
   If you want to compress data entirely in memory without reading or writing
   to a file, see
   the <a href="https://frinklang.org/fsp/colorize.fsp?f=gzipMemory.frink">gzipMemory.frink</a>
   sample file.
  </p>
      
  <h3><a name="EmailHarvesting">E-mail Harvesting</a></h3>
  <p>
   The following sample uses <a href="#RegularExpressions">regular
    expression</a> matching to harvest things that look like e-mail addresses
   from any URL.  The combination of the <code>for</code> loop and the
   <code>/g</code> modifier allows multiple matches to be found in a single
   line.
  </p>

  <p>
   <code>
    url = input["Enter a URL: "]<p>

    for line = lines[url]<br>
    &nbsp;&nbsp;&nbsp;for [result] = line =~ %r/(\w+@(?:\w|\.)+\.\w+)/g<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;println[result]</p></code>
  </p>

  <p>
   Pretty easy, eh?  Now you see why you get so much spam e-mail.  It's easy
   to grab e-mail addresses from files or Web pages.  Using this capability,
   Frink can be made to grab any kind of data from other web pages easily.
  </p>

  <p>
   Note that pattern matches always return a <em>list</em> of values, (even if
   only one item is returned,) so to get only the first match, the variable
   <code>result</code> must be placed in square brackets.
  </p>

  <h3><a name="StrippingHTML">Stripping HTML</a></h3>
  <p>
   The following (ridiculously simple) function fetches the contents of any
   URL and (somewhat naïvely) strips out the HTML markup.
  </p>

  <p>
   <code>
    stripHTML[url] := read[url] =~ %s/&lt;[^&gt;]*&gt;//gs
   </code>
  </p>


  <h3><a name="URLManipulation">URL Manipulation</a></h3>
  <p>
   Frink provides a few functions which are useful for manipulating URLs and
   producing web-spiders:
  </p>

  <p>
   <code>url[base, relative]</code> returns a new string URL
   made up of the given base and relative parts of a URL.  This is useful in
   resolving relative URLs in an HTML document:
  </p>

  <p>
   <code>url["http://futureboy.us/frinkdocs/index.html",&nbsp;"whatsnew.html"]</code><br>
   <code>http://futureboy.us/frinkdocs/whatsnew.html</code>
  </p>
  
  <p>
   <code>urlHost[url]</code> returns a string indicating the
   hostname of a specifed URL string (e.g. <code>"futureboy.us"</code>, or
   an empty string if no host is specified.)
  </p>

  <p>
   <code>urlPath[url]</code> returns a string indicating the
   entire path of a specifed URL string,
   (e.g. <code>"http://futureboy.us/frinkdocs/whatsnew.html"</code> will 
   return <code>"/frinkdocs/whatsnew.html"</code>)
  </p>
  
  <p>
   <code>urlFile[url]</code> returns a string indicating the
   filename of a specifed URL string, that is the last path part of a URL
   (e.g. <code>"http://futureboy.us/frinkdocs/whatsnew.html"</code> will
   return <code>"whatsnew.html"</code>)
  </p>
  
  <p>
   <code>URLEncode[<i>string, encoding="UTF8"</i>]</code>
   encodes a string for use as part of a URL.  The encoding should probably be
   the string <code>"UTF8"</code> for most applications.
  </p>
  
  <p>
   <code>URLDecode[<i>string, encoding="UTF8"</i>]</code>
   decodes a string for use as part of a URL.  The encoding should probably be
   the string <code>"UTF8"</code> for most applications.
  </p>
  
  <p>
   <code>urlProtocol[url]</code> returns a string indicating the
   protocol (e.g., <code>"http"</code> of a given URL string.)
  </p>

  <p>
   <code>filenameToURL[string]</code> turns a string containing
   a filename into a URL string.
  </p>

  <p>
   <code>fileURLs[string]</code> takes a string representing a
   file or directory and returns an enumeration of files in that directory.
   Each string is the URL of a file in that directory.
  </p>
  
  <p>
   <code>fileURLsRecursive[string]</code> takes a string
   representing a file or directory and returns an enumeration of files in that
   directory <em>and all its subdirectories.</em>  Each string is the URL of a
   file in that directory.
  </p>
  
  <p>
   The following program resolves all of the relative URLs in an HTML
   document and prints their values.
  </p>

  <p>
   <code>
    url = input["Enter a URL: "]<br>
    println[joinln[findURLs[url]]]<p>
    
    findURLs[u]&nbsp;:= <br>
    {<br>
    &nbsp;&nbsp;&nbsp;results&nbsp;=&nbsp;new array<br>
    &nbsp;&nbsp;&nbsp;for&nbsp;[rel]&nbsp;read[u]&nbsp;=~&nbsp;%r/&lt;\s*A\s+[^&gt;]*HREF\s*=\s*"([^&nbsp;"]+)"/gsi<br>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;results.push[url[u,&nbsp;rel]]</p><p>
    
    &nbsp;&nbsp;&nbsp;return&nbsp;results<br>
    }
   </p></code>
  </p>
  
  <h3><a name="IOFunctions">I/O Functions</a></h3>
  <p>
    The following functions are for other input/output routines.
  </p>

  <table summary="Other I/O Functions">
    <tbody><tr><th>Method</th><th>Description
    </th></tr><tr><td>copyStream[<i>inputStream</i>, <i>outputStream</i>]</td><td>Copies
        the contents of one <code>java.io.InputStream</code> to
        a <code>java.io.OutputStream</code>.  This closes both streams when
        complete.   This is actually a quite fundamental operation.  For
        example, it is used by
        the <a href="https://frinklang.org/fsp/colorize.fsp?f=ZipFile.frink">ZipFile.frink</a>
        sample program to extract files from a zip file.  In addition, it can
        be used to download from a URL (by
        calling <code>java.net.URL.openStream</code>,) copy files from one
        place to another, etc.
  </td></tr></tbody></table>
    
  <h2><a name="AnonymousFunctions">Anonymous Functions</a></h2>
  <p>
   In Frink, you can define blocks of executable code which can be assigned to
   variables, passed to and from functions, and executed as functions.  These
   work just like functions with no name.  In fact, that's exactly what they
   are.  The syntax is:
  </p>

  <p>
   <code>{ |<i>arglist</i>| <i>body</i> }</code>
  </p>

  <p>
    These can be multi-line functions, too:
  </p>

  <p>
    <code>{ |<i>x, y</i>|<br>
      &nbsp;&nbsp;&nbsp;println[x+y]<br>
      &nbsp;&nbsp;&nbsp;println[x*y]<br>
    }</code>
  </p>
  
  <p>
   The arguments in <code>arglist</code> are a (possibly empty)
   comma-separated list of variable names which are treated just like the
   formal parameters to a function.  The body is one or more statements or
   expressions to be executed.
  </p>

  <p>
   How is this useful?  Well, for example the <a href="#select"><code>select</code></a> function can take an anonymous
   function as an argument to help it select items from a list.  See its
   documentation for more information.
  </p>

  <p>
   An anonymous function can be called as a function.  The current syntax looks
   just like a function call:
  </p>

  <p>
   <code>
    isEven = { |x|  x mod 2 == 0 }<br>
    isEven[4]<br>
   </code>
   <code>true</code>
  </p>

  <p>
   You can also apply an anonymous function with
   the <code>apply[<i>function</i>, <i>argList</i>]</code>
   function.  <code>argList</code> should be an array of arguments to the
   function.
  </p>

  <p>
   <code>
    isEven = { |x|  x mod 2 == 0 }<br>
    apply[isEven, [4]]<br>
   </code>
   <code>true</code>
  </p>

  <p>
   As of the 2025-02-08 release, an anonymous function can be declared and
   immediately applied to its arguments by enclosing them in square brackets
   after the declaration.
  </p>

  <p>
   The following defines an anonymous function that
   squares its argument and immediately applies it with the
   argument <code>10</code>.
  </p>

  <p>
   <code>
    {|x| x^2}[10]<br>
   </code>
   <code>100</code>
  </p>

  <h2><a name="Sorting">Sorting</a></h2>
  <p>
   <code>sort[<i>list</i>]</code>will sort lists in which the elements have
   the same type.  When sorting units, the units should be conformal (that is,
   all should have the same dimensions.)  It is important to note that the
   list will be sorted in-place, that is, the original list will be modified!
   To get around this, the array should first be copied with the <a href="#ArrayMethods"><code><i>array</i>.shallowCopy[]</code> method.</a>
  </p>

  <p>
   <b>Note:</b>  If you want to do language-correct sorting of strings,
   especially for languages with accents, use the <a href="#LexicalSorting">Lexical Sorting</a> methods instead.  The default
   <code>sort[]</code> is designed to be simple and fast, but does not sort
   human languages according to their rules.
  </p>
  
  <p>
   <code>
    a = [5,2,3,1,4]<br>
    sort[a]<br>
   </code>
   <code>
    [1,2,3,4,5]
   </code>
  </p>

  <p>
   The two-argument version <code>sort[<i>list</i>, <i>func</i>]</code> allows
   you to specify a user-defined comparison routine. The second argument is a
   (possibly anonymous) function which contains a user-defined comparison
   routine.  The comparison routine must take 2 arguments
   (say <code>|a,b|</code>) and return -1 if a is less than b, 0 if a==b, and
   1 if a is greater than b.  (These are the values returned by
   the <a href="#ThreeWayComparison">three-way comparison</a>
   operator, <code>&lt;=&gt;</code> )  The argument <code>func</code> may also
   be an <code>Orderer</code>.
   The following samples are equivalent:
  </p>

  <p>
   <code>
    a = [5,2,3,1,4]<br>
    cmp = { |a,b|  a &lt;=&gt; b }<br>
    sort[a, cmp]<br>
   </code>
   <code>
    [1,2,3,4,5]
   </code>
  </p>

  <p>
   The default sort is much faster than if you define a user-defined
   comparison function (about 30 times faster in my tests!)  Now I see why
   Perl has so many anomalous and special-cased optimizations around
   user-defined sorting.
  </p>

  <p>
   If the <code>sort</code> function needs additional data to perform its
   work, you can use the three-argument <code>sort[<i>list</i>, <i>func</i>,
   <i>data</i>]</code> function which requires a three-argument comparison
   function to be passed to it, with the first two arguments being items to
   compare and the third argument being the arbitrary data.  The
   argument <code>func</code> may also be an <code>Orderer</code>.  For
   example, to sort a list by a specified column number:
  </p>

  <p>
   <code>
    list = [[1, "c"], [2, "b"], [3, "a"]]<p>
    
    <code>
     // Create a comparison function that takes a column number.<br>
    </code>
     cmpfunc = {|a, b, column| a@column &lt;=&gt; b@column}</p><p>
    
    <code>
     // Sort by column 1.  Note that the third argument is passed<br>
     // as the third argument to the comparison function.</code><br>
     sort[list, cmpfunc, 1]</p></code>
   <code>[[3, a], [2, b], [1, c]]</code>
  </p>

  <p>
   If you always want to sort a multi-dimensional array by column number, you
   can get an appropriate sorting function that sorts by a specified column by
   calling <code>byColumn[<i>int</i>]</code> and passing that as a sorting
   function.  The column number is zero-based.  For example, the following
   simplifies the above example and sorts by column 1:
  </p>

  <p>
   <code>
    list = [[1, "c"], [2, "b"], [3, "a"]]<br>
    sort[list, byColumn[1]]<br>
   </code>
   <code>[[3, a], [2, b], [1, c]]</code>
  </p>

  <p>
   If you need to sort by several columns (that is, if the first column
   compares equal, then sort by column 2, etc, you can get an appropriate
   sorting function by calling <code>byColumns[<i>array of int</i>]</code> and
   passing that as a sorting function.  The column numbers are
   an <em>array</em> and are zero-based.  For example, the following sorts by
   column 0 and then by column 1.
  </p>

  <p>
   <code>
    list = [[1, "c"], [2, "b"], [1, "a"], [3, "d"]]<br>
    sort[list, byColumns[[0,1]]]<br>
   </code>
   <code>[[1, a], [1, c], [2, b], [3, d]]</code>
  </p>
  
  <p>
   If you want the elements in reverse order, you can reverse the sorted list
   by calling the <code>reverse[<i>list</i>]</code> function on the sorted
   list.
  </p>

  <p>
   To sort all of the units with dimensions of time (or by extension, any
   dimension list) by their magnitude, you can use the following.  (Keep in
   mind that the <code>units</code> function returns the <em>names</em> of the
   units as strings.  The function <code>unit[<i>string</i>]</code> returns
   the unit with the specified name.:
  </p>

  <p>
   <code>
    sort[units[time], { |a,b| unit[a] &lt;=&gt; unit[b] }]
   </code>
  </p>

  <p>
   Which is equivalent to:
  </p>
  
  <p>
   <code>
    sort[unitsWithValues[time], byColumn[1]]
   </code>
  </p>

  <h3><a name="LexicalSorting">Lexical Sorting</a></h3>
  <p>
   The default <code>sort[]</code> functions sort strings in a simple and fast
   way (according to the order of characters in Unicode,) but in a way
   that is likely not correct according to the sorting methods for most human
   languages.  To sort strings correctly,
   <code>lexicalSort[<i>list</i>]</code> functions should be used.
  </p>

  <p>
   These functions understand alphabetization rules, Unicode normalization
   rules for characters with accents, alternate ways of specifying the same
   character, as well as the rules for most human languages and the way that
   their alphabetization rules differ.  They are very clever, and will make
   you look smart for using them correctly.
  </p>

  <p>
   The function <code>lexicalSort[<i>array</i>]</code> sorts an array of
   strings using the default language and locale settings defined in your Java
   Virtual Machine:
  </p>

  <p>
   <code>
    a = ["ökonomisch", "offenbar", "olfaktorisch", "Arg", "Ärgerlich", "Arm", "Assistent", "Aßlar", "Assoziation", "eñe", "ene", "enne"]<p>
    
    lexicalSort[a]</p></code>
   <code>
    [Arg, Ärgerlich, Arm, Assistent, Aßlar, Assoziation, ene, eñe, enne, offenbar, ökonomisch, olfaktorisch]
   </code>
  </p>

  <p>
   (Note that this was using an English locale, which also has good default
   rules that work correctly for other languages.)  Compare this to the order
   produced by the basic sort, which doesn't know anything about special
   characters:
  </p>
  
  <p>
   <code>
    sort[a]&nbsp;&nbsp;&nbsp;<code>// This is a dumb sort!</code><br>
   </code>
   <code>
    [Arg, Arm, Assistent, Assoziation, Aßlar, ene, enne, eñe, offenbar, olfaktorisch, Ärgerlich, ökonomisch]
   </code>
  </p>

  <p>
   Which bears no resemblance to any alphabetical ordering that most human
   languages would expect.  The price is that lexical sorting is slower and
   more expensive.  But it's a small price for being right, and
   internationalization-capable.
  </p>

  <p>
   Note that the sorting order depends on <em>your</em> Java Virtual Machine's
   locale and language settings.  If you want to force sorting for a
   particular language, you can use the <code>lexicalSort[<i>array</i>,
    <i>languageCode</i>]</code> function to specify its language code using
   the <a href="https://www.loc.gov/standards/iso639-2/php/code_list.php">ISO
    639-1</a> two-letter code for the language.  For example, repeating the
    above example for Turkish, whose language code is <code>"tr"</code>:
  </p>

  <p>
   <code>
    lexicalSort[a, "tr"]&nbsp;&nbsp;&nbsp;<code>// Turkish</code><br>
   </code>
   <code>
    [Arg, Arm, Assistent, Assoziation, Aßlar, Ärgerlich, ene, eñe, enne, offenbar, olfaktorisch, ökonomisch]
   </code>
  </p>

  <p>
   (Note that, according to the rules of Turkish, the letter
   <code>ä</code> is treated as a separate character alphabetized after
   <code>a</code>.  The same is true for <code>ö</code> and
   <code>o</code>.)
  </p>


  <p>
   Another example, using Danish and its possibly surprising alphabetization
   rules:
  </p>
  
  <p>
   <code>
    a = ["Ærø", "Aalborg", "Tårnby", "Vejen", "Thisted", "Stevns", "Sønderborg"]
    <br>
    lexicalSort[a, "da"]&nbsp;&nbsp;&nbsp;<code>// Danish</code><br>
   </code>
   <code>
    [Stevns, Sønderborg, Thisted, Tårnby, Vejen, Ærø, Aalborg]
   </code>
  </p>

  <p>
   That order is correct, with names beginning with "Aa" alphabetized last.
  </p>
  
  <p>
   If you need extreme control over the sorting order, the second argument of
   <code>lexicalSort[<i>list</i>, <i>languageCode</i>]</code> can be either a
   <a href="https://docs.oracle.com/javase/8/docs/api/java/text/Collator.html"><code>java.text.Collator</code></a>
   or a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Locale.html"><code>java.util.Locale</code></a>
   object which allows you very detailed control over creating custom sorting
   rules or locales.  Please see the documentation for those classes for
   details on controlling sorting.
  </p>

  <p>
   You can also normalize strings containing Unicode characters into a
   "canonical" form.  See the <a href="#CorrectStringParsing"><code>normalizeUnicode[<i>str</i>]</code></a>
   function for more information about this.
  </p>

  <p>
   If the values to be sorted by the <code>lexicalSort</code> functions are
   not strings, they can still be sorted as long as they are comparable to
   each other.  The default sort order will be used when values are not
   strings.
  </p>

  <p>
   As of the 2024-07-11 release, <code>lexicalSort</code> now compares
   sub-arrays also.  For example, in an array of arrays, <code>[1,2,3]</code>
   sorts before <code>[2,1,3]</code>.  Shorter arrays sort before longer ones.
  </p>

  <p>
   If you need a lexical-aware comparison operator that compares two items,
   see the <a href="#CorrectStringParsing"><code>lexicalCompare[<i>str1</i>, <i>str2</i>]</code></a> functions.
  </p>

  <p>
   This is all pretty cool and powerful, right?  Your programs can now
   demonstrate knowledge about many, many human languages and do the right
   thing with them!
  </p>

  <h2><a name="ListComprehensions">List Comprehensions</a></h2>
  <p>
   The following functions operate on all the elements of an array:
  </p>

  <h3><a name="select">select</a></h3>
  <p>
   The <code>select[<i>list</i>,
   <i>proc</i>]</code> function allows you to select the items from a list for
   which <code>proc</code> returns <code>true</code>.  For example, to select
   the even items from a list:
  </p>

  <p>
   <code>
    array = [0,1,2,3,4,5]<br>
    select[ array, { |x|  x mod 2 == 0 } ]<br>
   </code>
   <code>[0,2,4]</code>
  </p>

  <p>
   This successively assigns each element of <code>array</code> to a new
   local variable <code>x</code>, and returns the list of values for which
   <code>x mod 2</code> equals zero.
  </p>

  <p>
   If the function takes more than one argument, and is passed an array of
   values, the elements of the array are passed individually as function
   arguments.
  </p>

  <p>
   The following sample selects pairs of numbers which are coprime, that is,
   do <em>not</em> contain common factors (this is tested by checking if the
   greatest common factor is 1.):
  </p>

  <p>
   <code>
    array = [[2,3], [5,10], [20, 3], [7, 25]]<br>
    coprime = {|x,y| gcd[x,y] == 1}<br>
    select[array, coprime]<br>
   </code>
   <code>[[2, 3], [20, 3], [7, 25]]</code>
  </p>
  
  <p>
   <b>Note:</b> The second argument to <code>select[<i>list</i>,
   <i>regex</i>]</code> can also be a regular expression.  This expects the
   list to contain all strings and returns all of the strings that match the
   regular expression.
  </p>

  <p>
   <b>Note:</b> The second argument to <code>select[<i>list</i>,
    <i>substr</i>]</code> can also be a substring.  This expects the
   list to contain all strings and returns items which
   contain the specified substring (with an exact match.)  If you need a
   case-insensitive match, the second argument should be a regular expression.
  </p>

  <p>
   If the <code>select</code> function needs additional data to perform its
   work, you can use the three-argument <code>select[<i>list</i>, <i>func</i>,
   <i>data</i>]</code>
   function which requires a two-argument function to be passed to it, with
   the first argument being the item and the second argument the arbitrary
   data.  For example, to select all the elements of a list that are greater
   a certain number (in the following case, 2):
  </p>

  <p>
   <code>
    array = [0,1,2,3,4,5]<br>
    select[ array, { |x, data|  x &gt; data }, 2]<br>
   </code>
   <code>[3,4,5]</code>
  </p>

  <p>
   Similarly, the three-argument <code>select</code> function that passes in
   additional data will pass the data argument as the last argument to your
   selector function.
  </p>

  <p>
   The following example selects pairs whose product is larger than a specific
   number (in this case, 50).
  </p>
   
  <p>
   <code>
    array = [[2,3], [5,10], [20, 3], [7, 25]]<br>
    product = {|x,y,data| x*y &gt; data}<br>
    select[array, product, 50]<br>
   </code>
   <code>[[20, 3], [7, 25]]</code>
  </p>

  <p>
   <b>Behavior change:</b>  As of the 2014-05-09 release, the
   <code>select</code> and <code>remove</code> functions now try
   harder to keep their return values as arrays if passed an array, and an
   <a href="#EnumeratingExpressions">enumerating expression</a> if passed an
    enumerating expression.  In addition, they now keep dictionaries as
    dictionaries, <a href="#OrderedList">OrderedList</a>s as OrderedLists, and
    <a href="#Sets">sets</a> as sets.  To obtain other types, <code>toArray[<i>expr</i>]</code>,
    <code>toDict[<i>expr</i>]</code>, and <code>toSet[<i>expr</i>]</code>
    functions.  If in doubt, use these functions directly to change the return
    types.)
   However,closing the results in a <a href="#ForLoop"><code>for</code> loop</a> will still work to enumerate
   through all contained objects, no matter what the return type is.)
  </p>
  
  <p>
   This makes these functions now work properly with infinite series, and work
   more responsively with long-running operations that return information
   periodically. (<i>e.g.</i> searches.)  This change may also allow
   significantly-reduced memory consumption, as you can process each element
   and then forget about it, rather than holding on to a large array of
   values.
  </p>

  <p>
   The inverse of <code>select</code> is <code>remove</code>.  Read below.
  </p>
  
  <h3><a name="remove">remove</a></h3>
  <p>
   The inverse of the <code>select</code> function is <code>remove</code>
   which works similarly to <code>select</code>, but <em>removes</em> all
   items from a list that match the condition.
  </p>
   
  <p>
   The <code>remove[<i>list</i>,
   <i>proc</i>]</code> function allows you to remove the items from a list for
   which <code>proc</code> returns <code>true</code>.  For example, to remove
   the even items from a list:
  </p>

  <p>
   <code>
    array = [0,1,2,3,4,5]<br>
    remove[ array, { |x|  x mod 2 == 0 } ]<br>
   </code>
   <code>[1, 3, 5]</code>
  </p>

  <p>
   This successively assigns each element of <code>array</code> to a new
   local variable <code>x</code>, and removes all values for which
   <code>x mod 2</code> equals zero.
  </p>

  <p>
   If the function takes more than one argument, and is passed an array of
   values, the elements of the array are passed individually as function
   arguments.
  </p>

  <p>
   The following sample removes pairs of numbers which are coprime, that is,
   do <em>not</em> contain common factors (this is tested by checking if the
   greatest common factor is 1.):
  </p>

  <p>
   <code>
    array = [[2,3], [5,10], [20, 3], [7, 25]]<br>
    coprime = {|x,y| gcd[x,y] == 1}<br>
    remove[array, coprime]<br>
   </code>
   <code>[[5, 10]]</code>
  </p>
  
  <p>
   <b>Note:</b> The second argument to <code>remove[<i>list</i>,
   <i>regex</i>]</code> can also be a regular expression.  This expects the
   list to contain all strings and removes all of the strings that match the
   regular expression, returning the items that did <em>not</em> match.
  </p>

  <p>
   For example, if you wanted to remove all filenames that contained the
   substring <code>CVS</code> from a list, you might have to write a
   somewhat complicated, non-obvious regular expression that does not match
   that pattern using select: 
  </p>

  <p>
   <code>select[files,  %r/^(.(?!(CVS)))*$/]</code>
  </p><p>
   Or, more simply, use <code>remove</code> and a simpler pattern that matches
   the strings we want to remove:
  </p>

  <p>
   <code>remove[files,  %r/CVS/]</code>
  </p><p>
   If the <code>remove</code> function needs additional data to perform its
   work, you can use the three-argument <code>remove[<i>list</i>, <i>func</i>,
   <i>data</i>]</code>
   function which requires a two-argument function to be passed to it, with
   the first argument being the item and the second argument the arbitrary
   data.  For example, to remove all the elements of a list that match a
   certain number (in the following case, 2):
  </p>

  <p>
   <code>
    array = [0,1,2,3,4,5]<br>
    remove[ array, { |x, data|  x == data }, 2]<br>
   </code>
   <code>[0,1,3,4,5]</code>
  </p>
  
  <p>
   Similarly, the three-argument <code>remove</code> function that passes in
   additional data will pass the data argument as the last argument to your
   selector function.
  </p>

  <p>
   The following example removes pairs whose product is larger than a specific
   number (in this case, 50).
  </p>
   
  <p>
   <code>
    array = [[2,3], [5,10], [20, 3], [7, 25]]<br>
    product = {|x,y,data| x*y &gt; data}<br>
    remove[array, product, 50]<br>
   </code>
   <code>[[2, 3], [5, 10]]</code>
  </p>
  
  <h3><a name="map">map</a></h3>
  <p>
   The functions <code>map[<i>function</i>, <i>list</i>]</code>
   and <code>mapList[<i>function</i>, <i>list</i>]</code>
   and <code>mapList[<i>function</i>, <i>list</i>, <i>data</i>]</code> apply
   the specified function to all the members of a list, and returns a new list
   containing the results.  This is usually faster and more concise than
   applying a function to a list of arguments in a loop.
  </p><p>
   There are two different, but similar functions:  <code>map</code>
   and <code>mapList</code>.  Here is how to choose the function you want:
  </p>

  <ul>
   <li><code>map</code>: If you want to write a function that takes multiple
    arguments, <code>map</code> helps you by splitting an array of arguments
    into named variables for easy use in your function.

   </li><li><code>mapList</code>: If your function just wants to handle an array of
    values <em>as an array</em>, without modification,
    use <code>mapList</code>.  Normally, you provide a <em>one-argument</em>
    function that receives the array.  If you use the three-argument version
    <code>mapList[<i>function</i>, <i>list</i>, <i>data</i>]</code>, your
    function will have <em>two</em> arguments, <code>[list, data]</code>.
  </li></ul>

  <p>
   The <code><i>function</i></code> parameter may be either a string
   containing the name of the function or a function, possibly an <a href="#AnonymousFunctions">anonymous function</a>.
  </p>

  <p>
   If your list of arguments all have the same number of items, you can pass
   in the function name as a string:
  </p>

  <p>
   <code>
    array = [0,1,4,9]<br>
    map["sqrt", array]<br>
   </code>
   <code>[0,1,2,3]</code>
  </p>

  <p>
   You may want to pass in a reference to the function itself as the first
   parameter.  You can do this by calling the <code>getFunction[<i>name</i>,
   <i>numArgs</i>]</code> function.  For example, to return the greatest
   common denominator of successive pairs of numbers, you might do the
   following:
  </p>

  <p>
   <code>
    array = [[3,5], [2,10], [24, 36]]<br>
    g = getFunction["gcd", 2]<br>
    map[g, array]<br>
   </code>
   <code>[1,2,12]</code>
  </p>

  <p>
   Or, defining and using an <a href="#AnonymousFunctions">anonymous
    function</a>:
  </p>

  <p>
   <code>
    array = [1,2,3]<br>
    double = {|a|  a*2 }<br>
    map[double, array]<br>
   </code>
   <code>[2,4,6]</code>
  </p>

  <p>
   Anonymous arrays with any number of arguments are allowed, as long as each
   element of your list is a list containing the right number of items.
  </p>

  <p>
   Currently, all elements of the list must have the same number of elements
   and will resolve to the same function call.
  </p>

  <p>
   <b>For the <code>map</code> function:</b><br>
   If the number of items that will be passed to the function is greater than
   the number of formal arguments defined by the function, all of the extra
   arguments will be passed as an array to the last argument of the function.
   For example, if we define a function that only takes one argument, but pass
   it three items in each list, all three items will be passed as an array:
  </p>

  <p>
   <code>
    concat = {|i| join["", i]}<br>
    a = [[1,2,3],[4,5,6],[7,8,9]]<br>
    map[concat, a]<br>
   </code>
   <code>[123, 456, 789]</code>
  </p>

  <p>
   While this works in the above case, passing a one-argument array does not
   work correctly.  You need to use <code>mapList</code> in that case.
  </p>

  <p>
   <code>
    concat = {|i| join["", i]}<br>
    a = [[1],[4,5],[7,8,9]]<br>
    map[concat, a]<br>
   </code>
   <code>Error when calling function println:<br>
    &nbsp;Error when calling function map:<br>
    &nbsp;Error when calling function join:
    &nbsp;Second argument to join must be a list.
   </code>
  </p>

  <p>
   This is because the <code>map</code> function tries to "break up" the list
   and assign items from the list to named variables, and assigns any
   remaining items to the last variable of the function.  If you
   use <code>mapList</code> in this case, it works correctly.
  </p>

  <p>
   <code>
    concat = {|i| join["", i]}<br>
    a = [[1],[4,5],[7,8,9]]<br>
    mapList[concat, a]<br>
   </code>
   <code>[1, 45, 789]</code>
  </p>

  <p>
   You can test what your function is receiving by replacing your function
   with something that just returns its value:
  </p>

  <p>
   <code>
    echo = {|i| i}<br>
    a = [[1],[4,5],[7,8,9]]<br>
    map[echo, a]<br>
   </code>
   <code>[1, [4, 5], [7, 8, 9]]</code>
  </p>

  <p>
   As you can see, the first result <code>1</code> is not returned as an
   array.  Use <code>mapList</code> if you always want arrays handled as
   arrays, and not put into individual variables.
  </p>

  <p>
   If you need to pass additional data for the function to do its job, you can
   use the
   three-argument <code>mapList[<i>function</i>, <i>list</i>, <i>data</i>]</code>
   function.  The third argument, <code>data</code> is arbitrary data that
   will be passed to the second argument of <code>function</code> which must
   take two parameters, <code>[list, data]</code>.
  </p>

  <p>
   The following returns <code>true</code> for all values that are greater
   than the threshold value passed in the variable <code>data</code>.
  </p>
  
  <p>
   <code>
    gt = {|list, data| list &gt; data}<br>
    a = [1,2,3,4]<br>
    mapList[gt, a, 2]<br>
   </code>
   <code>[false, false, true, true]</code>
  </p>
  
  <h3><a name="split">split</a></h3>
  <p>
   A string can be split into an array using the <code>split[<i>regex</i>,
   <i>str</i>]</code> function which splits the string into parts.  The first
   argument to the <code>split[<i>pat</i>,&nbsp;<i>str</i>]</code> function
   can be either a regular expression or a string containing the delimiter.
   Conversely, the elements of an array can be joined into a string with a
   fixed delimiter, using <code>join[<i>separator</i>, <i>array</i>]</code>
  </p>

  <p>
   Splitting a string into an array, splitting on whitespace (the pattern
   <code>\s+</code> matches 1 or more whitespace characters:)
  </p>

  <p>
   <code>array = split[ %r/\s+/, "1 2 3 4 5"]</code><br>
   <code>[1, 2, 3, 4, 5]</code><br>
  </p>

  <p>
   Or, to split a tab-delimited line into elements:
  </p>

  <p>
   <code>array = split["\t", line]</code><br>
   which is the same as<br>
   <code>array = split[%r/\t/, line]</code><br>
  </p>

  <p>
   A string can be split into lines on any newline characters
   (<code>\r\n|\r|\n|\u2028|\u2029|\u000B|\u000C|\u0085</code>) using
   the <code>splitLines[<i>str</i>]</code> function which returns an array of
   strings with the newlines removed.
  </p>
  
  <p>
   <code>line = "One\nTwo\nThree"<br>
    println[splitLines[line]]</code><br>
   <code>[One, Two, Three]</code>
  </p>
  
  <h3><a name="join">join</a></h3>
  <p>
   The reverse of <code>split</code>
   is <code>join[<i>separator</i>, <i>array</i>]</code> which joins multiple
   array elements into one string, with elements separated by the specified
   string.
  </p>
  
  <p>
   <code>join[":", array]</code><br>
   <code>1:2:3:4:5</code>
  </p>

  <p>
   The single-argument function <code>joinstr[<i>array</i>]</code> joins array
   elements with no separator.  This is equivalent
   to <code>join["", <i>array</i>]</code>
  </p>
  
  <h3><a name="joinln">joinln</a></h3>
  <p>
   Returns a string where the elements of <code>array</code> are
   returned as a single string where the elements are separated by your
   platform's newline character(s).  That is, each element in the list are
   separated by newlines and probably printed on a line by itself.
  </p>
  
  <p>
   <code>joinln[array]</code><br>
   <code>1<br>2<br>3<br>4<br>5</code>
  </p>

  <p>
   The inverse of <code>joinln[<i>array</i>]</code>
   is <code>splitLines[<i>string</i>]</code> which takes a string and splits
   the string on newlines.
  </p>
  
  <h3><a name="zip">zip</a></h3>
  <p>
   The function <code>zip[<i>a</i>, <i>b</i>]</code> "zips" together
   corresponding elements of lists <code>a</code> and <code>b</code> and
   returns each pair as a two-element array.  (This is what this function is
   usually called in functional programming, and has nothing to do with the
   zip compression format.)  For example:
  </p>

  <p>
   <code>zip[1 to 3, 6 to 8]</code><br>
   <code>[ [1,6], [2,7], [3,8] ]</code>
  </p>

  <p>
   If one list is longer than the other, the shorter list will be
   padded with <code>undef</code> values.  If <em>both</em> arguments are
   <a href="#EnumeratingExpressions">enumerating expressions</a>, the result will be an efficient enumerating
   expression.  Otherwise, the arguments will be converted to arrays and the
   result will be an array (which is potentially large.)  Also note that an
   array <em>is</em> an <a href="#EnumeratingExpressions">enumerating expression</a> too!
  </p>

  <p>
   The results can be processed individually with the <code>for</code> loop:
  </p>

  <p>
   <code>
    for a = zip[1 to million, 3 to million + 3]<br>
    &nbsp;&nbsp;&nbsp;println[a]</code>
  </p>

  <p>
   If you wish to pad with values other than <code>undef</code>, there is a
   4-argument version of the function <code>zip[<i>a</i>, <i>b</i>,
    <i>defaultA</i>, <i>defaultB</i>]</code> that specifies what values to pad
   each list with.
  </p>

  <p>
   The inverse of the <code>zip</code> function is
   the <a href="#unzip"><code>unzip</code></a> function below.
  </p>
   
  <h3><a name="unzip">unzip</a></h3>
  <p>
   The function <code>unzip[<i>expr</i>]</code> is the inverse of
   the <a href="#zip"><code>zip</code></a> function and "unzips" the columns
   of a given <a href="#EnumeratingExpressions">enumerating expression</a>
   (which can be an array) into seperate arrays and returns an array of
   arrays.  (This is what this function is usually called in functional
   programming, and has nothing to do with the zip compression format.)  (The
   return types are currently arrays, but this may change.)  For example, this
   inverts the list produced by the <code>zip</code> function above and
   separates it into two arrays called <code>b</code> and <code>c</code>.
  </p>

  <p>
   <code>a = [ [1,6], [2,7], [3,8] ]<br>
    [b,c] = unzip[a]<br>
    println[b]</code><br>
   <code>[1, 2, 3]</code>
  </p>
  
  <h2><a name="IncludingOtherFiles">Including Other Files</a></h2>
  <p>
   For ease of maintenance, you can separate your program code into multiple
   files and include them in other files.  This is accomplished by the
   <code>use</code> statement.  This includes the contents of the named file
   at compile-time, at the point where the <code>use</code> statement is
   encountered.  For example, to include a file called
   <code>sun.frink</code> in the current directory:
  </p>

  <p>
   <code>
    use sun.frink
   </code>
  </p>

  <p>
   The <code>use</code> statement searches for the named files in the
   following places:
  </p>

  <ol>
   <li>Relative to the root of the current classpath or jar file.
    
   </li><li>If the statement specifies a fully-qualified URL, the URL is loaded.
    This includes <code>file:</code>, <code>ftp:</code>, and
    <code>http:</code> URLs.
    
   </li><li>Relative to the current file or URL being parsed.
    
   </li><li>Relative to the current working directory.
    
   </li><li>Relative to all paths specified using the <a href="#CommandLineOptions"><code>-I <i>path</i></code> command-line
     option.</a>

   </li><li>From the internal "standard library" shipped within the jar file's
    <code>/stdlib</code> directory.  This location may change.
  </li></ol>

  <p>
   The <code>use</code> statement has protection against including a file
   multiple times.
  </p>

  <p>
   <b>Tip:</b> If you're including a file that's <em>not</em> relative to any
   of the above, you'll need to specify it using an <em>absolute</em>
   <code>file:</code> URL, such as:
  </p>

  <p>
   <code>use file:///c:/prog/frink/samples/sun.frink</code><br>
   or<br>
   <code>use file:///prog/frink/samples/sun.frink</code>   
  </p>

  <p>
   This is necessary because a file or relative URL can legitimately contain
   colons on some operating systems.  For example, on a UNIX-like system, you
   could have a subdirectory called <code>c:</code> and that would be just
   fine.  Frink doesn't try to duplicate all the quirks of all operating
   systems and their wacky filename rules.
  </p>
  
  <h2><a name="ObjectOrientedProgramming">Object-Oriented Programming</a></h2>
  <p>
   Frink allows you to write your programs in object-oriented fashion,
   allowing complex data structures that are still easy to use.  Inheritance
   is not implemented, (and many people may argue that it shouldn't be
   implemented) but works fine for programs that don't require inheritance.
  </p>

  <p>
   Classes are defined using the <code>class</code> keyword and a syntax that
   won't particularly surprise anyone who has worked with Java, C++, Ruby,
   Python, or other object-oriented languages.
  </p>

  <p>
   The format of a class and how to use it is demonstrated in the 
   <a href="https://frinklang.org/fsp/colorize.fsp?f=classtest.frink">classtest.frink</a>
   file.
  </p>

  <p>
   Interfaces are defined using the <code>interface</code> keyword, and is
   similar to Java's implementation.
  </p>

  <p>
   The format of an interface and how to use it is demonstrated in the 
   <a href="https://frinklang.org/fsp/colorize.fsp?f=interfacetest.frink">interfacetest.frink</a> file.
  </p>

  <p>
   Methods on an object can be listed using the
   <code>methods[<i>obj</i>]</code> function.  If <code>obj</code> is an
   instance of an object, this lists the instance-level <em>and</em>
   class-level methods of that object.  If called with a classname (that gives
   you the "Metaclass Object" for that class,) it displays just the
   class-level methods.
  </p>

  <h2><a name="TryFinally">Try / Finally</a></h2>
  <p>
   Frink has a <code>try/finally</code> block which allows the programmer to
   ensure that code is called no matter what happens in a block of code.  The
   code within the <code>finally</code> block is executed whether the block is
   exited from a <code>return</code> statement, or if an error occurs in the
   code, or whatever.
  </p>

  <p>
   If the body of the <code>try</code> or <code>finally</code> block is a
   single line, it can be written without curly braces.
  </p>

  <p>
   <code>
    try<br>
    {<br>
    &nbsp;&nbsp;&nbsp;<code>// Code to do something that needs cleaning up</code><br>
    }<br>
    finally<br>
    {<br>
    &nbsp;&nbsp;&nbsp;<code>// Code to clean up</code><br>
    }<br>
   </code>
  </p><h2><a name="Formatters">Formatters</a></h2>
  <p>
   Frink expressions can be formatted in a variety of formats.  There are
   currently different formatters for human-readable and machine-readable
   forms:
  </p>

  <ul>
   <li><code>outputForm</code>: The default, human-friendly output format.
   </li><li><code>inputForm</code>: A machine-readable format, suitable for passing
    to Frink as input, and parsing with the <a href="#SelfEvaluation"><code>eval[<i>str</i>]</code></a> function.  This lets you
   easily save and load most Frink data structures (and programs,) send them
    over a network, etc., in a simple, safe and reversible
    way.  <code>inputForm</code> converts all ASCII characters outside the
    ASCII range 32-127 into escape codes, making it safe for use in a 7-bit
    ASCII pipeline.
   </li><li><code>inputFormUnicode</code>: A machine-readable format, suitable for passing
    to Frink as input, and parsing with the <a href="#SelfEvaluation"><code>eval[<i>str</i>]</code></a> function.  This
    assumes that you have a working Unicode environment and does not escape
    non-ASCII characters like <code>inputForm</code> does.
  </li></ul>

  <p>
   More formatters will follow, possibly for formatting into other languages
   (e.g. JavaScript/JSON).
  </p>

  <p>
   Several new functions have been added to support formatting in
   different formats:
  </p>

  <ul>
   <li><code>format[<i>expression</i>, <i>format</i>]</code> formats the
    expression to a string using the specified formatter.  Current formatters
    include the strings <code>"Input"</code>
    and <code>"Output"</code>.  <code>"Input"</code> is a formatter that
    provides Frink's input form that can be easily parsed by a call
    to <code>eval[<i>str</i>]</code>.  <code>"Output"</code> is the
    human-friendly formatter, which has been greatly improved for the
    introduction of multiple formatters.
    
   </li><li><code>formatters[]</code> lists the currently-available
    expression formatters.

   </li><li><code>inputForm[<i>expression</i>]</code>
    and <code>outputForm[<i>expression</i>]</code>
    and <code>inputFormUnicode[<i>expression</i>]</code> are aliases
    for <code>format[<i>expression</i>,"Input"]</code>
    and <code>format[<i>expression</i>,"Output"]</code>
    and <code>format[<i>expression</i>,"UnicodeInput"]</code> respectively.
    
   </li><li>Formatting options such as <code>showApproximations[]</code>,
    <code>rationalAsFloat[]</code>, <code>setEngineering[]</code>, and
    <code>showDimensionName[]</code> and the <code>:-&gt;</code> operator are
    now local to the <em>interpreter</em>, (and only affect the
    <code>"Output"</code> formatter,) not global to the entire Java Virtual
    Machine.  This makes it safer to embed multiple Frink parsers in a single
    virtual machine, each with their own preferences, and makes Java Server
    Pages more robust against poorly-behaved scripts.  (Programs still need
    to pass a security check to set these flags on an interpreter basis.)
  </li></ul>

  <h3><a name="InputForm">InputForm</a></h3>
  <p>
   The <code>inputForm[<i>expr</i>]</code> or <code>format[<i>expr</i>,
    "Input"]</code> function returns the expression in
   a machine-readable format, suitable for passing to Frink as input, and
   parsing with the <a href="#SelfEvaluation"><code>eval[<i>str</i>]</code></a>
   function.  This lets you easily save and load most Frink data structures
   (and programs,) send them over a network, etc., in a simple, safe and
   reversible way.
  </p>

  <p>
   <code>
    a = new dict</code>  <br>
   <code>
    a@"one" = 1<br>
    a@"two" = 2<br>
    a@"three" = 3<p>
    println[a]</p></code>
   <code>
    [[one, 1], [three, 3], [two, 2]]  <code>// default outputForm</code></code>
   <code>
    println[inputForm[a]]<br>
   </code>
   <code>
    new dict[[["one", 1], ["three", 3], ["two", 2]]]<br>
   </code>
  </p>

  <p>
   Notes on <code>inputForm</code>:
  </p>

  <ul>
   <li>Currently, objects created from a <code>class</code> specification will
    be output as a <code>dict</code> with name-value pairs for all instance
    variables.  This may change.  This is currently done because there's no
    way to guarantee that the Frink interpreter on the other end has loaded
    the same <code>class</code> or a compatible version.  There are potential
    security and correctness issues if the classes are incompatible.  A
    malicious user could also modify the data to get around security or logic
    checks and create invalid or dangerous objects.  It's currently left up to
    the programmer to take these objects, validate their fields, and turn them
    back into the objects they want on the other end.  This may change.
    
   </li><li>The Julian day parser can now parse rational numbers or date
    intervals, for example:
    <ul>
     <li><b>Rational:</b> <code># JD 212263942857555001/86400000000 #</code>
     </li><li><b>Interval:</b> <code># JD [212263942933679/86400000, 70754647644893/28800000] #</code>
    </li></ul>

   </li><li>Java objects are not currently formatted usefully.  This may change,
    or not.
    
   </li><li>When outputting dates in "input form", the date will be formatted as
    an exact Julian day (possibly an interval or an exact rational number as
    above) if necessary, or in a human-readable format in UTC, if
    sub-millisecond precision is not required, which allows exact round-trips
    of dates.

   </li><li>Strings and identifiers (e.g. variable names, function names) will be
    encoded into an ASCII-safe form.  Characters outside the ASCII range will
    be escaped into ASCII-safe Unicode escapes.  If you have a Unicode-safe
    environment and want to preserve Unicode unmodified, use
    the <a href="#InputFormUnicode">inputFormUnicode</a> formatter instead.

   </li><li>Added <code>toASCII[<i>str</i>]</code> function to turn a string into
    a network and file-encoding safe ASCII-encoded equivalent.  This is
    useful if you don't want the full quoting of <code>inputForm</code>.

   </li><li>Formatting options such as <code>showApproximations[]</code>,
    <code>rationalAsFloat[]</code>, <code>setEngineering[]</code>, and
    <code>showDimensionName[]</code> and the <code>:-&gt;</code> operator 
    do not apply in <code>inputForm</code>.
  </li></ul>

  <h3><a name="InputFormUnicode">InputFormUnicode</a></h3>
  <p>
   The <code>inputFormUnicode[<i>expr</i>]</code> or <code>format[<i>expr</i>,
    "UnicodeInput"]</code> function returns the expression in
   a machine-readable format, suitable for passing to Frink as input, and
   parsing with the <a href="#SelfEvaluation"><code>eval[<i>str</i>]</code></a>
   function.
  </p>

  <p>
   Unlike the <code>inputForm</code> formatter described above, it
   does <em>not</em> escape Unicode characters outside the ASCII 32-127 range
   into escape codes.  It assumes that you have a working Unicode
   environment that will not be corrupted by intermediate tools.  For safety
   in other environments, use the <code>inputForm</code> formatter instead.
  </p>
  
  <h2><a name="Graphics">Graphics</a></h2>
  <p>
   Frink has a powerful system for drawing graphics in a simple way.  Here are
   some of the features:
  </p>

  <ul>
   <li><b>Flexible coordinate system:</b> You can draw your graphics to any
    coordinates you wish, and Frink will, by default, automatically scale and
    center them in your display device, eliminating the tedium and error of
    manual coordinate conversions, adjustment for different window or printer
    sizes, etc.

   </li><li><b>Dimensioned drawings:</b>  Graphics can be specified with explicit
    lengths (such as "3 cm",) so exactly-sized drawings can be printed.
    (Well, as accurately as your printer's driver allows them to be!)

   </li><li><b>Infinitely scalable:</b> Frink's graphics are primarily designed to
    work with shapes, not individual pixels, so they can be re-scaled perfectly
    to display with full resolution on printers, in resizable graphics
    windows, in image files, or in rescalable vector formats.
    
   </li><li><b>High-quality shapes:</b>  Polygons and polylines are drawn with
    properly-joined, angled corners.

   </li><li><b>Anti-Aliasing:</b> Lines and shapes are anti-aliased, eliminating
    jagged edges.  (When running under Java 1.2 or later.  Frink's graphics
    will also run on Java 1.1, but without antialiased edges.)  Aliasing can
    now be controlled through the <a href="#Antialiasing">Antialiasing</a>
    methods.

   </li><li><b>Transparency (alpha channel):</b> Allows transparent shapes and
    lines, and see-through shapes to be drawn on top of other shapes.
    Anti-aliased edges are drawn with proper transparency so they can be
    overlaid on any background color or image.  (Requires Java 1.2 or later for
    transparency.)

   </li><li><b>High-quality text:</b>  Text can be written into any graphics
    object, with properly transparent anti-aliased edges.  Text may be scaled
    along with the image, or rendered at a constant size.

   </li><li><b>Easy transformations:</b>  All graphics can be translated, scaled,
    and rotated, making it very easy to draw objects to the coordinate system
    that is easiest to use, and translating it into larger drawings.  When
    graphics are scaled and rotated, Frink is smart enough to keep what you've
    drawn centered and scaled to fit on the screen or printed page!

   </li><li><b>Easy writing to files:</b> Graphics can be easily written to various
    file formats, including JPEG, PNG, HTML5 canvas, and Scalable Vector
    Graphics (SVG and SVGZ) formats.  PNG supports transparency (alpha channel)
    and allows antialiased, semi-transparent lines and shapes to be overlaid
    over other backgrounds or layers.  SVG format allows infinite rescaling and
    perfect rendering to high-resolution devices such as printers, and perfect
    import into other vector graphics programs.

   </li><li><b>Easy display on different devices:</b> The same graphics object
    can be created and then displayed on screen, printed to a printer, or
    written to a file, using a single command.
  </li></ul>

  <h3><a name="IntroductionToGraphics">Introduction to Graphics</a></h3>
  <p>
   Graphics are drawn and displayed in three steps:
  </p>

  <ol>
   <li>Create an object of type <code>graphics</code>:
    <p>
     <code>g = new graphics</code>
    </p>
    
   </li><li>Draw your shapes into the <code>graphics</code> object:
    <p>
     <code>
      g.line[1,100,100,1]<br>
      g.line[1,1,100,100]
     </code>
    </p>

   </li><li>Show (or print, or write your image to a file):
    <p>
     <code>
      g.show[]
     </code>
    </p>

    <p>
     <img src="https://frinklang.org/images/graphicsintro.png" width="400" height="300" alt="Graphics Introduction">
    </p>
  </li></ol>

  <p>
   That's it.  Frink takes care of the scaling and centering by default.  The
   coordinates that you choose can be whatever is most convenient and natural
   for you.  You can also create as many <code>graphics</code> objects as you
   want.  By default, when you call <code><i>graphics</i>.show[]</code>, each
   graphics object is displayed in its own resizable window. 
  </p>

  <h3><a name="Coordinates">Coordinates</a></h3>
  <p>
   Coordinates in Frink's graphics are very flexible.  There are a few things
   to note:
  </p>

  <ul>
   <li>Coordinates are specified as (x, y) with <code>x</code> being the
    horizontal coordinate and <code>y</code> the vertical coordinate.

   </li><li>Horizontal coordinates increase as you move right.

   </li><li>Vertical coordinates increase as you move down.  (Note that this is the
    common convention for almost all computer graphics, but is different than
    the usual mathematical conventions.  You can change this using a <a href="#TransformingGraphics">Graphics Transformation</a>, but be warned
    that will vertically flip text as well.)

   </li><li><b>Arbitrary-sized coordinates:</b>  Coordinates can be as big or small
    as you want.  Any real number that Frink can represent is fine.

   </li><li><b>Automatic centering and scaling:</b> You don't need to worry about
    the size or location of your rendering window.  By default, all graphics
    are resized and centered to fit into your graphics device (whether it's a
    resizable window, a printed page, or a graphic file.)  This saves lots of
    time and effort when drawing most graphics.  Even if your graphics have
    been scaled, translated, and rotated, Frink will still ensure that what
    you've drawn is scaled and centered.

   </li><li><b>Aspect ratio:</b> Aspect ratio is preserved by default.  That is, if
    a rectangle is 2 units wide and 1 unit high, it will retain that shape on
    resizing.  (You can change that by multiplying all coordinates on one axis
    by a "dummy" dimension that isn't dimensionless and isn't a length.)

   </li><li><b>Accurately-scaled drawings</b>: Coordinates may have dimensions of
    length (e.g. "1 inch"), in which case they are treated specially.  In this
    case, the graphics are still translated to fit into your view window, but
    Frink will also attempt to render them at the specified size.  This is
    highly dependent on how your operating system reports its resolution.  It
    works very well for printers, but not as well for monitors (especially in
    Windows, which almost always reports its screen resolution as 96 dpi, no
    matter what it really is.)  This allows you to print exact-sized drawings
    to the accuracy allowed by your operating system and printer drivers.  See
    the notes below about dimensions.

   </li><li><b>Dimensions with units:</b> Including the special case for length,
    all coordinates can have any units of measure, <em>as long as all
     coordinates along the same axis have the same dimensions</em>.  However,
    both axes do <em>not</em> have to have the same dimensions as each other,
    and will be scaled to fit in the window (because preserving aspect ratio is
    meaningless if they don't have the same units.)
  </li></ul>

  <p>
   For example, the following short program prints graph paper with a 1 mm
   grating:
  </p>

  <p>
   <code>
g= new graphics<br>
g.color[.7,.9,.7] <code>//light greenish-gray</code><p>

for x=0 mm to 8.5 in step 1 mm<br>
&nbsp;&nbsp;&nbsp;g.line[x, 0 in, x, 11 in]</p><p>

for y=0mm to 11 in step 1 mm<br>
&nbsp;&nbsp;&nbsp;g.line[0 in, y, 8.5 in, y]</p><p>

g.print[]
   </p></code>
  </p>
  
  <h3><a name="ShapesAndColors">Shapes and Colors</a></h3>
  <p>
   All of Frink's graphics are built out of a small number of basic shapes.
   These are drawn into a <code>graphics</code> object using the methods
   outlined below.  For example, you use them like the following:
  </p>

  <p>
   <code>
    g = new graphics<br>
    g.color[0,0,0]  <code>// black</code><br>
    g.fillEllipseCenter[0,0,10,10]<br>
    g.color[1,1,0]  <code>// yellow</code><br>
    g.fillEllipseCenter[0,0,9,9]<br>
    g.show[]
   </code>
  </p>

  <p>
   <img src="https://frinklang.org/images/circle.png" width="300" height="200" alt="Sample Circle">
  </p>

  <p>
   A new <code>color</code> object can also be obtained by calling <code>new
   color[<i>r, g, b, alpha</i>]</code> or <code>new color[<i>r, g,
   b</i>]</code>.  Note that <em>creating the color this way does not set the
   color in any graphics object.</em>  That must be done separately with a
   call to <code><i>graphics</i>.color[<i>c</i>]</code>.
  </p>

  <table summary="Graphics Shape and Color Methods">
    <tbody><tr><th>Method</th><th>Description
    </th></tr><tr><td>color[<i>r, g, b</i>]</td><td>Sets the current
      drawing color.  All following drawings will be made using this color.
      The color is specified with its red, green, and blue
      components which are floating-point values which must range from 0.0 to
      1.0, with 0.0 being completely dark for that component, and 1.0 being
      the brightest value for that component.  In a new graphics object, the
      default drawing color is black.  This also returns the color object so
      you can later re-use it in a <code>color[<i>c</i>]</code> method call.

    </td></tr><tr><td>color[<i>r, g, b, alpha</i>]</td><td>Also specifies a
      color, but with transparency.  The <code>alpha</code> component
      specifies the opacity of the color, and takes values from 0.0 to 1.0,
      with 1.0 being fully opaque and 0.0 being fully transparent.  (Note:
      transparency requires Java 1.2 or later.)  This also returns the color
      object so you can later re-use it in a <code>color[<i>c</i>]</code>
        method call.

    </td></tr><tr><td>color[<i>colorObject</i>]</td><td>Sets the current color to
      a color object that has been previously obtained from a call to
      <code>color[<i>r, g, b, alpha</i>]</code>, <code>color[<i>r, g,
      b</i>]</code>, or a call to the constructor <code>new color[<i>r, g, b,
      alpha</i>]</code> or <code>new color[<i>r, g, b</i>]</code>.
      
    </td></tr><tr><td>backgroundColor[<i>r, g, b</i>]</td><td>Sets the
      background color of the graphics window or image file.  The color
      components are specified as above.  There should be only one
      <code>backgroundColor</code> method call in a <code>graphics</code>
      object, and it should be the first method called when drawing.  If more
      than one call to <code>backgroundColor</code> is made, this will raise a
      warning.  (It will also replace any existing background color, but that
      behavior should not be relied on.)  By default, the background color is
      opaque white (or transparent when writing formats like SVG.)

    </td></tr><tr><td>backgroundColor[<i>colorObject</i>]</td><td>Sets the
      background color of the graphics window or image file to
      a color object that has been previously obtained from a call to
      <code>color[<i>r, g, b, alpha</i>]</code>, <code>color[<i>r, g,
      b</i>]</code>, or a call to the constructor <code>new color[<i>r, g, b,
      alpha</i>]</code> or <code>new color[<i>r, g, b</i>]</code>.  The
      warnings in the above <code>backgroundColor</code> method also applies
      to this method.

    </td></tr><tr><td>stroke[<i>width</i>]</td><td>Sets the stroke width used to
      draw lines, polygon outlines, ellipses, and polylines.  If the width is a
      dimensionless number, (e.g. <code>10</code>) the stroke
      will be scaled along with the drawing.  If the stroke has units of
      length, (e.g. <code>2 mm</code>) the lines will be
      rendered at that constant width regardless of how the image is scaled.
      (Note that the stroke width can not be changed in Java 1.1.)

    </td></tr><tr><td>alpha[<i>opacity</i>]</td><td>Sets the transparency (often
      called "alpha channel") of all subsequent drawing operations.  The
      opacity is a dimensionless number from 0 (fully transparent) to 1 (fully
      opaque.)  This primarily allows you to draw transparent images, as
      transparency can already be specified when setting colors.  If a color
      already has a transparency, that transparency value will be multiplied
      by this global transparency.  (Note that the transparency can not be
      changed in Java 1.1.) 
      
    </td></tr><tr><td>line[<i>x1, y1, x2, y2</i>]</td><td>Draws a straight line
      segment between the points (x1, y1) and (x2, y2) using the current color.
      
    </td></tr><tr><td>fillRectSize[<i>x, y, width, height</i>]<p>drawRectSize[<i>x, y, width, height</i>]</p></td><td>Draws
    a rectangle (filled or outlined, depending on the method called) with top
      left coordinate (x,y) and the specified width and height.  If the width
      or height are negative, this draws the rectangle to the left or to the
      top of that point.
      
    </td></tr><tr><td>fillRectSides[<i>x1, y1, x2, y2</i>]<p>drawRectSides[<i>x1, y1, x2, y2</i>]</p></td><td>Draws a
    rectangle (filled or outlined, depending on the method called) defined by
      its four sides.  The sides do not have to be in any particular order.

    </td></tr><tr><td>fillRectCenter[<i>cx, cy, width,
    height</i>]<p>drawRectCenter[<i>cx, cy, width, height</i>]</p></td><td>Draws a
    rectangle (filled or outlined, depending on the method called) defined by
    its centerpoint (cx, cy) and its width and height.
      
    </td></tr><tr><td>fillEllipseSize[<i>x, y, width, height</i>]<p>drawEllipseSize[<i>x, y, width, height</i>]</p></td><td>Draws
      a filled or unfilled ellipse (or circle if width==height) with top left
      coordinate (x,y) and the specified width and height.  If the width or
      height are negative, this draws the ellipse to the left or to the top of
      that point.
      
    </td></tr><tr><td>fillEllipseSides[<i>x1, y1, x2, y2</i>]<p>drawEllipseSides[<i>x1, y1, x2, y2</i>]</p></td><td>Draws
    a filled or unfilled ellipse (or circle if width==height) defined by its
    four sides.  The sides do not have to be in any particular order.

    </td></tr><tr><td>fillEllipseCenter[<i>cx, cy, width, height</i>]<p>drawEllipseCenter[<i>cx, cy, width, height</i>]</p></td><td>Draws
    a filled or unfilled ellipse or circle defined by its centerpoint (cx, cy)
      and its width and height.
  </td></tr></tbody></table>
       

  <h3><a name="AdvancedShapes">Advanced Shapes</a></h3>
  <h4><a name="PolygonsAndPolylines">Polygons and Polylines</a></h4>
  <p>
   Drawing a curve or a polygon out of <code>line</code> primitives might not
   give good results, as the lines don't know that they're supposed to be
   connected to each other.  To solve this problem, Frink has 
   <code>polyline</code>, <code>polygon</code> and <code>filledPolygon</code>
   objects which produce high-quality, connected lines with properly-joined
   corners.  Drawing a polygon or polyline to a graphics object consists of a
   few steps:
  </p>

  <ol>
   <li>Create the graphics object (if you haven't done so already.)
    <p>
     <code>g = new graphics</code>
    </p>

   </li><li>Create a polygon, filled polygon, <em>or</em> polyline.  (The sample
    below shows all three.  Pick one.)
    <p>
     <code>p = new polygon</code><br>
     <i>or</i><br>
     <code>p = new filledPolygon</code><br>
     <i>or</i><br>
     <code>p = new polyline</code>
    </p>

    <p>
     Alternately, you can pass in a list of points to any of the above
     constructors, in which case you can skip the next "adding points" step.
    </p>

    <p>
     <code>
      a = [ [1,3], [7,4], [6,2] ]<br>
      p = new polygon[a]
     </code>
    </p>

    <p>
     Alternately, you can copy a polygon type to another polygon using the copy
     constructors:
    </p>

    <p>
     <code>
      a = [ [1,3], [7,4], [6,2] ]<br>
      p = new polygon[a]<br>
      fp = new filledPolygon[p]<code>&nbsp;&nbsp;// copy constructor</code>
     </code>
    </p>
     
   </li><li>Add an arbitrary number of points to the line or polygon using its
    <code>addPoint</code> method.  Each point represents a vertex in the
    polyline or polygon.
    <p>
     <code>
      p.addPoint[<i>x,y</i>]<br>
      p.addPoint[<i>x,y</i>]<br>
      p.addPoint[<i>x,y</i>]
     </code>
    </p>

    <p>
     Note that a <code>polygon</code> or <code>filledPolygon</code> is
     <em>automatically closed</em>.  You should <em>not</em> manually connect
     the last point back to the first by repeating it at the end of the list.
     You should only have as many <code>addPoint</code> calls as there are
     vertices in your polygon.
    </p>

   </li><li>Add the polygon to the graphics object.  A polygon can be added to
    multiple graphics objects.  The drawing color and stroke width used in
    rendering the polygon are the ones which are active at the time of the
    <code>.add</code> call.  <em>Note that no points should be added to the
     polygon after it is added to the graphics object!</em>
    <p>
     <code>g.add[p]</code>
    </p>
    
   </li><li>Show the graphics object (or print, or save it to a file, or keep
    drawing into it and show it later...)
    <p>
     <code>g.show[]</code>
    </p>
  </li></ol>

  <h4><a name="PolygonMethods">Polygon Methods</a></h4>
  <p>
   You can call the following methods on a <code>polygon</code>,
   <code>filledPolygon</code>, or <code>polyline</code>.
  </p>
  <table summary="GeneralPath methods">
    <tbody><tr><th>Method</th><th>Description

    </th></tr><tr><td>addPoint[<i>x,y</i>]</td><td>Adds a point to the polygon.
      
    </td></tr><tr><td>getArea[]</td><td>Returns the area of the polygon, with
      appropriate dimensions.

    </td></tr><tr><td>getCentroid[]</td><td>Returns the centroid of the polygon
      as an array [<code>cx</code>, <code>cy</code>].
      
    </td></tr><tr><td>getPoints[]</td><td>Returns the points in the polygon as an
      array of [x, y] points.

    </td></tr><tr><td>isInside[<i>x,y</i>]</td><td>Returns <code>true</code> if
      the point <code>[x, y]</code> is inside the polygon, <code>false</code>
      otherwise.
      
    </td></tr><tr><td>show[]</td><td>Displays the polygon using the default
      display method.
  </td></tr></tbody></table>  

  <h4><a name="GeneralPath">GeneralPath</a></h4>
  <p>
   A <code>GeneralPath</code> allows you to create complex shapes consisting
   of straight lines, quadratic and cubic Bézier curves, arcs, and
   ellipses.  These paths can be filled or outlines, and can have multiple
   sub-paths that represent the "inside" and "outside" of an object.  For
   example, rendering a filled letter <code>P</code> in which one can see
   through the "hole" in the P can be obtained with a GeneralPath, and is not
   possible with a <code>polygon</code>.
  </p>

  <p><em>Note:</em> The GeneralPath functionality is only available under
   Java 1.2 and later.  Attempting to draw with a GeneralPath in earlier
   releases will produce a warning and the GeneralPath will not be drawn.
  </p>
     
  <p>
   Using a <code>GeneralPath</code> object consists of a few steps:
  </p>

  <ol>
   <li>Create the graphics object (if you haven't done so already.)
    <p>
     <code>g = new graphics</code>
    </p>

   </li><li>Create a GeneralPath or a filledGeneralPath.  (The sample below shows
    both.  Pick one.)
    <p>
     <code>p = new GeneralPath</code><br>
     <i>or</i><br>
     <code>p = new filledGeneralPath</code>
    </p>
  
   </li><li>Add an arbitrary number of segments using the following methods on the
    <code>GeneralPath</code> class:
    <table summary="GeneralPath methods">
     
      <tbody><tr><th>Method</th><th>Description

      </th></tr><tr><td>moveTo[<i>x,y</i>]</td><td>Moves to the specified point
        without drawing.  This creates a new subpath.  This (or
        <code>addPoint[<i>x,y</i>]</code>) should be the
        first call, otherwise the initial point is unspecified.

      </td></tr><tr><td>lineTo[<i>x, y</i>]
       </td><td>Draws a straight line segment from the current point to the
        specified point.

      </td></tr><tr><td>addPoint[<i>x,y</i>]
        </td><td>If this is the first point, does a <code>moveTo</code> the
        specified point.  If there are previous points, this does a
        <code>lineTo</code> the specified point.  The <code>addPoint</code>
        syntax is retained to make it easy to change code from a
        <code>polygon</code> or <code>polyline</code> representation to use
        <code>GeneralPath.</code>
        
     </td></tr><tr><td>quadratic[<i>cx, cy, px, py</i>]</td><td>Draws a quadratic
     Bézier curve from the current point to the point specified by
     <code>px,py</code> using the coordinates specified by <code>cx,cy</code>
     as the "control point".  The curves at each endpoint will be tangent to a
     line connecting that point and the control point.
        
        <img src="https://frinklang.org/images/quadratic.png" width="300" height="150" alt="Quadratic Curve">
        <br>
        (Control points drawn for clarity.)

      </td></tr><tr><td>cubicCurve[<i>c1x, c1y, c2x, c2y, px,
      py</i>]</td><td>Draws a cubic Bézier curve from the current point to
      the point specified by <code>px,py</code> using the coordinates
      specified by (<code>c1x,c1y</code>) and (<code>c2x,c2y</code>) as the
      "control points".  The curves at each endpoint will be tangent to a line
        connecting that point and its corresponding control point.

        <img src="https://frinklang.org/images/cubic.png" width="300" height="200" alt="Cubic Curve">
        <br>
        (Control points drawn for clarity.)

      </td></tr><tr><td>ellipseSides[x1, y1, x2, y2]</td><td>Creates an ellipse
        with the specified coordinates indicating its sides, that is, a
        rectangle that will contain it.  Note that an ellipse is considered to
        be <em>disconnected</em> from previous line segments, so you should use
        a <code>moveTo[x,y]</code> after this call to create a new path.
        
      </td></tr><tr><td>ellipseSize[x1, y1, width, height]</td><td>Creates an
        ellipse with the (x1,y1) coordinates indicating the top left corner of
        its bounding box, and the specified width and height relative to that
        point.  Note that an ellipse is considered to be <em>disconnected</em>
        from previous line segments, so you should use a
        <code>moveTo[x,y]</code> after this call to create a new path.

      </td></tr><tr><td>ellipseCenter[cx, cy, width, height]</td><td>Creates an
        ellipse with the (cx, cy) coordinates indicating the center of
        the ellipse, and the specified width and height.  Note that an
        ellipse is considered to be <em>disconnected</em> from previous line
        segments, so you should use a <code>moveTo[x,y]</code>
        after this call to create a new path.
        
      </td></tr><tr><td>circularArc[cx, cy, angle]</td><td>Creates a circular arc
        from the current point.  The (cx, cy) coordinates indicate the center
        of the circle, and <code>angle</code> specifies the angle to go around
        the circle in the counterclockwise direction.  Note that the
        <code>angle</code> parameter should have units of an angle, e.g.
        <code>90 degrees</code> or <code>1.2 radians</code> or even
        <code>1.2</code> (implying radians) if the standard data file is used
        which treats radians as a dimensionless number.
        
      </td></tr><tr><td>close[]</td><td>Closes the current subpath by drawing a
        straight line to the initial point of the subpath.  It is strongly
        recommended to use this method to close curves, as it properly joins
        corners, and informs the curve that it is logically closed.  This
        creates a new subpath, so you should use a <code>moveTo[x,y]</code>
        or <code>addPoint[x,y]</code> after this call to create a new path.
    </td></tr></tbody></table>

   </li><li>Add the GeneralPath to the graphics object.  A GeneralPath can be added
    to multiple graphics objects.  The drawing color and stroke width used in
    rendering the GeneralPath are the ones which are active at the time of the
    <code>.add</code> call.  <em>Note that no points should be added to
     the GeneralPath after it is added to the graphics object!</em>
    <p>
     <code>g.add[p]</code>
    </p>
    
   </li><li>Show the graphics object (or print, or save it to a file, or keep
    drawing into it and show it later...)
    <p>
     <code>g.show[]</code>
    </p>
  </li></ol>

  <p>
   For a sample of using the GeneralPath class, see <a href="https://frinklang.org/fsp/colorize.fsp?f=GeneralPathTest.frink">GeneralPathTest.frink</a>
   which demonstrates drawing a filled letter "P" with a properly-transparent
   hole.
  </p>

  <h3><a name="GraphicsWithText">Graphics with Text</a></h3>
  <p>
   High-quality text with transparent anti-aliased edges can be added
   to any <code>graphics</code> object using the following methods:
  </p>
  
  <table summary="Graphics Text Methods">
    <tbody><tr><th>Function</th><th>Description
    </th></tr><tr><td>font[<i>fontName, height</i>]<p>font[<i>fontName,
        style, height</i>]</p></td><td>Sets the current font that will be used to
      render text.  The arguments are:
      <ul>
       <li><code><b>fontName</b></code>:  A string indicating the name of the
        font family.  For portability to all platforms and image types
        (including SVG files,) this should be one of <code>"Serif", "SansSerif", "Monospaced"</code>.  However,
        any font name available on your system may be used if you don't care
        about portability.
        
       </li><li><code><b>style</b></code>:  An string containing information about
        the font style.  This should contain one of <code>"plain", "bold", "italic", "bold+italic"</code>.  (It's
        actually a case-insensitive substring search that just looks for
        "bold" and "italic" so this can be written in a lot of ways.) 
        
       </li><li><code><b>height</b></code>: The height of the font in the current
        coordinate system.  Height is taken as the distance from standard
        baseline to the next standard baseline, not necessarily as the height
        of the tallest characters.  This fits the usual definition of font size
        used in most systems.

        <p>
         If the height is a dimensionless number, (e.g. <code>10</code>) the font will be scaled
         along with the drawing.  If the height has units of length,
         (e.g. <code>10 points</code> or <code>1
          cm</code>) the font will be rendered at that constant height,
         regardless of how the image is scaled.  Note that using a height with
         dimensions of length might force the text out of the viewable area if
         the drawing is scaled too small to accommodate it.
        </p>
      </li></ul>

      <p>
       If you don't specify a font before drawing text, your system will use
       its default font, which may give different results when the same
       program is run on different systems or rendered to different devices.
       This behavior may change to specify a fixed default font in the future.
      </p>
      
    </td></tr><tr><td>text[<i>text, x, y</i>]</td><td>Draws the specified text
      <em>centered</em> (vertically and horizontally) at the coordinates
      (x,y).  Since it's hard to predict how wide (or tall) text will be until
      it's rendered, centering is often the most useful option.

    </td></tr><tr><td>text[<i>text, x, y, angle</i>]</td><td>Draws text as above,
      but also rotated by the specified angle (counterclockwise.)  The angle
      must have angular units, (<i>e.g.</i> <code>90 degrees</code> or <code>1
       radian</code>)
      
    </td></tr><tr><td>text[<i>text, x, y, horizontalAlign,
       verticalAlign</i>]</td><td>Draws the specified text with one point specified
      by the (x,y) coordinates and the rest of the text aligned relative to
      that as specified by the <code>horizontalAlign</code> and
      <code>verticalAlign</code> parameters.
      
      <p>
       The parameter <code>horizontalAlign</code> is a string
       containing one of: <code>"left", "right", "center"</code>
       indicating if the <code>x</code> coordinate indicates the left, right,
       or center horizontal position of the text.  For example, if the
       horizontal alignment is given as <code>"right"</code>, the specified
       <code>x</code> coordinate will be the right side of the text.
      </p>
      
      <p>The parameter <code>verticalAlign</code> is a string
       containing one of: <code>"top", "bottom", "center",
        "baseline"</code> indicating if the <code>y</code> coordinate indicates
       the top, bottom, center, or baseline vertical position of the text.  For
       example, if the vertical alignment is given as <code>"top"</code>, the
       specified <code>y</code> coordinate will be the top of the text.  The
       <code>"baseline"</code> parameter indicates the bottom of most
       characters, but characters with descenders like "j", "p" and "q" may
       hang below the baseline.
      </p>

    </td></tr><tr><td>text[<i>text, x, y, horizontalAlign,
       verticalAlign, angle</i>]</td><td>Draws text as above,
      but also rotated by the specified angle (counterclockwise.)  The angle
      must have angular units, (<i>e.g.</i> <code>90 degrees</code> or <code>1
       radian</code>)
      
    </td></tr><tr><td>caption[<i>text, align="bottom", angle=0 degrees</i>]
       </td><td>Adds a quick caption text to the specified side of a
        graphic.  <code>align</code> is optional but defaults
        to <code>"bottom"</code>.  If specified, <code>align</code> must be
        one of the following
        strings: <code>"top"</code>, <code>"bottom"</code>, <code>"left"</code>,
        or <code>"right"</code> indicating the side of the graphic where the
        text will be placed.  The text may be rotated by the specified
        optional <code>angle</code> (counterclockwise.)  The angle must have
        angular units, (<i>e.g.</i> <code>90 degrees</code> or <code>1
        radian</code>) It is suggested to set a font before drawing the
        caption, but either the last font or a font that is 1/20 of the
        graphic's height will be used if no font was specified.
  </td></tr></tbody></table>

  <p>
   <b>Example:</b>  The following program draws a 5x5 grid of random
   characters.
  </p>

  <p>
   <code>
g=new graphics<br>
g.font["SansSerif", "bold", 10]&nbsp;&nbsp;&nbsp;<p>

for x=1 to 5<br>
&nbsp;&nbsp;&nbsp;for y=1 to 5<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;g.text[char[random[char["A"], char["Z"]]], x*10, y*10]</p><p>

    g.show[]</p></code>
  </p>

  <p>
   <img src="https://frinklang.org/images/lettergrid.png" width="200" height="200" alt="Letter grid example">
  </p>

  <h3><a name="ComposingGraphics">Composing Graphics</a></h3>
  <p>
   A <code>graphics</code> object can be built up from multiple
   <code>graphics</code> objects that are added to it.  These graphics can be
   added at their original size, or placed at a certain location and size.
   This makes it easy to create complex graphics from many different graphics
   objects that were rendered at their "natural" sizes and then automatically
   resized to fit where you want them, <em>no matter what coordinates they
    were originally drawn to!</em>
  </p>

  <p>
   When adding one <code>graphics</code> obect into another, the new graphics
   object added will be transformed according to the current state of the <a href="#TransformingGraphics">Graphics Transformation</a> and global
   transparency (set by the <code>alpha[<i>opacity</i>]</code> method listed
   above in the <a href="#ShapesAndColors">Shapes and Colors</a> section.)
  </p>
  
  <p>
   Note that the object is fit according to its estimated bounding box;
   if the bounding box is estimated too large, then the graphic may not
   fill the entire region requested, and you may have to manually adjust
   the scaling.
   </p>
   
  <p>
   The following methods on a <code>graphics</code> object allow you to add
   other <code>graphics</code> objects to them.
  </p>
  
  <table summary="Methods for composing graphics">
    <tbody><tr><th>Method</th><th>Description
    </th></tr><tr><td>add[<i>graphics</i>]</td><td>Adds another graphic
      expression of any type to this graphics object.  By default, the other
      graphic is added at its original coordinates and size unless a <a href="#TransformingGraphics">coordinate transformation</a> has been set
      first.
      <p>
       See the other <code>add...</code> methods below to see how to add a
       graphic at a specified location and size.

    </p></td></tr><tr><td>addCenter[<i>graphics</i>, <i>cx</i>, <i>cy</i>,
      <i>width</i>, <i>height</i>, <i>maintainAspectRatio=true</i>]</td><td>Adds
      another graphic expression to this graphics object, attempting to place
      its center at the coordinates <code>(cx, cy)</code> and making it fit
      within the specified <code>width</code> and <code>height</code>.  This
      allows you to easily compose a <code>graphics</code> object out of other
      <code>graphics</code> objects, no matter what coordinates they were
      drawn to. 

      <p>
       The aspect ratio of the graphic is maintained unless the optional
       argument <code>maintainAspectRatio</code> is set to <code>false</code>
       (default is <code>true</code>).
      </p>

    </td></tr><tr><td>addCenterRotate[<i>graphics</i>, <i>cx</i>, <i>cy</i>,
      <i>width</i>, <i>height</i>, <i>angle</i>,
      <i>maintainAspectRatio=true</i>]</td><td>Identical to <code>addCenter</code>
      above, but the graphic is rotated around (<code>cx,cy</code>) by the
      specified angle (e.g. <code>10 degrees</code> or <code>1.3
       radians</code>).  Positive angles are clockwise.
      
    </td></tr><tr><td>addSides[<i>graphics</i>, <i>x1</i>, <i>y1</i>,
      <i>x2</i>, <i>y2</i>, <i>maintainAspectRatio=true</i>]</td><td>Adds
      another graphic expression to this graphics object, shrinking it or
      stretching it to fit into a rectangle with the specified sides.  The
      sides do not have to be in any particular order.

      <p>
       The aspect ratio of the graphic is maintained unless the optional
       argument <code>maintainAspectRatio</code> is set to <code>false</code>
       (default is <code>true</code>).
      </p>

    </td></tr><tr><td>addSidesRotate[<i>graphics</i>, <i>x1</i>, <i>y1</i>,
      <i>x2</i>, <i>y2</i>, <i>angle</i>, <i>maintainAspectRatio=true</i>]</td><td>
      Identical to <code>addSides</code> above, but the graphic is rotated
      around the center of its bounding box by the specified angle
      (e.g. <code>10 degrees</code> or <code>1.3 radians</code>).  Positive
      angles are clockwise.

    </td></tr><tr><td>addSize[<i>graphics</i>, <i>left</i>, <i>top</i>,
      <i>width</i>, <i>height</i>, <i>maintainAspectRatio=true</i>]</td><td>Adds
      another graphic expression to this graphics object, shrinking it or
      stretching it to fit into a rectangle with top left coordinate (left,
      top) and the specified width and height. If the width or height are
      negative, this draws the graphic to the left or to the top of that
      point, allowing you to align a graphic to the left, right, top, or
      bottom of a point or line.

      <p>
       The aspect ratio of the graphic is maintained unless the optional
       argument <code>maintainAspectRatio</code> is set to <code>false</code>
       (default is <code>true</code>).
      </p>

    </td></tr><tr><td>addSizeRotate[<i>graphics</i>, <i>left</i>, <i>top</i>,
      <i>width</i>, <i>height</i>, <i>angle</i>,
      <i>maintainAspectRatio=true</i>]
     </td><td>Identical to <code>addSize</code> above, but the graphic is rotated
      around the center of its bounding box by the specified angle
      (e.g. <code>10 degrees</code> or <code>1.3 radians</code>).  Positive
      angles are clockwise.
  </td></tr></tbody></table>
  
  <h3><a name="TransformingGraphics">Transforming Graphics</a></h3>
  <p>
   Frink allows you to rotate, translate, and scale graphics objects, allowing
   you to write simple code using the coordinate system that is most logical,
   and translate or scale it wherever you want.  Like all of Frink's other
   graphics, Frink ensures that whatever you draw is automatically scaled and
   centered into the display, and can be exported to various file formats.
  </p>

  <p>
   The current graphics transformation can be saved with a call to
   <code><i>graphics</i>.saveTransform[]</code> and should be restored with a
   corresponding call to <code><i>graphics</i>.restoreTransform[]</code>.
  </p>

  <p>
   The following methods are available on a <code>graphics</code> object to
   transform the coordinates.  Each transform is appended to the previous
   transforms.  After making a transformation, all subsequent drawing or
   <code>add[]</code> commands will use the current transform.
  </p>

  <table summary="Graphics Transformation Methods">
    <tbody><tr><th>Function</th><th>Description
    </th></tr><tr><td>translate[<i>dx</i>, <i>dy</i>]</td><td>Moves all
      subsequent drawing commands by the specified distance on the horizontal
      and vertical axes. (Positive <code>dx</code> moves to the right,
      positive <code>dy</code> moves down.)

      <div>
       <p>
        <b>Technical Note:</b> This corresponds to the matrix multiplication:
       </p>
       <p>
        <math>
         <mrow>
          <mrow>
           <mo fence="true">[</mo>
           <mtable>
            <mtr>
             <mtd>
              <mi>x'</mi>
             </mtd>
            </mtr>
            <mtr>
             <mtd>
              <mi>y'</mi>
             </mtd>
            </mtr>
            <mtr>
             <mtd>
              <mn>1</mn>
             </mtd>
            </mtr>
           </mtable>
           <mo fence="true">]</mo>
          </mrow>
          <mo> = </mo>
          <mrow>
           <mrow>
            <mo fence="true">[</mo>
            <mtable>
             <mtr>
              <mtd>
               <mn>1</mn>
              </mtd>
              <mtd>
               <mn>0</mn>
              </mtd>
              <mtd>
               <mi>dx</mi>
              </mtd>
             </mtr>
             <mtr>
              <mtd>
               <mn>0</mn>
              </mtd>
              <mtd>
               <mn>1</mn>
              </mtd>
              <mtd>
               <mi>dy</mi>
              </mtd>
             </mtr>
             <mtr>
              <mtd>
               <mn>0</mn>
              </mtd>
              <mtd>
               <mn>0</mn>
              </mtd>
              <mtd>
               <mn>1</mn>
              </mtd>
             </mtr>
            </mtable>
            <mo fence="true">]</mo>
           </mrow>
           <mo>·</mo>
           <mrow>
            <mo fence="true">[</mo>
            <mtable>
             <mtr>
              <mtd>
               <mi>x</mi>
              </mtd>
             </mtr>
             <mtr>
              <mtd>
               <mi>y</mi>
              </mtd>
             </mtr>
             <mtr>
              <mtd>
               <mn>1</mn>
              </mtd>
             </mtr>
            </mtable>
            <mo fence="true">]</mo>
           </mrow>
          </mrow>
         </mrow>
        </math>
       </p>

       <p>
        which gives the equations:
       </p>
       
       <p>
        <code>
         x' = x + dx<br>
         y' = y + dy
        </code>
       </p>
      </div>

      
    </td></tr><tr><td>scale[<i>sx</i>, <i>sy</i>]</td><td>Scales all subsequent
      drawing commands around the point (0,0) by the specified scale on the x
      and y axes. A coefficient of 1 corresponds to no scaling on that axis.
      A negative coefficient indicates a flip on that axis.  (Note that this
      will also flip text!)

      <p>
       Note that this function is not usually what you need; you usually want
       to scale around another point.  See the four-argument version of this
       function below.
      </p>
      
      <div>
       <p>
        <b>Technical Note:</b> This corresponds to the matrix multiplication:
       </p>

       <p>
        <math>
         <mrow>
          <mrow>
           <mo fence="true">[</mo>
           <mtable>
            <mtr>
             <mtd>
              <mi>x'</mi>
             </mtd>
            </mtr>
            <mtr>
             <mtd>
              <mi>y'</mi>
             </mtd>
            </mtr>
            <mtr>
             <mtd>
              <mn>1</mn>
             </mtd>
            </mtr>
           </mtable>
           <mo fence="true">]</mo>
          </mrow>
          <mo> = </mo>
          <mrow>
           <mrow>
            <mo fence="true">[</mo>
            <mtable>
             <mtr>
              <mtd>
               <mi>sx</mi>
              </mtd>
              <mtd>
               <mn>0</mn>
              </mtd>
              <mtd>
               <mn>0</mn>
              </mtd>
             </mtr>
             <mtr>
              <mtd>
               <mn>0</mn>
              </mtd>
              <mtd>
               <mi>sy</mi>
              </mtd>
              <mtd>
               <mn>0</mn>
              </mtd>
             </mtr>
             <mtr>
              <mtd>
               <mn>0</mn>
              </mtd>
              <mtd>
               <mn>0</mn>
              </mtd>
              <mtd>
               <mn>1</mn>
              </mtd>
             </mtr>
            </mtable>
            <mo fence="true">]</mo>
           </mrow>
           <mo>·</mo>
           <mrow>
            <mo fence="true">[</mo>
            <mtable>
             <mtr>
              <mtd>
               <mi>x</mi>
              </mtd>
             </mtr>
             <mtr>
              <mtd>
               <mi>y</mi>
              </mtd>
             </mtr>
             <mtr>
              <mtd>
               <mn>1</mn>
              </mtd>
             </mtr>
            </mtable>
            <mo fence="true">]</mo>
           </mrow>
          </mrow>
         </mrow>
        </math>
       </p>
       <p>
        which gives the equations:
       </p>
       
       <p>
        <code>
         x' = sx x<br>
         y' = sy y
        </code>
       </p>
      </div>

    </td></tr><tr><td>scale[<i>sx</i>, <i>sy</i>, <i>cx</i>,
      <i>cy</i>]</td><td>Scales all subsequent drawing commands around the point
      <code>(cx,cy)</code> by the specified scales <code>sx,sy</code> on the x
      and y axes.  A coefficient of 1 corresponds to no scaling on that axis.
      A negative coefficient indicates a flip on that axis.  (Note that this
      will also flip text!)

      <p>
       This is equivalent to the less-efficient:
      </p>

      <p>
       <code>
        translate[cx, cy]<br>
        scale[sx, sy]<br>
        translate[-cx, -cy]
       </code>
      </p>

      <div>
       <p>
        <b>Technical Note:</b> This corresponds to the matrix multiplication:
       </p>

       <p>
        <math display="inline">
         <mrow>
          <mrow>
           <mo fence="true">[</mo>
           <mtable>
            <mtr>
             <mtd>
              <mi>x'</mi>
             </mtd>
            </mtr>
            <mtr>
             <mtd>
              <mi>y'</mi>
             </mtd>
            </mtr>
            <mtr>
             <mtd>
              <mn>1</mn>
             </mtd>
            </mtr>
           </mtable>
           <mo fence="true">]</mo>
          </mrow>
          <mo> = </mo>
          <mrow>
           <mrow>
            <mo fence="true">[</mo>
            <mtable>
             <mtr>
              <mtd>
               <mi>sx</mi>
              </mtd>
              <mtd>
               <mn>0</mn>
              </mtd>
              <mtd>
               <mrow>
                <mi>cx</mi>
                <mo>⁢</mo> <!-- &InvisibleTimes; -->
                <mrow>
                 <mo>(</mo>
                 <mrow>
                  <mn>1</mn>
                  <mo>-</mo>
                  <mi>sx</mi>
                 </mrow>
                 <mo>)</mo>
                </mrow>
               </mrow>
              </mtd>
             </mtr>
             <mtr>
              <mtd>
               <mn>0</mn>
              </mtd>
              <mtd>
               <mi>sy</mi>
              </mtd>
              <mtd>
               <mrow>
                <mi>cy</mi>
                <mo>⁢</mo> <!-- &InvisibleTimes; -->
                <mrow>
                 <mo>(</mo>
                 <mrow>
                  <mn>1</mn>
                  <mo>-</mo>
                  <mi>sy</mi>
                 </mrow>
                 <mo>)</mo>
                </mrow>
               </mrow>
              </mtd>
             </mtr>
             <mtr>
              <mtd>
               <mn>0</mn>
              </mtd>
              <mtd>
               <mn>0</mn>
              </mtd>
              <mtd>
               <mn>1</mn>
              </mtd>
             </mtr>
            </mtable>
            <mo fence="true">]</mo>
           </mrow>
           <mo>·</mo>
           <mrow>
            <mo fence="true">[</mo>
            <mtable>
             <mtr>
              <mtd>
               <mi>x</mi>
              </mtd>
             </mtr>
             <mtr>
              <mtd>
               <mi>y</mi>
              </mtd>
             </mtr>
             <mtr>
              <mtd>
               <mn>1</mn>
              </mtd>
             </mtr>
            </mtable>
            <mo fence="true">]</mo>
           </mrow>
          </mrow>
         </mrow>
        </math>
       </p>
       <p>
        which gives the equations:
       </p>
       
       <p>
        <code>
         x' = sx x + cx (1 - sx)<br>
         y' = sy y + cy (1 - sy)
        </code>
       </p>

       <p>
        or, equivalently:
       </p>

       <p>
        <code>
         x' = sx (x-cx) + cx<br>
         y' = sy (y-cy) + cy
        </code>
       </p>
      </div>
      
    </td></tr><tr><td>rotate[<i>angle</i>]</td><td>Rotates all subsequent drawing
      commands around the point (0,0) by the specified angle.  Positive angles
      are clockwise.

      <p>
       Note that this function is rarely what you need; you usually want to
       rotate around another point.  See the three-argument version of this
       function below.
      </p>

      <div>
       <p>
        <b>Technical Note:</b> This corresponds to the matrix multiplication:
       </p>

       <table summary="rotate matrix">
        <colgroup span="1">
        </colgroup><colgroup span="1">
        </colgroup><colgroup span="3">
        </colgroup><colgroup span="1">
        </colgroup><colgroup span="1">
         </colgroup><tbody><tr><td>x'</td><td> </td><td>cos[angle]</td><td>-sin[angle]</td><td>0</td><td> </td><td>x
         </td></tr><tr><td>y'</td><td>=</td><td>sin[angle]</td><td>cos[angle]</td><td>0</td><td>*</td><td>y
         </td></tr><tr><td>1 </td><td> </td><td>0 </td><td>0</td><td>1</td><td> </td><td>1
       </td></tr></tbody></table>

       <p>
        which gives the equations:
       </p>
       
       <p>
        <code>
         x' = x cos[angle] - y sin[angle]<br>
         y' = x sin[angle] + y cos[angle]
        </code>
       </p>
      </div>

      
    </td></tr><tr><td>rotate[<i>angle</i>, <i>cx</i>, <i>cy</i>]</td><td>Rotates
      all subsequent drawing commands around the point (<code>cx, cy</code>)
      by the specified angle. Positive angles are clockwise.

      <p>
       This is equivalent to the less-efficient:
      </p>

      <p>
       <code>
        translate[cx, cy]<br>
        rotate[angle]<br>
        translate[-cx, -cy]
       </code>
      </p>

      <div>
       <p>
        <b>Technical Note:</b> This corresponds to the matrix multiplication:
       </p>

       <table summary="rotate around matrix">
        <colgroup span="1">
        </colgroup><colgroup span="1">
        </colgroup><colgroup span="3">
        </colgroup><colgroup span="1">
        </colgroup><colgroup span="1">
         </colgroup><tbody><tr><td>x'</td><td> </td><td>cos[angle]</td><td>-sin[angle]</td><td>cx (1-cos[angle]) + cy sin[angle] </td><td> </td><td>x
         </td></tr><tr><td>y'</td><td>=</td><td>sin[angle]</td><td>cos[angle]</td><td>cy (1-cos[angle]) - cx sin[angle]</td><td>*</td><td>y
         </td></tr><tr><td>1 </td><td> </td><td>0 </td><td>0</td><td>1</td><td> </td><td>1
       </td></tr></tbody></table>

       <p>
        which gives the equations:
       </p>

       <p>
        <code>
         x' = x cos[angle] - y sin[angle] + cx (1-cos[angle]) + cy sin[angle]<br>
         y' = x sin[angle] + y cos[angle] + cy (1-cos[angle]) - cx sin[angle]
        </code>
       </p>
       
       <p>
        or, equivalently:
       </p>

       <p>
        <code>
         x' = (x - cx) cos[angle] - (y - cy) sin[angle] + cx<br>
         y' = (x - cx) sin[angle] + (y - cy) cos[angle] + cy
        </code>
       </p>
      </div>


    </td></tr><tr><td>transform[<i>a,b,c,d,e,f</i>]</td><td>Performs an
      arbitrary affine transform on subsequent drawing commands, by specifying
      all relevant coefficients of an affine transformation matrix.

      <div>
       <p><b>Technical Note:</b> This corresponds to the matrix multiplication:

       </p><p>
        <math>
         <mrow>
          <mrow>
           <mo fence="true">[</mo>
           <mtable>
            <mtr>
             <mtd>
              <mi>x'</mi>
             </mtd>
            </mtr>
            <mtr>
             <mtd>
              <mi>y'</mi>
             </mtd>
            </mtr>
            <mtr>
             <mtd>
              <mn>1</mn>
             </mtd>
            </mtr>
           </mtable>
           <mo fence="true">]</mo>
          </mrow>
          <mo> = </mo>
          <mrow>
           <mrow>
            <mo fence="true">[</mo>
            <mtable>
             <mtr>
              <mtd>
               <mi>a</mi>
              </mtd>
              <mtd>
               <mi>c</mi>
              </mtd>
              <mtd>
               <mi>e</mi>
              </mtd>
             </mtr>
             <mtr>
              <mtd>
               <mi>b</mi>
              </mtd>
              <mtd>
               <mi>d</mi>
              </mtd>
              <mtd>
               <mi>f</mi>
              </mtd>
             </mtr>
             <mtr>
              <mtd>
               <mn>0</mn>
              </mtd>
              <mtd>
               <mn>0</mn>
              </mtd>
              <mtd>
               <mn>1</mn>
              </mtd>
             </mtr>
            </mtable>
            <mo fence="true">]</mo>
           </mrow>
           <mo>·</mo>
           <mrow>
            <mo fence="true">[</mo>
            <mtable>
             <mtr>
              <mtd>
               <mi>x</mi>
              </mtd>
             </mtr>
             <mtr>
              <mtd>
               <mi>y</mi>
              </mtd>
             </mtr>
             <mtr>
              <mtd>
               <mn>1</mn>
              </mtd>
             </mtr>
            </mtable>
            <mo fence="true">]</mo>
           </mrow>
          </mrow>
         </mrow>
        </math>
       </p>

      <p>
       which gives the equations:
      </p>

      <p>
       <code>
        x' = a x + c y + e<br>
        y' = b x + d y + f
       </code>
      </p>

      <p>
       See the technical notes for the above functions to see how various
       transformations are achieved by specifying the coefficients of this
       matrix.  Note also that this function can be used to create skews as
       well as rotations, translations, and scales.
      </p>
      </div>

      <div>
       <p>
        <b>Technical Note:</b> If you want to reverse this transformation, or
        any of the above transformations, the inverse equations are:
       </p>
      
       <p>
        <code>
          x =&nbsp;&nbsp;(c (f - y') - d (e - x')) / (a d - b c)<br>
          y =           -(a (f - y') - b (e - x')) / (a d - b c)
        </code>
       </p>

      </div>

    </td></tr><tr><td>saveTransform[]</td><td>Saves the current state of the
      graphics transform so it can later be restored with a call to
      <code>restoreTransform[]</code>

    </td></tr><tr><td>restoreTransform[]</td><td>Restores the state of the
      graphics transform to the point where the last
      <code>saveTransform[]</code> was called.
  </td></tr></tbody></table>

  <h3><a name="ClippingGraphics">Clipping Graphics</a></h3>
  <p>
   To constrain the area in which graphics can be drawn, you can specify a
   clipping region on a <code>graphics</code> object.  <em>After</em> you set
   a clipping region, subsequent drawing commands will only be drawn within
   that region.
  </p>

  <p>
   A cool thing about the clipping implementation is that, like all of Frink's
   graphics, you can draw to any coordinate system that makes sense to you,
   even if it's rotated, scaled, skewed, and clipped, and Frink will
   automatically center and scale that into your graphics window by default,
   greatly simplifying many graphics programming tasks.  In other words,
   clipping can be used to "zoom in" on a section of a larger graphic--just
   set a clipping region before drawing the graphic and only the section
   within the clipping region will be displayed.
  </p>
  
  <p>
   Each time you add a clipping boundary, it <em>narrows</em> the existing
   clipping boundary, and the clipping boundary will become the intersection
   of the previous clipping boundary and the new clipping boundary.
  </p>

  <p>
   Clipping boundaries can be saved and restored with the
   <code><i>graphics</i>.saveClip[]</code> and
   <code><i>graphics</i>.restoreClip[]</code> methods.  Currently, these
   must be properly nested with
   <code><i>graphics</i>.saveTransform[]</code> and
   <code><i>graphics</i>.restoreTransform[]</code> calls.
  </p>

  <p>
   The following methods are on a <code>graphics</code> object.
  </p>
  
  <table summary="Clipping Methods">
    <tbody><tr><th>Method</th><th>Description
    </th></tr><tr><td>clipRectSize[left, top, width, height]</td><td>Adds a new
      clipping rectangle with top left coordinate x,y and the specified width
      and height.   If the width or height are negative, the clipping
      rectangle is drawn to the left or to the top of that point.

    </td></tr><tr><td>clipRectSides[x1, y1, x2, y2]</td><td>Adds a new clipping
      rectangle with the specified sides.

    </td></tr><tr><td>clipRectCenter[cx, cy, width, height]</td><td>Adds a new
      clipping rectangle with the specified centerpoint, width, and height.

    </td></tr><tr><td>clipEllipseSize[left, top, width, height]</td><td>Adds a new
      clipping ellipse with top left coordinate x,y and the specified width
      and height.   If the width or height are negative, the clipping
      elipse is drawn to the left or to the top of that point.

    </td></tr><tr><td>clipEllipseSides[x1, y1, x2, y2]</td><td>Adds a new clipping
      ellipse with the specified sides.

    </td></tr><tr><td>clipEllipseCenter[cx, cy, width, height]</td><td>Adds a new
      clipping ellipse with the specified centerpoint, width, and height.

    </td></tr><tr><td>clip[<i>shape</i>]</td><td>Adds the specified shape to the
      current clipping boundary.  The shape may be either a rectangle, ellipse,
      <code>polygon</code>, or <code>GeneralPath</code>. (The new clipping
      boundary is the <em>intersection</em> of the old boundary and the new
      boundary, always making the clipping boundary smaller.)

    </td></tr><tr><td>saveClip[]</td><td>Saves the current clipping region so
      it can later be restored with a call to <code>restoreClip[]</code>.

    </td></tr><tr><td>restoreClip[]</td><td>Restores the current clipping region
      to the state it had at the last call to <code>saveClip[]</code>.
      Currently, these calls must be properly nested with
      <code><i>graphics</i>.saveTransform[]</code> and
      <code><i>graphics</i>.restoreTransform[]</code> calls.
  </td></tr></tbody></table>

  <h3><a name="ConstrainingViewport">Constraining Viewport</a></h3>
  <p>
   By default, Frink's graphics are automatically scaled and centered in the
   display.  All of the graphics that you draw will automatically be visible,
   no matter what coordinate system you use.  However, sometimes you may want
   to have fine-grained control over the region that is displayed, even if you
   don't fill it entirely, or if you want to draw outside the region, or if
   you want to "zoom in" on just part of a graphic.
  </p>
   
  <p>
   If you want to constrain the viewport of a graphics object, you can do so
   by drawing a transparent rectangle (or other shape) to set the minimum
   size, and by clipping to a rectangle (or other shape) to set the maximum
   size.  This is intentionally somewhat vague because Frink's graphics
   operations allow for a wide variety of viewport settings with many shapes.
  </p>

  <p>
   For example, to set the viewport to a rectangle, do something like the
   following with your <code>graphics</code> object <em>before</em> drawing to
   it:
  </p>

  <p>
   <code>
    g = new graphics[]<br>
    <code>// optionally set your background color with g.backgroundColor[<i>r</i>, <i>g</i>, <i>b</i>]</code><br>
    g.color[0,0,0,0] <code>// Transparent black</code><br>
    g.fillRectSides[<i>x1</i>, <i>y1</i>, <i>x2</i>, <i>y2</i>] <code>// Set minimum size</code><br>
    g.clipRectSides[<i>x1</i>, <i>y1</i>, <i>x2</i>, <i>y2</i>] <code>// Set maximum size</code><br>
    g.color[0,0,0]  <code>// Color back to default black</code><br>
     <code>// Now draw your graphics</code>
   </code>
  </p>

  <p>
   You can also clip to other shapes, such as circles, ellipses,
   polygons, <code>GeneralPath</code>, etc.  You can also use other
   convenience methods such
   as <code>fillRectSize</code>, <code>fillRectCenter</code>, <code>clipRectSize</code>, <code>clipRectCenter</code>,
   etc., if they are more convenient.
  </p>

  <h3><a name="Antialiasing">Antialiasing</a></h3>
  <p>
   By default, graphics and text are antialiased on most platforms.  That is,
   edges of lines and text are smoothed and slightly blurred to reduce jagged
   edges.  This may be unwelcome in some situations, such as when drawing many
   adjacent rectangles.  Antialiasing of graphics and text can be controlled
   by the following methods on a <code>graphics</code> object.

  </p><table summary="Antialiasing Methods">
    <tbody><tr><th>Method</th><th>Description </th></tr><tr><td>antialiased[<i>boolean</i>]</td><td>If set to <code>false</code>,
      all subsequent shape drawing operations to that <code>graphics</code>
      object will no longer be anti-aliased.  (Note that this does not affect
      anti-aliasing of text, which is controlled separately by the
      <code>antialiasedText</code> function below.)  This may be turned on and
      off over the course of drawing a single <code>graphics</code> object.
      Not all graphics environments support control of anti-aliasing, as noted
      below:

      <ul>
       <li><b>SVG</b>: The SVG specification does not directly allow control
        of antialiasing, but Frink sets the <a href="https://www.w3.org/1999/07/06/WD-SVG-19990706/render.html#RenderingProperties" target="_blank"><code>shape-rendering="crispEdges"</code></a>
        rendering property (link opens in new window), which seems to turn off
        antialiasing in many rendering environments.
        
       </li><li><b>HTML5</b>:  The HTML5 canvas specification does not seem to
        allow any control of antialiasing, so this does nothing.
      </li></ul>
      
    </td></tr><tr><td>antialiasedText[<i>boolean</i>]</td><td>If set to
      <code>false</code>, all
      subsequent text drawn to that <code>graphics</code> object will
      no longer be anti-aliased.  This may be turned on and off over the
      course of drawing a single <code>graphics</code> object.  Not all
      environments support control of anti-aliased text, as noted below:

      <ul>
       <li><b>SVG</b>: The SVG specification does not directly allow control
        of antialiasing, but this sets the <a href="https://www.w3.org/1999/07/06/WD-SVG-19990706/render.html#RenderingProperties" target="_blank"><code>text-rendering="optimizeSpeed"</code></a>
        rendering property (link opens in new window), which seems to turn off
        text antialiasing in many rendering environments.
        
       </li><li><b>HTML5</b>:  The HTML5 canvas specification does not seem to
        allow control of antialiasing, so this does nothing.
      </li></ul>
  </td></tr></tbody></table>
  
  <h3><a name="ShowingGraphics">Showing Graphics</a></h3>
  <p>
   Once a <code>graphics</code> object has been constructed, it can be shown
   on-screen, printed, or written to a file using the following methods:
  </p>
  
  <table summary="Graphics Show Methods">
    <tbody><tr><th>Method</th><th>Description
    </th></tr><tr><td>show[]</td><td>Displays the graphic object using the
      default method.  On most platforms, this opens a new resizable window.
      Note that this method returns an object that can be used to repaint the
      graphics.  See the <a href="#Animation">Animation</a> section of the
      documentation for more.

    </td></tr><tr><td>show[<i>insets</i>]</td><td>Displays the graphic object using the
      default method, specifying the insets as a value between 0 and 1 where 1
      means to use 100% of the window with the graphic (no borders.)  An insets
      value of 0.95 causes 95% of the window's width and/or height to be
      used by the graphic, and 5% as borders.  On most platforms, this opens a
      new resizable window.  Note that this method returns an object that can
      be used to repaint the graphics.  See the <a href="#Animation">Animation</a> section of the documentation for more.
      
    </td></tr><tr><td>show[<i>width, height</i>]</td><td>Displays the graphic
    object using the default method, specifying the width and height of the
     window as integers.  Note that this method returns an object that can be
    used to repaint the graphics.  See the <a href="#Animation">Animation</a>
    section of the documentation for more.

    </td></tr><tr><td>show[<i>width, height, insets</i>]</td><td>Displays the
      graphic object using the default method, specifying the width and height
      of the window as integers, and the insets as a floating-point value
      between 0 and 1, where 1 means to use 100% of the window with the graphic
      (no borders.)  An insets value of 0.95 causes 95% of the window's width
      and/or height to be used by the graphic, and 5% of the window's width
      and/or height to be borders.
      
    </td></tr><tr><td>print[]</td><td>Prints the graphics object to a single page
      on a printer.  This will produce a print dialog that allows you to
      select the printer, and the orientation and margins for the page.
      
    </td></tr><tr><td>print[<i>insets</i>]</td><td>Prints the graphics object to
      a single page on a printer.  This will produce a print dialog that
      allows you to select the printer, and the orientation and margins for
      the page.  <code>insets</code> is a floating-point value
      between 0 and 1, where 1 means to use 100% of the window with the graphic
      (no borders.)  An insets value of 0.95 causes 95% of the window's width
      and/or height to be graphics, and 5% as borders.  These insets are
      <em>in addition</em> 
      to any margins you set in the print dialog.  (Specifying insets is
      usually only necessary when rendering a background color that you want
      to have extend a certain distance around the graphic.)
      
    </td></tr><tr><td>printTiled[<i>pagesWide, pagesHigh</i>]</td><td>Prints the
      graphics object tiled across multiple pages on a printer.  This allows
      very large graphics to be printed.  The arguments indicate how many
      printer pages wide and high the graphic should be drawn.
      
    </td></tr><tr><td>printTiled[<i>pagesWide, pagesHigh,
       insets</i>]</td><td>Prints the graphics object tiled across multiple pages
      on a printer.  This allows very large graphics to be printed.  The
      arguments indicate how many printer pages wide and high the graphic
      should be drawn. <code>insets</code> is a floating-point value between 0
      and 1, where 1 means to use 100% of the window with the graphic (no
      borders.)  An insets value of 0.95 causes 5% of the window's width
      and/or height to be borders. These insets are <em>in addition</em> to
      any margins you set in the print dialog.  (Specifying insets is usually
      only necessary when rendering a background color that you want to have
      extend a certain distance around the graphic.)

    </td></tr><tr><td>invertGrays[]</td><td>Takes a <code>graphics</code> and
      returns a new <code>graphics</code> object in which the black colors are
      turned to white and the whites are turned to black, with all the colors
      near to gray inverted the same way.  This does not affect other colors;
      red remains red.  This is useful for making graphics that look like
      Wargames on-screen (black background with white lines) but don't destroy
      your printer ink budget.  A typical usage would be:

      <p>
       <code>
        <code>// Draw default graphics which are black on white background</code><br>
        g.invertGrays[].show[]  <code>// Make it look like Wargames on screen</code><br>
        g.print[]  <code>// Don't use up my printer ink, Joshua</code>
       </code>
      </p>

    </td></tr><tr><td>toBase64[<i>format, width, height</i>]</td><td>Encodes the
      graphic as a string which represents a base-64 encoded bitmap in the
      specified format (<i>e.g.</i> formats include "jpg", "png") at the
      specified width and height.  This may be included in an HTML document as
      a <code>data</code> URI, included in an email, etc.
      
    </td></tr><tr><td>write[<i>filename, width, height</i>]
      <p>writeTransparent[<i>filename, width, height</i>]
      </p><p>write[<i>filename, width, height, insets</i>]
      </p><p>writeTransparent[<i>filename, width, height, insets</i>]
     </p></td><td>Writes the image to a file with the specified width and height
      (usually in pixels).  The format of the file is guessed from the
      filename's extension.  If the <code>writeTransparent</code> method is
      called, and if the image format supports it, the image will be rendered
      with a transparent background, allowing you to stack and create
      composite images with full anti-aliasing and background support.

      <p>If exactly one of <code>width</code> or <code>height</code> are
       specified as <code>undef</code>, and the other is an integer, the size
       of the undefined axis will be calculated from the defined width or
       height and the aspect ratio of the
       <code>graphics</code> that is being drawn.
      </p>

      <p>
       In the versions of these functions where <code>insets</code> is
       specified, the value of that argument indicates how wide a border
       should be left when drawing.  When specifying <code>1</code> (indicating
       100%) to the <code>insets</code> argument, the drawn image occupies
       100% of the width and height, with no border.  By default, only 95%
       (0.95) of the width or height is used, leaving a small 5% border around
       the drawn graphics.  Specifying the insets is important when rendering
       image files out at their original size.  See the <a href="#Images">Images</a> section of the documentation for more.
       
      </p><p>The file formats supported by
      your version of Java may vary, but the following should be supported:
      
      </p><ul>
       <li><b>JPEG</b>: Does not support transparency.  Requires Java 1.4 or
        later.
       </li><li><b>PNG</b>: (Portable Network Graphics) Supports transparency and
        full anti-aliasing of transparent graphics.  Requires Java 1.4 or
        later.
       </li><li><b>SVG</b>: (Scalable Vector Graphics) A vector format that is
        infinitely resizable.  Supports transparency.  By default, all
        backgrounds in SVG graphics are transparent.  Works in all versions
        of Java.  <em>Warning:</em>  Due to a deficiency in the SVG standard,
        drawings with dimensions of length (e.g. "1 inch") may not work
        properly for some shapes, notably polygons, polylines, and GeneralPath.
       </li><li><b>SVGZ</b>: (Scalable Vector Graphics, compressed with GZIP)  This
        is the same as the SVG format, but is compressed with the GZIP
        compression algorithm.  Since SVG files usually contain a lot of
        repetition, using this format will significantly reduce file size and
        should be parseable by most/all programs that can handle SVG files.
       </li><li><a name="html5"><b>HTML</b></a>: (HTML5 canvas support required)
        While HTML5 will not be a finalized specification until at least 2014,
        major modern browsers for desktop and mobile devices (Firefox, Chrome,
        Opera, Safari, IE) support the HTML5 features that Frink requires.
        <ul>
         <li>Transmission of vector graphics in vector formats, allowing
          efficient, antialiased rendering of vector graphics.

         </li><li>Bitmapped images are transmitted within the HTML document as
          embedded <code>data</code> URIs encoded in base-64, allowing you to
          send the entire graphic as a single HTML file.  Bitmapped images are
          transmitted at the end of the file, and displayed as they are loaded,
          allowing progressive display of documents containing multiple
          bitmaps.

         </li><li>All of Frink's graphics primitives are supported, including
          bitmaps, <code>GeneralPath</code>, partially-transparent graphics,
          rotations, translations, and scaling.

         </li><li>HTML5 is rendered to relatively simple, user-modifiable code.

         </li><li><i>What doesn't work in HTML5 (future wish list):</i>
          <ul>
           <li>Drawings with dimensions (<i>e.g.</i> a rectangle with width
            <code>1 inch</code>) does not get rendered properly to HTML5.  I'm
            still doing research to see if we can get a reasonable resolution
            figure from the rendering environment.
            
           </li><li>HTML5, for some ungodly reason, for a long time did not not
            support the <a href="https://en.wikipedia.org/wiki/Even-odd_rule">even-odd
             winding rule</a> for filling graphics, which becomes important
            when drawing an arbitrary <code>GeneralPath</code> and
            self-intersecting or concentric filled polygons.  HTML5 only
            supported the rather stupid and useless <a href="https://en.wikipedia.org/wiki/Nonzero-rule" target="_blank">nonzero winding rule</a> which will make some 
            objects with "hollow" centers not render the same in HTML5 as they
            do in all other sane environments (e.g. Swing, AWT, Android, SVG,
            PostScript, PDF).
            
            <p>
             However, this problem is being gradually addressed in current
             browsers, (but not yet in the <a target="_blank" href="http://www.w3.org/TR/2dcontext/#fill-and-stroke-styles">official HTML5 Canvas spec</a>!) but your browser
             needs to support the HTML 
             Canvas's <code>context.fill("evenodd")</code> method for Frink's
             graphics to work properly now.  This appears to be supported in
             current versions of Firefox (21+), Firefox on Android, Chrome
             (27+), Opera (15+), Safari 8.0, and IE11 (<a href="http://msdn.microsoft.com/en-us/library/ie/ff975415%28v=vs.85%29.aspx">according to this</a>).

           </p></li><li>Animation is not yet possible in HTML5.  It's not clear if this
            will be easy without porting all of Frink to JavaScript.

           </li><li>All bitmapped graphics are embedded in PNG format.  These may
           be larger than the corresponding JPEG graphics, but they are
           lossless and allow alpha channels, which JPEG does not allow.  It's
           possible that there may be a switch in the future to embed bitmaps
           in JPEG format and to control the quality, or the renderer may get
           "smarter" and determine if alpha channels are present, and switch
           rendering formats for efficiency.

           </li><li>When rendering just a portion of a bitmapped image to HTML5,
           the entire original bitmap file is transmitted in the HTML5
           document.

           </li><li>If the browser doesn't support the HTML5 <code>canvas</code>
           element, Frink could theoretically render a small thumbnail image
           (or full-resolution image, but that would be wasteful) showing the
           user what they're missing.  If the browser doesn't support
           <code>canvas</code>, the user is warned about possibly needing to
            open the document in a newer browser.

           </li><li>There appears to be no way to control <a href="#Antialiasing">antialiasing</a> in the HTML5 spec
          </li></ul>
        </li></ul>

      </li></ul>

       
    </td></tr><tr><td>writeFormat[<i>filename, format, width, height</i>]<p>writeFormatTransparent[<i>filename, format, width, height</i>]
     </p></td><td>Writes
      to a file, explicitly specifying the format.  The format should be a
      string containing one of <code>"svg", "SVG", "svgz", "SVGZ", "jpeg",
       "JPEG", "jpg", "JPG", "png", "PNG", "html", "HTML"</code>, or possibly
      another format that your platform understands (like "<code>webp</code>" /
      "<code>WEBP</code>" on Android.)
      
    </td></tr><tr><td>ANSI[<i>columns=60</i>]
     </td><td>Renders the graphic as full-color ANSI terminal Unicode characters.
      The terminal must support true-color ANSI and Unicode block characters.
      This allows you to preview a graphic even over an SSH connection with no
      graphics capability.
  </td></tr></tbody></table>

  <p>
   The following draws a partially-transparent circle, and then successively
   displays it on-screen, prints it, and renders it to various image files:
  </p>

  <p>
   <code>
    g = new graphics<br>
    g.color[0, 0, 1, 0.5]&nbsp;&nbsp;&nbsp;<code>// Blue,
     half-transparent</code><br>
    g.fillEllipseCenter[0,0,10,10]<p>
    
    g.show[]<br>
    g.print[]<br>
    g.write["circle.jpg", 200, 200]<br>
    g.write["circle.png", 200, 200]<br>
    g.writeTransparent["circleTrans.png", 200, 200]<br>
    g.write["circle.svg", 200, 200]<br>
    g.write["circle.html", 200, 200]
   </p></code>
  </p>

  <h3><a name="GraphicsFunctions">Graphics Functions</a></h3>
  <table summary="Graphics Functionx">
    <tbody><tr><th>Function</th><th>Description
    </th></tr><tr><td>getBoundingBox[<i>graphicsExpression</i>]</td><td>Returns
      the coordinates of the bounding box for the graphics object in the form
      <code>[left, top, right, bottom]</code>.  If the bounding box is empty
      (that is, there are no drawable elements in
      <code>graphicsExpression</code>, this returns <code>undef</code>.
  </td></tr></tbody></table>
   
  <h3><a name="Images">Images</a></h3>
  <p>
   Bitmap images can be loaded and drawn to a graphics object, displayed in
   their own window, resized, printed (including tiled across several pages,)
   drawn over, saved out to files, etc.  You can also load an image or create
   it in memory, and read or write the values of individual pixels, allowing
   image processing or analysis.
  </p>
  
  <p>
   <em>Note that Java 1.1 and earlier did not have a portable, public way to
     read and write individial pixels of images, so many of these methods
     require Java 1.2 or later.</em>
  </p>

  <p>
   To load an image, call <code>new image[<i>URL</i>]</code>, passing it a
   URL.  The URL can be of any type your Java platform understands, including a
   <code>file:</code> URL indicating a file on your local system:
  </p>

  <p>
   <code>
    img1 = new image["http://futureboy.us/images/futureboydomethumb4.gif"]<br>
    img2 = new image["file:yourfile.gif"]
   </code>
  </p>
  
  <p>
   An image can also be loaded from a Java object that contains an
   already-opened <code>java.io.InputStream</code>: <code>new
   image[<i>java.io.InputStream</i>]</code>.  This allows you to create images
   from open files, URLs, network sources, servlet containers, in-memory
   sources, etc., without writing their data to temporary files.
  </p>

  <p>
    To create a new (blank) image, specify the width and height in pixels:
  </p>
  
  <p>
   <code>
    img3 = new image[640, 480]
   </code>
  </p>

  <p>
   To copy an image, use the copy constructor:
  </p>

  <p>
   <code>
    img4 = new image[img3]
   </code>
  </p>

  <p>
   This will make a copy of all of the pixels in the image, so the copy can be
   modified without modifying the original.
  </p>

  <p>
   You can turn a <code>graphics</code> object into a bitmapped image in
   memory by using the method:
  </p>

  <p>
   <code>
    <i>graphics</i>.toImage[<i>width</i>, <i>height</i>]
   </code>
  </p>

  <p>
   or the <code>image</code> constructor:
  </p>
  
  <p>
   <code>
    new image[<i>graphics</i>, <i>width</i>, <i>height</i>]
   </code>
  </p>

  <p>
   In both of the above functions, both <code>width</code>
   and <code>height</code> are dimensionless integers, or, if exactly one
   of <code>width</code> or <code>height</code> are specified
   as <code>undef</code>, and the other is an integer, the size of the
   undefined axis will be calculated from the defined width or height and the
   aspect ratio of the <code>graphics</code> that is being drawn.
  </p>

  <p>
   This gives you a readable/writable bitmap which allows you to read and
   write the individual pixels of the graphic.  For example, to create a
   graphic and then render it to a bitmapped image in memory, you may do
   something like:
  </p>

  <p>
   <code>
    g = new graphics<br>
    g.line[0,0,1,1]<br>
    img4 = new image[g, 300, 300]
   </code>
  </p>

  <p>
   Note that there are already methods to write graphics to a bitmapped file
   format.  Using this constructor is only necessary if you want to read or
   write specific pixels of the rendered graphic <em>directly in memory</em>.
  </p>

  <p>
   The image can be then shown in its own window by calling the
   <code>.show[]</code> method:
  </p>

  <p>
   <code>
    img1.show[]
   </code>
  </p>

  <h4><a name="ImageMethods">Image Methods</a></h4>
  <p>
   The following table summarizes the methods available on an
   <code>image</code> object:
  </p>

  <table summary="Image Methods">
    <tbody><tr><th>Method</th><th>Description
    </th></tr><tr><td>getHeight[]</td><td>Returns the height of the image in
        pixels.
        
    </td></tr><tr><td>getWidth[]</td><td>Returns the width of the image in
        pixels.
        
    </td></tr><tr><td>getSize[]</td><td>Returns the dimensions of the image in
      pixels as a two-dimensional array <code>[<i>width</i>,
       <i>height</i>]</code>.  You can thus call it like:<br>
      <code>[width,height]=<i>image</i>.getSize[]</code>
        
    </td></tr><tr><td>getPixel[x,y]</td><td>Returns the pixel's color as an array
      of [red, green, blue, alpha] components between, each between 0 and 1
      inclusive.
        
    </td></tr><tr><td>getPixelInt[x,y]</td><td>Returns the pixel's color as an
      array of [red, green, blue, alpha] components between, each between 0 and
      255 inclusive.
      
    </td></tr><tr><td>getPixelAsColor[x,y]</td><td>Returns the pixel's color as
      a <code>color</code> object that can be passed to other methods that
      take color objects.
      
    </td></tr><tr><td>getPixelGrayInt[x,y]</td><td>Returns the pixel's grayscale
      value as an integer between 0 and 255 inclusive.  This is meant for
      quick processing and does not correctly perform any perceptual encoding.
      
    </td></tr><tr><td>setPixel[x, y, red, green, blue, alpha]</td><td>Sets the
      specified pixel's color to the color specified by the red, green, blue,
        alpha components, each between 0 and 1 (inclusive).
        
    </td></tr><tr><td>setPixel[x, y, red, green, blue]</td><td>Sets the
      specified pixel's color to the color specified by the red, green, blue,
      components, each between 0 and 1 (inclusive).  The pixel will be fully
        opaque.
        
    </td></tr><tr><td>setPixelInt[x, y, red, green, blue, alpha]</td><td>Sets the
      specified pixel's color to the color specified by the red, green, blue,
        alpha components, each between 0 and 255 (inclusive).
        
    </td></tr><tr><td>setPixelInt[x, y, red, green, blue]</td><td>Sets the
      specified pixel's color to the color specified by the red, green, blue,
      components, each between 0 and 255 (inclusive).  The pixel will be fully
        opaque.
        
    </td></tr><tr><td>setPixel[x, y, color]</td><td>Sets the
      specified pixel's color to a color designated by the <code>color</code>
      object.
        
    </td></tr><tr><td>averagePixels[left, top, right, bottom]</td><td>Returns the
      average color of the pixels within the region specified by the given
      coordinates.  Each coordinate may be a floating-point value, and if an
      incomplete pixel is sampled, it is weighted accordingly.
      The return value is an array of [red, green, blue, alpha]
      components, each between 0 and 1 inclusive.  The values for the
      coordinates can range from 0 to (<code>im.getWidth[]</code> or
      <code>im.getHeight[]</code>,) inclusive, indicating, for example, the
      left and right side of the pixel (or subpixel) to be sampled.  For
      example, in a 2x2 pixel image, you'd want to sample [0,0,2,2] to average
      the whole image.
        
    </td></tr><tr><td>makeARGB[]</td><td>Forces a loaded image to have an ARGB
      color model, that is, to have an 24-bit true color model with an 8-bit
      alpha channel that supports transparency.  By default, when loading an
      image, the color model is preserved and may not support true color nor
      transparency.
        
    </td></tr><tr><td>makeMono[]</td><td>Forces a loaded image to have a one-bit
      monochrome color model, if your platform supports it.  This may perform
      dithering on the image.

      <p><i>For Android</i>: Currently, the Android <a href="https://developer.android.com/reference/android/graphics/Bitmap.Config.html">Bitmap.Config</a>
      class does not support monochrome images, so this does nothing on
      Android.
       
    </p></td></tr><tr><td>write[<i>filename</i>]</td><td> - Write the image to the
      specified filename.  The format of the file is guessed from the
      filename's extension. The file formats supported by your version of Java
      may vary, but the following should be supported:
      
      <ul>
       <li><b>JPEG</b>: Does not support transparency.  Requires Java 1.4 or
        later.
       </li><li><b>PNG</b>: (Portable Network Graphics) Supports transparency and
        full anti-aliasing of transparent graphics.  Requires Java 1.4 or
        later.
      </li></ul>

    </td></tr><tr><td>toBase64[<i>format</i>]</td><td>Returns a base-64 encoded
      string which represents the bitmap in the specified image format
      (<i>e.g.</i> "jpg", "png").  This may be included in an HTML document as
      a <code>data</code> URI, included in an email, etc.
            
    </td></tr><tr><td>mirrorX[]</td><td>Flips the image horizontally and returns
      a new image.
      
    </td></tr><tr><td>mirrorY[]</td><td>Flips the image vertically and returns
      a new image.

    </td></tr><tr><td>toColorChannels[]</td><td>Turns the bits of the image into
      a array of (probably 4) <code>ComplexArray2D</code> objects (the class
      may change to be real values only) which correspond to the red, green,
      blue, and alpha channels.  This array can be turned back into
      an <code>image</code> using the constructor <code>new
      image[<i>array</i>]</code>.

    </td></tr><tr><td>toComplexArray[]</td><td>Turns the bits of the image into a
      single grayscale 2-dimensional array of complex values, as
      a <code>ComplexArray2D</code> object which can be
      transformed quickly with the <a href="#FourierTransforms">Fourier
      transform</a> functions.  The behavior of this method will probably
      change.
      
    </td></tr><tr><td>toComplexArrayFromLog[<i>center=false</i>]</td><td>Assumes that
      this image contains magnitude and phase information (green encodes
      magnitude, red encodes phase) of a
      logarithmically-encoded <a href="#FourierTransforms">Fourier
      transform</a> of an image, and reconstructs a 2-dimensional
      <code>ComplexArray2D</code> with the values from the image.  In other
      words, this is the inverse
      of <code>ComplexArray2D.toLogImage[<i>decenter=false</i>]</code>.  The
      behavior of this method will probably change.  See the sample
      program <a href="https://frinklang.org/fsp/colorize.fsp?f=FourierImage.frink">FourierImage.frink</a>
      for a sample of FFT transforming an image, writing it as a log-encoded
      image, reading it back, and inverse-transforming back to the original
      image.

      <p>The boolean center/decenter parameter (default is false) will center
      the DC (zero-frequency) term in the the center of the image to mimic the
      convention used by many digital image processing texts.  In other words,
      if <code>center</code> is true, the DC term will be located at the x
      coordinate (width + 1) div 2 (for an image that is an even number of
      pixels wide, this is just width/2) and at the y coordinate (height + 1)
      div 2 (for an image that is an even number of pixels high, this is just
      height/2).  If <code>center</code> is false, the DC component will be at
      (0, 0) The same flag should be passed to
      <code>toComplexArrayFromLog</code> and
      <code>ComplexArray2D.toLogImage</code>.
      
    </p></td></tr><tr><td>show[]</td><td>Displays the image (by default, in its own
      window.)

    </td></tr><tr><td>show[<i>title</i>]</td><td>Displays the image (by default,
      in its own window) with the specified title.

    </td></tr><tr><td>print[]</td><td>Prints the image to a printer.

    </td></tr><tr><td>print[<i>insets</i>]</td><td>Prints the image to a
      printer.  <code>insets</code> is a floating-point value
      between 0 and 1, where 1 means to use 100% of the window with the graphic
      (no borders.)  An insets value of 0.95 causes 5% of the window's width
      and/or height to be borders.  These insets are <em>in addition</em>
      to any margins you set in the print dialog.

    </td></tr><tr><td>printTiled[<i>pagesWide, pagesHigh</i>]</td><td>Prints the
      image to a printer, tiled across several pages to make a very large
      image.

    </td></tr><tr><td>printTiled[<i>pagesWide, pagesHigh,
       insets</i>]</td><td>Prints the image to a printer, tiled across several
      pages to make a very large image. <code>insets</code> is a floating-point value
      between 0 and 1, where 1 means to use 100% of the window with the graphic
      (no borders.)  An insets value of 0.95 causes 5% of the window's width
      and/or height to be borders.  These insets are <em>in addition</em>
      to any margins you set in the print dialog.

    </td></tr><tr><td>resize[<i>width, height</i>]</td><td>Resizes an image to
      the new specified width and height and returns a new image.  It does not
      modify the original image.  If either <code>width</code> or
      <code>height</code> are the special value <code>undef</code> or
      <code>0</code>, then one dimension is constrained and the other
      dimension is calculated to preserve the aspect ratio of the original
      image.

      <p>
       This is generally <em>not</em> what you want to do when drawing an
       image into a <code>graphics</code> object.  You usually only want to
       do this if you're going to write the image to a file at a different
       size, or work with individual rescaled pixels.  To draw an
       <code>image</code> into a <code>graphics</code> object at any given
       size, use one of the methods in the <a href="#DrawingImagesIntoGraphics">Drawing images into graphics</a>
       section below.  This will preserve maximum resolution across devices.
    </p></td></tr><tr><td>autocrop[]</td><td>Automatically crops the sides of an
      image where the pixels are approximately equal.  This returns a new
      image.  If all of the pixels are identical, this returns a 1x1 image.

    </td></tr><tr><td>gaussianBlur[width]</td><td>Performs a Gaussian blur with
      the specified (1 sigma) width and returns a new image.

    </td></tr><tr><td>circularBlur[radius]</td><td>Performs a circular blur with
      the specified radius and returns a new image.

    </td></tr><tr><td>unsharpMask[width, amount]</td><td>Performs an unsharp mask
      (sharpening the image) with the specified (1 sigma) width and amount
      (which is usually 1 for 100% sharpening but can be lower or higher) and
      returns a new image. 

    </td></tr><tr><td>edgeDetect[]</td><td>Applies an edge detect filter to an
      image and returns a new image.

    </td></tr><tr><td>applyKernel[<i>array2D</i>]</td><td>Applies an arbitrary
      filter / kernel to an image and returns a new
      image.  <code><i>array2d</i></code> should be a 2-dimensional array of
      numbers with odd edge sizes.  For example, a sharpening filter is
      obtained by the array

      <p>
       <code>
        [[&nbsp;0,&nbsp;-1,&nbsp;&nbsp;0],<br>
        &nbsp;[-1,&nbsp;&nbsp;5,&nbsp;-1],<br>
        &nbsp;[&nbsp;0,&nbsp;-1,&nbsp;&nbsp;0]]
       </code>
      </p>

      <p>
       Note:  If the elements of the matrix sum to (approximately) 1, then the
       average brightness of each pixel in the result should be about the same
       as in the original image, and pixel values outside the range [0,255]
       will be clamped to that range.  However, if the elements of the matrix
       do <em>not</em> sum to 1, the color channels will be normalized so that
       they fall within the range [0,255] so the result is displayable.
       The relative brightness of each color channel is now preserved.
      </p>

      <p>
       See <a href="https://en.wikipedia.org/wiki/Kernel_(image_processing)">the
        Wikipedia entry on kernels for more examples.</a>
      </p>
      
    </td></tr><tr><td>applyKernel[<i>array2D</i>, <i>normalize</i>]</td><td>Same
      as <code>applyKernel</code> above, but allows the user to decide if the
      brightness levels of the image are going to be normalized by setting the
      boolean value <code>normalize</code>.  If <code>normalize</code> is
      false, values outside the range 0 to 255 will just be clamped to fit in
      that range.  This may result in a blank image!  However, some
      implementations of, say, edge detect filters do not normalize their
      output and this allows results to look more like other implementations.
      If <code>normalize</code> is true, the ranges will be normalized to fit
      into the range 0 to 255, possibly decreasing contrast.
      
    </td></tr><tr><td>normalize[]</td><td>Normalizes the brightness levels of an
      image so that color brightnesses range from 0 to 255.

    </td></tr><tr><td>ANSI[<i>columns=60</i>]
     </td><td>Renders the graphic as full-color ANSI terminal Unicode characters.
      The terminal must support true-color ANSI and Unicode block characters.
      This allows you to preview a graphic even over an SSH connection with no
      graphics capability.
  </td></tr></tbody></table>

  <h4><a name="DrawingImagesIntoGraphics">Drawing images into graphics</a></h4>
  <p>
   Images can be drawn onto a <code>graphics</code> object with the following
   methods on the <code>graphics</code> object:
  </p>

  <table summary="Graphics Image Methods">
    <tbody><tr><th>Method</th><th>Description
    </th></tr><tr><td>draw[<i>image, left, top, width, height</i>]</td><td>Draws
      the specified image onto the <code>graphics</code> object with the
      specified top left coordinates and the specified width and height.  Note
      that this method does <em>not</em> specifically preserve the image's
      aspect ratio and thus may distort the image if the width and the height
      are not in the same ratio as in the original image.  To preserve the
      aspect ratio automatically, use one of the methods below.
      
    </td></tr><tr><td>draw[<i>image, left, top, width, height, leftSrc,
       topSrc, rightSrc, bottomSrc</i>]</td><td>Like <code>draw</code> above, but
      draws <em>part</em> of the specified image.  The parameters ending in
      <code>Src</code> contain the pixel values of the image to include.
      To preserve the aspect ratio automatically, use one of the methods below.
      
    </td></tr><tr><td>fitCenter[<i>image, cx, cy, width, height</i>]</td><td>Draws
      an image onto the <code>graphics</code> object with the specified center
      coordinates (cx,cy), making it fill the specified width and height <em>as
       much as possible without modifying the aspect ratio.</em> This will thus
      preserve the proportions of the image.

    </td></tr><tr><td>fitCenter[<i>image, cx, cy, width, height, leftSrc,
       topSrc, rightSrc, bottomSrc</i>]</td><td>Like <code>fitCenter</code> above,
      but draws <em>part</em> of an image. The parameters ending in
      <code>Src</code> contain the pixel values of the image to include.

    </td></tr><tr><td>fillCenter[<i>image, cx, cy, width,
       height</i>]</td><td>Draws an image onto the <code>graphics</code> object with
      the specified center coordinates (cx,cy), making it <em>completely fill
       the specified width and height without modifying the aspect ratio.
      Note that this may cut off part of the image!</em>

    </td></tr><tr><td>fillCenter[<i>image, cx, c,y width, height, leftSrc,
       topSrc, rightSrc, bottomSrc</i>]</td><td>Like <code>fillCenter</code> above,
      but draws <em>part</em> of an image. The parameters ending in
      <code>Src</code> contain the pixel values of the image to include.
      <em>Note that this may cut off part of the image!</em>
  </td></tr></tbody></table>

  <p>
   See the <a href="https://frinklang.org/fsp/colorize.fsp?f=rewriteImage.frink">rewriteImage.frink</a>
   sample program for an example of loading an image, writing a
   semi-transparent watermark over it, and then saving the image out to
   another file at its original size.
  </p>
  
  <h3><a name="Animation">Animation</a></h3>
  <p>
   Animation is performed by calling
   the <code>replaceGraphics[<i>g</i>]</code> method on a graphics window
   (obtained by <code><i>graphics</i>.show[]</code>) which replaces the
   graphics object with a new graphics object and repaints the window.
  </p>

   <p>A short sample of animation is available in
   the <a href="http://futureboy.us/fsp/colorize.fsp?f=animate.frink">animate.frink</a>
     sample program.
     
  </p><p>
   An on-screen graphics window can be repainted as items are added to
   its <code>graphics</code> object.  Repainting is not done automatically,
   but is under the programmer's control.  This allows the screen to be
   repainted only when desired.
  </p>

  <p>
   The <code><i>graphics</i>.show[]</code> method returns an object with a
   <code>repaint[]</code> or <code>replaceGraphics[<i>g</i>]</code> method
   that instructs the graphics window to be painted.  <em>Tip:</em> don't save
   this object if you're not planning on doing incremental animation, or set
   the variable to some value such as <code>undef</code> when animation is
   complete.  This will allow the window's resources to be garbage-collected
   as soon as possible.
  </p>

  <p>
   <code>
    g = new graphics<br>
    window = g.show[]<p>
    
    for x = 1 to 10<br>
    {<br>
    <code>// Do something that takes a long time...</code><br>
    &nbsp;&nbsp;&nbsp;g.fillRectCenter[x,0,1,1]<br>
    &nbsp;&nbsp;&nbsp;window.repaint[]<br>
    }
   </p></code>
  </p>
      
  <h3><a name="AnimatedImages">Animated Images</a></h3>
  <p>
   Frink can combine a series of <code>graphics</code> objects into a single
   animated GIF image very simply.  The series of steps is:
  </p>

  <ol>
   <li>Create an object of type <code>Animation</code>, optionally setting the
    frame rate.  The frame rate can be specified as either a time or a
    frequency, for example, <code>1/30 s</code> or <code>33 ms</code> or
    <code>30/s</code>.

    <p>
     <code>a = new Animation</code>
    </p>

    <p>
     or
    </p>
    
    <p>
     <code>a = new Animation[30/s]</code>
    </p>
    
   </li><li>Create a <code>graphics</code> object for each frame and draw into it
    using the methods described above.

    <p>
     <code>g = new graphics<br>
      ...<i>drawing code goes here</i>...
     </code>
    </p>
    
   </li><li>Add the <code>graphics</code> object to the <code>Animation</code>
    object using its <code>add</code> method:

    <p>
     <code>a.add[g]</code>
    </p>

   </li><li>Repeat steps 2 and 3 for each frame of your animation.

   </li><li>Write the animated image to a file at any resolution using the
    <code><i>Animation</i>.write[<i>filename, width, height</i>]</code> method:

    <p>
     <code>a.write["animation.gif", 400, 400]</code>
    </p>
  </li></ol>

  <h4>Animated Image Methods</h4>
  <table summary="Animated Image Methods">
    <tbody><tr><th>Method</th><th>Description
    </th></tr><tr><td>add[<i>graphics</i>]</td><td>Adds a new frame to the
      animation, represented by the <code>graphics</code> object.  This may
      also be an <code>image</code>.
      
    </td></tr><tr><td>write[<i>filename, width,
       height</i>]<br>write[<i>filename, width, height, insets</i>]</td><td>Writes the
      animation to the specified filename.  Currently, no matter what filename
      is specified, the format will be an animated GIF.  <code>width</code>
      and <code>height</code> are integers.  If the insets are
      specified, they must be a number between 0 and 1 indicating how much of
      the image is filled by the graphics.  If <code>insets</code> is 1, the
      graphics will fill the entire image with no border.

    </td></tr><tr><td>toBase64[<i>width, height</i>]</td><td>Turns the animation
      into a base-64 encoded string in animated GIF format.
  </td></tr></tbody></table>
  
  <h3><a name="SampleGraphicsPrograms">Sample Graphics Programs</a></h3>
  <p>
   Below is a small list of simple but interesting and powerful programs that
   demonstrate Frink's graphics.
  </p>

  <table summary="Graphics Sample Programs">
    <tbody><tr><th>Filename</th><th>Description
      
     </th></tr><tr><td><a href="http://futureboy.us/fsp/colorize.fsp?f=animate.frink">animate.frink</a></td><td>Demonstrates
     simple animation.

     </td></tr><tr><td><a href="https://frinklang.org/fsp/colorize.fsp?f=graphpaper.frink">graphpaper.frink</a>
     </td><td>Prints graph paper with 1 cm and 1 mm grids.  Demonstrates
      exactly-sized printing.

    </td></tr><tr><td><a href="https://frinklang.org/fsp/colorize.fsp?f=rewriteImage.frink">rewriteImage.frink</a>
     </td><td>Loads a bitmap image and writes a semi-transparent
      watermark on it and then saves it back out to a file.  Demonstrates
      image loading, drawing over images, and saving image files
      at their original size.
      
    </td></tr><tr><td><a href="https://frinklang.org/fsp/colorize.fsp?f=SolarCooker2.frink">SolarCooker2.frink</a>
    </td><td>Draws a parabola and focal point for a small solar cooker that you can
    cut out and use to make a precisely-shaped mirror for cooking hot dogs and
    such.

    </td></tr><tr><td><a href="https://frinklang.org/fsp/colorize.fsp?f=simplegraph3.frink">simplegraph3.frink</a>
    </td><td>A <em>very</em> powerful but simple program to graph just about any
      equation, no matter how complicated or ill-behaved, using Frink's <a href="#IntervalArithmetic">Interval Arithmetic</a> capabilities.

    </td></tr><tr><td><a href="https://frinklang.org/fsp/colorize.fsp?f=spiral.frink">spiral.frink</a>
    </td><td>Draws simple, colorful spirals.  Fiddle with the numbers to make
      different, interesting patterns.

    </td></tr><tr><td><a href="https://frinklang.org/fsp/colorize.fsp?f=drawSolarSystem.frink">drawSolarSystem.frink</a>
    </td><td>Draws the current position of planets in the solar system.  (With
      exaggerated scale, otherwise they're invisible.)  Requires the <a href="https://frinklang.org/frinksamp/planets.frink">planets.frink</a> and <a href="https://frinklang.org/frinksamp/sun.frink">sun.frink</a> libraries.
  </td></tr></tbody></table>
  
  <h2><a name="TemperatureScales">Temperature Scales</a></h2>
  <p>
   Temperature scales that have their zero point (kelvin, Rankine) at absolute
   zero can be multiplied and converted normally.
  </p>

  <p>
   <code>45 Rankine -&gt; K</code><br>
   <code>25</code>
  </p>
  
  <p>
   Temperature scales like Fahrenheit, Celsius, and Reaumur cannot be
   represented as normal multiplicative unit definitions because their zero
   point is not at absolute zero. 
   Thus, to avoid ambiguous "do what I mean" interpretation, you must use the
   functions <code>Fahrenheit[x]</code> or the shorter
   <code>F[x]</code>, <code>Celsius[x]</code> or the shorter
   <code>C[x]</code>, and <code>Reaumur[x]</code> to convert to/from these
   temperature scales: 
  </p>

  <p>
   To represent a Fahrenheit temperature:<br>
   <code>Fahrenheit[451]</code><br>
   or <br>
   <code>F[451]</code><br>
   <code>505.9277777777778 K (temperature)</code>
  </p>

  <p>
   To convert another temperature scale to Fahrenheit:<br>
   <code>Fahrenheit[30 K]</code><br>
   or <br>
   <code>F[30 K]</code><br>      
   <code>-405.67</code>
  </p>

  <p>
   To represent a Celsius temperature:<br>
   <code>Celsius[0]</code><br>
   or <br>
   <code>C[0]</code><br>
   <code>273.15 K (temperature)</code>
  </p>

  <p>
   To convert another temperature scale to Celsius:<br>
   <code>Celsius[30 K]</code><br>
   or <br>
   <code>C[30 K]</code><br>
   <code>-243.15</code>
  </p>

  <p>
   To convert between scales (short version):<br>
   <code>Fahrenheit[98.6] -&gt; Celsius</code><br>
   or<br>
   <code>F[98.6] -&gt; C</code><br>
   <code>37.0</code>
  </p>

  <p>
   This is equivalent to saying:<br>
   <code>Celsius[ Fahrenheit[98.6] ]</code><br>
   or<br>
   <code>C[ F[98.6] ]</code><br>
   Except this way <em>doesn't</em> turn the result into a string like the
   <code>-&gt;</code> operator does.
  </p>

  <p>
   <b>Note:</b> The units <code>degC</code> and <code>degF</code> only
   indicate the difference in the <em>size</em> of a degree in these various
   scales.  They should only be used when you're indicating the
   <em>difference</em> between two temperatures, (say, how much energy to
   raise the temperature of a gram of water by 5 degrees Celsius,)
   <em>not</em> for absolute temperatures.  Conversely, the conversion
   functions above should <em>not</em> be used when the <em>difference</em>
    between temperatures in two scales should be compared.
  </p>

  <p>
   The International System of Units (SI) considers the thermodynamic
   temperature in kelvin and the size of a degree in the kelvin system to have
   the same units.  See <a href="http://www.bipm.org/en/CGPM/db/13/3/">Resolution 3 of the 13th CGPM
    (1967/68)</a>.  This means that you can use <code>K</code> as either an
   absolute thermodynamic temperature, or a temperature difference.  However,
   this implies that Frink can't automatically guarantee that "do what I mean"
   calculations with temperature are correct, as it would have to magically
   guess what you mean.
  </p>

  <h2><a name="OtherDataSources">Other Data Sources</a></h2>
  <p>
   One of the main design goals of Frink was to allow new sources of data to
   be added in very easily.  These special sources are not necessarily defined
   in the <a href="https://frinklang.org/frinkdata/units.txt">data file</a>.  The three data
   sources listed below retrieve data on demand from up-to-the-minute data on
   the Internet (and thus require connection to the Internet.)
  </p>

  <h3><a name="HistoricalUSPriceData">Historical U.S. Price Data</a></h3>

  <p>
   <b>Obligatory Disclaimer:</b> This feature requires connection to the
   internet.  If you are using Frink on a handheld device, you may incur
   connection charges.  Also, since I cannot guarantee the availability of any
   internet sites, this feature is intended only as a bonus that may not work
   reliably if at all.  You may also require some
   <a href="#ProxyConfiguration">proxy configuration</a> if you use an FTP
   proxy server to access the web.
  </p>
  
  <p>
   The units "dollar" or "USD" indicate the value of a <em>current</em>
   U.S. dollar (which is arbitrarily chosen as the standard unit of currency.)
   Historical price data is available to allow comparisons between the
   historical "buying power" of U.S. currency.  This allows you to adjust
   historical prices for inflation.  These are represented by specially-named
   units containing both the currency and the year, separated by an
   underscore, for example:
  </p>

  <ul>
   <li>1.25 dollar_1960
   </li><li>dollar_1902
   </li><li>dollars_1902
   </li><li>10 dollars_1902
   </li><li>10 USD_1902
   </li><li>cent_1910
   </li><li>5 cents_1926
   </li><li>cent_1914
  </li></ul>

  <p>
   <strike>Data after 1913 is fetched live from the U.S. Department of Labor <a href="http://www.bls.gov/">Bureau of Labor Statistics</a>
   Consumer Price Index data, specifially by retrieving and parsing <a href="https://fred.stlouisfed.org/data/CPIAUCNS">this
    file</a>.  If that file is unavailable, the data will be fetched from a
   static file distributed with Frink, which is only as recent as your version
   of Frink.</strike>
  </p>

  <p>
   Since the U.S. Department of Labor <a href="http://www.bls.gov/">Bureau of
   Labor Statistics</a> no longer maintains a machine-readable Consumer Price
   Index file, the file is fetched from the St. Louis Federal Reserve,
   specifically by
   parsing <a href="https://fred.stlouisfed.org/data/CPIAUCNS">this file.</a>
   The new data is also cached in each Frink jar file in case you don't have
   network connectivity.  Note that as of 2024-06-30, this file has been
   changed from a nice text file to a giant, poorly-formatted HTML file that
   is 10 times larger so it will cost everyone more time and money to
   download. They said this is "to make the table more accessible for our
   users."
  </p>

  <p>
   Data from 1700 to 1912 is based on some general economists' guesses and
   should be taken with a grain of salt.  U.S. data before 1700 is not
   available, and probably wouldn't be meaningful unless you could convert
   between the value of pelts, tinder, and tallow.
  </p>

  <p>
   <b>Warning:</b> The BLS web and FTP servers seem to have frequent
   outages, and historical data will not be available if the servers are down,
   or if you are not connected to the Internet.  Frink contains an internal
   cache of the CPI data in this case.
  </p>

  <p>
   From 1913-present, you can even use monthly resolution by indicating the
   month after the year.  Months are 2 digits and padded with zeros:
  </p>

  <ul>
   <li>dollar_1969_08
   </li><li>dollars_1969_08
   </li><li>14.75 dollar_1941_12
   </li><li>14.75 USD_1941_12
   </li><li>dollars_1941_12
   </li><li>dollar_1941_12
   </li><li>15 cents_1965_10
   </li><li>4 cent_1929_01
  </li></ul>

  <p>
   Historical currency values can be converted to the current value.  For
   example to find today's cost of Mark Twain's passage to Europe and the Holy
   Land on the steamship <i>Quaker City</i> at a cost of $1250 in 1867
   (detailed in <a href="https://frinklang.org/twain/innocents/"><i>The Innocents
   Abroad</i></a>, the conversion of which was one of my first web projects):
  </p>
  
  <p>
   <code>1250 dollar_1867 -&gt; dollar</code><br>
   <code>14982.240769251547535000</code>
  </p>

  <p>
   And, you can add the 5 dollars/day in gold that they were encouraged to
   bring along to cover expenses for the 6-month trip:
  </p>

  <p>
   <code>1250 dollar_1867 + 5 dollars_1867/day 6 months
    -&gt; dollar</code><br>
   <code>26043.38587544437 </code>
  </p>

  <p>
   You can translate from one year and month to another, if you have a
   DeLorean, and want to watch a Reagan movie:
  </p>
  
  <p>
   <code>50 cents_1955_11 -&gt; dollars_1985_10</code><br>
   <code>2.020446096654275 </code>
  </p>

  <h3><a name="HistoricalBritishPriceData">Historical British Price Data</a></h3>
  <p>
   The units <code>Britain</code> or <code>Britain_Pound</code> or
   <code>Britain_currency</code> or <code>Great_Britain</code> or
   <code>Great_Britain_Pound</code> or <code>United_Kingdom_Pound</code>, or
   <code>England</code> or <code>England_currency</code> or <code>GBP</code>
   (the <a href="http://en.wikipedia.org/wiki/ISO_4217">ISO-4217</a>
   code for the U.K. Pound) indicate the <em>current</em> pound (but don't use
   <code>pound</code> by itself--that's a measure of mass.)  The exchange rate
   between the pound and all other world currencies, see below, is fetched
   live from the Internet.
  </p>

  <p>
   Historical price data is available to allow comparisons between the
   historical "buying power" of British currency, both pre- and
   post-decimalization.  Data goes back to the year 1245.  I don't know if
   data before this would be very meaningful.
  </p>

  <p>
   Historical currency values are represented by specially-named units
   containing both the currency and the year, separated by an underscore.  All
   can be used in the plural, (<i>e.g.</i> <code>pound_1960</code> or
   <code>pounds_1960</code> or <code>GBP_1960</code> are all valid).  The
   following are examples of the plethora of values up to and including 1970
   (from 1971 on, it just became pounds and pence):
  </p>

  <table summary="British Currency Unit Examples">
    <tbody><tr><th>Example</th><th>Description
    </th></tr><tr><td>guinea_1865             </td><td>A pound plus a shilling
      (21/20 pounds)
    </td></tr><tr><td>pound_1865              </td><td>Fundamental unit
    </td></tr><tr><td>GBP_1865                </td><td>Fundamental unit
    </td></tr><tr><td>sovereign_1865          </td><td>A pound coin
    </td></tr><tr><td>merk_1865               </td><td>13/6d (that is 13
      shillings and 6 pence) or 27/40 of a pound
    </td></tr><tr><td>mark_1865               </td><td>2/3 pound
    </td></tr><tr><td>noble_1865              </td><td>80 pence or 1/3 pound
    </td></tr><tr><td>crown_1865              </td><td>1/4 pound or 5 shillings
    </td></tr><tr><td>florin_1865             </td><td>2 shillings or 1/10 pound
    </td></tr><tr><td>shilling_1865           </td><td>1/20 pound or 12 pence
    </td></tr><tr><td>groat_1865              </td><td>4 pence or 1/60 pound
    </td></tr><tr><td>penny_1865 or pence_1865</td><td>1/12 shilling or 1/240 pound
    </td></tr><tr><td>farthing_1865           </td><td>1/4 penny or 1/960 pound
  </td></tr></tbody></table>

  <p>
   No wonder they went to decimalization.  It was either that or go to
   base-960 math.  
  </p>

  <p>
   To form combinations you can add them (using parentheses when necessary).
   For example, to convert a historical rate per day to current dollars/year:
  </p>

  <p>
   <code>(4 pounds_1860 + 3 shilling_1860 + 5 pence_1860) / day
    -&gt; dollars/year</code><br>
   <code>101853.3826649</code>
  </p>

  <p>
   I acknowledge that's a bit cumbersome.
  </p>

  <p>
   So, you can find out what a great amount of money was
   involved when the British Parliament announced a 20,000 pound prize in 1714
   for solving the 
   <a href="http://www.rmg.co.uk/explore/astronomy-and-time/time-facts/harrison">Longitude Problem</a>:
  </p>

  <p>
   <code>20000 pound_1714 -&gt; dollars</code><br>
   <code>2807866.8</code>
  </p>

  <p>
   That's a lot of lettuce.  For more about the fascinating history of this
   problem, I highly recommend Dava Sobel's <a href="https://www.amazon.com/exec/obidos/ASIN/0140258795/ref=pd_ecc_rvi_1/104-0183884-9196715"><i>Longitude:
   The True Story of a Lone Genius Who Solved the Greatest Scientific Problem
   of His Time</i></a>. By God, Harrison, I will see you righted.
  </p>

  <p>
   Thanks to Dan Weiler who loaned me the above book which I never returned
   (and passed along to my Grandpa.)  Sorry, Dan, I'll buy you a book of your
   choice.
  </p>

  <h3><a name="InternationalExchangeRates">International Exchange Rates</a></h3>
  <p>
   <b>Obligatory Disclaimer:</b> This feature requires connection to the
   internet.  If you are using Frink on a handheld device, you may incur
   connection charges.  Also, since I cannot guarantee the availability of any
   internet sites, this feature is intended only as a bonus that may not work
   reliably if at all.  Java versions 1.6 and before may not be able to use
   this due to cryptography limitations (Java versions 1.6 and before cannot
   negotiate Diffie-Hellman key exchanges larger than 1024 bits.)  You may
   also require some <a href="#ProxyConfiguration">proxy configuration</a> if
   you use an HTTP proxy server to access the web.
  </p>
  
  <p>
   Current exchange rate between almost all of the world's currencies is
   available.  Exchange rates are fetched live from an allegedly zero-delay
   source on the Internet.  The currency can either be specified by the name
   of the country, by the 3-letter <a href="http://en.wikipedia.org/wiki/ISO_4217">ISO-4217</a>
   code for the currency, or by one of the combinations shown below.  The
   following examples all work:
  </p>

  <ul>
   <li>Ireland
   </li><li>Ireland_currency
   </li><li>Ireland_Punt
   </li><li>IEP
   </li><li>Japan
   </li><li>Japan_currency
   </li><li>Japan_Yen
   </li><li>JPY
   </li><li>yen (this works because only Japan has a currency called "yen")
   </li><li>Yen
   </li><li>United_Arab_Emirates
   </li><li>United_Arab_Emirates_currency
   </li><li>United_Arab_Emirates_Dirham
   </li><li>AED
   </li><li>Euro
   </li><li>EUR
  </li></ul>

  <p>
   To list all of the currencies, you can use:<br>
  </p>

  <p>
   <code>units[currency]</code>
  </p>

  <p>
   or, for a more nicely-formatted table with the currency names <em>and</em>
   their values:
  </p>

  <p>
   <code>formatTable[unitsWithValues[currency]]</code>
  </p>

  <p>
   So, I'm watching "The Amazing Race" and seeing a team pay 600 Baht in
   Thailand for a hotel room.  How much is that in a currency I'm familiar
   with?
  </p>

  <p>
   <code>600 baht -&gt; USD</code><br>
   <code>13.73724</code>
  </p>

  <p>
   I could have also used <code>Thailand_Baht</code> or <code>Thailand</code>
   in the above example.
  </p>

  <p>
   You can also get the current trade rates of various precious metals
   (normalized from the obscure troy weights that these values are measured
   in.)  These are referenced using the <em>capitalized</em> name (lower case
   brings up element properties for now... this will all be addressed when I
   add object-oriented behavior to Frink) or the 3-letter ISO code (which is
   an X followed by the chemical symbol):
  </p>

  <table summary="Precious metals and their symbols">
   <tbody><tr><th>Element</th><th>ISO Code
   </th></tr><tr><td>Gold</td><td>XAU
   </td></tr><tr><td>Platinum</td><td>XPT
   </td></tr><tr><td>Silver</td><td>XAG
   </td></tr><tr><td>Palladium</td><td>XPD
  </td></tr></tbody></table>

  <p>
   <code>Gold</code><br>
   <code>8765.9010519364188896 kg^-1 USD (price_per_mass)</code>
  </p>

  <p>
   Note that this is in units of currency/mass (the international exchange
   rates for these are specified in dollars/troyounce, (but try to find that
   written somewhere)), but you can use any units of mass you want:
  </p>

  <p>
   <code>1 ton Gold</code><br>
   <code>7952291.666666666667 USD (currency)</code>
  </p>

  <p>
   Or find out how much it would be worth to melt down that necklace:
  </p>

  <p>
   <code>3 gram 18 karat Gold</code><br>
   <code>19.723277366856942501600 USD (currency)</code>
  </p>

  <p>
   <b>Note:</b> If you want to set a different base currency in your units
   file, and if you want currency conversions to still work, you should now)
   define the base currency as its 3-letter ISO-4217 currency code (say, "EUR"
   or "JPY").  This will allow the currency converter to unambiguously figure
   out which currency you mean.  The following special cases work as well:
  </p>

  <table summary="Currency Symbols">
    <tbody><tr><th>Symbol</th><th>Description
    </th></tr><tr><td>dollar</td><td>U.S. dollar
    </td></tr><tr><td>Euro</td><td>Euro
    </td></tr><tr><td>euro</td><td>euro
    </td></tr><tr><td>€</td><td>Euro symbol (Unicode <code>\u20ac</code>)
    </td></tr><tr><td>¥
     </td><td>Japanese Yen symbol (Unicode <code>\u00a5</code>)
    </td></tr><tr><td>£
     </td><td>U.K. Pound symbol (Unicode <code>\u0163</code>)
  </td></tr></tbody></table>

  <h2><a name="IntervalArithmetic">Interval Arithmetic</a></h2>
  <p>
   Frink has the magical ability to perform rigorous interval arithmetic
   throughout calculations.  So what is interval arithmetic?  Well, you can
   think of it as a "new kind of number" that represents a fuzzy range of
   values.  For example, you may know that a value lies between 1 and 2, but
   you're not quite sure where the value lies in that interval.  Depending on
   your philosophy, you can think of an interval as specifying a fuzzy error
   bound, or you can think of an interval as simultaneously taking on all
   values within its bounds.
  </p>

  <p>
   Frink can take this uncertain interval and propagate the uncertainty
   through its calculations, giving you the ability to see how the initial
   uncertainties in your values affect your final calculations.
  </p>

  <p>
   Currently, the way to indicate that something is an interval is to use the
   <code>new interval</code> syntax (although something more concise will
   likely be added later, and the output format may change.)
  </p>

  <p>
   <code>
    a = new interval[2,3]<br>
    b = new interval[5,7]
   </code>
  </p>

  <p>
   The intervals can then be manipulated in mathematical expressions, either
   with ordinary scalar variables or other intervals:
  </p>
  
  <p>
   <code>a * 3</code><br>
   <code>[6, 9]</code>
  </p>

  <p>
   <code>a + b</code><br>
   <code>[7, 10]</code><br>
  </p>

  <p>
   <code>a * b</code><br>
   <code>[10, 21]</code>
  </p>

  <p>
   Intervals may also have a "middle" or "main" value which indicates the
   best-known value.  Note that values should be specified in increasing
   order.
  </p>

  <p>
   <code>
    d = new interval[2, 2.5, 3]<br>
    e = new interval[7, 8.2, 9.4]<br>
    d * e<br>
   </code>
   <code>[14, 20.5, 28.2]</code>
  </p>

  <p>
   Of course, all intervals used in a calculation must have "main" values or
   the main value will be dropped, creating an interval with only upper and
   lower bounds.
  </p>

  <p>
   Note:  The boundaries and "main" values for intervals must be real
   numbers.  (These numbers can also have dimensions like feet, meters, etc.)
   Although there is a theory of complex intervals, it's much harder and may
   not get implemented any time soon, (although a very generous Frink user sent
   a copy of a rare $200 textbook on complex interval arithmetic which will
   help that situation!  Thanks, Joshua!)
  </p>

  <p>
   Lest you think that intervals are simpler than they are, I find that people
   better understand them when they consider the following case:
  </p>

  <p>
   <code>
    x = new interval[-2,2]
   </code>
  </p>

  <p>
   Now, let's square x.  Note that the values at each endpoint are equal to 4.
   However, over the range [-2,2], the value of x<sup>2</sup> ranges from 4,
   down to 0 (at x=0), and back up to 4.  Frink does the right thing for the
   values over this whole range:
  </p>

  <p>
   <code>x^2</code><br>
   <code>[0, 4]</code>
  </p>

  <p>
   Yeah, that <em>is</em> cool.  Frink tracks appropriate boundaries for
   intervals throughout all of your calculations.
  </p>

  <p>
   Frink's interval arithmetic is also rigorous in its treatment of error
   bounds.  It painstakingly controls the rounding direction of arithmetic
   operations so that the boundaries are guaranteed to include the
   next-largest or next-smallest representable floating-point number that
   contains the interval.  (See notes below on <a href="#IntervalArithmeticStatus">implementation status</a>.)  This
   is subtle, but I have spent a lot of work ensuring that the boundaries came
   out trustable, and no bigger than need be. For example:
  </p>

  <p>
   <code>m = new interval[3,6]<br>
    1.0/m</code><br>
   <code>[0.16666666666666666666, 0.33333333333333333334]</code>
  </p>

  <p>
   Note that the bottom bound is rounded down, and the top bound is rounded
   up.
  </p>
  
  <p>
   Currently, almost all functions have been made interval-aware.
   Implementing all functions <em>to arbitrary precision</em> will take quite
   a bit of effort.  Of course, that would be much slower, too.  Error bounds
   are unfortunately not "sharp" for all operations (meaning as tight as they
   could possibly be with limited precision.)  I've noted them as such in the
   <a href="#IntervalArithmeticStatus">Interval Arithmetic Status</a> section
   below.
  </p>

  <p>
   Not all operators such as <code>&lt; &gt; =</code> make unambiguous sense
   when applied to intervals, so Frink has introduced new operators to
   disambiguate these cases, and will implement other operators to work with
   intervals.  See the <a href="#IntervalComparisonOperators">Interval
    Comparison Operators</a> section below for more details.
  </p>

  <p>
   By default, degenerate intervals which have the same upper and lower bounds
   are "collapsed" into a single real number.  If you want to maintain them as
   intervals, call the function <code>collapseIntervals[false]</code> before
   constructing or performing mathematics on those intervals.
  </p>

  <p>
   As everyone uses Interval Arithmetic for the first time, they come upon two
   characteristic problems in the field:  the dependence problem and the
   overestimation problem.  These are common to all interval analysis, and not
   just to Frink, and are covered in extensive detail in the <a href="https://frinklang.org/faq.html#IntervalArithmetic">Interval Arithmetic section of the
    Frink FAQ.</a>
  </p>

  <p>
   For more information about the field of Interval Arithmetic, please visit
   the <a target="_blank" href="http://www.cs.utep.edu/interval-comp/">Interval Computations</a>
   website. (Link opens in new window.)

  </p><h3><a name="IntervalArithmeticExample">Interval Arithmetic Example</a></h3>
  <p>
   Interval arithmetic is an incredibly powerful feature that allows programs
   that weren't necessarily written with intervals in mind to track error
   bounds throughout your calculations, and can be magically applied to
   programs that are already written.  For example, let's take some
   calculations to find the volume and density of a sphere:
  </p>

  <p>
   <code>
    circumference = eval[input["Enter circumference of a sphere: "]]<br>
    mass = eval[input["Enter the mass of the sphere: "]]<br>
    diameter = circumference / pi<br>
    radius = diameter / 2<br>
    volume = 4/3 pi radius^3<br>
    density = mass / volume<br>
    println["The density is: " + (density -&gt; "g/cm^3")]
   </code>
  </p>

  <p>
   Now, you can run the program and enter something like "9.1 inches" for the
   circumference and "5.1 ounces" for the mass and find out the density of your
   baseball.  No surprises there.  But when you read the rules of Major League
   Baseball, you'll find that section 1.09 states:
  </p>

  <blockquote>
   <p>
    "The ball shall be a sphere formed by yarn wound around a small core of
    cork, rubber or similar material, covered with two stripes of white
    horsehide or cowhide, tightly stitched together. It shall weigh not less
    than five nor more than 5 1/4 ounces avoirdupois and measure not less than
    nine nor more than 9 1/4 inches in circumference."
   </p>
  </blockquote>

  <p>
   So, using your exact same program above, and a little interval input,
   Frink can calculate the effects of these allowed variations and show you
   the allowed range of densities of <em>any</em> legal baseball:
  </p>

  <p>
   <code>Enter circumference of a sphere:</code>
   <code>new interval[9, 9+1/4] inches</code><br>
   <code>Enter the mass of the sphere:</code>
   <code>new interval[5, 5+1/4] ounces</code><br>
   <code>The density is: [0.64720283343427980773,
    0.73778085086685322066] g/cm^3</code>
  </p>

  <p>
   The output indicates the range of uncertainties.  Note that two different
   intervals were used to perform this calculation, and the effects of their
   uncertainties was automatically tracked throughout all calculations.  All
   this in a program that wasn't even written with intervals in mind.
   Unscrupulous teams may also not that the official definition allows for a
   <em>large</em> variation in allowable densities of baseballs, which could
   be manipulated to your advantage.
  </p>

  <p>
   Also note that I put the units of measure (e.g. inches, ounces) outside the
   brackets.  You could put them inside the brackets, but you'd just have to
   write them twice in this case.  Intervals can, of course, contain units of
   measure.
  </p>

  <p>
   By the way, I'm working on a more concise notation for specifying
   intervals.
  </p>

  <h3><a name="IntervalComparisonOperators">Interval Comparison
    Operators</a></h3>
  <p>
   The relational operators (e.g. <code>&lt; == &gt;</code>, etc) work with
   intervals, but there are many ambiguous cases.  These operators try to Do
   The Right Thing when applied to intervals.  If you compare intervals that
   do not overlap, they return the appropriate result.  If, however, the
   intervals <em>do</em> overlap, they terminate the program with an error
   similar to the following:

  </p><blockquote>
   <p>
    Comparison expression: Using operator &gt; to compare intervals [1, 3]
    and [2, 4]<br>
    This operator is only defined if there is no overlap between intervals.<br>
    Please modify your program to use interval-aware comparison operators.
   </p>
  </blockquote>

  <p>
   To handle the overlapping cases, Frink defines operators like "certainly
   less than" (<code>CLT</code>) and "possibly less than" (<code>PLT</code>).
   These operators can directly replace the normal relational operators.
   These new operators also work with normal real numbers, so you can still
   write programs that run using either intervals or real numbers as input.
  </p>
  
  <table summary="Interval Comparison Operators">
    <tbody><tr><th>Operator</th><th>Description
    </th></tr><tr><td>CEQ</td><td>Certainly equals
    </td></tr><tr><td>CNE</td><td>Certainly not equals
    </td></tr><tr><td>CLT</td><td>Certainly less than
    </td></tr><tr><td>CLE</td><td>Certainly less-than-or-equal-to
    </td></tr><tr><td>CGT</td><td>Certainly greater than
    </td></tr><tr><td>CGE</td><td>Certainly greater-than-or-equal-to
    </td></tr><tr><td>PEQ</td><td>Possibly equals
    </td></tr><tr><td>PNE</td><td>Possibly not equals
    </td></tr><tr><td>PLT</td><td>Possibly less than
    </td></tr><tr><td>PLE</td><td>Possibly less-than-or-equal-to
    </td></tr><tr><td>PGT</td><td>Possibly greater than
    </td></tr><tr><td>PGE</td><td>Possibly greater-than-or-equal-to
  </td></tr></tbody></table>

  <p>
   Example:
  </p>

  <p>
   <code>
    a = new interval[1,3]<br>
    b = new interval[2,4]<br>
    a PLT b<br>
   </code>
   <code>
    true<br>
   </code>
   <code>
    a CLT b<br>
   </code>
   <code>
    false
   </code>
  </p>

  <p>
   The “possibly” and “certainly” operators are related to each other by the
   following property: The “possibly” operator is the inverse of the opposite
   “certainly” operator. For example, <code>PLT</code> (possibly less than) is
   the inverse of the <code>CGE</code> (certainly greater than or equal)
   operator.  That is, when <code>PLT</code>
   returns <code>true</code>, <code>CGE</code> returns <code>false</code> and
   vice versa.
  </p>

  <h3><a name="IntervalArithmeticStatus">Interval Arithmetic Status</a></h3>
  <p>
   As noted above, not all functions are implemented for intervals.  The
   following table notes the status of the implementation of various operators
   and functions.  If a function does not appear on this list, it may still
   return values for interval arguments, but you shouldn't trust it because I
   haven't evaluated it for discontinuities or non-monotonicity yet.
  </p>

  <table summary="Interval Arithmetic Status">
    <tbody><tr><th>Function / Operator</th><th>Arbitrary Precision?</th><th>Rigorous Error
      Bounds?</th><th>Notes
    </th></tr><tr><td>+</td><td>Y</td><td>Y
    </td></tr><tr><td>-</td><td>Y</td><td>Y
    </td></tr><tr><td>*</td><td>Y</td><td>Y
    </td></tr><tr><td>/</td><td>Y</td><td>Y
    </td></tr><tr><td>mod</td><td>Y</td><td>Y
    </td></tr><tr><td>^</td><td>N</td><td>N
     </td><td>Performed to hardware precision only.
    </td></tr><tr><td>floor[<i>x</i>]</td><td>Y</td><td>Y
    </td></tr><tr><td>ln[<i>x</i>]</td><td>N</td><td>Y
     </td><td>Performed to hardware precision only.
    </td></tr><tr><td>log[<i>x</i>]</td><td>N</td><td>N
     </td><td>Performed to hardware precision only.
    </td></tr><tr><td>exp[<i>x</i>]</td><td>N</td><td>Y
     </td><td>Performed to hardware precision only.
    </td></tr><tr><td>sin[<i>x</i>]</td><td>N</td><td>N
     </td><td>Performed to hardware precision only.
    </td></tr><tr><td>cos[<i>x</i>]</td><td>N</td><td>N
     </td><td>Performed to hardware precision only.
    </td></tr><tr><td>tan[<i>x</i>]</td><td>N</td><td>N
     </td><td>Performed to hardware precision only.
    </td></tr><tr><td>sec[<i>x</i>]</td><td>N</td><td>N
     </td><td>Performed to hardware precision only.
    </td></tr><tr><td>csc[<i>x</i>]</td><td>N</td><td>N
     </td><td>Performed to hardware precision only.
    </td></tr><tr><td>cot[<i>x</i>]</td><td>N</td><td>N
     </td><td>Performed to hardware precision only.
    </td></tr><tr><td>arccos[<i>x</i>]</td><td>N</td><td>Y
     </td><td>Performed to hardware precision only.
    </td></tr><tr><td>arcsin[<i>x</i>]</td><td>N</td><td>Y
     </td><td>Performed to hardware precision only.
    </td></tr><tr><td>arctan[<i>x</i>]</td><td>N</td><td>Y
     </td><td>Performed to hardware precision only.
    </td></tr><tr><td>arctan[<i>y</i>, <i>x</i>]</td><td>N</td><td>N
     </td><td>Performed to hardware precision only.
      Returns <code>arctan[y/x]</code> corrected for quadrant.  Arguments can
      be real or intervals.  Has some corrections to range of function to
      eliminate branch discontinuity across x=0 when y&lt;0.
    </td></tr><tr><td>sqrt[<i>x</i>]</td><td>N</td><td>N
     </td><td>Performed to hardware precision for floating-point numbers, exact
      values for integers that produce exact integer values.
    </td></tr><tr><td>infimum[<i>x</i>]</td><td>Y</td><td>Y
     </td><td>Returns the infimum (lower bound) of an interval.  If called with a
      number that is not an interval, just returns the number.
    </td></tr><tr><td>supremum[<i>x</i>]</td><td>Y</td><td>Y
     </td><td>Returns the supremum (upper bound) of an interval.  If called with a
      number that is not an interval, just returns the number.

      
    </td></tr><tr><td>arg[<i>x</i>]</td><td>Y</td><td>Y
     </td><td>Returns the "argument" (that, is the phase) of a complex (or real)
     number.  For a complex number z = x + i y, this is equivalent to
     <code>arctan[y,x]</code>.
      
    </td></tr><tr><td>magnitude[<i>x</i>]</td><td>Y</td><td>Y
     </td><td>Returns the absolute value of the endpoint furthest from zero.  If
      called with a real number, just returns the number.  If called with a
      complex number, returns the absolute value (the magnitude) of the
      complex number.
      
    </td></tr><tr><td>mignitude[<i>x</i>]</td><td>Y</td><td>Y
     </td><td>Returns the absolute value of the endpoint <em>closest to</em> zero.
      If called with a real number, just returns the number.  If called with a
      complex number, since "mignitude" of a complex number is generally not
      defined, this also returns the absolute value (the magnitude) of the
      complex number.
      
    </td></tr><tr><td>mainValue[<i>x</i>]</td><td>Y
     </td><td>Y
     </td><td>Returns the main (middle) value of an interval.  If the interval does
      not have a middle value, returns <code>undef</code>. If called with a
      number that is not an interval, just returns the number.
  </td></tr></tbody></table>
  
  <h3><a name="DateTimeIntervals">Date/Time Intervals</a></h3>
  <p>
   An interval can also be composed of date/times.  The syntax is very similar:
  </p>

  <p>
   <code>
    a = new interval[now[], now[] + 3 days]<br>
   </code>
  </p>

  <p>
   <code>
    b = new interval[#1969-08-19#, #2005-06-11#]<br>
   </code>
  </p>
  
  <p>
   You can then perform <a href="#DateTimeArithmetic">Date/Time arithmetic</a>
   on the values.
  </p>

  <h2><a name="JavaIntrospection">Java Introspection</a></h2>
  <p>
   Missing a function that you need?  Frink can directly call Java code to let
   you take advantage of any Java library that's in your classpath.  Thus, you
   can use your favorite graphing package, connect to a database, perform
   lower-level networking, and more, directly from within Frink.
  </p>

  <p>
   Java objects can be manipulated just like Frink objects, by calling their
   methods or accessing their fields:
  </p>

  <p>
   <b>Method call:</b>  Note that method calls on Java objects use square
   brackets, as they do in all Frink function and method calls:
  </p>
   
  <p>
   <code>
    <i>obj.method[args]</i>
   </code>
  </p>

  <p>
   <b>Member variable access:</b>
  </p>
   
  <p>
   <code>
    <i>obj.field</i>
   </code>
  </p>

  <p>
   Java objects that implement the interfaces
   <code>java.util.Enumeration</code>, <code>java.util.Iterator</code>, or
   <code>java.lang.Iterable</code> can be used as a Frink enumerating
   expression, allowing them to be used in <code>for</code> loops or other
   places that allow <a href="#EnumeratingExpressions">enumerating expressions</a>.
  </p>

  <p>
   The Java <code>null</code> will be converted to/from the Frink type
   <code>undef</code>.
  </p>

  <h3><a name="CreatingJavaObjects">Creating Java Objects</a></h3>
  <p>
   New Java objects can be created with the <code>newJava[classname]</code>
   and <code>newJava[classname, argList]</code> functions.  These call Java
   constructors with the specified arguments.  If the constructor takes a
   single argument, <code>argList</code> can be a single value, otherwise it
   should be an array of values.  If the constructor takes no arguments, then
   the last argument can be eliminated entirely.  The following creates a new
   Frame and calls some methods on the Frame to display it.  Note that the
   method calls require square brackets.
  </p>

  <p>
   <code>f = newJava["javax.swing.JFrame", "Frink Rules!"]<br>
    f.setSize[200,200]<br>
    f.show[]<br>
    f.toFront[]</code>
  </p>

  <p>
   Arrays of Java objects, including primitives, can be constructed with the
   <code>newJavaArray[<i>classname</i>, <i>length</i>]</code>
   method.
  </p>

  <p>
   <code>
    d = newJavaArray["byte", 1024]<br>
    d@0 = 0x65
   </code>
  </p>
  
  <p>
   The classname should
   be a string containing either be a fully-qualified classname
   (e.g. <code>"java.util.Hashtable"</code>) or a primitive type name,
   (e.g. <code>"int"</code> or <code>"double"</code>).  Elements of Java
   arrays are addressed the same way as other <a href="#Arrays">arrays</a>.
  </p>

  <p>
   Multi-dimensional arrays of Java objects can be created by the same
   function, but with an array of integers specifying the size of each
   dimension.  For example, the following creates a two-dimensional array of
   <code>double</code> with dimensions 3 by 4:
  </p>

  <p>
   <code>
    d = newJavaArray["double", [3,4]]<br>
    d@0@0 = 3.14
   </code>
  </p>

  <p>
   The initial value of all of the elements of a new Java array can be
   specified with the three-argument version of the
   function: <code>newJavaArray[<i>classname</i>, <i>length</i>, <i>initValue</i>]</code>:
  </p>
   
  <p>
   <code>
    d = newJavaArray["double", [3,4], 3.14]<br>
   </code>
  </p>

  <p>
   Yes, this is <em>much</em> simpler than doing the same thing in Java!
  </p>

  <p>
   The methods on a Java object can be listed using the
   <code>methods[<i>obj</i>]</code> function:
  </p>
  
  <p>
   <code>
    f = newJava["javax.swing.JFrame", [] ]<br>
    sort[methods[f]]
   </code>
  </p>

  <p>
   This makes it easy to experiment with Java libraries without writing
   extensive unnecessary boilerplate code, recompiling, etc.  Frink has been
   called "an easier Java than Java."
  </p>

  <h3><a name="CallingStaticJavaMethods">Calling Static Java Methods</a></h3>
  <p>
   If you don't have an instance of the class, you can call static methods in
   Java classes using the <code>callJava[classname, methodname, argList]</code>
   function.  The following uses the <code>java.lang.Math</code> class to
   generate a random number.
  </p>

  <p>
   <code>n = callJava["java.lang.Math", "random", [] ]</code><br>
   <code>0.38102192379837</code>
  </p>

  <p>
   If the method requires no arguments, as in the above example, the last
   argument can be eliminated:
  </p>

  <p>
   <code>n = callJava["java.lang.Math", "random"]</code><br>
   <code>0.314291983004521</code>
  </p>
  
  <p>
   Lame example, huh?  Especially when Frink can already generate random
   numbers.  The same syntax can be used to get a database driver, or
   something more interesting.
  </p>

  <h3><a name="AccessingStaticJavaFields">Accessing Static Java Fields</a></h3>
  <p>
   You can access static variables in a class without having an instance of
   the class by calling the <code>staticJava[classname, fieldname]</code>
   function.
  </p>

  <p>
   <code>green = staticJava["java.awt.Color", "GREEN"]</code><br>
   <code>JavaObject:java.awt.Color</code>
  </p>

  <p>
   You can then call methods on that object:
  </p>

  <p>
   <code>green.getRed[]</code><br>
   <code>0</code>
  </p>
  
  <p>
   If you've constructed a Frame as in the <a href="#CreatingJavaObjects">Creating Java Objects</a> section above, you
   can set its background color by:
  </p>

  <p>
   <code>f.setBackground[green]</code>
  </p>

  <p>
   As of the 2014-04-21 release, Frink turns values returned from
   <code>staticJava</code> into their corresponding Frink types.  If you need
   the original, raw Java object (say, for code that checks object identity,)
   then you can call the three-argument version of the function, passing
   <code>false</code> as the third argument (this indicates that the value
   should <em>not</em> be mapped to a Frink type):
  </p>

  <p>
   <code>staticJava["javax.swing.SwingConstants", "LEFT"]</code><br>
   <code>2</code>
  </p>

  <p>
   <code>staticJava["javax.swing.SwingConstants", "LEFT", false]</code><br>
   <code>JavaObject:java.lang.Integer</code>
  </p>
  
  <h3><a name="CallingFunctionsAndMethodsByName">Calling Functions and Methods by Name</a></h3>
  <p>
   Sometimes you may have to call functions or methods by name.  For example,
   calling a method called <code><i>object</i>.next[]</code> on a Java object
   is impossible in Frink because <code>next</code> is a reserved word and
   produces a syntax error!  To get around this, use the
   <code>callByName[<i>object</i>, <i>methodName</i>, <i>argList</i>]</code>
   function.
  </p>

  <p>
   <code>callByName[iterator, "next", [] ]</code>
  </p>

  <p>
   If the first argument (normally an object) is <code>undef</code>, then the
   function with the specified name will be called.
  </p>

  <p>
   If the argument list is empty, as above, you can eliminate it entirely:
  </p>

  <p>
   <code>callByName[iterator, "next"]</code>
  </p>

  <p>
   If the argument list is a single element, you don't have to pass it as a
   list: 
  </p>

  <p>
   <code>callByName[undef, "println", "yo"]</code>
  </p>
  
  <p>
   Similarly, you can get a reference to a function by calling
   <code>getFunction[<i>name</i>, <i>numArgs</i>]</code> which returns a
   reference to the function with the specified name (specified as a string)
   and number of arguments.  This can then be assigned to variables, or called
   as noted in the <a href="#AnonymousFunctions">Anonymous Functions</a>
   section of the documentation.
  </p>
  
  <h3><a name="IteratingOverJavaCollections">Iterating Over Java Collections</a></h3>
  <p>
   The <code>for</code> loop can be used to iterate over the contents of most
   Java collections, including <code>array</code>, <code>Vector</code>,
   <code>Enumeration</code>, <code>Iterator</code>, <code>Collection</code>,
   <code>Map</code>, (which includes <code>Hashtable</code>,
   <code>HashMap</code>, <code>Properties</code> etc.), <code>Iterable</code>
   (which includes almost <em>all</em> <code>Collection</code> types in Java,
   and anything that can be used in Java's <code>foreach</code> statement)
   <i>etc.</i>
  </p>

  <p>
   For most Java collections, you can iterate through the contents using a
   <code>for</code> loop (which is really just a "for each" loop.)
  </p>

  <p>
   <code>
    for a = <i>javaObject</i><br>
    &nbsp;&nbsp;&nbsp;println[a]<br>
   </code>
  </p>

  <p>
   If the Java class implements the <code>java.util.Map</code> interface (this
   includes classes like <code>HashMap</code>, <code>Hashtable</code>,
   <code>Properties</code>, etc), it can be treated like a Frink <a href="#Dictionaries">dictionary</a>.  This includes enumerating over
   <code>[key,&nbsp;value]</code> pairs:
  </p>

  <p>
   <code>
    for [key,value] = <i>javaObject</i><br>
    &nbsp;&nbsp;&nbsp;println["$key maps to $value"]<br>
   </code>
  </p>

  <p>
   All of these Java collections can be treated as <a href="#EnumeratingExpressions">enumerating expressions</a> in
   Frink, so all of the functions and methods that can operate on enumerating
   expressions can operate on Java collections.  For example, Java collections
   can be converted to other types using functions like
   <code>toArray</code>, <code>toSet</code>, <code>toDict</code>, or
   manipulated with functions like <code>join</code>, etc.
  </p>

  <p>
   If you are using a Java data structure that puts Frink or Java data types
   into a data structure that needs a <code>java.util.Comparator</code> to
   perform the comparisons (<i>e.g.</i> <code>java.util.PriorityQueue</code>,)
   you can get Frink's default Comparator (which follows the same semantics as
   Frink's <code>&lt;=&gt;</code> <a href="#ThreeWayComparison">three-way
   comparison</a> operator,) by calling <code>getDefaultComparator[]</code>.
   Frink's default comparator will also compare Java objects that implement
   the <code>java.util.Comparable</code> interface so it can be used for Frink
   and Java data types.
  </p>

  <p>
   You can also implement a <code>java.util.Comparator</code> that uses a
   Frink function to perform the comparison.  The function should take two
   arguments <code>[a, b]</code> and return -1 if a&lt;b, 0 if a==b, and 1 if
   a&gt;b
  </p>

  <p>
   <code>c = new Comparator[ {|a,b| a &lt;=&gt; b } ]</code>
  </p>

  <p>
   If additional data is needed to perform the comparison, you can pass an
   arbitrary expression as the second argument of the Comparator constructor.
   This data will be passed as a third argument to the function.  For example,
   the following Comparator sorts the elements by their distance from 20.
  </p>
  
  <p>
   <code>c = new Comparator[ {|a,b,data| abs[a-data] &lt;=&gt; abs[b-data] }, 20]</code>
  </p>
  
  <h2><a name="EmbeddingFrink">Embedding Frink</a></h2>
  <p>
   Not only can you call Java from Frink, but you can call Frink from Java.
   It's quite easy to embed a Frink parser into any Java program and give
   those programs all of the power of Frink.  It can take just a few lines of
   Java:
  </p>

  <p>
   <code>//At the top of your file...<br>
    import frink.parser.Frink;<p>
    
    String results;<br>
    Frink interp = new Frink();<br>
    // Enable security here?  Currently commented-out.<br>
    // interp.setRestrictiveSecurity(true);</p><p>
    
    try<br>
    {<br>
    &nbsp;&nbsp;&nbsp;results = interp.parseString("2+2");<br>
    }<br>
    catch (frink.errors.FrinkEvaluationException fee)<br>
    {<br>
    &nbsp;&nbsp;&nbsp;// Do whatever you want with the exception<br>
    }</p></code>
  </p>

  <p>
   <b>Warning</b>: Frink is a Turing-complete programming language, and
   <code>parseString()</code> evaluates a string as a complete program.  A
   Frink interpreter normally has the ability to read your filesystem, call
   arbitrary Java code, execute infinite loops, allocate infinite amounts of
   memory, write large amounts of output, and do other things which may
   compromise your security.  Thus, if you're taking input from
   untrusted users, it's critical to call:

  </p><p>
   <code><i>interp</i>.setRestrictiveSecurity(true);</code>
  </p>

  <p>
   before parsing any user input.  This will enable the highest
   level of security, prohibiting all untrusted actions.
  </p>
  
  <p>
   There are more methods for calling Frink from within a Java program.  One
   of the major problems is that converting from Frink types to Java types is
   almost always a narrowing operation.
  </p>

  <p>
   For example, if you try to put a Frink value into a Java integer:
  </p>

  <ul>
   <li>It could be too large.

   </li><li>It could be a non-integer (rational number, floating point).

   </li><li>It could be complex.
    
   </li><li>It may have wrong unit types.

   </li><li>It could be something else like a String or an Object.
  </li></ul>

  <p>
   As a result, all of these interface methods throw a variety of exceptions.
  </p>

  <p>
   For more information, see the javadocs about <a href="https://frinklang.org/integrate/">Frink's
    integration methods,</a> especially the <code>frink.parser.Frink</code>
   class.
  </p>

  <p>
   If you're interested in integrating Frink into your company's products,
   please contact <a href="mailto:eliasen@mindspring.com">Alan Eliasen</a>.
  </p>
   
  <h2><a name="SampleCalculations">Sample Calculations</a></h2>
  <p>
   The following sections demonstrates some of the real-world calculations I've
   made with Frink.
  </p>

  <h3><a name="MassAndVolume">Mass and Volume</a></h3>
  <p>
   Let's say you wanted to fill your bedroom up with water.  How much water
   would it take?  Let's say your room measures 10 feet by 12 feet wide by
   8 feet high.
  </p>

  <p>
   <code>10 feet 12 feet 8 feet -&gt; gallons</code><br>
   <code>552960/77 (approx. 7181.298701298701)</code>
  </p>

  <p>
   It would take approximately 7181 gallons to fill it.  Note that you get
   both an exact fraction and an approximation.  (If you don't want to see the
   fraction, put a decimal point in any of the numbers, like <code>10.</code>
   or <code>10.0</code> .)
   How much would that weigh, if you filled it with water?  Frink has the unit
   "water" which stands for the density of water.
  </p>
  
  <p>
   <code>10. feet 12 feet 8 feet water -&gt; pounds</code><br>
   <code>59930.84215309883</code>
  </p>

  <p>
   So it would weigh almost 60,000 pounds.  What if you knew that your floor
   could only support 2 tons?  How deep could you fill the room with water?
  </p>

  <p>
   <code>2. tons / (10 feet 12 feet water) -&gt; feet</code><br>
   <code>0.5339487791320047</code>
  </p>

  <p>
   So you could only fill it about 0.53 feet deep.  It'll be a pretty sad pool
   party.
  </p>

  <h3><a name="Liquor">Liquor</a></h3>
  <p>
   You can set variables on the fly, by using the assignment
   <code>=</code> operator.  Let's say you want to define a new unit
   representing the amount of alcohol in a can of (quality) 3.2 beer.  Keep in
   mind that 3.2 beer is measured by alcohol/weight, while almost all other
   liquors (and many beers) are usually measured in alcohol/volume.  The
   density ratio between water and alcohol is given by:
  </p>

  <p>
   <code>water/alcohol</code><br>
   <code>1.267</code>
  </p>

  <p>
   Water is thus 1.267 times denser than alcohol.  3.2 beer (measured by
   weight) is thus actually 4.0 percent alcohol as measured by volume.  Now
   let's set that variable in terms of a beer's density of alcohol per volume
   so we can compare:
  </p>

  <p>
   <code>beer = 12 floz 3.2 percent water/alcohol</code>
  </p>

  <p>
   Then, you wanted to find out how many beers a big bottle of champagne is
   equal to:
  </p>

  <p>
   <code>magnum 13.5 percent -&gt; beer</code><br>
   <code>14.07</code>
  </p>

  <p>
   You probably don't want to drink that whole bottle.  Now let's say you're
   mixing Jungle Juice (using a 1.75 liter bottle of Everclear (190 proof!))
   and Kool-Aid to fill a 5-gallon bucket (any resemblance to my college
   parties is completely intentional.)  What percent alcohol is that stuff?
  </p>

  <p>
   <code>junglejuice = 1.75 liter 190 proof / (5 gallon)<br>
    junglejuice -&gt; "percent"</code><br>
   <code>8.78372074090843481138500000 percent</code>
  </p>

  <p>
   It's really not <em>that</em> strong.  About 8.8%.  But if you drink 5 cups
   of that, at 12 fluid ounces each, how many beers have you had?
  </p>

  <p>
   <code>5 12 floz junglejuice -&gt; "beer"</code><br>
   <code>10.832 beer</code>
  </p>

  <p>
   Maybe that's why people were getting punched in the head.  <i>QED.</i>
  </p>

  <h3><a name="MoreLiquor">More Liquor</a></h3>
  <p>
   Some more useful calculations, most thanks to the lovely Steve Clymer:
  </p>

  <p>
   How many cases in a keg?  (A keg is a normal-sized keg, what those in the
   beer industry would call a "half barrel," or <code>1/2 beerbarrel</code> in
   Frink notation.  I don't think they sell full barrels.  I've never seen
   one.  It would weigh 258 pounds.  A "pony keg" is a "quarter barrel" or, in
   Frink notation, <code>ponykeg</code> or <code>1/4 beerbarrel</code>)
  </p>
   
  <p>
   <code>keg -&gt; case</code><br>
   <code>62/9 (approx. 6.888888888888889)</code>
  </p>

  <p>
   How many 12 fluid ounce drinks (<i>i.e.</i> cans o' beer) in a keg?
  </p>
   
  <p>
   <code>keg -&gt; 12 floz</code><br>
   <code>496/3 (approx. 165.33333333333334)</code>
  </p>

  <p>
   What is the price in dollars per fluid ounce of alcohol when buying a keg of
   3.2 beer?  (Remember that 3.2 beer is measured in alcohol/weight, so we
   correct by the density ratio of <code>water/alcohol</code> to get alcohol by
   volume:)
  </p>

  <p>
   <code>(60 dollars)/(keg 3.2 percent water/alcohol) -&gt; "dollars/floz"</code><br>
   <code>0.74593 dollars/floz</code>
  </p>

  <p>
   A bottle of cheap wine?  (A "winebottle" is the standard 750 ml size.)
  </p>
  
  <p>
   <code>(6.99 dollars)/(winebottle 13 percent) -&gt; "dollars/floz"</code><br>
   <code>2.12 dollars/floz</code>
  </p>

  <p>
   A big plastic bottle of really bad vodka?
  </p>

  <p>
   <code>(13.99 dollars)/(1750 ml 80 proof) -&gt; "dollars/floz"</code><br>
   <code>0.59104811225625 dollars/floz</code>
  </p>

  <h3><a name="MovieMagic">Movie Magic</a></h3>
  <p>
   In the movie <i>Independence Day</i>, the alien mother ship is said to be
   500 km in diameter and have a mass 1/4 that of earth's moon.  If the mother
   ship were a sphere, what would its density be?  (The volume of a sphere is
   4/3 pi radius<sup>3</sup>)
  </p>

  <p>
   <code>1/4 moonmass / (4/3 pi (500/2 km)^3) -&gt; water</code><br>
   <code>280.68</code>
  </p>

  <p>
   This makes the ship <em>280 times</em> denser than water.  This is 36 times
   denser than iron and more than 12 times denser than any known element!  As
   the ship is actually more a thin disc than a sphere, it would actually be
   even denser.  Since it contains lots of empty space, parts of it would have
   to be much, much denser.
  </p>

  <p>
   If the object is this dense and has such a large mass, what is its surface
   gravity?  Surface gravity is given by G mass / radius<sup>2</sup>, where G
   is the gravitational constant (which Frink knows about):
  </p>
  
  <p>
   <code>G 1/4 moonmass / (500/2 km)^2 -&gt; gravity</code><br>
   <code>2.000079</code>
  </p>

  <p>
   The surface gravity of the spaceship is thus at least <em>twice</em>
   earth's gravity--and that's on the rim where gravity is weakest.  It
   would actually be much higher since it's much, much flatter than a sphere.
   I hope you're not the alien that has to go outside and paint it.
  </p>
  
  <h3><a name="FiscalCalculations">Fiscal Calculations</a></h3>
  <p>
   You can calculate the day that your company will run out of cash, based on
   their financial statements.  The following is an example for a real company,
   based on SEC filings, which read as the following:
  </p>

  <table summary="Sample Financial Data">
   <caption>Cash and Cash Equivalents (in thousands)</caption>
   <tbody><tr><th>December 31, 2000</th><th>June 30, 2001
   </th></tr><tr><td>$86,481</td><td>$41,601
  </td></tr></tbody></table>

  <p>
   To make this more readable, you can define variables to hold values:
  </p>

  <p>
   <code>burnrate = (#2001-06-30# - #2000-12-31#) / ((86481 - 41601) thousand dollars)</code>
  </p>

  <p>
   <code>burnrate -&gt; dollars/day</code><br>
   <code>248012.89431247435 </code>
  </p>

  <p>
   You can calculate the number of days until the money runs out at this rate:
  </p>

  <p>
   <code>41601 thousand dollars / burnrate -&gt;
    "days"</code><br> 
   <code>167.7372 days</code>
  </p>

  <p>
   Using date/time math, starting from the last report date (June 30,
   2001) you can find out the exact date this corresponds to:
  </p>

  <p>
   <code>#2001-06-30# + 41601 thousand dollars /
    burnrate</code><br>
   <code>AD 2001-12-14 04:41:38.101 PM (Fri) Mountain Standard Time</code>
  </p>

  <p>
   Just in time to see the cinema release of the first <i>Lord of the
   Rings</i> movie with your last six bucks.  Will they know it's
   Christmas Time at all?
  </p>


  <h3><a name="Ouch">Ouch!</a></h3>
  <p>
   At the moment, I'm watching CNN which is discussing some land-mines used in
   Afghanistan.  They showed a very small mine (about the size of a bran
   muffin) containing "51 grams of TNT" and they asked how much destructive
   force that carries.  Frink's data file includes how much energy is in a
   mass of TNT, specified by the unit "TNT".  How many feet in the air could
   51 grams of TNT throw me, assuming perfect efficiency, and knowing
   <code>energy = mass * gravity * height</code>?
  </p>

  <p>
   <code>51 grams TNT -&gt; 185 pounds gravity feet</code><br>
   <code>937.7628167428616 </code>
  </p>

  <p>
   Yikes.  937 feet.  But the only difference between explosives and other
   combustible fuels is the rapidity of combustion, not in the quantity of
   energy.  How much gasoline contains the same amount of energy?
  </p>

  <p>
   <code>51 grams TNT -&gt; "teaspoons gasoline"</code><br>
   <code>1.2903255 teaspoons gasoline</code>
  </p>

  <p>
   1.29 teaspoons?  That's not much at all.  You're buying a huge amount of
   energy when you fill up your car.
  </p>

  
  <h3><a name="SnipingEBayAuctions">Sniping eBay Auctions</a></h3>
  <p>
   I need a monocle, but I don't want to pay a lot for it.  The eBay monocle
   auction ends in 7 hours and 44 minutes... what time do I need to set the
   alarm clock for to remind me?
  </p>

  <p>
   <code>now[] + 7 hours + 44 min</code><br>
   <code>AD 2001-11-17 02:13:51.934 PM (Sat) Mountain Standard
    Time</code>
  </p>

  <p>
   <b>Epilogue 2001:</b> I didn't get the damned monocle.
  </p>

  
  <h3><a name="JunkyardWars">Junkyard Wars</a></h3>
  <p>
   I can't watch <i>Junkyard Wars</i> (or lots of other television shows)
   without having Frink at my side.  This week the team has to float a
   submerged half-ton Cooper Mini... how many oil barrels will they need to
   use as floats?
  </p>

  <p>
   <code>half ton -&gt; barrels water</code><br>
   <code>2.8530101742118243</code>
  </p>

  <p>
   They're trying to hand-pump air down to the barrels, submerged "2
   fathoms" below the water.  If the guy can sustain 40 watts of pumping
   power, how many minutes will it take to fill the barrel?
  </p>

  <p>
   <code>2 fathoms water gravity barrel -&gt; 40 watts minutes</code><br>
   <code>2.376123072093987</code>
  </p>

  <p>
   And how many food Calories (a food Calorie (with a capital 'C') equals 1000
   calories with a small 'c') will he burn to fill a barrel?
  </p>
  
  <p>
   <code>2 fathoms water gravity barrel -&gt; Calories</code><br>
   <code>1.3620653895637644</code>
  </p>

  <p>
   Better eat a Tic-Tac first.
  </p>

  <h3><a name="BodyHeat">Body Heat</a></h3>
  <p>
   I've seen lots of figures about how much heat the human body produces.  You
   can easily calculate the upper limit based on how much food you eat a day.
   Say, you eat 2000 Calories a day (again, food Calories with a capital "C"
   are equal to 1000 calories with a little "c".)
  </p>

  <p>
   <code>2000 Calories/day -&gt; watts</code><br>
   <code>96.91666666666667</code>
  </p>

  <p>
   So, your average power and/or heat output is slightly less than a 100-watt
   bulb.  (Note that your heat is radiated over a much larger area so the
   temperature is much lower.)  Many days I could be replaced entirely with a
   100-watt bulb and have no discernible effect on the universe.
  </p>

  <h3><a name="MicrowaveCookery">Microwave Cookery</a></h3>
  <p>
   I'm heating up yummy mustard greens in my microwave, but I don't want to
   overheat them.  I just want to warm them up.  If I run my 1100 watt
   microwave for 30 seconds, how much will their temperature increase?  I have
   a big 27 ounce (mass) can, and I'll assume that their specific heat is about
   the same as that of water (1 calorie/gram/degC):
  </p>

  <p>
   <code>1100 W 30 sec / (27 oz 1 calorie/gram/degC) -&gt; degF</code><br>
   <code>18.5350</code>
  </p>

  <p>
   30 seconds should raise the temperature by no more than 18 degrees
   Fahrenheit, assuming perfect transfer of microwave energy to heat.
  </p>

  <p>
   Knowing this, I could see how efficiently my microwave <em>actually</em>
   heats food.  I could heat a quantity of water and measure the temperature
   change in the water.  I'll do that sometime if I can find my good
   thermometer.
  </p>

  <h3><a name="Superman">Why is Superman so Lazy?</a></h3>
  <p>
   Superman is always rescuing school buses that are falling off of cliffs,
   flying to the moon, lifting cars over his head, and generally showing off.
   So why does he still allow so many accidents to happen?  Shouldn't he be
   able to rescue <em>everybody</em> who has a Volkswagen parked on their
   chest?
  </p>

  <p>
   While searching for answers, I found out three interesting things about
   Superman:
  </p>

  <ol>
   <li>He's 6 feet 3 inches tall.
   </li><li>He weighs 225 pounds.
   </li><li>He gets his strength from being charged up with solar energy.
  </li></ol>

  <p>
   This is enough information to find some answers.  Frink has units called
   <code>sunpower</code> (the total power radiated by the sun) and
   <code>sundist</code> (the distance between the earth and the sun.)  Thus,
   we can find the sun's power that strikes an area at the distance of the
   earth (knowing the surface area of a sphere is 4 pi radius<sup>2</sup>):
  </p>

  <p>
   <code>earthpower = sunpower / (4 pi sundist^2)</code>
  </p>

  <p>
   This is about 1372 watts per square meter.  Superman is a pretty big
   guy--let's say the surface area he can present to the sun is 12 square
   feet.  (This is probably a bit high--it makes him an average of 23 inches
   wide over his entire height.)  This allows Superman to charge up at a power
   of:
  </p>

  <p>
   <code>chargerate = earthpower 12 ft^2</code><br>
   <code>chargerate -&gt; watts</code><br>
   <code>1530.1602</code><br>
  </p>

  <p>
   Superman thus charges up at the rate of 1530 joules/sec or 1530 watts.  At
   this rate, how long does he have to charge up before he can lift a 2 ton
   truck over his head?  (Knowing energy = mass * height * gravity)
  </p>

  <p>
   <code>2 ton 7 feet gravity / chargerate -&gt; sec</code><br>
   <code>24.80975</code><br>
  </p>

  <p>
   So, charging up for 25 seconds allows him to save one dumb kid who is acting
   as a speed bump.  So his power is huge but not infinite.  He couldn't
   sustain a higher rate (unless he showed off less by lifting the car only a
   foot or two.)  Lifting a truck every 30 seconds or so isn't bad,
   though.  He could be saving a lot more people.  So why doesn't he?
  </p>

  <p>
   Well, we've all seen the movie.  He's using his super-powers to pick up
   chicks.  Literally.  Superman decides to take a break from saving lives and
   takes Lois Lane up in the sky for a joyride.  So how long does he have to
   charge up with solar energy to fly himself and Lois Lane (let's say she
   weighs 135 pounds) up to 15,000 feet?
  </p>

  <p>
   <code>(225 + 135) pounds 15000 feet gravity / chargerate -&gt; minutes</code><br>
   <code>59.809235</code><br>
  </p>

  <p>
   So, Superman has to charge up with solar energy for an <em>hour</em> to
   cart Lois up there.  With the same energy, he could have saved over 120
   trapped kids.  Keep in mind that Lois could do her part, too.  If she left
   her camera or big clunky shoes behind, he'd have more energy left over
   to save people.  If she would manage to leave behind just two pounds of
   cargo weight, Superman would have enough energy to save another kid's life.
  </p>

  <p>
   Sure, he's a great guy, and, sure, he's the Defender of Truth, Justice, and
   the American Way, but can't he find a better use for his super-powers than
   schlepping some shiksa into the stratosphere?  Shovel my walk, he could, in
   3 seconds--and me with the sciatica.
  </p>

  <h3><a name="FartJokes">Fart Jokes</a></h3>
  <p>
   I received one of those endlessly-forwarded e-mails of dubious but
   "interesting facts" which said "if you fart continuously for 6 years and 9
   months, you'll have enough gas to create the equivalent of an atomic bomb."
   Hee hee.  Cute.  (Thanks to Heather May Howard... being unable to easily
   calculate the veracity of this statement was one of the primary influences
   that showed how existing programs were too limited and inspired the
   creation of Frink.)  But I didn't believe it and wanted to check it.  The
   Hiroshima bomb had a yield of 12.5 kilotons of TNT, which is a very small
   bomb by today's standards.  How many horsepower would that be?
  </p>

  <p>
   <code>12.5 kilotons TNT / (6 years + 9 months) -&gt; horsepower</code><br>
   <code>329.26013859711395</code>
  </p>

  <p>
   Can <em>you</em> produce a 329-horsepower blowtorch of a fart?  I doubt it.
   That's the power produced by a Corvette engine running just at its melting
   point.  A one-second fart with that much power could blow me 1000 feet
   straight up.  To produce that kind of energy, how much food would you have
   to eat a day?
  </p>

  <p>
   <code>12.5 kilotons TNT / (6 years + 9 months) -&gt; Calories/day</code><br>
   <code>5066811.55086559</code>
  </p>

  <p>
   Ummm... can <em>you</em> eat over 5 million Calories a day?  (Again, note
   that these are <em>food</em> Calories with a capital 'c' which are equal to
   1000 calories with a small 'c'.)  If you were a perfect fart factory,
   converting food energy into farts with 100% efficiency, and ate a normal
   2000 Calories/day, how many years would it <em>really</em> take?
  </p>

  <p>
   <code>12.5 kilotons TNT / (2000 Calories/day) -&gt; years</code><br>
   <code>17100.488984171367</code>
  </p>

  <p>
   17,000 years is still a huge underestimate; I don't know how much of your
   energy actually goes into fart production.  Oh well.  To continue the
   calculations, let's guess your butthole has a diameter of 1 inch (no,
   <em>you</em> go measure it.)  Let's also guess that the gas you actually
   produce in a fart is only 1/10 as combustible as pure natural gas.  What
   would be the velocity of the gas coming out?
  </p>
  
  <p>
   <code>12.5 kilotons TNT / natural_gas / (6 years + 9 months)
    / (pi (.5 in)^2) 10 -&gt; mph</code><br>
   <code>280.1590446203110</code>
  </p>

  <p>
   Nobody likes sitting next to a 280-mile-per-hour fart-machine.
   <i>Lesson:</i> Even the smallest atomic bombs are <em>really
   unbelievably</em> powerful and whoever originally calculated this isn't any
   fun to be around if they really fart that much.
  </p>

  <p>
   Fart jokes.  Sheesh.  If Frink isn't a huge success, it's not because I
   didn't pander to the Lowest Common Denominator.
  </p>

  <h3><a name="AdvancedFarting">Advanced Farting</a></h3>
  <p>
   The above order-of-magnitude estimate shows how far off the mark that the
   fart e-mail was.  Not content with that, I found some medical studies that
   allowed me to do a more detailed analysis of the average person's available
   fart energy.
  </p>

  <p>
   What do you think are the most flammable gases in a fart?  Most people
   think it's methane, but I found some medical studies that disprove this.
   Most people hardly have <em>any</em> methane in their intestines.  For
   example, one study stated that only 4 out of 11 people had any detectable
   methane in their intestines!  So what's the rest of the gas?
  </p>

  <table summary="Gases Present in Human Intestines by Volume">
    <tbody><tr><th>Gas</th><th>Percent by Volume
    </th></tr><tr><td>Nitrogen</td><td>64%
    </td></tr><tr><td>Carbon Dioxide</td><td>14%
    </td></tr><tr><td>Hydrogen</td><td>19%
    </td></tr><tr><td>Methane</td><td>3.2%
    </td></tr><tr><td>Oxygen</td><td>0.7%
  </td></tr></tbody></table>

  <p>
   These studies also note that the average person has 100 milliliters of gas
   present in their intestinal tract at any given time.  The average person
   expels 400-2000 ml of gas daily (and I'm not talking about through the
   mouth and nose.)
  </p>

  <p>
   Okay, that's almost enough information to figure out available fart energy.
   Now all we need to know is the energy of combustion of the flammable gases.
   Of the above, only hydrogen and methane are readily combustible.  Looking
   up their energies of combustion:
  </p>
  
  <table summary="Combustion energy of gases in human intestine">
    <tbody><tr><th>Gas</th><th>Energy of Combustion in kJ/mol
    </th></tr><tr><td>Hydrogen (H<sub>2</sub>)</td><td>285.8
    </td></tr><tr><td>Methane (CH<sub>4</sub>)</td><td>890.8
  </td></tr></tbody></table>

  <p>
   Okay, that's plenty enough information to find out how much energy is
   released in a day of farting!  Say you're on the farty end of the scale,
   and you produce the 2000 ml of gas each day.
  </p>

  <p>
   Note that the energies above are given in kJ/mol, but we have volumes in
   milliliters.  As you may have learned in chemistry class, a mole of any gas
   at standard temperature and pressure takes up the same volume.  Frink knows
   this as <code>molarvolume</code>.
  </p>

  <p>
   The total energy in the hydrogen (keeping in mind that hydrogen makes up
   19% of the 2000 ml volume) is given by:
  </p>

  <p>
   <code>h2energy = 2000 ml / molarvolume mol * 19 percent * 285.8 kJ/mol</code><br>
   <code>4845.3656205695224816 m^2 s^-2 kg (energy)</code>
  </p>

  <p>
   The combustible hydrogen thus produces 4800 joules (per day.)  Now, for the
   methane, which makes a smaller percentage, but releases more energy per
   mole:
  </p>

  <p>
   <code>methaneenergy = 2000 ml / molarvolume mol * 3.2 percent * 890.8 kJ/mol</code><br>
   <code>2543.5537223989278488 m^2 s^-2 kg (energy)</code>
  </p>

  <p>
   The energy in the combustible methane is thus about 2500 joules (per day),
   about half the energy produced from the hydrogen.  Thus, the grand total of
   energy produced by combustible farts by a farty person in a day, in food
   Calories (with a capital C, remember--these are what a physicist would call
   a kilocalorie) is:
  </p>
  
  <p>
   <code>methaneenergy + h2energy -&gt; Calories</code>
  </p>

  <p>
   Which gives a result of about 1.76 Calories/day of energy available from
   burning your farts.  (About 1.16 Calories from hydrogen, and about 0.60
   Calories from methane.)  This is out of the 2000 Calories that an average
   person eats a day.  Or, one part in about 1133 of the energy in the food
   you eat is available in fart energy, (again, for a gassy person.)
  </p>

  <p>
   Thus, a good estimate to the problem stated above is that a real (gassy)
   human would need to save their farts for:

  </p><p>
   <code>12.5 kilotons TNT / ((methaneenergy + h2energy) / day)
    -&gt; years</code><br>
   <code>1.9379377133697419931e+7</code>
  </p>

  <p>
   or about <em>19 million years</em> to make the equivalent of the energy in
   a (small) atomic bomb!  So the estimate given in that e-mail is off by a
   factor of at least 2.8 million!
  </p>

  <p>
   Now, you know the true facts about farts.  Frink is now complete, and I
   couldn't be prouder.  Umm... thanks, Heather May.
  </p>

  <h3><a name="MoreIncorrectFacts">More Incorrect Facts</a></h3>
  <p>
   That e-mail has a higher density of incorrect facts than just about
   anything I've seen.  Below are several more examples.
  </p>

  <h4><a name="QE2">QE2</a></h4>
  <p>
   "The cruise liner, Queen Elizabeth II, moves only six inches for each gallon
   of diesel that it burns."
  </p>

  <p>
   From <a href="http://news.bbc.co.uk/2/hi/uk_news/319027.stm">a page of
   facts about the QE2,</a> we find that the ship consumes 18 tons of fuel per
   hour at a service speed of 28 knots.  By legislation in many areas, diesel
   fuel must have a density no higher than 0.85 kg/liter (if it were watered
   down, it would be higher.)
  </p>

  <p>
   <code>18 tons/hour / (28 knot) / (.85 kg/liter) -&gt; feet/gallon</code><br>
   <code>Warning: reciprocal conversion<br>
    33.52338503156235</code>
  </p>

  <p>
   They're very, very wrong.  It actually travels about 33.5 feet per gallon,
   or 157 gallons/mile.  They're only off by a factor of 67.  Still not great
   gas mileage, though.
  </p>

  <h4><a name="HamburgersAndCars">Hamburgers and Cars</a></h4>
  <p>
   The same e-mail states "pound for pound, hamburgers cost more than new
   cars."
  </p>

  <p>
   Let's see... let's try with a medium-expensive, light car.  A
   2001 Corvette Z06 weighs 3,115 pounds and costs $48,055.
  </p>

  <p>
   <code>(48055 dollars) / (3115 lb) -&gt; dollars/lb</code><br>
   <code>1373/89 (approx. 15.426966292134832)</code>
  </p>

  <p>
   I know <em>I</em> don't pay $15/lb for hamburger.
  </p>

  <p>
   Let's try with a light, very cheap car.  A quick lookup showed that a 2001
   Hyundai Accent costs $10,184 and weighs 2255 pounds.  That's still $4.51 a
   pound.  Do <em>you</em> pay that much for hamburger?  Maybe a finished
   hamburger in a good restaurant, certainly not for hamburger.  This is
   deceptive if not outright wrong.
  </p>

  <h4><a name="GetTheProvisions">"Get The Provisions..."</a></h4>
  <p>
   By the way, did you ever notice that in the movie <i>Stand By Me</i> that
   Gordie <em>really</em> gets ripped off for hamburger?  Supposedly set in
   1960, Gordie buys "a buck and a half of hamburger" which is slapped down in
   a tiny wrapper that couldn't contain more than 3/4 of a pound.  Probably a
   half pound--it looks like all wrapper.  (You estimate it.)  Converting to
   modern prices:
  </p>

  <p>
   <code>1.50 dollars_1960 / (.75 lb) -&gt; dollars/lb</code><br>
   <code>26.96</code>
  </p>

  <p>
   Gordie paid a modern equivalent of $27/lb for that hamburger.  Perhaps a
   smarter shopper <em>could</em> have gotten more for Vern's 7 cents.
  </p>

  <h4><a name="Typing">Typing</a></h4>
  <p>
   The same e-mail says "the longest word that can be typed using only the
   left hand is 'stewardesses'."  Well, Frink is good for doing word stuff
   too.  Using the single word list from the 
   <a href="http://icon.shef.ac.uk/Moby/">Moby wordlist</a>,
   the following program finds lots of 12-letter alternatives, and several
   longer:
  </p>

  <p>
   <code>
    infile = "<i>path to words file</i>"</code>
   

   
    <code>leftPattern = %r/^[qwertasdfgzxcvb]+$/i</code>
   
   <code>
    matches = select[lines[infile], leftPattern]</code>
   
   <code>
    sort[matches, { |a,b| length[a] &lt;=&gt; length[b] } ]<p>
    
    for [line] = matches<br>
    &nbsp;&nbsp;&nbsp;println[length[line] + ": $line"]
   </p></code>
  </p>

  <p>
   (Actually, my original program was only 2 lines, but this is easier to
   read.  The program could be written lots of ways.)  Some of the results are:
  </p>
  
  <p>
   <code>
    12: stewardesses<br>
    12: desegregates<br>
    12: terracewards<br>
    12: watercresses<br>
    12: extravasated<br>
    12: decerebrated<br>
    12: gazetteerage<br>
    12: desegregated<br>
    12: extravagated<br>
    12: tessaradecad<br>
    12: resegregated<br>
    12: reaggregated<br>
    12: reverberated<br>
    12: reverberates<br>
    12: reasseverate<br>
    12: aftereffects<br>
    13: tesseradecade<br>
    13: aftercataract<br>
    13: devertebrated<br>
    17: redrawerredrawers<br>
   </code>
  </p>

  <p>
   I have no idea what that last word means.
  </p>

  <h3><a name="BiblicalReferences">Biblical References</a></h3>
  <p>
   So you want to build an ark, do you?  And not an Ark of the Covenant, but
   the boat.  How bad was that flood?
  </p>

  <p>
   The bible is also quite precise in its measurement of the flood.  Genesis
   7:19-20 states that "And the waters prevailed exceedingly upon the earth;
   and all the mountains, that were under the whole heaven, were covered.
   Fifteen cubits upward did the waters prevail; and the mountains were
   covered."
  </p>

  <p>
   Okay, so the highest mountains of the earth were covered, plus an extra 15
   cubits (approx 27 feet) for good measure.  The current measurements for
   highest mountain is Mt. Everest at 29030.8 feet (according to the highly
   dubious and utterly non-trustable 2002 Guinness Book of World Records.)  I
   know that Everest is growing slowly, (best estimates are 2.4 inches/year)
   so we'll discount for that.
  </p>

  <p>
   <code>
    depth = 29030 feet + 15 biblicalcubits - (2.4 inches/year 4000 years)
   </code>
  </p>

  <p>
   About 28257 feet of water.  This was deposited over 40 days.  The rainfall
   was thus:
  </p>

  <p>
   <code>rainfall = depth / (40 days)</code>
  </p>

  <p>
   Or about 353 inches/hour, or 29 feet/hour.  A good rain around here is
   about an inch an hour.  The very rainiest places on earth like <a href="http://www.extremescience.com/wettest.htm">Cherrapunji</a>
   get about this much rain in a <em>year</em>.  (I'm campaigning Colorado
   farmers to sin a bit more...)
  </p>

  <h3><a name="Emc2">E=mc<sup>2</sup></a></h3>
  <p>
   Everyone knows Einstein's E=mc<sup>2</sup> equation, but to apply it is
   often very difficult because the units come out so strange.  Let's see, I
   have mass in pounds, and the speed of light is 186,282
   miles/second... ummm... what does that come out to?  In Frink the
   calculation becomes transparently simple.
  </p>

  <p>
   If you took the matter in a teaspoon of water, and converted that to
   energy, how many gallons of gasoline would that equal?
  </p>

  <p>
   <code>teaspoon water c^2 -&gt; "gallons gasoline"</code><br>
   <code>3164209.862836101 gallons gasoline</code>
  </p>

  <p>
   Unbelievable.  The energy in a teaspoon of water, if we could extract it,
   is equal to burning more than 3 <em>million</em> gallons of gasoline.
  </p>

  <h3><a name="DaysOld">Days Old</a></h3>
  <p>
   The November 2001 edition of <i>Sky &amp; Telescope</i> magazine has a
   charming article called "Stellar Guides for Your Birthday" by Jeff
   A. Farinacci (p. 63), which provides a list of "nearby" stars and their
   distances in light-years or light-days.  This allows you to look at the
   light coming from a star that was emitted the day you were born.  It
   includes a <a href="http://www.skyandtelescope.com/astronomy-resources/basic-programs-from-sky-telescope/">28-line
   BASIC program, <code>daysold.bas</code></a> to calculate how many days old
   you are on a certain date. 
   As you know by now, the essential calculation can be done in one line of
   Frink.  For example, the bright star Pollux is about 33.7 light-years away
   (12314 days, based on the Hipparcos satellite's parallax measurement of
   96.74 milliarcseconds) and the light it emitted on the day I was born will
   finally reach earth on the date:
  </p>

  <p>
   <code>#1969-08-19# + 12314 days</code><br>
   <code>AD 2003-05-07 12:00:00.000 AM (Wed) Mountain Daylight Time</code>
  </p>

  <p>
   or, to calculate the date directly from the parallax, we can use the
   following, where <code>au</code> is an astronomical unit (the average
   distance between the earth and the sun,) and <code>c</code> is the speed of
   light, the values of which are known to Frink:
  </p>

  <p>
   <code>#1969-08-19# + au / (96.74 milliarcsec) / c</code><br>
  </p>

  <p>
   This gives the same date as the calculation above (May 7, 2003.)  I was
   amazed to find that the universe has conspired to produce a beautiful
   conjunction on this date.  Pollux will form a straight line with the moon
   and Jupiter in the western sky on that night:
  </p>

  <p>
   <img src="https://frinklang.org/images/conjunction.png" width="412" height="414" alt="View of the sky on May 7, 2003"><br>
   (Screenshot courtesy of the wonderful <a href="http://www.skyviewcafe.com/">Sky View Café</a> applet)
  </p>
  
  <p>
   (Note:  The three objects aren't as close together as it may look in this
   picture.  The sky is big.)  These screenshots show how it will look at 10 PM
   Mountain Daylight Time.
  </p>

  <p>
   Below is a 45-degree chunk of sky looking due west.  This will give you a
   better idea of how the sky will look as you face west.  You'll probably see
   Pollux and Castor quite clearly.  Castor is the bright star directly
   to the right of Pollux.  Castor and Pollux will appear to make a horizontal
   line at this time.
  </p>

  <p>
   <img src="https://frinklang.org/images/conjunction2.png" width="437" height="397" alt="45-degree view of the sky looking West during conjunction">
  </p>

  <p>
   It shouldn't be hard to find.  Look west.  The moon will be the brightest
   object in the sky, and Jupiter will be the second-brightest.  Follow the
   line from Jupiter to the moon.  Pollux is by far the brightest star along
   that line (it has a dimmer twin Castor, which will be on the right.)  The
   moon is in the center and Jupiter and Pollux are equal distances on either
   side of the moon.  Follow the wise men.  Bring gold.  I already have lots
   of frankincense and myrrh.
  </p>

  <p>
   <b>Alan's Editorializing</b>: This article also underlines one of the
   things I am growing to miss in most physical equations and all programs
   written in other languages... the loss of units.  Everything is an
   unexplained number, and inscrutable conversion factors are strewn liberally
   throughout.  This is exactly the type of thing that Frink was designed to
   address.  For example, a line in the article indicates:
  </p>

  <p>
   <i>The parallax-to-distance formula is simple: d=1/p, where p is the
    parallax angle in arcseconds and d is the distance in parsecs (3.26
    light-years).</i>
  </p>

  <p>
   This description is unfortunate.  1 divided by an angle (which is
   dimensionless) is still dimensionless, <em>not</em> a distance.  This is
   better specified by saying that the formula is distance=(orbital
   radius)/(parallax angle).  Since the parallax angles are specified with
   respect to Earth's orbital radius, you can write the equation as
   <code><i>d</i> = au/<i>p</i></code>. "<code>au</code>" is an astronomical
   unit, the average distance between the Earth and the Sun, which is included
   in Frink's standard data file.  Then, p can be specified in <em>any</em>
   angular units and distance can be automatically converted to light-years or
   light-days instead of parsecs (or into feet, if you want).  As always,
   <em>Frink makes the units of measurement transparent, and helps to ensure
   that your calculations make sense.</em> So, using the <a href="http://www.rssd.esa.int/index.php?project=HIPPARCOS">Hipparcos</a>
   satellite's measurements for the parallax of the closest star, Proxima
   Centauri (okay, second-closest, smartypants):
  </p>

  <p>
   <code>au / (.7723 arcsec) -&gt; lightyears</code><br>
   <code>4.223182420960891 </code>
  </p>

  <p>
   This way, we learn something about the <em>nature</em> of the physical
   calculation which we can generalize, rather than having an equation that
   only works with one weird system of measurement.  (Although professional
   astronomers like to use parsecs, I think it's a horrible, intentionally
   exclusive, geocentric measurement and they're just being difficult.  There
   was even an article in <i>Sky &amp; Telescope</i> a while back which
   intimated that some astronomers would sneer and giggle at you if you used
   light-years in a professional publication or speech.)  Using our deeper
   knowledge, we can see how much more accurate the Hipparcos satellite would
   be if it were put into Jupiter's orbit, or how accurate its instruments
   need to be to achieve a certain accuracy in distance measurements.  We've
   learned something more general.
  </p>

  <p>
   Below is the same program as in Sky &amp; Telescope, but more flexible.
   You can enter the exact second of your birth using <a href="https://frinklang.org/frinkdata/dateformats.txt">any of the date formats that Frink
   recognizes.</a> You enter the desired age as "12314 days" or "1 billion
   seconds" or any other duration.  The program uses the <a href="#LeapSeconds"><code>addLeap</code></a> function to calculate the
   target date <em>with leap seconds accounted for</em>.  So you don't
   celebrate on the wrong second within the minute.
  </p>

  <p>
   <code>
    birthdate = parseDate[input["Enter your birthdate: "]]<br>
    str = input["Enter desired age: "]<br>
    age = eval[str]<br>
    println["You will be $str old on " + addLeap[birthdate,age]]<br>
   </code>
  </p>

  <p>
   <code>Enter your birthdate: </code>
   <code>1969-08-19 04:54 PM Mountain</code><br>
   <code>Enter desired age: </code>
   <code>1 billion seconds</code><br>
   <code>You will be 1 billion seconds old on AD 2001-04-27
     06:40:15.653 PM (Fri) Mountain Daylight Time
   </code>
  </p>

  <h4>Finding Your Own Star</h4>
  <p>
   Now you want your own star, don't you?  You might take a look at a list of
   <a href="http://en.wikipedia.org/wiki/List_of_brightest_stars">the
    brightest stars in the sky</a>
   and look the stars' distances in light-years.  This will give you an idea
   of the bright stars, and give you their Hipparcos catalog numbers.  Using
   the Hipparcos catalog number given in that table, you can look up that star
   from 
   <a href="http://www.rssd.esa.int/index.php?project=HIPPARCOS&amp;page=multisearch2">this
    Hipparcos search form,</a> find its Geometrical Parallax (field H11, which
   is probably given in milliarcseconds) and plug that number into the
   equation shown above.  At some point, I may make a Frink Server Page that
   automates this.  But you might learn more just by doing the calculations
   yourself.
  </p>

  <p>
   Whether you have a kid who is 8.6 years old (for Sirius which is the
   brightest star in the sky and 3141 light-days away,) someone turning 11.4
   (Procyon), turning 16.8 (Altair) or someone turning 65.1 (Aldebaran,) a
   star is a great gift and  might just start a love of astronomy.  I can't
   promise that the moon and the planets will line up for <em>them</em>,
   though.
  </p>

  <p>
   Note that there is some uncertainty in measuring parallaxes, often several
   percent, and thus the dates are somewhat uncertain, so it's a gift you can
   give <em>any</em> time around the date.  For example, the standard error
   for the parallax of Pollux is 0.87 milliarcseconds (parallax error is field
   H16 in the Hipparcos catalog, specified in milliarcseconds) which leads to
   an actual date that can vary from around January 17, 2003 to August 27,
   2003 -- a range of over 7 months.  Just have fun and celebrate your stars
   when you want!
  </p>

  <h3><a name="ModelSolarSystem">Model Solar System</a></h3>
  <p>
   This one is fun.  I didn't have a grasp of the size difference between the
   Earth and the Moon so I wanted to make a little scale model in my home.  It
   would be best to use spheres of the appropriate sizes, but I don't have
   that many balls.  Instead, I decided to cut circles out of paper.  My
   deciding dimension was the size of the piece of paper I used to cut out the
   pieces.  I could only get a 7-inch diameter circle for the Earth (3.5-inch
   radius), so this defined my scale, which I saved in a variable for use in
   later calculations:
  </p>
  
  <p>
   <code>scale = earthradius / (3.5 inches)</code><br>
   <code>7.166851856017998E7 </code>
  </p>

  <p>
   The standard data file contains information about the dimensions of the
   planets, <code>earthradius</code> being one of those.  Now how big should
   the Moon circle be?
  </p>

  <p>
   <code>moonradius / scale -&gt; inches</code><br>
   <code>0.9547455176283174 </code>
  </p>

  <p>
   Okay, using my rolling ruler, I cut out a circle with radius 0.95 inches
   (diameter 1.9 inches).  There's the Moon.  It's interesting to see the
   difference in size between the Earth and Moon:
  </p>

  <p>
   <img src="https://frinklang.org/images/earthmoon.jpg" width="280" height="210" alt="Earth-Moon Sizes">
  </p>

  <p>
   Now, to place them properly... how far away should they be at that scale?
  </p>

  <p>
   <code>moondist / scale -&gt; feet</code><br>
   <code>17.59705489913335 </code>
  </p>

  <p>
   Okay, stick the Earth to one wall, and then measure a distance 17.5 feet
   away, and stick the Moon to that.  <em>Installed!</em>
  </p>

  <p>
   From each vantage point, you can see how big the other actually looks from
   that distance.  Standing by the Earth, you can see how big the Moon looks
   (you've seen the Moon, but it's a smaller angle than you might guess... the
   Moon really doesn't take up much sky, only about half a degree in
   diameter.)  You can verify this by holding a fingernail out at arm's
   length, comparing it to the size of your Moon model, and then going outside
   and doing the same to the Moon, if you can see it.
  </p>

  <p>
   Now walk over to the Moon and look at the Earth.  It would be pretty big!
   Earth would appear about 3.66 times wider in diameter (in Frink notation,
   <code>earthradius/moonradius</code>, or 13.4 times larger in area (
   <code>pi earthradius^2 / (pi moonradius^2)</code> ).
  </p>

  <p>
   Just to verify, I wanted to make sure that the visible angles in my model
   match real life.  The visual angle of an object which does not subtend a
   large angle can be expressed as <code>angle = width / distance</code>.  The
   angle normally comes out in radians if width and distance are in the same
   units, but this is Frink.  You can get the answer out in degrees, or
   arcminutes if that's where your heart lies:
  </p>

  <p>
   <code>1.9 inches / (17.5 feet) -&gt; arcminutes</code><br>
   <code>31.10342316424469 </code>
  </p>

  <p>
   Yep, that's just the right number of arcminutes.  From Earth, the Sun and
   the Moon both appear just over half a degree in diameter, or about 32
   arcminutes (an arcminute is 1/60 of a degree).  It all works out.  Note
   that in the standard data file, radians are dimensionless units (a radian
   is defined as "1".)  This is because radians are dimensionless units, but
   you can convert values in radians to other angular units.
  </p>

  <p>
   By the way, a more accurate angular formula that is valid for large
   <em>and</em> small angles subtended by a sphere with a given radius at a
   specified distance is:
  </p>
  
  <p>
   <code>2 arcsin[<i>radius</i>/(<i>radius</i> + <i>distance</i>)] -&gt; degrees</code>
  </p>

  <p>
   Note that inverse trigonometric functions (<code>arcsin</code>,
   <code>arccos</code>, <code>arctan</code>) have their output in radians.
   This is easily converted to whatever angular units you want, as above.  You
   don't see that the output is in radians (if you use the standard data file)
   because radians are dimensionless numbers.  You just gotta be a bit careful
   here, or make the minor change in your units file to make radians a
   fundamental dimension.  (Read the documentation in the units file... the
   units file is otherwise radians-correct.)
  </p>
  
  <p>
   <b>Nostalgic Digression:</b> I remember a cool black-and-white movie we saw
   in my Kindergarten class about making a scale model of the solar system.
   It involved a <em>huge</em> vertical circular sign representing the Sun
   that somebody had built for the film and a car driving a measured distance
   away to look at it.  (A bit confusing, though.  I remember them saying
   "here we are, 93 million miles away!" and they were still in the same
   park.)  Good stuff, and I'm glad I finally made my own model.  It helps me
   understand how cool the Apollo missions were.  But my enthusiasm is
   tempered by the fact that I'm just now figuring out stuff they tried to
   teach me in Kindergarten.
  </p>

  <p>
   Now go make your own model.  Pick your own scale to fit your surroundings
   and materials.  It's fun.  In my model, Jupiter would have to
   be a sphere 6.59 feet in diameter, placed about 5.5 miles away right now.
   I'll have to get a bigger place.
  </p>

  <p>
   Now that you know how to calculate the size in Frink yourself, I've gone
   ahead and built a Frink Server Page that lets you
   <a href="https://frinklang.org/fsp/solar.fsp"><b>design your own!</b></a>
  </p>

  <p>
   <b>Homework:</b>  In your model, figure and/or plot the following:
  </p>

  <ul>
   <li>Orbit of the Space Shuttle (about 300 km above the surface of the
    Earth)  Wow.  That's barely up there.
   </li><li>Orbit of a geosynchronous satellite (42164 km from the <em>center</em>
    of the Earth, or about 22300 miles from the <em>surface</em> of the Earth.)
    Stand this far away from the Earth circle... that's how big it would look.
   </li><li>The sizes of the Sun, other planets, and their moons.
   </li><li>The speed of light in your model.
  </li></ul>

  <h3><a name="MCO">Saving Hundreds of Millions of Dollars</a></h3>
  <blockquote>
   <p>
    "The MCO [Mars Climate Orbiter] MIB [Mishap Investigation Board] has
    determined that the root cause for the loss of the MCO spacecraft was the
    failure to use metric units in the coding of a ground software file,
    "Small Forces," used in trajectory models.  Specifically, thruster
    performance data in English units instead of metric units was used in the
    software application code titled SM_FORCES (small forces)."<br> --<a href="ftp://ftp.hq.nasa.gov/pub/pao/reports/1999/MCO_report.pdf">Mars
    Climate Orbiter Mishap Investigation Board, Phase I Report</a>
   </p>
  </blockquote>

  <p>
   This is not to take away from the designers of a wonderfully complex
   spacecraft that can travel to Mars; that's an incredibly difficult problem,
   and I couldn't do it.  However, this is just the type of error that Frink
   was designed to help avoid, and because <em>I</em> make these type of
   errors a lot, I've designed this tool to help me.  Frink tracks units
   through <em>all</em> calculations and makes conversions between them
   transparent.  This is why I'm working toward making Frink a feasible
   solution for calculations of this type.
  </p>

  <p>
   <b>Update:</b>  I received the following from <a href="http://www.norvig.com/">Peter Norvig</a>:
  </p>

  <blockquote>
   <p>
    "I ran across Frink, and as a member of the MCO review board, I
    appreciate your efforts.  Note, however that more than just language
    support is necessary.  First, you'd have to have conventions on data
    I/O -- the misinterpreted data was from a file, not from another
    function in the program.  Also, there was an issue of software reuse
    -- the errant portion of the system had been used before on a previous
    mission, and in that case it was used in a non-critical,
    non-navigational way.  It was not properly reviewed because the team
    did not realize that in MCO it became critical."
   </p>
  </blockquote>

  <p>
   The points above are well-taken.  Proper parsing of units can be easily
   achieved in Frink with a simple, appropriate comment in the data file. <a href="https://frinklang.org/fsp/colorize.fsp?f=unittable.frink">unittable.frink</a> shows
   how Frink can parse a file containing units of measure.  All that is needed
   is to add a <em>single comment</em> to the data file that contains the
   units of measure of each data column.  Frink then reads each column with
   the appropriate units of measure and scale, using any units of measure that
   Frink knows about as input, and Frink parses them and works with them
   properly.  See its <a href="https://frinklang.org/unittable.txt">sample data file</a>.
  </p>

  <p>
   Frink and its <code>eval[x]</code> function could always trivially handle
   the case where each number in a file has its units of measure specified
   with the number, e.g. "<code>3.5 km/s</code>".  That's literally
   <em>zero</em> effort to parse with Frink, and is slightly less compact, but
   that's a very small price to pay, compared to mission failure.
  </p>

  <p>
   Of course, there's no simple solution for someone completely not reading
   the specification documents, but the fact that a file completely omits any
   units of measure would be a good warning flag to double-check your sources,
   I'm growing to fear and avoid any system that treats every physical
   measurement as an unexplained dimensionless number, as most programming
   languages have for the past few decades.  We can do better.
  </p>

  <h2><a name="ChangingSyntax">Changing Syntax</a></h2>
  <p>
   Keep in mind that the syntax represented in this document <em>will</em>
   change as Frink evolves.  The current parser just makes it easier for me to
   test certain features, and I intentionally refuse to spend a lot of time on
   it at this point.  The internals of the language should be the first
   concern, and the external representation is free to change.  Frink should
   be equally usable whether you want to load and save your data in the
   current mathematical notation, in a (LISP-like) prefix notation, in a (HP
   calculator-like) Reverse-Polish postfix notation, from a
   visually-based GUI, in MathML, TeX, XML, or whatever other
   flavor-of-the-month format the kids are crazy about these days.  The
   internals of the language are intentionally agnostic on this point, as they
   should be in a flexible design.
  </p>

  <p>
   On the other hand, I always want to keep Frink easy to use and transparent
   for the quick calculations as it is now.  Turning it into a language that
   forces an encumbering programming paradigm is out of the question.
  </p>

  <p>
   <b>Alan's Unsolicited Advice:</b> Anytime you're involved with a project
   where you hear people saying "we want to use 'X' technology" before they've
   even thought about representing the problem they're trying to solve, look
   up for the cloud of doom, which floats nigh.  It's like hiring a carpenter,
   who, before he knows what you want to make, insists on using
   mortice-and-tenon joints.
  </p>

  <h2><a name="Acknowledgements">Acknowledgements</a></h2>
  <h3>OROMatcher</h3>
  <p>
   "This product includes software developed by the Apache Software Foundation
   (<a href="http://www.apache.org/">http://www.apache.org/</a>)."  
  </p>

  <p>
   They made me say that.  The included part is the <a href="http://jakarta.apache.org/oro/index.html">Jakarta ORO</a> regular
   expression library.  I hacked it significantly so that it would compile and
   run on a Java 1.1 platform (so that Frink can be used on small devices
   running PersonalJava 1.1 and run in the JVM in just about any browser out
   there.)
  </p>

  <p>
   ORO is included under <a href="http://svn.apache.org/repos/asf/jakarta/oro/trunk/LICENSE">ORO
    licensing terms</a>.
  </p>

  <p>
   ORO has been removed from <a href="https://frinklang.org/experimental.html">Frink: The Next
   Generation</a> which requires Java 1.6 or later.  It uses Java's built-in
   regular expression library.
  </p>

  <h3>JavaCUP</h3>
  <p>
   JavaCUP is included under the following licensing terms:  <a href="http://www2.cs.tum.edu/projects/cup/licence.php">JavaCUP
   license.</a>  Note that the JavaCUP package itself is not included in
   Frink, but is used to generate a parser class.
  </p>

  <h3>JFlex</h3>
  <p>
   Frink's lexical analyzer is generated by <a href="http://www.jflex.de/">JFlex</a>.  Since this was generated from
   Frink's own specification, Frink may use the generated code without
   restriction according to <a href="http://jflex.de/copying.html">JFlex's
   licensing terms.</a>  The JFlex package itself is not included in Frink--it
   is only used to generate a lexer class.
  </p>

  <h2><a name="DonateToFrink">Donate to Frink</a></h2>
  <p>
   If you've gotten this far, hopefully you've seen something you liked.  If
   you find Frink useful, I'd appreciate if you took a look at some of the
   ways you can <a href="https://frinklang.org/donate.html">donate to Frink's development</a>.
   Thanks!
  </p>

  <hr>
  <p>
   Please send comments or questions to
   <a href="mailto:eliasen@mindspring.com">Alan Eliasen</a>.
  </p>
 

</div>]]></description>
        </item>
        <item>
            <title><![CDATA[New USPTO Memo Makes Fighting Patent Trolls Even Harder (289 pts)]]></title>
            <link>https://www.eff.org/deeplinks/2025/03/new-uspto-memo-makes-fighting-patent-trolls-even-harder</link>
            <guid>43439610</guid>
            <pubDate>Fri, 21 Mar 2025 18:55:33 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.eff.org/deeplinks/2025/03/new-uspto-memo-makes-fighting-patent-trolls-even-harder">https://www.eff.org/deeplinks/2025/03/new-uspto-memo-makes-fighting-patent-trolls-even-harder</a>, See on <a href="https://news.ycombinator.com/item?id=43439610">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
            <article role="article">
  
  
  <div><p>The U.S. Patent and Trademark Office (USPTO) just made a move that will protect bad patents at the expense of everyone else. In a <a href="https://www.uspto.gov/about-us/news-updates/uspto-rescinds-memorandum-addressing-discretionary-denial-procedures">memo released February 28</a>, the USPTO further restricted access to inter partes review, or IPR—the process Congress created to let the public challenge invalid patents without having to wage million-dollar court battles.</p>
<p>If left unchecked, this decision will shield bad patents from scrutiny, embolden patent trolls, and make it even easier for hedge funds and large corporations to weaponize weak patents against small businesses and developers.</p>
<h3><strong>IPR Exists Because the Patent Office Makes Mistakes</strong></h3>
<p>The USPTO grants <a href="https://ipo.org/wp-content/uploads/2025/01/2024-Top-300-Patent-Owners-List.pdf">over 300,000 patents a year</a>, but many of them <a href="https://ipwatchdog.com/2021/01/07/alice-in-2020-slashing-software-patents-and-searching-for-functional-language-at-the-federal-circuit-part-i/id=128802/">should not have been issued</a> in the first place. Patent examiners spend, on average, around <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=261400">20 hours per patent</a>, often missing key prior art or granting patents that are overly broad or vague. That’s how bogus patents on basic ideas—like <a href="https://www.eff.org/deeplinks/2015/04/effs-podcasting-patent-win-highlights-disturbing-trend">podcasting</a>, <a href="https://arstechnica.com/tech-policy/2013/01/how-newegg-crushed-the-shopping-cart-patent-and-saved-online-retail/">online shopping carts</a>, or <a href="https://arstechnica.com/tech-policy/2013/06/a-patent-on-watching-ads-online-no-problem-says-top-patent-court/">watching ads online</a>—have ended up in court.</p>
<p>Congress created IPR in 2012 to fix this problem. IPR allows anyone to challenge a patent’s validity based on prior art, and it’s done before specialized judges at the USPTO, where experts can re-evaluate whether a patent was properly granted. It’s faster, cheaper, and often fairer than fighting it out in federal court.</p>
<h3><strong>The USPTO is Blocking Patent Challenges—Again</strong></h3>
<p>Instead of defending IPR, the USPTO is working to sabotage it. The February 28 memo reinstates a rule that allows for widespread use of “discretionary denials.” That’s when the Patent Trial and Appeal Board (PTAB) refuses to hear an IPR case for procedural reasons—even if the patent is likely invalid.&nbsp;</p>
<p>The February 28 memo reinstates widespread use of the <a href="https://www.uspto.gov/sites/default/files/documents/IPR2020-00019,%20Apple%20v.%20Fintiv,%20Paper%2011%20(3.20.20).pdf"><i>Apple v. Fintiv</i> rule</a>, under which the USPTO often rejected IPR petitions whenever there’s an ongoing district court case about the same patent. This is backwards. If anything, an active lawsuit is proof that a patent’s validity needs to be reviewed—not an excuse to dodge the issue.</p>
<p>In 2022, former USPTO Director Kathi Vidal issued a <a href="https://www.uspto.gov/sites/default/files/documents/interim_proc_discretionary_denials_aia_parallel_district_court_litigation_memo_20220621_.pdf">memo</a> making clear that the PTAB should hear patent challenges when “a petition presents compelling evidence of unpatentability,” even if there is parallel court litigation.&nbsp;</p>
<p>That 2022 guidance essentially saved the IPR system. Once PTAB judges were told to consider all petitions that showed “compelling evidence,” the procedural denials <a href="https://www.unifiedpatents.com/insights/2022/10/27/q3-ptab-discretionary-denial-report-use-of-fintiv-drops-to-near-zero">dropped to almost nothing</a>. This February 28 memo signals that the USPTO will once again use discretionary denials to sharply limit access to IPR<span>—effectively making patent challenges harder across the board.&nbsp;&nbsp;</span></p>
<h3><b>Discretionary Denials Let Patent Trolls Rig the System</b></h3>
<p><span>The top beneficiary of this decision will be patent trolls, shell companies formed expressly for the purpose of filing patent lawsuits. Often patent trolls seek to extract a quick settlement before a patent can be challenged. With IPR becoming increasingly unavailable, that will be easier than ever.&nbsp;</span></p>
<p><span>Patent owners know that discretionary denials will block IPRs if they file a lawsuit first. That’s why trolls flock to specific courts, like the </span><a href="https://www2.law.temple.edu/10q/how-the-west-became-the-east-the-patent-litigation-explosion-in-the-western-district-of-texas/"><span>Western District of Texas</span></a><span>, where judges move cases quickly and rarely rule against patent owners.</span></p>
<p><span>By filing lawsuits in these troll-friendly courts, patent owners can game the system—forcing companies to pay up rather than risk millions in litigation costs.</span></p>
<p><span>The recent USPTO memo makes this problem even worse. Instead of stopping the abuse of discretionary denials, the USPTO is doubling down—undermining one of the most effective ways businesses, developers, and consumers can fight back against bad patents.</span></p>
<h3><b>Congress Created IPR to Protect the Public—Not Just Patent Owners</b></h3>
<p><span>The USPTO doesn’t get to rewrite the law. Congress passed IPR to ensure that weak patents don’t become weapons for extortionary lawsuits. By reinforcing discretionary denials with minimal restrictions, and, as a result, blocking access to IPRs, the USPTO is directly undermining what Congress intended.</span></p>
<p><span>Leaders at the USPTO should immediately revoke the February 28 memo. If they refuse, as </span><a href="https://www.eff.org/deeplinks/2020/07/when-us-patent-office-wont-do-its-job-congress-should-step"><span>we pointed out the last time IPR denials spiraled out of control</span></a><span>, it’s time for Congress to step in and fix this. They must ensure that IPR remains a fast, affordable way to challenge bad patents—not just a tool for the largest corporations. Patent quality matters—because when bad patents stand, we all pay the price.</span></p>

</div>

          </article>
    </div><div>
          <h2>Join EFF Lists</h2>
        
    </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Show HN: A terminal emulator in pure PHP (174 pts)]]></title>
            <link>https://github.com/soloterm/screen</link>
            <guid>43438797</guid>
            <pubDate>Fri, 21 Mar 2025 17:43:25 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://github.com/soloterm/screen">https://github.com/soloterm/screen</a>, See on <a href="https://news.ycombinator.com/item?id=43438797">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text"><p dir="auto"><h2 tabindex="-1" dir="auto">Solo Screen</h2><a id="user-content-solo-screen" aria-label="Permalink: Solo Screen" href="#solo-screen"></a></p>
<p dir="auto">Screen is a terminal renderer written in pure PHP. It powers <a href="https://github.com/soloterm/solo">Solo for Laravel</a> and
can be used to build rich text-based user interfaces in any PHP application.</p>
<div dir="auto"><p dir="auto">Note</p><p dir="auto">Screen is a library intended to be integrated into PHP applications. It is not a standalone terminal application.</p>
</div>
<p dir="auto"><h2 tabindex="-1" dir="auto">About terminal renderers</h2><a id="user-content-about-terminal-renderers" aria-label="Permalink: About terminal renderers" href="#about-terminal-renderers"></a></p>
<p dir="auto">A terminal renderer processes text and ANSI escape sequences to create a virtual representation of terminal output.
Unlike a full terminal emulator, Screen focuses specifically on correctly interpreting and rendering text content with
formatting rather than handling input, interactive sessions, or process management.</p>
<p dir="auto">Terminal renderers interpret escape sequences to:</p>
<ul dir="auto">
<li>Track cursor position</li>
<li>Apply text colors and styles (bold, underline, etc.)</li>
<li>Manage screen content</li>
<li>Handle special character sets</li>
<li>Generate a final rendered output</li>
</ul>
<p dir="auto">Screen implements this functionality in pure PHP, allowing developers to build terminal user interfaces without relying
on external dependencies or native code.</p>
<p dir="auto"><h2 tabindex="-1" dir="auto">Why this exists</h2><a id="user-content-why-this-exists" aria-label="Permalink: Why this exists" href="#why-this-exists"></a></p>
<p dir="auto">Screen was originally created to solve a specific problem in <a href="https://github.com/soloterm/solo">Solo for Laravel</a>.</p>
<p dir="auto">Solo provides a TUI (Text User Interface) that runs multiple processes simultaneously in separate panels, similar to
tmux. However, when these processes output ANSI escape codes for cursor movement and screen manipulation, they could
potentially "break out" of their visual containers and interfere with other parts of the interface.</p>
<p dir="auto">To solve this problem, Screen creates a virtual terminal buffer where:</p>
<ol dir="auto">
<li>All ANSI operations (cursor movements, color changes, screen clears) are safely interpreted within an isolated
environment</li>
<li>The final rendered state is captured after all operations are processed</li>
<li>Only the final visual output is displayed to the user's terminal</li>
</ol>
<p dir="auto">This approach provides complete control over how terminal output is rendered, ensuring that complex ANSI operations stay
contained within their designated areas. While initially built for Solo, Screen has evolved into a standalone library
that can be used in any PHP application requiring terminal rendering.</p>
<p dir="auto"><h2 tabindex="-1" dir="auto">Features</h2><a id="user-content-features" aria-label="Permalink: Features" href="#features"></a></p>
<ul dir="auto">
<li><strong>Pure PHP Implementation</strong>: Only one dependency (<a href="https://github.com/soloterm/grapheme">Grapheme</a>, another Solo
library)</li>
<li><strong>Comprehensive ANSI Support</strong>: Handles cursor positioning, text styling, and screen manipulation</li>
<li><strong>Unicode/Multibyte Support</strong>: Properly handles UTF-8 characters including emojis and wide characters</li>
<li><strong>Buffer Management</strong>: Maintains separate buffers for text content and styling</li>
<li><strong>Character Width Handling</strong>: Correctly calculates display width for CJK and other double-width characters</li>
<li><strong>Scrolling</strong>: Support for vertical scrolling with proper content management</li>
</ul>
<p dir="auto"><h2 tabindex="-1" dir="auto">Installation</h2><a id="user-content-installation" aria-label="Permalink: Installation" href="#installation"></a></p>
<p dir="auto">Install via Composer:</p>
<div dir="auto" data-snippet-clipboard-copy-content="composer require soloterm/screen"><pre>composer require soloterm/screen</pre></div>
<p dir="auto"><h2 tabindex="-1" dir="auto">Requirements</h2><a id="user-content-requirements" aria-label="Permalink: Requirements" href="#requirements"></a></p>
<ul dir="auto">
<li>PHP 8.1 or higher</li>
<li>mbstring extension</li>
</ul>
<p dir="auto"><h2 tabindex="-1" dir="auto">Basic usage</h2><a id="user-content-basic-usage" aria-label="Permalink: Basic usage" href="#basic-usage"></a></p>
<p dir="auto">Here's a simple example of using Screen:</p>
<div dir="auto" data-snippet-clipboard-copy-content="use SoloTerm\Screen\Screen;

// Create a screen with dimensions (columns, rows)
$screen = new Screen(80, 24);

// Write text and ANSI escape sequences
$screen->write(&quot;Hello, \e[1;32mWorld!\e[0m&quot;);

// Move cursor and add more text
$screen->write(&quot;\e[5;10HPositioned text&quot;);

// Get the rendered content
echo $screen->output();"><pre><span>use</span> <span>SoloTerm</span>\<span>Screen</span>\<span>Screen</span>;

<span>// Create a screen with dimensions (columns, rows)</span>
<span><span>$</span>screen</span> = <span>new</span> <span>Screen</span>(<span>80</span>, <span>24</span>);

<span>// Write text and ANSI escape sequences</span>
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"<span>Hello, </span>\e<span>[1;32mWorld!</span>\e<span>[0m</span>"</span>);

<span>// Move cursor and add more text</span>
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"\e<span>[5;10HPositioned text</span>"</span>);

<span>// Get the rendered content</span>
<span>echo</span> <span><span>$</span>screen</span>-&gt;<span>output</span>();</pre></div>
<p dir="auto"><h2 tabindex="-1" dir="auto">Core concepts</h2><a id="user-content-core-concepts" aria-label="Permalink: Core concepts" href="#core-concepts"></a></p>
<p dir="auto">Screen operates with several key components:</p>
<p dir="auto"><h3 tabindex="-1" dir="auto">Screen</h3><a id="user-content-screen" aria-label="Permalink: Screen" href="#screen"></a></p>
<p dir="auto">The main class that coordinates all functionality. It takes care of cursor positioning, content writing, and rendering
the final output.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$screen = new Screen(80, 24); // width, height
$screen->write(&quot;Text and ANSI codes&quot;);"><pre><span><span>$</span>screen</span> = <span>new</span> <span>Screen</span>(<span>80</span>, <span>24</span>); <span>// width, height</span>
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"<span>Text and ANSI codes</span>"</span>);</pre></div>
<p dir="auto"><h3 tabindex="-1" dir="auto">Buffers</h3><a id="user-content-buffers" aria-label="Permalink: Buffers" href="#buffers"></a></p>
<p dir="auto">Screen uses multiple buffer types to track content and styling:</p>
<ul dir="auto">
<li><strong>PrintableBuffer</strong>: Stores visible characters and handles width calculations</li>
<li><strong>AnsiBuffer</strong>: Tracks styling information (colors, bold, underline, etc.)</li>
</ul>
<p dir="auto"><h3 tabindex="-1" dir="auto">ANSI processing</h3><a id="user-content-ansi-processing" aria-label="Permalink: ANSI processing" href="#ansi-processing"></a></p>
<p dir="auto">Screen correctly interprets ANSI escape sequences for:</p>
<ul dir="auto">
<li>Cursor movement (up, down, left, right, absolute positioning)</li>
<li>Text styling (colors, bold, italic, underline)</li>
<li>Screen clearing and line manipulation</li>
<li>Scrolling</li>
</ul>
<p dir="auto"><h2 tabindex="-1" dir="auto">Advanced features</h2><a id="user-content-advanced-features" aria-label="Permalink: Advanced features" href="#advanced-features"></a></p>
<p dir="auto"><h3 tabindex="-1" dir="auto">Cursor positioning</h3><a id="user-content-cursor-positioning" aria-label="Permalink: Cursor positioning" href="#cursor-positioning"></a></p>
<div dir="auto" data-snippet-clipboard-copy-content="// Move cursor to position (row 5, column 10)
$screen->write(&quot;\e[5;10H&quot;);

// Move cursor up 3 lines
$screen->write(&quot;\e[3A&quot;);

// Save and restore cursor position
$screen->write(&quot;\e7&quot;); // Save
$screen->write(&quot;More text&quot;);
$screen->write(&quot;\e8&quot;); // Restore"><pre><span>// Move cursor to position (row 5, column 10)</span>
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"\e<span>[5;10H</span>"</span>);

<span>// Move cursor up 3 lines</span>
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"\e<span>[3A</span>"</span>);

<span>// Save and restore cursor position</span>
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"\e<span>7</span>"</span>); <span>// Save</span>
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"<span>More text</span>"</span>);
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"\e<span>8</span>"</span>); <span>// Restore</span></pre></div>
<p dir="auto"><h3 tabindex="-1" dir="auto">Text styling</h3><a id="user-content-text-styling" aria-label="Permalink: Text styling" href="#text-styling"></a></p>
<div dir="auto" data-snippet-clipboard-copy-content="// Bold red text
$screen->write(&quot;\e[1;31mImportant message\e[0m&quot;);

// Background colors
$screen->write(&quot;\e[44mBlue background\e[0m&quot;);

// 256-color support
$screen->write(&quot;\e[38;5;208mOrange text\e[0m&quot;);

// RGB colors
$screen->write(&quot;\e[38;2;255;100;0mCustom color\e[0m&quot;);"><pre><span>// Bold red text</span>
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"\e<span>[1;31mImportant message</span>\e<span>[0m</span>"</span>);

<span>// Background colors</span>
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"\e<span>[44mBlue background</span>\e<span>[0m</span>"</span>);

<span>// 256-color support</span>
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"\e<span>[38;5;208mOrange text</span>\e<span>[0m</span>"</span>);

<span>// RGB colors</span>
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"\e<span>[38;2;255;100;0mCustom color</span>\e<span>[0m</span>"</span>);</pre></div>
<p dir="auto"><h3 tabindex="-1" dir="auto">Screen manipulation</h3><a id="user-content-screen-manipulation" aria-label="Permalink: Screen manipulation" href="#screen-manipulation"></a></p>
<div dir="auto" data-snippet-clipboard-copy-content="// Clear screen
$screen->write(&quot;\e[2J&quot;);

// Clear from cursor to end of line
$screen->write(&quot;\e[0K&quot;);

// Insert lines
$screen->write(&quot;\e[2L&quot;);

// Scroll up
$screen->write(&quot;\e[2S&quot;);"><pre><span>// Clear screen</span>
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"\e<span>[2J</span>"</span>);

<span>// Clear from cursor to end of line</span>
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"\e<span>[0K</span>"</span>);

<span>// Insert lines</span>
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"\e<span>[2L</span>"</span>);

<span>// Scroll up</span>
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"\e<span>[2S</span>"</span>);</pre></div>
<p dir="auto"><h2 tabindex="-1" dir="auto">Custom integrations</h2><a id="user-content-custom-integrations" aria-label="Permalink: Custom integrations" href="#custom-integrations"></a></p>
<p dir="auto">You can respond to terminal queries by setting a callback:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$screen->respondToQueriesVia(function($response) {
    // Process response (like cursor position)
    echo $response;
});"><pre><span><span>$</span>screen</span>-&gt;<span>respondToQueriesVia</span>(<span>function</span>(<span><span>$</span>response</span>) {
    <span>// Process response (like cursor position)</span>
    <span>echo</span> <span><span>$</span>response</span>;
});</pre></div>
<div dir="auto"><p dir="auto">Note</p><p dir="auto">This is still a work in progress. We need some more tests / use cases here.</p>
</div>
<p dir="auto"><h2 tabindex="-1" dir="auto">Example: building a simple UI</h2><a id="user-content-example-building-a-simple-ui" aria-label="Permalink: Example: building a simple UI" href="#example-building-a-simple-ui"></a></p>
<div dir="auto" data-snippet-clipboard-copy-content="use SoloTerm\Screen\Screen;

$screen = new Screen(80, 24);

// Draw a border
$screen->write(&quot;┌&quot; . str_repeat(&quot;─&quot;, 78) . &quot;┐\n&quot;);
for ($i = 0; $i < 22; $i++) {
    $screen->write(&quot;│&quot; . str_repeat(&quot; &quot;, 78) . &quot;│\n&quot;);
}
$screen->write(&quot;└&quot; . str_repeat(&quot;─&quot;, 78) . &quot;┘&quot;);

// Add a title
$screen->write(&quot;\e[1;30H\e[1;36mMy Application\e[0m&quot;);

// Add some content
$screen->write(&quot;\e[5;5HWelcome to the application!&quot;);
$screen->write(&quot;\e[7;5HPress 'q' to quit.&quot;);

// Render
echo $screen->output();"><pre><span>use</span> <span>SoloTerm</span>\<span>Screen</span>\<span>Screen</span>;

<span><span>$</span>screen</span> = <span>new</span> <span>Screen</span>(<span>80</span>, <span>24</span>);

<span>// Draw a border</span>
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"<span>┌</span>"</span> . <span>str_repeat</span>(<span>"<span>─</span>"</span>, <span>78</span>) . <span>"<span>┐</span>\n"</span>);
<span>for</span> (<span><span>$</span>i</span> = <span>0</span>; <span><span>$</span>i</span> &lt; <span>22</span>; <span><span>$</span>i</span>++) {
    <span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"<span>│</span>"</span> . <span>str_repeat</span>(<span>"<span> </span>"</span>, <span>78</span>) . <span>"<span>│</span>\n"</span>);
}
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"<span>└</span>"</span> . <span>str_repeat</span>(<span>"<span>─</span>"</span>, <span>78</span>) . <span>"<span>┘</span>"</span>);

<span>// Add a title</span>
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"\e<span>[1;30H</span>\e<span>[1;36mMy Application</span>\e<span>[0m</span>"</span>);

<span>// Add some content</span>
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"\e<span>[5;5HWelcome to the application!</span>"</span>);
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"\e<span>[7;5HPress 'q' to quit.</span>"</span>);

<span>// Render</span>
<span>echo</span> <span><span>$</span>screen</span>-&gt;<span>output</span>();</pre></div>
<p dir="auto"><h2 tabindex="-1" dir="auto">Handling unicode and wide characters</h2><a id="user-content-handling-unicode-and-wide-characters" aria-label="Permalink: Handling unicode and wide characters" href="#handling-unicode-and-wide-characters"></a></p>
<p dir="auto">Screen properly handles Unicode characters including emoji and CJK characters that take up multiple columns:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$screen->write(&quot;Regular text: Hello&quot;);
$screen->write(&quot;\nWide characters: 你好世界&quot;);
$screen->write(&quot;\nEmoji: 🚀 👨‍👩‍👧‍👦 🌍&quot;);"><pre><span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"<span>Regular text: Hello</span>"</span>);
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"\n<span>Wide characters: 你好世界</span>"</span>);
<span><span>$</span>screen</span>-&gt;<span>write</span>(<span>"\n<span>Emoji: 🚀 👨‍👩‍👧‍👦 🌍</span>"</span>);</pre></div>
<p dir="auto"><h2 tabindex="-1" dir="auto">Testing</h2><a id="user-content-testing" aria-label="Permalink: Testing" href="#testing"></a></p>
<p dir="auto">Screen includes a comprehensive testing suite that features a unique visual comparison system:</p>

<p dir="auto"><h3 tabindex="-1" dir="auto">Visual testing</h3><a id="user-content-visual-testing" aria-label="Permalink: Visual testing" href="#visual-testing"></a></p>
<p dir="auto">Screen employs an innovative screenshot-based testing approach (see <code>ComparesVisually</code> trait) that validates the visual
output:</p>
<ol dir="auto">
<li>The test renders content in a real terminal (iTerm)</li>
<li>It captures a screenshot of the terminal output</li>
<li>It runs the same content through the Screen renderer</li>
<li>It captures a screenshot of the rendered output</li>
<li>It compares the screenshots pixel-by-pixel to ensure accuracy</li>
</ol>
<p dir="auto">This testing strategy ensures that Screen's rendering accurately matches real terminal behavior, especially for complex
scenarios involving:</p>
<ul dir="auto">
<li>Multi-byte characters</li>
<li>Complex ANSI formatting</li>
<li>Cursor movements</li>
<li>Scrolling behavior</li>
<li>Line wrapping</li>
</ul>
<p dir="auto">For environments without screenshot capabilities, tests can fall back to fixture-based comparison, making the test suite
versatile for CI/CD pipelines.</p>
<p dir="auto">To enable screenshots for all tests, use the following command:</p>
<div dir="auto" data-snippet-clipboard-copy-content="ENABLE_SCREENSHOT_TESTING=1 composer test"><pre>ENABLE_SCREENSHOT_TESTING=1 composer <span>test</span></pre></div>
<p dir="auto">To enable screenshots for only the tests that don't already have fixtures, use the following command:</p>
<div dir="auto" data-snippet-clipboard-copy-content="ENABLE_SCREENSHOT_TESTING=2 composer test"><pre>ENABLE_SCREENSHOT_TESTING=2 composer <span>test</span></pre></div>
<p dir="auto"><h2 tabindex="-1" dir="auto">Contributing</h2><a id="user-content-contributing" aria-label="Permalink: Contributing" href="#contributing"></a></p>
<p dir="auto">Contributions are welcome! Please feel free to submit a pull request.</p>
<p dir="auto"><h2 tabindex="-1" dir="auto">License</h2><a id="user-content-license" aria-label="Permalink: License" href="#license"></a></p>
<p dir="auto">The MIT License (MIT).</p>
<p dir="auto"><h2 tabindex="-1" dir="auto">Support</h2><a id="user-content-support" aria-label="Permalink: Support" href="#support"></a></p>
<p dir="auto">This is free! If you want to support me:</p>
<ul dir="auto">
<li>Sponsor my open source work: <a href="https://aaronfrancis.com/backstage" rel="nofollow">aaronfrancis.com/backstage</a></li>
<li>Check out my courses:
<ul dir="auto">
<li><a href="https://masteringpostgres.com/" rel="nofollow">Mastering Postgres</a></li>
<li><a href="https://highperformancesqlite.com/" rel="nofollow">High Performance SQLite</a></li>
<li><a href="https://screencasting.com/" rel="nofollow">Screencasting</a></li>
</ul>
</li>
<li>Help spread the word about things I make</li>
</ul>
<p dir="auto"><h2 tabindex="-1" dir="auto">Credits</h2><a id="user-content-credits" aria-label="Permalink: Credits" href="#credits"></a></p>
<p dir="auto">Solo Screen was developed by Aaron Francis. If you like it, please let me know!</p>
<ul dir="auto">
<li>Twitter: <a href="https://twitter.com/aarondfrancis" rel="nofollow">https://twitter.com/aarondfrancis</a></li>
<li>Website: <a href="https://aaronfrancis.com/" rel="nofollow">https://aaronfrancis.com</a></li>
<li>YouTube: <a href="https://youtube.com/@aarondfrancis" rel="nofollow">https://youtube.com/@aarondfrancis</a></li>
<li>GitHub: <a href="https://github.com/aarondfrancis">https://github.com/aarondfrancis</a></li>
</ul>
</article></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Chunking Attacks on File Backup Services Using Content-Deﬁned Chunking [pdf] (107 pts)]]></title>
            <link>https://www.daemonology.net/blog/chunking-attacks.pdf</link>
            <guid>43438601</guid>
            <pubDate>Fri, 21 Mar 2025 17:30:34 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.daemonology.net/blog/chunking-attacks.pdf">https://www.daemonology.net/blog/chunking-attacks.pdf</a>, See on <a href="https://news.ycombinator.com/item?id=43438601">Hacker News</a></p>
&lt;Not HTML&gt;]]></description>
        </item>
    </channel>
</rss>