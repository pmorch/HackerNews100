<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>HN100 - Readable Contents</title>
        <link>https://hn.algolia.com/api/v1/search_by_date?tags=%28story,poll%29&amp;numericFilters=points%3E100</link>
        <description>Uses Readability to add bodies to the RSS feed</description>
        <lastBuildDate>Thu, 31 Oct 2024 09:30:01 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[Zed: SSH Remoting Is Here (139 pts)]]></title>
            <link>https://zed.dev/blog/remote-development</link>
            <guid>42004206</guid>
            <pubDate>Thu, 31 Oct 2024 07:14:13 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://zed.dev/blog/remote-development">https://zed.dev/blog/remote-development</a>, See on <a href="https://news.ycombinator.com/item?id=42004206">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><section><article><p>For people with large codebases, programming on a laptop can be overwhelming. Your fans are constantly spinning, the language server is continually out of memory, and rebuilds take forever...</p>
<p>Now, in Zed, you can open a project on any machine you can SSH into. The UI runs fully locally to give you 120 frames per second of perfectly configured graphics, but with all the gubbins: language servers, tasks, and terminals run on the remote server where they can take advantage of cloud hardware.</p>
<p>It's simple to use for one-off projects:</p>
<div><pre><code>zed ssh://my-host/~/code/zed
</code></pre></div>
<p>And you can configure longer-lived connections as you need:</p>
<div><figure><img src="https://zed.dev/img/post/remote-dev/remote-dev.png" alt="The &quot;Remote Projects&quot; UI in Zed."><figcaption>The "Remote Projects" UI in Zed.</figcaption></figure></div>
<p>For more information, <a href="https://zed.dev/docs/remote-development">see the documentation</a>.</p>
<h2 id="building-remote-development">Building Remote Development</h2>
<p>We've been working on our remote development feature for a while. While Zed is built for <a href="https://zed.dev/docs/collaboration">remote code editing</a>, changing the infrastructure to support SSH required solving a whole bunch of sub-problems, from SSH connection maintenance, to how we build the remote server, to integrating the feature into everything else we have in Zed.</p>
<p>For the SSH connection, we use the <a href="https://linux.die.net/man/5/ssh_config">ControlMaster</a> setting to maintain a single connection to each host. This means that you can open new terminals and spawn tasks without having to retype your passphrase or re-authenticate. Once connected, we download the remote server for your operating system and architecture. Unlike our normal Linux builds, the remote server can be compiled with <code>musl</code>, which requires no dynamic linking. This lets it work on older distros (where before we ran into compatibility problems with <code>glibc</code>) and on modern share-nothing distros like Nix that don't have a global set of libraries to dynamically link. Once we've established the connection and installed the remote server, we initialize it as a daemon, so that when connections do drop the remote server continues running and on reconnect your language servers are still fully initialized. We also back up any unsaved changes locally, so you never lose your work.</p>
<p>The final piece of the puzzle was making SSH projects work with collaboration. This has been a real stress test of our collaborative syncing protocol as there can now be at least four different nodes involved in a 2-person collaboration over SSH. We had to rewrite our <code>Project</code>, and split it into logical chunks that could be enabled in remote and local modes depending on whether your client is the collab host, the ssh host, or the collab guest. We also have some new, fun <a href="https://github.com/zed-industries/zed/blob/main/crates/collab/src/tests/remote_editing_collaboration_tests.rs#L28-L86">tests</a> that instantiate each of these roles, and our collaboration server, and ensures that the synchronization is done correctly. If you're working on a project with a friend or colleague, it should be completely transparent to them whether the project is on your laptop, or on a machine you can SSH into.</p>
<p>Please try it out today and, as always, leave us feedback in <a href="https://github.com/zed-industries/zed">GitHub Issues</a> or <a href="https://discord.gg/zed-community">Discord</a>.</p><hr></article></section></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[I attended Google's creator conversation event, and it turned into a funeral (172 pts)]]></title>
            <link>https://www.giantfreakinrobot.com/tech/google-creators-event.html</link>
            <guid>42002262</guid>
            <pubDate>Thu, 31 Oct 2024 00:43:42 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.giantfreakinrobot.com/tech/google-creators-event.html">https://www.giantfreakinrobot.com/tech/google-creators-event.html</a>, See on <a href="https://news.ycombinator.com/item?id=42002262">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-url="https://www.giantfreakinrobot.com/tech/google-creators-event.html" data-title="I Attended Google’s Creator Conversation Event, And It Turned Into A Funeral" data-id="687043" data-page="0" aria-live="polite" aria-atomic="true" data-single-post="true" data-single-post-id="687043" data-single-post-order="previous" data-single-post-taxonomy="post_tag" data-single-post-excluded-terms="40003" data-single-post-title-template="{post-title} - {site-title}" data-single-post-site-title="GIANT FREAKIN ROBOT" data-single-post-site-tagline="Stomping into the future of entertainment." data-single-post-scroll="false" data-single-post-scrolltop="30" data-single-post-controls="1" data-single-post-progress-bar="" data-container-type="div" data-loading-style="grey" data-repeater="default" data-post-type="post" data-order="DESC" data-orderby="date" data-offset="0" data-posts-per-page="1" data-scroll-distance="-1200" data-button-label="Load More"><!-- Grid row -->
<article id="post-687043">
	<!-- Grid column -->
	<div>
				                            
		
		
		
		
<figure><img fetchpriority="high" decoding="async" width="900" height="506" src="https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/googlebag-900x506.png" alt="Google Creator Conversation Event" srcset="https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/googlebag-900x506.png 900w, https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/googlebag-578x325.png 578w, https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/googlebag-768x432.png 768w, https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/googlebag-1200x675.png 1200w, https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/googlebag.png 1280w" sizes="(max-width: 900px) 100vw, 900px"></figure>



<p>I recently attended a funeral. It was called the Google Web Creator Conversation Event and took place on October 29, 2024, at Google headquarters in Mountain View, California.&nbsp;</p>



<p>Google invited some of the most vocal independent site owners who’ve been shadowbanned by their brutal updates of the last two years, and 20 of them came to pay their respects. We had no idea what the purpose of our visit was going in, but we knew by the time we left.</p>



<p>Google has never done anything like it before. After this account, they likely never will again.</p>



<h3 id="h-visiting-the-google-campus"><strong>Visiting The Google Campus</strong></h3>



<figure><img decoding="async" width="900" height="506" src="https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/GoogleHQ-900x506.png" alt="Creators visiting Google's campus" srcset="https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/GoogleHQ-900x506.png 900w, https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/GoogleHQ-578x325.png 578w, https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/GoogleHQ-768x432.png 768w, https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/GoogleHQ-1200x675.png 1200w, https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/GoogleHQ.png 1280w" sizes="(max-width: 900px) 100vw, 900px"><figcaption>Google’s biggest empty building</figcaption></figure>



<p>Danny Sullivan hosted the event. He may be the most knowledgeable and helpful person still left at Google, though he has no real power to effect change.</p>



<p>The day before, he led the group on a tour of Google’s biggest office during the busiest part of weekday work hours and seemed slightly embarrassed that at no point during the tour was anyone there. The building was empty, a shell designed as a hub of activity, drained of people willing to engage in being active.</p>



<figure><img decoding="async" width="900" height="506" src="https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/googlepaths-900x506.png" alt="Empty pathways at Google campus during the Creator Event" srcset="https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/googlepaths-900x506.png 900w, https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/googlepaths-578x325.png 578w, https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/googlepaths-768x432.png 768w, https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/googlepaths-1200x675.png 1200w, https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/googlepaths.png 1280w" sizes="(max-width: 900px) 100vw, 900px"><figcaption>An empty path between Google buildings</figcaption></figure>



<p>Empty too, was the rest of Google’s behemoth campus. Their numerous buildings are surrounded by beautiful, park-like pathways with no one to enjoy them but the groundskeepers. They follow the paths with their lawnmowers, weaving between softly shaded employee parking lots, with no one to park in them.</p>



<p>Well, not no one. Continuing my aimless meandering, I encountered a large, mentally ill man in tight-fitting black clothing, screaming profanity and punching wildly at the air.</p>



<p>He didn’t seem to notice me, occupied as he was with fighting ghosts, and we passed amicably.&nbsp;</p>



<h3 id="h-buildings-so-secure-they-re-empty"><strong>Buildings So Secure They’re Empty</strong></h3>



<p>We weren’t allowed into the large, high-security building where Danny held his Creator Event until we’d been given not one but two visitor badges and affixed them to our clothes. After they were handed to us, these were never looked at or checked. There was no one around to check them.</p>




<p>I did see many janitors and food workers bustling about the premises. I considered asking them to check at least one of my visitor badges, but didn’t want to distract them from the noble task of delivering crystal bowls filled with conference room M&amp;Ms.</p>



<p>I saw only two Googlers out and about during my day spent in the building. They played ping pong atop a depressing, gray table in a tiny, fishbowl room deep within the bowels of Google’s labyrinth. They didn’t seem to be enjoying it.</p>



<h3 id="h-our-conversation-began-with-reassurances"><strong>Our Conversation Began With Reassurances</strong></h3>



<figure><img loading="lazy" decoding="async" width="900" height="506" src="https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/surveillance-900x506.png" alt="Web Conversation Creators being watched" srcset="https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/surveillance-900x506.png 900w, https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/surveillance-578x325.png 578w, https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/surveillance-768x432.png 768w, https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/surveillance-1200x675.png 1200w, https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/surveillance.png 1280w" sizes="(max-width: 900px) 100vw, 900px"><figcaption>Web Creators under surveillance by Google</figcaption></figure>



<p>The event began in a conference room full of folding card tables and stackable chairs, the kind of room you’d expect to see available to rent in a well-appointed, midwestern Holiday Inn. Danny, kind and patient as always, assured us there was nothing wrong with our sites and that we wouldn’t have been invited if there had been.</p>



<p>Also in attendance were a number of Google Engineers and managers, including Google’s Chief Search Scientist. Others, we were told, were watching from an undisclosed location through cameras mounted in the ceiling and ominously pointed at us, the audience, instead of Google’s assigned speakers.</p>



<p>The idea that this might be a funeral, was put forward as a half-joke by one of the shadowbanned attendees during our first Q&amp;A session, in which we asked questions and got no answers. Her funeral joke should have been funny. Only the Googlers laughed.</p>



<p>Most of these site owners seemed certain the funeral they were attending, was their own.</p>



<h3 id="h-google-sucks-us-dry-and-throws-away-the-husk"><strong>Google Sucks Us Dry And Throws Away The Husk</strong></h3>



<p>We spent the morning politely answering questions from Google, questions designed to help Google improve its search engine, questions that in no way benefited any of the shadowbanned attendees. After, we were given a chance (we thought) to get something useful out of the trip. We split into small breakout groups divided up by category.</p>



<p>We few Entertainment site owners rearranged ourselves into a corner semi-circle, and sat drinking mint lemon water from cups made of recycled Kale. We were joined by four Googlers, who began pumping us for information.&nbsp;</p>



<p>During this small group discussion, I and others tried to get our Googlers to address the biggest problem facing our industry: Google giving big brands special treatment. Each time a site owner brought up the topic, we were quickly steered in another direction.</p>



<figure><img loading="lazy" decoding="async" width="900" height="1211" src="https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/whiteboardsmall-900x1211.png" alt="" srcset="https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/whiteboardsmall-900x1211.png 900w, https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/whiteboardsmall-578x778.png 578w, https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/whiteboardsmall-768x1034.png 768w, https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/whiteboardsmall-1141x1536.png 1141w, https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/whiteboardsmall-1521x2048.png 1521w, https://www.giantfreakinrobot.com/wp-content/uploads/2024/10/whiteboardsmall-1568x2111.png 1568w" sizes="(max-width: 900px) 100vw, 900px"><figcaption>The Entertainment whiteboard after “diversity of results” was erased from the top and rewritten at the bottom in a tiny font</figcaption></figure>



<p>I kept pushing, and eventually, our Googler (whose name I’m not allowed to tell you) wrote “diversity of results” at the top of the whiteboard he was using, as if to signify I should shut up and move on. Instead of addressing the only topic that matters, I was asked to explain how <a href="https://www.giantfreakinrobot.com/topic/youtube" target="_blank" rel="noopener" title="YouTube" data-wpil-keyword-link="linked" data-wpil-monitor-id="73654">YouTube</a> works because, somehow, none of the four Googlers assigned to our group knew anything about it. </p>



<p>When our group session was over, I left the room for a break. While I was gone, “diversity of results” was erased from the top of the whiteboard and rewritten at the bottom, in much tinier lettering.</p>



<p>During the lunch break, we were fed Tofu, cold pickled chicken breasts, olive bread, and bonbons full of alcohol. Most of us didn’t eat much.</p>



<h3 id="h-google-s-head-wizard-appears"><strong>Google’s Head Wizard Appears</strong></h3>



<p>Back together as a whole group, their Chief Search Scientist arrived and made himself available to answer our questions.&nbsp;</p>



<p>While we’d been “eating” Google had its quarterly conference call, in which they talked only about the AI they were using to steal content from our sites. When questioned about the content of the call, our Googlers acted as if they barely knew AI existed, and pretended it wasn’t impacting their search results.</p>



<figure></figure>



<p>Undeterred, we then asked the only question that mattered: Why has Google shadowbanned our sites? Google’s Chief Search Scientist answered this question using a strategy based around gaslighting and said they hadn’t. Google doesn’t ever derank an entire site, only individual pages, he said. There is no site-wide classifier. He insisted it is only done at the page level.</p>



<p>Many of the shadowbanned site owners attempted to politely push back and point out that the reason all 20 of us were there was specifically because our entire site was deranked from Google in a single night.</p>



<p>He continued insisting this didn’t happen and then looked confused that anyone would disagree with him.&nbsp;</p>



<p>When asked what was wrong with our sites, as if we were jilted lovers in an abusive relationship being kicked to the curb, one Googler actually said “it’s not you it’s me”.</p>



<p>Finally, someone bluntly asked, since nothing is wrong with our sites, how do we recover?</p>



<p>Google’s elderly Chief Search Scientist answered, without an ounce of pity or concern, that there would be updates but he didn’t know when they’d happen or what they’d do.&nbsp; Further questions on the subject were met with indifference as if he didn’t understand why we cared.</p>



<p>He’d gotten the information he wanted. The conference was over. I don’t think he even said thanks.&nbsp;</p>



<p>Instead, Google’s wise wizard of search science wrapped things up with a self-congratulatory speech about what great a job we were doing at helping Google improve so he can deliver better search results to his users.&nbsp;</p>



<p>Search results without any of us in them.</p>



<p>It was then I realized this wasn’t our funeral, it was Google’s.</p>



<p>And if you have a moment, say a prayer for hard-working Danny Sullivan. Pray he won’t be left there at Google, wandering their empty and decaying coffin, all alone, haunted by angry, invisible ghosts.</p>

<!-- CONTENT END 2 -->

<!-- #comments -->                
		<hr>

									
	</div>
	<!-- Grid column -->
</article>
<!-- Grid row --></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Generative AI Scripting (169 pts)]]></title>
            <link>https://microsoft.github.io/genaiscript/</link>
            <guid>42001811</guid>
            <pubDate>Wed, 30 Oct 2024 23:39:01 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://microsoft.github.io/genaiscript/">https://microsoft.github.io/genaiscript/</a>, See on <a href="https://news.ycombinator.com/item?id=42001811">Hacker News</a></p>
<div id="readability-page-1" class="page"><div class="page">  <main data-pagefind-body="" lang="en" dir="ltr">   <div> <div> <p><img src="https://microsoft.github.io/genaiscript/_astro/logo.C7y7Xksc_ZQDjo6.svg" loading="eager" decoding="async" alt="GenAIScript logo A yellow square with genai text" width="400" height="400"></p> </div>  <div> <h2 id="prompting-is-coding">Prompting is Coding</h2>
<p>Programmatically assemble prompts for LLMs using JavaScript.</p>
<div><figure><pre data-language="js"><code><div><p><span>$</span><span>`</span><span>Analyze </span><span>${</span><span>env</span><span>.</span><span>files</span><span>}</span><span> and report errors. Use gitmojis.</span><span>`</span></p></div></code></pre></figure></div>
<p>Of course, things can get more complex…</p>
<div><figure><pre data-language="js"><code><div><p><span>// define the context</span></p></div><div><p><span>def</span><span>(</span><span>"</span><span>FILE</span><span>"</span><span>, </span><span>env</span><span>.</span><span>files</span><span>, { endsWith: </span><span>"</span><span>.pdf</span><span>"</span><span> })</span></p></div><div><p><span>// structure the data</span></p></div><div><p><span>const </span><span>schema</span><span> = </span><span>defSchema</span><span>(</span><span>"</span><span>DATA</span><span>"</span><span>, { type: </span><span>"</span><span>array</span><span>"</span><span>, items: { type: </span><span>"</span><span>string</span><span>"</span><span> } }</span><span>)</span></p></div><div><p><span>// assign the task</span></p></div><div><p><span>$</span><span>`</span><span>Analyze FILE and extract data to JSON.</span><span>`</span></p></div><div><p><span>// save results to file</span></p></div><div><p><span>defFileOutput</span><span>(</span><span>"</span><span>*.pdf.txt</span><span>"</span><span>, </span><span>"</span><span>Extracted data</span><span>"</span><span><span>, { </span><span>schema</span><span> })</span></span></p></div><div><p><span>// tools</span></p></div><div><p><span>defTool</span><span>(</span><span>"</span><span>weather</span><span>"</span><span>, </span><span>"</span><span>live weather</span><span>"</span><span>, { city: </span><span>"</span><span>Paris</span><span>"</span><span> }, </span><span>/* schema */</span></p></div><div><p><span>    </span><span>async</span><span> </span><span>(</span><span><span>{ </span><span>city</span><span> }</span></span><span>)</span><span> </span><span>=&gt;</span><span> { </span><span>...</span><span> </span><span>"</span><span>sunny</span><span>"</span><span> }) </span><span>/* callback */</span></p></div><div><p><span>// agents!</span></p></div><div><p><span>defAgent</span><span>(</span><span>"</span><span>git</span><span>"</span><span>, </span><span>"</span><span>answer git questions</span><span>"</span><span>, </span><span>"</span><span>You are a git expert.</span><span>"</span><span>, { tools: [</span><span>"</span><span>git</span><span>"</span><span>] })</span></p></div><div><p><span>...</span></p></div></code></pre></figure></div>
<h2 id="next-steps">Next steps</h2>
<div><article> <p>   <span>Listen to the podcast</span> </p> <div><p><audio controls="" loop="false" preload="metadata"> <source src="https://microsoft.github.io/genaiscript/podcasts/overview.wav" type="audio/mpeg">
Your browser does not support the audio element.
</audio> </p></div> </article> <article> <p>   <span>Install the extension</span> </p> <div><p>Install the <a href="https://microsoft.github.io/genaiscript/getting-started/installation/">Visual Studio Code
Extension</a> to get started.</p></div> </article> <article> <p>   <span>Configure your LLMs</span> </p> <p>Configure the <a href="https://microsoft.github.io/genaiscript/getting-started/configuration">secrets</a> to
access your LLMs.</p> </article> <article> <p>   <span>Write your first script</span> </p> <div><p>Follow <a href="https://microsoft.github.io/genaiscript/getting-started/your-first-genai-script/">Getting
Started</a> to write
your first script.</p></div> </article> <article> <p>   <span>Read the docs</span> </p> <div><p>Learn more about GenAIScript in the <a href="https://microsoft.github.io/genaiscript/reference/">Scripting
Reference</a>.</p></div> </article> </div> 
<p><img src="https://microsoft.github.io/genaiscript/_astro/visual-studio-code.CzkSq6ro_ZQ8RMG.webp" alt="A screenshot of VSCode with a genaiscript opened" loading="lazy" width="3072" height="1382" decoding="async"></p><h2 id="features">Features</h2>
<p>GenAIScript brings essential LLM prompt tooling into a cohesive scripting environment.</p>
<div><article> <p>   <span>Stylized JavaScript</span> </p> <div><p>Minimal syntax to build prompts using <a href="https://microsoft.github.io/genaiscript/reference/scripts/">JavaScript</a>
or <a href="https://microsoft.github.io/genaiscript/reference/scripts/typescript">TypeScript</a>.</p><div><figure><pre data-language="js"><code><div><p><span>$</span><span>`</span><span>Summarize </span><span>${</span><span>env</span><span>.</span><span>files</span><span>}</span><span>. Today is </span><span>${</span><span>new</span><span> </span><span>Date</span><span>()</span><span>}</span><span>.</span><span>`</span></p></div></code></pre></figure></div></div> </article> <article> <p>   <span>Fast Development Loop</span> </p>  </article> <article> <p>   <span>LLM Tools</span> </p> <div><p>Register JavaScript functions as <a href="https://microsoft.github.io/genaiscript/reference/scripts/tools/">LLM tools</a></p><div><figure><pre data-language="js"><code><div><p><span>defTool</span><span>(</span><span>"</span><span>weather</span><span>"</span><span>, </span><span>"</span><span>live weahter</span><span>"</span><span>,</span></p></div><div><p><span><span>    </span></span><span>{ city: </span><span>"</span><span>Paris</span><span>"</span><span> }, </span><span>// schema</span></p></div><div><p><span>    </span><span>async</span><span> </span><span>(</span><span><span>{ </span><span>city</span><span> }</span></span><span>)</span><span> </span><span>=&gt;</span><span> </span><span>// callback</span></p></div><div><p><span><span>        </span></span><span>{ </span><span>...</span><span> </span><span>"</span><span>sunny</span><span>"</span><span> }</span></p></div><div><p><span>)</span></p></div></code></pre></figure></div><p>or use built-in <a href="https://microsoft.github.io/genaiscript/guides/agentic-tools/">@agentic tools</a></p><div><figure><pre data-language="js"><code><div><p><span>import</span><span> { WeatherClient } </span><span>from</span><span> </span><span>"</span><span>@agentic/weather</span><span>"</span></p></div><div><p><span>defTool</span><span>(</span><span>new</span><span> </span><span>WeatherClient</span><span>())</span></p></div></code></pre></figure></div></div> </article> <article> <p>   <span>LLM Agents</span> </p> <div><p>Combine <a href="https://microsoft.github.io/genaiscript/reference/scripts/tools">tools</a> and <a href="https://microsoft.github.io/genaiscript/reference/scripts/inline-prompts/">inline prompts</a>
into an <a href="https://microsoft.github.io/genaiscript/reference/scripts/agents">agent</a>.</p><div><figure><pre data-language="js"><code><div><p><span>defAgent</span><span>(</span></p></div><div><p><span>    </span><span>"</span><span>git</span><span>"</span><span>,</span></p></div><div><p><span>    </span><span>"</span><span>Agent that answer git questions for the current repo</span><span>"</span><span>,</span></p></div><div><p><span>    </span><span>"</span><span>You are a helpful expert in using git.</span><span>"</span><span>,</span></p></div><div><p><span><span>    </span></span><span>{ tools: [</span><span>"</span><span>git</span><span>"</span><span>] }</span></p></div><div><p><span>)</span></p></div></code></pre></figure></div><div><figure><pre data-language="js"><code><div><p><span>script</span><span>({ tools: </span><span>"</span><span>agent</span><span>"</span><span> })</span></p></div><div><p><span>$</span><span>`</span><span>Do a statistical analysis of the last commits</span><span>`</span></p></div></code></pre></figure></div></div> </article> <article> <p>   <span>Reuse and Share Scripts</span> </p> <div><p>Scripts are <a href="https://microsoft.github.io/genaiscript/reference/scripts/">files</a>! They can be versioned, shared, forked, …</p><starlight-file-tree data-pagefind-ignore=""><ul><li><details open=""><summary><span><span><span><span>Directory</span></span>genaisrc
</span></span></summary><ul><li><span><span><span></span>my-script.genai.mjs</span></span></li><li><span><span><span></span>another-great-script.genai.mjs</span></span></li></ul></details></li></ul></starlight-file-tree> </div> </article> <article> <p>   <span>Data Schemas</span> </p> <div><p>Define, validate, repair data using <a href="https://microsoft.github.io/genaiscript/reference/scripts/schemas">schemas</a>.</p><div><figure><pre data-language="js"><code><div><p><span>const </span><span>data</span><span> = </span><span>defSchema</span><span>(</span><span>"</span><span>MY_DATA</span><span>"</span><span>,</span></p></div><div><p><span><span>    </span></span><span>{ type: </span><span>"</span><span>array</span><span>"</span><span>, items: { </span><span>...</span><span> }, }</span><span>)</span></p></div><div><p><span>$</span><span>`</span><span>Extract data from files using </span><span>${</span><span>data</span><span>}</span><span> schema.</span><span>`</span></p></div></code></pre></figure></div></div> </article> <article> <p>   <span>Ingest text from PDFs, DOCX, ...</span> </p> <div><p>Manipulate
<a href="https://microsoft.github.io/genaiscript/reference/scripts/pdf">PDFs</a>,
<a href="https://microsoft.github.io/genaiscript/reference/scripts/docx">DOCX</a>,
…</p><div><figure><pre data-language="js"><code><div><p><span>// automatically convert to text</span></p></div><div><p><span>def</span><span>(</span><span>"</span><span>PDF</span><span>"</span><span>, </span><span>env</span><span>.</span><span>files</span><span>, { endsWith: </span><span>"</span><span>.pdf</span><span>"</span><span> })</span></p></div><div><p><span>// or parse and process</span></p></div><div><p><span>const { </span><span>pages</span><span> } = await </span><span>parsers</span><span>.</span><span>PDF</span><span>(</span><span>env</span><span>.</span><span>files</span><span>[</span><span>0</span><span>])</span></p></div></code></pre></figure></div></div> </article> <article> <p>   <span>Ingest tables from CSV, XLSX, ..</span> </p> <div><p>Manipulate tabular data from
<a href="https://microsoft.github.io/genaiscript/reference/scripts/csv">CSV</a>,
<a href="https://microsoft.github.io/genaiscript/reference/scripts/xlsx">XLSX</a>,
…</p><div><figure><pre data-language="js"><code><div><p><span>// automatically convert to text</span></p></div><div><p><span>def</span><span>(</span><span>"</span><span>DATA</span><span>"</span><span>, </span><span>env</span><span>.</span><span>files</span><span>, {</span></p></div><div><p><span><span>    </span></span><span>endsWith: </span><span>"</span><span>.csv</span><span>"</span><span>,</span></p></div><div><p><span>    </span><span>// take top 100 rows</span></p></div><div><p><span><span>    </span></span><span>sliceHead: </span><span>100</span><span>,</span></p></div><div><p><span>})</span></p></div><div><p><span>// or parse to JavaScript object array</span></p></div><div><p><span>const </span><span>rows</span><span> = await </span><span>parsers</span><span>.</span><span>CSV</span><span>(</span><span>env</span><span>.</span><span>files</span><span>[</span><span>0</span><span>])</span></p></div><div><p><span>// render as markdown table</span></p></div><div><p><span>defData</span><span>(</span><span>"</span><span>ROWS</span><span>"</span><span><span>, </span><span>rows</span><span>, { sliceHead: </span></span><span>100</span><span> })</span></p></div></code></pre></figure></div></div> </article> <article> <p>   <span>Generate Files</span> </p> <div><p>Extract files and diff from the LLM output.
Preview changes in Refactoring UI.</p><div><figure><pre data-language="js"><code><div><p><span>$</span><span>`</span><span>Save the result in poem.txt.</span><span>`</span></p></div></code></pre></figure></div><div><figure><pre data-language="txt"><code><div><p><span>FILE ./poem.txt</span></p></div><div><p><span>```txt</span></p></div><div><p><span>The quick brown fox jumps over the lazy dog.</span></p></div><div><p><span>```</span></p></div></code></pre></figure></div><starlight-file-tree data-pagefind-ignore=""><ul><li><span><span><span></span>poem.txt</span> </span></li></ul></starlight-file-tree> </div> </article> <article> <p>   <span>File search</span> </p> <div><p>Grep or fuzz search <a href="https://microsoft.github.io/genaiscript/referen/script/files">files</a></p><div><figure><pre data-language="js"><code><div><p><span>const { </span><span>files</span><span> } = await </span><span>workspace</span><span>.</span><span>grep</span><span>(</span><span>/</span><span>[a-z][a-z0-9]</span><span>+</span><span>/</span><span>, { globs: </span><span>"</span><span>*.md</span><span>"</span><span> }</span><span>)</span></p></div></code></pre></figure></div></div> </article> <article> <p>   <span>Browser automation</span> </p> <div><p>Browse and scrape the web with <a href="https://microsoft.github.io/genaiscript/reference/scripts/browse">Playwright</a>.</p><div><figure><pre data-language="js"><code><div><p><span>const </span><span>page</span><span> = await </span><span>host</span><span>.</span><span>browse</span><span>(</span><span>"</span><span>https://...</span><span>"</span><span>)</span></p></div><div><p><span>const </span><span>table</span><span> = await </span><span>page</span><span>.</span><span>locator</span><span>(</span><span>"</span><span>table[...]</span><span>"</span><span>)</span><span>.</span><span>innerHTML</span><span>()</span></p></div><div><p><span>def</span><span>(</span><span>"</span><span>TABLE</span><span>"</span><span>, </span><span>await</span><span> </span><span>HTML</span><span>.</span><span>convertToMarkdown</span><span><span>(</span><span>table</span><span>))</span></span></p></div></code></pre></figure></div></div> </article> <article> <p>   <span>RAG built-in</span> </p> <div><p><a href="https://microsoft.github.io/genaiscript/reference/scripts/vector-search/">Vector search</a>.</p><div><figure><pre data-language="js"><code><div><p><span>const { </span><span>files</span><span> } = await </span><span>retrieval</span><span>.</span><span>vectorSearch</span><span>(</span><span>"</span><span>cats</span><span>"</span><span>, </span><span>"</span><span>**/*.md</span><span>"</span><span>)</span></p></div></code></pre></figure></div></div> </article> <article> <p>   <span>GitHub Models and GitHub Copilot</span> </p> <div><p>Run models through GitHub using <a href="https://microsoft.github.io/getting-started/configuration/#github-models">GitHub Models</a>
or <a href="https://microsoft.github.io/getting-started/configuration/#github-copilot-in-visual-studio-code">GitHub Copilot</a>.</p><div><figure><pre data-language="js"><code><div><p><span>script</span><span>({ </span><span>...</span><span>, model: </span><span>"</span><span>github:gpt-4o</span><span>"</span><span> })</span></p></div></code></pre></figure></div></div> </article> <article> <p>   <span>Local Models</span> </p> <div><p>Run your scripts with <a href="https://microsoft.github.io/genaiscript/getting-started/configuration/#local-models">Open Source models</a>,
like <a href="https://azure.microsoft.com/en-us/blog/introducing-phi-3-redefining-whats-possible-with-slms/">Phi-3</a>,
using <a href="https://ollama.com/">Ollama</a>, <a href="https://localai.io/">LocalAI</a>…</p><div><figure><pre data-language="js"><code><div><p><span>script</span><span>({ </span><span>...</span><span>, model: </span><span>"</span><span>ollama:phi3</span><span>"</span><span> })</span></p></div></code></pre></figure></div></div> </article> <article> <p>   <span>Code Interpreter</span> </p> <div><p>Let the LLM run code in a sandboxed execution environment.</p><div><figure><pre data-language="js"><code><div><p><span>script</span><span>({ tools: [</span><span>"</span><span>python_code_interpreter</span><span>"</span><span>] })</span></p></div></code></pre></figure></div></div> </article> <article> <p>   <span>Containers</span> </p> <div><p>Run code in Docker <a href="https://microsoft.github.io/genaiscript/reference/scripts/containers">containers</a>.</p><div><figure><pre data-language="js"><code><div><p><span>const </span><span>c</span><span> = await </span><span>host</span><span>.</span><span>container</span><span>(</span><span>{</span></p></div><div><p><span><span>    </span></span><span>image: </span><span>"</span><span>python:alpine</span><span>"</span><span>,</span></p></div><div><p><span>}</span><span>)</span></p></div><div><p><span>const </span><span>res</span><span> = await </span><span>c</span><span>.</span><span>exec</span><span>(</span><span>"</span><span>python --version</span><span>"</span><span>)</span></p></div></code></pre></figure></div></div> </article> <article> <p>   <span>LLM Composition</span> </p> <div><p><a href="https://microsoft.github.io/genaiscript/reference/scripts/inline-prompts/">Run LLMs</a> to build your LLM prompts.</p><div><figure><pre data-language="js"><code><div><p><span>// summarize each files individually</span></p></div><div><p><span>for</span><span> (</span><span>const </span><span>file</span><span> </span><span>of</span><span> </span><span>env</span><span>.</span><span>files</span><span>) {</span></p></div><div><p><span>    </span><span>const { </span><span>text</span><span> } = await </span><span>runPrompt</span><span>(</span><span>(</span><span>_</span><span>)</span><span> =&gt; {</span></p></div><div><p><span>        </span><span>_</span><span>.</span><span>def</span><span>(</span><span>"</span><span>FILE</span><span>"</span><span>, </span><span><span>file</span><span>)</span></span></p></div><div><p><span>        </span><span>_</span><span>.</span><span>$</span><span>`</span><span>Summarize the FILE.</span><span>`</span></p></div><div><p><span><span>    </span></span><span>}</span><span>)</span></p></div><div><p><span>    </span><span>// use result in main prompt</span></p></div><div><p><span>    </span><span>def</span><span>(</span><span>"</span><span>SUMMARY</span><span>"</span><span><span>, </span><span>text</span><span>)</span></span></p></div><div><p><span>}</span></p></div><div><p><span>// use summary</span></p></div><div><p><span>$</span><span>`</span><span>Summarize all the summaries.</span><span>`</span></p></div></code></pre></figure></div></div> </article> <article> <p>  <span>Prompty</span> </p> <div><p>Run or convert <a href="https://prompty.ai/">Prompty</a> files using GenAIScript.</p><div><figure><pre data-language="markdown"><code><div><p><span>---</span></p></div><div><p><span>name</span><span>: </span><span>poem</span></p></div><div><p><span>---</span></p></div><div><p><span>Write a short poem.</span></p></div></code></pre></figure></div></div> </article> <article> <p>   <span>Automate with CLI</span> </p> <div><p>Automate using the <a href="https://microsoft.github.io/genaiscript/reference/cli">CLI</a>,
integrate reports in your CI/CD pipeline.</p><div><figure><pre data-language="bash"><code><div><p><span>npx</span><span> </span><span>genaiscript</span><span> </span><span>run</span><span> </span><span>tlaplus-linter</span><span> </span><span>"</span><span>*.tla</span><span>"</span></p></div></code></pre></figure></div></div> </article> <article> <p>   <span>Pull Request Reviews</span> </p> <div><p>Integrate into your <a href="https://microsoft.github.io/genaiscript/reference/cli/run/#pull-requests">Pull Requests checks</a> through comments,
reviews or description updates. Supports GitHub Actions and Azure DevOps pipelines.</p><div><figure><pre data-language="bash"><code><div><p><span>npx</span><span> </span><span>genaiscript</span><span> </span><span>...</span><span> </span><mark><span>--pull-request-reviews</span></mark></p></div></code></pre></figure></div></div> </article> <article> <p>   <span>Tests and Evals</span> </p> <div><p>Build reliable prompts using <a href="https://microsoft.github.io/genaiscript/reference/scripts/tests">tests and evals</a>
powered by <a href="https://promptfoo.dev/">promptfoo</a>.</p><div><figure><pre data-language="js"><code><div><p><span>script</span><span>({ </span><span>...</span><span>, tests: {</span></p></div><div><p><span><span>  </span></span><span>files: </span><span>"</span><span>penguins.csv</span><span>"</span><span>,</span></p></div><div><p><span><span>  </span></span><span>rubric: </span><span>"</span><span>is a data analysis report</span><span>"</span><span>,</span></p></div><div><p><span><span>  </span></span><span>facts: </span><span>"</span><span>The data refers about penguin population in Antartica.</span><span>"</span><span>,</span></p></div><div><p><span>}})</span></p></div></code></pre></figure></div><p><img src="https://microsoft.github.io/genaiscript/_astro/vscode-test-explorer.DHobrdnh_1FDdux.webp" alt="Visual Studio Test Explorer opened with a few genaiscript tests." loading="lazy" width="815" height="451" decoding="async"></p></div> </article> </div> 
<h2 id="case-studies">Case Studies</h2>
<p>Tales from the real world using GenAIScript.</p>
<div><div> <p><span> <a href="https://microsoft.github.io/genaiscript/case-studies/bicep-best-practices"> <span>Bicep Best Practices</span> </a> <span>Learn how to apply best practices to Azure Bicep files for more efficient and maintainable infrastructure as code.</span> </span></p>  </div> <div> <p><span> <a href="https://microsoft.github.io/genaiscript/case-studies/seo-frontmatter"> <span>SEO Front Matter</span> </a> <span>Learn how to automate the creation of SEO-optimized front matter for your markdown documents with GenAIScript.</span> </span></p>  </div> <div> <p><span> <a href="https://microsoft.github.io/genaiscript/case-studies/documentation-translations"> <span>Documentation Translations</span> </a> <span>Explore the challenges and solutions for localizing MakeCode documentation with custom macros while maintaining rich rendering in multiple languages.</span> </span></p>  </div> <div> <p><span> <a href="https://microsoft.github.io/genaiscript/case-studies/blocks-localization"> <span>Blocks Localization</span> </a> <span>Learn how to localize MakeCode programming blocks while preserving block properties and variable names for international audiences.</span> </span></p>  </div> <div> <p><span> <a href="https://microsoft.github.io/genaiscript/case-studies/release-notes"> <span>Release Notes</span> </a> <span>Generate comprehensive release notes combining commit history and code diffs</span> </span></p>  </div> <div> <p><span> <a href="https://microsoft.github.io/genaiscript/case-studies/tla-ai-linter"> <span>TLA+ AI Linter</span> </a> <span>Explore how the TLA+ AI Linter leverages GenAI scripts and LLMs to enhance TLA+ specifications with automated linting and consistent comment verification.</span> </span></p>  </div> <div> <p><span> <a href="https://microsoft.github.io/genaiscript/case-studies/image-alt-text"> <span>Image Alt Text</span> </a> <span>Learn how to automatically generate descriptive alt text for images using OpenAI Vision model to enhance accessibility and SEO.</span> </span></p>  </div> </div> 
<h2 id="samples">Samples</h2>
<p>Fully fledged scripts ready to use.</p>
 
<h2 id="guides">Guides</h2>
<p>A cookbook full of recipes to make you a genius scripter.</p>
<div><div> <p><span> <a href="https://microsoft.github.io/genaiscript/guides/prompt-as-code"> <span>Prompt As Code</span> </a> <span>Tutorial on using GenAIScript runtime and syntax to assemble prompts</span> </span></p>  </div> <div> <p><span> <a href="https://microsoft.github.io/genaiscript/guides/sharing-scripts"> <span>Sharing scripts</span> </a> <span>Learn how to share GenAIScript scripts across projects using Git repositories, submodules, and GitHub Gists.</span> </span></p>  </div> <div> <p><span> <a href="https://microsoft.github.io/genaiscript/guides/ask-my-pdf"> <span>Ask My PDF</span> </a> <span>Quick-start guide to using GenAIScript for summarizing and critiquing PDF documents with AI assistance.</span> </span></p>  </div> <div> <p><span> <a href="https://microsoft.github.io/genaiscript/guides/ask-my-image"> <span>Ask My Image</span> </a> <span>Learn how to apply GenAIScript to images for data extraction and analysis using AI models.</span> </span></p>  </div>  <div> <p><span> <a href="https://microsoft.github.io/genaiscript/guides/present-my-code"> <span>Present My Code</span> </a> <span>Step-by-step instructions on presenting code effectively using GenAIScript and creating engaging slides.</span> </span></p>  </div> <div> <p><span> <a href="https://microsoft.github.io/genaiscript/guides/search-and-fetch"> <span>Search and Fetch</span> </a> <span>Learn how to leverage web search and fetching pages in GenAIScript</span> </span></p>  </div> <div> <p><span> <a href="https://microsoft.github.io/genaiscript/guides/tool-agent"> <span>Tool Agent</span> </a> <span>Learn how to define a built-in agent using functions for decision-making and reasoning in arithmetic operations.</span> </span></p>  </div>  <div> <p><span> <a href="https://microsoft.github.io/genaiscript/guides/containerized-tools"> <span>Containerized Tools</span> </a> <span>Learn how to create and use containerized tools with executable dependencies in a secure environment using GCC as an example.</span> </span></p>  </div> <div> <p><span> <a href="https://microsoft.github.io/genaiscript/guides/generated-knowledge"> <span>Generated Knowledge</span> </a> <span>Explore the technique of generated knowledge in AI prompting to enhance accuracy in answering questions.</span> </span></p>  </div> <div> <p><span> <a href="https://microsoft.github.io/genaiscript/guides/phi3-with-ollama"> <span>Phi-3 Mini with Ollama</span> </a> <span>Learn how to integrate Phi-3 Mini, a powerful 3.8B parameter model by Microsoft, with Ollama for local execution of state-of-the-art AI models.</span> </span></p>  </div>    <div> <p><span> <a href="https://microsoft.github.io/genaiscript/guides/llm-agents"> <span>LLM Agents</span> </a> <span>Learn how to use the inline prompts to create a LLM agent.</span> </span></p>  </div> <div> <p><span> <a href="https://microsoft.github.io/genaiscript/guides/pull-request-reviewer"> <span>Pull Request Reviewer</span> </a> <span>Learn how to automate pull request reviews with a GenAIScript that provides feedback and code analysis in GitHub Actions.</span> </span></p>  </div>  <div> <p><span> <a href="https://microsoft.github.io/genaiscript/guides/transformers-js"> <span>Transformer.js</span> </a> <span>Implement summarization with Transformers.js and leverage local hardware acceleration</span> </span></p>  </div> <div> <p><span> <a href="https://microsoft.github.io/genaiscript/guides/using-secrets"> <span>Using Secrets</span> </a> <span>Utilize secrets to augment documents with TypeScript and REST APIs</span> </span></p>  </div>  <div> <p><span> <a href="https://microsoft.github.io/genaiscript/guides/llm-as-tool"> <span>LLM as a tool</span> </a> <span>Create tools and inline prompts using LLM models for executing various tasks</span> </span></p>  </div> <div> <p><span> <a href="https://microsoft.github.io/genaiscript/guides/zod-schema"> <span>Zod Schema</span> </a> <span>Learn how to define and convert TypeScript-first Zod schemas to JSON schema</span> </span></p>  </div> </div> 
<h2 id="agents">Agents</h2>
<h3 id="builtin-agents">Builtin Agents</h3>
 
<div> <p><span> <a href="https://microsoft.github.io/genaiscript/reference/scripts/system#systemagent_fs"> <span>agent fs</span> </a> <span>query files to accomplish tasks</span> </span></p>  </div> 
<div> <p><span> <a href="https://microsoft.github.io/genaiscript/reference/scripts/system#systemagent_git"> <span>agent git</span> </a> <span>query a repository using Git to accomplish tasks. Provide all the context information available to execute git queries.</span> </span></p>  </div> 
 
<div> <p><span> <a href="https://microsoft.github.io/genaiscript/reference/scripts/system#systemagent_interpreter"> <span>agent interpreter</span> </a> <span>run code interpreters for Python, Math. Use this agent to ground computation questions.</span> </span></p>  </div> 
<div> <p><span> <a href="https://microsoft.github.io/genaiscript/reference/scripts/system#systemagent_memory"> <span>agent memory</span> </a> <span>queries the memories created by other agent conversations.</span> </span></p>  </div> 
<div> <p><span> <a href="https://microsoft.github.io/genaiscript/reference/scripts/system#systemagent_user_input"> <span>agent user_input</span> </a> <span>ask user for input to confirm, select or answer the question in the query. The message should be very clear and provide all the context.</span> </span></p>  </div> 
<h2 id="llm-friendly-docs">LLM friendly docs</h2>
<p>If you are an LLM crawler, fetch <a href="https://microsoft.github.io/genaiscript/.well-known/llms.txt">https://microsoft.github.io/genaiscript/.well-known/llms.txt</a> for an documentation map
or add the <code dir="auto">.md</code> suffix to any documentation URLs to get a raw markdown content.</p>
<p>For example, <a href="https://microsoft.github.io/genaiscript/guides/prompt-as-code.md">https://microsoft.github.io/genaiscript/guides/prompt-as-code.md</a> (note the .md extension)</p>  </div>   </div>  </main> </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[It might be possible to detect gravitons after all (155 pts)]]></title>
            <link>https://www.quantamagazine.org/it-might-be-possible-to-detect-gravitons-after-all-20241030/</link>
            <guid>42001642</guid>
            <pubDate>Wed, 30 Oct 2024 23:19:19 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.quantamagazine.org/it-might-be-possible-to-detect-gravitons-after-all-20241030/">https://www.quantamagazine.org/it-might-be-possible-to-detect-gravitons-after-all-20241030/</a>, See on <a href="https://news.ycombinator.com/item?id=42001642">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="postBody">
                <div>
        <p>
            A new experimental proposal suggests detecting a particle of gravity is far easier than anyone imagined. Now physicists are debating what it would really prove.
        </p>
        
    </div>
    <figure>
        <div>
                            <p><img width="2560" height="1440" src="https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting-Gravitons_crSenor-Salme-Lede-scaled.webp" alt="An illustration of concentric rings of a radiating wave in space, with chopsticks that appear poised to pluck a particle out of the wave." decoding="async" loading="lazy" srcset="https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting-Gravitons_crSenor-Salme-Lede-scaled.webp 2560w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting-Gravitons_crSenor-Salme-Lede-1720x968.webp 1720w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting-Gravitons_crSenor-Salme-Lede-520x293.webp 520w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting-Gravitons_crSenor-Salme-Lede-768x432.webp 768w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting-Gravitons_crSenor-Salme-Lede-1536x864.webp 1536w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting-Gravitons_crSenor-Salme-Lede-2048x1152.webp 2048w" sizes="(max-width: 2560px) 100vw, 2560px">                </p>
                        </div>
        <figcaption>
    <div>
                            <p>Capturing a graviton would be akin to noticing just one molecule in an ocean wave.</p>
            <p>Señor Salme for <em>Quanta Magazine</em></p>
        </div>
</figcaption>
    </figure>
<div>
            <h2>Introduction</h2>
            <div data-role="selectable">
    <p>Detecting a graviton — the hypothetical particle thought to carry the force of gravity — is the ultimate physics experiment. Conventional wisdom, however, says it can’t be done. According to one infamous estimate, an Earth-size apparatus orbiting the sun might pick up one graviton every billion years. To snag one in a decade, another <a href="https://arxiv.org/abs/gr-qc/0601043">calculation</a> has suggested, you’d have to park a Jupiter-size machine next to a neutron star. In short: not going to happen.</p>
<p>A new proposal overturns the conventional wisdom. Blending a modern understanding of ripples in space-time known as gravitational waves with developments in quantum technology, a group of physicists has devised a new way of detecting a graviton — or at least a quantum event closely associated with a graviton. The experiment would still be a herculean undertaking, but it could fit into the space of a modest laboratory and the span of a career.</p>
<p>“It’s something that can be reached in a few years of research,” said <a href="https://brancoweissfellowship.org/fellow/fadel/">Matteo Fadel</a>, an experimentalist at the Swiss Federal Institute of Technology Zurich (ETH Zurich) who was not involved in the proposal.</p>
<p>“It’s a very original proposal and well thought-out,” said <a href="https://physics.mit.edu/faculty/frank-wilczek/">Frank Wilczek</a>, a Nobel Prize-winning physicist at the Massachusetts Institute of Technology with a long-running interest in graviton detection. “It would be real progress in the field.”</p>
<p>Currently, Albert Einstein’s general theory of relativity attributes gravity to smooth curves in the space-time fabric. But a conclusive graviton detection would prove that gravity comes in the form of quantum particles, just like electromagnetism and the other fundamental forces. Most physicists believe that gravity does have a quantum side, and they’ve spent the better part of a century striving to determine its quantum rules. Nabbing a graviton would confirm that they’re on the right track.</p>
<p>But even if the experiment is relatively straightforward, the interpretation of what, exactly, a detection would prove is not. The simplest explanation of a positive result would be the existence of gravitons. But physicists have already found ways to interpret such a result without reference to gravitons at all.</p>
</div>
    </div>
    <figure>
        <div>
                            <p><img width="2560" height="1575" src="https://www.quantamagazine.org/wp-content/uploads/2024/10/Einstein-1920-University-of-Berlin_crETH-Archive-via-Wikimedia-Commons-edit-tint4-scaled.webp" alt="Black-and-white blue tinted photo of Albert Einstein sitting at his desk looking serious in a three-piece suit." decoding="async" loading="lazy" srcset="https://www.quantamagazine.org/wp-content/uploads/2024/10/Einstein-1920-University-of-Berlin_crETH-Archive-via-Wikimedia-Commons-edit-tint4-scaled.webp 2560w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Einstein-1920-University-of-Berlin_crETH-Archive-via-Wikimedia-Commons-edit-tint4-1720x1058.webp 1720w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Einstein-1920-University-of-Berlin_crETH-Archive-via-Wikimedia-Commons-edit-tint4-520x320.webp 520w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Einstein-1920-University-of-Berlin_crETH-Archive-via-Wikimedia-Commons-edit-tint4-768x473.webp 768w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Einstein-1920-University-of-Berlin_crETH-Archive-via-Wikimedia-Commons-edit-tint4-1536x945.webp 1536w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Einstein-1920-University-of-Berlin_crETH-Archive-via-Wikimedia-Commons-edit-tint4-2048x1260.webp 2048w" sizes="(max-width: 2560px) 100vw, 2560px">                </p>
                        </div>
        <figcaption>
    <div>
                            <p>Albert Einstein published the current theory of gravity, called general relativity, in 1915, a few years before this photo was taken in his office at the University of Berlin.</p>
            <p>ETH Zurich University Archive</p>
        </div>
</figcaption>
    </figure>
<div data-role="selectable">
    <p>The discussion recalls a messy, largely forgotten episode from the dawn of the quantum era. In 1905, Einstein interpreted experimental data to mean that light is “quantized,” coming in discrete particles now called photons. Others, including Niels Bohr and Max Planck, thought that the classical, wave nature of light might still be saved. It would take seven decades for physicists to undeniably establish that light is quantized, largely because of the subtle nature of quantumness.</p>
<p>Most physicists presume that everything in the world is quantized, including gravity. But proving that assumption will entail a new war, one that has only just begun.&nbsp;&nbsp;<strong>&nbsp;</strong></p>
<h2><strong><span>Clicks From Gravity</span></strong></h2>
<p>It’s hard to experimentally probe gravity because the force is extremely weak. You need huge masses — think planets — to significantly warp space-time and generate obvious gravitational attraction. By way of comparison, a credit card-size magnet will stick to your fridge. Electromagnetism is not a subtle force.</p>
<p>One way to study these forces is to disturb an object, then observe the ripples that travel outward as a consequence. Shake a charged particle, and it will create waves of light. Disturb a massive object, and it will emit gravitational waves. We pick up light waves with our eyeballs, but gravitational waves are another matter. It took decades of effort and the construction of the colossal, miles-long detectors that make up the Laser Interferometer Gravitational-Wave Observatory (LIGO) to first sense a rumble in space-time in 2015 — one sent out by a collision between distant black holes.</p>
<p>Detecting a single graviton would be harder still, akin to noticing the effect of just one molecule in an ocean wave. How hard would it be? In a lecture in 2012, the eminent physicist <a href="https://www.quantamagazine.org/a-math-puzzle-worthy-of-freeman-dyson-20140326/">Freeman Dyson</a> <a href="https://publications.ias.edu/sites/default/files/poincare2012.pdf">considered</a> gravitational waves from the sun, where the violent churning of matter inside the star should constantly send out mild tremors in space-time. Occasionally, one of the gravitons in these ripples would strike an atom in a detector and kick an electron into a higher energy level. Dyson calculated that in a detector as large as Earth, running for the 5-billion-year lifetime of the sun, such an effect might be seen just four times.</p>
</div>
    <figure>
        <div>
                            <p><img width="2560" height="1774" src="https://www.quantamagazine.org/wp-content/uploads/2024/10/Dyson_Freeman_Dyson_20151016_DKomoda-5367-edit-scaled.webp" alt="Portrait of a smiling man with gray hair in a tie and wool suit jacket." decoding="async" loading="lazy" srcset="https://www.quantamagazine.org/wp-content/uploads/2024/10/Dyson_Freeman_Dyson_20151016_DKomoda-5367-edit-scaled.webp 2560w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Dyson_Freeman_Dyson_20151016_DKomoda-5367-edit-1720x1192.webp 1720w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Dyson_Freeman_Dyson_20151016_DKomoda-5367-edit-520x360.webp 520w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Dyson_Freeman_Dyson_20151016_DKomoda-5367-edit-768x532.webp 768w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Dyson_Freeman_Dyson_20151016_DKomoda-5367-edit-1536x1065.webp 1536w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Dyson_Freeman_Dyson_20151016_DKomoda-5367-edit-2048x1420.webp 2048w" sizes="(max-width: 2560px) 100vw, 2560px">                </p>
                        </div>
        <figcaption>
    <div>
                            <p>A calculation by the late physicist Freeman Dyson, pictured in his office at the Institute for Advanced Study, suggested that individual gravitons will never be detected.</p>
            <p>D. Komoda</p>
        </div>
</figcaption>
    </figure>
<div data-role="selectable">
    <p>In the dozen years since Dyson’s remarks, two experimental developments have made the situation less dire. First, LIGO began detecting gravitational waves regularly from black hole collisions, and occasionally from colliding neutron stars. These events shake space-time far more intensely than the sun’s internal agitation does — providing a deluge of gravitons as opposed to Dyson’s trickle. And second, experimentalists have grown more capable of eliciting and measuring quantum phenomena.</p>
<p><a href="https://web.stevens.edu/pikovski/index.html">Igor Pikovski</a>, a theoretical physicist now at the Stevens Institute of Technology in New Jersey, has been mulling over these developments since 2016. At the time, he and three collaborators noted that a vat of superfluid helium — which displays quantum properties despite having a large mass — could be <a href="https://arxiv.org/abs/1606.04980">set up to reverberate</a> in response to certain gravitational waves.</p>

<p>It would take another conceptual leap to go from a gravitational wave detector to a detector for individual gravitons. In the recent paper, which appeared in <a href="https://www.nature.com/articles/s41467-024-51420-8"><em>Nature Communications</em></a> in August, Pikovski and his co-authors outlined how the graviton detector would work.</p>
<p>First, take a 15-kilogram bar of beryllium (or some similar material) and cool it almost all the way to absolute zero, the minimum possible temperature. Sapped of all heat, the bar will sit in its minimum-energy “ground” state. All the atoms of the bar will act together as one quantum system, akin to one hulking atom.</p>
<p>Then, wait until a gravitational wave from deep space passes by. The odds that any particular graviton will interact with the beryllium bar are low, but the wave will contain so many gravitons that the overall odds of at least one interaction are high. The group calculated that approximately one in three gravitational waves of the right sort (neutron star collisions work best since their mergers last longer than black hole mergers) would make the bar ring with one quantum unit of energy. If your bar reverberates in concert with a gravitational wave confirmed by LIGO, you will have witnessed a quantized event caused by gravity.</p>
</div>
    <figure>
        <div>
                            <p><img width="941" height="2560" src="https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting_Gravitons-crMarkBelan-Mobile-v2-scaled.jpg" alt="Graphic describing how physicists detect gravitons" decoding="async" loading="lazy" srcset="https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting_Gravitons-crMarkBelan-Mobile-v2-scaled.jpg 941w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting_Gravitons-crMarkBelan-Mobile-v2-632x1720.jpg 632w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting_Gravitons-crMarkBelan-Mobile-v2-1059x2880.jpg 1059w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting_Gravitons-crMarkBelan-Mobile-v2-191x520.jpg 191w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting_Gravitons-crMarkBelan-Mobile-v2-768x2089.jpg 768w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting_Gravitons-crMarkBelan-Mobile-v2-565x1536.jpg 565w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting_Gravitons-crMarkBelan-Mobile-v2-753x2048.jpg 753w" sizes="(max-width: 941px) 100vw, 941px"><img width="1120" height="2412" src="https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting_Gravitons-crMarkBelan-Desktop-v2.jpg" alt="Graphic describing how physicists detect gravitons" decoding="async" loading="lazy" srcset="https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting_Gravitons-crMarkBelan-Desktop-v2.jpg 1120w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting_Gravitons-crMarkBelan-Desktop-v2-799x1720.jpg 799w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting_Gravitons-crMarkBelan-Desktop-v2-241x520.jpg 241w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting_Gravitons-crMarkBelan-Desktop-v2-768x1654.jpg 768w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting_Gravitons-crMarkBelan-Desktop-v2-713x1536.jpg 713w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Detecting_Gravitons-crMarkBelan-Desktop-v2-951x2048.jpg 951w" sizes="(max-width: 1120px) 100vw, 1120px">                </p>
                        </div>
        <figcaption>
    <div>
            <p>Mark Belan/ <em>Quanta Magazine</em></p>
        </div>
</figcaption>
    </figure>
<div data-role="selectable">
    <p>“It would be our first window into where quantum gravity matters,” Pikovski said.</p>
<p>Among a handful of engineering hurdles involved in opening that window, the highest would be putting a heavy object into its ground state and sensing it jumping to its next-lowest-energy state. One of the groups pushing the state of the art on this front is at ETH Zurich, where Fadel and his collaborators cool tiny sapphire crystals until they display quantum properties. In 2023, the team succeeded in putting a crystal into <a href="https://www.science.org/doi/abs/10.1126/science.adf7553">two states simultaneously</a> — another hallmark of a quantum system. Its mass was 16 millionths of a gram — heavy for a quantum object, but still half a billion times lighter than Pikovski’s bar. Nevertheless, Fadel considers the proposal to be achievable. “It wouldn’t be too crazy,” he said.</p>
<p>Pikovski’s experiment — like Dyson’s — emulates the very experiment that prompted Einstein to propose in 1905 that light is quantized, a watershed moment in the history of quantum mechanics. “If carried through, it would bring the state of the art in the case for gravitons to the same level that it was for photons in 1905,” Wilczek said.</p>
</div>
    <figure>
        <div>
                            <p><img width="2000" height="1333" src="https://www.quantamagazine.org/wp-content/uploads/2024/10/Igor-Pikovski-2_crIan-Reitz-edit.webp" alt="A young man in plastic-frame glasses works at a blackboard, speaking to someone who is out of focus in the foreground." decoding="async" loading="lazy" srcset="https://www.quantamagazine.org/wp-content/uploads/2024/10/Igor-Pikovski-2_crIan-Reitz-edit.webp 2000w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Igor-Pikovski-2_crIan-Reitz-edit-1720x1146.webp 1720w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Igor-Pikovski-2_crIan-Reitz-edit-520x347.webp 520w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Igor-Pikovski-2_crIan-Reitz-edit-768x512.webp 768w, https://www.quantamagazine.org/wp-content/uploads/2024/10/Igor-Pikovski-2_crIan-Reitz-edit-1536x1024.webp 1536w" sizes="(max-width: 2000px) 100vw, 2000px">                </p>
                        </div>
        <figcaption>
    <div>
                            <p>Igor Pikovski, a physicist at the Stevens Institute of Technology, has proposed a way to detect a quantized response to a gravitational wave.</p>
            <p>Ian Reitz</p>
        </div>
</figcaption>
    </figure>
<div data-role="selectable">
    <p>Textbooks often credit Einstein’s paper with establishing the photon’s existence. But the real story is far more interesting. At the time, many physicists rejected Einstein’s theory. Some wouldn’t come around for two decades. In their view, the experiment fell far short of conclusive proof. It was, rather, an opening argument in a decades-long war fought to determine the true nature of light.</p>
<h2><strong><span>The Real Story of the Photon</span></strong></h2>
<p>Physicists saw the first cracks opening up in their classical understanding of reality in the closing years of the 19th century. J.J. Thomson discovered that electric currents come in discrete chunks of charge called electrons. Meanwhile, physicists were puzzling over a string of experiments by Heinrich Hertz and others that used light to make a current flow — a phenomenon that came to be called the photoelectric effect.</p>
<p>The puzzle was that when they directed dim beams of light at a metal plate, sometimes an electric current flowed across the plate and sometimes it didn’t. In the pre-quantum world this was hard to explain. It was believed that any wave should create at least a small current, and brighter waves should create larger currents. Instead, physicists found that there was a special color of light — a frequency — that got a current to flow. Only waves of that frequency or higher could start a current. Brightness had little to do with it.</p>
</div>
<figure>
    
</figure>
<div data-role="selectable">
    <p>Einstein proposed a solution in 1905: A wave of light is made of many discrete units called “quanta,” each with energy related to the wave’s frequency. The higher the frequency of the wave, the more energetic its quanta. And the brighter the wave, the more quanta there are. If you try to start an electric current in a metal plate with low-frequency red light, you’ll be no more successful than if you tried to knock over a refrigerator with ping-pong balls; no number would suffice. But using higher-frequency blue light is like switching to boulders. Each of those units has enough oomph to excite an electron, even in dim light with very few of them.</p>
<p>Einstein’s theory was met with skepticism. Physicists felt fiercely protective of James Clerk Maxwell’s then-40-year-old theory of light as an electromagnetic wave. They had seen light refracting, diffracting, and doing all the things waves do. How could it be made up of particles?</p>
<p>Even after Einstein won the 1921 Nobel Prize in Physics for his theory of the photoelectric effect, debate continued among physicists. The effect suggested that something is quantized; otherwise there wouldn’t be a minimum threshold required to get electrons flowing. But some physicists, including Niels Bohr, who is considered one of the founders of quantum theory, continued to explore the possibility that only the matter was quantized, not the light. Today, this type of theory is called “semiclassical” because it describes a classical field interacting with quantized matter.</p>
<p>To see how a semiclassical theory can explain the photoelectric effect, imagine a kid on a swing. They’re kind of like an electron in a metal. They have a ground state (not swinging) and an excited state (swinging). A classical wave is like giving the kid a series of pushes. If the pushes come at some random frequency, nothing happens. The kid might bounce around a little, but they will basically stay in their ground state. It’s only when you push with just the right frequency — the swing’s “<a href="https://www.quantamagazine.org/how-the-physics-of-resonance-shapes-reality-20220126/">resonant</a>” frequency — that the kid accumulates energy and starts swinging. (Electrons in a metal are a little different; they resonate with a whole continuous “band” of frequencies instead of just the one. But the upshot is the same: Any wave below that frequency band does nothing, whereas any wave in that frequency band excites electrons and makes a current flow.)</p>

<p>Einstein was eventually vindicated, but not on the strength of the photoelectric effect alone. Later experiments that collided electrons and photons like projectiles found that momentum, too, came in chunks. This research eventually ruled out the main alternative — a semiclassical theory of light and matter from Bohr and his collaborators. In 1925, seeing the data, Bohr agreed to “give our revolutionary efforts as honorable a funeral as possible” and welcomed light into the quantum fold. Light quanta became known as photons.</p>
<p>Few doubted the photon after 1925, but physicists are nothing if not thorough. Just because no one could think of a viable semiclassical theory didn’t mean one didn’t exist. The <a href="https://journals.aps.org/prl/abstract/10.1103/PhysRevLett.39.691">final proof</a> that photons are real came in the late 1970s, when quantum optics researchers showed that light arrived at a detector in a pattern no semiclassical theory could mimic. The experiments were akin to firing a photon gun once per second and confirming that the detector clicked once per second in response. The photon wars ended with a whimper.</p>
<p>“There were just mountains of evidence that this photon concept was useful and vital,” Wilczek said.</p>
<h2><strong><span>The Graviton Wars Begin</span></strong></h2>
<p>In August of 2023, <a href="https://qquest.lbl.gov/~carney/">Daniel Carney</a> and his collaborators fired the first shot in a new war.</p>
<p>It started when Carney’s colleague Nicholas Rodd had an insight similar to Pikovski’s, about a possible way to detect a graviton. “We got super pumped,” said Carney, a physicist at Lawrence Berkeley National Laboratory.</p>
<p>But when he and his collaborators dug into the literature, they uncovered the messy history of the photon, and the lengths to which quantum optics researchers had gone in the 1970s to close the final loopholes. They translated those more stringent tests into the gravitational context and found that Dyson had been right. Really proving quantumness by detecting lone gravitons one after another — as opposed to plucking one out of a tsunami, in the style of Pikovski’s proposal — would indeed take planetary-scale machinery.</p>
</div>
    <figure>
        <div>
                            <p><img width="2560" height="1830" src="https://www.quantamagazine.org/wp-content/uploads/2024/10/DanielCarney_crLawrenceBerkeleyNationalLaboratory-edit-scaled.webp" alt="Portrait of a young man with bushy brown hair and a beard." decoding="async" loading="lazy" srcset="https://www.quantamagazine.org/wp-content/uploads/2024/10/DanielCarney_crLawrenceBerkeleyNationalLaboratory-edit-scaled.webp 2560w, https://www.quantamagazine.org/wp-content/uploads/2024/10/DanielCarney_crLawrenceBerkeleyNationalLaboratory-edit-1720x1230.webp 1720w, https://www.quantamagazine.org/wp-content/uploads/2024/10/DanielCarney_crLawrenceBerkeleyNationalLaboratory-edit-520x372.webp 520w, https://www.quantamagazine.org/wp-content/uploads/2024/10/DanielCarney_crLawrenceBerkeleyNationalLaboratory-edit-768x549.webp 768w, https://www.quantamagazine.org/wp-content/uploads/2024/10/DanielCarney_crLawrenceBerkeleyNationalLaboratory-edit-1536x1098.webp 1536w, https://www.quantamagazine.org/wp-content/uploads/2024/10/DanielCarney_crLawrenceBerkeleyNationalLaboratory-edit-2048x1464.webp 2048w" sizes="(max-width: 2560px) 100vw, 2560px">                </p>
                        </div>
        <figcaption>
    <div>
                            <p>Daniel Carney, a physicist at Lawrence Berkeley National Laboratory, argues that a proposed experiment would not offer conclusive proof of quantum gravity.</p>
            <p>Lawrence Berkeley National Laboratory</p>
        </div>
</figcaption>
    </figure>
<div data-role="selectable">
    <p>“It was crazy to have to revise your hypothesis by 100% really fast,” Carney said.</p>
<p>Now graviton chasers find themselves in a peculiar position. On the main facts, everyone is in agreement. One, detecting a quantum event sparked by a gravitational wave is — surprisingly — possible. And two, doing so would not explicitly prove that the gravitational wave is quantized. “Could you make a classical gravitational wave that would produce the same signal? The answer is yes,” said Carney, who along with two co-authors analyzed this type of experiment in <a href="https://journals.aps.org/prd/abstract/10.1103/PhysRevD.109.044009"><em>Physical Review D</em></a> in February.</p>
<p>How much physicists feel they would learn from the experiment varies. To some, it would strongly suggest that gravity is a quantum force because the alternative — a semiclassical theory of gravity and matter — is disfavored on other grounds. Such theories violate the conservation of energy, for instance. If the beryllium bar gains one quantum of energy, then energy conservation requires that the gravitational wave must have lost one quantum of energy — and therefore it must be quantized, too. (Einstein advanced this sort of argument for the photon in 1911.) Semiclassical theories save gravity’s classicality by sacrificing this revered principle.</p>

<p>“Unless you use very artificial interpretations,” Wilczek said, “it does tell you that you really should apply quantum mechanics to the gravitational wave.”</p>
<p>“If I want to see signatures of quantumness, it’s not my first goal to rule out these pathological things,” Pikovski said.</p>
<p>To physicists such as Carney, however, a mere strong suggestion that gravity is quantized isn’t all that informative. We already have an abundance of strong suggestions that all of reality is quantized, he says. What’s needed is proof — such as experiments that would close the remaining loopholes, no matter how bizarre they might seem.</p>
<p>“We’re so biased to think that everything is quantum that you should really be doing a lawyerly thing,” he said.</p>
<h2><strong><span>A Starting Point</span></strong></h2>
<p>While Pikovski’s proposal is not a loophole-closing experiment, many physicists would still like to see it happen. It would mark the dawn of an era of experimental quantum gravity, which until recently seemed quite far off.</p>
<p>“This is an exciting paper,” said <a href="https://www.quantamagazine.org/he-seeks-mystery-magnetic-fields-with-his-quantum-compass-20240517/">Alex Sushkov</a>, an experimental physicist at Boston University. “These are hard experiments, and we need bright, smart people to move in this direction.”</p>
<p>“We can take it as a starting point,” said <a href="https://profiles.imperial.ac.uk/m.kim">Myungshik Kim</a>, a physicist at Imperial College London.</p>
        
        
<p>It might motivate subsequent experiments that would take physicists deeper into the quantum gravity era, just as scattering experiments once took them deeper into the era of the photon. Physicists now know that quantum mechanics is much more than quantization. Quantum systems can take on combinations of states known as superpositions, for instance, and their parts can become “entangled” in such a way that measuring one reveals information about the other. Experiments establishing that gravity exhibits these phenomena would provide <a href="https://www.quantamagazine.org/physicists-find-a-way-to-see-the-grin-of-quantum-gravity-20180306/">stronger evidence</a> for quantum gravity, and researchers are already exploring what it would take to carry them out.</p>
<p>None of these tests of gravity’s quantum side are completely ironclad, but each would contribute some hard data regarding the finest features of the universe’s weakest force. Now a frigid quantum bar of beryllium appears to be a prime candidate for an experiment that will mark the first step down that long and winding road.</p>
</div>
                
                
            </div><div>
        <div data-name="next-post__image-wrapper">
    <p><img width="1720" height="729" src="https://www.quantamagazine.org/wp-content/uploads/2024/10/EukaryoteExplainer-crKristinaArmitage-HP-1720x729.webp" alt="An illustration shows a cell with its organs arranged by shape, as if in separate compartments." decoding="async" loading="lazy" srcset="https://www.quantamagazine.org/wp-content/uploads/2024/10/EukaryoteExplainer-crKristinaArmitage-HP-1720x729.webp 1720w, https://www.quantamagazine.org/wp-content/uploads/2024/10/EukaryoteExplainer-crKristinaArmitage-HP-520x220.webp 520w, https://www.quantamagazine.org/wp-content/uploads/2024/10/EukaryoteExplainer-crKristinaArmitage-HP-768x325.webp 768w, https://www.quantamagazine.org/wp-content/uploads/2024/10/EukaryoteExplainer-crKristinaArmitage-HP-1536x651.webp 1536w, https://www.quantamagazine.org/wp-content/uploads/2024/10/EukaryoteExplainer-crKristinaArmitage-HP-2048x868.webp 2048w" sizes="(max-width: 1720px) 100vw, 1720px">    </p>
</div>
        
        <div>
                <h2>Next article</h2>
                <p>Meet the Eukaryote, the First Cell to Get Organized</p>
            </div>
        </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[OpenZFS deduplication is good now and you shouldn't use it (309 pts)]]></title>
            <link>https://despairlabs.com/blog/posts/2024-10-27-openzfs-dedup-is-good-dont-use-it/</link>
            <guid>42000784</guid>
            <pubDate>Wed, 30 Oct 2024 21:48:25 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://despairlabs.com/blog/posts/2024-10-27-openzfs-dedup-is-good-dont-use-it/">https://despairlabs.com/blog/posts/2024-10-27-openzfs-dedup-is-good-dont-use-it/</a>, See on <a href="https://news.ycombinator.com/item?id=42000784">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
      
<article>

<header>
  <p><time>27 October, 2024</time>
    
  </p>

  

  
</header>

<p><a href="https://github.com/openzfs/zfs/releases/">OpenZFS 2.3.0 will be released any day now</a>, and it includes the new <a href="https://www.youtube.com/watch?v=_T2lkb49gc8">“Fast Dedup”</a> feature. My team at <a href="https://klarasystems.com/">Klara</a> spent many months in 2023 and 2024 working on it, and we reckon it’s pretty good, a huge step up from the old dedup as well as being a solid base for further improvements.</p>
<p>I’ve been watching various forums and mailing lists since it was announced, and the thing I kept seeing was people saying something like “it has the same problems as the old dedup; needs too much memory, nukes your performance”. While that was true (ish), and is now significantly less true, the real problem is that this just repeating the same old non-information that they probably heard from someone else repeating it.</p>
<p>I don’t blame anyone really; it is true that dedup has been extremely challenging to get the best out of, it’s very difficult to find good information about using it well, and “don’t use it” was and remains almost certainly the right answer. But, with this being the first time in almost two decades that dedup has been worth even considering, I want to get some fresh information out there about what dedup is, how it worked traditionally and why it was usually bad, what we changed with fast dedup, and why it’s still probably not the thing you want.</p>
<nav>
<h2>Table of contents</h2>

<ul>
  
  
    <li><a href="#what-even-is-dedup">What even is dedup?</a>
    
    </li>
  

  
    <li><a href="#how-does-dedup-work">How does dedup work?</a>
    
    </li>
  

  
    <li><a href="#why-is-traditional-dedup-so-bad">Why is traditional dedup so bad?</a>
    
      <ul>
      
      
        <li><a href="#the-dedup-table">The dedup table</a></li>
      
      
      
        <li><a href="#the-live-entry-list">The live entry list</a></li>
      
      
      
        <li><a href="#unique-entries">Unique entries</a></li>
      
      
      </ul>
    
    </li>
  

  
    <li><a href="#how-does-fast-dedup-fix-all-this">How does fast dedup fix all this?</a>
    
      <ul>
      
      
        <li><a href="#making-the-live-entry-list-smaller">Making the live entry list smaller</a></li>
      
      
      
        <li><a href="#the-dedup-log">The dedup log</a></li>
      
      
      
        <li><a href="#incremental-log-flushing">Incremental log flushing</a></li>
      
      
      
        <li><a href="#unique-entries-1">Unique entries</a></li>
      
      
      </ul>
    
    </li>
  

  
    <li><a href="#thats-a-lot-anything-else">That’s a lot! Anything else?</a>
    
    </li>
  

  
    <li><a href="#nice-cant-wait-to-use-this-with-my-existing-dedup-table">Nice! Can’t wait to use this with my existing dedup table</a>
    
    </li>
  

  
    <li><a href="#is-deduplication-_really_-good-now">Is deduplication <em>really</em> good now?</a>
    
    </li>
  

  
    <li><a href="#i-dont-get-it-after-all-this-if-its-good-enough-why-shouldnt-i-enable-dedup-everywhere">I don’t get it. After all this, if it’s good enough, why shouldn’t I enable dedup everywhere?</a>
    
    </li>
  

  
    <li><a href="#in-summary">In summary</a>
    
    </li>
  

</ul>

</nav>

<h2 id="what-even-is-dedup">
What even is dedup?
<a href="#what-even-is-dedup">🔗</a> 
</h2>
<p>Dedup can be easily described in a sentence.</p>
<blockquote>
<p><em>When OpenZFS prepares to write some data to disk, if that data is already on disk, don’t do the write but instead, add a reference to the existing copy.</em></p>
</blockquote>
<p>The challenge is all in how you determine whether or not the data is already on disk, and knowing where on disk it is. The reason it’s challenging is that that information has to be stored and retrieved, which is additional IO that we didn’t have to do before, and that IO can add surprising amounts of overhead!</p>
<p>This stored information is the “dedup table”. Conceptually, it’s hashtable, with the data checksum as the “key” and the on-disk location and refcount as the “value”. It’s stored in the pool as part of the pool metadata, that is, it’s considered “structural” pool data, not user data.</p>
<h2 id="how-does-dedup-work">
How does dedup work?
<a href="#how-does-dedup-work">🔗</a> 
</h2>
<p>When dedup is enabled, the “write” IO path is modified. As normal, a data block is prepared by the DMU and handed to the SPA to be written to disk. Encryption and compression are performed as normal and then the checksum is calculated.</p>
<p>Without dedup, the metaslab allocator is called to request space on the pool to store the block, and the locations (DVAs) are returned and copied into the block pointer. When dedup is enabled, OpenZFS instead looks up the checksum in the dedup table. If it doesn’t find it, it calls out to the metaslab allocator as normal, gets fresh DVAs, fills the block and lets the IO through to be written to disks as normal, and then creates a new dedup table entry with the checksum, DVAs and the refcount set to 1. On the other hand, if it does find it, it copies the DVAs from the the value into the block pointer and returns the writing IO as “completed” and then increments the refcount.</p>
<p>Blocks allocated with dedup enabled have a special <code>D</code> flag set on the block pointer. This is to assist when it comes time to free the block. The “free” IO path is similarly modified to check for the <code>D</code> flag. If it exists, the same dedup table lookup happens, and the refcount is decremented. If the refcount is non-zero, the IO is returned as “completed”, but if it reaches zero, then the last “copy” of the block is being freed, so the dedup table entry is deleted and the metaslab allocator is called to deallocate the space.</p>
<p>So all this is working, in that OpenZFS is avoiding writing multiple copies of the same data. The downside is that every single write and free operation requires a lookup and a then a write to the dedup table, regardless of whether or not the write or free proper was actually done by the pool.</p>
<p>It should be clear then that any dedup system worth using needs to save more in “true” space and IO than it spends on the overhead of managing the table. And this is the fundamental issue with traditional dedup: these overheads are so outrageous that you are unlikely to ever get them back except on rare and specific workloads.</p>
<h2 id="why-is-traditional-dedup-so-bad">
Why is traditional dedup so bad?
<a href="#why-is-traditional-dedup-so-bad">🔗</a> 
</h2>
<p>All of the detail of dedup is in how the table is stored, and how it interacts with the IO pipeline. There’s three main categories of problem with the traditional setup:</p>
<ul>
<li>the construction and storage of the dedup table itself</li>
<li>the overheads required to accumulate and stage changes to the dedup table</li>
<li>the problem of “unique” entries in the table</li>
</ul>
<h3 id="the-dedup-table">
The dedup table
<a href="#the-dedup-table">🔗</a> 
</h3>
<p>Traditional dedup implemented the dedup table in probably the simplest way that might work: it just hooked up the standard OpenZFS on-disk hashtable object and called it a day. This object type is a “ZAP”, and it’s used throughout OpenZFS for file directories, property lists and internal housekeeping. It’s an entirely reasonable choice. It’s also really not well suited to an application like dedup.</p>
<p>A ZAP is a fairly complicated structure, and I’m not going to get into it here. For our purposes, it’s enough to know that each data block in a ZAP object is an array of fixed-size “chunks”, with a single key/value consuming as many chunks as are needed to hold the key, the data, and and a header describing how the chunks are being used.</p>
<p>A dedup entry has a 40-byte key. The value part can be up to 256 bytes, however this is compressed before storing it, so let’s assume a common case of 64 bytes to actually stored. Each chunk inside the ZAP is 24 bytes, and can contain either the header, or up to 21 bytes of key or value data. All together, we’re looking at <code>ceil(40/21) + ceil(64/21) + 1 == 7</code> chunks per entry. A typical dedup ZAP block is 32K, which has space for 1320 chunks (ZAP blocks themselves have their own header describing the chunks). So a single dedup block has space for <code>1320/7 = 188</code> “typical” entries.</p>
<p>We could certainly create a better format tailored to storing dedup entries, but the format is not the immediate issue here. The real problem is one present throughout OpenZFS wherever a data block is carrying an array of unrelated items: amplification. OpenZFS never writes partial blocks, and it never overwrites a block in place. So if we want to update a single dedup entry, we need to load the entire block from disk, modify just the bit we want, and write it back out, in full, as a brand-new block. And then the new block pointer needs to be written to an indirect block, and its new block pointer to another indirect, or the dnode, and so on up and up to the top of the tree. This is of course no different to any other OpenZFS write, and further up the tree we go the more that overhead is amortised across writes from the entire pool. But within the dedup ZAP, it’s a read-modify-write cycle for every single block written, because at minimum we have to bump a refcount.</p>
<p>That’s just a single entry update. If two writes were done within the same transaction, then that’s almost certain to be two different ZAP blocks we need to do that read-copy-write change on. Dedup mandates a cryptographically-strong and collision-resistant checksum to use as the key, which means the chance of any two arbitrary checksums falling close enough to land in the same ZAP block is small.</p>
<p>This is where the old recommendations suggesting that dedup requires enormous amounts of RAM ultimately come from. Reading a dedup table is like reading any other data in OpenZFS: it gets cached in the ARC. If you have enough RAM such that the ARC never needs to evict any part of the dedup table, then you can largely cut out the entire read part of the table update.</p>
<p>This is also where the rarely-seen <code>dedup</code> vdev class can help. If you add a sufficiently large and fast <code>dedup</code> vdev to your pool, then you may be able to reduce your memory requirements a little. This still ends up being a challenging build, because at scales that make dedup worthwhile, you really need to build that vdev out of something large enough to hold the entire table, and fast enough the overhead of not being memory is still workable. Multi-terabyte NVMe devices are great if you can afford them, but it’s not for the faint of heart or light of wallet.</p>
<h3 id="the-live-entry-list">
The live entry list
<a href="#the-live-entry-list">🔗</a> 
</h3>
<p>There is another significant memory use in traditional dedup, that isn’t as well known and has no good way to balance it against other factors.</p>
<p>Every write in OpenZFS is assigned to a “transaction”, identified by a numerical “transaction id”. Data is written out to disk as it becomes ready, then every so often that transaction is closed and all the metadata for the transaction, which includes dedup table updates, all those block pointer updates mentioned above, and various other bits of housekeeping are all written down. By default this happens no more than 5 seconds since the last time, but in practice it’s when there’s a gap in userspace activity.</p>
<p>Imagine you wrote, say, five instances of the same data at the same moment, to a dataset with dedup enabled. Imagine also that this is brand-new data, not currently in the dedup table. You would want this to only be written once, and a dedup table entry for this block to have a refcount of 5.</p>
<p>Because these are data writes, they begin “immediately”. But if you recall the IO path above, each one needs to look up the dedup table first to decide if it should really be written, or just bump the refcount. The dedup table lookup function will be called five times, all would end up trying to read the relevant part of the dedup ZAP (though the ARC would reduce it to one physical read), and all would discover that the entry doesn’t exist, and so let the writes through. Finally, all would try to create a new entry with refcount 1. We end up with some distinctly un-duplicated data, and a dedup table that has no reflection on reality.</p>
<p>So instead, OpenZFS keeps an in-memory list of “live” entries. These are held entirely in memory, and keep track of entries created or modified on this transaction. The dedup table lookup function starts by checking this list for the requested entry. If it’s there, the live entry refcount is bumped and it is returned. If it’s not there, then it will create a new live entry, flag it as “in progress”, then it will call down to the ZAP layer to get the dedup entry proper. When that entry comes back, it unpacks it into the live entry, flags it as “ready” and then returns it. Meanwhile, the other write threads will arrive, look up the live entry, see that it’s “in progress”, set up to be woken when it’s ready, and go to sleep. When they get woken, they will see that the flag has changed to “ready”, bump the refcount and return it.</p>
<p>Then, at the end of transaction, the live entry list is walked, and the relevant details are copied into the dedup ZAP.  Because there’s one and only one live entry for every checksum, each dedup ZAP entry only gets one update. We’re also applying all of the changes all at once, which is our best chance to be updating multiple entries within the same block.</p>
<p>Overall, this is a reasonable model, and matches the rough model everywhere else in OpenZFS: do all the data work during the transaction, and when the transaction closes, resolve all the associated metadata changes and write them all out. If you’ve ever heard an OpenZFS developer talk about “open” and “syncing” contexts, this is what they’re talking about.</p>
<p>The problem? These live entries are enormous: 424 bytes each. The raw entry that we load from and save to the ZAP is 296 bytes (bigger than the ~104 because this version is uncompressed), which is a problem on its own. However there is also 128 bytes of housekeeping stuff (like the “in progress” and “ready” flags and associated locks). It doesn’t take long for this list to grow very large, and although it’s cleared out at the end of every transaction, the peaks can be pretty high.</p>
<p>And this is kernel slab memory, not ARC memory. It can’t be reclaimed when the system is under pressure. There’s nothing you can tune or configure to bring this down.</p>
<p>It is a little more situational, as it will only grow in proportion to the amount of different things you’re writing each transaction. That’s little comfort though, as you’re only using dedup if you have a lot to write! So in the end, you still need a ton of memory if you want to actually make use of your dedup table.</p>
<h3 id="unique-entries">
Unique entries
<a href="#unique-entries">🔗</a> 
</h3>
<p>The biggest drag on all the dedup table is the space required to track unique entries. For dedup to work, we have to track everything we have stored on the disk, but, we only get any benefit when the refcount goes greater than 1. Any block that we have only one copy of is just consuming space in the dedup table, waiting for the day that something writes exactly the same data. If that never happens, then it’s a cost that we can never claw back.</p>
<p>And, since dedup is performed on the data after encryption and compression, and on the block level, then it’s not just the same <em>data</em>, but the same compression method, encryption keys, and alignment within the file. And this is why dedup is worse than useless on general purpose workloads, because there is just so little data that is truly “the same”.</p>
<h2 id="how-does-fast-dedup-fix-all-this">
How does fast dedup fix all this?
<a href="#how-does-fast-dedup-fix-all-this">🔗</a> 
</h2>
<p>What we call “fast dedup” is a suite of changes that together try to tackle the above problems. Put simply, the goal is to reduce the amount we store in the table, and when we must store something, be much smarter about how we accumulate and stage those changes, and then provide tools to allow the operator to limit and manage the table conetns.</p>
<h3 id="making-the-live-entry-list-smaller">
Making the live entry list smaller
<a href="#making-the-live-entry-list-smaller">🔗</a> 
</h3>
<p>The first place we started was to reduce the memory footprint of the live entry list. The dedup table is a regular stored object, accessed through the ARC, so for that we have many more optimisation options available to us. The live entry list however is exactly that: a simple list, recording every entry touched on this transaction, pinned in memory. We can’t get rid of it within the current architecture, so we just had to make it smaller.</p>
<p>The live entry type <code>ddt_entry_t</code> was not very well laid out. First, it used a few large numeric types to store simple flags; those were replaced with a bitfield. Next, some of the entry synchronisation fields (recall the “write five” example above) were simplified. Finally, it carried 40 bytes of state that is only needed when a dedup’d data block was first being written, or is in need of a repair write (the OpenZFS “self-healing” stuff). Once an entry is created, this state is never used, so it was lifted out to a separate “IO state” object that we create when we need it, and toss when we’re done. This was all fairly small stuff though.</p>
<p>The big fish is in the stored part of the entry. The key is 40 bytes, 32 of which are the checksum. It’s effectively a block pointer fragment, so can’t really be modified further without implications for the block pointer structure proper, which is well outside the scope of this work. More importantly though, we actually wanted to keep the key the same for compatibility with existing dedup tables. Not strictly necessary, but there’s no gains to be made that are significant enough to warrant the complexity of converting back to an old format when needed.</p>
<p>The value part is a different story. In traditional dedup, an entry contains four “physical” entries, which look like this:</p>
<div><pre tabindex="0"><code data-lang="c"><span><span><span>typedef</span> <span>struct</span> ddt_phys {
</span></span><span><span>    <span>dva_t</span>       ddp_dva[SPA_DVAS_PER_BP];
</span></span><span><span>    <span>uint64_t</span>    ddp_refcnt;
</span></span><span><span>    <span>uint64_t</span>    ddp_phys_birth;
</span></span><span><span>} <span>ddt_phys_t</span>;
</span></span></code></pre></div><p>That’s three 128-bit DVAs, the refcount for this entry, and the birth time (transaction id) for the entry. This is all pretty reasonable, and you can see how it can be combined with the key to produce an almost-complete block pointer (good enough to scrub the block anyway).</p>
<p>But wait, <em>four</em>? Why four? Well.</p>
<p>OpenZFS datasets have a <code>copies</code> parameter, that says how many copies of the block data should be written out. If you recall above I said that during a write, the metaslab allocator is called to allocate space to store the block data, and can return multiple DVAs. That’s how <code>copies</code> works: the allocator allocates one, two or three regions on the disk of the right size, the data is written to all of them, and that many DVAs go in the block pointer.</p>
<p>The thing is, you can change this property live, and it does what most property changes do, which is to affect all future writes, while leaving existing data on disk.</p>
<p>Consider what that means for dedup. Say you have a dataset with <code>copies=1</code> (the default), and you write a block. The block pointer gets one DVA (the other two are all-zero). You copy it a few times, which reuses the DVA and bumps the dedup refcount. Then you change to <code>copies=2</code> and copy the block again. The entry is looked up in the dedup table, but only has one DVA when the write policy is requesting two. What do we do?</p>
<p>Traditional dedup’s answer is to treat this as a brand-new write. It goes through to the allocator, two DVAs are allocated and written. Then the dedup entry is updated, but instead of bumping the refcount for the 1-copy “physical” entry (at <code>dde_phys[1]</code>), it instead copies the DVAs into the 2-copy entry (at <code>dde_phys[2]</code>, and sets the refcount there to 1. And from then on, those two variants of the block are treated effectively as separate dedup entries with a common key.</p>
<p>The thing is, is very unusual for an operator to modify <code>copies=</code> on an existing dataset, and also ill-advised where dedup is in play, because it effectively invalidates your existing dedup table for new writes: they all start back at 1, including using more space! So most of the time, the other “physical” entries are going to be filled with zeroes, unused. This isn’t too much of an issue for entries stored in the dedup ZAP, as those are compressed and long runs of zeroes compress reasonably well. But, while they’re in memory on the live list, they’re just sitting there, at least 192 bytes of zeroes that will never be needed.</p>
<p>(Astute readers that know that a block pointer can only contain up to three DVAs, and that <code>copies=</code> can be set to 1, 2 or 3, might now be wondering what the fourth entry is for. The answer, these days, is nothing. It used to be where the <code>dedupditto</code> feature lived, storing extra DVAs “just in case”, but it was buggy and not really useful, and was removed years ago. It’s still supported for very old pools, but modern OpenZFS can only read them, not write them).</p>
<p>After some experimentation, we realised that if we receive a write for a block that is already on the dedup table, but has too few DVAs, all we really have to do is allocate and write enough additional copies of the data to fulfill the request (up to 3), and add those to the dedup entry when we bump the refcount. This does mean we now have blocks on disk with the old number of DVAs, but that’s ok, as that’s the same guarantee as before. It does make the “lookup entry” part of the IO pipeline more complex of course, and it does introduce some subtleties when freeing the block when the refcount reaches zero, but that’s fine - clever and tricky things are ok, for a good cause.</p>
<p>And a good cause this is! New dedup tables created with fast dedup enabled have the “value” part of the entry at just 72 bytes, rather than 256 is the traditional version (the extra 8 is for an additional 64-bit integer to support the pruning feature, see below).</p>
<p>Pull this all together, and a single entry in the live list is now 216 bytes, almost half the original 424 in a traditional entry. “Half the memory” is a pretty nice thing to be able to put on the future, especially for slab memory that can’t be easily reclaimed.</p>
<p>The stored entry is technically also smaller, but it’s still going to hit that ballpark of ~64 bytes after compression. It starts a lot smaller, but is a lot less compressible because it’s not full of long runs of zeroes that are easy to reduce. Once we take ZAP chunk overheads into account there’s very little gain made here. But that’s ok, because reducing the size of the dedup ZAP entries was never really in our plans.</p>
<h3 id="the-dedup-log">
The dedup log
<a href="#the-dedup-log">🔗</a> 
</h3>
<p>As we’ve discussed, the live entry list has a record for every deduplicated modified on the current transaction. At the end of the transaction, these updated entries are written back to the dedup ZAPs. Each entry is surrounded by 187 other entries in the same dedup block, which as the dedup table gets larger, are less and less likely to have been touched on this transaction. So in order to update the entry, we have potentially had to load a full block of entries, which is additional IO or, in the better-but-still-bad scenario, “loaded” the block from the ARC instead. And then, once all the entries are updated, the live entry list is cleared.</p>
<p>After considering some customer workloads, and doing some of our own experiments, we decided that if a block is to be duplicated, it’s more likely to be one that was “recently” created or duplicated. Or, put another way, the longer it’s been since a block was touched, the less likely it is that it will be duplicated or freed in the future. Without thinking very hard this intuitively makes sense; we tend to work with the same bit of data a lot, and then we don’t touch it again for a while, or ever. If this is true, then it means throwing away the live entry list at the end of the transaction ends up being extremely wasteful, because there’s a good chance we’re going to need some or even most of those entries in the very near future!</p>
<p>The thing is, the changes represented by the live entry list “belong” to the transaction. They <em>must</em> be written down with that transaction, otherwise rolling back to that transaction (eg during crash recovery) will have stale information in the dedup table. So we started thinking about where else we could possibly record these changes such that we could get them back quickly in subsequent transactions, and in a rollback, without wearing the full cost of updating the dedup table proper every time.</p>
<p>The answer of course is the same as it’s been any time any storage system has wanted to defer work into the future: add a “journal” or “log” describing the changes, replay the log during crash recovery, and during normal operation, slowly write the logged changes out to their final resting place. The fundamentals of the dedup architecture however, make things a little more complicated, as we’ll see when we imagine building up this system.</p>
<p>So let’s imagine the simplest thing that might work. At the end of transaction, instead of updating the dedup ZAP, we just dump the entire live entry list as an array of fixed-size entries onto the end of some object, which we declare to be the log. Since the same entry might have been updated on two or more consecutive transactions, and we’re only appending to the log, this means that the log might contain the same entry more than once. That’s fine, it just means we should only use the last we see. Every so often, we blast through the log, add the last instance of each entry to the dedup ZAP, and then zero the log. Job done.</p>
<p>This actually works very well for what it is. The log is stored in a regular object, and so is bound to the same transaction as the data changes associated with its entries. Multiple changes to the same entries end up being amortised somewhat; if we only write the log back to the ZAP every five transactions, an entry that changes every five transactions will only be written once. So great, that’s the write overhead taken care of.</p>
<p>The critical flaw here is on the lookup side. At any point, the write pipeline is going to come asking for an entry. If it hasn’t been used this transaction (ie it’s not on the live entry list), it will go to the dedup ZAP and get the entry from there. But if that entry is on the log, then the entry in the ZAP is stale, and we can’t use it, both because it may be wrong, and because it’s going to be overwritten when the log is written out.</p>
<p>Our only option then is to search the log to find out if it has a more recent version of the entry. The problem with that is that most of the time it’s even worse than reading from the ZAP, as the log has no useful ordering, and duplicate entries. We potentially have to read the entire log, however enormous it may be, only to find the entry wasn’t even there and still have to do a lookup in the ZAP.</p>
<p>What we need is an index of the log, that gives us a fast way to look up any entry that might exist in it. As it turns out, once you remove the overheads of a “live” object, a single “logged” entry held in memory is only 144 bytes, for the entire entry. This is small enough that it’s feasible to keep the entire log in memory, as well as on disk. And then, when doing a lookup, if the entry we want is not on the live entry list, we then check the in-memory log, and if it’s not there, we go to the dedup ZAP. And then, at end of transaction, we save the updated version of the entry to both the in-memory log and to the on-disk log.</p>
<p>On disk <em>as well</em>? Yes. We still need crash safety. But when we take these two version of the log together, the on-disk log becomes write-only, while all regular activity goes to the in-memory log, that is, the two contain alternate representations of the same data. In the case of rollback or crash recovery (both of which happen at pool import), we simply load the in-memory log from the on-disk log, and move on with life.</p>
<h3 id="incremental-log-flushing">
Incremental log flushing
<a href="#incremental-log-flushing">🔗</a> 
</h3>
<p>Of course, we’ve now introduced some new complexity to help with managing some existing complexity, which naturally means we have to do some work to manage the complexity as well.</p>
<p>We’ve reduced the per-transaction IO overhead of the dedup table to about the smallest it can be, at the cost of the memory required to carry a copy of the log. It’s smaller on average compared to the ARC overhead, but it’s not <em>nothing</em>, and we have to keep it in check.</p>
<p>Our earliest version just watched the size of the in-memory tree and when it grew “too big”, at the end of transaction, we just wrote the entire log out to the dedup ZAP and cleared it. This is less IO <em>in total</em> than if we’d written those updates to the dedup ZAP at the end of each transaction, but at least that IO was spread across multiple transactions. In our testing, we could easily causes substantial flushing pauses with only a few thousand entries on the list, long before any real memory pressure was fault.</p>
<p>So instead, we changed things so that some amount of the log was written out to the ZAP every transaction. We monitor the log flush rate against the amount of time spent on real IO, so that we write less in busy periods, and more in quiet periods. There’s some extra consideration there too, like, we may accelerate when the in-memory log is too large and causing memory pressure, and a few other things.</p>
<p>Incremental flushing brought back an older problem though. We want to be able to zero the on-disk log. We know which are the “most recent” entries on the log, because they’re the only ones on the in-memory log. But, we don’t know <em>where</em> in the on-disk log those versions of those entries are, and, because new entries are being added to the log on the same transactions as we are writing them out, we don’t know which entries on the in-memory log have been written out. Under this model, we cannot zero the on-disk log until and unless the in-memory log is empty, and the in-memory log will only be empty if no updated entries have occurred, which ultimately means that eventually, we have stop and flush the remaining log. And, because the on-disk log is only appended to, the longer we drag out the flushing, the larger it gets.</p>
<p>To handle this, we actually have <em>two</em> logs, each with an in-memory and on-disk version. One of these is only being flushed, the other is only being updated. In this way, we can accumulate new updates on the “active” log, while the “flushing” log is being emptied. Once it’s empty, the on-disk flushing log is zeroed, and the two logs are swapped: the old “active” is now “flushing” and begins being written out, and new changes are written to active. We get our wish that the log needs to be stopped before it can be flushed, without needing to stop the world.</p>
<p>Of course, this adds further complications to the lookup stage, as we now have to look for an entry on the “active” log list first, and then on the “flushing” log list, before finally going to the ZAP. For obscure reasons, that then means that entries “loaded” from the flushing list then ”saved” to the active list need a little bit of extra finesse, because we can end up with entries on the on-disk “flushing” tree that were never flushed before they were reused. It’s nothing to worry about; just slightly more complicated dance moves.</p>
<p>There’s also a “log checkpoint”. Since checksums are really just very large numbers, they have a very comfortable ordering. So, when we finish flushing on this transaction, we write the last checksum we wrote to the disk (actually to the bonus buffer of the flushing log object). This is there to make import faster; we have to reload both log lists. We can use the checkpoint when reading the flushing log to know which entries have already been flushed and not even bother putting them in the in-memory list.</p>
<p>Finally, there’s some interesting interactions with pool scans (ie scrub and resilver). Normally, when dedup is enabled, a scan begins by walking the dedup table, reading every block pointer (and taking the wanted action) from every entry within it, and then moving on to the rest of the pool. Every so often, the scan process will record a position in the pool, so that the scan can be resumed from that point.</p>
<p>The problem with the dedup log is that there is no useful notion of “position” within it to record. The on-disk log has no natural layout as we know, while the in-memory log uses a common structure in OpenZFS called an AVL tree, which does not have a “stable cursor”; that is, there’s nothing you can store to describe a logical position in the tree that would carry over to a different tree with the same structure.</p>
<p>We tried a lot of things to synthesize an AVL cursor, and it is sort of possible, but not within the constraints of the “position” data we need to save (for those playing along at home, we need to add a 40-byte key to <code>scn_ddt_bookmark</code> within <code>dsl_scan_phys_t</code>). In the end, we take something of a coward’s way out: when a scrub is requested, we accelerate log flushing; all the log is flushed out to the dedup ZAP, and then do it the old way. Scans set the current transaction as the “end of scan” point, so we don’t need to worry about changes that come in after, and the dedup ZAP will have everything from before the flush. It does mean that after a crash, the log needs to be re-flushed before the scan can continue, but the expectation is always that the size of the dedup ZAP and the pool data as a whole is always going to dwarf the size of the log.</p>
<h3 id="unique-entries-1">
Unique entries
<a href="#unique-entries-1">🔗</a> 
</h3>
<p>So that was a lot about the logs! If you’re still reading, well done!</p>
<p>There was one other issue with traditional dedup, and that was the difficulties caused by unique entries vastly inflating the size of the table with entries that never get used. There’s some new tools to help the operator manage the table size generally, and unique entries specifically.</p>
<p>The big help for unique entries is the new <code>zpool ddtprune</code> command. It will remove some amount of unique entries from all dedup tables on the system, specified by age or percentage. The age option works particularly well with our ideal workload where more recently used data is more likely to be deduplicated. This sort of usage pattern results in a long and aging tail of unique entries that will never be deduplicated. Now you can wholesale get rid of them, and with the new “ZAP shrink” enhancement, dedup ZAP blocks that end up entirely empty as a result of this operation will simply be removed.</p>
<p>Of course, this does mean that if a block whose dedup entry has been removed does later get copied, it will be a new block with a new allocation; there will be no deduplication. That said, if a very old unique block is suddenly copied a dozen times, that will be a dozen references to a single new block, and you’ll have two copies instead of the 13 you’d have without dedup at all. So you do need to tune the behaviour of <code>ddtprune</code> to match your workload, but it may not be a total disaster if you were to prune too much.</p>
<p>Meanwhile, the pool property <code>dedup_table_quota</code> lets you set a maximum possible size for the dedup tables on your pool. If creating a new entry would take the dedup tables over that limit, the entry won’t be created and the write will just be a regular non-dedup’d write. This is good to use in conjunction with a dedicated dedup device where you want it to not spill out to the main device if it gets full.</p>
<h2 id="thats-a-lot-anything-else">
That’s a lot! Anything else?
<a href="#thats-a-lot-anything-else">🔗</a> 
</h2>
<p>Just a handful of operational improvements.</p>
<p><code>zpool prefetch -t ddt</code> will preload the dedup tables into the ARC, which can help with performance immediately after pool import. In traditional dedup it’s obvious how this helps, but even in fast dedup, entries not on the log still need to be loaded from the ZAPs, and flushing still needs the ZAPs nearby to write too, so having them in the ARC still helps.</p>
<p>There’s a new collection of kstats, in <code>/proc/spl/kstat/zfs/&lt;pool&gt;/ddt_stats_&lt;checksum&gt;</code> on Linux or <code>kstat.zfs.&lt;pool&gt;.misc.ddt_stats_&lt;checksum&gt;</code> on FreeBSD. These will show various live stats for the dedup subsystem, including counts of lookups, hit rates on the live and log lists and the dedup ZAPs, and the log flushing rates.</p>
<p>There’s also a new collection of tuneables, <code>/sys/modules/zfs/parameters/zfs_dedup_log_*</code> on Linux or <code>vfs.zfs.dedup.log_*</code> on FreeBSD. These control various inputs into how much log flushing occurs each transaction. As usual, the defaults are carefully considered and should be fine for anyone, but when they’re not, having some knobs to adjust is a game changer.</p>
<p>And then the existing dedup-aware things (<code>zpool status -D</code>, <code>zdb -D</code>, <code>zdb -S</code>, etc) have been updated to understand all this new stuff.</p>
<h2 id="nice-cant-wait-to-use-this-with-my-existing-dedup-table">
Nice! Can’t wait to use this with my existing dedup table
<a href="#nice-cant-wait-to-use-this-with-my-existing-dedup-table">🔗</a> 
</h2>
<p>😬</p>
<p>So almost all of the above requires on-disk format changes that your existing dedup tables don’t have. This was unfortunate, but intentional: the project brief explicitly excluded a migration path, because it’s complicated (read: expensive) and there’s very few dedup installations out there of sufficient size and complexity to require it.</p>
<p>However, we didn’t go out of our way to make it not work, or to prevent it from being possible in the future.</p>
<p>For existing tables, anything that doesn’t require an on-disk format change should work:</p>
<ul>
<li>Table quotas (<code>dedup_table_quota</code> pool property)</li>
<li>Table prefetch (<code>zpool prefetch -t ddt</code>)</li>
<li>Lookup and hit counts (<code>ddt_stats_*</code> kstats)</li>
<li>ZAP “shrink” (collapsing whole empty blocks; this is a general ZAP enhancement in 2.3)</li>
</ul>
<p>The dedup log feature should be straightforward to make work with traditional tables. Nothing in it cares about the size of the entries (in fact, “log” and “flat entry” are two separate subfeatures. The only missing piece is something to set up the new “container” object for an existing table, which would be fairly easy to do. Of course, you would not get the smaller live and log list entries in memory or on disk, so some of the sizing tuning would be different.</p>
<p>Unique entry pruning (<code>zpool ddtprune</code>) should be straightforward to add for only the “percentage of uniques” mode. The “age” mode is not possible, as it requires data in the new entry format which doesn’t exist in the traditional format.</p>
<p>Converting your old tables is not currently possible. In the simplest case, where <code>copies=</code> has never been changed, it would be as straightforward as creating a new ZAP, walking over the existing ZAP, converting the entry and copying it in. Doing this online would be complicated as we’d need to either be reading from both old and new ZAPs, or writing down to both ZAPs and then switch over at the end. Doing it offline would be easier, and could be done through a userspace tool, but of course requires taking the pool offline.</p>
<p>If <code>copies=</code> has been changed and there are existing entries carrying both kinds, then a complete conversion is not possible, as the whole method by which existing “variants” of a block are upgraded is different and there just isn’t room in a new entry to store it all. The most fortunate cases would be if one and only one of the variants has a refcount greater than 1, as those are uniques that could be “pruned”. Otherwise there’s nothing we can do with those (though I have just had a strange thought involving the BRT).</p>
<p>And of course, the usual “trick” of sending the deduplicated dataset to another pool where the new dedup is available will certainly do the job.</p>
<p>If you are one of those people with an enormous dedup table and you’re interested in funding development of one or more of these options, <a href="https://klarasystems.com/company/contact-us/">Klara would love to talk to you</a>.</p>
<h2 id="is-deduplication-_really_-good-now">
Is deduplication <em>really</em> good now?
<a href="#is-deduplication-_really_-good-now">🔗</a> 
</h2>
<p>I think it really is good enough to at least play with. The overheads should at least be reduced enough to make it useful in more marginal situations.</p>
<p>Is it <em>really good</em> though? Probably not, not yet, but “not yet” is part of the point of all this. We’ve taken perhaps the most unloved OpenZFS feature, given it a substantial upgrade that hopefully will get more people taking a look at it, or maybe even taking a <em>second</em> look at it. Meanwhile, the code is now better structured, commented and understood by a lot more people, and has a lot more obvious points to add and change behaviour. It can finally join all the other features in the OpenZFS toolbox, and from there, who knows what it can become.</p>
<h2 id="i-dont-get-it-after-all-this-if-its-good-enough-why-shouldnt-i-enable-dedup-everywhere">
I don’t get it. After all this, if it’s good enough, why shouldn’t I enable dedup everywhere?
<a href="#i-dont-get-it-after-all-this-if-its-good-enough-why-shouldnt-i-enable-dedup-everywhere">🔗</a> 
</h2>
<p>If you’re like most people, you’re thinking about transparent deduplication because you have a general-purpose workload, that is, some “big ball of miscellaneous files” setup, like a local desktop or laptop. Or maybe a bigger version of that, for example, you provide exactly that service for all the people in your organisation. And good disks cost money, and times are tough, and you’re thinking well, if I can turn this thing on and it saves a bit of data, wouldn’t that be worth it?</p>
<p>I actually agree with this in theory.</p>
<p>As we’ve seen from the last 7000+ words, the overheads are not trivial. Even with all these changes, you still need to have a lot of deduplicated blocks to offset the weight of all the unique entries in your dedup table.</p>
<p>But, what might surprise you is how rare it is to find blocks eligible for deduplication are on most general purpose workloads.</p>
<p>Consider a simulated dedup run on my laptop. This is the machine I use for <em>everything</em>, home and work, easily 12 hours every day.</p>
<pre tabindex="0"><code>$ zpool list crayon
NAME     SIZE  ALLOC   FREE  CKPOINT  EXPANDSZ   FRAG    CAP  DEDUP    HEALTH  ALTROOT
crayon   444G   397G  47.3G        -         -    72%    89%  1.00x    ONLINE  -
</code></pre><pre tabindex="0"><code>$ zdb -S crayon
Simulated DDT histogram:

bucket              allocated                       referenced
______   ______________________________   ______________________________
refcnt   blocks   LSIZE   PSIZE   DSIZE   blocks   LSIZE   PSIZE   DSIZE
------   ------   -----   -----   -----   ------   -----   -----   -----
     1    11.7M    708G    362G    373G    11.7M    708G    362G    373G
     2    12.2K    666M    284M    293M    25.1K   1.32G    582M    602M
     4      294   4.44M    962K   1.55M    1.44K   22.0M   4.67M   7.76M
     8        5     99K     41K     44K       52   1.06M    440K    464K
    16        1   7.50K   3.50K      4K       26    195K     91K    104K
 Total    11.7M    708G    362G    373G    11.7M    709G    362G    373G

dedup = 1.00, compress = 1.96, copies = 1.03, dedup * compress / copies = 1.90
</code></pre><p>So for a table of 11.7M entries, the number of those that represent something we actually managed to deduplicate is a literal rounding error. It’s pretty much entirely uniques, pure overhead. Turning on dedup would just add IO and memory pressure for almost nothing.</p>
<p>But the real reason you probably don’t want dedup these days is because since OpenZFS 2.2 we have the BRT (aka “block cloning” aka “reflinks”). (I acknowledge that it had a shaky start, which has been written and presented on extensively, so I won’t do that again, but lets just say it’s all good now).</p>
<p>You may recall, way back at the top of this post, we asked “what even is dedup?”, and we defined it as:</p>
<blockquote>
<p><em>When OpenZFS prepares to write some data to disk, if that data is already on disk, don’t do the write but instead, add a reference to the existing copy.</em></p>
</blockquote>
<p>The dedup table and its entourage all exist to answer “is this data already on disk?”, but in one quite niche situation: when you don’t have any other knowledge or context about the data being written.</p>
<p>The thing is, it’s actually pretty rare these days that you have a write operation coming from some kind of copy operation, but you don’t <em>know</em> that came from a copy operation. In the old days, a client program would read the source data and write to the destination data, and the storage system would see these as two unrelated operations. These days though, “copy offloading” is readily available, where instead of reading and writing, the program will tell the storage system “copy this source to that destination” and the storage system is free to do that however it wants. A naive implementation will just do the same read and write as the client would, but a smarter system could do something different, for example, not doing the write and instead just reusing the existing data and bumping a refcount.</p>
<p>For Linux and FreeBSD filesystems, this “offload” facility is the <code>copy_file_range()</code> syscall. Most systems have an equivalent; macOS calls it <code>copyfile()</code>, Windows calls it <code>FSCTL_SRV_COPYCHUNK</code>. NFS and CIFS support something like it, OS block device drivers are getting equivalents, even disk protocols have something like it (eg SCSI EXTENDED COPY or NVMe Copy).</p>
<p>If you put all this together, you end up in a place where so long as the client program (like <code>/bin/cp</code>) can issue the right copy offload call, and all the layers in between can translate it (eg the Window application does <code>FSCTL_SRV_COPYCHUNK</code>, which Samba converts to <code>copy_file_range()</code> and ships down to OpenZFS). And again, because there’s that clear and unambiguous signal that the data already exists and also it’s <em>right there</em>, OpenZFS can just bump the refcount in the BRT.</p>
<p>Most importantly is the space difference. If a block is never cloned, then we never pay for it, and if it is cloned, the BRT entry is only 16 bytes.</p>
<p>On my pool, where the two major users of <code>copy_file_range()</code> (that I know about) are <code>cp</code> and <code>ccache</code>, my BRT stats are rather nicer:</p>
<pre tabindex="0"><code>$ zdb -TTT crayon
BRT: used 292M; saved 309M; ratio 2.05x
BRT: vdev 0: refcnt 12.2K; used 292M; saved 309M

BRT: vdev 0: DVAs with 2^n refcnts:
			 1:  11788 ****************************************
			 2:    645 ***
			 3:     40 *
			 4:      3 *
			 5:      1 *
</code></pre><p>If you compare to the dedup simulation, I’m not saving as much raw data as dedup would get me, though it’s pretty close. But I’m not spending a fortune tracking all those uncloned and forgotten blocks.</p>
<p>Now yes, this is not plumbed through everywhere. zvols don’t use the BRT yet. Samba has only just gotten support for OpenZFS very recently. Offloading in Windows is only relatively new. The situation is only going to get better, but maybe it’s not good enough yet. So maybe you might be tempted to try dedup anyway, but for mine, I can’t see how the gains would be worth it even without block cloning.</p>
<p>And this is why I say you probably don’t want it. Unless you have a very very specific workload where data is heavily duplicated and clients can’t or won’t give direct “copy me!” signal, then just using block cloning is likely to get you a good chunk of the gain without the outsized amount of pain.</p>
<h2 id="in-summary">
In summary
<a href="#in-summary">🔗</a> 
</h2>
<p>Dedup is about balancing IO throughput, memory usage and dedup table size. Traditional dedup has a very tiny “sweet spot” where these factors balance nicely, while being ruinous if you fall out of it. Fast dedup improves all three, making it far easier to balance these factors and rather less of a disaster if it doesn’t work out. However, it is still only of benefit if you have a truly enormous amount of data, that gets copied a lot, and aren’t able to take advantage of other “zero-copy” options within OpenZFS, like block cloning or snapshot clones.</p>
<p>Extra congratulations if you got this far. I hope this was of interest!</p>
<hr>
<p><em>Thanks to <a href="https://aus.social/@mattcen">@mattcen</a> and <a href="https://hachyderm.io/@adavis">@adavis</a> for numerous grammar and spelling fixes. Much obliged! 💚</em></p>






</article>


    </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Hi Google, please stop pooping the bed: a desperate plea from the indie web (228 pts)]]></title>
            <link>https://build.shepherd.com/p/hi-google-please-stop-the-bed-a-desperate</link>
            <guid>42000651</guid>
            <pubDate>Wed, 30 Oct 2024 21:35:15 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://build.shepherd.com/p/hi-google-please-stop-the-bed-a-desperate">https://build.shepherd.com/p/hi-google-please-stop-the-bed-a-desperate</a>, See on <a href="https://news.ycombinator.com/item?id=42000651">Hacker News</a></p>
<div id="readability-page-1" class="page"><div dir="auto"><p><span>Join the rebellion and help me create the indie book platform readers and authors deserve! Three hurrahs for our&nbsp;818 Founding Members who keep us independent and fund new features. </span><a href="https://forauthors.shepherd.com/membership-for-readers" rel="">Readers</a><span> and </span><a href="https://forauthors.shepherd.com/membership" rel="">authors</a><span> can become Founding Members (</span><em>both get special perks, and more perks are coming</em><span>).</span></p><div><figure><a target="_blank" href="https://www.reddit.com/r/IASIP/comments/raem5o/is_who_pooped_the_bed_the_greatest_iasip_episode/" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1245c635-e700-421c-a6f5-9275d61d9af3_928x686.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1245c635-e700-421c-a6f5-9275d61d9af3_928x686.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1245c635-e700-421c-a6f5-9275d61d9af3_928x686.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1245c635-e700-421c-a6f5-9275d61d9af3_928x686.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1245c635-e700-421c-a6f5-9275d61d9af3_928x686.png" width="399" height="294.95043103448273" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/1245c635-e700-421c-a6f5-9275d61d9af3_928x686.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:686,&quot;width&quot;:928,&quot;resizeWidth&quot;:399,&quot;bytes&quot;:1018372,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:&quot;https://www.reddit.com/r/IASIP/comments/raem5o/is_who_pooped_the_bed_the_greatest_iasip_episode/&quot;,&quot;belowTheFold&quot;:false,&quot;topImage&quot;:true,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1245c635-e700-421c-a6f5-9275d61d9af3_928x686.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1245c635-e700-421c-a6f5-9275d61d9af3_928x686.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1245c635-e700-421c-a6f5-9275d61d9af3_928x686.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1245c635-e700-421c-a6f5-9275d61d9af3_928x686.png 1456w" sizes="100vw" fetchpriority="high"></picture></div></a></figure></div><p>Google is killing independent websites by burying them in the search results, even when we perfectly follow their guidelines. </p><p><strong>Nobody" is sure what is going on, but their search engine started breaking down about 16 months ago.</strong><span> </span></p><p><span>Some people believe they have lost control of their AI ranking systems, while others believe that the McKinsey alumni who run Google Search are purposefully doing this to increase ad earnings (</span><em>DOJ leaks from the ongoing trials hint at this</em><span>). </span></p><p><strong>Let me show you how Google is 💩 the bed…</strong><span> </span></p><p>Over the last 16 months, we’ve seen an 86% decline from Google to the most-loved section of the website. </p><p><span>This section has been incredibly popular with Google for years and it has&nbsp;</span><strong>sky-high engagement stats from visitors</strong><span>. </span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6d0edc90-3990-469e-935e-660a4becaa3b_1912x900.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6d0edc90-3990-469e-935e-660a4becaa3b_1912x900.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6d0edc90-3990-469e-935e-660a4becaa3b_1912x900.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6d0edc90-3990-469e-935e-660a4becaa3b_1912x900.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6d0edc90-3990-469e-935e-660a4becaa3b_1912x900.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6d0edc90-3990-469e-935e-660a4becaa3b_1912x900.png" width="1456" height="685" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/6d0edc90-3990-469e-935e-660a4becaa3b_1912x900.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:685,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:169493,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6d0edc90-3990-469e-935e-660a4becaa3b_1912x900.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6d0edc90-3990-469e-935e-660a4becaa3b_1912x900.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6d0edc90-3990-469e-935e-660a4becaa3b_1912x900.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6d0edc90-3990-469e-935e-660a4becaa3b_1912x900.png 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p><span>Google changes all the time, but </span><strong>a drop like this is insane</strong><span>. This is destroying many websites you know and love. </span></p><p>Google's promise to website owners was simple: create great content, and Google will rank those pages if those pages satisfy users.</p><p>This promise has been broken; let me show you how. </p><p>I am a data nerd. I love building good UX and work constantly to provide my visitors with an amazing experience. </p><p>I even do anonymous user video testing with every feature to ensure it is easy to navigate and that readers love the experience. </p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffb0ad070-bb2e-46f0-ab5f-4d57cc38eee1_480x344.webp" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffb0ad070-bb2e-46f0-ab5f-4d57cc38eee1_480x344.webp 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffb0ad070-bb2e-46f0-ab5f-4d57cc38eee1_480x344.webp 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffb0ad070-bb2e-46f0-ab5f-4d57cc38eee1_480x344.webp 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffb0ad070-bb2e-46f0-ab5f-4d57cc38eee1_480x344.webp 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffb0ad070-bb2e-46f0-ab5f-4d57cc38eee1_480x344.webp" width="360" height="258" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/fb0ad070-bb2e-46f0-ab5f-4d57cc38eee1_480x344.webp&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:344,&quot;width&quot;:480,&quot;resizeWidth&quot;:360,&quot;bytes&quot;:3155864,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/webp&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffb0ad070-bb2e-46f0-ab5f-4d57cc38eee1_480x344.webp 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffb0ad070-bb2e-46f0-ab5f-4d57cc38eee1_480x344.webp 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffb0ad070-bb2e-46f0-ab5f-4d57cc38eee1_480x344.webp 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ffb0ad070-bb2e-46f0-ab5f-4d57cc38eee1_480x344.webp 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><ul><li><p>60% of our visitors read 75% or more of the pages in this section. </p></li><li><p><span>On average, visitors spend 5 minutes and 1 second on pages in this section (</span><em>the real number is higher, as this only updates if an action is triggered on the page</em><span>).  </span></p></li></ul><ul><li><p>12% of visitors click to learn more about a book or go to a bookstore to learn more. This is an excellent sign that the reader found something that intrigued them enough to dig deeper.</p></li><li><p>8% of visitors click to visit another book list that we recommend at the end of the recommendations. </p></li><li><p>And more… </p></li></ul><p><strong>My point is that this section is incredibly popular with visitors, and Google used to see and reward that. </strong><span>This is happening to hundreds of thousands of websites, and Google is not saying anything. </span></p><p><span>I asked Kevin Miller to share his </span><a href="https://shepherd.com/best-books/battle-of-midway" rel="">five favorite books about the Battle of Midway</a><span> and why he thinks each of those is a great read (</span><em>click the below to read that</em><span>). </span></p><div><figure><a target="_blank" href="https://shepherd.com/best-books/battle-of-midway" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9a730161-eb0a-483a-9e3e-5e4c4eed0689_2448x1492.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9a730161-eb0a-483a-9e3e-5e4c4eed0689_2448x1492.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9a730161-eb0a-483a-9e3e-5e4c4eed0689_2448x1492.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9a730161-eb0a-483a-9e3e-5e4c4eed0689_2448x1492.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9a730161-eb0a-483a-9e3e-5e4c4eed0689_2448x1492.png" width="489" height="297.9004120879121" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/9a730161-eb0a-483a-9e3e-5e4c4eed0689_2448x1492.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:887,&quot;width&quot;:1456,&quot;resizeWidth&quot;:489,&quot;bytes&quot;:2922668,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:&quot;https://shepherd.com/best-books/battle-of-midway&quot;,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9a730161-eb0a-483a-9e3e-5e4c4eed0689_2448x1492.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9a730161-eb0a-483a-9e3e-5e4c4eed0689_2448x1492.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9a730161-eb0a-483a-9e3e-5e4c4eed0689_2448x1492.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9a730161-eb0a-483a-9e3e-5e4c4eed0689_2448x1492.png 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p>Kevin has written a book on the Battle of Midway, is the Executive Vice President of the Naval Aviation Museum, and is a former U.S. Navy Fighter Pilot. </p><p>He is exactly the person you want making an expert-led book recommendation about the Battle of Midway.</p><p><span>Since it was published, </span><strong>Kevin’s page has been in the top 3 results</strong><span> for Google searches related to the “best books on Battle of Midway.”</span></p><p><strong>…</strong></p><p><strong>Then Google 💩 the bed.</strong></p><p>….</p><p><strong>Kevin’s page now appears on the 3rd page, or not at all, for all searches.</strong><span> </span></p><p>How does Kevin’s page engage readers?</p><ul><li><p><span>On average, visitors spend 7 minutes and 16 seconds on his page (</span><em>the real number is higher as this only updates if an action is triggered</em><span>). And 55% of visitors read to the 75% mark or more. </span></p></li><li><p><span>15% of visitors click to explore a book or go to a bookstore (</span><em>to learn more about a specific book</em><span>). This is a very good sign that the reader found something that intrigued them. </span></p></li><li><p>15% of visitors go within Shepherd to a related topic, genre, or book on this page. </p></li><li><p>7.5% of visitors check out a recommended list at the bottom of the page or related topic. </p></li></ul><p><strong>My point is that this page crushes it for a large chunk of readers who are looking for an answer to their query on Google. </strong><span>And even worse, what Google is ranking instead is not great… </span></p><p>The page ranking #2 is one I created to test how badly Google is 💩 the bed. </p><p><span>It is </span><a href="https://bookshop.org/lists/the-best-books-about-the-battle-of-midway" rel="">a list I created on Bookshop.org that has 4 books</a><span>, no personal details, no expertise, and nothing of value. It even links to Kevin’s list on Shepherd since it is a terrible derivative of that list. </span></p><div><figure><a target="_blank" href="https://bookshop.org/lists/the-best-books-about-the-battle-of-midway" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F233954df-7670-4fe9-8088-d459d01daca2_1578x316.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F233954df-7670-4fe9-8088-d459d01daca2_1578x316.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F233954df-7670-4fe9-8088-d459d01daca2_1578x316.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F233954df-7670-4fe9-8088-d459d01daca2_1578x316.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F233954df-7670-4fe9-8088-d459d01daca2_1578x316.png" width="591" height="118.52472527472527" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/233954df-7670-4fe9-8088-d459d01daca2_1578x316.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:292,&quot;width&quot;:1456,&quot;resizeWidth&quot;:591,&quot;bytes&quot;:144903,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:&quot;https://bookshop.org/lists/the-best-books-about-the-battle-of-midway&quot;,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F233954df-7670-4fe9-8088-d459d01daca2_1578x316.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F233954df-7670-4fe9-8088-d459d01daca2_1578x316.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F233954df-7670-4fe9-8088-d459d01daca2_1578x316.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F233954df-7670-4fe9-8088-d459d01daca2_1578x316.png 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><ul><li><p><span>There is </span><a href="https://www.goodreads.com/shelf/show/battle-of-midway" rel="">a Goodreads list of all books tagged Battle of Midway</a><span>. They are not sorted by rating, and there is no expert explaining why they are a good resource. It is not the worst list, I guess, but it is just a collection of the 100 books on the battle that Goodreads has in their database. </span></p></li><li><p><a href="https://www.reddit.com/r/WarCollege/comments/nrean5/ive_taken_an_interest_in_the_battle_of_midway/" rel="">A 3-year-old Reddit thread</a><span> with only one book recommendation. I generally like Reddit, but this thread isn’t very helpful. </span></p></li><li><p><a href="https://store.pacificwarmuseum.org/products/shattered-sword-the-untold-story-of-the-battle-of-midway" rel="">A Museum e-commerce page selling a book about the battle for $35 dollar</a><span>s. There is zero curation, and it just has the default book description. </span></p></li><li><p><a href="https://www.quora.com/What-is-a-good-book-on-the-Battle-of-Midway-What-was-it-like-to-be-in-a-B-17-during-WWII-Why-weren-t-we-able-to-stop-Japan-from-attacking-us-at-Pearl-Harbor" rel="">A Quora post with only 2 answers</a><span>. The first answer recommends a single book, and the other answer can only be viewed if you pay for Quora Plus. </span></p></li><li><p>Google’s book widget, which shows book covers that match the topic? Wee! Zero curation or expertise or usefulness. </p></li><li><p>An Amazon link to a single book about the Battle of Midway. How is that helpful? </p></li><li><p><a href="https://www.goodreads.com/shelf/show/midway" rel="">Another Goodreads list with 829 books about “Midway.</a><span>” The 3rd book recommended is Dune, and the fourth is Little Women. Is that helpful?</span></p></li><li><p><span>This is a&nbsp;</span><a href="http://www.midway42.org/Library.aspx" rel="">decent result from the Midway Library</a><span>&nbsp;(</span><em>except it hasn’t been updated since 2016</em><span>). However, they do have some good recommendations and are curated by experts (</span><em>although I am not sure who</em><span>). The collection also movies and other media.</span></p></li><li><p><span>A 2010 post on a </span><a href="https://boardgamegeek.com/thread/509817/looking-for-a-good-book-on-the-battle-of-midway" rel="">Board Game forum</a><span> asking for good books about the Battle of Midway. Really Google? </span></p></li><li><p>A B&amp;N link to a single book about the Battle of Midway. </p></li></ul><p><strong>My point is that Google has elevated bad results that do not help users and buried independent websites like ourselves. </strong></p><p><span>In many cases, we are seeing websites that have served visitors for years lose 95%+ of their traffic from Google and not even rank for their brand name. This is a shadow ban where something in Google’s system has effectively blocked that website from existing. </span><strong>Google refuses to acknowledge it is happening or speak about it.</strong><span> </span></p><p>Meanwhile, search engines like DuckDuckGo and Bing rank Kevin’s page in the #1 and #3 spot, as they should. </p><p><span>I am lucky because while Google Search is breaking, I am receiving increasing traffic from Bing, DuckDuckGo, social media, and other sources. That has allowed us to stay alive along with the support of our Founding Members (</span><em>who financially support the website for the long term</em><span>). </span></p><p><strong>I have many friends and acquaintances who are going bankrupt and shutting down fantastic independently run websites. It is sad to see.</strong><span> </span></p><p>The independent web is in danger, and Google is destroying it. </p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb8a7859e-8434-4427-9216-17c77eb50565_500x500.webp" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb8a7859e-8434-4427-9216-17c77eb50565_500x500.webp 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb8a7859e-8434-4427-9216-17c77eb50565_500x500.webp 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb8a7859e-8434-4427-9216-17c77eb50565_500x500.webp 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb8a7859e-8434-4427-9216-17c77eb50565_500x500.webp 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb8a7859e-8434-4427-9216-17c77eb50565_500x500.webp" width="390" height="390" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/b8a7859e-8434-4427-9216-17c77eb50565_500x500.webp&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:500,&quot;width&quot;:500,&quot;resizeWidth&quot;:390,&quot;bytes&quot;:475138,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:null,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb8a7859e-8434-4427-9216-17c77eb50565_500x500.webp 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb8a7859e-8434-4427-9216-17c77eb50565_500x500.webp 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb8a7859e-8434-4427-9216-17c77eb50565_500x500.webp 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb8a7859e-8434-4427-9216-17c77eb50565_500x500.webp 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p>I used to love Google. </p><p>It was magic compared to Altavista. </p><p>I could type in what I wanted, and you would return a result that was what I wanted. At the very least, I had to try a few results before finding what I was specifically looking for.  </p><p><span>Now, it is just a wall of ads, unhelpful results, spam from big publishers like Forbes, and Reddit (</span><em>I like Reddit, but you do have to vet them still</em><span>).  I won’t even mention the AI overviews… which could be useful but are instead plastered on every surface you can find. </span></p><p><strong>Google, you have to fix search so it works again.</strong><span> </span></p><p><span>It has gotten so bad I moved to the </span><a href="https://kagi.com/" rel="">Kagi search engine</a><span>, and my wife switched to using ChatGPT 75% of the time. </span></p><p><span>Google has released several core updates since this started, </span><strong>and not a single website has really recovered.</strong><span> </span></p><p><span>It has also not provided </span><strong>enough good</strong><span> information about what is going on. Google has search liaisons who are amazing human beings, but they seem unable to share real information or help anyone. They just say the same corporate speak without saying much of anything. </span></p><ul><li><p><span>Dear&nbsp;</span><a href="https://twitter.com/JohnMu" rel="">John Mu</a><span>&nbsp;and&nbsp;</span><a href="https://x.com/dannysullivan?lang=en" rel="">Danny Sullivan</a><span>&nbsp;(</span><a href="https://x.com/searchliaison" rel="">work</a><span>), I have to do a shot of Tequilla every time you say, “</span><em>Just make good content,</em><span>” so please stop; I am begging you… Please provide real information and help the website owners you are destroying. I know you want to, as you are both amazing people. </span></p></li></ul><p><strong>Other ideas:</strong></p><ul><li><p>I’d love to see a partner program where Google has website owners embed code on their websites to pull in anonymous data about engagement so they can better reward good websites. I HATE spam and SEO spam, and I think this could help fix the problem. Google has something similar on YouTube, given their control of that platform, and I think this could work by helping them identify who wants to build a better web. </p></li><li><p>Build real help into GSC. Tell website owners what needs to be improved and why. Why are you hiding this information behind a mysterious black box? </p></li></ul><p>I put off writing this because I am not the best writer. </p><ul><li><p><a href="https://housefresh.com/david-vs-digital-goliaths/" rel="">HouseFresh explains how Google is killing independent websites like theirs</a><span>. This one is especially important as it shows how spam now ranks above them. </span></p></li><li><p><a href="https://retrododo.com/google-is-killing-retro-dodo/" rel="">Here is how Google killed RetroDodo</a><span>, which is one of the best retro video gaming websites on the net. </span></p></li><li><p><a href="https://healthyframework.com/an-open-letter-to-google-from-a-small-publisher/" rel="">Healthy Framework explains how Google is breaking the web</a><span> and why soon, nothing will be left but spam and Reddit.&nbsp;</span><a href="https://healthyframework.com/why-googles-dismissal-of-niche-experts-is-getting-da" rel="">Make sure you read part 2 to see how this is getting dangerous</a><span>. </span></p></li><li><p><a href="https://www.replayjutsu.com/how-google-updates-have-destroyed-many-gaming-and-entertainment-websites/" rel="">And a summary from RePlay on how Google has destroyed an entire swath of websites</a><span>. </span></p></li><li><p><a href="https://readysteadycut.com/2024/10/28/google-destroyed-ready-steady-cut/" rel="">A great overview of the pain Ready Steady Cut is in as well as other sites. </a></p></li><li><p><a href="https://rutledgedaugette.com/2024/10/28/the-notes-i-sent-to-google-before-the-october-2024-web-creator-conversation/" rel="">A fantastic set of notes that Rutledge sent Google before the Oct 28/29 creator summit that Google is throwing</a><span>. </span></p></li><li><p><a href="https://mike-hardaker.com/f/how-googles-updates-brought-out-my-insecurities-from-high-school" rel="">Mike’s post about Google destroying a 17-year-old outdoor website that is his life</a><span>. </span></p></li></ul><p>I have a lot more, but those are the best overviews of the damage Google is doing. </p><div id="youtube2-uSGVk2KVokQ" data-attrs="{&quot;videoId&quot;:&quot;uSGVk2KVokQ&quot;,&quot;startTime&quot;:null,&quot;endTime&quot;:null}" data-component-name="Youtube2ToDOM"><p><iframe src="https://www.youtube-nocookie.com/embed/uSGVk2KVokQ?rel=0&amp;autoplay=0&amp;showinfo=0&amp;enablejsapi=0" frameborder="0" loading="lazy" gesture="media" allow="autoplay; fullscreen" allowautoplay="true" allowfullscreen="true" width="728" height="409"></iframe></p></div><p><span>Thanks for listening Google, </span><br><span>Ben Fox (founder of Shepherd and inarticulate clown)</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb18dffe9-c855-40c4-b17f-03d202a769bd_500x667.jpeg" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb18dffe9-c855-40c4-b17f-03d202a769bd_500x667.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb18dffe9-c855-40c4-b17f-03d202a769bd_500x667.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb18dffe9-c855-40c4-b17f-03d202a769bd_500x667.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb18dffe9-c855-40c4-b17f-03d202a769bd_500x667.jpeg 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb18dffe9-c855-40c4-b17f-03d202a769bd_500x667.jpeg" width="274" height="365.516" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/b18dffe9-c855-40c4-b17f-03d202a769bd_500x667.jpeg&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:667,&quot;width&quot;:500,&quot;resizeWidth&quot;:274,&quot;bytes&quot;:76296,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/jpeg&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null,&quot;isProcessing&quot;:false}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb18dffe9-c855-40c4-b17f-03d202a769bd_500x667.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb18dffe9-c855-40c4-b17f-03d202a769bd_500x667.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb18dffe9-c855-40c4-b17f-03d202a769bd_500x667.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fb18dffe9-c855-40c4-b17f-03d202a769bd_500x667.jpeg 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Chain-of-Thought Can Hurt Performance on Tasks Where Thinking Makes Humans Worse (244 pts)]]></title>
            <link>https://arxiv.org/abs/2410.21333</link>
            <guid>41999340</guid>
            <pubDate>Wed, 30 Oct 2024 19:42:41 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://arxiv.org/abs/2410.21333">https://arxiv.org/abs/2410.21333</a>, See on <a href="https://news.ycombinator.com/item?id=41999340">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="content-inner">
    
    
                
    <p><a href="https://arxiv.org/pdf/2410.21333">View PDF</a>
    <a href="https://arxiv.org/html/2410.21333v1">HTML (experimental)</a></p><blockquote>
            <span>Abstract:</span>Chain-of-thought (CoT) prompting has become a widely used strategy for working with large language and multimodal models. While CoT has been shown to improve performance across many tasks, determining the settings in which it is effective remains an ongoing effort. In particular, it is still an open question in what settings CoT systematically reduces model performance. In this paper, we seek to identify the characteristics of tasks where CoT reduces performance by drawing inspiration from cognitive psychology, looking at cases where (i) verbal thinking or deliberation hurts performance in humans, and (ii) the constraints governing human performance generalize to language models. Three such cases are implicit statistical learning, visual recognition, and classifying with patterns containing exceptions. In extensive experiments across all three settings, we find that a diverse collection of state-of-the-art models exhibit significant drop-offs in performance (e.g., up to 36.3% absolute accuracy for OpenAI o1-preview compared to GPT-4o) when using inference-time reasoning compared to zero-shot counterparts. We also identify three tasks that satisfy condition (i) but not (ii), and find that while verbal thinking reduces human performance in these tasks, CoT retains or increases model performance. Overall, our results show that while there is not an exact parallel between the cognitive processes of models and those of humans, considering cases where thinking has negative consequences for human performance can help us identify settings where it negatively impacts models. By connecting the literature on human deliberation with evaluations of CoT, we offer a new tool that can be used in understanding the impact of prompt choices and inference-time reasoning.
    </blockquote>

    <!--CONTEXT-->
    
  </div><div>
      <h2>Submission history</h2><p> From: Ryan Liu [<a href="https://arxiv.org/show-email/2af21f3d/2410.21333">view email</a>]      <br>    <strong>[v1]</strong>
        Sun, 27 Oct 2024 18:30:41 UTC (2,612 KB)<br>
</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Steam games will need to disclose kernel-level anti-cheat on store pages (665 pts)]]></title>
            <link>https://www.gamingonlinux.com/2024/10/steam-games-will-now-need-to-fully-disclose-kernel-level-anti-cheat-on-store-pages/</link>
            <guid>41999314</guid>
            <pubDate>Wed, 30 Oct 2024 19:39:59 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.gamingonlinux.com/2024/10/steam-games-will-now-need-to-fully-disclose-kernel-level-anti-cheat-on-store-pages/">https://www.gamingonlinux.com/2024/10/steam-games-will-now-need-to-fully-disclose-kernel-level-anti-cheat-on-store-pages/</a>, See on <a href="https://news.ycombinator.com/item?id=41999314">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
						<p>Valve announced a change for Steam today that will make things a lot clearer for everyone, as developers will now need to clearly list the kernel-level anti-cheat used on Steam store pages.</p>

<p>In the Steamworks Developer <a href="https://steamcommunity.com/groups/steamworks/announcements/detail/4547038620960934857?snr=2___" rel="noopener nofollow" target="_blank">post</a> Valve said: "We've heard from more and more developers recently that they're looking for the right way to share anti-cheat information about their game with players. At the same time, players have been requesting more transparency around the anti-cheat services used in games, as well as the existence of any additional software that will be installed within the game."</p>

<p>Developers with games already on Steam will also need to do this, as it's not just for new games coming up for release, and it is also part of the release process now too. So Valve will be doing checks on games to ensure the notices are there and correct.</p>

<p>However, it's only being <em>forced</em> for kernel-level anti-cheat. If it's only client-side or server-side, it's <em>optional</em>, but Valve say "we generally think that any game that makes use of anti-cheat technology would benefit from letting players know".</p>

<p>Valve's example pictured below:</p>

<p><img src="https://uploads.golmedia.net/uploads/articles/article_media/7927772011730316555gol1.png"></p>
						<p><span>Article taken from <a href="https://www.gamingonlinux.com/">GamingOnLinux.com.</a></span>
						
					</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[DeepSeek v2.5 – open-source LLM comparable to GPT-4, but 95% less expensive (162 pts)]]></title>
            <link>https://www.deepseek.com/</link>
            <guid>41999151</guid>
            <pubDate>Wed, 30 Oct 2024 19:24:21 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.deepseek.com/">https://www.deepseek.com/</a>, See on <a href="https://news.ycombinator.com/item?id=41999151">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><div><div><div><p>DeepSeek-V2.5 Capabilities</p><p>DeepSeek-V2.5 delivers impressive results on current major large model leaderboards.</p><div><div><p>Places top 3 in AlignBench</p><p>Surpassing GPT-4 and close to GPT-4-Turbo</p></div><div><p>Ranks top-tier in MT-Bench</p><p>Rivaling LLaMA3-70B and outperforming Mixtral 8x22B</p></div><div><p>Specializes in math, code and reasoning</p></div><div><p>The open-source model and API support 128K context length</p></div></div></div><div><table><tbody><tr><th></th><th rowspan="2">Open source</th><th>Chinese General</th><th>English General</th><th>Knowledge</th><th>Arithmetic</th><th>Math</th><th>Reasoning</th><th>Coding</th></tr><tr><th></th><th>AlignBench</th><th>MT-Bench</th><th>MMLU</th><th>GSM8K</th><th>MATH</th><th>BBH</th><th>HumanEval</th></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DeepSeek-V2.5</td><td>Yes</td><td>8.04</td><td>9.02</td><td>80.4</td><td>95.1</td><td>74.7</td><td>84.3</td><td>89.0</td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>DeepSeek-V2</td><td>Yes</td><td>7.89</td><td>8.85</td><td>80.6</td><td>94.8</td><td>71.0</td><td>83.4</td><td>84.8</td></tr><tr><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td></tr><tr><td>GPT-4-Turbo-1106</td><td>-</td><td>8.01</td><td>9.32</td><td>84.6</td><td>93.0</td><td>64.1</td><td>-</td><td>82.2</td></tr><tr><td>GPT-4-0613</td><td>-</td><td>7.53</td><td>8.96</td><td>86.4</td><td>92.0</td><td>52.9</td><td>83.1</td><td>84.1</td></tr><tr><td>GPT-3.5</td><td>-</td><td>6.08</td><td>8.21</td><td>70.0</td><td>57.1</td><td>34.1</td><td>66.6</td><td>48.1</td></tr><tr><td>Gemini1.5 Pro</td><td>-</td><td>7.33</td><td>8.93</td><td>81.9</td><td>91.7</td><td>58.5</td><td>84.0</td><td>71.9</td></tr><tr><td>Claude3 Opus</td><td>-</td><td>7.62</td><td>9.00</td><td>86.8</td><td>95.0</td><td>61.0</td><td>86.8</td><td>84.9</td></tr><tr><td>Claude3 Sonnet</td><td>-</td><td>6.70</td><td>8.47</td><td>79.0</td><td>92.3</td><td>40.5</td><td>82.9</td><td>73.0</td></tr><tr><td>Claude3 Haiku</td><td>-</td><td>6.42</td><td>8.39</td><td>75.2</td><td>88.9</td><td>40.9</td><td>73.7</td><td>75.9</td></tr><tr><td>abab-6.5</td><td>-</td><td>7.97</td><td>8.82</td><td>79.5</td><td>91.7</td><td>51.4</td><td>82.0</td><td>78.0</td></tr><tr><td>abab-6.5s</td><td>-</td><td>7.34</td><td>8.69</td><td>74.6</td><td>87.3</td><td>42.0</td><td>76.8</td><td>68.3</td></tr><tr><td>ERNIE-4.0</td><td>-</td><td>7.89</td><td>7.69</td><td>-</td><td>91.3</td><td>52.2</td><td>-</td><td>72.0</td></tr><tr><td>GLM-4</td><td>-</td><td>7.88</td><td>8.60</td><td>81.5</td><td>87.6</td><td>47.9</td><td>82.3</td><td>72.0</td></tr><tr><td>Moonshot-v1</td><td>-</td><td>7.22</td><td>8.59</td><td>-</td><td>89.5</td><td>44.2</td><td>-</td><td>82.9</td></tr><tr><td>Baichuan 3</td><td>-</td><td>-</td><td>8.70</td><td>81.7</td><td>88.2</td><td>49.2</td><td>84.5</td><td>70.1</td></tr><tr><td>Qwen1.5 72B</td><td>Yes</td><td>7.19</td><td>8.61</td><td>76.2</td><td>81.9</td><td>40.6</td><td>65.9</td><td>68.9</td></tr><tr><td>LLaMA 3 70B</td><td>Yes</td><td>7.42</td><td>8.95</td><td>80.3</td><td>93.2</td><td>48.5</td><td>80.1</td><td>76.2</td></tr><tr><td>Mixtral 8x22B</td><td>Yes</td><td>6.49</td><td>8.66</td><td>77.8</td><td>87.9</td><td>49.8</td><td>78.4</td><td>75.0</td></tr></tbody></table></div></div><div><p>DeepSeek API Pricing</p><div><div><p>Per <span>Million</span> Input Tokens</p><p><span>0.14</span><span>$</span></p></div><div><p>Per <span>Million</span> Output Tokens</p><p><span>0.28</span><span>$</span></p></div></div></div></div><section><p>Why DeepSeek?</p><a href="https://platform.deepseek.com/" target="_blank">API Access<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><defs><clipPath id="clip812_775"><rect id="jiantou-9" width="24.000000" height="24.000000" transform="translate(0.000000 -0.255859)"></rect></clipPath></defs><g clip-path="url(#clip812_775)"><path id="path" d="M19.99 12.29L15.62 8.17C15.61 8.16 15.6 8.14 15.58 8.13C15.35 7.93 14.98 7.95 14.78 8.19C14.58 8.43 14.6 8.79 14.84 9L18.16 12.13L3.53 12.13C3.24 12.14 3.01 12.38 3 12.66C2.97 12.97 3.21 13.25 3.53 13.26L19.29 13.26C19.32 13.26 19.34 13.26 19.37 13.26C19.4 13.26 19.44 13.25 19.46 13.25C19.51 13.26 19.55 13.26 19.59 13.26C19.75 13.26 19.89 13.2 20 13.08C20.23 12.86 20.22 12.5 19.99 12.29Z" fill="currentColor" fill-rule="nonzero"></path></g></svg></a><div><div><p><span>236B parameters</span><br><span>128K context (API)</span><br></p><p>Capable</p></div><div><p><span>$0.14/M</span><span> input tokens</span><br><span>$0.28/M</span><span> output tokens</span><br></p></div><div><p><span>Compatible with</span><br><span>OpenAI API</span><br></p><p>Seamless</p></div></div></section><div><p><img alt="DeepSeek Logo" loading="lazy" width="780" height="165" decoding="async" data-nimg="1" srcset="https://www.deepseek.com/_next/image?url=https%3A%2F%2Fcdn.deepseek.com%2Flogo.png&amp;w=828&amp;q=75 1x, https://www.deepseek.com/_next/image?url=https%3A%2F%2Fcdn.deepseek.com%2Flogo.png&amp;w=1920&amp;q=75 2x" src="https://www.deepseek.com/_next/image?url=https%3A%2F%2Fcdn.deepseek.com%2Flogo.png&amp;w=1920&amp;q=75"></p></div></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Google's TOS doesn't eliminate a user's Fourth Amendment rights, judge rules [pdf] (321 pts)]]></title>
            <link>https://ww3.ca2.uscourts.gov/decisions/isysquery/0814a460-fe8f-42ef-9e82-cf94f952eb28/1/doc/23-6181_opn.pdf</link>
            <guid>41998891</guid>
            <pubDate>Wed, 30 Oct 2024 18:58:48 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://ww3.ca2.uscourts.gov/decisions/isysquery/0814a460-fe8f-42ef-9e82-cf94f952eb28/1/doc/23-6181_opn.pdf">https://ww3.ca2.uscourts.gov/decisions/isysquery/0814a460-fe8f-42ef-9e82-cf94f952eb28/1/doc/23-6181_opn.pdf</a>, See on <a href="https://news.ycombinator.com/item?id=41998891">Hacker News</a></p>
&lt;Not HTML&gt;]]></description>
        </item>
        <item>
            <title><![CDATA[Crafting Painterly Shaders (164 pts)]]></title>
            <link>https://blog.maximeheckel.com/posts/on-crafting-painterly-shaders/</link>
            <guid>41998319</guid>
            <pubDate>Wed, 30 Oct 2024 18:05:23 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://blog.maximeheckel.com/posts/on-crafting-painterly-shaders/">https://blog.maximeheckel.com/posts/on-crafting-painterly-shaders/</a>, See on <a href="https://news.ycombinator.com/item?id=41998319">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><p>October 29, 2024<!-- --> /<!-- --> <!-- -->35 min read</p><p><span>Last Updated:<!-- --> <!-- -->October 29, 2024</span></p></div><div><p>Writing a shader that can reproduce the look and feel of aquarelle, watercolor, or gouache to obtain a more <em>painterly</em>
output for my WebGL scenes has always been a long-term goal of mine.
Inspired by the work of very talented 3D artists such
as <a href="https://twitter.com/simonxxoo">@simonxxoo</a> or <a href="https://twitter.com/arpeegee">@arpeegee</a>, the contrast between paintings and the added dimension allowed by 3D renderers
was always very appealing to me. On top of that, my recent work with <a href="https://blog.maximeheckel.com/posts/moebius-style-post-processing/">stylized
shaders to mimic the hand-drawn Moebius art
style</a> emphasized not only that obtaining such stylized output was possible but also that post-processing
was more likely than not the key to emulating any artistic style.</p>
<p>After several months of on/off research that frankly was not leading to much, I stumbled upon a smoothing filter I never heard about before: the <strong>Kuwahara filter</strong>. Lucky for me, it turned out that many (very smart) people published papers about it and its ability to transform any image input into a painting-like work of art. By implementing it into a custom post-processing pass and going through many ups and downs in the process, I got very close to my original objective by building what is essentially <strong>a real-time 3D painting running in the browser</strong>:</p>
<figure></figure>
<p>This article is the culmination of months of work, trial and error, and research to <strong>craft the perfect painterly shader</strong> for your next WebGL project. In it, we will deep dive into <strong>the characteristics of the Kuwahara filter</strong> that make it so great at transforming our work into paintings, as well as look
into several techniques highlighted in the many papers I read to improve the original implementation and have it return <strong>a sharper, and more anisotropic output</strong>. Finally, we'll go through a bit of color correction and the use of textures to achieve a satisfying and accurate painting effect.</p>


<section id="painterly-post-processing-with-the-kuwahara-filter-section"><h2 id="painterly-post-processing-with-the-kuwahara-filter">Painterly post-processing with the Kuwahara filter</h2><p>Up until then, my only attempts at painterly shader consisted of several implementations of custom materials focused on emulating specific aspects of paint that I instinctively listed as <em>essential</em> to get a convincing output:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>The absence of texture/normal detail</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Preserved edges</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Quantized colors</p></li>
</ul><p>Below is an example of one of my "best" iterations from that exploratory work. It notably uses a Voronoi noise to <em>smudge normals</em> and a paintbrush texture for a more realistic look and feel.</p><p>However, despite my best efforts, this work was dead in the water as my implementation was severely flawed and only worked with a subset of meshes. From then on, I knew I had to go the post-processing route to solve most of those issues, but I didn't know how. Then, one day, I stumbled upon the beautiful work of <a href="https://twitter.com/arpeegee">@arpeegee</a>, who gave me the keywords I was missing all this time: <strong>Kuwahara filter</strong>.</p><div><div><div><p><a href="https://twitter.com/arpeegee" target="_blank" rel="noopener noreferrer"><span><span></span><img alt="arpeegee" loading="lazy" decoding="async" data-nimg="intrinsic" srcset="https://blog.maximeheckel.com/_next/image/?url=https%3A%2F%2Fpbs.twimg.com%2Fprofile_images%2F1794873330731716608%2FpNEFvCgN_normal.jpg&amp;w=48&amp;q=75 1x, https://blog.maximeheckel.com/_next/image/?url=https%3A%2F%2Fpbs.twimg.com%2Fprofile_images%2F1794873330731716608%2FpNEFvCgN_normal.jpg&amp;w=96&amp;q=75 2x" src="https://blog.maximeheckel.com/_next/image/?url=https%3A%2F%2Fpbs.twimg.com%2Fprofile_images%2F1794873330731716608%2FpNEFvCgN_normal.jpg&amp;w=96&amp;q=75" data-old-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></span></a></p></div><a href="https://twitter.com/arpeegee/status/1825974541958422592" target="_blank" rel="noopener noreferrer" aria-label="@arpeegee's Twitter profile"><svg viewBox="328 355 335 276" height="24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M 630, 425    A 195, 195 0 0 1 331, 600    A 142, 142 0 0 0 428, 570    A  70,  70 0 0 1 370, 523    A  70,  70 0 0 0 401, 521    A  70,  70 0 0 1 344, 455    A  70,  70 0 0 0 372, 460    A  70,  70 0 0 1 354, 370    A 195, 195 0 0 0 495, 442    A  67,  67 0 0 1 611, 380    A 117, 117 0 0 0 654, 363    A  65,  65 0 0 1 623, 401    A 117, 117 0 0 0 662, 390    A  65,  65 0 0 1 630, 425    Z" style="fill:#3BA9EE"></path></svg></a></div><p>I'm done with this one! Learned a lot in the process 😌
Blender / Cycles https://t.co/VCkYOJeBNw</p><div><p><span><span></span><img alt="I'm done with this one! Learned a lot in the process 😌
Blender / Cycles https://t.co/VCkYOJeBNw" loading="lazy" decoding="async" data-nimg="intrinsic" srcset="https://blog.maximeheckel.com/_next/image/?url=https%3A%2F%2Fpbs.twimg.com%2Fmedia%2FGVcppXpW4AAkPpT.jpg&amp;w=1920&amp;q=75 1x, https://blog.maximeheckel.com/_next/image/?url=https%3A%2F%2Fpbs.twimg.com%2Fmedia%2FGVcppXpW4AAkPpT.jpg&amp;w=3840&amp;q=75 2x" src="https://blog.maximeheckel.com/_next/image/?url=https%3A%2F%2Fpbs.twimg.com%2Fmedia%2FGVcppXpW4AAkPpT.jpg&amp;w=3840&amp;q=75" data-old-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></span></p><p><span><span></span><img alt="I'm done with this one! Learned a lot in the process 😌
Blender / Cycles https://t.co/VCkYOJeBNw" loading="lazy" decoding="async" data-nimg="intrinsic" srcset="https://blog.maximeheckel.com/_next/image/?url=https%3A%2F%2Fpbs.twimg.com%2Fmedia%2FGVcppXsWIAABPym.jpg&amp;w=1920&amp;q=75 1x, https://blog.maximeheckel.com/_next/image/?url=https%3A%2F%2Fpbs.twimg.com%2Fmedia%2FGVcppXsWIAABPym.jpg&amp;w=3840&amp;q=75 2x" src="https://blog.maximeheckel.com/_next/image/?url=https%3A%2F%2Fpbs.twimg.com%2Fmedia%2FGVcppXsWIAABPym.jpg&amp;w=3840&amp;q=75" data-old-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></span></p></div></div><h3 id="characteristics-of-the-kuwahara-filter">Characteristics of the Kuwahara filter</h3><p>Originally intended to remove noise through smoothing from medical images, the Kuwahara filter is most commonly used today to transform any input into stylistic paintings through post-processing.</p><p>Unlike other smoothing filters that reduce noise but also, on the way, blur our edges, the Kuwahara filter is capable of preserving edges and corners. That specificity is what makes it so good at achieving painting-like artistic effects by getting us two crucial visual properties of paintings:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>The smoothing erases some of the texture details.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>The filter preserves the edges and, in some cases, increases the sharpness compared to the original input.</p></li>
</ul><p>It achieves this by executing the following steps on each pixel of our input, which in our case would be our underlying 3D scene:</p><ol>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We center a box around a pixel.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We divide the box into 4 "sub-boxes" or <strong>Sectors</strong>.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><strong>We calculate the average color and variance for each Sector</strong>.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We set our pixel to the average color of the Sector with the <strong>lowest variance</strong>.</p></li>
</ol><p>I built the widget below to visually represent those sectors surrounding a given pixel at work:</p><p>You can see by selecting the edge examples that:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>when a pixel sits just outside an edge, the Sector with the lowest variance will always be outside the edge</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>when a pixel sits just inside an edge, the Sector with the lowest variance will be inside the edge</p></li>
</ul><p>highlighting the <em>edge-preserving</em> capabilities of this filter.</p><p>The widget below showcases how this process of picking the average color of the Sector with the lowest variance impacts an entire image:</p><p>Notice how, with a reasonable kernel size, we maintain the overall shapes featured in the underlying image but erase many details like, in this case, transparency. However, we can also observe that with a higher kernel size, the image filter, unfortunately, falls apart and denatures quite drastically our input, indicating that we will have to strike the right balance between kernel size and the strength of our painterly post-processing effect.</p><h3 id="our-first-implementation-of-the-kuwahara-filter-as-a-post-processing-effect">Our first implementation of the Kuwahara filter as a post-processing effect</h3><p>Now that we have a good understanding of the inner workings of the Kuwahara filter, let's implement it as a post-processing effect on top of a React Three Fiber scene. Much like the work done in <a href="https://blog.maximeheckel.com/posts/moebius-style-post-processing/">Moebius-style post-processing and other stylized shaders</a>, we will define our custom post-processing pass using the <code>Pass</code> class from the <code>post-processing</code> package.</p><p>This post-processing pass will:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Take our underlying scene as an input.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Implement the Kuwahara filter in its fragment shader.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Output the resulting scene.</p></li>
</ul><p>The implementation of it in GLSL goes as follows:</p><div><div><p data-testid="codesnippet-title">Implementation of the Kuwahara filter in GLSL</p></div><pre><div data-testid="line"><p>4</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">uniform</span><span data-testid="content-line"> </span><span data-testid="content-line">sampler2D</span><span data-testid="content-line"> inputBuffer</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>5</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">uniform</span><span data-testid="content-line"> </span><span data-testid="content-line">vec4</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">uniform</span><span data-testid="content-line"> </span><span data-testid="content-line">sampler2D</span><span data-testid="content-line"> originalTexture</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">void</span><span data-testid="content-line"> </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">vec2</span><span data-testid="content-line"> offset</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">int</span><span data-testid="content-line"> boxSize</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">out</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> avgColor</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">out</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> variance</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> colorSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>12</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> squaredColorSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>13</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> sampleCount </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>16</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">int</span><span data-testid="content-line"> y </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">;</span><span data-testid="content-line"> y </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> boxSize</span><span data-testid="content-line">;</span><span data-testid="content-line"> y</span><span data-testid="content-line">++</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>17</p><p><span><span data-testid="content-line">        </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">int</span><span data-testid="content-line"> x </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">;</span><span data-testid="content-line"> x </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> boxSize</span><span data-testid="content-line">;</span><span data-testid="content-line"> x</span><span data-testid="content-line">++</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>18</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> sampleOffset </span><span data-testid="content-line">=</span><span data-testid="content-line"> offset </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">x</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">y</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>19</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sampleColor</span><span data-testid="content-line">(</span><span data-testid="content-line">sampleOffset</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>21</p><p><span><span data-testid="content-line">            squaredColorSum </span><span data-testid="content-line">+=</span><span data-testid="content-line"> color </span><span data-testid="content-line">*</span><span data-testid="content-line"> color</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>27</p><p><span><span data-testid="content-line">    avgColor </span><span data-testid="content-line">=</span><span data-testid="content-line"> colorSum </span><span data-testid="content-line">/</span><span data-testid="content-line"> sampleCount</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>28</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> varianceRes </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">squaredColorSum </span><span data-testid="content-line">/</span><span data-testid="content-line"> sampleCount</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">avgColor </span><span data-testid="content-line">*</span><span data-testid="content-line"> avgColor</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>29</p><p><span><span data-testid="content-line">    variance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">varianceRes</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.299</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.587</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.114</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>33</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> boxAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">SECTOR_COUNT</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>34</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> boxVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">SECTOR_COUNT</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>36</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">kernelSize</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">kernelSize</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> kernelSize</span><span data-testid="content-line">,</span><span data-testid="content-line"> boxAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line">,</span><span data-testid="content-line"> boxVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>37</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">kernelSize</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> kernelSize</span><span data-testid="content-line">,</span><span data-testid="content-line"> boxAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line">,</span><span data-testid="content-line"> boxVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>38</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">kernelSize</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> kernelSize</span><span data-testid="content-line">,</span><span data-testid="content-line"> boxAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line">,</span><span data-testid="content-line"> boxVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>39</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> kernelSize</span><span data-testid="content-line">,</span><span data-testid="content-line"> boxAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">3</span><span data-testid="content-line">]</span><span data-testid="content-line">,</span><span data-testid="content-line"> boxVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">3</span><span data-testid="content-line">]</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>41</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> minVariance </span><span data-testid="content-line">=</span><span data-testid="content-line"> boxVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>42</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> finalColor </span><span data-testid="content-line">=</span><span data-testid="content-line"> boxAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>44</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">int</span><span data-testid="content-line"> i </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">;</span><span data-testid="content-line"> i </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> SECTOR_COUNT</span><span data-testid="content-line">;</span><span data-testid="content-line"> i</span><span data-testid="content-line">++</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>45</p><p><span><span data-testid="content-line">        </span><span data-testid="content-line">if</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">boxVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">i</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> minVariance</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>46</p><p><span><span data-testid="content-line">            minVariance </span><span data-testid="content-line">=</span><span data-testid="content-line"> boxVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">i</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>47</p><p><span><span data-testid="content-line">            finalColor </span><span data-testid="content-line">=</span><span data-testid="content-line"> boxAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">i</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>51</p><p><span><span data-testid="content-line">    gl_FragColor </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec4</span><span data-testid="content-line">(</span><span data-testid="content-line">finalColor</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><p>In the code featured above, we can see that:</p><ol>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We're allocating an array of <code>vec3</code> and <code>float</code> to store the average color and variance for each of our Sectors, respectively.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We're computing those stats by sampling the color for every pixel in a given Sector along the x-axis and y-axis and calculating the average and variance using the formulas we saw in the previous part.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We then set <code>minVariance</code> and <code>finalColor</code> as the variance and average color of the first Sector by default.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We then loop through the other Sectors to find the Sector with the lowest variance and set its corresponding average color as the output of our fragment shader.</p></li>
</ol><p>Doing this will result in a version of our scene with fewer texture details while preserving the overall shape of our geometries and also introducing artifacts that <strong>look somewhat like brush strokes</strong>:</p></section>
<section id="the-papari-extension-section"><h2 id="the-papari-extension">The Papari extension</h2><p>Through our initial implementation of the Kuwahara filter as a custom post-processing pass, we already achieved a somewhat convincing paint effect. However, it suffers from several drawbacks at high kernel sizes that may make our underlying scene not discernable by the viewer, and the appearance of our "brush strokes" could most likely be improved.</p><p>Ideally, we could fix both these issues in one go by allowing larger kernel sizes for a more intense stylized effect for our scene and also have more natural-looking artifacts with a slight tweak of our Kuwahara filter. That is what Giuseppe Papari proposes in his paper <strong>Artistic Edge and Corner Enhancing Smoothing</strong>. In it, he presents an <em>extension</em> to the Kuwahara filter that:</p><ol>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Removes the square-shaped kernel in favor of a circular one.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Improves the weight influence that each pixel has on the filter.</p></li>
</ol><p>In this part, we will implement some of those improvements with an additional section on potential performance improvements. It may sound absurd but; I like my paintings to run as close to 60fps as possible.</p><h3 id="circular-kernel">Circular kernel</h3><p>A circular-shaped kernel allows us to increase the number of Sectors when evaluating the color of a given pixel. Its box-shaped counterpart can only allow for up to four Sectors making more complex edge lines not well-preserved. Through his experiments, Papari found that <em>eight Sectors</em> were the ideal amount to balance output quality and good performance.</p><figure><p><img alt="Diagram showcasing both box-shaped and circular kernels and highlighting which parts of the image are being smoothed while maintaining the sharpness of the edges." loading="lazy" width="700" height="323" decoding="async" data-nimg="1" sizes="100vw" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kernel_Comparison 640w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kernel_Comparison 750w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kernel_Comparison 828w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kernel_Comparison 1080w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kernel_Comparison 1200w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kernel_Comparison 1920w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kernel_Comparison 2048w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kernel_Comparison 3840w" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kernel_Comparison"></p><figcaption>Diagram showcasing both box-shaped and circular kernels and highlighting which parts of the image are being smoothed while maintaining the sharpness of the edges.</figcaption></figure><p>The widget below showcases the impact that this subtle modification in the implementation of our filter has on a simple image:</p><p>Here, we can see that, compared to what we observed in the first part, this version of the Kuwahara filter yields a way better output even at a larger kernel size! The circular shape and the higher number of Sectors allow us to preserve edge lines for more complex angles and patterns.</p><p>We can tweak the fragment shader code to implement Papari's circular kernel into our post-processing pass by modifying the parts that compute variance and average color by Sector:</p><div><div><p data-testid="codesnippet-title">Switching to a circular kernel in our Kuwahara filter implementation</p></div><pre><div data-testid="line"><p>3</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">void</span><span data-testid="content-line"> </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> angle</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> radius</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">out</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> avgColor</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">out</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> variance</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> colorSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>5</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> squaredColorSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> sampleCount </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>8</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> r </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">;</span><span data-testid="content-line"> r </span><span data-testid="content-line">&lt;=</span><span data-testid="content-line"> radius</span><span data-testid="content-line">;</span><span data-testid="content-line"> r </span><span data-testid="content-line">+=</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>9</p><p><span><span data-testid="content-line">        </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> a </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">0.392699</span><span data-testid="content-line">;</span><span data-testid="content-line"> a </span><span data-testid="content-line">&lt;=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.392699</span><span data-testid="content-line">;</span><span data-testid="content-line"> a </span><span data-testid="content-line">+=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.196349</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>10</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> sampleOffset </span><span data-testid="content-line">=</span><span data-testid="content-line"> r </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">cos</span><span data-testid="content-line">(</span><span data-testid="content-line">angle </span><span data-testid="content-line">+</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">sin</span><span data-testid="content-line">(</span><span data-testid="content-line">angle </span><span data-testid="content-line">+</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sampleColor</span><span data-testid="content-line">(</span><span data-testid="content-line">sampleOffset</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>13</p><p><span><span data-testid="content-line">            squaredColorSum </span><span data-testid="content-line">+=</span><span data-testid="content-line"> color </span><span data-testid="content-line">*</span><span data-testid="content-line"> color</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>19</p><p><span><span data-testid="content-line">    avgColor </span><span data-testid="content-line">=</span><span data-testid="content-line"> colorSum </span><span data-testid="content-line">/</span><span data-testid="content-line"> sampleCount</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>20</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> varianceRes </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">squaredColorSum </span><span data-testid="content-line">/</span><span data-testid="content-line"> sampleCount</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">avgColor </span><span data-testid="content-line">*</span><span data-testid="content-line"> avgColor</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>21</p><p><span><span data-testid="content-line">    variance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">varianceRes</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.299</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.587</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.114</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>26</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> sectorAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">SECTOR_COUNT</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>27</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> sectorVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">SECTOR_COUNT</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>29</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">int</span><span data-testid="content-line"> i </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">;</span><span data-testid="content-line"> i </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> SECTOR_COUNT</span><span data-testid="content-line">;</span><span data-testid="content-line"> i</span><span data-testid="content-line">++</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>30</p><p><span><span data-testid="content-line">      </span><span data-testid="content-line">float</span><span data-testid="content-line"> angle </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">i</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">6.28318</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">SECTOR_COUNT</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>31</p><p><span><span data-testid="content-line">      </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">angle</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">radius</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> sectorAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">i</span><span data-testid="content-line">]</span><span data-testid="content-line">,</span><span data-testid="content-line"> sectorVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">i</span><span data-testid="content-line">]</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><p>In the end, the filter's principle is roughly the same. What changes here is which pixel is picked for a given sector and included in the average and variance.</p><figure><p><img alt="Diagram showcasing how the sampling of a slice of the circular kernel is split." loading="lazy" width="700" height="430" decoding="async" data-nimg="1" sizes="100vw" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Circular_Kernel_Details 640w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Circular_Kernel_Details 750w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Circular_Kernel_Details 828w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Circular_Kernel_Details 1080w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Circular_Kernel_Details 1200w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Circular_Kernel_Details 1920w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Circular_Kernel_Details 2048w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Circular_Kernel_Details 3840w" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Circular_Kernel_Details"></p><figcaption>Diagram showcasing how the sampling of a slice of the circular kernel is split.</figcaption></figure><p>The demo below uses this extended version of the Kuwahara filter on top of our scene. It lets us use a larger kernel size, yielding a more stylized output while keeping our scene discernable:</p><h3 id="a-better-weighting-of-colors">A better weighting of colors</h3><p>The artifacts left by the filter are still quite visible at large kernel sizes. According to Papari's study, this effect is due to the <em>weighting</em> of the colors when calculating the average and the variance of a given Sector, as it does not discriminate any pixel. If a pixel is in a sector, it contributes the same amount to the calculations.</p><p>Using <strong>Gaussian weights</strong> fixes this issue:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>It provides a gradual fall-off from the center of the Sector to its edges.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>This results in more natural-looking transitions from one Sector to another, thus avoiding abrupt changes that would otherwise make those artifacts very visible.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>It <em>emphasizes</em> the central pixels more likely to represent the <strong>most accurate</strong> sector color, giving them more importance when calculating the average color.</p></li>
</ul><figure><p><img alt="Diagram comparing standard weighting vs Gaussian weighting. The darker the color of a pixel is, the 'heavier' the weight for said pixel is." loading="lazy" width="700" height="398" decoding="async" data-nimg="1" sizes="100vw" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Weighting_Comparison 640w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Weighting_Comparison 750w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Weighting_Comparison 828w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Weighting_Comparison 1080w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Weighting_Comparison 1200w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Weighting_Comparison 1920w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Weighting_Comparison 2048w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Weighting_Comparison 3840w" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Weighting_Comparison"></p><figcaption>Diagram comparing standard weighting vs Gaussian weighting. The darker the color of a pixel is, the 'heavier' the weight for said pixel is.</figcaption></figure><p>To use Gaussian weighting in our filter, we only need to change a few lines from the previous implementation:</p><div><div><p data-testid="codesnippet-title">Using Gaussian weighting in our Kuwahara filter implementation</p></div><pre><div data-testid="line"><p>3</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> </span><span data-testid="content-line">gaussianWeight</span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> distance</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> sigma</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">exp</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">(</span><span data-testid="content-line">distance </span><span data-testid="content-line">*</span><span data-testid="content-line"> distance</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">2.0</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> sigma </span><span data-testid="content-line">*</span><span data-testid="content-line"> sigma</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>7</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">void</span><span data-testid="content-line"> </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> angle</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> radius</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">out</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> avgColor</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">out</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> variance</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>8</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> weightedColorSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>9</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> weightedSquaredColorSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> totalWeight </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>12</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> sigma </span><span data-testid="content-line">=</span><span data-testid="content-line"> radius </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">3.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>14</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> r </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">;</span><span data-testid="content-line"> r </span><span data-testid="content-line">&lt;=</span><span data-testid="content-line"> radius</span><span data-testid="content-line">;</span><span data-testid="content-line"> r </span><span data-testid="content-line">+=</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>15</p><p><span><span data-testid="content-line">        </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> a </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">0.392699</span><span data-testid="content-line">;</span><span data-testid="content-line"> a </span><span data-testid="content-line">&lt;=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.392699</span><span data-testid="content-line">;</span><span data-testid="content-line"> a </span><span data-testid="content-line">+=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.196349</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>16</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> sampleOffset </span><span data-testid="content-line">=</span><span data-testid="content-line"> r </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">cos</span><span data-testid="content-line">(</span><span data-testid="content-line">angle </span><span data-testid="content-line">+</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">sin</span><span data-testid="content-line">(</span><span data-testid="content-line">angle </span><span data-testid="content-line">+</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>17</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sampleColor</span><span data-testid="content-line">(</span><span data-testid="content-line">sampleOffset</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>18</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">float</span><span data-testid="content-line"> weight </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">gaussianWeight</span><span data-testid="content-line">(</span><span data-testid="content-line">length</span><span data-testid="content-line">(</span><span data-testid="content-line">sampleOffset</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> sigma</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>20</p><p><span><span data-testid="content-line">            weightedColorSum </span><span data-testid="content-line">+=</span><span data-testid="content-line"> color </span><span data-testid="content-line">*</span><span data-testid="content-line"> weight</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>21</p><p><span><span data-testid="content-line">            weightedSquaredColorSum </span><span data-testid="content-line">+=</span><span data-testid="content-line"> color </span><span data-testid="content-line">*</span><span data-testid="content-line"> color </span><span data-testid="content-line">*</span><span data-testid="content-line"> weight</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>22</p><p><span><span data-testid="content-line">            totalWeight </span><span data-testid="content-line">+=</span><span data-testid="content-line"> weight</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>27</p><p><span><span data-testid="content-line">    avgColor </span><span data-testid="content-line">=</span><span data-testid="content-line"> weightedColorSum </span><span data-testid="content-line">/</span><span data-testid="content-line"> totalWeight</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>28</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> varianceRes </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">weightedSquaredColorSum </span><span data-testid="content-line">/</span><span data-testid="content-line"> totalWeight</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">avgColor </span><span data-testid="content-line">*</span><span data-testid="content-line"> avgColor</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>29</p><p><span><span data-testid="content-line">    variance </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">varianceRes</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.299</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.587</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.114</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"> </span><span data-testid="content-line"></span></span></p></div></pre></div><p>As we can see in the code snippet above:</p><ol>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We compute the weight using the Gaussian formula.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>We then take the resulting weight into account when calculating our <strong>weighted color sum</strong> and <strong>weighted squared color sum</strong>.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Those weights are then reflected in the final result of the variance and average color for each Sector.</p></li>
</ol><p>Now, you may wonder whether adding all those nitty-gritty improvements to a filter that already performed quite well is worth it. You can see the result for yourself in the comparison below between a frame of our first scene using the original implementation of the Kuwahara filter and one using the Papari extension:</p><figure><div tabindex="0" role="slider" aria-label="Comparing the output of our extended Kuwahara filter without and with Gaussian weighting." aria-valuemin="0" aria-valuemax="100" aria-valuenow="50"><p><img alt="Before" loading="eager" width="700" height="376" decoding="async" data-nimg="1" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Spaceship-before-gaussian_cfx1fy 1x, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Spaceship-before-gaussian_cfx1fy 2x" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Spaceship-before-gaussian_cfx1fy"></p><p><img alt="After" loading="eager" width="700" height="376" decoding="async" data-nimg="1" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Spaceship-after-gaussian_zphvl2 1x, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Spaceship-after-gaussian_zphvl2 2x" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Spaceship-after-gaussian_zphvl2"></p><div id="slider-line"><p><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" style="transform:rotate(180deg)"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></p></div></div><figcaption>Comparing the output of our extended Kuwahara filter without and with Gaussian weighting.</figcaption></figure><p>The result looks already better than previously, even at a low kernel size! Let's observe now the difference between both implementations for a higher value:</p><figure><div tabindex="0" role="slider" aria-label="Comparing the output of our extended Kuwahara filter without and with Gaussian weighting at a high kernel size." aria-valuemin="0" aria-valuemax="100" aria-valuenow="50"><p><img alt="Before" loading="eager" width="700" height="529" decoding="async" data-nimg="1" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Plant-before-gaussian_oqjiwu 1x, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Plant-before-gaussian_oqjiwu 2x" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Plant-before-gaussian_oqjiwu"></p><p><img alt="After" loading="eager" width="700" height="529" decoding="async" data-nimg="1" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Plant-after-gaussian_nsscnb 1x, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Plant-after-gaussian_nsscnb 2x" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Plant-after-gaussian_nsscnb"></p><div id="slider-line"><p><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" style="transform:rotate(180deg)"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></p></div></div><figcaption>Comparing the output of our extended Kuwahara filter without and with Gaussian weighting at a high kernel size.</figcaption></figure><h3 id="fixing-a-performance-pitfall">Fixing a performance pitfall</h3><p>The Gaussian function used to calculate the weights of our pixel is, unfortunately, quite expensive to run, even more so in all those nested loops necessary to sample each pixel of a given Sector. This improvement is costing us a lot of frames, and it would be very tempting to disregard it and revert to the original weighting method.</p><p>However, a team of <em>smart individuals</em> found a way to squeeze more performance out of the filter while maintaining the advantages given by the Gaussian. In <a href="https://www.umsl.edu/~kangh/Papers/kang-tpcg2010.pdf">Anisotropic Kuwahara Filtering with PolynomialWeighting Functions</a>, they propose to replace the Gaussian with a polynomial that roughly approximates it.</p><p><code>[(x + ζ) − ηy^2]^2</code></p><div><div><p data-testid="codesnippet-title">Using Polynomial weighting in our Kuwahara filter implementation</p></div><pre><div data-testid="line"><p>3</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> </span><span data-testid="content-line">polynomialWeight</span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> x</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> y</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> eta</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> lambda</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> polyValue </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">x </span><span data-testid="content-line">+</span><span data-testid="content-line"> eta</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> lambda </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">y </span><span data-testid="content-line">*</span><span data-testid="content-line"> y</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>5</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">max</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> polyValue </span><span data-testid="content-line">*</span><span data-testid="content-line"> polyValue</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>8</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">void</span><span data-testid="content-line"> </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> angle</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> radius</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">out</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> avgColor</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">out</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> variance</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>9</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> colorSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> squaredColorSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> weightSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>16</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> r </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">;</span><span data-testid="content-line"> r </span><span data-testid="content-line">&lt;=</span><span data-testid="content-line"> radius</span><span data-testid="content-line">;</span><span data-testid="content-line"> r </span><span data-testid="content-line">+=</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>17</p><p><span><span data-testid="content-line">        </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> a </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">0.392699</span><span data-testid="content-line">;</span><span data-testid="content-line"> a </span><span data-testid="content-line">&lt;=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.392699</span><span data-testid="content-line">;</span><span data-testid="content-line"> a </span><span data-testid="content-line">+=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.196349</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>19</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> sampleOffset </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">r </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">cos</span><span data-testid="content-line">(</span><span data-testid="content-line">angle </span><span data-testid="content-line">+</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> r </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">sin</span><span data-testid="content-line">(</span><span data-testid="content-line">angle </span><span data-testid="content-line">+</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>20</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sampleColor</span><span data-testid="content-line">(</span><span data-testid="content-line">sampleOffset</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>21</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">float</span><span data-testid="content-line"> weight </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">polynomialWeight</span><span data-testid="content-line">(</span><span data-testid="content-line">sampleOffset</span><span data-testid="content-line">.</span><span data-testid="content-line">x</span><span data-testid="content-line">,</span><span data-testid="content-line"> sampleOffset</span><span data-testid="content-line">.</span><span data-testid="content-line">y</span><span data-testid="content-line">,</span><span data-testid="content-line"> eta</span><span data-testid="content-line">,</span><span data-testid="content-line"> lambda</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><p>When trying out this formula, I noticed the performance improvements highlighted in the paper but also that I could get a satisfying output at a smaller kernel size compared to what we've implemented so far. I'm still not exactly sure why 🤷‍♂️, but I'll take it.</p></section>
<section id="from-structure-tensor-to-anisotropic-kuwahara-filter-section"><h2 id="from-structure-tensor-to-anisotropic-kuwahara-filter">From Structure Tensor to Anisotropic Kuwahara filter</h2><p>Papari's extension of the Kuwahara filter is already a step towards a lovely painterly shader, however, (I must sound like a broken record at this point) we still can perceive some artifacts left by the filter on the resulting scene. Indeed, the painting effect is applied indiscriminately to the input without any consideration for the overall structure of the current frame. In the case of a true painting, the artist would adapt the <em>flow of the brush</em> based on the direction of the edge. We're not getting this here.</p><p>Luckily, <a href="https://www.umsl.edu/~kangh/Papers/kang-tpcg2010.pdf">Anisotropic Kuwahara Filtering with PolynomialWeighting Functions</a> answers this problem by building upon the concepts of the extended Kuwahara filter we just saw.</p><p>In this paper, the authors suggest that we could adapt our circular kernel to the local features of the input during sampling by <strong>squeezing</strong> and <strong>rotating</strong> it, thus letting us sample our Sectors more accurately. As a result, our kernel would look more like an ellipsis rather than a circle.</p><figure><p><img alt="Diagram comparing isotropic kernels vs anisotropic kernels." loading="lazy" width="700" height="382" decoding="async" data-nimg="1" sizes="100vw" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Anisotropic_Kernel 640w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Anisotropic_Kernel 750w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Anisotropic_Kernel 828w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Anisotropic_Kernel 1080w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Anisotropic_Kernel 1200w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Anisotropic_Kernel 1920w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Anisotropic_Kernel 2048w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Anisotropic_Kernel 3840w" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Anisotropic_Kernel"></p><figcaption>Diagram comparing isotropic kernels vs anisotropic kernels.</figcaption></figure><p>Implementing this improvement will require us to follow several steps and make our post-processing effect <strong>multi-pass</strong>:</p><ol>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>The first pass will take the underlying scene as input and return the <strong>structure of the scene</strong>.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Then based on this structure as input we'll apply our Kuwahara filter to the underlying scene.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Finally, we'll add one extra pass to apply some tone mapping and other details that will make our painterly shader shine.</p></li>
</ol><div data-fullbleed="true"><figure><p><img alt="Diagram showcasing the multi-pass post-processing pipeline details in this section." loading="lazy" width="700" height="203" decoding="async" data-nimg="1" sizes="100vw" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara_Pipeline 640w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara_Pipeline 750w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara_Pipeline 828w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara_Pipeline 1080w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara_Pipeline 1200w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara_Pipeline 1920w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara_Pipeline 2048w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara_Pipeline 3840w" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara_Pipeline"></p><figcaption>Diagram showcasing the multi-pass post-processing pipeline details in this section.</figcaption></figure></div><h3 id="sobel-operator-and-partial-derivatives">Sobel operator and partial derivatives</h3><p>To obtain the structure of our scene, we can leverage a <strong>Sobel operator</strong> which I introduced in <a href="https://blog.maximeheckel.com/posts/moebius-style-post-processing/">Moebius-style post-processing and other stylized shaders</a> earlier this year.</p><p><code>Sx = [[-1, 0, 1], [-2, 0, 2], [-1, 0, 1]]</code></p><p><code>Sy = [[-1, -2, -1], [0, 0, 0], [1, 2, 1]]</code></p><p>However, this time we won't use it for edge detection like we did back then. We will apply our Sobel Matrix for every pixel but instead of a rapid change in intensity, which is characteristic of edges, we want to extract the partial derivatives along the x/y axis representing the <em>rate of change</em>.</p><div><div><p data-testid="codesnippet-title">Applying our Sobel Matrices when sampling</p></div><pre><div data-testid="line"><p>2</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">uniform</span><span data-testid="content-line"> </span><span data-testid="content-line">sampler2D</span><span data-testid="content-line"> inputBuffer</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>3</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">uniform</span><span data-testid="content-line"> </span><span data-testid="content-line">vec4</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">const</span><span data-testid="content-line"> </span><span data-testid="content-line">mat3</span><span data-testid="content-line"> Gx </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">mat3</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">2</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">2</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line"> </span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"> </span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>7</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">const</span><span data-testid="content-line"> </span><span data-testid="content-line">mat3</span><span data-testid="content-line"> Gy </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">mat3</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">2</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">2</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line"> </span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"> </span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>9</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">vec4</span><span data-testid="content-line"> </span><span data-testid="content-line">computeStructureTensor</span><span data-testid="content-line">(</span><span data-testid="content-line">sampler2D</span><span data-testid="content-line"> inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> uv</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx0y0 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx0y1 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>12</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx0y2 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>13</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx1y0 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>14</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx1y1 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>15</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx1y2 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>16</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx2y0 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>17</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx2y1 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>18</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx2y2 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><p>With those partial derivatives, we can obtain a <strong>structure tensor</strong></p><p>In the following fragment shader code, we apply both Sobel matrices at a given pixel, compute the structure tensor, and return it as an output.</p><div><div><p data-testid="codesnippet-title">Using Sobel Matrices to obtain the structure tensor</p></div><pre><div data-testid="line"><p>2</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">uniform</span><span data-testid="content-line"> </span><span data-testid="content-line">sampler2D</span><span data-testid="content-line"> inputBuffer</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>3</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">uniform</span><span data-testid="content-line"> </span><span data-testid="content-line">vec4</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">const</span><span data-testid="content-line"> </span><span data-testid="content-line">mat3</span><span data-testid="content-line"> Gx </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">mat3</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">2</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">2</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line"> </span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"> </span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>7</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">const</span><span data-testid="content-line"> </span><span data-testid="content-line">mat3</span><span data-testid="content-line"> Gy </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">mat3</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">2</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">2</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line"> </span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"> </span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">vec4</span><span data-testid="content-line"> </span><span data-testid="content-line">computeStructureTensor</span><span data-testid="content-line">(</span><span data-testid="content-line">sampler2D</span><span data-testid="content-line"> inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> uv</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx0y0 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>12</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx0y1 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>13</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx0y2 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>14</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx1y0 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>15</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx1y1 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>16</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx1y2 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>17</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx2y0 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>18</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx2y1 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>19</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> tx2y2 </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputTexture</span><span data-testid="content-line">,</span><span data-testid="content-line"> uv </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">,</span><span data-testid="content-line">  </span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> resolution</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>21</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> Sx </span><span data-testid="content-line">=</span><span data-testid="content-line"> Gx</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx0y0 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gx</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx1y0 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gx</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx2y0 </span><span data-testid="content-line">+</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>22</p><p><span><span data-testid="content-line">              Gx</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx0y1 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gx</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx1y1 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gx</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx2y1 </span><span data-testid="content-line">+</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>23</p><p><span><span data-testid="content-line">              Gx</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx0y2 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gx</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx1y2 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gx</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx2y2</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>25</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> Sy </span><span data-testid="content-line">=</span><span data-testid="content-line"> Gy</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx0y0 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gy</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx1y0 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gy</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx2y0 </span><span data-testid="content-line">+</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>26</p><p><span><span data-testid="content-line">              Gy</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx0y1 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gy</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx1y1 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gy</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx2y1 </span><span data-testid="content-line">+</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>27</p><p><span><span data-testid="content-line">              Gy</span><span data-testid="content-line">[</span><span data-testid="content-line">0</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx0y2 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gy</span><span data-testid="content-line">[</span><span data-testid="content-line">1</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx1y2 </span><span data-testid="content-line">+</span><span data-testid="content-line"> Gy</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line">[</span><span data-testid="content-line">2</span><span data-testid="content-line">]</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> tx2y2</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>29</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">vec4</span><span data-testid="content-line">(</span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">Sx</span><span data-testid="content-line">,</span><span data-testid="content-line"> Sx</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">Sy</span><span data-testid="content-line">,</span><span data-testid="content-line"> Sy</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">Sx</span><span data-testid="content-line">,</span><span data-testid="content-line"> Sy</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>33</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec4</span><span data-testid="content-line"> tensor </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">computeStructureTensor</span><span data-testid="content-line">(</span><span data-testid="content-line">inputBuffer</span><span data-testid="content-line">,</span><span data-testid="content-line"> vUv</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>35</p><p><span><span data-testid="content-line">    gl_FragColor </span><span data-testid="content-line">=</span><span data-testid="content-line"> tensor</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><p>If we were to visualize our scene with this tensor pass applied on top, this is what we'd obtain:</p><h3 id="from-structure-tensor-to-flow">From Structure Tensor to flow</h3><p>Thanks to the Structure Tensor we just obtained, we can derive the information we need to adapt our filter to the local features of our scene. This process is rather tedious and involves some notions of linear algebra that can seem daunting at first. Thus, we'll proceed step-by-step and avoid taking unnecessary shortcuts.</p><p>We want to know in which <em>direction</em> a given pixel points towards, i.e. the <strong>dominant direction and orientation of the tensor at a given position</strong>. Luckily, there is a mathematical concept that represents just that: <strong>eigenvalues</strong> and <strong>eigenvectors</strong>.</p><p>Through our structure tensor, we'd like to obtain <code>λ1</code> and derive its corresponding eigenvector, giving us the <em>dominant</em> direction of the <em>local structure</em>, to adapt our filter.
We can do so by starting from the definition of an eigenvector <code>A * v = λ * v</code>. Given a Matrix <code>[[a, b], [b,c]]</code>, we have:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>A * v = λ * v</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>A * v - λ * v = 0</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>A * v - λ * I * v</code> where <code>I</code> is the identity matrix</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>(A - λ * I) * v = 0</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Since we established that <code>v</code> is non-null, the only way for a product of a matrix transformation and non-zero vector to be null is if the transformation completely squishes space. This can be represented by a zero determinant for that matrix transformation, hence <code>det(A - λ * I) = 0</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>det([[a - λ, b], [b, d - λ]]) = 0</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>By applying the formula of the determinant we highlighted above we get: <code>(a - λ) * (d - λ) - b^2 = 0</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Finally, if we simplify this equation, we get the following quadratic equation to solve for lambda: <code>λ^2 - (a + d)λ + (ad - b^2) = 0</code></p></li>
</ul><p>The solution of this quadratic equation gives us two possible values for lambda as we expected:</p><p><code>λ = [(a + d) ± √((a + d)^2 - 4*(ad - b^2))] / 2</code></p><p>Doing all these steps in our fragment shader code would be relatively intensive. If you look a bit closer at the formula above, you will notice that we can replace some bits with the ones of <strong>the determinant and the trace of the transformation matrix</strong>:</p><p><code>λ = [trace ± √(trace² - 4*determinant)] / 2</code></p><p>thus making us not have to perform all the steps we just went through in our shader code: we can directly use this formula to compute both eigenvalues.</p><div><div><p data-testid="codesnippet-title">Computing the eigenvalues of our structuretensor</p></div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">float</span><span data-testid="content-line"> Jxx </span><span data-testid="content-line">=</span><span data-testid="content-line"> structureTensor</span><span data-testid="content-line">.</span><span data-testid="content-line">r</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>2</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> Jyy </span><span data-testid="content-line">=</span><span data-testid="content-line"> structureTensor</span><span data-testid="content-line">.</span><span data-testid="content-line">g</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>3</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> Jxy </span><span data-testid="content-line">=</span><span data-testid="content-line"> structureTensor</span><span data-testid="content-line">.</span><span data-testid="content-line">b</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>5</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> trace </span><span data-testid="content-line">=</span><span data-testid="content-line"> Jxx </span><span data-testid="content-line">+</span><span data-testid="content-line"> Jyy</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> determinant </span><span data-testid="content-line">=</span><span data-testid="content-line"> Jxx </span><span data-testid="content-line">*</span><span data-testid="content-line"> Jyy </span><span data-testid="content-line">-</span><span data-testid="content-line"> Jxy </span><span data-testid="content-line">*</span><span data-testid="content-line"> Jxy</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>8</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> lambda1 </span><span data-testid="content-line">=</span><span data-testid="content-line"> trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">0.5</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">sqrt</span><span data-testid="content-line">(</span><span data-testid="content-line">trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">0.25</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> determinant</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>9</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">float</span><span data-testid="content-line"> lambda2 </span><span data-testid="content-line">=</span><span data-testid="content-line"> trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">0.5</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">sqrt</span><span data-testid="content-line">(</span><span data-testid="content-line">trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">0.25</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> determinant</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span></span></p></div></pre></div><p>Now that we have our eigenvalues, we can pick the largest one to derive our <strong>eigenvector</strong> following this definition:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>(A - λ * I) * v = 0</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>[Jxx - λ, Jxy] [vx] = [0]</code> and <code>[Jxy, Jyy - λ]* [vy] [0]</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>(Jxx - λ) * vx + Jxy * vy = 0</code> and <code>Jxy * vx + (Jyy - λ) * vy = 0</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>vx = -Jxy * vy / (Jxx - λ)</code>, and by setting <code>vy</code> to <code>1</code> for simplicity we get: <code>vx = -Jxy / (Jxx - λ)</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>we can then multiply both components by <code>Jxx - λ</code> and obtain the final value for our eigenvector: <code>v = (-Jxy, Jxx - λ)</code></p></li>
</ul><p>We can use it as is in our code, however, through many rounds of trial and error, I had to resort to using this eigenvector only if Jxy relative to the other components of the tensor matrix was above zero.</p><div><div><p data-testid="codesnippet-title">Computing the eigenvector of our structure tensor</p></div><pre><div data-testid="line"><p>1</p><p><span><span data-testid="content-line">vec4</span><span data-testid="content-line"> </span><span data-testid="content-line">getDominantOrientation</span><span data-testid="content-line">(</span><span data-testid="content-line">vec4</span><span data-testid="content-line"> structureTensor</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>2</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> Jxx </span><span data-testid="content-line">=</span><span data-testid="content-line"> structureTensor</span><span data-testid="content-line">.</span><span data-testid="content-line">r</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>3</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> Jyy </span><span data-testid="content-line">=</span><span data-testid="content-line"> structureTensor</span><span data-testid="content-line">.</span><span data-testid="content-line">g</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> Jxy </span><span data-testid="content-line">=</span><span data-testid="content-line"> structureTensor</span><span data-testid="content-line">.</span><span data-testid="content-line">b</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> trace </span><span data-testid="content-line">=</span><span data-testid="content-line"> Jxx </span><span data-testid="content-line">+</span><span data-testid="content-line"> Jyy</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>7</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> determinant </span><span data-testid="content-line">=</span><span data-testid="content-line"> Jxx </span><span data-testid="content-line">*</span><span data-testid="content-line"> Jyy </span><span data-testid="content-line">-</span><span data-testid="content-line"> Jxy </span><span data-testid="content-line">*</span><span data-testid="content-line"> Jxy</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>9</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> lambda1 </span><span data-testid="content-line">=</span><span data-testid="content-line"> trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">0.5</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">sqrt</span><span data-testid="content-line">(</span><span data-testid="content-line">trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">0.25</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> determinant</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>10</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> lambda2 </span><span data-testid="content-line">=</span><span data-testid="content-line"> trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">0.5</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">sqrt</span><span data-testid="content-line">(</span><span data-testid="content-line">trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> trace </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">0.25</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line"> determinant</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>12</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> jxyStrength </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">abs</span><span data-testid="content-line">(</span><span data-testid="content-line">Jxy</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">abs</span><span data-testid="content-line">(</span><span data-testid="content-line">Jxx</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">abs</span><span data-testid="content-line">(</span><span data-testid="content-line">Jyy</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">abs</span><span data-testid="content-line">(</span><span data-testid="content-line">Jxy</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">1e-7</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>16</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">if</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">jxyStrength </span><span data-testid="content-line">&gt;</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>17</p><p><span><span data-testid="content-line">        v </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">normalize</span><span data-testid="content-line">(</span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">-</span><span data-testid="content-line">Jxy</span><span data-testid="content-line">,</span><span data-testid="content-line"> Jxx </span><span data-testid="content-line">-</span><span data-testid="content-line"> lambda1</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>22</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">vec4</span><span data-testid="content-line">(</span><span data-testid="content-line">normalize</span><span data-testid="content-line">(</span><span data-testid="content-line">v</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> lambda1</span><span data-testid="content-line">,</span><span data-testid="content-line"> lambda2</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><h3 id="deriving-and-applying-anisotropy-to-our-filter">Deriving and applying anisotropy to our filter</h3><p>From the Structure Tensor of our underlying scene, we derived both its eigenvalues and eigenvector. We could have also merely headed over to <a href="https://docs.opencv.org/4.x/d4/d70/tutorial_anisotropic_image_segmentation_by_a_gst.html">Anisotropic image segmentation by a gradient structure tensor</a> to find those formulas, however, we're grown-ups and it's nice to step out of our comfort zone to learn how to derive/define the tools and formulas we use in our shaders from time to time 🙂.</p><p>In <a href="https://www.umsl.edu/~kangh/Papers/kang-tpcg2010.pdf">Anisotropic Kuwahara Filtering with PolynomialWeighting Functions</a>, the authors define the anisotropy <code>A</code> using those eigenvalues as follows:</p><p><code>A = (λ1 - λ2) / (λ1 + λ2 + 1e-7)</code></p><p>With this formula, we can derive that:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p><code>A</code> ranges from <code>0</code> to <code>1</code></p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>when <code>λ1 = λ2</code>, the anisotropy is <code>0</code>, representing a <strong>isotropic</strong> region.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>when <code>λ1 &gt; λ2</code>, the anisotropy tends towards <code>1</code>, representing an <strong>anisotropic</strong> region.</p></li>
</ul><p>With the anisotropy now defined, we can use it to shape the circular kernel from the Kuwahara filter along the x-axis and y-axis with</p><div><div><p data-testid="codesnippet-title">Excentricity of the circular kernel</p></div><pre><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec4</span><span data-testid="content-line"> structureTensor </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputBuffer</span><span data-testid="content-line">,</span><span data-testid="content-line"> vUv</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> sectorAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">SECTOR_COUNT</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>7</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> sectorVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">SECTOR_COUNT</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>9</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec4</span><span data-testid="content-line"> orientationAndAnisotropy </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">getDominantOrientation</span><span data-testid="content-line">(</span><span data-testid="content-line">structureTensor</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>10</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> orientation </span><span data-testid="content-line">=</span><span data-testid="content-line"> orientationAndAnisotropy</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>12</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> anisotropy </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">orientationAndAnisotropy</span><span data-testid="content-line">.</span><span data-testid="content-line">z </span><span data-testid="content-line">-</span><span data-testid="content-line"> orientationAndAnisotropy</span><span data-testid="content-line">.</span><span data-testid="content-line">w</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">orientationAndAnisotropy</span><span data-testid="content-line">.</span><span data-testid="content-line">z </span><span data-testid="content-line">+</span><span data-testid="content-line"> orientationAndAnisotropy</span><span data-testid="content-line">.</span><span data-testid="content-line">w </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">1e-7</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>15</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> scaleX </span><span data-testid="content-line">=</span><span data-testid="content-line"> alpha </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">anisotropy </span><span data-testid="content-line">+</span><span data-testid="content-line"> alpha</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>16</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> scaleY </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">anisotropy </span><span data-testid="content-line">+</span><span data-testid="content-line"> alpha</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> alpha</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><p>Notice how:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>As the anisotropy approaches <code>1</code>, the ellipsis becomes more elongated along the x-axis, stretching our circular kernel.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>When we have a relatively isotropic region, the scale factors are <code>1</code> resulting in our kernel remaining circular.</p></li>
</ul><p>We now know how to stretch and scale our kernel based on the anisotropy, the remaining task we need to achieve is to <em>orient</em> it accordingly using the eigenvector we computed previously and defining a <strong>rotation matrix</strong> from it.</p><div><div><p data-testid="codesnippet-title">Adapt our kernel using anisotropy and the eigenvector from our structure tensor</p></div><pre><div data-testid="line"><p>3</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">void</span><span data-testid="content-line"> </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">mat2</span><span data-testid="content-line"> anisotropyMat</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> angle</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> radius</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">out</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> avgColor</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">out</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> variance</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> weightedColorSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>5</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> weightedSquaredColorSum </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> totalWeight </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> r </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">;</span><span data-testid="content-line"> r </span><span data-testid="content-line">&lt;=</span><span data-testid="content-line"> radius</span><span data-testid="content-line">;</span><span data-testid="content-line"> r </span><span data-testid="content-line">+=</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>12</p><p><span><span data-testid="content-line">        </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">float</span><span data-testid="content-line"> a </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">0.392699</span><span data-testid="content-line">;</span><span data-testid="content-line"> a </span><span data-testid="content-line">&lt;=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.392699</span><span data-testid="content-line">;</span><span data-testid="content-line"> a </span><span data-testid="content-line">+=</span><span data-testid="content-line"> </span><span data-testid="content-line">0.196349</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>13</p><p><span><span data-testid="content-line">            </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> sampleOffset </span><span data-testid="content-line">=</span><span data-testid="content-line"> r </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">vec2</span><span data-testid="content-line">(</span><span data-testid="content-line">cos</span><span data-testid="content-line">(</span><span data-testid="content-line">angle </span><span data-testid="content-line">+</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">sin</span><span data-testid="content-line">(</span><span data-testid="content-line">angle </span><span data-testid="content-line">+</span><span data-testid="content-line"> a</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>14</p><p><span><span data-testid="content-line">            sampleOffset </span><span data-testid="content-line">*=</span><span data-testid="content-line"> anisotropyMat</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>24</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec4</span><span data-testid="content-line"> structureTensor </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputBuffer</span><span data-testid="content-line">,</span><span data-testid="content-line"> vUv</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>26</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> sectorAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">SECTOR_COUNT</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>27</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> sectorVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">SECTOR_COUNT</span><span data-testid="content-line">]</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>29</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec4</span><span data-testid="content-line"> orientationAndAnisotropy </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">getDominantOrientation</span><span data-testid="content-line">(</span><span data-testid="content-line">structureTensor</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>30</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec2</span><span data-testid="content-line"> orientation </span><span data-testid="content-line">=</span><span data-testid="content-line"> orientationAndAnisotropy</span><span data-testid="content-line">.</span><span data-testid="content-line">xy</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>32</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> anisotropy </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">orientationAndAnisotropy</span><span data-testid="content-line">.</span><span data-testid="content-line">z </span><span data-testid="content-line">-</span><span data-testid="content-line"> orientationAndAnisotropy</span><span data-testid="content-line">.</span><span data-testid="content-line">w</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">orientationAndAnisotropy</span><span data-testid="content-line">.</span><span data-testid="content-line">z </span><span data-testid="content-line">+</span><span data-testid="content-line"> orientationAndAnisotropy</span><span data-testid="content-line">.</span><span data-testid="content-line">w </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">1e-7</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>35</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> scaleX </span><span data-testid="content-line">=</span><span data-testid="content-line"> alpha </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">anisotropy </span><span data-testid="content-line">+</span><span data-testid="content-line"> alpha</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>36</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> scaleY </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">anisotropy </span><span data-testid="content-line">+</span><span data-testid="content-line"> alpha</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> alpha</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>38</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">mat2</span><span data-testid="content-line"> anisotropyMat </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">mat2</span><span data-testid="content-line">(</span><span data-testid="content-line">orientation</span><span data-testid="content-line">.</span><span data-testid="content-line">x</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">-</span><span data-testid="content-line">orientation</span><span data-testid="content-line">.</span><span data-testid="content-line">y</span><span data-testid="content-line">,</span><span data-testid="content-line"> orientation</span><span data-testid="content-line">.</span><span data-testid="content-line">y</span><span data-testid="content-line">,</span><span data-testid="content-line"> orientation</span><span data-testid="content-line">.</span><span data-testid="content-line">x</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">mat2</span><span data-testid="content-line">(</span><span data-testid="content-line">scaleX</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> scaleY</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>40</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">for</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">int</span><span data-testid="content-line"> i </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">0</span><span data-testid="content-line">;</span><span data-testid="content-line"> i </span><span data-testid="content-line">&lt;</span><span data-testid="content-line"> SECTOR_COUNT</span><span data-testid="content-line">;</span><span data-testid="content-line"> i</span><span data-testid="content-line">++</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>41</p><p><span><span data-testid="content-line">      </span><span data-testid="content-line">float</span><span data-testid="content-line"> angle </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">i</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">6.28318</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">SECTOR_COUNT</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"> </span><span data-testid="content-line"></span></span></p></div><div data-testid="highlight-line"><p>42</p><p><span><span data-testid="content-line">      </span><span data-testid="content-line">getSectorVarianceAndAverageColor</span><span data-testid="content-line">(</span><span data-testid="content-line">anisotropyMat</span><span data-testid="content-line">,</span><span data-testid="content-line"> angle</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">radius</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> sectorAvgColors</span><span data-testid="content-line">[</span><span data-testid="content-line">i</span><span data-testid="content-line">]</span><span data-testid="content-line">,</span><span data-testid="content-line"> sectorVariances</span><span data-testid="content-line">[</span><span data-testid="content-line">i</span><span data-testid="content-line">]</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><p>As you can see above, the last step simply consists of applying this matrix to our <code>sampleOffset</code>. Voilà! We adapted our Kuwahara filter to be anisotropic!</p><p>I acknowledge that this process is rather tedious, however, the techniques described in the paper about the anisotropic Kuwahara filter that we reimplemented here are interesting and demonstrate the power that a few matrix transformations can have on an image and all the information we can derive from these.</p><p>The result in itself is subtle, and you'll mostly notice the advantages when:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>analyzing some specific and complex details of your scene from up close once the filter is applied</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>having a very high kernel size</p></li>
</ul><figure><div tabindex="0" role="slider" aria-label="Comparing the output of our isotropic and anisotropic Kuwahara filter." aria-valuemin="0" aria-valuemax="100" aria-valuenow="50"><p><img alt="Before" loading="eager" width="700" height="460" decoding="async" data-nimg="1" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Spaceship-before_fzlops 1x, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Spaceship-before_fzlops 2x" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Spaceship-before_fzlops"></p><p><img alt="After" loading="eager" width="700" height="460" decoding="async" data-nimg="1" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Spaceship-after_peebcb 1x, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Spaceship-after_peebcb 2x" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Spaceship-after_peebcb"></p><div id="slider-line"><p><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" style="transform:rotate(180deg)"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></p></div></div><figcaption>Comparing the output of our isotropic and anisotropic Kuwahara filter.</figcaption></figure><figure><div tabindex="0" role="slider" aria-label="Comparing the output of our isotropic and anisotropic Kuwahara filter." aria-valuemin="0" aria-valuemax="100" aria-valuenow="50"><p><img alt="Before" loading="eager" width="700" height="661" decoding="async" data-nimg="1" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Plant-before_qx9lza 1x, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Plant-before_qx9lza 2x" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Plant-before_qx9lza"></p><p><img alt="After" loading="eager" width="700" height="661" decoding="async" data-nimg="1" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Plant-after_hank5e 1x, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Plant-after_hank5e 2x" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-Anisotropic-Plant-after_hank5e"></p><div id="slider-line"><p><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" style="transform:rotate(180deg)"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></p></div></div><figcaption>Comparing the output of our isotropic and anisotropic Kuwahara filter.</figcaption></figure><p>Below is the full implementation of our multi-pass anisotropic Kuwahara filter:</p></section>
<section id="final-touches-and-conclusion-section"><h2 id="final-touches-and-conclusion">Final touches and conclusion</h2><p>To bring out the best of our painterly shader, we can add a final post-processing pass to our scene to perform a few tweaks such as:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>quantization</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>color interpolation</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>saturation</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>tone mapping</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>adding some texture to the output</p></li>
</ul><p>Quantization will help reduce the number of colors our output will feature. I covered this method in length in <a href="https://blog.maximeheckel.com/posts/the-art-of-dithering-and-retro-shading-web/">The Art of Dithering and Retro Shading for the Web</a>. As a reminder, the formula behind quantization is:</p><p><code>floor(color * (n - 1) + 0.5)/n - 1</code>&nbsp;where&nbsp;n&nbsp;is the total number of colors.</p><p>In our fragment shader for our final pass, we can add quantization by:</p><ol>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Calculating the grayscale value of the current pixel.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Setting the number of colors <code>n</code>. In my examples, I picked <code>16</code>.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Using the formula established above.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>Clamp the range to avoid extreme values which wouldn't yield a realistic painting effect.</p></li>
</ol><div><div><p data-testid="codesnippet-title">Applying quantization in our final post-processing pass</p></div><pre><div data-testid="line"><p>2</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">texture2D</span><span data-testid="content-line">(</span><span data-testid="content-line">inputBuffer</span><span data-testid="content-line">,</span><span data-testid="content-line"> vUv</span><span data-testid="content-line">)</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>3</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> grayscale </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">color</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.299</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.587</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.114</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>8</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">float</span><span data-testid="content-line"> qn </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">floor</span><span data-testid="content-line">(</span><span data-testid="content-line">x </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">n </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> </span><span data-testid="content-line">0.5</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line">(</span><span data-testid="content-line">n </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">1</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>9</p><p><span><span data-testid="content-line">    qn </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">clamp</span><span data-testid="content-line">(</span><span data-testid="content-line">qn</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.2</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.7</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"> </span><span data-testid="content-line"></span></span></p></div></pre></div><p>On top of that, to obtain a more painterly color output, we can use a <strong>Two Point Interpolation</strong> to blend our colors with our grayscale quantized image:</p><ul>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>For a darker quantized pixel, we'd opt to interpolate from black (or close to black) to the image color based on that quantization value.</p></li>
<li><span data-list-item="true"><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><p>For a lighter quantized pixel, we'd interpolate from the image to white.</p></li>
</ul><div><div><p data-testid="codesnippet-title">Adding two point color interpolation</p></div><pre><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">    color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">mix</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.1</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> color</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">,</span><span data-testid="content-line"> qn </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">2.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line">    color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">mix</span><span data-testid="content-line">(</span><span data-testid="content-line">color</span><span data-testid="content-line">.</span><span data-testid="content-line">rgb</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">qn </span><span data-testid="content-line">-</span><span data-testid="content-line"> </span><span data-testid="content-line">0.5</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">2.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><p>This method emphasizes the contrast between light (represented by white space) and dark areas (more painted, darker colors).</p><p>To make our output <em>pop</em> more, I also chose to increase the saturation of our colors:</p><div><div><p data-testid="codesnippet-title">Saturating our color output</p></div><pre><div data-testid="line"><p>3</p><p><span><span data-testid="content-line"></span><span data-testid="content-line">vec3</span><span data-testid="content-line"> </span><span data-testid="content-line">sat</span><span data-testid="content-line">(</span><span data-testid="content-line">vec3</span><span data-testid="content-line"> rgb</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">float</span><span data-testid="content-line"> adjustment</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">{</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>4</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> W </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">0.2125</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.7154</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0721</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"> </span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>5</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec3</span><span data-testid="content-line"> intensity </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec3</span><span data-testid="content-line">(</span><span data-testid="content-line">dot</span><span data-testid="content-line">(</span><span data-testid="content-line">rgb</span><span data-testid="content-line">,</span><span data-testid="content-line"> W</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>6</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">mix</span><span data-testid="content-line">(</span><span data-testid="content-line">intensity</span><span data-testid="content-line">,</span><span data-testid="content-line"> rgb</span><span data-testid="content-line">,</span><span data-testid="content-line"> adjustment</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>11</p><p><span><span data-testid="content-line">color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sat</span><span data-testid="content-line">(</span><span data-testid="content-line">color</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.5</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><p>And, finally, I added some tone mapping for better color balance:</p><div><div><p data-testid="codesnippet-title">Applying tone mapping to our scene</p></div><pre><div data-testid="line"><p>9</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">return</span><span data-testid="content-line"> </span><span data-testid="content-line">clamp</span><span data-testid="content-line">(</span><span data-testid="content-line">(</span><span data-testid="content-line">x </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">a </span><span data-testid="content-line">*</span><span data-testid="content-line"> x </span><span data-testid="content-line">+</span><span data-testid="content-line"> b</span><span data-testid="content-line">)</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">/</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">x </span><span data-testid="content-line">*</span><span data-testid="content-line"> </span><span data-testid="content-line">(</span><span data-testid="content-line">c </span><span data-testid="content-line">*</span><span data-testid="content-line"> x </span><span data-testid="content-line">+</span><span data-testid="content-line"> d</span><span data-testid="content-line">)</span><span data-testid="content-line"> </span><span data-testid="content-line">+</span><span data-testid="content-line"> e</span><span data-testid="content-line">)</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">0.0</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>16</p><p><span><span data-testid="content-line">    color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">sat</span><span data-testid="content-line">(</span><span data-testid="content-line">color</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.5</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>17</p><p><span><span data-testid="content-line">    color </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">ACESFilm</span><span data-testid="content-line">(</span><span data-testid="content-line">color</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>19</p><p><span><span data-testid="content-line">    </span><span data-testid="content-line">vec4</span><span data-testid="content-line"> outputColor </span><span data-testid="content-line">=</span><span data-testid="content-line"> </span><span data-testid="content-line">vec4</span><span data-testid="content-line">(</span><span data-testid="content-line">color</span><span data-testid="content-line">,</span><span data-testid="content-line"> </span><span data-testid="content-line">1.0</span><span data-testid="content-line">)</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div><div data-testid="line"><p>20</p><p><span><span data-testid="content-line">    gl_FragColor </span><span data-testid="content-line">=</span><span data-testid="content-line"> outputColor</span><span data-testid="content-line">;</span><span data-testid="content-line"></span></span></p></div></pre></div><p>You can see that these little color improvements compound into significant changes highlighting the best features of our painterly shader:</p><figure><div tabindex="0" role="slider" aria-label="Comparing the output of our post-processing pipeline without/with the final pass." aria-valuemin="0" aria-valuemax="100" aria-valuenow="50"><p><img alt="Before" loading="eager" width="700" height="465" decoding="async" data-nimg="1" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-without-final-pass_d2ag3x 1x, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-without-final-pass_d2ag3x 2x" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-without-final-pass_d2ag3x"></p><p><img alt="After" loading="eager" width="700" height="465" decoding="async" data-nimg="1" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-with-final-padd_gwu0s8 1x, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-with-final-padd_gwu0s8 2x" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/Kuwahara-with-final-padd_gwu0s8"></p><div id="slider-line"><p><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img" style="transform:rotate(180deg)"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg><svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" role="img"><title>Arrow</title><desc>An icon representing an arrow</desc><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></p></div></div><figcaption>Comparing the output of our post-processing pipeline without/with the final pass.</figcaption></figure><p>To wrap it all up, and give our output some <em>physicality</em> and <em>realism</em>, we can add a paper-like texture and blend it with the color output of our fragment shader, exactly as <a href="https://twitter.com/arpeegee">@arpeegee</a> did in the example that originally inspired this article.
This is a very easy trick that adds a <em>lot</em> of details to our scene and makes it look like a real painting.</p><p>The demo below bundles all those improvements together on top of the anisotropic Kuwahara filter making an otherwise standard scene look like a beautiful painting with many features reminiscent of watercolor which is the effect I was originally trying to achieve.</p><p>As we saw throughout this article, making a satisfying painterly shader seemed simple on the surface thanks to the standard implementation of the Kuwahara filter. However, it turned out to be much more intricate once we started to dig deeper, trying to fix the artifacts that each technique yielded. If you were to ask me my take on the topic, <strong>I'd consider the Papari extension of the Kuwahara filter with polynomial weighting to be enough</strong> in most cases, while also being relatively performant compared to its anisotropic counterpart. At the end of the day, it's almost more a question of personal taste/creative choice as the different iterations of this image filter can produce drastically different results given an underlying scene/image.</p><p>Nonetheless, deep diving into how to obtain the structure tensor of an image and deriving anisotropy through many layers of linear algebra is far from useless as the technique can be ported to <em>many</em> other post-processing effects (one of which I'm considering writing about here). Consider it as one additional tool in your ever-growing shader toolbelt.</p><p>To finish this article, which was quite the undertaking not going to lie, here are a couple more shots/paintings of some of the test scenes I used while building this custom post-processing shader:</p><figure><p><img alt="Orange Tree 1 - Anisotropic Kuwahara filter" loading="lazy" width="700" height="426" decoding="async" data-nimg="1" sizes="100vw" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting2-min_zvrziz 640w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting2-min_zvrziz 750w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting2-min_zvrziz 828w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting2-min_zvrziz 1080w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting2-min_zvrziz 1200w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting2-min_zvrziz 1920w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting2-min_zvrziz 2048w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting2-min_zvrziz 3840w" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting2-min_zvrziz"></p><figcaption>Orange Tree 1 - Anisotropic Kuwahara filter</figcaption></figure><figure><p><img alt="Raymarched Clouds - Extended Kuwahara filter" loading="lazy" width="700" height="388" decoding="async" data-nimg="1" sizes="100vw" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/clouds-painting-min_bqf2ia 640w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/clouds-painting-min_bqf2ia 750w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/clouds-painting-min_bqf2ia 828w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/clouds-painting-min_bqf2ia 1080w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/clouds-painting-min_bqf2ia 1200w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/clouds-painting-min_bqf2ia 1920w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/clouds-painting-min_bqf2ia 2048w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/clouds-painting-min_bqf2ia 3840w" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/clouds-painting-min_bqf2ia"></p><figcaption>Raymarched Clouds - Extended Kuwahara filter</figcaption></figure><figure><p><img alt="Orange Tree 2 - Anisotropic Kuwahara filter" loading="lazy" width="700" height="426" decoding="async" data-nimg="1" sizes="100vw" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting1-min_ljlg7l 640w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting1-min_ljlg7l 750w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting1-min_ljlg7l 828w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting1-min_ljlg7l 1080w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting1-min_ljlg7l 1200w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting1-min_ljlg7l 1920w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting1-min_ljlg7l 2048w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting1-min_ljlg7l 3840w" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/orangetree-painting1-min_ljlg7l"></p><figcaption>Orange Tree 2 - Anisotropic Kuwahara filter</figcaption></figure><figure><p><img alt="Spaceship formation - Extended Kuwahara filter" loading="lazy" width="700" height="410" decoding="async" data-nimg="1" sizes="100vw" srcset="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/spaceship-formation-painting-min_egrake 640w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/spaceship-formation-painting-min_egrake 750w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/spaceship-formation-painting-min_egrake 828w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/spaceship-formation-painting-min_egrake 1080w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/spaceship-formation-painting-min_egrake 1200w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/spaceship-formation-painting-min_egrake 1920w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/spaceship-formation-painting-min_egrake 2048w, https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/spaceship-formation-painting-min_egrake 3840w" src="https://res.cloudinary.com/dg5nsedzw/image/upload/fl_lossy,f_auto,q_auto/blog/spaceship-formation-painting-min_egrake"></p><figcaption>Spaceship formation - Extended Kuwahara filter</figcaption></figure></section></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[CFPB finalizes personal financial data rights rule (127 pts)]]></title>
            <link>https://www.eff.org/deeplinks/2024/10/no-matter-what-bank-says-its-your-money-your-data-and-your-choice</link>
            <guid>41998192</guid>
            <pubDate>Wed, 30 Oct 2024 17:55:05 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.eff.org/deeplinks/2024/10/no-matter-what-bank-says-its-your-money-your-data-and-your-choice">https://www.eff.org/deeplinks/2024/10/no-matter-what-bank-says-its-your-money-your-data-and-your-choice</a>, See on <a href="https://news.ycombinator.com/item?id=41998192">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
            <article role="article">
  
  
  <div><p><span>The Consumer Finance Protection Bureau (CFPB) has just </span><a href="https://www.consumerfinance.gov/about-us/newsroom/cfpb-finalizes-personal-financial-data-rights-rule-to-boost-competition-protect-privacy-and-give-families-more-choice-in-financial-services/"><span>finalized a rule</span></a><span> that makes it easy and safe for you to figure out which bank will give you the best deal and switch to that bank, with just a couple of clicks.&nbsp;</span></p>
<p><span>We </span><i><span>love</span></i><span> this kind of thing: the coolest thing about a digital world is how easy it is to switch from product or service to another—in theory. Digital tools are so flexible, anyone who wants your business can </span><a href="https://www.eff.org/deeplinks/2019/10/adversarial-interoperability"><span>write a program</span></a><span> to import your data into a new service and forward any messages or interactions that show up at the old service.</span></p>
<p><span>That's the theory. But in practice, companies have figured out how to use law - IP law, cybersecurity law, contract law, trade secrecy law—to </span><a href="https://www.eff.org/deeplinks/2016/07/section-1201-dmca-cannot-pass-constitutional-scrutiny"><span>literally criminalize</span></a><span> this kind of marvelous digital flexibility, so that it can end up being even </span><i><span>harder</span></i><span> to switch away from a digital service than it is to hop around among traditional, analog ones.</span></p>
<p><span>Companies </span><i><span>love</span></i><span> lock-in. The harder it is to quit a product or service, the worse a company can treat you without risking your business. Economists call the difficulties you face in leaving one service for another the "</span><a href="https://www.eff.org/deeplinks/2021/08/facebooks-secret-war-switching-costs"><span>switching costs</span></a><span>" and businesses go to great lengths to raise the switching costs they can impose on you if you have the temerity to be a disloyal customer.&nbsp;</span></p>
<p><span>So long as it's easier to coerce your loyalty than it is to earn it, companies win and their customers lose. That's where the new CFPB rule comes in.</span></p>
<p><span>Under this rule, you can authorize a third party - another bank, a comparison shopping site, a broker, or just your bookkeeping software - to request your account data from your bank. The bank has to give the third party </span><i><span>all</span></i><span> the data you've authorized. This data can include your transaction history and all the data needed to set up your payees and recurring transactions somewhere else.</span></p>
<p><span>That means that—for example—you can authorize a comparison shopping site to access some of your bank details, like how much you pay in overdraft fees and service charges, how much you earn in interest, and what your loans and credit cards are costing you. The service can use this data to figure out which bank will cost you the least and pay you the most.&nbsp;</span></p>
<p><span>Then, once you've opened an account with your new best bank, you can direct it to request </span><i><span>all</span></i><span> your data from your old bank, and with a few clicks, get fully set up in your new financial home. All your payees transfer over, all your regular payments, all the transaction history you'll rely on at tax time. "Painless" is an admittedly weird adjective to apply to household finances, but this comes pretty darned close.</span></p>
<p><span>Americans lose a </span><i><span>lot</span></i><span> of money to banking fees and low interest rates. How much? Well, CFPB economists, using a </span><i><span>very</span></i><span> conservative methodology, estimate that this rule will make the American public </span><i><span>at least $677 million</span></i><span> better off, </span><i><span>every year.</span></i></p>
<p><span>Now, that $677 million has to come from somewhere, and it does: it comes from the banks that are currently charging sky-high fees and paying rock-bottom interest. The largest of these banks are </span><a href="https://www.americanbanker.com/news/cfpbs-open-banking-rule-faces-suit-from-bank-policy-institute"><span>suing the CFPB</span></a><span> in a bid to block the rule from taking effect.</span></p>
<p><span>These banks claim that they are doing this to protect us, their depositors, from a torrent of fraud that would be unleashed if we were allowed to give third parties access to our own financial data. Clearly, this is the only reason a giant bank would want to make it harder for us to change to a competitor (it can't possibly have anything to do with the $677 million we stand to save by switching).</span></p>
<p><span>We've heard arguments like these before. While EFF takes a back seat to no one when it comes to defending user security (</span><a href="https://www.eff.org/cases/bernstein-v-us-dept-justice"><span>we practically invented this</span></a><span>), we reject the idea that </span><a href="https://www.eff.org/deeplinks/2023/12/without-interoperability-apple-customers-will-never-be-secure"><span>user security is improved when corporations lock us in</span></a><span> (and </span><a href="https://www.eff.org/document/letter-bruce-schneier-senate-judiciary-regarding-app-store-security"><span>leading security experts agree with us</span></a><span>).</span></p>
<p><span>This is not to say that a </span><i><span>bad</span></i><span> data-sharing interoperability rule wouldn't be, you know, </span><i><span>bad</span></i><span>. A rule that lacked the proper safeguards could indeed enable a wave of fraud and identity theft the likes of which we've never seen.</span></p>
<p><span>Thankfully, this is a </span><i><span>good</span></i><span> interoperability rule! </span><a href="https://www.eff.org/deeplinks/2023/10/you-wanna-break-your-bank-cfpb-wants-help-you-do-it"><span>We liked it when it was first proposed</span></a><span>, and it got </span><i><span>even better</span></i><span> through the rulemaking process.</span></p>
<p><span>First, the CFPB had the wisdom to know that a federal finance agency probably wasn't the best—or only—group of people to design a data-interchange standard. Rather than telling the banks exactly how they should transmit data when requested by their customers, the CFPB instead said, "These are the data you need to share and these are the characteristics of a good standards body. So long as you use a standard from a good standards body that shares this data, you're in compliance with the rule." This is an approach we've advocated for years, and it's the first time we've seen it in the wild.</span></p>
<p><span>The CFPB also instructs the banks to fail safe: any time a bank gets a request to share your data that it thinks might be fraudulent, they have the right to block the process until they can get more information and confirm that everything is on the up-and-up.</span></p>
<p><span>The rule also regulates the third parties that can get your data, establishing stringent criteria for which kinds of entities can do this. It also limits </span><i><span>how</span></i><span> they can use your data (strictly for the purposes you authorize) and what they need to do with the data when that has been completed (delete it forever), and what else they are allowed to do with it (nothing). There's also a mini "</span><a href="https://www.ftc.gov/news-events/news/press-releases/2024/10/federal-trade-commission-announces-final-click-cancel-rule-making-it-easier-consumers-end-recurring"><span>click-to-cancel</span></a><span>" rule that guarantees that you can instantly revoke any third party's access to your data, for any reason.</span></p>
<p><span>The CFPB has had the authority to make a rule like this since its founding in 2010, with the passage of the Consumer Financial Protection Act (CFPA). Back when the CFPA was working its way through Congress, the banks howled that they were being forced to give up "their" data to their competitors.</span></p>
<p><span>But it's not their data. It's </span><i><span>your</span></i><span> data. The decision about who you share it with belongs to </span><i><span>you</span></i><span>, and you alone. </span></p>

</div>

          </article>
    </div><div>
          <h2>Join EFF Lists</h2>
        
    </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[The Karma connection in Chrome Web Store (150 pts)]]></title>
            <link>https://palant.info/2024/10/30/the-karma-connection-in-chrome-web-store/</link>
            <guid>41997823</guid>
            <pubDate>Wed, 30 Oct 2024 17:23:33 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://palant.info/2024/10/30/the-karma-connection-in-chrome-web-store/">https://palant.info/2024/10/30/the-karma-connection-in-chrome-web-store/</a>, See on <a href="https://news.ycombinator.com/item?id=41997823">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
                <p>Somebody <a href="https://gist.github.com/c0m4r/45e15fc1ec13c544393feafca30e74de">brought to my attention</a> that the Hide YouTube Shorts extension for Chrome changed hands and turned malicious. I looked into it and could confirm that it contained two undisclosed components: one performing <a href="https://www.investopedia.com/terms/a/affiliate-fraud.asp">affiliate fraud</a> and the other sending users’ every move to some Amazon cloud server. But that wasn’t all of it: I discovered eleven more extensions written by the same people. Some contained only the affiliate fraud component, some only the user tracking, some both. A few don’t appear to be malicious yet.</p>
<p>While most of these extensions were supposedly developed or bought by a person without any other traces online, one broke this pattern. Karma shopping assistant has been on Chrome Web Store since 2020, the company behind it founded in 2013. This company employs more than 50 people and secured tons of cash in venture capital. Maybe a mistake on my part?</p>
<p>After looking thoroughly this explanation seems unlikely. Not only does Karma share some backend infrastructure and considerable amounts of code with the malicious extensions. Not only does Karma Shopping Ltd. admit to selling users’ browsing profiles in their privacy policy. There is even more tying them together, including a mobile app developed by Karma Shopping Ltd. whereas the identical Chrome extension is supposedly developed by the mysterious evildoer.</p>
<figure><img src="https://palant.info/2024/10/30/the-karma-connection-in-chrome-web-store/karma.png" alt="Screenshot of the karmanow.com website, with the Karma logo visible and a yellow button “Add to Chrome - It’s Free”" width="718" height="468"></figure>

<div id="tocBox">
  <h4>Contents</h4>
  <nav id="TableOfContents">
  <ul>
    <li><a href="#the-affected-extensions">The affected extensions</a></li>
    <li><a href="#hiding-in-plain-sight">Hiding in plain sight</a></li>
    <li><a href="#affiliate-fraud-functionality">Affiliate fraud functionality</a></li>
    <li><a href="#browsing-profile-collection">Browsing profile collection</a></li>
    <li><a href="#who-is-behind-this">Who is behind this?</a></li>
    <li><a href="#what-does-karma-shopping-want-with-the-data">What does Karma Shopping want with the data?</a></li>
  </ul>
</nav>
</div>

<h2 id="the-affected-extensions"><a href="#the-affected-extensions"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a>The affected extensions</h2>
<p>Most of the extensions in question changed hands relatively recently, the first ones in the summer of 2023. The malicious code has been added immediately after the ownership transfer, with some extensions even requesting additional privileges citing bogus reasons. A few extensions have been developed this year by whoever is behind this.</p>
<p>Some extensions from the latter group don’t have any obvious malicious functionality at this point. If there is tracking, it only covers the usage of the extension’s user interface rather than the entire browsing behavior. This can change at any time of course.</p>
<div><table>
<thead>
<tr>
<th>Name</th>
<th>Weekly active users</th>
<th>Extension ID</th>
<th>Malicious functionality</th>
</tr>
</thead>
<tbody>
<tr>
<td>Hide YouTube Shorts</td>
<td>100,000</td>
<td>aljlkinhomaaahfdojalfmimeidofpih</td>
<td>Affiliate fraud, browsing profile collection</td>
</tr>
<tr>
<td>DarkPDF</td>
<td>40,000</td>
<td>cfemcmeknmapecneeeaajnbhhgfgkfhp</td>
<td>Affiliate fraud, browsing profile collection</td>
</tr>
<tr>
<td>Sudoku On The Rocks</td>
<td>1,000</td>
<td>dncejofenelddljaidedboiegklahijo</td>
<td>Affiliate fraud</td>
</tr>
<tr>
<td>Dynamics 365 Power Pane</td>
<td>70,000</td>
<td>eadknamngiibbmjdfokmppfooolhdidc</td>
<td>Affiliate fraud, browsing profile collection</td>
</tr>
<tr>
<td>Israel everywhere</td>
<td>70</td>
<td>eiccbajfmdnmkfhhknldadnheilniafp</td>
<td>–</td>
</tr>
<tr>
<td>Karma | Online shopping, but better</td>
<td>500,000</td>
<td>emalgedpdlghbkikiaeocoblajamonoh</td>
<td>Browsing profile collection</td>
</tr>
<tr>
<td>Where is Cookie?</td>
<td>93</td>
<td>emedckhdnioeieppmeojgegjfkhdlaeo</td>
<td>–</td>
</tr>
<tr>
<td>Visual Effects for Google Meet</td>
<td>1,000,000</td>
<td>hodiladlefdpcbemnbbcpclbmknkiaem</td>
<td>Affiliate fraud</td>
</tr>
<tr>
<td>Quick Stickies</td>
<td>106</td>
<td>ihdjofjnmhebaiaanaeeoebjcgaildmk</td>
<td>–</td>
</tr>
<tr>
<td>Nucleus: A Pomodoro Timer and Website Blocker</td>
<td>20,000</td>
<td>koebbleaefghpjjmghelhjboilcmfpad</td>
<td>Affiliate fraud, browsing profile collection</td>
</tr>
<tr>
<td>Hidden Airline Baggage Fees</td>
<td>496</td>
<td>kolnaamcekefalgibbpffeccknaiblpi</td>
<td>Affiliate fraud</td>
</tr>
<tr>
<td>M3U8 Downloader</td>
<td>100,000</td>
<td>pibnhedpldjakfpnfkabbnifhmokakfb</td>
<td>Affiliate fraud</td>
</tr>
</tbody>
</table></div>
<h2 id="hiding-in-plain-sight"><a href="#hiding-in-plain-sight"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a>Hiding in plain sight</h2>
<p>Whoever wrote the malicious code chose not to obfuscate it but to make it blend in with the legitimate functionality of the extension. Clearly, the expectation was that nobody would look at the code too closely. So there is for example this:</p>
<div><pre tabindex="0"><code data-lang="js"><span><span><span>if</span> <span>(</span><span>window</span><span>.</span><span>location</span><span>.</span><span>href</span><span>.</span><span>startsWith</span><span>(</span><span>"http"</span><span>)</span> <span>||</span>
</span></span><span><span>    <span>window</span><span>.</span><span>location</span><span>.</span><span>href</span><span>.</span><span>includes</span><span>(</span><span>"m.youtube.com"</span><span>))</span> <span>{</span>
</span></span><span><span>  <span>…</span>
</span></span><span><span><span>}</span>
</span></span></code></pre></div><p>It <em>looks</em> like the code inside the block would only run on YouTube. Only when you stop and consider the logic properly you realize that it runs on every website. In fact, that’s the block wrapping the calls to malicious functions.</p>
<p>The malicious functionality is split between content script and background worker for the same reason, even though it could have been kept in one place. This way each part looks innocuous enough: there is some data collection in the content script, and then it sends a <code>check_shorts</code> message to the background worker. And the background worker “checks shorts” by querying some web server. Together this just <em>happens</em> to send your entire browsing history into the Amazon cloud.</p>
<p>Similarly, there are some complicated checks in the content script which eventually result in a <code>loadPdfTab</code> message to the background worker. The background worker dutifully opens a new tab for that address and, strangely, closes it after 9 seconds. Only when you sort through the layers it becomes obvious that this is actually about adding an affiliate cookie.</p>
<p>And of course there is a bunch of usual complicated conditions, making sure that this functionality is not triggered too soon after installation and generally doesn’t pop up reliably enough that users could trace it back to this extension.</p>
<h2 id="affiliate-fraud-functionality"><a href="#affiliate-fraud-functionality"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a>Affiliate fraud functionality</h2>
<p>The affiliate fraud functionality is tied to the <code>kra18.com</code> domain. When this functionality is active, the extension will regularly download data from <code>https://www.kra18.com/v1/selectors_list?&amp;ex=90</code> (90 being the extension ID here, the server accepts eight different extension IDs). That’s a long list containing 6,553 host names:</p>
<figure><img src="https://palant.info/2024/10/30/the-karma-connection-in-chrome-web-store/selectors.png" alt="Screenshot of JSON data displayed in the browser. The selectors key is expanded, twenty domain names like drinkag1.com are visible in the list." width="325" height="448"></figure>

<p>Whenever one of these domains is visited and the moons are aligned in the right order, another request to the server is made with the full address of the page you are on. For example, the extension could request <code>https://www.kra18.com/v1/extension_selectors?u=https://www.tink.de/&amp;ex=90</code>:</p>
<figure><img src="https://palant.info/2024/10/30/the-karma-connection-in-chrome-web-store/affiliate_link.png" alt="Screenshot of JSON data displayed in the browser. There are keys shortsNavButtonSelector, url and others. The url key contains a lengthy URL from awin1.com domain." width="573" height="145"></figure>

<p>The <code>shortsNavButtonSelector</code> key is another red herring, the code only <em>appears</em> to be using it. The important key is <code>url</code>, the address to be opened in order to set the affiliate cookie. And that’s the address sent via <code>loadPdfTab</code> message mentioned before if the extension decides that right now is a good time to collect an affiliate commission.</p>
<p>There are also additional “selectors,” downloaded from <code>https://www.kra18.com/v1/selectors_list_lr?&amp;ex=90</code>. Currently this functionality is only used on the <code>amazon.com</code> domain and will replace some product links with links going through <code>jdoqocy.com</code> domain, again making sure an affiliate commission is collected. That domain is owned by Common Junction LLC, an affiliate marketing company that published a <a href="https://www.cj.com/case-study/shoptagr-cj-publisher-onboarding-team-case-study">case study</a> on how their partnership with Karma Shopping Ltd. (named Shoptagr Ltd. back then) helped drive profits.</p>
<h2 id="browsing-profile-collection"><a href="#browsing-profile-collection"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a>Browsing profile collection</h2>
<p>Some of the extensions will send each page visit to <code>https://7ng6v3lu3c.execute-api.us-east-1.amazonaws.com/EventTrackingStage/prod/rest</code>. According to the extension code, this is an Alooma backend. Alooma is a data integration platform which has been acquired by Google a while ago. Data transmitted could look like this:</p>
<figure><img src="https://palant.info/2024/10/30/the-karma-connection-in-chrome-web-store/tracking.png" alt="Screenshot of query string parameters displayed in Developer Tools. The parameters are: token: sBGUbZm3hp, timestamp: 1730137880441, user_id: 90, distinct_id: 7796931211, navigator_language: en-US, referrer: https://www.google.com/, local_time: Mon Oct 28 2024 18:51:20 GMT+0100 (Central European Standard Time), event: page_visit, component: external_extension, external: true, current_url: https://example.com/" width="488" height="251"></figure>

<p>Yes, this is sent for each and every page loaded in the browser, at least after you’ve been using the extension for a while. And <code>distinct_id</code> is my immutable user ID here.</p>
<p>But wait, it’s a bit different for the Karma extension. Here you can opt out! Well, that’s only if you are using Firefox because Mozilla is rather strict about unexpected data collection. And if you manage to understand what “User interactions” means on this options page:</p>
<figure><img src="https://palant.info/2024/10/30/the-karma-connection-in-chrome-web-store/karma_options.png" alt="Screenshot of an options page with two switches labeled User interactions and URL address. The former is described with the text: Karma is a community of people who are working together to help each other get a great deal. We collect anonymized data about coupon codes, product pricing, and information about Karma is used to contribute back to the community. This data does not contain any personably identifiable information such as names or email addresses, but may include data supplied by the browser such as url address." width="575" height="398"></figure>

<p>Well, I may disagree with the claim that <a href="https://palant.info/2020/02/18/insights-from-avast/jumpshot-data-pitfalls-of-data-anonymization/">url addresses do not contain personably identifiable information</a>. And: yes, this is the entire page. There really isn’t any more text.</p>
<p>The data transmitted is also somewhat different:</p>
<figure><img src="https://palant.info/2024/10/30/the-karma-connection-in-chrome-web-store/tracking2.png" alt="Screenshot of query string parameters displayed in Developer Tools. The parameters are: referrer: https://www.google.com/, current_url: https://example.com/, browser_version: 130, tab_id: 5bd19785-e18e-48ca-b400-8a74bf1e2f32, event_number: 1, browser: chrome, event: page_visit, source: extension, token: sBGUbZm3hp, version: 10.70.0.21414, timestamp: 1730138671937, user_id: 6372998, distinct_id: 6b23f200-2161-4a1d-9400-98805c17b9e3, navigator_language: en-US, local_time: Mon Oct 28 2024 19:04:31 GMT+0100 (Central European Standard Time), ui_config: old_save, save_logic: rules, show_k_button: true, show_coupon_scanner: true, show_popups: true" width="495" height="430"></figure>

<p>The <code>user_id</code> field no longer contains the extension ID but my personal identifier, complementing the identifier in <code>distinct_id</code>. There is a <code>tab_id</code> field adding more context, so that it is not only possible to recognize which page I navigated to and from where but also to distinguish different tabs. And some more information about my system is always useful of course.</p>
<h2 id="who-is-behind-this"><a href="#who-is-behind-this"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"></path></svg></a>Who is behind this?</h2>
<p>Eleven extensions on my list are supposedly developed by a person going by the name Rotem Shilop or Roni Shilop or Karen Shilop. This isn’t a very common last name, and if this person really exists it managed to leave no traces online. Yes, I also searched in Hebrew. Yet one extension is developed by Karma Shopping Ltd. (formerly Shoptagr Ltd.), a company based in Israel with at least 50 employees. An accidental association?</p>
<p>It doesn’t look like it. I’m not going into the details of shared code and tooling, let’s just say: it’s very obvious that all twelve extensions are being developed by the same people. Of course, there is still the possibility that the eleven malicious extensions are not associated directly with Karma Shopping but with some rogue employee or contractor or business partner.</p>
<p>However, it isn’t only the code. As <a href="#browsing-profile-collection">explained above</a>, five extensions including Karma share the same tracking backend which is found nowhere else. They are even sending the same access token. Maybe this backend isn’t actually run by Karma Shopping and they are only one of the customers of some third party? Yet if you look at the data being sent, clearly the Karma extension is considered first-party. It’s the other extensions which are sending <code>external: true</code> and <code>component: external_extension</code> flags.</p>
<p>Then maybe Karma Shopping is merely buying data from a third party, without actually being affiliated with their extensions? Again, this is possible but unlikely. One indicator is the <code>user_id</code> field in the data sent by these extensions. It’s the same extension ID that they use for internal communication with the <code>kra18.com</code> server. If Karma Shopping were granting a third party access to their server, wouldn’t they assign that third party some IDs of their own?</p>
<p>And those affiliate links produced by the <code>kra18.com</code> server? Some of them clearly mention <code>karmanow.com</code> as the affiliate partner.</p>
<figure><img src="https://palant.info/2024/10/30/the-karma-connection-in-chrome-web-store/affiliate_link2.png" alt="Screenshot of JSON data displayed in the browser. url key is a long link pointing to go.skimresources.com. sref query parameter of the link is https://karmanow.com. url query parameter of the link is www.runinrabbit.com." width="855" height="95"></figure>

<p>Finally, if we look at Karma Shopping’s mobile apps, they develop two of them. In addition to the Karma app, the app stores also contain an app called “Sudoku on the Rocks,” developed by Karma Shopping Ltd. Which is a very strange coincidence because an identical “Sudoku on the Rocks” extension also exists in the Chrome Web Store. Here however the developer is Karen Shilop. And Karen Shilop chose to include hidden affiliate fraud functionality in their extension.</p>
<p>By the way, guess who likes the Karma extension a lot and left a five-star review?</p>
<figure><img src="https://palant.info/2024/10/30/the-karma-connection-in-chrome-web-store/review.png" alt="Screenshot of a five-star review by Rona Shilop with a generic-looking avatar of woman with a cup of coffee. The review text says: Thanks for making this amazing free extension. There is a reply by Karma Support saying: We’re so happy to hear how much you enjoy shopping with Karma." width="631" height="241"></figure>

<p>I contacted Karma Shopping Ltd. via their public relations address about their relationship to these extensions and the Shilop person but didn’t hear back so far.</p>
<p><strong>Update</strong> (2024-10-30): An extension developer told me that they were contacted on multiple independent occasions about selling their Chrome extension to Karma Shopping, each time by C-level executives of the company, from official <code>karmanow.com</code> email addresses. The first outreach was in September 2023, where Karma was supposedly looking into adding extensions to their portfolio as part of their growth strategy. They offered to pay between $0.2 and $1 per weekly active user.</p>

<p>It is obvious why Karma Shopping Ltd. would want to add their affiliate functionality to more extensions. After all, affiliate commissions are their line of business. But why collect browsing histories? Only to publish <a href="https://jonathan-65927.medium.com/far-from-being-impulsive-buyers-millennials-agonize-over-online-purchases-bc0dbbf5f2ba">semi-insightful articles on people’s shopping behavior</a>?</p>
<p>Well, let’s have a look at <a href="https://www.karmanow.com/privacy">their privacy policy</a> which is actually meaningful for a change. Under 1.3.4 it says:</p>
<blockquote>
<p><strong>Browsing Data.</strong> In case you a user of our browser extensions we may collect data regarding web browsing data, which includes web pages visited, clicked stream data and information about the content you viewed.</p>
<p><strong>How we Use this Data.</strong> We use this Personal Data (1) in order to provide you with the Services and feature of the extension and (2) we will share this data in an aggregated, anonymized manner, for marketing research and commercial use with our business partners.</p>
<p><strong>Legal Basis.</strong> (1) We process this Personal Data for the purpose of providing the Services to you, which is considered performance of a contract with you. (2) When we process and share the aggregated and anonymized data we will ask for your consent.</p>
</blockquote>
<p>First of all, this tells us that Karma collecting browsing data is official. They also openly state that they are selling it. Good to know and probably good for their business as well.</p>
<p>As to the legal basis: I am no lawyer but I have a strong impression that they don’t deliver on the “we will ask for your consent” promise. No, not even that Firefox options page qualifies as informed consent. And this makes this whole data collection rather doubtful in the light of GDPR.</p>
<p>There is also a difference between anonymized and pseudonymized data. The data collection seen here is pseudonymized: while it doesn’t include my name, there is a persistent user identifier which is still linked to me. It is usually fairly easy to deanonymize pseudonymized browsing histories, e.g. because people tend to visit their social media profiles rather often.</p>
<p>Actually anonymized data would not allow associating it with any single person. This is very hard to achieve, and we’ve seen <a href="https://palant.info/2020/02/18/insights-from-avast/jumpshot-data-pitfalls-of-data-anonymization/">promises of aggregated and anonymized data go very wrong</a>. While it’s theoretically possible that Karma correctly anonymizes and aggregates data on the server side, this is a rather unlikely outcome for a company that, as <a href="#browsing-profile-collection">we’ve seen above</a>, confuses the lack of names and email addresses with anonymity.</p>
<p>But of course these considerations only apply to the Karma extension itself. Because related extensions like Hide YouTube Shorts just straight out lie:</p>
<figure><img src="https://palant.info/2024/10/30/the-karma-connection-in-chrome-web-store/privacy.png" alt="Screenshot of a Chrome Web Store listing. Text under the heading Privacy: The developer has disclosed that it will not collect or use your data." width="494" height="90"></figure>

<p>Some of these extensions actually used to have a privacy policy before they were bought. Now only three still have an identical and completely bogus privacy policy. Sudoku on the Rocks happens to be among these three, and the same privacy policy is linked by the Sudoku on the Rocks mobile apps which are officially developed by Karma Shopping Ltd.</p>

            </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[SimpleQA (160 pts)]]></title>
            <link>https://openai.com/index/introducing-simpleqa/</link>
            <guid>41997727</guid>
            <pubDate>Wed, 30 Oct 2024 17:16:43 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://openai.com/index/introducing-simpleqa/">https://openai.com/index/introducing-simpleqa/</a>, See on <a href="https://news.ycombinator.com/item?id=41997727">Hacker News</a></p>
Couldn't get https://openai.com/index/introducing-simpleqa/: Error: Request failed with status code 403]]></description>
        </item>
        <item>
            <title><![CDATA[Show HN: AI OmniGen – AI Image Generator with Consistent Visuals (126 pts)]]></title>
            <link>https://aiomnigen.com</link>
            <guid>41997648</guid>
            <pubDate>Wed, 30 Oct 2024 17:10:43 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://aiomnigen.com">https://aiomnigen.com</a>, See on <a href="https://news.ycombinator.com/item?id=41997648">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><section><div><h2>Generate with Text-to-Image and Image-Conditioned Prompts | AI OmniGen</h2><p>OmniGen enables you to craft images with simple text prompts or multi-modal inputs, using placeholders for image-conditioned prompts.

Perfect for creating diverse and contextually rich visuals.</p></div><div data-rcs="root"><p><img src="https://fal.media/files/tiger/McOSLy9PtgUjSEC_xyM0c.jpeg" alt="Image one" data-rcs="image"></p><p><img src="https://fal.media/files/kangaroo/CDyzrRL6KfjPOQT4RoHvI.jpeg" alt="Image two" data-rcs="image"></p></div></section><section><div><h2>Identity-Preserving and Subject-Driven Generation | AI OmniGen</h2><p>Maintain subject identity with OmniGen's advanced model, making it ideal for recognizable figures and consistent character rendering.</p></div><div data-rcs="root"><p><img src="https://aiomnigen.com/assets/featureShow/AI_Pioneers.jpg" alt="Image one" data-rcs="image"></p><p><img src="https://aiomnigen.com/assets/featureShow/pose-2.webp" alt="Image two" data-rcs="image"></p></div></section><section><div><h2>Identity-Preserving and Subject-Driven Image Combined Generation | AI OmniGen</h2><p>This feature allows for personalized and highly tailored imagery creation.</p></div><p><img alt="Feature image 1" src="https://aiomnigen.com/assets/featureShow/entity.webp"></p></section><section><div><h2>Seamless Image Editing and Style Customization | AI OmniGen</h2><p>Edit previously generated images with OmniGen’s flexible seed handling. For example, switch to a new seed when modifying an existing image for unique edits.

Perfect for image refinement and experimentation.</p></div><div data-rcs="root"><p><img src="https://aiomnigen.com/assets/featureShow/women-1.webp" alt="Image one" data-rcs="image"></p><p><img src="https://aiomnigen.com/assets/featureShow/women-2.webp" alt="Image two" data-rcs="image"></p></div></section><section><div><h2>Enhanced Prompt Adaptation for High-Quality Results | AI OmniGen</h2><p>Detailed prompts yield clearer and higher-quality results. OmniGen’s model adapts to specific prompts to generate visuals that suit professional and creative needs alike.</p></div><div data-rcs="root"><p><img src="https://aiomnigen.com/assets/featureShow/icl1.jpg" alt="Image one" data-rcs="image"></p><p><img src="https://aiomnigen.com/assets/featureShow/icl3.jpg" alt="Image two" data-rcs="image"></p></div></section></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Cheap solar panels are changing the world (112 pts)]]></title>
            <link>https://www.theatlantic.com/science/archive/2024/10/solar-power-energy-revolution-global-south/680351/</link>
            <guid>41996425</guid>
            <pubDate>Wed, 30 Oct 2024 15:46:35 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.theatlantic.com/science/archive/2024/10/solar-power-energy-revolution-global-south/680351/">https://www.theatlantic.com/science/archive/2024/10/solar-power-energy-revolution-global-south/680351/</a>, See on <a href="https://news.ycombinator.com/item?id=41996425">Hacker News</a></p>
<div id="readability-page-1" class="page"><article><header data-event-module="hero"><div><figure><div data-flatplan-lead_figure_media="true"><picture><img alt="Color picture of a fuzzy white orb against an orange, red, and black background" sizes="(min-width: 976px) 976px, 100vw" srcset="https://cdn.theatlantic.com/thumbor/1tVAqPhOKJ9-Ama_9rJvchKXqa0=/0x0:2700x1519/750x422/media/img/mt/2024/10/2024_10_23_7764/original.jpg 750w, https://cdn.theatlantic.com/thumbor/poGcucq5ljH2A8eXPv8DSzC6ihQ=/0x0:2700x1519/828x466/media/img/mt/2024/10/2024_10_23_7764/original.jpg 828w, https://cdn.theatlantic.com/thumbor/vzl34JyqeomOmxgWi5RcYdaQFhI=/0x0:2700x1519/960x540/media/img/mt/2024/10/2024_10_23_7764/original.jpg 960w, https://cdn.theatlantic.com/thumbor/-NIQgd0bqmqphOjZdN1F-p3_-jQ=/0x0:2700x1519/976x549/media/img/mt/2024/10/2024_10_23_7764/original.jpg 976w, https://cdn.theatlantic.com/thumbor/qsDScksnq-e6h-728nh23UbXE6I=/0x0:2700x1519/1952x1098/media/img/mt/2024/10/2024_10_23_7764/original.jpg 1952w" src="https://cdn.theatlantic.com/thumbor/vzl34JyqeomOmxgWi5RcYdaQFhI=/0x0:2700x1519/960x540/media/img/mt/2024/10/2024_10_23_7764/original.jpg" id="article-lead-image" width="960" height="540"></picture></div><figcaption data-flatplan-lead_figure_caption="true">Franz Gruenewald / Connected Archives</figcaption></figure></div><gpt-ad format="injector" sizes-at-0="mobile-wide" targeting-pos="injector-article-start" sizes-at-976="desktop-wide"></gpt-ad></header><div data-view-action="view - audio player - start" data-view-label="680351" data-event-module="audio player" data-event-content-type="narrated" data-event-module-state="start" data-event-view="true"><div><p><img alt="Color picture of a fuzzy white orb against an orange, red, and black background" sizes="80px" srcset="https://cdn.theatlantic.com/thumbor/NrENC2WTV6PoxwAzBNU1kHPt0qU=/591x0:2110x1519/80x80/media/img/mt/2024/10/2024_10_23_7764/original.jpg 80w, https://cdn.theatlantic.com/thumbor/KnebwVKvhRfzj3DksnCWgV3ylB4=/591x0:2110x1519/96x96/media/img/mt/2024/10/2024_10_23_7764/original.jpg 96w, https://cdn.theatlantic.com/thumbor/r5lm88Wb1WGE8NpCKHyimiJOHB8=/591x0:2110x1519/128x128/media/img/mt/2024/10/2024_10_23_7764/original.jpg 128w, https://cdn.theatlantic.com/thumbor/dz3XkvczCXE5zjTXKlTRdjQ0rLA=/591x0:2110x1519/160x160/media/img/mt/2024/10/2024_10_23_7764/original.jpg 160w, https://cdn.theatlantic.com/thumbor/_FBXT_ch4BJpeyXbD_oKGoZRNXM=/591x0:2110x1519/192x192/media/img/mt/2024/10/2024_10_23_7764/original.jpg 192w, https://cdn.theatlantic.com/thumbor/_GioWRDwGCI0on9bq086G6tlBI8=/591x0:2110x1519/256x256/media/img/mt/2024/10/2024_10_23_7764/original.jpg 256w, https://cdn.theatlantic.com/thumbor/yUkHVOX7E_V2sZEvyP-kabOZtjY=/591x0:2110x1519/384x384/media/img/mt/2024/10/2024_10_23_7764/original.jpg 384w, https://cdn.theatlantic.com/thumbor/6WNHdMgu43KzHaLNHOnBijKJnJs=/591x0:2110x1519/512x512/media/img/mt/2024/10/2024_10_23_7764/original.jpg 512w" src="https://cdn.theatlantic.com/thumbor/NrENC2WTV6PoxwAzBNU1kHPt0qU=/591x0:2110x1519/80x80/media/img/mt/2024/10/2024_10_23_7764/original.jpg" width="80" height="80"></p></div><p>Produced by ElevenLabs and News Over Audio (NOA) using AI narration.</p></div><section data-event-module="article body" data-flatplan-body="true"><p data-flatplan-paragraph="true"><em><small>Updated at 1:40 p.m. ET on October 25, 2024</small></em></p><p data-flatplan-paragraph="true">Last month, an energy think tank released some rare good news for the climate: The world is on track to install 29 percent more solar capacity this year than it did the year before, according to a report from <a data-event-element="inline link" href="https://ember-energy.org/latest-insights/solar-power-continues-to-surge-in-2024/">Ember</a>. “In a single year, in a single technology, we’re providing as much new electricity as the entirety of global growth the year before,” Kingsmill Bond, a senior energy strategist at RMI, a clean-energy nonprofit, told me. A decade or two ago, analysts “did not imagine in their wildest dreams that solar by the middle of the 2020s would already be supplying all of the growth of global electricity demand,” he said. Yet here we are.</p><p data-flatplan-paragraph="true">In the United States, solar accounted for <a data-event-element="inline link" href="https://grist.org/energy/solar-hits-a-renewable-energy-milestone-not-seen-since-wwii/">more than half</a> of all new power last year. But the most dramatic growth is happening overseas. The latest global report from the International Energy Agency (IEA) notes that solar is on track to <a data-event-element="inline link" href="https://www.iea.org/reports/world-energy-outlook-2024">overtake</a> all other forms of energy by 2033. The world’s use of fossil fuels is already plateauing (the U.S., for its part, hit its peak demand for fossil-fuel energy <a data-event-element="inline link" href="https://www.eia.gov/todayinenergy/detail.php?id=45096#:~:text=The%20share%20of%20U.S.%20total%20energy%20consumption%20that%20originated%20from,increase%20in%20natural%20gas%20consumption.">way back in 2007</a>). Energy demand is still rising, but renewables are stepping in to make up the difference. “The really interesting debate now,” Bond said, “is actually: When do we push fossil fuels off the plateau? And from our numbers, if solar keeps on growing this way, it’s going to be off the plateau by the end of this decade.”</p><p data-flatplan-paragraph="true">The advantages of solar speak for themselves. Solar can be built faster and with fewer permits than other forms of energy infrastructure, mostly because the panels are flat and modular (unlike, say, a towering wind turbine or a hulking gas-fired power plant). It’s also adaptable at any scale, from an individual erecting a single panel to a utility company assembling a solar farm. And now, thanks to remarkable drops in prices for solar panels, mainly from China, simple market forces seem to be driving an all-out solar boom. “This is unstoppable,” Heymi Bahar, a senior energy analyst at the IEA, told me.</p><p data-flatplan-paragraph="true">Globally, some 40 percent of solar’s growth is in the form of people powering their own homes and businesses, Bahar said. Perhaps nowhere is this better illustrated than in Africa, where Joel Nana, a project manager at Sustainable Energy Africa in Cape Town, has been leading an effort to help countries regulate and integrate the explosion of small-scale solar. When Nana and his team started quantifying just how much new solar was around, “we were actually shocked,” he told me. In South Africa, for example, the total amount of energy produced from solar systems in 2019 was thought to be about 500 megawatts, Nana said. But in the first quarter of 2023, when researchers <a data-event-element="inline link" href="https://www.sseg.org.za/wp-content/uploads/2024/02/Status-of-EG-in-South-African-Municipalities-2023-FINAL-2.pdf">used satellite imagery</a> to count all of the solar installations in the country, they estimated that solar was producing a combined 5,700 megawatts of energy—only 55 percent of which had been declared to the government. That story of rapid, invisible growth is being repeated across the continent. Kenya now has about 200 megawatts of rooftop solar installed, representing 9 percent of the country’s total energy use, Nana said. Namibia has about 96 megawatts of rooftop solar capacity in its system, he said—a whopping 15 percent of its energy mix. “It’s been happening for three or four years, maybe five years, completely off the radar,” Nana said.</p><p id="injected-recirculation-link-0" data-view-action="view link - injected link - item 1" data-event-element="injected link" data-event-position="1"><a href="https://www.theatlantic.com/magazine/archive/2020/03/climate-change-peer-pressure/605515/">From the March 2020 issue: Thy neighbor’s solar panels</a></p><p data-flatplan-paragraph="true">Solar seems to have passed a tipping point: In many countries, the low cost of the technology is propelling its own growth, despite little government help. In South Africa, businesses such as shopping malls and factories have historically run diesel generators to deal with frequent power outages. Many still do, but now others are saving money by installing solar panels. Electricity from a diesel generator costs about 10 rand per kilowatt-hour, Nana said; with solar panels, it plummets to about two rand. “It’s literally a no-brainer for a business owner,” he said. Businesses make up 80 percent of small-scale solar capacity in the country, according to his research. Soon, Nana hopes, arrays and batteries will become cheap enough that more homeowners across the continent will be able to afford switching to solar. And, as the journalist Bill McKibben has reported, some homeowners in African countries who have never been connected to the grid are getting electricity for the very first time via solar-panel kits, <a data-event-element="inline link" href="https://www.newyorker.com/magazine/2017/06/26/the-race-to-solar-power-africa">skipping over</a> a fossil-fuel phase entirely.</p><p data-flatplan-paragraph="true">Across the global South, solar is capturing unprecedented portions of the energy market. <a data-event-element="inline link" href="https://www.bloomberg.com/news/articles/2024-08-09/pakistan-sees-solar-boom-as-chinese-imports-surge-bnef-says?sref=OVk78rkt">Pakistan</a>, for example, imported the equivalent of a quarter of its total energy capacity in Chinese solar panels in just the first six months of this year. Many countries in the global South lack significant fossil-fuel resources, and importing them is expensive. “By far the easiest way to obtain economic growth in a country with a lot of sunshine and no fossil fuels is by exploiting your own domestic resources,” Bond said. Already, in countries including Brazil, Morocco, Mexico, and Uruguay, solar and wind make up a bigger share of electricity generation than it does in global-North countries. By 2030, RMI <a data-event-element="inline link" href="https://rmi.org/insight/powering-up-the-global-south/?utm_campaign=heatmap_am&amp;utm_medium=email&amp;_hsenc=p2ANqtz--BBjdCevYygk974VQXcaVPv4j6TzxSY16EAOWZzFTxiQVb1IaUzr5KB04lHP5hWB-Z4i04a3GWJstmBl3UfnMazBK6ig&amp;_hsmi=329173745&amp;utm_content=329173745&amp;utm_source=hs_email">predicts</a>, the global South will have quadrupled its solar and wind capacity.</p><p data-flatplan-paragraph="true">That estimate doesn’t account for China, which is experiencing an unparalleled solar boom. In addition to supplying the rest of the world with panels, China installed more than half of the planet’s new solar capacity within its own borders in 2023, and the Ember report says it’s on track to add a similar amount this year. In 2023, the country more than doubled its own solar capacity year over year. “Nobody was expecting that it would be so high,” Bahar said.</p><p id="injected-recirculation-link-1" data-view-action="view link - injected link - item 2" data-event-element="injected link" data-event-position="2"><a href="https://www.theatlantic.com/science/archive/2021/06/why-the-us-doesnt-really-make-solar-panels-anymore-industrial-policy/619213/">Read: Why America doesn’t really make solar panels anymore</a></p><p data-flatplan-paragraph="true">Last year, at the United Nations Climate Change Conference, or COP28, in Dubai, 132 countries and the European Union <a data-event-element="inline link" href="https://www.cop28.com/en/global-renewables-and-energy-efficiency-pledge#:~:text=Commit%20to%20work%20together%20to,starting%20points%20and%20national%20circumstances">pledged</a> to triple the world’s renewable-energy capacity by 2030. According to Bahar, it’s the only promise of the many made in Dubai that’s likely to even be close to fulfilled: The world is on track to add 2.7 times its renewable capacity by then, and 80 percent of that increase will come from solar. To make use of all this growth, the world will have to add much more storage and transmission capacity, neither of which are keeping up with solar’s pace. The IEA, where Bahar works, will advocate for new pledges on those two fronts at COP29 next month. A world that mostly runs on solar power will also need something else—such as hydropower, nuclear, or geothermal—to generate energy when the sun isn’t shining in the evenings and winters. Jessika Trancik, an MIT professor who models clean-energy development, told me that governments need to steer investments toward storage and alternate forms of energy to compensate for that inherent downtime. That way, the world can have a reliable energy mix when 50 or 60 percent of electricity generation comes from solar and wind. That may seem far off, she said—solar made up about <a data-event-element="inline link" href="https://ember-energy.org/latest-insights/the-global-solar-revolution/">5.5 percent</a> of global electricity in 2023—but with the exponential growth of cheap solar, “before you know it, it’s upon you.”</p><p data-flatplan-paragraph="true">For Africa’s quiet solar boom to meet its full potential, governments will need to regulate and subsidize the technology, Nana said. Federal departments in Namibia, Kenya, and Eswatini have largely ignored the ascendance of solar technology within their borders, Nana said. Yet in South Africa, he’s seeing bright spots. Last year, the government began providing subsidies for solar for the first time. This year, its updated energy plan acknowledged that small-scale solar will be the biggest player in the country in the next decade. If South Africa is any indication, a solar revolution will arrive in more countries in the coming years. It may even sneak up on them.</p><hr><p data-flatplan-paragraph="true"><small><em>This article originally misstated that solar power made up 5.5 percent of global energy in 2023. It made up 5.5 percent of global electricity.</em></small></p></section><div data-event-module="footer"><p><h3>About the Author</h3></p><div><address id="article-writer-0" data-event-element="author" data-event-position="1" data-flatplan-bio="true"><div><p><a href="https://www.theatlantic.com/author/zoe-schlanger/" data-event-element="image"><img alt="" loading="lazy" src="https://cdn.theatlantic.com/thumbor/u8S5JVOtiftKFSYJUPgPfsZK710=/468x9:2384x1925/120x120/media/img/authors/2023/10/Sten_SSENSE_ZoeSchlanger_18_hi_res_version/original.jpg" width="60" height="60"></a></p><div><p><a href="https://www.theatlantic.com/author/zoe-schlanger/" data-label="https://www.theatlantic.com/author/zoe-schlanger/" data-action="click author - name">Zoë Schlanger</a> is a staff writer at <em>The Atlantic</em>. She is the author of <em><a href="https://bookshop.org/p/books/the-light-eaters-how-the-unseen-world-of-plant-intelligence-offers-a-new-understanding-of-life-on-earth-zoe-schlanger/20890522?ean=9780063073852">The Light Eaters</a>, </em>about the world of plant-behavior-and-intelligence research.</p></div></div></address></div></div><gpt-ad format="injector" sizes-at-0="mobile-wide,native,house" targeting-pos="injector-most-popular" sizes-at-976="desktop-wide,native,house"></gpt-ad></article></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Cooking with black plastic is particularly crucial to avoid (154 pts)]]></title>
            <link>https://www.theatlantic.com/health/archive/2024/10/black-plastic-spatula-flame-retardants/680452/</link>
            <guid>41996156</guid>
            <pubDate>Wed, 30 Oct 2024 15:30:47 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.theatlantic.com/health/archive/2024/10/black-plastic-spatula-flame-retardants/680452/">https://www.theatlantic.com/health/archive/2024/10/black-plastic-spatula-flame-retardants/680452/</a>, See on <a href="https://news.ycombinator.com/item?id=41996156">Hacker News</a></p>
<div id="readability-page-1" class="page"><article><header data-event-module="hero"><div><div><p>It’s probably leaching chemicals into your cooking oil.</p></div><div><figure><div data-flatplan-lead_figure_media="true"><picture><img alt="An illustration of a black plastic spatula melting in a neon-green cloud." sizes="(min-width: 976px) 976px, 100vw" srcset="https://cdn.theatlantic.com/thumbor/ZN71JAgNkzuiKTzQZ4BNXDFm3DA=/0x0:2000x1125/750x422/media/img/mt/2024/10/blackSpatula/original.png 750w, https://cdn.theatlantic.com/thumbor/TEEsZdXt3HDEWQ-Y-2YlbGtHRyQ=/0x0:2000x1125/828x466/media/img/mt/2024/10/blackSpatula/original.png 828w, https://cdn.theatlantic.com/thumbor/FsfngqvTp1LGerIb9ToASOW7FYM=/0x0:2000x1125/960x540/media/img/mt/2024/10/blackSpatula/original.png 960w, https://cdn.theatlantic.com/thumbor/AyOGylcQcP44tNEf2QIiv0-vZuk=/0x0:2000x1125/976x549/media/img/mt/2024/10/blackSpatula/original.png 976w, https://cdn.theatlantic.com/thumbor/uGhFS9sUnWZm0Z0Aq0wLWJAyT3k=/0x0:2000x1125/1952x1098/media/img/mt/2024/10/blackSpatula/original.png 1952w" src="https://cdn.theatlantic.com/thumbor/FsfngqvTp1LGerIb9ToASOW7FYM=/0x0:2000x1125/960x540/media/img/mt/2024/10/blackSpatula/original.png" id="article-lead-image" width="960" height="540"></picture></div><figcaption data-flatplan-lead_figure_caption="true">Illustration by The Atlantic. Source: Getty.</figcaption></figure></div></div><div><p><time datetime="2024-10-30T13:00:00Z" data-flatplan-timestamp="true">October 30, 2024, 9 AM ET</time> </p></div><gpt-ad format="injector" sizes-at-0="mobile-wide" targeting-pos="injector-article-start" sizes-at-976="desktop-wide"></gpt-ad></header><section data-event-module="article body" data-flatplan-body="true"><p data-flatplan-paragraph="true">For the past several years, I’ve been telling my friends what I’m going to tell you: Throw out your black plastic spatula. In a world of plastic consumer goods, avoiding the material entirely requires the fervor of a religious conversion. But getting rid of black plastic kitchen utensils is a low-stakes move, and worth it. Cooking with any plastic is a dubious enterprise, because heat <a data-event-element="inline link" href="https://www.health.harvard.edu/staying-healthy/is-plastic-a-threat-to-your-health">encourages</a> potentially harmful plastic compounds to <a data-event-element="inline link" href="https://www.sciencedirect.com/science/article/pii/S2214289422001089">migrate</a> out of the polymers and potentially into the food. But, as Andrew Turner, a biochemist at the University of Plymouth recently told me, black plastic is particularly crucial to avoid.</p><p data-flatplan-paragraph="true">In 2018, Turner <a data-event-element="inline link" href="https://www.sciencedirect.com/science/article/abs/pii/S0160412018302125?via%3Dihub">published one of the earliest papers</a> positing that black plastic products were likely regularly being made from recycled electronic waste. The clue was the plastic’s concerning levels of flame retardants. In some cases, the mix of chemicals matched the profile of those commonly found in computer and television housing, many of which are treated with flame retardants to prevent them from catching fire.</p><p data-flatplan-paragraph="true">Because optical sensors in recycling facilities <a data-event-element="inline link" href="https://www.weforum.org/agenda/2019/12/black-plastic-recycling-supermarkets-waste/">can’t detect</a> them, black-colored plastics are largely rejected from domestic-waste streams, resulting in a shortage of black base material for recycled plastic. So the demand for black plastic appears to be met “in no insignificant part” via recycled e-waste, according to Turner’s research. TV and computer casings, <a data-event-element="inline link" href="https://www.undp.org/blog/unsung-heroes-four-things-policymakers-can-do-empower-informal-waste-workers">like the majority of the world’s plastic waste</a>, tend to be recycled in informal waste economies with few regulations and end up remolded into consumer products, including ones, such as spatulas and slotted spoons, that come into contact with food.</p><div data-flatplan-paragraph="true"><p>You simply do not want flame retardants anywhere near your stir-fry. Flame retardants are typically not bound to the polymers to which they are added, making them a particular flight risk: They dislodge easily and make their way into the surrounding environment. And, indeed, another paper from 2018 found that flame retardants in black kitchen utensils readily <a data-event-element="inline link" href="https://www.sciencedirect.com/science/article/abs/pii/S0048969717321708">migrate into hot cooking oil</a>. The health concerns associated with those chemicals are well established: Some flame retardants are <a data-event-element="inline link" href="https://pmc.ncbi.nlm.nih.gov/articles/PMC10486428/">endocrine disruptors</a>, which can interfere with the body’s hormonal system, and scientific literature suggests that they may be associated with a range of ailments, including <a data-event-element="inline link" href="https://www.hsph.harvard.edu/news/press-releases/exposure-to-common-flame-retardant-chemicals-may-increase-thyroid-problems-in-women/">thyroid disease</a>, <a data-event-element="inline link" href="https://deohs.washington.edu/hsm-blog/flame-retardants-and-diabetes">diabetes</a>, and cancer. People with the highest blood levels of PBDEs, a class of flame retardants found in black plastic, had about a 300 percent increase in their risk of dying from cancer compared with people who had the lowest levels, according to a <a data-event-element="inline link" href="https://jamanetwork.com/journals/jamanetworkopen/fullarticle/2816783">study released this year</a>. In a separate <a data-event-element="inline link" href="https://www.sciencedirect.com/science/article/pii/S0045653524022173?via%3Dihub">study</a>, published in a peer-reviewed journal this month, researchers from the advocacy group Toxic-Free Future and from Vrije Universiteit Amsterdam found that, out of all of the consumer products they tested, kitchen utensils had some of the highest levels of flame retardants.</p><p>  Another food product, black plastic sushi trays, had the highest level of flame retardants in the study. Children’s toys also ranked high: A single pirate-themed plastic children’s necklace was almost 3 percent flame retardant by weight. “When you’re using black plastic items, there’s going to be a risk that they could be contaminated,” Megan Liu, the science and policy manager at Toxic-Free Future and the first author on the study, told me. Those flame retardants <a data-event-element="inline link" href="https://www.sciencedirect.com/science/article/pii/S0045653522002673">migrate into toddlers’ saliva</a> and into the dust in our homes and, thus, in the air we breathe. Last year, Toxic-Free Future tested <a data-event-element="inline link" href="https://toxicfreefuture.org/research/toxic-flame-retardants-in-breast-milk/">breast milk</a> taken from 50 women in the U.S. and found flame-retardant compounds in <a data-event-element="inline link" href="https://www.sciencedirect.com/science/article/abs/pii/S0269749123010308?via%3Dihub">each sample</a>.</p></div><p data-flatplan-paragraph="true">Many of the flame-retardant compounds that showed up in the tests that Liu and her co-authors conducted should no longer be in the product stream. Brominated flame retardants have mostly been phased out of products in the U.S. and Europe, including from many electronics. In the U.S. and elsewhere, some of the most harmful flame-retardant compounds are now illegal for use in most consumer goods. Massachusetts <a data-event-element="inline link" href="https://www.wamc.org/new-england-news/2021-02-03/new-massachusetts-law-bans-certain-chemical-flame-retardants">banned</a> a list of 11 flame retardants in 2021. Starting this year, a New York <a data-event-element="inline link" href="https://www.nysenate.gov/legislation/bills/2021/A5418">bill</a> restricts the use of organohalogen flame retardants—one large class of the compounds—in electronic casings, and a similar Washington State ban will go into effect in 2025.</p><p data-flatplan-paragraph="true">But these compounds keep coming back. The sushi tray tested in Liu’s study contained 11,900 parts per million of decaBDE, also called BDE-209, which she described as a “really alarming” level of a chemical that was <a data-event-element="inline link" href="https://www.federalregister.gov/documents/2023/11/24/2023-25714/decabromodiphenyl-ether-and-phenol-isopropylated-phosphate-31-revision-to-the-regulation-of#:~:text=The%202021%20decaBDE%20final%20rule,as%20of%20January%206%2C%202022.">banned</a> from most U.S. commerce in 2022 and largely phased out of production long before that. Because plastic recycling is a global economy with scant oversight, patchwork legislation may do little to keep these compounds out of the supply chain. “You send your electronic waste abroad, and you just haven’t got a clue what happens to it,” Turner told me. “I think the assumption is that it gets handled safely and it’s disposed of properly. But, you know, it comes back in the form of things that we don’t want.”</p><p data-flatplan-paragraph="true">For a consumer, this problem would be simpler to handle if it was clear that only certain black plastic products posed a risk, or that all of them did. But Turner found that products were contaminated with flame retardants at random. Not all of the black plastic he tested in his 2018 study contained the compounds, and in those that did, “the amount of chemicals in the black plastic varied hugely,” he said. Some items would have the same chemical profile of what you’d expect from, say, the flame-retardant plastic housing of a television or a cellphone. Other objects would have just a trace of flame retardant, or none at all. Of the more than 200 black plastic products Liu bought at retail stores for her study, hardly any were labeled as being made from recycled materials, she said. Consumers have no way to tell which black plastics might be recycled e-waste and which aren’t. “It’s just a minefield, really,” Turner said.</p><p data-flatplan-paragraph="true">Putting your black plastic in the recycling bin might seem like the right thing to do, but recycling isn’t a solution to the most noxious qualities of plastics. “I personally have been throwing out my black plastic takeout containers,” Liu told me, because if they are contaminated, “it’s scary to think that those might be reentering other products with the same flame retardants.” Until flame retardants and any dubious compounds that arise to replace banned ones are eliminated from the supply chain, reusing black plastic will perpetuate a potential health hazard. In her view, “the onus shouldn’t fall on consumers to have to make these daily changes in their lives.” Ultimately, federal bans or more ubiquitous state laws that go beyond single-compound phaseouts are the only way to keep flame retardants out of takeout containers and other black plastic intended for use in things such as foodware and toys. Until manufacturers use safer flame-retardant compounds and laws effectively prohibit recycled electronics material from entering consumer products, these chemicals will continue circulating through our kitchens, arising and re-arising like toxic zombies.</p><p data-flatplan-paragraph="true">But that doesn’t mean we need to consume them by way of our kitchen utensils. Replacing a black plastic spatula with a steel or silicone option is an easy way to cut down on at least part of one’s daily dose of hormone disruptors. I’ve also taken this news as a reason to coax myself into carrying a reusable coffee mug more often, if only to avoid the black plastic lids on disposable cups—heat plus plastic equals chemical migration, after all. It’s a minefield of random hazards out there, as Turner said. Most of the time we’re trying to navigate without a map. But in at least some areas, we can trace a safer path for ourselves.</p></section><div data-event-module="footer"><p><h3>About the Author</h3></p><div><address id="article-writer-0" data-event-element="author" data-event-position="1" data-flatplan-bio="true"><div><p><a href="https://www.theatlantic.com/author/zoe-schlanger/" data-event-element="image"><img alt="" loading="lazy" src="https://cdn.theatlantic.com/thumbor/u8S5JVOtiftKFSYJUPgPfsZK710=/468x9:2384x1925/120x120/media/img/authors/2023/10/Sten_SSENSE_ZoeSchlanger_18_hi_res_version/original.jpg" width="60" height="60"></a></p><div><p><a href="https://www.theatlantic.com/author/zoe-schlanger/" data-label="https://www.theatlantic.com/author/zoe-schlanger/" data-action="click author - name">Zoë Schlanger</a> is a staff writer at <em>The Atlantic</em>. She is the author of <em><a href="https://bookshop.org/p/books/the-light-eaters-how-the-unseen-world-of-plant-intelligence-offers-a-new-understanding-of-life-on-earth-zoe-schlanger/20890522?ean=9780063073852">The Light Eaters</a>, </em>about the world of plant-behavior-and-intelligence research.</p></div></div></address></div></div><gpt-ad format="injector" sizes-at-0="mobile-wide,native,house" targeting-pos="injector-most-popular" sizes-at-976="desktop-wide,native,house"></gpt-ad></article></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Pushing the frontiers of audio generation (199 pts)]]></title>
            <link>https://deepmind.google/discover/blog/pushing-the-frontiers-of-audio-generation/</link>
            <guid>41995730</guid>
            <pubDate>Wed, 30 Oct 2024 15:02:56 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://deepmind.google/discover/blog/pushing-the-frontiers-of-audio-generation/">https://deepmind.google/discover/blog/pushing-the-frontiers-of-audio-generation/</a>, See on <a href="https://news.ycombinator.com/item?id=41995730">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="content">
      
  <article>
    
    
  
  
  
    

    
    
      
        <div>
          
            
            
              
              
<div>
    <div>
      <p>Technologies</p>
      

      
    <dl>
      
        <dt>Published</dt>
        <dd><time datetime="2024-10-30">30 October 2024</time></dd>
      
      
        <dt>Authors</dt>
        
      
    </dl>
  

      
    </div>

    
      
    
    
    <picture>
      <source media="(min-width: 1024px)" type="image/webp" width="1072" height="603" srcset="https://lh3.googleusercontent.com/_jjPl1Kv1mv1Qz5QdR_nJ-3rnaqSrwTabpyrdabzYl7hytlaIMj_i3elkt5o3pPVCjI-9M0Nuazevo3Jr81VubuIV4QY9IZsxVDPktGMGeODFIFn=w1072-h603-n-nu-rw 1x, https://lh3.googleusercontent.com/_jjPl1Kv1mv1Qz5QdR_nJ-3rnaqSrwTabpyrdabzYl7hytlaIMj_i3elkt5o3pPVCjI-9M0Nuazevo3Jr81VubuIV4QY9IZsxVDPktGMGeODFIFn=w2144-h1206-n-nu-rw 2x"><source media="(min-width: 600px)" type="image/webp" width="928" height="522" srcset="https://lh3.googleusercontent.com/_jjPl1Kv1mv1Qz5QdR_nJ-3rnaqSrwTabpyrdabzYl7hytlaIMj_i3elkt5o3pPVCjI-9M0Nuazevo3Jr81VubuIV4QY9IZsxVDPktGMGeODFIFn=w928-h522-n-nu-rw 1x, https://lh3.googleusercontent.com/_jjPl1Kv1mv1Qz5QdR_nJ-3rnaqSrwTabpyrdabzYl7hytlaIMj_i3elkt5o3pPVCjI-9M0Nuazevo3Jr81VubuIV4QY9IZsxVDPktGMGeODFIFn=w1856-h1044-n-nu-rw 2x"><source type="image/webp" width="528" height="297" srcset="https://lh3.googleusercontent.com/_jjPl1Kv1mv1Qz5QdR_nJ-3rnaqSrwTabpyrdabzYl7hytlaIMj_i3elkt5o3pPVCjI-9M0Nuazevo3Jr81VubuIV4QY9IZsxVDPktGMGeODFIFn=w528-h297-n-nu-rw 1x, https://lh3.googleusercontent.com/_jjPl1Kv1mv1Qz5QdR_nJ-3rnaqSrwTabpyrdabzYl7hytlaIMj_i3elkt5o3pPVCjI-9M0Nuazevo3Jr81VubuIV4QY9IZsxVDPktGMGeODFIFn=w1056-h594-n-nu-rw 2x">
      <img alt="An illustration depicting speech patterns, iterative progress on dialogue generation,  and a relaxed conversation between two voices." height="603" src="https://lh3.googleusercontent.com/_jjPl1Kv1mv1Qz5QdR_nJ-3rnaqSrwTabpyrdabzYl7hytlaIMj_i3elkt5o3pPVCjI-9M0Nuazevo3Jr81VubuIV4QY9IZsxVDPktGMGeODFIFn=w1072-h603-n-nu" width="1072">
    </picture>
    
  
    
  </div>
            
          
            
            
              
              <div>
  <h4 data-block-key="yrcbl">Our pioneering speech generation technologies are helping people around the world interact with more natural, conversational and intuitive digital assistants and AI tools.</h4><p data-block-key="3cjpl">Speech is central to human connection. It helps people around the world exchange information and ideas, express emotions and create mutual understanding. As our technology built for generating natural, dynamic voices continues to improve, we’re unlocking richer, more engaging digital experiences.</p><p data-block-key="bh9mr">Over the past few years, we’ve been pushing the frontiers of audio generation, developing models that can create high quality, natural speech from a range of inputs, like text, tempo controls and particular voices. This technology powers single-speaker audio in many Google products and experiments — including <a href="https://blog.google/products/gemini/made-by-google-gemini-ai-updates/" rel="noopener" target="_blank">Gemini Live</a>, <a href="https://deepmind.google/technologies/gemini/project-astra/" rel="noopener" target="_blank">Project Astra</a>, <a href="https://cloud.google.com/text-to-speech/docs/voice-types" rel="noopener" target="_blank">Journey Voices</a> and <a href="https://blog.youtube/news-and-events/made-on-youtube-2024/" rel="noopener" target="_blank">YouTube’s auto dubbing</a> — and is helping people around the world interact with more natural, conversational and intuitive digital assistants and AI tools.</p><p data-block-key="7838d">Working together with partners across Google, we recently helped develop two new features that can generate long-form, multi-speaker dialogue for making complex content more accessible:</p><ul><li data-block-key="5j7f7"><a href="https://notebooklm.google/" rel="noopener" target="_blank">NotebookLM Audio Overviews</a> turns uploaded documents into engaging and lively dialogue. With one click, two AI hosts summarize user material, make connections between topics and banter back and forth.</li><li data-block-key="9q17j"><a href="https://illuminate.google.com/" rel="noopener" target="_blank">Illuminate</a> creates formal AI-generated discussions about research papers to help make knowledge more accessible and digestible.</li></ul><p data-block-key="c3kro">Here, we provide an overview of our latest speech generation research underpinning all of these products and experimental tools.</p>
</div>
            
          
            
            
              
              <div>
  <h2 data-block-key="auxvk">Pioneering techniques for audio generation</h2><p data-block-key="2rhdn">For years, we've been investing in audio generation research and exploring new ways for generating more natural dialogue in our products and experimental tools. In our previous research on <a href="https://research.google/blog/soundstorm-efficient-parallel-audio-generation/" rel="noopener" target="_blank">SoundStorm</a>, we first demonstrated the ability to generate 30-second segments of natural dialogue between multiple speakers.</p><p data-block-key="ecfnq">This extended our earlier work, <a href="https://research.google/blog/soundstream-an-end-to-end-neural-audio-codec/" rel="noopener" target="_blank">SoundStream</a> and <a href="https://google-research.github.io/seanet/audiolm/examples/" rel="noopener" target="_blank">AudioLM</a>, which allowed us to apply many text-based language modeling techniques to the problem of audio generation.</p><p data-block-key="7m7rr">SoundStream is a neural audio codec that efficiently compresses and decompresses an audio input, without compromising its quality. As part of the training process, SoundStream learns how to map audio to a range of acoustic tokens. These tokens capture all of the information needed to reconstruct the audio with high fidelity, including properties such as <a href="https://en.wikipedia.org/wiki/Prosody_(linguistics)" rel="noopener" target="_blank">prosody</a> and <a href="https://en.wikipedia.org/wiki/Timbre" rel="noopener" target="_blank">timbre</a>.</p><p data-block-key="3bngd">AudioLM treats audio generation as a language modeling task to produce the acoustic tokens of codecs like SoundStream. As a result, the AudioLM framework makes no assumptions about the type or makeup of the audio being generated, and can flexibly handle a variety of sounds without needing architectural adjustments — making it a good candidate for modeling multi-speaker dialogues.</p>
</div>
            
          
            
            
              
              


            
          
            
            
              
              




<figure aria-labelledby="single-media-ab666b1b-5b78-44a6-a805-9b31cf82c4e3-figcaption">
  
  
    <figcaption id="single-media-ab666b1b-5b78-44a6-a805-9b31cf82c4e3-figcaption">
      <p data-block-key="1snyy">Example of a multi-speaker dialogue generated by NotebookLM Audio Overview, based on a few potato-related documents.</p>
    </figcaption>
  
</figure>
            
          
            
            
              
              <p data-block-key="6qplr">Building upon this research, our latest speech generation technology can produce 2 minutes of dialogue, with improved naturalness, speaker consistency and acoustic quality, when given a script of dialogue and speaker turn markers. The model also performs this task in under 3 seconds on a single <a href="https://cloud.google.com/tpu/docs/v5e" rel="noopener" target="_blank">Tensor Processing Unit (TPU) v5e chip</a>, in one inference pass. This means it generates audio over 40-times faster than real time.</p>
            
          
            
            
              
              <div>
  <h2 data-block-key="uq3en">Scaling our audio generation models</h2><p data-block-key="du2ro">Scaling our single-speaker generation models to multi-speaker models then became a matter of data and model capacity. To help our latest speech generation model produce longer speech segments, we created an even more efficient speech codec for compressing audio into a sequence of tokens, in as low as 600 bits per second, without compromising the quality of its output.</p><p data-block-key="g9ht">The tokens produced by our codec have a hierarchical structure and are grouped by time frames. The first tokens within a group capture phonetic and prosodic information, while the last tokens encode fine acoustic details.</p><p data-block-key="7vshj">Even with our new speech codec, producing a 2-minute dialogue requires generating over 5000 tokens. To model these long sequences, we developed a specialized <a href="https://research.google/blog/transformer-a-novel-neural-network-architecture-for-language-understanding/" rel="noopener" target="_blank">Transformer</a> architecture that can efficiently handle hierarchies of information, matching the structure of our acoustic tokens.</p><p data-block-key="8djch">With this technique, we can efficiently generate acoustic tokens that correspond to the dialogue, within a single autoregressive inference pass. Once generated, these tokens can be decoded back into an audio waveform using our speech codec.</p>
</div>
            
          
            
            
              
              




<figure aria-labelledby="single-media-a9d3eb76-9a4f-464c-a5fa-a7f1fbd5b760-figcaption">
  
  
    <figcaption id="single-media-a9d3eb76-9a4f-464c-a5fa-a7f1fbd5b760-figcaption">
      <p data-block-key="57qqn">Animation showing how our speech generation model produces a stream of audio tokens autoregressively, which are decoded back to a waveform consisting of a two-speaker dialogue.</p>
    </figcaption>
  
</figure>
            
          
            
            
              
              <div>
  <p data-block-key="269cj">To teach our model how to generate realistic exchanges between multiple speakers, we pretrained it on hundreds of thousands of hours of speech data. Then we finetuned it on a much smaller dataset of dialogue with high acoustic quality and precise speaker annotations, consisting of unscripted conversations from a number of voice actors and realistic <a href="https://en.wikipedia.org/wiki/Speech_disfluency" rel="noopener" target="_blank">disfluencies</a> — the “umm”s and “aah”s of real conversation. This step taught the model how to reliably switch between speakers during a generated dialogue and to output only studio quality audio with realistic pauses, tone and timing.</p><p data-block-key="8shit">In line with our <a href="https://ai.google/responsibility/principles/" rel="noopener" target="_blank">AI Principles</a> and our commitment to developing and deploying AI technologies responsibly, we’re incorporating our SynthID technology to watermark non-transient AI-generated audio content from these models, to help safeguard against the potential misuse of this technology.</p>
</div>
            
          
            
            
              
              <div>
  <h2 data-block-key="wao8a">New speech experiences ahead</h2><p data-block-key="dr1sf">We’re now focused on improving our model’s fluency, acoustic quality and adding more fine-grained controls for features, like prosody, while exploring how best to combine these advances with other modalities, such as video.</p><p data-block-key="82sf">The potential applications for advanced speech generation are vast, especially when combined with our Gemini family of models. From enhancing learning experiences to making content more universally accessible, we’re excited to continue pushing the boundaries of what’s possible with voice-based technologies.</p>
</div>
            
          
            
            
              
              


            
          
            
            
              
              
            
          
            
            
              
              



  
    
  

            
          
        </div>
      
    

    
  
  

  

  </article>

    </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[M4 MacBook Pro (780 pts)]]></title>
            <link>https://www.apple.com/newsroom/2024/10/new-macbook-pro-features-m4-family-of-chips-and-apple-intelligence/</link>
            <guid>41995701</guid>
            <pubDate>Wed, 30 Oct 2024 15:00:20 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.apple.com/newsroom/2024/10/new-macbook-pro-features-m4-family-of-chips-and-apple-intelligence/">https://www.apple.com/newsroom/2024/10/new-macbook-pro-features-m4-family-of-chips-and-apple-intelligence/</a>, See on <a href="https://news.ycombinator.com/item?id=41995701">Hacker News</a></p>
<div id="readability-page-1" class="page">


	
    







 
<nav id="ac-localnav" lang="en-US" role="navigation" aria-label="Newsroom" data-analytics-region="local nav" data-sticky="">
	
    
    
        




    
    
    
	
	

</nav>





<main id="main" role="main"> 




<span id="opens-in-new-window">opens in new window</span>
<section>
<article data-analytics-activitymap-region-id="article">






    
    
    









    





    <div>
        
		
        <div>
                    
                    
                        <span>PRESS RELEASE</span>
                    
                    
                        <span>October 30, 2024</span>
                    
                    
                </div>

        <div>
                
                
                
                    <h2>
                        
    
        Apple’s new MacBook&nbsp;Pro features the incredibly powerful M4 family of chips and ushers in a new era with Apple&nbsp;Intelligence
    

                    </h2>
                
            </div>

        <div>
                
                
                    With an advanced 12MP Center Stage camera, Thunderbolt&nbsp;5 on M4&nbsp;Pro and M4&nbsp;Max models, and an all-new nano-texture display option, MacBook&nbsp;Pro gets even more capable and even more pro
                
            </div>

        
            
    
    
    
    
    

        

    </div>







    
    
    






  
    
    
    
    
      <figure aria-label="Media, An almost shut MacBook Pro emits a colorful glowing light.">
        <div>
             
              
              <div>
                Supercharged by Apple Intelligence, even more powerful Apple silicon with the M4 family of chips, and new capabilities, MacBook Pro accelerates pro workloads like never before.
              </div>
            
            
            
            
            <a href="https://www.apple.com/newsroom/images/2024/10/new-macbook-pro/article/Apple-MacBook-Pro-M4-hero.zip" download="" data-analytics-title="download image - Apple-MacBook-Pro-M4-hero_big" aria-label="Download media, An almost shut MacBook Pro emits a colorful glowing light."></a>
          </div>
      </figure>
    
  






    
    
    


     
     
    
    
        <div>
             
                 <div><strong><span>CUPERTINO, CALIFORNIA</span> </strong>Apple today unveiled the new <a href="https://www.youtube.com/watch?v=G0cmfY7qdmY" target="_blank" rel="nofollow" data-analytics-exit-link="">MacBook Pro</a>, powered by the M4 family of chips — M4, M4 Pro, and M4 Max — delivering much faster performance and enhanced capabilities. The new MacBook Pro is built for Apple Intelligence, the personal intelligence system that transforms how users work, communicate, and express themselves, while protecting their privacy. Now available in space black and silver finishes, the 14-inch MacBook Pro includes the blazing-fast performance of M4 and three Thunderbolt 4 ports, starting with 16GB of memory, all at just $1,599. The 14- and 16-inch models with M4 Pro and M4 Max offer Thunderbolt 5 for faster transfer speeds and advanced connectivity. All models include a Liquid Retina XDR display that gets even better with an all-new nano-texture display option and up to 1000 nits of brightness for SDR content, an advanced 12MP Center Stage camera, along with up to 24 hours of battery life, the longest ever in a Mac.<sup>1</sup> The new MacBook Pro is available to pre-order today, with availability beginning November 8.
</div>
                 
             
                 <div>“MacBook Pro is an incredibly powerful tool that millions of people use to do their life’s best work, and today we’re making it even better,” said John Ternus, Apple’s senior vice president of Hardware Engineering. “With the powerful M4 family of chips, and packed with pro features like Thunderbolt 5, an advanced 12MP Center Stage camera, an all-new nano-texture display option, and Apple Intelligence, the new MacBook Pro continues to be, by far, the world’s best pro laptop.”
</div>
                 
             
         </div>
 

    
    
    


    
    
        
        
        
            <div role="group" aria-label="gallery" data-component-list="MixinGallery" id="macbook-pro-details">
            <nav role="presentation">
                <ul role="tablist">
                    
                        <li role="presentation">
                            <a id="gallery-dotnav-6f87eb0dc4ce953520c7f9cc606f58cf" href="#gallery-6f87eb0dc4ce953520c7f9cc606f58cf" data-ac-gallery-trigger="gallery-6f87eb0dc4ce953520c7f9cc606f58cf"><span>A look at the front and the back of the new MacBook Pro.</span></a>
                        </li>
                    
                        <li role="presentation">
                            <a id="gallery-dotnav-e77c52288c1b1d227891ed9d8eff5844" href="#gallery-e77c52288c1b1d227891ed9d8eff5844" data-ac-gallery-trigger="gallery-e77c52288c1b1d227891ed9d8eff5844"><span>A close-up of the keyboard on the new MacBook Pro.</span></a>
                        </li>
                    
                </ul>
            </nav>
            <div>
                
                    
                        
                        <div id="gallery-6f87eb0dc4ce953520c7f9cc606f58cf" aria-labelledby="gallery-dotnav-6f87eb0dc4ce953520c7f9cc606f58cf" data-gallery-item="">
                            <figure role="presentation" data-analytics-activitymap-region-id="Gallery:front-and-back">
                                
                                <div>
                                    <div>The new MacBook Pro is transformed with Apple Intelligence, the blazing performance of the M4 family, an advanced 12MP Center Stage camera, an all-new nano-texture display option, and more.</div>
                                    
                                    
                                    <a href="https://www.apple.com/newsroom/images/2024/10/new-macbook-pro/article/Apple-MacBook-Pro-M4-lineup.zip" download="" data-analytics-title="download image - Apple-MacBook-Pro-M4-lineup_big" aria-label="Download media, A look at the front and the back of the new MacBook Pro."></a>
                                </div>
                            </figure>
                        </div>
                        
                    
                
                    
                        
                        <div id="gallery-e77c52288c1b1d227891ed9d8eff5844" aria-labelledby="gallery-dotnav-e77c52288c1b1d227891ed9d8eff5844" data-gallery-item="">
                            <figure role="presentation" data-analytics-activitymap-region-id="Gallery:screen-and-keyboard">
                                
                                <div>
                                    <div>The new MacBook Pro is transformed with Apple Intelligence, the blazing performance of the M4 family, an advanced 12MP Center Stage camera, an all-new nano-texture display option, and more.</div>
                                    
                                    
                                    <a href="https://www.apple.com/newsroom/images/2024/10/new-macbook-pro/article/Apple-MacBook-Pro-M4-Magic-Keyboard-close-up.zip" download="" data-analytics-title="download image - Apple-MacBook-Pro-M4-Magic-Keyboard-close-up_big" aria-label="Download media, A close-up of the keyboard on the new MacBook Pro."></a>
                                </div>
                            </figure>
                        </div>
                        
                    
                
            </div>
            
                
                
                <nav role="presentation">
                    
                        <ul>
                            <li>
                                
                            </li>
                            <li>
                                
                            </li>
                        </ul>
                    
                </nav>
            
        </div>
    


    
    
    


     
     
    
    
        <div>
             
                 <h2><strong>Supercharged by the M4 Family of Chips</strong>
</h2>
                 
             
                 <div>Built using second-generation 3-nanometer technology, the <a href="https://www.apple.com/newsroom/2024/10/apple-introduces-m4-pro-and-m4-max" target="_blank">M4 family</a> is the most advanced lineup of chips for a personal computer. The M4 family features phenomenal single-threaded CPU performance with the world’s fastest CPU core,<sup>2</sup> along with outstanding multithreaded CPU performance for the most demanding workloads. Combined with machine learning accelerators in the CPU, an advanced GPU, and a faster and more efficient Neural Engine, Apple silicon is built from the ground up to deliver incredible performance for AI. Together with faster unified memory, each chip also includes increased memory bandwidth, so large language models (LLMs) and other large projects run smoothly and on device. Additionally, the industry-leading performance per watt of the M4 family means that users get up to 24 hours of battery life, raising the bar of what users can do on a single charge.
</div>
                 
             
         </div>
 

    
    
    






  
    
    
    
    
      <figure aria-label="Media, A graphic shows the M4 family of chips: M4, M4 Pro, and M4 Max.">
        <div>
             
              
              <div>
                The new MacBook&nbsp;Pro features the M4 family of chips, the most advanced lineup of chips ever built for a pro laptop.
              </div>
            
            
            
            
            <a href="https://www.apple.com/newsroom/images/2024/10/new-macbook-pro/article/Apple-MacBook-Pro-M4-chip-series-3up.zip" download="" data-analytics-title="download image - Apple-MacBook-Pro-M4-chip-series-3up_big" aria-label="Download media, A graphic shows the M4 family of chips: M4, M4 Pro, and M4 Max."></a>
          </div>
      </figure>
    
  






    
    
    


     
     
    
    
        <div>
             
                 <h2><strong>New 14-inch MacBook Pro with M4</strong>
</h2>
                 
             
                 <div>The 14-inch MacBook Pro with M4 is the ideal choice for entrepreneurs, students, creators, or anyone doing what they love. Featuring a more powerful 10-core CPU, with four performance cores and six efficiency cores, and a faster 10-core GPU with Apple’s most advanced graphics architecture, the new MacBook Pro starts with 16GB of faster unified memory with support for up to 32GB, along with 120GB/s of memory bandwidth. With M4, MacBook Pro is up to 1.8x faster than the 13-inch MacBook Pro with M1 for tasks like editing gigapixel photos, and even more demanding workloads like rendering complex scenes in Blender are up to 3.4x faster.<sup>1</sup> With a Neural Engine that’s over 3x more powerful than in M1, it’s great for features in Apple Intelligence and other AI workloads. The M4 model also supports two high-resolution external displays in addition to the built-in display, and now features three Thunderbolt 4 ports so users can connect all their peripherals.
</div>
                 
             
         </div>
 

    
    
    






  
    
    
    
    
      <figure aria-label="Media, A person sits on the floor, working on a MacBook Pro propped up on their lap.">
        <div>
             
              
              <div>
                MacBook Pro empowers users to work and be creative wherever they are, with even more game-changing performance and extraordinary battery life.
              </div>
            
            
            
            
            <a href="https://www.apple.com/newsroom/images/2024/10/new-macbook-pro/article/Apple-MacBook-Pro-M4-lifestyle-01.zip" download="" data-analytics-title="download image - Apple-MacBook-Pro-M4-lifestyle-01_big" aria-label="Download media, A person sits on the floor, working on a MacBook Pro propped up on their lap."></a>
          </div>
      </figure>
    
  






    
    
    


     
     
    
    
        <div>
             
                 <div><strong>MacBook Pro with M4 delivers:<sup>1</sup></strong>
</div>
                 
             
                 <div><ul>
<li>Up to 7x faster image processing in Affinity Photo when compared to the 13‑inch MacBook Pro with Core i7, and up to 1.8x faster when compared to the 13-inch MacBook Pro with M1.</li>
</ul>
</div>
                 
             
                 <div><ul>
<li>Up to 10.9x faster 3D rendering in Blender when compared to the 13‑inch MacBook Pro with Core i7, and up to 3.4x faster when compared to the 13‑inch MacBook Pro with M1.</li>
</ul>
</div>
                 
             
                 <div><ul>
<li>Up to 9.8x faster scene edit detection in Adobe Premiere Pro when compared to the 13‑inch MacBook Pro with Core i7, and up to 1.7x faster when compared to the 13‑inch MacBook Pro with M1.</li>
</ul>
</div>
                 
             
         </div>
 

    
    
    


    
    <div data-component-list="ScrollAnimationDefault AutoPlayVideo">
        <div>M4 brings phenomenal performance to the new 14-inch MacBook Pro, from creative tasks to even more demanding workloads such as rendering complex scenes in Blender.</div>
        
            <a aria-label="Download video: MacBook Pro Blender Workflow" data-analytics-title="Download video - MacBook Pro Blender Workflow" download="" href="https://www.apple.com/newsroom/videos/videos-2024/autoplay/2024/10/apple-macbook-pro-m4-blender/downloads/Apple-MacBook-Pro-M4-Blender.zip">
            </a>
        
    </div>






    
    
    


     
     
    
    
        <div>
             
                 <h2><strong>MacBook Pro with M4 Pro: A Pro Powerhouse</strong>
</h2>
                 
             
                 <div>For researchers, developers, engineers, creative pros, or anyone that needs even faster performance for more demanding workflows, MacBook Pro with M4 Pro offers a tremendous performance boost. M4 Pro features a powerful 14-core CPU with 10 performance cores and four efficiency cores for a jump in multicore performance, along with up to a 20-core GPU that is twice as powerful as M4. With M4 Pro, the new MacBook Pro gets a massive 75 percent increase in memory bandwidth over the prior generation — double that of any AI PC chip.<sup>3</sup> The new MacBook Pro with M4 Pro is up to 3x faster than models with M1 Pro, speeding up workflows like geo mapping, structural engineering, and data modeling.<sup>1</sup>
</div>
                 
             
         </div>
 

    
    
    






  
    
    
    
    
      <figure aria-label="Media, Two people work in a lab, with one using the new MacBook Pro.">
        <div>
             
              
              <div>
                The new 14- and 16-inch MacBook Pro with M4 Pro is ideal for researchers, developers, engineers, creative pros, or for anyone looking for even faster performance.
              </div>
            
            
            
            
            <a href="https://www.apple.com/newsroom/images/2024/10/new-macbook-pro/article/Apple-MacBook-Pro-M4-lifestyle-02.zip" download="" data-analytics-title="download image - Apple-MacBook-Pro-M4-lifestyle-02_big" aria-label="Download media, Two people work in a lab, with one using the new MacBook Pro."></a>
          </div>
      </figure>
    
  






    
    
    


     
     
    
    
        <div>
             
                 <div><strong>MacBook Pro with M4 Pro offers:<sup>1</sup></strong>
</div>
                 
             
                 <div><ul>
<li>Up to 4x faster scene rendering performance with Maxon Redshift when compared to the 16-inch MacBook Pro with Core i9, and up to 3x faster when compared to the 16-inch MacBook Pro with M1 Pro.</li>
</ul>
</div>
                 
             
                 <div><ul>
<li>Up to 5x faster simulation of dynamical systems in MathWorks MATLAB when compared to the 16-inch MacBook Pro with Core i9, and up to 2.2x faster when compared to the 16-inch MacBook Pro with M1 Pro.</li>
</ul>
</div>
                 
             
                 <div><ul>
<li>Up to 23.8x faster basecalling for DNA sequencing in Oxford Nanopore MinKNOW when compared to the 16-inch MacBook Pro with Core i9, and up to 1.8x faster when compared to the 16-inch MacBook Pro with M1 Pro.</li>
</ul>
</div>
                 
             
         </div>
 

    
    
    


    
    
        
        
        
            <div role="group" aria-label="gallery" data-component-list="MixinGallery" id="macbook-pro-m4-pro-workflows">
            <nav role="presentation">
                <ul role="tablist">
                    
                        <li role="presentation">
                            <a id="gallery-dotnav-67b1179c669e36224b07ff92d8ff1291" href="#gallery-67b1179c669e36224b07ff92d8ff1291" data-ac-gallery-trigger="gallery-67b1179c669e36224b07ff92d8ff1291"><span>A user works in Fusion on the new MacBook Pro.</span></a>
                        </li>
                    
                        <li role="presentation">
                            <a id="gallery-dotnav-5d95f85875db4499732c2b5318c2f27b" href="#gallery-5d95f85875db4499732c2b5318c2f27b" data-ac-gallery-trigger="gallery-5d95f85875db4499732c2b5318c2f27b"><span>A user works in Luna Modeler on the new MacBook Pro.</span></a>
                        </li>
                    
                        <li role="presentation">
                            <a id="gallery-dotnav-1d2a1510f37c521f0c1ef7d42b17661e" href="#gallery-1d2a1510f37c521f0c1ef7d42b17661e" data-ac-gallery-trigger="gallery-1d2a1510f37c521f0c1ef7d42b17661e"><span>A user works in Xcode on the new MacBook Pro.</span></a>
                        </li>
                    
                </ul>
            </nav>
            <div>
                
                    
                        
                        <div id="gallery-67b1179c669e36224b07ff92d8ff1291" aria-labelledby="gallery-dotnav-67b1179c669e36224b07ff92d8ff1291" data-gallery-item="">
                            <figure role="presentation" data-analytics-activitymap-region-id="Gallery:fusion">
                                
                                <div>
                                    <div>The new MacBook Pro with M4 Pro speeds up a variety of workflows such as structural engineering, data modeling, and more.</div>
                                    
                                    
                                    <a href="https://www.apple.com/newsroom/images/2024/10/new-macbook-pro/article/Apple-MacBook-Pro-M4-Fusion.zip" download="" data-analytics-title="download image - Apple-MacBook-Pro-M4-Fusion_big" aria-label="Download media, A user works in Fusion on the new MacBook Pro."></a>
                                </div>
                            </figure>
                        </div>
                        
                    
                
                    
                        
                        <div id="gallery-5d95f85875db4499732c2b5318c2f27b" aria-labelledby="gallery-dotnav-5d95f85875db4499732c2b5318c2f27b" data-gallery-item="">
                            <figure role="presentation" data-analytics-activitymap-region-id="Gallery:luna-modeler">
                                
                                <div>
                                    <div>The new MacBook Pro with M4 Pro speeds up a variety of workflows such as structural engineering, data modeling, and more.</div>
                                    
                                    
                                    <a href="https://www.apple.com/newsroom/images/2024/10/new-macbook-pro/article/Apple-MacBook-Pro-M4-Luna-Modeler.zip" download="" data-analytics-title="download image - Apple-MacBook-Pro-M4-Luna-Modeler_big" aria-label="Download media, A user works in Luna Modeler on the new MacBook Pro."></a>
                                </div>
                            </figure>
                        </div>
                        
                    
                
                    
                        
                        <div id="gallery-1d2a1510f37c521f0c1ef7d42b17661e" aria-labelledby="gallery-dotnav-1d2a1510f37c521f0c1ef7d42b17661e" data-gallery-item="">
                            <figure role="presentation" data-analytics-activitymap-region-id="Gallery:xcode">
                                
                                <div>
                                    <div>The new MacBook Pro with M4 Pro speeds up a variety of workflows such as structural engineering, data modeling, and more.</div>
                                    
                                    
                                    <a href="https://www.apple.com/newsroom/images/2024/10/new-macbook-pro/article/Apple-MacBook-Pro-M4-Cinema-4D-Slack-Finder-Xcode.zip" download="" data-analytics-title="download image - Apple-MacBook-Pro-M4-Cinema-4D-Slack-Finder-Xcode_big" aria-label="Download media, A user works in Xcode on the new MacBook Pro."></a>
                                </div>
                            </figure>
                        </div>
                        
                    
                
            </div>
            
                
                
                <nav role="presentation">
                    
                        <ul>
                            <li>
                                
                            </li>
                            <li>
                                
                            </li>
                        </ul>
                    
                </nav>
            
        </div>
    


    
    
    


     
     
    
    
        <div>
             
                 <h2><strong>MacBook Pro with M4 Max: The Ultimate in Pro Performance</strong>
</h2>
                 
             
                 <div>Designed for pros like data scientists, 3D artists, and composers who constantly push workflows to the limit, MacBook Pro with M4 Max empowers users to work on projects that were previously only imaginable on a desktop. M4 Max brings up to a 16-core CPU, up to a 40-core GPU, over half a terabyte per second of unified memory bandwidth, and a Neural Engine that is over 3x faster than M1 Max, allowing on-device AI models to run faster than ever. With M4 Max, MacBook Pro delivers up to 3.5x the performance of M1 Max, ripping through heavy creative workloads like visual effects, 3D animation, and film scoring.<sup>1</sup> It also supports up to 128GB of unified memory, so developers can easily interact with LLMs that have nearly 200 billion parameters. And with the powerful Media Engine in M4 Max, which features two ProRes accelerators, MacBook Pro performance is amazing even when taking 4K120 fps ProRes video captured with the new iPhone 16 Pro and editing it in Final Cut Pro.
</div>
                 
             
                 <div><strong>MacBook Pro with M4 Max enables:<sup>1</sup></strong>
</div>
                 
             
                 <div><ul>
<li>Up to 7.8x faster scene rendering performance with Maxon Redshift when compared to the 16-inch MacBook Pro with Intel Core i9, and up to 3.5x faster when compared to the 16-inch MacBook Pro with M1 Max.</li>
</ul>
</div>
                 
             
                 <div><ul>
<li>Up to 4.6x faster build performance when compiling code in Xcode when compared to the 16‑inch MacBook Pro with Intel Core i9, and up to 2.2x faster when compared to the 16‑inch MacBook Pro with M1 Max.</li>
</ul>
</div>
                 
             
                 <div><ul>
<li>Up to 30.8x faster video processing performance in Topaz Video AI when compared to the 16‑inch MacBook Pro with Intel Core i9, and up to 1.6x faster when compared to the 16-inch MacBook Pro with M1 Max.</li>
</ul>
</div>
                 
             
         </div>
 

    
    
    


    
    
        
        
        
            <div role="group" aria-label="gallery" data-component-list="MixinGallery" id="macbook-pro-m4-max-workflows">
            <nav role="presentation">
                <ul role="tablist">
                    
                        <li role="presentation">
                            <a id="gallery-dotnav-e7f3015f7a7b3c6c39f9c8f972852143" href="#gallery-e7f3015f7a7b3c6c39f9c8f972852143" data-ac-gallery-trigger="gallery-e7f3015f7a7b3c6c39f9c8f972852143"><span>Flame is shown on MacBook Pro with M4 Max.</span></a>
                        </li>
                    
                        <li role="presentation">
                            <a id="gallery-dotnav-51972600b23331ea62e5a7a7473b2cda" href="#gallery-51972600b23331ea62e5a7a7473b2cda" data-ac-gallery-trigger="gallery-51972600b23331ea62e5a7a7473b2cda"><span>LM Studio is shown on MacBook Pro with M4 Max.</span></a>
                        </li>
                    
                </ul>
            </nav>
            <div>
                
                    
                        
                        <div id="gallery-e7f3015f7a7b3c6c39f9c8f972852143" aria-labelledby="gallery-dotnav-e7f3015f7a7b3c6c39f9c8f972852143" data-gallery-item="">
                            <figure role="presentation" data-analytics-activitymap-region-id="Gallery:flame">
                                
                                <div>
                                    <div>With M4 Max, MacBook Pro rips through the heaviest creative workloads like visual effects, 3D animation, and film scoring.</div>
                                    
                                    
                                    <a href="https://www.apple.com/newsroom/images/2024/10/new-macbook-pro/article/Apple-MacBook-Pro-M4-Flame.zip" download="" data-analytics-title="download image - Apple-MacBook-Pro-M4-Flame_big" aria-label="Download media, Flame is shown on MacBook Pro with M4 Max."></a>
                                </div>
                            </figure>
                        </div>
                        
                    
                
                    
                        
                        <div id="gallery-51972600b23331ea62e5a7a7473b2cda" aria-labelledby="gallery-dotnav-51972600b23331ea62e5a7a7473b2cda" data-gallery-item="">
                            <figure role="presentation" data-analytics-activitymap-region-id="Gallery:lm-studio">
                                
                                <div>
                                    <div>With support for up to 128GB of unified memory, developers can easily interact with LLMs that have nearly 200 billion parameters.</div>
                                    
                                    
                                    <a href="https://www.apple.com/newsroom/images/2024/10/new-macbook-pro/article/Apple-MacBook-Pro-M4-LM-Studio.zip" download="" data-analytics-title="download image - Apple-MacBook-Pro-M4-LM-Studio_big" aria-label="Download media, LM Studio is shown on MacBook Pro with M4 Max."></a>
                                </div>
                            </figure>
                        </div>
                        
                    
                
            </div>
            
                
                
                <nav role="presentation">
                    
                        <ul>
                            <li>
                                
                            </li>
                            <li>
                                
                            </li>
                        </ul>
                    
                </nav>
            
        </div>
    


    
    
    


     
     
    
    
        <div>
             
                 <h2><strong>Industry-Leading Liquid XDR Display Gets Even Better</strong>
</h2>
                 
             
                 <div>The new MacBook Pro introduces an all-new nano-texture display option that dramatically reduces glare and distractions from reflections. In bright lighting conditions, the new MacBook Pro can now show SDR content at up to 1000 nits and still displays HDR content at up to 1600 nits of peak brightness. All together, it’s a game-changing experience for users working outdoors.
</div>
                 
             
         </div>
 

    
    
    






  
    
    
    
    
      <figure aria-label="Media, A user works on MacBook Pro outdoors in a field of vegetables.">
        <div>
             
              
              <div>
                A game changer when working outdoors, the Liquid Retina XDR display gets even better with an all-new nano-texture display option and up to 1000 nits of brightness for SDR content.
              </div>
            
            
            
            
            <a href="https://www.apple.com/newsroom/images/2024/10/new-macbook-pro/article/Apple-MacBook-Pro-M4-lifestyle-03.zip" download="" data-analytics-title="download image - Apple-MacBook-Pro-M4-lifestyle-03_big" aria-label="Download media, A user works on MacBook Pro outdoors in a field of vegetables."></a>
          </div>
      </figure>
    
  






    
    
    


     
     
    
    
        <div>
             
                 <h2><strong>New 12MP Center Stage Camera</strong>
</h2>
                 
             
                 <div>MacBook Pro includes a new 12MP Center Stage camera that delivers enhanced video quality in challenging lighting conditions. Video calls are even more engaging with Center Stage, which automatically keeps users centered in the frame as they move around. The new camera also supports Desk View, which adds a whole new dimension to video calls. And with studio-quality mics and a phenomenal six-speaker sound system with support for Spatial Audio, MacBook Pro delivers an incredibly immersive audio experience whether users are listening to music or watching a movie in Dolby Atmos.
</div>
                 
             
         </div>
 

    
    
    


    
    <div data-component-list="ScrollAnimationDefault AutoPlayVideo">
        <div>MacBook Pro features a new 12MP Center Stage camera, which keeps users centered in the frame, and supports Desk View, which adds a whole new dimension to video calls.</div>
        
            <a aria-label="Download video: MacBook Pro Video Call with Center Stage" data-analytics-title="Download video - MacBook Pro Video Call with Center Stage" download="" href="https://www.apple.com/newsroom/videos/videos-2024/autoplay/2024/10/apple-macbook-pro-m4-center-stage-camera/downloads/Apple-MacBook-Pro-M4-Center-Stage-camera.zip">
            </a>
        
    </div>






    
    
    


     
     
    
    
        <div>
             
                 <h2><strong>Thunderbolt 5 Comes to the Mac</strong>
</h2>
                 
             
                 <div>MacBook Pro with M4 Pro and M4 Max features Thunderbolt 5 ports that more than double transfer speeds up to 120 Gb/s, enabling faster external storage, expansion chassis, and powerful docking and hub solutions. For example, by connecting just a single cable, pros like music producers can now light up their entire studio. All MacBook Pro models feature an HDMI port that supports up to 8K resolution, a SDXC card slot, a MagSafe 3 port for charging, and a headphone jack, along with support for Wi-Fi 6E and Bluetooth 5.3.
</div>
                 
             
         </div>
 

    
    
    






  
    
    
    
    
      <figure aria-label="Media, A close-up of the keyboard on MacBook Pro and its Thunderbolt 5 ports with plugged-in peripherals.">
        <div>
             
              
              <div>
                MacBook Pro with M4 Pro and M4 Max now features Thunderbolt 5 with faster transfer speeds that enable powerful docking and hub solutions, allowing pros to connect to higher-bandwidth gear with a single cable.
              </div>
            
            
            
            
            <a href="https://www.apple.com/newsroom/images/2024/10/new-macbook-pro/article/Apple-MacBook-Pro-M4-connectivity.zip" download="" data-analytics-title="download image - Apple-MacBook-Pro-M4-connectivity_big" aria-label="Download media, A close-up of the keyboard on MacBook Pro and its Thunderbolt 5 ports with plugged-in peripherals."></a>
          </div>
      </figure>
    
  






    
    
    


     
     
    
    
        <div>
             
                 <h2><strong>A New Era with Apple Intelligence on the Mac</strong>
</h2>
                 
             
                 <div><a href="https://www.apple.com/newsroom/2024/10/apple-intelligence-is-available-today-on-iphone-ipad-and-mac/" target="_blank">Apple Intelligence</a> ushers in a new era for the Mac, bringing personal intelligence to the personal computer. Combining powerful generative models with industry-first privacy protections, Apple Intelligence harnesses the power of Apple silicon and the Neural Engine to unlock new ways for users to work, communicate, and express themselves on Mac. It is available in U.S. English with macOS Sequoia 15.1. With systemwide Writing Tools, users can refine their words by rewriting, proofreading, and summarizing text nearly everywhere they write. With the newly redesigned Siri, users can move fluidly between spoken and typed requests to accelerate tasks throughout their day, and Siri can answer thousands of questions about Mac and other Apple products. New Apple Intelligence features will be available in December, with additional capabilities rolling out in the coming months. Image Playground gives users a new way to create fun original images, and Genmoji allows them to create custom emoji in seconds. Siri will become even more capable, with the ability to take actions across the system and draw on a user’s personal context to deliver intelligence that is tailored to them. In December, ChatGPT will be integrated into Siri and Writing Tools, allowing users to access its expertise without needing to jump between tools.
</div>
                 
             
         </div>
 

    
    
    


    
    <div data-component-list="ScrollAnimationDefault AutoPlayVideo">
        <div>Apple Intelligence transforms the things users do every day on their Mac. With brand-new Writing Tools, users can rewrite, proofread, or summarize everything from daily emails to important projects.</div>
        
            <a aria-label="Download video: Apple Intelligence Writing Tools" data-analytics-title="Download video - Apple Intelligence Writing Tools" download="" href="https://www.apple.com/newsroom/videos/videos-2024/autoplay/2024/10/apple-macbook-pro-m4-writing-tools/downloads/Apple-MacBook-Pro-M4-Writing-Tools.zip">
            </a>
        
    </div>






    
    
    


     
     
    
    
        <div>
             
                 <div>Apple Intelligence does all this while protecting users’ privacy at every step. At its core is on-device processing, and for more complex tasks, Private Cloud Compute gives users access to Apple’s even larger, server-based models and offers groundbreaking protections for personal information. In addition, users can access ChatGPT for free without creating an account, and privacy protections are built in — their IP addresses are obscured and OpenAI won’t store requests. For those who choose to connect their account, OpenAI’s data-use policies apply.
</div>
                 
             
                 <h2><strong>An Unrivaled Experience with macOS Sequoia</strong>
</h2>
                 
             
                 <div><a href="https://www.apple.com/macos/macos-sequoia-preview/" target="_blank">macOS Sequoia</a> completes the new MacBook Pro experience with a host of exciting features, including iPhone Mirroring, allowing users to wirelessly interact with their iPhone, its apps, and notifications directly from their Mac.<sup>4</sup> Safari, the world’s fastest browser,<sup>5</sup> now offers Highlights, which quickly pulls up relevant information from a site; a smarter, redesigned Reader with a table of contents and high-level summary; and a new Video Viewer to watch videos without distractions. With Distraction Control, users can hide items on a webpage that they may find disruptive to their browsing. Gaming gets even more immersive with features like Personalized Spatial Audio and improvements to Game Mode, along with a breadth of exciting titles, including the upcoming Assassin’s Creed Shadows. Easier window tiling means users can stay organized with a windows layout that works best for them. The all-new Passwords app gives convenient access to passwords, passkeys, and other credentials, all stored in one place. And users can apply new beautiful built-in backgrounds for video calls, which include a variety of color gradients and system wallpapers, or upload their own photos.
</div>
                 
             
                 <h2><strong>The Perfect Time to Upgrade or Switch to a Mac</strong>
</h2>
                 
             
                 <div>Upgraders will get monumental improvements over Intel-based MacBook Pro models, including the amazing features of Apple Intelligence. When compared to an Intel-based MacBook Pro, the new MacBook Pro provides nearly 10x faster performance for AI-based workloads,<sup>1</sup> and for graphics-intensive workloads, users get up to 20x faster performance.<sup>6</sup> With battery life on the new MacBook Pro now up to 24 hours, upgraders will also experience up to 14 additional hours. And with the Liquid Retina XDR display, a new 12MP Center Stage camera, an immersive six-speaker sound system, the unrivaled experience of macOS Sequoia, and more, there’s never been a better time to upgrade or switch to MacBook Pro.
</div>
                 
             
                 <h2><strong>MacBook Air: The World’s Most Popular Laptop Now Starts at 16GB</strong>
</h2>
                 
             
                 <div>MacBook Air is the world’s most popular laptop, and with Apple Intelligence, it’s even better. Now, models with M2 and M3 double the starting memory to 16GB, while keeping the starting price at just $999 — a terrific value for the world’s best-selling laptop.
</div>
                 
             
                 <h2><strong>Better for the Environment</strong>
</h2>
                 
             
                 <div>The new MacBook Pro is built to last and incredibly durable, created from a custom alloy that uses 100 percent recycled aluminum in the enclosure. It also uses 100 percent recycled rare earth elements in all magnets, and 100 percent recycled tin soldering, gold plating, and copper in multiple printed circuit boards. The packaging for the 14-inch MacBook Pro is now entirely fiber-based, joining the 16-inch MacBook Pro and bringing Apple closer to its goal to remove plastic from its packaging by 2025.
</div>
                 
             
                 <div>Today, Apple is carbon neutral for global corporate operations and, as part of its ambitious Apple 2030 goal, plans to be carbon neutral across its entire carbon footprint by the end of this decade.
</div>
                 
             
         </div>
 

    
    
    


     
     
    
    
        <div>
             
                 
                 
             
                 <div><ul>
<li>Customers can pre-order the new MacBook Pro starting today, October 30, on <a href="https://www.apple.com/store/" target="_blank">apple.com/store</a> and in the Apple Store app in 28 countries and regions, including the U.S. It will begin arriving to customers, and will be in Apple Store locations and Apple Authorized Resellers, beginning Friday, November 8.</li>
</ul>
</div>
                 
             
                 <div><ul>
<li>The 14-inch MacBook Pro with M4 starts at <strong>$1,599</strong> (U.S.) and <strong>$1,499</strong> (U.S.) for education; the 14‑inch MacBook Pro with M4 Pro starts at <strong>$1,999</strong> (U.S.) and <strong>$1,849 </strong>(U.S.) for education; and the 16‑inch MacBook Pro starts at <strong>$2,499</strong> (U.S.) and <strong>$2,299 </strong>(U.S.) for education. All models are available in space black and silver.</li>
</ul>
</div>
                 
             
                 <div><ul>
<li>Additional technical specifications, including the nano-texture display and configure-to-order options, are available at <a href="https://www.apple.com/mac/" target="_blank">apple.com/mac</a>.</li>
</ul>
</div>
                 
             
                 <div><ul>
<li>MacBook Air with M2 and M3 comes standard with 16GB of unified memory, and is available in midnight, starlight, silver, and space gray, starting at <strong>$999</strong> (U.S.) and <strong>$899</strong> (U.S.) for education.</li>
</ul>
</div>
                 
             
                 <div><ul>
<li>New accessories with USB-C — including Magic Keyboard (<strong>$99 </strong>U.S.), Magic Keyboard with Touch ID (<strong>$149</strong> U.S.), Magic Keyboard with Touch ID and Numeric Keypad (<strong>$179</strong> U.S.), Magic Trackpad (<strong>$129 </strong>U.S.), Magic Mouse (<strong>$79</strong> U.S.), and Thunderbolt 5 Pro Cable (<strong>$69</strong>) — are available at <a href="https://www.apple.com/store/" target="_blank">apple.com/store</a>.</li>
</ul>
</div>
                 
             
                 <div><ul>
<li>Apple Intelligence is available now as a free software update for Mac with M1 and later, and can be accessed in most regions around the world when the device and Siri language are set to U.S. English. The first set of features is in beta and available with macOS Sequoia 15.1, with more features rolling out in the months to come.</li>
</ul>
</div>
                 
             
                 <div><ul>
<li>Apple Intelligence is quickly adding support for more languages. In December, Apple Intelligence will add support for localized English in <em>Australia</em>, <em>Canada</em>, <em>Ireland</em>, <em>New Zealand</em>, <em>South Africa</em>, and the <em>U.K.,</em> and in April, a software update will deliver expanded language support, with more coming throughout the year. Chinese, English (India), English (Singapore), French, German, Italian, Japanese, Korean, Portuguese, Spanish, Vietnamese, and other languages will be supported.</li>
</ul>
</div>
                 
             
                 <div><ul>
<li>With Apple Trade In, customers can trade in their current computer and get credit toward a new Mac. Customers can visit <a href="https://www.apple.com/shop/trade-in/" target="_blank">apple.com/shop/trade-in</a> to see what their device is worth.</li>
</ul>
</div>
                 
             
                 <div><ul>
<li>AppleCare+ for Mac provides unparalleled service and support. This includes unlimited incidents of accidental damage, battery service coverage, and 24/7 support from the people who know Mac best.</li>
</ul>
</div>
                 
             
                 <div><ul>
<li>Every customer who buys directly from Apple Retail gets access to Personal Setup. In these guided online sessions, a Specialist can walk them through setup, or focus on features that help them make the most of their new device. Customers can also learn more about getting started with their new device with a Today at Apple session at their nearest Apple Store.</li>
</ul>
</div>
                 
             
         </div>
 

    
    
    




    
    
        
    


    
    
    



    
    
    




    




    
    
    





    
    
    <div>
            <ol>
<li>Testing was conducted by Apple from August through October 2024. Battery life varies by use and configuration. See <a href="https://www.apple.com/macbook-pro/" target="_blank">apple.com/macbook-pro</a> for more information.</li>
<li>Testing was conducted by Apple in October 2024 using shipping competitive systems and select industry-standard benchmarks.</li>
<li>Based on published technical specifications of shipping competitive chips as of October 2024.</li>
<li>Available on Mac computers with Apple&nbsp;silicon and Intel-based Mac computers with a T2 Security Chip. Requires that the user’s iPhone and Mac are signed in with the same Apple&nbsp;Account using two-factor authentication, their iPhone and Mac are near each other and have Bluetooth and Wi-Fi turned on, and their Mac is not using AirPlay or Sidecar. Some iPhone features (e.g., camera and microphone) are not compatible with iPhone&nbsp;Mirroring.</li>
<li>Testing was conducted by Apple in August 2024. See <a href="https://www.apple.com/safari/" target="_blank">apple.com/safari</a> for more information.</li>
<li>Results are compared to previous-generation 1.7GHz quad-core Intel Core i7-based 13-inch MacBook&nbsp;Pro systems with Intel Iris Plus Graphics 645, 16GB of RAM, and 2TB SSD.</li>
</ol>

        </div>



    
    
    






    

















		
		
			
























		
		

</article>



</section>
</main>


	

</div>]]></description>
        </item>
        <item>
            <title><![CDATA[Internal representations of LLMs encode information about truthfulness (129 pts)]]></title>
            <link>https://arxiv.org/abs/2410.02707</link>
            <guid>41995201</guid>
            <pubDate>Wed, 30 Oct 2024 14:22:18 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://arxiv.org/abs/2410.02707">https://arxiv.org/abs/2410.02707</a>, See on <a href="https://news.ycombinator.com/item?id=41995201">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="content-inner">
    
    
                
    <p><a href="https://arxiv.org/pdf/2410.02707">View PDF</a>
    <a href="https://arxiv.org/html/2410.02707v3">HTML (experimental)</a></p><blockquote>
            <span>Abstract:</span>Large language models (LLMs) often produce errors, including factual inaccuracies, biases, and reasoning failures, collectively referred to as "hallucinations". Recent studies have demonstrated that LLMs' internal states encode information regarding the truthfulness of their outputs, and that this information can be utilized to detect errors. In this work, we show that the internal representations of LLMs encode much more information about truthfulness than previously recognized. We first discover that the truthfulness information is concentrated in specific tokens, and leveraging this property significantly enhances error detection performance. Yet, we show that such error detectors fail to generalize across datasets, implying that -- contrary to prior claims -- truthfulness encoding is not universal but rather multifaceted. Next, we show that internal representations can also be used for predicting the types of errors the model is likely to make, facilitating the development of tailored mitigation strategies. Lastly, we reveal a discrepancy between LLMs' internal encoding and external behavior: they may encode the correct answer, yet consistently generate an incorrect one. Taken together, these insights deepen our understanding of LLM errors from the model's internal perspective, which can guide future research on enhancing error analysis and mitigation.
    </blockquote>

    <!--CONTEXT-->
    
  </div><div>
      <h2>Submission history</h2><p> From: Hadas Orgad [<a href="https://arxiv.org/show-email/660cb3e9/2410.02707">view email</a>]      <br>            <strong><a href="https://arxiv.org/abs/2410.02707v1">[v1]</a></strong>
        Thu, 3 Oct 2024 17:31:31 UTC (2,525 KB)<br>
            <strong><a href="https://arxiv.org/abs/2410.02707v2">[v2]</a></strong>
        Mon, 7 Oct 2024 14:46:11 UTC (2,530 KB)<br>
    <strong>[v3]</strong>
        Mon, 28 Oct 2024 12:33:44 UTC (2,360 KB)<br>
</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Thunderbird for Android Now Available (203 pts)]]></title>
            <link>https://blog.thunderbird.net/2024/10/thunderbird-for-android-8-0-takes-flight/</link>
            <guid>41995041</guid>
            <pubDate>Wed, 30 Oct 2024 14:11:44 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://blog.thunderbird.net/2024/10/thunderbird-for-android-8-0-takes-flight/">https://blog.thunderbird.net/2024/10/thunderbird-for-android-8-0-takes-flight/</a>, See on <a href="https://news.ycombinator.com/item?id=41995041">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
								<img src="https://blog.thunderbird.net/files/2024/10/blog-banner-TBfA.jpg" alt="featured post title image">
						<section>
												

				
<p>Just over two years ago, we <a href="https://blog.thunderbird.net/2022/06/revealed-thunderbird-on-android-plans-k9/">announced our plans</a> to bring Thunderbird to Android by taking K-9 Mail under our wing. The journey took a <a href="https://blog.thunderbird.net/2023/12/when-will-thunderbird-for-android-be-released/">little longer than we had originally anticipated</a> and there was a lot to learn along the way, but the wait is finally over! For all of you who have ever asked “when is Thunderbird for Android coming out?”, the answer is – today! We are excited to announce that the first stable release of Thunderbird for Android is out now, and we couldn’t be prouder of the newest, most mobile member of the Thunderbird family.</p>



<h2>Resources</h2>



<ul>
<li><strong>What’s New</strong>: <a href="https://support.mozilla.org/kb/new-thunderbird-android-version-8">https://support.mozilla.org/kb/new-thunderbird-android-version-8</a></li>



<li><strong>Detailed Release Notes:</strong> <a href="https://github.com/thunderbird/thunderbird-android/releases/tag/THUNDERBIRD_8_0">https://github.com/thunderbird/thunderbird-android/releases/tag/THUNDERBIRD_8_0</a></li>



<li><strong>Community Support Forum</strong>: Thunderbird for Android has its own home on the <a href="https://support.mozilla.org/en-US/products/thunderbird-android">official Mozilla Support (SUMO) forums</a>. Find the help you need to configure and use the newest Thunderbird from our community on a mobile friendly site.</li>



<li><strong>Import Settings:</strong> Whether you’re importing your information from K-9 Mail or Thunderbird on the desktop, transfer your information <a href="https://support.mozilla.org/en-US/kb/thunderbird-android-import">quickly and easily with our guide</a>.</li>



<li><strong>System Requirements</strong>: Thunderbird for Android runs on mobile devices running Android 5 and above.</li>



<li><strong>Platform Availability</strong>: Download Thunderbird for Android from the following places. Availability on F-Droid will be coming soon.


<ul>
<li><a href="https://play.google.com/store/apps/details?id=net.thunderbird.android&amp;referrer=utm_campaign%3Dandroid_release_appeal_2024%26utm_medium%3Dweb%26utm_source%3Dblog%26utm_content%3Dlink">Google Play Store</a></li>



<li><a href="https://github.com/thunderbird/thunderbird-android/releases/tag/THUNDERBIRD_8_0">GitHub Releases</a> (apk)</li>
</ul>



<ul>
<li>The <a href="https://thunderbird.net/mobile/">Thunderbird website</a> (on an Android device)</li>
</ul>
</li>



<li><strong>Get Involved:</strong> Thunderbird for Android thrives thanks to community support, and you can be part of the community! We are grateful to everyone who donates their skill and time to answer support questions, test releases, translate and more. <a href="https://blog.thunderbird.net/2024/09/contribute-to-thunderbird-for-android/">Find out all the ways to get in where you fit in.</a></li>



<li><strong>Support Us:</strong> We are 100% donor-supported. Your gift helps us develop new apps (like this one!), improve speed and stability, promote Thunderbird and software freedom, and provide downloads free-of-charge to millions. Donate on <a href="https://www.thunderbird.net/?form=tfa&amp;utm_campaign=android_release_appeal_2024&amp;utm_medium=web&amp;utm_source=blog.thunderbird.net&amp;utm_content=link">our webpage</a> or in the app.</li>



<li><strong>Suggest New Features:</strong> We know you have great ideas for future features. You can share them on Mozilla Connect, where community members can upvote and comment on them. Our team uses the feedback here to help shape our roadmap.</li>
</ul>



<h2>Thanks for Helping Thunderbird for Android Fly</h2>



<p>Thank you for being a part of the community and sharing this adventure on Android with us! We’re especially grateful to all of you who have helped us test the beta and release candidate images. Your feedback helped us find and fix bugs, test key features, and polish the stable release. We hope you enjoy using the newest Thunderbird, now and for a long time to come!</p>
				

			</section>
			

			
			</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Dropbox announces 20% global workforce reduction (468 pts)]]></title>
            <link>https://blog.dropbox.com/topics/company/an-update-from-drew</link>
            <guid>41994640</guid>
            <pubDate>Wed, 30 Oct 2024 13:42:52 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://blog.dropbox.com/topics/company/an-update-from-drew">https://blog.dropbox.com/topics/company/an-update-from-drew</a>, See on <a href="https://news.ycombinator.com/item?id=41994640">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>










<header>
    <div>
        <div>
            
            <figure>
                <div>
                    
                    
    

        

        
        
        <!--<sly data-sly-use.assetPath1x="com.dropbox.aem.common.models.utils.RewriterHelperModel"/>-->

        
        
        <!--<sly data-sly-test.scaledImagePath=""/>-->

		 <!--optimized image webp-->
        
        
        

        
        <!--<img data-sly-test.highRes="false"
                srcset=", /cms/content/dam/dropbox/blog/company/2023/glyphs/Dropbox_Glyph_grey_1200x628.jpg 2x"
                src="/cms/content/dam/dropbox/blog/company/2023/glyphs/Dropbox_Glyph_grey_1200x628.jpg"
                aria-hidden=""
                alt="1200x628"
                class=""
                data-sly-attribute.width="auto"
                data-sly-attribute.height="auto"
                data-sly-attribute.data-id=""
                data-aem-asset-id="8448f2b6-1123-45bd-9e1f-cb32e1e3daae:Dropbox_Glyph_grey_1200x628.jpg"
                data-trackable="true" />
        <img data-sly-test="true"
                src="/cms/content/dam/dropbox/blog/company/2023/glyphs/Dropbox_Glyph_grey_1200x628.jpg"
                aria-hidden="false"
                alt="1200x628"
                class=""
                data-sly-attribute.width="auto"
                data-sly-attribute.height="auto"
                data-sly-attribute.data-id=""
                data-aem-asset-id="8448f2b6-1123-45bd-9e1f-cb32e1e3daae:Dropbox_Glyph_grey_1200x628.jpg"
                data-trackable="true" />-->

	    
      <picture>
        <source media="(min-width: 800px)" srcset="https://aem.dropbox.com/cms/content/dam/dropbox/blog/company/2023/glyphs/Dropbox_Glyph_grey_1200x628.jpg/_jcr_content/renditions/Dropbox_Glyph_grey_1200x628.webp" fallbackimage="https://aem.dropbox.com/cms/content/dam/dropbox/blog/company/2023/glyphs/Dropbox_Glyph_grey_1200x628.jpg">
        <source media="(min-width: 480px)" srcset="https://aem.dropbox.com/cms/content/dam/dropbox/blog/company/2023/glyphs/Dropbox_Glyph_grey_1200x628.jpg/_jcr_content/renditions/Dropbox_Glyph_grey_1200x628.tablet.webp" fallbackimage="https://aem.dropbox.com/cms/content/dam/dropbox/blog/company/2023/glyphs/Dropbox_Glyph_grey_1200x628.jpg/_jcr_content/renditions/Dropbox_Glyph_grey_1200x628.tablet.webp">
        <source media="(min-width: 0px)" srcset="https://aem.dropbox.com/cms/content/dam/dropbox/blog/company/2023/glyphs/Dropbox_Glyph_grey_1200x628.jpg/_jcr_content/renditions/Dropbox_Glyph_grey_1200x628.mobile.webp" fallbackimage="https://aem.dropbox.com/cms/content/dam/dropbox/blog/company/2023/glyphs/Dropbox_Glyph_grey_1200x628.jpg/_jcr_content/renditions/Dropbox_Glyph_grey_1200x628.mobile.webp">
         <img loading="lazy" src="https://aem.dropbox.com/cms/content/dam/dropbox/blog/company/2023/glyphs/Dropbox_Glyph_grey_1200x628.jpg/_jcr_content/renditions/Dropbox_Glyph_grey_1200x628.webp" fallbackimage="https://aem.dropbox.com/cms/content/dam/dropbox/blog/company/2023/glyphs/Dropbox_Glyph_grey_1200x628.jpg" onerror="window.failedAttempts=0;this.setAttribute('src',this.getAttribute('fallbackimage'));window.failedAttempts++;if(window.failedAttempts == 1)this.onerror=null" aria-hidden="false" alt="1200x628" data-aem-asset-id="8448f2b6-1123-45bd-9e1f-cb32e1e3daae:Dropbox_Glyph_grey_1200x628.jpg" data-trackable="true" height="auto" width="auto">
        
      </picture>

    

                    
                </div>
                
            </figure>
            
        </div>
        <div data-color="coconut">
            <p>
                
                
                    <a href="https://blog.dropbox.com/topics/company">Company</a>
                
            </p>
            
            
            <p>Published on
                October 30, 2024
            </p>
            <!-- <p data-sly-test="" class="b01-article-hero-plank__photographer"></p> -->
        </div>
    </div>
</header>
</div><div data-highlight="cloud">

<p><i>Today, our cofounder and CEO Drew Houston shared the difficult news that we’ll be making reductions to our global workforce. He sent the following email to all employees:<br>
&nbsp;</i></p>
<p>Hi everyone,</p>
<p>I’m writing to let you all know that after careful consideration, we've decided to reduce our global workforce by approximately 20% or 528 Dropboxers.</p>
<p>As CEO, I take full responsibility for this decision and the circumstances that led to it, and I’m truly sorry to those impacted by this change.</p>
<h3>Why we're making this decision</h3>
<p>As we've shared over the last year, we're in a transitional period as a company. Our FSS business has matured, and we've been working to build our next phase of growth with products like Dash. However, navigating this transition while maintaining our current structure and investment levels is no longer sustainable.</p>
<p>We continue to see softening demand and macro headwinds in our core business. But external factors are only part of the story. We’ve heard from many of you that our organizational structure has become overly complex, with excess layers of management slowing us down.</p>
<p>And while I'm proud of the progress we’ve made in the last couple years, in some parts of the business, we’re still not delivering at the level our customers deserve or performing in line with industry peers. So we're making more significant cuts in areas where we're over-invested or underperforming while designing a flatter, more efficient team structure overall.</p>
<h3>The opportunity ahead</h3>
<p>The changes we're making today, while difficult, come at a pivotal moment when the market is accelerating precisely where we've placed our biggest bets. It's been tremendously rewarding over the last few weeks to see customers and prospects light up when using Dash for Business for the first time, much like people did when we first launched Dropbox.&nbsp;</p>
<p>And this time we're starting from a position of strength. Millions of customers trust us as the home for their most important files, making the leap to organizing all their cloud content a natural evolution.</p>
<p>But we're not operating on our own schedule. This market is moving fast and investors are pouring hundreds of millions of dollars into this space. This both validates the opportunity we've been pursuing and underscores the need for even more urgency, even more aggressive investment, and decisive action.</p>
<p>The steps we’re taking today are necessary to both strengthen our core product and accelerate the growth of our new products. We’ll share more about our 2025 strategy in the days ahead.</p>
<h3>Taking care of impacted employees</h3>
<p>To those leaving Dropbox, we're committed to supporting you through this transition. You’ll be eligible to receive the following benefits and support:</p>
<p><b>Severance, equity, and transition payment&nbsp;</b></p>
<ul>
<li>All impacted employees will be eligible for sixteen weeks of pay, starting today, with one additional week of pay for each completed year of tenure at Dropbox. Internationally, severance packages will vary depending on regional practices and statutory requirements.</li>
<li>All impacted employees will receive their Q4 equity vest.</li>
<li>Those on the Corporate Bonus plan will be eligible to receive a pro-rated lump sum transition payment equivalent to their 2024 bonus target based on company performance forecasts and aligned with their level.</li>
<li>We will pay out eligible remaining current and approved upcoming paid leaves, including medical or family leaves.</li>
<li>We will support impacted visa holders by providing additional time to transition and access to 1:1 immigration consultation.</li>
</ul>
<p><b>Healthcare and benefits</b></p>
<ul>
<li>US employees will be eligible for up to six months of COBRA.</li>
<li>Canada-based employees will be eligible for a one-month healthcare extension.</li>
<li>All employees will continue to have access to Modern Health to support their mental well-being.</li>
</ul>
<p><b>Devices</b></p>
<ul>
<li>Impacted employees will be eligible to keep company devices (phones, tablets, laptops, and peripherals) for personal use.</li>
</ul>
<p><b>Job placement</b></p>
<ul>
<li>Job placement services and career coaching will be available at no cost.</li>
</ul>
<h3>Next steps</h3>
<p>We'll be sharing more details on high-level changes later today and will host company-wide Town Halls later this week to answer questions and discuss our plans in more detail.</p>
<p>I know this is incredibly difficult and unwelcome news. To everyone leaving Dropbox, I’m deeply grateful for everything you've done for our company and our customers.</p>
<p>Drew</p>

</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Gross Apple Marketing (238 pts)]]></title>
            <link>https://jonathanbuys.com/Gross_Apple_Marketing/</link>
            <guid>41994567</guid>
            <pubDate>Wed, 30 Oct 2024 13:33:07 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://jonathanbuys.com/Gross_Apple_Marketing/">https://jonathanbuys.com/Gross_Apple_Marketing/</a>, See on <a href="https://news.ycombinator.com/item?id=41994567">Hacker News</a></p>
<div id="readability-page-1" class="page"><article>
	    <h3>Gross Apple Marketing</h3>
	    <time datetime="2024-10-29T15:47:31+00:00" pubdate="pubdate">October 29, 2024</time>

		<p>I’m not sure what’s going on over in Cupertino for them to think that <em>any</em> of the recent Apple Intelligence ads they’ve been running are a good idea. They’re cringy at best, and honestly just flat out insulting.</p>

<p>In one a <a href="https://www.youtube.com/watch?v=3m0MoYKwVTM">schlub writes an email</a> to his boss and uses AI to make it sound ‘more professional’, in another a young woman uses it to <a href="https://www.youtube.com/watch?v=TPe8revsg3k">lie about remembering an acquaintance’s name</a>. In another the same young woman again uses it to <a href="https://www.youtube.com/watch?v=_eJy6QyHaFM">lie about reading an email</a> from a college, to her face, while she’s sitting with her. In yet another, <a href="https://blog.blankbaby.com/2024/10/apple-intelligence-smug-and-gross.html">linked to recently by Scott McNulty</a>, a woman uses AI to lie to her husband about getting him something for his birthday.</p>

<p>If this is what Apple thinks their AI is for, I honestly don’t know that I want any part of it.</p>

<p>Compare and contrast with the <a href="https://jonathanbuys.com/Scout/">video I posted yesterday</a>, and with this beautiful animation from Canonical.</p>

<p>
<iframe src="https://www.youtube.com/embed/q5yM4ZYwB_s?si=u4GcyOGtdR1QztNe" frameborder="0" allowfullscreen=""></iframe>
</p>

<p>I’ve watched that little animation several times, and they tell a better story in a minute twenty-five than all of Apple’s AI commercials combined.</p>

	</article></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Lessons learned from a successful Rust rewrite (115 pts)]]></title>
            <link>https://gaultier.github.io/blog/lessons_learned_from_a_successful_rust_rewrite.html</link>
            <guid>41994189</guid>
            <pubDate>Wed, 30 Oct 2024 12:39:46 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://gaultier.github.io/blog/lessons_learned_from_a_successful_rust_rewrite.html">https://gaultier.github.io/blog/lessons_learned_from_a_successful_rust_rewrite.html</a>, See on <a href="https://news.ycombinator.com/item?id=41994189">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>

		<div>
			<p><a href="https://gaultier.github.io/blog"> ⏴ Back to all articles</a></p>

			<p>Published on 2024-10-30</p>
		</div>
		
 <p><strong>Table of contents</strong></p><ul>

<li>
	<a href="#what-worked-well">What worked well</a>
		</li>

<li>
	<a href="#what-did-not-work-so-well">What did not work so well</a>
		<ul>

<li>
	<a href="#i-am-still-chasing-undefined-behavior">I am still chasing Undefined Behavior</a>
		</li>

<li>
	<a href="#miri-does-not-always-work-and-i-still-have-to-use-valgrind">Miri does not always work and I still have to use Valgrind</a>
		</li>

<li>
	<a href="#i-am-still-chasing-memory-leaks">I am still chasing memory leaks</a>
		</li>

<li>
	<a href="#cross-compilation-does-not-always-work">Cross-compilation does not always work</a>
		</li>

<li>
	<a href="#cbindgen-does-not-always-work">Cbindgen does not always work</a>
		</li>

<li>
	<a href="#unstable-abi">Unstable ABI</a>
		</li>

<li>
	<a href="#no-support-for-custom-memory-allocators">No support for custom memory allocators</a>
		</li>

<li>
	<a href="#complexity">Complexity</a>
		</li>
</ul>
</li>

<li>
	<a href="#conclusion">Conclusion</a>
		</li>
</ul>

<p><em>Discussions: <a href="https://old.reddit.com/r/rust/comments/1gflxxh/lessons_learned_from_a_successful_rust_rewrite/?">/r/rust</a>, <a href="https://old.reddit.com/r/programming/comments/1gfljj7/lessons_learned_from_a_successful_rust_rewrite/?">/r/programming</a>, <a href="https://news.ycombinator.com/item?id=41994189">HN</a></em></p>
<p>I have written about my on-going rewrite-it-to-Rust effort at work: <a href="https://gaultier.github.io/blog/you_inherited_a_legacy_cpp_codebase_now_what.md">1</a>, <a href="https://gaultier.github.io/blog/how_to_rewrite_a_cpp_codebase_successfully.md">2</a>, <a href="https://gaultier.github.io/blog/rust_c++_interop_trick.html">3</a>. And now it's finished, meaning it's 100% Rust and 0% C++ - the public C API has not changed, just the implementation, one function at time until the end. Let's have a look back at what worked, what didn't, and what can be done about it.</p>
<p>For context, I have written projects in pure Rust before, so I won't mention all of the usual Rust complaints, like "learning it is hard", they did not affect me during this project.</p>
<h2 id="what-worked-well">
	<a href="#what-worked-well">What worked well</a>
	
</h2>
<p>The rewrite was done incrementally, in a stop-and-go fashion. At some point, as I expected, we had to add brand new features while the rewrite was on-going and that was very smooth with this approach. Contrast this with the (wrong) approach of starting a new codebase from scratch in parallel, and then the feature has to be implemented twice.</p>
<p>The new code is much, much simpler and easier to reason about. It is roughly the same number of lines of code as the old C++ codebase, or slightly more. Some people think that equivalent Rust code will be much shorter (I have heard ratios of 1/2 or 2/3), but in my experience, it's not really the case. C++ can be incredibly verbose in some instances, but Rust as well. And the C++ code will often ignore some errors that the Rust compiler forces the developer to handle, which is a good thing, but also makes the codebase slightly bigger.</p>
<p>Undergoing a rewrite, even a bug-for-bug one like ours, opens many new doors in terms of performance. For example, some fields in C++ were assumed to be of a dynamic size, but we realized that they were always 16 bytes according to business rules, so we stored them in an array of a fixed size, thus simplifying lots of code and reducing heap allocations. That's not strictly due to Rust, it's just that having this holistic view of the codebase yields many benefits.</p>
<p>Related to this: we delete lots and lots of dead code. I estimate that we removed perhaps a third or half of the whole C++ codebase because it was simply never used. Some of it were half-assed features some long-gone customer asked for, and some were simply never run or even worse, never even built (they were C++ files not even present in the CMake build system). I feel that modern programming languages such as Rust or Go are much more aggressive at flagging dead code and pestering the developer about it, which again, is a good thing.</p>
<p>We don't have to worry about out-of-bounds accesses and overflow/underflows with arithmetic. These were the main issues in the C++ code. Even if C++ containers have this <code>.at()</code> method to do bounds check, in my experience, most people do not use them. It's nice that this happens by default. And overflows/underflows checks are typically never addressed in C and C++ codebases.</p>
<p>Cross-compilation is pretty smooth, although not always, see next section.</p>
<p>The builtin test framework in Rust is very serviceable. All the ones I used in C++ were terrible and took so much time to even compile.</p>
<p>Rust is much more concerned with correctness than C++, so it sparked a lot of useful discussions. For example: oh, the Rust compiler is forcing me to check if this byte array is valid UTF8 when I try to convert it to a string. The old C++ code did no such check. Let's add this check.</p>
<p>It felt so good to remove all the CMake files. On all the C or C++ projects I worked on, I never felt that CMake was worth it and I always lost a lot of hours to coerce it into doing what I needed.</p>
<h2 id="what-did-not-work-so-well">
	<a href="#what-did-not-work-so-well">What did not work so well</a>
	
</h2>
<p>This section is surprisingly long and is the most interesting in my opinion. Did Rust hold its promises?</p>
<h3 id="i-am-still-chasing-undefined-behavior">
	<a href="#i-am-still-chasing-undefined-behavior">I am still chasing Undefined Behavior</a>
	
</h3>
<p>Doing an incremental rewrite from C/C++ to Rust, we had to use a lot of raw pointers and <code>unsafe{}</code> blocks. And even when segregating these to the entry point of the library, they proved to be a big pain in the neck.</p>
<p>All the stringent rules of Rust still apply inside these blocks but the compiler just stops checking them for you, so you are on your own. As such, it's so easy to introduce Undefined Behavior. I honestly think from this experience that it is easier to inadvertently introduce Undefined Behavior in Rust than in C++, and it turn, it's easier in C++ than in C.</p>
<p>The main rule in Rust is: <s>multiple read-only pointers XOR one mutable pointer</s> <code>multiple read-only reference XOR one mutable reference</code>. That's what the borrow checker is always pestering you about.</p>
<p>But when using raw pointers, it's so easy to silently break, especially when porting C or C++ code as-is, which is mutation and pointer heavy:</p>
<p><em>Note: Astute readers have pointed out that the issue in the snippet below is having multiple mutable references, not pointers, and that using the syntax <code>let a = &amp;raw mut x;</code> in recent Rust versions, or <code>addr_of_mut</code> in older versions, avoids creating multiple mutable references.</em></p>
<pre><code>fn main() {
    let mut x = 1;
    unsafe {
        let a: *mut usize = &amp;mut x;
        let b: *mut usize = &amp;mut x;

        *a = 2;
        *b = 3;
    }
}
</code></pre>
<p>You might think that this code is dumb and obviously wrong, but in a big real codebase, this is not so easy to spot, especially when these operations are hidden inside helper functions or layers and layers of abstraction, as Rust loves to do.</p>
<p><code>cargo run</code> is perfectly content with the code above. The Rust compiler can and will silently assume that there is only one mutable pointer to <code>x</code>, and make optimizations, and generate machine code, based on that assumption, which this code breaks.</p>
<p>The only savior here is <a href="https://github.com/rust-lang/miri">Miri</a>:</p>
<pre><code>$ cargo +nightly-2024-09-01 miri r
error: Undefined Behavior: attempting a write access using &lt;2883&gt; at alloc1335[0x0], but that tag does not exist in the borrow stack for this location
 --&gt; src/main.rs:7:9
  |
7 |         *a = 2;
  |         ^^^^^^
  |         |
  |         attempting a write access using &lt;2883&gt; at alloc1335[0x0], but that tag does not exist in the borrow stack for this location
  |         this error occurs as part of an access at alloc1335[0x0..0x8]
  |
  [...]
 --&gt; src/main.rs:4:29
  |
4 |         let a: *mut usize = &amp;mut x;
  |                             ^^^^^^
help: &lt;2883&gt; was later invalidated at offsets [0x0..0x8] by a Unique retag
 --&gt; src/main.rs:5:29
  |
5 |         let b: *mut usize = &amp;mut x;
  |                             ^^^^^^
  [...]
</code></pre>
<p>So, what could have been a compile time error, is now a runtime error. Great. I hope you have 100% test coverage! Thank god there's Miri.</p>
<p>If you are writing <code>unsafe{}</code> code without Miri checking it, or if you do so without absolutely having to, I think this is foolish. It will blow up in your face.</p>
<p>Miri is awesome. But...</p>
<h3 id="miri-does-not-always-work-and-i-still-have-to-use-valgrind">
	<a href="#miri-does-not-always-work-and-i-still-have-to-use-valgrind">Miri does not always work and I still have to use Valgrind</a>
	
</h3>
<p>I am not talking about some parts of Miri that are experimental. Or the fact that running code under Miri is excruciatingly slow. Or the fact that Miri only works in <code>nightly</code>.</p>
<p>No, I am talking about code that Miri cannot run, period:</p>
<pre><code>    |
471 |     let pkey_ctx = LcPtr::new(unsafe { EVP_PKEY_CTX_new_id(EVP_PKEY_EC, null_mut()) })?;
    |                                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ can't call foreign function `␁aws_lc_0_16_0_EVP_PKEY_CTX_new_id` on OS `linux`
    |
    = help: if this is a basic API commonly used on this target, please report an issue with Miri
    = help: however, note that Miri does not aim to support every FFI function out there; for instance, we will not support APIs for things such as GUIs, scripting languages, or databases
</code></pre>
<p>If you are using a library that has parts written in C or assembly, which is usual for cryptography libraries, or video compression, etc, you are out of luck.</p>
<p>So we resorted to add a feature flag to split the codebase between parts that use this problematic library and parts that don't. And Miri only runs tests with the feature disabled.</p>
<p>That means that there is a lot of <code>unsafe</code> code that is simply not being checked right now. Bummer.</p>
<p>Perhaps there could be a fallback implementation for these libraries that's entirely implemented in software (and in pure Rust). But that's not really feasible for most libraries to maintain two implementations just for Rust developers.</p>
<p>I resorted to run the problematic tests in <code>valgrind</code>, like I used to do with pure C/C++ code. It does not detect many things that Miri would, for example having more than one mutable pointer to the same value, which is perfectly fine in C/C++/Assembly, but not in Rust.</p>
<h3 id="i-am-still-chasing-memory-leaks">
	<a href="#i-am-still-chasing-memory-leaks">I am still chasing memory leaks</a>
	
</h3>
<p>Our library offers a C API, something like this:</p>
<pre><code>void* handle = MYLIB_init();

// Do some stuff with the handle...

MYLIB_release(handle);
</code></pre>
<p>Under the hood, <code>MYLIB_init</code> allocates some memory and <code>MYLIB_release()</code> frees it. This is a very usual pattern in C libraries, e.g. <code>curl_easy_init()/curl_easy_cleanup()</code>.</p>
<p>So immediately, you are thinking: well, it's easy to forget to call <code>MYLIB_release</code> in some code paths, and thus leak memory. And you'd be right. So let's implement them to illustrate. We are good principled developers so we write a Rust test:</p>
<pre><code>#[no_mangle]
pub extern "C" fn MYLIB_init() -&gt; *mut std::ffi::c_void {
    let alloc = Box::leak(Box::new(1usize));

    alloc as *mut usize as *mut std::ffi::c_void
}

#[no_mangle]
pub extern "C" fn MYLIB_do_stuff(_handle: *mut std::ffi::c_void) {
    // Do some stuff.
}

#[no_mangle]
pub extern "C" fn MYLIB_release(handle: *mut std::ffi::c_void) {
    let _ = unsafe { Box::from_raw(handle as *mut usize) };
}

fn main() {}

#[cfg(test)]
mod test {
    #[test]
    fn test_init_release() {
        let x = super::MYLIB_init();

        super::MYLIB_do_stuff(x);

        super::MYLIB_release(x);
    }
}
</code></pre>
<p>A Rust developer first instinct would be to use RAII by creating a wrapper object which implements <code>Drop</code> and automatically calls the cleanup function.
However, we wanted to write our tests using the public C API of the library like a normal C application would, and it would not have access to this Rust feature.
Also, it can become unwieldy when there are tens of types that have an allocation/deallocation function. It's a lot of boilerplate!</p>
<p>And often, there is complicated logic with lots of code paths, and we need to ensure that the cleanup is always called. In C, this is typically done with <code>goto</code> to an <code>end:</code> label that always cleans up the resources. But Rust does not support this form of <code>goto</code>.</p>
<p>So we solved it with the <a href="https://docs.rs/scopeguard/latest/scopeguard/">defer</a> crate in Rust and implementing a <a href="https://www.gingerbill.org/article/2015/08/19/defer-in-cpp/">defer</a> statement in C++.</p>
<p>However, the Rust borrow checker really does not like the <code>defer</code> pattern. Typically, a cleanup function will take as its argument as <code>&amp;mut</code> reference and that precludes the rest of the code to also store and use a second <code>&amp;mut</code> reference to the same value. So we could not always use <code>defer</code> on the Rust side.</p>
<h3 id="cross-compilation-does-not-always-work">
	<a href="#cross-compilation-does-not-always-work">Cross-compilation does not always work</a>
	
</h3>
<p>Same issue as with Miri, using libraries with a Rust API but with parts implemented in C or Assembly will make <code>cargo build --target=...</code> not work out of the box. It won't affect everyone out there, and perhaps it can be worked around by providing a sysroot like in C or C++. But that's a bummer still. For example, I think Zig manages this situation smoothly for most targets, since it ships with a C compiler and standard library, whereas <code>cargo</code> does not.</p>
<h3 id="cbindgen-does-not-always-work">
	<a href="#cbindgen-does-not-always-work">Cbindgen does not always work</a>
	
</h3>
<p><a href="https://github.com/mozilla/cbindgen">cbindgen</a> is a conventionally used tool to generate a C header from a Rust codebase. It mostly works, until it does not. I hit quite a number of limitations or bugs. I thought of contributing PRs, but I found for most of these issues, a stale open PR, so I didn't. Every time, I thought of dumping <code>cbindgen</code> and writing all of the C prototypes by hand. I think it would have been simpler in the end.</p>
<p>Again, as a comparison, I believe Zig has a builtin C header generation tool.</p>
<h3 id="unstable-abi">
	<a href="#unstable-abi">Unstable ABI</a>
	
</h3>
<p>I talked about this point in my previous articles so I won't be too long. Basically, all the useful standard library types such as <code>Option</code> have no stable ABI, so they have to be replicated manually with the <code>repr(C)</code> annotation, so that they can be used from C or C++. This again is a bummer and creates friction. Note that I am equally annoyed at C++ ABI issues for the same reason.</p>
<p>Many, many hours of hair pulling would be avoided if Rust and C++ adopted, like C, a <a href="https://daniel.haxx.se/blog/2024/10/30/eighteen-years-of-abi-stability/">stable ABI</a>.</p>
<h3 id="no-support-for-custom-memory-allocators">
	<a href="#no-support-for-custom-memory-allocators">No support for custom memory allocators</a>
	
</h3>
<p>With lots of C libraries, the user can provide its own allocator at runtime, which is often very useful. In Rust, the developer can only pick the global allocator at compile time. So we did not attempt to offer this feature in the library API.</p>
<p>Additionally, all of the aforementioned issues about cleaning up resources would have been instantly fixed by using an <a href="https://gaultier.github.io/blog/tip_of_the_day_2.html">arena allocator</a>, which is not at all idiomatic in Rust and does not integrate with the standard library (even though there are crates for it). Again, Zig and Odin all support arenas natively, and it's trivial to implement and use them in C. I really longed for an arena while chasing subtle memory leaks.</p>
<h3 id="complexity">
	<a href="#complexity">Complexity</a>
	
</h3>
<p>From the start, I decided I would not touch async Rust with a ten-foot pole, and I did not miss it at all, for this project.</p>
<p>Whilst reading the docs for <code>UnsafeCell</code> for the fourth time, and pondering whether I should use that or <code>RefCell</code>, while just having been burnt by the pitfalls of <code>MaybeUninit</code>, and asking myself if I need <code>Pin</code>, I really asked myself what life choices had led me to this.</p>
<p>Pure Rust is already very complex, but add to it the whole layer that is mainly there to deal with FFI, and it really becomes a beast. Especially for new Rust learners.</p>
<p>Some developers in our team straight declined to work on this codebase, mentioning the real or perceived Rust complexity.
Now, I think that Rust is still mostly easier to learn than C++, but admittedly not by much, especially in this FFI heavy context.</p>
<h2 id="conclusion">
	<a href="#conclusion">Conclusion</a>
	
</h2>
<p>I am mostly satisfied with this Rust rewrite, but I was disappointed in some areas, and it overall took much more effort than I anticipated. Using Rust with a lot of C interop feels like using a completely different language than using pure Rust. There is much friction, many pitfalls, and many issues in C++, that Rust claims to have solved, that are in fact not really solved at all.</p>
<p>I am deeply grateful to the developers of Rust, Miri, cbindgen, etc. They have done tremendous work. Still, the language and tooling, when doing lots of C FFI, feel immature, almost pre v1.0. If the ergonomics of <code>unsafe</code> (which are being worked and slightly improved in the recent versions), the standard library, the docs, the tooling, and the unstable ABI, all improve in the future, it could become a more pleasant experience.</p>
<p>I think that all of these points have been felt by Microsoft and Google, and that's why they are investing real money in this area to improve things.</p>
<p>If you do not yet know Rust, I recommend for your first project to use pure Rust, and stay far away from the whole FFI topic.</p>
<p>I initially considered using Zig or Odin for this rewrite, but I really did not want to use a pre v1.0 language for an enterprise production codebase (and I anticipated that it would be hard to convince other engineers and managers). Now, I am wondering if the experience would have really been worse than with Rust. Perhaps the Rust model is really at odds with the C model (or with the C++ model for that matter) and there is simply too much friction when using both together.</p>
<p>If I have to undertake a similar effort in the future, I think I would strongly consider going with Zig instead. We'll see. In any case, the next time someone say 'just rewrite it in Rust', point them to this article, and ask them if that changed their mind ;)</p>
<p><a href="https://gaultier.github.io/blog"> ⏴ Back to all articles</a></p>

<blockquote id="donate">
  <p>If you enjoy what you're reading, you want to support me, and can afford it: <a href="https://paypal.me/philigaultier?country.x=DE&amp;locale.x=en_US">Donate</a>. That allows me to write more cool articles!</p>
</blockquote>

<blockquote>
  <p>
    This blog is <a href="https://github.com/gaultier/blog">open-source</a>!
    If you find a problem, please open a Github issue.
    The content of this blog as well as the code snippets are under the <a href="https://en.wikipedia.org/wiki/BSD_licenses#3-clause_license_(%22BSD_License_2.0%22,_%22Revised_BSD_License%22,_%22New_BSD_License%22,_or_%22Modified_BSD_License%22)">BSD-3 License</a> which I also usually use for all my personal projects. It's basically free for every use but you have to mention me as the original author.
  </p>
</blockquote>

</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[EPA cancels pesticide shown to be harmful to unborn babies (158 pts)]]></title>
            <link>https://www.thenewlede.org/2024/10/epa-cancels-pesticide-shown-to-be-harmful-to-unborn-babies/</link>
            <guid>41993832</guid>
            <pubDate>Wed, 30 Oct 2024 11:41:21 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.thenewlede.org/2024/10/epa-cancels-pesticide-shown-to-be-harmful-to-unborn-babies/">https://www.thenewlede.org/2024/10/epa-cancels-pesticide-shown-to-be-harmful-to-unborn-babies/</a>, See on <a href="https://news.ycombinator.com/item?id=41993832">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>

                                        
<p>Citing a need to protect the unborn babies of pregnant women, the US Environmental Protection Agency (EPA) on Tuesday banned a pesticide used to kill weeds on farms, golf courses and athletic fields.</p>



<p>The action comes after years of mounting scientific evidence of the dangers posed by exposure to the chemical dimethyl tetrachloroterephthalate, also known as DCPA or Dacthal. &nbsp;</p>



<p>“With the final cancellation of DCPA, we’re taking a definitive step to protect pregnant women and their unborn babies,” Michal Freedhoff, assistant administrator for the EPA Office of Chemical Safety and Pollution Prevention, said in a press release. “The science showing the potential for irreversible harm to unborn babies’ developing brains, in addition to other lifelong consequences from exposure, demands decisive action to remove this dangerous chemical from the marketplace.”</p>
<p>The agency said “robust studies” demonstrated “thyroid toxicity,” and said that unborn babies whose pregnant mothers are exposed to DCPA could experience changes to fetal thyroid hormone levels. Such changes are “generally linked to low birth weight, impaired brain development, decreased IQ, and impaired motor skills later in life, some of which may be irreversible,” the EPA said.</p>
<p>DCPA was registered to control weeds in both agricultural and non-agricultural settings, but has largely been used to control weeds in fields growing crops such as broccoli, brussels sprouts, cabbage and onions.</p>



<p>The EPA action comes after&nbsp;<a href="https://www.epa.gov/pesticides/dcpa-dacthal-technical-herbicide-product-suspended-epa" target="_blank" rel="noreferrer noopener">years of research and smaller moves</a>&nbsp;by the EPA to limit the impact of DCPA on public health.&nbsp;In April, the <a href="https://www.thenewlede.org/2024/04/concerned-about-developing-babies-epa-warns-about-danger-of-weed-killer-used-on-farms-golf-courses/" target="_blank" rel="noreferrer noopener">agency issued a rare warning</a>&nbsp;that the pesticide posed “serious, permanent and irreversible health risks,” especially to farmworkers involved in tasks such as transplanting, weeding and harvesting after the pesticide has been applied.</p>



<p>In August, the EPA issued an&nbsp;“<a href="https://www.epa.gov/newsreleases/epa-issues-emergency-order-stop-use-pesticide-dacthal-address-serious-health-risk-4" target="_blank" rel="noreferrer noopener">emergency suspension</a>” of the chemical, marking the first time in almost 40 years the agency took such an emergency action. The agency said that, following the suspension, it received a letter from AMVAC Chemical Corporation, the sole manufacturer of DCPA, stating its intent to voluntarily cancel pesticide products containing DCPA sold in the US. AMVAC later said it would also cancel all international registrations.&nbsp;&nbsp;</p>
<p>The EPA cancellation prohibits anyone from distributing or selling DCPA pesticide products and bars anyone from using existing supplies.&nbsp;</p>
<p>(Featured photo by <a href="https://unsplash.com/@jorbrain">Jordan González</a> for&nbsp;<a href="https://unsplash.com/plus?referrer=%2Fphotos%2Fa-couple-of-people-that-are-sitting-in-the-grass-jVq0I80khBs" rel="nofollow">Unsplash+</a>)</p>

            
        </div></div>]]></description>
        </item>
    </channel>
</rss>