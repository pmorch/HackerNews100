<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>HN100 - Readable Contents</title>
        <link>https://hn.algolia.com/api/v1/search_by_date?tags=%28story,poll%29&amp;numericFilters=points%3E100</link>
        <description>Uses Readability to add bodies to the RSS feed</description>
        <lastBuildDate>Mon, 06 May 2024 11:00:04 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[Helldivers 2 PSN account linking update will not be moving forward (110 pts)]]></title>
            <link>https://twitter.com/PlayStation/status/1787331667616829929</link>
            <guid>40271104</guid>
            <pubDate>Mon, 06 May 2024 04:18:59 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://twitter.com/PlayStation/status/1787331667616829929">https://twitter.com/PlayStation/status/1787331667616829929</a>, See on <a href="https://news.ycombinator.com/item?id=40271104">Hacker News</a></p>
Couldn't get https://twitter.com/PlayStation/status/1787331667616829929: Error: Request failed with status code 400]]></description>
        </item>
        <item>
            <title><![CDATA[Remnants of a legendary typeface have been rescued from the Thames (166 pts)]]></title>
            <link>https://news.artnet.com/art-world/doves-typeface-2454807</link>
            <guid>40270586</guid>
            <pubDate>Mon, 06 May 2024 02:27:06 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://news.artnet.com/art-world/doves-typeface-2454807">https://news.artnet.com/art-world/doves-typeface-2454807</a>, See on <a href="https://news.ycombinator.com/item?id=40270586">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-post-id="2454807">
                                            <p>The depths of the river Thames in London hold many unexpected stories, gleaned from the recovery of prehistoric tools, Roman pottery, medieval jewelry, and much more besides. Yet the tale of the lost (and since recovered) Doves typeface is surely one of the most peculiar.</p>
<p>A little over a century ago, the printer <a href="https://www.britannica.com/biography/Thomas-James-Cobden-Sanderson" target="_blank" rel="noopener">T.J. Cobden-Sanderson</a> took it upon himself to surreptitiously dump every piece of this carefully honed metal letterpress type into the river. It was an act of retribution against his business partner, <a href="https://www.cheltenhammuseum.org.uk/collection/the-private-press-movement-emery-walker/" target="_blank" rel="noopener">Emery Walker</a>, whom he believed was attempting to swindle him.</p>
<p>The pair had conceived this idiosyncratic Arts and Crafts typeface when they founded the <a href="https://www.emerywalker.org.uk/doves-press" target="_blank" rel="noopener">Doves Press</a> in the London’s Hammersmith neighborhood, in 1900. They worked with draftsman Percy Tiffin and master punch-cutter Edward Prince to faithfully recall the Renaissance clarity of 15th-century Venetian fonts, designed by the revolutionary master typographer Nicolas Jensen.</p>
<div id="attachment_2454810"><p><img aria-describedby="caption-attachment-2454810" loading="lazy" src="https://news.artnet.com/app/news-upload/2024/03/6-Doves-type-recovered-by-Robert-Green-2014.-Photography-Matthew-Williams-Ellis-949x1024.jpg" alt="metal pieces of the Doves type in a block" width="949" height="1024" srcset="https://news.artnet.com/app/news-upload/2024/03/6-Doves-type-recovered-by-Robert-Green-2014.-Photography-Matthew-Williams-Ellis-949x1024.jpg 949w, https://news.artnet.com/app/news-upload/2024/03/6-Doves-type-recovered-by-Robert-Green-2014.-Photography-Matthew-Williams-Ellis-278x300.jpg 278w, https://news.artnet.com/app/news-upload/2024/03/6-Doves-type-recovered-by-Robert-Green-2014.-Photography-Matthew-Williams-Ellis-1423x1536.jpg 1423w, https://news.artnet.com/app/news-upload/2024/03/6-Doves-type-recovered-by-Robert-Green-2014.-Photography-Matthew-Williams-Ellis-1897x2048.jpg 1897w, https://news.artnet.com/app/news-upload/2024/03/6-Doves-type-recovered-by-Robert-Green-2014.-Photography-Matthew-Williams-Ellis-46x50.jpg 46w, https://news.artnet.com/app/news-upload/2024/03/6-Doves-type-recovered-by-Robert-Green-2014.-Photography-Matthew-Williams-Ellis-1779x1920.jpg 1779w" sizes="(max-width: 949px) 100vw, 949px"></p><p id="caption-attachment-2454810">Doves Type recovered by Robert Green, 2014. Photo Matthew Williams Ellis</p></div>
<p>With its extra-wide capital letters, diamond shaped punctuation and unique off-kilter dots on the letter “i,” Doves Type became the press’s hallmark, surpassing fussier typographic attempts by their friend and sometime collaborator, William Morris.</p>
<p>The letterforms only existed as a unique 16pt edition, meaning that when Cobden-Sanderson decided to “bequeath” every single piece of molded lead to the Thames, he effectively destroyed any prospect of the typeface ever being printed again. That might well have been the case, were it not for several individuals and a particularly tenacious graphic designer.</p>
<p>Robert Green first became fascinated with Doves Type in the mid-2000s, scouring printed editions and online facsimiles, to try and faithfully redraw and digitize every line. In 2013, he released the first downloadable version on <a href="https://typespec.co.uk/doves-type-revival/">typespec</a>, but remained dissatisfied. In October 2014, he decided to take to the river to see if he could find any of the original pieces.</p>
<div id="attachment_2454817"><p><img aria-describedby="caption-attachment-2454817" loading="lazy" src="https://news.artnet.com/app/news-upload/2024/03/Doves-Type-recovered-and-held-here-by-Lukasz-Orlinski-at-Emery-Walkers-House.-Photograph-credit-Lucinda-MacPherson-1-771x1024.jpg" alt="lead pieces of letterpress held in an open palm at Emery Walker's House" width="771" height="1024" srcset="https://news.artnet.com/app/news-upload/2024/03/Doves-Type-recovered-and-held-here-by-Lukasz-Orlinski-at-Emery-Walkers-House.-Photograph-credit-Lucinda-MacPherson-1-771x1024.jpg 771w, https://news.artnet.com/app/news-upload/2024/03/Doves-Type-recovered-and-held-here-by-Lukasz-Orlinski-at-Emery-Walkers-House.-Photograph-credit-Lucinda-MacPherson-1-226x300.jpg 226w, https://news.artnet.com/app/news-upload/2024/03/Doves-Type-recovered-and-held-here-by-Lukasz-Orlinski-at-Emery-Walkers-House.-Photograph-credit-Lucinda-MacPherson-1-1157x1536.jpg 1157w, https://news.artnet.com/app/news-upload/2024/03/Doves-Type-recovered-and-held-here-by-Lukasz-Orlinski-at-Emery-Walkers-House.-Photograph-credit-Lucinda-MacPherson-1-1542x2048.jpg 1542w, https://news.artnet.com/app/news-upload/2024/03/Doves-Type-recovered-and-held-here-by-Lukasz-Orlinski-at-Emery-Walkers-House.-Photograph-credit-Lucinda-MacPherson-1-38x50.jpg 38w, https://news.artnet.com/app/news-upload/2024/03/Doves-Type-recovered-and-held-here-by-Lukasz-Orlinski-at-Emery-Walkers-House.-Photograph-credit-Lucinda-MacPherson-1-1446x1920.jpg 1446w, https://news.artnet.com/app/news-upload/2024/03/Doves-Type-recovered-and-held-here-by-Lukasz-Orlinski-at-Emery-Walkers-House.-Photograph-credit-Lucinda-MacPherson-1-scaled.jpg 1928w" sizes="(max-width: 771px) 100vw, 771px"></p><p id="caption-attachment-2454817">Doves Type recovered and held here by Lukasz Orlinski at Emery Walker’s House. Photo: Lucinda MacPherson.</p></div>
<p>Using historical accounts and Cobden-Sanderson’s <a href="https://news.artnet.com/art-world/hirshhorn-video-diaries-artists-isolation-1843464" target="_blank" rel="noopener">diaries</a>, he pinpointed the exact spot where the printer had offloaded his wares, from a shadowy spot on Hammersmith bridge. “I’d only been down there 20 minutes and I found three pieces,” he said. “So, I got in touch with the Port of London Authority and they came down to search in a meticulous spiral.” The team of scuba divers used the rather low-tech tools of a bucket and a sieve to sift through the riverbed.</p>
<p>Green managed to recover a total of 151 sorts (the name for individual pieces of type) out of a possible 500,000. “It’s a tiny fraction, but when I was down by the river on my own, for one second it all felt very cosmic,” he said. “It was like Cobden-Sanderson had dropped the type from the bridge and straight into my hands. Time just collapsed.”</p>
<p>The finds have enabled him to further develop his digitized version and has also connected him with official <a href="https://news.artnet.com/art-world/an-amateur-metal-detectorist-makes-a-one-in-a-billion-find-2430194" target="_blank" rel="noopener">mudlarks</a> (people who search riverbanks for lost treasures, with special permits issued) who have uncovered even more of the type.</p>
<div id="attachment_2454830"><p><img aria-describedby="caption-attachment-2454830" loading="lazy" src="https://news.artnet.com/app/news-upload/2024/03/A-mudlarker-by-the-Thames-with-Hammersmith-Bridge-in-background.-Credit-Lucinda-MacPherson-1004x1024.jpg" alt="" width="1004" height="1024" srcset="https://news.artnet.com/app/news-upload/2024/03/A-mudlarker-by-the-Thames-with-Hammersmith-Bridge-in-background.-Credit-Lucinda-MacPherson-1004x1024.jpg 1004w, https://news.artnet.com/app/news-upload/2024/03/A-mudlarker-by-the-Thames-with-Hammersmith-Bridge-in-background.-Credit-Lucinda-MacPherson-294x300.jpg 294w, https://news.artnet.com/app/news-upload/2024/03/A-mudlarker-by-the-Thames-with-Hammersmith-Bridge-in-background.-Credit-Lucinda-MacPherson-1507x1536.jpg 1507w, https://news.artnet.com/app/news-upload/2024/03/A-mudlarker-by-the-Thames-with-Hammersmith-Bridge-in-background.-Credit-Lucinda-MacPherson-2009x2048.jpg 2009w, https://news.artnet.com/app/news-upload/2024/03/A-mudlarker-by-the-Thames-with-Hammersmith-Bridge-in-background.-Credit-Lucinda-MacPherson-50x50.jpg 50w, https://news.artnet.com/app/news-upload/2024/03/A-mudlarker-by-the-Thames-with-Hammersmith-Bridge-in-background.-Credit-Lucinda-MacPherson-1883x1920.jpg 1883w" sizes="(max-width: 1004px) 100vw, 1004px"></p><p id="caption-attachment-2454830">A mudlark by the Thames with Hammersmith Bridge in background. Photo: Lucinda MacPherson.</p></div>
<p>Jason Sandy, an architect, author and member of the Society of Thames Mudlarks, found 12 pieces, which he has donated to <a href="https://www.emerywalker.org.uk/" target="_blank" rel="noopener">Emery Walker’s House</a> at 7 Hammersmith Terrace. This private museum was once home to both business partners, and retains its stunning domestic Arts and Crafts interior.</p>
<p>Much like Green, Sandy was captivated by the Doves Type story, and mounted an exhibition at the house that displays hundreds of these salvaged pieces, including those discovered by Green, as well as mudlarks Lucasz Orlinski and Angus McArthur. The show was supplemented by a whole host of Sandy’s other finds, including jewelry and tools. An extant copy of the Doves English Bible is also on display.</p>
<div id="attachment_2454811"><p><img aria-describedby="caption-attachment-2454811" loading="lazy" src="https://news.artnet.com/app/news-upload/2024/03/The-Doves-Bible-returns-to-Emery-Walkers-House.-Credit-Lucinda-MacPherson-2-1024x824.jpg" alt="" width="1024" height="824" srcset="https://news.artnet.com/app/news-upload/2024/03/The-Doves-Bible-returns-to-Emery-Walkers-House.-Credit-Lucinda-MacPherson-2-1024x824.jpg 1024w, https://news.artnet.com/app/news-upload/2024/03/The-Doves-Bible-returns-to-Emery-Walkers-House.-Credit-Lucinda-MacPherson-2-300x241.jpg 300w, https://news.artnet.com/app/news-upload/2024/03/The-Doves-Bible-returns-to-Emery-Walkers-House.-Credit-Lucinda-MacPherson-2-1536x1236.jpg 1536w, https://news.artnet.com/app/news-upload/2024/03/The-Doves-Bible-returns-to-Emery-Walkers-House.-Credit-Lucinda-MacPherson-2-2048x1648.jpg 2048w, https://news.artnet.com/app/news-upload/2024/03/The-Doves-Bible-returns-to-Emery-Walkers-House.-Credit-Lucinda-MacPherson-2-50x40.jpg 50w, https://news.artnet.com/app/news-upload/2024/03/The-Doves-Bible-returns-to-Emery-Walkers-House.-Credit-Lucinda-MacPherson-2-1920x1545.jpg 1920w" sizes="(max-width: 1024px) 100vw, 1024px"></p><p id="caption-attachment-2454811">The Doves Bible returns to Emery Walker’s House. Photo: Lucinda MacPherson.</p></div>
<p>“It is not that unusual to find pieces of type in the river,” Sandy said. “Particularly around Fleet Street, where newspaper typesetters would throw pieces in the water when they couldn’t be bothered to put them back in their cases. But this is a legendary story and we mudlarks love a good challenge.” The community is naturally secretive about exactly where and how things are found. For example, Orlinski has worked under the cover of night with a head torch, to search for treasures at his own mysterious spot on the riverbank.</p>
<p>For Sandy, the thrill comes from the discovery of both rare and everyday artifacts, which can lead to an entirely new line of inquiry: “The Thames is very democratic. It gives you a clear picture of what people have been wearing or using over thousands of years. And it’s not carefully curated by a museum. The river gives up these objects randomly, and you experience these amazing stories of ordinary Londoners. It creates a very tangible connection to the past. Every object leads you down a rabbit hole.”</p>
<p><em>“<a href="https://www.emerywalker.org.uk/events">Mudlarking: Unearthing London’s Past</a>” is at Emery Walker’s House, 7 Hammersmith Terrace, London, through May 30.</em></p>
<p><em>Follow <a href="https://www.facebook.com/artnet" target="_blank">Artnet News</a> on Facebook: </em></p>


<p><em><a href="http://link.artnet.com/join/522/newscta&amp;hash=8e9534fb495110baf97a368037111816" target="_blank">Want to stay ahead of the art world? Subscribe to our newsletter to get the breaking news, eye-opening interviews, and incisive critical takes that drive the conversation forward.</a></em>
                                        </p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[X.org on NetBSD – The State of Things (140 pts)]]></title>
            <link>https://blog.netbsd.org/tnf/entry/x_org_on_netbsd_the</link>
            <guid>40269680</guid>
            <pubDate>Sun, 05 May 2024 23:46:21 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://blog.netbsd.org/tnf/entry/x_org_on_netbsd_the">https://blog.netbsd.org/tnf/entry/x_org_on_netbsd_the</a>, See on <a href="https://news.ycombinator.com/item?id=40269680">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
							  		              <h2><a href="https://blog.netbsd.org/tnf/entry/x_org_on_netbsd_the">X.Org on NetBSD - the state of things</a></h2>
<p>May 04, 2024 posted by <i>Nia Alarie</i></p>

  <p>
A few years ago, I wrote a "state of things" blog post about
<a href="https://blog.netbsd.org/tnf/entry/wayland_on_netbsd_trials_and">Wayland on NetBSD</a>.
It's only natural that I should do one about X11, which
is used by far more people to get a graphical environment on NetBSD.
</p>

<p><img src="https://ftp.netbsd.org/pub/NetBSD/misc/nia/glxgears.png" alt="Spinning glxgears, a classic X.Org program."></p><p>
There are a lot of differences from how NetBSD and the typical distributor
ship X.Org. For one, we ship it as an optional monolithic package rather than
separate individual packages. This means every driver is included on every system,
rather than as an optional module. Sometimes, this means we need
to fine-tune driver selection to ensure the correct drivers are loaded
on the correct hardware, since multiple conflicting drivers can
claim a video output. We also want sensible fallbacks, since if you're
using a GPU from the future with an old OS version, you probably
want X to seamlessly fall back to a regular framebuffer.
</p>

<p>
Secondly, the way our "xsrc" repository is set up, it's effectively
functioning as a fork of X.Org that regularly pulls from upstream
freedesktop.org (but does not push back). This allows X development
to happen as part of NetBSD.
</p>

<p>
Thirdly, we use our own build system based purely on BSD makefiles,
not X.Org's based on GNU autotools. This fits well with our build.sh
cross-compilation system.
</p>

<p>
We have a number of drivers which have not made their way upstream.
Perhaps the most ubiquitous of these is xf86-input-ws, a driver which
came from OpenBSD, targets an API from NetBSD, and continues to be
developed in both. This is a generic input driver that can
support any pointing device that the kernel supports.  Unlike
xf86-input-mouse, it doesn't assume the device is a mouse, and
can support advanced touchpad and touchscreen features.
Other NetBSD exclusives include xf86-video-pnozz,
xf86-video-mgx, and xf86-video-crime.
While these all share the "xf86" name inherited from the historical
XFree86 distribution, none of them are exclusively for x86.
</p>

<p>
There are a number of drivers that are accelerated when used
in NetBSD, but the acceleration support is missing upstream.
This is mostly due to the work of macallan@, who has diligently
worked on drivers for accelerators found on SPARC and PowerPC hardware.
</p>

<p>
X.Org has historically supported two 2D acceleration modes,
<a href="https://www.x.org/wiki/Development/Documentation/Performance/">XAA and EXA</a>.
XAA seems complicated - according to the X.Org Foundation it
supports accelerating "patterned fills and Bresenham lines" (eh?).
XAA was removed from the X.Org server in 2012, and many old drivers
were not updated to support the newer and simpler EXA model,
except in NetBSD, over a time period of several years.
</p>

<p>
Did you know that Nvidia
<a href="https://lwn.net/Articles/380704/">used to have</a> an open source graphics
driver? It supported 2D acceleration for a range of cards.
In NetBSD, it's retained for platforms that included embedded
Nvidia chips and aren't capable of (or predate, or don't want)
the modern novueau driver. Six years ago, it was updated in NetBSD
to support EXA acceleration.
</p>

<p>
There are a few ways our X integration could be improved.
While lots of attention has been paid to the server, less
has been paid to clients (programs).  Did you know that X
includes a
<a href="https://man.netbsd.org/NetBSD-10.0/xedit.1">text editor,</a>
and that text editor supports syntax
highlighting and spell checking?
</p>

<p><img src="https://ftp.netbsd.org/pub/NetBSD/misc/nia/xedit.png" alt="xedit, the standard editor"></p><p>
NetBSD includes its own command-line spell checker and associated
dictionaries, <a href="https://man.netbsd.org/NetBSD-10.0/spell.1">spell(1)</a>,
inherited from the BSD UNIX of yore.
It's pretty basic, and only supports
variations of English. To get spell checking to work in xedit, you need
to install ispell (another command-line spell checker) from pkgsrc, install
a dictionary, then set some Xresources (or create symlinks) to make
sure xedit finds ispell. This could surely be streamlined
by teaching xedit about spell.
</p>

<p>
We also ship every program that has been included with
historical X.Org distributions. This includes well-known
things like
<a href="https://invisible-island.net/xterm/">xterm</a>, slightly less well-known things like 
<a href="https://man.netbsd.org/xbiff.1">xbiff(1)</a>, and obscurities like
<a href="https://man.netbsd.org/NetBSD-10.0/bitmap.1">bitmap(1)</a>
(apparently a 1-bit-per-pixel alternative to MS Paint).
A while ago, we removed some libraries which are no longer used by the modern
X server, and maybe we should evaluate whether we need
all of these programs too.
<a href="https://man.netbsd.org/NetBSD-10.0/xmh.1">xmh(1)</a>
is a frontend for a mail system that isn't included in base.
Together, bitmap and xmh are around 300 kilobytes.
</p>

<p>
We include fonts, bitmaps and scalable, for a wide range of
computing devices. In the latest versions of NetBSD, the font size
will automatically scale with the screen size to support HiDPI displays
as well as small mobile devices.
However, we don't ship a scalable cursor theme at the moment.
We're also missing high-resolution fonts for Japanese,
a shame considering the popularity of NetBSD in Japan.
<a href="https://koruri.github.io/">Koruri</a> looks interesting
and is suitably small, maybe we should import it.
</p>

<p>
While we have many useful simple programs by default (a clock,
a calculator, an editor, a window manager, a compositor,
a terminal emulator...), we're notably missing a screen locking
program for X in the default install,
although we have <a href="https://man.netbsd.org/lock.1">lock(1) for the tty.</a>
</p>

<p>
The big question - does all this have a future?
The good news is that all new hardware has generic support in X.
Someone writes either a modesetting kernel driver or a classical wsdisplay
kernel driver and they will be automatically supported by the associated
drivers in X.
The bad news is that to have applications running we require access to
a larger open source ecosystem, and that ecosystem has a lot of churn
and is easily distracted by shiny new squirrels.
The process of upstreaming stuff to X.Org is an ongoing process, but
it's likely we'll run into things that will never be suitable for upstream.
</p>

<p>
Of course, on NetBSD, you also have the option of trying vanilla
modular X.Org from pkgsrc, or using
<a href="https://www.youtube.com/watch?v=4igLujPyK0M">something else entirely</a>.
</p><p>

   [<a href="https://blog.netbsd.org/tnf/entry/x_org_on_netbsd_the#comments">6 comments</a>]
 
</p>





    		  
		  		     
		     		     
    
		  				</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Drug resistant bacteria found on ISS mutating to become functionally distinct (136 pts)]]></title>
            <link>https://www.nasa.gov/centers-and-facilities/ames/ames-science/ames-space-biosciences/multi-drug-resistant-bacteria-found-on-iss-mutating-to-become-functionally-distinct/</link>
            <guid>40269592</guid>
            <pubDate>Sun, 05 May 2024 23:32:20 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.nasa.gov/centers-and-facilities/ames/ames-science/ames-space-biosciences/multi-drug-resistant-bacteria-found-on-iss-mutating-to-become-functionally-distinct/">https://www.nasa.gov/centers-and-facilities/ames/ames-science/ames-space-biosciences/multi-drug-resistant-bacteria-found-on-iss-mutating-to-become-functionally-distinct/</a>, See on <a href="https://news.ycombinator.com/item?id=40269592">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="primary">

	<article id="post-648535"><div><div><div><p><img src="https://secure.gravatar.com/avatar/051490bd53528f338b222a3e6a30d4ed?s=300&amp;d=blank&amp;r=g" alt="The headshot image of Elizabeth E. Keller"></p><p><h3>Elizabeth E. Keller</h3></p></div><p><span>Apr 16, 2024</span></p>
</div><div>
<p>In a new scientific paper funded by an Ames Space Biology grant, Principal Investigator Dr. Kasthuri Venkateswaran of NASA’s Jet Propulsion Laboratory strains of the bacterial species <em>Enterobacter bugandensis</em> isolated from the International Space Station (ISS) were studied. Thirteen strains of <em>E. bugandensis, </em>a bacterium notorious for being multi-drug resistant, were isolated from the ISS. Study findings indicate under stress, the ISS isolated strains were mutated and became genetically and functionally distinct compared to their Earth counterparts. The strains were able to viably persist in the ISS over time with a significant abundance. <em>E. bugandensis </em>coexisted with multiple other microorganisms, and in some cases could have helped those organisms survive. &nbsp;</p>
<p><strong>Publication Impact: </strong>Closed human-built environments, such as the ISS, are unique areas that provide an extreme environment subject to microgravity, radiation, and elevated carbon dioxide levels. Any microorganisms introduced to these areas must adapt to thrive. By delving into microbial dynamics in extreme environments, this research opens doors to effective preventative measure for astronaut health.</p>

<p>Reference:<strong> </strong>Sengupta P, Muthamilselvi Sivabalan SK, Singh NK, Raman K, Venkateswaran K.</p>
<p><a href="https://pubmed.ncbi.nlm.nih.gov/38521963" rel="noopener">Genomic, functional, and metabolic enhancements in multidrug-resistant Enterobacter bugandensis facilitating its persistence and succession in the International Space Station.</a> <em>Microbiome.</em> 2024 Mar 23;12:62. ISS results funded by<strong> </strong>a 2012 Space Biology NNH12ZTT001N grant nos. 19-12829-26 under Task Order NNN13D111T award to K.V., which also funded post-doctoral fellowship for N.K.S. K.R. acknowledges support from the Science and Engineering Board (SERB) MATRICS Grant MTR/2020/000490, IIT Madras, Centre for Integrative Biology and Systems mEdicine (IBSE) and Robert Bosch Center for Data Science and Artificial Intelligence (RBCDSAI).</p>
</div></div></article>
</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Deep Reinforcement Learning: Zero to Hero (292 pts)]]></title>
            <link>https://github.com/alessiodm/drl-zh</link>
            <guid>40269489</guid>
            <pubDate>Sun, 05 May 2024 23:12:28 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://github.com/alessiodm/drl-zh">https://github.com/alessiodm/drl-zh</a>, See on <a href="https://news.ycombinator.com/item?id=40269489">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text"><p dir="auto"><h2 tabindex="-1" dir="auto">Deep Reinforcement Learning: Zero to Hero!</h2><a id="user-content-deep-reinforcement-learning-zero-to-hero" aria-label="Permalink: Deep Reinforcement Learning: Zero to Hero!" href="#deep-reinforcement-learning-zero-to-hero"></a></p>
<p dir="auto">Welcome to the most hands-on reinforcement learning experience!</p>
<p dir="auto">This is a short and practical introductory course on foundational and classic deep reinforcement
learning algorithms. By the end of the course, you will have written from scratch algorithms like
DQN, SAC, PPO, as well as understood at a high-level the theory behind them.</p>
<p dir="auto">We will be able to train an AI to play Atari games and land on the Moon!</p>
<p><a target="_blank" rel="noopener noreferrer" href="https://github.com/alessiodm/drl-zh/blob/main/assets/landing.gif"><img src="https://github.com/alessiodm/drl-zh/raw/main/assets/landing.gif" data-animated-image=""></a>
</p>
<p dir="auto"><h2 tabindex="-1" dir="auto">Environment Setup</h2><a id="user-content-environment-setup" aria-label="Permalink: Environment Setup" href="#environment-setup"></a></p>
<p dir="auto">To make sure we can focus on learning, the environment setup is <em>opinionated</em> 😊 Here it is:</p>
<ul dir="auto">
<li>
<p dir="auto">Install <a href="https://docs.anaconda.com/free/miniconda/" rel="nofollow">Miniconda</a><br>

Why conda? Because it's a full envinronment manager, and we can choose the Python version too.
</p>
</li>
<li>
<p dir="auto">Checkout this Git repository, and <code>cd</code> into its folder.</p>
</li>
<li>
<p dir="auto">Create and activate the <code>drlzh</code> virtual environment:</p>
<div dir="auto" data-snippet-clipboard-copy-content="conda create --name drlzh python=3.11
conda activate drlzh"><pre>conda create --name drlzh python=3.11
conda activate drlzh</pre></div>
</li>
<li>
<p dir="auto">Install <a href="https://python-poetry.org/" rel="nofollow">Poetry</a> and install dependencies:<br>

Dependencies include <code>gymnasium[accept-rom-license]</code> for Atari. Make sure to accept the
license agreement when installing the dependencies of the project via Poetry.
</p>
<div data-snippet-clipboard-copy-content="pip install poetry
poetry install"><pre><code>pip install poetry
poetry install
</code></pre></div>
</li>
<li>
<p dir="auto">Install <a href="https://code.visualstudio.com/" rel="nofollow">Visual Studio Code</a></p>
</li>
</ul>
<p dir="auto"><h2 tabindex="-1" dir="auto">How Do I Start?</h2><a id="user-content-how-do-i-start" aria-label="Permalink: How Do I Start?" href="#how-do-i-start"></a></p>
<p dir="auto">Open this repository folder in Visual Studio Code (make sure to keep the <code>.vscode</code> folder for
settings consistency, running on Jupyter might require some tweaks to code and imports).</p>
<p dir="auto">Open the first <code>00_Intro.ipynb</code> notebook in Visual Studio Code, and follow along! From there, just
keep moving on to the next notebooks. If you get stuck, feel free to check the <code>/solution</code> folder.</p>
<p dir="auto">For an expanded treatment and step-by-step coding, check out the YouTube videos!</p>
</article></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA["Meta spent almost as much as the Manhattan Project on GPUs in today's dollars" (258 pts)]]></title>
            <link>https://twitter.com/emollick/status/1786213463456448900</link>
            <guid>40268204</guid>
            <pubDate>Sun, 05 May 2024 20:48:37 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://twitter.com/emollick/status/1786213463456448900">https://twitter.com/emollick/status/1786213463456448900</a>, See on <a href="https://news.ycombinator.com/item?id=40268204">Hacker News</a></p>
Couldn't get https://twitter.com/emollick/status/1786213463456448900: Error: Request failed with status code 400]]></description>
        </item>
        <item>
            <title><![CDATA[Bollards: Why and What (379 pts)]]></title>
            <link>https://josh.works/bollards</link>
            <guid>40267675</guid>
            <pubDate>Sun, 05 May 2024 19:54:46 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://josh.works/bollards">https://josh.works/bollards</a>, See on <a href="https://news.ycombinator.com/item?id=40267675">Hacker News</a></p>
<div id="readability-page-1" class="page"><article>
  

  <time datetime="2024-04-30T13:00:00+00:00">April 2024</time>
  <section>
    
    <!-- https://planetjekyll.github.io/snippets/reading-time -->
<p>
  
  
    Reading time: 7 mins
  
</p>

  </section>
  
  
  <h2>Article Table of Contents</h2>
<ul>
  <li><a href="#what-are-bollards">What are bollards</a></li>
  <li><a href="#what-are-not-bollards">What are <em>not</em> bollards?</a></li>
  <li><a href="#what-does-not-bollards-look-like">What does not bollards look like</a></li>
  <li><a href="#footnotes-links">Footnotes, Links</a></li>
</ul>
  <h2 id="what-are-bollards">
        
        
          What are bollards <a href="#what-are-bollards">#</a>
        
        
      </h2>
    

<p>The what and the why in a single image:</p>

<p><img src="https://josh.works/images/bollard.jpg" alt="bollard"></p>

<p>A bollard is:</p>

<blockquote>
  <p>any sort of physical barricade strong enough, shaped in such a way, that if a vehicle tries to overlap with the bollard in location, intentional or not, the vehicle cannot cross. Sometimes they’re built into the physical environment, sometimes not. They can be movable or not. Large and intrusive, or not.</p>
</blockquote>

<p><img src="https://josh.works/images/smol_bollard.jpg" alt="smol_bollard"></p>

<p><em>source: <a href="https://twitter.com/WorldBollard/status/1785595490358247717">@worldbollard twitter account</a></em></p>

<p>In the words of a local city engineer’<sup id="fnref:will-not-be-named" role="doc-noteref"><a href="#fn:will-not-be-named" rel="footnote">1</a></sup>, <em>as he was explaining why a bollard placed near where pedestrians congregate to cross a large roadway would be innapropriate</em>:</p>

<blockquote>
  <p>Barriers (bollards, guardrail, etc.) are considered for installation if the result of a vehicle striking the barrier will be less severe than hitting the unshielded object.</p>
</blockquote>

<p>So a placement like this makes intuitive sense:</p>

<p><img src="https://josh.works/images/pencil_bollard.jpg" alt="pencil_bollard"></p>

<p><em>source: <a href="https://twitter.com/WorldBollard/status/1656022438507946014">@worldbollard twitter account</a></em></p>

<p>You’ll never unsee this:</p>

<p>https://www.urbanismspeakeasy.com/p/take-another-look-at-where-they-put</p>

<blockquote>
  <p>But public works and transportation departments routinely install guardrails <em>on the outside of a sidewalk</em>.</p>
</blockquote>

<p>Please, please stop evaluating local transportation administrations as competent. I’ve hung out with these people, gone on walks with them, driven around with them, listened to them get excited about a new pedestrian affordence they’ve installed, and the lack of awareness and closemindedness (which is obviously necessary to sustain a shitty system creaking into it’s 100th year of existance) is stunning.</p>

<p>To interact with local transportation administrations <em>requires</em> that you 1) self-abandon, and 2) maintain performative allegience to a pseudo-scientific view of the world.</p>
      <h2 id="what-are-not-bollards">
        
        
          What are <em>not</em> bollards? <a href="#what-are-not-bollards">#</a>
        
        
      </h2>
    

<p><em>It’s tricky to hit the right emotional tone of why bollards matter. Sometimes it seems academic and dry, sometimes its very visceral and raw.</em></p>

<p>Where there are not bollards, there are careening, speeding vehicles, and often enough death and destruction.</p>

<p>To park a vehicle, one needs to press the correct pedel. When people are driving unfamilar vehicles, or rushed, or whatever, sometimes the wrong peddle gets pushed. Would you suggest that this small error should result in death of people and the elimination of businesses and buildings?</p>

<blockquote>
  <p>vehicle operator makes error when parking</p>
</blockquote>

<p><a href="https://www.reddit.com/r/fuckcars/comments/1cfs0np/why_cars_should_be_restricted"><img src="https://josh.works/images/car_in_store.png" alt="car_in_store"></a></p>

<p>When there are not bollards, in areas where people are promised safety, even if everyone behaves correctly, there are still failures. For example…</p>

<p>Once, a widely respected member of a local software development community and their partner (also a widely respected member of the same community) were walking on a sidewalk in California one night a few years ago. Far from them, a speeding car struck another car of course careened through the sidewalk. Both friends were hit by the car. She was killed instantly, he was knocked unconcious, woke up days later to find out the news. <a href="https://www.sfchronicle.com/crime/article/29-year-old-woman-identified-as-victim-in-S-F-16189585.php">The lanugage in the article is full of ‘this was an unavoidable tragedy’</a>, though i think it’s obvious a local city engineer ought to be held criminally liable for their neglect.</p>

<p>Because not only was it entirely preventable, it was also statistically inevitable. Not putting bollards where they need to be is like not only <em>not wearing a seatbelt</em> when driving, but arguing that <em>seatbelts should not be available in cars because usually they’re not needed</em>.</p>

<p>A bollard is just a seatbelt for someone outside of the vehicle.</p>

<p>So… this is the sort of devestation done to a community that everyone would obviously want to prevent. And this exact pattern plays out many times a day.</p>

<p>So, when there’s <em>not</em> bollards, often enough, there are cars.</p>

<p>Here’s another example - even souless corporate entities understand bollards and appreciate that they have a duty of responsibility to people who are using their spaces:</p>

<p><a href="https://chicago.suntimes.com/2023/2/8/23591381/7-eleven-storefront-crash-settles-lawsuit-bensenville">7-Eleven to pay $91 million to suburban man who lost both legs because they didn’t install bollards at <em>that</em> location.</a></p>

<p>It’s a normal occurrance. Notice down below how often this kind of thing happens. I hope there’s bollards at every 7/11 now:</p>

<blockquote>
  <p>A 57-year-old suburban man who became a double amputee after a car pinned his legs against the front of a Bensenville 7-Eleven will receive a $91 million payout from the convenience store chain</p>
</blockquote>

<p>In a moment, you’ll see the kinds of vehicle-strikes-building results this refers to.</p>

<blockquote>
  <p>The case was the first in which attorneys had access to some 15 years of reports from 7- Eleven, which identified some 6,253 storefront crashes at 7-Eleven stores across the country, Power said. Data from a previous lawsuit against the company identified another 1,525 crashes between 1991 and 1996.</p>
</blockquote>

<p>Who in the story do you think uttered the following?</p>

<blockquote>
  <p>It is important to note that this unfortunate accident was caused by a reckless driver who pled guilty, and this store followed all local building codes and ordinances.</p>
</blockquote>

<p>That was the legal representation of 7/11, but you can also hear the local city manager or city engineer saying ‘it was not my fault either!’. (“followed all local buildiong codes and ordinances”)</p>

<p>Maybe it would feel poetic if he was also a car-user, having his life destroyed by a car, but he didn’t even have a car.</p>

<blockquote>
  <p>Carl was a frequent customer of the Bensenville store, and most days would walk a few blocks from an apartment he shared with his three sons to buy his morning coffee…</p>

  <p>[the morning of this tragic-yet-statistically-inevitable systemic failure] Carl’s ride was running late, and a man pulling into a parking space in front of the store stepped on his car’s accelerator instead of the brake. The car lurched over the curb, across a sidewalk and pinned Carl against the storefront, causing injuries that would require the amputation of both his legs above the knees. Another driver had crashed into the front of the same store 16 months earlier, Power said.</p>
</blockquote>
      <h2 id="what-does-not-bollards-look-like">
        
        
          What does not bollards look like <a href="#what-does-not-bollards-look-like">#</a>
        
        
      </h2>
    

<p>In the context of ‘bollards as protecting store-fronts from cars’, sort of akin to a physical insurance policy, here’s what moving vehicles, through stores, can look like.</p>

<p>I wonder what losses the involved parties were able to recoup. Presumably insurance would make partial financial repairs, but it would all be at great opportunity cost, hassle, sadness, anger.</p>

<p>Even a <em>rock</em>, obtained functionally for free, could have fully prevented this. Again, no one’s fault, but it hurts to see damage accrue.</p>

<p>👉 <a href="https://www.reddit.com/r/fuckcars/comments/1cfs0np/why_cars_should_be_restricted/">driver presses wrong peddle when parking outside store</a></p>

<p>I dislike the caption. It says “woman forgets…” which feels like it’s possibly playing into the mysogentistic sentiment that some people are, for reasons of fundamental inferiority, unable to develop a certain skill.</p>

<p>It should say:</p>

<blockquote>
  <p>vehicle operator makes error when parking</p>
</blockquote>

<p><a href="https://www.reddit.com/r/fuckcars/comments/1cfs0np/why_cars_should_be_restricted"><img src="https://josh.works/images/car_in_store.png" alt="car_in_store"></a></p>

<p>This sort of incident would be perfectly prevented by bollards like this:</p>

<p><img src="https://josh.works/images/tiny_bollards.jpg" alt="tiny_bollards"></p>

<p><em><a href="https://twitter.com/WorldBollard/status/1729592943927767072">source: @worldbollard</a></em></p><hr>

<p>I live in the Cheesman park area in Denver, there’s already plenty of bollards and bollard-passing objects (trees, light poles, boulders) and I’d love for there to be many more, following similar-enough patterns of what is already placed, with some reasonable, obvious iteration.</p>
      
    

<ul>
  <li><a href="https://twitter.com/WorldBollard">World Bollard Association twitter account</a></li>
  <li><a href="https://twitter.com/WorldBollard/status/1659861152254369792/photo/1">Bollards to do cars what cars do to people…</a></li>
  <li><a href="https://people.com/1-dead-14-injured-after-suv-driver-crashes-into-savers-store-8641685">1 Dead, 14 Injured After [vehicle operator presses wrong button]</a></li>
  <li><a href="https://www.tiktok.com/@zzelevv/video/7364123121873374506?_r=1&amp;_t=8m2nIerAfQl">reversed through his own garage, crashed through a condo that was going on the market friday</a></li>
  <li><a href="https://www.urbanismspeakeasy.com/p/take-another-look-at-where-they-put">Take another look at where they put the guardrail</a></li>
</ul>

<p>Bollards are like iceburgs. Some bollards are not placed deep into the ground or very strong, and might deform under a vehicle impact. Some bollards are quite firmly placed.</p>

<p><img src="https://josh.works/images/under_the_bollard.jpg" alt="under_the_bollard"></p>

<p><em><a href="https://twitter.com/WorldBollard/status/1722713086274990229">source: @worldbollard</a></em></p>

  
  

  
</article></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Social engineering takeovers of open source projects (669 pts)]]></title>
            <link>https://openssf.org/blog/2024/04/15/open-source-security-openssf-and-openjs-foundations-issue-alert-for-social-engineering-takeovers-of-open-source-projects/</link>
            <guid>40267666</guid>
            <pubDate>Sun, 05 May 2024 19:53:48 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://openssf.org/blog/2024/04/15/open-source-security-openssf-and-openjs-foundations-issue-alert-for-social-engineering-takeovers-of-open-source-projects/">https://openssf.org/blog/2024/04/15/open-source-security-openssf-and-openjs-foundations-issue-alert-for-social-engineering-takeovers-of-open-source-projects/</a>, See on <a href="https://news.ycombinator.com/item?id=40267666">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><h2><i>XZ Utils cyberattack likely not an isolated incident</i></h2>
<p>By Robin Bender Ginn, Executive Director, OpenJS Foundation; and Omkhar Arasaratnam, General Manager, Open Source Security Foundation</p>
<p><span>The recent attempted </span><a href="https://openssf.org/blog/2024/03/30/xz-backdoor-cve-2024-3094/"><span>XZ Utils backdoor</span></a><span> (</span><a href="https://www.cve.org/CVERecord?id=CVE-2024-3094"><span>CVE-2024-3094</span></a><span>) may not be an isolated incident as evidenced by a similar credible takeover attempt intercepted by the <a href="https://openjsf.org/">OpenJS Foundation</a>, home to JavaScript projects used by billions of websites worldwide. The Open Source Security (OpenSSF) and OpenJS Foundations are calling all open source maintainers to be alert for social engineering takeover attempts, to recognize the early threat patterns emerging, and to take steps to protect their open source projects.</span></p>
<h2><b>Failed Credible Takeover Attempt</b></h2>
<p><span>The OpenJS Foundation Cross Project Council received a suspicious series of emails with similar messages, bearing different names and overlapping GitHub-associated emails. These emails implored OpenJS to take action to update one of its popular JavaScript projects to “address any critical vulnerabilities,” yet cited no specifics. The email author(s) wanted OpenJS to designate them as a new maintainer of the project despite having little prior involvement. This approach bears strong resemblance to the manner in which “Jia Tan” positioned themselves in the XZ/liblzma backdoor.&nbsp;&nbsp;</span></p>
<p><span>None of these individuals have been given privileged access to the OpenJS-hosted project. The project has security policies in place, including those outlined by the </span><a href="https://github.com/openjs-foundation/security-collab-space"><span>Foundation’s security working group</span></a><span>.</span></p>
<p><span>The OpenJS team also recognized a similar suspicious pattern in two other popular JavaScript projects not hosted by its Foundation, and immediately flagged the potential security concerns to respective OpenJS leaders, and the Cybersecurity and Infrastructure Security Agency (CISA) within the United States Department of Homeland Security (DHS).</span></p>
<p><span>Open source projects always welcome contributions from anyone, anywhere, yet granting someone administrative access to the source code as a maintainer requires a higher level of earned trust, and it is not given away as a “quick fix” to any problem.</span></p>
<p><span>Together with the Linux Foundation, we want to raise awareness of this ongoing threat to all open source maintainers, and offer practical guidance and resources from our broad community of experts in security and open source.</span></p>
<h2><b>Suspicious patterns in social engineering takeovers:</b></h2>
<ul>
<li aria-level="1"><span>Friendly yet aggressive and persistent pursuit of maintainer or their hosted entity (foundation or company) by relatively unknown members of the community.</span></li>
<li aria-level="1"><span>Request to be elevated to maintainer status by new or unknown persons.</span></li>
<li aria-level="1"><span>Endorsement coming from other unknown members of the community who may also be using false identities, also known as “sock puppets.”</span></li>
<li aria-level="1"><span>PRs containing blobs as artifacts.</span>
<ul>
<li aria-level="2"><span>For example, the XZ backdoor was a cleverly crafted file as part of the test suite that wasn’t human readable, as opposed to source code.</span></li>
</ul>
</li>
<li aria-level="1"><span>Intentionally obfuscated or difficult to understand source code.</span></li>
<li aria-level="1"><span>Gradually escalating security issues.</span>
<ul>
<li aria-level="2"><span>For example, the XZ issue started off with a relatively innocuous replacement of safe_fprintf() with fprintf() to see who would notice.</span></li>
</ul>
</li>
<li aria-level="1"><span>Deviation from typical project compile, build, and deployment practices that could allow the insertion of external malicious payloads into blobs, zips, or other binary artifacts.</span></li>
<li aria-level="1"><span>A false sense of urgency, especially if the implied urgency forces a maintainer to reduce the thoroughness of a review or bypass a control.</span></li>
</ul>
<p><span>These social engineering attacks are exploiting the sense of duty that maintainers have with their project and community in order to manipulate them. Pay attention to how interactions make you feel. Interactions that create self-doubt, feelings of inadequacy, of not doing enough for the project, etc. might be part of a social engineering attack.</span></p>
<p><span>Social engineering attacks like the ones we have witnessed with XZ/liblzma were successfully averted by the OpenJS community. These types of attacks are difficult to detect or protect against programmatically as they prey on a violation of trust through social engineering. In the short term, clearly and transparently sharing suspicious activity like those we mentioned above will help other communities stay vigilant. Ensuring our maintainers are well supported is the primary deterrent we have against these social engineering attacks.</span></p>
<h2><b>Steps to help secure your open source project:</b></h2>
<p><span>In addition to these recommendations, there are a number of security best practices that can improve the security properties of our projects. While these recommendations will not thwart a persistent social engineering attack, they may help improve your overall security posture of your project.&nbsp;</span></p>
<ul>
<li aria-level="1"><span>Consider following industry-standard security best practices such as </span><a href="https://openssf.org/resources/guides/"><span>OpenSSF Guides</span></a><span>.</span></li>
<li aria-level="1"><span>Use strong authentication.</span>
<ul>
<li aria-level="2"><span>Enable two-factor authentication (2FA) or Multifactor Authentication (MFA).&nbsp;</span></li>
<li aria-level="2"><span>Use a secure password manager.</span></li>
<li aria-level="2"><span>Preserve your recovery codes in a safe, preferably offline place.&nbsp;&nbsp;</span></li>
<li aria-level="2"><span>Do not reuse credentials/passwords across different services.</span></li>
</ul>
</li>
<li aria-level="1"><span>Have a security policy including a </span><a href="https://github.com/ossf/oss-vulnerability-guide"><span>“coordinated disclosure”</span></a><span> process for reports.</span></li>
<li aria-level="1"><span>Use best practices for merging new code.</span>
<ul>
<li aria-level="2"><span>Enable branch protections and signed commits.&nbsp;</span></li>
<li aria-level="2"><span>If possible, have a second developer conduct code reviews before merging, even when the PR comes from a maintainer.</span></li>
<li aria-level="2"><span>Enforce readability requirements to ensure new PRs are not obfuscated, and use of opaque binaries is minimized.&nbsp;</span></li>
<li aria-level="2"><span>Limit who has npm publish rights.</span></li>
<li aria-level="2"><span>Know your committers and maintainers, and do a periodic review. Have you seen them in your working group meetings or met them at events, for example?</span></li>
</ul>
</li>
<li aria-level="1"><span>If you run an open source package repository, consider adopting </span><a href="https://repos.openssf.org/principles-for-package-repository-security"><span>Principles for Package Repository Security</span></a><span>.</span></li>
<li aria-level="1"><span>Review “</span><a href="https://www.cisa.gov/news-events/news/avoiding-social-engineering-and-phishing-attacks"><span>Avoiding social engineering and phishing attacks</span></a><span>” from CISA and/or “</span><a href="https://www.enisa.europa.eu/topics/incident-response/glossary/what-is-social-engineering"><span>What is ‘Social Engineering’”</span></a><span> from ENISA.</span></li>
</ul>
<h2><b>Steps for industry and government to help secure critical open source infrastructure:</b></h2>
<p><span>The pressure to sustain a stable and secure open source project creates pressure on maintainers. For example,</span> <span>many projects in the</span> <span>JavaScript ecosystem are maintained by small teams or single developers who are overwhelmed by commercial companies who depend on these community-led projects yet contribute very little back.</span></p>
<p><span>To solve a problem of this scale, we need vast resources and public/private international coordination. There is already great work underway by the following organizations:</span></p>
<h2><b>Open source foundations</b><span>: </span></h2>
<p><span>The Linux Foundation family of foundations and other similar organizations like ours can help provide a safety net for open source projects. Maintainers often lack the time, people and expertise in areas such as security. Neutral foundations help support the business, marketing, legal and operations behind hundreds of open source projects that so many rely upon. Our goal is to remove any friction outside of coding to support our maintainers and help their projects grow. As vendor-neutral nonprofits, we are uniquely positioned to offer expertise garnered from multiple stakeholders represented in our organizations.</span></p>
<p><span>On security, our open source foundations have found that an effective best approach is to provide technical assistance and direct support to open source projects.&nbsp;</span></p>
<p><span>Alpha-Omega is an associated project of the OpenSSF, funded by Microsoft, Google, and Amazon, funds critical projects and ecosystems. The project aims to build a world where critical open source projects are secure and where security vulnerabilities are found and fixed quickly.&nbsp; The OpenJS Foundation has experienced how funding developers for security has had a proven impact through Alpha-Omega investments in Node.js and jQuery.</span></p>
<h2><b>Sovereign Tech Fund: </b><span>&nbsp;</span></h2>
<p><span>The Sovereign Tech Fund, financed by the German Federal Ministry for Economic Affairs and Climate Action, is providing the OpenJS Foundation and more open source organizations significant funding to strengthen infrastructure and security.&nbsp;</span></p>
<p><span>They have built a model with detailed reporting and accountability of resources, yet at the same time, have technical expertise on staff to customize security proposals for the variety of open source projects they fund.</span></p>
<p><span>It’s encouraging to see the German government taking this initiative to improve the lives of citizens by investing in critical open source infrastructure through the Sovereign Tech Fund.&nbsp;</span></p>
<p>We are advocating for more global public investment in initiatives like the Sovereign Tech Fund to invest in open source global that society depends on, complimentary to private funding. We recommend that public institutions learn from, adapt and coordinate with Germany’s Sovereign Tech Fund to support our interconnected open source projects and shared digital economies.</p>
<h2><b>About OpenJS Foundation</b></h2>
<p><span>The OpenJS Foundation is committed to supporting the healthy growth of the JavaScript ecosystem and web technologies by providing a neutral organization to host and sustain projects, as well as collaboratively fund activities for the benefit of the community at large. The OpenJS Foundation is made up of 35 open source JavaScript projects including Appium, Electron, Jest, jQuery, Node.js, and webpack and is supported by corporate and end-user members, including GoDaddy, Google, HeroDevs, IBM, Joyent, Microsoft, and the Sovereign Tech Fund. These members recognize the interconnected nature of the JavaScript ecosystem and the importance of providing a central home for projects which represent significant shared value.</span></p>
<h2><b>About the OpenSSF</b></h2>
<p><span>The Open Source Security Foundation (OpenSSF) is a cross-industry initiative by the Linux Foundation that brings together the industry’s most important open source security initiatives and the individuals and companies that support them. The OpenSSF is committed to collaboration and working both upstream and with existing communities to advance open source security for all. For more information, please visit us at openssf.org.</span></p>
<h2><b>About the Authors</b></h2>
<p><img decoding="async" src="https://openssf.org/wp-content/uploads/2024/04/Robin-Ginn-1-200x300.jpg" alt="" width="125" height="188" srcset="https://openssf.org/wp-content/uploads/2024/04/Robin-Ginn-1-200x300.jpg 200w, https://openssf.org/wp-content/uploads/2024/04/Robin-Ginn-1-682x1024.jpg 682w, https://openssf.org/wp-content/uploads/2024/04/Robin-Ginn-1.jpg 1333w" sizes="(max-width: 125px) 100vw, 125px"><span>Rob</span>in Bender Ginn is the Executive Director of the OpenJS Foundation, the neutral home to drive broad adoption and ongoing development of key JavaScript and web technologies. She also serves on the leadership team at the Linux Foundation. Robin has led major initiatives advancing open source technologies, community development, and open standards. Previously, Robin spent more than 10 years at Microsoft where she was at the forefront of the company’s shift to openness.</p>

<p><span><img decoding="async" src="https://openssf.org/wp-content/uploads/2024/04/Omkhar-Arasaratnam-Headshot-Square-2-300x300.jpg" alt="" width="126" height="126" srcset="https://openssf.org/wp-content/uploads/2024/04/Omkhar-Arasaratnam-Headshot-Square-2-300x300.jpg 300w, https://openssf.org/wp-content/uploads/2024/04/Omkhar-Arasaratnam-Headshot-Square-2-1024x1024.jpg 1024w, https://openssf.org/wp-content/uploads/2024/04/Omkhar-Arasaratnam-Headshot-Square-2-150x150.jpg 150w, https://openssf.org/wp-content/uploads/2024/04/Omkhar-Arasaratnam-Headshot-Square-2.jpg 1135w" sizes="(max-width: 126px) 100vw, 126px">Omkhar Arasaratnam is the General Manager of the Open Source Security Foundation (OpenSSF). He is a veteran cybersecurity and technical risk management executive with more than 25 years of experience leading global organizations. Omkhar began his career as a strong supporter of open source software as a PPC64 maintainer for Gentoo and contributor to the Linux kernel, and that enthusiasm for OSS continues today. Before joining the OpenSSF, he led security and engineering organizations at financial and technology institutions, such as Google, JPMorgan Chase, Credit Suisse, Deutsche Bank, TD Bank Group, and IBM. As a seasoned technology leader, he has revolutionized the effectiveness of secure software engineering, compliance, and cybersecurity controls. He is also an accomplished author and has led contributions to many international standards. Omkhar is also a NYU Cyber Fellow Advisory Council member and a Senior Fellow with the NYU Center for Cybersecurity where he guest lectures Applied Cryptography.</span></p>
</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Israel shuts down local Al Jazeera offices (592 pts)]]></title>
            <link>https://www.theguardian.com/world/article/2024/may/05/israel-shuts-down-local-al-jazeera-offices-in-dark-day-for-the-media</link>
            <guid>40267639</guid>
            <pubDate>Sun, 05 May 2024 19:50:59 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.theguardian.com/world/article/2024/may/05/israel-shuts-down-local-al-jazeera-offices-in-dark-day-for-the-media">https://www.theguardian.com/world/article/2024/may/05/israel-shuts-down-local-al-jazeera-offices-in-dark-day-for-the-media</a>, See on <a href="https://news.ycombinator.com/item?id=40267639">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="maincontent"><p>Israeli authorities shut down the local offices of <a href="https://www.theguardian.com/media/al-jazeera" data-link-name="in body link" data-component="auto-linked-tag">Al Jazeera</a> on Sunday, hours after a government vote to use new laws to close the satellite news network’s operations in the country.</p><p>Critics called the move, which comes as faltering indirect ceasefire negotiations between <a href="https://www.theguardian.com/world/israel" data-link-name="in body link" data-component="auto-linked-tag">Israel</a> and Hamas continue, a “dark day for the media” and raised new concerns about the attitude to free speech of Benjamin Netanyahu’s hardline government.</p><p>Israeli officials said the move was justified because Al Jazeera was a threat to national security. “The incitement channel Al Jazeera will be closed in Israel,” the country’s prime minister posted on social media after the unanimous cabinet vote.</p><p>A government statement said Israel’s communications minister had signed orders to act immediately to close al Jazeera’s offices in Israel, confiscate broadcast equipment, cut the channel off from cable and satellite companies and block its websites.</p><p>The network, which is funded by Qatar, has been critical of Israel’s military operation in Gaza, from where it has reported around the clock throughout the seven-month war.</p><p>Al Jazeera said the accusation that it threatened Israeli security was a “dangerous and ridiculous lie” that put its journalists at risk.</p><p>“Al Jazeera Media Network strongly condemns and denounces this criminal act that violates human rights and the basic right to access of information,” the company said in a statement. “Al Jazeera affirms its right to continue to provide news and information to its global audiences.”</p><p>A pre-recorded <a href="https://www.aljazeera.com/program/newsfeed/2024/5/5/al-jazeeras-pre-recorded-final-report-from-israel-as-ban-enacted" data-link-name="in body link">“final report”</a> listing the restrictions placed on the network by a reporter in Jerusalem was broadcast on the network after the ban came into effect.</p><p>Al Jazeera has previously accused the Israeli authorities of deliberately targeting several of its journalists, including Samer Abu Daqqa and Hamza Al-Dahdouh, both killed in Gaza during the conflict. Israel has rejected the charge and says it does not target journalists.</p><p>The office of the UN high commissioner for human rights also criticised the move. “We regret cabinet decision to close Al Jazeera in Israel,” <a href="https://twitter.com/UNHumanRights/status/1787108354499731572" data-link-name="in body link">it said on X.</a> “A free &amp; independent media is essential to ensuring transparency &amp; accountability. Now, even more so given tight restrictions on reporting from Gaza. Freedom of expression is a key human right. We urge govt to overturn ban.”</p><p>Israel’s parliament ratified a law last month that allows for the temporary closure of foreign broadcasters considered a threat to national security.</p><p>The law allows Netanyahu and his security cabinet to shut Al Jazeera’s offices in Israel for 45 days, a period that can be renewed, so it could stay in force until the end of July or until the end of major military operations in Gaza.</p><p>While including on-the-ground reporting of the war’s casualties, Al Jazeera’s Arabic-language service often publishes verbatim video statements from Hamas and other militant groups in the region, drawing sharp criticism from Israeli officials.</p><figure id="2911a539-9f9e-46a8-b677-429ecd41b1c4" data-spacefinder-role="richLink" data-spacefinder-type="model.dotcomrendering.pageElements.RichLinkBlockElement"><gu-island name="RichLinkComponent" priority="feature" deferuntil="idle" props="{&quot;richLinkIndex&quot;:13,&quot;element&quot;:{&quot;_type&quot;:&quot;model.dotcomrendering.pageElements.RichLinkBlockElement&quot;,&quot;prefix&quot;:&quot;Related: &quot;,&quot;text&quot;:&quot;Israel tells Hamas to accept ceasefire terms or risk new onslaught ‘in near future’&quot;,&quot;elementId&quot;:&quot;2911a539-9f9e-46a8-b677-429ecd41b1c4&quot;,&quot;role&quot;:&quot;richLink&quot;,&quot;url&quot;:&quot;https://www.theguardian.com/world/article/2024/may/05/israel-tells-hamas-to-accept-ceasefire-terms-or-risk-new-onslaught-in-near-future&quot;},&quot;ajaxUrl&quot;:&quot;https://api.nextgen.guardianapps.co.uk&quot;,&quot;format&quot;:{&quot;display&quot;:0,&quot;theme&quot;:0,&quot;design&quot;:0}}" config="{&quot;renderingTarget&quot;:&quot;Web&quot;,&quot;darkModeAvailable&quot;:false,&quot;assetOrigin&quot;:&quot;https://assets.guim.co.uk/&quot;}"></gu-island></figure><p>A campaign of judicial reform led last year by Netanyahu’s coalition government, the most rightwing in Israel’s history, prompted great opposition and accusations of authoritarianism. Recent crackdowns on protesters against the Gaza war in Israel have also raised new concerns for free speech.</p><p>The <a href="https://twitter.com/FPAIsPal" data-link-name="in body link">Foreign Press Association</a>, a NGO representing journalists working for international news organisations reporting from Israel, the West Bank and Gaza accused Israel of joining a “dubious club of authoritarian governments”.</p><p>“This is a dark day for the media. This is a dark day for democracy,” it said in a statement.</p><p>There was also some political opposition in Israel to the move, or at least its timing. The<a href="https://www.timesofisrael.com/government-orders-temporary-closure-of-al-jazeera-bureau-for-harming-israeli-security/" data-link-name="in body link"> National Unity party,</a> a centrist member of the ruling coalition, said that coming as ceasefire talks appeared close to failing, it could “sabotage efforts” to free Israeli hostages in Gaza.</p><p>Qatar established Al Jazeera in 1996 to build influence around the Middle East and further afield.</p><p>The small Gulf state, where several Hamas political leaders are based, was a key mediator in the talks but has been marginalised in recent weeks, which may have encouraged the Israeli government to act.</p><p>Israel has barred foreign journalists from entering Gaza to cover the conflict, which was triggered by Hamas attacks into southern Israel on 7 October last year in which 1,200 people, mostly civilians, were killed. Israel’s ensuing offensive has killed more than 34,000 people, mostly women and children.</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Designing furniture using the CSS grid (2023) (126 pts)]]></title>
            <link>https://alnvdl.github.io/2023/01/07/designing-furniture-using-the-css-grid.html</link>
            <guid>40267182</guid>
            <pubDate>Sun, 05 May 2024 18:47:46 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://alnvdl.github.io/2023/01/07/designing-furniture-using-the-css-grid.html">https://alnvdl.github.io/2023/01/07/designing-furniture-using-the-css-grid.html</a>, See on <a href="https://news.ycombinator.com/item?id=40267182">Hacker News</a></p>
<div id="readability-page-1" class="page"><section>
                

<p><img src="https://alnvdl.github.io/assets/img/squareplanner_screenshot.png" alt="A screenshot of the squareplanner web-based furniture design tool">
<em>Live example: <a href="https://alnvdl.github.io/squareplanner/">https://alnvdl.github.io/squareplanner/</a></em></p>

<p>At one point during the construction of my house, we needed designs for the kitchen and bathroom cabinets and a bedroom wardrobe.</p>

<p>In my country, this type of furniture is usually mounted under countertops or onto the bedroom walls using <a href="https://en.wikipedia.org/wiki/Medium-density_fibreboard">MDF</a> boards. This type of material lends itself to a lot of customization.</p>

<p>People usually pay specialized professionals (or companies) to design and build this kind of MDF furniture for their houses, and it can go from very cheap to very expensive depending on one’s choices of materials and finishing. These designers use specialized software (usually a 3D CAD), and the output is not only the design, but a detailed bill of materials. This output then gets sent to a factory, which cuts, finishes and delivers the boards and related materials directly to the destination, where it’s usually assembled by people working for the company that designed the furniture.</p>

<p>As we did with the house blueprint, we wanted full control over every part of the design. We found it’s much easier to make the designs ourselves, rather than imposing vetoes and “suggestions” on a designer’s work, which can be annoying for both the designer and for ourselves.</p>

<p>I wasn’t going to learn a bespoke 3D CAD software just for this. But I still needed a way to clearly communicate my ideas to the person designing and overseeing the manufacturing of our furniture. 2D was enough, as the depth of the furniture depends on where it gets placed.</p>

<p>My wife started drawing her ideas in Adobe Illustrator, but it was hard work. So you just noticed you need to add a new drawer? Now you have to redraw and move the other pieces around. Did you just realize that your stand mixer won’t fit in a module that is only 35cm tall? You may need to rethink the whole cabinet… My wife and I would discuss an idea, and then it’d take her some manual work to redraw the whole thing. Repeat that a few times, and we were spending a lot of time on this.</p>

<p>One important realization struck me when looking at her designs though: most of the time, it’s basically rectangles fitted together in a delimited area. And when designing it, if we changed our minds, these rectangles should respond to changes according to certain rules. For example, I might want that drawer to be 38cm wide, but I don’t care about the size of the doors next to it.</p>

<p>At first I thought of writing a Python script that would take a text description, calculate a few things and output measurements in text. But that would not be very visual, so it was hard to grasp for both ourselves and the furniture designers. Plus, I’d have to write some code that fits rectangles. I was losing motivation, as it would require some non-trivial work, and the end result would not look nice anyway. Was there any software I knew that did at least some of this work for me?</p>

<p><strong>What if I could be lazy and reuse an existing calculation engine, while at the same time getting a nice graphical output?</strong> Of course, I later realized that instead of writing a calculator I ended up having to write a transpiler, but by then I was too involved to give up.</p>

<p>It turns out that fitting rectangles if basically what modern web browers do. Web developers and designers have been fitting rectangles in complex ways for a while now with concepts such as the CSS <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Flexible_Box_Layout/Basic_Concepts_of_Flexbox">flexbox</a> and <a href="https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Grid_Layout">grid</a> layouts. Professionally, I’m mostly a backend developer, but I venture myself in web development from time to time, and I had read great things about the CSS grid layout, so I decided to give it a try.</p>

<p>After studying the <a href="https://developer.mozilla.org/en-US/docs/Learn/CSS/CSS_layout/Grids">CSS grid layout on MDN</a>, I realized it was the perfect fit. I could tell the browser:</p>
<blockquote>
  <p>this column is 78px tall, and I want 4 rows that are 38px wide in it</p>
</blockquote>

<p>Or in other words:</p>
<blockquote>
  <p>this module is 78cm tall, and I want 4 drawers that are 38cm wide in it</p>
</blockquote>

<p>Of course, I was not going to write HTML and CSS by hand, as that is not much better than dragging boxes in Illustrator. What about the input format for that stillborn Python script? At first, I came up with something like this:</p>
<div><pre><code>cabinet 200cm x 95cm top 3cm bottom 14cm scale 5
    38cm
*   drawer
*   drawer
*   drawer
*   drawer
</code></pre></div>

<p>In other words: my cabinet should be 200cm wide and 95cm tall. There will be a countertop taking 3cm at the top, and a base mount taking 14 cm at the bottom. I want a module that is 38cm wide, and I want 4 drawers in it, and I don’t care about their height as long at they fit. The word <code>drawer</code> doesn’t have any special meaning, and any word can be used to identify the rectangles.</p>

<p>As I kept on adding things, I needed more expressiveness to do the things I wanted:</p>
<div><pre><code>cabinet 200cm x 95cm top 3cm bottom 14cm scale 5
    38cm     *      *      *        38cm
*   drawer   door   door   drawer   drawer:red
*   drawer   ^      ^      drawer   &lt;
*   drawer   ^      ^      drawer   &lt;
*   drawer   ^      ^      drawer   &lt;
</code></pre></div>

<p>In this example we can see a few new things:</p>
<ul>
  <li><code>*</code> means “I don’t care, make it fit for me”;</li>
  <li>A number followed by <code>cm</code> is a required width or height (in centimeters);</li>
  <li><code>&lt;</code>, <code>&gt;</code> and <code>^</code> are saying “continue whatever is to the left/right or above”;</li>
  <li>Adding <code>:red</code>, <code>:green</code> or <code>:blue</code> after the name of a rectangle makes it have that color;</li>
  <li>The <code>scale</code> is mostly a hacky way of hinting how big things should be so that labels fit into rectangles;</li>
</ul>

<p>Of course, I didn’t develop this little language beforehand, as I mostly didn’t know what I was doing at first. I was basically discovering new things I needed to express when designing new parts, and I then extended the code until it did everything I wanted.</p>

<p>It turns out this little language was enough to describe everything I needed, including my ridiculously over-engineered wardrobe <a href="https://alnvdl.github.io/squareplanner/#lock:QXJt4XJpbyBkZSBjYXNhbCAodmlz428gZXh0ZXJuYSkgY29tIDM0MGNtIHggMjYwY20gYmFzZSBkZSAxNSBlbSBlc2NhbGEgMwogICAgICAgNDVjbSAgICA0NWNtICAgICogICAgICAgICAgICAgICAgKiAgICAgICA0NWNtICAgIDQ1Y20gICAgNDVjbQo2MGNtICAgcG9ydGEgICBwb3J0YSAgIHBvcnRhICAgICAgICAgICAgcG9ydGEgICBwb3J0YSAgIHBvcnRhICAgcG9ydGEKKiAgICAgIHBvcnRhICAgcG9ydGEgICBuaWNob190djp2ZXJkZSAgIDwgICAgICAgcG9ydGEgICBwb3J0YSAgIHBvcnRhCjQwY20gICBeICAgICAgIF4gICAgICAgXiAgICAgICAgICAgICAgICA8ICAgICAgIF4gICAgICAgXiAgICAgICBeCjIwY20gICBeICAgICAgIF4gICAgICAgbmljaG9fYWJlcnRvICAgICA8ICAgICAgIF4gICAgICAgXiAgICAgICBeCjMwY20gICBeICAgICAgIF4gICAgICAgZ2F2ZXRhICAgICAgICAgICA8ICAgICAgIF4gICAgICAgXiAgICAgICBeCjE1Y20gICBeICAgICAgIF4gICAgICAgZ2F2ZXRhICAgICAgICAgICA8ICAgICAgIF4gICAgICAgXiAgICAgICBeCjE1Y20gICBeICAgICAgIF4gICAgICAgXiAgICAgICAgICAgICAgICA8ICAgICAgIF4gICAgICAgXiAgICAgICBeCjE1Y20gICBeICAgICAgIF4gICAgICAgZ2F2ZXRhICAgICAgICAgICA8ICAgICAgIF4gICAgICAgXiAgICAgICBeCjE1Y20gICBeICAgICAgIF4gICAgICAgZ2F2ZXRhICAgICAgICAgICA8ICAgICAgIF4gICAgICAgXiAgICAgICBeCgojIEVtIHZlcmRlLCBuaWNobyBkZSBUViBjb20gcHJvZnVuZGlkYWRlIGRlIDMwY20uIFbjbyBsaXZyZSBkZSBvdXRyb3MgMzBjbSBlc2NvbmRpZG8gYXRy4XMsIGUgbmljaG8gYWJlcnRvIGxvZ28gYWJhaXhvLgojIFByb2Z1bmRpZGFkZSBkbyBhcm3hcmlvOiA2MGNtLg==">external</a> and <a href="https://alnvdl.github.io/squareplanner/#lock:QXJt4XJpbyBkZSBjYXNhbCAodmlz428gaW50ZXJuYSkgY29tIDM0MGNtIHggMjYwY20gYmFzZSBkZSAxNSBlbSBlc2NhbGEgMwogICAgICAgNDVjbSAgICAgNDVjbSAgICAgICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgIDQ1Y20gICA0NWNtICAgICAgICAgNDVjbSAgIDQ1Y20KNjBjbSAgIG5pY2hvICAgIDwgICAgICAgICAgICBuaWNobyAgICAgICAgICAgICAgICAgICAgICAgICA8ICAgICAgbmljaG8gICAgICAgIDwgICAgICBuaWNobwoqICAgICAgbmljaG8gICAgPCAgICAgICAgICAgIG5pY2hvX3R2K25pY2hvX2FiZXJ0bzp2ZXJkZSAgIDwgICAgICBuaWNobyAgICAgICAgPCAgICAgIHBlbmR1cmFkb3IKNDBjbSAgIG5pY2hvICAgIHBlbmR1cmFkb3IgICBeICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8ICAgICAgcGVuZHVyYWRvciAgIDwgICAgICBeCjMwY20gICBeICAgICAgICBeICAgICAgICAgICAgXiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXiAgICAgIF4gICAgICAgICAgICBeICAgICAgXgozMGNtICAgbmljaG8gICAgXiAgICAgICAgICAgIGdhdmV0YSAgICAgICAgICAgICAgICAgICAgICAgIDwgICAgICBeICAgICAgICAgICAgPCAgICAgIF4KMTVjbSAgIGdhdmV0YSAgIDwgICAgICAgICAgICBnYXZldGEgICAgICAgICAgICAgICAgICAgICAgICA8ICAgICAgZ2F2ZXRhICAgICAgIDwgICAgICBeCjE1Y20gICBnYXZldGEgICA8ICAgICAgICAgICAgXiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPCAgICAgIGdhdmV0YSAgICAgICA8ICAgICAgXgoxNWNtICAgZ2F2ZXRhICAgPCAgICAgICAgICAgIGdhdmV0YSAgICAgICAgICAgICAgICAgICAgICAgIDwgICAgICBnYXZldGEgICAgICAgPCAgICAgIF4KMTVjbSAgIGdhdmV0YSAgIDwgICAgICAgICAgICBnYXZldGEgICAgICAgICAgICAgICAgICAgICAgICA8ICAgICAgZ2F2ZXRhICAgICAgIDwgICAgICBe">internal</a> designs.</p>

<p>Originally, input was hardcoded in the file. Then I moved it into an editable <a href="https://developer.mozilla.org/en-US/docs/Web/HTML/Element/textarea"><code>textarea</code></a>, so that I could easily tweak it in the browser and see the results in realtime.</p>

<p>I also needed a way to easily share this with the person designing the furniture in the 3D CAD. I definitely didn’t want to host this anywhere (I’m cheap). But I needed an easy and safe way to share this relatively complex data. There’s a trick I have used in several projects before: store information in the <a href="https://developer.mozilla.org/en-US/docs/Web/API/URL/hash">URL hash</a>. JavaScript code can both write the hash it and read it. There’s a <a href="https://stackoverflow.com/questions/417142/what-is-the-maximum-length-of-a-url-in-different-browsers">limitation of 2048 characters in URLs</a>, but if I couldn’t describe my furniture in 2048 characters, I probably wouldn’t be able to afford it anyway :)</p>

<p>When sharing a design, I didn’t want people opening the page and accidentally pressing keys in the editor, breaking my carefully laid out rectangles and then delivering me a cabinet with giant drawers. If you press <code>Ctrl</code>+<code>Alt</code>+<code>L</code> on the page, it will lock the text area to prevent editing, and persist that lock state into the URL so it can be safely shared.</p>

<p>Ah, and I also realized it would be useful to have comments for myself and for the people reading the designs. So I added comments to the mini language (lines beginning with <code>#</code>). And colors too, as I needed to highlight a few things in the diagram so people could relate them to the comments (for example, <code>drawer:red</code> will make a red drawer).</p>

<p>And I’d need to print and export this to PDF, to carry with me, make notes and adaptations as I decided on the designs. So there’s a bit of CSS for adapting the page for nicer print output, and the browser then takes care of printing to PDF.</p>

<p>Finally, it was getting really annoying coding in that language, full of whitespaces and columns and rows. By this point, it had become a pet project, so why not just add code formatting? Pressing <code>Ctrl</code>+<code>Alt</code>+<code>F</code> in the editable <code>textarea</code> will cause the code to be formatted in columns.</p>

<p>And that’s it. I spent around 5 evenings working on this. I think I would actually have spent more time dragging rectangles with my wife in Illustrator, given how slow we were (and how much we were arguing over every decision). At least with this tool, it became extremely cheap to prototype weird cabinet designs together, only to realize they were actually not that bad.</p>

<p><strong>You can play with this tool yourself: <a href="https://alnvdl.github.io/squareplanner/">https://alnvdl.github.io/squareplanner/</a></strong></p>

<p>There is no server-side code, just static HTML, JavaScript and CSS, and it is hosted as a static page.</p>

<p>It’s not written using any frameworks, if you push it too hard it will draw weird things, it’s not unit- or integration-tested, and it does not follow a particularly academic or professional approach to the transpilation process. I guess making it more “serious” would have been possible, but in this case I just wanted to get my furniture designed fast, and keeping the code simple and small helped in that. At the time I designed this, I had dozens of other problems to solve in the construction. Looking at the end result, it’s amazing to to see all the complexity supported by modern browsers, which enable an application like this to be written in just ~550 non-minified LOC (or ~18KB).</p>

<p>In the end, the person designing the furniture in the 3D CAD had very few questions and was able to do their work. This design was also used by the company making the countertops, and we also used it throughout the construction process to help define where to place power outlets and pipes behind the cabinets (yes, we took the whole “design the house of your dreams” thing a bit too seriously).</p>

<p>And the end result was exactly as we wanted. I’m sharing this in the hope that it can be useful for someone else in the same situation as I was, or maybe help someone who is learning about the CSS grid layout.</p>


            </section></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Flying planes in Microsoft Flight Simulator with a JavaScript autopilot (2023) (209 pts)]]></title>
            <link>https://pomax.github.io/are-we-flying/</link>
            <guid>40267164</guid>
            <pubDate>Sun, 05 May 2024 18:45:04 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://pomax.github.io/are-we-flying/">https://pomax.github.io/are-we-flying/</a>, See on <a href="https://news.ycombinator.com/item?id=40267164">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
      
      <h2><a href="https://pomax.github.io/are-we-flying/">are-we-flying</a></h2>
      

      

<p><img src="https://pomax.github.io/are-we-flying/images/masthead.png" alt="masthead image of a cockpit with browsers loaded in the cockpit screens"></p>

<p>To allay any concerns: this is not about running JavaScript software to control an actual aircraft.</p>

<p><strong><em>That would kill people</em></strong>.</p>

<p>Instead, we’re writing a web page that can control an autopilot running in JS that, in turn, controls a little virtual aeroplane. And by “little” I actually mean “most aeroplanes in <a href="https://www.flightsimulator.com/">Microsoft Flight Simulator 2020</a>” because as it turns out, MSFS comes with an API that can be used to both query <em>*and set*</em> values ranging from anything as simple as cockpit lights to something as complex as spawning a fleet of aircraft and making them fly in formation while making their smoke pattern spell out the works of Chaucer in its original middle English.</p>

<p>While we’re not doing that (…today?), we <em>*are*</em> going to write an autopilot for planes that don’t have one, as well as planes that do have one but that are just a 1950’s chore to work with, while also tacking on some functionality that just straight up doesn’t exist in modern autopilots. The thing that lets us perform this trick is that MSFS comes with something called <a href="https://docs.flightsimulator.com/html/Programming_Tools/SimConnect/SimConnect_SDK.htm">SimConnect</a>, which is an SDK that lets people write addons for the game using C, C++, or languages with .NET support… and so, of course, folks have been writing connectors to “port” the SimConnect function calls to officially unsupported languages like Go, Node, Python, etc.</p>

<p>Which means that we could, say, write a web page that allows us to see what’s going on in the game. And toggle in-game settings. And –and this is the one that’s the most fun– <em>fly the plane</em> from a web page. And once we’re done “it’ll be that easy” but the road to get there is going to take a little bit of prep work… some of it tedious, some of it weird, but all of it’s going to set us up for just doing absolutely ridiculous things and at the end of it, we’ll have a fully functional autopilot <em>with auto-takeoff and flight planning that’s as easy as using google maps</em> and whatever’s missing, you can probably bolt on yourself!</p>

<p>Before we get there though, let’s start at the start. If the idea is to interface with MSFS from a webpage, and webpages use JS, then your first thought might be “Cool, can I write an <a href="https://expressjs.com/">express</a> server that connects to MSFS?” to which the answer is: yes! There is the <a href="https://www.npmjs.com/package/node-simconnect">node-simconnect</a> package for <a href="https://nodejs.org/">Node</a>, which implements full access to the SimConnect DLL file, but it’s very true to the original C++ SDK, meaning it’s a bit like “programming C++ in JavaScript”. Now, you might like that (I don’t know your background) but JS has its own set of conventions that don’t really line up with the C++ way of doing things, and because I know my way around programming and I like writing JS, I created a somewhat more “JavaScripty” API on top of node-simconnect called <a href="https://www.npmjs.com/package/msfs-simconnect-api-wrapper">msfs-simconnect-api-wrapper</a> (I am <em>*great*</em> at naming things) which lets me (and you!) write code that can talk to MSFS in a way that looks and feels much more like standard JavaScript, so… let’s use that!</p>

<p>Also, because we want to talk “from the browser to a game”, we don’t really want to have to rely on HTML GET and POST requests, because they’re both slow, and unidirectional: the game will never be able to talk to us unless it’s to answer a question we sent it. That’s not great, especially not if we want to register event handlers, so instead we’ll use <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API">web sockets</a>, which let us set up a persistent bidirectional data connection And to make that a trivial task, we’re going to use a library called <a href="https://github.com/Pomax/socketless">“socketless”</a>, which lets us write client/server code as if everything is just local code, and it magically makes things work over the network.</p>

<p>If that sounds cool: you can check out the complete project over on the <a href="https://github.com/Pomax/are-we-flying">“Are we flying?”</a> Github repository, and you can just clone that and run the project with a simple <code>run.bat</code>, but if you want to actually learn something… let’s dive in!</p>

<h2 id="the-structure-of-this-tutorial">The structure of this “tutorial”</h2>

<p>We’ll be tackling this whole thing in six parts:</p>

<ol>
  <li>In the first part we’ll cover the prep work we need to do in order to set up a working combination of MSFS, a SimConnect API server for communicating to and from MSFS, and a web server that hosts a webpage and takes care of communicating to and from the API server.</li>
  <li>In the the second part we’ll cover the “web page pages”, where we’re going to visualize everything we can visualize relating to our flights in MSFS, including graphs that plot the various control values over time (altitude, speed, heading, trim values, etc.) to get a better insight into how our aeroplane(s) responds to control inputs.</li>
  <li>In the third part we’ll cover the thing you came here for: writing our own autopilot (in several stages of complexity) and making our computer fly planes all on its own!</li>
  <li>In the fourth part, we’re going to cover the “flight path” part of a modern autopilot, but rather than programming specific radio beacons and airports, we’re going the google maps route, where you just place markers on the map and then the plane flies the path through those markers.</li>
  <li>Part five is dedicated to running test flights and rewriting some of our code based on the flight behaviour of a variety of in-game planes ranging from ultra light to commercial jet airliners.</li>
  <li>In the sixth part, we’re going to cover the thing you didn’t even realize you came here for: literally making JavaScript fly our plane for us, where we spawn a plane on the runway, click “take off” in the browser and have the plane just… start flying in MSFS with us along for the ride, following our flight path with automatic elevation detection, and then when we click “land”, having the autopilot find a nearby airport, figure out an approach, and then land the plane for us. <em>Because we can</em>.</li>
</ol>

<p>And along the way we’re going to learn a few developer tricks like hot reloading ES modules, mocking SimConnect, and other such fun things.</p>

<p>By the time we’re done, we’ll have a web page that looks a little bit like this:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/sim-view-on-map.png" alt="sim view on the map"></p>

<p>While the in game view looking like this:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/in-game-sim-view.png" alt="in-game sim view"></p>

<p>or this:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/in-game-sim-view-outside.png" alt="in-game sim view outside"></p>

<p>If that sounds (and looks) good to you, then read on!</p>

<h2 id="table-of-contents">Table of Contents</h2>



<ul id="markdown-toc">
  <li><a href="#the-structure-of-this-tutorial" id="markdown-toc-the-structure-of-this-tutorial">The structure of this “tutorial”</a></li>
  <li><a href="#part-1-the-prep-work" id="markdown-toc-part-1-the-prep-work">Part 1: The prep work</a>    <ul>
      <li><a href="#setting-up-our-project" id="markdown-toc-setting-up-our-project">Setting up our project</a></li>
      <li><a href="#an-env-file" id="markdown-toc-an-env-file">An .env file</a></li>
      <li><a href="#a-socketless-api-and-web-servers" id="markdown-toc-a-socketless-api-and-web-servers">A “socketless” API, and web servers</a>        <ul>
          <li><a href="#but-first-some-testing" id="markdown-toc-but-first-some-testing">But first, some testing!</a></li>
        </ul>
      </li>
      <li><a href="#our-api-server" id="markdown-toc-our-api-server">Our API server</a>        <ul>
          <li><a href="#the-api-router" id="markdown-toc-the-api-router">The API Router</a></li>
        </ul>
      </li>
      <li><a href="#our-browser-connection-accepting-client" id="markdown-toc-our-browser-connection-accepting-client">Our browser-connection-accepting client</a></li>
      <li><a href="#the-browser-code" id="markdown-toc-the-browser-code">The browser code</a></li>
      <li><a href="#adding-permission-control" id="markdown-toc-adding-permission-control">Adding “permission control”</a></li>
      <li><a href="#testing-our-code" id="markdown-toc-testing-our-code">Testing our code</a></li>
      <li><a href="#hot-reloading-to-make-our-dev-lives-easier" id="markdown-toc-hot-reloading-to-make-our-dev-lives-easier">Hot-reloading to make our dev lives easier</a></li>
    </ul>
  </li>
  <li><a href="#part-2-visualizing-flights" id="markdown-toc-part-2-visualizing-flights">Part 2: visualizing flights</a>    <ul>
      <li><a href="#checking-the-game-data-what-do-we-want-to-know" id="markdown-toc-checking-the-game-data-what-do-we-want-to-know">Checking the game data: what do we want to know?</a>        <ul>
          <li><a href="#getting-game-state-data" id="markdown-toc-getting-game-state-data">Getting game state data</a></li>
          <li><a href="#converting-simconnect-values" id="markdown-toc-converting-simconnect-values">Converting SimConnect values</a></li>
          <li><a href="#our-flightinformation-object" id="markdown-toc-our-flightinformation-object">Our <code>FlightInformation</code> object</a></li>
        </ul>
      </li>
      <li><a href="#showing-the-game-data" id="markdown-toc-showing-the-game-data">Showing the game data</a>        <ul>
          <li><a href="#trying-our-question-list-out" id="markdown-toc-trying-our-question-list-out">Trying our question list out</a></li>
        </ul>
      </li>
      <li><a href="#putting-our-plane-on-the-map" id="markdown-toc-putting-our-plane-on-the-map">Putting our plane on the map</a>        <ul>
          <li><a href="#improving-our-visualization" id="markdown-toc-improving-our-visualization">Improving our visualization</a></li>
          <li><a href="#seeing-the-terrain" id="markdown-toc-seeing-the-terrain">Seeing the terrain</a></li>
          <li><a href="#adding-scale-to-our-map" id="markdown-toc-adding-scale-to-our-map">Adding scale to our map</a></li>
        </ul>
      </li>
      <li><a href="#recording-our-flight-path" id="markdown-toc-recording-our-flight-path">Recording our flight path</a></li>
      <li><a href="#planes-with-attitude" id="markdown-toc-planes-with-attitude">Planes with attitude</a></li>
      <li><a href="#doing-science-plotting-our-flight-telemetry" id="markdown-toc-doing-science-plotting-our-flight-telemetry">Doing science: plotting our flight telemetry</a></li>
    </ul>
  </li>
  <li><a href="#part-3-writing-an-autopilot" id="markdown-toc-part-3-writing-an-autopilot">Part 3: writing an autopilot</a>    <ul>
      <li><a href="#the-code-basics" id="markdown-toc-the-code-basics">The code basics</a>        <ul>
          <li><a href="#the-server-side-of-our-autopilot" id="markdown-toc-the-server-side-of-our-autopilot">The server side of our autopilot</a>            <ul>
              <li><a href="#ignoring-slew-mode" id="markdown-toc-ignoring-slew-mode">Ignoring slew mode</a></li>
            </ul>
          </li>
          <li><a href="#the-client-side-of-our-autopilot" id="markdown-toc-the-client-side-of-our-autopilot">The client-side of our autopilot</a></li>
          <li><a href="#testing-our-autopilot-code" id="markdown-toc-testing-our-autopilot-code">Testing our “autopilot” code</a></li>
        </ul>
      </li>
      <li><a href="#so-how-does-an-autopilot-actually-work" id="markdown-toc-so-how-does-an-autopilot-actually-work">So how does an autopilot actually work?</a>        <ul>
          <li><a href="#the-backbone-of-our-autopilot-code-constrain-mapping" id="markdown-toc-the-backbone-of-our-autopilot-code-constrain-mapping">The backbone of our autopilot code: constrain-mapping</a></li>
        </ul>
      </li>
      <li><a href="#implementing-cruise-control" id="markdown-toc-implementing-cruise-control">Implementing cruise control</a>        <ul>
          <li><a href="#lvl-level-mode" id="markdown-toc-lvl-level-mode">LVL: level mode</a>            <ul>
              <li><a href="#adding-a-lvl-switch" id="markdown-toc-adding-a-lvl-switch">Adding a LVL switch</a></li>
            </ul>
          </li>
          <li><a href="#alt-altitude-hold" id="markdown-toc-alt-altitude-hold">ALT: altitude hold</a></li>
          <li><a href="#testing-our-code-1" id="markdown-toc-testing-our-code-1">Testing our code</a></li>
        </ul>
      </li>
      <li><a href="#improving-our-code" id="markdown-toc-improving-our-code">Improving our code</a>        <ul>
          <li><a href="#flying-straight-not-just-level" id="markdown-toc-flying-straight-not-just-level">Flying straight, not just level</a></li>
        </ul>
      </li>
      <li><a href="#improving-altitude-hold-and-heading-mode" id="markdown-toc-improving-altitude-hold-and-heading-mode">Improving altitude hold and heading mode</a>        <ul>
          <li><a href="#emergency-altitude-intervention" id="markdown-toc-emergency-altitude-intervention">Emergency altitude intervention</a></li>
          <li><a href="#snapping-to-a-new-heading" id="markdown-toc-snapping-to-a-new-heading">Snapping to a new heading</a></li>
        </ul>
      </li>
      <li><a href="#edge-case-testing" id="markdown-toc-edge-case-testing">Edge-case testing</a></li>
      <li><a href="#planes-without-aileron-trim" id="markdown-toc-planes-without-aileron-trim">Planes without aileron trim</a></li>
      <li><a href="#controlling-acrobatic-planes" id="markdown-toc-controlling-acrobatic-planes">Controlling acrobatic planes</a></li>
      <li><a href="#auto-throttling" id="markdown-toc-auto-throttling">Auto-throttling</a></li>
    </ul>
  </li>
  <li><a href="#part-4-google-maps-for-planes" id="markdown-toc-part-4-google-maps-for-planes">Part 4: Google maps for planes</a>    <ul>
      <li><a href="#intermission-mocking-an-msfs" id="markdown-toc-intermission-mocking-an-msfs">Intermission: Mocking an MSFS</a></li>
      <li><a href="#adding-waypoint-navigation" id="markdown-toc-adding-waypoint-navigation">Adding waypoint navigation</a>        <ul>
          <li><a href="#the-server-side" id="markdown-toc-the-server-side">The server side</a></li>
          <li><a href="#the-client-side" id="markdown-toc-the-client-side">The client side</a></li>
          <li><a href="#testing-waypoint-placement" id="markdown-toc-testing-waypoint-placement">Testing waypoint placement</a></li>
        </ul>
      </li>
      <li><a href="#quality-of-life-improvements" id="markdown-toc-quality-of-life-improvements">Quality of life improvements</a>        <ul>
          <li><a href="#dont-snap-the-map" id="markdown-toc-dont-snap-the-map">Don’t snap the map</a></li>
          <li><a href="#toggle-label-visualization" id="markdown-toc-toggle-label-visualization">Toggle label visualization</a></li>
          <li><a href="#waypoint-management-buttons" id="markdown-toc-waypoint-management-buttons">Waypoint management buttons</a></li>
          <li><a href="#repeating-the-flight-path" id="markdown-toc-repeating-the-flight-path">Repeating the flight path</a></li>
          <li><a href="#adding-a-waypoint-edit-modal" id="markdown-toc-adding-a-waypoint-edit-modal">Adding a waypoint edit modal</a></li>
        </ul>
      </li>
      <li><a href="#how-to-fly-a-flight-path" id="markdown-toc-how-to-fly-a-flight-path">How to fly a flight path</a>        <ul>
          <li><a href="#flight-path-policies" id="markdown-toc-flight-path-policies">Flight path policies</a></li>
        </ul>
      </li>
      <li><a href="#saving-and-loading-flight-plans" id="markdown-toc-saving-and-loading-flight-plans">Saving and loading flight plans</a>        <ul>
          <li><a href="#get-ready-to-fly-this-path" id="markdown-toc-get-ready-to-fly-this-path">“Get ready to fly this path”</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#part-5-testing-and-refining-our-code" id="markdown-toc-part-5-testing-and-refining-our-code">Part 5: Testing and refining our code</a>    <ul>
      <li><a href="#initial-test-flights" id="markdown-toc-initial-test-flights">Initial test flights</a>        <ul>
          <li><a href="#de-havilland-dhc-2-beaver" id="markdown-toc-de-havilland-dhc-2-beaver">De Havilland DHC-2 “Beaver”</a></li>
          <li><a href="#cessna-310r" id="markdown-toc-cessna-310r">Cessna 310R</a></li>
          <li><a href="#piper-turbo-arrow-iii" id="markdown-toc-piper-turbo-arrow-iii">Piper Turbo Arrow III</a></li>
        </ul>
      </li>
      <li><a href="#updating-our-heading-mode" id="markdown-toc-updating-our-heading-mode">Updating our heading mode</a>        <ul>
          <li><a href="#cessna-310r-take-2" id="markdown-toc-cessna-310r-take-2">Cessna 310R, take 2</a></li>
          <li><a href="#cessna-310r-take-3" id="markdown-toc-cessna-310r-take-3">Cessna 310R, take 3</a></li>
        </ul>
      </li>
      <li><a href="#rerunning-our-test-flights" id="markdown-toc-rerunning-our-test-flights">Rerunning our test flights</a>        <ul>
          <li><a href="#cessna-310r-take-4" id="markdown-toc-cessna-310r-take-4">Cessna 310R, take 4</a></li>
          <li><a href="#dehavilland-dhc-2-beaver" id="markdown-toc-dehavilland-dhc-2-beaver">DeHavilland DHC-2 Beaver</a></li>
          <li><a href="#piper-turbo-arrow-iii-1" id="markdown-toc-piper-turbo-arrow-iii-1">Piper Turbo Arrow III</a></li>
          <li><a href="#beechcraft-model-18" id="markdown-toc-beechcraft-model-18">Beechcraft Model 18</a></li>
          <li><a href="#daher-kodiak-100" id="markdown-toc-daher-kodiak-100">Daher Kodiak 100</a></li>
          <li><a href="#top-rudder-solo-103" id="markdown-toc-top-rudder-solo-103">Top Rudder Solo 103</a></li>
          <li><a href="#pitts-special-s-1s" id="markdown-toc-pitts-special-s-1s">Pitts Special S-1S</a></li>
          <li><a href="#gee-bee-r3-special" id="markdown-toc-gee-bee-r3-special">Gee Bee R3 Special</a></li>
          <li><a href="#pitts-special-s-1s-take-2" id="markdown-toc-pitts-special-s-1s-take-2">Pitts Special S-1S, take 2</a></li>
        </ul>
      </li>
      <li><a href="#but-can-we-fly-upside-down" id="markdown-toc-but-can-we-fly-upside-down">…But can we fly upside-down?</a></li>
    </ul>
  </li>
  <li><a href="#part-6-lets-just-have-javascript-fly-the-plane-for-us" id="markdown-toc-part-6-lets-just-have-javascript-fly-the-plane-for-us">Part 6: “Let’s just have JavaScript fly the plane for us”</a>    <ul>
      <li><a href="#terrain-follow-mode" id="markdown-toc-terrain-follow-mode">Terrain follow mode</a>        <ul>
          <li><a href="#time-for-another-server" id="markdown-toc-time-for-another-server">Time for another server</a></li>
          <li><a href="#working-with-alos-data" id="markdown-toc-working-with-alos-data">Working with ALOS data</a>            <ul>
              <li><a href="#updating-our-server" id="markdown-toc-updating-our-server">Updating our server</a></li>
            </ul>
          </li>
          <li><a href="#working-with-individual-geo-tiles" id="markdown-toc-working-with-individual-geo-tiles">Working with individual Geo tiles</a>            <ul>
              <li><a href="#optimizing-our-call-time-adding-caching" id="markdown-toc-optimizing-our-call-time-adding-caching">Optimizing our call time: adding caching</a></li>
            </ul>
          </li>
          <li><a href="#working-with-shapes" id="markdown-toc-working-with-shapes">Working with shapes</a>            <ul>
              <li><a href="#adding-polygon-awareness" id="markdown-toc-adding-polygon-awareness">Adding polygon-awareness</a></li>
              <li><a href="#scanlines-and-bresenham" id="markdown-toc-scanlines-and-bresenham">Scanlines and Bresenham</a></li>
              <li><a href="#optimizing-our-call-time-coarse-lookups" id="markdown-toc-optimizing-our-call-time-coarse-lookups">Optimizing our call time: coarse lookups</a></li>
              <li><a href="#splitting-our-shapes" id="markdown-toc-splitting-our-shapes">Splitting our shapes</a></li>
            </ul>
          </li>
          <li><a href="#putting-it-all-together" id="markdown-toc-putting-it-all-together">Putting it all together</a></li>
          <li><a href="#elevation-along-a-flight-path" id="markdown-toc-elevation-along-a-flight-path">Elevation along a flight path</a>            <ul>
              <li><a href="#finding-the-distance-from-the-plane-to-its-next-waypoint" id="markdown-toc-finding-the-distance-from-the-plane-to-its-next-waypoint">Finding the distance from the plane to its next waypoint</a></li>
              <li><a href="#finding-the-number-of-legs-that-are-fully-covered" id="markdown-toc-finding-the-number-of-legs-that-are-fully-covered">Finding the number of legs that are fully covered</a></li>
              <li><a href="#finding-how-much-of-the-leg-after-that-to-cover" id="markdown-toc-finding-how-much-of-the-leg-after-that-to-cover">Finding how much of the leg after that to cover</a></li>
              <li><a href="#building-a-triangle-if-there-is-no-next-leg" id="markdown-toc-building-a-triangle-if-there-is-no-next-leg">Building a triangle if there is no next leg</a></li>
            </ul>
          </li>
          <li><a href="#testing-our-code-2" id="markdown-toc-testing-our-code-2">Testing our code</a></li>
        </ul>
      </li>
      <li><a href="#auto-takeoff" id="markdown-toc-auto-takeoff">Auto takeoff</a>        <ul>
          <li><a href="#our-auto-takeoff-handler" id="markdown-toc-our-auto-takeoff-handler">Our auto-takeoff handler</a></li>
          <li><a href="#basic-testing" id="markdown-toc-basic-testing">Basic testing</a></li>
          <li><a href="#preflight-checklist" id="markdown-toc-preflight-checklist">Preflight checklist</a></li>
          <li><a href="#runway-roll" id="markdown-toc-runway-roll">Runway roll</a></li>
          <li><a href="#rotatetake-off" id="markdown-toc-rotatetake-off">Rotate/take-off</a></li>
          <li><a href="#handoff-to-the-autopilot" id="markdown-toc-handoff-to-the-autopilot">Handoff to the autopilot</a></li>
          <li><a href="#testing-our-code-3" id="markdown-toc-testing-our-code-3">Testing our code</a>            <ul>
              <li><a href="#dehavilland-dhc-2-beaver-1" id="markdown-toc-dehavilland-dhc-2-beaver-1">DeHavilland DHC-2 Beaver</a></li>
              <li><a href="#cessna-310r-1" id="markdown-toc-cessna-310r-1">Cessna 310R</a></li>
            </ul>
          </li>
        </ul>
      </li>
      <li><a href="#auto-landing" id="markdown-toc-auto-landing">Auto-landing</a>        <ul>
          <li><a href="#auto-landing-phases" id="markdown-toc-auto-landing-phases">Auto-landing phases</a></li>
          <li><a href="#a-basic-framework" id="markdown-toc-a-basic-framework">A basic framework</a></li>
          <li><a href="#finding-our-landing" id="markdown-toc-finding-our-landing">Finding our landing</a></li>
          <li><a href="#tracking-our-landing" id="markdown-toc-tracking-our-landing">Tracking our landing</a></li>
          <li><a href="#implementing-our-landing-phases" id="markdown-toc-implementing-our-landing-phases">Implementing our landing phases</a>            <ul>
              <li><a href="#getting-onto-the-approach" id="markdown-toc-getting-onto-the-approach">Getting onto the approach</a></li>
              <li><a href="#throttling-down-to-climb-speed" id="markdown-toc-throttling-down-to-climb-speed">Throttling down to climb speed</a></li>
              <li><a href="#flying-the-glide-slope" id="markdown-toc-flying-the-glide-slope">Flying the glide slope</a></li>
              <li><a href="#riding-out-the-short-final" id="markdown-toc-riding-out-the-short-final">Riding out the short final</a></li>
              <li><a href="#cutting-the-engines" id="markdown-toc-cutting-the-engines">Cutting the engines</a></li>
              <li><a href="#touching-down" id="markdown-toc-touching-down">Touching down</a></li>
              <li><a href="#rolling-and-braking" id="markdown-toc-rolling-and-braking">Rolling and braking</a></li>
              <li><a href="#ending-our-landing" id="markdown-toc-ending-our-landing">Ending our landing</a></li>
            </ul>
          </li>
          <li><a href="#adding-the-supplemental-code" id="markdown-toc-adding-the-supplemental-code">Adding the supplemental code</a></li>
          <li><a href="#testing-everything" id="markdown-toc-testing-everything">Testing <em>Everything</em></a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#conclusions" id="markdown-toc-conclusions">Conclusions</a></li>
</ul>

<h2 id="part-1-the-prep-work">Part 1: The prep work</h2>

<p>As mentioned, we’re going to have to do a bit of prep work before we can start writing the fun stuff, so let’s get this done. We’re going to implement three things:</p>

<ol>
  <li>An API server that talks directly to MSFS, and accepts web socket connections that can be used by API clients to interact with MSFS,</li>
  <li>a web server that serves a webpage, and accepts web socket connections from the webpage, which it can forward to the API server, and</li>
  <li>a web page with some code that connects it to the API (as far as it knows) using a web socket and can show the various aspects of a flight.</li>
</ol>

<p>In high fidelity image media, we’ll be implementing this:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/server/server-diagram.png"></p>

<p>And as mentioned, to make our lives a little easier we’re going to be using the <a href="https://www.npmjs.com/package/socketless">socketless</a> library to take care of the actual client/server management, so we can just focus on writing the code that’s going to let us show a user interface based on talking to MSFS. The nice thing about this library is that it does some magic that lets clients and servers call functions on each other “without knowing there’s a network”. If the server has a function called <code>test</code> then the client can just call <code>const testResult = await this.server.test()</code> and done, as far as the client knows, the server is just a local variable. Similarly, if the client has a function called <code>test</code> then server can call that with a <code>const testResult = await this.clients[...].test()</code> and again, as far as the server knows it’s just working with a local variable.</p>

<h2 id="setting-up-our-project">Setting up our project</h2>

<p>Let’s start by creating a new dir somewher called <code>are-we-flying</code> and initialising it as a Node project:</p>

<div><pre><code><span>&gt;</span> <span>mkdir </span>are-we-flying
<span>&gt;</span> <span>cd </span>are-we-flying
are-we-flying&gt; npm init <span>-y</span>
</code></pre></div>

<p>after which we can install the dependencies that we’ll need: <a href="https://www.npmjs.com/package/dotenv">dotenv</a>, <a href="https://www.npmjs.com/package/open">open</a>, <a href="https://www.npmjs.com/package/socketless">socketless</a>, and <a href="https://www.npmjs.com/package/msfs-simconnect-api-wrapper">msfs-simconnect-api-wrapper</a>.</p>

<div><pre><code><span>&gt;</span> npm i dotenv open socketless msfs-simconnect-api-wrapper
</code></pre></div>

<p>Then, we want to make sure to tell Node that we we’ll be writing normal, modern JS with JS modules, rather than Node’s legacy module system: open <code>package.json</code> and add the key/value pair <code>"type": "module"</code> .</p>

<h2 id="an-env-file">An .env file</h2>

<p>Next up, we’ll create a file called <code>.env</code> that will house a few variables that we want to be using across all our code:</p>

<pre><code>WEB_PORT=3000
API_PORT=8080
</code></pre>

<p>Nothing fancy, just two port numbers for now.</p>

<h2 id="a-socketless-api-and-web-servers">A “socketless” API, and web servers</h2>

<p>Before we look at the “real” code we want to write, let’s quickly run through the “boilerplate” code we need to run our API server, which we’ll put in <code>api-server.js</code>:</p>

<div><pre><code><span>// First we load our .env file:</span>
<span>import</span> <span>url</span> <span>from</span> <span>"</span><span>node:url</span><span>"</span><span>;</span>
<span>const</span> <span>__dirname</span> <span>=</span> <span>url</span><span>.</span><span>fileURLToPath</span><span>(</span><span>new</span> <span>URL</span><span>(</span><span>"</span><span>.</span><span>"</span><span>,</span> <span>import</span><span>.</span><span>meta</span><span>.</span><span>url</span><span>));</span>
<span>import</span> <span>dotenv</span> <span>from</span> <span>"</span><span>dotenv</span><span>"</span><span>;</span>
<span>dotenv</span><span>.</span><span>config</span><span>({</span> <span>path</span><span>:</span> <span>`</span><span>${</span><span>__dirname</span><span>}</span><span>/.env`</span> <span>});</span>

<span>// And get our API server's port from that environment:</span>
<span>const</span> <span>{</span> <span>API_PORT</span> <span>}</span> <span>=</span> <span>process</span><span>.</span><span>env</span><span>;</span>

<span>// Then we set up socketless so it can do its thing:</span>
<span>import</span> <span>{</span> <span>createServer</span> <span>}</span> <span>from</span> <span>"</span><span>socketless</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>ServerClass</span> <span>}</span> <span>from</span> <span>"</span><span>./src/classes/index.js</span><span>"</span><span>;</span>

<span>// Where "its thing" is creating an API server instance:</span>
<span>const</span> <span>{</span> <span>webserver</span> <span>}</span> <span>=</span> <span>createServer</span><span>(</span><span>ServerClass</span><span>);</span>

<span>// Which we then run like you would any other Node server.</span>
<span>webserver</span><span>.</span><span>listen</span><span>(</span><span>API_PORT</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
  <span>console</span><span>.</span><span>log</span><span>(</span><span>`Server listening on http://localhost:</span><span>${</span><span>API_PORT</span><span>}</span><span>`</span><span>);</span>
<span>});</span>
</code></pre></div>

<p>And that’s all the code we need to set up a server (ignoring the actualy <code>ServerClass</code>, which we’ll look at in a bit). So next up is the code required to run the “web server” part of our above diagram, which we’ll put in <code>web-server.js</code>:</p>

<div><pre><code><span>// We start the same was as above:</span>
<span>import</span> <span>url</span> <span>from</span> <span>"</span><span>node:url</span><span>"</span><span>;</span>
<span>const</span> <span>__dirname</span> <span>=</span> <span>url</span><span>.</span><span>fileURLToPath</span><span>(</span><span>new</span> <span>URL</span><span>(</span><span>"</span><span>.</span><span>"</span><span>,</span> <span>import</span><span>.</span><span>meta</span><span>.</span><span>url</span><span>));</span>
<span>import</span> <span>dotenv</span> <span>from</span> <span>"</span><span>dotenv</span><span>"</span><span>;</span>
<span>dotenv</span><span>.</span><span>config</span><span>({</span> <span>path</span><span>:</span> <span>`</span><span>${</span><span>__dirname</span><span>}</span><span>/.env`</span> <span>});</span>

<span>// Instead of "just a server" our web server will act as a client</span>
<span>// to our API server, but as web server for browsers that try to</span>
<span>// connect. As such we need to know both the port for our API server</span>
<span>// as well as what port we should use for our own server:</span>
<span>const</span> <span>{</span> <span>API_PORT</span><span>,</span> <span>WEB_PORT</span> <span>}</span> <span>=</span> <span>process</span><span>.</span><span>env</span><span>;</span>

<span>// Then we set up a socketless client with "browser connection" functionality:</span>
<span>import</span> <span>{</span> <span>ClientClass</span> <span>}</span> <span>from</span> <span>"</span><span>./src/classes/index.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>createWebClient</span> <span>}</span> <span>from</span> <span>"</span><span>socketless</span><span>"</span><span>;</span>

<span>// Clients need to know which URL to find the server at:</span>
<span>const</span> <span>serverURL</span> <span>=</span> <span>`http://localhost:</span><span>${</span><span>API_PORT</span><span>}</span><span>`</span><span>;</span>

<span>// And web clients need to know which directory/folder to serve static content from:</span>
<span>const</span> <span>dir</span> <span>=</span> <span>`</span><span>${</span><span>__dirname</span><span>}</span><span>/public`</span><span>;</span>

<span>// Which means we can now create our "web-enabled client":</span>
<span>const</span> <span>{</span> <span>clientWebServer</span> <span>}</span> <span>=</span> <span>createWebClient</span><span>(</span><span>ClientClass</span><span>,</span> <span>serverURL</span><span>,</span> <span>dir</span><span>);</span>

<span>// And then we run its web server the same way we ran the API server:</span>
<span>clientWebServer</span><span>.</span><span>listen</span><span>(</span><span>WEB_PORT</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
  <span>console</span><span>.</span><span>log</span><span>(</span><span>`Server listening on http://localhost:</span><span>${</span><span>WEB_PORT</span><span>}</span><span>`</span><span>);</span>

  <span>// With an extra bit that automatically opens a browser for us:</span>
  <span>if</span> <span>(</span><span>process</span><span>.</span><span>argv</span><span>.</span><span>includes</span><span>(</span><span>`--browser`</span><span>))</span> <span>{</span>
    <span>import</span><span>(</span><span>"</span><span>open</span><span>"</span><span>).</span><span>then</span><span>(({</span> <span>default</span><span>:</span> <span>open</span> <span>})</span> <span>=&gt;</span> <span>{</span>
      <span>open</span><span>(</span><span>`http://localhost:</span><span>${</span><span>WEB_PORT</span><span>}</span><span>`</span><span>);</span>
    <span>});</span>
  <span>}</span>
<span>});</span>
</code></pre></div>

<p>So a tiny bit more code, but that’s all we need to do in terms of setting up our “API server ↔ client ↔ browser” constellation. The <code>socketless</code> library takes care of all of that so we can focus on actually implementing the code we <em>care</em> about. And on that note, let’s look at that code because we have two classes to implement:</p>

<ol>
  <li>the server class, which will be our interface between MSFS and our clients, and</li>
  <li>the client class, which will be our interface between the server and the browser.</li>
</ol>

<h3 id="but-first-some-testing">But first, some testing!</h3>

<p>Before we implement those though, let’s verify that the code we wrote even works by implementing some tiny client and server classes with just enough code to show connections and function calls to work. Let’s create a <code>src/classes/index.js</code> with “dummy” client and server classes:</p>

<div><pre><code><span>// Our client class will announce its own connection, as well as browser connections:</span>
<span>export</span> <span>class</span> <span>ClientClass</span> <span>{</span>
  <span>// nothing special going on here, just a console log</span>
  <span>onConnect</span><span>()</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`[client] We connected to the server!`</span><span>);</span>
  <span>}</span>
  <span>// and nothing special going on here either, just more console log</span>
  <span>onBrowserConnect</span><span>()</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`[client] A browser connected!`</span><span>);</span>
  <span>}</span>
<span>}</span>

<span>// Our server class will also announce that it got client connections:</span>
<span>export</span> <span>class</span> <span>ServerClass</span> <span>{</span>
  <span>// still nothing special going on here...</span>
  <span>onConnect</span><span>(</span><span>client</span><span>)</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`[server] A client connected!`</span><span>);</span>
  <span>}</span>
  <span>// ...but we do add a little test function that clients can call:</span>
  <span>async</span> <span>test</span><span>()</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`[server] test!`</span><span>);</span>
    <span>return</span> <span>"</span><span>success!</span><span>"</span><span>;</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>Then, to add the browser into the mix, we’ll also create a quick <code>public/index.html</code> file:</p>

<div><pre><code><span>&lt;!DOCTYPE html&gt;</span>
<span>&lt;html</span> <span>lang=</span><span>"en-GB"</span><span>&gt;</span>
  <span>&lt;head&gt;</span>
    <span>&lt;meta</span> <span>charset=</span><span>"utf-8"</span> <span>/&gt;</span>
    <span>&lt;title&gt;</span>Let's test our connections!<span>&lt;/title&gt;</span>
    <span>&lt;script </span><span>src=</span><span>"js/index.js"</span> <span>type=</span><span>"module"</span> <span>async</span><span>&gt;&lt;/script&gt;</span>
  <span>&lt;/head&gt;</span>
  <span>&lt;body&gt;</span>
    <span>&lt;!-- we only need to look at the developer tools "console" tab for now --&gt;</span>
  <span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
</code></pre></div>

<p>And then a bare minimum amount of browser JS in <code>public/js/index.js</code>:</p>

<div><pre><code><span>// We don't need to put a "socketless.js" in our public dir,</span>
<span>// this is a "magic import" that works when we're connected</span>
<span>// to a socketless web server:</span>
<span>import</span> <span>{</span> <span>createBrowserClient</span> <span>}</span> <span>from</span> <span>"</span><span>../socketless.js</span><span>"</span><span>;</span>

<span>// Then we set up our browser client to announce its connections:</span>
<span>class</span> <span>BrowserClient</span> <span>{</span>
  <span>async</span> <span>init</span><span>()</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`[browser] We're connected to our web client!`</span><span>);</span>

    <span>// And then as part of startup, we'll call the server's</span>
    <span>// test function, just to confirm that works:</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`Calling test:`</span><span>,</span> <span>await</span> <span>this</span><span>.</span><span>server</span><span>.</span><span>test</span><span>());</span>
  <span>}</span>
<span>}</span>

<span>// Then the only thing left to do in the browser is to create a browser client instance:</span>
<span>createBrowserClient</span><span>(</span><span>BrowserClient</span><span>);</span>
</code></pre></div>

<p>And that’s it, we just implemented a full server + client + browser constellation!</p>

<p>So let’s run <code>node api-server.js</code> in a terminal, and <code>node web-server.js --browser</code> in another. Doing so will show us the following text in the server terminal:</p>

<div><pre><code>...&gt; node api-server.js
Server listening on http://localhost:8080
[server] A client connected!
[server] test!
</code></pre></div>

<p>And will show us the following in the client terminal:</p>

<div><pre><code>...&gt; node web-server.js --browser
Server listening on http://localhost:3000
Opening a browser...
[client] We connected to the server!
[client] A browser connected!
</code></pre></div>

<p>And, because the <code>--browser</code> flag opened a browser, if we look at the browser’s developer tools’ <code>console</code> tab, we see:</p>

<div><pre><code>[browser] We're connected to our web client!                            index.js:9:17
Calling test: success!
</code></pre></div>

<p>Awesome, we have a complete API server + web server + browser thin client and “things just work™”, we didn’t have to write a single line of websocket or remote function calling code!</p>

<h2 id="our-api-server">Our API server</h2>

<p>Let’s finish up the basics.</p>

<p>Our server is where we “talk to MSFS”, and any functions that we expose on the server class will end up being a function that, as far as clients know, is just part of their local <code>this.server</code> object, so we’ll want to make sure to keep things that should not be directly accessible to clients either out of the serverclass (i.e. declare and initialize them in module scope instead) or mark them as private using the <code>#</code> character, so that they can’t be called by anyone else.</p>

<p>With that in mind, let’s write a <em>real</em> server clas, in its own <code>src/classes/server/server.js</code> file instead, so we’re not mixing client and server code:</p>

<div><pre><code><span>// Load the environment:</span>
<span>import</span> <span>url</span> <span>from</span> <span>"</span><span>node:url</span><span>"</span><span>;</span>
<span>const</span> <span>__dirname</span> <span>=</span> <span>url</span><span>.</span><span>fileURLToPath</span><span>(</span><span>new</span> <span>URL</span><span>(</span><span>"</span><span>.</span><span>"</span><span>,</span> <span>import</span><span>.</span><span>meta</span><span>.</span><span>url</span><span>));</span>
<span>import</span> <span>dotenv</span> <span>from</span> <span>"</span><span>dotenv</span><span>"</span><span>;</span>
<span>dotenv</span><span>.</span><span>config</span><span>({</span> <span>path</span><span>:</span> <span>`</span><span>${</span><span>__dirname</span><span>}</span><span>/../../../.env`</span> <span>});</span>

<span>// And get the "how frequentlu to poll" from theÏ environment.</span>
<span>const</span> <span>POLLING_INTERVAL</span> <span>=</span> <span>process</span><span>.</span><span>env</span><span>.</span><span>POLLING_INTERVAL</span> <span>??</span> <span>2500</span><span>;</span>

<span>// Then, an import for a setTimeout that ignores throws:</span>
<span>import</span> <span>{</span> <span>runLater</span> <span>}</span> <span>from</span> <span>"</span><span>../../utils/utils.js</span><span>"</span><span>;</span>

<span>// And two helper functions for setting up the API connection:</span>
<span>import</span> <span>{</span> <span>connectServerToAPI</span><span>,</span> <span>registerWithAPI</span> <span>}</span> <span>from</span> <span>"</span><span>./helpers.js</span><span>"</span><span>;</span>

<span>// Plus a helper that we can expose as `this.api` for clients to work with:</span>
<span>import</span> <span>{</span> <span>APIRouter</span> <span>}</span> <span>from</span> <span>"</span><span>./routers/api-router.js</span><span>"</span><span>;</span>

<span>// And then the most important import: the MSFS connector</span>
<span>import</span> <span>{</span> <span>MSFS_API</span> <span>}</span> <span>from</span> <span>"</span><span>msfs-simconnect-api-wrapper</span><span>"</span><span>;</span>

<span>// In order to prevent clients from directly accessing the MSFS</span>
<span>// connector, we're going to make it a global (to our module):</span>
<span>let</span> <span>api</span> <span>=</span> <span>false</span><span>;</span>

<span>// Next up, our server class:</span>
<span>export</span> <span>class</span> <span>ServerClass</span> <span>{</span>
  <span>async</span> <span>init</span><span>()</span> <span>{</span>
    <span>const</span> <span>{</span> <span>clients</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>

    <span>// set up the API variable - note that because this is a global,</span>
    <span>// clients can't directly access the API. However, we'll be setting</span>
    <span>// up some API routing to make that a non-issue in a bit.</span>
    <span>api</span> <span>=</span> <span>new</span> <span>MSFS_API</span><span>();</span>

    <span>// Set up call handling for API calls: this will be explained after we</span>
    <span>// finish writing this class. We bind it as `this.api` so that any</span>
    <span>// client will be able to call `this.server.api...` and have things work.</span>
    <span>this</span><span>.</span><span>api</span> <span>=</span> <span>new</span> <span>APIRouter</span><span>(</span><span>api</span><span>);</span>

    <span>// Then wait for MSFS to come online</span>
    <span>connectServerToAPI</span><span>(</span><span>api</span><span>,</span> <span>async</span> <span>()</span> <span>=&gt;</span> <span>{</span>
      <span>console</span><span>.</span><span>log</span><span>(</span><span>`Connected to MSFS.`</span><span>);</span>

      <span>registerWithAPI</span><span>(</span><span>clients</span><span>,</span> <span>api</span><span>);</span>
      <span>clients</span><span>.</span><span>forEach</span><span>((</span><span>client</span><span>)</span> <span>=&gt;</span> <span>client</span><span>.</span><span>onMSFS</span><span>(</span><span>true</span><span>));</span>

      <span>// And when it's online and we're connected, start polling for when we're "in game".</span>
      <span>(</span><span>async</span> <span>function</span> <span>poll</span><span>()</span> <span>{</span>
        <span>// We'll look at what actually goes here once we have everything in place.</span>
        <span>// For now, we just schedule a poll</span>
        <span>runLater</span><span>(</span><span>poll</span><span>,</span> <span>POLLING_INTERVAL</span><span>);</span>
      <span>})();</span>
    <span>});</span>
  <span>}</span>

  <span>/**
   * Then a minimum amount of code for When a client connects to us,
   * and MSFS is already connected.
   */</span>
  <span>async</span> <span>onConnect</span><span>(</span><span>client</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>api</span><span>?.</span><span>connected</span><span>)</span> <span>client</span><span>.</span><span>onMSFS</span><span>(</span><span>true</span><span>);</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>So let’s look at those secondary imports: first, the simplest one, in <code>src/utils/utils.js</code>:</p>

<div><pre><code><span>export</span> <span>function</span> <span>runLater</span><span>(</span><span>fn</span><span>,</span> <span>timeoutInMillis</span><span>)</span> <span>{</span>
  <span>// this is literally just setTimeout, but with a try/catch so</span>
  <span>// that if the function we're running throws an error, we</span>
  <span>// completely ignore that instead of crashing the server.</span>
  <span>setTimeout</span><span>(()</span> <span>=&gt;</span> <span>{</span>
    <span>try</span> <span>{</span>
      <span>fn</span><span>();</span>
    <span>}</span> <span>catch</span> <span>(</span><span>e</span><span>)</span> <span>{</span>
      <span>console</span><span>.</span><span>error</span><span>(</span><span>e</span><span>);</span>
    <span>}</span>
  <span>},</span> <span>timeoutInMillis</span><span>);</span>
<span>}</span>
</code></pre></div>

<p>Then those helper functions for working with the API in <code>src/classes/server/helpers.js</code></p>

<div><pre><code><span>// We'll grab the list of system events from the MSFS connector, so we can register for a few events:</span>
<span>import</span> <span>{</span> <span>SystemEvents</span> <span>}</span> <span>from</span> <span>"</span><span>msfs-simconnect-api-wrapper</span><span>"</span><span>;</span>

<span>// Then mostly for organizational purposes ("to keep the code clean")</span>
<span>// we house the actually MSFS API connection properties here.</span>
<span>export</span> <span>function</span> <span>connectServerToAPI</span><span>(</span><span>api</span><span>,</span> <span>onConnect</span><span>)</span> <span>{</span>
  <span>api</span><span>.</span><span>connect</span><span>({</span>
    <span>autoReconnect</span><span>:</span> <span>true</span><span>,</span>
    <span>retries</span><span>:</span> <span>Infinity</span><span>,</span>
    <span>retryInterval</span><span>:</span> <span>5</span><span>,</span>
    <span>onConnect</span><span>,</span>
    <span>onRetry</span><span>:</span> <span>(</span><span>_</span><span>,</span> <span>s</span><span>)</span> <span>=&gt;</span>
      <span>console</span><span>.</span><span>log</span><span>(</span><span>`Can't connect to MSFS, retrying in </span><span>${</span><span>s</span><span>}</span><span> seconds`</span><span>),</span>
  <span>});</span>
<span>}</span>

<span>// And since this is basically a "run once" thing we also house the code</span>
<span>// that registers for pause and crash events here.</span>
<span>export</span> <span>function</span> <span>registerWithAPI</span><span>(</span><span>clients</span><span>,</span> <span>api</span><span>)</span> <span>{</span>
  <span>console</span><span>.</span><span>log</span><span>(</span><span>`Registering API server to the general sim events.`</span><span>);</span>

  <span>api</span><span>.</span><span>on</span><span>(</span><span>SystemEvents</span><span>.</span><span>PAUSED</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
    <span>clients</span><span>.</span><span>forEach</span><span>((</span><span>client</span><span>)</span> <span>=&gt;</span> <span>client</span><span>.</span><span>pause</span><span>());</span>
  <span>});</span>

  <span>api</span><span>.</span><span>on</span><span>(</span><span>SystemEvents</span><span>.</span><span>UNPAUSED</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
    <span>clients</span><span>.</span><span>forEach</span><span>((</span><span>client</span><span>)</span> <span>=&gt;</span> <span>client</span><span>.</span><span>unpause</span><span>());</span>
  <span>});</span>

  <span>api</span><span>.</span><span>on</span><span>(</span><span>SystemEvents</span><span>.</span><span>CRASHED</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
    <span>clients</span><span>.</span><span>forEach</span><span>((</span><span>client</span><span>)</span> <span>=&gt;</span> <span>client</span><span>.</span><span>crashed</span><span>());</span>
  <span>});</span>

  <span>api</span><span>.</span><span>on</span><span>(</span><span>SystemEvents</span><span>.</span><span>CRASH_RESET</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
    <span>clients</span><span>.</span><span>forEach</span><span>((</span><span>client</span><span>)</span> <span>=&gt;</span> <span>client</span><span>.</span><span>crashReset</span><span>());</span>
  <span>});</span>
<span>}</span>
</code></pre></div>

<p>Which leaves the code that lets clients call API functions through the server</p>

<h3 id="the-api-router">The API Router</h3>

<p>The <code>APIRouter</code> code lets clients interface “directly” with MSFS through the SimConnect driver, with five main functions that we can expose to clients:</p>

<ul>
  <li>register: register as event listener for one of the (few) “subscription” based MSFS event.</li>
  <li>forget: the opposite of register.</li>
  <li>get: a way to get the current value(s) for SimConnect variable(s).</li>
  <li>set: a way to set variable(s) to specific value(s).</li>
  <li>trigger: a way to trigger one of the (<em>many</em>) sim events.</li>
</ul>

<p>So let’s look at how we expose those to the client in a file that we’ll call <code>src/classes/routes/api-router.js</code>:</p>

<div><pre><code><span>// Obviously we'll need to load the list of events if we're going to let clients register for events:</span>
<span>import</span> <span>{</span> <span>SystemEvents</span> <span>}</span> <span>from</span> <span>"</span><span>msfs-simconnect-api-wrapper</span><span>"</span><span>;</span>

<span>const</span> <span>eventTracker</span> <span>=</span> <span>{};</span>

<span>// And in order to cache GET requests, we're going to hash requests based on</span>
<span>// the varname collection we get passed, which we'll do by hashing.</span>
<span>import</span> <span>{</span> <span>createHash</span> <span>}</span> <span>from</span> <span>"</span><span>node:crypto</span><span>"</span><span>;</span>

<span>const</span> <span>resultCache</span> <span>=</span> <span>{};</span>

<span>// Since there is only one API instance, we can cache that</span>
<span>// at the module level, just like in the server class.</span>
<span>let</span> <span>api</span><span>;</span>

<span>export</span> <span>class</span> <span>APIRouter</span> <span>{</span>
  <span>// And then we bind that variable using the constructor:</span>
  <span>constructor</span><span>(</span><span>_api</span><span>)</span> <span>{</span>
    <span>api</span> <span>=</span> <span>_api</span><span>;</span>
  <span>}</span>

  <span>// Then, when clients call this.server.register(...), we:</span>
  <span>async</span> <span>register</span><span>(</span><span>client</span><span>,</span> <span>...</span><span>eventNames</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>!</span><span>api</span><span>.</span><span>connected</span><span>)</span> <span>return</span><span>;</span>
    <span>eventNames</span><span>.</span><span>forEach</span><span>((</span><span>eventName</span><span>)</span> <span>=&gt;</span> <span>this</span><span>.</span><span>#</span><span>registerEvent</span><span>(</span><span>client</span><span>,</span> <span>eventName</span><span>));</span>
  <span>}</span>

  <span>// With a private function for registering events on the API:</span>
  <span>#</span><span>registerEvent</span><span>(</span><span>client</span><span>,</span> <span>eventName</span><span>)</span> <span>{</span>
    <span>const</span> <span>tracker</span> <span>=</span> <span>(</span><span>eventTracker</span><span>[</span><span>eventName</span><span>]</span> <span>??=</span> <span>{</span> <span>listeners</span><span>:</span> <span>[]</span> <span>});</span>

    <span>// One that can response to custom "api server only" event requests:</span>
    <span>if</span> <span>(</span><span>eventName</span> <span>===</span> <span>`MSFS`</span><span>)</span> <span>{</span>
      <span>return</span> <span>client</span><span>.</span><span>onMSFS</span><span>(</span><span>api</span><span>.</span><span>connected</span><span>);</span>
    <span>}</span>

    <span>// And has additional logic for making sure a client doesn't "double-register":</span>
    <span>if</span> <span>(</span><span>tracker</span><span>.</span><span>listeners</span><span>.</span><span>includes</span><span>(</span><span>client</span><span>))</span> <span>{</span>
      <span>console</span><span>.</span><span>log</span><span>(</span>
        <span>`Ignoring </span><span>${</span><span>eventName</span><span>}</span><span> registration: client already registered. Current value: </span><span>${</span><span>tracker</span><span>.</span><span>value</span><span>}</span><span>`</span>
      <span>);</span>
      <span>return</span> <span>false</span><span>;</span>
    <span>}</span>

    <span>// When a client registers for a sim event like "SIM" or "FLIGHT_LOADED",</span>
    <span>// we assume we can call them back with event information on function</span>
    <span>// names like onSim and onFlightLoaded:</span>
    <span>const</span> <span>eventHandlerName</span> <span>=</span>
      <span>`on`</span> <span>+</span>
      <span>eventName</span>
        <span>.</span><span>split</span><span>(</span><span>`_`</span><span>)</span>
        <span>.</span><span>map</span><span>((</span><span>v</span><span>)</span> <span>=&gt;</span> <span>v</span><span>[</span><span>0</span><span>].</span><span>toUpperCase</span><span>()</span> <span>+</span> <span>v</span><span>.</span><span>substring</span><span>(</span><span>1</span><span>).</span><span>toLowerCase</span><span>())</span>
        <span>.</span><span>join</span><span>(</span><span>``</span><span>);</span>

    <span>// So: ask the API to register for this event, with an appropriate</span>
    <span>// bit of code to handle "what to do when SimConnect flags this event".</span>
    <span>if</span> <span>(</span><span>!</span><span>tracker</span><span>.</span><span>off</span><span>)</span> <span>{</span>
      <span>tracker</span><span>.</span><span>off</span> <span>=</span> <span>api</span><span>.</span><span>on</span><span>(</span><span>SystemEvents</span><span>[</span><span>eventName</span><span>],</span> <span>(...</span><span>result</span><span>)</span> <span>=&gt;</span> <span>{</span>
        <span>tracker</span><span>.</span><span>value</span> <span>=</span> <span>result</span><span>;</span>
        <span>tracker</span><span>.</span><span>listeners</span><span>.</span><span>forEach</span><span>((</span><span>client</span><span>)</span> <span>=&gt;</span>
          <span>client</span><span>[</span><span>eventHandlerName</span><span>](</span><span>tracker</span><span>.</span><span>value</span><span>)</span>
        <span>);</span>
      <span>});</span>
    <span>}</span>
  <span>}</span>

  <span>// And when clients call this.server.forget(...), we do the opposite:</span>
  <span>async</span> <span>forget</span><span>(</span><span>client</span><span>,</span> <span>eventName</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>!</span><span>api</span><span>.</span><span>connected</span><span>)</span> <span>return</span><span>;</span>
    <span>const</span> <span>pos</span> <span>=</span> <span>eventTracker</span><span>[</span><span>eventName</span><span>].</span><span>listeners</span><span>.</span><span>findIndex</span><span>(</span>
      <span>(</span><span>c</span><span>)</span> <span>=&gt;</span> <span>c</span> <span>===</span> <span>client</span>
    <span>);</span>
    <span>if</span> <span>(</span><span>pos</span> <span>===</span> <span>-</span><span>1</span><span>)</span> <span>return</span><span>;</span>
    <span>eventTracker</span><span>[</span><span>eventName</span><span>].</span><span>listeners</span><span>.</span><span>splice</span><span>(</span><span>pos</span><span>,</span> <span>1</span><span>);</span>
    <span>if</span> <span>(</span><span>eventTracker</span><span>[</span><span>eventName</span><span>].</span><span>listeners</span><span>.</span><span>length</span> <span>===</span> <span>0</span><span>)</span> <span>{</span>
      <span>eventTracker</span><span>[</span><span>eventName</span><span>].</span><span>off</span><span>();</span>
    <span>}</span>
  <span>}</span>

  <span>// And when clients call this.server.get(...), we cache the set of simvars</span>
  <span>// that are being requested, so we don't ask SimConnect for the same data</span>
  <span>// several times, if several clients want the same information at the same time.</span>
  <span>async</span> <span>get</span><span>(</span><span>client</span><span>,</span> <span>...</span><span>simVarNames</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>!</span><span>api</span><span>.</span><span>connected</span><span>)</span> <span>return</span> <span>{};</span>
    <span>const</span> <span>now</span> <span>=</span> <span>Date</span><span>.</span><span>now</span><span>();</span>
    <span>const</span> <span>key</span> <span>=</span> <span>createHash</span><span>(</span><span>"</span><span>sha1</span><span>"</span><span>).</span><span>update</span><span>(</span><span>simVarNames</span><span>.</span><span>join</span><span>(</span><span>`,`</span><span>)).</span><span>digest</span><span>(</span><span>"</span><span>hex</span><span>"</span><span>);</span>
    <span>// assign a new expiry, if there is no cached entry already:</span>
    <span>resultCache</span><span>[</span><span>key</span><span>]</span> <span>??=</span> <span>{</span> <span>expires</span><span>:</span> <span>now</span> <span>};</span>
    <span>// did our cached entry "expire"? (which, if we just made it, won't be the case of course)</span>
    <span>if</span> <span>(</span><span>resultCache</span><span>[</span><span>key</span><span>]?.</span><span>expires</span> <span>&lt;=</span> <span>now</span> <span>===</span> <span>true</span><span>)</span> <span>{</span>
      <span>resultCache</span><span>[</span><span>key</span><span>].</span><span>expires</span> <span>=</span> <span>now</span> <span>+</span> <span>100</span><span>;</span> <span>// ms</span>
      <span>// we cache a promise, rather than data, so we can "await"</span>
      <span>resultCache</span><span>[</span><span>key</span><span>].</span><span>data</span> <span>=</span> <span>new</span> <span>Promise</span><span>(</span><span>async</span> <span>(</span><span>resolve</span><span>)</span> <span>=&gt;</span> <span>{</span>
        <span>try</span> <span>{</span>
          <span>resolve</span><span>(</span><span>await</span> <span>api</span><span>.</span><span>get</span><span>(...</span><span>simVarNames</span><span>));</span>
        <span>}</span> <span>catch</span> <span>(</span><span>e</span><span>)</span> <span>{</span>
          <span>// Also make sure to never crash the server if there's a problem with a simvar:</span>
          <span>console</span><span>.</span><span>warn</span><span>(</span><span>e</span><span>);</span>
          <span>resolve</span><span>({});</span>
        <span>}</span>
      <span>});</span>
    <span>}</span>
    <span>// And then we await the cache entry's data before responding. If this is a</span>
    <span>// request for data that was previously cached already, then this will pretty</span>
    <span>// much resolve instantly. Otherwise, it'll resolve once we get data from the API.</span>
    <span>return</span> <span>await</span> <span>resultCache</span><span>[</span><span>key</span><span>].</span><span>data</span><span>;</span>
  <span>}</span>

  <span>// when clients call this.server.set(...), we forward that to the API:</span>
  <span>async</span> <span>set</span><span>(</span><span>client</span><span>,</span> <span>simVars</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>!</span><span>api</span><span>.</span><span>connected</span><span>)</span> <span>return</span> <span>false</span><span>;</span>

    <span>if</span> <span>(</span><span>typeof</span> <span>simVars</span> <span>!==</span> <span>`object`</span><span>)</span>
      <span>throw</span> <span>new</span> <span>Error</span><span>(</span><span>`api.set input must be an object.`</span><span>);</span>

    <span>// But we make sure to handle each setter separately, so we can</span>
    <span>// report any and all errors, without breaking the entire call.</span>
    <span>const</span> <span>errors</span> <span>=</span> <span>[];</span>
    <span>const</span> <span>entries</span> <span>=</span> <span>Object</span><span>.</span><span>entries</span><span>(</span><span>simVars</span><span>);</span>
    <span>entries</span><span>.</span><span>forEach</span><span>(([</span><span>key</span><span>,</span> <span>value</span><span>])</span> <span>=&gt;</span> <span>{</span>
      <span>try</span> <span>{</span>
        <span>api</span><span>.</span><span>set</span><span>(</span><span>key</span><span>,</span> <span>value</span><span>);</span>
      <span>}</span> <span>catch</span> <span>(</span><span>e</span><span>)</span> <span>{</span>
        <span>errors</span><span>.</span><span>push</span><span>(</span><span>e</span><span>.</span><span>message</span><span>);</span>
      <span>}</span>
    <span>});</span>
    <span>return</span> <span>errors</span><span>.</span><span>length</span> <span>?</span> <span>errors</span> <span>:</span> <span>true</span><span>;</span>
  <span>}</span>

  <span>// And for triggers, we forward those too, but we only allow single triggers per call.Ï</span>
  <span>async</span> <span>trigger</span><span>(</span><span>client</span><span>,</span> <span>eventName</span><span>,</span> <span>value</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>!</span><span>api</span><span>.</span><span>connected</span><span>)</span> <span>return</span> <span>false</span><span>;</span>
    <span>api</span><span>.</span><span>trigger</span><span>(</span><span>eventName</span><span>,</span> <span>value</span><span>);</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>Phew. That was a lot of code! But hopefully, it all made sense. Because we still have to look at our client class… which is going to be a <em>lot</em> less code =)</p>

<h2 id="our-browser-connection-accepting-client">Our browser-connection-accepting client</h2>

<p>In addition to our API server, we’re going to need a client that is also a web server, so that we can connect a browser and actually, you know, <em>use</em> all of this. This means we’ll have to define a client class such that <code>socketless</code> can take care of the rest. Thankfully, this is super easy: our client doesn’t need to “do” anything other than make sure that values make it from the server to the browser, and vice versa, so we’re going to essentially be writing a state-manager, where the client takes signals from the server and turns them into updates to its <code>this.state</code> variable, and then <code>socketless</code> will take care of the tedious “making sure the browser gets that” parts. So: client class time! (which we put in its own <code>src/classes/client.js</code>)</p>

<div><pre><code><span>import</span> <span>{</span> <span>runLater</span> <span>}</span> <span>from</span> <span>"</span><span>../../utils/utils.js</span><span>"</span><span>;</span>

<span>// when we lose the connection to the server, this will be our reconnection interval:</span>
<span>const</span> <span>RECONNECT_TIMEOUT_IN_MS</span> <span>=</span> <span>5000</span><span>;</span>

<span>// A timeer variable for when we need to (re)try (re)connecting.</span>
<span>let</span> <span>reconnection</span><span>;</span>

<span>/**
 * Our client class
 */</span>
<span>export</span> <span>class</span> <span>ClientClass</span> <span>{</span>
  <span>/**
   * When our client starts up, start a "reconnect 5 seconds
   * from now" attempt, cleaned up when we connect.
   */</span>
  <span>init</span><span>()</span> <span>{</span>
    <span>this</span><span>.</span><span>#</span><span>resetState</span><span>();</span>
    <span>runLater</span><span>(()</span> <span>=&gt;</span> <span>this</span><span>.</span><span>#</span><span>tryReconnect</span><span>(),</span> <span>RECONNECT_TIMEOUT_IN_MS</span><span>);</span>
  <span>}</span>

  <span>/**
   * A private function that sets our state to a "starting default" state.
   */</span>
  <span>async</span> <span>#</span><span>resetState</span><span>()</span> <span>{</span>
    <span>// "setState" is a magic function that comes with socketless, and will</span>
    <span>// automatically lead to a browser sync, if there's a browser connected.</span>
    <span>this</span><span>.</span><span>setState</span><span>({</span>
      <span>crashed</span><span>:</span> <span>false</span><span>,</span>
      <span>flying</span><span>:</span> <span>false</span><span>,</span>
      <span>MSFS</span><span>:</span> <span>false</span><span>,</span>
      <span>serverConnection</span><span>:</span> <span>false</span><span>,</span>
      <span>paused</span><span>:</span> <span>true</span><span>,</span>
    <span>});</span>
  <span>}</span>

  <span>/**
   * A private function that lets us reconnect to the server
   * in case it disappears and comes back online.
   */</span>
  <span>async</span> <span>#</span><span>tryReconnect</span><span>()</span> <span>{</span>
    <span>if</span> <span>(</span><span>this</span><span>.</span><span>server</span><span>)</span> <span>{</span>
      <span>clearTimeout</span><span>(</span><span>reconnection</span><span>);</span>
      <span>return</span> <span>console</span><span>.</span><span>log</span><span>(</span><span>`reconnected`</span><span>);</span>
    <span>}</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`trying to reconnect to the server...`</span><span>);</span>
    <span>this</span><span>.</span><span>#</span><span>resetState</span><span>();</span>
    <span>this</span><span>.</span><span>reconnect</span><span>();</span> <span>// &lt;- this is also a magic socketless function</span>
    <span>reconnection</span> <span>=</span> <span>setTimeout</span><span>(</span>
      <span>()</span> <span>=&gt;</span> <span>this</span><span>.</span><span>#</span><span>tryReconnect</span><span>(),</span>
      <span>RECONNECT_TIMEOUT_IN_MS</span>
    <span>);</span>
  <span>}</span>


  <span>/**
   * The main role of our client is to encode a state that can be
   * automatically communicated to the browser. As such, really
   * the only thing we're doing si setting up a state, and then
   * updating that based on server signals.
   */</span>
  <span>async</span> <span>onConnect</span><span>()</span> <span>{</span>
    <span>clearTimeout</span><span>(</span><span>reconnection</span><span>);</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`client connected to server`</span><span>);</span>
    <span>this</span><span>.</span><span>setState</span><span>({</span>
      <span>serverConnection</span><span>:</span> <span>true</span><span>,</span>
    <span>});</span>
    <span>await</span> <span>this</span><span>.</span><span>server</span><span>.</span><span>api</span><span>.</span><span>register</span><span>(</span><span>`MSFS`</span><span>);</span>
  <span>}</span>

  <span>/**
   * If we become disconnected from the server, go into a
   * "holding pattern" where we check whether the server
   * is back every few seconds.
   */</span>
  <span>async</span> <span>onDisconnect</span><span>()</span> <span>{</span>
    <span>// First, since we obviously don't have a server anymore,</span>
    <span>// we won't be informed about whether or not we're still</span>
    <span>// flying, or really anything about the flight at all, so</span>
    <span>// record that we're not flying (anymore).</span>
    <span>this</span><span>.</span><span>setState</span><span>({</span>
      <span>flying</span><span>:</span> <span>false</span><span>,</span>
      <span>MSFS</span><span>:</span> <span>false</span><span>,</span>
      <span>serverConnection</span><span>:</span> <span>false</span><span>,</span>
    <span>});</span>
    <span>// Then start the reconnect cycle</span>
    <span>this</span><span>.</span><span>#</span><span>tryReconnect</span><span>();</span>
  <span>}</span>

  <span>// Record that a connection has been established. Since the state</span>
  <span>// gets automatically synced at the browser, this means the browser</span>
  <span>// can also see that `this.state.connected` is true.</span>
  <span>async</span> <span>onBrowserConnect</span><span>(</span><span>browser</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>setState</span><span>({</span> <span>browserConnected</span><span>:</span> <span>true</span> <span>});</span>
  <span>}</span>

  <span>// And the opposite when the browser disconnects, of course:</span>
  <span>async</span> <span>onBrowserDisconnect</span><span>(</span><span>browser</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>setState</span><span>({</span> <span>browserConnected</span><span>:</span> <span>false</span> <span>});</span>
  <span>}</span>

  <span>// Then a set of self-explanatory functions based on events:</span>
  <span>async</span> <span>onMSFS</span><span>(</span><span>value</span><span>)</span> <span>{</span> <span>this</span><span>.</span><span>setState</span><span>({</span> <span>MSFS</span><span>:</span> <span>value</span> <span>});</span> <span>}</span>
  <span>async</span> <span>pause</span><span>()</span> <span>{</span> <span>this</span><span>.</span><span>setState</span><span>({</span> <span>paused</span><span>:</span> <span>true</span> <span>});</span> <span>}</span>
  <span>async</span> <span>unpause</span><span>()</span> <span>{</span> <span>this</span><span>.</span><span>setState</span><span>({</span> <span>paused</span><span>:</span> <span>false</span> <span>});</span> <span>}</span>
  <span>async</span> <span>crashed</span><span>()</span> <span>{</span> <span>this</span><span>.</span><span>setState</span><span>({</span> <span>crashed</span><span>:</span> <span>true</span> <span>});</span> <span>}</span>
  <span>async</span> <span>crashReset</span><span>()</span> <span>{</span> <span>this</span><span>.</span><span>setState</span><span>({</span> <span>crashed</span><span>:</span> <span>false</span> <span>});</span> <span>}</span>
<span>}</span>
</code></pre></div>

<p>With that, let’s move on to the browser.</p>

<h2 id="the-browser-code">The browser code</h2>

<p>In order for the browser to be able to “do something”, we’ll use the <code>index.html</code> we made earlier without any modifications, but we’ll update <code>index.js</code>:</p>

<div><pre><code><span>import</span> <span>{</span> <span>createBrowserClient</span> <span>}</span> <span>from</span> <span>"</span><span>../socketless.js</span><span>"</span><span>;</span>

<span>// Let's import a class that's *actually* going to do all the work...</span>
<span>import</span> <span>{</span> <span>Plane</span> <span>}</span> <span>from</span> <span>"</span><span>./js/plane.js</span><span>"</span><span>;</span>

<span>// And then we update our browser client, whose sole responsibility</span>
<span>// is to hand off state updates to our new "Plane" object:</span>
<span>class</span> <span>BrowserClient</span> <span>{</span>
  <span>async</span> <span>init</span><span>()</span> <span>{</span>
    <span>this</span><span>.</span><span>plane</span> <span>=</span> <span>new</span> <span>Plane</span><span>(</span><span>this</span><span>.</span><span>server</span><span>);</span>
  <span>}</span>

  <span>async</span> <span>update</span><span>(</span><span>prevState</span><span>)</span> <span>{</span>
    <span>// set a class on the HTML body based on our connection state...</span>
    <span>document</span><span>.</span><span>body</span><span>.</span><span>classList</span><span>.</span><span>toggle</span><span>(</span><span>`connected`</span><span>,</span> <span>this</span><span>.</span><span>state</span><span>.</span><span>serverConnection</span><span>);</span>

    <span>// And then, ather than "doing anything" here, we just pass the current</span>
    <span>// state on to the Plane. All we do in this file is wait for the next update.</span>
    <span>this</span><span>.</span><span>plane</span><span>.</span><span>updateState</span><span>(</span><span>this</span><span>.</span><span>state</span><span>);</span>
  <span>}</span>
<span>}</span>

<span>createBrowserClient</span><span>(</span><span>BrowserClient</span><span>);</span>
</code></pre></div>

<p>So that just leaves looking at our <code>Plane</code> code, which will minimal for now, andwe’ll put in <code>public/js/plane.js</code>:</p>

<div><pre><code><span>// We'll be building this out throughout this document, but this</span>
<span>// will be our main entry point when it comes to what the browser</span>
<span>// shows in terms of both visualisation and interactivity.</span>
<span>export</span> <span>class</span> <span>Plane</span> <span>{</span>
  <span>constructor</span><span>(</span><span>server</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>server</span> <span>=</span> <span>server</span><span>;</span>
    <span>this</span><span>.</span><span>lastUpdate</span> <span>=</span> <span>{</span>
      <span>lat</span><span>:</span> <span>0</span><span>,</span>
      <span>long</span><span>:</span> <span>0</span><span>,</span>
      <span>flying</span><span>:</span> <span>false</span><span>,</span>
      <span>crashed</span><span>:</span> <span>false</span><span>,</span>
    <span>};</span>
  <span>}</span>

  <span>async</span> <span>updateState</span><span>(</span><span>state</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>state</span> <span>=</span> <span>state</span><span>;</span>
    <span>const</span> <span>now</span> <span>=</span> <span>Date</span><span>.</span><span>now</span><span>();</span>

    <span>// ...nothing here yet, but we'll be filling this out in soon enough!</span>

    <span>this</span><span>.</span><span>lastUpdate</span> <span>=</span> <span>{</span> <span>time</span><span>:</span> <span>now</span><span>,</span> <span>...</span><span>state</span> <span>};</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And that’s it. There’s nothing “meaningful” in our plane class yet, but for the moment we’re done: we’ve set up a complete API server, web server, and browser system.</p>

<h2 id="adding-permission-control">Adding “permission control”</h2>

<p>That just leaves one last thing: making sure that only “we” get to talk to MSFS directly. We don’t want people to just spam MSFS with API requests or even set values or trigger MSFS event and mess with our flight, or worse!</p>

<p>In order to do that, we first add three new keys to our <code>.env</code> file to act as a security key:</p>

<div><pre><code><span>export </span><span>API_PORT</span><span>=</span>8080
<span>export </span><span>WEB_PORT</span><span>=</span>3000
<span>export </span><span>FLIGHT_OWNER_KEY</span><span>=</span><span>"dXNlcm5hbWVwYXNzd29yZA=="</span>
<span>export </span><span>FLIGHT_OWNER_USERNAME</span><span>=</span>username
<span>export </span><span>FLIGHT_OWNER_PASSWORD</span><span>=</span>password
</code></pre></div>

<p>Just a <a href="https://en.wikipedia.org/wiki/Base64">base64</a> conversion of the string concatenation <code>"username" + "password"</code>… super secure! Of course, when we make our web page available, we’ll want to make triple-sure that we change this key to something a little more secret-appropriate =)</p>

<p>Then, let’s update our <code>server.js</code> class with a function that clients can call in order to authenticate:</p>

<div><pre><code><span>...</span>

<span>const</span> <span>{</span> <span>FLIGHT_OWNER_KEY</span> <span>}</span> <span>=</span> <span>process</span><span>.</span><span>env</span><span>;</span>

<span>...</span>

<span>export</span> <span>class</span> <span>ServerClass</span> <span>{</span>
  <span>#</span><span>authenticatedClients</span> <span>=</span> <span>[];</span>

  <span>async</span> <span>init</span><span>()</span> <span>{</span>
    <span>const</span> <span>{</span> <span>clients</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>

    <span>api</span> <span>=</span> <span>new</span> <span>MSFS_API</span><span>();</span>

    <span>// Set up call routing so that clients can call this.server.api.[...]</span>
    <span>// in order to talk directly to the API, but only allow this for</span>
    <span>// authenticated clients, rather than everyone:</span>
    <span>this</span><span>.</span><span>api</span> <span>=</span> <span>this</span><span>.</span><span>lock</span><span>(</span>
      <span>new</span> <span>APIRouter</span><span>(</span><span>api</span><span>),</span>
      <span>(</span><span>client</span><span>)</span> <span>=&gt;</span> <span>this</span><span>.</span><span>#</span><span>authenticatedClients</span><span>.</span><span>includes</span><span>(</span><span>client</span><span>)</span>
    <span>);</span>

    <span>connectServerToAPI</span><span>(</span><span>api</span><span>,</span> <span>async</span> <span>()</span> <span>=&gt;</span> <span>{</span>
      <span>...</span>
    <span>});</span>
  <span>}</span>

  <span>..</span>

  <span>/**
   * An almost trivially simple authentication function:
   */</span>
  <span>async</span> <span>authenticate</span><span>(</span><span>client</span><span>,</span> <span>username</span><span>,</span> <span>password</span><span>)</span> <span>{</span>
    <span>// This should go without saying, but: don't do this in real</span>
    <span>// code. Use a proper, secure login solution, instead =)</span>
    <span>const</span> <span>hash</span> <span>=</span> <span>btoa</span><span>(</span><span>username</span> <span>+</span> <span>password</span><span>);</span>
    <span>if</span> <span>(</span><span>hash</span> <span>!==</span> <span>FLIGHT_OWNER_KEY</span><span>)</span> <span>return</span> <span>false</span><span>;</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`authenticated client </span><span>${</span><span>client</span><span>.</span><span>id</span><span>}</span><span>`</span><span>);</span>
    <span>this</span><span>.</span><span>#</span><span>authenticatedClients</span><span>.</span><span>push</span><span>(</span><span>client</span><span>);</span>
    <span>return</span> <span>true</span><span>;</span>
  <span>}</span>
<span>}</span>

</code></pre></div>

<p>With that, we can now make clients (and by extension, browsers) authenticate by having them call <code>this.server.authenticate(...)</code>, so let’s make that work by updating our <code>client.js</code> so it loads that key (if it has access to it) and calls the authentication function:</p>

<div><pre><code><span>// Load in our environment variables now we have</span>
<span>import</span> <span>url</span> <span>from</span> <span>"</span><span>node:url</span><span>"</span><span>;</span>
<span>const</span> <span>__dirname</span> <span>=</span> <span>url</span><span>.</span><span>fileURLToPath</span><span>(</span><span>new</span> <span>URL</span><span>(</span><span>"</span><span>.</span><span>"</span><span>,</span> <span>import</span><span>.</span><span>meta</span><span>.</span><span>url</span><span>));</span>
<span>import</span> <span>dotenv</span> <span>from</span> <span>"</span><span>dotenv</span><span>"</span><span>;</span>
<span>dotenv</span><span>.</span><span>config</span><span>({</span> <span>path</span><span>:</span> <span>`</span><span>${</span><span>__dirname</span><span>}</span><span>/../../../.env`</span> <span>});</span>

<span>// Do we have a flight owner key that we need to authenticate with?</span>
<span>let</span> <span>username</span><span>,</span> <span>password</span><span>;</span>
<span>if</span> <span>(</span><span>process</span><span>.</span><span>argv</span><span>.</span><span>includes</span><span>(</span><span>`--owner`</span><span>))</span> <span>{</span>
  <span>username</span> <span>=</span> <span>process</span><span>.</span><span>env</span><span>.</span><span>FLIGHT_OWNER_USERNAME</span><span>;</span>
  <span>password</span> <span>=</span> <span>process</span><span>.</span><span>env</span><span>.</span><span>FLIGHT_OWNER_PASSWORD</span><span>;</span>
<span>}</span>

<span>...</span>

<span>export</span> <span>class</span> <span>ClientClass</span> <span>{</span>
  <span>...</span>

  <span>// The only update will be to our "onConnect", where we're</span>
  <span>// going to immediately try to authenticate with the server:</span>
  <span>async</span> <span>onConnect</span><span>()</span> <span>{</span>
    <span>clearTimeout</span><span>(</span><span>reconnection</span><span>);</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`client connected to server`</span><span>);</span>
    <span>this</span><span>.</span><span>setState</span><span>({</span>
      <span>// authenticate with the server, using our stored username and password:</span>
      <span>authenticated</span><span>:</span> <span>await</span> <span>this</span><span>.</span><span>server</span><span>.</span><span>authenticate</span><span>(</span><span>username</span><span>,</span> <span>password</span><span>),</span>
      <span>serverConnection</span><span>:</span> <span>true</span><span>,</span>
    <span>});</span>

    <span>// Since API access is now restricted, make sure we only call it</span>
    <span>// when we know (or think we know) that we won't be rejected.</span>
    <span>if</span> <span>(</span><span>this</span><span>.</span><span>state</span><span>.</span><span>authenticated</span><span>)</span> <span>{</span>
      <span>await</span> <span>this</span><span>.</span><span>server</span><span>.</span><span>api</span><span>.</span><span>register</span><span>(</span><span>`MSFS`</span><span>);</span>
    <span>}</span>
  <span>}</span>

  <span>...</span>
<span>}</span>
</code></pre></div>

<p>And that’s our “authentication” added, so we have all the parts in place:</p>

<ol>
  <li>we can start up MSFS,</li>
  <li>we can start up our API server using <code>node api-server.js</code>,</li>
  <li>we can start up our web server using <code>node web-server.js --owner --browser</code></li>
  <li>we can have the browser open http://localhost:3000, and then</li>
  <li>we can use a UI that’s based on the current client state, with the option to get values from MSFS as well as set values and trigger events in MSFS as needed using the developer tools console.</li>
</ol>

<h2 id="testing-our-code">Testing our code</h2>

<p>So, let’s run this code and <em>actually</em> talk to MSFS. First, let’s make sure we have direct access to our browser client by updating our <code>index.js</code>:</p>

<div><pre><code><span>...</span>

<span>// Let's get a direct reference to our client so we can do some testing using our developer tools:</span>
<span>window</span><span>.</span><span>browserClient</span> <span>=</span> <span>createBrowserClient</span><span>(</span><span>BrowserClient</span><span>);</span>
</code></pre></div>

<p>As you can see the <code>createBrowserClient</code> returns the actual instance it builds. There’s rarely a reason to capture that, but it can be <em>very</em> useful for testing, like now!</p>

<p>Let’s fire up MSFS and load up a plane on on a runway somewhere, run our API server, run our client with the <code>--browser</code> flag, and then let’s open the developer tools in the browser and get to the “console” tab. While there, let’s ask MSFS for some things:</p>

<div><pre><code><span>»</span> <span>await</span> <span>browserClient</span><span>.</span><span>server</span><span>.</span><span>api</span><span>.</span><span>get</span><span>(</span>
  <span>`CATEGORY`</span><span>,</span>
  <span>`DESIGN_CRUISE_ALT`</span><span>,</span>
  <span>`DESIGN_TAKEOFF_SPEED`</span><span>,</span>
  <span>`ENGINE_TYPE`</span><span>,</span>
  <span>`IS_TAIL_DRAGGER`</span><span>,</span>
  <span>`NUMBER_OF_ENGINES`</span><span>,</span>
  <span>`TITLE`</span><span>,</span>
  <span>`TOTAL_WEIGHT`</span><span>,</span>
  <span>`TYPICAL_DESCENT_RATE`</span><span>,</span>
  <span>`WING_SPAN`</span><span>,</span>
<span>);</span>
</code></pre></div>

<p>If we had loaded up a De Havilland DHC-2 “Beaver”, we might get the following response:</p>

<div><pre><code><span>«</span> <span>▼</span> <span>Object</span> <span>{</span>
  <span>"</span><span>CATEGORY</span><span>"</span><span>:</span> <span>"</span><span>Airplane</span><span>"</span><span>,</span>
  <span>"</span><span>DESIGN_CRUISE_ALT</span><span>"</span><span>:</span> <span>5000</span><span>,</span>
  <span>"</span><span>DESIGN_TAKEOFF_SPEED</span><span>"</span><span>:</span> <span>65</span><span>,</span>
  <span>"</span><span>ENGINE_TYPE</span><span>"</span><span>:</span> <span>0</span><span>,</span>
  <span>"</span><span>IS_TAIL_DRAGGER</span><span>"</span><span>:</span> <span>1</span><span>,</span>
  <span>"</span><span>NUMBER_OF_ENGINES</span><span>"</span><span>:</span> <span>1</span><span>,</span>
  <span>"</span><span>TITLE</span><span>"</span><span>:</span> <span>"</span><span>Blackbird Simulations DHC-2 Beaver Wheels N93E</span><span>"</span><span>,</span>
  <span>"</span><span>TOTAL_WEIGHT</span><span>"</span><span>:</span> <span>3954.932373046875</span><span>,</span>
  <span>"</span><span>TYPICAL_DESCENT_RATE</span><span>"</span><span>:</span> <span>16.66666666666665</span><span>,</span>
  <span>"</span><span>WING_SPAN</span><span>"</span><span>:</span> <span>48</span>
<span>}</span>
</code></pre></div>

<p>Of course, none of these things have units, but that’s what the <a href="https://docs.flightsimulator.com/html/Programming_Tools/SimVars/Simulation_Variables.htm">SimConnect documentation</a> is for: the Beaver is designed to cruise at 5000 feet, take off at 65 knots, it has a two wheels up front and a little wibble wheel at the back (i.e. it’s a “tail dragger”), it has one engine, which is a piston propeller (which we know by looking up the enum for engine type); it weighs 3955 pounds, has a wing span of 48 feet, and has a typical descent rate of 16.667 feet per second.</p>

<p>And of course, we can also ask for information that’s relevant to our flight <em>right now</em> rather than just asking about the plane in general. Say we actually took off and are cruising along, we can run:</p>

<div><pre><code><span>»</span> <span>await</span> <span>browserClient</span><span>.</span><span>server</span><span>.</span><span>api</span><span>.</span><span>get</span><span>(</span>
  <span>`AIRSPEED_INDICATED`</span><span>,</span>
  <span>`ELEVATOR_TRIM_PCT`</span><span>,</span>
  <span>`PLANE_ALT_ABOVE_GROUND`</span><span>,</span>
  <span>`PLANE_ALTITUDE`</span><span>,</span>
  <span>`PLANE_BANK_DEGREES`</span><span>,</span>
  <span>`PLANE_HEADING_DEGREES_MAGNETIC`</span><span>,</span>
  <span>`PLANE_LONGITUDE`</span><span>,</span>
  <span>`PLANE_LATITUDE`</span><span>,</span>
  <span>`VERTICAL_SPEED`</span><span>,</span>
<span>);</span>
</code></pre></div>

<p>And this might give us something like:</p>

<div><pre><code><span>«</span> <span>▼</span> <span>Object</span> <span>{</span>
  <span>"</span><span>AIRSPEED_INDICATED</span><span>"</span><span>:</span> <span>139.7057647705078</span><span>,</span>
  <span>"</span><span>ELEVATOR_TRIM_PCT</span><span>"</span><span>:</span> <span>-</span><span>0.33069596466810336</span><span>,</span>
  <span>"</span><span>PLANE_ALT_ABOVE_GROUND</span><span>"</span><span>:</span> <span>573.1917558285606</span><span>,</span>
  <span>"</span><span>PLANE_ALTITUDE</span><span>"</span><span>:</span> <span>996.7162778193412</span><span>,</span>
  <span>"</span><span>PLANE_BANK_DEGREES</span><span>"</span><span>:</span> <span>-</span><span>0.001284847042605199</span><span>,</span>
  <span>"</span><span>PLANE_HEADING_DEGREES_MAGNETIC</span><span>"</span><span>:</span> <span>4.539803629684118</span><span>,</span>
  <span>"</span><span>PLANE_LONGITUDE</span><span>"</span><span>:</span> <span>-</span><span>2.1609759665698802</span><span>,</span>
  <span>"</span><span>PLANE_LATITUDE</span><span>"</span><span>:</span> <span>0.8514234731618152</span><span>,</span>
  <span>"</span><span>VERTICAL_SPEED</span><span>"</span><span>:</span> <span>0.3496674597263333</span>
<span>}</span>
</code></pre></div>

<p>This tells us our plane is flying over Vancouver Island at GPS coordinates -123.814803 longitude, 48.782971 latitude (both values reported in degrees radians by MSFS, not decimal degrees), with an air speed of about 140 knots (which is around 260kmh/161mph), flying at an altitude of almost 1000 feet (305m) above sea level, but really only about 573 feet (174m) above the ground. We can see that we’re flying fairly straight (our “bank” angle is basically 0), with a heading of 260 degrees on the compass (given in radians again), and we can see that we’re flying fairly straight in the vertical sense, too: the plane is currently moving up at about a third of a foot per second (so about 4”, or 10cm, per second), which is well within “flying straight” limits.</p>

<p>We can trigger events, too:</p>

<div><pre><code><span>»</span> <span>await</span> <span>browserClient</span><span>.</span><span>server</span><span>.</span><span>api</span><span>.</span><span>get</span><span>(</span><span>`TAILWHEEL_LOCK_ON`</span><span>);</span>
<span>»</span> <span>browserClient</span><span>.</span><span>server</span><span>.</span><span>api</span><span>.</span><span>trigger</span><span>(</span><span>`TOGGLE_TAILWHEEL_LOCK`</span><span>);</span>
<span>»</span> <span>await</span> <span>browserClient</span><span>.</span><span>server</span><span>.</span><span>api</span><span>.</span><span>get</span><span>(</span><span>`TAILWHEEL_LOCK_ON`</span><span>);</span>
</code></pre></div>

<p>Which should result in:</p>

<div><pre><code><span>«</span> <span>▼</span> <span>Object</span> <span>{</span>
  <span>"</span><span>TAILWHEEL_LOCK_ON</span><span>"</span><span>:</span> <span>0</span>
<span>}</span>
<span>«</span> <span>undefined</span>
<span>«</span> <span>▼</span> <span>Object</span> <span>{</span>
  <span>"</span><span>TAILWHEEL_LOCK_ON</span><span>"</span><span>:</span> <span>1</span>
<span>}</span>
</code></pre></div>

<p>And of course, we can listen for events. For example, we can write this:</p>

<div><pre><code><span>»</span> <span>browserClient</span><span>.</span><span>server</span><span>.</span><span>api</span><span>.</span><span>on</span><span>(</span><span>`CRASHED`</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>console</span><span>.</span><span>log</span><span>(</span><span>`...we crashed!`</span><span>))</span>
</code></pre></div>

<p>And now if we point our plane towards the ground and just let gravity do the rest (don’t worry, it’s just pixels, it’s perfectly safe), eventually our flight will come to an abrupt stop, the MSFS screen will go black, and we’ll get a little dialog telling us that we crashed… but if we look at the dev tools console for our web page, we’ll also see this little gem:</p>



<p>Which means our crash event listener worked. So this is promising, we have a full loop!</p>

<h2 id="hot-reloading-to-make-our-dev-lives-easier">Hot-reloading to make our dev lives easier</h2>

<p>Now, being able to write code is all well and good, but we’re going to be <em>working on that code</em> a lot, so it’d be nice if we don’t constantly have to stop and restart the server for every line we change, and instead just have code changes kick in automatically when we save files. And while there isn’t anything baked into JS to make that happen, with a bit of smart programming we can take advantage of filesystem watching, as we well as how <code>import</code> works, to make this happen for us. Anyway</p>

<p>We can, for instance, write a function that will selectively watch a single file for changes, and if it sees any, load the new code in, and then trigger an event handler for “whoever might need it” with the newly loaded code:</p>

<div><pre><code><span>// We'll be using Node's own file watch mechanism for this:</span>
<span>import</span> <span>{</span> <span>watchFile</span> <span>}</span> <span>from</span> <span>"</span><span>node:fs</span><span>"</span><span>;</span>

<span>// With some helpers for making sure we know where our files and modules live:</span>
<span>import</span> <span>{</span> <span>__root</span> <span>}</span> <span>from</span> <span>"</span><span>./constants.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>rootRelative</span> <span>}</span> <span>from</span> <span>"</span><span>./utils.js</span><span>"</span><span>;</span>

<span>export</span> <span>async</span> <span>function</span> <span>watch</span><span>(</span><span>basePath</span><span>,</span> <span>modulePath</span><span>,</span> <span>onChange</span><span>)</span> <span>{</span>
  <span>const</span> <span>filePath</span> <span>=</span> <span>basePath</span> <span>+</span> <span>modulePath</span><span>;</span>
  <span>const</span> <span>moduleURL</span> <span>=</span> <span>`file:///</span><span>${</span><span>filePath</span><span>}</span><span>`</span><span>;</span>

  <span>// Step 1: don't run file-watching in production. Obviously.</span>
  <span>if</span> <span>(</span><span>process</span><span>.</span><span>env</span><span>.</span><span>NODE_ENV</span> <span>===</span> <span>`production`</span><span>)</span> <span>{</span>
    <span>return</span> <span>import</span><span>(</span><span>moduleURL</span><span>);</span>
  <span>}</span>

  <span>// Next, get the current callstack, so we can report on</span>
  <span>// that when a file change warrants an update.</span>
  <span>const</span> <span>callStack</span> <span>=</span> <span>new</span> <span>Error</span><span>().</span><span>stack</span>
    <span>.</span><span>split</span><span>(</span><span>`\n`</span><span>)</span>
    <span>.</span><span>slice</span><span>(</span><span>2</span><span>)</span>
    <span>.</span><span>map</span><span>((</span><span>v</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>return</span> <span>v</span>
        <span>.</span><span>trim</span><span>()</span>
        <span>.</span><span>replace</span><span>(</span><span>`file:///</span><span>${</span><span>__root</span><span>}</span><span>`</span><span>,</span> <span>`./`</span><span>)</span>
        <span>.</span><span>replace</span><span>(</span><span>/^at /</span><span>,</span> <span>`  in `</span><span>)</span>
        <span>.</span><span>replace</span><span>(</span><span>/new </span><span>(\S</span><span>+</span><span>)</span><span>/</span><span>,</span> <span>`$1.constructor`</span><span>);</span>
    <span>})</span>
    <span>.</span><span>join</span><span>(</span><span>`\n`</span><span>)</span>
    <span>.</span><span>replace</span><span>(</span><span>/</span><span>\.</span><span>constructor </span><span>\(([^</span><span>)</span><span>]</span><span>+</span><span>)\)(</span><span>.|</span><span>[\n\r])</span><span>*/</span><span>,</span> <span>`.constructor ($1)`</span><span>);</span>

  <span>// If we're not running in production, check this file for changes every second:</span>
  <span>watchFile</span><span>(</span><span>filePath</span><span>,</span> <span>{</span> <span>interval</span><span>:</span> <span>1000</span> <span>},</span> <span>async</span> <span>()</span> <span>=&gt;</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`Reloading module </span><span>${</span><span>rootRelative</span><span>(</span><span>filePath</span><span>)}</span><span> at </span><span>${</span><span>Date</span><span>.</span><span>now</span><span>()}</span><span>`</span><span>);</span>

    <span>try</span> <span>{</span>
      <span>// If there was a change, re-import this file as an ES module, with a "cache busting" URL</span>
      <span>// that includes the current time stamp. Modules are cached based on their exact URL,</span>
      <span>// so adding a query argument that we can vary means we can "reimport" the code:</span>
      <span>const</span> <span>module</span> <span>=</span> <span>await</span> <span>import</span><span>(</span><span>`</span><span>${</span><span>moduleURL</span><span>}</span><span>?ts=</span><span>${</span><span>Date</span><span>.</span><span>now</span><span>()}</span><span>`</span><span>);</span>

      <span>// Then we log the stack so we know where this reload was set up in our code:</span>
      <span>console</span><span>.</span><span>log</span><span>(</span><span>callStack</span><span>);</span>

      <span>// To confirm to ourselves that a module was fully loaded as a "new module" we check</span>
      <span>// whether it has a `LOAD_TIME` constant that it set during load, and log what that</span>
      <span>// value is. Because it should be very close to our reload time.</span>
      <span>if</span> <span>(</span><span>module</span><span>.</span><span>LOAD_TIME</span><span>)</span>
        <span>console</span><span>.</span><span>log</span><span>(</span><span>`  Module-indicated load time is </span><span>${</span><span>module</span><span>.</span><span>LOAD_TIME</span><span>}</span><span>`</span><span>);</span>

      <span>// And then we run whatever code needs to run now that the module's been reloaded.</span>
      <span>onChange</span><span>(</span><span>module</span><span>);</span>
    <span>}</span> <span>catch</span> <span>(</span><span>e</span><span>)</span> <span>{</span>
      <span>// Never crash the server just because someone saved a file with a typo.</span>
      <span>console</span><span>.</span><span>error</span><span>(</span><span>`\nWatcher could not load module: </span><span>${</span><span>filePath</span><span>}</span><span>`</span><span>);</span>
      <span>console</span><span>.</span><span>error</span><span>(</span><span>callStack</span><span>);</span>
      <span>console</span><span>.</span><span>error</span><span>(</span><span>e</span><span>);</span>
    <span>}</span>
  <span>});</span>

  <span>// Then, as part of the call, run an immediate load with a timestamp, so we're cache-busting.</span>
  <span>return</span> <span>import</span><span>(</span><span>`</span><span>${</span><span>moduleURL</span><span>}</span><span>?ts=</span><span>${</span><span>Date</span><span>.</span><span>now</span><span>()}</span><span>`</span><span>);</span>
<span>}</span>
</code></pre></div>

<p>With the extra imported bits, from <code>src/utils/constants.js</code>:</p>

<div><pre><code><span>// Get the directory that this file lives in:</span>
<span>import</span> <span>url</span> <span>from</span> <span>"</span><span>node:url</span><span>"</span><span>;</span>
<span>const</span> <span>__dirname</span> <span>=</span> <span>url</span><span>.</span><span>fileURLToPath</span><span>(</span><span>new</span> <span>URL</span><span>(</span><span>"</span><span>.</span><span>"</span><span>,</span> <span>import</span><span>.</span><span>meta</span><span>.</span><span>url</span><span>));</span>

<span>// And then use that to figure out what the project root dir is:</span>
<span>import</span> <span>{</span> <span>join</span><span>,</span> <span>resolve</span><span>,</span> <span>sep</span><span>,</span> <span>win32</span><span>,</span> <span>posix</span> <span>}</span> <span>from</span> <span>"</span><span>node:path</span><span>"</span><span>;</span>
<span>export</span> <span>const</span> <span>__root</span> <span>=</span> <span>(</span><span>resolve</span><span>(</span><span>join</span><span>(</span><span>__dirname</span><span>,</span> <span>`..`</span><span>,</span> <span>`..`</span><span>))</span> <span>+</span> <span>sep</span><span>).</span><span>split</span><span>(</span><span>win32</span><span>.</span><span>sep</span><span>).</span><span>join</span><span>(</span><span>posix</span><span>.</span><span>sep</span><span>);</span>
</code></pre></div>

<p>and <code>src/utils/utils.js</code>:</p>

<div><pre><code><span>import</span> <span>{</span> <span>win32</span><span>,</span> <span>posix</span> <span>}</span> <span>from</span> <span>"</span><span>node:path</span><span>"</span><span>;</span>

<span>// Get a file's path relative to the project root directory</span>
<span>export</span> <span>function</span> <span>rootRelative</span><span>(</span><span>filepath</span><span>)</span> <span>{</span>
  <span>return</span> <span>filepath</span><span>.</span><span>split</span><span>(</span><span>win32</span><span>.</span><span>sep</span><span>).</span><span>join</span><span>(</span><span>posix</span><span>.</span><span>sep</span><span>).</span><span>replace</span><span>(</span><span>__root</span><span>,</span> <span>`./`</span><span>);</span>
<span>}</span>
</code></pre></div>

<p>The thing that makes this work is usually considered a memory leak: modules are cached based on their URL, and URL query arguments count towards URL “uniqueness”, so by loading the module using a URL ending in <code>...?ts=${Date.now()}</code> we effectively load a separate, new module, thus bypassing the module caching mechanism.</p>

<p>That sounds great, but because there is no mechanism for “unloading” modules is modern JS, every save-and-reload will effectively cause a new file to be loaded in, without the old file getting unloaded, so we’re going to slowly fill up our memory… which would be a problem if our files weren’t tiny compared to how much memory modern computers (or even cell phones for that matter), have. So this is going to be a non-issue, but it’s still good to know about, and an <em>excellent</em> idea to make sure it doesn’t kick in for production code.</p>

<p>A more practical problem, though, is that we can no longer “just import something from a module”, because imports are considered constants, with <code>import { x } from Y</code> being equivalent to declarig a <code>const x = ...</code>, so we can’t “reimport” onto the same variable name. That would be a runtime error.</p>

<p>Instead, we need to be a little more clever about how we import code: we can use a top-level <code>await</code> to make the watcher load the module we want, and assign that to a mutable variable:</p>

<div><pre><code><span>// Get the url for "this script", since that's what relative imports will be relative to:</span>
<span>import</span> <span>url</span> <span>from</span> <span>"</span><span>node:url</span><span>"</span><span>;</span>
<span>const</span> <span>__dirname</span> <span>=</span> <span>url</span><span>.</span><span>fileURLToPath</span><span>(</span><span>new</span> <span>URL</span><span>(</span><span>"</span><span>.</span><span>"</span><span>,</span> <span>import</span><span>.</span><span>meta</span><span>.</span><span>url</span><span>));</span>

<span>// Then import our watcher:</span>
<span>import</span> <span>{</span> <span>watch</span> <span>}</span> <span>from</span> <span>"</span><span>./reload-watcher.js</span><span>"</span><span>;</span>

<span>// Then, as mentioned above, we load our import as a mutable variable instead of "as an import":</span>
<span>let</span> <span>{</span> <span>Something</span> <span>}</span> <span>=</span> <span>await</span> <span>watch</span><span>(</span><span>__dirname</span><span>,</span> <span>`some-module.js`</span><span>,</span> <span>(</span><span>lib</span><span>)</span> <span>=&gt;</span> <span>{</span>
  <span>Something</span> <span>=</span> <span>lib</span><span>.</span><span>Something</span><span>;</span>
<span>});</span>
</code></pre></div>

<p>And while that’s a bit more code, and requires an <code>await</code> (which is easy to forget!) now every time we edit <code>some-module.js</code> and save it, the watcher will reload that code for us and our <code>Something</code> variable will get updated. So that solved half of the reloading problem. The other half is making sure that if our module exports a class, that <em>instances</em> of that class get updated, too, by taking advantage of how prototype inheritance works in JS.</p>

<p>Since objects don’t have their type “baked in”, but simply follow a chain of prototype objects, we can change one of those prototype objects and basically change the identity of the object itself. Normally, this would be a bad idea(tm) but in this specific case, it’s exactly what we need to make sure that instances of any hot-reloadable classes we use get updated as part of the reload process:</p>

<div><pre><code><span>// We can set up our reload watcher to update not just the</span>
<span>// variable for our class, but also instances of that class:</span>
<span>let</span> <span>{</span> <span>Something</span> <span>}</span> <span>=</span> <span>await</span> <span>watch</span><span>(</span><span>__dirname</span><span>,</span> <span>`some-module.js`</span><span>,</span> <span>(</span><span>lib</span><span>)</span> <span>=&gt;</span> <span>{</span>
  <span>// Update our class binding:</span>
  <span>Something</span> <span>=</span> <span>lib</span><span>.</span><span>Something</span><span>;</span>

  <span>// And then update our class instance's prototype. This only works because</span>
  <span>// by the time this code runs, the "instance" variable will exist.</span>
  <span>if</span> <span>(</span><span>instance</span><span>)</span> <span>{</span>
    <span>Object</span><span>.</span><span>setPrototypeOf</span><span>(</span><span>instance</span><span>,</span> <span>Something</span><span>.</span><span>prototype</span><span>);</span>
    <span>// This swaps the old prototype for the new code, while leaving any</span>
    <span>// of the instance's own properties unaffected. Something that will be</span>
    <span>// particularly useful for changing autopilot code *while* we're flying!</span>
  <span>}</span>
<span>});</span>

<span>let</span> <span>instance</span> <span>=</span> <span>new</span> <span>Something</span><span>();</span>
</code></pre></div>

<h2 id="part-2-visualizing-flights">Part 2: visualizing flights</h2>

<p>Before we try to automate flight by writing an autopilot, it helps if we can know what “a flight” is. I mean, you and I know what a flight is, but computers not so much, especially when they can’t even see your game, so let’s figure out what information we need our code to know about before we can ask it to do the things we might want it to do.</p>

<h2 id="checking-the-game-data-what-do-we-want-to-know">Checking the game data: what do we want to know?</h2>

<p>There are two kinds of information that we’ll want our code to know about: “static” information like the name of the plane we’re flying, whether it has a tail wheel, how much it weighs, etc. and “dynamic information” like what lat/long the plane is current at, how fast it’s going, what its current pitch angle is, etc.</p>

<p>We can compile a list of properties that we’re likely going to need in order to write our autopilot, and then request all those values from MSFS at a regular interval using SimConnect, so that we can then forward that information to our autopilot code, as well as all clients, and consequently, any connected browser.</p>

<h3 id="getting-game-state-data">Getting game state data</h3>

<p>So let’s write some code that lets us relatively easily work with flight models and flight data. We’ll create a <code>src/utils/flight-values.js</code> file, and then start with the list flight model values we’ll want:</p>

<div><pre><code><span>export</span> <span>const</span> <span>FLIGHT_MODEL</span> <span>=</span> <span>[</span>
  <span>`CATEGORY`</span><span>,</span>
  <span>`DESIGN_CRUISE_ALT`</span><span>,</span>
  <span>`DESIGN_SPEED_CLIMB`</span><span>,</span>
  <span>`DESIGN_SPEED_MIN_ROTATION`</span><span>,</span>
  <span>`DESIGN_SPEED_VC`</span><span>,</span>
  <span>`DESIGN_SPEED_VS0`</span><span>,</span>
  <span>`DESIGN_SPEED_VS1`</span><span>,</span>
  <span>`DESIGN_TAKEOFF_SPEED`</span><span>,</span>
  <span>`ELEVATOR_TRIM_DOWN_LIMIT`</span><span>,</span>
  <span>`ELEVATOR_TRIM_UP_LIMIT`</span><span>,</span>
  <span>`ENGINE_TYPE`</span><span>,</span>
  <span>`INCIDENCE_ALPHA`</span><span>,</span>
  <span>`IS_GEAR_FLOATS`</span><span>,</span>
  <span>`IS_GEAR_RETRACTABLE`</span><span>,</span>
  <span>`IS_TAIL_DRAGGER`</span><span>,</span>
  <span>`NUMBER_OF_ENGINES`</span><span>,</span>
  <span>`PLANE_LATITUDE`</span><span>,</span>
  <span>`PLANE_LONGITUDE`</span><span>,</span>
  <span>`STALL_ALPHA`</span><span>,</span>
  <span>`STATIC_CG_TO_GROUND`</span><span>,</span>
  <span>`TITLE`</span><span>,</span>
  <span>`TOTAL_WEIGHT`</span><span>,</span>
  <span>`TYPICAL_DESCENT_RATE`</span><span>,</span>
  <span>`WING_AREA`</span><span>,</span>
  <span>`WING_SPAN`</span><span>,</span>
<span>];</span>

<span>export</span> <span>const</span> <span>ENGINE_TYPES</span> <span>=</span> <span>[</span>
  <span>`piston`</span><span>,</span>
  <span>`jet`</span><span>,</span>
  <span>`none`</span><span>,</span>
  <span>`helo(Bell) turbine`</span><span>,</span>
  <span>`unsupported`</span><span>,</span>
  <span>`turboprop`</span><span>,</span>
<span>];</span>
</code></pre></div>

<p>Do we need all that data? Surprisingly: yes! Almost all of these will let us either bootstrap our autopilot parameters, or will let us show things we’re interested in on our web page.</p>

<p>Next up, our “things we want to know while we’re actually flying” data:</p>

<div><pre><code><span>export</span> <span>const</span> <span>FLIGHT_DATA</span> <span>=</span> <span>[</span>
  <span>`AILERON_POSITION`</span><span>,</span>
  <span>`AILERON_TRIM_PCT`</span><span>,</span>
  <span>`AIRSPEED_INDICATED`</span><span>,</span>
  <span>`AIRSPEED_TRUE`</span><span>,</span>
  <span>`AUTOPILOT_HEADING_LOCK_DIR`</span><span>,</span>
  <span>`AUTOPILOT_MASTER`</span><span>,</span>
  <span>`CAMERA_STATE`</span><span>,</span>
  <span>`CAMERA_SUBSTATE`</span><span>,</span>
  <span>`CRASH_FLAG`</span><span>,</span>
  <span>`CRASH_SEQUENCE`</span><span>,</span>
  <span>`ELECTRICAL_AVIONICS_BUS_VOLTAGE`</span><span>,</span>
  <span>`ELECTRICAL_TOTAL_LOAD_AMPS`</span><span>,</span>
  <span>`ELEVATOR_POSITION`</span><span>,</span>
  <span>`ELEVATOR_TRIM_PCT`</span><span>,</span>
  <span>`ELEVATOR_TRIM_POSITION`</span><span>,</span>
  <span>`ENG_COMBUSTION:1`</span><span>,</span>
  <span>`ENG_COMBUSTION:2`</span><span>,</span>
  <span>`ENG_COMBUSTION:3`</span><span>,</span>
  <span>`ENG_COMBUSTION:4`</span><span>,</span>
  <span>`GEAR_POSITION:1`</span><span>,</span>
  <span>`GEAR_SPEED_EXCEEDED`</span><span>,</span>
  <span>`GROUND_ALTITUDE`</span><span>,</span>
  <span>`INDICATED_ALTITUDE`</span><span>,</span>
  <span>`OVERSPEED_WARNING`</span><span>,</span>
  <span>`PLANE_ALT_ABOVE_GROUND_MINUS_CG`</span><span>,</span>
  <span>`PLANE_ALT_ABOVE_GROUND`</span><span>,</span>
  <span>`PLANE_BANK_DEGREES`</span><span>,</span>
  <span>`PLANE_HEADING_DEGREES_MAGNETIC`</span><span>,</span>
  <span>`PLANE_HEADING_DEGREES_TRUE`</span><span>,</span>
  <span>`PLANE_LATITUDE`</span><span>,</span>
  <span>`PLANE_LONGITUDE`</span><span>,</span>
  <span>`PLANE_PITCH_DEGREES`</span><span>,</span>
  <span>`RUDDER_POSITION`</span><span>,</span>
  <span>`RUDDER_TRIM_PCT`</span><span>,</span>
  <span>`SIM_ON_GROUND`</span><span>,</span>
  <span>`TURN_INDICATOR_RATE`</span><span>,</span>
  <span>`VERTICAL_SPEED`</span><span>,</span>
<span>];</span>
</code></pre></div>

<p>This also looks like a lot of data, but we really do need every single one of these values if we’re going to implement an autopilot.</p>

<h3 id="converting-simconnect-values">Converting SimConnect values</h3>

<p>But: this does leave us with a problem: SimConnect isn’t really all that fussy about making sure every single value uses a unit that makes sense, or that collections of variables all use the same unit, so we’re in a situation where something like <code>PLANE_BANK_DEGREES</code>, which you would expect to be a number in degrees, is actually a number in radians. And <code>AIRSPEED_TRUE</code> is in knots, so surely <code>DESIGN_SPEED_CLIMB</code> is in knots, too, right? Nope, that’s in feet per second. Which means <code>DESIGN_SPEED_VS1</code> is in feet per second, too? Haha, no, that one <em>is</em> in knots, but “knots indicated”, so not a real speed, but what the dial in the cockpit shows on the speed gauge. Oh, and: boolean values aren’t true or false, they’re 1 or 0.</p>

<p>It’s all a bit of a mess, so let’s write some code to take of all this nonsense and make sure values are in units we can rely on, because if we don’t it’s just going to be a huge headache:</p>

<div><pre><code><span>// These are all degree values that are actually stored as radians.</span>
<span>export</span> <span>const</span> <span>DEGREE_VALUES</span> <span>=</span> <span>[</span>
  <span>`PLANE_LATITUDE`</span><span>,</span>
  <span>`PLANE_LONGITUDE`</span><span>,</span>
  <span>`PLANE_BANK_DEGREES`</span><span>,</span>
  <span>`PLANE_HEADING_DEGREES_MAGNETIC`</span><span>,</span>
  <span>`PLANE_HEADING_DEGREES_TRUE`</span><span>,</span>
  <span>`PLANE_PITCH_DEGREES`</span><span>,</span>
  <span>`STALL_ALPHA`</span><span>,</span>
  <span>`TURN_INDICATOR_RATE`</span><span>,</span>
<span>];</span>

<span>// These are all boolean values that are stored as a number.</span>
<span>export</span> <span>const</span> <span>BOOLEAN_VALUES</span> <span>=</span> <span>[</span>
  <span>`AUTOPILOT_MASTER`</span><span>,</span>
  <span>`ENG_COMBUSTION:1`</span><span>,</span>
  <span>`ENG_COMBUSTION:2`</span><span>,</span>
  <span>`ENG_COMBUSTION:3`</span><span>,</span>
  <span>`ENG_COMBUSTION:4`</span><span>,</span>
  <span>`IS_GEAR_FLOATS`</span><span>,</span>
  <span>`IS_GEAR_RETRACTABLE`</span><span>,</span>
  <span>`IS_TAIL_DRAGGER`</span><span>,</span>
  <span>`GEAR_POSITION:1`</span><span>,</span>
  <span>`GEAR_SPEED_EXCEEDED`</span><span>,</span>
  <span>`OVERSPEED_WARNING`</span><span>,</span>
  <span>`SIM_ON_GROUND`</span><span>,</span>
<span>];</span>

<span>// These are percentages, but stored as "percent divided by 100"</span>
<span>export</span> <span>const</span> <span>PERCENT_VALUES</span> <span>=</span> <span>[</span>
  <span>`AILERON_POSITION`</span><span>,</span>
  <span>`AILERON_TRIM_PCT`</span><span>,</span>
  <span>`ELEVATOR_POSITION`</span><span>,</span>
  <span>`ELEVATOR_TRIM_PCT`</span><span>,</span>
  <span>`RUDDER_POSITION`</span><span>,</span>
  <span>`RUDDER_TRIM_PCT`</span><span>,</span>
<span>];</span>

<span>// In game, vertical speed is shown feet per minute,</span>
<span>// but SimConnect reports it as feet per second...</span>
<span>export</span> <span>const</span> <span>FPM_VALUES</span> <span>=</span> <span>[</span><span>`VERTICAL_SPEED`</span><span>];</span>

<span>// Plane altitude is in feet, so why is ground altitude in meters?</span>
<span>export</span> <span>const</span> <span>MTF_VALUES</span> <span>=</span> <span>[</span><span>`GROUND_ALTITUDE`</span><span>];</span>

<span>// And finally, please just turn all of these into</span>
<span>// values in knots instead of feet per second...</span>
<span>export</span> <span>const</span> <span>KNOT_VALUES</span> <span>=</span> <span>[</span>
  <span>`DESIGN_SPEED_MIN_ROTATION`</span><span>,</span>
  <span>`DESIGN_SPEED_CLIMB`</span><span>,</span>
  <span>`DESIGN_SPEED_VC`</span><span>,</span>
<span>];</span>
</code></pre></div>

<p>We can pair this with a function that runs through a bunch of rewrites for each of the categories, to give us values to work with that actually make sense:</p>

<div><pre><code><span>import</span> <span>{</span> <span>FEET_PER_METER</span><span>,</span> <span>FPS_IN_KNOTS</span> <span>}</span> <span>from</span> <span>"</span><span>./constants.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>exists</span> <span>}</span> <span>from</span> <span>"</span><span>./utils.js</span><span>"</span><span>;</span>

<span>const</span> <span>noop</span> <span>=</span> <span>()</span> <span>=&gt;</span> <span>{};</span>

<span>export</span> <span>function</span> <span>convertValues</span><span>(</span><span>data</span><span>)</span> <span>{</span>
  <span>// Convert values to the units they're supposed to be:</span>
  <span>BOOLEAN_VALUES</span><span>.</span><span>forEach</span><span>((</span><span>p</span><span>)</span> <span>=&gt;</span> <span>exists</span><span>(</span><span>data</span><span>[</span><span>p</span><span>])</span> <span>?</span> <span>(</span><span>data</span><span>[</span><span>p</span><span>]</span> <span>=</span> <span>!!</span><span>data</span><span>[</span><span>p</span><span>])</span> <span>:</span> <span>noop</span><span>);</span>
  <span>DEGREE_VALUES</span><span>.</span><span>forEach</span><span>((</span><span>p</span><span>)</span> <span>=&gt;</span> <span>exists</span><span>(</span><span>data</span><span>[</span><span>p</span><span>])</span> <span>?</span> <span>(</span><span>data</span><span>[</span><span>p</span><span>]</span> <span>*=</span> <span>180</span> <span>/</span> <span>Math</span><span>.</span><span>PI</span><span>)</span> <span>:</span> <span>noop</span><span>);</span>
  <span>PERCENT_VALUES</span><span>.</span><span>forEach</span><span>((</span><span>p</span><span>)</span> <span>=&gt;</span> <span>(</span><span>exists</span><span>(</span><span>data</span><span>[</span><span>p</span><span>])</span> <span>?</span> <span>(</span><span>data</span><span>[</span><span>p</span><span>]</span> <span>*=</span> <span>100</span><span>)</span> <span>:</span> <span>noop</span><span>));</span>
  <span>FPM_VALUES</span><span>.</span><span>forEach</span><span>((</span><span>p</span><span>)</span> <span>=&gt;</span> <span>exists</span><span>(</span><span>data</span><span>[</span><span>p</span><span>])</span> <span>?</span> <span>(</span><span>data</span><span>[</span><span>p</span><span>]</span> <span>*=</span> <span>60</span><span>)</span> <span>:</span> <span>noop</span><span>);</span>
  <span>KNOT_VALUES</span><span>.</span><span>forEach</span><span>((</span><span>p</span><span>)</span> <span>=&gt;</span> <span>exists</span><span>(</span><span>data</span><span>[</span><span>p</span><span>])</span> <span>?</span> <span>(</span><span>data</span><span>[</span><span>p</span><span>]</span> <span>*=</span> <span>FPS_IN_KNOTS</span><span>)</span> <span>:</span> <span>noop</span><span>);</span>
  <span>MTF_VALUES</span><span>.</span><span>forEach</span><span>((</span><span>p</span><span>)</span> <span>=&gt;</span> <span>exists</span><span>(</span><span>data</span><span>[</span><span>p</span><span>])</span> <span>?</span> <span>(</span><span>data</span><span>[</span><span>p</span><span>]</span> <span>*=</span> <span>FEET_PER_METER</span><span>)</span> <span>:</span> <span>noop</span><span>);</span>
  <span>if</span> <span>(</span><span>exists</span><span>(</span><span>data</span><span>.</span><span>ENGINE_TYPE</span><span>))</span> <span>data</span><span>.</span><span>ENGINE_TYPE</span> <span>=</span> <span>ENGINE_TYPES</span><span>[</span><span>data</span><span>.</span><span>ENGINE_TYPE</span><span>];</span>
<span>}</span>
</code></pre></div>

<p>In this code, the contants that we import have the values 364000, 3.28084, and 1/1.68781, respectively, and the <code>exists</code> function is just a tiny function that checks whether a value is either <code>undefined</code> or <code>null</code>, because we want to overwrite a value if it exist, rather than if it doesn’t exist, and there is no opposite of the <code>??=</code> operator.</p>

<p>Which leaves one more thing: calming all those words down a little, because working with <code>PLANE_ALT_ABOVE_GROUND_MINUS_CG</code> or <code>AUTOPILOT_HEADING_LOCK_DIR</code> is something we <em>could</em> do, but it would be a heck of a lot nicer if those things had normal names that followed standard JS naming conventions.</p>

<p>So let’s write <em>even more utility code</em> to take care of that for us:</p>

<div><pre><code><span>export</span> <span>const</span> <span>NAME_MAPPING</span> <span>=</span> <span>{</span>
  <span>AILERON_POSITION</span><span>:</span> <span>`aileron`</span><span>,</span>
  <span>AILERON_TRIM_PCT</span><span>:</span> <span>`aileronTrim`</span><span>,</span>
  <span>AIRSPEED_INDICATED</span><span>:</span> <span>`speed`</span><span>,</span>
  <span>AIRSPEED_TRUE</span><span>:</span> <span>`trueSpeed`</span><span>,</span>
  <span>AUTOPILOT_HEADING_LOCK_DIR</span><span>:</span> <span>`headingBug`</span><span>,</span>
  <span>AUTOPILOT_MASTER</span><span>:</span> <span>`MASTER`</span><span>,</span>
  <span>CAMERA_STATE</span><span>:</span> <span>`camera`</span><span>,</span>
  <span>CAMERA_SUBSTATE</span><span>:</span> <span>`cameraSub`</span><span>,</span>
  <span>CATEGORY</span><span>:</span> <span>`category`</span><span>,</span>
  <span>CRASH_FLAG</span><span>:</span> <span>`crashed`</span><span>,</span>
  <span>CRASH_SEQUENCE</span><span>:</span> <span>`crashSequence`</span><span>,</span>
  <span>DESIGN_CRUISE_ALT</span><span>:</span> <span>`cruiseAlt`</span><span>,</span>
  <span>DESIGN_SPEED_CLIMB</span><span>:</span> <span>`climbSpeed`</span><span>,</span>
  <span>DESIGN_SPEED_MIN_ROTATION</span><span>:</span> <span>`minRotation`</span><span>,</span>
  <span>DESIGN_SPEED_VC</span><span>:</span> <span>`cruiseSpeed`</span><span>,</span>
  <span>DESIGN_SPEED_VS0</span><span>:</span> <span>`vs0`</span><span>,</span>
  <span>DESIGN_SPEED_VS1</span><span>:</span> <span>`vs1`</span><span>,</span>
  <span>DESIGN_TAKEOFF_SPEED</span><span>:</span> <span>`takeoffSpeed`</span><span>,</span>
  <span>ELECTRICAL_AVIONICS_BUS_VOLTAGE</span><span>:</span> <span>`busVoltage`</span><span>,</span>
  <span>ELECTRICAL_TOTAL_LOAD_AMPS</span><span>:</span> <span>`ampLoad`</span><span>,</span>
  <span>ELEVATOR_POSITION</span><span>:</span> <span>`elevator`</span><span>,</span>
  <span>ELEVATOR_TRIM_DOWN_LIMIT</span><span>:</span> <span>`trimDownLimit`</span><span>,</span>
  <span>ELEVATOR_TRIM_PCT</span><span>:</span> <span>`pitchTrim`</span><span>,</span>
  <span>ELEVATOR_TRIM_POSITION</span><span>:</span> <span>`trimPosition`</span><span>,</span>
  <span>ELEVATOR_TRIM_UP_LIMIT</span><span>:</span> <span>`trimUpLimit`</span><span>,</span>
  <span>ENGINE_TYPE</span><span>:</span> <span>`engineType`</span><span>,</span>
  <span>"</span><span>GEAR_POSITION:1</span><span>"</span><span>:</span> <span>`isGearDown`</span><span>,</span>
  <span>GEAR_SPEED_EXCEEDED</span><span>:</span> <span>`gearSpeedExceeded`</span><span>,</span>
  <span>GROUND_ALTITUDE</span><span>:</span> <span>`groundAlt`</span><span>,</span>
  <span>INDICATED_ALTITUDE</span><span>:</span> <span>`alt`</span><span>,</span>
  <span>IS_GEAR_FLOATS</span><span>:</span> <span>`isFloatPlane`</span><span>,</span>
  <span>IS_GEAR_RETRACTABLE</span><span>:</span> <span>`hasRetractibleGear`</span><span>,</span>
  <span>IS_TAIL_DRAGGER</span><span>:</span> <span>`isTailDragger`</span><span>,</span>
  <span>NUMBER_OF_ENGINES</span><span>:</span> <span>`engineCount`</span><span>,</span>
  <span>OVERSPEED_WARNING</span><span>:</span> <span>`overSpeed`</span><span>,</span>
  <span>PLANE_ALT_ABOVE_GROUND_MINUS_CG</span><span>:</span> <span>`lift`</span><span>,</span>
  <span>PLANE_ALT_ABOVE_GROUND</span><span>:</span> <span>`altAboveGround`</span><span>,</span>
  <span>PLANE_BANK_DEGREES</span><span>:</span> <span>`bank`</span><span>,</span>
  <span>PLANE_HEADING_DEGREES_MAGNETIC</span><span>:</span> <span>`heading`</span><span>,</span>
  <span>PLANE_HEADING_DEGREES_TRUE</span><span>:</span> <span>`trueHeading`</span><span>,</span>
  <span>PLANE_LATITUDE</span><span>:</span> <span>`lat`</span><span>,</span>
  <span>PLANE_LONGITUDE</span><span>:</span> <span>`long`</span><span>,</span>
  <span>PLANE_PITCH_DEGREES</span><span>:</span> <span>`pitch`</span><span>,</span>
  <span>RUDDER_POSITION</span><span>:</span> <span>`rudder`</span><span>,</span>
  <span>RUDDER_TRIM_PCT</span><span>:</span> <span>`rudderTrim`</span><span>,</span>
  <span>SIM_ON_GROUND</span><span>:</span> <span>`onGround`</span><span>,</span>
  <span>STATIC_CG_TO_GROUND</span><span>:</span> <span>`cg`</span><span>,</span>
  <span>STALL_ALPHA</span><span>:</span> <span>`stallAlpha`</span><span>,</span>
  <span>TITLE</span><span>:</span> <span>`title`</span><span>,</span>
  <span>TOTAL_WEIGHT</span><span>:</span> <span>`weight`</span><span>,</span>
  <span>TURN_INDICATOR_RATE</span><span>:</span> <span>`turnRate`</span><span>,</span>
  <span>TYPICAL_DESCENT_RATE</span><span>:</span> <span>`descentRate`</span><span>,</span>
  <span>VERTICAL_SPEED</span><span>:</span> <span>`VS`</span><span>,</span>
  <span>WING_AREA</span><span>:</span> <span>`wingArea`</span><span>,</span>
  <span>WING_SPAN</span><span>:</span> <span>`wingSpan`</span><span>,</span>
<span>};</span>

<span>export</span> <span>function</span> <span>renameData</span><span>(</span><span>data</span><span>)</span> <span>{</span>
  <span>Object</span><span>.</span><span>entries</span><span>(</span><span>data</span><span>).</span><span>forEach</span><span>(([</span><span>simName</span><span>,</span> <span>value</span><span>])</span> <span>=&gt;</span> <span>{</span>
    <span>const</span> <span>jsName</span> <span>=</span> <span>NAME_MAPPING</span><span>[</span><span>simName</span><span>];</span>

    <span>if</span> <span>(</span><span>jsName</span> <span>===</span> <span>undefined</span><span>)</span> <span>return</span><span>;</span>
    <span>if</span> <span>(</span><span>!</span><span>exists</span><span>(</span><span>data</span><span>[</span><span>simName</span><span>]))</span> <span>return</span><span>;</span>

    <span>data</span><span>[</span><span>jsName</span><span>]</span> <span>=</span> <span>value</span><span>;</span>
    <span>delete</span> <span>data</span><span>[</span><span>simName</span><span>];</span>
  <span>});</span>
<span>}</span>
</code></pre></div>

<p>And that’s us nearly here. However, SimConnect typically only serves up “values” and if we’re going to write an autopilot, we generally also care the <em>change</em> in certain values over time. For instance, just knowing our current vertical speed doesn’t tell us whether we’re ascending or descending, and just knowing that we’re turning at 3 degrees per second  <em>right now</em> doesn’t tell us anything about whether we’re about to spiral out of control or whether we’re about to stop turning entirely.</p>

<p>So we need a little bit of extra code to track the “delta” values for some of the flight properties we listed earlier:</p>

<div><pre><code><span>// Our list of "first derivatives", i.e. our deltas</span>
<span>export</span> <span>const</span> <span>DERIVATIVES</span> <span>=</span> <span>[</span>
  <span>`bank`</span><span>,</span>
  <span>`heading`</span><span>,</span>
  <span>`lift`</span><span>,</span>
  <span>`pitch`</span><span>,</span>
  <span>`speed`</span><span>,</span>
  <span>`trueHeading`</span><span>,</span>
  <span>`trueSpeed`</span><span>,</span>
  <span>`turnRate`</span><span>,</span>
  <span>`VS`</span><span>,</span>
<span>];</span>

<span>// And our single "second derivative":</span>
<span>export</span> <span>const</span> <span>SECOND_DERIVATIVES</span> <span>=</span> <span>[</span><span>`VS`</span><span>];</span>

<span>// And then an update to the `rebind` function:</span>
<span>export</span> <span>function</span> <span>renameData</span><span>(</span><span>data</span><span>,</span> <span>previousValues</span><span>)</span> <span>{</span>
  <span>// Whether or not we have previous values for delta computation,</span>
  <span>// just preallocate the values we _might_ need for that.</span>
  <span>const</span> <span>d</span> <span>=</span> <span>{};</span>
  <span>const</span> <span>now</span> <span>=</span> <span>Date</span><span>.</span><span>now</span><span>();</span>
  <span>const</span> <span>before</span> <span>=</span> <span>previousValues</span><span>?.</span><span>__date_time</span> <span>??</span> <span>now</span><span>;</span>
  <span>const</span> <span>dt</span> <span>=</span> <span>(</span><span>now</span> <span>-</span> <span>before</span><span>)</span> <span>/</span> <span>1000</span><span>;</span> <span>// delta per second seconds</span>

  <span>// Then perform the name mapping, but with extra code for getting</span>
  <span>// our "delta" values, which we'll add into a `.d` property.</span>
  <span>Object</span><span>.</span><span>entries</span><span>(</span><span>data</span><span>).</span><span>forEach</span><span>(([</span><span>simName</span><span>,</span> <span>value</span><span>])</span> <span>=&gt;</span> <span>{</span>
    <span>const</span> <span>jsName</span> <span>=</span> <span>NAME_MAPPING</span><span>[</span><span>simName</span><span>];</span>

    <span>if</span> <span>(</span><span>jsName</span> <span>===</span> <span>undefined</span><span>)</span> <span>return</span><span>;</span>
    <span>if</span> <span>(</span><span>!</span><span>exists</span><span>(</span><span>data</span><span>[</span><span>simName</span><span>]))</span> <span>return</span><span>;</span>

    <span>data</span><span>[</span><span>jsName</span><span>]</span> <span>=</span> <span>value</span><span>;</span>
    <span>delete</span> <span>data</span><span>[</span><span>simName</span><span>];</span>

    <span>// Do we need to compute derivatives?</span>
    <span>if</span> <span>(</span><span>previousValues</span> <span>&amp;&amp;</span> <span>DERIVATIVES</span><span>.</span><span>includes</span><span>(</span><span>jsName</span><span>))</span> <span>{</span>
      <span>const</span> <span>previous</span> <span>=</span> <span>previousValues</span><span>[</span><span>jsName</span><span>];</span>
      <span>if</span> <span>(</span><span>typeof</span> <span>previous</span> <span>!==</span> <span>`number`</span><span>)</span> <span>return</span><span>;</span>
      <span>const</span> <span>current</span> <span>=</span> <span>data</span><span>[</span><span>jsName</span><span>];</span>
      <span>d</span><span>[</span><span>jsName</span><span>]</span> <span>=</span> <span>(</span><span>current</span> <span>-</span> <span>previous</span><span>)</span> <span>/</span> <span>dt</span><span>;</span>

      <span>// ...do we need to compute *second* derivatives?</span>
      <span>if</span> <span>(</span><span>SECOND_DERIVATIVES</span><span>.</span><span>includes</span><span>(</span><span>jsName</span><span>))</span> <span>{</span>
        <span>d</span><span>.</span><span>d</span> <span>??=</span> <span>{};</span>
        <span>const</span> <span>previousDelta</span> <span>=</span> <span>previousValues</span><span>.</span><span>d</span><span>?.[</span><span>jsName</span><span>]</span> <span>??</span> <span>0</span><span>;</span>
        <span>d</span><span>.</span><span>d</span><span>[</span><span>jsName</span><span>]</span> <span>=</span> <span>d</span><span>[</span><span>jsName</span><span>]</span> <span>-</span> <span>previousDelta</span><span>;</span>
      <span>}</span>
    <span>}</span>
  <span>});</span>

  <span>// If we did delta computation work, save the result:</span>
  <span>if</span> <span>(</span><span>previousValues</span><span>)</span> <span>{</span>
    <span>data</span><span>.</span><span>__date_time</span> <span>=</span> <span>now</span><span>;</span>
    <span>data</span><span>.</span><span>d</span> <span>=</span> <span>d</span><span>;</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>Well that only took forever…</p>

<h3 id="our-flightinformation-object">Our <code>FlightInformation</code> object</h3>

<p>And we still need to write the actual code that actually pulls this data from SimConnect to keep us up to date. Thankfully, with all the above work completed, that part is nowhere near as much work. First, we write a <code>FlightInformation</code> object to wrap all those values and functions:</p>

<div><pre><code><span>import</span> <span>{</span>
  <span>FLIGHT_MODEL</span><span>,</span>
  <span>FLIGHT_DATA</span><span>,</span>
  <span>convertValues</span><span>,</span>
  <span>renameData</span><span>,</span>
<span>}</span> <span>from</span> <span>"</span><span>./flight-values.js</span><span>"</span><span>;</span>

<span>let</span> <span>api</span><span>;</span>

<span>export</span> <span>class</span> <span>FlightInformation</span> <span>{</span>
  <span>constructor</span><span>(</span><span>_api</span><span>)</span> <span>{</span>
    <span>api</span> <span>=</span> <span>_api</span><span>;</span>
    <span>this</span><span>.</span><span>reset</span><span>();</span>
  <span>}</span>

  <span>reset</span><span>()</span> <span>{</span>
    <span>this</span><span>.</span><span>model</span> <span>=</span> <span>false</span><span>;</span>
    <span>this</span><span>.</span><span>data</span> <span>=</span> <span>false</span><span>;</span>
    <span>this</span><span>.</span><span>general</span> <span>=</span> <span>{</span>
      <span>flying</span><span>:</span> <span>false</span><span>,</span>
      <span>inGame</span><span>:</span> <span>false</span><span>,</span>
      <span>moving</span><span>:</span> <span>false</span><span>,</span>
      <span>planeActive</span><span>:</span> <span>false</span><span>,</span>
    <span>};</span>
  <span>}</span>

  <span>// We'll have three update functions. Two for the two types</span>
  <span>// of data, and then this one, which is a unified "call both":</span>
  <span>async</span> <span>update</span><span>()</span> <span>{</span>
    <span>try</span> <span>{</span>
      <span>if</span> <span>(</span><span>!</span><span>api</span><span>.</span><span>connected</span><span>)</span> <span>throw</span> <span>new</span> <span>Error</span><span>(</span><span>`API not connected`</span><span>);</span>
      <span>await</span> <span>Promise</span><span>.</span><span>all</span><span>([</span><span>this</span><span>.</span><span>updateModel</span><span>(),</span> <span>this</span><span>.</span><span>updateFlight</span><span>()]);</span>
    <span>}</span> <span>catch</span> <span>(</span><span>e</span><span>)</span> <span>{</span>
      <span>console</span><span>.</span><span>warn</span><span>(</span><span>e</span><span>);</span>
    <span>}</span>
    <span>return</span> <span>this</span><span>;</span>
  <span>}</span>

  <span>// Then our "update the model" code:</span>
  <span>async</span> <span>updateModel</span><span>()</span> <span>{</span>
    <span>const</span> <span>data</span> <span>=</span> <span>await</span> <span>api</span><span>.</span><span>get</span><span>(...</span><span>FLIGHT_MODEL</span><span>);</span>
    <span>if</span> <span>(</span><span>!</span><span>data</span><span>)</span> <span>return</span> <span>(</span><span>this</span><span>.</span><span>flightModel</span> <span>=</span> <span>false</span><span>);</span>

    <span>// Make sure to run our quality-of-life functions:</span>
    <span>convertValues</span><span>(</span><span>data</span><span>);</span>
    <span>renameData</span><span>(</span><span>data</span><span>);</span>

    <span>// Create a convenience value for trimming</span>
    <span>data</span><span>.</span><span>pitchTrimLimit</span> <span>=</span> <span>[</span><span>data</span><span>.</span><span>trimUpLimit</span> <span>??</span> <span>10</span><span>,</span> <span>data</span><span>.</span><span>trimDownLimit</span> <span>??</span> <span>-</span><span>10</span><span>];</span>
    <span>return</span> <span>(</span><span>this</span><span>.</span><span>model</span> <span>=</span> <span>data</span><span>);</span>
  <span>}</span>

  <span>// And our "update the current flight information" code:</span>
  <span>async</span> <span>updateFlight</span><span>()</span> <span>{</span>
    <span>const</span> <span>data</span> <span>=</span> <span>await</span> <span>api</span><span>.</span><span>get</span><span>(...</span><span>FLIGHT_DATA</span><span>);</span>
    <span>if</span> <span>(</span><span>!</span><span>data</span><span>)</span> <span>return</span> <span>(</span><span>this</span><span>.</span><span>data</span> <span>=</span> <span>false</span><span>);</span>
    <span>// Make sure to run our quality-of-life functions here, too:</span>
    <span>convertValues</span><span>(</span><span>data</span><span>);</span>
    <span>renameData</span><span>(</span><span>data</span><span>,</span> <span>this</span><span>.</span><span>data</span><span>);</span>

    <span>// Create a convenience value for "are any engines running?",</span>
    <span>// which would otherwise require checking four separate variables:</span>
    <span>data</span><span>.</span><span>enginesRunning</span> <span>=</span> <span>[</span><span>1</span><span>,</span> <span>2</span><span>,</span> <span>3</span><span>,</span> <span>4</span><span>].</span><span>reduce</span><span>(</span>
      <span>(</span><span>t</span><span>,</span> <span>num</span><span>)</span> <span>=&gt;</span> <span>t</span> <span>||</span> <span>data</span><span>[</span><span>`ENG_COMBUSTION:</span><span>${</span><span>num</span><span>}</span><span>`</span><span>],</span>
      <span>false</span>
    <span>);</span>

    <span>// Create a convenience value for "is the plane powered on?",</span>
    <span>// which would otherwise require checking two variables:</span>
    <span>data</span><span>.</span><span>hasPower</span> <span>=</span> <span>data</span><span>.</span><span>ampLoad</span> <span>!==</span> <span>0</span> <span>||</span> <span>data</span><span>.</span><span>busVoltage</span> <span>!==</span> <span>0</span><span>;</span>

    <span>// And create a convenience value for compass correction:</span>
    <span>data</span><span>.</span><span>declination</span> <span>=</span> <span>data</span><span>.</span><span>trueHeading</span> <span>-</span> <span>data</span><span>.</span><span>heading</span><span>;</span>

    <span>// Then update our general flight values and return;</span>
    <span>this</span><span>.</span><span>setGeneralProperties</span><span>(</span><span>data</span><span>);</span>
    <span>return</span> <span>(</span><span>this</span><span>.</span><span>data</span> <span>=</span> <span>data</span><span>);</span>
  <span>}</span>

  <span>// The general properties are mostly there so we don't have to</span>
  <span>// constantly derive them on the client side:</span>
  <span>setGeneralProperties</span><span>(</span><span>data</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>onGround</span><span>,</span> <span>hasPower</span><span>,</span> <span>enginesRunning</span><span>,</span> <span>speed</span><span>,</span> <span>camera</span> <span>}</span> <span>=</span> <span>data</span><span>;</span>
    <span>const</span> <span>inGame</span> <span>=</span> <span>2</span> <span>&lt;=</span> <span>camera</span> <span>&amp;&amp;</span> <span>camera</span> <span>&lt;</span> <span>9</span><span>;</span>
    <span>const</span> <span>flying</span> <span>=</span> <span>inGame</span> <span>?</span> <span>!</span><span>onGround</span> <span>:</span> <span>false</span><span>;</span>
    <span>const</span> <span>moving</span> <span>=</span> <span>inGame</span> <span>?</span> <span>speed</span> <span>&gt;</span> <span>0</span> <span>:</span> <span>false</span><span>;</span>
    <span>const</span> <span>planeActive</span> <span>=</span> <span>inGame</span> <span>?</span> <span>hasPower</span> <span>||</span> <span>enginesRunning</span> <span>:</span> <span>false</span><span>;</span>
    <span>Object</span><span>.</span><span>assign</span><span>(</span><span>this</span><span>.</span><span>general</span><span>,</span> <span>{</span> <span>flying</span><span>,</span> <span>inGame</span><span>,</span> <span>planeActive</span><span>,</span> <span>moving</span> <span>});</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And then, as last step, we now need to make the server actually use this object, and make sure that clients can receive it. So, on the server side:</p>

<div><pre><code><span>...</span>

<span>// Import our hot-reloader</span>
<span>import</span> <span>{</span> <span>watch</span> <span>}</span> <span>from</span> <span>"</span><span>../../utils/reload-watcher.js</span><span>"</span><span>;</span>

<span>// Import our fancy new class, in a way that lets us hot-reload it:</span>
<span>let</span> <span>flightInformation</span><span>;</span>
<span>let</span> <span>{</span> <span>FlightInformation</span> <span>}</span> <span>=</span> <span>await</span> <span>watch</span><span>(</span>
  <span>__dirname</span><span>,</span>
  <span>`../../utils/flight-information.js`</span><span>,</span>
  <span>(</span><span>module</span><span>)</span> <span>=&gt;</span> <span>{</span>
    <span>FlightInformation</span> <span>=</span> <span>module</span><span>.</span><span>FlightInformation</span><span>;</span>
    <span>if</span> <span>(</span><span>flightInformation</span><span>)</span> <span>{</span>
      <span>Object</span><span>.</span><span>setPrototypeOf</span><span>(</span><span>flightInformation</span><span>,</span> <span>FlightInformation</span><span>.</span><span>prototype</span><span>);</span>
    <span>}</span>
  <span>}</span>
<span>);</span>

<span>class</span> <span>Server</span> <span>{</span>
  <span>...</span>

  <span>async</span> <span>init</span><span>()</span> <span>{</span>
    <span>...</span>
    <span>connectServerToAPI</span><span>(</span><span>api</span><span>,</span> <span>async</span> <span>()</span> <span>=&gt;</span> <span>{</span>
      <span>console</span><span>.</span><span>log</span><span>(</span><span>`Connected to MSFS.`</span><span>);</span>

      <span>// Set up a flight information object for pulling</span>
      <span>// model and flight data from SimConnect:</span>
      <span>flightInformation</span> <span>=</span> <span>new</span> <span>FlightInformation</span><span>(</span><span>api</span><span>);</span>

      <span>registerWithAPI</span><span>(</span><span>clients</span><span>,</span> <span>api</span><span>,</span> <span>autopilot</span><span>);</span>
      <span>clients</span><span>.</span><span>forEach</span><span>((</span><span>client</span><span>)</span> <span>=&gt;</span> <span>client</span><span>.</span><span>onMSFS</span><span>(</span><span>true</span><span>));</span>

      <span>(</span><span>async</span> <span>function</span> <span>poll</span><span>()</span> <span>{</span>
        <span>// And make sure to pass this into our game check.</span>
        <span>checkGameState</span><span>(</span><span>clients</span><span>,</span> <span>flightInformation</span><span>);</span>
        <span>runLater</span><span>(</span><span>poll</span><span>,</span> <span>POLLING_INTERVAL</span><span>);</span>
      <span>})();</span>
    <span>});</span>
  <span>}</span>


  <span>async</span> <span>onConnect</span><span>(</span><span>client</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>api</span><span>?.</span><span>connected</span><span>)</span> <span>client</span><span>.</span><span>onMSFS</span><span>(</span><span>true</span><span>);</span>
    <span>// When clients connect, immediately send them the most up to date</span>
    <span>// flight information, if the flightInformation object has been</span>
    <span>// initialized, of course.</span>
    <span>if</span> <span>(</span><span>flightInformation</span><span>)</span> <span>{</span>
      <span>client</span><span>.</span><span>setFlightInformation</span><span>(</span><span>flightInformation</span><span>);</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>With the <code>flightInformation</code> added to the <code>checkGameState</code> function we created earlier in the helpers file:</p>

<div><pre><code><span>// get the most up to date game state and send that over to our clients:</span>
<span>export</span> <span>async</span> <span>function</span> <span>checkGameState</span><span>(</span><span>clients</span><span>,</span> <span>flightInformation</span><span>)</span> <span>{</span>
  <span>await</span> <span>flightInformation</span><span>.</span><span>update</span><span>();</span>
  <span>clients</span><span>.</span><span>forEach</span><span>((</span><span>client</span><span>)</span> <span>=&gt;</span> <span>client</span><span>.</span><span>setFlightInformation</span><span>(</span><span>flightInformation</span><span>));</span>
<span>}</span>
</code></pre></div>

<p>And then we add the <code>setFlightInformation</code> function to the client class, to close the loop:</p>

<div><pre><code><span>...</span>

<span>export</span> <span>class</span> <span>ClientClass</span> <span>{</span>
  <span>...</span>

  <span>// our base state now includes the flightinformation properties:</span>
  <span>#</span><span>resetState</span><span>()</span> <span>{</span>
    <span>this</span><span>.</span><span>setState</span><span>({</span>
      <span>...</span>
      <span>flightInformation</span><span>:</span> <span>{}</span>
    <span>});</span>
  <span>}</span>

  <span>...</span>

  <span>async</span> <span>setFlightInformation</span><span>(</span><span>flightInformation</span><span>)</span> <span>{</span>
    <span>// Just straight-up copy all the flight information state</span>
    <span>// values, which will then automatically update any browser</span>
    <span>// that's connected, as well.</span>
    <span>this</span><span>.</span><span>setState</span><span>({</span> <span>flightInformation</span> <span>});</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>Well that only took forever, but we can finally get back to <em>&lt;checks notes&gt;</em> ticking a few HTML checkboxes?</p>

<h2 id="showing-the-game-data">Showing the game data</h2>

<p>We know when we’re connected to MSFS, so let’s write a few functions that let us cascade through the various stages of the game before we get to “actually controlling a plane”. Let’s start with what we want that to look like:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/page/questions.png" alt="so many questions"></p>

<p>Nothing particularly fancy (although we can pretty much use any amount of CSS to turn it <em>into</em> something fancy), but it lets us see where in the process of firing up MSFS, clicking through to the world map, and starting a flight we are. So let’s update our HTML file to include these questions, and then we can update our JS to start answering them:</p>

<div><pre><code><span>&lt;link</span> <span>rel=</span><span>"stylesheet"</span> <span>href=</span><span>"css/questions.css"</span> <span>/&gt;</span>
<span>&lt;li&gt;</span>
  Is our API server running? <span>&lt;input</span> <span>type=</span><span>"checkbox"</span> <span>disabled</span> <span>class=</span><span>"server-online"</span> <span>/&gt;</span>
<span>&lt;/li&gt;</span>
<span>&lt;li&gt;</span>
  Is MSFS running? <span>&lt;input</span> <span>type=</span><span>"checkbox"</span> <span>disabled</span> <span>class=</span><span>"msfs-running"</span> <span>/&gt;</span>
<span>&lt;/li&gt;</span>
<span>&lt;li&gt;</span>
  Which plane did we pick? <span>&lt;span</span> <span>class=</span><span>"specific-plane"</span><span>&gt;</span>... nothing yet?<span>&lt;/span&gt;</span>
<span>&lt;/li&gt;</span>
<span>&lt;li&gt;</span>
  Are we actually "in a game"? <span>&lt;input</span> <span>type=</span><span>"checkbox"</span> <span>disabled</span> <span>class=</span><span>"in-game"</span> <span>/&gt;</span>
<span>&lt;/li&gt;</span>
<span>&lt;li&gt;</span>
  Do we have power? <span>&lt;input</span> <span>type=</span><span>"checkbox"</span> <span>disabled</span> <span>class=</span><span>"powered-up"</span> <span>/&gt;</span>
<span>&lt;/li&gt;</span>
<span>&lt;li&gt;</span>
  Are the engines running? <span>&lt;input</span> <span>type=</span><span>"checkbox"</span> <span>disabled</span> <span>class=</span><span>"engines-running"</span> <span>/&gt;</span>
<span>&lt;/li&gt;</span>
<span>&lt;li&gt;</span>
  Are we flying?? <span>&lt;input</span> <span>type=</span><span>"checkbox"</span> <span>disabled</span> <span>class=</span><span>"in-the-air"</span> <span>/&gt;</span>
<span>&lt;/li&gt;</span>
<span>&lt;li&gt;</span>
  <span>&lt;em&gt;</span>Where<span>&lt;/em&gt;</span> are we flying?
  <span>&lt;a</span> <span>href=</span><span>"."</span> <span>class=</span><span>"gmaps-link"</span><span>&gt;</span>
    <span>&lt;span</span> <span>class=</span><span>"latitude"</span><span>&gt;</span>-<span>&lt;/span&gt;</span>,
    <span>&lt;span</span> <span>class=</span><span>"longitude"</span><span>&gt;</span>-<span>&lt;/span&gt;</span>
  <span>&lt;/a&gt;</span>
<span>&lt;/li&gt;</span>
<span>&lt;li&gt;</span>
  Are we on the in-game autopilot? <span>&lt;input</span> <span>type=</span><span>"checkbox"</span> <span>disabled</span> <span>class=</span><span>"using-ap"</span> <span>/&gt;</span>
<span>&lt;/li&gt;</span>
<span>&lt;li&gt;</span>
  (... did we crash? <span>&lt;input</span> <span>type=</span><span>"checkbox"</span> <span>disabled</span> <span>class=</span><span>"plane-crashed"</span> <span>/&gt;</span>)
<span>&lt;/li&gt;</span>
</code></pre></div>

<p>Excellent: boring, but serviceable, so let’s add a parent for that in our <code>index.html</code>:</p>

<div><pre><code><span>&lt;!doctype html&gt;</span>
<span>&lt;html</span> <span>lang=</span><span>"en-GB"</span><span>&gt;</span>
  <span>&lt;head&gt;</span>
    <span>&lt;meta</span> <span>charset=</span><span>"utf-8"</span> <span>/&gt;</span>
    <span>&lt;title&gt;</span>Let's test our connections!<span>&lt;/title&gt;</span>
    <span>&lt;script </span><span>src=</span><span>"js/index.js"</span> <span>type=</span><span>"module"</span> <span>async</span><span>&gt;&lt;/script&gt;</span>
  <span>&lt;/head&gt;</span>
  <span>&lt;body&gt;</span>
    <span>&lt;h1&gt;</span>Are we flying?<span>&lt;/h1&gt;</span>
    <span>&lt;p&gt;</span>
      Let's see if we're currently flying around in Microsoft Flight Simulator 2020...
    <span>&lt;/p&gt;</span>
    <span>&lt;ul&gt;</span>
    <span>&lt;ul</span> <span>id=</span><span>"questions"</span> <span>data-description=</span><span>"Templated from questions.html"</span><span>&gt;&lt;/ul&gt;</span>
  <span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
</code></pre></div>

<p>And create a little CSS file in <code>public/css/questions/css</code>:</p>

<div><pre><code><span>#questions</span> <span>{</span>
  <span>list-style</span><span>:</span> <span>none</span><span>;</span>
  <span>margin</span><span>:</span> <span>1em</span><span>;</span>
  <span>padding</span><span>:</span> <span>0</span><span>;</span>
  <span>text-indent</span><span>:</span> <span>0</span><span>;</span>
<span>}</span>
<span>#questions</span> <span>li</span> <span>{</span> <span>display</span><span>:</span> <span>block</span><span>;</span> <span>}</span>
<span>#questions</span> <span>li</span><span>:before</span> <span>{</span> <span>content</span><span>:</span> <span>"-"</span><span>;</span> <span>}</span>
</code></pre></div>

<p>Then let’s move on to the JS side! First let’s write a little convenience file called <code>questions.js</code> that we’re going to use to (un)check these questions, based on the fact that we have access to the web client’s state:</p>

<div><pre><code><span>const</span> <span>content</span> <span>=</span> <span>await</span> <span>fetch</span><span>(</span><span>"</span><span>questions.html</span><span>"</span><span>).</span><span>then</span><span>((</span><span>res</span><span>)</span> <span>=&gt;</span> <span>res</span><span>.</span><span>text</span><span>());</span>
<span>const</span> <span>questions</span> <span>=</span> <span>document</span><span>.</span><span>getElementById</span><span>(</span><span>`questions`</span><span>);</span>
<span>questions</span><span>.</span><span>innerHTML</span> <span>=</span> <span>content</span><span>;</span>

<span>// The query selectors for our elements:</span>
<span>const</span> <span>qss</span> <span>=</span> <span>[</span>
  <span>`server-online`</span><span>,</span>
  <span>`msfs-running`</span><span>,</span>
  <span>`in-game`</span><span>,</span>
  <span>`powered-up`</span><span>,</span>
  <span>`engines-running`</span><span>,</span>
  <span>`in-the-air`</span><span>,</span>
  <span>`using-ap`</span><span>,</span>
  <span>`plane-crashed`</span><span>,</span>
  <span>`specific-plane`</span><span>,</span>
  <span>`gmaps-link`</span><span>,</span>
  <span>`latitude`</span><span>,</span>
  <span>`longitude`</span><span>,</span>
<span>];</span>

<span>// A bit of house-keeping</span>
<span>const</span> <span>vowels</span> <span>=</span> <span>[</span><span>`a`</span><span>,</span> <span>`i`</span><span>,</span> <span>`u`</span><span>,</span> <span>`e`</span><span>,</span> <span>`o`</span><span>,</span> <span>`A`</span><span>,</span> <span>`I`</span><span>,</span> <span>`U`</span><span>,</span> <span>`E`</span><span>,</span> <span>`O`</span><span>];</span>

<span>function</span> <span>titleCase</span><span>(</span><span>s</span><span>)</span> <span>{</span>
  <span>return</span> <span>s</span><span>.</span><span>substring</span><span>(</span><span>0</span><span>,</span> <span>1</span><span>).</span><span>toUpperCase</span><span>()</span> <span>+</span> <span>s</span><span>.</span><span>substring</span><span>(</span><span>1</span><span>).</span><span>toLowerCase</span><span>();</span>
<span>}</span>

<span>function</span> <span>reCase</span><span>(</span><span>e</span><span>)</span> <span>{</span>
  <span>return</span> <span>e</span>
    <span>.</span><span>split</span><span>(</span><span>`-`</span><span>)</span>
    <span>.</span><span>map</span><span>((</span><span>s</span><span>,</span> <span>p</span><span>)</span> <span>=&gt;</span> <span>(</span><span>p</span> <span>===</span> <span>0</span> <span>?</span> <span>s</span> <span>:</span> <span>titleCase</span><span>(</span><span>s</span><span>)))</span>
    <span>.</span><span>join</span><span>(</span><span>``</span><span>);</span>
<span>}</span>

<span>// Let's create an object that's { serverOnline: span, msfsRunning: span, ... }</span>
<span>// because that'll make it easier to set text and check checkboxes:</span>
<span>const</span> <span>elements</span> <span>=</span> <span>Object</span><span>.</span><span>fromEntries</span><span>(</span>
  <span>qss</span><span>.</span><span>map</span><span>((</span><span>e</span><span>)</span> <span>=&gt;</span> <span>{</span>
    <span>const</span> <span>propName</span> <span>=</span> <span>reCase</span><span>(</span><span>e</span><span>);</span>
    <span>return</span> <span>[</span><span>propName</span><span>,</span> <span>document</span><span>.</span><span>querySelector</span><span>(</span><span>`.</span><span>${</span><span>e</span><span>}</span><span>`</span><span>)];</span>
  <span>})</span>
<span>);</span>

<span>// And then our questions helper: we're simply going to set every checkbox</span>
<span>// based on what's in the current state, only spending a little more time</span>
<span>// on the plane model, and mostly because we want the right "a" vs. "an"</span>
<span>// depending on whether the title starts with a vowel or not:</span>
<span>export</span> <span>const</span> <span>Questions</span> <span>=</span> <span>{</span>
  <span>update</span><span>(</span><span>state</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span>
      <span>general</span><span>,</span>
      <span>model</span><span>:</span> <span>flightModel</span><span>,</span>
      <span>data</span><span>:</span> <span>flightData</span><span>,</span>
    <span>}</span> <span>=</span> <span>state</span><span>.</span><span>flightInformation</span><span>;</span>
    <span>elements</span><span>.</span><span>serverOnline</span><span>.</span><span>checked</span> <span>=</span> <span>!!</span><span>state</span><span>.</span><span>serverConnection</span><span>;</span>
    <span>elements</span><span>.</span><span>msfsRunning</span><span>.</span><span>checked</span> <span>=</span> <span>state</span><span>.</span><span>MSFS</span><span>;</span>
    <span>elements</span><span>.</span><span>inGame</span><span>.</span><span>checked</span> <span>=</span> <span>general</span><span>?.</span><span>inGame</span><span>;</span>
    <span>elements</span><span>.</span><span>poweredUp</span><span>.</span><span>checked</span> <span>=</span> <span>flightData</span><span>?.</span><span>hasPower</span><span>;</span>
    <span>elements</span><span>.</span><span>enginesRunning</span><span>.</span><span>checked</span> <span>=</span> <span>flightData</span><span>?.</span><span>enginesRunning</span><span>;</span>
    <span>elements</span><span>.</span><span>inTheAir</span><span>.</span><span>checked</span> <span>=</span> <span>general</span><span>?.</span><span>flying</span><span>;</span>
    <span>elements</span><span>.</span><span>usingAp</span><span>.</span><span>checked</span> <span>=</span> <span>flightData</span><span>?.</span><span>MASTER</span><span>;</span>
    <span>elements</span><span>.</span><span>planeCrashed</span><span>.</span><span>checked</span> <span>=</span> <span>state</span><span>.</span><span>crashed</span><span>;</span>
    <span>// And we'll do these two separately because they're a bit more than just a check mark:</span>
    <span>this</span><span>.</span><span>whereAreWeFlying</span><span>(</span><span>flightData</span><span>);</span>
    <span>this</span><span>.</span><span>modelLoaded</span><span>(</span><span>flightModel</span><span>?.</span><span>title</span><span>);</span>
  <span>},</span>

  <span>whereAreWeFlying</span><span>(</span><span>flightData</span><span>)</span> <span>{</span>
    <span>const</span> <span>lat</span> <span>=</span> <span>flightData</span><span>?.</span><span>lat</span><span>?.</span><span>toFixed</span><span>(</span><span>6</span><span>);</span>
    <span>const</span> <span>long</span> <span>=</span> <span>flightData</span><span>?.</span><span>long</span><span>?.</span><span>toFixed</span><span>(</span><span>6</span><span>);</span>
    <span>elements</span><span>.</span><span>gmapsLink</span><span>.</span><span>href</span> <span>=</span> <span>`https://www.google.com/maps/place/</span><span>${</span><span>lat</span><span>}</span><span>+</span><span>${</span><span>long</span><span>}</span><span>/@</span><span>${</span><span>lat</span><span>}</span><span>,</span><span>${</span><span>long</span><span>}</span><span>,13z`</span><span>;</span>
    <span>elements</span><span>.</span><span>latitude</span><span>.</span><span>textContent</span> <span>=</span> <span>lat</span> <span>??</span> <span>`-`</span><span>;</span>
    <span>elements</span><span>.</span><span>longitude</span><span>.</span><span>textContent</span> <span>=</span> <span>long</span> <span>??</span> <span>`-`</span><span>;</span>
  <span>},</span>

  <span>modelLoaded</span><span>(</span><span>modelName</span><span>)</span> <span>{</span>
    <span>let</span> <span>model</span> <span>=</span> <span>`(...nothing yet?)`</span><span>;</span>
    <span>if</span> <span>(</span><span>modelName</span><span>)</span> <span>{</span>
      <span>let</span> <span>article</span> <span>=</span> <span>`a`</span><span>;</span>
      <span>if</span> <span>(</span><span>vowels</span><span>.</span><span>includes</span><span>(</span><span>modelName</span><span>.</span><span>substring</span><span>(</span><span>0</span><span>,</span> <span>1</span><span>)))</span> <span>article</span> <span>+=</span> <span>`n`</span><span>;</span>
      <span>model</span> <span>=</span> <span>`...Looks like </span><span>${</span><span>article</span><span>}</span><span> </span><span>${</span><span>modelName</span><span>}</span><span>. Nice!`</span><span>;</span>
    <span>}</span>
    <span>elements</span><span>.</span><span>specificPlane</span><span>.</span><span>textContent</span> <span>=</span> <span>model</span><span>;</span>
  <span>},</span>
<span>};</span>
</code></pre></div>

<p>Cool! Of course, this does nothing yet, so let’s plug it into our <code>plane.js</code> so that we can run through our sequence of “where in the game we are” as part of the update call:</p>

<div><pre><code><span>...</span>
<span>import</span> <span>{</span> <span>Questions</span> <span>}</span> <span>from</span> <span>"</span><span>./questions.js</span><span>"</span><span>;</span>

<span>export</span> <span>class</span> <span>Plane</span> <span>{</span>
  <span>...</span>

  <span>async</span> <span>updateState</span><span>(</span><span>state</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>state</span> <span>=</span> <span>state</span><span>;</span>
    <span>const</span> <span>now</span> <span>=</span> <span>Date</span><span>.</span><span>now</span><span>();</span>

    <span>// Update our questions:</span>
    <span>Questions</span><span>.</span><span>update</span><span>(</span><span>state</span><span>);</span>

    <span>this</span><span>.</span><span>lastUpdate</span> <span>=</span> <span>{</span> <span>time</span><span>:</span> <span>now</span><span>,</span> <span>...</span><span>state</span> <span>};</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And that’s the “game state” read-back sorted out! Easy-peasy!</p>

<h3 id="trying-our-question-list-out">Trying our question list out</h3>

<p>So: let’s tick some HTML checkboxes!</p>

<ul>
  <li>Start MSFS,</li>
  <li>then up the server with <code>node api-server.js</code> and our client with <code>node web-server.js --browser</code> ,</li>
  <li>then look at what happens in the browser as MSFS finished starting up.</li>
  <li>Load up a plane on a runway somewhere, and see what happens.</li>
  <li>Load up a plane mid-flight and see what the checkboxes do! And of course,</li>
  <li>look at what happens when you shut down MSFS, and what happens when you shut down the API server <em>before</em> you shut down the web client.</li>
</ul>

<p>So, on the one hand: <em>that was a LOT of work just to check some boxes</em>! But the upside is that with all of that work out of the way, we’re done in terms of “making sure we have up to date information to work with”: all we need to do is call our flight information <code>update</code> function on the server side, and hook into our Plane’s <code>updateState</code> function on the browser side from now on, and that’s going to make things like running autopilot code and showing flight visualizations a lot easier.</p>

<p>And speaking of visualizations…</p>

<h2 id="putting-our-plane-on-the-map">Putting our plane on the map</h2>

<p>Even with all that work done, we’ve still only implemented page code that lets us answer a bunch of questions, but that’s hardly the only thing we’ll want to see on our page. Let’s add something that let’s us actually see something <em>cool</em> on our webpage: let’s set up a <a href="https://leafletjs.com/">Leaflet</a> map that we can put our plane on, so we can see ourselves flying around on a map.</p>

<p>Step one: update our <code>index.html</code> to make that work, including downloading Leaflet and putting it in <code>public/js/leaflet</code>. We <em>could</em> run it from CDN, using something like this:</p>

<div><pre><code>    <span>&lt;link</span> <span>rel=</span><span>"stylesheet"</span> <span>href=</span><span>"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"</span> <span>async</span> <span>/&gt;</span>
    <span>&lt;script </span><span>src=</span><span>"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"</span> <span>defer</span> <span>async</span><span>&gt;&lt;/script&gt;</span>
</code></pre></div>

<p>And I encourage you to give that a try, but if we do, Leaflet takes “forever” to load, as opposed to loading near instantly if we save and use a local copy, so: download the .js and .css files from the above CDN links, and put them in our own leaflet dir, and then lets add them to our <code>index.html</code> as:</p>

<div><pre><code><span>&lt;!DOCTYPE html&gt;</span>
<span>&lt;html</span> <span>lang=</span><span>"en-GB"</span><span>&gt;</span>
  <span>&lt;head&gt;</span>
    <span>&lt;meta</span> <span>charset=</span><span>"utf-8"</span> <span>/&gt;</span>
    <span>&lt;title&gt;</span>Let's test our connections!<span>&lt;/title&gt;</span>
    <span>&lt;!-- we'll load Leaflet from CDN --&gt;</span>
    <span>&lt;link</span> <span>rel=</span><span>"stylesheet"</span> <span>href=</span><span>"js/leaflet/leaflet.min.css"</span> <span>async</span> <span>/&gt;</span>
    <span>&lt;script </span><span>src=</span><span>"js/leaflet/leaflet.min.js"</span> <span>defer</span> <span>async</span><span>&gt;&lt;/script&gt;</span>
    <span>&lt;!-- and then our own script --&gt;</span>
    <span>&lt;script </span><span>src=</span><span>"js/index.js"</span> <span>type=</span><span>"module"</span> <span>async</span><span>&gt;&lt;/script&gt;</span>
  <span>&lt;/head&gt;</span>
  <span>&lt;body&gt;</span>
    <span>&lt;h1&gt;</span>Are we flying?<span>&lt;/h1&gt;</span>
    <span>&lt;p&gt;</span>
      Let's see if we're currently flying around in Microsoft Flight Simulator
      2020...
    <span>&lt;/p&gt;</span>
    <span>&lt;ul</span> <span>id=</span><span>"questions"</span> <span>data-description=</span><span>"Templated from questions.html"</span><span>&gt;&lt;/ul&gt;</span>
    <span>&lt;div</span> <span>id=</span><span>"visualization"</span><span>&gt;</span>
      <span>&lt;!-- Then we'll hook Leaflet into the following div: --&gt;</span>
      <span>&lt;div</span> <span>id=</span><span>"map"</span> <span>style=</span><span>"width: 1200px; height: 800px"</span><span>&gt;&lt;/div&gt;</span>
    <span>&lt;/div&gt;</span>
  <span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
</code></pre></div>

<p>And then let’s write a <code>public/js/map.js</code> that we can import to take care of the map for us:</p>

<div><pre><code><span>import</span> <span>{</span> <span>waitFor</span> <span>}</span> <span>from</span> <span>"</span><span>./utils.js</span><span>"</span><span>;</span>

<span>export</span> <span>const</span> <span>DUNCAN_AIRPORT</span> <span>=</span> <span>[</span><span>48.7566</span><span>,</span> <span>-</span><span>123.71134</span><span>];</span>

<span>// Leaflet creates a global "L" object to work with, so use that to tie into the &lt;div id="map"&gt;&lt;/div&gt; we have sitting</span>
<span>// in our index.html. However, because independent page scripts can't be imported, we need to wait for it to be available:</span>
<span>const</span> <span>L</span> <span>=</span> <span>await</span> <span>waitFor</span><span>(</span><span>async</span> <span>()</span> <span>=&gt;</span> <span>window</span><span>.</span><span>L</span><span>);</span>

<span>// With our "L" object available, let's make a map, centered on Duncan airport:</span>
<span>export</span> <span>const</span> <span>map</span> <span>=</span> <span>L</span><span>.</span><span>map</span><span>(</span><span>"</span><span>map</span><span>"</span><span>).</span><span>setView</span><span>(</span><span>DUNCAN_AIRPORT</span><span>,</span> <span>15</span><span>);</span>

<span>// Of course, this won't *show* anything: we still need an actual map tile layer:</span>
<span>L</span><span>.</span><span>tileLayer</span><span>(</span><span>`https://tile.openstreetmap.org/{z}/{x}/{y}.png`</span><span>,</span> <span>{</span>
  <span>maxZoom</span><span>:</span> <span>19</span><span>,</span>
  <span>attribution</span><span>:</span> <span>`© &lt;a href="http://www.openstreetmap.org/copyright"&gt;OpenStreetMap&lt;/a&gt;`</span><span>,</span>
<span>}).</span><span>addTo</span><span>(</span><span>map</span><span>);</span>
</code></pre></div>

<p>With a quick look at that <code>waitFor</code> function in <code>public/js/utils.js</code>:</p>

<div><pre><code><span>// Return a promise that doesn't resolve until `fn()` returns a truthy value, or we run out of retries.</span>
<span>export</span> <span>function</span> <span>waitFor</span><span>(</span><span>fn</span><span>,</span> <span>timeout</span> <span>=</span> <span>5000</span><span>,</span> <span>retries</span> <span>=</span> <span>100</span><span>)</span> <span>{</span>
  <span>return</span> <span>new</span> <span>Promise</span><span>((</span><span>resolve</span><span>,</span> <span>reject</span><span>)</span> <span>=&gt;</span> <span>{</span>
    <span>(</span><span>async</span> <span>function</span> <span>run</span><span>()</span> <span>{</span>
      <span>if</span> <span>(</span><span>--</span><span>retries</span> <span>===</span> <span>0</span><span>)</span> <span>reject</span><span>(</span><span>new</span> <span>Error</span><span>(</span><span>`max retries reached`</span><span>));</span>
      <span>try</span> <span>{</span>
        <span>const</span> <span>data</span> <span>=</span> <span>await</span> <span>fn</span><span>();</span>
        <span>if</span> <span>(</span><span>!</span><span>data</span><span>)</span> <span>return</span> <span>setTimeout</span><span>(</span><span>run</span><span>,</span> <span>timeout</span><span>,</span> <span>retries</span><span>);</span>
        <span>resolve</span><span>(</span><span>data</span><span>);</span>
      <span>}</span> <span>catch</span> <span>(</span><span>e</span><span>)</span> <span>{</span>
        <span>reject</span><span>(</span><span>e</span><span>);</span>
      <span>}</span>
    <span>})();</span>
  <span>});</span>
<span>}</span>
</code></pre></div>

<p>We use this because we don’t want to do any map work until Leaflet’s been loaded in, and as an external third party library, we have no idea when that might be, and the HTML stack does not have anything simple built in to check whether non-import scripts have finished loading. So this will have to do.</p>

<p>With that, though, we can update our <code>plane.js</code> to load our map code:</p>

<div><pre><code><span>import</span> <span>{</span> <span>map</span> <span>as</span> <span>defaultMap</span> <span>}</span> <span>from</span> <span>"</span><span>./map.js</span><span>"</span>

<span>...</span>

<span>export</span> <span>class</span> <span>Plane</span> <span>{</span>
  <span>constructor</span><span>(</span><span>server</span><span>,</span> <span>map</span> <span>=</span> <span>defaultMap</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>server</span> <span>=</span> <span>server</span><span>;</span>
    <span>this</span><span>.</span><span>map</span> <span>=</span> <span>map</span><span>;</span>
    <span>...</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And presto! Now our browser page actually has more than just text:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/page/page-overview.png" alt="A basic page overview with questions and map"></p>

<p>Which is pretty good, but it’s lacking something… our plane!</p>

<p>Let’s make a quick little plane icon and put that on the map, at the correct latitude and longitude, pointing in the right direction. We’ll start by making a <code>public/map-marker.html</code> file and putting some code in there:</p>

<div><pre><code><span>&lt;div</span> <span>id=</span><span>"plane-icon"</span><span>&gt;</span>
  <span>&lt;div</span> <span>class=</span><span>"bounds"</span><span>&gt;</span>
    <span>&lt;link</span> <span>rel=</span><span>"stylesheet"</span> <span>href=</span><span>"css/map-marker.css"</span> <span>/&gt;</span>

    <span>&lt;div</span> <span>class=</span><span>"basics"</span><span>&gt;</span>
      <span>&lt;!-- One normal plane: --&gt;</span>
      <span>&lt;img</span> <span>src=</span><span>"/planes/plane.png"</span> <span>class=</span><span>"plane"</span> <span>/&gt;</span>
      <span>&lt;!-- And a plane shadow, because seeing a shadow on a map makes a *huge* difference: --&gt;</span>
      <span>&lt;img</span> <span>src=</span><span>"/planes/plane.png"</span> <span>class=</span><span>"shadow"</span> <span>/&gt;</span>
    <span>&lt;/div&gt;</span>
  <span>&lt;/div&gt;</span>
<span>&lt;/div&gt;</span>
</code></pre></div>

<p>With that <code>plane.png</code> being a simple little non-existent plane silhouette:</p>

<p><img src="https://pomax.github.io/public/planes/plane.png"></p>

<p>And then we add a bit of CSS here, because while we <em>could</em> rotate our plane and shadow using JavaScript, that’s a bit silly when CSS comes with <code>tranform: rotate(...)</code> built in. All we need to do is make sure that the CSS variable <code>--heading</code> is some plain number in degrees (which we can, because that’s one of our flight data values), and then CSS can do the rest. So:</p>

<div><pre><code><span>#plane-icon</span> <span>{</span>
  <span>/* --heading will be unitless, with a corresponding --degrees that's a "real" value */</span>
  <span>--heading</span><span>:</span> <span>0</span><span>;</span>
  <span>--degrees</span><span>:</span> <span>calc</span><span>(</span><span>1deg</span> <span>*</span> <span>var</span><span>(</span><span>--heading</span><span>));</span>

  <span>/* --altitude will be unitless, with a corresponding --alt-em that's a "real" value */</span>
  <span>--altitude</span><span>:</span> <span>0</span><span>;</span>
  <span>--alt-em</span><span>:</span> <span>calc</span><span>(</span><span>sqrt</span><span>(</span><span>var</span><span>(</span><span>--altitude</span><span>))</span> <span>/</span> <span>20</span><span>);</span>
<span>}</span>

<span>#plane-icon</span> <span>.basics</span> <span>{</span>
  <span>/*
    we want to overlay the plane and its shadow, so mark this element relative
    and then mark the contained plane and shadow as absolute, so they end up on
    top of each other.
  */</span>
  <span>position</span><span>:</span> <span>relative</span><span>;</span>
<span>}</span>

<span>#plane-icon</span> <span>.basics</span> <span>img</span> <span>{</span>
  <span>position</span><span>:</span> <span>absolute</span><span>;</span>
  <span>transform-origin</span><span>:</span> <span>center</span> <span>center</span><span>;</span>
<span>}</span>

<span>#plane-icon</span> <span>.basics</span> <span>img</span><span>.shadow</span> <span>{</span>
  <span>/* the higher we're flying, the more blurred our shadow should be: */</span>
  <span>--shadow-blur-size</span><span>:</span> <span>calc</span><span>(</span><span>1px</span> <span>*</span> <span>var</span><span>(</span><span>--alt-em</span><span>)</span> <span>/</span> <span>2</span><span>);</span>
  <span>filter</span><span>:</span> <span>blur</span><span>(</span><span>var</span><span>(</span><span>--shadow-blur-size</span><span>))</span> <span>opacity</span><span>(</span><span>0.3</span><span>);</span>
  <span>/* we only need to rotate the shadow, so it's pointing in the right direction: */</span>
  <span>transform</span><span>:</span> <span>rotate</span><span>(</span><span>var</span><span>(</span><span>--degrees</span><span>));</span>
<span>}</span>

<span>#plane-icon</span> <span>.basics</span> <span>img</span><span>.plane</span> <span>{</span>
  <span>/* but we rotate *and* move the real plane icon up, based on how high it's flying: */</span>
  <span>--elevation-offset</span><span>:</span> <span>calc</span><span>(</span><span>-1em</span> <span>*</span> <span>var</span><span>(</span><span>--alt-em</span><span>))</span> <span>position</span><span>:</span> <span>absolute</span><span>;</span>
  <span>/* and transforms are applied right-to-left, so this rotates first, then translates: */</span>
  <span>transform</span><span>:</span> <span>translate</span><span>(</span><span>0</span><span>,</span> <span>var</span><span>(</span><span>--elevation-offset</span><span>))</span> <span>rotate</span><span>(</span><span>var</span><span>(</span><span>--degrees</span><span>));</span>
<span>}</span>
</code></pre></div>

<p>Which just leaves adding this icon to our map. First, a little map helper file in <code>public/js/map-marker.js</code>:</p>

<div><pre><code><span>// Load our .html "partial"</span>
<span>const</span> <span>content</span> <span>=</span> <span>await</span> <span>fetch</span><span>(</span><span>"</span><span>map-marker.html</span><span>"</span><span>).</span><span>then</span><span>((</span><span>res</span><span>)</span> <span>=&gt;</span> <span>res</span><span>.</span><span>text</span><span>());</span>
<span>const</span> <span>div</span> <span>=</span> <span>document</span><span>.</span><span>createElement</span><span>(</span><span>`div`</span><span>);</span>
<span>div</span><span>.</span><span>innerHTML</span> <span>=</span> <span>content</span><span>;</span>
<span>const</span> <span>MapMarker</span> <span>=</span> <span>div</span><span>.</span><span>children</span><span>[</span><span>0</span><span>];</span>

<span>// Then create a little helper function that gets the HTML we need to</span>
<span>// feed to Leaflet in order for it to put our icon on the map "as an</span>
<span>// icon that it can move", with some initial heading:</span>
<span>MapMarker</span><span>.</span><span>getHTML</span> <span>=</span> <span>(</span><span>initialHeading</span> <span>=</span> <span>0</span><span>)</span> <span>=&gt;</span> <span>{</span>
  <span>MapMarker</span><span>.</span><span>style</span><span>.</span><span>setProperty</span><span>(</span><span>`--heading`</span><span>,</span> <span>initialHeading</span><span>);</span>
  <span>return</span> <span>MapMarker</span><span>.</span><span>outerHTML</span><span>;</span>
<span>};</span>

<span>// And then just export that.</span>
<span>export</span> <span>{</span> <span>MapMarker</span> <span>};</span>
</code></pre></div>

<p>And then we can update our <code>plane.js</code>:</p>

<div><pre><code><span>import</span> <span>{</span> <span>Questions</span> <span>}</span> <span>from</span> <span>"</span><span>./questions.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>map</span> <span>as</span> <span>defaultMap</span><span>,</span> <span>DUNCAN_AIRPORT</span> <span>}</span> <span>from</span> <span>"</span><span>./map.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>MapMarker</span> <span>}</span> <span>from</span> <span>"</span><span>./map-marker.js</span><span>"</span><span>;</span>

<span>const</span> <span>{</span> <span>abs</span> <span>}</span> <span>=</span> <span>Math</span><span>;</span>

<span>export</span> <span>class</span> <span>Plane</span> <span>{</span>
  <span>constructor</span><span>(</span><span>server</span><span>,</span> <span>map</span> <span>=</span> <span>defaultMap</span><span>,</span> <span>location</span> <span>=</span> <span>DUNCAN_AIRPORT</span><span>,</span> <span>heading</span> <span>=</span> <span>135</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>this</span><span>.</span><span>addPlaneIconToMap</span><span>(</span><span>map</span><span>,</span> <span>location</span><span>,</span> <span>heading</span><span>);</span>
  <span>}</span>

  <span>/**
   * We'll use Leaflet's "icon" functionality to add our plane:
   */</span>
  <span>async</span> <span>addPlaneIconToMap</span><span>(</span><span>map</span><span>,</span> <span>location</span><span>,</span> <span>heading</span><span>)</span> <span>{</span>
    <span>const</span> <span>props</span> <span>=</span> <span>{</span>
      <span>icon</span><span>:</span> <span>L</span><span>.</span><span>divIcon</span><span>({</span>
        <span>iconSize</span><span>:</span> <span>[</span><span>36</span><span>,</span> <span>25</span><span>],</span>
        <span>iconAnchor</span><span>:</span> <span>[</span><span>36</span> <span>/</span> <span>2</span><span>,</span> <span>25</span> <span>/</span> <span>2</span><span>],</span>
        <span>className</span><span>:</span> <span>`map-pin`</span><span>,</span>
        <span>// We our little plane icon's HTML, with the initial heading baked in:</span>
        <span>html</span><span>:</span> <span>MapMarker</span><span>.</span><span>getHTML</span><span>(</span><span>heading</span><span>),</span>
      <span>}),</span>
    <span>};</span>
    <span>// Then we turn that into a Leaflet map marker:</span>
    <span>this</span><span>.</span><span>marker</span> <span>=</span> <span>L</span><span>.</span><span>marker</span><span>(</span><span>location</span><span>,</span> <span>props</span><span>).</span><span>addTo</span><span>(</span><span>map</span><span>);</span>
    <span>// And then we cache the resulting page element so we can use it later, too:</span>
    <span>this</span><span>.</span><span>planeIcon</span> <span>=</span> <span>document</span><span>.</span><span>querySelector</span><span>(</span><span>`#plane-icon`</span><span>);</span>
  <span>}</span>

  <span>/**
   * We've seen this function before!
   */</span>
  <span>async</span> <span>updateState</span><span>(</span><span>state</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>state</span> <span>=</span> <span>state</span><span>;</span>
    <span>const</span> <span>now</span> <span>=</span> <span>Date</span><span>.</span><span>now</span><span>();</span>
    <span>Questions</span><span>.</span><span>update</span><span>(</span><span>state</span><span>);</span>

    <span>// Keep our map up to date:</span>
    <span>this</span><span>.</span><span>updateMap</span><span>(</span><span>state</span><span>.</span><span>flightInformation</span><span>);</span>

    <span>this</span><span>.</span><span>lastUpdate</span> <span>=</span> <span>{</span> <span>time</span><span>:</span> <span>now</span><span>,</span> <span>...</span><span>state</span> <span>};</span>
  <span>}</span>

  <span>/**
   * A dedicated function for updating the map!
   */</span>
  <span>async</span> <span>updateMap</span><span>({</span> <span>data</span><span>:</span> <span>flightData</span> <span>})</span> <span>{</span>
    <span>if</span> <span>(</span><span>!</span><span>flightData</span><span>)</span> <span>return</span><span>;</span>

    <span>const</span> <span>{</span> <span>map</span><span>,</span> <span>marker</span><span>,</span> <span>planeIcon</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>const</span> <span>{</span> <span>lat</span><span>,</span> <span>long</span> <span>}</span> <span>=</span> <span>flightData</span><span>;</span>

    <span>// Do we have a GPS coordinate? (And not the 0,0 off the West coast</span>
    <span>// of Africa that you get while you're not in game?)</span>
    <span>if</span> <span>(</span><span>lat</span> <span>===</span> <span>undefined</span> <span>||</span> <span>long</span> <span>===</span> <span>undefined</span><span>)</span> <span>return</span><span>;</span>
    <span>if</span> <span>(</span><span>abs</span><span>(</span><span>lat</span><span>)</span> <span>&lt;</span> <span>0.1</span> <span>&amp;&amp;</span> <span>abs</span><span>(</span><span>long</span><span>)</span> <span>&lt;</span> <span>0.1</span><span>)</span> <span>return</span><span>;</span>

    <span>// Update our plane's position on the Leaflet map:</span>
    <span>marker</span><span>.</span><span>setLatLng</span><span>([</span><span>lat</span><span>,</span> <span>long</span><span>]);</span>

    <span>// And make sure the map stays centered on our plane,</span>
    <span>// so we don't "fly off the screen":</span>
    <span>map</span><span>.</span><span>setView</span><span>([</span><span>lat</span><span>,</span> <span>long</span><span>]);</span>

    <span>// And then set our CSS variables so that the browser "does the rest":</span>
    <span>this</span><span>.</span><span>updateMarker</span><span>(</span><span>planeIcon</span><span>.</span><span>style</span><span>,</span> <span>flightData</span><span>);</span>
  <span>}</span>

  <span>/**
   * A dedicated function for updating the marker, which right now means
   * updating the CSS variables we're using to show our plane and shadow.
   */</span>
  <span>updateMarker</span><span>(</span><span>css</span><span>,</span> <span>{</span> <span>heading</span><span>,</span> <span>lift</span> <span>})</span> <span>{</span>
    <span>// Point the plane and shadow in the right direction:</span>
    <span>css</span><span>.</span><span>setProperty</span><span>(</span><span>`--heading`</span><span>,</span> <span>heading</span><span>);</span>

    <span>// And then also place the plane itself higher than</span>
    <span>// the shadow on the ground (if we're in the air):</span>
    <span>css</span><span>.</span><span>setProperty</span><span>(</span><span>`--altitude`</span><span>,</span> <span>max</span><span>(</span><span>lift</span><span>,</span> <span>0</span><span>));</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And through the magic of “the original web stack” we suddenly have a visualization that shows our plane somewhere in the air, and its shadow on the ground:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/page/basic-map.png" alt="A basic map with plane icon"></p>

<p>Nice!</p>

<p>That is to say, it’s nicer than not having a plane on the map, but this doesn’t really tell us much, does it? How high are we flying? What’s our airspeed? Which actual heading in degrees are we flying? I think we’re going to need some more HTML. And some SVG. And probably some CSS variables. And a smattering of JS.</p>

<h3 id="improving-our-visualization">Improving our visualization</h3>

<p>Let’s start by considering what we might want to visualize. We basically want all the information you’d get in a cockpit, but presented in marker form, so let’s go for the traditional navigation marker: a compass, with information arranged in and around that. What if we had a nice compass ring around our plane, with heading indication, current speed, and current altitude (both above the ground and “as far as the barometer can tell”). What about something like… this?</p>

<p><img src="https://pomax.github.io/are-we-flying/images/page/plane-marker.png" alt="our map icon"></p>

<p>Oh yeah: we’re getting fancy. We’re not using a simple little pin with a text bubble, we’re cramming as much MSFS information into our marker as we can:</p>

<ul>
  <li>Up top we have the current altitude above the ground in feet, with the altitude relative to sea level in parentheses.</li>
  <li>Down below, the speed in knots.</li>
  <li>In the center, we have the plane itself, offset vertically based on its altitude, with a picture that looks like the in-game plane.</li>
  <li>Below it, on the ground, we have the same plane but blurred and made translucent so it looks like a ground shadow.</li>
  <li>Also below the plane we have an altitude line connecting the plane to its GPS position on the map,</li>
  <li>as well as a line indicating both the current heading and speed of the plane.</li>
  <li>The outer compass ring represents the magnetic compass as we see it inside the plane,</li>
  <li>and the an inner compass ring represents the “true” north, based on GPS.</li>
  <li>The outer ring has a red “heading bug” that points in the direction that the plane should be going according to the autopilot,</li>
  <li>as well a green “current heading” marker so we don’t have to guess our heading based on the speed line.</li>
</ul>

<p>How do we build that? With HTML and SVG:</p>

<div><pre><code><span>&lt;div</span> <span>id=</span><span>"plane-icon"</span><span>&gt;</span>
  <span>&lt;div</span> <span>class=</span><span>"bounds"</span><span>&gt;</span>
    <span>&lt;link</span> <span>rel=</span><span>"stylesheet"</span> <span>href=</span><span>"css/map-marker.css"</span> <span>/&gt;</span>

    <span>&lt;div</span> <span>class=</span><span>"basics"</span><span>&gt;</span>
      <span>&lt;img</span> <span>src=</span><span>"/planes/plane.png"</span> <span>class=</span><span>"plane"</span> <span>/&gt;</span>
      <span>&lt;img</span> <span>src=</span><span>"/planes/plane.png"</span> <span>class=</span><span>"shadow"</span> <span>/&gt;</span>
      <span>&lt;hr</span> <span>class=</span><span>"alt-line"</span> <span>/&gt;</span>
      <span>&lt;hr</span> <span>class=</span><span>"speedo"</span> <span>/&gt;</span>
      <span>&lt;hr</span> <span>class=</span><span>"speedarrow"</span> <span>/&gt;</span>
      <span>&lt;div</span> <span>class=</span><span>"speed label"</span><span>&gt;</span>0kts<span>&lt;/div&gt;</span>
      <span>&lt;div</span> <span>class=</span><span>"alt label"</span><span>&gt;</span>0' (500')<span>&lt;/div&gt;</span>
    <span>&lt;/div&gt;</span>

    <span>&lt;svg</span> <span>class=</span><span>"compass"</span> <span>viewBox=</span><span>"0 0 200 200"</span><span>&gt;</span>
      <span>&lt;g</span> <span>transform=</span><span>"scale(0.9)"</span><span>&gt;</span>
        <span>&lt;g</span> <span>class=</span><span>"box"</span><span>&gt;</span>
          <span>&lt;path</span> <span>d=</span><span>"M0 100 L 200 100"</span> <span>/&gt;</span>
          <span>&lt;path</span> <span>d=</span><span>"M100 0 L 100 200"</span> <span>/&gt;</span>
          <span>&lt;rect</span>
            <span>x=</span><span>"0"</span>
            <span>y=</span><span>"0"</span>
            <span>width=</span><span>"200"</span>
            <span>height=</span><span>"200"</span>
            <span>stroke=</span><span>"black"</span>
            <span>fill=</span><span>"none"</span>
          <span>/&gt;</span>
        <span>&lt;/g&gt;</span>

        <span>&lt;g</span> <span>transform=</span><span>"translate(0,0) scale(0.92)"</span><span>&gt;</span>
          <span>&lt;g</span> <span>class=</span><span>"inner ring"</span><span>&gt;</span>
            <span>&lt;!-- and then a whoooole bunch of SVG path and text elements --&gt;</span>
          <span>&lt;/g&gt;</span>
          <span>&lt;g</span> <span>class=</span><span>"outer ring"</span><span>&gt;</span>
            <span>&lt;!-- and then even more SVG path and text elements --&gt;</span>
          <span>&lt;/g&gt;</span>
          <span>&lt;!-- and even more SVG O_o! --&gt;</span>
        <span>&lt;/g&gt;</span>
    <span>&lt;/svg&gt;</span>
  <span>&lt;/div&gt;</span>
<span>&lt;/div&gt;</span>
</code></pre></div>

<p>Now, I’m skipping over the SVG code here mostly because it’s just a <em>lot</em> of SVG for all those little lines in the compass rings, and really all you need is to copy-paste the code <a href="https://github.com/Pomax/are-we-flying/blob/main/public/map-marker.html">here</a> to keep following along. What’s more important is the updates we make to our CSS:</p>

<div><pre><code><span>#plane-icon</span> <span>{</span>
  <span>--speed</span><span>:</span> <span>120</span><span>;</span>       <span>/* our airspeed in knots, without a unit */</span>
  <span>--altitude</span><span>:</span> <span>1500</span><span>;</span>   <span>/* our altitude in feet, without a unit */</span>
  <span>--heading</span><span>:</span> <span>150</span><span>;</span>     <span>/* our magnetic compass heading in degrees, without a unit */</span>
  <span>--heading-bug</span><span>:</span> <span>220</span><span>;</span> <span>/* our "heading bug" compass indicator angle in degrees, without a unit */</span>
  <span>--north</span><span>:</span> <span>15.8</span><span>;</span>      <span>/* the compass deviation from true north in degrees, without a unit */</span>

  <span>--degrees</span><span>:</span> <span>calc</span><span>(</span><span>1deg</span> <span>*</span> <span>var</span><span>(</span><span>--heading</span><span>));</span>
  <span>--alt-em</span><span>:</span> <span>calc</span><span>(</span><span>sqrt</span><span>(</span><span>var</span><span>(</span><span>--altitude</span><span>))</span> <span>/</span> <span>20</span><span>);</span>

  <span>/* and a bit of value magic that scales the text based on the size of the marker */</span>
  <span>--f</span><span>:</span> <span>250</span><span>;</span>
  <span>--dim</span><span>:</span> <span>calc</span><span>(</span><span>var</span><span>(</span><span>--f</span><span>)</span> <span>*</span> <span>1px</span><span>);</span>
  <span>--font-size</span><span>:</span> <span>calc</span><span>(</span><span>var</span><span>(</span><span>--dim</span><span>)</span> <span>/</span> <span>17</span><span>);</span>

  <span>/* And we definitely want a sans-serif font for immediate legibility */</span>
  <span>font-family</span><span>:</span> <span>Arial</span><span>;</span>
  <span>font-size</span><span>:</span> <span>var</span><span>(</span><span>--font-size</span><span>);</span>
<span>}</span>

<span>/*
 And then a whole bunch of CSS that makes use of those variables
*/</span>
</code></pre></div>

<p>Again, if you want to follow along grab the CSS <a href="https://github.com/Pomax/are-we-flying/blob/main/public/css/map-marker.css">here</a>, but the important part is those new CSS variables, which we can update on the JS side based on the values we get from MSFS:</p>

<div><pre><code><span>...</span>

<span>import</span> <span>{</span> <span>getAirplaneSrc</span> <span>}</span> <span>from</span> <span>"</span><span>./airplane-src.js</span><span>"</span><span>;</span>
<span>const</span> <span>{</span> <span>abs</span><span>,</span> <span>sqrt</span> <span>}</span> <span>=</span> <span>Math</span><span>;</span>

<span>export</span> <span>class</span> <span>Plane</span> <span>{</span>

  <span>...</span>

  <span>/**
   * Our map update function is a little bigger now:
   */</span>
  <span>async</span> <span>updateMap</span><span>({</span> <span>model</span><span>:</span> <span>flightModel</span><span>,</span> <span>data</span><span>:</span> <span>flightData</span><span>,</span> <span>general</span> <span>})</span> <span>{</span>
    <span>if</span> <span>(</span><span>!</span><span>flightData</span><span>)</span> <span>return</span><span>;</span>
    <span>...</span>
    <span>map</span><span>.</span><span>setView</span><span>([</span><span>lat</span><span>,</span> <span>long</span><span>]);</span>

    <span>// And set some classes that let us show pause/crash states:</span>
    <span>const</span> <span>{</span> <span>paused</span><span>,</span> <span>crashed</span> <span>}</span> <span>=</span> <span>general</span><span>;</span>
    <span>planeIcon</span><span>.</span><span>classList</span><span>.</span><span>toggle</span><span>(</span><span>`paused`</span><span>,</span> <span>!!</span><span>paused</span><span>);</span>
    <span>planeIcon</span><span>.</span><span>classList</span><span>.</span><span>toggle</span><span>(</span><span>`crashed`</span><span>,</span> <span>!!</span><span>crashed</span><span>);</span>

    <span>// Also, make sure we're using the right silhouette image:</span>
    <span>const</span> <span>pic</span> <span>=</span> <span>getAirplaneSrc</span><span>(</span><span>flightModel</span><span>.</span><span>title</span><span>);</span>
    <span>[...</span><span>planeIcon</span><span>.</span><span>querySelectorAll</span><span>(</span><span>`img`</span><span>)].</span><span>forEach</span><span>(</span>
      <span>(</span><span>img</span><span>)</span> <span>=&gt;</span> <span>(</span><span>img</span><span>.</span><span>src</span> <span>=</span> <span>`planes/</span><span>${</span><span>pic</span><span>}</span><span>`</span><span>)</span>
    <span>);</span>

    <span>// Then update the marker's CSS variables and various text bits:</span>
    <span>this</span><span>.</span><span>updateMarker</span><span>(</span><span>planeIcon</span><span>,</span> <span>flightData</span><span>);</span>
  <span>}</span>

  <span>/**
   * Our marker update function is also little bigger now:
   */</span>
  <span>updateMarker</span><span>(</span><span>planeIcon</span><span>,</span> <span>flightData</span><span>)</span> <span>{</span>
    <span>const</span> <span>css</span> <span>=</span> <span>planeIcon</span><span>.</span><span>style</span><span>;</span>

    <span>const</span> <span>{</span> <span>alt</span><span>,</span> <span>headingBug</span><span>,</span> <span>groundAlt</span><span>,</span> <span>lift</span> <span>}</span> <span>=</span> <span>flightData</span><span>;</span>
    <span>const</span> <span>{</span> <span>heading</span><span>,</span> <span>speed</span><span>,</span> <span>trueHeading</span> <span>}</span> <span>=</span> <span>flightData</span><span>;</span>

    <span>css</span><span>.</span><span>setProperty</span><span>(</span><span>`--altitude`</span><span>,</span> <span>lift</span> <span>|</span> <span>0</span><span>);</span>
    <span>css</span><span>.</span><span>setProperty</span><span>(</span><span>`--sqrt-alt`</span><span>,</span> <span>sqrt</span><span>(</span><span>lift</span><span>)</span> <span>|</span> <span>0</span><span>);</span>
    <span>css</span><span>.</span><span>setProperty</span><span>(</span><span>`--speed`</span><span>,</span> <span>speed</span> <span>|</span> <span>0</span><span>);</span>
    <span>css</span><span>.</span><span>setProperty</span><span>(</span><span>`--north`</span><span>,</span> <span>trueHeading</span> <span>-</span> <span>heading</span><span>);</span>
    <span>css</span><span>.</span><span>setProperty</span><span>(</span><span>`--heading`</span><span>,</span> <span>heading</span><span>);</span>
    <span>css</span><span>.</span><span>setProperty</span><span>(</span><span>`--heading-bug`</span><span>,</span> <span>headingBug</span><span>);</span>

    <span>const</span> <span>altitudeText</span> <span>=</span> <span>(</span><span>groundAlt</span> <span>|</span> <span>0</span><span>)</span> <span>===</span> <span>0</span> <span>?</span> <span>`</span><span>${</span><span>alt</span> <span>|</span> <span>0</span><span>}</span><span>'`</span> <span>:</span> <span>`</span><span>${</span><span>lift</span> <span>|</span> <span>0</span><span>}</span><span>' (</span><span>${</span><span>alt</span> <span>|</span> <span>0</span><span>}</span><span>')`</span><span>;</span>
    <span>planeIcon</span><span>.</span><span>querySelector</span><span>(</span><span>`.alt`</span><span>).</span><span>textContent</span> <span>=</span> <span>altitudeText</span><span>;</span>
    <span>planeIcon</span><span>.</span><span>querySelector</span><span>(</span><span>`.speed`</span><span>).</span><span>textContent</span> <span>=</span> <span>`</span><span>${</span><span>speed</span> <span>|</span> <span>0</span><span>}</span><span>kts`</span><span>;</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And the final bit of the puzzle, <code>airplane-src.js</code>, for which we’re going to want to create a directory called <code>public/planes</code> so that we can fill it with plane icons, like these:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/plane-icons.png" alt="so many planes!"></p>

<p>And then we can swap the correct icon in, based on the plane we’re flying:</p>

<div><pre><code><span>export</span> <span>const</span> <span>defaultPlane</span> <span>=</span> <span>`plane.png`</span><span>;</span>

<span>export</span> <span>function</span> <span>getAirplaneSrc</span><span>(</span><span>title</span> <span>=</span> <span>``</span><span>)</span> <span>{</span>
  <span>let</span> <span>pic</span> <span>=</span> <span>defaultPlane</span><span>;</span>
  <span>let</span> <span>plane</span> <span>=</span> <span>title</span><span>.</span><span>toLowerCase</span><span>();</span>

  <span>// let's find our plane!</span>
  <span>if</span> <span>(</span><span>plane</span><span>.</span><span>includes</span><span>(</span><span>` 152`</span><span>))</span> <span>pic</span> <span>=</span> <span>`152.png`</span><span>;</span>
  <span>else</span> <span>if</span> <span>(</span><span>plane</span><span>.</span><span>includes</span><span>(</span><span>` 310`</span><span>))</span> <span>pic</span> <span>=</span> <span>`310.png`</span><span>;</span>
  <span>else</span> <span>if</span> <span>(</span><span>plane</span><span>.</span><span>includes</span><span>(</span><span>` beaver`</span><span>))</span> <span>pic</span> <span>=</span> <span>`beaver.png`</span><span>;</span>
  <span>else</span> <span>if</span> <span>(</span><span>plane</span><span>.</span><span>includes</span><span>(</span><span>` kodiak`</span><span>))</span> <span>pic</span> <span>=</span> <span>`kodiak.png`</span><span>;</span>
  <span>else</span> <span>if</span> <span>.....</span><span>you</span> <span>get</span> <span>the</span> <span>idea</span><span>...</span>

  <span>// And a quick check: is this the float plane variant?</span>
  <span>if</span> <span>(</span><span>plane</span><span>.</span><span>includes</span><span>(</span><span>`amphibian`</span><span>)</span> <span>||</span> <span>plane</span><span>.</span><span>includes</span><span>(</span><span>`float`</span><span>))</span> <span>{</span>
    <span>pic</span> <span>=</span> <span>pic</span><span>.</span><span>replace</span><span>(</span><span>`.png`</span><span>,</span> <span>`-float.png`</span><span>);</span>
  <span>}</span>

  <span>// Done, return the appropriate icon. Or just `plane.png` if we don't have this plane in our list.</span>
  <span>return</span> <span>pic</span><span>;</span>
<span>}</span>
</code></pre></div>

<p>And that’ll do it. Let’s fire up MSFS, load a plane into the world, and let’s see what that looks like!</p>

<p><img src="https://pomax.github.io/are-we-flying/images/page/marker-on-map.png" alt="A map with our marker on it"></p>

<p>That’s looking pretty good!</p>

<p><strong>“Oh, yeah that looks cool! But hold up… why are there <em>two</em> compasses?”</strong> —you, hopefully (again)</p>

<p>Yeah, so, here’s a fun thing about our planet: you’d think magnetic lines run north to south, like those pictures of metal filings around a magnet… which they would, if the Earth was a bar-magnet-sized magnet. Instead, it’s an <em>absolutely huge</em> and highly imperfect magnet, so if we look at a picture of “how wrong a magnet wrt true north/south anywhere on the planet”, things look like this:</p>

<figure>
    <a href="https://en.wikipedia.org/wiki/File:World_Magnetic_Declination_2015.pdf">
      <img src="https://pomax.github.io/are-we-flying/images/page/declination.png">
    </a>
    <figcaption>A map of the magnetic declination on planet Earth</figcaption>
</figure>

<p>The green lines are where a compass will <em>actually</em> point north, but everywhere else on the planet your compass will be off by various degrees. For example, it’s only a tiny bit off if you’re in Belgium, but at the south tip of the border between Alaska and Canada, your compass will be a pointing a whopping 20 degrees away from true north. When you’re flying a plane, you’d better be aware of that, and you better know which of your instruments use compass heading, and which of them use true heading, or you might not get to where you thought you were going.</p>

<h3 id="seeing-the-terrain">Seeing the terrain</h3>

<p>So… this looks good, but we’re missing one thing: terrain. Maps might be flat, but the world isn’t, and when we’re flying we’d like to know where the hills and mountains are so we can either avoid them, or plan accordingly. So let’s add a terrain layer to our map by updating our <code>maps.js</code>:</p>

<div><pre><code><span>import</span> <span>{</span> <span>waitFor</span> <span>}</span> <span>from</span> <span>"</span><span>./utils.js</span><span>"</span><span>;</span>

<span>export</span> <span>const</span> <span>DUNCAN_AIRPORT</span> <span>=</span> <span>[</span><span>48.7566</span><span>,</span> <span>-</span><span>123.71134</span><span>];</span>

<span>// Leaflet creates a global "L" object to work with, so use that to tie into the &lt;div id="map"&gt;&lt;/div&gt; we have sitting</span>
<span>// in our index.html. However, because independent page scripts can't be imported, we need to wait for it to be available:</span>
<span>const</span> <span>L</span> <span>=</span> <span>await</span> <span>waitFor</span><span>(</span><span>async</span> <span>()</span> <span>=&gt;</span> <span>window</span><span>.</span><span>L</span><span>);</span>

<span>// With our "L" object available, let's make a map, centered on Duncan airport:</span>
<span>export</span> <span>const</span> <span>map</span> <span>=</span> <span>L</span><span>.</span><span>map</span><span>(</span><span>"</span><span>map</span><span>"</span><span>).</span><span>setView</span><span>(</span><span>DUNCAN_AIRPORT</span><span>,</span> <span>15</span><span>);</span>

<span>// Let's make our layers a little more "data driven" by first defining a list of sources:</span>
<span>const</span> <span>sources</span> <span>=</span> <span>[</span>
  <span>{</span>
    <span>name</span><span>:</span> <span>`openStreetMap`</span><span>,</span>
    <span>url</span><span>:</span> <span>`https://tile.openstreetmap.org/{z}/{x}/{y}.png`</span><span>,</span>
    <span>maxZoom</span><span>:</span> <span>19</span><span>,</span>
    <span>attribution</span><span>:</span> <span>{</span>
      <span>url</span><span>:</span> <span>`http://www.openstreetmap.org/copyright`</span><span>,</span>
      <span>label</span><span>:</span> <span>`OpenStreetMap`</span><span>,</span>
    <span>},</span>
  <span>},</span>
  <span>{</span>
    <span>name</span><span>:</span> <span>`googleTerrain`</span><span>,</span>
    <span>url</span><span>:</span> <span>`http://{s}.google.com/vt/lyrs=p&amp;x={x}&amp;y={y}&amp;z={z}`</span><span>,</span>
    <span>subdomains</span><span>:</span> <span>[</span><span>"</span><span>mt0</span><span>"</span><span>,</span> <span>"</span><span>mt1</span><span>"</span><span>,</span> <span>"</span><span>mt2</span><span>"</span><span>,</span> <span>"</span><span>mt3</span><span>"</span><span>],</span>
    <span>maxZoom</span><span>:</span> <span>20</span><span>,</span>
    <span>attribution</span><span>:</span> <span>{</span>
      <span>url</span><span>:</span> <span>`https://www.google.com/permissions/geoguidelines`</span><span>,</span>
      <span>label</span><span>:</span> <span>`Google Maps`</span><span>,</span>
    <span>},</span>
  <span>},</span>
<span>];</span>

<span>// and then converting those to map layers:</span>
<span>const</span> <span>mapLayers</span> <span>=</span> <span>Object</span><span>.</span><span>fromEntries</span><span>(</span>
  <span>sources</span><span>.</span><span>map</span><span>((</span><span>e</span><span>)</span> <span>=&gt;</span> <span>[</span>
    <span>e</span><span>.</span><span>name</span><span>,</span>
    <span>L</span><span>.</span><span>tileLayer</span><span>(</span><span>e</span><span>.</span><span>url</span><span>,</span> <span>{</span>
      <span>subdomains</span><span>:</span> <span>e</span><span>.</span><span>subdomains</span> <span>??</span> <span>[],</span>
      <span>maxZoom</span><span>:</span> <span>e</span><span>.</span><span>maxZoom</span><span>,</span>
      <span>attribution</span><span>:</span> <span>`© &lt;a href="</span><span>${</span><span>e</span><span>.</span><span>attribution</span><span>.</span><span>url</span><span>}</span><span>"&gt;</span><span>${</span><span>e</span><span>.</span><span>attribution</span><span>.</span><span>label</span><span>}</span><span>&lt;/a&gt;`</span><span>,</span>
    <span>}),</span>
  <span>])</span>
<span>);</span>

<span>// We'll keep the openstreetmap layer as base layer:</span>
<span>mapLayers</span><span>.</span><span>openStreetMap</span><span>.</span><span>setOpacity</span><span>(</span><span>1</span><span>);</span>
<span>mapLayers</span><span>.</span><span>openStreetMap</span><span>.</span><span>addTo</span><span>(</span><span>map</span><span>);</span>

<span>// And then we'll add the terrain layer as 50% opacity overlay:</span>
<span>mapLayers</span><span>.</span><span>googleTerrain</span><span>.</span><span>setOpacity</span><span>(</span><span>0.5</span><span>);</span>
<span>mapLayers</span><span>.</span><span>googleTerrain</span><span>.</span><span>addTo</span><span>(</span><span>map</span><span>);</span>
</code></pre></div>

<p>And now our map looks <strong><em>amazing</em></strong>:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/page/map-with-terrain.png" alt="Our map, now with terrain!"></p>

<h3 id="adding-scale-to-our-map">Adding scale to our map</h3>

<p>One last thing: we have no idea what the scale of this map is, so normally that involves telling Leaflet to add the standard scale legend, but Leaflet only knows about standard miles, and kilometers, which is not super useful when you’re flying and everything’s measured in nautical miles. So I guess we’re writing our own scale code by creating a little Leaflet plugin called <code>public/js/leaflet/nautical.js</code>:</p>

<div><pre><code><span>// Based on https://github.com/PowerPan/leaflet.nauticscale/blob/master/dist/leaflet.nauticscale.js</span>
<span>import</span> <span>{</span> <span>waitFor</span> <span>}</span> <span>from</span> <span>"</span><span>../utils.js</span><span>"</span><span>;</span>

<span>// We first need to wait for Leaflet...</span>
<span>const</span> <span>L</span> <span>=</span> <span>await</span> <span>waitFor</span><span>(</span><span>async</span> <span>()</span> <span>=&gt;</span> <span>window</span><span>.</span><span>L</span><span>);</span>

<span>// Then we can define a new Leaflet control that extends the base Leaflet scale visualization:</span>
<span>L</span><span>.</span><span>Control</span><span>.</span><span>ScaleNautical</span> <span>=</span> <span>L</span><span>.</span><span>Control</span><span>.</span><span>Scale</span><span>.</span><span>extend</span><span>({</span>
  <span>options</span><span>:</span> <span>{</span> <span>nautical</span><span>:</span> <span>false</span> <span>},</span>
  <span>_addScales</span><span>:</span> <span>function</span> <span>(</span><span>options</span><span>,</span> <span>className</span><span>,</span> <span>container</span><span>)</span> <span>{</span>
    <span>L</span><span>.</span><span>Control</span><span>.</span><span>Scale</span><span>.</span><span>prototype</span><span>.</span><span>_addScales</span><span>.</span><span>call</span><span>(</span>
      <span>this</span><span>,</span>
      <span>options</span><span>,</span>
      <span>className</span><span>,</span>
      <span>container</span>
    <span>);</span>
    <span>L</span><span>.</span><span>setOptions</span><span>(</span><span>options</span><span>);</span>
    <span>if</span> <span>(</span><span>this</span><span>.</span><span>options</span><span>.</span><span>nautical</span><span>)</span>
      <span>this</span><span>.</span><span>_nScale</span> <span>=</span> <span>L</span><span>.</span><span>DomUtil</span><span>.</span><span>create</span><span>(</span><span>"</span><span>div</span><span>"</span><span>,</span> <span>className</span><span>,</span> <span>container</span><span>);</span>
  <span>},</span>
  <span>_updateScales</span><span>:</span> <span>function</span> <span>(</span><span>maxMeters</span><span>)</span> <span>{</span>
    <span>L</span><span>.</span><span>Control</span><span>.</span><span>Scale</span><span>.</span><span>prototype</span><span>.</span><span>_updateScales</span><span>.</span><span>call</span><span>(</span><span>this</span><span>,</span> <span>maxMeters</span><span>);</span>
    <span>if</span> <span>(</span><span>this</span><span>.</span><span>options</span><span>.</span><span>nautical</span> <span>&amp;&amp;</span> <span>maxMeters</span><span>)</span> <span>{</span>
      <span>this</span><span>.</span><span>_updateNautical</span><span>(</span><span>maxMeters</span><span>);</span>
    <span>}</span>
  <span>},</span>
  <span>_updateNautical</span><span>:</span> <span>function</span> <span>(</span><span>maxMeters</span><span>)</span> <span>{</span>
    <span>const</span> <span>scale</span> <span>=</span> <span>this</span><span>.</span><span>_nScale</span><span>;</span>
    <span>const</span> <span>maxNauticalMiles</span> <span>=</span> <span>maxMeters</span> <span>/</span> <span>1852</span><span>;</span>
    <span>let</span> <span>nauticalMiles</span><span>;</span>
    <span>if</span> <span>(</span><span>maxMeters</span> <span>&gt;=</span> <span>1852</span><span>)</span> <span>{</span>
      <span>nauticalMiles</span> <span>=</span> <span>L</span><span>.</span><span>Control</span><span>.</span><span>Scale</span><span>.</span><span>prototype</span><span>.</span><span>_getRoundNum</span><span>.</span><span>call</span><span>(</span>
        <span>this</span><span>,</span>
        <span>maxNauticalMiles</span>
      <span>);</span>
    <span>}</span> <span>else</span> <span>{</span>
      <span>nauticalMiles</span> <span>=</span> <span>maxNauticalMiles</span><span>.</span><span>toFixed</span><span>(</span><span>maxNauticalMiles</span> <span>&gt;</span> <span>0.1</span> <span>?</span> <span>1</span> <span>:</span> <span>0</span><span>);</span>
    <span>}</span>
    <span>const</span> <span>scaleWidth</span> <span>=</span> <span>(</span>
      <span>this</span><span>.</span><span>options</span><span>.</span><span>maxWidth</span> <span>*</span>
      <span>(</span><span>nauticalMiles</span> <span>/</span> <span>maxNauticalMiles</span><span>)</span>
    <span>).</span><span>toFixed</span><span>(</span><span>0</span><span>);</span>
    <span>scale</span><span>.</span><span>style</span><span>.</span><span>width</span> <span>=</span> <span>`</span><span>${</span><span>scaleWidth</span> <span>-</span> <span>10</span><span>}</span><span>px`</span><span>;</span>
    <span>scale</span><span>.</span><span>textContent</span> <span>=</span> <span>`</span><span>${</span><span>nauticalMiles</span><span>}</span><span> nm`</span><span>;</span>
  <span>},</span>
<span>});</span>

<span>L</span><span>.</span><span>control</span><span>.</span><span>scaleNautical</span> <span>=</span> <span>(</span><span>options</span><span>)</span> <span>=&gt;</span> <span>new</span> <span>L</span><span>.</span><span>Control</span><span>.</span><span>ScaleNautical</span><span>(</span><span>options</span><span>);</span>

<span>export</span> <span>function</span> <span>setMapScale</span><span>(</span>
  <span>map</span><span>,</span>
  <span>metric</span> <span>=</span> <span>true</span><span>,</span>
  <span>imperial</span> <span>=</span> <span>false</span><span>,</span>
  <span>nautical</span> <span>=</span> <span>true</span>
<span>)</span> <span>{</span>
  <span>L</span><span>.</span><span>control</span><span>.</span><span>scaleNautical</span><span>({</span> <span>metric</span><span>,</span> <span>imperial</span><span>,</span> <span>nautical</span> <span>}).</span><span>addTo</span><span>(</span><span>map</span><span>);</span>
<span>}</span>
</code></pre></div>

<p>How this code works isn’t super important, but what it does when we use it, is: if we update our <code>maps.js</code> file as follows:</p>

<div><pre><code><span>import</span> <span>{</span> <span>waitFor</span> <span>}</span> <span>from</span> <span>"</span><span>./utils.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>setMapScale</span> <span>}</span> <span>from</span> <span>"</span><span>./leaflet/nautical.js</span><span>"</span><span>;</span>

<span>...</span>

<span>// add our scale</span>
<span>setMapScale</span><span>(</span><span>map</span><span>);</span>
</code></pre></div>

<p>And we refresh our browser, we now have a handy-dandy scale marker in the lower left corner:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/page/map-with-scale.png" alt="now with scale"></p>

<p>And now we know how long it’ll take us to get places, because as dumb as knots and miles may seem, their relation is extremely simple: a speed of 1 knot means you’re going 1 nautical mile per hour. If we’re going at 120 knots, then we’ll cover 120 nautical miles an hour, or 1 nautical mile every thirty seconds.</p>

<h2 id="recording-our-flight-path">Recording our flight path</h2>

<p>Seeing ourselves flying around on the map is pretty great, but right now we can only see “where we are”, instead of seeing where we’ve come from. As it turns out, Leaflet supports drawing polygons, so let’s also add some “flight tracking” to our web page (not in the least because it’s something that will be pretty important for debugging autopilot code later!).</p>

<p>First, we create a little <code>public/js/trail.js</code> class because you know how this works by now, new code gets its own file:</p>

<div><pre><code><span>export</span> <span>class</span> <span>Trail</span> <span>{</span>
  <span>// The constructor isn't particularly interesting...</span>
  <span>constructor</span><span>(</span><span>map</span><span>,</span> <span>pair</span><span>,</span> <span>color</span><span>,</span> <span>opts</span> <span>=</span> <span>{})</span> <span>{</span>
    <span>this</span><span>.</span><span>coords</span> <span>=</span> <span>[];</span>
    <span>this</span><span>.</span><span>map</span> <span>=</span> <span>map</span><span>;</span>
    <span>if</span> <span>(</span><span>pair</span><span>)</span> <span>this</span><span>.</span><span>add</span><span>(...</span><span>pair</span><span>);</span>
    <span>this</span><span>.</span><span>color</span> <span>=</span> <span>color</span> <span>??</span> <span>`blue`</span><span>;</span>
    <span>this</span><span>.</span><span>opts</span> <span>=</span> <span>opts</span><span>;</span>
    <span>this</span><span>.</span><span>line</span> <span>=</span> <span>undefined</span><span>;</span>
  <span>}</span>

  <span>// but the "add" function is, because it's the code that actually</span>
  <span>// draws our trail onto the map once we have 2 coordinates, and</span>
  <span>// then updates it by adding points to the trail during flight.</span>
  <span>add</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>!</span><span>lat</span> <span>&amp;&amp;</span> <span>!</span><span>long</span><span>)</span> <span>return</span><span>;</span>

    <span>const</span> <span>{</span> <span>coords</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>const</span> <span>pair</span> <span>=</span> <span>[</span><span>lat</span><span>,</span> <span>long</span><span>];</span>
    <span>coords</span><span>.</span><span>push</span><span>(</span><span>pair</span><span>);</span>

    <span>// If we have fewer than 2 points, we can't draw a trail yet!</span>
    <span>const</span> <span>l</span> <span>=</span> <span>coords</span><span>.</span><span>length</span><span>;</span>
    <span>if</span> <span>(</span><span>l</span> <span>&lt;</span> <span>2</span><span>)</span> <span>return</span><span>;</span>

    <span>// If we have exactly 2 points, we create the trail polyon</span>
    <span>// and add it to the map:</span>
    <span>if</span> <span>(</span><span>l</span> <span>===</span> <span>2</span><span>)</span> <span>{</span>
      <span>this</span><span>.</span><span>line</span> <span>=</span> <span>L</span><span>.</span><span>polyline</span><span>([...</span><span>coords</span><span>],</span> <span>{</span>
        <span>className</span><span>:</span> <span>`flight-trail`</span><span>,</span>
        <span>color</span><span>:</span> <span>this</span><span>.</span><span>color</span><span>,</span>
        <span>...</span><span>this</span><span>.</span><span>opts</span><span>,</span>
      <span>});</span>
      <span>return</span> <span>this</span><span>.</span><span>line</span><span>.</span><span>addTo</span><span>(</span><span>this</span><span>.</span><span>map</span><span>);</span>
    <span>}</span>

    <span>// And if we have more than 2 points, all we need to do is</span>
    <span>// add the new point to the polygon that Leafet's working with.</span>
    <span>this</span><span>.</span><span>line</span><span>.</span><span>addLatLng</span><span>(</span><span>pair</span><span>);</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>Really all this does is wrap some of the administrative functionality for tracking position over time, so that we can just create a <code>Trail</code> instance, and add points to it and it’ll do the right thing. For instance, it’s not going to do anything until there are two points to draw a line with. That’s not code we want to constantly have to remember we need to write.</p>

<p>So with that class set up, let’s update <code>plane.js</code> some more:</p>

<div><pre><code><span>import</span> <span>{</span> <span>Trail</span> <span>}</span> <span>from</span> <span>"</span><span>./trail.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>getDistanceBetweenPoints</span> <span>}</span> <span>from</span> <span>"</span><span>./utils.js</span><span>"</span><span>;</span>

<span>...</span>

<span>export</span> <span>class</span> <span>Plane</span> <span>{</span>
  <span>...</span>

  <span>/**
   * A little helper function for tracking "the current trail", because we
   * can restart flights as much as we want (voluntarily, or because we
   * crashed) and those new flights should all get their own trail:
   */</span>
  <span>startNewTrail</span><span>(</span><span>location</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>trail</span> <span>=</span> <span>new</span> <span>Trail</span><span>(</span><span>this</span><span>.</span><span>map</span><span>,</span> <span>location</span><span>);</span>
  <span>}</span>

  <span>/**
   * We're well-acquainted with this function by now:
   */</span>
  <span>async</span> <span>updateState</span><span>(</span><span>state</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>state</span> <span>=</span> <span>state</span><span>;</span>
    <span>const</span> <span>now</span> <span>=</span> <span>Date</span><span>.</span><span>now</span><span>();</span>
    <span>Questions</span><span>.</span><span>update</span><span>(</span><span>state</span><span>);</span>

    <span>// Check if we started a new flight because that requires</span>
    <span>// immediately building a new flight trail:</span>
    <span>try</span> <span>{</span>
       <span>const</span> <span>{</span> <span>flying</span><span>:</span> <span>wasFlying</span> <span>}</span> <span>=</span> <span>this</span><span>.</span><span>lastUpdate</span><span>.</span><span>flightInformation</span><span>.</span><span>general</span><span>;</span>
      <span>const</span> <span>{</span> <span>flying</span> <span>}</span> <span>=</span> <span>this</span><span>.</span><span>state</span><span>.</span><span>flightInformation</span><span>.</span><span>general</span><span>;</span>
      <span>const</span> <span>startedFlying</span> <span>=</span> <span>!</span><span>wasFlying</span> <span>&amp;&amp;</span> <span>flying</span><span>;</span>
      <span>if</span> <span>(</span><span>startedFlying</span><span>)</span> <span>this</span><span>.</span><span>startNewTrail</span><span>();</span>
    <span>}</span> <span>catch</span> <span>(</span><span>e</span><span>)</span> <span>{</span>
      <span>// this will fail if we don't have lastUpdate yet, and that's fine.</span>
    <span>}</span>

    <span>// And then update our map.</span>
    <span>this</span><span>.</span><span>updateMap</span><span>(</span><span>state</span><span>.</span><span>flightInformation</span><span>);</span>

    <span>this</span><span>.</span><span>lastUpdate</span> <span>=</span> <span>{</span> <span>time</span><span>:</span> <span>now</span><span>,</span> <span>...</span><span>state</span> <span>};</span>
  <span>}</span>

  <span>async</span> <span>updateMap</span><span>({</span> <span>model</span><span>:</span> <span>flightModel</span><span>,</span> <span>data</span><span>:</span> <span>flightData</span><span>,</span> <span>general</span> <span>})</span> <span>{</span>
    <span>if</span> <span>(</span><span>!</span><span>flightData</span><span>)</span> <span>return</span><span>;</span>

    <span>const</span> <span>{</span> <span>map</span><span>,</span> <span>marker</span><span>,</span> <span>planeIcon</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>const</span> <span>{</span> <span>lat</span><span>,</span> <span>long</span> <span>}</span> <span>=</span> <span>flightData</span><span>;</span>
    <span>if</span> <span>(</span><span>lat</span> <span>===</span> <span>undefined</span> <span>||</span> <span>long</span> <span>===</span> <span>undefined</span><span>)</span> <span>return</span><span>;</span>
    <span>if</span> <span>(</span><span>abs</span><span>(</span><span>lat</span><span>)</span> <span>&lt;</span> <span>0.1</span> <span>&amp;&amp;</span> <span>abs</span><span>(</span><span>long</span><span>)</span> <span>&lt;</span> <span>0.1</span><span>)</span> <span>return</span><span>;</span>

    <span>try</span> <span>{</span>
      <span>// First off: did we teleport? E.g. did the plane's position change</span>
      <span>// impossibly fast, due to restarting a flight, or by using the</span>
      <span>// "teleport" function in Parallel 42's "Flow" add-on, etc? Because</span>
      <span>// if so, we need to start a new trail.</span>
      <span>const</span> <span>{</span> <span>lat</span><span>:</span> <span>lat2</span><span>,</span> <span>long</span><span>:</span> <span>long2</span> <span>}</span> <span>=</span> <span>this</span><span>.</span><span>lastUpdate</span><span>.</span><span>flightInformation</span><span>.</span><span>data</span><span>;</span>
      <span>const</span> <span>d</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>lat2</span><span>,</span> <span>long2</span><span>);</span>
      <span>const</span> <span>kmps</span> <span>=</span> <span>(</span><span>speed</span> <span>??</span> <span>0</span><span>)</span> <span>/</span> <span>1944</span><span>;</span>

      <span>// We'll call ourselves "teleported" if we moved at a speed of over</span>
      <span>// 5 kilometers per second (3.1 miles per second), which is roughly</span>
      <span>// equivalent to mach 14.5, which is a little over half the orbital</span>
      <span>// speed of the international space station.</span>
      <span>const</span> <span>teleported</span> <span>=</span> <span>this</span><span>.</span><span>lastUpdate</span><span>.</span><span>flightData</span> <span>&amp;&amp;</span> <span>d</span> <span>&gt;</span> <span>5</span> <span>*</span> <span>kmps</span><span>;</span>
      <span>if</span> <span>(</span><span>teleported</span><span>)</span> <span>this</span><span>.</span><span>startNewTrail</span><span>([</span><span>lat</span><span>,</span> <span>long</span><span>]);</span>
    <span>}</span> <span>catch</span> <span>(</span><span>e</span><span>)</span> <span>{</span>
      <span>// this will als fail if we don't have lastUpdate yet, and that's still fine.</span>
    <span>}</span>

    <span>// With all that done, we can add the current position to our current trail:</span>
    <span>if</span> <span>(</span><span>!</span><span>this</span><span>.</span><span>trail</span><span>)</span> <span>this</span><span>.</span><span>startNewTrail</span><span>([</span><span>lat</span><span>,</span> <span>long</span><span>]);</span>
    <span>this</span><span>.</span><span>trail</span><span>.</span><span>add</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>);</span>

    <span>...</span>
  <span>}</span>

   <span>...</span>
<span>}</span>
</code></pre></div>

<p>With the <code>getDistanceBetweenPoints</code> in utils:</p>

<div><pre><code><span>const</span> <span>{</span> <span>sin</span><span>,</span> <span>cos</span><span>,</span> <span>atan2</span><span>,</span> <span>sqrt</span> <span>}</span> <span>=</span> <span>Math</span><span>;</span>

<span>...</span>

<span>export</span> <span>function</span> <span>radians</span><span>(</span><span>deg</span><span>)</span> <span>{</span>
  <span>return</span> <span>(</span><span>deg</span> <span>/</span> <span>180</span><span>)</span> <span>*</span> <span>PI</span><span>;</span>
<span>}</span>

<span>export</span> <span>function</span> <span>degrees</span><span>(</span><span>rad</span><span>)</span> <span>{</span>
  <span>return</span> <span>(</span><span>rad</span> <span>/</span> <span>PI</span><span>)</span> <span>*</span> <span>180</span><span>;</span>
<span>}</span>

<span>export</span> <span>function</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat1</span><span>,</span> <span>long1</span><span>,</span> <span>lat2</span><span>,</span> <span>long2</span><span>,</span> <span>R</span> <span>=</span> <span>6371</span><span>)</span> <span>{</span>
  <span>// see https://stackoverflow.com/a/365853/740553</span>

  <span>lat1</span> <span>=</span> <span>parseFloat</span><span>(</span><span>lat1</span><span>);</span>
  <span>long1</span> <span>=</span> <span>parseFloat</span><span>(</span><span>long1</span><span>);</span>
  <span>lat2</span> <span>=</span> <span>parseFloat</span><span>(</span><span>lat2</span><span>);</span> <span>// do we still need parseFloat here?</span>
  <span>long2</span> <span>=</span> <span>parseFloat</span><span>(</span><span>long2</span><span>);</span>

  <span>const</span> <span>dLat</span> <span>=</span> <span>radians</span><span>(</span><span>lat2</span> <span>-</span> <span>lat1</span><span>);</span>
  <span>const</span> <span>dLong</span> <span>=</span> <span>radians</span><span>(</span><span>long2</span> <span>-</span> <span>long1</span><span>);</span>
  <span>lat1</span> <span>=</span> <span>radians</span><span>(</span><span>lat1</span><span>);</span>
  <span>lat2</span> <span>=</span> <span>radians</span><span>(</span><span>lat2</span><span>);</span>

  <span>const</span> <span>a</span> <span>=</span>
    <span>sin</span><span>(</span><span>dLat</span> <span>/</span> <span>2</span><span>)</span> <span>*</span> <span>sin</span><span>(</span><span>dLat</span> <span>/</span> <span>2</span><span>)</span> <span>+</span>
    <span>sin</span><span>(</span><span>dLong</span> <span>/</span> <span>2</span><span>)</span> <span>*</span> <span>sin</span><span>(</span><span>dLong</span> <span>/</span> <span>2</span><span>)</span> <span>*</span> <span>cos</span><span>(</span><span>lat1</span><span>)</span> <span>*</span> <span>cos</span><span>(</span><span>lat2</span><span>);</span>
  <span>const</span> <span>c</span> <span>=</span> <span>2</span> <span>*</span> <span>atan2</span><span>(</span><span>sqrt</span><span>(</span><span>a</span><span>),</span> <span>sqrt</span><span>(</span><span>1</span> <span>-</span> <span>a</span><span>));</span>
  <span>return</span> <span>R</span> <span>*</span> <span>c</span><span>;</span>
<span>}</span>
</code></pre></div>

<p>A reasonably small bit of extra code, for a profound improvement:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/page/map-with-flightpath.png" alt="Now we know where we came from"></p>

<p>Now we don’t just know where we are, also also where we’ve been!</p>

<h2 id="planes-with-attitude">Planes with attitude</h2>

<p>There’s one thing our fancy marker isn’t showing though, which is the current roll and pitch, which would be really nice to be able to see. So… let’s build an <a href="https://en.wikipedia.org/wiki/Attitude_indicator">attitude indicator</a>, also sometimes called an “artificial horizon”:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/page/attitude.png" alt="now with attitude"></p>

<p>This is a way to visualize whether the plane is pitching up, down, or is flying level, as well as showing whether we’re turning left, right, or flying straight. It’s a critical part of the cockpit, and it would be very nice if we could see one at all times, too. So just like before, let’s whip up a bit of HTML, SVG, CSS, and JS to make that happen.</p>

<p>First an update to <code>index.html</code> so that there’s a place for the attitude indictor:</p>

<div><pre><code><span>&lt;div</span> <span>id=</span><span>"visualization"</span><span>&gt;</span>
  <span>&lt;div</span> <span>id=</span><span>"map"</span> <span>style=</span><span>"width: 1200px; height: 800px"</span><span>&gt;&lt;/div&gt;</span>
  <span>&lt;div</span> <span>id=</span><span>"attitude"</span> <span>data-description=</span><span>"Templated from attitude.html"</span><span>&gt;&lt;/div&gt;</span>
<span>&lt;/div&gt;</span>
</code></pre></div>

<p>And then the attitude indicator itself. Thankfully, this will be considerably less code than the airplane marker, so let’s create a <code>public/attitude.html</code>:</p>

<div><pre><code><span>&lt;div</span> <span>id=</span><span>"attitude"</span><span>&gt;</span>
  <span>&lt;div</span> <span>class=</span><span>"frame"</span><span>&gt;</span>
    <span>&lt;link</span> <span>rel=</span><span>"stylesheet"</span> <span>href=</span><span>"/css/attitude.css"</span> <span>/&gt;</span>

    <span>&lt;div</span> <span>class=</span><span>"inner-shadow"</span><span>&gt;&lt;/div&gt;</span>
    <span>&lt;div</span> <span>class=</span><span>"sky"</span><span>&gt;&lt;/div&gt;</span>
    <span>&lt;div</span> <span>class=</span><span>"ground"</span><span>&gt;&lt;/div&gt;</span>

    <span>&lt;div</span> <span>class=</span><span>"scales"</span><span>&gt;</span>
      <span>&lt;hr</span> <span>/&gt;</span>
      <span>&lt;hr</span> <span>class=</span><span>"minor small"</span> <span>/&gt;</span>
      <span>&lt;hr</span> <span>class=</span><span>"minor small"</span> <span>/&gt;</span>
      <span>&lt;hr</span> <span>/&gt;</span>
      <span>&lt;hr</span> <span>class=</span><span>"small"</span> <span>/&gt;</span>
      <span>&lt;hr</span> <span>class=</span><span>"small"</span> <span>/&gt;</span>
      <span>&lt;hr</span> <span>/&gt;</span>
      <span>&lt;hr</span> <span>class=</span><span>"small"</span> <span>/&gt;</span>
      <span>&lt;hr</span> <span>class=</span><span>"small"</span> <span>/&gt;</span>
      <span>&lt;hr</span> <span>/&gt;</span>
      <span>&lt;hr</span> <span>class=</span><span>"minor small"</span> <span>/&gt;</span>
      <span>&lt;hr</span> <span>class=</span><span>"minor small"</span> <span>/&gt;</span>
      <span>&lt;hr</span> <span>/&gt;</span>
      <span>&lt;hr</span> <span>/&gt;</span>
      <span>&lt;div</span> <span>class=</span><span>"center-mark"</span><span>&gt;&lt;/div&gt;</span>
      <span>&lt;div</span> <span>class=</span><span>"sky"</span><span>&gt;&lt;/div&gt;</span>
      <span>&lt;div</span> <span>class=</span><span>"ground"</span><span>&gt;&lt;/div&gt;</span>
    <span>&lt;/div&gt;</span>

    <span>&lt;div</span> <span>class=</span><span>"box"</span><span>&gt;</span>
      <span>&lt;div</span> <span>class=</span><span>"bug"</span><span>&gt;&lt;/div&gt;</span>
      <span>&lt;div</span> <span>class=</span><span>"gyro"</span><span>&gt;</span>
        <span>&lt;div</span> <span>class=</span><span>"sky"</span><span>&gt;</span>
          <span>&lt;hr</span> <span>class=</span><span>"pitch-marker small"</span> <span>/&gt;</span>
          <span>&lt;hr</span> <span>class=</span><span>"pitch-marker"</span> <span>/&gt;</span>
          <span>&lt;hr</span> <span>class=</span><span>"pitch-marker small"</span> <span>/&gt;</span>
          <span>&lt;hr</span> <span>class=</span><span>"pitch-marker"</span> <span>/&gt;</span>
        <span>&lt;/div&gt;</span>
        <span>&lt;div</span> <span>class=</span><span>"ground"</span><span>&gt;</span>
          <span>&lt;hr</span> <span>class=</span><span>"pitch-marker small"</span> <span>/&gt;</span>
          <span>&lt;hr</span> <span>class=</span><span>"pitch-marker"</span> <span>/&gt;</span>
          <span>&lt;hr</span> <span>class=</span><span>"pitch-marker small"</span> <span>/&gt;</span>
          <span>&lt;hr</span> <span>class=</span><span>"pitch-marker"</span> <span>/&gt;</span>
        <span>&lt;/div&gt;</span>
        <span>&lt;div</span> <span>class=</span><span>"box-shadow"</span><span>&gt;&lt;/div&gt;</span>
      <span>&lt;/div&gt;</span>
    <span>&lt;/div&gt;</span>

    <span>&lt;div</span> <span>class=</span><span>"bird"</span><span>&gt;</span>
      <span>&lt;hr/&gt;&lt;hr/&gt;&lt;hr/&gt;&lt;hr/&gt;&lt;hr/&gt;</span>
    <span>&lt;/div&gt;</span>
  <span>&lt;/div&gt;</span>
<span>&lt;/div&gt;</span>
</code></pre></div>

<p>With… okay, quite a <em>lot</em> of CSS, so have a look <a href="https://github.com/Pomax/are-we-flying/blob/main/public/css/attitude.css">here</a> if you’re following along, I’ll just highlight the important part here, which is (of course) the CSS variables section:</p>

<div><pre><code><span>#attitude</span> <span>{</span>
  <span>--bank</span><span>:</span> <span>0</span><span>;</span>
  <span>--pitch</span><span>:</span> <span>0</span><span>;</span>
  <span>--safety-pad</span><span>:</span> <span>-5%</span><span>;</span>
  <span>--frame-pad</span><span>:</span> <span>7%</span><span>;</span>
  <span>--box-pad</span><span>:</span> <span>5%</span><span>;</span>
  <span>--active-pad</span><span>:</span> <span>10%</span><span>;</span>
  <span>--dial-space</span><span>:</span> <span>3px</span><span>;</span>
  <span>...</span>
<span>}</span>

<span>...</span>

<span>#attitude</span> <span>.box</span> <span>.gyro</span> <span>.sky</span> <span>{</span>
  <span>position</span><span>:</span> <span>absolute</span><span>;</span>
  <span>top</span><span>:</span> <span>0</span><span>;</span>
  <span>bottom</span><span>:</span> <span>calc</span><span>(</span><span>48%</span> <span>+</span> <span>calc</span><span>(</span><span>1%</span> <span>*</span> <span>var</span><span>(</span><span>--pitch</span><span>)));</span>
  <span>left</span><span>:</span> <span>0</span><span>;</span>
  <span>right</span><span>:</span> <span>0</span><span>;</span>
<span>}</span>

<span>...</span>
</code></pre></div>

<p>And then we create a little <code>public/js/attitude.js</code> file to help us inject and update that:</p>

<div><pre><code><span>const</span> <span>content</span> <span>=</span> <span>await</span> <span>fetch</span><span>(</span><span>"</span><span>attitude.html</span><span>"</span><span>).</span><span>then</span><span>((</span><span>res</span><span>)</span> <span>=&gt;</span> <span>res</span><span>.</span><span>text</span><span>());</span>
<span>const</span> <span>attitude</span> <span>=</span> <span>document</span><span>.</span><span>getElementById</span><span>(</span><span>`attitude`</span><span>);</span>
<span>attitude</span><span>.</span><span>innerHTML</span> <span>=</span> <span>content</span><span>;</span>

<span>export</span> <span>const</span> <span>Attitude</span> <span>=</span> <span>{</span>
  <span>setPitchBank</span><span>(</span><span>pitch</span><span>,</span> <span>bank</span><span>)</span> <span>{</span>
    <span>attitude</span><span>.</span><span>style</span><span>.</span><span>setProperty</span><span>(</span><span>`--pitch`</span><span>,</span> <span>pitch</span><span>);</span>
    <span>attitude</span><span>.</span><span>style</span><span>.</span><span>setProperty</span><span>(</span><span>`--bank`</span><span>,</span> <span>bank</span><span>);</span>
  <span>},</span>
<span>};</span>
</code></pre></div>

<p>Barely anything to it. Now we just import that and then call the <code>setPitchBank</code> function during the update cycle in our <code>plane.js</code>:</p>

<div><pre><code><span>import</span> <span>{</span> <span>Attitude</span> <span>}</span> <span>from</span> <span>"</span><span>./attitude.js</span><span>"</span><span>;</span>
<span>...</span>
<span>export</span> <span>class</span> <span>Plane</span> <span>{</span>
  <span>...</span>
  <span>/**
   * Yet again, we're back in updateState
   */</span>
  <span>async</span> <span>updateState</span><span>(</span><span>state</span><span>)</span> <span>{</span>
    <span>...</span>

    <span>// Update the attitude indicator:</span>
    <span>if</span> <span>(</span><span>state</span><span>.</span><span>flightInformation</span><span>.</span><span>data</span><span>)</span> <span>{</span>
      <span>const</span> <span>{</span> <span>pitch</span><span>,</span> <span>bank</span> <span>}</span> <span>=</span> <span>state</span><span>.</span><span>flightInformation</span><span>.</span><span>data</span><span>;</span>
      <span>Attitude</span><span>.</span><span>setPitchBank</span><span>(</span><span>pitch</span><span>,</span> <span>bank</span><span>);</span>
    <span>}</span>

    <span>this</span><span>.</span><span>lastUpdate</span> <span>=</span> <span>{</span> <span>time</span><span>:</span> <span>now</span><span>,</span> <span>...</span><span>state</span> <span>};</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And done, that’s our attitude indicator hooked up.</p>

<h2 id="doing-science-plotting-our-flight-telemetry">Doing science: plotting our flight telemetry</h2>

<p>Before we consider our page work done, though, let’s add one more thing: science.</p>

<figure>
  <img src="https://pomax.github.io/are-we-flying/images/page/science/overview.png">
  <figcaption>Look at all that science!</figcaption>
</figure>
<p>If we want to understand what our plane is doing, especially if we want to understand what our plane is doing in response to input changes (whether those are by a human or auto pilot), we need some way to see what happens over time. Which means we want graphs. Lots of graphs. And if we need graphs, we need some code that’ll do that graphing for us!</p>

<p>There’s quite a few ways to get some nice charts on a page, so instead of running you through the code that this project uses, let’s just say that you are spoiled for choice and the choice of whether to use an off-the-shelf library or rolling your own code is entirely up to you. In this specific case, I rolled us some custom code that you can find on the repo under <code>public/js/dashboard/</code>, mostly because I wanted something that generates plain SVG that I can just copy-paste from dev tools into a new file, save that as <code>.svg</code> and then be able to load it into any SVG viewer/editor. Something that’s particularly useful for autopilot debugging.</p>

<p>What matters most is that we can tell the code that we want to plot several graphs, and that each graph has some initial x and y interval that we can grow as needed (<code>x</code> representing time and <code>y</code> representing “whatever makes sense for the value we’re plotting”, since heading angle, speed in knots, altitude in feet, etc. all have rather different ranges), which we do with an initial setup:</p>

<div><pre><code><span>export</span> <span>function</span> <span>initCharts</span><span>()</span> <span>{</span>
  <span>const</span> <span>config</span> <span>=</span> <span>{</span>
    <span>// the basics</span>
    <span>ground</span><span>:</span> <span>{</span> <span>unit</span><span>:</span> <span>`feet`</span><span>,</span> <span>positive</span><span>:</span> <span>true</span><span>,</span> <span>fixed</span><span>:</span> <span>1</span><span>,</span> <span>max</span><span>:</span> <span>1500</span><span>,</span> <span>filled</span><span>:</span> <span>true</span> <span>},</span>
    <span>altitude</span><span>:</span> <span>{</span> <span>unit</span><span>:</span> <span>`feet`</span><span>,</span> <span>positive</span><span>:</span> <span>true</span><span>,</span> <span>fixed</span><span>:</span> <span>1</span> <span>},</span>
    <span>speed</span><span>:</span> <span>{</span> <span>unit</span><span>:</span> <span>`knots`</span><span>,</span> <span>positive</span><span>:</span> <span>true</span><span>,</span> <span>fixed</span><span>:</span> <span>2</span> <span>},</span>
    <span>dV</span><span>:</span> <span>{</span> <span>unit</span><span>:</span> <span>`knots/s`</span><span>,</span> <span>fixed</span><span>:</span> <span>2</span> <span>},</span>

    <span>// elevator related values</span>
    <span>VS</span><span>:</span> <span>{</span> <span>unit</span><span>:</span> <span>`fpm`</span><span>,</span> <span>fixed</span><span>:</span> <span>1</span><span>,</span> <span>limits</span><span>:</span> <span>[</span><span>1000</span><span>,</span> <span>-</span><span>1000</span><span>]</span> <span>},</span>
    <span>dVS</span><span>:</span> <span>{</span> <span>unit</span><span>:</span> <span>`fpm/s`</span><span>,</span> <span>fixed</span><span>:</span> <span>2</span> <span>},</span>
    <span>pitch</span><span>:</span> <span>{</span> <span>unit</span><span>:</span> <span>`degrees`</span><span>,</span> <span>fixed</span><span>:</span> <span>1</span> <span>},</span>
    <span>dPitch</span><span>:</span> <span>{</span> <span>unit</span><span>:</span> <span>`deg/s`</span><span>,</span> <span>fixed</span><span>:</span> <span>2</span><span>,</span> <span>limits</span><span>:</span> <span>[</span><span>1</span><span>,</span> <span>-</span><span>1</span><span>]</span> <span>},</span>

    <span>// aileron related values</span>
    <span>heading</span><span>:</span> <span>{</span>
      <span>unit</span><span>:</span> <span>`degrees`</span><span>,</span>
      <span>positive</span><span>:</span> <span>true</span><span>,</span>
      <span>min</span><span>:</span> <span>0</span><span>,</span>
      <span>max</span><span>:</span> <span>360</span><span>,</span>
      <span>discontinuous</span><span>:</span> <span>true</span><span>,</span>
      <span>fixed</span><span>:</span> <span>0</span><span>,</span>
    <span>},</span>
    <span>bank</span><span>:</span> <span>{</span> <span>unit</span><span>:</span> <span>`degrees`</span><span>,</span> <span>fixed</span><span>:</span> <span>2</span><span>,</span> <span>limits</span><span>:</span> <span>[</span><span>30</span><span>,</span> <span>-</span><span>30</span><span>]</span> <span>},</span>
    <span>dBank</span><span>:</span> <span>{</span> <span>unit</span><span>:</span> <span>`deg/s`</span><span>,</span> <span>fixed</span><span>:</span> <span>4</span> <span>},</span>
    <span>turnRate</span><span>:</span> <span>{</span> <span>label</span><span>:</span> <span>`turn rate`</span><span>,</span> <span>unit</span><span>:</span> <span>`deg/s`</span><span>,</span> <span>fixed</span><span>:</span> <span>2</span> <span>},</span>
    <span>rudder</span><span>:</span> <span>{</span> <span>label</span><span>:</span> <span>`rudder`</span><span>,</span> <span>unit</span><span>:</span> <span>`%`</span><span>,</span> <span>fixed</span><span>:</span> <span>2</span> <span>},</span>

    <span>// trim settings</span>
    <span>pitchTrim</span><span>:</span> <span>{</span> <span>label</span><span>:</span> <span>`pitch trim`</span><span>,</span> <span>unit</span><span>:</span> <span>`%`</span><span>,</span> <span>fixed</span><span>:</span> <span>3</span> <span>},</span>
    <span>aileronTrim</span><span>:</span> <span>{</span> <span>label</span><span>:</span> <span>`aileron trim`</span><span>,</span> <span>unit</span><span>:</span> <span>`%`</span><span>,</span> <span>fixed</span><span>:</span> <span>3</span> <span>},</span>
    <span>rudderTrim</span><span>:</span> <span>{</span> <span>label</span><span>:</span> <span>`rudder trim`</span><span>,</span> <span>unit</span><span>:</span> <span>`%`</span><span>,</span> <span>fixed</span><span>:</span> <span>3</span> <span>},</span>
  <span>};</span>

  <span>return</span> <span>new</span> <span>Chart</span><span>(</span><span>config</span><span>);</span>
<span>}</span>
</code></pre></div>

<p>After which we update our <code>plane.js</code> to use this charting solution:</p>

<div><pre><code><span>import</span> <span>{</span> <span>initCharts</span> <span>}</span> <span>from</span> <span>"</span><span>./dashboard/charts.js</span><span>"</span><span>;</span>

<span>...</span>

<span>export</span> <span>class</span> <span>Plane</span> <span>{</span>
  <span>constructor</span><span>(</span><span>server</span><span>,</span> <span>map</span> <span>=</span> <span>defaultMap</span><span>,</span> <span>location</span> <span>=</span> <span>Duncan</span><span>,</span> <span>heading</span> <span>=</span> <span>135</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>// Set up our chart solution, which will inject some elements</span>
    <span>// into the page that will do the relevant drawing for us:</span>
    <span>this</span><span>.</span><span>charts</span> <span>=</span> <span>initCharts</span><span>();</span>
  <span>}</span>

  <span>async</span> <span>updateState</span><span>(</span><span>state</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>state</span> <span>=</span> <span>state</span><span>;</span>
    <span>const</span> <span>now</span> <span>=</span> <span>Date</span><span>.</span><span>now</span><span>();</span>

    <span>...</span>

    <span>const</span> <span>flightData</span> <span>=</span> <span>state</span><span>.</span><span>flightInformation</span><span>.</span><span>data</span><span>;</span>
    <span>if</span> <span>(</span><span>flightData</span><span>)</span> <span>{</span>
      <span>// Update the attitude indicator:</span>
      <span>const</span> <span>{</span> <span>pitch</span><span>,</span> <span>bank</span> <span>}</span> <span>=</span> <span>state</span><span>.</span><span>flightInformation</span><span>.</span><span>data</span><span>;</span>
      <span>Attitude</span><span>.</span><span>setPitchBank</span><span>(</span><span>pitch</span><span>,</span> <span>bank</span><span>);</span>

      <span>// Update our science</span>
      <span>this</span><span>.</span><span>updateChart</span><span>(</span><span>flightData</span><span>);</span>
    <span>}</span>

    <span>this</span><span>.</span><span>lastUpdate</span> <span>=</span> <span>{</span> <span>time</span><span>:</span> <span>now</span><span>,</span> <span>...</span><span>state</span> <span>};</span>
  <span>}</span>


  <span>/**
   * And then in the updateChart function we simply pick our
   * values, and tell the charting solution to plot them.
   */</span>
  <span>updateChart</span><span>(</span><span>flightData</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>alt</span><span>,</span> <span>bank</span><span>,</span> <span>groundAlt</span><span>,</span> <span>pitch</span><span>,</span> <span>speed</span><span>,</span> <span>heading</span><span>,</span> <span>rudder</span> <span>}</span> <span>=</span> <span>flightData</span><span>;</span>
    <span>const</span> <span>{</span> <span>VS</span><span>,</span> <span>pitchTrim</span><span>,</span> <span>aileronTrim</span><span>,</span> <span>turnRate</span><span>,</span> <span>rudderTrim</span> <span>}</span> <span>=</span> <span>flightData</span><span>;</span>
    <span>const</span> <span>nullDelta</span> <span>=</span> <span>{</span> <span>VS</span><span>:</span> <span>0</span><span>,</span> <span>pitch</span><span>:</span> <span>0</span><span>,</span> <span>bank</span><span>:</span> <span>0</span> <span>};</span>
    <span>const</span> <span>{</span> <span>VS</span><span>:</span> <span>dVS</span><span>,</span> <span>pitch</span><span>:</span> <span>dPitch</span><span>,</span> <span>bank</span><span>:</span> <span>dBank</span><span>,</span> <span>speed</span><span>:</span> <span>dV</span> <span>}</span> <span>=</span> <span>flightData</span><span>.</span><span>d</span> <span>??</span> <span>nullDelta</span><span>;</span>
    <span>this</span><span>.</span><span>charts</span><span>.</span><span>update</span><span>({</span>
      <span>ground</span><span>:</span> <span>groundAlt</span><span>,</span> <span>altitude</span><span>:</span> <span>alt</span><span>,</span> <span>speed</span><span>,</span> <span>dV</span><span>,</span> <span>// basics</span>
      <span>VS</span><span>,</span> <span>dVS</span><span>,</span> <span>pitch</span><span>,</span> <span>dPitch</span><span>,</span>                      <span>// elevator</span>
      <span>heading</span><span>,</span> <span>bank</span><span>,</span> <span>dBank</span><span>,</span> <span>turnRate</span><span>,</span> <span>rudder</span><span>,</span>      <span>// ailleron</span>
      <span>pitchTrim</span><span>,</span> <span>aileronTrim</span><span>,</span> <span>rudderTrim</span><span>,</span>          <span>// trim</span>
    <span>});</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>With an update to <code>index.html</code> so that there’s a science div to put all our graphs into:</p>

<div><pre><code>    ...
    <span>&lt;div</span> <span>id=</span><span>"visualization"</span><span>&gt;</span>
      <span>&lt;div</span> <span>id=</span><span>"map"</span> <span>style=</span><span>"width: 1200px; height: 800px"</span><span>&gt;&lt;/div&gt;</span>
      <span>&lt;div</span> <span>id=</span><span>"attitude"</span> <span>data-description=</span><span>"Templated from attitude.html"</span><span>&gt;&lt;/div&gt;</span>
    <span>&lt;/div&gt;</span>
    <span>&lt;div</span> <span>id=</span><span>"science"</span> <span>class=</span><span>"pane"</span><span>&gt;</span>
      <span>&lt;!-- all the data!  --&gt;</span>
    <span>&lt;/div&gt;</span>
  <span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
</code></pre></div>

<p>And now we can see what our plane is doing over time, which means we’re ready to get down to what you started reading this page for!</p>

<figure>
  <img src="https://pomax.github.io/are-we-flying/images/page/big-science.png">
  <figcaption>That's some big science...</figcaption>
</figure>

<p>…Now that we’re some 15,000 words down the page…</p>

<p><em>So let’s finally do this.</em></p>

<h2 id="part-3-writing-an-autopilot">Part 3: writing an autopilot</h2>

<p>It’s time. Let’s write that autopilot you came here for.</p>

<p>And while we could do this in the browser, we’re going to be adding the main code to our API server, rather than our web page. Don’t get me wrong: we <em>totally could</em> write our autopilot in client-side JS, but we’d much rather not have to deal with the delay of network requests from the webpage (even if web sockets are must faster than GET/POST requests), and we definitely don’t want to accidentally turn off the autopilot just because we closed a tab… we might be flying a virtual plane, but it’d be nice to keep it in the air instead of just plummeting out of the sky when we accidentally close our browser!</p>

<h2 id="the-code-basics">The code basics</h2>

<p>In order to run an auto pilot, we’re going to need to set up some code that actually “runs” the auto pilot, and then expose some of that functionality over the network, which requires (unsurprisingly) some new files, and some updates to old files.</p>

<h3 id="the-server-side-of-our-autopilot">The server side of our autopilot</h3>

<p>Let’s start with the autopilot code itself, but without any specific piloting logic implemented quite yet, since we’ll be doing that in stages as we run through this chapter. We’ll start by creating a  <code>src/autopilot/autopilot.js</code>, which will be something that we’ll never expose to clients directly, so we can write “normal” code:</p>

<div><pre><code><span>import</span> <span>url</span> <span>from</span> <span>"</span><span>node:url</span><span>"</span><span>;</span>
<span>const</span> <span>__dirname</span> <span>=</span> <span>url</span><span>.</span><span>fileURLToPath</span><span>(</span><span>new</span> <span>URL</span><span>(</span><span>"</span><span>.</span><span>"</span><span>,</span> <span>import</span><span>.</span><span>meta</span><span>.</span><span>url</span><span>));</span>

<span>const</span> <span>AUTOPILOT_INTERVAL</span> <span>=</span> <span>500</span><span>;</span>

<span>export</span> <span>class</span> <span>AutoPilot</span> <span>{</span>
  <span>constructor</span><span>(</span><span>api</span><span>,</span> <span>onChange</span> <span>=</span> <span>()</span> <span>=&gt;</span> <span>{})</span> <span>{</span>
    <span>this</span><span>.</span><span>api</span> <span>=</span> <span>api</span><span>;</span>
    <span>this</span><span>.</span><span>onChange</span> <span>=</span> <span>async</span> <span>(</span><span>update</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>onChange</span><span>(</span><span>update</span> <span>??</span> <span>(</span><span>await</span> <span>this</span><span>.</span><span>getParameters</span><span>()));</span>
    <span>};</span>
    <span>this</span><span>.</span><span>reset</span><span>();</span>
  <span>}</span>

  <span>reset</span><span>(</span><span>flightInformation</span><span>,</span> <span>flightInfoUpdateHandler</span><span>)</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`resetting autopilot`</span><span>);</span>
    <span>this</span><span>.</span><span>flightInformation</span> <span>=</span> <span>flightInformation</span><span>;</span>
    <span>this</span><span>.</span><span>flightInfoUpdateHandler</span> <span>=</span> <span>flightInfoUpdateHandler</span><span>;</span>
    <span>this</span><span>.</span><span>paused</span> <span>=</span> <span>false</span><span>;</span>
    <span>this</span><span>.</span><span>modes</span> <span>=</span> <span>{</span>
      <span>// This is going to be our "switch panel", where</span>
      <span>// we say which modes are on or off, and for modes</span>
      <span>// with numerical values, what those values are.</span>

      <span>// For now, we're only adding a single switch:</span>
      <span>// the master switch.</span>
      <span>MASTER</span><span>:</span> <span>false</span><span>,</span>
    <span>};</span>
    <span>this</span><span>.</span><span>onChange</span><span>(</span><span>this</span><span>.</span><span>getParameters</span><span>);</span>
  <span>}</span>

  <span>get</span> <span>autoPilotEnabled</span><span>()</span> <span>{</span>
    <span>return</span> <span>this</span><span>.</span><span>modes</span><span>.</span><span>MASTER</span><span>;</span>
  <span>}</span>

  <span>disable</span><span>()</span> <span>{</span>
    <span>this</span><span>.</span><span>setParameters</span><span>({</span> <span>MASTER</span><span>:</span> <span>false</span> <span>});</span>
  <span>}</span>

  <span>setPaused</span><span>(</span><span>value</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>paused</span> <span>=</span> <span>value</span><span>;</span>
  <span>}</span>

  <span>async</span> <span>getParameters</span><span>()</span> <span>{</span>
    <span>return</span> <span>{</span> <span>...</span><span>this</span><span>.</span><span>modes</span> <span>};</span>
  <span>}</span>

  <span>async</span> <span>setParameters</span><span>(</span><span>params</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>api</span><span>,</span> <span>modes</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>const</span> <span>wasEnabled</span> <span>=</span> <span>modes</span><span>.</span><span>MASTER</span><span>;</span>
		<span>Object</span><span>.</span><span>entries</span><span>(</span><span>params</span><span>).</span><span>forEach</span><span>(([</span><span>key</span><span>,</span> <span>value</span><span>])</span> <span>=&gt;</span> <span>{</span>
      <span>this</span><span>.</span><span>setTarget</span><span>(</span><span>key</span><span>,</span> <span>value</span><span>);</span>
    <span>});</span>

    <span>// notify clients of all the changes that just occurred:</span>
    <span>this</span><span>.</span><span>onChange</span><span>();</span>

    <span>// Then, MSFS might not actually be running...</span>
    <span>if</span> <span>(</span><span>!</span><span>this</span><span>.</span><span>api</span><span>.</span><span>connected</span><span>)</span> <span>return</span><span>;</span>

    <span>// but if it is, and we just turned our own autopilot on, then we'll</span>
    <span>// want to make sure to turn off the in-game autopilot (if it's on),</span>
    <span>// before we start to run our own code, so that it doesn't interfere:</span>
    <span>if</span> <span>(</span><span>!</span><span>wasEnabled</span> <span>&amp;&amp;</span> <span>modes</span><span>.</span><span>MASTER</span><span>)</span> <span>{</span>
      <span>const</span> <span>{</span> <span>AUTOPILOT_MASTER</span><span>:</span> <span>gameAP</span> <span>}</span> <span>=</span> <span>await</span> <span>api</span><span>.</span><span>get</span><span>(</span><span>`AUTOPILOT_MASTER`</span><span>);</span>
      <span>if</span> <span>(</span><span>gameAP</span> <span>===</span> <span>1</span><span>)</span> <span>api</span><span>.</span><span>trigger</span><span>(</span><span>`AP_MASTER`</span><span>);</span>
      <span>// now we can safely run our own autopilot code.</span>
      <span>this</span><span>.</span><span>runAutopilot</span><span>();</span>
    <span>}</span>
  <span>}</span>

  <span>async</span> <span>setTarget</span><span>(</span><span>key</span><span>,</span> <span>value</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>modes</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>// We'll be building this out as we implement more and</span>
    <span>// more autopilot features, but for now we just "blindly"</span>
    <span>// update values. But, only if they exist in our list of</span>
    <span>// modes: we're not going to let clients just set arbitrary</span>
    <span>// key/value pairs!</span>
    <span>if</span> <span>(</span><span>modes</span><span>[</span><span>key</span><span>]</span> <span>!==</span> <span>undefined</span><span>)</span> <span>{</span>
			<span>modes</span><span>[</span><span>key</span><span>]</span> <span>=</span> <span>value</span><span>;</span>
    <span>}</span>
  <span>}</span>

  <span>async</span> <span>runAutopilot</span><span>()</span> <span>{</span>
    <span>const</span> <span>{</span> <span>api</span><span>,</span> <span>modes</span><span>,</span> <span>paused</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>

    <span>// Sanity check: *should* this code run?</span>
    <span>if</span> <span>(</span><span>!</span><span>api</span><span>.</span><span>connected</span><span>)</span> <span>return</span><span>;</span>
    <span>if</span> <span>(</span><span>!</span><span>modes</span><span>.</span><span>MASTER</span><span>)</span> <span>return</span><span>;</span>

    <span>// If the autopilot is enabled, even if there are errors due to</span>
    <span>// MSFS glitching, or the DLL handling glitching, or values somehow</span>
    <span>// having gone missing, or our own code throwing errors that we</span>
    <span>// need to fix, etc. etc: schedule the next call, and hopefully</span>
    <span>// things work by then.</span>
    <span>runLater</span><span>(()</span> <span>=&gt;</span> <span>this</span><span>.</span><span>runAutopilot</span><span>(),</span> <span>this</span><span>.</span><span>AP_INTERVAL</span><span>);</span>

    <span>// If the game is paused, then don't run the autopilot code, but</span>
    <span>// only for "this call". Maybe by the next call the game won't be</span>
    <span>// paused anymore.</span>
    <span>if</span> <span>(</span><span>paused</span><span>)</span> <span>return</span><span>;</span>

    <span>// And remember: *never* allow code to crash the server:</span>
    <span>try</span> <span>{</span>
      <span>await</span> <span>this</span><span>.</span><span>run</span><span>();</span>
      <span>this</span><span>.</span><span>onChange</span><span>();</span>
    <span>}</span> <span>catch</span> <span>(</span><span>e</span><span>)</span> <span>{</span>
      <span>console</span><span>.</span><span>error</span><span>(</span><span>e</span><span>);</span>
    <span>}</span>
  <span>}</span>

  <span>async</span> <span>run</span><span>()</span> <span>{</span>
    <span>// This is where things will actually happen, rather than</span>
    <span>// putting that code inside `runAutopilot`, because this will</span>
    <span>// eventually be a substantial amount of code.</span>

    <span>// For now, all we do is update the flight information. And</span>
    <span>// you might be thinking "well why not just update only the</span>
    <span>// flight data, the model isn't going to change mid-flight?"</span>
    <span>// but if so: you never turned on the MSFS developer tools,</span>
    <span>// which comes with an aircraft selector so you *can* change</span>
    <span>// the model mid-flight =)</span>
    <span>this</span><span>.</span><span>flightInfoUpdateHandler</span><span>(</span><span>await</span> <span>this</span><span>.</span><span>flightInformation</span><span>.</span><span>update</span><span>());</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>So this does nothing yet, except run the autopilot loop when the autopilot gets enabled, but it’s enough code that want to at least test this to see if we can turn the AP on and off, which means we’ll need to update a few more files before we can do our testing, starting with our <code>server.js</code>:</p>

<div><pre><code><span>...</span>

<span>// we'll make the autopilot hot-reloadable:</span>
<span>let</span> <span>autopilot</span> <span>=</span> <span>false</span><span>;</span>
<span>let</span> <span>{</span> <span>AutoPilot</span> <span>}</span> <span>=</span> <span>await</span> <span>watch</span><span>(</span>
  <span>__dirname</span><span>,</span>
  <span>`../../autopilot/autopilot.js`</span><span>,</span>
  <span>(</span><span>module</span><span>)</span> <span>=&gt;</span> <span>{</span>
    <span>AutoPilot</span> <span>=</span> <span>module</span><span>.</span><span>AutoPilot</span><span>;</span>
    <span>if</span> <span>(</span><span>autopilot</span><span>)</span> <span>Object</span><span>.</span><span>setPrototypeOf</span><span>(</span><span>autopilot</span><span>,</span> <span>AutoPilot</span><span>.</span><span>prototype</span><span>);</span>
  <span>}</span>
<span>);</span>

<span>// And we're not going to expose the autopilot itself to clients,</span>
<span>// instead we're wrapping it so we can control who gets to call it,</span>
<span>// similar to what we did with the API:</span>
<span>import</span> <span>{</span> <span>AutopilotRouter</span> <span>}</span> <span>from</span> <span>"</span><span>./routers/autopilot-router.js</span><span>"</span><span>;</span>

<span>...</span>

<span>export</span> <span>class</span> <span>ServerClass</span> <span>{</span>
  <span>init</span><span>()</span> <span>{</span>
    <span>const</span> <span>{</span> <span>clients</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>

    <span>// Set up the off-class autopilot instance, with a callback that</span>
    <span>// lets the autopilot broadcast its settings whenever they change.</span>
    <span>autopilot</span> <span>=</span> <span>new</span> <span>AutoPilot</span><span>(</span><span>api</span><span>,</span> <span>(</span><span>params</span><span>)</span> <span>=&gt;</span>
      <span>clients</span><span>.</span><span>forEach</span><span>((</span><span>client</span><span>)</span> <span>=&gt;</span> <span>client</span><span>.</span><span>onAutoPilot</span><span>(</span><span>params</span><span>));</span>
    <span>);</span>

    <span>// And set up call routing for the autopilot in the same way as we</span>
    <span>// did for the API: only authenticated clients are allowed to mess</span>
    <span>// with the AP settings =)</span>
    <span>this</span><span>.</span><span>autopilot</span> <span>=</span> <span>this</span><span>.</span><span>lock</span><span>(</span>
      <span>new</span> <span>AutopilotRouter</span><span>(</span><span>autopilot</span><span>),</span>
      <span>(</span><span>client</span><span>)</span> <span>=&gt;</span> <span>this</span><span>.</span><span>#</span><span>authenticatedClients</span><span>.</span><span>includes</span><span>(</span><span>client</span><span>)</span>
    <span>);</span>

    <span>connectServerToAPI</span><span>(</span><span>api</span><span>,</span> <span>async</span> <span>()</span> <span>=&gt;</span> <span>{</span>
      <span>console</span><span>.</span><span>log</span><span>(</span><span>`Connected to MSFS.`</span><span>);</span>
      <span>flightInformation</span> <span>=</span> <span>new</span> <span>FlightInformation</span><span>(</span><span>api</span><span>);</span>

      <span>// Since we want to pause the autopilot when the game pauses,</span>
      <span>// we add the autopilot to our event registration:</span>
      <span>registerWithAPI</span><span>(</span><span>clients</span><span>,</span> <span>api</span><span>,</span> <span>autopilot</span><span>);</span>

      <span>clients</span><span>.</span><span>forEach</span><span>((</span><span>client</span><span>)</span> <span>=&gt;</span> <span>client</span><span>.</span><span>onMSFS</span><span>(</span><span>true</span><span>));</span>
      <span>(</span><span>async</span> <span>function</span> <span>poll</span><span>()</span> <span>{</span>
        <span>// And we add the autopilot to our game state check, because</span>
        <span>// when the autopilot kicks in, it becomes responsible for polling</span>
        <span>// the game for data (much) faster than the regular server poll.</span>
        <span>checkGameState</span><span>(</span><span>autopilot</span><span>,</span> <span>clients</span><span>,</span> <span>flightInformation</span><span>);</span>
        <span>runLater</span><span>(</span><span>poll</span><span>,</span> <span>POLLING_INTERVAL</span><span>);</span>
      <span>})();</span>
    <span>});</span>
  <span>}</span>

  <span>// When clients connect, we immediately send them the current autopilot</span>
  <span>// state. If the autopilot's been initialized, of course.</span>
  <span>async</span> <span>onConnect</span><span>(</span><span>client</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>if</span> <span>(</span><span>autopilot</span><span>)</span> <span>{</span>
      <span>client</span><span>.</span><span>onAutoPilot</span><span>(</span><span>await</span> <span>autopilot</span><span>.</span><span>getParameters</span><span>());</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>With the associated (tiny) autopilot router in <code>src/classes/server/routers/autopilot-router.js</code>:</p>

<div><pre><code><span>// clients will be able to access functions in this router, so we</span>
<span>// want to make sure the autopilot is not directly accessible:</span>
<span>let</span> <span>autopilot</span><span>;</span>

<span>export</span> <span>class</span> <span>AutopilotRouter</span> <span>{</span>
  <span>constructor</span><span>(</span><span>_autopilot</span><span>)</span> <span>{</span>
    <span>autopilot</span> <span>=</span> <span>_autopilot</span><span>;</span>
  <span>}</span>

  <span>// This is the only thing we want to expose to clients:</span>
  <span>// a way for them to change AP settings.</span>
  <span>async</span> <span>update</span><span>(</span><span>client</span><span>,</span> <span>params</span><span>)</span> <span>{</span>
    <span>autopilot</span><span>.</span><span>setParameters</span><span>(</span><span>params</span><span>);</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>With a change to <code>checkGameState</code> now that we have an autopilot:</p>

<div><pre><code><span>export</span> <span>async</span> <span>function</span> <span>checkGameState</span><span>(</span><span>autopilot</span><span>,</span> <span>clients</span><span>,</span> <span>flightInformation</span><span>)</span> <span>{</span>
  <span>// If the autopilot is running, it will be updating the flight</span>
  <span>// information more frequently than the server would otherwise do,</span>
  <span>// so don't update it here if the AP code is running.</span>
  <span>if</span> <span>(</span><span>!</span><span>autopilot</span> <span>||</span> <span>!</span><span>autopilot</span><span>.</span><span>autoPilotEnabled</span><span>)</span> <span>{</span>
    <span>await</span> <span>flightInformation</span><span>.</span><span>update</span><span>();</span>
    <span>clients</span><span>.</span><span>forEach</span><span>((</span><span>client</span><span>)</span> <span>=&gt;</span> <span>client</span><span>.</span><span>setFlightInformation</span><span>(</span><span>flightInformation</span><span>));</span>
  <span>}</span>

  <span>// Is there's a state change from "not in game" to "in game"?</span>
  <span>const</span> <span>wasInGame</span> <span>=</span> <span>inGame</span><span>;</span>
  <span>inGame</span> <span>=</span> <span>flightInformation</span><span>.</span><span>general</span><span>.</span><span>inGame</span><span>;</span>

  <span>if</span> <span>(</span><span>wasInGame</span> <span>&amp;&amp;</span> <span>!</span><span>inGame</span><span>)</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`left the game, disabling autopilot`</span><span>);</span>
    <span>autopilot</span><span>.</span><span>disable</span><span>();</span>
  <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>!</span><span>wasInGame</span> <span>&amp;&amp;</span> <span>inGame</span><span>)</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`new game started, resetting autopilot`</span><span>);</span>
    <span>autopilot</span><span>.</span><span>reset</span><span>(</span><span>flightInformation</span><span>,</span> <span>(</span><span>data</span><span>)</span> <span>=&gt;</span>
      <span>clients</span><span>.</span><span>forEach</span><span>((</span><span>client</span><span>)</span> <span>=&gt;</span> <span>client</span><span>.</span><span>setFlightInformation</span><span>(</span><span>data</span><span>))</span>
    <span>);</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And of course, since our server code is calling <code>client.onAutoPilot(params)</code> we better make sure that exists in our <code>client.js</code>:</p>

<div><pre><code><span>...</span>
<span>export</span> <span>class</span> <span>ClientClass</span> <span>{</span>
  <span>...</span>
  <span>async</span> <span>onAutoPilot</span><span>(</span><span>params</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>setState</span><span>({</span> <span>autopilot</span><span>:</span> <span>params</span> <span>});</span>
  <span>}</span>
  <span>...</span>
<span>}</span>
</code></pre></div>

<p>And <code>socketless</code> will do the rest to make sure that the browser get that state update, too.</p>

<h4 id="ignoring-slew-mode">Ignoring slew mode</h4>

<p>Even MSFS knows that “flying somewhere just to get there” because you want to fly over some scenery that doesn’t have an airstrip nearby, or lining up a plane for some manoeuvre can be incredibly tedious, and so pressing <code>y</code> in game will hard-pause the flight and allow you to reposition the plane using wasd and the numpad, as well as using F1 through F4 to set the plane’s elevation. That’s super useful, but we don’t want the autopilot to keep running when we’re using that, so let’s bake in some “slew mode awareness”, starting with our <code>flight-values.js</code>:</p>

<div><pre><code><span>...</span>

<span>export</span> <span>const</span> <span>FLIGHT_DATA</span> <span>=</span> <span>[</span>
  <span>...</span>
  <span>`IS_SLEW_ACTIVE`</span><span>,</span>
  <span>...</span>
<span>];</span>

<span>...</span>

<span>export</span> <span>const</span> <span>BOOLEAN_VALUES</span> <span>=</span> <span>[</span>
  <span>...</span>
  <span>`IS_SLEW_ACTIVE`</span><span>,</span>
  <span>...</span>
<span>];</span>

<span>...</span>

<span>export</span> <span>const</span> <span>NAME_MAPPING</span> <span>=</span> <span>{</span>
  <span>...</span>
  <span>IS_SLEW_ACTIVE</span><span>:</span> <span>`slewMode`</span><span>,</span>
  <span>...</span>
<span>];</span>

<span>...</span>
</code></pre></div>

<p>With that in place, we can skip the autopilot run at each iteration for as long as <code>slewMode</code> is true:</p>

<div><pre><code><span>...</span>
<span>export</span> <span>class</span> <span>AutoPilot</span> <span>{</span>
  <span>...</span>

  <span>async</span> <span>run</span><span>()</span> <span>{</span>
    <span>this</span><span>.</span><span>flightInfoUpdateHandler</span><span>(</span><span>await</span> <span>this</span><span>.</span><span>flightInformation</span><span>.</span><span>update</span><span>());</span>

    <span>// Should we skip this round?</span>
    <span>if</span> <span>(</span><span>flightInformation</span><span>.</span><span>data</span><span>.</span><span>slewMode</span><span>)</span> <span>return</span><span>;</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<h3 id="the-client-side-of-our-autopilot">The client-side of our autopilot</h3>

<p>Of course, we want to be able to control this autopilot from the browser, so we’ll need an update to our browser code so that we can actually turn the autopilot on and off (even if that, right now, does nothing other than toggle a boolean value).</p>

<p>First, let’s create a little <code>public/autopilot.html</code> file:</p>

<div><pre><code><span>&lt;div</span> <span>class=</span><span>"controls"</span><span>&gt;</span>
  <span>&lt;link</span> <span>rel=</span><span>"stylesheet"</span> <span>href=</span><span>"/css/autopilot.css"</span> <span>/&gt;</span>
  <span>&lt;button</span> <span>class=</span><span>"MASTER"</span><span>&gt;</span>AP<span>&lt;/button&gt;</span>
  <span>&lt;!-- we're going to add *so* many options here, later on! --&gt;</span>
<span>&lt;/div&gt;</span>
</code></pre></div>

<p>Which we’ll tie into our <code>index.html</code>:</p>

<div><pre><code><span>&lt;!doctype html&gt;</span>
<span>&lt;html</span> <span>lang=</span><span>"en-GB"</span><span>&gt;</span>
  <span>&lt;head&gt;</span>
    ...
  <span>&lt;/head&gt;</span>
  <span>&lt;body&gt;</span>
    ...
    <span>&lt;div</span> <span>id=</span><span>"autopilot"</span> <span>data-description=</span><span>"Templated from autopilot.html"</span><span>&gt;&lt;/div&gt;</span>
  <span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
</code></pre></div>

<p>Then we’ll create a <code>public/css/autopilot.css</code> so we can see when our button has been pressed or not:</p>

<div><pre><code><span>#autopilot</span> <span>button</span><span>.active</span> <span>{</span>
  <span>background</span><span>:</span> <span>red</span><span>;</span>
  <span>color</span><span>:</span> <span>white</span><span>;</span>
<span>}</span>
</code></pre></div>

<p>And then, we’ll create a <code>public/js/autopilot.js</code> to load in this “partial” and hook up all the buttons… err… button. All the button.</p>

<div><pre><code><span>// We've seen this pattern before:</span>
<span>const</span> <span>content</span> <span>=</span> <span>await</span> <span>fetch</span><span>(</span><span>"</span><span>autopilot.html</span><span>"</span><span>).</span><span>then</span><span>((</span><span>res</span><span>)</span> <span>=&gt;</span> <span>res</span><span>.</span><span>text</span><span>());</span>
<span>const</span> <span>autopilot</span> <span>=</span> <span>document</span><span>.</span><span>getElementById</span><span>(</span><span>`autopilot`</span><span>);</span>
<span>autopilot</span><span>.</span><span>innerHTML</span> <span>=</span> <span>content</span><span>;</span>

<span>// just in case we start a client before we start a server,</span>
<span>// make sure that we have default value to work with:</span>
<span>export</span> <span>const</span> <span>AP_OPTIONS</span> <span>=</span> <span>{</span>
  <span>MASTER</span><span>:</span> <span>false</span><span>,</span>
<span>};</span>

<span>export</span> <span>class</span> <span>Autopilot</span> <span>{</span>
  <span>constructor</span><span>(</span><span>owner</span><span>)</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`Hooking up the autopilot controls`</span><span>);</span>
    <span>this</span><span>.</span><span>owner</span> <span>=</span> <span>owner</span><span>;</span>
    <span>const</span> <span>server</span> <span>=</span> <span>(</span><span>this</span><span>.</span><span>server</span> <span>=</span> <span>owner</span><span>.</span><span>server</span><span>);</span>
    <span>// We're going to add more buttons later, so we'll write some code</span>
    <span>// that "does that for us" sp we add options to AP_OPTIONS without</span>
    <span>// having to write new code for every option we add.</span>
    <span>Object</span><span>.</span><span>keys</span><span>(</span><span>AP_OPTIONS</span><span>).</span><span>forEach</span><span>((</span><span>key</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>const</span> <span>e</span> <span>=</span> <span>document</span><span>.</span><span>querySelector</span><span>(</span><span>`#autopilot .</span><span>${</span><span>key</span><span>}</span><span>`</span><span>);</span>
      <span>e</span><span>.</span><span>addEventListener</span><span>(</span><span>`click`</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
        <span>// We check to see if "this button" is active. If it is, then we</span>
        <span>// want to turn it off, and if it isn't, we want to turn it on.</span>
        <span>const</span> <span>value</span> <span>=</span> <span>e</span><span>.</span><span>classList</span><span>.</span><span>contains</span><span>(</span><span>`active`</span><span>);</span>
        <span>server</span><span>.</span><span>autopilot</span><span>.</span><span>update</span><span>({</span> <span>[</span><span>key</span><span>]:</span> <span>!</span><span>value</span> <span>});</span>
      <span>});</span>
    <span>});</span>
  <span>}</span>

  <span>// And we'll need a function that, when we're passed the server's</span>
  <span>// current autopilot settings, makes sure all the buttons (all one of</span>
  <span>// them right now) are shown correctly:</span>
  <span>update</span><span>(</span><span>flightData</span><span>,</span> <span>params</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>!</span><span>params</span><span>)</span> <span>return</span><span>;</span>
		<span>// Again, we do this with code that "does that for us":</span>
    <span>Object</span><span>.</span><span>entries</span><span>(</span><span>params</span><span>).</span><span>forEach</span><span>(([</span><span>key</span><span>,</span> <span>value</span><span>])</span> <span>=&gt;</span> <span>{</span>
      <span>const</span> <span>e</span> <span>=</span> <span>document</span><span>.</span><span>querySelector</span><span>(</span><span>`#autopilot .</span><span>${</span><span>key</span><span>}</span><span>`</span><span>);</span>
      <span>e</span><span>?.</span><span>classList</span><span>.</span><span>toggle</span><span>(</span><span>`active`</span><span>,</span> <span>!!</span><span>value</span><span>);</span>
    <span>});</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And then finally, of course, we load that in with the rest of our code in <code>plane.js</code>:</p>

<div><pre><code><span>import</span> <span>{</span> <span>Autopilot</span> <span>}</span> <span>from</span> <span>"</span><span>./autopilot.js</span><span>"</span><span>;</span>

<span>...</span>

<span>export</span> <span>class</span> <span>Plane</span> <span>{</span>
  <span>constructor</span><span>(</span><span>server</span><span>,</span> <span>map</span> <span>=</span> <span>defaultMap</span><span>,</span> <span>location</span> <span>=</span> <span>Duncan</span><span>,</span> <span>heading</span> <span>=</span> <span>135</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>this</span><span>.</span><span>autopilot</span> <span>=</span> <span>new</span> <span>Autopilot</span><span>(</span><span>this</span><span>);</span>
  <span>}</span>

  <span>// Another bit of code for our updateState: updating the autopilot UI.</span>
  <span>async</span> <span>updateState</span><span>(</span><span>state</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>state</span> <span>=</span> <span>state</span><span>;</span>
    <span>const</span> <span>now</span> <span>=</span> <span>Date</span><span>.</span><span>now</span><span>();</span>

    <span>...</span>
    <span>const</span> <span>flightData</span> <span>=</span> <span>state</span><span>.</span><span>flightInformation</span><span>.</span><span>data</span><span>;</span>
    <span>...</span>

    <span>// Super straight-forward:</span>
    <span>const</span> <span>{</span> <span>autopilot</span><span>:</span> <span>params</span> <span>}</span> <span>=</span> <span>state</span><span>;</span>
    <span>this</span><span>.</span><span>autopilot</span><span>.</span><span>update</span><span>(</span><span>flightData</span><span>,</span> <span>params</span><span>);</span>

    <span>this</span><span>.</span><span>lastUpdate</span> <span>=</span> <span>{</span> <span>time</span><span>:</span> <span>now</span><span>,</span> <span>...</span><span>state</span> <span>};</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>Which means, we should now be able to test that we have a working “click button, enable/disable autopilot” setup.</p>

<h3 id="testing-our-autopilot-code">Testing our “autopilot” code</h3>

<p>Let’s confirm everything works.</p>

<ul>
  <li>start our API server with <code>node api-server</code>,</li>
  <li>start our client web server with <code>node web-server --owner --browser</code>,</li>
  <li>we won’t need to start MSFS for this one, as nothing we’re doing relies on having the game running (yet!)</li>
  <li>
    <p>our browser should open and we should see our page with the new autopilot button:<br><img src="https://pomax.github.io/are-we-flying/images/page/ap-button-off.png" alt="our AP button off..."></p>
  </li>
  <li>and if we click it, we should see it turn red, because it now has an <code>active</code> class:<br><img src="https://pomax.github.io/are-we-flying/images/page/ap-button-on.png" alt="And our AP button on"></li>
</ul>

<p>The important thing to realize is that the button doesn’t turn red “when we clicked it” because we didn’t write any code that adds an <code>active</code> class when we click a button. Instead <em>a lot more</em> happens:</p>

<ol>
  <li>we press the AP master button,</li>
  <li><em>that does not update anything on the page</em> and instead calls <code>server.autopilot.update({ MASTER: true })</code>,</li>
  <li>which makes the server-side autopilot code update its <code>MASTER</code> value,</li>
  <li>which then triggers an autopilot “settings have changed” broadcast,</li>
  <li>which calls our client’s <code>onAutoPilot</code> with the new settings,</li>
  <li>which we use to update our client’s <code>state.autopilot</code> value,</li>
  <li>which automatically gets copied over to the browser,</li>
  <li>which forwards the state to our <code>Plane</code> code</li>
  <li>which passes it on to the <code>autopilot.update()</code> function,</li>
  <li>and <em>that</em>, finally, sets an <code>active</code> class on the button we pressed because it sees a <code>MASTER</code> property with value <code>true</code>.</li>
</ol>

<p>And that all happened so fast that as far as you can tell, you just clicked a button and it changed color to show that it’s active: that’s a good sign! It looks like we’ll be able to control our autopilot through the browser without things feeling sluggish or laggy.</p>

<p>So let’s start adding some buttons that actually control our airplane. Which of course requires also writing the server-side code that does the controlling. Which requires knowing a bit about how an autopilot makes a plane do the things it needs to do.</p>

<h2 id="so-how-does-an-autopilot-actually-work">So how does an autopilot actually work?</h2>

<p>At its core, an autopilot is a system that lets a plane fly “where we want it to fly”, with the most basic form of automated flight being making the plane fly in a straight line. However, there are two kinds of “straight line” we need to think about, because we’re not driving a car on a road, or gliding a boat through water, we’re flying through the air:</p>

<ol>
  <li>we can fly in a straight line without turning left or right, and</li>
  <li>we can fly in a straight line without moving up or down.</li>
</ol>

<p>The first of these is achieved using, in autopilot parlance, a <strong>wing leveler</strong>, often found as the label <code>LVL</code> on autopilot controls, and the second of these is achieved using <strong>altitude hold</strong>, often found as <code>ALT</code> on autopilot controls. You can see where the names come from: the first keeps the plane’s wings level, keeping us pointing in (roughly) one compass direction, while the second keeps the plane (roughly) at some fixed altitude.</p>

<p>More fully featured autopilots extend these two modes by adding <strong>heading mode</strong>, which effectively runs the wing leveler such that we fly “a <em>*specific*</em> compass direction”, with additional logic to get us from pointing in one direction to pointing in another, and by adding <strong>altitude set and hold</strong>, which runs altitude hold “at a <em>*specific*</em> altitude”, with additional logic to get us from one altitude to another.</p>

<p>We start by observing that we <em>*could*</em> try to take all our aeroplane’s flight data, then run a bunch of maths on the numbers we get in order to predict when we need to perform which operations in order to make sure that our plane does the right thing in the future, but this will be a losing proposition: the weather, air density changes, random updrafts, terrain-induced wind, the tendency to “pull” in some direction, etc. are all going to interfere with any predictions we’d make.</p>

<p>So instead, we’re going to implement our autopilot as a <em>*reactionary*</em> system: it looks at what the current flight data is, what the flight data <em>should</em> be if we were already flying the way the AP is set, and then puts in single, small corrections that’ll push us away from the wrong direction. We repeat that process over and over and over, every time looking at the new flight data, and then saying which corrections to make. The trick to getting an autopilot working based on this approach is that if we can do this in a way that makes the corrections smaller and smaller every time we run, we will converge on the desired flight path, barely having to correct anything after a while. The plane will just be flying the way we want it to.</p>

<p>Of course, a real autopilot does this kind of monitoring and correcting on a near-continuous basis. Something we don’t really have the luxury of doing by using JavaScript: in order not to overload both Node.js and MSFS, and in order for us to be able to look at the flight log when we need to do console log debugging, we’re going to run our autopilot only twice per second. And that may sound dangerously low, but it’s actually plenty fast.</p>

<p>So how do we determine the size of corrections we need to put in? Enter the constrained mapping function:</p>

<h3 id="the-backbone-of-our-autopilot-code-constrain-mapping">The backbone of our autopilot code: constrain-mapping</h3>

<p>Before we do anything else, let’s first look at what is probably <em>the</em> single most important function in our autopilot: <code>constrainMap</code>. This function takes a value, relative to some interval <code>[a,b]</code>, and maps it to the corresponding value in a different interval <code>[c,d]</code>, such that <code>a</code> maps to <code>c</code>, <code>b</code> maps to <code>d</code>, and anything in between <code>a</code> and <code>b</code> is some new value between <code>c</code> and <code>d</code>. This is nothing special, that’s just numerical mapping, but the critical part here is that in addition to the standard mapping, we also make sure that any value less than <code>a</code> <em>still maps to <code>c</code></em> and any value greater than <code>b</code> <em>still maps to <code>d</code></em>:</p>

<figure>
  <img src="https://pomax.github.io/are-we-flying/images/constrain_map.png" alt="Constrained mapping">
  <figcaption>Mapping interval [a,b] to [c,d]<br></figcaption>
</figure>

<p>That last part is critically important: if we’re going to write an autopilot, we want to be able to effect proportional changes, but we want to “cap” those changes to some minimum and maximum value because just yanking the plane in some direction so hard that it stalls is the opposite of useful.</p>

<p>As such, let’s implement <code>map</code> and <code>constrain</code> functions (unfortunately missing from the standard Math library), and then compose them as <code>constrainMap</code> in our <code>src/utils/utils.js</code> file:</p>

<div><pre><code><span>// map a value relative to some range [a,b] to a new range [c,d]</span>
<span>function</span> <span>map</span><span>(</span><span>v</span><span>,</span> <span>a</span><span>,</span> <span>b</span><span>,</span> <span>c</span><span>,</span> <span>d</span><span>)</span> <span>{</span>
  <span>const</span> <span>sourceInterval</span> <span>=</span> <span>b</span> <span>-</span> <span>a</span><span>;</span>
  <span>if</span> <span>(</span><span>sourceInterval</span> <span>===</span> <span>0</span><span>)</span> <span>return</span> <span>(</span><span>c</span> <span>+</span> <span>d</span><span>)</span> <span>/</span> <span>2</span><span>;</span>
  <span>const</span> <span>targetInterval</span> <span>=</span> <span>d</span> <span>-</span> <span>c</span><span>;</span>
  <span>return</span> <span>c</span> <span>+</span> <span>((</span><span>v</span> <span>-</span> <span>a</span><span>)</span> <span>*</span> <span>targetInterval</span><span>)</span> <span>/</span> <span>sourceInterval</span><span>;</span>
<span>}</span>

<span>// cap a number so that it's always in the range [min, max]</span>
<span>function</span> <span>constrain</span><span>(</span><span>v</span><span>,</span> <span>min</span><span>,</span> <span>max</span><span>)</span> <span>{</span>
  <span>if</span> <span>(</span><span>min</span> <span>&gt;</span> <span>max</span><span>)</span> <span>return</span> <span>constrain</span><span>(</span><span>v</span><span>,</span> <span>max</span><span>,</span> <span>min</span><span>);</span>
  <span>return</span> <span>v</span> <span>&gt;</span> <span>max</span> <span>?</span> <span>max</span> <span>:</span> <span>v</span> <span>&lt;</span> <span>min</span> <span>?</span> <span>min</span> <span>:</span> <span>v</span><span>;</span>
<span>}</span>

<span>// map a value from some range [a,b] to a new range [c,d], constrained to that new range [c,d]</span>
<span>function</span> <span>constrainMap</span><span>(</span><span>v</span><span>,</span> <span>a</span><span>,</span> <span>b</span><span>,</span> <span>c</span><span>,</span> <span>d</span><span>)</span> <span>{</span>
  <span>return</span> <span>constrain</span><span>(</span><span>map</span><span>(</span><span>v</span><span>,</span> <span>a</span><span>,</span> <span>b</span><span>,</span> <span>c</span><span>,</span> <span>d</span><span>),</span> <span>c</span><span>,</span> <span>d</span><span>);</span>
<span>}</span>
</code></pre></div>

<p>We’re going to rely on this function <em>a lot</em>, so now that we know what it does, and how it does it, let’s move on to actual autopilot code.</p>

<h2 id="implementing-cruise-control">Implementing cruise control</h2>

<p>Let’s start with the simplest bit of the autopilot: “cruise control”, which consists of just a wing leveler so we don’t turn left or right, and an altitude hold so we don’t fly up or down.</p>

<h3 id="lvl-level-mode">LVL: level mode</h3>

<p><img src="https://pomax.github.io/are-we-flying/images/fly-level/left-bank.png" alt="left bank"><img src="https://pomax.github.io/are-we-flying/images/fly-level/level-flight.png" alt="flying straight"><img src="https://pomax.github.io/are-we-flying/images/fly-level/right-bank.png" alt="right bank"></p>

<p>Implementing level mode is probably the easiest of all autopilot functions: we’re going to simply check “is the plane tilting left or right?” and if so, we move the <strong>aileron trim</strong>—a value that “biases” the plane to tilt left or right by adjusting the wing surfaces that tilt the plane—in the opposite direction. As long we do that a little bit at a time, and we do that for long enough, we’ll eventually have the plane flying level.</p>

<p>Let’s create an <code>api/autopilot/fly-level.js</code> file with some scaffolding:</p>

<div><pre><code><span>import</span> <span>{</span> <span>radians</span><span>,</span> <span>constrainMap</span> <span>}</span> <span>from</span> <span>"</span><span>../utils/utils.js</span><span>"</span><span>;</span>

<span>// Some initial constants: we want to level the wings, so we</span>
<span>// want a bank angle of zero degrees:</span>
<span>const</span> <span>DEFAULT_TARGET_BANK</span> <span>=</span> <span>0</span><span>;</span>

<span>// And we want to make sure not to turn more than 30 degrees (the</span>
<span>// universal "safe bank angle") when we're correcting the plane.</span>
<span>const</span> <span>DEFAULT_MAX_BANK</span> <span>=</span> <span>30</span><span>;</span>

<span>// And, importantly, we also don't want our bank to change by</span>
<span>// more than 3 degrees per second, or we might accellerate past</span>
<span>// zero or our max bank angle too fast.</span>
<span>const</span> <span>DEFAULT_MAX_TURN_RATE</span> <span>=</span> <span>3</span><span>;</span>

<span>// Now, we have no "additional features" yet, since this is going</span>
<span>// to be our first pass at writing the wing leveler, but we'll be</span>
<span>// adding a bunch of refinements later on, as we revisit this code,</span>
<span>// so we're going to tie those to "feature flags" that we can easily</span>
<span>// turn on or off to see the difference in-flight.</span>
<span>const</span> <span>FEATURES</span> <span>=</span> <span>{};</span>

<span>// Then, our actual "fly level" function, which  we're going to keep very "dumb":</span>
<span>// each time we call it, it gets to make a recommendation, without any kind of</span>
<span>// history tracking or future predictions. This keeps the code simple, and allows</span>
<span>// us to hot-reload the code without ever messing up some kind of "data tracking".</span>
<span>export</span> <span>async</span> <span>function</span> <span>flyLevel</span><span>(</span><span>autopilot</span><span>,</span> <span>state</span><span>)</span> <span>{</span>
  <span>// in order to make this work, we'll extend the autopilot with a "trim vector"</span>
  <span>// that lets us update pitch, roll, and yaw trim values on an ongoing basis.</span>
  <span>const</span> <span>{</span> <span>trim</span><span>,</span> <span>api</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>

  <span>// Get our current bank/roll information:</span>
  <span>const</span> <span>{</span> <span>data</span><span>:</span> <span>flightData</span><span>,</span> <span>model</span><span>:</span> <span>flightModel</span> <span>}</span> <span>=</span> <span>state</span><span>;</span>
  <span>const</span> <span>{</span> <span>bank</span><span>,</span> <span>speed</span> <span>}</span> <span>=</span> <span>flightData</span><span>;</span>
  <span>const</span> <span>{</span> <span>bank</span><span>:</span> <span>dBank</span> <span>}</span> <span>=</span> <span>flightData</span><span>.</span><span>d</span> <span>??</span> <span>{</span> <span>bank</span><span>:</span> <span>0</span> <span>};</span>

  <span>// Then, since we're running this over and over, how big should</span>
  <span>// our corrections be at most this iteration? The faster we're going,</span>
  <span>// the bigger a correction we're going to allow:</span>
  <span>const</span> <span>step</span> <span>=</span> <span>constrainMap</span><span>(</span><span>speed</span><span>,</span> <span>50</span><span>,</span> <span>150</span><span>,</span> <span>radians</span><span>(</span><span>1</span><span>),</span> <span>radians</span><span>(</span><span>5</span><span>));</span>

  <span>// Then, let's figure out "how much are we off by". Right now our</span>
  <span>// target bank angle is zero, but eventually that value is going to</span>
  <span>// be a number that may change every iteration.</span>
  <span>const</span> <span>targetBank</span> <span>=</span> <span>DEFAULT_TARGET_BANK</span><span>;</span>
  <span>const</span> <span>diff</span> <span>=</span> <span>targetBank</span> <span>-</span> <span>bank</span><span>;</span>

  <span>// Then, we determine a trim update, based on how much we're off by.</span>
  <span>// Negative updates will correct us to the left, positive updates</span>
  <span>// will correct us to the right.</span>
  <span>let</span> <span>update</span> <span>=</span> <span>0</span><span>;</span>

  <span>// As our main correction, we're looking directly at our bank difference:</span>
  <span>// the more we're banking, the more we correct, although if we're banking</span>
  <span>// more than "max bank", correct based off the max bank value instead.</span>
  <span>// Also, we'll restrict how much that max bank is based on how fast we're</span>
  <span>// going. Because a hard bank at low speeds is a good way to crash a plane.</span>
  <span>const</span> <span>maxBank</span> <span>=</span> <span>constrainMap</span><span>(</span><span>speed</span><span>,</span> <span>50</span><span>,</span> <span>200</span><span>,</span> <span>10</span><span>,</span> <span>DEFAULT_MAX_BANK</span><span>);</span>
  <span>update</span> <span>-=</span> <span>constrainMap</span><span>(</span><span>diff</span><span>,</span> <span>-</span><span>maxBank</span><span>,</span> <span>maxBank</span><span>,</span> <span>-</span><span>step</span><span>,</span> <span>step</span><span>);</span>

  <span>// With our main correction determined, we may want to "undo" some of that</span>
  <span>// correction in order not to jerk the plane around. We are, after all,</span>
  <span>// technically still in that plane and we'd like to not get sick =)</span>
  <span>const</span> <span>maxDBank</span> <span>=</span> <span>DEFAULT_MAX_TURN_RATE</span><span>;</span>
  <span>update</span> <span>+=</span> <span>constrainMap</span><span>(</span><span>dBank</span><span>,</span> <span>-</span><span>4</span> <span>*</span> <span>maxDBank</span><span>,</span> <span>4</span> <span>*</span> <span>maxDBank</span><span>,</span> <span>-</span><span>2</span> <span>*</span> <span>step</span><span>,</span> <span>2</span> <span>*</span> <span>step</span><span>);</span>

  <span>// Then add our update to our trim value, and set the trim in MSFS:</span>
  <span>trim</span><span>.</span><span>roll</span> <span>+=</span> <span>update</span><span>;</span>
  <span>api</span><span>.</span><span>set</span><span>(</span><span>`AILERON_TRIM_PCT`</span><span>,</span> <span>trim</span><span>.</span><span>roll</span><span>);</span>
<span>}</span>
</code></pre></div>

<p>If we remove all the comments, we just implemented a wing leveler in about 20 lines of code. That’s pretty good! …but let’s run through it in text rather than just code anyway, so we understand what’s happening here:</p>

<p>We implement our wing leveling code by solving two problems at the same time:</p>

<ol>
  <li>we want to get to a situation where our <strong>bank angle</strong> (the angle of the wings with respect to level flight) is zero, and</li>
  <li>we want to get to a situation where our <strong>bank acceleration</strong> (how fast the bank angle changes per second) is also zero.</li>
</ol>

<p>Those two are at odds with each other, and so we want to prioritize getting the bank angle to zero over getting the bank acceleration to zero, so we start by getting our current bank and bank acceleration values, and defining our maximum allowed values for those. Then:</p>

<ol>
  <li>We correct our bank in our first <code>update -= ...</code>: if we’re banking a lot, we want to correct a lot, and if we’re banking a little, we want to correct just a little, and if we’re perfectly level, we don’t want to correct at all. Which is exactly what we wrote <code>constrainMap</code> to do for us.</li>
  <li>Then, we correct our bank acceleration in the next <code>update += ...</code>, by trimming in the opposite direction of our bank acceleration. This will undo some of our bank correction, but as long as we use a smaller step size for acceleration than for the main bank correction, the code will “prioritize” zeroing our bank angle over our bank acceleration. We do, however, allow for a much larger correction that would normally be necessary, in order to deal with momentary “way too much” values caused by wind, bumping the yoke/stick, etc.</li>
  <li>Finally, we update our trim (both in our code and in MSFS) and then we wait for the autopilot to retrigger this function during the next run, letting us run through the same procedure, but with (hopefully!) slightly less wrong values. Provided that this function runs enough times, we’ll converge on level flight, and that’s exactly what we want.</li>
</ol>

<p>Of course, this does require that <code>radians</code> exists, so let’s quickly add that to our <code>utils.js</code>:</p>

<div><pre><code><span>export</span> <span>function</span> <span>radians</span><span>(</span><span>deg</span><span>)</span> <span>{</span>
  <span>return</span> <span>(</span><span>deg</span> <span>/</span> <span>180</span><span>)</span> <span>*</span> <span>PI</span><span>;</span>
<span>}</span>

<span>export</span> <span>function</span> <span>degrees</span><span>(</span><span>rad</span><span>)</span> <span>{</span>
  <span>return</span> <span>(</span><span>rad</span> <span>/</span> <span>PI</span><span>)</span> <span>*</span> <span>180</span><span>;</span>
<span>}</span>
</code></pre></div>

<h4 id="adding-a-lvl-switch">Adding a LVL switch</h4>

<p>Of course, we do still need to update the autopilot code so that we can turn this feature on and off. First, we’ll define a constants file for housing things like autopilot modes in <code>autopilot/utils/constants.js</code>:</p>

<div><pre><code><span>export</span> <span>const</span> <span>LEVEL_FLIGHT</span> <span>=</span> <span>`LVL`</span><span>;</span>
</code></pre></div>

<p>Big change, very exiting.</p>

<p>Then, we update the <code>autopilot.js</code> code to make use of this new constant, and we’ll add that <code>trim</code> vector for tracking how much we need to trim in each direction:</p>

<div><pre><code><span>import</span> <span>url</span> <span>from</span> <span>"</span><span>node:url</span><span>"</span><span>;</span>
<span>const</span> <span>__dirname</span> <span>=</span> <span>url</span><span>.</span><span>fileURLToPath</span><span>(</span><span>new</span> <span>URL</span><span>(</span><span>"</span><span>.</span><span>"</span><span>,</span> <span>import</span><span>.</span><span>meta</span><span>.</span><span>url</span><span>));</span>
<span>import</span> <span>{</span> <span>watch</span> <span>}</span> <span>from</span> <span>"</span><span>./reload-watcher.js</span><span>"</span><span>;</span>

<span>// Import our new constant...</span>
<span>import</span> <span>{</span> <span>LEVEL_FLIGHT</span> <span>}</span> <span>from</span> <span>"</span><span>../utils/constants.js</span><span>"</span><span>;</span>

<span>// and import the "fly level" code using our hot-reloading technique</span>
<span>let</span> <span>{</span> <span>flyLevel</span> <span>}</span> <span>=</span> <span>await</span> <span>watch</span><span>(</span><span>__dirname</span><span>,</span> <span>`fly-level.js`</span><span>,</span> <span>(</span><span>lib</span><span>)</span> <span>=&gt;</span> <span>(</span><span>flyLevel</span> <span>=</span> <span>lib</span><span>.</span><span>flyLevel</span><span>));</span>

<span>export</span> <span>class</span> <span>Autopilot</span> <span>{</span>
  <span>...</span>
  <span>async</span> <span>reset</span><span>(</span><span>flightInformation</span><span>,</span> <span>flightInfoUpdateHandler</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>this</span><span>.</span><span>modes</span> <span>=</span> <span>{</span>
      <span>MASTER</span><span>:</span> <span>false</span><span>,</span>
      <span>[</span><span>LEVEL_FLIGHT</span><span>]:</span> <span>false</span><span>,</span>
    <span>};</span>
    <span>this</span><span>.</span><span>resetTrim</span><span>();</span>
    <span>...</span>
  <span>}</span>

  <span>resetTrim</span><span>()</span> <span>{</span>
    <span>this</span><span>.</span><span>trim</span> <span>=</span> <span>{</span>
      <span>pitch</span><span>:</span> <span>0</span><span>,</span>
      <span>roll</span><span>:</span> <span>0</span><span>,</span>
      <span>yaw</span><span>:</span> <span>0</span><span>,</span>
    <span>};</span>
  <span>}</span>

  <span>async</span> <span>setTarget</span><span>(</span><span>key</span><span>,</span> <span>value</span><span>)</span> <span>{</span>
    <span>...</span>

    <span>// Now that we can turn the wing leveler on and off,</span>
    <span>// we'll want to make sure that when we turn it on,</span>
    <span>// we copy over the in-game trim setting into our</span>
    <span>// trim vector. Pretty important!</span>
    <span>if</span> <span>(</span><span>key</span> <span>===</span> <span>LEVEL_FLIGHT</span> <span>&amp;&amp;</span> <span>value</span> <span>===</span> <span>true</span><span>)</span> <span>{</span>
      <span>trim</span><span>.</span><span>roll</span> <span>=</span> <span>this</span><span>.</span><span>flightInformation</span><span>?.</span><span>data</span><span>.</span><span>aileronTrim</span> <span>??</span> <span>0</span><span>;</span>
      <span>console</span><span>.</span><span>log</span><span>(</span><span>`Engaging wing leveler. Initial trim:`</span><span>,</span> <span>trim</span><span>.</span><span>roll</span><span>);</span>
    <span>}</span>
  <span>}</span>

  <span>// Finally, actual autopilot functionality!</span>
  <span>async</span> <span>run</span><span>()</span> <span>{</span>
    <span>const</span> <span>{</span> <span>modes</span><span>,</span> <span>flightInformation</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>

    <span>// Get the most up to date flight information:</span>
    <span>this</span><span>.</span><span>flightInfoUpdateHandler</span><span>(</span><span>await</span> <span>flightInformation</span><span>.</span><span>update</span><span>());</span>

    <span>// Then run a single iteration of the wing leveler:</span>
    <span>if</span> <span>(</span><span>modes</span><span>[</span><span>LEVEL_FLIGHT</span><span>])</span> <span>flyLevel</span><span>(</span><span>this</span><span>,</span> <span>flightInformation</span><span>);</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>Then, let’s make sure the browser can flip that switch, too, in our <code>public/js/autopilot.js</code>:</p>

<div><pre><code><span>// This is the only thing we need to change:</span>
<span>export</span> <span>const</span> <span>AP_OPTIONS</span> <span>=</span> <span>{</span>
  <span>MASTER</span><span>:</span> <span>false</span><span>,</span>
  <span>LVL</span><span>:</span> <span>false</span><span>,</span>
<span>};</span>
</code></pre></div>

<p>And in our HTML “partial”:</p>

<div><pre><code><span>&lt;div</span> <span>class=</span><span>"controls"</span><span>&gt;</span>
  <span>&lt;link</span> <span>rel=</span><span>"stylesheet"</span> <span>href=</span><span>"/css/autopilot.css"</span> <span>/&gt;</span>
  <span>&lt;button</span> <span>class=</span><span>"MASTER"</span><span>&gt;</span>AP<span>&lt;/button&gt;</span>
  <span>&lt;button</span> <span>class=</span><span>"LVL"</span><span>&gt;</span>LVL<span>&lt;/button&gt;</span>
<span>&lt;/div&gt;</span>
</code></pre></div>

<p>And that’s it, we have a switch for turning our wing leveler on and off!</p>

<p>Now, we could test this immediately, but we’ve only implemented half of a minimal autopilot solution, and it’s going to be hard to test a wing leveler if the plane is flying to the moon, or dropping into the ocean, so let’s first implement the other half before we do some actual, honest to goodness, in-game testing.</p>

<h3 id="alt-altitude-hold">ALT: altitude hold</h3>

<p><img src="https://pomax.github.io/are-we-flying/images/alt-hold/holding-altitude.png"></p>

<p>Next up: making the plane hold its vertical position. This requires updating the “pitch trim” (also known as elevator trim) rather than our aileron trim, by looking at the plane’s vertical speed and trying to keep it at zero. That is, we’re going to look at how fast the plane is moving up or down through the air, and then we’re going to try to get that value down to zero by pitching the plane a little in whichever direction counteracts the vertical movement.</p>

<p>Let’s add a new constant to our <code>constants.js</code> file:</p>

<div><pre><code><span>export</span> <span>const</span> <span>LEVEL_FLIGHT</span> <span>=</span> <span>`LVL`</span><span>;</span>
<span>export</span> <span>const</span> <span>ALTITUDE_HOLD</span> <span>=</span> <span>`ALT`</span><span>;</span>
</code></pre></div>

<p>And then let’s add this new mode to our autopilot, too:</p>

<div><pre><code><span>import</span> <span>{</span> <span>LEVEL_FLIGHT</span><span>,</span> <span>ALTITUDE_HOLD</span> <span>}</span> <span>from</span> <span>"</span><span>./utils/constants.js</span><span>"</span><span>;</span>

<span>...</span>

<span>// We'll be doing some hot-reload-watching here too:</span>
<span>let</span> <span>{</span> <span>altitudeHold</span> <span>}</span> <span>=</span> <span>await</span> <span>watch</span><span>(</span><span>__dirname</span><span>,</span> <span>`altitude-hold.js`</span><span>,</span> <span>(</span><span>lib</span><span>)</span> <span>=&gt;</span> <span>(</span><span>altitudeHold</span> <span>=</span> <span>lib</span><span>.</span><span>altitudeHold</span><span>));</span>

<span>export</span> <span>class</span> <span>Autopilot</span> <span>{</span>
  <span>...</span>

  <span>async</span> <span>reset</span><span>(</span><span>flightInformation</span><span>,</span> <span>flightInfoUpdateHandler</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>this</span><span>.</span><span>modes</span> <span>=</span> <span>{</span>
      <span>MASTER</span><span>:</span> <span>false</span><span>,</span>
      <span>[</span><span>LEVEL_FLIGHT</span><span>]:</span> <span>false</span><span>,</span>
      <span>[</span><span>ALTITUDE_HOLD</span><span>]:</span> <span>false</span><span>,</span>
    <span>};</span>
    <span>...</span>
  <span>}</span>

  <span>setTarget</span><span>(</span><span>key</span><span>,</span> <span>value</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>// Again, we copy over the existing trim.</span>
    <span>if</span> <span>(</span><span>key</span> <span>===</span> <span>ALTITUDE_HOLD</span> <span>&amp;&amp;</span> <span>value</span> <span>===</span> <span>true</span><span>)</span> <span>{</span>
      <span>trim</span><span>.</span><span>pitch</span> <span>=</span> <span>this</span><span>.</span><span>flightInformation</span><span>?.</span><span>data</span><span>.</span><span>pitchTrim</span> <span>??</span> <span>0</span><span>;</span>
      <span>console</span><span>.</span><span>log</span><span>(</span><span>`Engaging altitude hold. Initial trim:`</span><span>,</span> <span>trim</span><span>.</span><span>pitch</span><span>);</span>
    <span>}</span>
  <span>}</span>


  <span>// Now with two functions!</span>
  <span>async</span> <span>run</span><span>()</span> <span>{</span>
    <span>const</span> <span>{</span> <span>modes</span><span>,</span> <span>flightInformation</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
		<span>this</span><span>.</span><span>flightInfoUpdateHandler</span><span>(</span><span>await</span> <span>flightInformation</span><span>.</span><span>update</span><span>());</span>
    <span>// Then run a single iteration of the wing leveler and altitude holder:</span>
    <span>if</span> <span>(</span><span>modes</span><span>[</span><span>LEVEL_FLIGHT</span><span>])</span> <span>flyLevel</span><span>(</span><span>this</span><span>,</span> <span>flightInformation</span><span>);</span>
    <span>if</span> <span>(</span><span>modes</span><span>[</span><span>ALTITUDE_HOLD</span><span>])</span> <span>altitudeHold</span><span>(</span><span>this</span><span>,</span> <span>flightInformation</span><span>);</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And then of course the <code>altitudeHold</code> function itself, which we’ll put in  <code>autopilot/altitude-hold.js</code>:</p>

<div><pre><code><span>import</span> <span>{</span> <span>constrainMap</span> <span>}</span> <span>from</span> <span>"</span><span>../utils/utils.js</span><span>"</span><span>;</span>
<span>const</span> <span>{</span> <span>abs</span> <span>}</span> <span>=</span> <span>Math</span><span>;</span>

<span>// Our default vertical speed target, if we want to hold our current</span>
<span>// altitude, is obviously zero.</span>
<span>const</span> <span>DEFAULT_TARGET_VS</span> <span>=</span> <span>0</span><span>;</span>

<span>// Also, we don't want our vertical speed to exceed 1000 feet per</span>
<span>// minute, although depending on what's happening that might change.</span>
<span>const</span> <span>DEFAULT_MAX_VS</span> <span>=</span> <span>1000</span><span>;</span>

<span>// And in order to make sure that in trying to reach that target</span>
<span>// from whatever our current vertical speed is, we limit by</span>
<span>// how much the vertical speed's allowed to change per iteration.</span>
<span>const</span> <span>DEFAULT_MAX_dVS</span> <span>=</span> <span>100</span><span>;</span>

<span>// Similar to the flyLevel code, we have no features yet, but we'll</span>
<span>// be adding those as we go, so we can quickly and easily compare</span>
<span>// how our code behaves when we turn a feature on or off.</span>
<span>const</span> <span>FEATURES</span> <span>=</span> <span>{};</span>

<span>// Then, our actual "hold altitude" function, which we're going to</span>
<span>// keep as dumb" as the "fly level" code: each time we call it, it</span>
<span>// gets to make a recommendation, without any kind of history tracking</span>
<span>// or future predictions. This keeps the code simple, and allows us</span>
<span>// to hot-reload the code.</span>
<span>export</span> <span>async</span> <span>function</span> <span>altitudeHold</span><span>(</span><span>autopilot</span><span>,</span> <span>flightInformation</span><span>)</span> <span>{</span>
  <span>// Each plane has different min/max pitch trim values, so</span>
  <span>// let's find out what our current plane's values are:</span>
  <span>const</span> <span>{</span> <span>api</span><span>,</span> <span>trim</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>
  <span>const</span> <span>{</span> <span>data</span><span>:</span> <span>flightData</span><span>,</span> <span>model</span><span>:</span> <span>flightModel</span> <span>}</span> <span>=</span> <span>flightInformation</span><span>;</span>

  <span>// What are our vertical speed values?</span>
  <span>const</span> <span>{</span> <span>VS</span> <span>}</span> <span>=</span> <span>flightData</span><span>;</span>
  <span>const</span> <span>{</span> <span>VS</span><span>:</span> <span>dVS</span> <span>}</span> <span>=</span> <span>flightData</span><span>.</span><span>d</span> <span>??</span> <span>{</span> <span>VS</span><span>:</span> <span>0</span> <span>};</span>
  <span>const</span> <span>{</span> <span>pitchTrimLimit</span> <span>}</span> <span>=</span> <span>flightModel</span><span>;</span>

  <span>// How big should our trim steps be?</span>
  <span>let</span> <span>trimLimit</span> <span>=</span> <span>pitchTrimLimit</span><span>[</span><span>0</span><span>];</span>
  <span>trimLimit</span> <span>=</span> <span>trimLimit</span> <span>===</span> <span>0</span> <span>?</span> <span>10</span> <span>:</span> <span>trimLimit</span><span>;</span>
  <span>let</span> <span>trimStep</span> <span>=</span> <span>trimLimit</span> <span>/</span> <span>10</span><span>_000</span><span>;</span>

  <span>// And what should those parameters be instead, if want to maintain our altitude?</span>
  <span>const</span> <span>{</span> <span>targetVS</span> <span>}</span> <span>=</span> <span>getTargetVS</span><span>();</span>
  <span>const</span> <span>diff</span> <span>=</span> <span>targetVS</span> <span>-</span> <span>VS</span><span>;</span>

  <span>// Just like in the flyLevel code, we first determine an update</span>
  <span>// to our trim, and then apply that only once we're done figuring out</span>
  <span>// all the increments and decrements that should involve:</span>
  <span>let</span> <span>update</span> <span>=</span> <span>0</span><span>;</span>

  <span>// Set our update to trim towards the correct vertical speed:</span>
  <span>const</span> <span>maxVS</span> <span>=</span> <span>DEFAULT_MAX_VS</span><span>;</span>
  <span>update</span> <span>+=</span> <span>constrainMap</span><span>(</span><span>diff</span><span>,</span> <span>-</span><span>maxVS</span><span>,</span> <span>maxVS</span><span>,</span> <span>-</span><span>trimStep</span><span>,</span> <span>trimStep</span><span>);</span>

  <span>// And if we're accelerating too much, counter-act that a little:</span>
  <span>const</span> <span>maxdVS</span> <span>=</span> <span>constrainMap</span><span>(</span><span>abs</span><span>(</span><span>diff</span><span>),</span> <span>0</span><span>,</span> <span>100</span><span>,</span> <span>0</span><span>,</span> <span>DEFAULT_MAX_dVS</span><span>);</span>
  <span>update</span> <span>-=</span> <span>constrainMap</span><span>(</span><span>dVS</span><span>,</span> <span>-</span><span>4</span> <span>*</span> <span>maxdVS</span><span>,</span> <span>4</span> <span>*</span> <span>maxdVS</span><span>,</span> <span>-</span><span>2</span> <span>*</span> <span>trimStep</span><span>,</span> <span>2</span> <span>*</span> <span>trimStep</span><span>);</span>

  <span>// Finally, apply the new trim value:</span>
  <span>trim</span><span>.</span><span>pitch</span> <span>+=</span> <span>update</span><span>;</span>
  <span>api</span><span>.</span><span>set</span><span>(</span><span>`ELEVATOR_TRIM_POSITION`</span><span>,</span> <span>trim</span><span>.</span><span>pitch</span><span>);</span>
<span>}</span>

<span>// This function determines what our target vertical speed should</span>
<span>// be in order to reach our desired stable flight. For now, this</span>
<span>// function simply sets the target VS to zero, but that's going to</span>
<span>// change almost immediate after we test this code, because we'll</span>
<span>// discover that you can't really "hold an altitude" if you don't</span>
<span>// actually write down what altitude you should be holding =)</span>
<span>function</span> <span>getTargetVS</span><span>()</span> <span>{</span>
  <span>// So: we'll be putting some more code here *very* soon.</span>
  <span>return</span> <span>{</span> <span>targetVS</span><span>:</span> <span>DEFAULT_TARGET_VS</span> <span>};</span>
<span>}</span>
</code></pre></div>

<p>So that’s a little more code than <code>flyLevel</code>, but not much more, still being less than 30 lines of code if we remove comments. So, let’s go over this code, too.</p>

<ul>
  <li>Again, because we added a trim vector to our autopilot, we can use its <code>pitch</code> component for our up/down trimming.</li>
  <li>And again, because some planes have explicit aileron trim controls, we want to make sure we don’t “overwrite” any existing trim setting when we engage the autopilot, so we make sure to copy over the trim value into <code>trim.pitch</code> when the user turns altitude hold on.</li>
  <li>Again, we implement our altitude hold as solving two problems at the same time :
    <ol>
      <li>We want to get to a situation where our <strong>vertical speed</strong> (how much we’re flying up or down) is zero, and</li>
      <li>we want to get to a situation where our <strong>vertical acceleration</strong> is also zero.</li>
    </ol>
  </li>
</ul>

<p>Just like before we prioritize the former by giving the latter a smaller step, and we’re good to go, and just like before we’ll allow for a much larger correction based on vertical acceleration than we’d normally need, because even during regular flight a pocket of low density air will do a number on our altitude hold.</p>

<h3 id="testing-our-code-1">Testing our code</h3>

<p>Now that we have a working “fly level” and “hold altitude” implementation, let’s see how we’re doing! And spoilers: we’re going to discover we forgot something pretty important that’ll impact both how level we’re flying, and how well we’re holding our altitude. We’re going to write some more code, but first let’s do some science and actually see what happens with the code we wrote above in place.</p>

<p>We’ll update our <code>public/js/autopilot.js</code> to include the new mode:</p>

<div><pre><code><span>// This is the only thing we need to change:</span>
<span>export</span> <span>const</span> <span>AP_OPTIONS</span> <span>=</span> <span>{</span>
  <span>MASTER</span><span>:</span> <span>false</span><span>,</span>
  <span>LVL</span><span>:</span> <span>false</span><span>,</span>
  <span>ALT</span><span>:</span> <span>false</span><span>,</span>
<span>};</span>
</code></pre></div>

<p>And we’ll update our HTML partial to include the ALT switch:</p>

<div><pre><code><span>&lt;div</span> <span>class=</span><span>"controls"</span><span>&gt;</span>
  <span>&lt;link</span> <span>rel=</span><span>"stylesheet"</span> <span>href=</span><span>"/css/autopilot.css"</span> <span>/&gt;</span>
  <span>&lt;button</span> <span>class=</span><span>"MASTER"</span><span>&gt;</span>AP<span>&lt;/button&gt;</span>
  <span>&lt;button</span> <span>class=</span><span>"LVL"</span><span>&gt;</span>LVL<span>&lt;/button&gt;</span>
  <span>&lt;button</span> <span>class=</span><span>"ALT"</span><span>&gt;</span>ALT<span>&lt;/button&gt;</span>
<span>&lt;/div&gt;</span>
</code></pre></div>

<p>Then, in order to see how well our code works, we’ll be flying around a bit in The <a href="https://en.wikipedia.org/wiki/De%5FHavilland%5FCanada%5FDHC-2%5FBeaver">De Havilland DHC-2 “Beaver”</a>, a fun little piston engine bush plane:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/planes/beaver-shot.png" alt="The DeHavilland DHC-2 &quot;Beaver&quot;"></p>

<p>And our order of operations will be to spawn the plane at cruise altitude in above the middle of the pacific ocean in fair weather, have it stabilize itself on the in-game autopilot as a substitute for manually trimming the plane, and then switch to our own autopilot (which will turn off the in-game one) to see how well that holds up. And then we’re going to compare our “before” and “after” graphs to see what we can learn.</p>

<p>See if you can tell when we switched from the in-game autopilot to our own autopilot in the following science:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/combined/initial-test.png" alt="Initial test"></p>

<p>So yeah, this should be relatively obvious: our autopilot is more aggressive than the in-game one, which means it won’t be as smooth of a ride, but the more important thing to notice is that our VS is not centered around zero, and our bank angle isn’t either, even if it’s hard to tell. We’ve left our in-game autopilot altitude of 1500 and ended up at about 1560 feet over the course of our own autopilot being active in these graphs, and we’ve also drifted to the left, starting at a heading of 341 degrees but slowly turning towards 338 by the end of the graph.</p>

<h2 id="improving-our-code">Improving our code</h2>

<p>If you look at the graph, our vertical speed is now perpetually “not actually zero”… it’s not off by a lot, but we’re definitely drifting, which isn’t <em>quite</em> the same as holding altitude. And the same is true for our wing leveler: we’re flying very nearly straight, but not <em>quite</em> straight. The obvious reason for this is that we can’t actually guarantee “straight” without some reference points: we don’t know what heading to fly, or which specific altitude to hold, so if there’s persistent wind, we’re going to get blown off course and we won’t even know.</p>

<p>This also has an extremely obvious solution: let’s make our autopilot capable of flying in a specific direction, at a specific altitude. And that’s going to be surprisingly easy!</p>

<p>Let’s start with our altitude hold: if we could just tell it <em>which</em> altitude to hold, that’d solve half the problem. And as it turns out, we can do this pretty easily with some pretty simple math: check the difference between the altitude we’re at, and the one we’re supposed to <em>be</em> at, and then pick a target VS that will help us cross that vertical distance. And while we’re at it, let’s also fix that aggressive trimming by reducing the amount we update by when we get close to our target:</p>

<div><pre><code><span>...</span>

<span>// Two feature flags!</span>
<span>const</span> <span>FEATURES</span> <span>=</span> <span>{</span>
  <span>DAMPEN_CLOSE_TO_ZERO</span><span>:</span> <span>true</span><span>,</span>
  <span>TARGET_TO_HOLD</span><span>:</span> <span>true</span><span>,</span>
<span>};</span>

<span>const</span> <span>{</span> <span>abs</span> <span>}</span> <span>=</span> <span>Math</span><span>;</span>

<span>export</span> <span>async</span> <span>function</span> <span>altitudeHold</span><span>(</span><span>autopilot</span><span>,</span> <span>flightInformation</span><span>)</span> <span>{</span>
  <span>...</span>
  <span>const</span> <span>{</span> <span>VS</span><span>,</span> <span>alt</span> <span>}</span> <span>=</span> <span>flightData</span><span>;</span>
  <span>...</span>
  <span>// we'll move this value up</span>
  <span>const</span> <span>maxVS</span> <span>=</span> <span>DEFAULT_MAX_VS</span><span>;</span>
  <span>const</span> <span>{</span> <span>targetVS</span> <span>}</span> <span>=</span> <span>await</span> <span>getTargetVS</span><span>(</span><span>maxVS</span><span>,</span> <span>alt</span><span>);</span>

  <span>...</span>

  <span>// And our first new feature! If we're close to our target, dampen</span>
  <span>// the corrections, so we don't over/undershoot the target too much.</span>
  <span>if</span> <span>(</span><span>FEATURES</span><span>.</span><span>DAMPEN_CLOSE_TO_ZERO</span><span>)</span> <span>{</span>
    <span>const</span> <span>aDiff</span> <span>=</span> <span>abs</span><span>(</span><span>diff</span><span>);</span>
    <span>if</span> <span>(</span><span>aDiff</span> <span>&lt;</span> <span>100</span><span>)</span> <span>update</span> <span>/=</span> <span>2</span><span>;</span>
    <span>if</span> <span>(</span><span>aDiff</span> <span>&lt;</span> <span>20</span><span>)</span> <span>update</span> <span>/=</span> <span>2</span><span>;</span>
  <span>}</span>

  <span>// And then we apply the new trim value:</span>
  <span>trim</span><span>.</span><span>pitch</span> <span>+=</span> <span>update</span><span>;</span>
  <span>api</span><span>.</span><span>set</span><span>(</span><span>`ELEVATOR_TRIM_POSITION`</span><span>,</span> <span>trim</span><span>.</span><span>pitch</span><span>);</span>
<span>}</span>

<span>// Then for our second feature...</span>
<span>async</span> <span>function</span> <span>getTargetVS</span><span>(</span><span>maxVS</span><span>,</span> <span>alt</span><span>)</span> <span>{</span>
  <span>let</span> <span>targetVS</span> <span>=</span> <span>DEFAULT_TARGET_VS</span><span>;</span>
  <span>let</span> <span>altDiff</span> <span>=</span> <span>undefined</span><span>;</span>

  <span>if</span> <span>(</span><span>TARGET_TO_HOLD</span><span>)</span> <span>{</span>
    <span>// Get our hold-altitude from our autopilot mode:</span>
    <span>const</span> <span>targetAltitude</span> <span>=</span> <span>autopilot</span><span>.</span><span>modes</span><span>[</span><span>ALTITUDE_HOLD</span><span>];</span>
    <span>if</span> <span>(</span><span>targetAltitude</span><span>)</span> <span>{</span>
      <span>// And then if we're above that altitude, set a target VS that's negative,</span>
      <span>// and if we're below that altitude, set a target VS that's positive:</span>
      <span>altDiff</span> <span>=</span> <span>targetAltitude</span> <span>-</span> <span>state</span><span>.</span><span>altitude</span><span>;</span>
      <span>targetVS</span> <span>=</span> <span>constrainMap</span><span>(</span><span>altDiff</span><span>,</span> <span>-</span><span>200</span><span>,</span> <span>200</span><span>,</span> <span>-</span><span>maxVS</span><span>,</span> <span>maxVS</span><span>);</span>
    <span>}</span>
  <span>}</span>

  <span>return</span> <span>{</span> <span>targetVS</span><span>,</span> <span>altDiff</span> <span>};</span>
<span>}</span>
</code></pre></div>

<p>This will require us to massage our browser code a little, so that we can actually set an altitude in our <code>autopilot.html</code> rather than only having an on/off button:</p>

<div><pre><code><span>&lt;div</span> <span>class=</span><span>"controls"</span><span>&gt;</span>
  ...
  <span>&lt;label&gt;</span>Target altitude: <span>&lt;/label&gt;</span>
  <span>&lt;input</span>
    <span>class=</span><span>"altitude"</span>
    <span>type=</span><span>"number"</span>
    <span>min=</span><span>"0"</span>
    <span>max=</span><span>"40000"</span>
    <span>value=</span><span>"4500"</span>
    <span>step=</span><span>"100"</span>
  <span>/&gt;</span>
  <span>&lt;button</span> <span>title=</span><span>"altitude hold"</span> <span>class=</span><span>"ALT"</span><span>&gt;</span>ALT<span>&lt;/button&gt;</span>
<span>&lt;/div&gt;</span>
</code></pre></div>

<p>And then we can update our browser’s <code>autopilot.js</code> to work with that input field:</p>

<div><pre><code><span>...</span>

<span>export</span> <span>class</span> <span>Autopilot</span> <span>{</span>
  <span>constructor</span><span>(</span><span>owner</span><span>)</span> <span>{</span>
    <span>...</span>

    <span>Object</span><span>.</span><span>keys</span><span>(</span><span>AP_DEFAULT</span><span>).</span><span>forEach</span><span>((</span><span>key</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>const</span> <span>e</span> <span>=</span> <span>document</span><span>.</span><span>querySelector</span><span>(</span><span>`#autopilot .</span><span>${</span><span>key</span><span>}</span><span>`</span><span>);</span>
      <span>e</span><span>?.</span><span>addEventListener</span><span>(</span><span>`click`</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
        <span>e</span><span>.</span><span>classList</span><span>.</span><span>toggle</span><span>(</span><span>`active`</span><span>);</span>
        <span>let</span> <span>value</span> <span>=</span> <span>!</span><span>e</span><span>.</span><span>classList</span><span>.</span><span>contains</span><span>(</span><span>`active`</span><span>);</span>
        <span>// Special handling for our altitude mode: instead of a</span>
        <span>// boolean, let's make this our desired altitude in feet:</span>
        <span>if</span> <span>(</span><span>value</span><span>)</span> <span>{</span>
          <span>if</span> <span>(</span><span>key</span> <span>===</span> <span>`ALT`</span><span>)</span> <span>{</span>
            <span>value</span> <span>=</span> <span>document</span><span>.</span><span>querySelector</span><span>(</span><span>`#autopilot .altitude`</span><span>).</span><span>value</span> <span>??</span> <span>1500</span><span>;</span>
          <span>}</span>
        <span>}</span>
        <span>server</span><span>.</span><span>autopilot</span><span>.</span><span>update</span><span>({</span> <span>[</span><span>key</span><span>]:</span> <span>value</span> <span>});</span>
      <span>});</span>
    <span>});</span>

    <span>// We'll also add a change handler to our number field</span>
    <span>// so that if that changes, we can let the server know:</span>
    <span>document</span>
      <span>.</span><span>querySelector</span><span>(</span><span>`#autopilot .altitude`</span><span>)</span>
      <span>?.</span><span>addEventListener</span><span>(</span><span>`change`</span><span>,</span> <span>(</span><span>evt</span><span>)</span> <span>=&gt;</span> <span>{</span>
        <span>server</span><span>.</span><span>autopilot</span><span>.</span><span>update</span><span>({</span> <span>ALT</span><span>:</span> <span>evt</span><span>.</span><span>target</span><span>.</span><span>value</span> <span>});</span>
        <span>evt</span><span>.</span><span>target</span><span>.</span><span>blur</span><span>();</span>
      <span>});</span>
  <span>}</span>

  <span>// And then we also add some ALT-specific code to our update function:</span>
  <span>update</span><span>(</span><span>flightData</span><span>,</span> <span>params</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>!</span><span>params</span><span>)</span> <span>params</span><span>;</span>

    <span>const</span> <span>altitude</span> <span>=</span> <span>document</span><span>.</span><span>querySelector</span><span>(</span><span>`#autopilot .altitude`</span><span>);</span>

    <span>Object</span><span>.</span><span>entries</span><span>(</span><span>params</span><span>).</span><span>forEach</span><span>(([</span><span>key</span><span>,</span> <span>value</span><span>])</span> <span>=&gt;</span> <span>{</span>
      <span>const</span> <span>e</span> <span>=</span> <span>document</span><span>.</span><span>querySelector</span><span>(</span><span>`#autopilot .</span><span>${</span><span>key</span><span>}</span><span>`</span><span>);</span>
      <span>e</span><span>?.</span><span>classList</span><span>.</span><span>toggle</span><span>(</span><span>`active`</span><span>,</span> <span>!!</span><span>value</span><span>);</span>

      <span>// Because if the autopilot's altitude value changes without us having</span>
      <span>// done so, (e.g. the autopilot is running an automated flight) then we</span>
      <span>// want to make sure that the browser reflects that new value:</span>
      <span>if</span> <span>(</span><span>value</span> <span>&amp;&amp;</span> <span>key</span> <span>===</span> <span>`ALT`</span><span>)</span> <span>{</span>
        <span>// With one caveat: if our cursor is in the number field, then it's</span>
        <span>// safe to say we're trying to set a (new) number, and the autopilot</span>
        <span>// update should not suddenly change the input field value.</span>
        <span>if</span> <span>(</span><span>!</span><span>altitude</span> <span>||</span> <span>altitude</span> <span>===</span> <span>document</span><span>.</span><span>activeElement</span><span>)</span> <span>return</span><span>;</span>
        <span>altitude</span><span>.</span><span>value</span> <span>=</span> <span>parseFloat</span><span>(</span><span>value</span><span>).</span><span>toFixed</span><span>(</span><span>1</span><span>);</span>
      <span>}</span>
    <span>});</span>

    <span>// And if we're not locked into flying a specific altitude, copy over</span>
    <span>// the current values so that when we click the button, we're just</span>
    <span>// telling the plane to "keep going" instead of immediately pushing</span>
    <span>// an altitude change through:</span>
    <span>if</span> <span>(</span><span>!</span><span>params</span><span>[</span><span>`ALT`</span><span>])</span> <span>altitude</span><span>.</span><span>value</span> <span>=</span> <span>round</span><span>(</span><span>flightData</span><span>.</span><span>alt</span><span>);</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>So let’s save all that and then first set both our new <code>DAMPEN_CLOSE_TO_ZERO</code> and <code>TARGET_TO_HOLD</code> features to <code>false</code>,  so that we’re still flying “the same way we did before”. Then, after we’ve established that we’re autopiloting just as aggressively (because nothing changed in terms of the code running yet), we change them to <code>true</code>, and save, to see the immediately result…</p>

<p><img src="https://pomax.github.io/are-we-flying/images/alt-hold/target-altitude.png" alt="With target altitude"></p>

<p>We see that our VS is now actually centered around zero, so we’re <em>actually</em> holding altitude, with a calmer moment-to-moment dVS, too, meaning that when we do change VS, it’s less abrupt and we’re less likely to get airsick.</p>

<p>And for the eagle eyed: we’re also no longer drifting left, our bank angle has a slight bias to the right to keep us going steady and the aileron trimming is <em>far</em> calmer. Because I ran this with the <code>fly-level.js</code> file updated in the same way as our altitude hold code: let’s add <code>DAMPEN_CLOSE_TO_ZERO</code> and <code>FLY_SPECIFIC_HEADING</code> to our wing leveler:</p>

<h3 id="flying-straight-not-just-level">Flying straight, not just level</h3>

<p>We’ll start with the browser, adding a heading field and button in <code>autopilot.html</code></p>

<div><pre><code><span>&lt;div</span> <span>class=</span><span>"controls"</span><span>&gt;</span>
  ...
  <span>&lt;label&gt;</span>Target heading: <span>&lt;/label&gt;</span>
  <span>&lt;input</span> <span>class=</span><span>"heading"</span> <span>type=</span><span>"number"</span> <span>min=</span><span>"1"</span> <span>max=</span><span>"360"</span> <span>value=</span><span>"360"</span> <span>step=</span><span>"1"</span> <span>/&gt;</span>
  <span>&lt;button</span> <span>title=</span><span>"heading mode"</span> <span>class=</span><span>"HDG"</span><span>&gt;</span>HDG<span>&lt;/button&gt;</span>
<span>&lt;/div&gt;</span>
</code></pre></div>

<p>And the associated update to the browser’s <code>autopilot.js</code>:</p>

<div><pre><code><span>...</span>

<span>const</span> <span>{</span> <span>round</span> <span>}</span> <span>=</span> <span>Math</span><span>;</span>

<span>export</span> <span>const</span> <span>AP_DEFAULT</span> <span>=</span> <span>{</span>
  <span>MASTER</span><span>:</span> <span>false</span><span>,</span>
  <span>LVL</span><span>:</span> <span>false</span><span>,</span>
  <span>ALT</span><span>:</span> <span>false</span><span>,</span>
  <span>HDG</span><span>:</span> <span>false</span><span>,</span>
<span>};</span>

<span>export</span> <span>class</span> <span>Autopilot</span> <span>{</span>
  <span>constructor</span><span>(</span><span>owner</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>if</span> <span>(</span><span>value</span><span>)</span> <span>{</span>
      <span>...</span>
      <span>// Just like we did for ALT, we turn HDG from a boolean into a number:</span>
      <span>if</span> <span>(</span><span>key</span> <span>===</span> <span>`HDG`</span><span>)</span> <span>{</span>
        <span>value</span> <span>=</span> <span>document</span><span>.</span><span>querySelector</span><span>(</span><span>`#autopilot .heading`</span><span>).</span><span>value</span> <span>??</span> <span>360</span><span>;</span>
      <span>}</span>
    <span>}</span>
    <span>...</span>

    <span>// And we add an onchange handler for the heading input field:</span>
    <span>document</span>
      <span>.</span><span>querySelector</span><span>(</span><span>`#autopilot .heading`</span><span>)</span>
      <span>?.</span><span>addEventListener</span><span>(</span><span>`change`</span><span>,</span> <span>(</span><span>evt</span><span>)</span> <span>=&gt;</span> <span>{</span>
        <span>const</span> <span>{</span> <span>value</span> <span>}</span> <span>=</span> <span>evt</span><span>.</span><span>target</span><span>;</span>
        <span>server</span><span>.</span><span>autopilot</span><span>.</span><span>update</span><span>({</span> <span>HDG</span><span>:</span> <span>value</span> <span>});</span>
        <span>evt</span><span>.</span><span>target</span><span>.</span><span>blur</span><span>();</span>
      <span>});</span>
  <span>}</span>

  <span>// And then we also add some ALT-specific code to our update function:</span>
  <span>update</span><span>(</span><span>flightData</span><span>,</span> <span>params</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>!</span><span>params</span><span>)</span> <span>params</span><span>;</span>

    <span>const</span> <span>altitude</span> <span>=</span> <span>document</span><span>.</span><span>querySelector</span><span>(</span><span>`#autopilot .altitude`</span><span>);</span>
    <span>const</span> <span>heading</span> <span>=</span> <span>document</span><span>.</span><span>querySelector</span><span>(</span><span>`#autopilot .heading`</span><span>);</span>

    <span>Object</span><span>.</span><span>entries</span><span>(</span><span>params</span><span>).</span><span>forEach</span><span>(([</span><span>key</span><span>,</span> <span>value</span><span>])</span> <span>=&gt;</span> <span>{</span>
      <span>const</span> <span>e</span> <span>=</span> <span>document</span><span>.</span><span>querySelector</span><span>(</span><span>`#autopilot .</span><span>${</span><span>key</span><span>}</span><span>`</span><span>);</span>
      <span>e</span><span>?.</span><span>classList</span><span>.</span><span>toggle</span><span>(</span><span>`active`</span><span>,</span> <span>!!</span><span>value</span><span>);</span>

      <span>if</span> <span>(</span><span>value</span> <span>&amp;&amp;</span> <span>key</span> <span>===</span> <span>`ALT`</span><span>)</span> <span>{</span>
        <span>if</span> <span>(</span><span>!</span><span>altitude</span> <span>||</span> <span>altitude</span> <span>===</span> <span>document</span><span>.</span><span>activeElement</span><span>)</span> <span>return</span><span>;</span>
        <span>altitude</span><span>.</span><span>value</span> <span>=</span> <span>parseFloat</span><span>(</span><span>value</span><span>).</span><span>toFixed</span><span>(</span><span>1</span><span>);</span>
      <span>}</span>

      <span>// Then we also add the same input field update logic so that we don't</span>
      <span>// change the field's value while the user's already typing something.</span>
      <span>if</span> <span>(</span><span>value</span> <span>&amp;&amp;</span> <span>key</span> <span>===</span> <span>`HDG`</span><span>)</span> <span>{</span>
        <span>if</span> <span>(</span><span>!</span><span>heading</span> <span>||</span> <span>heading</span> <span>===</span> <span>document</span><span>.</span><span>activeElement</span><span>)</span> <span>return</span><span>;</span>
        <span>heading</span><span>.</span><span>value</span> <span>=</span> <span>parseFloat</span><span>(</span><span>value</span><span>).</span><span>toFixed</span><span>(</span><span>1</span><span>);</span>
      <span>}</span>
    <span>});</span>

    <span>// And if HDG is not active, we want to keep the input field in sync, too:</span>
    <span>if</span> <span>(</span><span>!</span><span>params</span><span>[</span><span>`ALT`</span><span>])</span> <span>altitude</span><span>.</span><span>value</span> <span>=</span> <span>round</span><span>(</span><span>flightData</span><span>.</span><span>alt</span><span>);</span>
    <span>if</span> <span>(</span><span>!</span><span>params</span><span>[</span><span>`HDG`</span><span>])</span> <span>heading</span><span>.</span><span>value</span> <span>=</span> <span>round</span><span>(</span><span>flightData</span><span>.</span><span>heading</span><span>);</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>Then a minor update to the server’s <code>autopilot.js</code> code:</p>

<div><pre><code><span>import</span> <span>{</span> <span>ALTITUDE_HOLD</span><span>,</span> <span>HEADING_MODE</span><span>,</span> <span>LEVEL_FLIGHT</span> <span>}</span> <span>from</span> <span>"</span><span>./utils/constants.js</span><span>"</span><span>;</span>

<span>export</span> <span>class</span> <span>AutoPilot</span> <span>{</span>
  <span>constructor</span><span>(...)</span> <span>{</span>
    <span>...</span>
    <span>this</span><span>.</span><span>modes</span> <span>=</span> <span>{</span>
      <span>[</span><span>LEVEL_FLIGHT</span><span>]:</span> <span>false</span><span>,</span>
      <span>[</span><span>ALTITUDE_HOLD</span><span>]:</span> <span>false</span><span>,</span>
      <span>// We're using a new constant here mostly "because words".</span>
      <span>// While hold an altitude makes sense whether we have a number</span>
      <span>// or not, "flying level" doesn't imply a number, whereas</span>
      <span>// "flying a heading" does, so let's just add a mode:</span>
      <span>[</span><span>HEADING_MODE</span><span>]:</span> <span>false</span><span>,</span>
    <span>};</span>
    <span>...</span>
  <span>}</span>

  <span>async</span> <span>setTarget</span><span>(</span><span>key</span><span>,</span> <span>value</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>if</span> <span>(</span><span>type</span> <span>===</span> <span>HEADING_MODE</span><span>)</span> <span>{</span>
      <span>if</span> <span>(</span><span>value</span> <span>!==</span> <span>false</span><span>)</span> <span>{</span>
        <span>console</span><span>.</span><span>log</span><span>(</span><span>`Engaging heading hold at </span><span>${</span><span>value</span><span>}</span><span> degrees`</span><span>);</span>
        <span>// When we set a heading, update the "heading bug" in-game:</span>
        <span>this</span><span>.</span><span>set</span><span>(</span><span>"</span><span>AUTOPILOT_HEADING_LOCK_DIR</span><span>"</span><span>,</span> <span>value</span><span>);</span>
      <span>}</span>
    <span>}</span>
  <span>}</span>
</code></pre></div>

<p>With the <code>HEADING_MODE</code> constant added to our <code>constants.js</code>:</p>

<div><pre><code><span>...</span>
<span>export</span> <span>const</span> <span>HEADING_MODE</span> <span>=</span> <span>`HDG`</span><span>;</span>
</code></pre></div>

<p>Then, we can update <code>fly-level.js</code> to take heading and dampening-close-to-zero into account:</p>

<div><pre><code><span>import</span> <span>{</span> <span>HEADING_MODE</span> <span>}</span> <span>from</span> <span>"</span><span>../utils/constants.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>radians</span><span>,</span> <span>constrainMap</span><span>,</span> <span>getCompassDiff</span> <span>}</span> <span>from</span> <span>"</span><span>../utils/utils.js</span><span>"</span><span>;</span>
<span>const</span> <span>{</span> <span>abs</span> <span>}</span> <span>=</span> <span>Math</span><span>;</span>

<span>...</span>

<span>const</span> <span>FEATURES</span> <span>=</span> <span>{</span>
  <span>// The main feature</span>
  <span>FLY_SPECIFIC_HEADING</span><span>:</span> <span>true</span><span>,</span>
  <span>// And our additional features</span>
  <span>DAMPEN_CLOSE_TO_ZERO</span><span>:</span> <span>true</span><span>,</span>
<span>};</span>

<span>...</span>

<span>export</span> <span>async</span> <span>function</span> <span>flyLevel</span><span>(</span><span>autopilot</span><span>,</span> <span>state</span><span>)</span> <span>{</span>
  <span>...</span>
  <span>// Our "how much are we off" information, which we're going to rewrite</span>
  <span>// a little by instead calling a function to do the work for us:</span>
  <span>const</span> <span>{</span> <span>targetBank</span> <span>}</span> <span>=</span> <span>getTargetBankAndTurnRate</span><span>(</span><span>autopilot</span><span>,</span> <span>heading</span><span>);</span>
  <span>const</span> <span>diff</span> <span>=</span> <span>targetBank</span> <span>-</span> <span>bank</span><span>;</span>
  <span>...</span>

  <span>// New feature! If we're close to our target, dampen the</span>
  <span>// corrections, so we don't over/undershoot the target too much.</span>
  <span>if</span> <span>(</span><span>FEATURES</span><span>.</span><span>DAMPEN_CLOSE_TO_ZERO</span><span>)</span> <span>{</span>
    <span>const</span> <span>aDiff</span> <span>=</span> <span>abs</span><span>(</span><span>diff</span><span>);</span>
    <span>if</span> <span>(</span><span>aDiff</span> <span>&lt;</span> <span>2</span><span>)</span> <span>update</span> <span>/=</span> <span>2</span><span>;</span>
  <span>}</span>

  <span>trim</span><span>.</span><span>roll</span> <span>+=</span> <span>update</span><span>;</span>
  <span>api</span><span>.</span><span>set</span><span>(</span><span>`AILERON_TRIM_PCT`</span><span>,</span> <span>trim</span><span>.</span><span>roll</span><span>);</span>
<span>}</span>

<span>// And our new function:</span>
<span>function</span> <span>getTargetBankAndTurnRate</span><span>(</span><span>autopilot</span><span>,</span> <span>heading</span><span>,</span> <span>maxBank</span><span>)</span> <span>{</span>
  <span>const</span> <span>{</span> <span>modes</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>

  <span>let</span> <span>targetBank</span> <span>=</span> <span>DEFAULT_TARGET_BANK</span><span>;</span>
  <span>let</span> <span>maxDBank</span> <span>=</span> <span>DEFAULT_MAX_D_BANK</span><span>;</span>

  <span>// If there is an autopilot flight heading set (either because the</span>
  <span>// user set one, or because of the previous waypoint logic) then we</span>
  <span>// set a new target bank, somewhere between zero and the maximum</span>
  <span>// bank angle we want to allow, with the target bank closer to zero</span>
  <span>// the closer we already are to our target heading.</span>
  <span>let</span> <span>targetHeading</span> <span>=</span> <span>FEATURES</span><span>.</span><span>FLY_SPECIFIC_HEADING</span> <span>&amp;&amp;</span> <span>modes</span><span>[</span><span>HEADING_MODE</span><span>];</span>
  <span>let</span> <span>headingDiff</span><span>;</span>
  <span>if</span> <span>(</span><span>targetHeading</span><span>)</span> <span>{</span>
    <span>headingDiff</span> <span>=</span> <span>getCompassDiff</span><span>(</span><span>heading</span><span>,</span> <span>targetHeading</span><span>);</span>
    <span>targetBank</span> <span>=</span> <span>constrainMap</span><span>(</span><span>headingDiff</span><span>,</span> <span>-</span><span>30</span><span>,</span> <span>30</span><span>,</span> <span>maxBank</span><span>,</span> <span>-</span><span>maxBank</span><span>);</span>
    <span>maxDBank</span> <span>=</span> <span>constrainMap</span><span>(</span><span>abs</span><span>(</span><span>headingDiff</span><span>),</span> <span>0</span><span>,</span> <span>10</span><span>,</span> <span>0</span><span>,</span> <span>maxDBank</span><span>);</span>
  <span>}</span>

  <span>return</span> <span>{</span> <span>targetBank</span><span>,</span> <span>maxDBank</span><span>,</span> <span>targetHeading</span><span>,</span> <span>headingDiff</span> <span>};</span>
<span>}</span>
</code></pre></div>

<p>With a new helper function in our <code>utils.js</code> for getting the signed difference between two compass directions:</p>

<div><pre><code><span>export</span> <span>function</span> <span>getCompassDiff</span><span>(</span><span>current</span><span>,</span> <span>target</span><span>,</span> <span>direction</span> <span>=</span> <span>1</span><span>)</span> <span>{</span>
  <span>const</span> <span>diff</span> <span>=</span> <span>current</span> <span>&gt;</span> <span>180</span> <span>?</span> <span>current</span> <span>-</span> <span>360</span> <span>:</span> <span>current</span><span>;</span>
  <span>target</span> <span>=</span> <span>target</span> <span>-</span> <span>diff</span><span>;</span>
  <span>const</span> <span>result</span> <span>=</span> <span>target</span> <span>&lt;</span> <span>180</span> <span>?</span> <span>target</span> <span>:</span> <span>target</span> <span>-</span> <span>360</span><span>;</span>
  <span>if</span> <span>(</span><span>direction</span> <span>&gt;</span> <span>0</span><span>)</span> <span>return</span> <span>result</span><span>;</span>
  <span>return</span> <span>target</span> <span>&lt;</span> <span>180</span> <span>?</span> <span>360</span> <span>-</span> <span>target</span> <span>:</span> <span>target</span> <span>-</span> <span>360</span><span>;</span>
<span>}</span>
</code></pre></div>

<p>And we’re done, our wing leveler can now actually fly a heading and maintain that heading indefinitely!</p>

<h2 id="improving-altitude-hold-and-heading-mode">Improving altitude hold and heading mode</h2>

<p>Technically, we also just implemented “change logic”, because if we can set an altitude or heading, then we can also change those numbers and the plane will go “okay well that’s not what we’re doing here, let me put in corrections until we’re at that altitude/flying that heading”. But if we do that, we see that the transitions aren’t exactly smooth. If we change our altitude, and we look at the VS curve…</p>

<p><img src="https://pomax.github.io/are-we-flying/images/combined/improvement-01.png" alt="image-20240112095149402"></p>

<p>That’s definitely choppy. Things get worse though, if we try to change our heading:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/combined/improvement-02.png" alt="image-20240112095455585"></p>

<p>The heading change isn’t super smooth either, but what’s worse is that when we bank we’re going to drop (because that’s how physics works, we’ve traded lift for torque), and in order to compensate the autopilot will change the plane’s pitch, but then when we come out of our turn, that extra VS pushes us up, then the autopilot tries to correct for that, but it’s a bit too much, so we end up undershooting, then the autopilot tries to correct for a VS that’s already larger than it can cope with, so it adds as much as it can, and we overshoot. And now we’re in a situation where we’re <em>technically</em> in a “stable flight” configuration, but my goodness <em>would it ever be uncomfortable</em>:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/combined/improvement-03.png" alt="image-20240112095836943"></p>

<p>We might not be crashing, but we’re also not really “flying” anymore, we’re on a nightmare rollercoaster of death. So let’s fix that.</p>

<h3 id="emergency-altitude-intervention">Emergency altitude intervention</h3>

<p>Let’s fix our altitude hold code so that we can get out of the above situation, by adding some emergency trimming to stabilize our vertical speed, and some code to “snap” to our target heading instead of oscillating around that for a (short, but noticable) time. Time for more features!</p>

<div><pre><code><span>// We're going to make our maximum rate of change</span>
<span>// for vertical speed a little more permissive:</span>
<span>const</span> <span>DEFAULT_MAX_dVS</span> <span>=</span> <span>200</span><span>;</span>

<span>// And then we'll add our new feature flag:</span>
<span>const</span> <span>FEATURES</span> <span>=</span> <span>{</span>
  <span>...</span>
  <span>EMERGENCY_PROTECTION</span><span>:</span> <span>true</span><span>,</span>
<span>};</span>

<span>export</span> <span>async</span> <span>function</span> <span>altitudeHold</span><span>(</span><span>autopilot</span><span>,</span> <span>flightInformation</span><span>)</span> <span>{</span>
  <span>...</span>

  <span>// A slight update to our dVS logic: allow it to fully counteract the VS update</span>
  <span>const</span> <span>maxdVS</span> <span>=</span> <span>constrainMap</span><span>(</span><span>abs</span><span>(</span><span>diff</span><span>),</span> <span>0</span><span>,</span> <span>100</span><span>,</span> <span>0</span><span>,</span> <span>DEFAULT_MAX_dVS</span><span>);</span>
  <span>update</span> <span>+=</span> <span>constrainMap</span><span>(</span><span>dVS</span><span>,</span> <span>-</span><span>maxdVS</span><span>,</span> <span>maxdVS</span><span>,</span> <span>trimStep</span><span>,</span> <span>-</span><span>trimStep</span><span>);</span>

  <span>...</span>

  <span>// And the feature itself: an emergency trimming override for when we're</span>
  <span>// ascending or descending too fast, or if the rate of change in our</span>
  <span>// vertical speed indicates that we might get in that situation soon.</span>
  <span>if</span> <span>(</span><span>FEATURES</span><span>.</span><span>EMERGENCY_PROTECTION</span><span>)</span> <span>{</span>
    <span>// Do we need to intervene? If so, throw away the update we just computed.</span>
    <span>const</span> <span>VS_EMERGENCY</span> <span>=</span> <span>VS</span> <span>&lt;</span> <span>-</span><span>DEFAULT_MAX_VS</span> <span>||</span> <span>VS</span> <span>&gt;</span> <span>DEFAULT_MAX_VS</span><span>;</span>
    <span>const</span> <span>DVS_EMERGENCY</span> <span>=</span> <span>dVS</span> <span>&lt;</span> <span>-</span><span>DEFAULT_MAX_dVS</span> <span>||</span> <span>dVS</span> <span>&gt;</span> <span>DEFAULT_MAX_dVS</span><span>;</span>
    <span>if</span> <span>(</span><span>VS_EMERGENCY</span> <span>||</span> <span>DVS_EMERGENCY</span><span>)</span> <span>{</span>
      <span>update</span> <span>=</span> <span>0</span><span>;</span>
    <span>}</span>
    <span>// And instead run much larger corrections by constraining from a much</span>
    <span>// larger input interval to a much larger output interval. Let's go with</span>
    <span>// four times bigger, but you can experiment with this value yourself!</span>
    <span>const</span> <span>f</span> <span>=</span> <span>4</span><span>;</span>
    <span>const</span> <span>fMaxVS</span> <span>=</span> <span>f</span> <span>*</span> <span>maxVS</span><span>;</span>
    <span>const</span> <span>fMaxdVS</span> <span>=</span> <span>f</span> <span>*</span> <span>MaxdVS</span><span>;</span>
    <span>const</span> <span>fStep</span> <span>=</span> <span>f</span> <span>*</span> <span>trimStep</span><span>;</span>
    <span>// Are we exceeding our "permissible" vertical speed?</span>
    <span>if</span> <span>(</span><span>VS_EMERGENCY</span><span>)</span> <span>{</span>
      <span>console</span><span>.</span><span>log</span><span>(</span><span>`VS emergency! (</span><span>${</span><span>VS</span><span>}</span><span>/</span><span>${</span><span>maxVS</span><span>}</span><span>)`</span><span>);</span>
      <span>update</span> <span>+=</span> <span>constrainMap</span><span>(</span><span>VS</span><span>,</span> <span>-</span><span>fMaxVS</span><span>,</span> <span>fMaxVS</span><span>,</span> <span>fStep</span><span>,</span> <span>-</span><span>fStep</span><span>);</span>
    <span>}</span>
    <span>// What about the rate of change of our vertical speed?</span>
    <span>if</span> <span>(</span><span>DVS_EMERGENCY</span><span>)</span> <span>{</span>
      <span>console</span><span>.</span><span>log</span><span>(</span><span>`VS delta emergency! (</span><span>${</span><span>dVS</span><span>}</span><span>/</span><span>${</span><span>maxdVS</span><span>}</span><span>)`</span><span>);</span>
      <span>update</span> <span>+=</span> <span>constrainMap</span><span>(</span><span>dVS</span><span>,</span> <span>-</span><span>fMaxdVS</span><span>,</span> <span>fMaxdVS</span><span>,</span> <span>fStep</span><span>,</span> <span>-</span><span>fStep</span><span>);</span>
    <span>}</span>
  <span>}</span>

  <span>trim</span><span>.</span><span>pitch</span> <span>+=</span> <span>update</span><span>;</span>
  <span>api</span><span>.</span><span>set</span><span>(</span><span>`ELEVATOR_TRIM_POSITION`</span><span>,</span> <span>trim</span><span>.</span><span>pitch</span><span>);</span>
<span>}</span>
</code></pre></div>

<p>And this seems to have tamed our rollercoaster well enough:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/combined/alt-intervention/alt-intervention.png" alt="ALT intervention"></p>

<p>Putting it through its paces by running four 100 degree turns shows that we’re still not turning “perfectly level”, but that’s fine, at least we manage to make a turn and end up pointing in the right direction, at the right altitude after coming out of our turn, instead of things going horribly wrong.</p>

<p>In fact, let’s intentionally make things go horribly wrong by yanking on the stick and making the plane rocket upwards, as well as push down to induce a nose dive. Do we stabilize to a safe situation again?</p>

<p><img src="https://pomax.github.io/are-we-flying/images/combined/alt-intervention/alt-intervention%202.png" alt="ALT intervention"></p>

<p>We do! Sure, it won’t be comfortable, and it’ll be scary as heck, but we can just ride it out, instead of either getting stuck in a nightmare ride or our plane crashing.</p>

<h3 id="snapping-to-a-new-heading">Snapping to a new heading</h3>

<p>Another thing we’ll want to “fix” (in quotes because it’s not super terrible right now, but definitely a bit weird) is that when you change from one heading to another, we overshoot the new heading by a few degrees, and it takes a little while for the plane to correct for that overshoot. At which point it might overshoot <em>again</em> by a degree or so, before finally making it to pointing the heading we wanted. That’s… annoying. The reason for this is that we’re correcting based on a difference in bank angle, without regard for the difference in heading, so by the time we get to our target heading, the bank angle only just realized it should be 0 and the plane needs some time to fully catch up.</p>

<p>So let’s add a <code>SNAP_TO_HEADING</code> feature to our <code>fly-level.js</code> that checks how close we actually are to our target heading, and if we’re close, very close, or <em>super</em> close, boosts the update we need to force the bank angle to undershoot  a little, thus counteracting the overshoot:</p>

<div><pre><code><span>const</span> <span>FEATURES</span> <span>=</span> <span>{</span>
  <span>...</span>
  <span>SNAP_TO_HEADING</span><span>:</span> <span>true</span><span>,</span>
<span>};</span>

<span>// "snap to heading" settings</span>
<span>const</span> <span>BUMP_FACTOR</span> <span>=</span> <span>1.8</span><span>;</span>

<span>export</span> <span>async</span> <span>function</span> <span>flyLevel</span><span>(</span><span>autopilot</span><span>,</span> <span>state</span><span>)</span> <span>{</span>
  <span>...</span>

  <span>let</span> <span>update</span> <span>=</span> <span>0</span><span>;</span>

  <span>// We use a new variable for the bank update, so we can boost that as needed:</span>
  <span>let</span> <span>bankDiff</span> <span>=</span> <span>constrainMap</span><span>(</span><span>diff</span><span>,</span> <span>-</span><span>maxBank</span><span>,</span> <span>maxBank</span><span>,</span> <span>-</span><span>step</span><span>,</span> <span>step</span><span>);</span>

  <span>// And then we add three rounds of boosting based on how</span>
  <span>// close to our intended target heading we are.</span>
  <span>if</span> <span>(</span><span>FEATURES</span><span>.</span><span>SNAP_TO_HEADING</span><span>)</span> <span>{</span>
    <span>const</span> <span>aHeadingDiff</span> <span>=</span> <span>abs</span><span>(</span><span>headingDiff</span><span>);</span>
    <span>// We're going to run the snapping logic for as long as we're half</span>
    <span>// a degree off of our intended target heading:</span>
    <span>if</span> <span>(</span><span>aHeadingDiff</span> <span>&gt;</span> <span>0.5</span> <span>&amp;&amp;</span> <span>aHeadingDiff</span> <span>&lt;</span> <span>5</span><span>)</span> <span>{</span>
      <span>// And the way we make sure we snap is with some step-wise bumping:</span>
      <span>const</span> <span>bump</span> <span>=</span> <span>BUMP_FACTOR</span><span>;</span>
      <span>bankDiff</span> <span>*=</span> <span>bump</span><span>;</span>
      <span>if</span> <span>(</span><span>aHeadingDiff</span> <span>&lt;</span> <span>2</span><span>)</span> <span>{</span>
        <span>bankDiff</span> <span>*=</span> <span>bump</span><span>;</span>
        <span>if</span> <span>(</span><span>aHeadingDiff</span> <span>&lt;</span> <span>1</span><span>)</span> <span>{</span>
          <span>bankDiff</span> <span>*=</span> <span>bump</span><span>;</span>
        <span>}</span>
      <span>}</span>
    <span>}</span>
    <span>// This may be counteracted by DAMPEN_CLOSE_TO_ZERO, but that won't</span>
    <span>// kick in until dBank has been taken into account, so we're not</span>
    <span>// necessarily always going to undo there was we're doing here.</span>
  <span>}</span>

  <span>update</span> <span>-=</span> <span>bankDiff</span><span>;</span>

  <span>...</span>
<span>}</span>

<span>// And let's add 2 letters to our target finding function to help us out, too:</span>
<span>function</span> <span>getTargetBankAndTurnRate</span><span>(</span><span>autopilot</span><span>,</span> <span>heading</span><span>,</span> <span>maxBank</span><span>)</span> <span>{</span>
  <span>...</span>
  <span>if</span> <span>(</span><span>targetHeading</span><span>)</span> <span>{</span>
    <span>// instead of targeting "the actual heading", we're going to target</span>
    <span>// a heading midway between "here" and "the real target". This changes</span>
    <span>// our targeting behaviour from a linear function into a quadratic</span>
    <span>// easing function. Nice!</span>
    <span>headingDiff</span> <span>=</span> <span>getCompassDiff</span><span>(</span><span>heading</span><span>,</span> <span>targetHeading</span><span>)</span> <span>/</span> <span>2</span><span>;</span>
    <span>...</span>
  <span>}</span>
  <span>...</span>
<span>}</span>
</code></pre></div>

<p>Let’s look at the difference this makes, by temporarily changing the charting config for our <code>heading</code> value from “always show the full 0 through 360 degrees” to “dynamically zoom the graph as needed” (similar to how vertical speed gets plotted). First, changing course from 250 degrees to 300 degrees and back with <code>SNAP_TO_HEADING</code> turned off vs. with <code>SNAP_TO_HEADING</code> turned on:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/combined/heading-snap/snap-to-heading.png" alt="Snap to heading"></p>

<p>Much better. The first two turns with our original code take “forever” to actually stabilize, overshooting, then again, and then <em>again</em>, whereas with snapping turned on we get to our target heading and then as the name implies we “snap to that heading” and now that’s the direction we’re going.</p>

<h2 id="edge-case-testing">Edge-case testing</h2>

<p>Now that we have pretty decent control of both the horizontal and the vertical, let’s see what happens when we throw this code at some fun edge cases: planes that don’t quite follow the same recipe as most other planes. Like….</p>

<p><img src="https://pomax.github.io/are-we-flying/images/planes/top-rudder-shot.png" alt="Top Rudder Solo 103"></p>

<p>The <a href="https://www.toprudderaircraft.com/product-page/103solo-standard">Top Rudder Solo 103</a> - this type of plane was never meant to have an autopilot. Under no circumstances should you try to add one in real life. Not that you could if you wanted to, Which no sane person would want. So we will. <em>Because we can</em>.</p>

<p>That said, this is the least likely plane to succeed, mostly because it flies so close to its stall speed: when the stars align it’ll do 60 knots, but 50 is more typical, at 30 knots there’s a good chance that you’ll fall out of the sky when you even so much as thinking about tipping the wings because you’re on the edge of no longer having enough lift to maintain altitude, and at 25 knots it’s just a brick. Not a problem under normal operation, but when we slap on an autopilot… let’s just say things might get exciting!</p>

<p>So, let’s see what happens when we start a flight and turn on our autopilot. We’ll first see if it can hold an altitude, then set it to climb, see if it can do that, and then set it to descend, and see if it can do that.</p>

<p><img src="https://pomax.github.io/are-we-flying/images/combined/top-rudder-failure.png" alt="A Top Rudder failure..."></p>

<p>…We… uh… yeah, we may need to do something about that. Things start out alright, where we’re holding altitude perfectly fine, but once we start to climb, things start to go wrong, fast. See that “speed” graph? That’s showing us that as we’re climbing, we’re losing speed. Nothing unusual about that, but we’re losing <em>a lot</em> of speed. So much so, in fact, that we drop below the safe climbing speed of 30 knots, all the way down to below stall speed at 21 knots. And then it’s basically game over.</p>

<p>So let’s add “making sure we have enough speed to stay in the air” to our emergency handling in <code>altitude-hold.js</code>:</p>

<div><pre><code><span>...</span>
<span>export</span> <span>async</span> <span>function</span> <span>altitudeHold</span><span>(</span><span>autopilot</span><span>,</span> <span>flightInformation</span><span>)</span> <span>{</span>
  <span>const</span> <span>{</span> <span>api</span><span>,</span> <span>trim</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>
  <span>const</span> <span>{</span> <span>data</span><span>:</span> <span>flightData</span><span>,</span> <span>model</span><span>:</span> <span>flightModel</span> <span>}</span> <span>=</span> <span>flightInformation</span><span>;</span>

  <span>// we're going to need our current speed, and the plane's climb and cruise speeds:</span>
  <span>const</span> <span>{</span> <span>VS</span><span>,</span> <span>alt</span><span>,</span> <span>pitch</span><span>,</span> <span>speed</span> <span>}</span> <span>=</span> <span>flightData</span><span>;</span>
  <span>const</span> <span>{</span> <span>VS</span><span>:</span> <span>dVS</span><span>,</span> <span>pitch</span><span>:</span> <span>dPitch</span> <span>}</span> <span>=</span> <span>flightData</span><span>.</span><span>d</span> <span>??</span> <span>{</span> <span>VS</span><span>:</span> <span>0</span><span>,</span> <span>pitch</span><span>:</span> <span>0</span> <span>};</span>
  <span>const</span> <span>{</span> <span>pitchTrimLimit</span><span>,</span> <span>climbSpeed</span><span>,</span> <span>cruiseSpeed</span> <span>}</span> <span>=</span> <span>flightModel</span><span>;</span>

  <span>let</span> <span>trimLimit</span> <span>=</span> <span>pitchTrimLimit</span><span>[</span><span>0</span><span>];</span>
  <span>trimLimit</span> <span>=</span> <span>trimLimit</span> <span>===</span> <span>0</span> <span>?</span> <span>10</span> <span>:</span> <span>trimLimit</span><span>;</span>
  <span>let</span> <span>trimStep</span> <span>=</span> <span>trimLimit</span> <span>/</span> <span>10</span><span>_000</span><span>;</span>

  <span>const</span> <span>maxVS</span> <span>=</span> <span>DEFAULT_MAX_VS</span><span>;</span>
  <span>// then we pass those on to the function that calculates our target VS</span>
  <span>const</span> <span>{</span> <span>targetVS</span><span>,</span> <span>targetAlt</span><span>,</span> <span>altDiff</span> <span>}</span> <span>=</span> <span>getTargetVS</span><span>(</span><span>autopilot</span><span>,</span> <span>maxVS</span><span>,</span> <span>alt</span><span>,</span> <span>speed</span><span>,</span> <span>climbSpeed</span><span>,</span> <span>cruiseSpeed</span><span>);</span>

  <span>...</span>
<span>}</span>

<span>function</span> <span>getTargetVS</span><span>(</span><span>autopilot</span><span>,</span> <span>maxVS</span><span>,</span> <span>alt</span><span>,</span> <span>speed</span><span>,</span> <span>climbSpeed</span><span>,</span> <span>cruiseSpeed</span><span>)</span> <span>{</span>
  <span>...</span>

  <span>if</span> <span>(</span><span>FEATURES</span><span>.</span><span>EMERGENCY_PROTECTION</span><span>)</span> <span>{</span>
    <span>// Are we getting dangerously slow during a climb?</span>
    <span>const</span> <span>threshold</span> <span>=</span> <span>climbSpeed</span> <span>+</span> <span>10</span><span>;</span>
    <span>if</span> <span>(</span><span>targetVS</span> <span>&gt;</span> <span>0</span> <span>&amp;&amp;</span> <span>speed</span> <span>&lt;</span> <span>threshold</span><span>)</span> <span>{</span>
      <span>console</span><span>.</span><span>log</span><span>(</span><span>`Speed emergency! (</span><span>${</span><span>speed</span><span>}</span><span>/</span><span>${</span><span>threshold</span><span>}</span><span>)`</span><span>);</span>
      <span>// If we're at climbSpeed, which is the absolute slowest we can go</span>
      <span>// if we want to safely climb, just stop climbing entirely. Otherwise,</span>
      <span>// interpolate between "don't climb" and half the original target VS</span>
      <span>// at our theshold speed.</span>
      <span>targetVS</span> <span>=</span> <span>constrainMap</span><span>(</span><span>speed</span><span>,</span> <span>climbSpeed</span><span>,</span> <span>threshold</span><span>,</span> <span>0</span><span>,</span> <span>targetVS</span><span>/</span><span>2</span><span>);</span>
    <span>}</span>
  <span>}</span>

  <span>return</span> <span>{</span> <span>targetVS</span><span>,</span> <span>targetAlt</span><span>,</span> <span>altDiff</span> <span>};</span>
<span>}</span>
</code></pre></div>

<p>This code should be fairly self-explanatory (given the code comments): SimConnect gives us various design speeds, include the “safe climb speed” (V<sub>Y</sub>), cruise speed (V<sub>C</sub>), and stall speeds (V<sub>S<sub>0</sub></sub> for stall speed when set up to land, and V<sub>S<sub>1</sub></sub> for stall speed during regular flight) so we can use those to determine whether we’ve slowed down too much. We don’t actually want the plane below the climb speed (so we can ignore the stall speeds) so we can check whether we’ve dropped below “10 knots above the climb speed” (10 knots above, because if our speed’s already dropping, it’s goin got keep dropping while we try to correct for it, so we need that safety byffer), and if so we fairly aggressively reduce the target vertical speed calculated so far, to the point where if our speed ends up at climb speed, we just set it to zero. This might mean we climb a <em>lot</em> slower than we otherwise would, but on the upside we’re going to <em>keep</em> climbing instead of dropping out of the sky!</p>

<p>So we’re no longer at risk of the death spiral we were getting in before. In fact, we can now “comfortably” climb from 1500 feet up to 6000 feet, and back down to 1500, and then back up to 6000 etc. etc:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/combined/top-rudder-success.png" alt="Top Rudder success!"></p>

<p>…insofar as flying up to that altitude can be called comfortable when piloting an ultralight, or course… I hope we’re wearing thermal pants! And can I just point out: <strong>we added an autopilot to an ultralight</strong>. That alone would be an amazing bit of open source to run alongside your game! And we’re only getting started!</p>

<p>Buuuuut just out of curiosity, what if we change altitude and heading at the same time? Let’s try a 500 foot climb with a 90 degree turn at the same time, and then a 500 foot descent with another 90 degree turn. Place your bets on what will happen… will we live?</p>

<p><img src="https://pomax.github.io/are-we-flying/images/combined/top-rudder-success-2.png" alt="Top Rudder success!"></p>

<p>We will! It’s certainly not confidence inspiring, it doesn’t look like a thing we’ll ever <em>actually</em> want to do, and even if we do, we’ll probably want our hands on the stick despite having an “autopilot”, but: we’ll live! Excellent!</p>

<p>(You may also notice that we seem to be far most stable going down than going up: turns out actually having enough air flowing over your control surfaces makes an aircraft easier to work with… who knew!)</p>

<p>So let’s try another edge-case. A normal plane, but one that doesn’t have aileron trim. How do we deal with that?</p>

<h2 id="planes-without-aileron-trim">Planes without aileron trim</h2>

<p>Not all planes have aileron trim, instead relying on setting a rudder trim to keep the plane straight, and the stick to do all the maneuvering, which means that our autopilot isn’t much use. We’d be able to maintain an altitude, since virtually all planes have pitch trim, but that alone won’t keep us in the air. You’d think that was something you could ask SimConnect about, but while there is an <code>AILERON_TRIM_DISABLED</code> variable, that only tells you whether it’s <em>disabled</em>, and does not tell you whether there <em>is</em> one or not. Instead, we’re left having to just “compile a list of planes, as we find them”, so… find, let’s do that, even though it’s quite dumb:</p>

<div><pre><code><span>export</span> <span>class</span> <span>FlightInformation</span> <span>{</span>
  <span>...</span>

  <span>// Then our "update the model" code:</span>
  <span>async</span> <span>updateModel</span><span>()</span> <span>{</span>
    <span>const</span> <span>data</span> <span>=</span> <span>await</span> <span>api</span><span>.</span><span>get</span><span>(...</span><span>FLIGHT_MODEL</span><span>);</span>
    <span>if</span> <span>(</span><span>!</span><span>data</span><span>)</span> <span>return</span> <span>(</span><span>this</span><span>.</span><span>flightModel</span> <span>=</span> <span>false</span><span>);</span>

    <span>// Make sure to run our quality-of-life functions:</span>
    <span>convertValues</span><span>(</span><span>data</span><span>);</span>
    <span>renameData</span><span>(</span><span>data</span><span>);</span>

    <span>// Does this plane have aileron trim?</span>
    <span>const</span> <span>noAileron</span> <span>=</span> <span>[</span><span>`Turbo Arrow`</span><span>];</span>
    <span>data</span><span>.</span><span>hasAileronTrim</span> <span>=</span> <span>!</span><span>noAileron</span><span>.</span><span>some</span><span>(</span><span>t</span> <span>=&gt;</span>
      <span>data</span><span>.</span><span>title</span><span>.</span><span>toLowerCase</span><span>().</span><span>includes</span><span>(</span><span>t</span><span>.</span><span>toLowerCase</span><span>())</span>
    <span>);</span>

    <span>// Create a convenience value for trimming</span>
    <span>data</span><span>.</span><span>pitchTrimLimit</span> <span>=</span> <span>[</span><span>data</span><span>.</span><span>trimUpLimit</span> <span>??</span> <span>10</span><span>,</span> <span>data</span><span>.</span><span>trimDownLimit</span> <span>??</span> <span>-</span><span>10</span><span>];</span>
    <span>return</span> <span>(</span><span>this</span><span>.</span><span>model</span> <span>=</span> <span>data</span><span>);</span>
  <span>}</span>

  <span>...</span>
<span>}</span>
</code></pre></div>

<p>We can now tap into the flight model’s <code>hasAileronTrim</code> value to see whether we can just trim, or whether we need to level the plane by “attaching some strings to the steering wheel” in our <code>fly-level.js</code>:</p>

<div><pre><code><span>...</span>
<span>export</span> <span>async</span> <span>function</span> <span>flyLevel</span><span>(</span><span>autopilot</span><span>,</span> <span>state</span><span>)</span> <span>{</span>
  <span>const</span> <span>{</span> <span>trim</span><span>,</span> <span>api</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>
  <span>const</span> <span>{</span> <span>data</span><span>:</span> <span>flightData</span><span>,</span> <span>model</span><span>:</span> <span>flightModel</span> <span>}</span> <span>=</span> <span>state</span><span>;</span>

  <span>// Flight data</span>
  <span>const</span> <span>{</span> <span>bank</span><span>,</span> <span>speed</span><span>,</span> <span>heading</span><span>,</span> <span>turnRate</span> <span>}</span> <span>=</span> <span>flightData</span><span>;</span>
  <span>const</span> <span>{</span> <span>bank</span><span>:</span> <span>dBank</span> <span>}</span> <span>=</span> <span>flightData</span><span>.</span><span>d</span> <span>??</span> <span>{</span> <span>bank</span><span>:</span> <span>0</span> <span>};</span>

  <span>// Model data</span>
  <span>const</span> <span>{</span> <span>hasAileronTrim</span><span>,</span> <span>weight</span> <span>}</span> <span>=</span> <span>flightModel</span><span>;</span>
  <span>const</span> <span>useStickInstead</span> <span>=</span> <span>hasAileronTrim</span> <span>===</span> <span>false</span><span>;</span>

  <span>// Our original step, based on the assumption that we're working</span>
  <span>// with trim, is now a "let" rather than a "const":</span>
  <span>let</span> <span>step</span> <span>=</span> <span>constrainMap</span><span>(</span><span>speed</span><span>,</span> <span>20</span><span>,</span> <span>150</span><span>,</span> <span>radians</span><span>(</span><span>0.1</span><span>),</span> <span>radians</span><span>(</span><span>5</span><span>));</span>

  <span>// Because we'll need to change it if we're "trimming" on the stick:</span>
  <span>let</span> <span>aileron</span> <span>=</span> <span>0</span><span>;</span>
  <span>if</span> <span>(</span><span>useStickInstead</span><span>)</span> <span>{</span>
    <span>step</span> <span>=</span> <span>constrainMap</span><span>(</span><span>weight</span><span>,</span> <span>1000</span><span>,</span> <span>6000</span><span>,</span> <span>1</span><span>,</span> <span>3</span><span>);</span>
    <span>aileron</span> <span>=</span> <span>flightData</span><span>.</span><span>aileron</span> <span>/</span> <span>100</span><span>;</span> <span>// make sure aileron is in the range [-1,1]</span>
  <span>}</span>

  <span>const</span> <span>maxBank</span> <span>=</span> <span>constrainMap</span><span>(</span><span>speed</span><span>,</span> <span>50</span><span>,</span> <span>200</span><span>,</span> <span>10</span><span>,</span> <span>DEFAULT_MAX_BANK</span><span>);</span>
  <span>const</span> <span>{</span> <span>targetBank</span><span>,</span> <span>maxDBank</span><span>,</span> <span>targetHeading</span><span>,</span> <span>headingDiff</span> <span>}</span> <span>=</span>
    <span>// ...and we'll need this function to know whether we're on stick or not, too.</span>
    <span>getTargetBankAndTurnRate</span><span>(</span><span>autopilot</span><span>,</span> <span>heading</span><span>,</span> <span>maxBank</span><span>,</span> <span>useStickInstead</span><span>);</span>

  <span>...</span>

  <span>// And of course, we now need to either update the aileron trim</span>
  <span>// or just "the aileron", so: which one are we working with?</span>
  <span>if</span> <span>(</span><span>useStickInstead</span><span>)</span> <span>{</span>
    <span>const</span> <span>position</span> <span>=</span> <span>aileron</span> <span>+</span> <span>update</span> <span>/</span> <span>100</span><span>;</span>
    <span>// Even though the aileron value is reported as percentage, when</span>
    <span>// *setting* the aileron you need to map that to [-16384,+16384],</span>
    <span>// and it has to be a clean integer value or it'll crash SimConnect</span>
    <span>// Oh, and a positive aileron value corresponds to a negative here.</span>
    <span>// Because of course it does.</span>
    <span>api</span><span>.</span><span>trigger</span><span>(</span><span>"</span><span>AILERON_SET</span><span>"</span><span>,</span> <span>(</span><span>-</span><span>16383</span> <span>*</span> <span>position</span><span>)</span> <span>|</span> <span>0</span><span>);</span>
  <span>}</span> <span>else</span> <span>{</span>
    <span>trim</span><span>.</span><span>roll</span> <span>+=</span> <span>update</span><span>;</span>
    <span>api</span><span>.</span><span>set</span><span>(</span><span>"</span><span>AILERON_TRIM_PCT</span><span>"</span><span>,</span> <span>trim</span><span>.</span><span>roll</span><span>);</span>
  <span>}</span>
<span>}</span>

<span>function</span> <span>getTargetBankAndTurnRate</span><span>(</span><span>autopilot</span><span>,</span> <span>heading</span><span>,</span> <span>maxBank</span><span>,</span> <span>useStickInstead</span><span>)</span> <span>{</span>
  <span>...</span>

  <span>if</span> <span>(</span><span>targetHeading</span><span>)</span> <span>{</span>
    <span>headingDiff</span> <span>=</span> <span>getCompassDiff</span><span>(</span><span>heading</span><span>,</span> <span>targetHeading</span><span>);</span>
    <span>// if we're flying on stick, we use a sliding target, where we always</span>
    <span>// target half the distance to our real target. This will converge on</span>
    <span>// the real target as we progress through the turn, but it lets us</span>
    <span>// not overshoot (much) by taking slower to make the turn, especially</span>
    <span>// as we get close to our target.</span>
    <span>if</span> <span>(</span><span>useStickInstead</span><span>)</span> <span>headingDiff</span> <span>/=</span> <span>2</span><span>;</span>
    <span>targetBank</span> <span>=</span> <span>constrainMap</span><span>(</span><span>headingDiff</span><span>,</span> <span>-</span><span>30</span><span>,</span> <span>30</span><span>,</span> <span>maxBank</span><span>,</span> <span>-</span><span>maxBank</span><span>);</span>
    <span>maxDBank</span> <span>=</span> <span>constrainMap</span><span>(</span><span>abs</span><span>(</span><span>headingDiff</span><span>),</span> <span>0</span><span>,</span> <span>10</span><span>,</span> <span>0</span><span>,</span> <span>maxDBank</span><span>);</span>
  <span>}</span>

  <span>return</span> <span>{</span> <span>targetBank</span><span>,</span> <span>maxDBank</span><span>,</span> <span>targetHeading</span><span>,</span> <span>headingDiff</span> <span>};</span>
<span>}</span>
</code></pre></div>

<p>We’re partially “guessing” here, with an alternative step size based on “flying a bunch of planes and seeing what works”. The heading also isn’t held as strictly as the trim-based approach, but at least now we can <em>fly</em> planes without aileron trim, even if it’s going to be less precise. In fact, we’re probably going to drift, but again: we’ll take it. At least things “work”.</p>

<p><img src="https://pomax.github.io/are-we-flying/images/planes/turbo-arrow-III-shot.png" alt="the Piper Turbo Arrow III"></p>

<p>Let’s use Just Flight’s <a href="https://www.justflight.com/product/pa-28r-turbo-arrow-iii-iv-microsoft-flight-simulator">PA28 Piper Turbo Arrow III</a> to demonstrate the effect of this code, setting it to a heading of 250 degrees, switching to 300, and then back to 250. It can’t strictly hold those, but it’s “close enough to probably be fine if we have a flight path”, which we’ll tackle in part 4.</p>

<p><img src="https://pomax.github.io/are-we-flying/images/combined/no-aileron-trim/level-on-stick.png" alt="Leveling using the stick"></p>

<p>The Piper settles a few degrees off from the actual heading it needs to fly (actually flying 253, 303, and 253) but given how few planes are “broken” in this way, we’re going to call that good enough. We could test a few more planes that don’t have aileron trim, and if they’re all off in the same way, we can always just “cheat” by updating <code>getTargetBankAndTurnRate</code> so that it uses a heading that’s 3 degrees less than what we specified or something. But that’s more of an “if there’s a plane we like to fly with this specific problem” rather than something that’s worth tackling now.</p>

<p>What other edge-cases might we have?</p>

<h2 id="controlling-acrobatic-planes">Controlling acrobatic planes</h2>

<p>Say we want to have some fun in our stunt plane, but it’s a boring flight to the practice “grounds” so we just turn on our autopilot to get us there.</p>

<p><img src="https://pomax.github.io/are-we-flying/images/planes/pitts-special-shot.png" alt="the Pitts Special S1"></p>

<p>Will our current autopilot code actually get us there? As it turns out, no. No it won’t:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/combined/acrobatic/bad-acrobatics.png" alt="image-20240115102153561"></p>

<p>That’s a hard crash. And adding our plane to the list of “trim on stick” planes won’t help either: the problem here is that these planes fly fundamentally differently from “regular” planes, with near-instant response to control inputs, and our autopilot simply can’t run fast enough to keep up. We can’t really speed up our autopilot (I mean, we can probably speed it up <em>a bit</em>, but we’re definitely not going to run it every frame: we only have so much CPU available, and MSFS famously wants all of it), but what we <em>can</em> do is make our autopilot give these kinds of planes much smaller corrections. This will make us turn slower, but on the upside: it makes the plane turn slower rather than immediately trying to do a roll.</p>

<p>Let’s add an <code>isAcrobatic</code> flag to our flight model, in <code>flight-information.js</code>, and reorganize it since we’re now working with multiple lists:</p>

<div><pre><code><span>...</span>

<span>// Yay, more hard-coded lists!</span>
<span>const</span> <span>noAileron</span> <span>=</span> <span>[</span><span>`Turbo Arrow`</span><span>].</span><span>map</span><span>(</span><span>v</span> <span>=&gt;</span> <span>v</span><span>.</span><span>toLowerCase</span><span>());</span>
<span>const</span> <span>acrobatic</span> <span>=</span> <span>[</span><span>`Pitts`</span><span>].</span><span>map</span><span>(</span><span>v</span> <span>=&gt;</span> <span>v</span><span>.</span><span>toLowerCase</span><span>());</span>

<span>export</span> <span>class</span> <span>FlightInformation</span> <span>{</span>
  <span>...</span>
    <span>// Then our "update the model" code:</span>
  <span>async</span> <span>updateModel</span><span>()</span> <span>{</span>
    <span>...</span>
    <span>const</span> <span>title</span> <span>=</span> <span>data</span><span>.</span><span>title</span><span>.</span><span>toLowerCase</span><span>();</span>
    <span>data</span><span>.</span><span>hasAileronTrim</span> <span>=</span> <span>!</span><span>noAileron</span><span>.</span><span>some</span><span>((</span><span>t</span><span>)</span> <span>=&gt;</span><span>title</span><span>.</span><span>includes</span><span>(</span><span>t</span><span>));</span>
    <span>data</span><span>.</span><span>isAcrobatic</span> <span>=</span> <span>acrobatic</span><span>.</span><span>some</span><span>((</span><span>t</span><span>)</span> <span>=&gt;</span> <span>title</span><span>.</span><span>includes</span><span>(</span><span>t</span><span>));</span>
    <span>...</span>
  <span>}</span>
  <span>...</span>
<span>}</span>
</code></pre></div>

<p>And presto, we now have an <code>isAcrobatic</code> flag that we can check in our <code>fly-level.js</code> code:</p>

<div><pre><code><span>...</span>
<span>export</span> <span>async</span> <span>function</span> <span>flyLevel</span><span>(</span><span>autopilot</span><span>,</span> <span>state</span><span>)</span> <span>{</span>
  <span>...</span>
  <span>const</span> <span>{</span> <span>hasAileronTrim</span><span>,</span> <span>weight</span><span>,</span> <span>isAcrobatic</span> <span>}</span> <span>=</span> <span>flightModel</span><span>;</span>
  <span>...</span>

  <span>// Let's pass that value into our target finding function</span>
  <span>const</span> <span>{</span> <span>targetBank</span><span>,</span> <span>maxDBank</span><span>,</span> <span>targetHeading</span><span>,</span> <span>headingDiff</span> <span>}</span> <span>=</span>
    <span>getTargetBankAndTurnRate</span><span>(</span><span>autopilot</span><span>,</span> <span>heading</span><span>,</span> <span>maxBank</span><span>,</span> <span>isAcrobatic</span><span>);</span>
  <span>const</span> <span>aHeadingDiff</span> <span>=</span> <span>abs</span><span>(</span><span>headingDiff</span><span>);</span>
  <span>const</span> <span>diff</span> <span>=</span> <span>targetBank</span> <span>-</span> <span>bank</span><span>;</span>

  <span>// And of course, use it to drastically reduce the step size,</span>
  <span>// until we're very close to our target, then only moderately</span>
  <span>// reduce the step size.</span>
  <span>if</span> <span>(</span><span>isAcrobatic</span><span>)</span> <span>{</span>
    <span>step</span> <span>=</span> <span>constrainMap</span><span>(</span><span>aHeadingDiff</span><span>,</span> <span>0</span><span>,</span> <span>10</span><span>,</span> <span>step</span> <span>/</span> <span>5</span><span>,</span> <span>step</span> <span>/</span> <span>20</span><span>);</span>
  <span>}</span>
  <span>...</span>
<span>}</span>

<span>// Remember how we made the heading a quadratic easing function?</span>
<span>// We're going to undo that for acrobatic planes, otherwise it</span>
<span>// will take them waaaay too long to cover the last few degrees</span>
<span>function</span> <span>getTargetBankAndTurnRate</span><span>(</span><span>autopilot</span><span>,</span> <span>heading</span><span>,</span> <span>maxBank</span><span>,</span> <span>isAcrobatic</span><span>)</span> <span>{</span>
  <span>...</span>
    <span>headingDiff</span> <span>=</span> <span>getCompassDiff</span><span>(</span><span>heading</span><span>,</span> <span>targetHeading</span><span>);</span>
    <span>if</span> <span>(</span><span>!</span><span>isAcrobatic</span><span>)</span> <span>headingDiff</span> <span>/=</span> <span>2</span><span>;</span>
  <span>...</span>
<span>}</span>

</code></pre></div>

<p>There. Let’s see what that did for us:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/combined/acrobatic/good-acrobatics.png" alt="image-20240115105424178"></p>

<p>Looking pretty great!</p>

<p>So, let’s try one more edge-case: planes that cruise very close to their “never exceed” (V<sub>NE</sub>) speed limit.</p>

<h2 id="auto-throttling">Auto-throttling</h2>

<p>Say we’re flying a bear:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/planes/kodiak-100-shot.png" alt="The Kodiak 100"></p>

<p>This is the Daher Kodiak 100. It’s fast! It’s famous! It’s also relatively easy to fly, but it has a really weird design quirk in MSFS… see if you can spot it:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/combined/throttle/kodiak-problem.png" alt="The problem with the Kodiak 100..."></p>

<p>If we look at its supposed cruise speed as reported by MSFS, it likes to fly at 174 knots. And if we look at our cockpit dash, it says we’re going to die at 180 knots. That’s… not a lot of leeway between “merrily cruising along” and “tearing a two million dollar plane apart in mid-air”. So let’s start a flight at 1500 feet, at its cruise speed of 174 knots, and climb up to its “intended” cruise altitude of 12000, and then… come back down to 1500 feet. And you can probably guess where this is going.</p>

<p><img src="https://pomax.github.io/are-we-flying/images/combined/throttle/kodiak-climb.png" alt="Gettting to 12,000 feet is not a problem"></p>

<p>Going up: not a problem! With a cruise speed of 174 bit a minimum safe climb speed of 101 knots, the Kodiak has power <em>to spare</em>. We never even drop below 120 knots during our climb. And then we try to descend.</p>

<p><img src="https://pomax.github.io/are-we-flying/images/combined/throttle/kodiak-descent-death.png" alt="Descending 12,000 feet does not end well"></p>

<p>The first few thousand feet: not a problem!</p>

<p>But all the while our speed is slowly creeping up, and after a little over 4000 feet of descent, at an altitude of 7860.7 feet, we’re going too fast for the plane to handle and…</p>

<p><img src="https://pomax.github.io/are-we-flying/images/combined/throttle/overstressed.png" alt="we overstressed the plane, which is a polite way to say we died"></p>

<p>Game over.</p>

<p>So how do we deal with this edge-case? If you remember when we needed emergency measures to deal with the plane being told to climb faster than its engine could sustain, our solution then was to decrease the target VS. However, a second option would have been to just throttle up so that the plane has the power it needs, with a reduced target VS only once we’re maxed out on the throttle.</p>

<p>Conversely, we can throttle <em>down</em> if we’re descending and we’re seeing the plane go faster than its intended cruise speed. So let’s write some “auto throttle” code  to help us keep our Kodiak 100 in one piece, starting with a new value to our <code>constants.js</code>:</p>

<div><pre><code><span>...</span>
<span>const</span> <span>AUTO_THROTTLE</span> <span>=</span> <span>`ATT`</span><span>;</span>
</code></pre></div>

<p>And then let’s make a <code>src/autopilot/auto-throttle.js</code> file and get to work:</p>

<div><pre><code><span>import</span> <span>{</span> <span>ALTITUDE_HOLD</span><span>,</span> <span>AUTO_THROTTLE</span> <span>}</span> <span>from</span> <span>"</span><span>../utils/constants.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>constrainMap</span> <span>}</span> <span>from</span> <span>"</span><span>../utils/utils.js</span><span>"</span><span>;</span>

<span>const</span> <span>{</span> <span>abs</span> <span>}</span> <span>=</span> <span>Math</span><span>;</span>

<span>export</span> <span>function</span> <span>autoThrottle</span><span>(</span><span>autopilot</span><span>,</span> <span>flightInformation</span><span>)</span> <span>{</span>
  <span>const</span> <span>{</span> <span>api</span><span>,</span> <span>modes</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>
	<span>const</span> <span>{</span> <span>data</span><span>:</span> <span>flightData</span><span>,</span> <span>model</span><span>:</span> <span>flightModel</span> <span>}</span> <span>=</span> <span>flightInformation</span><span>;</span>

  <span>// We'll need to know our current altitude and speed...</span>
  <span>const</span> <span>{</span> <span>alt</span><span>,</span> <span>speed</span> <span>}</span> <span>=</span> <span>flightData</span><span>;</span>
  <span>const</span> <span>{</span> <span>speed</span><span>:</span> <span>dV</span> <span>}</span> <span>=</span> <span>flightData</span><span>.</span><span>d</span><span>;</span>

  <span>// As well as knowing how many engines we're working with,</span>
  <span>// and what the plane's intended cruise speed is:</span>
  <span>const</span> <span>{</span> <span>engineCount</span><span>,</span> <span>cruiseSpeed</span> <span>}</span> <span>=</span> <span>flightModel</span><span>;</span>

  <span>const</span> <span>targetAlt</span> <span>=</span> <span>modes</span><span>[</span><span>ALTITUDE_HOLD</span><span>];</span>
  <span>const</span> <span>targetSpeed</span> <span>=</span> <span>cruiseSpeed</span><span>;</span>
  <span>const</span> <span>diff</span> <span>=</span> <span>abs</span><span>(</span><span>speed</span> <span>-</span> <span>targetSpeed</span><span>);</span>

  <span>// An accelleration threshold that we use to determine</span>
  <span>// if we should (still) speed up or down:</span>
  <span>const</span> <span>threshold</span> <span>=</span> <span>constrainMap</span><span>(</span><span>diff</span><span>,</span> <span>0</span><span>,</span> <span>10</span><span>,</span> <span>0.01</span><span>,</span> <span>0.2</span><span>);</span>

  <span>// A factor for "how much our altitude difference matters":</span>
  <span>const</span> <span>altFactor</span> <span>=</span> <span>constrainMap</span><span>(</span><span>targetAlt</span> <span>-</span> <span>alt</span><span>,</span> <span>0</span><span>,</span> <span>100</span><span>,</span> <span>0</span><span>,</span> <span>0.25</span><span>);</span>

  <span>// And our throttling step size, which is both dependent on</span>
  <span>// how far off our speed is from the target...</span>
  <span>let</span> <span>step</span> <span>=</span> <span>constrainMap</span><span>(</span><span>diff</span><span>,</span> <span>0</span><span>,</span> <span>50</span><span>,</span> <span>1</span><span>,</span> <span>5</span><span>);</span>

  <span>// As well as how light the plane is, because the amount of</span>
  <span>// throttle we need for a lumbering hulk will be way more</span>
  <span>// than we need for a little and nimble little plane.</span>
  <span>step</span> <span>=</span> <span>constrainMap</span><span>(</span><span>weight</span><span>,</span> <span>1000</span><span>,</span> <span>6000</span><span>,</span> <span>step</span><span>/</span><span>5</span><span>,</span> <span>step</span><span>);</span>

  <span>// Also we want to make sure that while we can throttle</span>
  <span>// up to 100%, we never throttle down past 25%. Because</span>
  <span>// we don't want the engines to cut out on us.</span>
  <span>const</span> <span>throttle</span> <span>=</span> <span>amount</span> <span>=&gt;</span> <span>{</span>
    <span>changeThrottle</span><span>(</span><span>api</span><span>,</span> <span>engineCount</span><span>,</span> <span>amount</span><span>,</span> <span>25</span><span>,</span> <span>100</span><span>);</span>
  <span>}</span>

  <span>// 1) are we in a throttle-up situation?</span>
  <span>if</span> <span>(</span><span>targetSpeed</span> <span>-</span> <span>speed</span> <span>&gt;</span> <span>2</span><span>)</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`throttle up`</span><span>);</span>
    <span>if</span> <span>(</span><span>dV</span> <span>&lt;=</span> <span>threshold</span><span>)</span> <span>{</span>
      <span>throttle</span><span>(</span><span>step</span><span>);</span>
    <span>}</span>
    <span>// do we need to climb? then throttle up a bit more</span>
    <span>if</span> <span>(</span><span>alt</span> <span>&lt;</span> <span>targetAlt</span> <span>-</span> <span>50</span><span>)</span> <span>{</span>
      <span>console</span><span>.</span><span>log</span><span>(</span><span>`climbimg`</span><span>);</span>
      <span>throttle</span><span>(</span><span>altFactor</span> <span>*</span> <span>step</span><span>);</span>
    <span>}</span>
    <span>// are we speeding up more than desired?</span>
    <span>if</span> <span>(</span><span>dV</span> <span>&gt;</span> <span>threshold</span><span>)</span> <span>{</span>
      <span>throttle</span><span>(</span><span>step</span> <span>/</span> <span>4</span><span>);</span>
    <span>}</span>
  <span>}</span>

  <span>// 2) are we in a throttle-down situation?</span>
  <span>if</span> <span>(</span><span>speed</span> <span>-</span> <span>targetSpeed</span> <span>&gt;</span> <span>2</span><span>)</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`throttle down`</span><span>);</span>
    <span>if</span> <span>(</span><span>dV</span> <span>&gt;=</span> <span>-</span><span>3</span> <span>*</span> <span>threshold</span><span>)</span> <span>{</span>
      <span>console</span><span>.</span><span>log</span><span>(</span><span>`dV range good, throttling down`</span><span>);</span>
      <span>throttle</span><span>(</span><span>-</span><span>step</span><span>);</span>
    <span>}</span>
    <span>// do we need to descend? then throttle down a bit more</span>
    <span>if</span> <span>(</span><span>alt</span> <span>&gt;</span> <span>targetAlt</span> <span>+</span> <span>50</span><span>)</span> <span>{</span>
      <span>console</span><span>.</span><span>log</span><span>(</span><span>`descending`</span><span>);</span>
      <span>throttle</span><span>(</span><span>-</span><span>altFactor</span> <span>*</span> <span>step</span><span>);</span>
    <span>}</span>
    <span>// Are we slowing down more than desired?</span>
    <span>if</span> <span>(</span><span>dV</span> <span>&lt;</span> <span>-</span><span>3</span> <span>*</span> <span>threshold</span><span>)</span> <span>{</span>
      <span>console</span><span>.</span><span>log</span><span>(</span><span>`dV too low, throttling up`</span><span>);</span>
      <span>throttle</span><span>(</span><span>step</span> <span>/</span> <span>4</span><span>);</span>
    <span>}</span>
  <span>}</span>
<span>}</span>

<span>/**
 * To make life easier we make the "change the throttle" functionality
 * its own function, where we update all engines by the amount indicated,
 * and then poll the first engine to see what the *actual* new value is.
 */</span>
<span>async</span> <span>function</span> <span>changeThrottle</span><span>(</span><span>api</span><span>,</span> <span>engineCount</span> <span>=</span> <span>4</span><span>,</span> <span>byHowMuch</span><span>,</span> <span>floor</span> <span>=</span> <span>0</span><span>,</span> <span>ceiling</span> <span>=</span> <span>100</span><span>)</span> <span>{</span>
  <span>let</span> <span>newThrottle</span><span>;</span>
  <span>for</span> <span>(</span><span>let</span> <span>count</span> <span>=</span> <span>1</span><span>;</span> <span>count</span> <span>&lt;=</span> <span>engineCount</span><span>;</span> <span>count</span><span>++</span><span>)</span> <span>{</span>
    <span>const</span> <span>simVar</span> <span>=</span> <span>`GENERAL_ENG_THROTTLE_LEVER_POSITION:</span><span>${</span><span>count</span><span>}</span><span>`</span><span>;</span>
    <span>const</span> <span>throttle</span> <span>=</span> <span>(</span><span>await</span> <span>api</span><span>.</span><span>get</span><span>(</span><span>simVar</span><span>))[</span><span>simVar</span><span>];</span>
    <span>if</span> <span>((</span><span>byHowMuch</span> <span>&lt;</span> <span>0</span> <span>&amp;&amp;</span> <span>throttle</span> <span>&gt;</span> <span>floor</span><span>)</span> <span>||</span> <span>(</span><span>byHowMuch</span> <span>&gt;</span> <span>0</span> <span>&amp;&amp;</span> <span>throttle</span> <span>&lt;</span> <span>ceiling</span><span>))</span> <span>{</span>
      <span>newThrottle</span> <span>=</span> <span>constrain</span><span>(</span><span>throttle</span> <span>+</span> <span>byHowMuch</span><span>,</span> <span>floor</span><span>,</span> <span>ceiling</span><span>);</span>
      <span>api</span><span>.</span><span>set</span><span>(</span><span>simVar</span><span>,</span> <span>newThrottle</span><span>);</span>
    <span>}</span>
  <span>}</span>
  <span>const</span> <span>simVar</span> <span>=</span> <span>`GENERAL_ENG_THROTTLE_LEVER_POSITION:1`</span><span>;</span>
  <span>newThrottle</span> <span>=</span> <span>(</span><span>await</span> <span>api</span><span>.</span><span>get</span><span>(</span><span>simVar</span><span>))[</span><span>simVar</span><span>];</span>
  <span>return</span> <span>newThrottle</span><span>;</span>
<span>}</span>
</code></pre></div>

<p>Effectively: “try to maintain cruise speed”. And with that in place, what does our Kodiak do when told to go from 12000 feet down to 1500 feet?</p>

<p><img src="https://pomax.github.io/are-we-flying/images/combined/throttle/fixed.png" alt="A fixed Kodiak 100"></p>

<p>And once more: we live. You can see the auto-throttle keeping our speed around 174 knots (we go over a bit, we go under a bit) through pretty much the entire descent. And with that, we’ve exhausted the list of edge cases to look at. Which means our autopilot is done! Which means we can finally get down to writing the <em>real</em> autopilot! …<em>Wait, what?</em></p>
<h2 id="part-4-google-maps-for-planes">Part 4: Google maps for planes</h2>

<p>So far we’ve been looking at what we <em>call</em> an autopilot, but is it? Can we just get in the plane, and then tell it to pilot itself? In the real world: no, absolutely not, for very good reasons. But we’re not dealing with the real world, we’re dealing with a video game that we have near enough full control over, so why would we stop at “what you can do in the real world” when we can make things <em>so</em> much cooler by adding in the bits you won’t get in real life? We now have the basics in place for making the plane go where we want it to go, so let’s create a UI that lets use <em>tell it</em> where we want it to go, starting <em>and ending</em> on a runway. Because now we’re ready to tackle the  <em>really</em> interesting parts:</p>

<ul>
  <li>creating a waypoint-based navigation system where you just put markers on the map to form a flight path, and have the plane figure out how to fly that path,</li>
  <li>adding terrain awareness so we don’t even need to care about setting the correct altitudes for each waypoint,</li>
  <li>adding auto-takeoff so we can start the plane on the runway, hit “take off!” and then have the plane just… do that, and finally,</li>
  <li>adding auto-landing, so that at the end of the flight, the plane just finds a nearby airport, figures out the approach, and then lands itself.</li>
</ul>

<p>If that sounds like too much work: it might be. And no one would blame you if you stopped here. But if that sounds <em>amazing</em>… we’re not at the bottom of this page yet, let’s implement some crazy shit!</p>

<h2 id="intermission-mocking-an-msfs">Intermission: Mocking an MSFS</h2>

<p>Not all the work we’re doing here strictly speaking “requires” MSFS: if we had something that could pretend to be MSFS and feed us SimConnect data that is identical to MSFS then that would let us do some dev work with a “game” that we can tailor to suit whatever work we want to do, so before we start doing that work, let’s mock ourselves a little MSFS, which requires:</p>

<ul>
  <li>Mocking the list of SimConnect variables we work with,</li>
  <li>mocking a plane that works with those variables (basically creating the world’s worst flight simulator), and</li>
  <li>mocking a simconnect API so that calls go to our mocked variables.</li>
</ul>

<p>So let’s do that! First, let’s create a <code>src/classes/server/mocks</code> directory, and then create a file called <code>fake-flight-data.js</code>:</p>

<div><pre><code><span>import</span> <span>{</span> <span>radians</span> <span>}</span> <span>from</span> <span>"</span><span>../../../utils/utils.js</span><span>"</span><span>;</span>

<span>/**
 * Our starting point will be 1500 feet above runway 27
 * at Victoria Airport on Vancouver Island, BC, Canada.
 */</span>
<span>const</span> <span>altitude</span> <span>=</span> <span>1500</span><span>;</span>
<span>const</span> <span>static_cg_height</span> <span>=</span> <span>5</span><span>;</span>
<span>const</span> <span>speed</span> <span>=</span> <span>142</span><span>;</span>
<span>const</span> <span>declination</span> <span>=</span> <span>15.883026056332483</span><span>;</span>
<span>const</span> <span>heading</span> <span>=</span> <span>270</span><span>;</span>
<span>const</span> <span>lat</span> <span>=</span> <span>48.646548831015394</span><span>;</span>
<span>const</span> <span>long</span> <span>=</span> <span>-</span><span>123.41169834136964</span><span>;</span>
<span>const</span> <span>trimLimit</span> <span>=</span> <span>18</span><span>;</span>

<span>/**
 * All the values that our FlightInformation object needs:
 */</span>
<span>const</span> <span>data</span> <span>=</span> <span>{</span>
  <span>AILERON_POSITION</span><span>:</span> <span>0</span><span>,</span>
  <span>AILERON_TRIM_PCT</span><span>:</span> <span>0</span><span>,</span>
  <span>AIRSPEED_INDICATED</span><span>:</span> <span>speed</span> <span>*</span> <span>0.95</span><span>,</span>
  <span>AIRSPEED_TRUE</span><span>:</span> <span>speed</span><span>,</span>
  <span>AUTOPILOT_HEADING_LOCK_DIR</span><span>:</span> <span>heading</span><span>,</span>
  <span>AUTOPILOT_MASTER</span><span>:</span> <span>0</span><span>,</span>
  <span>BRAKE_PARKING_POSITION</span><span>:</span> <span>0</span><span>,</span>
  <span>CAMERA_STATE</span><span>:</span> <span>2</span><span>,</span> <span>// cockpit view</span>
  <span>CAMERA_SUBSTATE</span><span>:</span> <span>2</span><span>,</span> <span>// unlocked view</span>
  <span>CATEGORY</span><span>:</span> <span>2</span><span>,</span>
  <span>CRASH_FLAG</span><span>:</span> <span>0</span><span>,</span>
  <span>CRASH_SEQUENCE</span><span>:</span> <span>0</span><span>,</span>
  <span>DESIGN_CRUISE_ALT</span><span>:</span> <span>12000</span><span>,</span>
  <span>DESIGN_SPEED_CLIMB</span><span>:</span> <span>100</span><span>,</span>
  <span>DESIGN_SPEED_MIN_ROTATION</span><span>:</span> <span>100</span><span>,</span>
  <span>DESIGN_SPEED_VC</span><span>:</span> <span>245</span><span>,</span>
  <span>DESIGN_SPEED_VS0</span><span>:</span> <span>60</span><span>,</span>
  <span>DESIGN_SPEED_VS1</span><span>:</span> <span>70</span><span>,</span>
  <span>DESIGN_TAKEOFF_SPEED</span><span>:</span> <span>100</span><span>,</span>
  <span>ELECTRICAL_AVIONICS_BUS_VOLTAGE</span><span>:</span> <span>480</span><span>,</span>
  <span>ELECTRICAL_TOTAL_LOAD_AMPS</span><span>:</span> <span>-</span><span>148.123</span><span>,</span>
  <span>ELEVATOR_POSITION</span><span>:</span> <span>0</span><span>,</span>
  <span>ELEVATOR_TRIM_DOWN_LIMIT</span><span>:</span> <span>trimLimit</span><span>,</span>
  <span>ELEVATOR_TRIM_PCT</span><span>:</span> <span>0</span><span>,</span>
  <span>ELEVATOR_TRIM_POSITION</span><span>:</span> <span>0</span><span>,</span>
  <span>ELEVATOR_TRIM_UP_LIMIT</span><span>:</span> <span>trimLimit</span><span>,</span>
  <span>ENG_COMBUSTION</span><span>:</span> <span>1</span><span>,</span> <span>// note that we removed the :&lt;num&gt; suffix</span>
  <span>ENGINE_TYPE</span><span>:</span> <span>1</span><span>,</span>
  <span>GEAR_HANDLE_POSITION</span><span>:</span> <span>0</span><span>,</span>
  <span>GEAR_POSITION</span><span>:</span> <span>1</span><span>,</span> <span>// note that we removed the :&lt;num&gt; suffix</span>
  <span>GEAR_SPEED_EXCEEDED</span><span>:</span> <span>0</span><span>,</span>
  <span>GENERAL_ENG_THROTTLE_LEVER_POSITION</span><span>:</span> <span>95</span><span>,</span>
  <span>GROUND_ALTITUDE</span><span>:</span> <span>0</span><span>,</span>
  <span>INCIDENCE_ALPHA</span><span>:</span> <span>0</span><span>,</span>
  <span>INDICATED_ALTITUDE</span><span>:</span> <span>altitude</span><span>,</span>
  <span>IS_GEAR_FLOATS</span><span>:</span> <span>0</span><span>,</span>
  <span>IS_GEAR_RETRACTABLE</span><span>:</span> <span>1</span><span>,</span>
  <span>IS_TAIL_DRAGGER</span><span>:</span> <span>0</span><span>,</span>
  <span>MAGVAR</span><span>:</span> <span>declination</span><span>,</span>
  <span>NUMBER_OF_ENGINES</span><span>:</span> <span>1</span><span>,</span>
  <span>OVERSPEED_WARNING</span><span>:</span> <span>0</span><span>,</span>
  <span>PLANE_ALT_ABOVE_GROUND_MINUS_CG</span><span>:</span> <span>altitude</span> <span>-</span> <span>static_cg_height</span><span>,</span>
  <span>PLANE_ALT_ABOVE_GROUND</span><span>:</span> <span>altitude</span><span>,</span>
  <span>PLANE_BANK_DEGREES</span><span>:</span> <span>0</span><span>,</span>
  <span>PLANE_HEADING_DEGREES_MAGNETIC</span><span>:</span> <span>radians</span><span>(</span><span>heading</span><span>),</span>
  <span>PLANE_HEADING_DEGREES_TRUE</span><span>:</span> <span>radians</span><span>(</span><span>heading</span> <span>+</span> <span>declination</span><span>),</span>
  <span>PLANE_LATITUDE</span><span>:</span> <span>radians</span><span>(</span><span>lat</span><span>),</span>
  <span>PLANE_LONGITUDE</span><span>:</span> <span>radians</span><span>(</span><span>long</span><span>),</span>
  <span>PLANE_PITCH_DEGREES</span><span>:</span> <span>0</span><span>,</span>
  <span>RUDDER_POSITION</span><span>:</span> <span>0</span><span>,</span>
  <span>RUDDER_TRIM_PCT</span><span>:</span> <span>0</span><span>,</span>
  <span>SIM_ON_GROUND</span><span>:</span> <span>0</span><span>,</span>
  <span>STALL_ALPHA</span><span>:</span> <span>0</span><span>,</span>
  <span>STATIC_CG_TO_GROUND</span><span>:</span> <span>static_cg_height</span><span>,</span>
  <span>TAILWHEEL_LOCK_ON</span><span>:</span> <span>0</span><span>,</span>
  <span>TITLE</span><span>:</span> <span>`pretty terrible testing plane`</span><span>,</span>
  <span>TOTAL_WEIGHT</span><span>:</span> <span>3000</span><span>,</span>
  <span>TURN_INDICATOR_RATE</span><span>:</span> <span>0</span><span>,</span>
  <span>TYPICAL_DESCENT_RATE</span><span>:</span> <span>80</span><span>,</span>
  <span>VERTICAL_SPEED</span><span>:</span> <span>0</span><span>,</span>
  <span>WING_AREA</span><span>:</span> <span>250</span><span>,</span>
  <span>WING_SPAN</span><span>:</span> <span>50</span><span>,</span>
<span>};</span>

<span>/**
 * And as our export, a function that returns a *copy*
 * of the above data, so that we can reset to it if
 * we need to.
 */</span>
<span>export</span> <span>function</span> <span>getInitialState</span><span>()</span> <span>{</span>
  <span>return</span> <span>Object</span><span>.</span><span>assign</span><span>({},</span> <span>data</span><span>);</span>
<span>}</span>
</code></pre></div>

<p>Not much to it: since we’re mocking the actual SimConnect variables, there’s no conversion or renaming etc. Just the pure, original variables.</p>

<p>Next up, a <code>mock-api.hs</code>:</p>

<div><pre><code><span>import</span> <span>{</span> <span>watch</span> <span>}</span> <span>from</span> <span>"</span><span>../../../utils/reload-watcher.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>runLater</span> <span>}</span> <span>from</span> <span>"</span><span>../../../utils/utils.js</span><span>"</span><span>;</span>

<span>let</span> <span>plane</span><span>;</span>
<span>let</span> <span>{</span> <span>MockPlane</span> <span>}</span> <span>=</span> <span>await</span> <span>watch</span><span>(</span>
  <span>import</span><span>.</span><span>meta</span><span>.</span><span>dirname</span><span>,</span>
  <span>"</span><span>./mock-plane.js</span><span>"</span><span>,</span>
  <span>(</span><span>lib</span><span>)</span> <span>=&gt;</span> <span>{</span>
    <span>MockPlane</span> <span>=</span> <span>lib</span><span>.</span><span>MockPlane</span><span>;</span>
    <span>if</span> <span>(</span><span>plane</span><span>)</span> <span>Object</span><span>.</span><span>setPrototypeOf</span><span>(</span><span>plane</span><span>,</span> <span>MockPlane</span><span>.</span><span>prototype</span><span>);</span>
  <span>}</span>
<span>);</span>

<span>export</span> <span>class</span> <span>MOCK_API</span> <span>{</span>
  <span>constructor</span><span>()</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`
      ==========================================
      =                                        =
      =        !!! USING MOCKED API !!!        =
      =                                        =
      ==========================================
    `</span><span>);</span>
    <span>this</span><span>.</span><span>reset</span><span>();</span>
  <span>}</span>

  <span>reset</span><span>(</span><span>notice</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>notice</span><span>)</span> <span>console</span><span>.</span><span>log</span><span>(</span><span>notice</span><span>);</span>
    <span>plane</span> <span>??=</span> <span>new</span> <span>MockPlane</span><span>();</span>
    <span>plane</span><span>.</span><span>reset</span><span>();</span>
    <span>this</span><span>.</span><span>plane</span> <span>=</span> <span>plane</span><span>;</span>
    <span>this</span><span>.</span><span>connected</span> <span>=</span> <span>true</span><span>;</span>
    <span>this</span><span>.</span><span>started</span> <span>=</span> <span>false</span><span>;</span>
    <span>const</span> <span>{</span> <span>autopilot</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>if</span> <span>(</span><span>autopilot</span><span>)</span> <span>{</span>
      <span>autopilot</span><span>.</span><span>disable</span><span>();</span>
      <span>this</span><span>.</span><span>setAutopilot</span><span>(</span><span>autopilot</span><span>);</span>
    <span>}</span>
  <span>}</span>

  <span>async</span> <span>setAutopilot</span><span>(</span><span>autopilot</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>this</span><span>.</span><span>started</span><span>)</span> <span>return</span><span>;</span>
    <span>this</span><span>.</span><span>autopilot</span> <span>=</span> <span>autopilot</span><span>;</span>
    <span>this</span><span>.</span><span>started</span> <span>=</span> <span>true</span><span>;</span>
    <span>// Start running a flight 10 seconds after start-up:</span>
    <span>runLater</span><span>(</span>
      <span>()</span> <span>=&gt;</span> <span>autopilot</span><span>.</span><span>setParameters</span><span>({</span> <span>MASTER</span><span>:</span> <span>true</span><span>,</span> <span>LVL</span><span>:</span> <span>true</span><span>,</span> <span>ALT</span><span>:</span> <span>1500</span><span>,</span> <span>HDG</span><span>:</span> <span>270</span> <span>}),</span>
      <span>10000</span><span>,</span>
      <span>`--- Starting autopilot in 10 seconds ---`</span><span>,</span>
      <span>// With a count-down so you know when things will happen:</span>
      <span>()</span> <span>=&gt;</span> <span>{</span>
        <span>for</span> <span>(</span><span>let</span> <span>i</span> <span>=</span> <span>1</span><span>;</span> <span>i</span> <span>&lt;</span> <span>10</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>{</span>
          <span>const</span> <span>msg</span> <span>=</span> <span>`</span><span>${</span><span>10</span> <span>-</span> <span>i</span><span>}</span><span>...`</span><span>;</span>
          <span>setTimeout</span><span>(()</span> <span>=&gt;</span> <span>console</span><span>.</span><span>log</span><span>(</span><span>msg</span><span>),</span> <span>1000</span> <span>*</span> <span>i</span><span>);</span>
        <span>}</span>
      <span>}</span>
    <span>);</span>
  <span>}</span>

  <span>// And then our API mocking: "get" and "set" go to our plane,</span>
  <span>// the rest we're simply going to completely ignore.</span>
  <span>async</span> <span>get</span><span>(...</span><span>props</span><span>)</span> <span>{</span>
    <span>const</span> <span>response</span> <span>=</span> <span>{};</span>
    <span>props</span><span>.</span><span>forEach</span><span>((</span><span>name</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>response</span><span>[</span><span>name</span><span>]</span> <span>=</span> <span>plane</span><span>.</span><span>data</span><span>[</span><span>name</span><span>.</span><span>replace</span><span>(</span><span>/:.*/</span><span>,</span> <span>``</span><span>)];</span>
    <span>});</span>
    <span>return</span> <span>response</span><span>;</span>
  <span>}</span>

  <span>async</span> <span>set</span><span>(</span><span>name</span><span>,</span> <span>value</span><span>)</span> <span>{</span>
    <span>plane</span><span>.</span><span>set</span><span>(</span><span>name</span><span>.</span><span>replace</span><span>(</span><span>/:.*/</span><span>,</span> <span>``</span><span>),</span> <span>value</span><span>);</span>
  <span>}</span>

  <span>async</span> <span>connect</span><span>(</span><span>options</span><span>)</span> <span>{</span>
    <span>// Always pretend we're connected</span>
    <span>options</span><span>?.</span><span>onConnect</span><span>?.();</span>
  <span>}</span>

  <span>async</span> <span>trigger</span><span>()</span> <span>{</span>
    <span>// do nothing.</span>
  <span>}</span>

  <span>async</span> <span>on</span><span>()</span> <span>{</span>
    <span>// also do nothing.</span>
  <span>};</span>
<span>}</span>
</code></pre></div>

<p>And that leaves our <code>mock-plane.js</code>:</p>

<div><pre><code><span>import</span> <span>*</span> <span>as</span> <span>geomag</span> <span>from</span> <span>"</span><span>geomag</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>getInitialState</span> <span>}</span> <span>from</span> <span>"</span><span>./fake-flight-data.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>convertValues</span><span>,</span> <span>renameData</span> <span>}</span> <span>from</span> <span>"</span><span>../../../utils/flight-values.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span>
  <span>FEET_PER_METER</span><span>,</span>
  <span>ONE_KTS_IN_KMS</span><span>,</span>
  <span>FPS_PER_KNOT</span><span>,</span>
  <span>ENV_PATH</span>
<span>}</span> <span>from</span> <span>"</span><span>../../../utils/constants.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span>
  <span>constrainMap</span><span>,</span>
  <span>degrees</span><span>,</span>
  <span>getCompassDiff</span><span>,</span>
  <span>getPointAtDistance</span><span>,</span>
  <span>lerp</span><span>,</span>
  <span>radians</span><span>,</span>
  <span>runLater</span><span>,</span>
<span>}</span> <span>from</span> <span>"</span><span>../../../utils/utils.js</span><span>"</span><span>;</span>

<span>import</span> <span>dotenv</span> <span>from</span> <span>"</span><span>dotenv</span><span>"</span><span>;</span>
<span>dotenv</span><span>.</span><span>config</span><span>({</span> <span>path</span><span>:</span> <span>ENV_PATH</span> <span>});</span>
<span>const</span> <span>{</span> <span>DATA_FOLDER</span> <span>}</span> <span>=</span> <span>process</span><span>.</span><span>env</span><span>;</span>
<span>import</span> <span>{</span> <span>ALOSInterface</span> <span>}</span> <span>from</span> <span>"</span><span>../../../elevation/alos-interface.js</span><span>"</span><span>;</span>
<span>const</span> <span>alos</span> <span>=</span> <span>new</span> <span>ALOSInterface</span><span>(</span><span>DATA_FOLDER</span><span>);</span>

<span>const</span> <span>{</span> <span>abs</span><span>,</span> <span>sign</span><span>,</span> <span>tan</span><span>,</span> <span>PI</span> <span>}</span> <span>=</span> <span>Math</span><span>;</span>
<span>const</span> <span>UPDATE_FREQUENCY</span> <span>=</span> <span>450</span><span>;</span>

<span>/**
 * World's. Worst. Flight Sim.
 */</span>
<span>export</span> <span>class</span> <span>MockPlane</span> <span>{</span>
  <span>constructor</span><span>()</span> <span>{</span>
    <span>this</span><span>.</span><span>reset</span><span>();</span>
    <span>this</span><span>.</span><span>playbackRate</span> <span>=</span> <span>1</span><span>;</span>
    <span>this</span><span>.</span><span>run</span><span>();</span>
  <span>}</span>

  <span>reset</span><span>()</span> <span>{</span>
    <span>this</span><span>.</span><span>data</span> <span>=</span> <span>getInitialState</span><span>();</span>
  <span>}</span>

  <span>/**
   * Make time pass for this plane.
   */</span>
  <span>run</span><span>(</span><span>previousCallTime</span> <span>=</span> <span>Date</span><span>.</span><span>now</span><span>())</span> <span>{</span>
    <span>let</span> <span>callTime</span> <span>=</span> <span>Date</span><span>.</span><span>now</span><span>();</span>
    <span>const</span> <span>ms</span> <span>=</span> <span>callTime</span> <span>-</span> <span>previousCallTime</span><span>;</span>
    <span>if</span> <span>(</span><span>ms</span> <span>&gt;</span> <span>10</span><span>)</span> <span>{</span>
      <span>this</span><span>.</span><span>update</span><span>(</span><span>ms</span><span>);</span>
    <span>}</span> <span>else</span> <span>{</span>
      <span>callTime</span> <span>=</span> <span>previousCallTime</span><span>;</span>
    <span>}</span>
    <span>runLater</span><span>(()</span> <span>=&gt;</span> <span>this</span><span>.</span><span>run</span><span>(</span><span>callTime</span><span>),</span> <span>UPDATE_FREQUENCY</span><span>);</span>
  <span>}</span>

  <span>/**
   * Set all heading-related values when the plane's heading updates.
   */</span>
  <span>setHeading</span><span>(</span>
    <span>deg</span><span>,</span>
    <span>lat</span> <span>=</span> <span>degrees</span><span>(</span><span>this</span><span>.</span><span>data</span><span>.</span><span>PLANE_LATITUDE</span><span>),</span>
    <span>long</span> <span>=</span> <span>degrees</span><span>(</span><span>this</span><span>.</span><span>data</span><span>.</span><span>PLANE_LONGITUDE</span><span>),</span>
    <span>alt</span> <span>=</span> <span>this</span><span>.</span><span>data</span><span>.</span><span>INDICATED_ALTITUDE</span> <span>/</span> <span>(</span><span>1000</span> <span>*</span> <span>FEET_PER_METER</span><span>)</span>
  <span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>data</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>const</span> <span>declination</span> <span>=</span> <span>geomag</span><span>.</span><span>field</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>alt</span><span>).</span><span>declination</span><span>;</span>
    <span>data</span><span>.</span><span>MAGVAR</span> <span>=</span> <span>radians</span><span>(</span><span>declination</span><span>);</span>
    <span>deg</span> <span>=</span> <span>(</span><span>deg</span> <span>+</span> <span>360</span><span>)</span> <span>%</span> <span>360</span><span>;</span>
    <span>data</span><span>.</span><span>PLANE_HEADING_DEGREES_MAGNETIC</span> <span>=</span> <span>radians</span><span>(</span><span>deg</span><span>);</span>
    <span>data</span><span>.</span><span>PLANE_HEADING_DEGREES_TRUE</span> <span>=</span> <span>radians</span><span>(</span><span>deg</span> <span>+</span> <span>declination</span><span>);</span>
  <span>}</span>

  <span>/**
   * Set all altitude-related values when the plane's altitude updates.
   */</span>
  <span>setAltitude</span><span>(</span><span>feet</span><span>,</span> <span>groundAlt</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>data</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>data</span><span>.</span><span>INDICATED_ALTITUDE</span> <span>=</span> <span>feet</span><span>;</span>
    <span>data</span><span>.</span><span>PLANE_ALT_ABOVE_GROUND</span> <span>=</span> <span>feet</span> <span>-</span> <span>groundAlt</span> <span>*</span> <span>FEET_PER_METER</span><span>;</span>
    <span>data</span><span>.</span><span>PLANE_ALT_ABOVE_GROUND_MINUS_CG</span> <span>=</span>
      <span>data</span><span>.</span><span>PLANE_ALT_ABOVE_GROUND</span> <span>-</span> <span>data</span><span>.</span><span>STATIC_CG_TO_GROUND</span><span>;</span>
  <span>}</span>

  <span>/**
   * This function basically runs the world's worst flight
   * simulator: we're not even going to bother with a flight
   * model and computing forces, even though we're trying to
   * work with a trim-based autopilot, we're just going to
   * constrainMap and interpolate our way to victory.
   */</span>
  <span>update</span><span>(</span><span>ms</span><span>)</span> <span>{</span>
    <span>// If the interval is too long, "do nothing",</span>
    <span>// so we don't teleport around when the OS decides</span>
    <span>// to throttle or suspend a process.</span>
    <span>if</span> <span>(</span><span>ms</span> <span>&gt;</span> <span>5</span> <span>*</span> <span>UPDATE_FREQUENCY</span><span>)</span> <span>return</span><span>;</span>

    <span>// allow "fast forward"</span>
    <span>const</span> <span>interval</span> <span>=</span> <span>(</span><span>ms</span> <span>/</span> <span>1000</span><span>)</span> <span>*</span> <span>this</span><span>.</span><span>playbackRate</span><span>;</span>

    <span>// First, use the code we already wrote to data-fy the flight.</span>
    <span>const</span> <span>{</span> <span>data</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>const</span> <span>converted</span> <span>=</span> <span>Object</span><span>.</span><span>assign</span><span>({},</span> <span>data</span><span>);</span>
    <span>convertValues</span><span>(</span><span>converted</span><span>);</span>
    <span>renameData</span><span>(</span><span>converted</span><span>,</span> <span>this</span><span>.</span><span>previousValues</span><span>);</span>
    <span>this</span><span>.</span><span>previousValues</span> <span>=</span> <span>converted</span><span>;</span>

    <span>// Update the current altitude by turning the current elevator</span>
    <span>// trim position into a target pitch and vertical speed, and then</span>
    <span>// applying a partial change so that the plane "takes a while to</span>
    <span>// get there" because otherwise our autopilot won't work =)</span>
    <span>const</span> <span>{</span> <span>pitchTrim</span><span>,</span> <span>lat</span><span>,</span> <span>long</span> <span>}</span> <span>=</span> <span>converted</span><span>;</span>
    <span>const</span> <span>p</span> <span>=</span> <span>sign</span><span>(</span><span>pitchTrim</span><span>)</span> <span>*</span> <span>(</span><span>abs</span><span>(</span><span>pitchTrim</span><span>)</span> <span>/</span> <span>100</span><span>)</span> <span>**</span> <span>1.2</span><span>;</span>
    <span>const</span> <span>pitchAngle</span> <span>=</span> <span>constrainMap</span><span>(</span><span>p</span><span>,</span> <span>-</span><span>1</span><span>,</span> <span>1</span><span>,</span> <span>-</span><span>3</span><span>,</span> <span>3</span><span>);</span>
    <span>data</span><span>.</span><span>PLANE_PITCH_DEGREES</span> <span>=</span> <span>radians</span><span>(</span><span>pitchAngle</span><span>);</span>

    <span>// Okay fine, there's *one* bit of real math: converting</span>
    <span>// the plane's pitch into a vertical speed, since we know</span>
    <span>// how fast we're going, and thus how many feet per second</span>
    <span>// we're covering, and thus how many vertical feet that</span>
    <span>// works out to. This is, of course, *completely wrong*</span>
    <span>// compared to the real world, but: this is a mock.</span>
    <span>// We don't *need* realistic, we just need good enough.</span>
    <span>const</span> <span>newVS</span> <span>=</span>
      <span>tan</span><span>(</span><span>-</span><span>data</span><span>.</span><span>PLANE_PITCH_DEGREES</span><span>)</span> <span>*</span>
      <span>FPS_PER_KNOT</span> <span>*</span>
      <span>data</span><span>.</span><span>AIRSPEED_TRUE</span> <span>*</span>
      <span>60</span> <span>*</span>
      <span>5</span><span>;</span>
    <span>data</span><span>.</span><span>VERTICAL_SPEED</span> <span>=</span> <span>lerp</span><span>(</span><span>0.15</span><span>,</span> <span>data</span><span>.</span><span>VERTICAL_SPEED</span><span>,</span> <span>newVS</span><span>);</span>

    <span>// Then update our current speed, based on the throttle lever,</span>
    <span>// with a loss (or gain) offset based on the current vertical</span>
    <span>// speed, so the autothrottle/targetVS code has something to</span>
    <span>// work with.</span>
    <span>const</span> <span>throttle</span> <span>=</span> <span>data</span><span>.</span><span>GENERAL_ENG_THROTTLE_LEVER_POSITION</span><span>;</span>
    <span>const</span> <span>vsOffset</span> <span>=</span> <span>constrainMap</span><span>(</span><span>newVS</span><span>,</span> <span>-</span><span>16</span><span>,</span> <span>16</span><span>,</span> <span>-</span><span>10</span><span>,</span> <span>10</span><span>);</span>
    <span>const</span> <span>speed</span> <span>=</span> <span>constrainMap</span><span>(</span><span>throttle</span><span>,</span> <span>0</span><span>,</span> <span>100</span><span>,</span> <span>0</span><span>,</span> <span>150</span><span>)</span> <span>-</span> <span>vsOffset</span><span>;</span>
    <span>data</span><span>.</span><span>AIRSPEED_TRUE</span> <span>=</span> <span>lerp</span><span>(</span><span>0.8</span><span>,</span> <span>data</span><span>.</span><span>AIRSPEED_TRUE</span><span>,</span> <span>speed</span><span>);</span>
    <span>data</span><span>.</span><span>AIRSPEED_INDICATED</span> <span>=</span> <span>0.95</span> <span>*</span> <span>data</span><span>.</span><span>AIRSPEED_TRUE</span><span>;</span>

    <span>// Update the current bank and turn rate by turning the current</span>
    <span>// aileron trim position into a values that we then "lerp to" so</span>
    <span>// that the change is gradual.</span>
    <span>const</span> <span>{</span> <span>aileronTrim</span> <span>}</span> <span>=</span> <span>converted</span><span>;</span>
    <span>const</span> <span>newBankDegrees</span> <span>=</span> <span>constrainMap</span><span>(</span><span>aileronTrim</span><span>,</span> <span>-</span><span>100</span><span>,</span> <span>100</span><span>,</span> <span>180</span><span>,</span> <span>-</span><span>180</span><span>);</span>
    <span>const</span> <span>newBank</span> <span>=</span> <span>100</span> <span>*</span> <span>radians</span><span>(</span><span>newBankDegrees</span><span>);</span>
    <span>data</span><span>.</span><span>PLANE_BANK_DEGREES</span> <span>=</span> <span>lerp</span><span>(</span><span>0.9</span><span>,</span> <span>data</span><span>.</span><span>PLANE_BANK_DEGREES</span><span>,</span> <span>newBank</span><span>);</span>
    <span>let</span> <span>turnRate</span> <span>=</span> <span>aileronTrim</span> <span>*</span> <span>30</span><span>;</span>
    <span>data</span><span>.</span><span>TURN_INDICATOR_RATE</span> <span>=</span> <span>lerp</span><span>(</span><span>0.9</span><span>,</span> <span>data</span><span>.</span><span>TURN_INDICATOR_RATE</span><span>,</span> <span>turnRate</span><span>);</span>

    <span>// Update heading, taking into account that the slower we go, the</span>
    <span>// faster we can turn, and the faster we go, the slower we can turn:</span>
    <span>const</span> <span>{</span> <span>heading</span><span>,</span> <span>headingBug</span> <span>}</span> <span>=</span> <span>converted</span><span>;</span>
    <span>const</span> <span>speedFactor</span> <span>=</span> <span>constrainMap</span><span>(</span><span>speed</span><span>,</span> <span>100</span><span>,</span> <span>150</span><span>,</span> <span>4</span><span>,</span> <span>1</span><span>);</span>
    <span>let</span> <span>updatedHeading</span> <span>=</span> <span>heading</span> <span>+</span> <span>speedFactor</span> <span>*</span> <span>turnRate</span> <span>*</span> <span>interval</span><span>;</span>
    <span>if</span> <span>(</span><span>updatedHeading</span> <span>===</span> <span>heading</span> <span>&amp;&amp;</span> <span>heading</span> <span>!==</span> <span>headingBug</span><span>)</span> <span>{</span>
      <span>const</span> <span>update</span> <span>=</span> <span>constrainMap</span><span>(</span><span>getCompassDiff</span><span>(</span><span>headingBug</span><span>,</span> <span>heading</span><span>),</span> <span>-</span><span>3</span><span>/</span><span>2</span><span>,</span> <span>3</span><span>/</span><span>2</span><span>,</span> <span>3</span><span>/</span><span>2</span><span>,</span> <span>-</span><span>3</span><span>/</span><span>2</span><span>);</span>
      <span>updatedHeading</span> <span>=</span> <span>heading</span> <span>+</span> <span>update</span><span>;</span>
    <span>}</span>
    <span>this</span><span>.</span><span>setHeading</span><span>(</span><span>updatedHeading</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>);</span>

    <span>// Update our altitude values...</span>
    <span>const</span> <span>{</span> <span>alt</span> <span>}</span> <span>=</span> <span>converted</span><span>;</span>
    <span>const</span> <span>newAltitude</span> <span>=</span> <span>alt</span> <span>+</span> <span>data</span><span>.</span><span>VERTICAL_SPEED</span> <span>*</span> <span>interval</span><span>;</span>
    <span>const</span> <span>groundAlt</span> <span>=</span> <span>(</span><span>data</span><span>.</span><span>GROUND_ALTITUDE</span> <span>=</span> <span>alos</span><span>.</span><span>lookup</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>));</span>
    <span>this</span><span>.</span><span>setAltitude</span><span>(</span><span>newAltitude</span><span>,</span> <span>groundAlt</span> <span>*</span> <span>FEET_PER_METER</span><span>);</span>

    <span>// And update our GPS position.</span>
    <span>const</span> <span>d</span> <span>=</span> <span>data</span><span>.</span><span>AIRSPEED_TRUE</span> <span>*</span> <span>ONE_KTS_IN_KMS</span> <span>*</span> <span>interval</span><span>;</span>
    <span>const</span> <span>h</span> <span>=</span> <span>degrees</span><span>(</span><span>data</span><span>.</span><span>PLANE_HEADING_DEGREES_TRUE</span><span>);</span>
    <span>const</span> <span>{</span> <span>lat</span><span>:</span> <span>lat2</span><span>,</span> <span>long</span><span>:</span> <span>long2</span> <span>}</span> <span>=</span> <span>getPointAtDistance</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>d</span><span>,</span> <span>h</span><span>);</span>
    <span>data</span><span>.</span><span>PLANE_LATITUDE</span> <span>=</span> <span>radians</span><span>(</span><span>lat2</span><span>);</span>
    <span>data</span><span>.</span><span>PLANE_LONGITUDE</span> <span>=</span> <span>radians</span><span>(</span><span>long2</span><span>);</span>
  <span>}</span>

  <span>/**
   * We accept all of four variables, one each so that
   * ATT, ALT, and LVL modes work, and then one for updating
   * the heading bug, because we use that in the browser.
   */</span>
  <span>set</span><span>(</span><span>name</span><span>,</span> <span>value</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>data</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>if</span> <span>(</span><span>name</span> <span>===</span> <span>`GENERAL_ENG_THROTTLE_LEVER_POSITION`</span><span>)</span> <span>{</span>
      <span>if</span> <span>(</span><span>value</span> <span>&lt;</span> <span>0.01</span><span>)</span> <span>value</span> <span>=</span> <span>0</span><span>;</span>
      <span>data</span><span>.</span><span>GENERAL_ENG_THROTTLE_LEVER_POSITION</span> <span>=</span> <span>value</span><span>;</span>
    <span>}</span>
    <span>if</span> <span>(</span><span>name</span> <span>===</span> <span>`ELEVATOR_TRIM_POSITION`</span><span>)</span> <span>{</span>
      <span>data</span><span>.</span><span>ELEVATOR_TRIM_POSITION</span> <span>=</span> <span>value</span><span>;</span>
      <span>data</span><span>.</span><span>ELEVATOR_TRIM_PCT</span> <span>=</span> <span>constrainMap</span><span>(</span><span>value</span><span>,</span> <span>-</span><span>PI</span> <span>/</span> <span>2</span><span>,</span> <span>PI</span> <span>/</span> <span>2</span><span>,</span> <span>1</span><span>,</span> <span>-</span><span>1</span><span>);</span>
    <span>}</span>
    <span>if</span> <span>(</span><span>name</span> <span>===</span> <span>`AILERON_TRIM_PCT`</span><span>)</span> <span>{</span>
      <span>data</span><span>.</span><span>AILERON_TRIM_PCT</span> <span>=</span> <span>value</span> <span>/</span> <span>100</span><span>;</span>
    <span>}</span>
    <span>if</span> <span>(</span><span>name</span> <span>===</span> <span>`AUTOPILOT_HEADING_LOCK_DIR`</span><span>)</span> <span>{</span>
      <span>data</span><span>.</span><span>AUTOPILOT_HEADING_LOCK_DIR</span> <span>=</span> <span>value</span><span>;</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>So how do we run this? Let’s update our <code>src/classes/server/server.js</code> to look for a <code>--mock</code> runtime argument and then use this mock rather than trying to use the real SimConnect API:</p>

<div><pre><code><span>...</span>

<span>// In order to prevent clients from directly accessing the MSFS</span>
<span>// connector, we're going to make it a global (to our module):</span>
<span>let</span> <span>api</span> <span>=</span> <span>false</span><span>;</span>

<span>import</span> <span>{</span> <span>MOCK_API</span> <span>}</span> <span>from</span> <span>"</span><span>./mocks/mock-api.js</span><span>"</span><span>;</span>
<span>const</span> <span>USE_MOCK</span> <span>=</span> <span>process</span><span>.</span><span>argv</span><span>.</span><span>includes</span><span>(</span><span>`--mock`</span><span>);</span>

<span>// Next up, our server class:</span>
<span>export</span> <span>class</span> <span>ServerClass</span> <span>{</span>
  <span>...</span>

  <span>async</span> <span>init</span><span>()</span> <span>{</span>
    <span>const</span> <span>{</span> <span>clients</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>

    <span>// set up the API variable - note that because this is a global,</span>
    <span>// clients can't directly access the API. However, we'll be setting</span>
    <span>// up some API routing to make that a non-issue in a bit.</span>
    <span>api</span> <span>=</span> <span>USE_MOCK</span> <span>?</span> <span>new</span> <span>MOCK_API</span><span>()</span> <span>:</span> <span>new</span> <span>MSFS_API</span><span>();</span>

    <span>this</span><span>.</span><span>api</span> <span>=</span> <span>...</span>
    <span>autopilot</span> <span>=</span> <span>...</span>
    <span>this</span><span>.</span><span>autopilot</span> <span>=</span> <span>...</span>

    <span>if</span> <span>(</span><span>USE_MOCK</span><span>)</span> <span>{</span>
      <span>// Explicitly bind the autopilot if we're running a mock,</span>
      <span>// because the mock is going to have to turn it on without</span>
      <span>// any sort of user involvement.</span>
      <span>api</span><span>.</span><span>setAutopilot</span><span>(</span><span>autopilot</span><span>);</span>
      <span>// And allow clients to call this.server.mock.reset(),</span>
      <span>this</span><span>.</span><span>mock</span> <span>=</span> <span>{</span>
        <span>reset</span><span>:</span> <span>(</span><span>client</span><span>)</span> <span>=&gt;</span> <span>api</span><span>.</span><span>reset</span><span>(</span><span>`Resetting the mock flight`</span><span>),</span>
        <span>setPlaybackRate</span><span>:</span> <span>(</span><span>client</span><span>,</span> <span>v</span><span>)</span> <span>=&gt;</span> <span>api</span><span>.</span><span>plane</span><span>.</span><span>setPlaybackRate</span><span>(</span><span>v</span><span>),</span>
      <span>};</span>
    <span>}</span>

    <span>connectServerToAPI</span><span>(</span><span>api</span><span>,</span> <span>async</span> <span>()</span> <span>=&gt;</span> <span>{</span>
      <span>...</span>
    <span>});</span>
  <span>}</span>

  <span>...</span>
<span>}</span>
</code></pre></div>

<p>And done: if we now run <code>node api-server --mock</code>, we see the following:</p>

<div><pre><code>
      ==========================================
      =                                        =
      =        !!! USING MOCKED API !!!        =
      =                                        =
      ==========================================

resetting autopilot
--- Starting autopilot in 10 seconds ---
Connected to MSFS.
Registering API server to the general sim events.
new game started, resetting autopilot
resetting autopilot
Server listening on http://localhost:8080
9...
8...
7...
6...
5...
4...
3...
2...
1...
Engaging autopilot
Engaging heading hold at 270 degrees
Engaging wing leveler. Initial trim: 0
Engaging altitude hold at 1500 feet. Initial trim: 0
</code></pre></div>

<p>And firing up <code>node web-server.js --owner --browser</code> will show us that a flight’s happening. As far as it knows, it’s visualizing MSFS:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240227091819795.png" alt="image-20240227091819795"></p>

<h2 id="adding-waypoint-navigation">Adding waypoint navigation</h2>

<p>Our goal is going to be able to give the autopilot a bunch of coordinates and then make it fly our plane towards waypoints, and then when it gets close, transition to flying towards the next waypoint, and so on, until we run out of waypoints. Something like this:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/page/map-with-waypoints.png" alt="Doing some waypoint flying"></p>

<p>Flying towards a point is pretty easy, but transitioning in a way that “feels right” is a bit more work, so there might be a bit more code here than you’d expect. Plus, we want to place, move, and remove points using the map on our web page, but the actual waypoints themselves will live server-side, so there’s a bit of work to be done there, too.</p>

<p>As such, we’re going to need to break down waypoint logic as a few separate tasks:</p>

<ol>
  <li>the server side will  be our authority on which waypoints exist and which one we’re flying towards, which:
    <ol>
      <li>requires having code that models individual waypoints,</li>
      <li>requires having a waypoint manager, and</li>
      <li>requires updating our heading and altitude hold modes to made the plane fly get their target heading and altitude from the waypoint manager.</li>
    </ol>
  </li>
  <li>the client side is our UI for placing, editing, and removing waypoints, which:
    <ol>
      <li>requires code for showing waypoints as map markers, and</li>
      <li>Requires code for placing and editing waypoints.</li>
    </ol>
  </li>
</ol>

<p>This will be a little “trickier” in that the client will need to main a list of waypoints <em>in parallel</em> to the server’s list of waypoints, which we need to keep in sync with the list of waypoints we get as part of our regular server update. And of course, the client is <em>just</em> a UI, so if we -say- place a point, we don’t: we instead send an instruction to create a new waypoint to the server, and then on the next server update we’ll see that waypoint in the updated listed of waypoints. So it’s going to be a bit more code than you might have thought this would be.</p>

<p>So let’s get started!</p>

<h3 id="the-server-side">The server side</h3>

<p>We’ll model waypoints pretty plainly in their own <code>src/autopilot/waypoints/waypoint.js</code>, after a quick think about what we want our waypoints to model:</p>

<ol>
  <li>they need a lat/long GPS position, obviously,</li>
  <li>they need an optional elevation,</li>
  <li>they need a way to indicate whether we’ve passed them or not, so we can show that in our UI</li>
  <li>they need a way to indicate whether they are “our current waypoint”, so we can show that in our UI</li>
  <li>they need to know what “the next waypoint” is, so we can show that in our UI, and</li>
  <li>they need to know their distance from the previous waypoint, so we can show that in our UI</li>
</ol>

<p>And that last one seems obvious: it’s the first one in whatever list of waypoints we end up coding, but</p>

<p>Similarly, we’ll need ways to set and update all those values. So… let’s put all that in:</p>

<div><pre><code><span>import</span> <span>{</span>
  <span>getDistanceBetweenPoints</span><span>,</span>
  <span>getHeadingFromTo</span><span>,</span>
<span>}</span> <span>from</span> <span>"</span><span>../../utils/utils.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>KM_PER_NM</span> <span>}</span> <span>from</span> <span>"</span><span>../../utils/constants.js</span><span>"</span><span>;</span>

<span>export</span> <span>class</span> <span>Waypoint</span> <span>{</span>
  <span>// We'll use a silly little id function, because</span>
  <span>// we don't need uuids, we just need something</span>
  <span>// that we can use to order and find waypoints.</span>
  <span>static</span> <span>nextId</span> <span>=</span> <span>(()</span> <span>=&gt;</span> <span>{</span>
    <span>let</span> <span>id</span> <span>=</span> <span>1</span><span>;</span>
    <span>return</span> <span>()</span> <span>=&gt;</span> <span>id</span><span>++</span><span>;</span>
  <span>})();</span>

  <span>// The following functions should be pretty self-explanatory:</span>

  <span>constructor</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>alt</span> <span>=</span> <span>false</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>id</span> <span>=</span> <span>Waypoint</span><span>.</span><span>nextId</span><span>();</span>
    <span>this</span><span>.</span><span>reset</span><span>();</span>
    <span>this</span><span>.</span><span>setPosition</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>);</span>
    <span>this</span><span>.</span><span>setElevation</span><span>(</span><span>alt</span><span>);</span>
  <span>}</span>

  <span>reset</span><span>()</span> <span>{</span>
    <span>this</span><span>.</span><span>active</span> <span>=</span> <span>false</span><span>;</span>
    <span>this</span><span>.</span><span>completed</span> <span>=</span> <span>false</span><span>;</span>
    <span>this</span><span>.</span><span>distance</span> <span>=</span> <span>0</span><span>;</span>
    <span>this</span><span>.</span><span>next</span> <span>=</span> <span>undefined</span><span>;</span>
  <span>}</span>

  <span>setPosition</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>lat</span> <span>=</span> <span>lat</span><span>;</span>
    <span>this</span><span>.</span><span>long</span> <span>=</span> <span>long</span><span>;</span>
  <span>}</span>

  <span>setElevation</span><span>(</span><span>alt</span><span>)</span> <span>{</span>
    <span>alt</span> <span>=</span> <span>parseFloat</span><span>(</span><span>alt</span><span>);</span>
    <span>this</span><span>.</span><span>alt</span> <span>=</span> <span>!</span><span>isNaN</span><span>(</span><span>alt</span><span>)</span> <span>&amp;&amp;</span> <span>alt</span> <span>&gt;</span> <span>0</span> <span>?</span> <span>alt</span> <span>:</span> <span>false</span><span>;</span>
  <span>}</span>

  <span>activate</span><span>()</span> <span>{</span>
    <span>this</span><span>.</span><span>active</span> <span>=</span> <span>Date</span><span>.</span><span>now</span><span>();</span>
  <span>}</span>

  <span>deactivate</span><span>()</span> <span>{</span>
    <span>this</span><span>.</span><span>active</span> <span>=</span> <span>false</span><span>;</span>
  <span>}</span>

  <span>/**
   * When we complete a waypoint, we automatically
   * return "the next one" so code can keep going.
   */</span>
  <span>complete</span><span>()</span> <span>{</span>
    <span>this</span><span>.</span><span>deactivate</span><span>();</span>
    <span>this</span><span>.</span><span>completed</span> <span>=</span> <span>true</span><span>;</span>
    <span>return</span> <span>this</span><span>.</span><span>next</span><span>;</span>
  <span>}</span>

  <span>/**
   * When we set a "next" waypoint, we want to set
   * the heading towards that next waypoint, and
   * we want that next waypoint to record how far
   * away from us it is, so that users can see how
   * long a leg will be (in nautical miles).
   */</span>
  <span>setNext</span><span>(</span><span>nextWaypoint</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>next</span> <span>=</span> <span>nextWaypoint</span><span>;</span>
    <span>if</span> <span>(</span><span>this</span><span>.</span><span>next</span><span>)</span> <span>{</span>
      <span>this</span><span>.</span><span>heading</span> <span>=</span> <span>getHeadingFromTo</span><span>(</span>
        <span>this</span><span>.</span><span>lat</span><span>,</span>
        <span>this</span><span>.</span><span>long</span><span>,</span>
        <span>this</span><span>.</span><span>next</span><span>.</span><span>lat</span><span>,</span>
        <span>this</span><span>.</span><span>next</span><span>.</span><span>long</span>
      <span>);</span>
      <span>this</span><span>.</span><span>next</span><span>.</span><span>distance</span> <span>=</span>
        <span>getDistanceBetweenPoints</span><span>(</span>
          <span>this</span><span>.</span><span>lat</span><span>,</span>
          <span>this</span><span>.</span><span>long</span><span>,</span>
          <span>this</span><span>.</span><span>next</span><span>.</span><span>lat</span><span>,</span>
          <span>this</span><span>.</span><span>next</span><span>.</span><span>long</span>
        <span>)</span> <span>/</span> <span>KM_PER_NM</span><span>;</span>
    <span>}</span>
  <span>}</span>

  <span>/**
   * When objects are converted to JSON through a
   * JSON.stringify call, this function (if it exists)
   * gets called as a "preprocessing" step, as part of
   * standard JavaScript execution rules.
   */</span>
  <span>toJSON</span><span>()</span> <span>{</span>
    <span>// this is useful because we need to make sure that our</span>
    <span>// "next" property is just the id for that waypoint,</span>
    <span>// not the actual waypoint.</span>
    <span>const</span> <span>props</span> <span>=</span> <span>Object</span><span>.</span><span>assign</span><span>({},</span> <span>this</span><span>);</span>
    <span>props</span><span>.</span><span>next</span> <span>=</span> <span>props</span><span>.</span><span>next</span><span>?.</span><span>id</span><span>;</span>
    <span>return</span> <span>props</span><span>;</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>That should cover what we need them to do. Next up, a waypoint manager, housed in its own <code>waypoint-manager.js</code> file:</p>

<div><pre><code><span>import</span> <span>{</span>
  <span>getDistanceBetweenPoints</span><span>,</span>
  <span>getHeadingFromTo</span><span>,</span>
<span>}</span> <span>from</span> <span>"</span><span>../../utils/utils.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>Waypoint</span> <span>}</span> <span>from</span> <span>"</span><span>./waypoint.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>ALTITUDE_HOLD</span><span>,</span> <span>HEADING_MODE</span> <span>}</span> <span>from</span> <span>"</span><span>../../utils/constants.js</span><span>"</span><span>;</span>

<span>export</span> <span>class</span> <span>WayPointManager</span> <span>{</span>
  <span>constructor</span><span>(</span><span>autopilot</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>autopilot</span> <span>=</span> <span>autopilot</span><span>;</span>
    <span>this</span><span>.</span><span>reset</span><span>();</span>
  <span>}</span>

  <span>reset</span><span>()</span> <span>{</span>
    <span>this</span><span>.</span><span>points</span> <span>=</span> <span>[];</span>
    <span>this</span><span>.</span><span>currentWaypoint</span> <span>=</span> <span>undefined</span><span>;</span>
    <span>this</span><span>.</span><span>repeating</span> <span>=</span> <span>false</span><span>;</span>
    <span>this</span><span>.</span><span>autopilot</span><span>.</span><span>onChange</span><span>();</span>
  <span>}</span>

  <span>/**
   * Make sure that if someone asks for all waypoints, they
   * don't get a direct reference to the array we're using.
   */</span>
  <span>getWaypoints</span><span>()</span> <span>{</span>
    <span>return</span> <span>this</span><span>.</span><span>points</span><span>.</span><span>slice</span><span>();</span>
  <span>}</span>

  <span>/**
   * Should we restart at the beginning once we finish the
   * last waypoint or not?
   */</span>
  <span>toggleRepeating</span><span>()</span> <span>{</span>
    <span>this</span><span>.</span><span>repeating</span> <span>=</span> <span>!</span><span>this</span><span>.</span><span>repeating</span><span>;</span>
    <span>this</span><span>.</span><span>resequence</span><span>();</span>
  <span>}</span>

  <span>/**
   * Add a waypoint, where lat/long is required, but altitude
   * is entirely optional.
   */</span>
  <span>add</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>alt</span> <span>=</span> <span>false</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>points</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>const</span> <span>waypoint</span> <span>=</span> <span>new</span> <span>Waypoint</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>alt</span><span>);</span>
    <span>points</span><span>.</span><span>push</span><span>(</span><span>waypoint</span><span>);</span>
    <span>// If we don't have a "current" point yet, this is now it.</span>
    <span>if</span> <span>(</span><span>!</span><span>this</span><span>.</span><span>currentWaypoint</span><span>)</span> <span>{</span>
      <span>this</span><span>.</span><span>currentWaypoint</span> <span>=</span> <span>waypoint</span><span>;</span>
      <span>this</span><span>.</span><span>currentWaypoint</span><span>.</span><span>activate</span><span>();</span>
    <span>}</span>
    <span>this</span><span>.</span><span>resequence</span><span>();</span>
  <span>}</span>

  <span>/**
   * Allow waypoints to be repositioned.
   */</span>
  <span>setWaypointPosition</span><span>(</span><span>id</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>points</span><span>.</span><span>find</span><span>((</span><span>e</span><span>)</span> <span>=&gt;</span> <span>e</span><span>.</span><span>id</span> <span>===</span> <span>id</span><span>)?.</span><span>setPosition</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>);</span>
    <span>this</span><span>.</span><span>resequence</span><span>();</span>
  <span>}</span>

  <span>/**
   * And allow waypoints to have their elevation changed.
   */</span>
  <span>setWaypointElevation</span><span>(</span><span>id</span><span>,</span> <span>alt</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>points</span><span>.</span><span>find</span><span>((</span><span>e</span><span>)</span> <span>=&gt;</span> <span>e</span><span>.</span><span>id</span> <span>===</span> <span>id</span><span>)?.</span><span>setElevation</span><span>(</span><span>alt</span><span>);</span>
    <span>this</span><span>.</span><span>resequence</span><span>();</span>
  <span>}</span>

  <span>/**
   * remove a waypoint and resequence.
   */</span>
  <span>remove</span><span>(</span><span>id</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>points</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>const</span> <span>pos</span> <span>=</span> <span>points</span><span>.</span><span>findIndex</span><span>((</span><span>e</span><span>)</span> <span>=&gt;</span> <span>e</span><span>.</span><span>id</span> <span>===</span> <span>id</span><span>);</span>
    <span>if</span> <span>(</span><span>pos</span> <span>===</span> <span>-</span><span>1</span><span>)</span> <span>return</span><span>;</span>
    <span>points</span><span>.</span><span>splice</span><span>(</span><span>pos</span><span>,</span> <span>1</span><span>)[</span><span>0</span><span>];</span>
    <span>if</span> <span>(</span><span>this</span><span>.</span><span>currentWaypoint</span><span>?.</span><span>id</span> <span>===</span> <span>id</span><span>)</span> <span>{</span>
      <span>this</span><span>.</span><span>currentWaypoint</span> <span>=</span> <span>this</span><span>.</span><span>currentWaypoint</span><span>.</span><span>next</span><span>;</span>
      <span>this</span><span>.</span><span>currentWaypoint</span><span>?.</span><span>activate</span><span>();</span>
    <span>}</span>
    <span>this</span><span>.</span><span>resequence</span><span>();</span>
  <span>}</span>

  <span>/**
   * Duplicate a waypoint, and put it *after* the one
   * that's being duplicated, so that dragging the
   * duplicate doesn't affect the prior flight path.
   */</span>
  <span>duplicate</span><span>(</span><span>id</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>points</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>const</span> <span>pos</span> <span>=</span> <span>points</span><span>.</span><span>findIndex</span><span>((</span><span>e</span><span>)</span> <span>=&gt;</span> <span>e</span><span>.</span><span>id</span> <span>===</span> <span>id</span><span>);</span>
    <span>if</span> <span>(</span><span>pos</span> <span>===</span> <span>-</span><span>1</span><span>)</span> <span>return</span><span>;</span>
    <span>// create a copy right next to the original point</span>
    <span>const</span> <span>waypoint</span> <span>=</span> <span>points</span><span>[</span><span>pos</span><span>];</span>
    <span>const</span> <span>{</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>alt</span> <span>}</span> <span>=</span> <span>waypoint</span><span>;</span>
    <span>const</span> <span>copy</span> <span>=</span> <span>new</span> <span>Waypoint</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>alt</span><span>);</span>
    <span>points</span><span>.</span><span>splice</span><span>(</span><span>pos</span><span>,</span> <span>0</span><span>,</span> <span>copy</span><span>);</span>
    <span>this</span><span>.</span><span>resequence</span><span>();</span>
  <span>}</span>

  <span>/**
   * Make a waypoint our current waypoint.
   */</span>
  <span>target</span><span>(</span><span>id</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>points</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>const</span> <span>pos</span> <span>=</span> <span>points</span><span>.</span><span>findIndex</span><span>((</span><span>e</span><span>)</span> <span>=&gt;</span> <span>e</span><span>.</span><span>id</span> <span>===</span> <span>id</span><span>);</span>
    <span>if</span> <span>(</span><span>pos</span> <span>===</span> <span>-</span><span>1</span><span>)</span> <span>return</span><span>;</span>
    <span>this</span><span>.</span><span>currentWaypoint</span> <span>=</span> <span>points</span><span>[</span><span>pos</span><span>];</span>
    <span>// make sure all points prior to this one are now</span>
    <span>// marked as complete, with this one active, and</span>
    <span>// any subsequent points fully reset.</span>
    <span>points</span><span>.</span><span>forEach</span><span>((</span><span>p</span><span>,</span> <span>i</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>p</span><span>.</span><span>reset</span><span>();</span>
      <span>if</span> <span>(</span><span>i</span> <span>&lt;</span> <span>pos</span><span>)</span> <span>p</span><span>.</span><span>complete</span><span>();</span>
      <span>else</span> <span>if</span> <span>(</span><span>i</span> <span>===</span> <span>pos</span><span>)</span> <span>{</span>
        <span>p</span><span>.</span><span>activate</span><span>();</span>
        <span>this</span><span>.</span><span>currentWaypoint</span> <span>=</span> <span>p</span><span>;</span>
      <span>}</span>
    <span>});</span>
    <span>this</span><span>.</span><span>resequence</span><span>();</span>
  <span>}</span>

  <span>/**
   * Make sure each waypoint knows what "their next waypoint"
   * is, then notify all clients of this resequence.
   */</span>
  <span>resequence</span><span>()</span> <span>{</span>
    <span>const</span> <span>{</span> <span>points</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>points</span><span>.</span><span>forEach</span><span>((</span><span>p</span><span>,</span> <span>i</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>p</span><span>.</span><span>id</span> <span>=</span> <span>i</span> <span>+</span> <span>1</span><span>;</span>
      <span>p</span><span>.</span><span>setNext</span><span>(</span><span>points</span><span>[</span><span>i</span> <span>+</span> <span>1</span><span>]);</span>
    <span>});</span>
    <span>if</span> <span>(</span><span>this</span><span>.</span><span>repeating</span><span>)</span> <span>points</span><span>.</span><span>at</span><span>(</span><span>-</span><span>1</span><span>).</span><span>setNext</span><span>(</span><span>points</span><span>[</span><span>0</span><span>]);</span>
    <span>// push the update to clients</span>
    <span>this</span><span>.</span><span>autopilot</span><span>.</span><span>onChange</span><span>();</span>
  <span>}</span>

  <span>/**
   * Remove all active/completed flags from all waypoints
   * and mark the first point as our active point.
   */</span>
  <span>resetWaypoints</span><span>()</span> <span>{</span>
    <span>this</span><span>.</span><span>points</span><span>.</span><span>forEach</span><span>((</span><span>waypoint</span><span>)</span> <span>=&gt;</span> <span>waypoint</span><span>.</span><span>reset</span><span>());</span>
    <span>this</span><span>.</span><span>currentWaypoint</span> <span>=</span> <span>this</span><span>.</span><span>points</span><span>[</span><span>0</span><span>];</span>
    <span>this</span><span>.</span><span>currentWaypoint</span><span>?.</span><span>activate</span><span>();</span>
    <span>this</span><span>.</span><span>resequence</span><span>();</span>
  <span>}</span>

  <span>/**
   * Have our waypoint manager update the autopilot's
   * heading mode, if we're not flying in the right
   * direction at the moment. Then return our heading.
   */</span>
  <span>getHeading</span><span>({</span> <span>autopilot</span><span>,</span> <span>heading</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>declination</span> <span>})</span> <span>{</span>
    <span>const</span> <span>{</span> <span>modes</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>
    <span>let</span> <span>{</span> <span>currentWaypoint</span><span>:</span> <span>p1</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>

    <span>// If we don't have a waypoint, and the autopilot doesn't</span>
    <span>// have anything set, then our current heading becomes our</span>
    <span>// autopilot heading parameter.</span>
    <span>if</span> <span>(</span><span>!</span><span>p1</span><span>)</span> <span>{</span>
      <span>if</span> <span>(</span><span>!</span><span>modes</span><span>[</span><span>HEADING_MODE</span><span>])</span> <span>{</span>
        <span>autopilot</span><span>.</span><span>setParameters</span><span>({</span>
          <span>[</span><span>HEADING_MODE</span><span>]:</span> <span>heading</span><span>,</span>
        <span>});</span>
      <span>}</span>
    <span>}</span>

    <span>// If we do have a waypoint, then set the autopilot to</span>
    <span>// the heading we need to fly in order to fly "through"</span>
    <span>// our waypoint.</span>
    <span>else</span> <span>{</span>
      <span>const</span> <span>newHeading</span> <span>=</span> <span>getHeadingFromTo</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>p1</span><span>.</span><span>lat</span><span>,</span> <span>p1</span><span>.</span><span>long</span><span>);</span>
      <span>// round the heading to 2 decimal places..</span>
      <span>const</span> <span>hdg</span> <span>=</span> <span>parseFloat</span><span>(((</span><span>360</span> <span>+</span> <span>newHeading</span> <span>-</span> <span>declination</span><span>)</span> <span>%</span> <span>360</span><span>).</span><span>toFixed</span><span>(</span><span>2</span><span>));</span>

      <span>// ...and if that's not the heading we're already flying,</span>
      <span>// update the autopilot!</span>
      <span>if</span> <span>(</span><span>modes</span><span>[</span><span>HEADING_MODE</span><span>]</span> <span>!==</span> <span>hdg</span><span>)</span> <span>{</span>
        <span>autopilot</span><span>.</span><span>setParameters</span><span>({</span>
          <span>[</span><span>HEADING_MODE</span><span>]:</span> <span>hdg</span><span>,</span>
        <span>});</span>
      <span>}</span>

      <span>// Also make sure to check whether we're now close enough to</span>
      <span>// our waypoint that we need to transition to the next one:</span>
      <span>this</span><span>.</span><span>checkTransition</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>p1</span><span>);</span>
    <span>}</span>

    <span>return</span> <span>modes</span><span>[</span><span>HEADING_MODE</span><span>];</span>
  <span>}</span>

  <span>/**
   * Check whether we should transition to the next waypoint
   * based on the plane's current GPS coordinate. Note that
   * this is not a good transition policy, but we'll revisit
   * this code in the next subsection to make it much better.
   */</span>
  <span>checkTransition</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>point</span><span>,</span> <span>radiusInKM</span> <span>=</span> <span>1</span><span>)</span> <span>{</span>
    <span>const</span> <span>d</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>point</span><span>.</span><span>lat</span><span>,</span> <span>point</span><span>.</span><span>long</span><span>);</span>
    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>radiusInKM</span><span>)</span> <span>{</span>
      <span>return</span> <span>this</span><span>.</span><span>transition</span><span>();</span>
    <span>}</span>
  <span>}</span>

  <span>/**
   * do the thing!
   */</span>
  <span>transition</span><span>()</span> <span>{</span>
    <span>const</span> <span>{</span> <span>points</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>this</span><span>.</span><span>currentWaypoint</span><span>.</span><span>deactivate</span><span>();</span>
    <span>this</span><span>.</span><span>currentWaypoint</span> <span>=</span> <span>this</span><span>.</span><span>currentWaypoint</span><span>.</span><span>complete</span><span>();</span>
    <span>if</span> <span>(</span><span>this</span><span>.</span><span>currentWaypoint</span> <span>===</span> <span>points</span><span>[</span><span>0</span><span>])</span> <span>this</span><span>.</span><span>resetWaypoints</span><span>();</span>
    <span>this</span><span>.</span><span>currentWaypoint</span><span>?.</span><span>activate</span><span>();</span>
    <span>return</span> <span>true</span><span>;</span>
  <span>}</span>

  <span>/**
   * Check if we need to set the autopilot's altitude hold
   * value to something new, and then return our hold alt:
   */</span>
  <span>getAltitude</span><span>(</span><span>autopilot</span><span>,</span> <span>alt</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>modes</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>
    <span>const</span> <span>{</span> <span>currentWaypoint</span><span>:</span> <span>p1</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>

    <span>// If we don't have a waypoint, then our current heading</span>
    <span>// becomes our current autopilot heading parameter.</span>
    <span>if</span> <span>(</span><span>!</span><span>p1</span><span>)</span> <span>{</span>
      <span>if</span> <span>(</span><span>!</span><span>modes</span><span>[</span><span>ALTITUDE_HOLD</span><span>])</span> <span>{</span>
        <span>autopilot</span><span>.</span><span>setParameters</span><span>({</span>
          <span>[</span><span>ALTITUDE_HOLD</span><span>]:</span> <span>alt</span><span>,</span>
        <span>});</span>
      <span>}</span>
    <span>}</span>

    <span>// If we do have a waypoint, then set the autopilot to the</span>
    <span>// altitude we need to fly in order to fly at a safe level</span>
    <span>else</span> <span>{</span>
      <span>alt</span> <span>=</span> <span>p1</span><span>.</span><span>alt</span><span>;</span>

      <span>// Do we have a next waypoint? And does it have</span>
      <span>// greater elevation than this one? If so, use that.</span>
      <span>const</span> <span>p2</span> <span>=</span> <span>p1</span><span>.</span><span>next</span><span>;</span>
      <span>if</span> <span>(</span><span>p2</span> <span>&amp;&amp;</span> <span>!!</span><span>p2</span><span>.</span><span>alt</span> <span>&amp;&amp;</span> <span>p2</span><span>.</span><span>alt</span> <span>&gt;</span> <span>p1</span><span>.</span><span>alt</span><span>)</span> <span>{</span>
        <span>alt</span> <span>=</span> <span>p2</span><span>.</span><span>alt</span><span>;</span>
      <span>}</span>

      <span>// Update the autopilot altitude parameter,</span>
      <span>// if we have a different value here.</span>
      <span>if</span> <span>(</span><span>alt</span> <span>&amp;&amp;</span> <span>modes</span><span>[</span><span>ALTITUDE_HOLD</span><span>]</span> <span>!==</span> <span>alt</span><span>)</span> <span>{</span>
        <span>autopilot</span><span>.</span><span>setParameters</span><span>({</span> <span>[</span><span>ALTITUDE_HOLD</span><span>]:</span> <span>alt</span> <span>});</span>
      <span>}</span>
    <span>}</span>
    <span>return</span> <span>modes</span><span>[</span><span>ALTITUDE_HOLD</span><span>];</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>That looks like a lot of code, but most of it’s pretty “boilerplate” in that we want this class to be able to do a few things, and each has an obvious implementation that mostly just makes the code take up more lines. The parts that are actually <em>interesting</em> are the <code>getHeading</code> and <code>getAltitude</code> functions, which don’t just “get” things, they actually update the autopilot to the appropriate heading and altitude respectively, and then return that new value. Both use fairly “naïve” approaches: <code>getHeading</code> simply returns the heading towards the next waypoint (which is a <em>terrible</em> flight policy, as we’ll see in a bit) and <code>getAltitude</code> returns either our current waypoint’s elevation, or the next elevation’s, depending on which is higher. Picking the highest (hopefully) prevents us from flying into a hill side.</p>

<p>This does mean we have a new functions in our <code>utils.js</code> file for getting the heading from one point to another:</p>

<div><pre><code><span>...</span>

<span>/**
 * Determine the heading from a point 1 to a point 2, using airplane
 * heading (a degree value between 0 and 360).
 */</span>
<span>export</span> <span>function</span> <span>getHeadingFromTo</span><span>(</span><span>lat1</span><span>,</span> <span>long1</span><span>,</span> <span>lat2</span><span>,</span> <span>long2</span><span>,</span> <span>declination</span> <span>=</span> <span>0</span><span>)</span> <span>{</span>
  <span>lat1</span> <span>=</span> <span>radians</span><span>(</span><span>parseFloat</span><span>(</span><span>lat1</span><span>));</span>
  <span>long1</span> <span>=</span> <span>radians</span><span>(</span><span>parseFloat</span><span>(</span><span>long1</span><span>));</span>
  <span>lat2</span> <span>=</span> <span>radians</span><span>(</span><span>parseFloat</span><span>(</span><span>lat2</span><span>));</span>
  <span>long2</span> <span>=</span> <span>radians</span><span>(</span><span>parseFloat</span><span>(</span><span>long2</span><span>));</span>
  <span>const</span> <span>dLon</span> <span>=</span> <span>long2</span> <span>-</span> <span>long1</span><span>;</span>
  <span>const</span> <span>x</span> <span>=</span> <span>cos</span><span>(</span><span>lat1</span><span>)</span> <span>*</span> <span>sin</span><span>(</span><span>lat2</span><span>)</span> <span>-</span> <span>sin</span><span>(</span><span>lat1</span><span>)</span> <span>*</span> <span>cos</span><span>(</span><span>lat2</span><span>)</span> <span>*</span> <span>cos</span><span>(</span><span>dLon</span><span>);</span>
  <span>const</span> <span>y</span> <span>=</span> <span>cos</span><span>(</span><span>lat2</span><span>)</span> <span>*</span> <span>sin</span><span>(</span><span>dLon</span><span>);</span>
  <span>return</span> <span>(</span><span>degrees</span><span>(</span><span>atan2</span><span>(</span><span>y</span><span>,</span> <span>x</span><span>))</span> <span>-</span> <span>declination</span> <span>+</span> <span>360</span><span>)</span> <span>%</span> <span>360</span><span>;</span>
<span>}</span>
</code></pre></div>

<p>So just a few steps left. First, we need to add a waypoint manager instance to our <code>src/autopilot/autopilot.js</code>:</p>

<div><pre><code><span>// We're not hot-reloading this one, but we could. The reason we don't</span>
<span>// is because we've pretty much covered everything we needed to already.</span>
<span>// There's one thing we'll be adding a bit later, but we don't need</span>
<span>// hot reloading for that.</span>
<span>import</span> <span>{</span> <span>WayPointManager</span> <span>}</span> <span>from</span> <span>"</span><span>./waypoints/waypoint-manager.js</span><span>"</span><span>;</span>

<span>...</span>

<span>export</span> <span>class</span> <span>AutoPilot</span> <span>{</span>
  <span>// Add the manager in our constructor...</span>
  <span>constructor</span><span>(</span><span>api</span><span>,</span> <span>onChange</span> <span>=</span> <span>()</span> <span>=&gt;</span> <span>{})</span> <span>{</span>
    <span>...</span>
    <span>this</span><span>.</span><span>waypoints</span> <span>=</span> <span>new</span> <span>WayPointManager</span><span>(</span><span>this</span><span>);</span>
  <span>}</span>

  <span>// ...and then add the waypoint list to our autopilot parameter object:Ï</span>
  <span>async</span> <span>getParameters</span><span>()</span> <span>{</span>
    <span>return</span> <span>{</span>
      <span>...</span><span>this</span><span>.</span><span>modes</span><span>,</span>
      <span>waypoints</span><span>:</span> <span>this</span><span>.</span><span>getWaypoints</span><span>(),</span>
    <span>};</span>
  <span>}</span>

  <span>...</span>
<span>}</span>
</code></pre></div>

<p>Then, we’ll need to update our <code>fly-level.js</code> and <code>altitude-hold.js</code> so they actually <em>use</em> the waypoint manager to get the heading and altitude we should be flying. Respectively:</p>

<div><pre><code><span>...</span>

<span>function</span> <span>getTargetBankAndTurnRate</span><span>(...)</span> <span>{</span>
  <span>...</span>
  <span>let</span> <span>targetHeading</span> <span>=</span> <span>autopilot</span><span>.</span><span>waypoints</span><span>.</span><span>getHeading</span><span>(</span><span>autopilot</span><span>,</span> <span>heading</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>);</span>
  <span>...</span>
<span>}</span>
</code></pre></div>

<p>and</p>

<div><pre><code><span>...</span>

<span>function</span> <span>getTargetVS</span><span>(...)</span> <span>{</span>
  <span>...</span>
  <span>if</span> <span>(...)</span> <span>{</span>
    <span>targetAlt</span> <span>=</span> <span>autopilot</span><span>.</span><span>waypoints</span><span>.</span><span>getAltitude</span><span>(</span><span>autopilot</span><span>,</span> <span>alt</span><span>)</span>
    <span>...</span>
  <span>}</span>
  <span>...</span>
<span>}</span>
</code></pre></div>

<p>And finally, we need to update our autopilot router, so that clients call things like <code>this.server.autopilot.addWaypoint(...)</code>:</p>

<div><pre><code><span>let</span> <span>autopilot</span><span>;</span>

<span>export</span> <span>class</span> <span>AutopilotRouter</span> <span>{</span>
  <span>constructor</span><span>(</span><span>_autopilot</span><span>)</span> <span>{</span> <span>autopilot</span> <span>=</span> <span>_autopilot</span><span>;</span> <span>}</span>
  <span>update</span><span>(</span><span>client</span><span>,</span> <span>params</span><span>)</span> <span>{</span> <span>autopilot</span><span>.</span><span>setParameters</span><span>(</span><span>params</span><span>);</span> <span>}</span>
  <span>resetTrim</span><span>(</span><span>client</span><span>)</span> <span>{</span> <span>autopilot</span><span>.</span><span>resetTrim</span><span>();</span> <span>}</span>
  <span>// Our new "routes":</span>
  <span>getWaypoints</span><span>(</span><span>client</span><span>)</span> <span>{</span> <span>return</span> <span>autopilot</span><span>.</span><span>waypoints</span><span>.</span><span>getWaypoints</span><span>();</span> <span>}</span>
  <span>addWaypoint</span><span>(</span><span>client</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>)</span> <span>{</span> <span>autopilot</span><span>.</span><span>waypoints</span><span>.</span><span>addWaypoint</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>);</span> <span>}</span>
  <span>setWaypointPosition</span><span>(</span><span>client</span><span>,</span> <span>id</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>)</span> <span>{</span> <span>autopilot</span><span>.</span><span>waypoints</span><span>.</span><span>setWaypointPosition</span><span>(</span><span>id</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>);</span> <span>}</span>
  <span>setWaypointElevation</span><span>(</span><span>client</span><span>,</span> <span>id</span><span>,</span> <span>alt</span><span>)</span> <span>{</span> <span>autopilot</span><span>.</span><span>waypoints</span><span>.</span><span>setWaypointElevation</span><span>(</span><span>id</span><span>,</span> <span>alt</span><span>);</span> <span>}</span>
  <span>removeWaypoint</span><span>(</span><span>client</span><span>,</span> <span>id</span><span>)</span> <span>{</span> <span>autopilot</span><span>.</span><span>waypoints</span><span>.</span><span>remove</span><span>(</span><span>id</span><span>);</span> <span>}</span>
  <span>duplicateWaypoint</span><span>(</span><span>client</span><span>,</span> <span>id</span><span>)</span> <span>{</span> <span>autopilot</span><span>.</span><span>waypoints</span><span>.</span><span>duplicate</span><span>(</span><span>id</span><span>);</span> <span>}</span>
  <span>targetWaypoint</span><span>(</span><span>client</span><span>,</span> <span>id</span><span>)</span> <span>{</span> <span>autopilot</span><span>.</span><span>waypoints</span><span>.</span><span>target</span><span>(</span><span>id</span><span>);</span> <span>}</span>
  <span>resetWaypoints</span><span>(</span><span>client</span><span>)</span> <span>{</span> <span>autopilot</span><span>.</span><span>waypoints</span><span>.</span><span>resetWaypoints</span><span>();</span> <span>}</span>
  <span>clearWaypoints</span><span>(</span><span>client</span><span>)</span> <span>{</span> <span>autopilot</span><span>.</span><span>waypoints</span><span>.</span><span>reset</span><span>();</span> <span>}</span>
  <span>toggleRepeating</span><span>(</span><span>client</span><span>,</span> <span>value</span><span>)</span> <span>{</span> <span>autopilot</span><span>.</span><span>waypoints</span><span>.</span><span>toggleRepeating</span><span>(</span><span>value</span><span>);</span> <span>}</span>
<span>}</span>
</code></pre></div>

<p>And speaking of clients, that was the last of the server-side work, so let’s update our client code and get to testing.</p>

<h3 id="the-client-side">The client side</h3>

<p>In order to work with waypoints, we’ll want the client-side equivalent of a waypoint manager, but since it won’t be “really” managing waypoints, let’s call it a waypoint overlay instead. It’ll be mirroring server-side waypoints on our map, so that feels an appropriate name.</p>

<p>Let’s first update our <code>public/js/plane.js</code>:</p>

<div><pre><code><span>import</span> <span>{</span> <span>WaypointOverlay</span> <span>}</span> <span>from</span> <span>"</span><span>./waypoint-overlay.js</span><span>"</span><span>;</span>

<span>...</span>

<span>export</span> <span>class</span> <span>Plane</span> <span>{</span>
  <span>// Step 1: bind a client-side waypoint manager</span>
  <span>constructor</span><span>(</span><span>server</span><span>,</span> <span>map</span> <span>=</span> <span>defaultMap</span><span>,</span> <span>location</span> <span>=</span> <span>DUNCAN_AIRPORT</span><span>,</span> <span>heading</span> <span>=</span> <span>135</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>this</span><span>.</span><span>waypointOverlay</span> <span>=</span> <span>new</span> <span>WaypointOverlay</span><span>(</span><span>this</span><span>);</span>
  <span>}</span>

  <span>// Step 2: give it the server-side waypoint data</span>
  <span>//         and let it sort out the rest!</span>
  <span>async</span> <span>updateState</span><span>(</span><span>state</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>const</span> <span>{</span> <span>autopilot</span><span>:</span> <span>params</span> <span>}</span> <span>=</span> <span>state</span><span>;</span>
    <span>this</span><span>.</span><span>autopilot</span><span>.</span><span>update</span><span>(</span><span>flightData</span><span>,</span> <span>params</span><span>);</span>
    <span>this</span><span>.</span><span>waypointOverlay</span><span>.</span><span>manage</span><span>(</span><span>params</span><span>.</span><span>waypoints</span><span>);</span>
    <span>...</span>
  <span>}</span>
<span>};</span>
</code></pre></div>

<p>And then it would help if we had an implementation for that waypoint overlay in <code>public/waypoint-overlay.js</code>:</p>

<div><pre><code><span>import</span> <span>{</span> <span>Trail</span> <span>}</span> <span>from</span> <span>"</span><span>./trail.js</span><span>"</span><span>;</span>

<span>export</span> <span>class</span> <span>WaypointOverlay</span> <span>{</span>
  <span>constructor</span><span>(</span><span>plane</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>plane</span> <span>=</span> <span>plane</span><span>;</span>
    <span>this</span><span>.</span><span>server</span> <span>=</span> <span>plane</span><span>.</span><span>server</span><span>;</span>
    <span>this</span><span>.</span><span>map</span> <span>=</span> <span>plane</span><span>.</span><span>map</span><span>;</span>
    <span>this</span><span>.</span><span>waypoints</span> <span>=</span> <span>[];</span>
    <span>this</span><span>.</span><span>addEventHandling</span><span>();</span>
  <span>}</span>

  <span>addEventHandling</span><span>()</span> <span>{</span>
    <span>const</span> <span>{</span> <span>map</span><span>,</span> <span>server</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>// Set up the event handling for clicking the map:</span>
    <span>map</span><span>.</span><span>on</span><span>(</span><span>`click`</span><span>,</span> <span>({</span> <span>latlng</span> <span>})</span> <span>=&gt;</span> <span>{</span>
      <span>const</span> <span>{</span> <span>lat</span><span>,</span> <span>lng</span> <span>}</span> <span>=</span> <span>latlng</span><span>;</span>
      <span>server</span><span>.</span><span>autopilot</span><span>.</span><span>addWaypoint</span><span>(</span><span>lat</span><span>,</span> <span>lng</span><span>);</span>
    <span>});</span>

    <span>// ...We're going to add a bunch more here very soon...</span>
  <span>}</span>

  <span>/**
   * Look at each waypoint and determine whether it's
   * a new point, or one we already know about.
   */</span>
  <span>manage</span><span>(</span><span>waypoints</span> <span>=</span> <span>[],</span> <span>repeating</span><span>)</span> <span>{</span>
    <span>waypoints</span><span>.</span><span>forEach</span><span>((</span><span>waypoint</span><span>,</span> <span>pos</span><span>)</span> <span>=&gt;</span>
      <span>this</span><span>.</span><span>manageWaypoint</span><span>(</span><span>waypoint</span><span>,</span> <span>pos</span> <span>+</span> <span>1</span><span>)</span>
    <span>);</span>

    <span>// Additionally, if we received fewer waypoints from the</span>
    <span>// server than we have locally, one or more got removed,</span>
    <span>// and we'll have to remove those from our list, then</span>
    <span>// visually hook everything up to look right again.</span>
    <span>if</span> <span>(</span><span>waypoints</span><span>.</span><span>length</span> <span>&lt;</span> <span>this</span><span>.</span><span>waypoints</span><span>.</span><span>length</span><span>)</span> <span>{</span>
      <span>this</span><span>.</span><span>waypoints</span>
        <span>.</span><span>filter</span><span>((</span><span>w</span><span>)</span> <span>=&gt;</span> <span>!</span><span>waypoints</span><span>.</span><span>find</span><span>((</span><span>e</span><span>)</span> <span>=&gt;</span> <span>e</span><span>.</span><span>id</span> <span>===</span> <span>w</span><span>.</span><span>id</span><span>))</span>
        <span>.</span><span>forEach</span><span>(({</span> <span>id</span> <span>})</span> <span>=&gt;</span> <span>this</span><span>.</span><span>removeWaypoint</span><span>(</span><span>id</span><span>));</span>
      <span>this</span><span>.</span><span>resequence</span><span>(</span><span>repeating</span><span>);</span>
    <span>}</span>
  <span>}</span>

  <span>/**
   * Is this a new waypoint that we need to put on the map, or is
   * this a previously known waypoint that we need to update?
   */</span>
  <span>manageWaypoint</span><span>(</span><span>waypoint</span><span>,</span> <span>number</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>waypoints</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>const</span> <span>{</span> <span>id</span> <span>}</span> <span>=</span> <span>waypoint</span><span>;</span>
    <span>const</span> <span>known</span> <span>=</span> <span>waypoints</span><span>.</span><span>find</span><span>((</span><span>e</span><span>)</span> <span>=&gt;</span> <span>e</span><span>.</span><span>id</span> <span>===</span> <span>id</span><span>);</span>
    <span>if</span> <span>(</span><span>!</span><span>known</span><span>)</span> <span>return</span> <span>this</span><span>.</span><span>addWaypoint</span><span>(</span><span>waypoint</span><span>,</span> <span>number</span><span>);</span>
    <span>this</span><span>.</span><span>updateWaypoint</span><span>(</span><span>known</span><span>,</span> <span>waypoint</span><span>,</span> <span>number</span><span>);</span>
  <span>}</span>

  <span>/**
   * Create a local waypoint based on a remote waypoint at the server
   */</span>
  <span>addWaypoint</span><span>(</span><span>waypoint</span><span>,</span> <span>number</span><span>)</span> <span>{</span>
    <span>// Unpack and reassemble, because state content is immutable,</span>
    <span>// but we want to tack new properties onto waypoints here.</span>
    <span>// If we forget to do this, we'll get runtime errors!</span>
    <span>waypoint</span> <span>=</span> <span>Object</span><span>.</span><span>assign</span><span>({},</span> <span>waypoint</span><span>);</span>
    <span>const</span> <span>{</span> <span>id</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>completed</span><span>,</span> <span>active</span> <span>}</span> <span>=</span> <span>waypoint</span><span>;</span>

    <span>const</span> <span>waypointClass</span> <span>=</span> <span>`waypoint-marker</span><span>${</span><span>completed</span> <span>?</span> <span>` completed`</span> <span>:</span> <span>``</span><span>}${</span>
      <span>active</span> <span>?</span> <span>` active`</span> <span>:</span> <span>``</span>
    <span>}</span><span>`</span><span>;</span>

    <span>// First we create a Leaflet icon:</span>
    <span>const</span> <span>icon</span> <span>=</span> <span>L</span><span>.</span><span>divIcon</span><span>({</span>
      <span>iconSize</span><span>:</span> <span>[</span><span>40</span><span>,</span> <span>40</span><span>],</span>
      <span>iconAnchor</span><span>:</span> <span>[</span><span>20</span><span>,</span> <span>40</span><span>],</span>
      <span>className</span><span>:</span> <span>`waypoint-div`</span><span>,</span>
      <span>html</span><span>:</span> <span>`
        &lt;div class="</span><span>${</span><span>waypointClass</span><span>}</span><span>"&gt;
          &lt;div class="pre"&gt;&lt;/div&gt;
          &lt;img src="css/images/marker-icon.png"&gt;
          &lt;div class="post"&gt;&lt;/div&gt;
        &lt;/div&gt;
      `</span><span>,</span>
    <span>});</span>

    <span>// Then we create a Leaflet marker that uses that icon as its visualisation:</span>
    <span>const</span> <span>marker</span> <span>=</span> <span>(</span><span>waypoint</span><span>.</span><span>marker</span> <span>=</span> <span>L</span><span>.</span><span>marker</span><span>(</span>
      <span>{</span> <span>lat</span><span>,</span> <span>lng</span><span>:</span> <span>long</span> <span>},</span>
      <span>{</span> <span>icon</span><span>,</span> <span>draggable</span><span>:</span> <span>true</span> <span>}</span>
    <span>).</span><span>addTo</span><span>(</span><span>this</span><span>.</span><span>map</span><span>));</span>

    <span>// We we set a human-friendly label</span>
    <span>this</span><span>.</span><span>setWaypointLabel</span><span>(</span><span>waypoint</span><span>,</span> <span>number</span><span>);</span>

    <span>// Next, if we click-drag a marker, we want to send the positional</span>
    <span>// change to the server once we let go.</span>
    <span>marker</span><span>.</span><span>on</span><span>(</span><span>`drag`</span><span>,</span> <span>(</span><span>event</span><span>)</span> <span>=&gt;</span> <span>(</span><span>marker</span><span>.</span><span>__drag__latlng</span> <span>=</span> <span>event</span><span>.</span><span>latlng</span><span>));</span>
    <span>marker</span><span>.</span><span>on</span><span>(</span><span>`dragend`</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
      <span>const</span> <span>{</span> <span>lat</span><span>,</span> <span>lng</span><span>:</span> <span>long</span> <span>}</span> <span>=</span> <span>marker</span><span>.</span><span>__drag__latlng</span><span>;</span>
      <span>marker</span><span>.</span><span>__drag__latlng</span> <span>=</span> <span>undefined</span><span>;</span>
      <span>this</span><span>.</span><span>server</span><span>.</span><span>autopilot</span><span>.</span><span>setWaypointPosition</span><span>(</span><span>id</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>);</span>
    <span>});</span>

    <span>// Then, because we want to see the flight path, not just individual markers,</span>
    <span>// we also build trails between "the new marker" and the previous one.</span>
    <span>const</span> <span>prev</span> <span>=</span> <span>this</span><span>.</span><span>waypoints</span><span>.</span><span>at</span><span>(</span><span>-</span><span>1</span><span>);</span>
    <span>this</span><span>.</span><span>waypoints</span><span>.</span><span>push</span><span>(</span><span>waypoint</span><span>);</span>
    <span>if</span> <span>(</span><span>prev</span><span>)</span> <span>{</span>
      <span>waypoint</span><span>.</span><span>prev</span> <span>=</span> <span>prev</span><span>;</span>
      <span>prev</span><span>.</span><span>next</span> <span>=</span> <span>waypoint</span><span>;</span>
      <span>waypoint</span><span>.</span><span>trail</span> <span>=</span> <span>this</span><span>.</span><span>addNewTrail</span><span>(</span><span>prev</span><span>.</span><span>lat</span><span>,</span> <span>prev</span><span>.</span><span>long</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>);</span>
    <span>}</span>
  <span>}</span>

  <span>/**
   * Check if we need to update a local waypoint based on it
   * having changed at the server.
   */</span>
  <span>updateWaypoint</span><span>(</span><span>waypoint</span><span>,</span> <span>fromServer</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>id</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>alt</span><span>,</span> <span>active</span><span>,</span> <span>completed</span> <span>}</span> <span>=</span> <span>fromServer</span><span>;</span>

    <span>// First, are we currently dragging this point around? If so, don't</span>
    <span>// do anything to this point yet, because we're not done with it.</span>
    <span>if</span> <span>(</span><span>waypoint</span><span>.</span><span>marker</span><span>?.</span><span>__drag__latlng</span><span>)</span> <span>return</span><span>;</span>

    <span>// Did its location change?</span>
    <span>if</span> <span>(</span><span>waypoint</span><span>.</span><span>lat</span> <span>!==</span> <span>lat</span> <span>||</span> <span>waypoint</span><span>.</span><span>long</span> <span>!==</span> <span>long</span><span>)</span> <span>{</span>
      <span>waypoint</span><span>.</span><span>lat</span> <span>=</span> <span>lat</span><span>;</span>
      <span>waypoint</span><span>.</span><span>long</span> <span>=</span> <span>long</span><span>;</span>
      <span>waypoint</span><span>.</span><span>marker</span><span>.</span><span>setLatLng</span><span>([</span><span>lat</span><span>,</span> <span>long</span><span>]);</span>

      <span>// if it did, we also need to update the trail(s) that connect to it.</span>
      <span>const</span> <span>prev</span> <span>=</span> <span>waypoint</span><span>.</span><span>prev</span><span>;</span>
      <span>if</span> <span>(</span><span>prev</span><span>)</span> <span>{</span>
        <span>waypoint</span><span>.</span><span>trail</span><span>?.</span><span>remove</span><span>();</span>
        <span>waypoint</span><span>.</span><span>trail</span> <span>=</span> <span>this</span><span>.</span><span>addNewTrail</span><span>(</span><span>prev</span><span>.</span><span>lat</span><span>,</span> <span>prev</span><span>.</span><span>long</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>);</span>
      <span>}</span>
      <span>const</span> <span>next</span> <span>=</span> <span>waypoint</span><span>.</span><span>next</span><span>;</span>
      <span>if</span> <span>(</span><span>next</span><span>)</span> <span>{</span>
        <span>next</span><span>.</span><span>trail</span><span>?.</span><span>remove</span><span>();</span>
        <span>next</span><span>.</span><span>trail</span> <span>=</span> <span>this</span><span>.</span><span>addNewTrail</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>next</span><span>.</span><span>lat</span><span>,</span> <span>next</span><span>.</span><span>long</span><span>);</span>
      <span>}</span>
    <span>}</span>

    <span>// Do we need to update its altitude information?</span>
    <span>const</span> <span>div</span> <span>=</span> <span>waypoint</span><span>.</span><span>marker</span><span>.</span><span>getElement</span><span>();</span>
    <span>if</span> <span>(</span><span>div</span> <span>&amp;&amp;</span> <span>div</span><span>.</span><span>dataset</span><span>)</span> <span>{</span>
      <span>if</span> <span>(</span><span>alt</span><span>)</span> <span>{</span>
        <span>div</span><span>.</span><span>dataset</span><span>.</span><span>alt</span> <span>=</span> <span>`</span><span>${</span><span>alt</span><span>}</span><span>'`</span><span>;</span>
      <span>}</span> <span>else</span> <span>{</span>
        <span>delete</span> <span>div</span><span>.</span><span>dataset</span><span>.</span><span>alt</span><span>;</span>
      <span>}</span>
    <span>}</span>
    <span>waypoint</span><span>.</span><span>alt</span> <span>=</span> <span>alt</span><span>;</span>

    <span>// What about the waypoint "state" classes?</span>
    <span>const</span> <span>classes</span> <span>=</span> <span>div</span><span>.</span><span>classList</span><span>;</span>
    <span>waypoint</span><span>.</span><span>active</span> <span>=</span> <span>active</span><span>;</span>
    <span>classes</span><span>.</span><span>toggle</span><span>(</span><span>`active`</span><span>,</span> <span>!!</span><span>active</span><span>);</span>
    <span>waypoint</span><span>.</span><span>completed</span> <span>=</span> <span>completed</span><span>;</span>
    <span>classes</span><span>.</span><span>toggle</span><span>(</span><span>`completed`</span><span>,</span> <span>!!</span><span>completed</span><span>);</span>
  <span>}</span>

  <span>/**
   * Set a human-friendly label on a waypoint
   */</span>
  <span>setWaypointLabel</span><span>(</span><span>waypoint</span><span>,</span> <span>number</span><span>)</span> <span>{</span>
    <span>waypoint</span><span>.</span><span>marker</span>
      <span>.</span><span>getElement</span><span>()</span>
      <span>.</span><span>querySelector</span><span>(</span><span>`.pre`</span><span>)</span>
       <span>// We'll show the waypoint's number (starting at 1, not 0) as</span>
       <span>// well as the distance to this waypoint from the previous one.</span>
      <span>.</span><span>textContent</span> <span>=</span> <span>`waypoint </span><span>${</span><span>number</span><span>}</span><span> (</span><span>${</span><span>waypoint</span><span>.</span><span>distance</span><span>.</span><span>toFixed</span><span>(</span><span>1</span><span>)}</span><span> NM)`</span><span>;</span>
  <span>}</span>

  <span>/**
   * remove a point locally (because it no longer exists at the server)
   */</span>
  <span>removeWaypoint</span><span>(</span><span>id</span><span>)</span> <span>{</span>
    <span>const</span> <span>pos</span> <span>=</span> <span>this</span><span>.</span><span>waypoints</span><span>.</span><span>findIndex</span><span>((</span><span>e</span><span>)</span> <span>=&gt;</span> <span>e</span><span>.</span><span>id</span> <span>===</span> <span>id</span><span>);</span>
    <span>if</span> <span>(</span><span>pos</span> <span>===</span> <span>-</span><span>1</span><span>)</span> <span>return</span><span>;</span>
    <span>const</span> <span>waypoint</span> <span>=</span> <span>this</span><span>.</span><span>waypoints</span><span>.</span><span>splice</span><span>(</span><span>pos</span><span>,</span> <span>1</span><span>)[</span><span>0</span><span>];</span>
    <span>waypoint</span><span>.</span><span>marker</span><span>.</span><span>remove</span><span>();</span>
    <span>waypoint</span><span>.</span><span>trail</span><span>?.</span><span>remove</span><span>();</span>
    <span>waypoint</span><span>.</span><span>next</span><span>?.</span><span>trail</span><span>?.</span><span>remove</span><span>();</span>
  <span>}</span>

  <span>/**
   * Make sure that cosmetically, the first waypoint is labeled
   * as waypoint 1, the next is waypoint 2, etc, irrespective of
   * the waypoint's internal id number.
   */</span>
  <span>resequence</span><span>(</span><span>repeating</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>waypoints</span><span>.</span><span>forEach</span><span>((</span><span>waypoint</span><span>,</span> <span>pos</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>if</span> <span>(</span><span>pos</span> <span>&gt;</span> <span>0</span><span>)</span> <span>{</span>
        <span>const</span> <span>{</span> <span>lat</span><span>,</span> <span>long</span> <span>}</span> <span>=</span> <span>waypoint</span><span>;</span>
        <span>const</span> <span>prev</span> <span>=</span> <span>(</span><span>waypoint</span><span>.</span><span>prev</span> <span>=</span> <span>this</span><span>.</span><span>waypoints</span><span>[</span><span>pos</span> <span>-</span> <span>1</span><span>]);</span>
        <span>waypoint</span><span>.</span><span>trail</span><span>?.</span><span>remove</span><span>();</span>
        <span>waypoint</span><span>.</span><span>trail</span> <span>=</span> <span>this</span><span>.</span><span>addNewTrail</span><span>(</span><span>prev</span><span>.</span><span>lat</span><span>,</span> <span>prev</span><span>.</span><span>long</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>);</span>
      <span>}</span>
      <span>this</span><span>.</span><span>setWaypointLabel</span><span>(</span><span>waypoint</span><span>,</span> <span>pos</span> <span>+</span> <span>1</span><span>);</span>
    <span>});</span>
  <span>}</span>

  <span>/**
   * A little helper for "drawing lines" between waypoints. By using
   * separate lines, we can more easily update "just the two that need
   * to be redone" when a point gets moved around, rather than having
   * to rebuild the entire flight path's polygon.
   */</span>
  <span>addNewTrail</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>lat2</span><span>,</span> <span>long2</span><span>)</span> <span>{</span>
    <span>const</span> <span>trail</span> <span>=</span> <span>new</span> <span>Trail</span><span>(</span><span>this</span><span>.</span><span>map</span><span>,</span> <span>[</span><span>lat</span><span>,</span> <span>long</span><span>],</span> <span>`var(--flight-path-colour)`</span><span>);</span>
    <span>trail</span><span>.</span><span>add</span><span>(</span><span>lat2</span><span>,</span> <span>long2</span><span>);</span>
    <span>return</span> <span>trail</span><span>;</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>We’ll be using the following image for our marker:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/page/marker-icon.png" alt="marker-icon"></p>

<p>And we’ll use a smattering of CSS to make the various waypoint states look differently, in  our <code>public/css/map-marker.css</code> file:</p>

<pre><code>#map {
  --flight-path-colour: grey;
}

...

.waypoint-div {
  &amp;::before {
    content: attr(data-alt);
    position: relative;
    width: 40px;
    display: inline-block;
    text-align: center;
    bottom: -40px;
    text-shadow:
      0px 0px 5px black,
      0px 0px 10px black,
      0px 0px 15px black;
    color: white;
    font-weight: bold;
  }

  &amp;.active .waypoint-marker img {
    filter: hue-rotate(145deg) brightness(2);
  }

  &amp; .waypoint-marker {
    &amp; .pre {
      display: block;
      position: absolute;
      width: auto;
      white-space: nowrap;
      background: white;
      border: 1px solid lightgrey;
      border-radius: 5px;
      padding: 0 4px;
      top: calc(1em - 100%);
      left: -40%;
    }
    &amp; img {
      width: 40px !important;
      height: 40px !important;
      position: relative;
      top: -20px;
      left: 0;
    }
  }

  &amp;.completed .waypoint-marker {
    &amp; .pre {
      top: calc(1em - 50%);
      left: -40%;
    }
    &amp; img {
      width: 20px !important;
      height: 20px !important;
      filter: hue-rotate(-45deg);
      opacity: 1;
      top: 0px;
      left: 10px;
    }
  }
}
</code></pre>

<p>And with that, we should be ready to do some testing!</p>

<h3 id="testing-waypoint-placement">Testing waypoint placement</h3>

<p>If we rerun our server with <code>node api-server.js --mock</code> and our client with <code>node web-server.js --owner --browser</code> , we can now run our “simulation” and place a bunch of waypoints by clicking the map, which will send a waypoint creation message to the server, which creates the <em>actual</em> waypoint, which we’re then told about because the waypoints are now part of the autopilot information that gets sent to the client every time the autopilot updates, and the plane will do something!</p>

<p><img src="https://pomax.github.io/are-we-flying/images/waypoints/placing-points.png" alt="Adding some waypoints to our map"></p>

<p>…but it’s a bit janky: the map keeps snapping to the plane, which makes placing points harder than it needs to be because we need to zoom out so we can place points, and then when we try to move them around the map keeps changing on us, not to mention that the plane is using an extremely poor waypoint policy that we can’t actually use in-game:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240128175409726.png" alt="image-20240128175409726"></p>

<p>Note that, at no point during this flight, are we actually properly on the flight path itself… And of course: while we can move points around, we don’t have a way to edit or remove them yet. Nor a way to mark a sequence of waypoints as repeating… let’s improve things a bit!</p>

<h2 id="quality-of-life-improvements">Quality of life improvements</h2>

<h3 id="dont-snap-the-map">Don’t snap the map</h3>

<p>When placing or moving waypoints, it would be <em>Extremely Useful <sup>(tm)</sup></em> if the map didn’t constantly snap to our plane. If you recall, the reason it does that is because we have a <code>map.setView()</code> call in our <code>plane.js</code> that explicitly keeps the map in lock-step with our plane, so let’s add a flag in the code, and a checkbox to our page, and tie those two together.</p>

<p>First, we’ll edit our <code>index.html</code>:</p>

<div><pre><code><span>&lt;!doctype html&gt;</span>
<span>&lt;html</span> <span>lang=</span><span>"en-GB"</span><span>&gt;</span>
  <span>&lt;head&gt;</span>
    ...
    <span>&lt;link</span> <span>rel=</span><span>"stylesheet"</span> <span>href=</span><span>"css/index.css"</span> <span>async</span> <span>/&gt;</span>
  <span>&lt;/head&gt;</span>
  <span>&lt;body&gt;</span>
    ...
    <span>&lt;div</span> <span>id=</span><span>"map-controls"</span><span>&gt;</span>
      <span>&lt;fieldset&gt;</span>
        <span>&lt;label</span> <span>for=</span><span>"center-on-plane"</span><span>&gt;</span>Center map on plane<span>&lt;/label&gt;</span>
        <span>&lt;input</span> <span>id=</span><span>"center-on-plane"</span> <span>type=</span><span>"checkbox"</span> <span>checked=</span><span>"checked"</span> <span>/&gt;</span>
      <span>&lt;/fieldset&gt;</span>
    <span>&lt;/div&gt;</span>
    <span>&lt;div</span> <span>id=</span><span>"visualization"</span><span>&gt;</span>
      ...
    <span>&lt;/div&gt;</span>
    ...
  <span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
</code></pre></div>

<p>With a tiny <code>public/css/index.css</code>:</p>

<div><pre><code><span>fieldset</span> <span>{</span>
  <span>display</span><span>:</span> <span>inline-block</span><span>;</span>
  <span>margin</span><span>:</span> <span>0</span><span>;</span>
  <span>padding</span><span>:</span> <span>0.25em</span> <span>0.5em</span><span>;</span>
  <span>border</span><span>:</span> <span>1px</span> <span>solid</span> <span>black</span><span>;</span>
  <span>border-radius</span><span>:</span> <span>0.5em</span><span>;</span>
<span>}</span>

<span>label</span><span>[</span><span>for</span><span>]</span> <span>{</span>
  <span>cursor</span><span>:</span> <span>pointer</span><span>;</span>
<span>}</span>

<span>button</span><span>.active</span> <span>{</span>
  <span>background</span><span>:</span> <span>red</span><span>;</span>
  <span>color</span><span>:</span> <span>white</span><span>;</span>
<span>}</span>
</code></pre></div>

<p>And if that last rule looks familiar: it used to live in our <code>autopilot.css</code> file, but we want it to apply page-wide now (so let’s remove it from our autopilot CSS file). Then, we want to hook this page element into our <code>plane.js</code> code:</p>

<div><pre><code><span>...</span>

<span>export</span> <span>class</span> <span>Plane</span> <span>{</span>
  <span>constructor</span><span>(</span><span>server</span><span>,</span> <span>map</span> <span>=</span> <span>defaultMap</span><span>,</span> <span>location</span> <span>=</span> <span>DUNCAN_AIRPORT</span><span>,</span> <span>heading</span> <span>=</span> <span>135</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>this</span><span>.</span><span>setupControls</span><span>(</span><span>map</span><span>);</span>
  <span>}</span>

  <span>setupControls</span><span>(</span><span>map</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>centerMapOnPlane</span> <span>=</span> <span>true</span><span>;</span>

    <span>// Link our checkbox to our new "centerMapOnPlane" flag</span>
    <span>const</span> <span>btn</span> <span>=</span> <span>(</span><span>this</span><span>.</span><span>centerButton</span> <span>=</span> <span>document</span><span>.</span><span>getElementById</span><span>(</span><span>`center-on-plane`</span><span>));</span>
    <span>btn</span><span>.</span><span>addEventListener</span><span>(</span><span>`change`</span><span>,</span> <span>({</span> <span>target</span> <span>})</span> <span>=&gt;</span> <span>(</span><span>this</span><span>.</span><span>centerMapOnPlane</span> <span>=</span> <span>!!</span><span>target</span><span>.</span><span>checked</span><span>));</span>

    <span>// Then: if we drag the map around, turn off auto-centering</span>
    <span>map</span><span>.</span><span>on</span><span>(</span><span>`drag`</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span> <span>if</span> <span>(</span><span>btn</span><span>.</span><span>checked</span><span>)</span> <span>btn</span><span>.</span><span>click</span><span>();</span> <span>});</span>

    <span>// And if we load the page without the checkbox checked</span>
    <span>// (e.g. we reload the page), get it checked.</span>
    <span>if</span> <span>(</span><span>!</span><span>btn</span><span>.</span><span>checked</span><span>)</span> <span>btn</span><span>.</span><span>click</span><span>();</span>
  <span>}</span>

  <span>...</span>

  <span>// And of course: control the centering using our new flag!</span>
  <span>async</span> <span>updateMap</span><span>({</span> <span>model</span><span>:</span> <span>flightModel</span><span>,</span> <span>data</span><span>:</span> <span>flightData</span><span>,</span> <span>general</span> <span>})</span> <span>{</span>
    <span>...</span>
    <span>if</span> <span>(</span><span>this</span><span>.</span><span>centerMapOnPlane</span><span>)</span> <span>map</span><span>.</span><span>setView</span><span>([</span><span>lat</span><span>,</span> <span>long</span><span>]);</span>
    <span>...</span>
  <span>}</span>

<span>...</span>
<span>}</span>
</code></pre></div>

<p>And we’re done, if we reload our page and drag the map around, we no longer auto-center on our plane until we tick that checkbox again (or click its associated label, which counts as ticking the checkbox).</p>

<h3 id="toggle-label-visualization">Toggle label visualization</h3>

<p>Things can get a bit hard to see with a large flightpath with lots of labels, so let’s add a tiny bit more HTML and CSS to toggle waypoint labels. We’ll add a checkbox to our <code>index.html</code> similar to what we just did for centering the map on the plane:</p>

<div><pre><code>    <span>&lt;div</span> <span>id=</span><span>"map-controls"</span><span>&gt;</span>
      <span>&lt;fieldset&gt;</span>
        <span>&lt;label</span> <span>for=</span><span>"center-on-plane"</span><span>&gt;</span>Center map on plane<span>&lt;/label&gt;</span>
        <span>&lt;input</span> <span>id=</span><span>"center-on-plane"</span> <span>type=</span><span>"checkbox"</span> <span>checked=</span><span>"checked"</span> <span>/&gt;</span>
      <span>&lt;/fieldset&gt;</span>
      <span>&lt;fieldset&gt;</span>
        <span>&lt;label</span> <span>for=</span><span>"show-labels"</span><span>&gt;</span>Show waypoint labels<span>&lt;/label&gt;</span>
        <span>&lt;input</span> <span>id=</span><span>"show-labels"</span> <span>type=</span><span>"checkbox"</span> <span>checked</span> <span>/&gt;</span>
      <span>&lt;/fieldset&gt;</span>
    <span>&lt;/div&gt;</span>
</code></pre></div>

<p>And then we’ll update our <code>index.css</code>, with a bit of clever CSS that toggles visibility of our waypoint labels based on whether or not our checkbox is checked or unchecked:</p>

<div><pre><code><span>body</span> <span>{</span>
  <span>&amp;:has(#</span><span>show-labels</span><span>:</span><span>not</span><span>(:</span><span>checked</span><span>))</span> <span>{</span>
    <span>#</span><span>map</span> <span>.</span><span>waypoint-div</span> <span>.</span><span>waypoint-marker</span> <span>{</span>
      <span>&amp;</span> <span>.</span><span>pre</span><span>,</span> <span>&amp;</span> <span>.</span><span>post</span> <span>{</span>
        <span>display</span><span>:</span> <span>none</span><span>;</span>
      <span>}</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>What we’ve done here is created a conditional bit of CSS for <code>#map .waypoint-div .waypoint-marker</code> that will only kick in when <code>#show-labels:not(:checked)</code> is true <em>anywhere on the page</em>. This kind of CSS only works in browsers that support <code>:has</code>, but as of 2024 that’s “all of them” so that’s handy: no classes that need to be set, and no JavaScript needed.</p>

<p><img src="https://pomax.github.io/are-we-flying/images/waypoints/hide-labels.png" alt="Hiding our waypoint labels"></p>

<p>In fact, let’s take that one step further by also adding an option that lets us scale our markers down:</p>

<div><pre><code>    <span>&lt;div</span> <span>id=</span><span>"map-controls"</span><span>&gt;</span>
      <span>&lt;fieldset&gt;</span>
        <span>&lt;label</span> <span>for=</span><span>"center-on-plane"</span><span>&gt;</span>Center map on plane<span>&lt;/label&gt;</span>
        <span>&lt;input</span> <span>id=</span><span>"center-on-plane"</span> <span>type=</span><span>"checkbox"</span> <span>checked=</span><span>"checked"</span> <span>/&gt;</span>
      <span>&lt;/fieldset&gt;</span>
      <span>&lt;fieldset&gt;</span>
        <span>&lt;label</span> <span>for=</span><span>"show-labels"</span><span>&gt;</span>Show waypoint labels<span>&lt;/label&gt;</span>
        <span>&lt;input</span> <span>id=</span><span>"show-labels"</span> <span>type=</span><span>"checkbox"</span> <span>checked</span> <span>/&gt;</span>
      <span>&lt;/fieldset&gt;</span>
      <span>&lt;fieldset&gt;</span>
        <span>&lt;label</span> <span>for=</span><span>"tiny-waypoints"</span><span>&gt;</span>Tiny waypoints<span>&lt;/label&gt;</span>
        <span>&lt;input</span> <span>id=</span><span>"tiny-waypoints"</span> <span>type=</span><span>"checkbox"</span> <span>/&gt;</span>
      <span>&lt;/fieldset&gt;</span>
  <span>&lt;/div&gt;</span>
</code></pre></div>

<p>And an extra CSS rule for waypoint images:</p>

<div><pre><code>
<span>body</span> <span>{</span>
  <span>&amp;:has(#</span><span>show-labels</span><span>:</span><span>not</span><span>(:</span><span>checked</span><span>))</span> <span>{</span>
    <span>...</span>
  <span>}</span>

  <span>&amp;</span><span>:has</span><span>(</span><span>#tiny-waypoints</span><span>:checked</span><span>)</span> <span>{</span>
    <span>#map</span> <span>.waypoint-div</span> <span>.waypoint-marker</span> <span>{</span>
      <span>&amp;</span> <span>img</span> <span>{</span>
        <span>transform</span><span>:</span> <span>translate</span><span>(</span><span>0</span><span>,</span> <span>10px</span><span>)</span> <span>scale</span><span>(</span><span>0.4</span><span>);</span>
      <span>}</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And now we can toggle between full size waypoints and mini waypoints, which is super useful when we’re zoomed out, looking at a large path with lots of waypoints:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240120115225767.png" alt="image-20240120115225767"></p>

<h3 id="waypoint-management-buttons">Waypoint management buttons</h3>

<p>Next up: some buttons for waypoint management things:</p>

<ol>
  <li>a “patrol” button for turning a flightpath into a repeating path,</li>
  <li>a “reset” button to reset the flight path to “not flown yet”, and</li>
  <li>a “clear” button to remove all waypoints.</li>
</ol>

<p>Much like before, let’s start with the HTML:</p>

<div><pre><code><span>&lt;!doctype html&gt;</span>
<span>&lt;html</span> <span>lang=</span><span>"en-GB"</span><span>&gt;</span>
  <span>&lt;head&gt;</span>
    ...
  <span>&lt;/head&gt;</span>
  <span>&lt;body&gt;</span>
    ...
    <span>&lt;div</span> <span>id=</span><span>"map-controls"</span><span>&gt;</span>
      ...
      <span>&lt;fieldset&gt;</span>
        <span>&lt;button</span> <span>class=</span><span>"reset"</span><span>&gt;</span>reset waypoints<span>&lt;/button&gt;</span>
        <span>&lt;button</span> <span>class=</span><span>"clear"</span><span>&gt;</span>clear waypoints<span>&lt;/button&gt;</span>
      <span>&lt;/fieldset&gt;</span>
    <span>&lt;/div&gt;</span>
    ...
  <span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
</code></pre></div>

<p>And then we update our <code>waypoint-overlay.js</code> since these are waypoint-related controls:</p>

<div><pre><code><span>...</span>
<span>export</span> <span>class</span> <span>WaypointOverlay</span> <span>{</span>
  <span>constructor</span><span>(</span><span>plane</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>this</span><span>.</span><span>addEventHandling</span><span>();</span>
  <span>}</span>

  <span>addEventHandling</span><span>()</span> <span>{</span>
    <span>...</span>

    <span>document</span>
      <span>.</span><span>querySelector</span><span>(</span><span>`#map-controls .reset`</span><span>)</span>
      <span>.</span><span>addEventListener</span><span>(</span><span>`click`</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
        <span>// We won't ask for confirmation to reset the flight path for</span>
        <span>// reasons that will become clear in the next improvement.</span>
        <span>server</span><span>.</span><span>autopilot</span><span>.</span><span>resetWaypoints</span><span>();</span>
      <span>});</span>

    <span>document</span>
      <span>.</span><span>querySelector</span><span>(</span><span>`#map-controls .clear`</span><span>)</span>
      <span>.</span><span>addEventListener</span><span>(</span><span>`click`</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
        <span>// But we *do* verify that this wasn't an accidental click!</span>
        <span>if</span> <span>(</span><span>confirm</span><span>(</span><span>`Are you sure you want to clear all waypoints?`</span><span>))</span> <span>{</span>
          <span>server</span><span>.</span><span>autopilot</span><span>.</span><span>clearWaypoints</span><span>();</span>
        <span>}</span>
      <span>});</span>
  <span>}</span>

  <span>...</span>
<span>}</span>
</code></pre></div>

<p>Sorted. Next up:</p>

<h3 id="repeating-the-flight-path">Repeating the flight path</h3>

<p>Let’s also add in a button that toggles the flight path from being “just this path” to “and when you get to the end, start at the start again”. First up, our page code:</p>

<div><pre><code><span>&lt;!doctype html&gt;</span>
<span>&lt;html</span> <span>lang=</span><span>"en-GB"</span><span>&gt;</span>
  <span>&lt;head&gt;</span>
    ...
  <span>&lt;/head&gt;</span>
  <span>&lt;body&gt;</span>
    ...
    <span>&lt;div</span> <span>id=</span><span>"map-controls"</span><span>&gt;</span>
      ...
      <span>&lt;fieldset&gt;</span>
        <span>&lt;button</span> <span>class=</span><span>"patrol"</span><span>&gt;</span>patrol<span>&lt;/button&gt;</span>
        <span>&lt;button</span> <span>class=</span><span>"reset"</span><span>&gt;</span>reset waypoints<span>&lt;/button&gt;</span>
        <span>&lt;button</span> <span>class=</span><span>"clear"</span><span>&gt;</span>clear waypoints<span>&lt;/button&gt;</span>
      <span>&lt;/fieldset&gt;</span>
    <span>&lt;/div&gt;</span>
    ...
  <span>&lt;/body&gt;</span>
<span>&lt;/html&gt;</span>
</code></pre></div>

<p>because we’re basically turning the flight path into a patrol route =)</p>

<p>Next, our <code>waypoint-overlay.js</code> to add the click handler:</p>

<div><pre><code><span>...</span>

<span>export</span> <span>class</span> <span>WaypointOverlay</span> <span>{</span>
  <span>...</span>

  <span>addEventHandling</span><span>()</span> <span>{</span>
    <span>...</span>

    <span>document</span>
      <span>.</span><span>querySelector</span><span>(</span><span>`#map-controls .patrol`</span><span>)</span>
      <span>.</span><span>addEventListener</span><span>(</span><span>`click`</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
        <span>server</span><span>.</span><span>autopilot</span><span>.</span><span>toggleRepeating</span><span>();</span>
      <span>});</span>
  <span>}</span>

  <span>// But we're not done: we now also need some extra code that</span>
  <span>// can show the flight path as closed or not, by adding an</span>
  <span>// extra trail from end to start...</span>

  <span>manage</span><span>(</span><span>waypoints</span> <span>=</span> <span>[],</span> <span>repeating</span><span>)</span> <span>{</span>
    <span>// Since we could start the web UI when a flight already</span>
    <span>// in progress, make sure to class our button appropriately:</span>
    <span>document</span>
      <span>.</span><span>querySelector</span><span>(</span><span>`#map-controls .patrol`</span><span>)</span>
      <span>.</span><span>classList</span><span>.</span><span>toggle</span><span>(</span><span>`active`</span><span>,</span> <span>repeating</span><span>);</span>

    <span>// And make sure to add the trail that "closes" the flight path, or removes it,</span>
    <span>// based on the repeating state and whether we already have it or not.</span>
    <span>this</span><span>.</span><span>updateClosingTrail</span><span>(</span><span>repeating</span><span>);</span>

    <span>...</span>
  <span>}</span>

  <span>...</span>

  <span>/**
   * And then we also make sure  call that function when a waypoint moves,
   * and that waypoint is either the first or last point
   * in our list:
   */</span>
  <span>updateWaypoint</span><span>(</span><span>waypoint</span><span>,</span> <span>fromServer</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>if</span> <span>(</span><span>waypoint</span><span>.</span><span>lat</span> <span>!==</span> <span>lat</span> <span>||</span> <span>waypoint</span><span>.</span><span>long</span> <span>!==</span> <span>long</span><span>)</span> <span>{</span>
      <span>...</span>

      <span>// Did we move the first or last waypoint?</span>
      <span>const</span> <span>pos</span> <span>=</span> <span>this</span><span>.</span><span>waypoints</span><span>.</span><span>findIndex</span><span>((</span><span>e</span><span>)</span> <span>=&gt;</span> <span>e</span><span>.</span><span>id</span> <span>===</span> <span>id</span><span>);</span>
      <span>if</span> <span>(</span><span>pos</span> <span>===</span> <span>0</span> <span>||</span> <span>pos</span> <span>===</span> <span>this</span><span>.</span><span>waypoints</span><span>.</span><span>length</span> <span>-</span> <span>1</span><span>)</span> <span>{</span>
        <span>// If we did, update our "wraparound" line.</span>
        <span>this</span><span>.</span><span>updateClosingTrail</span><span>();</span>
      <span>}</span>
    <span>}</span>
    <span>...</span>
  <span>}</span>

  <span>...</span>

  <span>/**
   * We also extend the resequence function signature to
   * include the repeat flag:
   */</span>
  <span>resequence</span><span>(</span><span>repeating</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>// and then use that to call a new function:</span>
    <span>this</span><span>.</span><span>updateClosingTrail</span><span>(</span><span>repeating</span><span>);</span>
  <span>}</span>

  <span>/**
   * Which makes sure that we have a trail connecting the first
   * and last waypoint, if we need to repeat the flightpath.
   * Note that we also call this when we *move* the first or
   * last point, so we indiscriminantly remove the trail first,
   * then selectively add it back in.
   */</span>
  <span>updateClosingTrail</span><span>(</span><span>repeating</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>waypoints</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>if</span> <span>(</span><span>waypoints</span><span>.</span><span>length</span> <span>&lt;</span> <span>2</span><span>)</span> <span>return</span><span>;</span>

    <span>if</span> <span>(</span><span>this</span><span>.</span><span>closingTrail</span><span>)</span> <span>{</span>
      <span>this</span><span>.</span><span>closingTrail</span><span>.</span><span>remove</span><span>();</span>
      <span>this</span><span>.</span><span>closingTrail</span> <span>=</span> <span>undefined</span><span>;</span>
    <span>}</span>

    <span>if</span> <span>(</span><span>repeating</span> <span>&amp;&amp;</span> <span>!</span><span>this</span><span>.</span><span>closingTrail</span><span>)</span> <span>{</span>
      <span>const</span> <span>first</span> <span>=</span> <span>waypoints</span><span>[</span><span>0</span><span>];</span>
      <span>const</span> <span>last</span> <span>=</span> <span>waypoints</span><span>.</span><span>at</span><span>(</span><span>-</span><span>1</span><span>);</span>
      <span>this</span><span>.</span><span>closingTrail</span> <span>=</span> <span>this</span><span>.</span><span>addNewTrail</span><span>(</span>
        <span>first</span><span>.</span><span>lat</span><span>,</span>
        <span>first</span><span>.</span><span>long</span><span>,</span>
        <span>last</span><span>.</span><span>lat</span><span>,</span>
        <span>last</span><span>.</span><span>long</span>
      <span>);</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And now we can “open” or “close” a flight path!</p>

<h3 id="adding-a-waypoint-edit-modal">Adding a waypoint edit modal</h3>

<p>Finally, we’re still missing something that lets us edit a waypoint. We can click-drag them to move them on the map but we still need UI for:</p>

<ol>
  <li>changing the elevation,</li>
  <li>duplicating a waypoint,</li>
  <li>making a waypoint the current target, and</li>
  <li>removing a waypoint.</li>
</ol>

<p>So let’s make a little modal that then let’s make sure we can also edit and/or remove waypoints, by adding some code that gives us an edit modal when we click on waypoints. And edit to our <code>waypoint-overlay.js</code>:</p>

<div><pre><code><span>...</span>
<span>import</span> <span>{</span> <span>showWaypointModal</span> <span>}</span> <span>from</span> <span>"</span><span>./waypoint-modal.js</span><span>"</span><span>;</span>

<span>export</span> <span>class</span> <span>WaypointOverlay</span> <span>{</span>
  <span>...</span>
  <span>addWaypoint</span><span>(</span><span>waypoint</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>// Add a "show dialog" action when we click a waypoint marker:</span>
    <span>marker</span><span>.</span><span>on</span><span>(</span><span>`click`</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>showWaypointModal</span><span>(</span><span>this</span><span>.</span><span>server</span><span>,</span> <span>waypoint</span><span>));</span>
    <span>...</span>
  <span>}</span>
  <span>...</span>
<span>}</span>
</code></pre></div>

<p>And then we write a bunch of fairly straight-forward JS in a new <code>waypoint-modal.js</code>:</p>

<div><pre><code><span>/**
 * Show a full-page modal for editing waypoint properties.
 */</span>
<span>export</span> <span>function</span> <span>showWaypointModal</span><span>(</span><span>server</span><span>,</span> <span>waypoint</span><span>)</span> <span>{</span>
  <span>const</span> <span>{</span> <span>id</span><span>,</span> <span>alt</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>active</span><span>,</span> <span>completed</span> <span>}</span> <span>=</span> <span>waypoint</span><span>;</span>

  <span>// Previously we used `fetch` to template HTML into our page,</span>
  <span>// but since we're not just permanently adding this modal and</span>
  <span>// instead want to remove it from the page when we're done,</span>
  <span>// let's use a template string instead:</span>
  <span>const</span> <span>modal</span> <span>=</span> <span>document</span><span>.</span><span>createElement</span><span>(</span><span>`div`</span><span>);</span>
  <span>modal</span><span>.</span><span>close</span> <span>=</span> <span>()</span> <span>=&gt;</span> <span>modal</span><span>.</span><span>remove</span><span>();</span>
  <span>modal</span><span>.</span><span>classList</span><span>.</span><span>add</span><span>(</span><span>`modal`</span><span>);</span>
  <span>modal</span><span>.</span><span>innerHTML</span> <span>=</span> <span>`
      &lt;dialog class="content" open&gt;
        &lt;h3&gt;Waypoint </span><span>${</span><span>id</span><span>}</span><span>&lt;/h3&gt;
        &lt;h4&gt;</span><span>${</span><span>lat</span><span>.</span><span>toFixed</span><span>(</span><span>6</span><span>)}</span><span>, </span><span>${</span><span>long</span><span>.</span><span>toFixed</span><span>(</span><span>6</span><span>)}</span><span>&lt;/h4&gt;
        &lt;fieldset&gt;
          &lt;label&gt;Elevation:&lt;/label&gt;
          &lt;input type="number" class="altitude" value="</span><span>${</span>
            <span>alt</span> <span>?</span> <span>alt</span> <span>:</span> <span>``</span>
          <span>}</span><span>" placeholder="feet above sea level"/&gt;
        &lt;/fieldset&gt;
        &lt;fieldset&gt;
          &lt;label&gt;Options:&lt;/label&gt;
					&lt;button class="duplicate"&gt;duplicate&lt;/button&gt;
					&lt;button class="target"&gt;fly&lt;/button&gt;
					&lt;button class="remove"&gt;remove&lt;/button&gt;
        &lt;/fieldset&gt;
      &lt;/dialog&gt;
    `</span><span>;</span>

  <span>// Add the modal to the page and get the elevation input field:</span>
  <span>document</span><span>.</span><span>body</span><span>.</span><span>appendChild</span><span>(</span><span>modal</span><span>);</span>
  <span>const</span> <span>input</span> <span>=</span> <span>modal</span><span>.</span><span>querySelector</span><span>(</span><span>`input.altitude`</span><span>);</span>

  <span>// Dismiss the modal and commit the elevation change</span>
  <span>// if we click outside the dialog box:</span>
  <span>modal</span><span>.</span><span>addEventListener</span><span>(</span><span>`click`</span><span>,</span> <span>(</span><span>evt</span><span>)</span> <span>=&gt;</span> <span>{</span>
    <span>const</span> <span>{</span> <span>target</span> <span>}</span> <span>=</span> <span>evt</span><span>;</span>
    <span>if</span> <span>(</span><span>target</span> <span>===</span> <span>modal</span><span>)</span> <span>{</span>
      <span>evt</span><span>.</span><span>preventDefault</span><span>();</span>
      <span>evt</span><span>.</span><span>stopPropagation</span><span>();</span>
      <span>const</span> <span>alt</span> <span>=</span> <span>parseFloat</span><span>(</span><span>input</span><span>.</span><span>value</span><span>);</span>
      <span>modal</span><span>.</span><span>close</span><span>();</span>
      <span>if</span> <span>(</span><span>!</span><span>isNaN</span><span>(</span><span>alt</span><span>)</span> <span>&amp;&amp;</span> <span>alt</span> <span>&gt;</span> <span>0</span><span>)</span> <span>{</span>
        <span>server</span><span>.</span><span>autopilot</span><span>.</span><span>setWaypointElevation</span><span>(</span><span>id</span><span>,</span> <span>alt</span><span>);</span>
      <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>input</span><span>.</span><span>value</span><span>.</span><span>trim</span><span>()</span> <span>===</span> <span>``</span><span>)</span> <span>{</span>
        <span>server</span><span>.</span><span>autopilot</span><span>.</span><span>setWaypointElevation</span><span>(</span><span>id</span><span>,</span> <span>false</span><span>);</span>
      <span>}</span>
    <span>}</span>
  <span>});</span>

  <span>// Also add key-based dismissal:</span>
  <span>// - `Esc` cancels the modal without doing anything</span>
  <span>// - `Enter` applies and closes.</span>
  <span>const</span> <span>controller</span> <span>=</span> <span>new</span> <span>AbortController</span><span>();</span>
  <span>document</span><span>.</span><span>addEventListener</span><span>(</span>
    <span>`keydown`</span><span>,</span>
    <span>({</span> <span>key</span> <span>})</span> <span>=&gt;</span> <span>{</span>
      <span>if</span> <span>(</span><span>key</span> <span>===</span> <span>`Escape`</span><span>)</span> <span>{</span>
        <span>modal</span><span>.</span><span>close</span><span>();</span>
        <span>controller</span><span>.</span><span>abort</span><span>();</span>
      <span>}</span>
      <span>if</span> <span>(</span><span>key</span> <span>===</span> <span>`Enter`</span><span>)</span> <span>{</span>
        <span>modal</span><span>.</span><span>click</span><span>();</span>
        <span>controller</span><span>.</span><span>abort</span><span>();</span>
      <span>}</span>
    <span>},</span>
    <span>{</span> <span>signal</span><span>:</span> <span>controller</span><span>.</span><span>signal</span> <span>}</span>
  <span>);</span>

  <span>// Then we hook up our "duplicate" button:</span>
  <span>const</span> <span>duplicate</span> <span>=</span> <span>modal</span><span>.</span><span>querySelector</span><span>(</span><span>`button.duplicate`</span><span>);</span>
  <span>duplicate</span><span>.</span><span>addEventListener</span><span>(</span><span>`click`</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
    <span>server</span><span>.</span><span>autopilot</span><span>.</span><span>duplicateWaypoint</span><span>(</span><span>id</span><span>);</span>
    <span>modal</span><span>.</span><span>close</span><span>();</span>
  <span>});</span>

  <span>// And our "This is now our target" button:</span>
  <span>const</span> <span>target</span> <span>=</span> <span>modal</span><span>.</span><span>querySelector</span><span>(</span><span>`button.target`</span><span>);</span>
  <span>target</span><span>.</span><span>addEventListener</span><span>(</span><span>`click`</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
    <span>server</span><span>.</span><span>autopilot</span><span>.</span><span>targetWaypoint</span><span>(</span><span>id</span><span>);</span>
    <span>modal</span><span>.</span><span>close</span><span>();</span>
  <span>});</span>

  <span>// And our "remove waypoint" button:</span>
  <span>const</span> <span>remove</span> <span>=</span> <span>modal</span><span>.</span><span>querySelector</span><span>(</span><span>`button.remove`</span><span>);</span>
  <span>remove</span><span>.</span><span>addEventListener</span><span>(</span><span>`click`</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
    <span>server</span><span>.</span><span>autopilot</span><span>.</span><span>removeWaypoint</span><span>(</span><span>id</span><span>);</span>
    <span>modal</span><span>.</span><span>close</span><span>();</span>
  <span>});</span>

  <span>// And finally, auto-select the elevation text when</span>
  <span>// the modal opens so you can immediately change it</span>
  <span>// by just typing (or immediately tab to the buttons)</span>
  <span>input</span><span>.</span><span>addEventListener</span><span>(</span><span>`focus`</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>input</span><span>.</span><span>select</span><span>());</span>
  <span>input</span><span>.</span><span>focus</span><span>();</span>
<span>}</span>

</code></pre></div>

<p>With some CSS to make that modal look sensible, in <code>index.css</code>:</p>

<div><pre><code><span>div</span><span>.modal</span> <span>{</span>
  <span>width</span><span>:</span> <span>100%</span><span>;</span>
  <span>position</span><span>:</span> <span>fixed</span><span>;</span>
  <span>display</span><span>:</span> <span>flex</span><span>;</span>
  <span>top</span><span>:</span> <span>0</span><span>;</span>
  <span>right</span><span>:</span> <span>0</span><span>;</span>
  <span>bottom</span><span>:</span> <span>0</span><span>;</span>
  <span>left</span><span>:</span> <span>0</span><span>;</span>
  <span>background</span><span>:</span> <span>#0009</span><span>;</span>
  <span>z-index</span><span>:</span> <span>1000</span><span>;</span>
  <span>justify-content</span><span>:</span> <span>center</span><span>;</span>
  <span>align-items</span><span>:</span> <span>center</span><span>;</span>

  <span>&amp;</span> <span>dialog.content</span> <span>{</span>
    <span>background</span><span>:</span> <span>white</span><span>;</span>
    <span>border</span><span>:</span> <span>none</span><span>;</span>
    <span>border-radius</span><span>:</span> <span>0.5em</span><span>;</span>
    <span>padding</span><span>:</span> <span>0</span> <span>2em</span> <span>1em</span> <span>2em</span><span>;</span>
    <span>box-shadow</span><span>:</span> <span>3px</span> <span>3px</span> <span>14px</span> <span>#000</span><span>;</span>

    <span>&amp;</span> <span>h3</span> <span>{</span>
      <span>font-family</span><span>:</span> <span>sans-serif</span><span>;</span>
    <span>}</span>

    <span>&amp;</span> <span>fieldset</span> <span>{</span>
      <span>border</span><span>:</span> <span>none</span><span>;</span>
      <span>padding</span><span>:</span> <span>0</span><span>;</span>
      <span>display</span><span>:</span> <span>block</span><span>;</span>

      <span>&amp;</span> <span>+</span> <span>fieldset</span> <span>{</span>
        <span>margin-top</span><span>:</span> <span>1em</span><span>;</span>
      <span>}</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And now when we click on a waypoint, we get this:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240128100954922.png" alt="image-20240128100954922"></p>

<p>And that’s our quality of life improvements covered, how about we make this “plane” fly our flight path already!</p>

<h2 id="how-to-fly-a-flight-path">How to fly a flight path</h2>

<p>As we saw before, our naïve approach of flying waypoints is… not great. Even though we have waypoints, it turns out that just flying towards individual points without regard for the path between those points is a pretty terrible way to fly “a path”.  So (probably unsurprisingly) we need a bit more than just “fly towards a point, and when we get there, fly towards the next point” if we want proper flight path following. So let’s have a bit of a think about how we can improve our flight path logic.</p>

<p>Let’s start with the use case we already have: flying a flight path with a single waypoint. This is what we already implemented: if there’s a single point, then that’s our target, and that’s what we fly towards. So far so good, our plane can already do this!</p>

<p><img src="https://pomax.github.io/are-we-flying/images/waypoints/flightpath/single-point.png" alt="A single target"></p>

<p>But what do we want to have happens when we add a second point?</p>

<p><img src="https://pomax.github.io/are-we-flying/images/waypoints/flightpath/line-segment.png" alt="Various flight segments"></p>

<p>Now we have conflicting priorities: on the one hand, the idea behind the flight path is that we fly from waypoint to waypoint, while sticking to the path, but we’re not on the path yet: do we first fly towards the next waypoint, or do we first “get on the path”? And if we’ve figured that out, what if we have a third point, creating a “real” flight path with a transition from one leg of the journey to the next:</p>

<p><img src="https://pomax.github.io/are-we-flying/images/waypoints/flightpath/three-point-path.png" alt="Three points form a real flight path"></p>

<p>When do we transition? If we transition “when we pass the waypoint” we’ll be overshooting the next leg by a lot. If we transition too early, we might miss the waypoint we actually wanted to see.</p>

<h3 id="flight-path-policies">Flight path policies</h3>

<p>Let’s investigate some options by writing a graphics program that flies a little plane around.</p>

<graphics-element title="A flight path tester" src="./graphics/flight-path-base.js">
  <source title="our airplane class" src="https://pomax.github.io/are-we-flying/graphics/airplane.js">
</graphics-element>

<p>This shows the policy we already implemented, with a reduced plane radius: we switch to the next waypoint when we’re 10 pixels away from our current one, and as we know, that’s a pretty terrible policy, and leads to the plane flying something that looks nothing like our intended flight path.</p>

<p>Clearly, what we want is at least <em>some</em> form of “getting onto the line that joins waypoints”, so let’s see what we can do here: if the plane isn’t on the flight path, we can calculate the projection of the airplane onto our flight path using some <a href="https://stackoverflow.com/a/1079478/740553">basic linear algebra</a> and then fly towards that point. This will take us closer and closer to the flight path until we’re less than our plane’s radius away, at which point we stop targeting the plane’s projection and instead target the intersection point between the flightpath, and the circle around our plane. This also takes care of transitions: if we’re close enough to the next waypoint, the circle around our plane will also already be intersecting the next flight path, so we just keeping following the line/circle intersection”:</p>

<div><pre><code><span>// Get our current waypoint</span>
<span>const</span> <span>p1</span> <span>=</span> <span>points</span><span>[</span><span>current</span><span>];</span>
<span>if</span> <span>(</span><span>!</span><span>p1</span><span>)</span> <span>return</span><span>;</span>

<span>// Are we flying "a leg"?</span>
<span>const</span> <span>p2</span> <span>=</span> <span>points</span><span>[</span><span>current</span> <span>+</span> <span>1</span><span>];</span>

<span>// If we're not...</span>
<span>if</span> <span>(</span><span>!</span><span>p2</span><span>)</span> <span>{</span>
  <span>// ...and we're close enough to p1 to "transtion" (to nothing,</span>
  <span>// since there's no next waypoint), switch...</span>
  <span>if</span> <span>(</span><span>dist</span><span>(</span><span>airplane</span><span>.</span><span>x</span><span>,</span> <span>airplane</span><span>.</span><span>y</span><span>,</span> <span>p1</span><span>.</span><span>x</span><span>,</span> <span>p1</span><span>.</span><span>y</span><span>)</span> <span>&lt;</span> <span>airplane</span><span>.</span><span>r</span><span>)</span> <span>{</span>
    <span>current</span><span>++</span><span>;</span>
  <span>}</span>
  <span>// ...and return p1 as "this is our target"</span>
  <span>return</span> <span>p1</span><span>;</span>
<span>}</span>

<span>// If we *are* flying a leg, project our plane onto the flightpath</span>
<span>// and target that, or if our "circle" overlaps the flight path,</span>
<span>// target the intersection of the flight path line and our circle:</span>
<span>const</span> <span>target</span> <span>=</span> <span>airplane</span><span>.</span><span>project</span><span>(</span><span>p1</span><span>.</span><span>x</span><span>,</span> <span>p1</span><span>.</span><span>y</span><span>,</span> <span>p2</span><span>.</span><span>x</span><span>,</span> <span>p2</span><span>.</span><span>y</span><span>,</span> <span>airplane</span><span>.</span><span>r</span><span>);</span>

<span>// And if we're close enough to p2, transition.</span>
<span>if</span> <span>(</span><span>dist</span><span>(</span><span>airplane</span><span>.</span><span>x</span><span>,</span> <span>airplane</span><span>.</span><span>y</span><span>,</span> <span>p2</span><span>.</span><span>x</span><span>,</span> <span>p2</span><span>.</span><span>y</span><span>)</span> <span>&lt;</span> <span>airplane</span><span>.</span><span>r</span><span>)</span> <span>{</span>
  <span>current</span><span>++</span><span>;</span>
<span>}</span>

<span>return</span> <span>target</span><span>;</span>
</code></pre></div>

<p>So let’s see what that does when we slot this new targeting code in the above graphics:</p>

<graphics-element title="A flight path testing program" src="./graphics/flight-path-base.js">
  <source title="our airplane class" src="https://pomax.github.io/are-we-flying/graphics/airplane.js">
  <source title="our new targeting policy" src="https://pomax.github.io/are-we-flying/graphics/project.js">
</graphics-element>

<p>This at least looks a bit better, but it can take quite a while for the plane to be properly aligned with the flight path, and it would be nicer if we could make that happen quicker.</p>

<p>We can sort of fake that by giving our plane a smaller radius: the smaller we make it, the closer our target point on the flight path will be to our plane, but then we also run the risk of overshooting our transitions again… play around with the radius slider in the following graphic to see what happens:</p>

<graphics-element title="Intercepting the flight path" src="./graphics/flight-path-base.js">
  <source src="https://pomax.github.io/are-we-flying/graphics/airplane.js">
  <source src="https://pomax.github.io/are-we-flying/graphics/dynamic-project.js">
</graphics-element>

<p>Of course, we can be clever and give the plane <em>two</em> radii instead of just one:</p>
<ul>
  <li>one that represents our transition radius, and</li>
  <li>one that represents our on-path target radius:</li>
</ul>

<div><pre><code><span>...</span>

<span>const</span> <span>target</span> <span>=</span> <span>airplane</span><span>.</span><span>project</span><span>(</span><span>p1</span><span>.</span><span>x</span><span>,</span> <span>p1</span><span>.</span><span>y</span><span>,</span> <span>p2</span><span>.</span><span>x</span><span>,</span> <span>p2</span><span>.</span><span>y</span><span>,</span> <span>onPathRadius</span><span>);</span>

<span>if</span> <span>(</span><span>dist</span><span>(</span><span>airplane</span><span>.</span><span>x</span><span>,</span> <span>airplane</span><span>.</span><span>y</span><span>,</span> <span>p2</span><span>.</span><span>x</span><span>,</span> <span>p2</span><span>.</span><span>y</span><span>)</span> <span>&lt;</span> <span>airplane</span><span>.</span><span>r</span><span>)</span> <span>{</span>
  <span>current</span><span>++</span><span>;</span>
<span>}</span>

<span>return</span> <span>target</span><span>;</span>
</code></pre></div>

<p>Which has the following effect:</p>

<graphics-element title="Dynamic flight path interception" src="./graphics/flight-path-base.js">
  <source src="https://pomax.github.io/are-we-flying/graphics/airplane.js">
  <source src="https://pomax.github.io/are-we-flying/graphics/dual-project.js">
</graphics-element>

<p>This is again better, but if you look at what happens at the transitions with angles less than 90 degrees, our outer circle intersects the next leg of our flight path <em>before</em> the plane reaches the next waypoint, so what if we transition early?</p>

<p>Instead of just projecting our plane onto the current leg, we’ll also project the plane onto the <em>next</em> leg, and if the distance from our plane to that second projection is less than our plane’s outer radius, we transition, while still using our inner radius for finding a point on the flight path to target:</p>

<div><pre><code><span>function</span> <span>checkTransition</span><span>(</span><span>p</span><span>)</span> <span>{</span>
  <span>if</span> <span>(</span><span>dist</span><span>(</span><span>airplane</span><span>.</span><span>x</span><span>,</span> <span>airplane</span><span>.</span><span>y</span><span>,</span> <span>p</span><span>.</span><span>x</span><span>,</span> <span>p</span><span>.</span><span>y</span><span>)</span> <span>&lt;</span> <span>airplane</span><span>.</span><span>r</span><span>)</span> <span>{</span>
    <span>current</span><span>++</span><span>;</span>
    <span>return</span> <span>true</span><span>;</span>
  <span>}</span>
  <span>return</span> <span>false</span><span>;</span>
<span>}</span>

<span>let</span> <span>target</span><span>,</span> <span>p1</span><span>,</span> <span>p2</span><span>,</span> <span>p3</span><span>,</span> <span>intersection</span><span>;</span>

<span>p1</span> <span>=</span> <span>points</span><span>[</span><span>current</span><span>];</span>
<span>if</span> <span>(</span><span>!</span><span>p1</span><span>)</span> <span>return</span><span>;</span>

<span>p2</span> <span>=</span> <span>points</span><span>[</span><span>current</span> <span>+</span> <span>1</span><span>];</span>
<span>if</span> <span>(</span><span>!</span><span>p2</span><span>)</span> <span>{</span>
  <span>checkTransition</span><span>(</span><span>p1</span><span>)</span>
  <span>return</span> <span>p1</span><span>;</span>
<span>}</span>

<span>// find our target based on the "inner radius"</span>
<span>target</span> <span>=</span> <span>airplane</span><span>.</span><span>project</span><span>(</span><span>p1</span><span>.</span><span>x</span><span>,</span> <span>p1</span><span>.</span><span>y</span><span>,</span> <span>p2</span><span>.</span><span>x</span><span>,</span> <span>p2</span><span>.</span><span>y</span><span>,</span> <span>innerRadius</span><span>);</span>

<span>// And now let's also check whether we're close enough to the</span>
<span>// next leg (if there is one) so that we can transition early:</span>
<span>p3</span> <span>=</span> <span>points</span><span>[</span><span>current</span> <span>+</span> <span>2</span><span>];</span>

<span>if</span> <span>(</span><span>p3</span><span>)</span> <span>{</span>
  <span>intersection</span> <span>=</span> <span>airplane</span><span>.</span><span>project</span><span>(</span><span>p2</span><span>.</span><span>x</span><span>,</span> <span>p2</span><span>.</span><span>y</span><span>,</span> <span>p3</span><span>.</span><span>x</span><span>,</span> <span>p3</span><span>.</span><span>y</span><span>);</span>
  <span>if</span> <span>(</span><span>intersection</span> <span>&amp;&amp;</span> <span>checkTransition</span><span>(</span><span>intersection</span><span>))</span> <span>{</span>
    <span>target</span> <span>=</span> <span>intersection</span><span>;</span>
  <span>}</span>
<span>}</span> <span>else</span> <span>checkTransition</span><span>(</span><span>p2</span><span>);</span>

<span>return</span> <span>target</span><span>;</span>
</code></pre></div>

<p>Let’s switch our targeting code to this, and see what happens:</p>

<graphics-element title="Early transitioning" src="./graphics/flight-path-base.js">
  <source src="https://pomax.github.io/are-we-flying/graphics/airplane.js">
  <source src="https://pomax.github.io/are-we-flying/graphics/path-intersection.js">
</graphics-element>

<p>And that’s… honestly, pretty good! Of course, the challenge is now to figure out which radii to use in order for this to work with “real” planes in MSFS, so let’s change the way we determine what the inner radius is. Instead of hardcoding it, let’s express it as a percentage of the outer circle, and then let’s base our outer circle on the plane’s speed:</p>

<graphics-element title="Early transitioning" src="./graphics/flight-path-base.js">
  <source src="https://pomax.github.io/are-we-flying/graphics/airplane.js">
  <source src="https://pomax.github.io/are-we-flying/graphics/controlled.js">
</graphics-element>

<p>But can we do better? What if we instead borrow a page out of our autopilot book so far, and treat the intersection on the flightpath as an initial target that we then “move a little” so that it’s past the flightpath, so that if we’re far away from the flight path, it’s also far away (on the other side of the path), and if we’re on the flight path, it’s also on the flight path. Does that notably improve things?</p>

<div><pre><code><span>...</span>

<span>// Our initial target is based on our outer circle stays the same...</span>
<span>target</span> <span>=</span> <span>airplane</span><span>.</span><span>project</span><span>(</span><span>p1</span><span>.</span><span>x</span><span>,</span> <span>p1</span><span>.</span><span>y</span><span>,</span> <span>p2</span><span>.</span><span>x</span><span>,</span> <span>p2</span><span>.</span><span>y</span><span>,</span> <span>airplane</span><span>.</span><span>r</span> <span>*</span> <span>ratio_r</span><span>);</span>

<span>// ...but let's also get the projection of our plane "if our</span>
<span>// circle radius was zero", i.e. get the point projection:</span>
<span>const</span> <span>fp</span> <span>=</span> <span>airplane</span><span>.</span><span>project</span><span>(</span><span>p1</span><span>.</span><span>x</span><span>,</span> <span>p1</span><span>.</span><span>y</span><span>,</span> <span>p2</span><span>.</span><span>x</span><span>,</span> <span>p2</span><span>.</span><span>y</span><span>,</span> <span>0</span><span>);</span>

<span>// And then let's get the vector from our plane to that projection...</span>
<span>const</span> <span>dx</span> <span>=</span> <span>fp</span><span>.</span><span>x</span> <span>-</span> <span>airplane</span><span>.</span><span>x</span><span>;</span>
<span>const</span> <span>dy</span> <span>=</span> <span>fp</span><span>.</span><span>y</span> <span>-</span> <span>airplane</span><span>.</span><span>y</span><span>;</span>
<span>line</span><span>(</span><span>airplane</span><span>.</span><span>x</span><span>,</span> <span>airplane</span><span>.</span><span>y</span><span>,</span> <span>airplane</span><span>.</span><span>x</span> <span>+</span> <span>dx</span><span>,</span> <span>airplane</span><span>.</span><span>y</span> <span>+</span> <span>dy</span><span>);</span>

<span>// ...and move our target by that vector:</span>
<span>line</span><span>(</span><span>target</span><span>.</span><span>x</span><span>,</span> <span>target</span><span>.</span><span>y</span><span>,</span> <span>target</span><span>.</span><span>x</span> <span>+</span> <span>dx</span><span>,</span> <span>target</span><span>.</span><span>y</span> <span>+</span> <span>dy</span><span>);</span>
<span>point</span><span>(</span><span>target</span><span>.</span><span>x</span> <span>+</span> <span>dx</span><span>,</span> <span>target</span><span>.</span><span>y</span> <span>+</span> <span>dy</span><span>);</span>
<span>target</span> <span>=</span> <span>new</span> <span>Point</span><span>(</span><span>target</span><span>.</span><span>x</span> <span>+</span> <span>dx</span><span>,</span> <span>target</span><span>.</span><span>y</span> <span>+</span> <span>dy</span><span>);</span>

<span>...</span>
</code></pre></div>

<p>How did we do?</p>

<graphics-element title="Early transitioning" src="./graphics/flight-path-base.js">
  <source src="https://pomax.github.io/are-we-flying/graphics/airplane.js">
  <source src="https://pomax.github.io/are-we-flying/graphics/bumped.js">
</graphics-element>

<p>It’s actually hard to tell: if we overlay the graphs we see that we get onto the flight path just a <em>tiny</em> bit earlier in the very last turn, but not fast enough to justify the extra work.</p>

<p>So let’s update the <code>getHeading</code> function in our <code>waypoint-manager.js</code> file to use our “projective” flight pathing:</p>

<div><pre><code><span>import</span> <span>{</span>
  <span>getDistanceBetweenPoints</span><span>,</span>
  <span>getHeadingFromTo</span><span>,</span>
  <span>pathIntersection</span><span>,</span>
<span>}</span> <span>from</span> <span>"</span><span>../../utils/utils.js</span><span>"</span><span>;</span>

<span>...</span>

<span>export</span> <span>class</span> <span>WayPointManager</span> <span>{</span>
  <span>...</span>
  <span>getHeading</span><span>(</span><span>autopilot</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>declination</span><span>,</span> <span>speed</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>modes</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>
    <span>const</span> <span>{</span> <span>points</span><span>,</span> <span>currentWaypoint</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>const</span> <span>p1</span> <span>=</span> <span>currentWaypoint</span><span>;</span>
    <span>let</span> <span>target</span><span>;</span>

    <span>// Do we need to do anything?</span>
    <span>if</span> <span>(</span><span>!</span><span>p1</span><span>)</span> <span>return</span><span>;</span>

    <span>// we'll go with a radius based on X seconds at our current speed:</span>
    <span>const</span> <span>seconds</span> <span>=</span> <span>60</span><span>;</span>
    <span>const</span> <span>radiusInKM</span> <span>=</span> <span>speed</span> <span>*</span> <span>ONE_KTS_IN_KMS</span> <span>*</span> <span>seconds</span><span>;</span>
    <span>const</span> <span>radiusInArcDeg</span> <span>=</span> <span>radiusInKM</span> <span>*</span> <span>KM_PER_ARC_DEGREE</span><span>;</span>

    <span>// Do we only have a single point?</span>
    <span>const</span> <span>p2</span> <span>=</span> <span>p1</span><span>.</span><span>next</span>
    <span>if</span> <span>(</span><span>!</span><span>p2</span><span>)</span> <span>{</span>
      <span>this</span><span>.</span><span>checkTransition</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>p1</span><span>.</span><span>lat</span><span>,</span> <span>p1</span><span>.</span><span>long</span><span>,</span> <span>radiusInKM</span><span>);</span>
      <span>target</span> <span>=</span> <span>p1</span><span>;</span>
    <span>}</span>

    <span>// We have two or more points, so let's keep going!</span>
    <span>else</span> <span>{</span>
      <span>target</span> <span>=</span> <span>projectCircleOnLine</span><span>(</span><span>long</span><span>,</span> <span>lat</span><span>,</span> <span>radiusInArcDeg</span><span>,</span> <span>p1</span><span>.</span><span>long</span><span>,</span> <span>p1</span><span>.</span><span>lat</span><span>,</span> <span>p2</span><span>.</span><span>long</span><span>,</span> <span>p2</span><span>.</span><span>lat</span><span>);</span>

      <span>// Did this projection technically fall outside of the</span>
      <span>// line segment p1--p2, and we constrained it to p1?</span>
      <span>const</span> <span>{</span> <span>constrained</span> <span>}</span> <span>=</span> <span>target</span><span>;</span>

      <span>// Because projectCircleOnLine works with x and y values,</span>
      <span>// we need to turn those back into lat/long:</span>
      <span>target</span> <span>=</span> <span>{</span> <span>lat</span><span>:</span> <span>target</span><span>.</span><span>y</span><span>,</span> <span>long</span><span>:</span> <span>target</span><span>.</span><span>x</span> <span>};</span>

      <span>// If this was an unconstrained projection, let's apply our "vector offset":</span>
      <span>if</span> <span>(</span><span>!</span><span>constrained</span><span>)</span> <span>{</span>
        <span>let</span> <span>fp</span> <span>=</span> <span>projectCircleOnLine</span><span>(</span><span>long</span><span>,</span> <span>lat</span><span>,</span> <span>0</span><span>,</span> <span>p1</span><span>.</span><span>long</span><span>,</span> <span>p1</span><span>.</span><span>lat</span><span>,</span> <span>p2</span><span>.</span><span>long</span><span>,</span> <span>p2</span><span>.</span><span>lat</span><span>);</span>
        <span>fp</span> <span>=</span> <span>{</span> <span>lat</span><span>:</span> <span>fp</span><span>.</span><span>y</span><span>,</span> <span>long</span><span>:</span> <span>fp</span><span>.</span><span>x</span> <span>};</span>
        <span>target</span><span>.</span><span>lat</span> <span>+=</span> <span>fp</span><span>.</span><span>lat</span> <span>-</span> <span>lat</span><span>;</span>
        <span>target</span><span>.</span><span>long</span> <span>+=</span> <span>fp</span><span>.</span><span>long</span> <span>-</span> <span>long</span><span>;</span>
      <span>}</span>

      <span>// Then, do we have three or more points?</span>
      <span>const</span> <span>p3</span> <span>=</span> <span>p2</span><span>.</span><span>next</span><span>;</span>
      <span>if</span> <span>(</span><span>!</span><span>p3</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>checkTransition</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>p2</span><span>.</span><span>lat</span><span>,</span> <span>p2</span><span>.</span><span>long</span><span>,</span> <span>radiusInKM</span><span>);</span>
      <span>}</span>

      <span>// We do: let's keep going!</span>
      <span>else</span> <span>{</span>
        <span>const</span> <span>intersection</span> <span>=</span> <span>projectCircleOnLine</span><span>(</span><span>long</span><span>,</span> <span>lat</span><span>,</span> <span>radiusInArcDeg</span><span>,</span> <span>p2</span><span>.</span><span>long</span><span>,</span> <span>p2</span><span>.</span><span>lat</span><span>,</span> <span>p3</span><span>.</span><span>long</span><span>,</span> <span>p3</span><span>.</span><span>lat</span><span>);</span>
        <span>if</span> <span>(</span><span>this</span><span>.</span><span>checkTransition</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>intersection</span><span>.</span><span>y</span><span>,</span> <span>intersection</span><span>.</span><span>x</span><span>,</span> <span>radiusInKM</span><span>))</span> <span>{</span>
          <span>target</span> <span>=</span> <span>{</span> <span>lat</span><span>:</span> <span>intersection</span><span>.</span><span>y</span><span>,</span> <span>long</span><span>:</span> <span>intersection</span><span>.</span><span>x</span> <span>};</span>
        <span>}</span>
      <span>}</span>
    <span>}</span>

    <span>// We now know which GPS coordinate to target, so let's compute</span>
    <span>// which heading that equates to, and whether that means we need</span>
    <span>// to update our autopilot heading parameter:</span>
    <span>const</span> <span>newHeading</span> <span>=</span> <span>getHeadingFromTo</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>target</span><span>.</span><span>lat</span><span>,</span> <span>target</span><span>.</span><span>long</span><span>);</span>
    <span>const</span> <span>hdg</span> <span>=</span> <span>parseFloat</span><span>(((</span><span>360</span> <span>+</span> <span>newHeading</span> <span>-</span> <span>declination</span><span>)</span> <span>%</span> <span>360</span><span>).</span><span>toFixed</span><span>(</span><span>2</span><span>));</span>
    <span>if</span> <span>(</span><span>modes</span><span>[</span><span>HEADING_MODE</span><span>]</span> <span>!==</span> <span>hdg</span><span>)</span> <span>{</span>
      <span>autopilot</span><span>.</span><span>setParameters</span><span>({</span>
        <span>[</span><span>HEADING_MODE</span><span>]:</span> <span>hdg</span><span>,</span>
      <span>});</span>
    <span>}</span>

    <span>// And then return this heading to fly-level.</span>
    <span>return</span> <span>modes</span><span>[</span><span>HEADING_MODE</span><span>];</span>
  <span>}</span>

  <span>/**
   * After updating getHeading, we also need to update our "check
   * transition" function, based on radial distance:
   */</span>
  <span>checkTransition</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>lat2</span><span>,</span> <span>long2</span><span>,</span> <span>radiusInKM</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>currentWaypoint</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>const</span> <span>d</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>lat2</span><span>,</span> <span>long2</span><span>);</span>
    <span>// Are we close enough to transition to the next point?</span>
    <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>radiusInKM</span><span>)</span> <span>{</span>
      <span>currentWaypoint</span><span>.</span><span>deactivate</span><span>();</span>
      <span>this</span><span>.</span><span>currentWaypoint</span> <span>=</span> <span>currentWaypoint</span><span>?.</span><span>complete</span><span>();</span>
      <span>// Do we need to wrap-around after transitioning?</span>
      <span>if</span> <span>(</span><span>!</span><span>this</span><span>.</span><span>currentWaypoint</span> <span>&amp;&amp;</span> <span>this</span><span>.</span><span>repeating</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>resetWaypoints</span><span>();</span>
      <span>}</span>
      <span>this</span><span>.</span><span>currentWaypoint</span><span>?.</span><span>activate</span><span>();</span>
      <span>return</span> <span>true</span><span>;</span>
    <span>}</span>
    <span>return</span> <span>false</span><span>;</span>
  <span>}</span>

  <span>...</span>
<span>}</span>
</code></pre></div>

<p>Of course, we do need to add that new constant to our <code>constants.js</code>:</p>

<div><pre><code><span>...</span>
<span>export</span> <span>const</span> <span>KM_PER_ARC_DEGREE</span> <span>=</span> <span>0.01</span><span>;</span> <span>// note: on a great circle.</span>
</code></pre></div>

<p>And update our <code>utils.js</code> to include that new <code>pathIntersection</code> function, too:</p>

<div><pre><code><span>...</span>

<span>// Find a circle/line intersection, given a line segment,</span>
<span>// and constraining the intersection to the segment.</span>
<span>export</span> <span>function</span> <span>projectCircleOnLine</span><span>(</span><span>px</span><span>,</span> <span>py</span><span>,</span> <span>r</span><span>,</span> <span>x1</span><span>,</span> <span>y1</span><span>,</span> <span>x2</span><span>,</span> <span>y2</span><span>)</span> <span>{</span>
  <span>const</span> <span>dx</span> <span>=</span> <span>x2</span> <span>-</span> <span>x1</span><span>;</span>
  <span>const</span> <span>dy</span> <span>=</span> <span>y2</span> <span>-</span> <span>y1</span><span>;</span>

  <span>const</span> <span>A</span> <span>=</span> <span>dy</span> <span>**</span> <span>2</span> <span>+</span> <span>dx</span> <span>**</span> <span>2</span><span>;</span>
  <span>const</span> <span>A2</span> <span>=</span> <span>1</span> <span>/</span> <span>(</span><span>2</span> <span>*</span> <span>A</span><span>);</span>
  <span>const</span> <span>B</span> <span>=</span> <span>2</span> <span>*</span> <span>(</span><span>-</span><span>px</span> <span>*</span> <span>dx</span> <span>-</span> <span>py</span> <span>*</span> <span>dy</span> <span>+</span> <span>x1</span> <span>*</span> <span>dx</span> <span>+</span> <span>y1</span> <span>*</span> <span>dy</span><span>);</span>
  <span>const</span> <span>C</span> <span>=</span>
    <span>px</span> <span>**</span> <span>2</span> <span>+</span>
    <span>py</span> <span>**</span> <span>2</span> <span>+</span>
    <span>x1</span> <span>**</span> <span>2</span> <span>+</span>
    <span>y1</span> <span>**</span> <span>2</span> <span>-</span>
    <span>2</span> <span>*</span> <span>px</span> <span>*</span> <span>x1</span> <span>-</span>
    <span>2</span> <span>*</span> <span>py</span> <span>*</span> <span>y1</span> <span>-</span>
    <span>r</span> <span>**</span> <span>2</span><span>;</span>
  <span>const</span> <span>D</span> <span>=</span> <span>B</span> <span>*</span> <span>B</span> <span>-</span> <span>4</span> <span>*</span> <span>A</span> <span>*</span> <span>C</span><span>;</span>

  <span>// At this point, we've computed the intersection of a circle</span>
  <span>// and an (infinitely long) line, so there will be (at most)</span>
  <span>// two intersection points.</span>
  <span>const</span> <span>t1</span> <span>=</span> <span>(</span><span>-</span><span>B</span> <span>+</span> <span>sqrt</span><span>(</span><span>D</span><span>))</span> <span>*</span> <span>A2</span><span>;</span>
  <span>const</span> <span>t2</span> <span>=</span> <span>(</span><span>-</span><span>B</span> <span>-</span> <span>sqrt</span><span>(</span><span>D</span><span>))</span> <span>*</span> <span>A2</span><span>;</span>

  <span>// You may have noticed that the above code is just solving the</span>
  <span>// quadratic formula, so t1 and/or t2 might be "nothing". If there</span>
  <span>// are no roots, then there's no intersection between the circle</span>
  <span>// and the line, and we perform a plain point projection:</span>
  <span>if</span> <span>(</span><span>isNaN</span><span>(</span><span>t1</span><span>)</span> <span>&amp;&amp;</span> <span>isNaN</span><span>(</span><span>t2</span><span>))</span> <span>{</span>
    <span>const</span> <span>cx</span> <span>=</span> <span>px</span> <span>-</span> <span>x1</span><span>;</span>
    <span>const</span> <span>cy</span> <span>=</span> <span>py</span> <span>-</span> <span>y1</span><span>;</span>
    <span>let</span> <span>f</span> <span>=</span> <span>constrain</span><span>((</span><span>dx</span> <span>*</span> <span>cx</span> <span>+</span> <span>dy</span> <span>*</span> <span>cy</span><span>)</span> <span>/</span> <span>(</span><span>dx</span> <span>**</span> <span>2</span> <span>+</span> <span>dy</span> <span>**</span> <span>2</span><span>),</span> <span>0</span><span>,</span> <span>1</span><span>);</span>
    <span>return</span> <span>{</span> <span>x</span><span>:</span> <span>x1</span> <span>+</span> <span>dx</span> <span>*</span> <span>f</span><span>,</span> <span>y</span><span>:</span> <span>y1</span> <span>+</span> <span>dy</span> <span>*</span> <span>f</span> <span>};</span>
  <span>}</span>

  <span>// If we have one root, then that is, by definition, our only</span>
  <span>// solution, and if there are two solutions, then we want the</span>
  <span>// one that is closest to the start of the line segment:</span>
  <span>if</span> <span>(</span><span>isNaN</span><span>(</span><span>t1</span><span>)</span> <span>||</span> <span>t1</span> <span>&lt;</span> <span>t2</span><span>)</span> <span>t1</span> <span>=</span> <span>t2</span><span>;</span>

  <span>// However, we're *still* working with the intersection of our</span>
  <span>// circle and an infinitely long line, so now we get to force</span>
  <span>// the projection to lie on our line segment:</span>
  <span>const</span> <span>t</span> <span>=</span> <span>constrain</span><span>(</span><span>t1</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>);</span>

  <span>// And finally, we can return the intersection as {x,y} point.</span>
  <span>return</span> <span>{</span> <span>x</span><span>:</span> <span>x1</span> <span>+</span> <span>dx</span> <span>*</span> <span>t</span><span>,</span> <span>y</span><span>:</span> <span>y1</span> <span>+</span> <span>dy</span> <span>*</span> <span>t</span><span>,</span> <span>constrained</span><span>:</span> <span>t</span> <span>!==</span> <span>t1</span> <span>};</span>
<span>}</span>
</code></pre></div>

<p>That’s a lot of code to do what we sketched out before, so… does this work?</p>

<p><img src="https://pomax.github.io/are-we-flying/images/waypoints/flightpath/basic-flightpath.png" alt="Following our flight path"></p>

<p>With our mock plane, well enough to barely even see our plane’s flightpath on top of the path polygon… What if we use a slightly more aggressive flight path?</p>

<p><img src="https://pomax.github.io/are-we-flying/images/waypoints/flightpath/aggressive-flightpath.png" alt="A more aggressive flight path"></p>

<p>Not quite as good… Because our mock plane is pretty terrible at turning compared to the in-game planes, we’re seeing it overshoot a bit, as well as have difficulties with the short initial leg of the journey, but what we’re seeing by running our mock is promising, which means we can swap over to testing this “for real”, or rather, “in game” =)</p>

<p>But before we do, let’s make sure we can fly the same flight path with lots of different planes…</p>

<h2 id="saving-and-loading-flight-plans">Saving and loading flight plans</h2>

<p>Before we move on to testing, let’s make sure we can actually have different planes fly the same flight path, across multiple game sessions, otherwise testing is going to be quite the challenge. Thankfully, this is going to be super simple. First, we add some save and load buttons to our <code>index.html</code>:</p>

<div><pre><code>  ...
    <span>&lt;div</span> <span>id=</span><span>"map-controls"</span><span>&gt;</span>
      ...
      <span>&lt;fieldset&gt;</span>
        flight plan:
        <span>&lt;button</span> <span>class=</span><span>"save"</span><span>&gt;</span>save<span>&lt;/button&gt;</span>
        load: <span>&lt;input</span> <span>type=</span><span>"file"</span> <span>class=</span><span>"load"</span> <span>/&gt;</span>
      <span>&lt;/fieldset&gt;</span>
      <span>&lt;fieldset&gt;</span>
        <span>&lt;button</span> <span>class=</span><span>"patrol"</span><span>&gt;</span>patrol<span>&lt;/button&gt;</span>
        <span>&lt;button</span> <span>class=</span><span>"revalidate"</span><span>&gt;</span>revalidate<span>&lt;/button&gt;</span>
        <span>&lt;button</span> <span>class=</span><span>"reset"</span><span>&gt;</span>reset waypoints<span>&lt;/button&gt;</span>
        <span>&lt;button</span> <span>class=</span><span>"clear"</span><span>&gt;</span>clear waypoints<span>&lt;/button&gt;</span>
      <span>&lt;/fieldset&gt;</span>
    <span>&lt;/div&gt;</span>
  ...
</code></pre></div>

<p>With just enough CSS to hide the filename that file input elements insist on showing you when you’ve pick a file (and which is, annoyingly, not something you just just… remove) in our `index.css:</p>

<div><pre><code><span>fieldset</span> <span>{</span>
  <span>border</span><span>:</span> <span>1px</span> <span>solid</span> <span>black</span><span>;</span>
  <span>border-radius</span><span>:</span> <span>0.5em</span><span>;</span>
  <span>margin</span><span>:</span> <span>0</span><span>;</span>
  <span>padding</span><span>:</span> <span>0.25em</span> <span>0.5em</span><span>;</span>
  <span>display</span><span>:</span> <span>inline-block</span><span>;</span>

  <span>input[type="file"]</span> <span>{</span>
    <span>color</span><span>:</span> <span>transparent</span><span>;</span>
    <span>width</span><span>:</span> <span>6em</span><span>;</span>
  <span>}</span>
<span>}</span>
<span>...</span>
</code></pre></div>

<p>And some extra JS added to our waypoint overlay event handling function that will turn our list of waypoints into a JSON document that you can save, and can read in those documents in order to recreate a flight path:</p>

<div><pre><code><span>...</span>
<span>export</span> <span>class</span> <span>WaypointOverlay</span> <span>{</span>
  <span>constructor</span><span>(</span><span>server</span><span>,</span> <span>map</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>server</span> <span>=</span> <span>server</span><span>;</span>
    <span>this</span><span>.</span><span>map</span> <span>=</span> <span>map</span><span>;</span>
    <span>this</span><span>.</span><span>waypoints</span> <span>=</span> <span>[];</span>
    <span>this</span><span>.</span><span>addEventHandling</span><span>(</span><span>map</span><span>);</span>
  <span>}</span>

  <span>addEventHandling</span><span>()</span> <span>{</span>
    <span>...</span>

    <span>document</span>
      <span>.</span><span>querySelector</span><span>(</span><span>`#map-controls .revalidate`</span><span>)</span>
      <span>.</span><span>addEventListener</span><span>(</span><span>`click`</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
        <span>const</span> <span>{</span> <span>lat</span><span>,</span> <span>long</span> <span>}</span> <span>=</span> <span>this</span><span>.</span><span>plane</span><span>?.</span><span>state</span><span>.</span><span>flightInformation</span><span>?.</span><span>data</span> <span>||</span> <span>{};</span>
        <span>server</span><span>.</span><span>autopilot</span><span>.</span><span>revalidate</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>);</span>
      <span>});</span>

    <span>// Saving our waypoints is actually fairly easy: we throw everything except the lat/long/alt</span>
    <span>// information away, and then we generate an `&lt;a&gt;` that triggers a file download for that</span>
    <span>// data in JSON format:</span>
    <span>document</span><span>.</span><span>querySelector</span><span>(</span><span>`button.save`</span><span>).</span><span>addEventListener</span><span>(</span><span>`click`</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
      <span>// We only need the latitude, longitude, and elevation for each waypoint:</span>
      <span>const</span> <span>simplify</span> <span>=</span> <span>({</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>alt</span> <span>})</span> <span>=&gt;</span> <span>({</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>alt</span> <span>});</span>
      <span>const</span> <span>simplified</span> <span>=</span> <span>this</span><span>.</span><span>waypoints</span><span>.</span><span>map</span><span>(</span><span>simplify</span><span>);</span>
      <span>const</span> <span>data</span> <span>=</span> <span>JSON</span><span>.</span><span>stringify</span><span>(</span><span>simplified</span><span>,</span> <span>null</span><span>,</span> <span>2</span><span>);</span>

      <span>// Then create a download link:</span>
      <span>const</span> <span>downloadLink</span> <span>=</span> <span>document</span><span>.</span><span>createElement</span><span>(</span><span>`a`</span><span>);</span>
      <span>downloadLink</span><span>.</span><span>textContent</span> <span>=</span> <span>`download this flightplan`</span><span>;</span>
      <span>downloadLink</span><span>.</span><span>href</span> <span>=</span> <span>`data:text/plain;base64,</span><span>${</span><span>btoa</span><span>(</span><span>data</span><span>)}</span><span>`</span><span>;</span>
      <span>// And ask the user what to call this file:</span>
      <span>const</span> <span>defaultFilename</span> <span>=</span> <span>`flightplan.json`</span><span>;</span>
      <span>let</span> <span>filename</span> <span>=</span> <span>prompt</span><span>(</span><span>`Name this path:`</span><span>,</span> <span>defaultFilename</span><span>);</span>
      <span>if</span> <span>(</span><span>!</span><span>filename</span><span>.</span><span>endsWith</span><span>(</span><span>`.json`</span><span>))</span> <span>filename</span> <span>+=</span> <span>`.json`</span><span>;</span>
      <span>downloadLink</span><span>.</span><span>download</span> <span>=</span> <span>btoa</span><span>(</span><span>filename</span><span>);</span>
      <span>// Then click the link to trigger a download:</span>
      <span>downloadLink</span><span>.</span><span>click</span><span>();</span>
    <span>});</span>

    <span>// Loading data is even easier: we load the file using the file picker that is built</span>
    <span>// into the browser, then we parse the JSON and tell the autopilot to make waypoints:</span>
    <span>document</span><span>.</span><span>querySelector</span><span>(</span><span>`input.load`</span><span>).</span><span>addEventListener</span><span>(</span><span>`change`</span><span>,</span> <span>(</span><span>evt</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>const</span> <span>file</span> <span>=</span> <span>evt</span><span>.</span><span>target</span><span>.</span><span>files</span><span>[</span><span>0</span><span>];</span>
      <span>const</span> <span>reader</span> <span>=</span> <span>new</span> <span>FileReader</span><span>();</span>
      <span>reader</span><span>.</span><span>onload</span> <span>=</span> <span>()</span> <span>=&gt;</span> <span>{</span>
        <span>const</span> <span>response</span> <span>=</span> <span>reader</span><span>.</span><span>result</span><span>;</span>
        <span>try</span> <span>{</span>
          <span>const</span> <span>data</span> <span>=</span> <span>JSON</span><span>.</span><span>parse</span><span>(</span><span>response</span><span>);</span>
          <span>server</span><span>.</span><span>autopilot</span><span>.</span><span>clearWaypoints</span><span>();</span>
          <span>data</span><span>.</span><span>forEach</span><span>(({</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>alt</span> <span>})</span> <span>=&gt;</span>
            <span>server</span><span>.</span><span>autopilot</span><span>.</span><span>addWaypoint</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>alt</span><span>)</span>
          <span>);</span>
          <span>// Are we already flying? If so, we don't want to fly all the way back to the</span>
          <span>// start of the flight plan: target the nearest point on it, instead.</span>
          <span>if</span> <span>(</span><span>!</span><span>plane</span><span>.</span><span>state</span><span>.</span><span>flightInformation</span><span>?.</span><span>data</span><span>.</span><span>onGround</span><span>)</span> <span>{</span>
            <span>const</span> <span>{</span> <span>lat</span><span>,</span> <span>long</span> <span>}</span> <span>=</span> <span>this</span><span>.</span><span>plane</span><span>?.</span><span>state</span><span>.</span><span>flightInformation</span><span>?.</span><span>data</span> <span>||</span> <span>{};</span>
            <span>server</span><span>.</span><span>autopilot</span><span>.</span><span>revalidate</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>);</span>
          <span>}</span>
        <span>}</span> <span>catch</span> <span>(</span><span>e</span><span>)</span> <span>{</span>
          <span>console</span><span>.</span><span>error</span><span>(</span><span>`An error occurred while parsing the flight path data.`</span><span>)</span>
          <span>console</span><span>.</span><span>error</span><span>(</span><span>e</span><span>);</span>
          <span>console</span><span>.</span><span>log</span><span>(</span><span>`file data:`</span><span>,</span> <span>response</span><span>);</span>
        <span>}</span>
      <span>};</span>
      <span>reader</span><span>.</span><span>readAsText</span><span>(</span><span>file</span><span>);</span>
    <span>});</span>
  <span>}</span>

  <span>...</span>
<span>}</span>
</code></pre></div>

<p>Which leaves adding the <code>revalidate</code> function to our <code>waypoint-manager.js</code>, so that when we load up a flight path, we can find the point on that flight path that the plane is currently closest to, mark the entire path leading up to that point as “completed”, and marking everything past it as “still pending”:</p>

<div><pre><code><span>...</span>

<span>export</span> <span>class</span> <span>WayPointManager</span> <span>{</span>
  <span>...</span>

  <span>/**
   * revalidate the flight path based on the current plane position,
   * marking the nearest waypoint as "the currently active point", and
   * any points prior to it as already completed.
   */</span>
  <span>revalidate</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>)</span> <span>{</span>
    <span>// which point are we closest to?</span>
    <span>const</span> <span>{</span> <span>points</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>let</span> <span>nearest</span> <span>=</span> <span>{</span> <span>pos</span><span>:</span> <span>0</span> <span>};</span>
    <span>if</span> <span>(</span><span>lat</span> <span>!==</span> <span>undefined</span> <span>&amp;&amp;</span> <span>long</span> <span>!==</span> <span>undefined</span><span>)</span> <span>{</span>
      <span>nearest</span> <span>=</span> <span>{</span> <span>distance</span><span>:</span> <span>Number</span><span>.</span><span>MAX_SAFE_INTEGER</span><span>,</span> <span>pos</span><span>:</span> <span>-</span><span>1</span> <span>};</span>
      <span>points</span><span>.</span><span>forEach</span><span>((</span><span>p</span><span>,</span> <span>pos</span><span>)</span> <span>=&gt;</span> <span>{</span>
        <span>p</span><span>.</span><span>reset</span><span>();</span>
        <span>const</span> <span>d</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>p</span><span>.</span><span>lat</span><span>,</span> <span>p</span><span>.</span><span>long</span><span>);</span>
        <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>nearest</span><span>.</span><span>distance</span><span>)</span> <span>{</span>
          <span>nearest</span><span>.</span><span>distance</span> <span>=</span> <span>d</span><span>;</span>
          <span>nearest</span><span>.</span><span>pos</span> <span>=</span> <span>pos</span><span>;</span>
        <span>}</span>
      <span>});</span>
    <span>}</span>

    <span>// Mark all points before the one we're closest to as complete:</span>
    <span>for</span> <span>(</span><span>let</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>nearest</span><span>.</span><span>pos</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>points</span><span>[</span><span>i</span><span>].</span><span>complete</span><span>();</span>

    <span>// And then make sure every point knows what the next point is,</span>
    <span>// and mark the one that we're closest to as our current waypoint.</span>
    <span>this</span><span>.</span><span>currentWaypoint</span> <span>=</span> <span>points</span><span>[</span><span>nearest</span><span>.</span><span>pos</span><span>];</span>
    <span>this</span><span>.</span><span>currentWaypoint</span><span>.</span><span>activate</span><span>();</span>
    <span>this</span><span>.</span><span>resequence</span><span>();</span>

    <span>// and push the update to clients</span>
    <span>this</span><span>.</span><span>autopilot</span><span>.</span><span>onChange</span><span>();</span>
  <span>}</span>
<span>}</span>

</code></pre></div>

<p>And then of course we need to expose that through the <code>autopilot-router.js</code> too:</p>

<div><pre><code><span>...</span>
<span>export</span> <span>class</span> <span>AutopilotRouter</span> <span>{</span>
  <span>...</span>
  <span>revalidate</span><span>(</span><span>client</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>)</span> <span>{</span>
    <span>autopilot</span><span>.</span><span>waypoints</span><span>.</span><span>revalidate</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>);</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And with that, saving and loading’s sorted, although we want to add one more button to our page now that we can load up an entire flight plan: an “arm” button.</p>

<h3 id="get-ready-to-fly-this-path">“Get ready to fly this path”</h3>

<p>When we load a flight plan, it would be super useful if we could “prime” the autopilot so that when we turn it on, we don’t then also have to enabled every single feature manually. This should be a quick fix in our <code>autopilot.html</code>:</p>

<div><pre><code>  ...
  <span>&lt;button</span> <span>class=</span><span>"MASTER"</span><span>&gt;</span>AP<span>&lt;/button&gt;</span>
  <span>&lt;button</span> <span>class=</span><span>"arm-all"</span><span>&gt;</span>(arm all)<span>&lt;/button&gt;</span>
  ...
</code></pre></div>

<p>and our <code>public/js/autopilot.js</code>:</p>

<div><pre><code><span>...</span>
<span>export</span> <span>class</span> <span>Autopilot</span> <span>{</span>
  <span>constructor</span><span>(</span><span>owner</span><span>)</span> <span>{</span>
    <span>...</span>

    <span>domAP</span><span>.</span><span>querySelector</span><span>(</span><span>`.arm-all`</span><span>).</span><span>addEventListener</span><span>(</span><span>`click`</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
      <span>Object</span><span>.</span><span>entries</span><span>(</span><span>AP_OPTIONS</span><span>).</span><span>forEach</span><span>(([</span><span>key</span><span>,</span> <span>value</span><span>])</span> <span>=&gt;</span> <span>{</span>
        <span>if</span> <span>(</span><span>key</span> <span>===</span> <span>`MASTER`</span><span>)</span> <span>return</span><span>;</span>
        <span>if</span> <span>(</span><span>!</span><span>value</span><span>)</span> <span>{</span>
          <span>domAP</span><span>.</span><span>querySelector</span><span>(</span><span>`.</span><span>${</span><span>key</span><span>}</span><span>`</span><span>).</span><span>click</span><span>();</span>
        <span>}</span>
      <span>});</span>
    <span>});</span>
  <span>}</span>
</code></pre></div>

<p>Done, one button now presses every other button, if they’re not already pressed. Now we can load a flight path, click “arm all”, so that when we’re ready to start flying our flight path, we only have to turn on the autopilot with everything else already set correctly.</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240202120537200.png" alt="One click, four buttons"></p>

<p>Which means it’s time to test things properly by loading up some planes and flying a plan!</p>

<h2 id="part-5-testing-and-refining-our-code">Part 5: Testing and refining our code</h2>

<p>Now that we can load a flight path, we can load up <a href="https://gist.githubusercontent.com/Pomax/4bee1457ff3f33fdb1bb314908ac271b/raw/537b01ebdc0d3264ae7bfdf357b94bd963d20b3f/vancouver-island-loop.txt">this one</a>, which expects us to start on <a href="https://www.google.com/maps/place/48%C2%B038'48.0%22N+123%C2%B024'44.4%22W/@48.6466197,-123.4125952,202m/data=!3m1!1e3!4m4!3m3!8m2!3d48.646658!4d-123.41234?entry=ttu">runway 27 at Victoria Airport on Vancouver Island</a>, taking us on a round trip of East Vancouver Island by flying us over <a href="https://www.tourismcowichan.com/explore/about-cowichan/shawnigan-lake/">Shawnigan Lake</a> and <a href="https://www.canoevancouverisland.com/canoe-kayak-vancouver-island-directory/sooke-lake/">Sooke Lake</a>, turning right into the mountains at <a href="https://www.crd.bc.ca/parks-recreation-culture/parks-trails/find-park-trail/kapoor">Kapoor regional park</a>, following the valley down to the coast, turning over <a href="https://www.portrenfrew.com/">Port Renfrew</a> into the <a href="https://en.wikipedia.org/wiki/San_Juan_River_(Vancouver_Island)">San Juan river</a> valley and then following that all the way west to the <a href="https://www.cvrd.ca/1379/Kinsol-Trestle">Kinsol Tressle</a>, where we take a quick detour north towards <a href="https://vancouverisland.com/plan-your-trip/regions-and-towns/vancouver-island-bc-islands/cowichan-station/">Cowichan Station</a>, then back to Victoria Airport (which is actually in <a href="http://www.sidney.ca/">Sidney</a>, a good hour north of BC’s capital of <a href="https://www.tourismvictoria.com/">Victoria</a>):</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240202122620692.png" alt="It's Zero, the ghost dog!"></p>

<p>And I don’t know about you, but that looks a lot like “Zero”, the ghost dog from “The Nightmare Before Christmas” to me, so this is now the ghost dog tour. Let’s fly some planes!</p>

<h2 id="initial-test-flights">Initial test flights</h2>

<h3 id="de-havilland-dhc-2-beaver">De Havilland DHC-2 “Beaver”</h3>

<p><img src="https://pomax.github.io/are-we-flying/image-20240202123251197.png" alt="Departing the airport to start our journey"></p>

<p>We’ll start the beaver on the runway, load our flight plan, arm the autopilot, then pilot our plane manually for <em>just</em> long enough to get airborne, and then we’ll turn on the autopilot and let it run the rest of the flight while we sit back, make a coffee, maybe grab some snacks, and enjoy the view:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240202123743228.png" alt="image-20240202123743228"></p>

<p>Except not for long: looking at the first few turns, it’s obvious we need to refine out heading mode code a little, because we’re already overshooting our transitions at low speeds:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240202125225656.png" alt="image-20240202125225656"></p>

<p>Which means we’ll <em>really</em> overshoot our transitions at high speeds. In fact, let’s try a faster plane to see how wrong things go…</p>

<h3 id="cessna-310r">Cessna 310R</h3>

<p>The 310R is considerably faster than the Beaver, with a cruise speed that’s almost double that of the Beaver, so how do we-</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240120130749555.png" alt="image-20240120130749555"></p>

<p>Oh, okay. We can’t even make the first real turn. What happened?</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240120104424564.png" alt="image-20240120104424564"></p>

<p>Ah. We plotted a course around a little 1200’ hill, and thanks to our transition logic and turn behaviour, rather than going <em>around</em> it, we tried to go <em>through</em> it. Earth vs. Plane: Earth wins. One obvious thing we can change is the transition time: a full minute is far too long when we’re going fast, but let’s also have a look at our banking behaviour:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240202125414273.png" alt="image-20240202125414273"></p>

<p>This shows a max bank that’s only half of what we wanted our plane to do, so it might be time to tweak some values in <code>fly-level.js</code>:</p>

<div><pre><code><span>// First off, the counter-steering that we've got going on will</span>
<span>// effectively ensure we never actually get the speed we list here.</span>
<span>// As such, we can bump this from 30 to 40, to increase the max</span>
<span>// bank that planes exhibit:</span>
<span>const</span> <span>DEFAULT_MAX_BANK</span> <span>=</span> <span>40</span><span>;</span>

<span>// Next, in order to allow planes to change their rate of turn</span>
<span>// faster, we bump this up from 3 to 5. This might introduce some</span>
<span>// oscillation when we get hit from the side by a good old gust</span>
<span>// of wind, but we'll take "being wibbly" over "being dead":</span>
<span>const</span> <span>DEFAULT_MAX_D_BANK</span> <span>=</span> <span>5</span><span>;</span>

<span>...</span>

<span>// Then, we change the trim step size based on the plane's</span>
<span>// own flight model:</span>
<span>export</span> <span>async</span> <span>function</span> <span>flyLevel</span><span>(</span><span>autopilot</span><span>,</span> <span>state</span><span>)</span> <span>{</span>
  <span>...</span>
  <span>const</span> <span>{</span> <span>hasAileronTrim</span><span>,</span> <span>weight</span><span>,</span> <span>isAcrobatic</span><span>,</span> <span>vs1</span><span>,</span> <span>cruiseSpeed</span><span>}</span> <span>=</span> <span>flightModel</span><span>;</span>
  <span>...</span>
  <span>// If we're near stall speed, any amount of turn may kill us...</span>
  <span>// And if we're near cruise speed, we can turn quite a bit:</span>
  <span>let</span> <span>step</span> <span>=</span> <span>constrainMap</span><span>(</span><span>speed</span><span>,</span> <span>vs1</span><span>,</span> <span>cruiseSpeed</span><span>,</span> <span>radians</span><span>(</span><span>0.1</span><span>),</span> <span>radians</span><span>(</span><span>5</span><span>));</span>
  <span>...</span>
  <span>// And then we'll want the same kind of logic for getting</span>
  <span>// a target heading, which means passing vs1 and cruiseSpeed</span>
  <span>// on to the waypoint manager's getHeading function:</span>
  <span>const</span> <span>{</span> <span>targetBank</span><span>,</span> <span>maxDBank</span><span>,</span> <span>targetHeading</span><span>,</span> <span>headingDiff</span> <span>}</span> <span>=</span>
    <span>getTargetBankAndTurnRate</span><span>(...,</span> <span>vs1</span><span>,</span> <span>cruiseSpeed</span><span>);</span>
  <span>...</span>
<span>}</span>

<span>// New function arguments: stall and cruise speed.</span>
<span>function</span> <span>getTargetBankAndTurnRate</span><span>(...,</span> <span>vs1</span><span>,</span> <span>cruiseSpeed</span><span>)</span> <span>{</span>
  <span>...</span>
  <span>// Which we forward to the waypoint manager:</span>
  <span>let</span> <span>targetHeading</span> <span>=</span> <span>autopilot</span><span>.</span><span>waypoints</span><span>.</span><span>getHeading</span><span>(...,</span> <span>vs1</span><span>,</span> <span>cruiseSpeed</span><span>);</span>
  <span>let</span> <span>headingDiff</span><span>;</span>
  <span>if</span> <span>(</span><span>targetHeading</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>// And then let's not restrict our rate of bank until we're 2 degrees,</span>
    <span>// from our target heading, rather than 10 degrees. And let's also make</span>
    <span>// sure to allow for *some* change in rate of bank at 0.</span>
    <span>maxDBank</span> <span>=</span> <span>constrainMap</span><span>(</span><span>abs</span><span>(</span><span>headingDiff</span><span>),</span> <span>0</span><span>,</span> <span>2</span><span>,</span> <span>maxDBank</span><span>/</span><span>10</span><span>,</span> <span>maxDBank</span><span>);</span>
  <span>}</span>

  <span>return</span> <span>{</span> <span>targetBank</span><span>,</span> <span>targetHeading</span><span>,</span> <span>headingDiff</span> <span>};</span>
<span>}</span>
</code></pre></div>

<p>Which leaves the fix in our <code>waypoint-manager.js</code> for the <code>getHeading</code> function, where we want the transition distance to be based on time, but the <em>amount</em> of time we need should be based on what speed we’re currently flying at, because that determines how fast we can turn:</p>

<div><pre><code><span>...</span>

<span>export</span> <span>class</span> <span>WayPointManager</span> <span>{</span>
  <span>...</span>
  <span>// In order to set a "sensible" transition distance, we need to know our</span>
  <span>// stall and cruise speeds, since those determine how fast we can turn.</span>
  <span>getHeading</span><span>(</span><span>autopilot</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>declination</span><span>,</span> <span>speed</span><span>,</span> <span>vs1</span><span>,</span> <span>cruiseSpeed</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>// Let's set our transtion to a full minute if we're near stall</span>
    <span>// speed, but half that if we're going at cruise speed:</span>
    <span>const</span> <span>seconds</span> <span>=</span> <span>constrainMap</span><span>(</span><span>speed</span><span>,</span> <span>vs1</span><span>,</span> <span>cruiseSpeed</span><span>,</span> <span>60</span><span>,</span> <span>30</span><span>);</span>
    <span>...</span>
  <span>}</span>
  <span>...</span>
<span>}</span>
</code></pre></div>

<p><img src="https://pomax.github.io/are-we-flying/image-20240202130332581.png" alt="image-20240202130332581"></p>

<p>Hmm. Well, we didn’t crash, but I struggle to call this “better”. In fact, let’s see what happens when try this with a plane that has a roughly similar cruise speed but doesn’t have aileron trim…</p>

<h3 id="piper-turbo-arrow-iii">Piper Turbo Arrow III</h3>

<p>Things aren’t looking too hot for our heading mode already, what if fly the same route on the stick?</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240202175023483.png" alt="image-20240202175023483"></p>

<p>Yeah… so… look at our plane’s attitude: we’re about to fall out of the sky.</p>

<p>II’m gonna go with “we need to rewrite our heading mode” because this just feels pretty under-performant. The map suggests we’re not turning as fast as we should So: what if we start over, and write a heading mode that turns the plane not based on bank angle, but based on turn rate?</p>

<h2 id="updating-our-heading-mode">Updating our heading mode</h2>

<p>Let’s replace the code we had for stick-based trimming with this:</p>

<div><pre><code><span>export</span> <span>async</span> <span>function</span> <span>flyLevel</span><span>(</span><span>autopilot</span><span>,</span> <span>state</span><span>)</span> <span>{</span>
  <span>...</span>
  <span>// we'll be updating our code to target turnRate</span>
  <span>const</span> <span>{</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>declination</span><span>,</span> <span>bank</span><span>,</span> <span>speed</span><span>,</span> <span>heading</span><span>,</span> <span>turnRate</span> <span>}</span> <span>=</span> <span>flightData</span><span>;</span>
  <span>...</span>
  <span>const</span> <span>aHeadingDiff</span> <span>=</span> <span>abs</span><span>(</span><span>headingDiff</span><span>);</span>
  <span>const</span> <span>diff</span> <span>=</span> <span>targetBank</span> <span>-</span> <span>bank</span><span>;</span>

  <span>// Then, if we're flying on the stick, we target a turn rate that lets</span>
  <span>// cover the heading difference at a resonable speed.</span>
  <span>if</span> <span>(</span><span>useStickInstead</span><span>)</span> <span>{</span>
    <span>const</span> <span>targetTurnRate</span> <span>=</span> <span>constrainMap</span><span>(</span><span>headingDiff</span><span>,</span> <span>-</span><span>20</span><span>,</span> <span>20</span><span>,</span> <span>-</span><span>3</span><span>,</span> <span>3</span><span>);</span>
    <span>const</span> <span>turnDiff</span> <span>=</span> <span>targetTurnRate</span> <span>-</span> <span>turnRate</span><span>;</span>

    <span>// But we do need to boost stick changes the closer to zero</span>
    <span>// we get, because otherwise ramp-up and ramp-down takes too long:</span>
    <span>let</span> <span>proportion</span> <span>=</span> <span>constrainMap</span><span>(</span><span>turnDiff</span><span>,</span> <span>-</span><span>3</span><span>,</span> <span>3</span><span>,</span> <span>-</span><span>1</span><span>,</span> <span>1</span><span>);</span>
    <span>proportion</span> <span>=</span> <span>sign</span><span>(</span><span>proportion</span><span>)</span> <span>*</span> <span>abs</span><span>(</span><span>proportion</span><span>);</span>

    <span>// And we may want to base the "max stick deflection" value on</span>
    <span>// flight model properties, but for now this will do. The maximum</span>
    <span>// deflection of the stick is +/- 2**14, but giving a plane that</span>
    <span>// much stick generally makes it do a barrel roll, so let's not,</span>
    <span>// and instead set our max deflection to 1/5th of that.</span>
    <span>const</span> <span>maxStick</span> <span>=</span> <span>-</span><span>16384</span> <span>/</span> <span>5</span><span>;</span>
    <span>const</span> <span>newAileron</span> <span>=</span> <span>proportion</span> <span>*</span> <span>maxStick</span><span>;</span>

    <span>// Then we "early exit" after setting the new stick value.</span>
    <span>return</span> <span>api</span><span>.</span><span>trigger</span><span>(</span><span>"</span><span>AILERON_SET</span><span>"</span><span>,</span> <span>newAileron</span> <span>|</span> <span>0</span><span>);</span>
  <span>}</span>

  <span>...</span>
<span>}</span>
</code></pre></div>

<p>How does that perform?</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240202140606069.png" alt="image-20240202140606069"></p>

<p>…feels like we might want to replace our original bank-based heading code with this turn rate based heading code. What if we just make <em>every</em> plane use this? Let’s throw away all the heading mode code we wrote before, because science told us it wasn’t all that great, and let’s use the following code for all planes, instead:</p>

<div><pre><code><span>import</span> <span>{</span> <span>constrainMap</span><span>,</span> <span>getCompassDiff</span> <span>}</span> <span>from</span> <span>"</span><span>../utils/utils.js</span><span>"</span><span>;</span>

<span>const</span> <span>{</span> <span>abs</span><span>,</span> <span>sign</span> <span>}</span> <span>=</span> <span>Math</span><span>;</span>
<span>const</span> <span>FEATURES</span> <span>=</span> <span>{</span>
  <span>FLY_SPECIFIC_HEADING</span><span>:</span> <span>true</span><span>,</span>
<span>};</span>

<span>// Our updated "fly leve" function</span>
<span>export</span> <span>async</span> <span>function</span> <span>flyLevel</span><span>(</span><span>autopilot</span><span>,</span> <span>state</span><span>)</span> <span>{</span>
  <span>const</span> <span>{</span> <span>api</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>
  <span>const</span> <span>{</span> <span>data</span><span>:</span> <span>flightData</span><span>,</span> <span>model</span><span>:</span> <span>flightModel</span> <span>}</span> <span>=</span> <span>state</span><span>;</span>
  <span>const</span> <span>{</span> <span>turnRate</span> <span>}</span> <span>=</span> <span>flightData</span><span>;</span>
  <span>const</span> <span>parameters</span> <span>=</span> <span>Object</span><span>.</span><span>assign</span><span>({</span> <span>autopilot</span> <span>},</span> <span>flightModel</span><span>,</span> <span>flightData</span><span>);</span>
  <span>const</span> <span>{</span> <span>headingDiff</span> <span>}</span> <span>=</span> <span>getTargetHeading</span><span>(</span><span>parameters</span><span>);</span>

  <span>const</span> <span>targetTurnRate</span> <span>=</span> <span>constrainMap</span><span>(</span><span>headingDiff</span><span>,</span> <span>-</span><span>20</span><span>,</span> <span>20</span><span>,</span> <span>-</span><span>3</span><span>,</span> <span>3</span><span>);</span>
  <span>const</span> <span>turnDiff</span> <span>=</span> <span>targetTurnRate</span> <span>-</span> <span>turnRate</span><span>;</span>

  <span>let</span> <span>proportion</span> <span>=</span> <span>constrainMap</span><span>(</span><span>turnDiff</span><span>,</span> <span>-</span><span>3</span><span>,</span> <span>3</span><span>,</span> <span>-</span><span>1</span><span>,</span> <span>1</span><span>);</span>
  <span>proportion</span> <span>=</span> <span>sign</span><span>(</span><span>proportion</span><span>)</span> <span>*</span> <span>abs</span><span>(</span><span>proportion</span><span>);</span>

  <span>const</span> <span>maxStick</span> <span>=</span> <span>-</span><span>16384</span> <span>/</span> <span>5</span><span>;</span>
  <span>const</span> <span>newAileron</span> <span>=</span> <span>proportion</span> <span>*</span> <span>maxStick</span><span>;</span>
  <span>api</span><span>.</span><span>trigger</span><span>(</span><span>"</span><span>AILERON_SET</span><span>"</span><span>,</span> <span>newAileron</span> <span>|</span> <span>0</span><span>);</span>
<span>}</span>

<span>// And our updated heading function</span>
<span>function</span> <span>getTargetHeading</span><span>(</span><span>parameters</span><span>)</span> <span>{</span>
  <span>const</span> <span>{</span> <span>autopilot</span><span>,</span> <span>heading</span><span>,</span> <span>speed</span><span>,</span> <span>vs1</span><span>,</span> <span>cruiseSpeed</span> <span>}</span> <span>=</span> <span>parameters</span><span>;</span>
  <span>let</span> <span>targetHeading</span> <span>=</span> <span>heading</span><span>;</span>
  <span>let</span> <span>headingDiff</span> <span>=</span> <span>0</span><span>;</span>
  <span>if</span> <span>(</span><span>FEATURES</span><span>.</span><span>FLY_SPECIFIC_HEADING</span><span>)</span> <span>{</span>
    <span>targetHeading</span> <span>=</span> <span>autopilot</span><span>.</span><span>waypoints</span><span>.</span><span>getHeading</span><span>(</span><span>parameters</span><span>);</span>
    <span>headingDiff</span> <span>=</span> <span>getCompassDiff</span><span>(</span><span>heading</span><span>,</span> <span>targetHeading</span><span>);</span>
    <span>const</span> <span>half</span> <span>=</span> <span>headingDiff</span> <span>/</span> <span>2</span><span>;</span>
    <span>headingDiff</span> <span>=</span> <span>constrainMap</span><span>(</span><span>speed</span><span>,</span> <span>vs1</span><span>,</span> <span>cruiseSpeed</span><span>,</span> <span>half</span><span>,</span> <span>headingDiff</span><span>);</span>
  <span>}</span>
  <span>return</span> <span>{</span> <span>targetHeading</span><span>,</span> <span>headingDiff</span> <span>};</span>
<span>}</span>

</code></pre></div>

<p>…and then let’s see what the 310R does for us.</p>

<h3 id="cessna-310r-take-2">Cessna 310R, take 2</h3>

<p><img src="https://pomax.github.io/are-we-flying/image-20240202141213784.png" alt="image-20240202141213784"></p>

<p>Amazing! But the map doesn’t tell the whole story, because if we look at the game (which was the whole point of course), the plane’s wobbling again, with lots of tiny back and forth corrections. So let’s smooth those out by not just setting “the new stick” in one go, but instead using a value “between the old and new stick position”, based on how big the difference between the two is: barely any difference? Bias towards the current stick value. Big difference? Bias towards the new value:</p>

<div><pre><code><span>export</span> <span>async</span> <span>function</span> <span>flyLevel</span><span>(</span><span>autopilot</span><span>,</span> <span>state</span><span>)</span> <span>{</span>
  <span>...</span>
  <span>const</span> <span>{</span> <span>aileron</span><span>,</span> <span>turnRate</span> <span>}</span> <span>=</span> <span>flightData</span><span>;</span>
  <span>const</span> <span>currentAileron</span> <span>=</span> <span>(</span><span>aileron</span> <span>/</span> <span>100</span><span>)</span> <span>*</span> <span>-</span><span>16384</span><span>;</span>

  <span>...</span>

  <span>const</span> <span>maxStick</span> <span>=</span> <span>-</span><span>16384</span> <span>/</span> <span>5</span><span>;</span>
  <span>const</span> <span>newAileron</span> <span>=</span> <span>proportion</span> <span>*</span> <span>maxStick</span><span>;</span>

  <span>// Get the difference in stick position</span>
  <span>const</span> <span>aileronDiff</span> <span>=</span> <span>abs</span><span>(</span><span>currentAileron</span> <span>-</span> <span>newAileron</span><span>);</span>

  <span>// turn that into a "how much old vs. new" ratio, raised to a power in order</span>
  <span>// to turn the normally linear constrainMap result into a result that stays</span>
  <span>// near 1 much longer, so that we mix in much less of the new stick position</span>
  <span>// if the difference is a small amount.</span>
  <span>const</span> <span>aileronDiff</span> <span>=</span> <span>abs</span><span>(</span><span>currentAileron</span> <span>-</span> <span>newAileron</span><span>);</span>
  <span>const</span> <span>ratio</span> <span>=</span> <span>constrainMap</span><span>(</span><span>aileronDiff</span><span>,</span> <span>0</span><span>,</span> <span>abs</span><span>(</span><span>maxStick</span><span>),</span> <span>1</span><span>,</span> <span>0</span><span>)</span> <span>**</span> <span>0.5</span><span>;</span>
  <span>const</span> <span>mixed</span> <span>=</span> <span>lerp</span><span>(</span><span>ratio</span><span>,</span> <span>currentAileron</span><span>,</span> <span>newAileron</span><span>);</span>

  <span>api</span><span>.</span><span>trigger</span><span>(</span><span>"</span><span>AILERON_SET</span><span>"</span><span>,</span> <span>mixed</span> <span>|</span> <span>0</span><span>);</span>
<span>}</span>
</code></pre></div>

<p>You may have noticed that <code>... ** 0.5</code>, which is pretty important: it lets us turn a nice, linear constrain mapping into a non-linear mapping:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240202143546089.png" alt="image-20240202143546089"></p>

<p>On the left is the usual constrain map behaviour, but that <code>... ** 0.5</code> takes the square root of the result, which means our ratio will favour being “near 1”, which means our mixing ratio will favour our current stick position more, the close to “no difference” we get, which means we jostle the stick less if we’re near our target turn rate. Now, if we look at how the plane flies in-game, we can confirm that indeed looks better, but let’s look at our graphs: what’s the difference between flying without that mixing ration, flying with a linear ratio, and flying with a non-linear ration?</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240202145354300.png" alt="image-20240202145354300"></p>

<p>As it turns out, we made one thing better by making another thing worse: we’ve reduced the frequency of our wobbling, but we’ve increased the <em>amount</em> of wobble. So what we really want is some way to control how much we’re “allowed” to deflect the stick, in a way that we start with a safe (far too) low maximum, and bump that up if we’re not turning fast enough (based on our turn rate), until we are. With, of course, a little bit of code that pushes it back down when we’re flying the heading we’re supposed to.</p>

<p>And wouldn’t you know it, we have a handy place to put that value: our now unused <code>trim.roll</code>. No code changes required for that at least. Then, we need some new code to let us “grow” and “shrink” the maximum allowed deflection:</p>

<div><pre><code><span>...</span>

<span>export</span> <span>async</span> <span>function</span> <span>flyLevel</span><span>(</span><span>autopilot</span><span>,</span> <span>state</span><span>)</span> <span>{</span>
  <span>const</span> <span>{</span> <span>trim</span><span>,</span> <span>api</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>
  <span>const</span> <span>{</span> <span>data</span><span>:</span> <span>flightData</span><span>,</span> <span>model</span><span>:</span> <span>flightModel</span> <span>}</span> <span>=</span> <span>state</span><span>;</span>

  <span>// Get our turn rate...</span>
  <span>const</span> <span>{</span> <span>turnRate</span> <span>}</span> <span>=</span> <span>flightData</span><span>;</span>
  <span>const</span> <span>aTurnRate</span> <span>=</span> <span>abs</span><span>(</span><span>turnRate</span><span>);</span>

  <span>// ...and our target heading...</span>
  <span>const</span> <span>parameters</span> <span>=</span> <span>Object</span><span>.</span><span>assign</span><span>({</span> <span>autopilot</span> <span>},</span> <span>flightModel</span><span>,</span> <span>flightData</span><span>);</span>
  <span>const</span> <span>{</span> <span>headingDiff</span> <span>}</span> <span>=</span> <span>getTargetHeading</span><span>(</span><span>parameters</span><span>);</span>
  <span>const</span> <span>aHeadingDiff</span> <span>=</span> <span>abs</span><span>(</span><span>headingDiff</span><span>);</span>

  <span>// ...so that we can get our target turn rate.</span>
  <span>const</span> <span>targetTurnRate</span> <span>=</span> <span>constrainMap</span><span>(</span><span>headingDiff</span><span>,</span> <span>-</span><span>20</span><span>,</span> <span>20</span><span>,</span> <span>-</span><span>3</span><span>,</span> <span>3</span><span>);</span>
  <span>const</span> <span>turnDiff</span> <span>=</span> <span>targetTurnRate</span> <span>-</span> <span>turnRate</span><span>;</span>
  <span>const</span> <span>aTurnDiff</span> <span>=</span> <span>abs</span><span>(</span><span>turnDiff</span><span>);</span>

  <span>// And we'll use those to increase the maximum allowed deflection</span>
  <span>// if it turns out the current maximum is insufficient for getting</span>
  <span>// the plane to turn fast enough to cover the heading change it</span>
  <span>// needs to cover.</span>
  <span>if</span> <span>(</span><span>aHeadingDiff</span> <span>&gt;</span> <span>1</span><span>)</span> <span>{</span>
    <span>const</span> <span>threshold</span> <span>=</span> <span>constrainMap</span><span>(</span><span>aTurnDiff</span><span>,</span> <span>0</span><span>,</span> <span>3</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>);</span>
    <span>const</span> <span>regularTurn</span> <span>=</span> <span>aTurnRate</span> <span>&lt;</span> <span>threshold</span><span>;</span>
    <span>const</span> <span>hardTurn</span> <span>=</span> <span>aHeadingDiff</span> <span>&gt;</span> <span>30</span> <span>&amp;&amp;</span> <span>aTurnRate</span> <span>&lt;</span> <span>2.5</span><span>;</span>
    <span>const</span> <span>wrongWay</span> <span>=</span> <span>sign</span><span>(</span><span>turnRate</span><span>)</span> <span>!==</span> <span>sign</span><span>(</span><span>headingDiff</span><span>);</span>
    <span>if</span> <span>(</span><span>regularTurn</span> <span>||</span> <span>hardTurn</span> <span>||</span> <span>wrongWay</span><span>)</span> <span>{</span>
      <span>updateMaxDeflection</span><span>(</span><span>trim</span><span>,</span> <span>aHeadingDiff</span><span>);</span>
    <span>}</span>
  <span>}</span>

  <span>// Conversely, we also want to decrease the maximum allowed stick</span>
  <span>// if we're flying nice and straight along our heading, so that</span>
  <span>// we end up slowly easing back towards neutral.</span>
  <span>else</span> <span>updateMaxDeflection</span><span>(</span><span>trim</span><span>,</span> <span>-</span><span>10</span><span>);</span>

  <span>// And then we'll use the same code we used before our "mixing".</span>
  <span>let</span> <span>proportion</span> <span>=</span> <span>constrainMap</span><span>(</span><span>turnDiff</span><span>,</span> <span>-</span><span>3</span><span>,</span> <span>3</span><span>,</span> <span>-</span><span>1</span><span>,</span> <span>1</span><span>);</span>
  <span>proportion</span> <span>=</span> <span>sign</span><span>(</span><span>proportion</span><span>)</span> <span>*</span> <span>abs</span><span>(</span><span>proportion</span><span>);</span>

  <span>// Rather than some fixed amount, we now get our maximum</span>
  <span>// deflection from the roll "trim" vector.</span>
  <span>const</span> <span>maxStick</span> <span>=</span> <span>-</span><span>trim</span><span>.</span><span>roll</span><span>;</span>
  <span>const</span> <span>newAileron</span> <span>=</span> <span>proportion</span> <span>*</span> <span>maxStick</span><span>;</span>
  <span>api</span><span>.</span><span>trigger</span><span>(</span><span>"</span><span>AILERON_SET</span><span>"</span><span>,</span> <span>newAileron</span> <span>|</span> <span>0</span><span>);</span>
<span>}</span>

<span>...</span>

<span>// And a little helper function that lets us change the</span>
<span>// maximum stick deflection allowed per autopilot iteration.</span>
<span>function</span> <span>updateMaxDeflection</span><span>(</span><span>trim</span><span>,</span> <span>byHowMuch</span><span>)</span> <span>{</span>
  <span>let</span> <span>{</span> <span>roll</span><span>:</span> <span>value</span> <span>}</span> <span>=</span> <span>trim</span><span>;</span>
  <span>// We don't actually want to ever allow full stick, max out at "half that":</span>
  <span>const</span> <span>maxValue</span> <span>=</span> <span>2</span><span>**</span><span>13</span><span>;</span>
  <span>value</span> <span>=</span> <span>constrain</span><span>(</span><span>value</span> <span>+</span> <span>byHowMuch</span><span>,</span> <span>0</span><span>,</span> <span>maxValue</span><span>)</span> <span>|</span> <span>0</span><span>;</span>
  <span>if</span> <span>(</span><span>value</span> <span>!==</span> <span>trim</span><span>.</span><span>roll</span><span>)</span> <span>{</span>
    <span>trim</span><span>.</span><span>roll</span> <span>=</span> <span>value</span><span>;</span>
    <span>const</span> <span>prefix</span> <span>=</span> <span>byHowMuch</span> <span>&gt;</span> <span>0</span> <span>?</span> <span>`In`</span> <span>:</span> <span>`De`</span><span>;</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`</span><span>${</span><span>prefix</span><span>}</span><span>creased aileronMaxStick to </span><span>${</span><span>value</span><span>}</span><span>`</span><span>);</span>
  <span>}</span>
<span>}</span>

</code></pre></div>

<p>And that should be a lot better, let’s try this again:</p>

<h3 id="cessna-310r-take-3">Cessna 310R, take 3</h3>

<p>Let’s run a take-off with this new code, where we prime the autopilot before we start, and then turn it on the moment the wheels come off the ground, without interfering with the stick afterwards:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240202181817642.png" alt="image-20240202181817642"></p>

<p>Not bad, but the map alludes to something that’s <em>super</em> obvious in-game: because we start with a maximum allowed deflection of 0, the plane doesn’t actually succeed at turning for a while, so “this works” but it’s a nervous first few seconds that we can avoid by starting with a better trim value. We have a few options, none of them perfect, so let’s go with this: the more inertial mass a plane has, i.e. the more it weighs, the more energy it needs to change course. Likewise, the larger the wings and ailerons are, the more a plane will be able to turn at the same aileron angle. So let’s combine those into “weight over wing area” and use that value to set an initial trim that’s very low for planes with a very low weight, very high wing area, or both, and is much higher for planes with a lot of weight, a small wing area, or both. Looking at a few planes, that gives the following table of data:</p>

<table>
  <thead>
    <tr>
      <th>plane</th>
      <th>&nbsp;&nbsp;weight<br><span>wing area</span></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Top Rudder 103 Solo</td>
      <td>3.5</td>
    </tr>
    <tr>
      <td>Pitts Special S1</td>
      <td>9.6</td>
    </tr>
    <tr>
      <td>Gee Bee R3 Special</td>
      <td>13.2</td>
    </tr>
    <tr>
      <td>Piper Turbo Arrow III</td>
      <td>14.5</td>
    </tr>
    <tr>
      <td>DeHavilland DHC-2 Beaver</td>
      <td>15.8</td>
    </tr>
    <tr>
      <td>Beechcraft Model 18</td>
      <td>18.8</td>
    </tr>
    <tr>
      <td>Daher Kodiak 100</td>
      <td>21.5</td>
    </tr>
    <tr>
      <td>Cessna 310R</td>
      <td>23</td>
    </tr>
    <tr>
      <td>Douglas DC-3</td>
      <td>23.9</td>
    </tr>
    <tr>
      <td>Daher TMB 930</td>
      <td>30.5</td>
    </tr>
    <tr>
      <td>Beechcraft King Air 350i</td>
      <td>41.22</td>
    </tr>
    <tr>
      <td>Boeing 747-8</td>
      <td>126.5</td>
    </tr>
  </tbody>
</table>

<p>This makes an intuitive kind of sense: the lighter planes are at or near the top, the heavier planes are at or near the bottom, but we also see that even though the Beaver and the D18 are wildly different weight classes, their weight over wing area is pretty similar, and so we’d expect them to need a similar amount of max aileron deflection during flight.</p>

<p>So let’s add the code that sets up our initial deflection value:</p>

<div><pre><code><span>...</span>
<span>export</span> <span>class</span> <span>Autopilot</span> <span>{</span>
  <span>...</span>

  <span>resetTrim</span><span>()</span> <span>{</span>
    <span>// 1: Figure out a sensible "start value" for working the</span>
    <span>// aileron, based on the plane's weight to wing area ratio.</span>
    <span>const</span> <span>{</span> <span>weight</span><span>,</span> <span>wingArea</span> <span>}</span> <span>=</span> <span>this</span><span>.</span><span>flightInformation</span><span>?.</span><span>model</span> <span>??</span> <span>{</span>
      <span>weight</span><span>:</span> <span>0</span><span>,</span>
      <span>wingArea</span><span>:</span> <span>1</span><span>,</span>
    <span>};</span>
    <span>const</span> <span>wpa</span> <span>=</span> <span>weight</span> <span>/</span> <span>wingArea</span><span>;</span>
    <span>const</span> <span>initialRollValue</span> <span>=</span> <span>constrainMap</span><span>(</span><span>wpa</span><span>,</span> <span>4</span><span>,</span> <span>25</span><span>,</span> <span>0</span><span>,</span> <span>5000</span><span>);</span>
    <span>console</span><span>.</span><span>log</span><span>(</span>
      <span>`initial roll value for </span><span>${</span><span>title</span><span>}</span><span>: </span><span>${</span><span>initialRollValue</span><span>}</span><span> (</span><span>${</span><span>weight</span><span>}</span><span>/</span><span>${</span><span>wingArea</span><span>}</span><span> ≈ </span><span>${</span><span>wpa</span><span>|</span><span>0</span><span>}</span><span> psf)`</span>
    <span>);</span>

    <span>// 2: "zero out" the trim vector, but not the aileron:</span>
    <span>this</span><span>.</span><span>trim</span> <span>=</span> <span>{</span>
      <span>pitch</span><span>:</span> <span>0</span><span>,</span>
      <span>roll</span><span>:</span> <span>initialRollValue</span><span>,</span>
      <span>yaw</span><span>:</span> <span>0</span><span>,</span>
    <span>};</span>
  <span>}</span>

  <span>...</span>

  <span>async</span> <span>setTarget</span><span>(</span><span>key</span><span>,</span> <span>value</span><span>)</span> <span>{</span>
    <span>...</span>

    <span>// And 3: we need to remember to *remove* the code we</span>
    <span>// wrote that saves the current aileron trim to trim.roll!</span>

    <span>// if (key === LEVEL_FLIGHT &amp;&amp; value === true) {</span>
    <span>//  we don't want any "trim.roll = roll" here anymore</span>
    <span>// }</span>
    <span>...</span>
  <span>}</span>
  <span>...</span>
<span>}</span>
</code></pre></div>

<p>If we run this with the 310R, we see the following notice in the server logs:</p>

<div><pre><code>new game started, resetting autopilot
resetting autopilot
initial roll value for Milviz 310R CGTER: 3000 (4496/186.395 ≈ 24 psf)
</code></pre></div>

<p>And we see the following flight path behaviour at takeoff (“<em>Cessna 310R, take 4</em>”?):</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203095727441.png" alt="image-20240203095727441"></p>

<p>Much nicer!</p>

<h2 id="rerunning-our-test-flights">Rerunning our test flights</h2>

<h3 id="cessna-310r-take-4">Cessna 310R, take 4</h3>

<p>Okay, yes: this is just the previous take, but now we’re looking at the whole flight. And the plane, of course:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240202194102466.png" alt="image-20240202194102466"></p>

<p>Very nice. So, what about that flight path?</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203100301040.png" alt="image-20240203100301040"></p>

<p>And it’s looking good! Much better than before!</p>

<h3 id="dehavilland-dhc-2-beaver">DeHavilland DHC-2 Beaver</h3>

<p>Which means it’s Beaver time! …that’s not a thing. Is it? It could be thing… anyway. It’s Beaver time.</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240202191143592.png" alt="image-20240202191143592"></p>

<p>And even the Beaver flies better now:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203100434634.png" alt="image-20240203100434634"></p>

<h3 id="piper-turbo-arrow-iii-1">Piper Turbo Arrow III</h3>

<p>We already did some limited testing with this plane, but not a full flight, so… let’s fly!</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203100658381.png" alt="image-20240203100658381"></p>

<p>Looking pretty, but how did we do?</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203103817431.png" alt="image-20240203103817431"></p>

<p>We did very well indeed. The turbo arrow wants a bit more initial aileron trim (ramping to about 6800 on the turns) but we end up turning pretty soon after takeoff and we just fly parallel to the runway for a bit.</p>

<h3 id="beechcraft-model-18">Beechcraft Model 18</h3>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203104153301.png" alt="image-20240203104153301"></p>

<p>Let’s fly a leisure cruise.</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203111332518.png" alt="image-20240203111332518"></p>

<p>Overall, pretty good, but there’s an interesting overshoot happening at the left-most transition, caused by having a transition radius based on a fixed amount of time. Instead, since we’re now “trimming” on turn rate, what we really want is to see how many degrees we’ll need to cover, and thus how many seconds that’s going to take, given a maximum turn rate of 3 degrees per second.</p>

<p>Let’s modify the <code>getHeading</code> in our <code>waypoint-manager.js</code> just a tiny bit:</p>

<div><pre><code><span>...</span>
<span>export</span> <span>class</span> <span>WaypointManager</span> <span>{</span>
  <span>...</span>
  <span>getHeading</span><span>({...})</span> <span>{</span>
    <span>const</span> <span>{</span> <span>modes</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>

    <span>// Get all our points up front, because we'll need all of them to</span>
    <span>// determine how many seconds we're going to need for a transition:</span>
    <span>let</span> <span>{</span> <span>currentWaypoint</span><span>:</span> <span>p1</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>let</span> <span>p2</span> <span>=</span> <span>p1</span><span>?.</span><span>next</span><span>;</span>
    <span>let</span> <span>p3</span> <span>=</span> <span>p2</span><span>?.</span><span>next</span><span>;</span>

    <span>// So: how many seconds will we need for the upcoming transition</span>
    <span>// given a turn rate of 3 degrees per second?</span>
    <span>let</span> <span>seconds</span> <span>=</span> <span>10</span><span>;</span>
    <span>if</span> <span>(</span><span>p1</span> <span>&amp;&amp;</span> <span>p2</span> <span>&amp;&amp;</span> <span>p3</span><span>)</span> <span>{</span>
      <span>const</span> <span>aHeadingDiff</span> <span>=</span> <span>abs</span><span>(</span><span>getCompassDiff</span><span>(</span><span>p1</span><span>.</span><span>heading</span><span>,</span> <span>p2</span><span>.</span><span>heading</span><span>));</span>
      <span>seconds</span> <span>=</span> <span>aHeadingDiff</span> <span>/</span> <span>3</span><span>;</span>
      <span>seconds</span> <span>=</span> <span>constrainMap</span><span>(</span><span>speed</span><span>,</span> <span>vs1</span><span>,</span> <span>cruiseSpeed</span><span>,</span> <span>seconds</span><span>/</span><span>10</span><span>,</span> <span>seconds</span><span>);</span>
    <span>}</span>
    <span>const</span> <span>radiusInKM</span> <span>=</span> <span>speed</span> <span>*</span> <span>ONE_KTS_IN_KMS</span> <span>*</span> <span>seconds</span><span>;</span>

    <span>let</span> <span>target</span><span>;</span>
    <span>let</span> <span>targets</span> <span>=</span> <span>[];</span>
    <span>...</span>
  <span>}</span>
  <span>...</span>
<span>}</span>
</code></pre></div>

<p>And if we draw our transition radius on the map with a quick Leaflet <code>Circle</code>, that’s quite a difference:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203112324179.png" alt="image-20240203112324179"></p>

<p>That’s a considerably longer transition time, so we should have a much better turn now:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203112453153.png" alt="image-20240203112453153"></p>

<p>… wait, what happened? The turn starts nice and early with a good path into the turn, but then it gets what looks like a kink in the path, and then we overshoot the next transition with a tiny radius?</p>

<p>What happened is that as we transition from flying along the coast to flying towards Port Renfrew, we switched our current waypoint from Botanical Beach to Port Renfrew, and suddenly our radius started getting computed based on the path into the valley, rather than up to Port Renfrew. We don’t want that: we want to base our transition radius on “the point we’re nearest”, rather than “the current active waypoint” because those might not be the same point!</p>

<p>So: let’s make that change in our <code>waypoint-manager.js</code>:</p>

<div><pre><code><span>...</span>

<span>const</span> <span>{</span> <span>abs</span><span>,</span> <span>max</span> <span>}</span> <span>=</span> <span>Math</span><span>;</span>

<span>// We'll put a lower limit on how late we can start</span>
<span>// a turn: even if the transition is barely a turn,</span>
<span>// start turning in when we're 20 seconds away, at</span>
<span>// the latest.</span>
<span>const</span> <span>MIN_RADIUS_IN_SECONDS</span> <span>=</span> <span>20</span><span>;</span>

<span>...</span>

<span>export</span> <span>class</span> <span>WaypointManager</span> <span>{</span>
  <span>...</span>

  <span>/**
   * Then we update our getHeading function so that it pulls the
   * transition radius from a function that calculates it:
   */</span>
  <span>getHeading</span><span>({...})</span> <span>{</span>
    <span>const</span> <span>{</span> <span>modes</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>
    <span>let</span> <span>{</span> <span>currentWaypoint</span><span>:</span> <span>p1</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>const</span> <span>radiusInKM</span> <span>=</span> <span>this</span><span>.</span><span>getTransitionRadius</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>speed</span><span>,</span> <span>vs1</span><span>,</span> <span>cruiseSpeed</span><span>,</span> <span>p1</span><span>);</span>
    <span>...</span>
  <span>}</span>

  <span>/**
   * And then we declare that function: it needs to figure out how
   * many "seconds long" our transition radius needs to be, bearing
   * in mind that if we're coming out of a transition, we need to
   * work with the *previous* set of waypoints, not the new set of
   * waypoints.
   */</span>
  <span>getTransitionRadius</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>speed</span><span>,</span> <span>vs1</span><span>,</span> <span>cruiseSpeed</span><span>,</span> <span>p1</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>points</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>const</span> <span>minRadiusInKM</span> <span>=</span> <span>MIN_RADIUS_IN_SECONDS</span> <span>*</span> <span>speed</span> <span>*</span> <span>ONE_KTS_IN_KMS</span><span>;</span>
    <span>let</span> <span>p2</span> <span>=</span> <span>p1</span><span>?.</span><span>next</span><span>;</span>
    <span>if</span> <span>(</span><span>!</span><span>p2</span><span>)</span> <span>return</span> <span>minRadiusInKM</span><span>;</span>

    <span>// Are we closer to p1 than p2?</span>
    <span>const</span> <span>d1</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>p1</span><span>.</span><span>lat</span><span>,</span> <span>p1</span><span>.</span><span>long</span><span>);</span>
    <span>const</span> <span>d2</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>p2</span><span>.</span><span>lat</span><span>,</span> <span>p2</span><span>.</span><span>long</span><span>);</span>
    <span>if</span> <span>(</span><span>d1</span> <span>&lt;</span> <span>d2</span><span>)</span> <span>{</span>
      <span>const</span> <span>prevPos</span> <span>=</span> <span>points</span><span>.</span><span>findIndex</span><span>((</span><span>e</span><span>)</span> <span>=&gt;</span> <span>e</span> <span>===</span> <span>p1</span><span>)</span> <span>-</span> <span>1</span><span>;</span>
      <span>if</span> <span>(</span><span>prevPos</span> <span>&gt;</span> <span>-</span><span>1</span><span>)</span> <span>{</span>
        <span>p1</span> <span>=</span> <span>points</span><span>[</span><span>prevPos</span><span>];</span>
        <span>p2</span> <span>=</span> <span>p1</span><span>.</span><span>next</span><span>;</span>
      <span>}</span>
    <span>}</span>

    <span>// Once we've figured that out, see if we have three</span>
    <span>// waypoints to work with, or there won't be a "transition":</span>
    <span>const</span> <span>p3</span> <span>=</span> <span>p2</span><span>?.</span><span>next</span><span>;</span>
    <span>const</span> <span>minRadiusInKM</span> <span>=</span> <span>MIN_RADIUS_IN_SECONDS</span> <span>*</span> <span>speed</span> <span>*</span> <span>ONE_KTS_IN_KMS</span><span>;</span>
    <span>if</span> <span>(</span><span>!</span><span>p1</span> <span>||</span> <span>!</span><span>p2</span> <span>||</span> <span>!</span><span>p3</span><span>)</span> <span>return</span> <span>minRadiusInKM</span><span>;</span>

    <span>// If we have three points, see what the heading difference is,</span>
    <span>// and then turn that into a second amount based on a turn rate</span>
    <span>// of 3 degrees per second, then turn that into an actual distance</span>
    <span>// value based on our current air speed:</span>
    <span>const</span> <span>aHeadingDiff</span> <span>=</span> <span>abs</span><span>(</span><span>getCompassDiff</span><span>(</span><span>p1</span><span>.</span><span>heading</span><span>,</span> <span>p2</span><span>.</span><span>heading</span><span>));</span>
    <span>let</span> <span>seconds</span> <span>=</span> <span>aHeadingDiff</span> <span>/</span> <span>3</span><span>;</span>
    <span>seconds</span> <span>=</span> <span>constrainMap</span><span>(</span><span>speed</span><span>,</span> <span>vs1</span><span>,</span> <span>cruiseSpeed</span><span>,</span> <span>seconds</span> <span>/</span> <span>10</span><span>,</span> <span>seconds</span><span>);</span>
    <span>const</span> <span>radiusInKM</span> <span>=</span> <span>seconds</span> <span>*</span> <span>speed</span> <span>*</span> <span>ONE_KTS_IN_KMS</span><span>;</span>
    <span>return</span> <span>max</span><span>(</span><span>minRadiusInKM</span><span>,</span> <span>radiusInKM</span><span>);</span>
  <span>}</span>

  <span>...</span>
<span>}</span>
</code></pre></div>

<p>Alright, what does this do for our transition radius throughout the flight?</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203123640205.png" alt="image-20240203123640205"></p>

<p>We see a small radius as we transition over a gentle turn, with that radius persisting until we’re closer to the next point, at which point our transition radius switches to the much larger one, because the turn needs to cover far more degrees. Then, once we’re turning we maintain that large radius even after the flight plan has transitioned to the next waypoint, and we don’t switch to the next, smaller, radius until we’re closer to our next point than the one we transitioned over. Leading a much better flight path behaviour:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203132121404.png" alt="image-20240203132121404"></p>

<h3 id="daher-kodiak-100">Daher Kodiak 100</h3>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203160034983.png" alt="image-20240203160034983"></p>

<p>This is the plane that we ended up needing to write the auto-throttle code for, so how does it fare?</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203163044676.png" alt="image-20240203163044676"></p>

<p>That’ll do.</p>

<h3 id="top-rudder-solo-103">Top Rudder Solo 103</h3>

<p>So… how about we fly some of the other “edge-case” planes we looked at before? Like: what happens when we, say, try the Top Rudder ultralight again?</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203132439900.png" alt="image-20240203132439900"></p>

<p>This is either going to go wrong pretty quickly, or it’s going to be <em>amazing</em></p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203132620555.png" alt="image-20240203132620555"></p>

<p>But first, let’s adjust our lower bound for the initial maximum deflection, because “zero” was clearly too low. Even this ultralight wants more than that, so let’s set it to 1500 and retry.</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203133020926.png" alt="image-20240203133020926"></p>

<p>Much better. So.. time to sit back for an hour? This one’s going to take a while!</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203134954318.png" alt="image-20240203134954318"></p>

<p>Or not?</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203135113853.png" alt="image-20240203135113853"></p>

<p>Looks like we might need some extra help to make the top rudder less… wibbly. And this is a special enough plane that it feels okay to add a dedicated, hard coded fix in our <code>fly-level.js</code>:</p>

<div><pre><code><span>export</span> <span>async</span> <span>function</span> <span>flyLevel</span><span>(</span><span>autopilot</span><span>,</span> <span>state</span><span>)</span> <span>{</span>
  <span>const</span> <span>{</span> <span>trim</span><span>,</span> <span>api</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>
  <span>const</span> <span>{</span> <span>data</span><span>:</span> <span>flightData</span><span>,</span> <span>model</span><span>:</span> <span>flightModel</span> <span>}</span> <span>=</span> <span>state</span><span>;</span>
  <span>const</span> <span>{</span> <span>weight</span><span>,</span> <span>wingArea</span> <span>}</span> <span>=</span> <span>flightModel</span><span>;</span>
  <span>const</span> <span>wpa</span> <span>=</span> <span>weight</span> <span>/</span> <span>wingArea</span><span>;</span>

  <span>...</span>

  <span>// We'll add a special affordance for ultralights, where we don't</span>
  <span>// want a lower maximum turn rate. 2 degrees per second instead of 2.</span>
  <span>const</span> <span>maxTurn</span> <span>=</span> <span>wpa</span> <span>&lt;</span> <span>5</span> <span>?</span> <span>2</span> <span>:</span> <span>3</span><span>;</span>
  <span>const</span> <span>targetTurnRate</span> <span>=</span> <span>constrainMap</span><span>(</span><span>headingDiff</span><span>,</span> <span>-</span><span>20</span><span>,</span> <span>20</span><span>,</span> <span>-</span><span>maxTurn</span><span>,</span> <span>maxTurn</span><span>);</span>

  <span>...</span>

  <span>if</span> <span>(</span><span>aHeadingDiff</span> <span>&gt;</span> <span>1</span><span>)</span> <span>{</span>
    <span>...</span>
  <span>}</span>
  <span>// And we also want the maximum deflection to drop a lot faster:</span>
  <span>else</span> <span>updateMaxDeflection</span><span>(</span><span>trim</span><span>,</span> <span>wpa</span> <span>&lt;</span> <span>5</span><span>?</span> <span>-</span><span>50</span> <span>:</span> <span>-</span><span>10</span><span>);</span>

    <span>...</span>
<span>}</span>

<span>// And a change to our update function, so that ultralights can't get "the full stick":</span>
<span>function</span> <span>updateMaxDeflection</span><span>(</span><span>wpa</span><span>,</span> <span>trim</span><span>,</span> <span>byHowMuch</span><span>)</span> <span>{</span>
  <span>let</span> <span>{</span> <span>roll</span><span>:</span> <span>value</span> <span>}</span> <span>=</span> <span>trim</span><span>;</span>
  <span>// Change the max value to only 4096 for ultralights, with 8192 for regular planes:</span>
  <span>const</span> <span>maxValue</span> <span>=</span> <span>2</span> <span>**</span> <span>(</span><span>wpa</span> <span>&lt;</span> <span>5</span> <span>?</span> <span>12</span> <span>:</span> <span>13</span><span>);</span>
  <span>value</span> <span>=</span> <span>constrain</span><span>(</span><span>value</span> <span>+</span> <span>byHowMuch</span><span>,</span> <span>0</span><span>,</span> <span>maxValue</span><span>)</span> <span>|</span> <span>0</span><span>;</span>
  <span>...</span>
<span>}</span>
</code></pre></div>

<p>Which gives us:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203141607701.png" alt="image-20240203141607701"></p>

<p>Much better. And if you look at our altitude, whereas we were barely keeping 1200’ before because of all the wobbling, this update keeps us at the intended 1400’, which is rather necessary as this part of the flight path takes us over a hill that’s just a few feet shy of 1400’!</p>

<p>Mind you, wind gusts and up- and downdrafts will still “punch us” off-course, but at least we should be able to recover from those reasonably well. So, back to flying the rest of the flight. The two hour flight. See you in a bit…</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203155113450.png" alt="image-20240203155113450"></p>

<p>Overall, pretty good! The little “lump” just behind the plane in this picture is from having gotten blown off course, which we knew was going to be a possibility. Bottom line: don’t walk away from your plane, an autopilot might still kill you, especially when the plane was never designed to use one =)</p>

<p>In fact, let’s try some more of our edge cases. What about acrobatic planes?</p>

<h3 id="pitts-special-s-1s">Pitts Special S-1S</h3>

<p>Let’s jump back into our stunting plane!</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203163344913.png" alt="image-20240203163344913"></p>

<p>Whereas previously these were… twitchy, the new code made them much more behaved. It’s almost like flying a regular plane!</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203171231542.png" alt="image-20240203171231542"></p>

<p>In fact, what about a plane that’s even <em>more</em> twitchy, normally?</p>

<h3 id="gee-bee-r3-special">Gee Bee R3 Special</h3>

<p>Let’s goooooo</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203182449270.png" alt="image-20240203182449270"></p>

<p>It’s like flying a bullet. This is going to be amazing!</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240229204704309.png" alt="image-20240229204704309"></p>

<p>…or not?</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240229204725354.png" alt="image-20240229204725354"></p>

<p>As it turns out, allowing the max aileron to go all the way down to zero, and allowing it to go all the way up to 50% of the physical stick tolerances, means we’re giving our plane either way too little, or way too much stick. So we’re going to need some extra rules for <em>properly</em> twitchy planes if we want to keep them in the air. On the <code>autopilot.js</code> side we make the code “acrobatics-aware”:</p>

<div><pre><code>  <span>resetTrim</span><span>()</span> <span>{</span>
    <span>// We want to further reduce the stick values that acrobatic planes get, so: get that flag:</span>
    <span>const</span> <span>{</span> <span>isAcrobatic</span><span>,</span> <span>weight</span><span>,</span> <span>wingArea</span><span>,</span> <span>title</span> <span>}</span> <span>=</span> <span>this</span><span>.</span><span>flightInformation</span><span>?.</span><span>model</span> <span>??</span> <span>{</span>
      <span>isAcrobatic</span><span>:</span> <span>true</span><span>,</span>
      <span>weight</span><span>:</span> <span>0</span><span>,</span>
      <span>wingArea</span><span>:</span> <span>1</span><span>,</span>
      <span>title</span><span>:</span> <span>`unknown`</span><span>,</span>
    <span>};</span>

    <span>// Then make sure acrobatic planes start at "just above zero" rather than "quite a lot above zero":</span>
    <span>const</span> <span>wpa</span> <span>=</span> <span>weight</span> <span>/</span> <span>wingArea</span><span>;</span>
    <span>let</span> <span>initialRollValue</span> <span>=</span> <span>300</span><span>;</span>
    <span>if</span> <span>(</span><span>!</span><span>isAcrobatic</span><span>)</span> <span>{</span>
      <span>initialRollValue</span> <span>=</span> <span>constrainMap</span><span>(</span><span>wpa</span><span>,</span> <span>4</span><span>,</span> <span>20</span><span>,</span> <span>1500</span><span>,</span> <span>5000</span><span>);</span>
    <span>}</span>

    <span>this</span><span>.</span><span>trim</span> <span>=</span> <span>{</span>
      <span>pitch</span><span>:</span> <span>0</span><span>,</span>
      <span>roll</span><span>:</span> <span>initialRollValue</span><span>,</span>
      <span>yaw</span><span>:</span> <span>0</span><span>,</span>
    <span>};</span>
  <span>}</span>
</code></pre></div>

<p>And then we add some acrobatics-awareness to our <code>fly-level.js</code>:</p>

<div><pre><code><span>...</span>

<span>export</span> <span>async</span> <span>function</span> <span>flyLevel</span><span>(</span><span>autopilot</span><span>,</span> <span>state</span><span>)</span> <span>{</span>
  <span>...</span>

  <span>// Again: let's get that flag:</span>
  <span>const</span> <span>{</span> <span>weight</span><span>,</span> <span>wingArea</span><span>,</span> <span>isAcrobatic</span> <span>}</span> <span>=</span> <span>flightModel</span><span>;</span>
  <span>const</span> <span>wpa</span> <span>=</span> <span>weight</span> <span>/</span> <span>wingArea</span><span>;</span>

  <span>// And then: does this qualify as a twitchy plane?</span>
  <span>const</span> <span>isTwitchy</span> <span>=</span> <span>isAcrobatic</span> <span>||</span> <span>wpa</span> <span>&lt;</span> <span>5</span><span>;</span>

  <span>...</span>

  <span>// If this is an acrobatic plane, it gets a tiny step,</span>
  <span>// and we forward the isAcrobatic flag on, so we can</span>
  <span>// set the lower and upper limit for our deflection:</span>
  <span>if</span> <span>(</span><span>aHeadingDiff</span> <span>&gt;</span> <span>1</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>if</span> <span>(</span><span>regularTurn</span> <span>||</span> <span>hardTurn</span> <span>||</span> <span>wrongWay</span><span>)</span> <span>{</span>
      <span>const</span> <span>howMuch</span> <span>=</span> <span>isAcrobatic</span> <span>?</span> <span>10</span> <span>:</span> <span>50</span><span>;</span>
      <span>updateMaxDeflection</span><span>(</span><span>trim</span><span>,</span> <span>howMuch</span><span>,</span> <span>isTwitchy</span><span>);</span>
    <span>}</span>
  <span>}</span>

  <span>else</span> <span>{</span>
    <span>// likewise, we make sure to step *down* a lot when we're</span>
    <span>// flying an acrobatic plane, too:</span>
    <span>const</span> <span>howMuch</span> <span>=</span> <span>isTwitchy</span> <span>?</span> <span>-</span><span>50</span> <span>:</span> <span>-</span><span>10</span><span>;</span>
    <span>updateMaxDeflection</span><span>(</span><span>trim</span><span>,</span> <span>howMuch</span><span>,</span> <span>isTwitchy</span><span>);</span>
  <span>}</span>

  <span>...</span>
<span>}</span>

<span>// We use the isAcrobatic flag to set the same upper limit as</span>
<span>// for ultralights, and then we bump up the lower limit from 0 to 300:</span>
<span>function</span> <span>updateMaxDeflection</span><span>(</span><span>trim</span><span>,</span> <span>byHowMuch</span><span>,</span> <span>isTwitchy</span><span>)</span> <span>{</span>
  <span>let</span> <span>{</span> <span>roll</span><span>:</span> <span>value</span> <span>}</span> <span>=</span> <span>trim</span><span>;</span>
  <span>const</span> <span>maxValue</span> <span>=</span> <span>2</span> <span>**</span> <span>(</span><span>isTwitchy</span> <span>?</span> <span>12</span> <span>:</span> <span>13</span><span>);</span>
  <span>value</span> <span>=</span> <span>constrain</span><span>(</span><span>value</span> <span>+</span> <span>byHowMuch</span><span>,</span> <span>300</span><span>,</span> <span>maxValue</span><span>)</span> <span>|</span> <span>0</span><span>;</span>
  <span>if</span> <span>(</span><span>value</span> <span>!==</span> <span>trim</span><span>.</span><span>roll</span><span>)</span> <span>{</span>
    <span>trim</span><span>.</span><span>roll</span> <span>=</span> <span>value</span><span>;</span>
    <span>const</span> <span>prefix</span> <span>=</span> <span>byHowMuch</span> <span>&gt;</span> <span>0</span> <span>?</span> <span>`In`</span> <span>:</span> <span>`De`</span><span>;</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`</span><span>${</span><span>prefix</span><span>}</span><span>creased aileronMaxStick to </span><span>${</span><span>value</span><span>}</span><span>`</span><span>);</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>That should hopefully do it, so… did it?</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203184436143.png" alt="image-20240203184436143"></p>

<p>Looks like it. Of course, that does mean we now need to also retest the Pitts Special S-1S, since that’s also has its <code>isAcrobatic</code> flight model flag set…</p>

<h3 id="pitts-special-s-1s-take-2">Pitts Special S-1S, take 2</h3>

<p><img src="https://pomax.github.io/are-we-flying/image-20240203195206604.png" alt="image-20240203195206604"></p>

<p>Looks like we’re still good.</p>

<h2 id="but-can-we-fly-upside-down">…But can we fly upside-down?</h2>

<p>Think about it. They’re acrobatic planes. They fly upside down at airshows all the time. Can we just… make them do that? On autopilot?? Obviously, step one is to just yank the throttle hard left or right a few times to get our plane in an inverted orientation and seeing what happens:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240204082034304.png" alt="image-20240204082034304"></p>

<p>What happens is that things work… but only ever so briefly.</p>

<p>Despite being a stunt plane, the forces acting on it really want to push it back into a “wheels down” orientation, so we’re going to have to write a bit more code that prevents the plane from righting itself, based on how much we’re tipping over. Our ideal bank angle when going straight is zero (we know it’s almost never <em>actually</em> zero, but we’re tweaking an upside-down autopilot at this point, so let’s just go with the simplest approach), and we don’t want the plane to bank any more than 30 degrees on either side of that, no matter how steep a turn we need to make. And, of course, our altitude hold doesn’t understand “upside down” so it’ll trim us into the ground.</p>

<p>So let’s sort this all out, starting with adding an <code>upsideDown</code> flag to our flight information:</p>

<div><pre><code><span>...</span>

<span>export</span> <span>class</span> <span>FlightInformation</span> <span>{</span>
  <span>...</span>

  <span>// And our "update the current flight information" code:</span>
  <span>async</span> <span>updateFlight</span><span>()</span> <span>{</span>
    <span>...</span>

    <span>// Are we upside down?</span>
    <span>data</span><span>.</span><span>upsideDown</span> <span>=</span> <span>abs</span><span>(</span><span>data</span><span>.</span><span>bank</span><span>)</span> <span>&gt;</span> <span>90</span><span>;</span>

    <span>// Did we flip orientations between now an the previous iteration?</span>
    <span>data</span><span>.</span><span>flipped</span> <span>=</span> <span>this</span><span>.</span><span>data</span><span>.</span><span>upsideDown</span> <span>!==</span> <span>data</span><span>.</span><span>upsideDown</span><span>;</span>

    <span>this</span><span>.</span><span>setGeneralProperties</span><span>(</span><span>data</span><span>);</span>
    <span>return</span> <span>(</span><span>this</span><span>.</span><span>data</span> <span>=</span> <span>data</span><span>);</span>
  <span>}</span>

  <span>...</span>
<span>}</span>
</code></pre></div>

<p>And now the rest of our code can hook into that flag to do the right thing when we’re flying inverted, like our <code>altitude-hold.js</code>:</p>

<div><pre><code><span>...</span>

<span>export</span> <span>async</span> <span>function</span> <span>altitudeHold</span><span>(</span><span>autopilot</span><span>,</span> <span>flightInformation</span><span>)</span> <span>{</span>
  <span>const</span> <span>{</span> <span>api</span><span>,</span> <span>trim</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>
  <span>const</span> <span>{</span> <span>data</span><span>:</span> <span>flightData</span><span>,</span> <span>model</span><span>:</span> <span>flightModel</span> <span>}</span> <span>=</span> <span>flightInformation</span><span>;</span>

  <span>// get the upsideDown flag:</span>
  <span>const</span> <span>{</span> <span>VS</span><span>,</span> <span>alt</span><span>,</span> <span>pitch</span><span>,</span> <span>speed</span><span>,</span> <span>bank</span><span>,</span> <span>upsideDown</span> <span>}</span> <span>=</span> <span>flightData</span><span>;</span>

  <span>...</span>

  <span>// And then set our trim step, but invert it if we're flying upside</span>
  <span>// down, and double it because we'll need to more aggressively trim</span>
  <span>// while the plane is upside-down.</span>
  <span>let</span> <span>trimStep</span> <span>=</span> <span>trimLimit</span> <span>/</span> <span>10</span><span>_000</span><span>;</span>
  <span>if</span> <span>(</span><span>upsideDown</span><span>)</span> <span>trimStep</span> <span>=</span> <span>-</span><span>2</span> <span>*</span> <span>trimStep</span><span>;</span>

  <span>...</span>
<span>}</span>
</code></pre></div>

<p>And, of course, our <code>fly-level.js</code>:</p>

<div><pre><code><span>...</span>

<span>export</span> <span>async</span> <span>function</span> <span>flyLevel</span><span>(</span><span>autopilot</span><span>,</span> <span>state</span><span>)</span> <span>{</span>
  <span>...</span>

  <span>// Get our flag:</span>
  <span>const</span> <span>{</span> <span>bank</span><span>,</span> <span>turnRate</span><span>,</span> <span>upsideDown</span> <span>}</span> <span>=</span> <span>flightData</span><span>;</span>

  <span>// And allocate an offset for our aileron position:</span>
  <span>let</span> <span>offset</span> <span>=</span> <span>0</span><span>;</span>

  <span>...</span>

  <span>// Then, are we flying upside down? If so, we're going to counteract</span>
  <span>// physics by adding an offset to our stick adjustments, so that we</span>
  <span>// can "catch" the plane trying to roll out of inverted orientation.</span>
  <span>if</span> <span>(</span><span>upsideDown</span><span>)</span> <span>{</span>
    <span>// How much are we currently deviating from 180?</span>
    <span>const</span> <span>tipAngle</span> <span>=</span> <span>bank</span> <span>&lt;</span> <span>0</span> <span>?</span> <span>bank</span> <span>+</span> <span>180</span> <span>:</span> <span>bank</span> <span>-</span> <span>180</span><span>;</span>
    <span>const</span> <span>aTipAngle</span> <span>=</span> <span>abs</span><span>(</span><span>tipAngle</span><span>);</span>

    <span>// If we're tipping too much, reduce our max stick</span>
    <span>// because we were clearly giving it too much:</span>
    <span>if</span> <span>(</span><span>aTipAngle</span> <span>&gt;</span> <span>30</span><span>)</span> <span>updateMaxDeflection</span><span>(</span><span>trim</span><span>,</span> <span>-</span><span>50</span><span>,</span> <span>isTwitchy</span><span>);</span>

    <span>// Then determine how much offset on the stick we need in order to</span>
    <span>// prevent us from "rolling out of inversion", based on heading:</span>
    <span>// if we're flying straight along our flightpath, we don't want</span>
    <span>// our bank to be more than 1 degree off center, and if we're in</span>
    <span>// a turn, we can be out by up to 30 degrees:</span>
    <span>const</span> <span>s</span> <span>=</span> <span>sign</span><span>(</span><span>bank</span><span>);</span>
    <span>const</span> <span>maxBankAngle</span> <span>=</span> <span>s</span> <span>*</span> <span>constrainMap</span><span>(</span><span>aHeadingDiff</span><span>,</span> <span>0</span><span>,</span> <span>10</span><span>,</span> <span>179</span><span>,</span> <span>150</span><span>);</span>
    <span>offset</span> <span>+=</span> <span>constrainMap</span><span>(</span><span>bank</span><span>,</span> <span>s</span> <span>*</span> <span>90</span><span>,</span> <span>maxBankAngle</span><span>,</span> <span>s</span> <span>*</span> <span>2</span> <span>**</span> <span>13</span><span>,</span> <span>0</span><span>);</span>

    <span>// Also, because this is *such* an unstable way to fly, we need</span>
    <span>// an additional correction for when we're getting blown off</span>
    <span>// course by even the smallest gust or draft:</span>
    <span>if</span> <span>(</span><span>aHeadingDiff</span> <span>&gt;</span> <span>1</span><span>)</span> <span>{</span>
      <span>offset</span> <span>-=</span> <span>constrainMap</span><span>(</span><span>headingDiff</span><span>,</span> <span>-</span><span>10</span><span>,</span> <span>10</span><span>,</span> <span>-</span><span>500</span><span>,</span> <span>500</span><span>);</span>
    <span>}</span>
  <span>}</span>

  <span>...</span>

  <span>// And then to make things work, we add this offset to our aileron:</span>
  <span>const</span> <span>newAileron</span> <span>=</span> <span>proportion</span> <span>*</span> <span>maxStick</span> <span>+</span> <span>offset</span><span>;</span>
  <span>api</span><span>.</span><span>trigger</span><span>(</span><span>"</span><span>AILERON_SET</span><span>"</span><span>,</span> <span>newAileron</span> <span>|</span> <span>0</span><span>);</span>
<span>}</span>
</code></pre></div>

<p>And with that…</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240204093136389.png" alt="image-20240204093136389"></p>

<p>We can fly our autopilot… upside down! Which, incidentally, is absolutely terrifying viewed from the cockpit.</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240204093540784.png" alt="image-20240204093540784"></p>

<p>And just because “why not”, what does the flight path look like going around Ghost Dog?</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240204095802436.png" alt="image-20240204095802436"></p>

<p>We just flew a tour of South-East Vancouver Island upside down. Need I say more?</p>

<h2 id="part-6-lets-just-have-javascript-fly-the-plane-for-us">Part 6: “Let’s just have JavaScript fly the plane for us”</h2>

<p>So now we get to the part where we’ve implemented an autopilot, and we’ve made planes fly upside down, and we could stop there, <em>or we could keep going</em>. What if we just make JavaScript fly the plane, start to finish? Because in the immortal words of Jeremy Clarkson: how hard could it be?</p>

<p>We’ll tackle this in three parts:</p>

<ol>
  <li>we’ll  be adding a terrain follow mode that ensures the plane’s always at a safe altitude,</li>
  <li>we’ll  be adding auto takeoff, to get us off the run way and into the air, and</li>
  <li>we’ll be adding auto landing, to gets us back to being stopped on a runway.</li>
</ol>

<h2 id="terrain-follow-mode">Terrain follow mode</h2>

<p>Normally, most planes don’t come with a mode that lets them “hug the landscape”, but we’re not flying real planes, we’re flying virtual planes, and hugging the landscape would be pretty sweet to have if we just want to fly around on autopilot and enjoy the view without having to meticulously set altitudes on every waypoint and then fly the route until we crash so we can refine those values. Having a terrain-follow mode would be so much nicer!</p>

<p>Conceptually, there’s nothing particularly hard about terrain follow:</p>

<ol>
  <li>Scan our flight path up to a several nautical miles ahead of us,</li>
  <li>find the highest point along that path,</li>
  <li>set the autopilot altitude to something that lets us safely clear that highest point, and</li>
  <li>keep repeating this check for as long as the autopilot is running the show.</li>
</ol>

<p>The problem is with point (2) in that list: there is nothing baked into MSFS that lets us “query landscape elevation” using SimConnect. The only method it (currently) offers for finding elevations is to create a dummy object, spawn it into the world, then move it across the landscape and ask MSFS what its lat, long, and elevation values are, which is both quite a bit of work, and <em>slow</em>.</p>

<p>However, since the whole selling point of MSFS is that you can fly anywhere on Earth -as in, the actual Earth- we have an alternative: we could also just query some out-of-game resource for elevation data based on GPS coordinates.</p>

<p>Back in the day, Google offered that as a free web API, but they decided that it would be more profitable if they charged (quite a bit of) money for elevation API access back in 2018, so that’s out. There is also https://www.open-elevation.com, which is technically free, but because they’re don’t have Google money, they’re more for incidental work rather than constant polling. If the website is up at all. Which realistically only leaves “writing our own elevation API service”.</p>

<p>I know, I know, this sounds ludicrous, but roll with it: what do we even need?</p>

<ol>
  <li>a server that we can send elevation requests to,</li>
  <li>code that can turn GPS coordinates into elevation values, and</li>
  <li>geo data for the entire planet.</li>
</ol>

<p>Of these three, the first is trivial, the last is surprisingly easy, and really the only actual work we’ll have to do is point 2.</p>

<p><strong><em>“Whoa, hold up. Point 3 is easy?” —you, probably</em></strong></p>

<p>I know, geodata for the entire planet? Where do you even get that? Enter the Japanese Aerospace eXploration Agency, or <a href="https://global.jaxa.jp/">JAXA</a>, and their freely available ALOS (“Advanced Land Observing Satellite”) <a href="https://en.wikipedia.org/wiki/Digital_elevation_model">Digital Surface Model</a> datasets. Specifically, their <a href="https://www.eorc.jaxa.jp/ALOS/en/dataset/aw3d30/aw3d30_e.htm">30 meter dataset</a>, which has elevation data for the entire planet’s land surface at a resolution finer than MSFS uses, and can be downloaded for free after signing up for an (also, free) account and agreeing to their <a href="https://earth.jaxa.jp/en/data/policy">data license</a>.</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240213160714400.png" alt="image-20240213160714400"></p>

<p>There is, however, one downside: an entire planet’s worth of data isn’t a small download: it’s 450GB of on-disk data hosted as 150GB of downloads spread out over a few hundred files. But, on the upside, we know how to program, so scripting the downloads isn’t terribly hard, and a 1TB SSD is cheap these days. So as long as you have an internet plan without a data cap (which, if you game: you probably do) then that’s unlikely to <em>really</em> be a problem.</p>

<p>What <em>won’t</em> be easy is step 2, though: all that ALOS data is in the form of GeoTIFF files, which are TIFF images with <a href="http://geotiff.maptools.org/spec/geotiff6.html">metadata that describes what section of the planet they map to, and which mapping you need to use to go from pixel-coordinate to geo-coordinate</a>. Again, perhaps unexpectedly, it’s not the TIFF part that’s going to be the problem (we can just use the <a href="https://www.npmjs.com/package/tiff">tiff</a> package to load those in), and it’s not the “which section of the planet” part that’s going to be the problem (the data is neatly organized in directories and filenames that indicate which whole-angle GPS bounding box they’re for) it’s finding the pixel in the image that belongs to a <em>specific</em> GPS coordinate that’s going to require some work.</p>

<p>Or, it would, if <a href="https://stackoverflow.com/questions/47951513#75647596">I hadn’t already done that work for us</a>, so let’s dive in: what do we need?</p>

<h3 id="time-for-another-server">Time for another server</h3>

<p>Let’s create a <code>src/elevation/</code> directory, and then define a new little server in <code>src/elevation/alos-server.js</code> that we can use to test the rest of the code we’re about to write. Something that’ll accept a URL like  http://localhost:9000/?points=48.8,-123.8,48.9,-123.9,49,-124 and then spits out the elevation at each of those three coordinates.</p>

<p>We won’t be using this server in our actual autopilot code, but it’ll make developing and testing the elevation code on its own (before we try to integrate it into the autopilot) a lot easier. And that’s always important.</p>

<p>However, let’s not go overboard: no need for a full <a href="https://expressjs.com/">Express.js</a> server, we just need something small that we can query with the browser, so a plain <code>node:http</code> server will do just fine:</p>

<div><pre><code><span>import</span> <span>http</span> <span>from</span> <span>"</span><span>node:http</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>shimResponsePrototype</span> <span>}</span> <span>from</span> <span>"</span><span>./shim-response-prototype.js</span><span>"</span><span>;</span>
<span>shimResponsePrototype</span><span>(</span><span>http</span><span>.</span><span>ServerResponse</span><span>.</span><span>prototype</span><span>);</span>

<span>import</span> <span>dotenv</span> <span>from</span> <span>"</span><span>dotenv</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>ENV_PATH</span> <span>}</span> <span>from</span> <span>"</span><span>../utils/constants.js</span><span>"</span><span>;</span>
<span>dotenv</span><span>.</span><span>config</span><span>({</span> <span>path</span><span>:</span> <span>ENV_PATH</span> <span>});</span>

<span>// Fairly boilerplate http server:</span>
<span>function</span> <span>processRequest</span><span>(</span><span>req</span><span>,</span> <span>res</span><span>)</span> <span>{</span>
  <span>// We only support one URL: the root url.</span>
  <span>const</span> <span>url</span> <span>=</span> <span>new</span> <span>URL</span><span>(</span><span>`http://localhost:</span><span>${</span><span>PORT</span><span>}${</span><span>req</span><span>.</span><span>url</span><span>}</span><span>`</span><span>);</span>
  <span>if</span> <span>(</span><span>url</span><span>.</span><span>pathname</span> <span>!==</span> <span>`/`</span><span>)</span> <span>return</span> <span>res</span><span>.</span><span>fail</span><span>(</span><span>`unsupported endpoint`</span><span>);</span>

  <span>// We'll be accepting GPS coordinates through a query argument:</span>
  <span>const</span> <span>query</span> <span>=</span> <span>new</span> <span>URLSearchParams</span><span>(</span><span>url</span><span>.</span><span>search</span><span>);</span>
  <span>const</span> <span>{</span> <span>points</span> <span>}</span> <span>=</span> <span>Object</span><span>.</span><span>fromEntries</span><span>(</span><span>query</span><span>.</span><span>entries</span><span>());</span>
  <span>if</span> <span>(</span><span>!</span><span>points</span><span>)</span> <span>{</span>
    <span>return</span> <span>res</span><span>.</span><span>fail</span><span>(</span><span>`missing "?points=..." query argument`</span><span>);</span>
  <span>}</span>

  <span>// We need an even number of coordinates...</span>
  <span>const</span> <span>values</span> <span>=</span> <span>(</span><span>points</span><span>).</span><span>split</span><span>(</span><span>`,`</span><span>).</span><span>map</span><span>((</span><span>v</span><span>)</span> <span>=&gt;</span> <span>parseFloat</span><span>(</span><span>v</span><span>));</span>
  <span>if</span> <span>(</span><span>values</span><span>.</span><span>length</span> <span>%</span> <span>2</span> <span>!==</span> <span>0</span><span>)</span> <span>{</span>
    <span>return</span> <span>res</span><span>.</span><span>fail</span><span>(</span><span>`Not an even number values provided.`</span><span>);</span>
  <span>}</span>

  <span>// And it'd be useful if we had those as a list of pairs:</span>
  <span>const</span> <span>coords</span> <span>=</span> <span>[];</span>
  <span>for</span> <span>(</span><span>let</span> <span>i</span> <span>=</span> <span>0</span><span>,</span> <span>e</span> <span>=</span> <span>values</span><span>.</span><span>length</span><span>;</span> <span>i</span> <span>&lt;</span> <span>e</span><span>;</span> <span>i</span> <span>+=</span> <span>2</span><span>)</span> <span>{</span>
    <span>coords</span><span>.</span><span>push</span><span>(</span><span>values</span><span>.</span><span>slice</span><span>(</span><span>i</span><span>,</span> <span>i</span> <span>+</span> <span>2</span><span>));</span>
  <span>}</span>

  <span>// Then, find the elevation associated with each coordinate:</span>
  <span>const</span> <span>start</span> <span>=</span> <span>Date</span><span>.</span><span>now</span><span>();</span>
  <span>const</span> <span>results</span> <span>=</span> <span>{</span>
    <span>results</span><span>:</span> <span>coords</span><span>.</span><span>map</span><span>(([</span><span>lat</span><span>,</span> <span>long</span><span>])</span> <span>=&gt;</span> <span>({</span>
      <span>lat</span><span>,</span>
      <span>long</span><span>,</span>
      <span>elevation</span><span>:</span> <span>123</span>
    <span>})),</span>
  <span>};</span>
  <span>results</span><span>.</span><span>ms</span> <span>=</span> <span>Date</span><span>.</span><span>now</span><span>()</span> <span>-</span> <span>start</span><span>;</span>
  <span>return</span> <span>res</span><span>.</span><span>json</span><span>(</span><span>results</span><span>);</span>
<span>}</span>

<span>http</span><span>.</span><span>createServer</span><span>(</span><span>processRequest</span><span>).</span><span>listen</span><span>(</span><span>PORT</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
  <span>console</span><span>.</span><span>log</span><span>(</span><span>`Elevation server listening on http://localhost:</span><span>${</span><span>PORT</span><span>}</span><span>`</span><span>);</span>
<span>});</span>
</code></pre></div>

<p>As long as we don’t forget to add that new <code>ALOS_PORT</code> value to our <code>.env</code> file (I’m using <code>ALOS_PORT=9000</code> but obviously pick whichever port you like best) this should start up and log <code>Elevation server listening on http://localhost:9000</code>, so that calling the earlier URL http://localhost:9000/?points=48.8,-123.8,48.9,-123.9,49,-124 will give us a JSON object with an elevation value of <code>123</code> for each of those three coordinates:</p>

<div><pre><code><span>{</span><span>
  </span><span>"results"</span><span>:</span><span> </span><span>[</span><span>
    </span><span>{</span><span>
      </span><span>"lat"</span><span>:</span><span>48.8</span><span>,</span><span>
      </span><span>"long"</span><span>:</span><span>-123.8</span><span>,</span><span>
      </span><span>"elevation"</span><span>:</span><span>123</span><span>
    </span><span>},</span><span>
    </span><span>{</span><span>
      </span><span>"lat"</span><span>:</span><span>48.9</span><span>,</span><span>
      </span><span>"long"</span><span>:</span><span>-123.9</span><span>,</span><span>
      </span><span>"elevation"</span><span>:</span><span>123</span><span>
    </span><span>},</span><span>
    </span><span>{</span><span>
      </span><span>"lat"</span><span>:</span><span>49</span><span>,</span><span>
      </span><span>"long"</span><span>:</span><span>-124</span><span>,</span><span>
      </span><span>"elevation"</span><span>:</span><span>123</span><span>
    </span><span>}</span><span>
  </span><span>],</span><span>
  </span><span>"ms"</span><span>:</span><span>0</span><span>
</span><span>}</span><span>
</span></code></pre></div>

<p>Of course there’s a sneaky little helper file that we also need to make, <code>shim-response-prototype.js</code>, which is just a bit of code that turns Node’s response object into something a little bit more usable (and a little more into an Express.js response object):</p>

<div><pre><code><span>export</span> <span>function</span> <span>shimResponsePrototype</span><span>(</span><span>responsePrototype</span><span>)</span> <span>{</span>
  <span>// there's a bunch of default headers we want, as part of</span>
  <span>// setting whether this is a 200, 400, 404, etc.</span>
  <span>responsePrototype</span><span>.</span><span>status</span> <span>=</span> <span>function</span> <span>(</span><span>statusNumber</span><span>,</span> <span>type</span> <span>=</span> <span>`text/plain`</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>writeHead</span><span>(</span><span>statusNumber</span><span>,</span> <span>{</span>
      <span>"</span><span>Content-Type</span><span>"</span><span>:</span> <span>type</span><span>,</span>
      <span>"</span><span>Cache-Control</span><span>"</span><span>:</span> <span>`no-store`</span><span>,</span>
      <span>"</span><span>Access-Control-Allow-Origin</span><span>"</span><span>:</span> <span>`*`</span><span>,</span>
    <span>});</span>
    <span>return</span> <span>this</span><span>;</span>
  <span>};</span>

  <span>// we don't want to call write(), and then end(), separately, all the time.</span>
  <span>responsePrototype</span><span>.</span><span>send</span> <span>=</span> <span>function</span> <span>(</span><span>data</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>write</span><span>(</span><span>data</span><span>);</span>
    <span>this</span><span>.</span><span>end</span><span>();</span>
  <span>};</span>

  <span>// "just reply with some text"</span>
  <span>responsePrototype</span><span>.</span><span>text</span> <span>=</span> <span>function</span> <span>(</span><span>textData</span><span>,</span> <span>status</span> <span>=</span> <span>200</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>status</span><span>(</span><span>status</span><span>).</span><span>send</span><span>(</span><span>textData</span><span>);</span>
  <span>};</span>

  <span>// "just reply with some json"</span>
  <span>responsePrototype</span><span>.</span><span>json</span> <span>=</span> <span>function</span> <span>(</span><span>jsData</span><span>,</span> <span>status</span> <span>=</span> <span>200</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>status</span><span>(</span><span>status</span><span>,</span> <span>`application/json`</span><span>).</span><span>send</span><span>(</span><span>JSON</span><span>.</span><span>stringify</span><span>(</span><span>jsData</span><span>));</span>
  <span>};</span>

  <span>// "send a failure response"</span>
  <span>responsePrototype</span><span>.</span><span>fail</span> <span>=</span> <span>function</span> <span>(</span><span>reason</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>text</span><span>(</span><span>reason</span><span>,</span> <span>400</span><span>);</span>
  <span>};</span>
<span>}</span>
</code></pre></div>

<p>Of course, on its own this server isn’t super useful yet, so let’s write the code we need to actually work with our ALOS data.</p>

<h3 id="working-with-alos-data">Working with ALOS data</h3>

<p>We’re going to split our ALOS code up into three parts: a general querying object, a tile class that maps to individual GeoTIFF files, and a really simple caching system.</p>

<p>First, some ALOS constants that we’ll put in <code>src/elevation/alos-constants.js</code>:</p>

<div><pre><code><span>import</span> <span>{</span> <span>join</span><span>,</span> <span>resolve</span> <span>}</span> <span>from</span> <span>"</span><span>node:path</span><span>"</span><span>;</span>
<span>const</span> <span>__dirname</span> <span>=</span> <span>import</span><span>.</span><span>meta</span><span>.</span><span>dirname</span><span>;</span>

<span>export</span> <span>const</span> <span>SEA_LEVEL</span> <span>=</span> <span>0</span><span>;</span>
<span>export</span> <span>const</span> <span>ALOS_VOID_VALUE</span> <span>=</span> <span>-</span><span>9999</span><span>;</span>
<span>export</span> <span>const</span> <span>NO_ALOS_DATA_VALUE</span> <span>=</span> <span>9999</span><span>;</span>
<span>export</span> <span>const</span> <span>INDEX_FILE</span> <span>=</span> <span>resolve</span><span>(</span><span>join</span><span>(</span><span>__dirname</span><span>,</span> <span>`alos-index.json`</span><span>));</span>
<span>export</span> <span>const</span> <span>CACHE_DIR</span> <span>=</span> <span>resolve</span><span>(</span><span>join</span><span>(</span><span>__dirname</span><span>,</span> <span>`cache`</span><span>));</span>
</code></pre></div>

<p>Then, our querying object, which we’ll put in <code>src/elevation/alos-interface.js</code>:</p>

<div><pre><code><span>import</span> <span>{</span> <span>getDistanceBetweenPoints</span> <span>}</span> <span>from</span> <span>"</span><span>../utils/utils.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>SEA_LEVEL</span><span>,</span> <span>ALOS_VOID_VALUE</span><span>,</span> <span>NO_ALOS_DATA_VALUE</span><span>,</span> <span>INDEX_FILE</span><span>,</span> <span>CACHE_DIR</span> <span>}</span> <span>from</span> <span>"</span><span>./alos-constants.js</span><span>"</span><span>;</span>
<span>const</span> <span>{</span> <span>floor</span><span>,</span> <span>ceil</span><span>,</span> <span>max</span> <span>}</span> <span>=</span> <span>Math</span><span>;</span>

<span>// We'll look at implementing this after we flesh out our ALOS interface</span>
<span>import</span> <span>{</span> <span>ALOSTile</span> <span>}</span> <span>from</span> <span>"</span><span>./alos-tile.js</span><span>"</span><span>;</span>

<span>/**
 * JAXA ALOS World 3D (30m) dataset manager
 *
 * Homepage: https://www.eorc.jaxa.jp/ALOS/en/dataset/aw3d30/aw3d30_e.htm
 * Data format: https://www.eorc.jaxa.jp/ALOS/en/aw3d30/aw3d30v11_format_e.pdf
 * Data license: https://earth.jaxa.jp/en/data/policy/
 */</span>
<span>export</span> <span>class</span> <span>ALOSInterface</span> <span>{</span>
  <span>constructor</span><span>(</span><span>tilesFolder</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>loaded</span> <span>=</span> <span>false</span><span>;</span>
    <span>this</span><span>.</span><span>files</span> <span>=</span> <span>[];</span>
    <span>this</span><span>.</span><span>tilesFolder</span> <span>=</span> <span>tilesFolder</span><span>;</span>
    <span>if</span> <span>(</span><span>!</span><span>this</span><span>.</span><span>tilesFolder</span><span>)</span> <span>{</span>
      <span>console</span><span>.</span><span>log</span><span>(</span>
        <span>`No ALOS data folder specified, elevation service will not be available.`</span>
      <span>);</span>
    <span>}</span> <span>else</span> <span>{</span>
      <span>this</span><span>.</span><span>loadIndex</span><span>();</span>
      <span>this</span><span>.</span><span>loaded</span> <span>=</span> <span>true</span><span>;</span>
      <span>console</span><span>.</span><span>log</span><span>(</span><span>`ALOS loaded, using </span><span>${</span><span>this</span><span>.</span><span>files</span><span>.</span><span>length</span><span>}</span><span> tiles.`</span><span>);</span>
    <span>}</span>
  <span>}</span>

	<span>/**
   * We don't want to hold up our elevation server to index a directory
   * containing some twenty three thousand files, so we'll build an index
   * instead, and load that when it exists.
   */</span>
  <span>loadIndex</span><span>()</span> <span>{</span>
    <span>// Build our index if it doesn't exist:</span>
    <span>if</span> <span>(</span><span>!</span><span>existsSync</span><span>(</span><span>INDEX_FILE</span><span>))</span> <span>{</span>
      <span>console</span><span>.</span><span>log</span><span>(</span><span>`Indexing dataset...`</span><span>);</span>
      <span>const</span> <span>mark</span> <span>=</span> <span>Date</span><span>.</span><span>now</span><span>();</span>
      <span>this</span><span>.</span><span>findFiles</span><span>();</span>
      <span>const</span> <span>fileCount</span> <span>=</span> <span>this</span><span>.</span><span>files</span><span>.</span><span>length</span><span>;</span>
      <span>const</span> <span>json</span> <span>=</span> <span>JSON</span><span>.</span><span>stringify</span><span>(</span><span>this</span><span>.</span><span>files</span><span>.</span><span>map</span><span>((</span><span>v</span><span>)</span> <span>=&gt;</span> <span>v</span><span>.</span><span>replace</span><span>(</span><span>this</span><span>.</span><span>tilesFolder</span><span>,</span> <span>``</span><span>)));</span>
      <span>writeFileSync</span><span>(</span><span>INDEX_FILE</span><span>,</span> <span>json</span><span>);</span>
      <span>console</span><span>.</span><span>log</span><span>(</span><span>`Dataset indexed in </span><span>${((</span><span>Date</span><span>.</span><span>now</span><span>()</span> <span>-</span> <span>mark</span><span>)</span> <span>/</span> <span>1000</span><span>).</span><span>toFixed</span><span>(</span><span>2</span><span>)}</span><span>s (</span><span>${</span><span>fileCount</span><span>}</span><span> tiles found)`</span><span>);</span>
    <span>}</span>
    <span>// Or, if it does, load in the index instead of trawling the file system:</span>
    <span>else</span> <span>{</span>
	    <span>this</span><span>.</span><span>files</span> <span>=</span> <span>JSON</span><span>.</span><span>parse</span><span>(</span><span>readFileSync</span><span>(</span><span>INDEX_FILE</span><span>)).</span><span>map</span><span>((</span><span>v</span><span>)</span> <span>=&gt;</span> <span>v</span><span>.</span><span>split</span><span>(</span><span>win32</span><span>.</span><span>sep</span><span>).</span><span>join</span><span>(</span><span>sep</span><span>));</span>
    <span>}</span>
  <span>}</span>

  <span>/**
   * In order to build our index, we recursively read the
   * data directory in order to find all filenames.
   */</span>
  <span>findFiles</span><span>(</span><span>dir</span> <span>=</span> <span>this</span><span>.</span><span>tilesFolder</span><span>)</span> <span>{</span>
    <span>readdirSync</span><span>(</span><span>dir</span><span>,</span> <span>{</span> <span>withFileTypes</span><span>:</span> <span>true</span> <span>}).</span><span>forEach</span><span>((</span><span>entry</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>const</span> <span>fullPath</span> <span>=</span> <span>join</span><span>(</span><span>dir</span><span>,</span> <span>entry</span><span>.</span><span>name</span><span>);</span>
      <span>if</span> <span>(</span><span>entry</span><span>.</span><span>isFile</span><span>()</span> <span>&amp;&amp;</span> <span>fullPath</span><span>.</span><span>endsWith</span><span>(</span><span>"</span><span>.tif</span><span>"</span><span>))</span>
        <span>this</span><span>.</span><span>files</span><span>.</span><span>push</span><span>(</span><span>fullPath</span><span>);</span>
      <span>if</span> <span>(</span><span>entry</span><span>.</span><span>isDirectory</span><span>())</span> <span>this</span><span>.</span><span>findFiles</span><span>(</span><span>fullPath</span><span>);</span>
    <span>});</span>
  <span>}</span>

  <span>/**
   * Then, the function we care about the most:
   */</span>
  <span>lookup</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>!</span><span>this</span><span>.</span><span>loaded</span><span>)</span> <span>return</span> <span>NO_ALOS_DATA_VALUE</span><span>;</span>
    <span>const</span> <span>tile</span> <span>=</span> <span>this</span><span>.</span><span>getTileFor</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>);</span>
    <span>if</span> <span>(</span><span>!</span><span>tile</span><span>)</span> <span>console</span><span>.</span><span>warn</span><span>(</span><span>`no tile for </span><span>${</span><span>lat</span><span>}</span><span>,</span><span>${</span><span>long</span><span>}</span><span>...`</span><span>);</span>
    <span>const</span> <span>elevation</span> <span>=</span> <span>tile</span><span>?.</span><span>lookup</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>)</span> <span>??</span> <span>ALOS_VOID_VALUE</span><span>;</span>
    <span>return</span> <span>elevation</span><span>;</span>
  <span>}</span>

  <span>/**
   * Which requires a way to get a tile (which is a 1 degree
   * by 1 degree "rectangle" on the map).
   */</span>
  <span>getTileFor</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>loaded</span><span>,</span> <span>tileFolder</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>if</span> <span>(</span><span>!</span><span>loaded</span><span>)</span> <span>return</span><span>;</span>
    <span>const</span> <span>[</span><span>tileName</span><span>,</span> <span>tilePath</span><span>]</span> <span>=</span> <span>this</span><span>.</span><span>getTileFromFolder</span><span>(</span><span>tilesFolder</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>);</span>
    <span>if</span> <span>(</span><span>!</span><span>tileName</span><span>)</span> <span>return</span><span>;</span>
    <span>return</span> <span>new</span> <span>ALOSTile</span><span>(</span><span>tilePath</span><span>);</span>
  <span>}</span>

  <span>/**
   * Which in turn requires knowing which file we need to
   * work with.
   *
   * ALOS tiles have [0,0] mapped to the upper-left, and
   * (3600,3600) to the lower right, but have a name based
   * on the lower-left corner, so a tile with name N048W124
   * covers the range N48-N49 and W124-W123 with:
   *
   *   [0,0] mapping to 49,-124, and
   *   [3599,3599] mapping to 49-1+1/3600, -124+1-1/3600.
   *
   * Similarly, a tile with name S038E174 covers the range
   * S37-S48 and E174-E175 with:
   *
   *   [0,0] mapping to -37,174, and
   *   [3599,3599] mapping to -37-1+1/3600, 174+1-1/3600.
   *
   * ALOS tiles are named ALPSMKC30_UyyyVxxx_DSM.tif, where
   * U is either "N" or "S", yyy is the degree of latitude
   * (with leading zeroes if necessary), and V is either "E"
   * or "W", with xxx being the degree of longitude (again,
   * with leading zeroes if necessary).
   */</span>
  <span>getTileFromFolder</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>)</span> <span>{</span>
    <span>// given the rules above, an integer latitude</span>
    <span>// can be found in the tile south of it:</span>
    <span>if</span> <span>((</span><span>lat</span> <span>|</span> <span>0</span><span>)</span> <span>===</span> <span>lat</span><span>)</span> <span>lat</span> <span>-=</span> <span>1</span><span>;</span>

    <span>// and an integer longitude can be found in</span>
    <span>// the tile east of it:</span>
    <span>if</span> <span>((</span><span>long</span> <span>|</span> <span>0</span><span>)</span> <span>===</span> <span>long</span><span>)</span> <span>long</span> <span>+=</span> <span>1</span><span>;</span>

    <span>// Form the latitude portions of our path:</span>
    <span>const</span> <span>latDir</span> <span>=</span> <span>lat</span> <span>&gt;=</span> <span>0</span> <span>?</span> <span>"</span><span>N</span><span>"</span> <span>:</span> <span>"</span><span>S</span><span>"</span><span>;</span>
    <span>let</span> <span>latStr</span> <span>=</span> <span>``</span> <span>+</span> <span>(</span><span>latDir</span> <span>==</span> <span>"</span><span>N</span><span>"</span> <span>?</span> <span>floor</span><span>(</span><span>lat</span><span>)</span> <span>:</span> <span>ceil</span><span>(</span><span>-</span><span>lat</span><span>));</span>
    <span>latStr</span> <span>=</span> <span>latStr</span><span>.</span><span>padStart</span><span>(</span><span>3</span><span>,</span> <span>"</span><span>0</span><span>"</span><span>);</span>

    <span>// Form the longitude portions of our path:</span>
    <span>const</span> <span>longDir</span> <span>=</span> <span>long</span> <span>&gt;=</span> <span>0</span> <span>?</span> <span>"</span><span>E</span><span>"</span> <span>:</span> <span>"</span><span>W</span><span>"</span><span>;</span>
    <span>let</span> <span>longStr</span> <span>=</span> <span>``</span> <span>+</span> <span>(</span><span>longDir</span> <span>==</span> <span>"</span><span>E</span><span>"</span> <span>?</span> <span>floor</span><span>(</span><span>long</span><span>)</span> <span>:</span> <span>ceil</span><span>(</span><span>-</span><span>long</span><span>));</span>
    <span>longStr</span> <span>=</span> <span>longStr</span><span>.</span><span>padStart</span><span>(</span><span>3</span><span>,</span> <span>"</span><span>0</span><span>"</span><span>);</span>

    <span>// Then assemble them into an ALOS path fragment:</span>
    <span>const</span> <span>tileName</span> <span>=</span> <span>`ALPSMLC30_</span><span>${</span><span>latDir</span><span>}${</span><span>latStr</span><span>}${</span><span>longDir</span><span>}${</span><span>longStr</span><span>}</span><span>_DSM.tif`</span><span>;</span>

    <span>// And finally, find the fully qualified file path</span>
    <span>// given that fragment, by looking at our filename index:</span>
    <span>const</span> <span>fullPath</span> <span>=</span> <span>this</span><span>.</span><span>files</span><span>.</span><span>find</span><span>((</span><span>f</span><span>)</span> <span>=&gt;</span> <span>f</span><span>.</span><span>endsWith</span><span>(</span><span>tileName</span><span>));</span>
    <span>if</span> <span>(</span><span>!</span><span>fullPath</span><span>)</span> <span>return</span> <span>[</span><span>false</span><span>,</span> <span>false</span><span>];</span>
    <span>return</span> <span>[</span><span>tileName</span><span>,</span> <span>join</span><span>(</span><span>this</span><span>.</span><span>tilesFolder</span><span>,</span> <span>fullPath</span><span>)];</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<h4 id="updating-our-server">Updating our server</h4>

<p>And now that we have an interface to work with, let’s replace our <code>123</code> response with an <em>actual</em> response in our server:</p>

<div><pre><code><span>...</span>

<span>// New variable: DATA_FOLDER points to the root directory for all our ALOS data.</span>
<span>const</span> <span>{</span> <span>DATA_FOLDER</span><span>,</span> <span>ALOS_PORT</span><span>:</span> <span>PORT</span> <span>}</span> <span>=</span> <span>process</span><span>.</span><span>env</span><span>;</span>
<span>import</span> <span>{</span> <span>ALOSInterface</span> <span>}</span> <span>from</span> <span>"</span><span>./alos-interface.js</span><span>"</span><span>;</span>
<span>const</span> <span>ALOS</span> <span>=</span> <span>new</span> <span>ALOSInterface</span><span>(</span><span>DATA_FOLDER</span><span>);</span>

<span>...</span>

<span>function</span> <span>processRequest</span><span>(</span><span>req</span><span>,</span> <span>res</span><span>)</span> <span>{</span>
  <span>...</span>
  <span>const</span> <span>start</span> <span>=</span> <span>Date</span><span>.</span><span>now</span><span>();</span>
  <span>const</span> <span>results</span> <span>=</span> <span>{</span>
    <span>results</span><span>:</span> <span>coords</span><span>.</span><span>map</span><span>(([</span><span>lat</span><span>,</span> <span>long</span><span>])</span> <span>=&gt;</span> <span>({</span>
      <span>lat</span><span>,</span>
      <span>long</span><span>,</span>
      <span>elevation</span><span>:</span> <span>alos</span><span>.</span><span>lookup</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>),</span>
    <span>})),</span>
  <span>};</span>
  <span>results</span><span>.</span><span>ms</span> <span>=</span> <span>Date</span><span>.</span><span>now</span><span>()</span> <span>-</span> <span>start</span><span>;</span>
  <span>return</span> <span>res</span><span>.</span><span>json</span><span>(</span><span>results</span><span>);</span>
<span>}</span>
</code></pre></div>

<p>Neato! Of course, this still won’t do anything yet, because we haven’t written the code that works with tiles yet, so…</p>

<h3 id="working-with-individual-geo-tiles">Working with individual Geo tiles</h3>

<p>Back to the ALOS data: we still need something that turns “tiff images” into objects that we can work with, so let’s write a <code>src/elevation/alos-tile.js</code> for that.</p>

<div><pre><code><span>// A pretty important import if want to work with tiff images:</span>
<span>import</span> <span>tiff</span> <span>from</span> <span>"</span><span>tiff</span><span>"</span><span>;</span>

<span>import</span> <span>{</span> <span>readFileSync</span> <span>}</span> <span>from</span> <span>"</span><span>node:fs</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>ALOS_VOID_VALUE</span><span>,</span> <span>NO_ALOS_DATA_VALUE</span> <span>}</span> <span>from</span> <span>"</span><span>./alos-constants.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>KM_PER_ARC_DEGREE</span> <span>}</span> <span>from</span> <span>"</span><span>../utils/constants.js</span><span>"</span><span>;</span>

<span>const</span> <span>{</span> <span>abs</span><span>,</span> <span>ceil</span><span>,</span> <span>sign</span> <span>}</span> <span>=</span> <span>Math</span><span>;</span>

<span>export</span> <span>class</span> <span>ALOSTile</span> <span>{</span>
  <span>constructor</span><span>(</span><span>tilePath</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>tilePath</span> <span>=</span> <span>tilePath</span><span>;</span>
    <span>this</span><span>.</span><span>load</span><span>(</span><span>tilePath</span><span>);</span>
  <span>}</span>

  <span>/**
   * Load in a GeoTIFF and parse its metadata so we can set
   * up our matrix transforms for geo-to-pixel and pixel-to-geo
   * coordinate conversions.
   *
   * See https://stackoverflow.com/questions/47951513#75647596
   * for the full details on how that all works.
   */</span>
  <span>load</span><span>(</span><span>filename</span><span>)</span> <span>{</span>
    <span>// Unpack the image</span>
    <span>const</span> <span>file</span> <span>=</span> <span>readFileSync</span><span>(</span><span>filename</span><span>);</span>
    <span>const</span> <span>image</span> <span>=</span> <span>tiff</span><span>.</span><span>decode</span><span>(</span><span>file</span><span>.</span><span>buffer</span><span>);</span>
    <span>const</span> <span>{</span> <span>data</span><span>,</span> <span>fields</span><span>,</span> <span>width</span><span>,</span> <span>height</span> <span>}</span> <span>=</span> <span>image</span><span>[</span><span>0</span><span>];</span>
    <span>// Cache the image information</span>
    <span>this</span><span>.</span><span>pixels</span> <span>=</span> <span>data</span><span>;</span>
    <span>this</span><span>.</span><span>width</span> <span>=</span> <span>width</span><span>;</span>
    <span>this</span><span>.</span><span>height</span> <span>=</span> <span>height</span><span>;</span>
    <span>// And then construct the geo transform matrices</span>
    <span>let</span> <span>[</span><span>sx</span><span>,</span> <span>sy</span><span>,</span> <span>_sz</span><span>]</span> <span>=</span> <span>fields</span><span>.</span><span>get</span><span>(</span><span>33550</span><span>);</span>
    <span>let</span> <span>[</span><span>_px</span><span>,</span> <span>_py</span><span>,</span> <span>_k</span><span>,</span> <span>gx</span><span>,</span> <span>gy</span><span>,</span> <span>_gz</span><span>]</span> <span>=</span> <span>fields</span><span>.</span><span>get</span><span>(</span><span>33922</span><span>);</span>
    <span>sy</span> <span>=</span> <span>-</span><span>sy</span><span>;</span>
    <span>this</span><span>.</span><span>forward</span> <span>=</span> <span>[</span><span>gx</span><span>,</span> <span>sx</span><span>,</span> <span>0</span><span>,</span> <span>gy</span><span>,</span> <span>0</span><span>,</span> <span>sy</span><span>];</span>
    <span>this</span><span>.</span><span>reverse</span> <span>=</span> <span>[</span><span>-</span><span>gx</span> <span>/</span> <span>sx</span><span>,</span> <span>1</span> <span>/</span> <span>sx</span><span>,</span> <span>0</span><span>,</span> <span>-</span><span>gy</span> <span>/</span> <span>sy</span><span>,</span> <span>0</span><span>,</span> <span>1</span> <span>/</span> <span>sy</span><span>];</span>
  <span>}</span>

  <span>/**
   * convert a pixel (x,y) coordinate to a [lat, long] value.
   */</span>
  <span>pixelToGeo</span><span>(</span><span>x</span><span>,</span> <span>y</span><span>,</span> <span>F</span> <span>=</span> <span>this</span><span>.</span><span>forward</span><span>)</span> <span>{</span>
    <span>return</span> <span>[</span>
      <span>F</span><span>[</span><span>3</span><span>]</span> <span>+</span> <span>F</span><span>[</span><span>4</span><span>]</span> <span>*</span> <span>x</span> <span>+</span> <span>F</span><span>[</span><span>5</span><span>]</span> <span>*</span> <span>y</span><span>,</span> <span>// lat</span>
      <span>F</span><span>[</span><span>0</span><span>]</span> <span>+</span> <span>F</span><span>[</span><span>1</span><span>]</span> <span>*</span> <span>x</span> <span>+</span> <span>F</span><span>[</span><span>2</span><span>]</span> <span>*</span> <span>y</span><span>,</span> <span>// long</span>
    <span>];</span>
  <span>}</span>

  <span>/**
   * convert a geo (lat,long) coordinate to an [x,y] value.
   */</span>
  <span>geoToPixel</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>R</span> <span>=</span> <span>this</span><span>.</span><span>reverse</span><span>)</span> <span>{</span>
    <span>// We round down so that pixels coordinates are</span>
    <span>// always integers, with (0,0) as "lowest" value.</span>
    <span>return</span> <span>[</span>
      <span>(</span><span>R</span><span>[</span><span>0</span><span>]</span> <span>+</span> <span>R</span><span>[</span><span>1</span><span>]</span> <span>*</span> <span>long</span> <span>+</span> <span>R</span><span>[</span><span>2</span><span>]</span> <span>*</span> <span>lat</span><span>)</span> <span>|</span> <span>0</span><span>,</span> <span>// x</span>
      <span>(</span><span>R</span><span>[</span><span>3</span><span>]</span> <span>+</span> <span>R</span><span>[</span><span>4</span><span>]</span> <span>*</span> <span>long</span> <span>+</span> <span>R</span><span>[</span><span>5</span><span>]</span> <span>*</span> <span>lat</span><span>)</span> <span>|</span> <span>0</span><span>,</span> <span>// y</span>
    <span>];</span>
  <span>}</span>

  <span>/**
   * Find the pixel that maps to a given lat/long coordinate,
   * and return the elevation in meters that it has encoded
   * as a greyscale intensity value at that coordinate.
   *
   * Note: this might not be a real elevation! There may
   * be gaps in the ALOS data, or the coordinate might
   * simply not exist because it's an ocean coordinate.
   */</span>
  <span>lookup</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>)</span> <span>{</span>
    <span>const</span> <span>[</span><span>x</span><span>,</span> <span>y</span><span>]</span> <span>=</span> <span>this</span><span>.</span><span>geoToPixel</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>);</span>
    <span>const</span> <span>pos</span> <span>=</span> <span>x</span> <span>+</span> <span>y</span> <span>*</span> <span>this</span><span>.</span><span>block</span><span>.</span><span>width</span><span>;</span>
    <span>let</span> <span>value</span> <span>=</span> <span>this</span><span>.</span><span>pixels</span><span>[</span><span>pos</span><span>];</span>
    <span>if</span> <span>(</span><span>value</span> <span>===</span> <span>undefined</span> <span>||</span> <span>value</span> <span>&gt;=</span> <span>NO_ALOS_DATA_VALUE</span><span>)</span> <span>{</span>
      <span>value</span> <span>=</span> <span>ALOS_VOID_VALUE</span><span>;</span>
    <span>}</span>
    <span>return</span> <span>value</span><span>;</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And suddenly we have a way to query elevations for GPS coordinates, without having to use some third party online service, or messing around with object spawning in-game! Asking for http://localhost:9000/?points=48.8,-123.8,48.9,-123.9,49,-124 now yields:</p>

<div><pre><code><span>{</span><span>
  </span><span>"results"</span><span>:[</span><span>
    </span><span>{</span><span>
      </span><span>"lat"</span><span>:</span><span>48.8</span><span>,</span><span>
      </span><span>"long"</span><span>:</span><span>-123.8</span><span>,</span><span>
      </span><span>"elevation"</span><span>:</span><span>152</span><span>
    </span><span>},</span><span>
    </span><span>{</span><span>
      </span><span>"lat"</span><span>:</span><span>48.9</span><span>,</span><span>
      </span><span>"long"</span><span>:</span><span>-123.9</span><span>,</span><span>
      </span><span>"elevation"</span><span>:</span><span>840</span><span>
    </span><span>},</span><span>
    </span><span>{</span><span>
      </span><span>"lat"</span><span>:</span><span>49</span><span>,</span><span>
      </span><span>"long"</span><span>:</span><span>-124</span><span>,</span><span>
      </span><span>"elevation"</span><span>:</span><span>330</span><span>
    </span><span>}</span><span>
  </span><span>],</span><span>
  </span><span>"ms"</span><span>:</span><span>93</span><span>
</span><span>}</span><span>
</span></code></pre></div>

<h4 id="optimizing-our-call-time-adding-caching">Optimizing our call time: adding caching</h4>

<p>If we look at the previous result’s <code>ms</code> value, we see that it takes about 100 milliseconds to get a result… that’s pretty long! It might not seem very long, but we don’t want to get “a handful of elevation values”, we’re going to want to get a <em>whole bunch</em> of them and find the highest elevation amongst them, so we Let’s see which part(s) of the code are taking up how much time, <a href="https://github.com/Pomax/js-call-tracer/tree/main">tracing the function calls</a>:</p>

<div><pre><code>╭┈┈
│ —&gt; call: ALOSInterface.lookup([48.8,-123.8])
│ —&gt;   call: ALOSInterface.getTileFor(...)
│ —&gt;     call: ALOSInterface.getTileFromFolder(...)
│ &lt;—     finished ALOSInterface.getTileFromFolder(), return value: ..., runtime: 0ms
│ &lt;—   finished ALOSInterface.getTileFor(), return value: ... runtime: 25ms
│ —&gt;   call: ALOSTile.lookup(...)
│ —&gt;     call: ALOSTile.geoToPixel(...)
│ &lt;—     finished ALOSTile.geoToPixel(), return value: ..., runtime: 0ms
│ &lt;—   finished ALOSTile.lookup(), return value: 152, runtime: 0ms
│ &lt;— finished ALOSInterface.lookup(), return value: 152, runtime: 26ms
╰┈┈
</code></pre></div>

<p>On the first call,  we spend approximately “literally no time” running the actual lookup, and approximately “the entirety of the call runtime” on figuring out the tile name, and loading the associated file into memory. Let’s drill down a little further and split up our <code>getTileFromFolder</code> into separate steps:</p>

<div><pre><code>  <span>...</span>
  <span>getTileFromFolder</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>)</span> <span>{</span>
    <span>const</span> <span>tileName</span> <span>=</span> <span>this</span><span>.</span><span>getTileName</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>);</span>
		<span>return</span> <span>this</span><span>.</span><span>getTilePath</span><span>(</span><span>tileName</span><span>);</span>
  <span>}</span>

  <span>getTileName</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>)</span> <span>{</span>
    <span>if</span> <span>((</span><span>lat</span> <span>|</span> <span>0</span><span>)</span> <span>===</span> <span>lat</span><span>)</span> <span>lat</span> <span>-=</span> <span>1</span><span>;</span>
    <span>if</span> <span>((</span><span>long</span> <span>|</span> <span>0</span><span>)</span> <span>===</span> <span>long</span><span>)</span> <span>long</span> <span>+=</span> <span>1</span><span>;</span>
    <span>...</span>
    <span>return</span> <span>`ALPSMLC30_</span><span>${</span><span>latDir</span><span>}${</span><span>latStr</span><span>}${</span><span>longDir</span><span>}${</span><span>longStr</span><span>}</span><span>_DSM.tif`</span><span>;</span>
  <span>}</span>

  <span>getTilePath</span><span>(</span><span>tileName</span><span>)</span> <span>{</span>
    <span>const</span> <span>fullPath</span> <span>=</span> <span>this</span><span>.</span><span>files</span><span>.</span><span>find</span><span>((</span><span>f</span><span>)</span> <span>=&gt;</span> <span>f</span><span>.</span><span>endsWith</span><span>(</span><span>tileName</span><span>));</span>
    <span>if</span> <span>(</span><span>!</span><span>fullPath</span><span>)</span> <span>return</span> <span>false</span><span>;</span>
    <span>return</span> <span>join</span><span>(</span><span>this</span><span>.</span><span>tilesFolder</span><span>,</span> <span>fullPath</span><span>);</span>
  <span>}</span>

  <span>...</span>
</code></pre></div>

<p>Let’s run another trace:</p>

<div><pre><code>...
│ —&gt;   call: ALOSInterface.getTileFor(...)
│ —&gt;     call: ALOSInterface.getTileFromFolder(...)
│ —&gt;       call: ALOSInterface.getTileName(...)
│ &lt;—       finished ALOSInterface.getTileName(), return value: ..., runtime: 0ms
│ —&gt;       call: ALOSInterface.getTilePath(...)
│ &lt;—       finished ALOSInterface.getTilePath(), return value: ..., runtime: 0ms
│ &lt;—     finished ALOSInterface.getTileFromFolder(), return value: ..., runtime: 1ms
│ &lt;—   finished ALOSInterface.getTileFor(), return value: ..., runtime: 25ms
...
</code></pre></div>

<p>“why is the runtime 25ms when the inner calls take 0ms?” I imagine you to be asking at this point, and the reason for this is that the tracer can’t trace constructors, it can only work once an object has already been constructed, so there’s a constructor call in there somewhere, and the only candidate for scrutiny is our <code>new ALOSTile(...)</code> call. Let’s add some <code>Date.now() - start</code> logic in that constructor to log how long the various parts take:</p>

<div><pre><code><span>running</span> <span>ALOSTile</span><span>.</span><span>load</span><span>()</span>
  <span>reading</span> <span>file</span> <span>took</span> <span>5</span><span>ms</span>
  <span>decoding</span> <span>tiff</span> <span>took</span> <span>21</span><span>ms</span>
  <span>extracting</span> <span>values</span> <span>took</span> <span>0</span><span>ms</span>
</code></pre></div>

<p>Turns out decoding 25MB tiff files takes a bit, and we do that <em>every time we ask for a coordinate</em>… so how about… we don’t? Let’s add a tile cache to our <code>alos-interface.js</code> so that we only load a tile once, cutting out the file loading and tiff decoding after the first time we need to load a specific tile:</p>

<div><pre><code><span>...</span>

<span>// let's define a fancy new tile cache, and let's make that</span>
<span>// a global cache, so that multiple ALOSInterface instances</span>
<span>// all share the same cache.</span>
<span>const</span> <span>globalTileCache</span> <span>=</span> <span>[];</span>

<span>export</span> <span>class</span> <span>ALOSInterface</span> <span>{</span>
  <span>...</span>

  <span>/**
   * We update our "get tile" function to build the name
   * and then hand off the actual "getting a tile" work
   * to a new getTileFromCache:
   */</span>
  <span>getTileFor</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>loaded</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>if</span> <span>(</span><span>!</span><span>loaded</span><span>)</span> <span>return</span><span>;</span>
    <span>const</span> <span>tileName</span> <span>=</span> <span>this</span><span>.</span><span>getTileName</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>);</span>
    <span>return</span> <span>this</span><span>.</span><span>getTileFromCache</span><span>(</span><span>tileName</span><span>);</span>
  <span>}</span>

  <span>/**
   * If there is no cached entry, build it. Otherwise
   * just immediately return that cached value:
   */</span>
	<span>getTileFromCache</span><span>(</span><span>tileName</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>globalTileCache</span><span>[</span><span>tileName</span><span>]</span> <span>===</span> <span>undefined</span><span>)</span> <span>{</span>
      <span>globalTileCache</span><span>[</span><span>tileName</span><span>]</span> <span>=</span> <span>false</span><span>;</span>
      <span>const</span> <span>tilePath</span> <span>=</span> <span>this</span><span>.</span><span>getTilePath</span><span>(</span><span>tileName</span><span>);</span>
      <span>if</span> <span>(</span><span>tilePath</span><span>)</span> <span>{</span>
        <span>globalTileCache</span><span>[</span><span>tileName</span><span>]</span> <span>=</span> <span>new</span> <span>ALOSTile</span><span>(</span><span>tilePath</span><span>);</span>
      <span>}</span>
    <span>}</span>
    <span>return</span> <span>globalTileCache</span><span>[</span><span>tileName</span><span>];</span>
  <span>}</span>

  <span>...</span>
<span>}</span>
</code></pre></div>

<p>Just a few lines of code, but look at the improvement that bought us:</p>

<div><pre><code>╭┈┈
│ —&gt; call: ALOSInterface.lookup([48.8,-123.8])
│ —&gt;   call: ALOSInterface.getTileFor(...)
│ —&gt;     call: ALOSInterface.getTileName(...)
│ &lt;—     finished ALOSInterface.getTileName(), return value: ..., runtime: 0ms
│ —&gt;     call: ALOSInterface.getTileFromCache(["ALPSMLC30_N048W124_DSM.tif"])
│ —&gt;       call: ALOSInterface.getTilePath(["ALPSMLC30_N048W124_DSM.tif"])
│ &lt;—       finished ALOSInterface.getTilePath(), return value: ..., runtime: 0ms
running ALOSTile.load()
reading file took 4ms
decoding tiff took 27ms
extracting values took 0ms
│ &lt;—     finished ALOSInterface.getTileFromCache(), return value: ALOSTile:{...}, runtime: 33ms
│ &lt;—   finished ALOSInterface.getTileFor(), return value: ALOSTile:{...}, runtime: 34ms
│ &lt;— finished ALOSInterface.lookup(), return value: 152, runtime: 34ms
╰┈┈

╭┈┈
│ —&gt; call: ALOSInterface.lookup([48.9,-123.9])
│ —&gt;   call: ALOSInterface.getTileFor(...)
│ —&gt;     call: ALOSInterface.getTileName(...)
│ &lt;—     finished ALOSInterface.getTileName(), return value: "ALPSMLC30_N048W124_DSM.tif", runtime: 0ms
│ —&gt;     call: ALOSInterface.getTileFromCache(["ALPSMLC30_N048W124_DSM.tif"])
│ &lt;—     finished ALOSInterface.getTileFromCache(), return value: ALOSTile:{...}, runtime: 0ms
│ &lt;—   finished ALOSInterface.getTileFor(), return value: ALOSTile:{...}, runtime: 1ms
│ &lt;— finished ALOSInterface.lookup(), return value: 840, runtime: 1ms
╰┈┈

╭┈┈
│ —&gt; call: ALOSInterface.lookup([49,-124])
│ —&gt;   call: ALOSInterface.getTileFor(...)
│ —&gt;     call: ALOSInterface.getTileName(...)
│ &lt;—     finished ALOSInterface.getTileName(), return value: "ALPSMLC30_N048W124_DSM.tif", runtime: 0ms
│ —&gt;     call: ALOSInterface.getTileFromCache(["ALPSMLC30_N048W124_DSM.tif"])
│ &lt;—     finished ALOSInterface.getTileFromCache(), return value: ALOSTile:{...}, runtime: 0ms
│ &lt;—   finished ALOSInterface.getTileFor(), return value: ALOSTile:{...}, runtime: 1ms
│ &lt;— finished ALOSInterface.lookup(), return value: 330, runtime: 1ms
╰┈┈
</code></pre></div>

<p>Sure, the initial load takes just as long as before, simply because it has to, but any lookup using a cached tile now takes a millisecond. And sure, we now have a higher memory footprint, but RAM is cheap, and the gains are clearly worth it!</p>

<h3 id="working-with-shapes">Working with shapes</h3>

<p>As mentioned earlier, single point lookups are nice and all, but in order for this to be useful to our autopilot we need to know what the maximum elevation is inside “some shape” rather than “at some point”, which requires writing some more code that can find all pixels within a shape and then turn all of those into a single “highest value”. So:</p>

<ol>
  <li>we’ll want some code that can get the max elevation inside a shape that falls within a single tile,</li>
  <li>then, we’ll want to extend that code so that we can “split up” a shape that covers more than one tile,</li>
  <li>and then we’ll want to combine those two things so that we get a single max elevation value, even if we need to check multiple tiles.</li>
</ol>

<h4 id="adding-polygon-awareness">Adding polygon-awareness</h4>

<p>Let’s make life easy (well, “easier”) on ourselves and restrict the kind of shapes we work with to polygons, with GPS coordinates as vertices, so we can ask our server for something like  http://localhost:9000/?poly=47.8,-123.1,47.8,-123.99,48.99,-123.99,48.99,-123.1 and have it know we mean the “rectangle” (not really, but at small scale, close enough) spanned by N47.8W123.1 and N48.99W123.99.</p>

<p>This requires updating our server a tiny bit:</p>

<div><pre><code><span>...</span>
<span>function</span> <span>processRequest</span><span>(</span><span>req</span><span>,</span> <span>res</span><span>)</span> <span>{</span>
  <span>...</span>

  <span>// Let's add `?poly=...` as allowed query argument:</span>
  <span>const</span> <span>query</span> <span>=</span> <span>new</span> <span>URLSearchParams</span><span>(</span><span>url</span><span>.</span><span>search</span><span>);</span>
  <span>const</span> <span>{</span> <span>points</span><span>,</span> <span>poly</span> <span>}</span> <span>=</span> <span>Object</span><span>.</span><span>fromEntries</span><span>(</span><span>query</span><span>.</span><span>entries</span><span>());</span>
  <span>if</span> <span>(</span><span>!</span><span>points</span> <span>&amp;&amp;</span> <span>!</span><span>poly</span><span>)</span> <span>{</span>
    <span>return</span> <span>res</span><span>.</span><span>fail</span><span>(</span><span>`missing "?points=..." or "?poly=..." query argument`</span><span>);</span>
  <span>}</span>

  <span>...</span>
  <span>// We'll still need an even number of numerical values, of course</span>
  <span>...</span>

  <span>if</span> <span>(</span><span>points</span><span>)</span> <span>{</span>
    <span>// Our original code now goes inside an if-block</span>
  <span>}</span>

  <span>// And we add a second if-block for when we need to get</span>
  <span>// the max elevation inside some polygon:</span>
  <span>if</span> <span>(</span><span>poly</span><span>)</span> <span>{</span>
    <span>const</span> <span>start</span> <span>=</span> <span>Date</span><span>.</span><span>now</span><span>();</span>
    <span>const</span> <span>result</span> <span>=</span> <span>{</span>
      <span>poly</span><span>:</span> <span>coords</span><span>,</span>
      <span>result</span><span>:</span> <span>ALOS</span><span>.</span><span>getMaxElevation</span><span>(</span><span>coords</span><span>),</span>
    <span>};</span>
    <span>result</span><span>.</span><span>ms</span> <span>=</span> <span>Date</span><span>.</span><span>now</span><span>()</span> <span>-</span> <span>start</span><span>;</span>
    <span>return</span> <span>res</span><span>.</span><span>json</span><span>(</span><span>result</span><span>);</span>
  <span>}</span>
<span>}</span>
<span>...</span>
</code></pre></div>

<p>After which we can update our <code>alos-interface.js</code>:</p>

<div><pre><code><span>...</span>

<span>export</span> <span>class</span> <span>ALOSInterface</span> <span>{</span>
  <span>...</span>

  <span>/**
   * We're first going to implement this based on the assumption that
   * all the coordinates are from the same tile. We'll change this later,
   * because that's not actually a guarantee we have, but let's get
   * something working first!
   */</span>
  <span>getMaxElevation</span><span>(</span><span>poly</span><span>)</span> <span>{</span>
    <span>// We can find the tile we need by looking</span>
    <span>// at the first coordinate in our poygon:</span>
    <span>const</span> <span>tile</span> <span>=</span> <span>this</span><span>.</span><span>getTileFor</span><span>(...</span><span>poly</span><span>[</span><span>0</span><span>]);</span>

    <span>// Then we can delegate the task to that tile,</span>
    <span>// bearing in that mind that we might be requesting</span>
    <span>// a tile that doesn't exist, like an ocean location:</span>
    <span>return</span> <span>tile</span><span>?.</span><span>getMaxElevation</span><span>(</span><span>poly</span><span>);</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And then, of course, we need to implement <code>getMaxElevation</code> in our <code>alos-tile.js</code>:</p>

<div><pre><code><span>...</span>

<span>export</span> <span>class</span> <span>ALOSTile</span> <span>{</span>
  <span>...</span>

  <span>/**
   * Find the maximum elevation inside a polygon by converting it
   * from geo-poly to pixel-poly, and then... uh... doing...
   *
   * ...something?
   */</span>
  <span>getMaxElevation</span><span>(</span><span>geoPoly</span><span>)</span> <span>{</span>
    <span>const</span> <span>pixelPoly</span> <span>=</span> <span>geoPoly</span><span>.</span><span>map</span><span>((</span><span>pair</span><span>)</span> <span>=&gt;</span> <span>this</span><span>.</span><span>geoToPixel</span><span>(...</span><span>pair</span><span>));</span>

    <span>// ...what do we even do here?</span>

    <span>return</span> <span>result</span><span>;</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<h4 id="scanlines-and-bresenham">Scanlines and Bresenham</h4>

<p>While we’re trying to find the max elevation, what we’re <em>really</em> trying to do is find the pixel coordinate that has the highest encoded value, which we’re going to have to do by inspecting every pixel that lies within our polygon, and because “reading a pixel value” and “setting a pixel value” are essentially the same thing, what we’re doing is <em>nearly identical</em> to something called <a href="https://en.wikipedia.org/wiki/Flood_fill">flood filling</a> a shape.</p>

<p>There are several ways in which to do this (and I encourage you to read about all of them!) but the one we’ll go with is the “scanline” approach: because our pixels are internally organized as a 1D array, with positions 0 through 3599 being the first row of pixels, positions 3600 through 7199 being the second row of pixels, and so on, we can very quickly “scan through lines” of consecutive pixels, but not so easily skip from one row to the next. So, if we can “chop up” our polygon into a set of scan lines, we can then run through each of those, find the max value, and then the overall max value is simply “the max of all maxes”. In pseudocode:</p>

<pre><code>highest = -Infinity
scanlines = chopUpPolygon(poly)
for each line in scanlines:
  for each pixel value in line:
    if pixel value &gt; highest:
      highest = pixel_value
</code></pre>

<p>Obviously the hard part here is chopping up our polygon into scanlines, but thankfully we’re not sailing through uncharted waters here, this kind of graphics work has some super solid foundations, a famous one of which is <a href="https://en.wikipedia.org/wiki/Bresenham%27s_line_algorithm">Bresenham’s line algorithm</a> for drawing a line between two points using only integer coordinates, which we can actually very easily use to construct our set of scan lines.</p>

<p>Let’s start from the bottom up:</p>

<div><pre><code><span>const</span> <span>{</span> <span>abs</span><span>,</span> <span>sign</span> <span>}</span> <span>=</span> <span>Math</span><span>;</span>

<span>// The code for Bresenham's line algorithm is pretty</span>
<span>// straight forward, as all good graphics algorithms are:</span>
<span>function</span> <span>fillScanLines</span><span>(</span><span>x</span><span>,</span> <span>y</span><span>,</span> <span>x2</span><span>,</span> <span>y2</span><span>,</span> <span>scanLines</span> <span>=</span> <span>[])</span> <span>{</span>
  <span>const</span> <span>dx</span> <span>=</span> <span>x2</span> <span>-</span> <span>x</span><span>,</span>  <span>dy</span> <span>=</span> <span>y2</span> <span>-</span> <span>y</span><span>;</span>
  <span>const</span> <span>ax</span> <span>=</span> <span>abs</span><span>(</span><span>dx</span><span>),</span> <span>ay</span> <span>=</span> <span>abs</span><span>(</span><span>dy</span><span>);</span>
  <span>const</span> <span>sx</span> <span>=</span> <span>sign</span><span>(</span><span>dx</span><span>),</span> <span>sy</span> <span>=</span> <span>sign</span><span>(</span><span>dy</span><span>);</span>
  <span>let</span> <span>threshold</span> <span>=</span> <span>ax</span> <span>-</span> <span>ay</span><span>;</span>

  <span>while</span> <span>(</span><span>true</span><span>)</span> <span>{</span>
    <span>scanLines</span><span>[</span><span>y</span><span>]</span> <span>??=</span> <span>[];</span>
    <span>scanLines</span><span>[</span><span>y</span><span>].</span><span>push</span><span>(</span><span>x</span><span>);</span>
    <span>if</span> <span>(</span><span>x</span> <span>===</span> <span>x2</span> <span>&amp;&amp;</span> <span>y</span> <span>===</span> <span>y2</span><span>)</span> <span>return</span> <span>scanLines</span><span>;</span>
    <span>const</span> <span>error</span> <span>=</span> <span>2</span> <span>*</span> <span>errorThreshold</span><span>;</span>
    <span>if</span> <span>(</span><span>error</span> <span>&gt;</span> <span>-</span><span>ay</span><span>)</span> <span>{</span> <span>x</span> <span>+=</span> <span>sx</span><span>;</span> <span>threshold</span> <span>-=</span> <span>ay</span><span>;</span> <span>}</span>
    <span>if</span> <span>(</span><span>error</span> <span>&lt;=</span> <span>ax</span><span>)</span> <span>{</span> <span>y</span> <span>+=</span> <span>sy</span><span>;</span> <span>threshold</span> <span>+=</span> <span>ax</span><span>;</span> <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>This is Bresenham’s algorithm with one important change: instead of “coloring” pixels in order to draw lines, we store the result in a lookup table that’s indexed on <code>y</code>. For a single pass, that may not sound super useful, but look at what happens if we run this for a polygon with coordinates (0,0), (10,0), (10,10), and (0,10).</p>

<p>First we index between (0,0) and (10,0), filling out <code>scanLines</code> lookup to:</p>

<div><pre><code><span>{</span>
  <span>[</span><span>0</span><span>]:</span> <span>[</span><span>0</span><span>,</span><span>1</span><span>,</span><span>2</span><span>,</span><span>3</span><span>,</span><span>4</span><span>,</span><span>5</span><span>,</span><span>6</span><span>,</span><span>7</span><span>,</span><span>8</span><span>,</span><span>9</span><span>,</span><span>10</span><span>]</span>
<span>}</span>
</code></pre></div>

<p>Then we process the edge from (10,0) to (10,10):</p>

<div><pre><code><span>{</span>
  <span>[</span><span>0</span><span>]:</span> <span>[</span><span>0</span><span>,</span><span>1</span><span>,</span><span>2</span><span>,</span><span>3</span><span>,</span><span>4</span><span>,</span><span>5</span><span>,</span><span>6</span><span>,</span><span>7</span><span>,</span><span>8</span><span>,</span><span>9</span><span>,</span><span>10</span><span>,</span><span>10</span><span>],</span>
  <span>[</span><span>1</span><span>]:</span> <span>[</span><span>10</span><span>],</span>
  <span>...</span>
  <span>[</span><span>10</span><span>]:</span> <span>[</span><span>10</span><span>]</span>
<span>}</span>
</code></pre></div>

<p>Then the edge from (10,10) to (0,10):</p>

<div><pre><code>{
  [0]: [0,1,2,3,4,5,6,7,8,9,10,10],
  [1]: [10],
  ...
  [9]: [10],
  [10]: [10,10,9,8,7,6,5,4,3,2,1,0]
}
</code></pre></div>

<p>And then closing edge from (0,10) back to (0,0):</p>

<div><pre><code>{
  [0]: [0,1,2,3,4,5,6,7,8,9,10,10,0],
  [1]: [10,0],
  ...
  [9]: [10,0],
  [10]: [10,10,9,8,7,6,5,4,3,2,1,0,0]
}
</code></pre></div>

<p>If we now sort those arrays and throw away everything except the first and last number, using we get:</p>

<div><pre><code>{
  [0]: [0,10],
  [1]: [0,10],
  ...
  [9]: [0,10],
  [10]: [0,10]
}
</code></pre></div>

<p>And suddenly we have all the scanlines that cover our polygon, expressed as a start and end <code>x</code> value, for any given <code>y</code>: the first row, at <code>y=0</code>, has a scanline that starts at <code>x=0</code> and runs up to and including <code>x=10</code>. The next line has the same, etc.  If we do this for <code>{(0,0), (10,5), (10,10), (0,5)}</code> we get:</p>

<div><pre><code><span>{</span>
  <span>[</span><span>0</span><span>]:</span> <span>[</span><span>0</span><span>,</span><span>0</span><span>]</span>
  <span>[</span><span>1</span><span>]:</span> <span>[</span><span>0</span><span>,</span><span>2</span><span>]</span>
  <span>[</span><span>2</span><span>]:</span> <span>[</span><span>0</span><span>,</span><span>4</span><span>]</span>
  <span>[</span><span>3</span><span>]:</span> <span>[</span><span>0</span><span>,</span><span>6</span><span>]</span>
  <span>[</span><span>4</span><span>]:</span> <span>[</span><span>0</span><span>,</span><span>8</span><span>]</span>
  <span>[</span><span>5</span><span>]:</span> <span>[</span><span>0</span><span>,</span><span>10</span><span>]</span>
  <span>[</span><span>6</span><span>]:</span> <span>[</span><span>2</span><span>,</span><span>10</span><span>]</span>
  <span>[</span><span>7</span><span>]:</span> <span>[</span><span>4</span><span>,</span><span>10</span><span>]</span>
  <span>[</span><span>8</span><span>]:</span> <span>[</span><span>6</span><span>,</span><span>10</span><span>]</span>
  <span>[</span><span>9</span><span>]:</span> <span>[</span><span>8</span><span>,</span><span>10</span><span>]</span>
  <span>[</span><span>10</span><span>]:</span> <span>[</span><span>10</span><span>,</span><span>10</span><span>]</span>
<span>}</span>
</code></pre></div>

<p>We can now find all the points in our polygon by starting at a scanline start, and running to the end. The following picture shows our original four points that define our polygon, then the scanline start and end values in the middle, and then all the implicit intermediate values coloured in on the right:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240209112833961.png" alt="image-20240209112833961"></p>

<p>So that looks pretty good! Although there is one caveat: this won’t work if the polygon is concave such that there would be multiple scanlines per row:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240209113348725.png" alt="image-20240209113348725"></p>

<p>Even though the line algorithm will find the lines marked in gray in the middle image, all those pixels are “not at the start or end” and so our concave polygon turns into a convex polygon instead. We <em>could</em> fix our code to account for that, but given the reason that we’re writing this code is to determine the maximum elevation in some area around-and/or-in-front-of our airplane, this simply won’t be an problem we need to deal with. Convex polygons it is!</p>

<p>so, let’s write the code that does the same thing that we just did by hand:</p>

<div><pre><code><span>function</span> <span>formScanLines</span><span>(</span><span>poly</span><span>)</span> <span>{</span>
  <span>// first, rewrite the input so that it's a "closed" polygon</span>
  <span>// by having its first coordinate be its last coordinate, too:</span>
  <span>poly</span> <span>=</span> <span>[...</span><span>poly</span><span>,</span> <span>poly</span><span>[</span><span>0</span><span>]];</span>

  <span>// Then, preallocate our "scanline lookup table":</span>
  <span>const</span> <span>scanLines</span> <span>=</span> <span>[];</span>

  <span>// And then we run through every edge, callig our</span>
  <span>// Bresenham function to update our lookup table:</span>
  <span>for</span> <span>(</span><span>let</span> <span>i</span> <span>=</span> <span>1</span><span>,</span> <span>e</span> <span>=</span> <span>poly</span><span>.</span><span>length</span><span>,</span> <span>a</span> <span>=</span> <span>poly</span><span>[</span><span>0</span><span>],</span> <span>b</span><span>;</span> <span>i</span> <span>&lt;</span> <span>e</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>{</span>
    <span>const</span> <span>b</span> <span>=</span> <span>poly</span><span>[</span><span>i</span><span>];</span>
    <span>fillScanLines</span><span>(</span><span>a</span><span>[</span><span>0</span><span>],</span> <span>a</span><span>[</span><span>1</span><span>],</span> <span>b</span><span>[</span><span>0</span><span>],</span> <span>b</span><span>[</span><span>1</span><span>],</span> <span>scanLines</span><span>);</span>
    <span>a</span> <span>=</span> <span>b</span><span>;</span>
  <span>}</span>

  <span>// Then we run the last step, where we turn rows of values</span>
  <span>// into start and end values. If we wanted this to work</span>
  <span>// for concave polygons we would need to do a bit more work,</span>
  <span>// because in that case a row can have multiple start and ends.</span>
  <span>// However, given the shape(s) we'll want to work with, we</span>
  <span>// can assume single start and end values.</span>
  <span>scanLines</span><span>.</span><span>forEach</span><span>((</span><span>line</span><span>)</span> <span>=&gt;</span> <span>{</span>
    <span>line</span><span>.</span><span>sort</span><span>((</span><span>a</span><span>,</span> <span>b</span><span>)</span> <span>=&gt;</span> <span>a</span> <span>-</span> <span>b</span><span>);</span>
    <span>const</span> <span>n</span> <span>=</span> <span>line</span><span>.</span><span>length</span><span>;</span>
    <span>if</span> <span>(</span><span>n</span> <span>&gt;</span> <span>2</span><span>)</span> <span>line</span><span>.</span><span>splice</span><span>(</span><span>1</span><span>,</span> <span>n</span> <span>-</span> <span>2</span><span>);</span>
  <span>});</span>

  <span>return</span> <span>scanLines</span><span>;</span>
<span>}</span>
</code></pre></div>

<p>And now we’re ready to fill in the as-of-yet empty  <code>maxElevation</code> function in our <code>alos-tile.js</code> file:</p>

<div><pre><code><span>...</span>

<span>export</span> <span>class</span> <span>ALOSTile</span> <span>{</span>
  <span>...</span>

  <span>/**
   * Find the maximum elevation inside a polygon by converting it
   * from geo-poly to pixel-poly, turning that into a set of
   * scan lines, and then finding the max elevation within those.
   */</span>
  <span>getMaxElevation</span><span>(</span><span>geoPoly</span><span>)</span> <span>{</span>
    <span>const</span> <span>pixelPoly</span> <span>=</span> <span>geoPoly</span><span>.</span><span>map</span><span>((</span><span>pair</span><span>)</span> <span>=&gt;</span> <span>this</span><span>.</span><span>geoToPixel</span><span>(...</span><span>pair</span><span>));</span>

    <span>// form our scanlines:</span>
    <span>const</span> <span>scanLines</span> <span>=</span> <span>formScanLines</span><span>(</span><span>pixelPoly</span><span>);</span>

    <span>// Then find the max elevation for each scanline,</span>
    <span>// and record at which coordinate we found that.</span>
    <span>const</span> <span>result</span> <span>=</span> <span>{</span> <span>elevation</span><span>:</span> <span>ALOS_VOID_VALUE</span> <span>};</span>
    <span>scanLines</span><span>.</span><span>forEach</span><span>(([</span><span>start</span><span>,</span> <span>end</span><span>],</span> <span>y</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>if</span> <span>(</span><span>start</span> <span>===</span> <span>end</span><span>)</span> <span>return</span><span>;</span>

      <span>const</span> <span>line</span> <span>=</span> <span>this</span><span>.</span><span>pixels</span><span>.</span><span>slice</span><span>(</span>
        <span>this</span><span>.</span><span>width</span> <span>*</span> <span>y</span> <span>+</span> <span>start</span><span>,</span>
        <span>this</span><span>.</span><span>width</span> <span>*</span> <span>y</span> <span>+</span> <span>end</span>
      <span>);</span>

      <span>line</span><span>.</span><span>forEach</span><span>((</span><span>elevation</span><span>,</span> <span>i</span><span>)</span> <span>=&gt;</span> <span>{</span>
        <span>if</span> <span>(</span><span>elevation</span> <span>&gt;=</span> <span>NO_ALOS_DATA_VALUE</span><span>)</span> <span>return</span><span>;</span>
        <span>let</span> <span>x</span> <span>=</span> <span>i</span> <span>+</span> <span>start</span><span>;</span>
        <span>if</span> <span>(</span><span>elevation</span> <span>&gt;</span> <span>result</span><span>.</span><span>elevation</span><span>)</span> <span>{</span>
          <span>result</span><span>.</span><span>x</span> <span>=</span> <span>x</span><span>;</span>
          <span>result</span><span>.</span><span>y</span> <span>=</span> <span>y</span><span>;</span>
          <span>result</span><span>.</span><span>elevation</span> <span>=</span> <span>elevation</span><span>;</span>
        <span>}</span>
      <span>});</span>
    <span>});</span>

    <span>// When we're done, we have our max elevation, but it's in meters,</span>
    <span>// and we know where "on the map" that is, but only in pixel coordinates.</span>
    <span>// So let's convert those to feet and GPS coordinates, respectively:Ï</span>
    <span>const</span> <span>{</span> <span>elevation</span><span>:</span> <span>meter</span><span>,</span> <span>x</span><span>,</span> <span>y</span> <span>}</span> <span>=</span> <span>result</span><span>;</span>
    <span>const</span> <span>[</span><span>lat</span><span>,</span> <span>long</span><span>]</span> <span>=</span> <span>this</span><span>.</span><span>pixelToGeo</span><span>(</span><span>x</span><span>,</span> <span>y</span><span>);</span>
    <span>const</span> <span>feet</span> <span>=</span> <span>(</span><span>meter</span> <span>===</span> <span>ALOS_VOID_VALUE</span><span>)</span> <span>?</span> <span>meter</span> <span>:</span> <span>ceil</span><span>(</span><span>meter</span> <span>*</span> <span>3.28084</span><span>);</span>
    <span>return</span> <span>{</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>elevation</span><span>:</span> <span>{</span> <span>feet</span><span>,</span> <span>meter</span> <span>}};</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And that should do it, so let’s put that to the test! if we run the server and we ask for http://localhost:9000/?poly=47.1,-123.1,47.1,-123.8,47.8,-123.8,47.8,-123.1 we get:</p>

<div><pre><code><span>{</span><span>
  </span><span>"poly"</span><span>:</span><span> </span><span>[</span><span>
    </span><span>[</span><span>47.1</span><span>,</span><span> </span><span>-123.1</span><span>],</span><span>
    </span><span>[</span><span>47.1</span><span>,</span><span> </span><span>-123.8</span><span>],</span><span>
    </span><span>[</span><span>47.8</span><span>,</span><span> </span><span>-123.8</span><span>],</span><span>
    </span><span>[</span><span>47.8</span><span>,</span><span> </span><span>-123.1</span><span>]</span><span>
  </span><span>],</span><span>
  </span><span>"result"</span><span>:</span><span> </span><span>{</span><span>
    </span><span>"lat"</span><span>:</span><span> </span><span>47.79666666666667</span><span>,</span><span>
    </span><span>"long"</span><span>:</span><span> </span><span>-123.70111111111112</span><span>,</span><span>
    </span><span>"elevation"</span><span>:</span><span> </span><span>{</span><span> </span><span>"feet"</span><span>:</span><span> </span><span>7845</span><span>,</span><span> </span><span>"meter"</span><span>:</span><span> </span><span>2391</span><span> </span><span>}</span><span>
  </span><span>},</span><span>
  </span><span>"ms"</span><span>:</span><span> </span><span>348</span><span>
</span><span>}</span><span>
</span></code></pre></div>

<p>Which we can check for accuracy by looking that coordinate up on the map. Does this result make sense?</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240207213813384.png" alt="image-20240207213813384"></p>

<p>It looks like we’ve found the peak(s) of Mount Olympus, in Olympic National Park, Washington, US, which is <em>by far</em> the highest point around for many miles (and thus, for “even manier kilometers”): great success!</p>

<h4 id="optimizing-our-call-time-coarse-lookups">Optimizing our call time: coarse lookups</h4>

<p>Let’s check some timings: if we repeat-run this query so that our tile is cached, it takes about 50 milliseconds to find the highest point in an area that’s around 10,000 square kilometers. And while that certainly doesn’t seem bad, is it…. <em>good</em>?</p>

<p>Specifically: the ALOS data has a 30 meter resolution (meaning each pixel represents the elevation measured over a 30m x 30m area), which is smaller than the wing span of some planes (For example, the <a href="https://en.wikipedia.org/wiki/Airbus_A320neo_family">Airbus A320neo</a> has a wingspan of 35 meters) so what if we turn our beautiful 30 meter resolution data into something a little coarser, like 60m x 60m, or 120m x 120m, by resizing the image data while keeping “the highest values” instead of averaging them like a normal resize would?</p>

<p>Let’s update our <code>alos-tile.js</code> code:</p>

<div><pre><code><span>...</span>

<span>import</span> <span>{</span> <span>KM_PER_ARC_DEGREE</span> <span>}</span> <span>from</span> <span>"</span><span>../utils/constants.js</span><span>"</span><span>;</span>
<span>const</span> <span>{</span> <span>abs</span><span>,</span> <span>ceil</span><span>,</span> <span>sign</span><span>,</span> <span>max</span> <span>}</span> <span>=</span> <span>Math</span><span>;</span>
<span>const</span> <span>DEFAULT_COARSE_SCALE</span> <span>=</span> <span>2</span><span>;</span>

<span>export</span> <span>class</span> <span>ALOSTile</span> <span>{</span>
  <span>constructor</span><span>(</span><span>tilePath</span><span>,</span> <span>scale</span> <span>=</span> <span>DEFAULT_COARSE_SCALE</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>tilePath</span> <span>=</span> <span>tilePath</span><span>;</span>
    <span>this</span><span>.</span><span>load</span><span>(</span><span>tilePath</span><span>,</span> <span>scale</span><span>);</span>
  <span>}</span>

  <span>load</span><span>(</span><span>filename</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>// Create a down-scaled version of this tile that we</span>
    <span>// can use for max elevation purposes:</span>
    <span>this</span><span>.</span><span>coarse</span> <span>=</span> <span>false</span><span>;</span>
    <span>// And do this work on a timeout, so that it doesn't.</span>
    <span>// hold up calls that might come in before the code</span>
    <span>// for that has finished:</span>
    <span>setTimeout</span><span>(</span>
      <span>()</span> <span>=&gt;</span>
        <span>time</span><span>(</span><span>`forming coarse image`</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>this</span><span>.</span><span>formCoarseTile</span><span>(</span><span>width</span><span>,</span> <span>height</span><span>)),</span>
      <span>50</span>
    <span>);</span>
  <span>}</span>

  <span>/**
   * Resize the original data by a factor of 2^scale, preserving
   * maximum elevation. If we had four pixels that encoded:
   *
   *    [.. .. .. ..]
   *    [.. 24 38 ..]
   *    [.. 34 57 ..]
   *    [.. .. .. ..]
   *
   * That would become a new, single pixel with value 57.
   */</span>
  <span>formCoarseTile</span><span>(</span><span>width</span><span>,</span> <span>height</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>pixels</span><span>:</span> <span>p</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>

    <span>const</span> <span>coarseLevel</span> <span>=</span> <span>2</span> <span>**</span> <span>(</span><span>this</span><span>.</span><span>scale</span> <span>-</span> <span>1</span><span>);</span>
    <span>const</span> <span>coarsePixels</span> <span>=</span> <span>[];</span>
    <span>const</span> <span>[</span><span>w</span><span>,</span> <span>h</span><span>]</span> <span>=</span> <span>[</span><span>width</span> <span>/</span> <span>coarseLevel</span><span>,</span> <span>height</span> <span>/</span> <span>coarseLevel</span><span>];</span>

    <span>// We run a relative expensive loop here, but we'll only be</span>
    <span>// running it once, and we're running it "independently" of</span>
    <span>// any actual calls, so it won't cause query slowdowns.</span>
    <span>for</span> <span>(</span><span>let</span> <span>x</span> <span>=</span> <span>0</span><span>;</span> <span>x</span> <span>&lt;</span> <span>width</span><span>;</span> <span>x</span> <span>+=</span> <span>coarseLevel</span><span>)</span> <span>{</span>
      <span>for</span> <span>(</span><span>let</span> <span>y</span> <span>=</span> <span>0</span><span>;</span> <span>y</span> <span>&lt;</span> <span>width</span><span>;</span> <span>y</span> <span>+=</span> <span>coarseLevel</span><span>)</span> <span>{</span>
        <span>// find the highest elevation amongst all the pixels</span>
        <span>// that we want to collapse into a single new pixel:</span>
        <span>let</span> <span>maximum</span> <span>=</span> <span>ALOS_VOID_VALUE</span><span>;</span>
        <span>for</span> <span>(</span><span>let</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>coarseLevel</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>{</span>
          <span>for</span> <span>(</span><span>let</span> <span>j</span> <span>=</span> <span>0</span><span>;</span> <span>j</span> <span>&lt;</span> <span>coarseLevel</span><span>;</span> <span>j</span><span>++</span><span>)</span> <span>{</span>
            <span>const</span> <span>pos</span> <span>=</span> <span>(</span><span>y</span> <span>+</span> <span>j</span><span>)</span> <span>*</span> <span>width</span> <span>+</span> <span>(</span><span>x</span> <span>+</span> <span>i</span><span>);</span>
            <span>const</span> <span>elevation</span> <span>=</span> <span>p</span><span>[</span><span>pos</span><span>];</span>
            <span>if</span> <span>(</span><span>maximum</span> <span>&lt;</span> <span>elevation</span><span>)</span> <span>maximum</span> <span>=</span> <span>elevation</span><span>;</span>
          <span>}</span>
        <span>}</span>
        <span>// and then set that value in our smaller pixel "grid".</span>
        <span>const</span> <span>pos</span> <span>=</span> <span>((</span><span>y</span> <span>/</span> <span>coarseLevel</span><span>)</span> <span>|</span> <span>0</span><span>)</span> <span>*</span> <span>w</span> <span>+</span> <span>((</span><span>x</span> <span>/</span> <span>coarseLevel</span><span>)</span> <span>|</span> <span>0</span><span>);</span>
        <span>coarsePixels</span><span>[</span><span>pos</span><span>]</span> <span>=</span> <span>maximum</span><span>;</span>
      <span>}</span>
    <span>}</span>

    <span>this</span><span>.</span><span>coarse</span> <span>=</span> <span>{</span> <span>coarseLevel</span><span>,</span> <span>width</span><span>:</span> <span>w</span><span>,</span> <span>height</span><span>:</span> <span>h</span><span>,</span> <span>pixels</span><span>:</span> <span>coarsePixels</span> <span>};</span>
  <span>}</span>

  <span>// In order to map pixels to GPS coordaintes, we now need to take</span>
  <span>// our scaling factor into account, if we're performing a coarse lookup:</span>
  <span>pixelToGeo</span><span>(</span><span>x</span><span>,</span> <span>y</span><span>,</span> <span>coarse</span> <span>=</span> <span>false</span><span>,</span> <span>F</span> <span>=</span> <span>this</span><span>.</span><span>forward</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>coarse</span><span>)</span> <span>{</span>
      <span>const</span> <span>{</span> <span>coarseLevel</span> <span>}</span> <span>=</span> <span>this</span><span>.</span><span>coarse</span><span>;</span>
      <span>x</span> <span>=</span> <span>x</span> <span>*</span> <span>coarseLevel</span><span>;</span>
      <span>y</span> <span>=</span> <span>y</span> <span>*</span> <span>coarseLevel</span><span>;</span>
    <span>}</span>
    <span>return</span> <span>[</span><span>F</span><span>[</span><span>3</span><span>]</span> <span>+</span> <span>F</span><span>[</span><span>4</span><span>]</span> <span>*</span> <span>x</span> <span>+</span> <span>F</span><span>[</span><span>5</span><span>]</span> <span>*</span> <span>y</span><span>,</span> <span>F</span><span>[</span><span>0</span><span>]</span> <span>+</span> <span>F</span><span>[</span><span>1</span><span>]</span> <span>*</span> <span>x</span> <span>+</span> <span>F</span><span>[</span><span>2</span><span>]</span> <span>*</span> <span>y</span><span>];</span>
  <span>}</span>

  <span>// And the same goes for GPS to pixel coordinate, of course:</span>
  <span>geoToPixel</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>coarse</span> <span>=</span> <span>false</span><span>,</span> <span>R</span> <span>=</span> <span>this</span><span>.</span><span>reverse</span><span>)</span> <span>{</span>
    <span>let</span> <span>[</span><span>x</span><span>,</span> <span>y</span><span>]</span> <span>=</span> <span>[</span>
      <span>(</span><span>R</span><span>[</span><span>0</span><span>]</span> <span>+</span> <span>R</span><span>[</span><span>1</span><span>]</span> <span>*</span> <span>long</span> <span>+</span> <span>R</span><span>[</span><span>2</span><span>]</span> <span>*</span> <span>lat</span><span>)</span> <span>|</span> <span>0</span><span>,</span>
      <span>(</span><span>R</span><span>[</span><span>3</span><span>]</span> <span>+</span> <span>R</span><span>[</span><span>4</span><span>]</span> <span>*</span> <span>long</span> <span>+</span> <span>R</span><span>[</span><span>5</span><span>]</span> <span>*</span> <span>lat</span><span>)</span> <span>|</span> <span>0</span><span>,</span>
    <span>];</span>
    <span>if</span> <span>(</span><span>coarse</span><span>)</span> <span>{</span>
      <span>const</span> <span>{</span> <span>coarseLevel</span> <span>}</span> <span>=</span> <span>this</span><span>.</span><span>coarse</span><span>;</span>
      <span>x</span> <span>=</span> <span>(</span><span>x</span> <span>/</span> <span>coarseLevel</span><span>)</span> <span>|</span> <span>0</span><span>;</span>
      <span>y</span> <span>=</span> <span>(</span><span>y</span> <span>/</span> <span>coarseLevel</span><span>)</span> <span>|</span> <span>0</span><span>;</span>
    <span>}</span>
    <span>return</span> <span>[</span><span>x</span><span>,</span> <span>y</span><span>];</span>
  <span>}</span>

  <span>// We give our lookup function the option to perform a coarse lookup:</span>
  <span>lookup</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>coarse</span> <span>=</span> <span>false</span><span>)</span> <span>{</span>
    <span>// Since we wrote `this.coarse` to have the same lookup-relevant</span>
    <span>// properties as the tile object itself, they're interchangeable:</span>
    <span>const</span> <span>ref</span> <span>=</span> <span>coarse</span> <span>?</span> <span>this</span><span>.</span><span>coarse</span> <span>:</span> <span>this</span><span>;</span>
    <span>const</span> <span>[</span><span>x</span><span>,</span> <span>y</span><span>]</span> <span>=</span> <span>this</span><span>.</span><span>geoToPixel</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>coarse</span><span>);</span>
    <span>const</span> <span>pos</span> <span>=</span> <span>x</span> <span>+</span> <span>y</span> <span>*</span> <span>ref</span><span>.</span><span>width</span><span>;</span>
    <span>let</span> <span>value</span> <span>=</span> <span>ref</span><span>.</span><span>pixels</span><span>[</span><span>pos</span><span>];</span>
    <span>if</span> <span>(</span><span>value</span> <span>===</span> <span>undefined</span> <span>||</span> <span>value</span> <span>&gt;</span> <span>NO_ALOS_DATA_VALUE</span><span>)</span>
      <span>value</span> <span>=</span> <span>ALOS_VOID_VALUE</span><span>;</span>
    <span>return</span> <span>value</span><span>;</span>
  <span>}</span>

  <span>// But we make the max elevation function always perform coarse</span>
  <span>// lookups once the formCoarseTile() function finishes:</span>
  <span>getMaxElevation</span><span>(</span><span>geoPoly</span><span>)</span> <span>{</span>
    <span>const</span> <span>coarse</span> <span>=</span> <span>!!</span><span>this</span><span>.</span><span>coarse</span><span>;</span>
    <span>const</span> <span>ref</span> <span>=</span> <span>coarse</span> <span>?</span> <span>this</span><span>.</span><span>coarse</span> <span>:</span> <span>this</span><span>;</span>
    <span>const</span> <span>pixelPoly</span> <span>=</span> <span>geoPoly</span><span>.</span><span>map</span><span>((</span><span>pair</span><span>)</span> <span>=&gt;</span> <span>this</span><span>.</span><span>geoToPixel</span><span>(...</span><span>pair</span><span>,</span> <span>coarse</span><span>));</span>
    <span>const</span> <span>scanLines</span> <span>=</span> <span>formScanLines</span><span>(</span><span>pixelPoly</span><span>);</span>

    <span>const</span> <span>result</span> <span>=</span> <span>{</span> <span>elevation</span><span>:</span> <span>ALOS_VOID_VALUE</span> <span>};</span>
    <span>scanLines</span><span>.</span><span>forEach</span><span>(([</span><span>start</span><span>,</span> <span>end</span><span>],</span> <span>y</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>if</span> <span>(</span><span>start</span> <span>===</span> <span>end</span><span>)</span> <span>return</span><span>;</span>

      <span>const</span> <span>line</span> <span>=</span> <span>ref</span><span>.</span><span>pixels</span><span>.</span><span>slice</span><span>(</span><span>ref</span><span>.</span><span>width</span> <span>*</span> <span>y</span> <span>+</span> <span>start</span><span>,</span> <span>ref</span><span>.</span><span>width</span> <span>*</span> <span>y</span> <span>+</span> <span>end</span><span>);</span>

      <span>line</span><span>.</span><span>forEach</span><span>((</span><span>elevation</span><span>,</span> <span>i</span><span>)</span> <span>=&gt;</span> <span>{</span>
        <span>if</span> <span>(</span><span>elevation</span> <span>&gt;=</span> <span>NO_ALOS_DATA_VALUE</span><span>)</span> <span>return</span><span>;</span>
        <span>let</span> <span>x</span> <span>=</span> <span>i</span> <span>+</span> <span>start</span><span>;</span>
        <span>if</span> <span>(</span><span>elevation</span> <span>&gt;</span> <span>result</span><span>.</span><span>elevation</span><span>)</span> <span>{</span>
          <span>result</span><span>.</span><span>x</span> <span>=</span> <span>x</span><span>;</span>
          <span>result</span><span>.</span><span>y</span> <span>=</span> <span>y</span><span>;</span>
          <span>result</span><span>.</span><span>elevation</span> <span>=</span> <span>elevation</span><span>;</span>
        <span>}</span>
      <span>});</span>
    <span>});</span>

    <span>const</span> <span>{</span> <span>elevation</span><span>:</span> <span>meter</span><span>,</span> <span>x</span><span>,</span> <span>y</span> <span>}</span> <span>=</span> <span>result</span><span>;</span>
    <span>const</span> <span>[</span><span>lat</span><span>,</span> <span>long</span><span>]</span> <span>=</span> <span>this</span><span>.</span><span>pixelToGeo</span><span>(</span><span>x</span><span>,</span> <span>y</span><span>,</span> <span>coarse</span><span>);</span>
    <span>const</span> <span>feet</span> <span>=</span> <span>meter</span> <span>===</span> <span>ALOS_VOID_VALUE</span> <span>?</span> <span>meter</span> <span>:</span> <span>ceil</span><span>(</span><span>meter</span> <span>*</span> <span>3.28084</span><span>);</span>
    <span>const</span> <span>maximum</span> <span>=</span> <span>{</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>elevation</span><span>:</span> <span>{</span> <span>feet</span><span>,</span> <span>meter</span> <span>}};</span>

    <span>// And for good measure, let's also include what resolution we used:</span>
    <span>maximum</span><span>.</span><span>resolution</span> <span>=</span> <span>parseFloat</span><span>(((</span><span>KM_PER_ARC_DEGREE</span> <span>*</span> <span>1000</span><span>)</span> <span>/</span> <span>ref</span><span>.</span><span>width</span><span>).</span><span>toFixed</span><span>(</span><span>2</span><span>));</span>
    <span>return</span> <span>maximum</span><span>;</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>So what’s the effect of this? The first call, obviously, won’t be using any scaling, so that’ll perform the same as before, but what happens to our subsequent calls?</p>

<div><pre><code><span>{</span><span>
  </span><span>"poly"</span><span>:</span><span> </span><span>[</span><span>
    </span><span>[</span><span>47.1</span><span>,</span><span> </span><span>-123.1</span><span>],</span><span>
    </span><span>[</span><span>47.1</span><span>,</span><span> </span><span>-123.8</span><span>],</span><span>
    </span><span>[</span><span>47.8</span><span>,</span><span> </span><span>-123.8</span><span>],</span><span>
    </span><span>[</span><span>47.8</span><span>,</span><span> </span><span>-123.1</span><span>]</span><span>
  </span><span>],</span><span>
  </span><span>"result"</span><span>:</span><span> </span><span>{</span><span>
    </span><span>"lat"</span><span>:</span><span> </span><span>47.79666666666667</span><span>,</span><span>
    </span><span>"long"</span><span>:</span><span> </span><span>-123.70111111111112</span><span>,</span><span>
    </span><span>"elevation"</span><span>:</span><span> </span><span>{</span><span> </span><span>"feet"</span><span>:</span><span> </span><span>7845</span><span>,</span><span> </span><span>"meter"</span><span>:</span><span> </span><span>2391</span><span> </span><span>},</span><span>
    </span><span>"resolution"</span><span>:</span><span> </span><span>61.84</span><span>
  </span><span>},</span><span>
  </span><span>"ms"</span><span>:</span><span> </span><span>18</span><span>
</span><span>}</span><span>
</span></code></pre></div>

<p>That’s almost three times as fast. And incredible speedup!</p>

<p>In fact, let’s bump our <code>DEFAULT_COARSE_SCALE</code> up to 3:</p>

<div><pre><code><span>{</span>
  <span>"</span><span>poly</span><span>"</span><span>:</span> <span>[</span>
    <span>[</span><span>47.1</span><span>,</span> <span>-</span><span>123.1</span><span>],</span>
    <span>[</span><span>47.1</span><span>,</span> <span>-</span><span>123.8</span><span>],</span>
    <span>[</span><span>47.8</span><span>,</span> <span>-</span><span>123.8</span><span>],</span>
    <span>[</span><span>47.8</span><span>,</span> <span>-</span><span>123.1</span><span>]</span>
  <span>],</span>
  <span>"</span><span>result</span><span>"</span><span>:</span> <span>{</span>
    <span>"</span><span>lat</span><span>"</span><span>:</span> <span>47.79666666666667</span><span>,</span>
    <span>"</span><span>long</span><span>"</span><span>:</span> <span>-</span><span>123.70111111111112</span><span>,</span>
    <span>"</span><span>elevation</span><span>"</span><span>:</span> <span>{</span> <span>"</span><span>feet</span><span>"</span><span>:</span> <span>7845</span><span>,</span> <span>"</span><span>meter</span><span>"</span><span>:</span> <span>2391</span> <span>},</span>
    <span>"</span><span>resolution</span><span>"</span><span>:</span> <span>123.69</span>
  <span>},</span>
  <span>"</span><span>ms</span><span>"</span><span>:</span> <span>6</span>
<span>}</span>
</code></pre></div>

<p>We’re now getting results for entire GPS grid blocks in under 10 milliseconds!</p>

<p>We could even bump our scale up to 4, and get it down to running in only 3 milliseconds, but now we’re looking at diminishing returns: going from 50ms to 6ms is <em>huge</em>, but going from 50ms to 3ms is just not appreciably better. Instead, let’s focus on what’s left on our list of things we need to do before terrain follow can work.</p>

<h4 id="splitting-our-shapes">Splitting our shapes</h4>

<p>So far, we’ve restrict our polygon to something that fits inside a single, 1 degree x 1 degree tile, and that’s not super useful when we’re flying around and crossing degree lines all the time. Ideally, we’d:</p>

<ul>
  <li>split our polygon into 2 or more partials if it crosses degree lines,</li>
  <li>find the max elevation in each “partial”, and then</li>
  <li>pick whichever of those partial’s result is the highest.</li>
</ul>

<p>The last two are pretty straight forward given that we already wrote code that does that above, and the first one is a little harder, but not much harder. Let’s start with our <code>alos-interface.js</code> where we want to update <code>getMaxElevation</code> so it can deal with coordinates that cover more than one tile:</p>

<div><pre><code><span>...</span>

<span>export</span> <span>class</span> <span>ALOSInterface</span> <span>{</span>
  <span>...</span>

  <span>/**
   * Let's expand our function to deal with multiple tiles:
   */</span>
  <span>getMaxElevation</span><span>(</span><span>geoPoly</span><span>)</span> <span>{</span>
    <span>// We'll get to this function...</span>
    <span>const</span> <span>quadrants</span> <span>=</span> <span>splitAsQuadrants</span><span>(</span><span>geoPoly</span><span>);</span>

    <span>// But assuming that works, we start with a dummy result:</span>
    <span>let</span> <span>result</span> <span>=</span> <span>{</span>
      <span>lat</span><span>:</span> <span>0</span><span>,</span>
      <span>long</span><span>:</span> <span>0</span><span>,</span>
      <span>elevation</span><span>:</span> <span>{</span> <span>feet</span><span>:</span> <span>ALOS_VOID_VALUE</span><span>,</span> <span>meter</span><span>:</span> <span>ALOS_VOID_VALUE</span> <span>},</span>
    <span>};</span>

    <span>// Then check each partial polygon in its own tile to see</span>
    <span>// if that yields a higher max elevation</span>
    <span>quadrants</span><span>.</span><span>forEach</span><span>((</span><span>poly</span><span>,</span> <span>i</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>if</span> <span>(</span><span>!</span><span>poly</span><span>.</span><span>length</span><span>)</span> <span>return</span><span>;</span>

      <span>// Get the tile for this partial polygon...</span>
      <span>const</span> <span>tile</span> <span>=</span> <span>this</span><span>.</span><span>getTileFor</span><span>(...</span><span>poly</span><span>[</span><span>0</span><span>]);</span>

      <span>// ...but remember that not every GPS "rectangle" has a</span>
      <span>// tile. For instance, if one of our tiles would be</span>
      <span>// all-ocean, that's not captured by ALOS.</span>
      <span>if</span> <span>(</span><span>!</span><span>tile</span><span>)</span> <span>return</span><span>;</span>

      <span>// Get the max elevation for this tile...</span>
      <span>const</span> <span>qResult</span> <span>=</span> <span>tile</span><span>.</span><span>getMaxElevation</span><span>(</span><span>poly</span><span>);</span>

      <span>// ...and then check if it's better than what we have</span>
      <span>if</span> <span>qResult</span><span>.</span><span>elevation</span><span>.</span><span>meter</span> <span>&gt;</span> <span>result</span><span>.</span><span>elevation</span><span>.</span><span>meter</span><span>)</span> <span>{</span>
        <span>result</span> <span>=</span> <span>qResult</span><span>;</span>
      <span>}</span>
    <span>});</span>

    <span>return</span> <span>result</span><span>;</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>So let’s explore that <code>splitAsQuadrants</code> function. At the distances we want to work with, polygons will almost certainly cross degree lines, but they <em>won’t</em> be crossing more than one degree line in either direction, which leaves us with the following possibilities:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240207220242889.png" alt="image-20240207220242889"><img src="https://pomax.github.io/are-we-flying/image-20240207220309961.png" alt="image-20240207220309961"><img src="https://pomax.github.io/are-we-flying/image-20240207220348606.png" alt="image-20240207220348606"><img src="https://pomax.github.io/are-we-flying/image-20240207220430386.png" alt="image-20240207220430386"></p>

<p>As well as a special case where one of our edges may cross both the vertical and horizontal degree lines at the same time:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240207221029594.png" alt="image-20240207221029594"></p>

<p>So the first step is: figure out which degree lines might split our polygon.</p>

<div><pre><code><span>function</span> <span>splitAsQuadrants</span><span>(</span><span>poly</span><span>)</span> <span>{</span>
  <span>// Figure out which "horizontal" and "vertical"</span>
  <span>// lines we may need to cut our polygon:</span>
  <span>const</span> <span>lats</span> <span>=</span> <span>[],</span> <span>longs</span> <span>=</span> <span>[];</span>
  <span>poly</span><span>.</span><span>forEach</span><span>(([</span><span>lat</span><span>,</span> <span>long</span><span>])</span> <span>=&gt;</span> <span>{</span>
    <span>lats</span><span>.</span><span>push</span><span>(</span><span>lat</span> <span>|</span> <span>0</span><span>);</span>
    <span>longs</span><span>.</span><span>push</span><span>(</span><span>long</span> <span>|</span> <span>0</span><span>);</span>
  <span>});</span>

  <span>const</span> <span>hThreshold</span> <span>=</span> <span>ceil</span><span>((</span>
    <span>min</span><span>(...</span><span>longs</span><span>)</span> <span>+</span> <span>max</span><span>(...</span><span>longs</span><span>))</span> <span>/</span> <span>2</span>
  <span>);</span>

  <span>const</span> <span>vThreshold</span> <span>=</span> <span>ceil</span><span>(</span>
    <span>(</span><span>min</span><span>(...</span><span>lats</span><span>)</span> <span>+</span> <span>max</span><span>(...</span><span>lats</span><span>))</span> <span>/</span> <span>2</span>
  <span>);</span>
<span>}</span>
</code></pre></div>

<p>With that work done, we can use three steps to split any polygon into “as many pieces as needed”: first we split one way, then we split the resulting (up to) two pieces the other way, yielding (up to) four pieces:</p>

<div><pre><code><span>function</span> <span>splitAsQuadrants</span><span>(</span><span>poly</span><span>)</span> <span>{</span>
  <span>...</span>

  <span>// Perform a three-way polygon split:</span>
  <span>//</span>
  <span>// first we split left/right, then we split both results</span>
  <span>// (one of which might be an empty array) top/bottom so</span>
  <span>// that we end up with up to four regions in which we need</span>
  <span>// to find the maximum elevation.</span>
  <span>poly</span> <span>=</span> <span>[...</span><span>poly</span><span>,</span> <span>poly</span><span>[</span><span>0</span><span>]];</span>
  <span>const</span> <span>[</span><span>left</span><span>,</span> <span>right</span><span>]</span> <span>=</span> <span>splitAlong</span><span>(</span><span>poly</span><span>,</span> <span>1</span><span>,</span> <span>hThreshold</span><span>);</span>
  <span>const</span> <span>[</span><span>tl</span><span>,</span> <span>bl</span><span>]</span> <span>=</span> <span>splitAlong</span><span>(</span><span>left</span><span>,</span> <span>0</span><span>,</span> <span>vThreshold</span><span>);</span>
  <span>const</span> <span>[</span><span>tr</span><span>,</span> <span>br</span><span>]</span> <span>=</span> <span>splitAlong</span><span>(</span><span>right</span><span>,</span> <span>0</span><span>,</span> <span>vThreshold</span><span>);</span>
  <span>return</span> <span>[</span><span>tr</span><span>,</span> <span>br</span><span>,</span> <span>bl</span><span>,</span> <span>tl</span><span>];</span>
<span>}</span>
</code></pre></div>

<p>And that’s the easy part covered. Now for the part where we actually split a polygon along some line… For this, we need to consider the two points on either side of an edge: either they’re both on the same side of our dividing line, and we don’t need to do anything special, or they’re on opposite sides of the divide, and the edge between them will need to be split.</p>

<p>So let’s start with two empty shapes, one for “all points less or equal to” our dividing line, and one for “all points greater than” our dividing line, and then start running through our shape one edge at a time:</p>

<div><pre><code><span>function</span> <span>splitAlong</span><span>(</span><span>coords</span><span>,</span> <span>dim</span><span>,</span> <span>threshold</span><span>)</span> <span>{</span>
  <span>// our new shapes:</span>
  <span>const</span> <span>le</span> <span>=</span> <span>[],</span> <span>gt</span> <span>=</span> <span>[];</span>

  <span>// Then we run through all edges by iterating over point pairs:</span>
  <span>for</span> <span>(</span><span>let</span> <span>i</span> <span>=</span> <span>1</span><span>,</span> <span>e</span> <span>=</span> <span>coords</span><span>.</span><span>length</span><span>,</span> <span>a</span> <span>=</span> <span>coords</span><span>[</span><span>0</span><span>],</span> <span>b</span><span>;</span> <span>i</span> <span>&lt;</span> <span>e</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>{</span>
    <span>b</span> <span>=</span> <span>coords</span><span>[</span><span>i</span><span>];</span>
    <span>// if the first point is less or equal to our divider,</span>
    <span>// add that point to our new "less or equal" shape.</span>
    <span>if</span> <span>(</span><span>a</span><span>[</span><span>dim</span><span>]</span> <span>&lt;=</span> <span>threshold</span><span>)</span> <span>{</span>
      <span>le</span><span>.</span><span>push</span><span>(</span><span>a</span><span>);</span>
      <span>// If the second point is on the other side of our</span>
      <span>// divider, we split up the edge by generating two new</span>
      <span>// points on either side of the divider, and then adding</span>
      <span>// the one on a's side to the same shape we added a to,</span>
      <span>// and we add the one on b's side to the other shape.</span>
      <span>if</span> <span>(</span><span>b</span><span>[</span><span>dim</span><span>]</span> <span>&gt;</span> <span>threshold</span><span>)</span> <span>{</span>
        <span>splitEdge</span><span>(</span><span>a</span><span>,</span> <span>b</span><span>,</span> <span>dim</span><span>,</span> <span>threshold</span><span>,</span> <span>le</span><span>,</span> <span>gt</span><span>);</span>
      <span>}</span>
    <span>}</span>
    <span>// And if the first point is greater than our divider, we</span>
    <span>// do the same thing but with the target shapes switched.</span>
    <span>else</span> <span>{</span>
      <span>gt</span><span>.</span><span>push</span><span>(</span><span>a</span><span>);</span>
      <span>if</span> <span>(</span><span>b</span><span>[</span><span>dim</span><span>]</span> <span>&lt;=</span> <span>threshold</span><span>)</span> <span>{</span>
        <span>splitEdge</span><span>(</span><span>a</span><span>,</span> <span>b</span><span>,</span> <span>dim</span><span>,</span> <span>threshold</span><span>,</span> <span>le</span><span>,</span> <span>gt</span><span>);</span>
      <span>}</span>
    <span>}</span>
    <span>a</span> <span>=</span> <span>b</span><span>;</span>
  <span>}</span>

  <span>// Once we've done all that, we need to make sure that we</span>
  <span>// return closed polygons, so for both shapes (IF they have</span>
  <span>// any points) we need to add the first point as the last point.</span>
  <span>if</span> <span>(</span><span>le</span><span>.</span><span>length</span><span>)</span> <span>le</span><span>.</span><span>push</span><span>(</span><span>le</span><span>[</span><span>0</span><span>]);</span>
  <span>if</span> <span>(</span><span>gt</span><span>.</span><span>length</span><span>)</span> <span>gt</span><span>.</span><span>push</span><span>(</span><span>gt</span><span>[</span><span>0</span><span>]);</span>
  <span>return</span> <span>[</span><span>le</span><span>,</span> <span>gt</span><span>];</span>
<span>}</span>
</code></pre></div>

<p>So: not a lot of code, but we did gloss over <code>splitEdge()</code>, so let’s define that, too:</p>

<div><pre><code><span>function</span> <span>splitEdge</span><span>(</span><span>a</span><span>,</span> <span>b</span><span>,</span> <span>dim</span><span>,</span> <span>threshold</span><span>,</span> <span>le</span><span>,</span> <span>gt</span><span>)</span> <span>{</span>
  <span>// How far along the edge can we find our divider,</span>
  <span>// relative to the first point?</span>
  <span>const</span> <span>r</span> <span>=</span> <span>(</span><span>threshold</span> <span>-</span> <span>a</span><span>[</span><span>dim</span><span>])</span> <span>/</span> <span>(</span><span>b</span><span>[</span><span>dim</span><span>]</span> <span>-</span> <span>a</span><span>[</span><span>dim</span><span>]);</span>

  <span>// Then, if we're splitting top/bottom we need two</span>
  <span>// points above and below our dividing line:</span>
  <span>if</span> <span>(</span><span>dim</span> <span>===</span> <span>0</span><span>)</span> <span>{</span>
    <span>const</span> <span>long</span> <span>=</span> <span>(</span><span>1</span> <span>-</span> <span>r</span><span>)</span> <span>*</span> <span>a</span><span>[</span><span>1</span><span>]</span> <span>+</span> <span>r</span> <span>*</span> <span>b</span><span>[</span><span>1</span><span>];</span>
    <span>// console.log(`splitting [0] with`, [threshold, long]);</span>
    <span>le</span><span>.</span><span>push</span><span>([</span><span>threshold</span><span>,</span> <span>long</span><span>]);</span>
    <span>gt</span><span>.</span><span>push</span><span>([</span><span>threshold</span> <span>+</span> <span>cm</span><span>,</span> <span>long</span><span>]);</span>
  <span>}</span>

  <span>// If we're not, then we're splitting left/right and we</span>
  <span>// need two points to the left and right of our divider:</span>
  <span>else</span> <span>{</span>
    <span>const</span> <span>lat</span> <span>=</span> <span>(</span><span>1</span> <span>-</span> <span>r</span><span>)</span> <span>*</span> <span>a</span><span>[</span><span>0</span><span>]</span> <span>+</span> <span>r</span> <span>*</span> <span>b</span><span>[</span><span>0</span><span>];</span>
    <span>// console.log(`splitting [1] with`, [lat, threshold]);</span>
    <span>le</span><span>.</span><span>push</span><span>([</span><span>lat</span><span>,</span> <span>threshold</span><span>]);</span>
    <span>gt</span><span>.</span><span>push</span><span>([</span><span>lat</span><span>,</span> <span>threshold</span> <span>+</span> <span>cm</span><span>]);</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And now we can query across degree lines just fine: if we load http://localhost:9000/?poly=47.1,-123.1,47.1,-124.8,48.8,-124.8,48.8,-123.1 we get:</p>

<div><pre><code>{
  "poly": [
    [47.1, -123.1],
    [47.1, -124.8],
    [48.8, -124.8],
    [48.8, -123.1]
  ],
  "result": {
    "lat": 47.80222222222222,
    "long": -123.7088888888889,
    "elevation": { "feet": 7911, "meter": 2411 },
    "resolution": 123.69
  },
  "ms": 26
}
</code></pre></div>

<p>And that’s still Mount Olympus, found in a 2 degree x 2 degree area (50,000 square kilometers), in only 26 milliseconds. I think we’re good to go in terms of plugging this into our autopilot for terrain follow purposes, given that that’s going to run every 500 milliseconds!</p>

<h3 id="putting-it-all-together">Putting it all together</h3>

<p>Let’s finally make this all work. First, let’s add some terrain mode related constant to <code>constants.js</code>:</p>

<div><pre><code><span>export</span> <span>const</span> <span>KNOTS_IN_KM_PER_MINUTE</span> <span>=</span> <span>0.0308667</span><span>;</span>
<span>export</span> <span>const</span> <span>TERRAIN_FOLLOW</span> <span>=</span> <span>`TER`</span><span>;</span>
<span>export</span> <span>const</span> <span>TERRAIN_FOLLOW_DATA</span> <span>=</span> <span>`TerrainFollowData`</span><span>;</span>
<span>export</span> <span>const</span> <span>TERRAIN_FOLLOW_SAFETY</span> <span>=</span> <span>500</span><span>;</span>
</code></pre></div>

<p>The first terrain value is the toggle for enabling/disabling terrain follow, and the second will let us send terrain information to clients so that we can visualize the area we’re working with, with the last value being used to determine how many feet to add to the max elevation in order to set our autopilot’s altitude hold value.</p>

<p>Next up, our <code>autopilot.js</code>:</p>

<div><pre><code><span>...</span>

<span>import</span> <span>{</span>
  <span>...</span>
  <span>TERRAIN_FOLLOW</span><span>,</span>
  <span>TERRAIN_FOLLOW_DATA</span><span>,</span>
<span>}</span> <span>from</span> <span>"</span><span>../utils/constants.js?t=2</span><span>"</span><span>;</span>

<span>...</span>

<span>// We'll implement this one next</span>
<span>let</span> <span>{</span> <span>terrainFollow</span> <span>}</span> <span>=</span> <span>await</span> <span>watch</span><span>(</span>
  <span>dirname</span><span>,</span>
  <span>`terrain-follow.js`</span><span>,</span>
  <span>(</span><span>lib</span><span>)</span> <span>=&gt;</span> <span>(</span><span>terrainFollow</span> <span>=</span> <span>lib</span><span>.</span><span>terrainFollow</span><span>)</span>
<span>);</span>

<span>...</span>

<span>export</span> <span>class</span> <span>AutoPilot</span> <span>{</span>
  <span>...</span>
  <span>reset</span><span>(</span><span>flightInformation</span><span>,</span> <span>flightInfoUpdateHandler</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>this</span><span>.</span><span>modes</span> <span>=</span> <span>{</span>
      <span>...</span>
      <span>[</span><span>TERRAIN_FOLLOW</span><span>]:</span> <span>false</span><span>,</span>
      <span>[</span><span>TERRAIN_FOLLOW_DATA</span><span>]:</span> <span>false</span><span>,</span>
    <span>};</span>
    <span>...</span>
  <span>}</span>

  <span>...</span>

  <span>async</span> <span>run</span><span>()</span> <span>{</span>
    <span>const</span> <span>{</span> <span>modes</span><span>,</span> <span>flightInformation</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>this</span><span>.</span><span>flightInfoUpdateHandler</span><span>(</span><span>await</span> <span>flightInformation</span><span>.</span><span>update</span><span>());</span>
    <span>try</span> <span>{</span>
      <span>...</span>
      <span>if</span> <span>(</span><span>modes</span><span>[</span><span>TERRAIN_FOLLOW</span><span>])</span> <span>terrainFollow</span><span>(</span><span>this</span><span>,</span> <span>flightInformation</span><span>);</span>
    <span>}</span> <span>catch</span> <span>(</span><span>e</span><span>)</span> <span>{</span>
      <span>console</span><span>.</span><span>warn</span><span>(</span><span>e</span><span>);</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>Nothing we haven’t done several times before already. So let’s write that <code>terrainFollow</code> function in <code>terrain-follow.js</code>:</p>

<div><pre><code><span>import</span> <span>{</span>
  <span>ALTITUDE_HOLD</span><span>,</span>
  <span>HEADING_MODE</span><span>,</span>
  <span>TERRAIN_FOLLOW_SAFETY</span><span>,</span>
  <span>TERRAIN_FOLLOW_DATA</span><span>,</span>
  <span>KNOTS_IN_KM_PER_MINUTE</span><span>,</span>
  <span>ENV_PATH</span><span>,</span>
<span>}</span> <span>from</span> <span>"</span><span>../utils/constants.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>getPointAtDistance</span> <span>}</span> <span>from</span> <span>"</span><span>../utils/utils.js</span><span>"</span><span>;</span>

<span>import</span> <span>dotenv</span> <span>from</span> <span>"</span><span>dotenv</span><span>"</span><span>;</span>
<span>dotenv</span><span>.</span><span>config</span><span>({</span> <span>path</span><span>:</span> <span>ENV_PATH</span> <span>});</span>

<span>const</span> <span>{</span> <span>DATA_FOLDER</span><span>,</span> <span>ALOS_PORT</span><span>:</span> <span>PORT</span> <span>}</span> <span>=</span> <span>process</span><span>.</span><span>env</span><span>;</span>
<span>import</span> <span>{</span> <span>ALOSInterface</span> <span>}</span> <span>from</span> <span>"</span><span>../elevation/alos-interface.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>ALOS_VOID_VALUE</span> <span>}</span> <span>from</span> <span>"</span><span>../elevation/alos-constants.js</span><span>"</span><span>;</span>
<span>const</span> <span>alos</span> <span>=</span> <span>new</span> <span>ALOSInterface</span><span>(</span><span>DATA_FOLDER</span><span>);</span>

<span>const</span> <span>{</span> <span>ceil</span> <span>}</span> <span>=</span> <span>Math</span><span>;</span>

<span>export</span> <span>async</span> <span>function</span> <span>terrainFollow</span><span>(</span><span>autopilot</span><span>,</span> <span>flightInformation</span><span>)</span> <span>{</span>
<span>const</span> <span>{</span> <span>modes</span><span>,</span> <span>waypoints</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>
  <span>const</span> <span>{</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>trueHeading</span><span>,</span> <span>speed</span><span>,</span> <span>declination</span> <span>}</span> <span>=</span> <span>flightInformation</span><span>.</span><span>data</span><span>;</span>
  <span>let</span> <span>maxElevation</span><span>,</span> <span>geoPolies</span><span>;</span>

  <span>// Because we want enough time to climb if it turns out we're</span>
  <span>// flying towards a mountain, we'll set a "probe length" that</span>
  <span>// extends 5 minutes ahead of us based on our current speed.</span>
  <span>const</span> <span>probeLength</span> <span>=</span> <span>speed</span> <span>*</span> <span>KNOTS_IN_KM_PER_MINUTE</span> <span>*</span> <span>5</span><span>;</span>

  <span>// Then, we either need to find the maximum elevation along</span>
  <span>// our flight path, if we have a flight plan loaded, or</span>
  <span>// just "ahead of us" if we're flying on autopilot without</span>
  <span>// a specific flight plan.</span>

  <span>// If we're on a flight plan, we'll let the waypoint manager</span>
  <span>// figure out the shape we're using, because it knows where</span>
  <span>// all the waypoints are.</span>
  <span>if</span> <span>(</span><span>waypoints</span><span>.</span><span>active</span><span>)</span> <span>{</span>
    <span>const</span> <span>result</span> <span>=</span> <span>waypoints</span><span>.</span><span>getMaxElevation</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>probeLength</span><span>);</span>
    <span>geoPolies</span> <span>=</span> <span>result</span><span>.</span><span>geoPolies</span><span>;</span>
    <span>maxElevation</span> <span>=</span> <span>result</span><span>.</span><span>maxElevation</span><span>;</span>
  <span>}</span>

  <span>// If not, we just project a triangle in front of us, with</span>
  <span>// a base that's 1km on either side of us, and a tip that's</span>
  <span>// simply the point 5 minutes ahaead of us:</span>
  <span>else</span> <span>{</span>
    <span>// Also note that "ahead" can either literally be in front</span>
    <span>// of us, but if the autopilot is flying a heading and we</span>
    <span>// change that heading the probe should be pointed in that</span>
    <span>// direction, not the one the plane is currently pointed in.</span>
    <span>let</span> <span>heading</span> <span>=</span> <span>trueHeading</span><span>;</span>
    <span>if</span> <span>(</span><span>modes</span><span>[</span><span>HEADING_MODE</span><span>])</span> <span>{</span>
      <span>heading</span> <span>=</span> <span>modes</span><span>[</span><span>HEADING_MODE</span><span>]</span> <span>+</span> <span>declination</span><span>;</span>
    <span>}</span>
    <span>const</span> <span>geoPoly</span> <span>=</span> <span>[</span>
      <span>getPointAtDistance</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>1</span><span>,</span> <span>heading</span> <span>-</span> <span>90</span><span>),</span>
      <span>getPointAtDistance</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>probeLength</span><span>,</span> <span>heading</span><span>),</span>
      <span>getPointAtDistance</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>1</span><span>,</span> <span>heading</span> <span>+</span> <span>90</span><span>),</span>
    <span>].</span><span>map</span><span>(({</span> <span>lat</span><span>,</span> <span>long</span> <span>})</span> <span>=&gt;</span> <span>[</span><span>lat</span><span>,</span> <span>long</span><span>]);</span>
    <span>geoPolies</span> <span>=</span> <span>[</span><span>geoPoly</span><span>];</span>
    <span>maxElevation</span> <span>=</span> <span>alos</span><span>.</span><span>getMaxElevation</span><span>(</span><span>geoPoly</span><span>);</span>
  <span>}</span>

  <span>// if this didn't yield elevation data (e.g. we're flying</span>
  <span>// over the ocean) just do nothing.</span>
  <span>const</span> <span>alt</span> <span>=</span> <span>maxElevation</span><span>.</span><span>elevation</span><span>.</span><span>feet</span><span>;</span>
  <span>if</span> <span>(</span><span>alt</span> <span>===</span> <span>ALOS_VOID_VALUE</span><span>)</span> <span>return</span><span>;</span>

  <span>// But if it did, set our autopilot to however many feet</span>
  <span>// we want to be above the max elevation, based on the</span>
  <span>// constant/ we declared earlier, and then round that up</span>
  <span>// to some multiple of 100 feet.</span>
  <span>const</span> <span>bracketed</span> <span>=</span> <span>TERRAIN_FOLLOW_SAFETY</span> <span>+</span> <span>ceil</span><span>(</span><span>alt</span> <span>/</span> <span>100</span><span>)</span> <span>*</span> <span>100</span><span>;</span>
  <span>autopilot</span><span>.</span><span>setParameters</span><span>({</span>
    <span>[</span><span>ALTITUDE_HOLD</span><span>]:</span> <span>bracketed</span><span>,</span>
    <span>// And for visualization purposes, also add the polygon(s)</span>
    <span>// that we used and the maximum elevation that we found.</span>
    <span>[</span><span>TERRAIN_FOLLOW_DATA</span><span>]:</span> <span>{</span>
      <span>geoPolies</span><span>,</span>
      <span>maxElevation</span><span>,</span>
    <span>},</span>
  <span>});</span>
<span>}</span>
</code></pre></div>

<p>Pretty straight-forward code, and even though we’ll want to implement <code>getMaxElevation</code> in our <code>waypoint-manager.js</code> eventually, we can test the non-flight-planned terrain follow mode right now!</p>

<p>…well, okay, almost right now, we still need to add that <code>getPointAtDistance</code> to our <code>utils.js</code>:</p>

<div><pre><code><span>// Get a point at distance {d}km relative to (lat,long)</span>
<span>export</span> <span>function</span> <span>getPointAtDistance</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>d</span><span>,</span> <span>heading</span><span>,</span> <span>R</span> <span>=</span> <span>6371</span><span>)</span> <span>{</span>
  <span>lat</span> <span>=</span> <span>radians</span><span>(</span><span>lat</span><span>);</span>
  <span>long</span> <span>=</span> <span>radians</span><span>(</span><span>long</span><span>);</span>
  <span>const</span> <span>a</span> <span>=</span> <span>radians</span><span>(</span><span>heading</span><span>);</span>
  <span>const</span> <span>lat2</span> <span>=</span> <span>asin</span><span>(</span><span>sin</span><span>(</span><span>lat</span><span>)</span> <span>*</span> <span>cos</span><span>(</span><span>d</span> <span>/</span> <span>R</span><span>)</span> <span>+</span> <span>cos</span><span>(</span><span>lat</span><span>)</span> <span>*</span> <span>sin</span><span>(</span><span>d</span> <span>/</span> <span>R</span><span>)</span> <span>*</span> <span>cos</span><span>(</span><span>a</span><span>));</span>
  <span>const</span> <span>dx</span> <span>=</span> <span>cos</span><span>(</span><span>d</span> <span>/</span> <span>R</span><span>)</span> <span>-</span> <span>sin</span><span>(</span><span>lat</span><span>)</span> <span>*</span> <span>sin</span><span>(</span><span>lat2</span><span>);</span>
  <span>const</span> <span>dy</span> <span>=</span> <span>sin</span><span>(</span><span>a</span><span>)</span> <span>*</span> <span>sin</span><span>(</span><span>d</span> <span>/</span> <span>R</span><span>)</span> <span>*</span> <span>cos</span><span>(</span><span>lat</span><span>);</span>
  <span>const</span> <span>long2</span> <span>=</span> <span>long</span> <span>+</span> <span>atan2</span><span>(</span><span>dy</span><span>,</span> <span>dx</span><span>);</span>
  <span>return</span> <span>{</span> <span>lat</span><span>:</span> <span>degrees</span><span>(</span><span>lat2</span><span>),</span> <span>long</span><span>:</span> <span>degrees</span><span>(</span><span>long2</span><span>)</span> <span>};</span>
<span>}</span>
</code></pre></div>

<p>And update our browser page, starting with <code>autopilot.html</code> so we have a button to press:</p>

<div><pre><code><span>&lt;div</span> <span>class=</span><span>"controls"</span><span>&gt;</span>
  ...
  <span>&lt;button</span> <span>title=</span><span>"altitude hold"</span> <span>class=</span><span>"ALT"</span><span>&gt;</span>ALT<span>&lt;/button&gt;</span>
  <span>&lt;button</span> <span>title=</span><span>"terrain follow"</span> <span>class=</span><span>"TER"</span><span>&gt;</span>TER<span>&lt;/button&gt;</span>
  ...
<span>&lt;/div&gt;</span>
</code></pre></div>

<p>and our <code>public/js/autopilot.js</code> so that button also actually does something:</p>

<div><pre><code><span>...</span>

<span>export</span> <span>const</span> <span>AP_OPTIONS</span> <span>=</span> <span>{</span>
  <span>...</span>
  <span>TER</span><span>:</span> <span>false</span><span>,</span>
<span>};</span>
</code></pre></div>

<p>And some extra code that visualizes elevation polygons as well as showing the spot where the max elevation was found:</p>

<div><pre><code><span>export</span> <span>class</span> <span>Autopilot</span> <span>{</span>
  <span>constructor</span><span>(</span><span>owner</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>owner</span> <span>=</span> <span>owner</span><span>;</span>
    <span>this</span><span>.</span><span>map</span> <span>=</span> <span>owner</span><span>.</span><span>map</span><span>;</span>
    <span>...</span>
  <span>}</span>

  <span>...</span>

  <span>update</span><span>(</span><span>flightData</span><span>,</span> <span>params</span><span>)</span> <span>{</span>
    <span>...</span>

    <span>// Remove any previously visualized terrain polygons</span>
    <span>if</span> <span>(</span><span>this</span><span>.</span><span>terrainProbe</span><span>)</span> <span>this</span><span>.</span><span>terrainProbe</span><span>.</span><span>forEach</span><span>((</span><span>p</span><span>)</span> <span>=&gt;</span> <span>p</span><span>.</span><span>remove</span><span>());</span>

    <span>// And the marker for where the maximum elevation was found</span>
    <span>if</span> <span>(</span><span>this</span><span>.</span><span>maxElevation</span><span>)</span> <span>this</span><span>.</span><span>maxElevation</span><span>.</span><span>remove</span><span>();</span>

    <span>// Then see if we need to build new ones:</span>
    <span>const</span> <span>{</span> <span>TerrainFollowData</span><span>:</span> <span>data</span><span>,</span> <span>TER</span> <span>}</span> <span>=</span> <span>params</span><span>;</span>
    <span>if</span> <span>(</span><span>TER</span> <span>&amp;&amp;</span> <span>data</span><span>)</span> <span>{</span>
      <span>const</span> <span>{</span> <span>maxElevation</span><span>,</span> <span>geoPolies</span> <span>}</span> <span>=</span> <span>data</span><span>;</span>

      <span>// Draw all polygons used in finding our maximum elevation</span>
      <span>this</span><span>.</span><span>terrainProbe</span> <span>=</span> <span>geoPolies</span><span>.</span><span>map</span><span>((</span><span>coords</span><span>)</span> <span>=&gt;</span>
        <span>L</span><span>.</span><span>polyline</span><span>([...</span><span>coords</span><span>,</span> <span>coords</span><span>[</span><span>0</span><span>]],</span> <span>{</span>
          <span>className</span><span>:</span> <span>`terrain-probe`</span><span>,</span>
          <span>fill</span><span>:</span> <span>true</span><span>,</span>
        <span>})</span>
      <span>);</span>

      <span>this</span><span>.</span><span>terrainProbe</span><span>.</span><span>forEach</span><span>((</span><span>p</span><span>)</span> <span>=&gt;</span> <span>p</span><span>.</span><span>addTo</span><span>(</span><span>this</span><span>.</span><span>map</span><span>));</span>

      <span>// And then draw the GPS coordinate where we found that value.</span>
      <span>this</span><span>.</span><span>maxElevation</span> <span>=</span> <span>L</span><span>.</span><span>circle</span><span>([</span><span>maxElevation</span><span>.</span><span>lat</span><span>,</span> <span>maxElevation</span><span>.</span><span>long</span><span>],</span> <span>100</span><span>,</span> <span>{</span>
        <span>color</span><span>:</span> <span>`black`</span><span>,</span>
        <span>fill</span><span>:</span> <span>true</span><span>,</span>
      <span>});</span>

      <span>// With a handy little tooltip that lists the exact elevation found.</span>
      <span>this</span><span>.</span><span>maxElevation</span><span>.</span><span>bindTooltip</span><span>(</span><span>maxElevation</span><span>.</span><span>elevation</span><span>.</span><span>feet</span> <span>+</span> <span>`'`</span><span>,</span> <span>{</span>
        <span>permanent</span><span>:</span> <span>true</span><span>,</span>
        <span>direction</span><span>:</span> <span>"</span><span>top</span><span>"</span><span>,</span>
        <span>offset</span><span>:</span> <span>L</span><span>.</span><span>point</span><span>({</span><span>x</span><span>:</span> <span>0</span><span>,</span> <span>y</span><span>:</span> <span>-</span><span>20</span><span>})</span>
      <span>});</span>

      <span>this</span><span>.</span><span>maxElevation</span><span>.</span><span>addTo</span><span>(</span><span>this</span><span>.</span><span>map</span><span>);</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>Then we just need a tiny bit of CSS in our <code>public/css/autopilot.css</code> that makes our “probe polies” stand out:</p>

<div><pre><code><span>#autopilot</span> <span>{</span>
  <span>margin</span><span>:</span> <span>0.5em</span> <span>0</span><span>;</span>
<span>}</span>

<span>/* We'll use a nice and loud colour for this: */</span>
<span>.terrain-probe</span> <span>{</span>
  <span>stroke</span><span>:</span> <span>#00ffc8</span><span>;</span>
  <span>fill</span><span>:</span> <span>#00ffc8</span><span>;</span>
<span>}</span>

<span>/*
  Also: when terrain follow is enabled, we hide the  waypoint marker
  elevation indicators, because they're not actually getting used.
*/</span>
<span>body</span><span>:has</span><span>(</span><span>.TER.active</span><span>)</span> <span>.waypoint-div</span><span>::before</span> <span>{</span>
  <span>content</span><span>:</span> <span>""</span><span>;</span>
<span>}</span>
</code></pre></div>

<p>And that’s it: let’s fire up a flight and turn on terrain follow!</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240209135510306.png" alt="image-20240209135510306"></p>

<p>We see our elevation probe (correctly pointing in the direction of the autopilot), starting at 2km wide (1km on either side of the plane) and ending at a tip a the 5 minute flight’s worth of distance away from the plane. The highest elevation covered by our probe is the peak of <a href="https://en.wikipedia.org/wiki/Mount_Maxwell_Provincial_Park">Mount Maxwell</a> on <a href="https://en.wikipedia.org/wiki/Salt_Spring_Island">Salt Spring Island</a>. Since the elevation found is 2002 feet, the autopilot altitude hold value is 2600: 2002 plus 500, rounded up to a multiple of 100.</p>

<p>We could let the plane fly forever and it wouldn’t crash into anything! …well, until it runs out of fuel, of course. But there’s a setting for infinite fuel, so…!</p>

<h3 id="elevation-along-a-flight-path">Elevation along a flight path</h3>

<p>Of course we still need to implement the elevation code for when we’re flying with a flight plan: rather than a single polygon, that “5 minutes of flight distance” might cover multiple full and partial legs of the flight, so we’ll need some code that:</p>

<ol>
  <li>can chop up our “probe distance” into a set of distances, each related to a different leg of the flight plan,</li>
  <li>can create polygons for each of those distances,</li>
  <li>can find the max elevation inside each of those polygons, and</li>
  <li>can return the highest value amongst those results.</li>
</ol>

<p>We’ve already seen 2 through 4 in code we literally just wrote, leaving us with only the first point to solve, which we can break down into three separate problems:</p>

<ol>
  <li>finding the distance from the plane to the waypoint it’s currently flying towards,</li>
  <li>if that distance is less than the probe length: finding how many complete legs after that waypoint are fully covered by our probe length minus the distance found in 1 (which might be zero),</li>
  <li>if there is a next leg, finding out how much of that legs the remaining probe length covers, or</li>
  <li>if there is no next leg, just “finishing the shape” by drawing a shorter-than-full-length triangle in the direction that we’ll be flying in at that point.</li>
</ol>

<p>The nice thing about breaking down the problem is that none of these tasks, individually, is particularly complicated. And once they all work, simply putting them together means we’ll have our full solution.</p>

<h4 id="finding-the-distance-from-the-plane-to-its-next-waypoint">Finding the distance from the plane to its next waypoint</h4>

<p>This one’s pretty easy. If we’re flying a flight plan, we’re either flying towards the current waypoint (when we’re still getting onto the flight path, as well as any time we’re close enough to a waypoint to effect a transition), or we’re flying towards the waypoint after it, so let’s find out which of those it is:</p>

<div><pre><code><span>export</span> <span>class</span> <span>WayPointManager</span> <span>{</span>
  <span>...</span>
  <span>getMaxElevation</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>probeLength</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>currentWaypoint</span><span>:</span> <span>c</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>let</span> <span>maxElevation</span> <span>=</span> <span>{</span> <span>elevation</span><span>:</span> <span>{</span> <span>meter</span><span>:</span> <span>ALOS_VOID_VALUE</span> <span>}</span> <span>};</span>
    <span>let</span> <span>geoPolies</span> <span>=</span> <span>[];</span>
    <span>let</span> <span>current</span> <span>=</span> <span>c</span><span>;</span>
    <span>let</span> <span>heading</span> <span>=</span> <span>c</span><span>.</span><span>heading</span><span>;</span>

    <span>// Let's figure out which waypoint the plane is flying towards.</span>
    <span>let</span> <span>target</span> <span>=</span> <span>current</span><span>.</span><span>next</span><span>;</span>

   	<span>// Get the distance from the plane to the next waypoint,</span>
    <span>const</span> <span>d1</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>target</span><span>.</span><span>lat</span><span>,</span> <span>target</span><span>.</span><span>long</span><span>);</span>

    <span>// As well as the distance from the current waypoint to the next waypoint.</span>
    <span>const</span> <span>d2</span> <span>=</span> <span>target</span><span>.</span><span>distance</span> <span>*</span> <span>KM_PER_NM</span><span>;</span>

    <span>// If the plane is further from current.next than current itself is,</span>
    <span>// then our target is the current waypoint instead of the next.</span>
    <span>if</span> <span>(</span><span>d1</span> <span>&gt;</span> <span>d2</span><span>)</span> <span>{</span>
      <span>// Sweet: we found it.</span>
    <span>}</span>
</code></pre></div>

<p>When this happens, we want to make sure to capture a strip of flight path that’s 2km wide and runs from our plane to the waypoint we’re targeting:</p>

<div><pre><code>    <span>if</span> <span>(</span><span>d1</span> <span>&gt;</span> <span>d2</span><span>)</span> <span>{</span>
      <span>// Form a 2km wide strip along the flight path:</span>
      <span>const</span> <span>h</span> <span>=</span> <span>getHeadingFromTo</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>current</span><span>.</span><span>lat</span><span>,</span> <span>current</span><span>.</span><span>long</span><span>);</span>
      <span>const</span> <span>geoPoly</span> <span>=</span> <span>[</span>
        <span>getPointAtDistance</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>1</span><span>,</span> <span>h</span> <span>-</span> <span>90</span><span>),</span>
        <span>getPointAtDistance</span><span>(</span><span>current</span><span>.</span><span>lat</span><span>,</span> <span>current</span><span>.</span><span>long</span><span>,</span> <span>1</span><span>,</span> <span>h</span> <span>-</span> <span>90</span><span>),</span>
        <span>getPointAtDistance</span><span>(</span><span>current</span><span>.</span><span>lat</span><span>,</span> <span>current</span><span>.</span><span>long</span><span>,</span> <span>1</span><span>,</span> <span>h</span> <span>+</span> <span>90</span><span>),</span>
        <span>getPointAtDistance</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>1</span><span>,</span> <span>h</span> <span>+</span> <span>90</span><span>),</span>
      <span>].</span><span>map</span><span>(({</span> <span>lat</span><span>,</span> <span>long</span> <span>})</span> <span>=&gt;</span> <span>[</span><span>lat</span><span>,</span> <span>long</span><span>]);</span>

      <span>// Then find the max elevation in that strip:</span>
      <span>const</span> <span>partialMax</span> <span>=</span> <span>alos</span><span>.</span><span>getMaxElevation</span><span>(</span><span>geoPoly</span><span>);</span>
      <span>if</span> <span>(</span><span>maxElevation</span><span>.</span><span>elevation</span><span>.</span><span>meter</span> <span>&lt;</span> <span>partialMax</span><span>.</span><span>elevation</span><span>.</span><span>meter</span><span>)</span> <span>{</span>
        <span>maxElevation</span> <span>=</span> <span>partialMax</span><span>;</span>
      <span>}</span>

      <span>// Then save the shape we just used so we can send it to the browser:</span>
      <span>geoPolies</span><span>.</span><span>push</span><span>(</span><span>geoPoly</span><span>);</span>

      <span>// And then as last step, reduce our probe length by the length of our strip:</span>
      <span>const</span> <span>d</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>current</span><span>.</span><span>lat</span><span>,</span> <span>current</span><span>.</span><span>long</span><span>);</span>
      <span>probeLength</span> <span>-=</span> <span>d</span><span>;</span>
    <span>}</span>
</code></pre></div>

<p>And with that, we’ve solved the “if we’re not on the flight path yet” part of the problem</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240209144406788.png" alt="image-20240209144406788"></p>

<p>Though we’re going to have to massage that just a <em>tiny</em> bit because if the first waypoint on a flight plan is far away from us, we don’t want to check the entire length of the distance for a max elevation. We still only want to only check up to a distance of <code>probeLength</code>:</p>

<div><pre><code>      <span>if</span> <span>(</span><span>d1</span> <span>&gt;</span> <span>d2</span><span>)</span> <span>{</span>
        <span>const</span> <span>h</span> <span>=</span> <span>...</span>
        <span>// what's our distance to this target?</span>
        <span>const</span> <span>d</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>current</span><span>.</span><span>lat</span><span>,</span> <span>current</span><span>.</span><span>long</span><span>);</span>
        <span>// and what's the point ahead of us by probeLength?</span>
        <span>const</span> <span>f</span> <span>=</span> <span>getPointAtDistance</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>probeLength</span><span>,</span> <span>h</span><span>);</span>
        <span>// Is our waypoint further away than we need for elevation purposes?</span>
        <span>// If so, don't build out our elevation polygon to "the current</span>
        <span>// waypoint", but only build it out to probeLength ahead of us.</span>
        <span>const</span> <span>c</span> <span>=</span> <span>d</span> <span>&gt;</span> <span>probeLength</span> <span>?</span> <span>f</span> <span>:</span> <span>current</span><span>;</span>
        <span>const</span> <span>geoPoly</span> <span>=</span> <span>[</span>
          <span>getPointAtDistance</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>1</span><span>,</span> <span>h</span> <span>-</span> <span>90</span><span>),</span>
          <span>getPointAtDistance</span><span>(</span><span>c</span><span>.</span><span>lat</span><span>,</span> <span>c</span><span>.</span><span>long</span><span>,</span> <span>1</span><span>,</span> <span>h</span> <span>-</span> <span>90</span><span>),</span>
          <span>getPointAtDistance</span><span>(</span><span>c</span><span>.</span><span>lat</span><span>,</span> <span>c</span><span>.</span><span>long</span><span>,</span> <span>1</span><span>,</span> <span>h</span> <span>+</span> <span>90</span><span>),</span>
          <span>getPointAtDistance</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>1</span><span>,</span> <span>h</span> <span>+</span> <span>90</span><span>),</span>
        <span>].</span><span>map</span><span>(...);</span>
        <span>...</span>
      <span>}</span>
</code></pre></div>

<p>And now, rather than a “probe polygon” that runs all the way from our plane to the first waypoint, even if that distance is half the world away, we’ll only use a polygon that’s (at most) five minutes long.</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240213171035696.png" alt="image-20240213171035696"></p>

<p>So let’s move on to the “if we <em>are</em> on the flight path” equivalent. If we’re on the flight path, then the distances we used in the above check don’t really apply: the distance between the plane and the end point of the leg is (by definition, really) always less than the distance between the two end points, so we’re going to simply iterate over each leg, and if that’s the one we’re currently one, we form a partial “strip”:</p>

<div><pre><code>    <span>if</span> <span>(</span><span>d1</span> <span>&gt;</span> <span>d2</span><span>)</span> <span>{</span>
      <span>...</span>
    <span>}</span>


    <span>// Iterate through our flight plan legs for as long as there is a next</span>
    <span>// point to fly, and we haven't run out of probe length yet.</span>
    <span>while</span> <span>(</span><span>target</span> <span>&amp;&amp;</span> <span>probeLength</span> <span>&gt;</span> <span>0</span><span>)</span> <span>{</span>
      <span>const</span> <span>d</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>target</span><span>.</span><span>lat</span><span>,</span> <span>target</span><span>.</span><span>long</span><span>);</span>
      <span>// If d &lt; probeLength, our probe will cover either the entire leg, or</span>
      <span>// the entire "remainder" of the leg, if it's the one we're flying, so...</span>
      <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>probeLength</span><span>)</span> <span>{</span>

        <span>// *Is* this the leg we are current flying?</span>
        <span>if</span> <span>(</span><span>target</span> <span>===</span> <span>c</span><span>.</span><span>next</span><span>)</span> <span>{</span>
          <span>const</span> <span>g</span> <span>=</span> <span>current</span><span>.</span><span>geoPoly</span><span>.</span><span>slice</span><span>();</span>
          <span>const</span> <span>r</span> <span>=</span> <span>constrain</span><span>(</span><span>d</span> <span>/</span> <span>(</span><span>target</span><span>.</span><span>distance</span> <span>*</span> <span>KM_PER_NM</span><span>),</span> <span>-</span><span>1</span><span>,</span> <span>1</span><span>);</span>
          <span>g</span><span>[</span><span>0</span><span>]</span> <span>=</span> <span>[</span>
            <span>r</span> <span>*</span> <span>g</span><span>[</span><span>0</span><span>][</span><span>0</span><span>]</span> <span>+</span> <span>(</span><span>1</span> <span>-</span> <span>r</span><span>)</span> <span>*</span> <span>g</span><span>[</span><span>1</span><span>][</span><span>0</span><span>],</span>
            <span>r</span> <span>*</span> <span>g</span><span>[</span><span>0</span><span>][</span><span>1</span><span>]</span> <span>+</span> <span>(</span><span>1</span> <span>-</span> <span>r</span><span>)</span> <span>*</span> <span>g</span><span>[</span><span>1</span><span>][</span><span>1</span><span>],</span>
          <span>];</span>
          <span>g</span><span>[</span><span>3</span><span>]</span> <span>=</span> <span>[</span>
            <span>r</span> <span>*</span> <span>g</span><span>[</span><span>3</span><span>][</span><span>0</span><span>]</span> <span>+</span> <span>(</span><span>1</span> <span>-</span> <span>r</span><span>)</span> <span>*</span> <span>g</span><span>[</span><span>2</span><span>][</span><span>0</span><span>],</span>
            <span>r</span> <span>*</span> <span>g</span><span>[</span><span>3</span><span>][</span><span>1</span><span>]</span> <span>+</span> <span>(</span><span>1</span> <span>-</span> <span>r</span><span>)</span> <span>*</span> <span>g</span><span>[</span><span>2</span><span>][</span><span>1</span><span>],</span>
          <span>];</span>
          <span>geoPolies</span><span>.</span><span>push</span><span>(</span><span>g</span><span>);</span>
          <span>const</span> <span>partialMax</span> <span>=</span> <span>alos</span><span>.</span><span>getMaxElevation</span><span>(</span><span>g</span><span>);</span>
          <span>if</span> <span>(</span><span>maxElevation</span><span>.</span><span>elevation</span><span>.</span><span>meter</span> <span>&lt;</span> <span>partialMax</span><span>.</span><span>elevation</span><span>.</span><span>meter</span><span>)</span> <span>{</span>
            <span>maxElevation</span> <span>=</span> <span>partialMax</span><span>;</span>
          <span>}</span>
        <span>}</span>

        <span>// If it's not, then we find the max elevation along</span>
        <span>// the entire length of this leg's "strip":</span>
        <span>else</span> <span>{</span>
          <span>// which we'll do in the next section.</span>
        <span>}</span>
      <span>}</span>

      <span>// If d &gt; probeLength, then our probe ends somewhere inside this leg,</span>
      <span>// and we'll need to figure out where that is.</span>
      <span>else</span> <span>{</span>
        <span>// which we'll do in the section after the next one.</span>
      <span>}</span>

      <span>// also, as we're iterating remember to decrease the "remaining probelenght",</span>
      <span>probeLength</span> <span>-=</span> <span>d</span><span>;</span>

      <span>// and update our iteration values.</span>
      <span>heading</span> <span>=</span> <span>current</span><span>.</span><span>heading</span><span>;</span>
      <span>current</span> <span>=</span> <span>target</span><span>;</span>
      <span>target</span> <span>=</span> <span>current</span><span>.</span><span>next</span><span>;</span>
    <span>}</span>
</code></pre></div>

<p>This code has three possible branches, one of which is the one we wanted to implement here, and the other two we’ll look at in the next sections. For now, let’s focus on building our “partial leg” polygon: you may notice that we’re starting with <code>const g = current.geoPoly.slice()</code>: since legs on a flightpath are fixed until we move a waypoint, it makes sense to have waypoints cache their associated polygon and max elevation:</p>

<div><pre><code><span>import</span> <span>{</span> <span>getDistanceBetweenPoints</span><span>,</span> <span>getHeadingFromTo</span><span>,</span> <span>getPointAtDistance</span> <span>}</span> <span>from</span> <span>"</span><span>../../utils/utils.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>KM_PER_NM</span><span>,</span> <span>ENV_PATH</span> <span>}</span> <span>from</span> <span>"</span><span>../../utils/constants.js</span><span>"</span><span>;</span>

<span>import</span> <span>dotenv</span> <span>from</span> <span>"</span><span>dotenv</span><span>"</span><span>;</span>
<span>dotenv</span><span>.</span><span>config</span><span>({</span> <span>path</span><span>:</span> <span>ENV_PATH</span> <span>});</span>
<span>const</span> <span>{</span> <span>DATA_FOLDER</span><span>,</span> <span>ALOS_PORT</span><span>:</span> <span>PORT</span> <span>}</span> <span>=</span> <span>process</span><span>.</span><span>env</span><span>;</span>

<span>import</span> <span>{</span> <span>ALOSInterface</span> <span>}</span> <span>from</span> <span>"</span><span>../../elevation/alos-interface.js</span><span>"</span><span>;</span>
<span>const</span> <span>alos</span> <span>=</span> <span>new</span> <span>ALOSInterface</span><span>(</span><span>DATA_FOLDER</span><span>);</span>

<span>export</span> <span>class</span> <span>Waypoint</span> <span>{</span>
  <span>...</span>

  <span>// When we set a next waypoint, this waypoint can immediately determine</span>
  <span>// the elevation polygon that results in, and find the associated max elevation:</span>
  <span>setNext</span><span>(</span><span>nextWaypoint</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>lat</span><span>,</span> <span>long</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>const</span> <span>next</span> <span>=</span> <span>(</span><span>this</span><span>.</span><span>next</span> <span>=</span> <span>nextWaypoint</span><span>);</span>
    <span>if</span> <span>(</span><span>next</span><span>)</span> <span>{</span>
      <span>this</span><span>.</span><span>heading</span> <span>=</span> <span>getHeadingFromTo</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>next</span><span>.</span><span>lat</span><span>,</span> <span>next</span><span>.</span><span>long</span><span>);</span>
      <span>next</span><span>.</span><span>distance</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>next</span><span>.</span><span>lat</span><span>,</span> <span>next</span><span>.</span><span>long</span><span>)</span> <span>/</span> <span>KM_PER_NM</span><span>;</span>
      <span>this</span><span>.</span><span>findMaxElevation</span><span>();</span>
    <span>}</span>
  <span>}</span>

  <span>async</span> <span>findMaxElevation</span><span>()</span> <span>{</span>
    <span>const</span> <span>{</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>heading</span><span>,</span> <span>next</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>this</span><span>.</span><span>geoPoly</span> <span>=</span> <span>[</span>
      <span>getPointAtDistance</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>1</span><span>,</span> <span>heading</span> <span>-</span> <span>90</span><span>),</span>
      <span>getPointAtDistance</span><span>(</span><span>next</span><span>.</span><span>lat</span><span>,</span> <span>next</span><span>.</span><span>long</span><span>,</span> <span>1</span><span>,</span> <span>heading</span> <span>-</span> <span>90</span><span>),</span>
      <span>getPointAtDistance</span><span>(</span><span>next</span><span>.</span><span>lat</span><span>,</span> <span>next</span><span>.</span><span>long</span><span>,</span> <span>1</span><span>,</span> <span>heading</span> <span>+</span> <span>90</span><span>),</span>
      <span>getPointAtDistance</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>1</span><span>,</span> <span>heading</span> <span>+</span> <span>90</span><span>),</span>
    <span>].</span><span>map</span><span>(({</span> <span>lat</span><span>,</span> <span>long</span> <span>})</span> <span>=&gt;</span> <span>[</span><span>lat</span><span>,</span> <span>long</span><span>]);</span>
    <span>this</span><span>.</span><span>maxElevation</span> <span>=</span> <span>alos</span><span>.</span><span>getMaxElevation</span><span>(</span><span>this</span><span>.</span><span>geoPoly</span><span>);</span>
  <span>}</span>

  <span>...</span>
<span>}</span>
</code></pre></div>

<p>Pretty simple, and that save us a <em>lot</em> of computation. Back to our waypoint manager though: <code>current.geoPoly.slice()</code> gets us a copy of the full leg’s polygon, but it has the wrong start points for our need, so we replace those by figuring out how far along the leg we are, expressed as a ratio, which we then use to create new start points for our polygon. For instance, if we’re midway between the start and end points, then the ratio is 0.5, and we create two new points that are 0.5 interpolations of the original start and end points.</p>

<p>And that covers our second possible “start of the probe”:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240209150737514.png" alt="image-20240209150737514"></p>

<h4 id="finding-the-number-of-legs-that-are-fully-covered">Finding the number of legs that are fully covered</h4>

<p>Next up, how many legs are fully covered by the remaining probe length? We already saw the scaffolding for this in the previous section, and our waypoints already cache full-length polygons and max elevations, so this’ll be a quick bit of code:</p>

<div><pre><code>    <span>while</span> <span>(</span><span>target</span> <span>&amp;&amp;</span> <span>probeLength</span> <span>&gt;</span> <span>0</span><span>)</span> <span>{</span>
      <span>const</span> <span>d</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>target</span><span>.</span><span>lat</span><span>,</span> <span>target</span><span>.</span><span>long</span><span>);</span>

      <span>// If d &lt; probeLength, our probe will cover either the entire leg, or</span>
      <span>// the entire "remainder" of the leg, if it's the one we're flying, so...</span>
      <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>probeLength</span><span>)</span> <span>{</span>
        <span>if</span> <span>(</span><span>target</span> <span>===</span> <span>c</span><span>.</span><span>next</span><span>)</span> <span>{</span>
          <span>...</span>
        <span>}</span>

        <span>// If it's not, then we find the max elevation along the entire</span>
        <span>// length of this leg's "strip", which really just means asking</span>
        <span>// the current waypoint for its already cached polygon and elevation:</span>
        <span>else</span> <span>{</span>
          <span>geoPolies</span><span>.</span><span>push</span><span>(</span><span>current</span><span>.</span><span>geoPoly</span><span>);</span>
          <span>if</span> <span>(</span><span>maxElevation</span><span>.</span><span>elevation</span><span>.</span><span>meter</span> <span>&lt;</span> <span>current</span><span>.</span><span>maxElevation</span><span>.</span><span>elevation</span><span>.</span><span>meter</span><span>)</span> <span>{</span>
            <span>maxElevation</span> <span>=</span> <span>current</span><span>.</span><span>maxElevation</span><span>;</span>
          <span>}</span>
        <span>}</span>
      <span>}</span>

      <span>// If d &gt; probeLength, then our probe ends somewhere inside this leg,</span>
      <span>// and we'll need to figure out where that is.</span>
      <span>else</span> <span>{</span>
        <span>// which we'll do in the next section.</span>
      <span>}</span>

      <span>...</span>
    <span>}</span>
</code></pre></div>

<p>Another part of the problem tackled!</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240209151217476.png" alt="image-20240209151217476"></p>

<h4 id="finding-how-much-of-the-leg-after-that-to-cover">Finding how much of the leg after that to cover</h4>

<p>Which brings us to the final bit of this code, which is really just “the reverse of the first bit”:</p>

<div><pre><code>    <span>while</span> <span>(</span><span>target</span> <span>&amp;&amp;</span> <span>probeLength</span> <span>&gt;</span> <span>0</span><span>)</span> <span>{</span>
      <span>const</span> <span>d</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>target</span><span>.</span><span>lat</span><span>,</span> <span>target</span><span>.</span><span>long</span><span>);</span>

      <span>// If d &lt; probeLength, our probe will cover either the entire leg, or</span>
      <span>// the entire "remainder" of the leg, if it's the one we're flying, so...</span>
      <span>if</span> <span>(</span><span>d</span> <span>&lt;</span> <span>probeLength</span><span>)</span> <span>{</span>
        <span>...</span>
      <span>}</span>

      <span>// If d &gt; probeLength, then our probe ends somewhere inside this leg,</span>
      <span>// and we'll need to figure out where that is.</span>
      <span>else</span> <span>{</span>
        <span>const</span> <span>g</span> <span>=</span> <span>current</span><span>.</span><span>geoPoly</span><span>.</span><span>slice</span><span>();</span>
        <span>const</span> <span>r</span> <span>=</span> <span>probeLength</span> <span>/</span> <span>d</span><span>;</span>
        <span>g</span><span>[</span><span>1</span><span>]</span> <span>=</span> <span>[</span>
          <span>(</span><span>1</span> <span>-</span> <span>r</span><span>)</span> <span>*</span> <span>g</span><span>[</span><span>0</span><span>][</span><span>0</span><span>]</span> <span>+</span> <span>r</span> <span>*</span> <span>g</span><span>[</span><span>1</span><span>][</span><span>0</span><span>],</span>
          <span>(</span><span>1</span> <span>-</span> <span>r</span><span>)</span> <span>*</span> <span>g</span><span>[</span><span>0</span><span>][</span><span>1</span><span>]</span> <span>+</span> <span>r</span> <span>*</span> <span>g</span><span>[</span><span>1</span><span>][</span><span>1</span><span>],</span>
        <span>];</span>
        <span>g</span><span>[</span><span>2</span><span>]</span> <span>=</span> <span>[</span>
          <span>(</span><span>1</span> <span>-</span> <span>r</span><span>)</span> <span>*</span> <span>g</span><span>[</span><span>3</span><span>][</span><span>0</span><span>]</span> <span>+</span> <span>r</span> <span>*</span> <span>g</span><span>[</span><span>2</span><span>][</span><span>0</span><span>],</span>
          <span>(</span><span>1</span> <span>-</span> <span>r</span><span>)</span> <span>*</span> <span>g</span><span>[</span><span>3</span><span>][</span><span>1</span><span>]</span> <span>+</span> <span>r</span> <span>*</span> <span>g</span><span>[</span><span>2</span><span>][</span><span>1</span><span>],</span>
        <span>];</span>
        <span>geoPolies</span><span>.</span><span>push</span><span>(</span><span>g</span><span>);</span>
        <span>const</span> <span>partialMax</span> <span>=</span> <span>alos</span><span>.</span><span>getMaxElevation</span><span>(</span><span>g</span><span>);</span>
        <span>if</span> <span>(</span><span>maxElevation</span><span>.</span><span>elevation</span><span>.</span><span>meter</span> <span>&lt;</span> <span>partialMax</span><span>.</span><span>elevation</span><span>.</span><span>meter</span><span>)</span> <span>{</span>
          <span>maxElevation</span> <span>=</span> <span>partialMax</span><span>;</span>
        <span>}</span>
      <span>}</span>

      <span>...</span>
    <span>}</span>
</code></pre></div>

<p>We again start with the full-length poly, but this time we need to bring the end points in towards the start, based on how much probe length we have left. Pretty much a straight copy paste, but this time updating <code>g[1]</code> and <code>g[2]</code>, rather than <code>g[0]</code> and <code>g[3]</code>. Boom, problem solved!</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240209151840268.png" alt="image-20240209151840268"></p>

<h4 id="building-a-triangle-if-there-is-no-next-leg">Building a triangle if there is no next leg</h4>

<p>Except for when there is no next leg, of course:</p>

<div><pre><code>    <span>while</span> <span>(</span><span>target</span> <span>&amp;&amp;</span> <span>probeLength</span> <span>&gt;</span> <span>0</span><span>)</span> <span>{</span>
      <span>...</span>
    <span>}</span>

    <span>// If we've run out legs, but we still have probe length left over,</span>
    <span>// just build a triangle with a base that starts at the last waypoint</span>
    <span>// we have, and a tip that's at a distance equal to whatever probe</span>
    <span>// length we have left.</span>
    <span>if</span> <span>(</span><span>probeLength</span> <span>&gt;</span> <span>0</span><span>)</span> <span>{</span>
      <span>const</span> <span>geoPoly</span> <span>=</span> <span>[</span>
        <span>getPointAtDistance</span><span>(</span><span>current</span><span>.</span><span>lat</span><span>,</span> <span>current</span><span>.</span><span>long</span><span>,</span> <span>1</span><span>,</span> <span>heading</span> <span>-</span> <span>90</span><span>),</span>
        <span>getPointAtDistance</span><span>(</span><span>current</span><span>.</span><span>lat</span><span>,</span> <span>current</span><span>.</span><span>long</span><span>,</span> <span>probeLength</span><span>,</span> <span>heading</span><span>),</span>
        <span>getPointAtDistance</span><span>(</span><span>current</span><span>.</span><span>lat</span><span>,</span> <span>current</span><span>.</span><span>long</span><span>,</span> <span>1</span><span>,</span> <span>heading</span> <span>+</span> <span>90</span><span>),</span>
      <span>].</span><span>map</span><span>(({</span> <span>lat</span><span>,</span> <span>long</span> <span>})</span> <span>=&gt;</span> <span>[</span><span>lat</span><span>,</span> <span>long</span><span>]);</span>
      <span>geoPolies</span><span>.</span><span>push</span><span>(</span><span>geoPoly</span><span>);</span>
      <span>const</span> <span>probeMax</span> <span>=</span> <span>alos</span><span>.</span><span>getMaxElevation</span><span>(</span><span>geoPoly</span><span>);</span>
      <span>if</span> <span>(</span><span>maxElevation</span><span>.</span><span>elevation</span><span>.</span><span>meter</span> <span>&lt;</span> <span>probeMax</span><span>)</span> <span>{</span>
        <span>maxElevation</span> <span>=</span> <span>probeMax</span><span>;</span>
      <span>}</span>
    <span>}</span>

    <span>// Oh my gosh, we're done!</span>
    <span>return</span> <span>{</span> <span>geoPolies</span><span>,</span> <span>maxElevation</span> <span>};</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And that’s it!</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240209152411101.png" alt="image-20240209152411101"></p>

<p>Was it a lot of work? Absolutely. Was it worth it? <em><strong>Absolutely</strong></em>.</p>

<h3 id="testing-our-code-2">Testing our code</h3>

<p>So let’s see what happens if we run our test flight with terrain follow rather than preprogrammed altitudes? Let’s find out! We’ll grab ourselves a Twin Beech and let’s see what happens! First, let’s look at the altitude curve when we’re flying the Ghost Dog Tour without terrain follow:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240210101811963.png" alt="image-20240210101811963"></p>

<p>And then, <em>with</em> terrain follow:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240209172658718.png" alt="image-20240209172658718"></p>

<p>So now we have two ways to fly a flight plan, but one of those requires zero effort on our part when it comes to flying it: we can now  just drop down a bunch of points on the map and let the autopilot figure out how to safely fly that. And then it does!</p>

<p>And if we want to make things <em>exciting</em> we can lower the safe altitude to something like 25 feet instead of 500 feet… although of course the terrain follow code will still round that up to the nearest higher multiple of 100, and it won’t be able to fly as low through a canyon as a well-flown, elevation tailored flight plan will simply because the elevation probe almost certainly covers the sides cliff sides on either side.</p>

<p>…Still…</p>

<div><pre><code><span>...</span>
<span>// terrain follow</span>
<span>export</span> <span>const</span> <span>TERRAIN_FOLLOW</span> <span>=</span> <span>`TER`</span><span>;</span>
<span>export</span> <span>const</span> <span>TERRAIN_FOLLOW_DATA</span> <span>=</span> <span>`TerrainFollowData`</span><span>;</span>
<span>export</span> <span>const</span> <span>TERRAIN_FOLLOW_SAFETY</span> <span>=</span> <span>25</span><span>;</span> <span>// Let's make this fun!</span>
</code></pre></div>

<p><img src="https://pomax.github.io/are-we-flying/image-20240209191040395.png" alt="image-20240209191040395"></p>

<p>…okay you know what, that actually looks perfectly fine. Guess we’re flying at 25 from now on!</p>

<h2 id="auto-takeoff">Auto takeoff</h2>

<p>So with “safely flying as long as we’re in the air” covered, let’s work on <em>getting</em> ourselves up ion the air. This is, barring auto-landing, the hardest thing to implement if we’re not building a bespoke autopilot for one specific plane, but we’re going to do it anyway, and we’re going to succeed, <em>and</em> it’s going to be glorious. (Although I won’t guarantee it won’t be janky!)</p>

<p>We’ll tackle this by breaking up the task again:</p>

<ol>
  <li>we want to make sure the plane is ready for takeoff, then</li>
  <li>throttle up and roll down the runway to pick up speed. <em>Ideally in a straight line</em>. Then,</li>
  <li>rotating the plane in order to take off once we’re at take-off speed, and then</li>
  <li>switch to the autopilot and keep on flying.</li>
</ol>

<h3 id="our-auto-takeoff-handler">Our auto-takeoff handler</h3>

<p>Let’s start by writing the scaffolding we’ll need in order to run through auto-takeoff, with a new autopilot mode, a new mode function, and of course a new browser page button to trigger this functionality. So you know the drill by now: let’s add a constant:</p>

<div><pre><code><span>export</span> <span>const</span> <span>AUTO_TAKEOFF</span> <span>=</span> <span>`ATO`</span><span>;</span>
</code></pre></div>

<p>and plug that into the autopilot</p>

<div><pre><code><span>import</span> <span>{</span> <span>...,</span> <span>AUTO_TAKEOFF</span> <span>}</span> <span>from</span> <span>"</span><span>../utils/constants.js</span><span>"</span><span>;</span>
<span>...</span>
  <span>this</span><span>.</span><span>modes</span> <span>=</span> <span>[</span>
    <span>...,</span>
    <span>[</span><span>AUTO_TAKEOFF</span><span>]:</span> <span>false</span><span>,</span>
  <span>]</span>
<span>...</span>
</code></pre></div>

<p>and our <code>public/js/autopilot.js</code> as well:</p>

<div><pre><code><span>...</span>
<span>export</span> <span>const</span> <span>AP_OPTIONS</span> <span>=</span> <span>{</span>
  <span>...</span>
  <span>ATO</span><span>:</span> <span>false</span><span>,</span>
<span>};</span>
<span>...</span>
</code></pre></div>

<p>and our <code>autopilot.html</code>:</p>

<div><pre><code><span>&lt;div</span> <span>class=</span><span>"controls"</span><span>&gt;</span>
  ...
  <span>&lt;fieldset&gt;</span>
    <span>&lt;button</span> <span>title=</span><span>"terrain follow"</span> <span>class=</span><span>"TER"</span><span>&gt;</span>terrain follow<span>&lt;/button&gt;</span>
    <span>&lt;button</span> <span>title=</span><span>"auto takeoff"</span> <span>class=</span><span>"ATO"</span><span>&gt;</span>take off<span>&lt;/button&gt;</span>
  <span>&lt;/fieldset&gt;</span>
<span>&lt;/div&gt;</span>
</code></pre></div>

<p>(Also note the moved  terrain follow button: let’s just group our special functions)</p>

<p>Then, our auto takeoff function. Or rather, our take off object, because it’s going to have to do a lot of “this-takeoff-relevant” value tracking throughout the takeoff process, so it makes more sense to use a proper object rather than a (mostly) stateless function:</p>

<div><pre><code><span>export</span> <span>class</span> <span>AutoTakeoff</span> <span>{</span>
  <span>constructor</span><span>(</span><span>autopilot</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>autopilot</span> <span>=</span> <span>autopilot</span><span>;</span>
    <span>this</span><span>.</span><span>api</span> <span>=</span> <span>autopilot</span><span>.</span><span>api</span><span>;</span>
  	<span>this</span><span>.</span><span>prepped</span> <span>=</span> <span>false</span><span>;</span>
    <span>this</span><span>.</span><span>done</span> <span>=</span> <span>false</span><span>;</span>
  <span>}</span>

  <span>async</span> <span>run</span><span>(</span><span>flightInformation</span><span>)</span> <span>{</span>
    <span>if</span> <span>(</span><span>this</span><span>.</span><span>done</span><span>)</span> <span>return</span><span>;</span>
    <span>const</span> <span>{</span> <span>model</span><span>:</span> <span>flightModel</span><span>,</span> <span>data</span><span>:</span> <span>flightData</span> <span>}</span> <span>=</span> <span>flightInformation</span><span>;</span>

    <span>// prep the plane for roll</span>
    <span>if</span> <span>(</span><span>!</span><span>this</span><span>.</span><span>prepped</span><span>)</span> <span>return</span> <span>this</span><span>.</span><span>prepForRoll</span><span>(</span><span>flightModel</span><span>,</span> <span>flightData</span><span>);</span>

    <span>// Throttle up (if we can)</span>
    <span>this</span><span>.</span><span>throttleUp</span><span>(</span><span>flightModel</span><span>,</span> <span>flightData</span><span>);</span>

	  <span>// And try to keep us rolling in a straight line:</span>
    <span>this</span><span>.</span><span>autoRudder</span><span>(</span><span>flightModel</span><span>,</span> <span>flightData</span><span>);</span>

    <span>// Is it time to actually take off?</span>
    <span>this</span><span>.</span><span>checkRotation</span><span>(</span><span>flightModel</span><span>,</span> <span>flightData</span><span>);</span>

    <span>// Is it time to hand off flight to the regular auto pilot?</span>
    <span>this</span><span>.</span><span>checkHandoff</span><span>(</span><span>flightModel</span><span>,</span> <span>flightData</span><span>);</span>
  <span>}</span>

  <span>// We'll look at the implementations for all of these in a bit</span>

  <span>async</span> <span>prepForRoll</span><span>()</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`prep for roll`</span><span>);</span>
  <span>}</span>

  <span>async</span> <span>throttleUp</span><span>()</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`throttle up`</span><span>);</span>
  <span>}</span>

  <span>async</span> <span>autoRudder</span><span>()</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`run autorudder`</span><span>);</span>
  <span>}</span>

  <span>async</span> <span>checkRotation</span><span>()</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`check rotation`</span><span>);</span>
  <span>}</span>

  <span>async</span> <span>checkHandoff</span><span>()</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`check for handoff`</span><span>);</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>Which we then import into the autopilot, but with some extra code to make the autopilot run faster when we’re in auto-takeoff, because our half-second interval is too long for the auto-rudder to do its job (you can literally “spin out” in half a second when a heavy tail dragger goes from three wheels on the ground to only two wheels on the ground because it reached a speed that’s fast enough for the tail to lift).</p>

<div><pre><code><span>import</span> <span>{</span> <span>...,</span> <span>AUTO_TAKEOFF</span> <span>}</span> <span>from</span> <span>"</span><span>./constants.js</span><span>"</span><span>;</span>
<span>...</span>

<span>let</span> <span>autoTakeoff</span> <span>=</span> <span>false</span><span>;</span>
<span>let</span> <span>{</span> <span>AutoTakeoff</span> <span>}</span> <span>=</span> <span>await</span> <span>watch</span><span>(</span>
  <span>dirname</span><span>,</span>
  <span>`auto-takeoff.js`</span><span>,</span>
  <span>(</span><span>lib</span><span>)</span> <span>=&gt;</span> <span>{</span>
    <span>AutoTakeoff</span> <span>=</span> <span>lib</span><span>.</span><span>AutoTakeoff</span><span>;</span>
    <span>if</span> <span>(</span><span>autoTakeoff</span><span>)</span> <span>{</span>
      <span>Object</span><span>.</span><span>setPrototypeOf</span><span>(</span><span>autoTakeoff</span><span>,</span> <span>AutoTakeoff</span><span>.</span><span>prototype</span><span>);</span>
    <span>}</span>
<span>);</span>

<span>const</span> <span>FAST_AUTOPILOT_INTERVAL</span> <span>=</span> <span>100</span><span>;</span>

<span>export</span> <span>class</span> <span>AutoPilot</span> <span>{</span>
  <span>...</span>

  <span>reset</span><span>()</span> <span>{</span>
    <span>...</span>
    <span>autoTakeoff</span> <span>=</span> <span>false</span><span>;</span>
  <span>}</span>

  <span>async</span> <span>setTarget</span><span>(</span><span>key</span><span>,</span> <span>value</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>// Did we turn auto takeoff on or off?</span>
    <span>if</span> <span>(</span><span>key</span> <span>===</span> <span>AUTO_TAKEOFF</span><span>)</span> <span>{</span>
      <span>if</span> <span>(</span><span>oldValue</span> <span>===</span> <span>false</span> <span>&amp;&amp;</span> <span>newValue</span> <span>===</span> <span>true</span><span>)</span> <span>{</span>
        <span>autoTakeoff</span> <span>=</span> <span>new</span> <span>AutoTakeoff</span><span>(</span><span>this</span><span>);</span>
        <span>this</span><span>.</span><span>resetTrim</span><span>();</span>
        <span>this</span><span>.</span><span>AP_INTERVAL</span> <span>=</span> <span>FAST_AUTOPILOT_INTERVAL</span>
      <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>newValue</span> <span>===</span> <span>false</span> <span>&amp;&amp;</span> <span>autoTakeoff</span><span>)</span> <span>{</span>
        <span>autoTakeoff</span> <span>=</span> <span>false</span><span>;</span>
        <span>this</span><span>.</span><span>AP_INTERVAL</span> <span>=</span> <span>AUTOPILOT_INTERVAL</span><span>;</span>
      <span>}</span>
    <span>}</span>
  <span>}</span>

  <span>async</span> <span>run</span><span>()</span> <span>{</span>
    <span>...</span>
    <span>try</span> <span>{</span>
      <span>...</span>
      <span>if</span> <span>(</span><span>modes</span><span>[</span><span>AUTO_TAKEOFF</span><span>])</span> <span>autoTakeoff</span><span>?.</span><span>run</span><span>(</span><span>flightInformation</span><span>);</span>
    <span>}</span> <span>catch</span> <span>(</span><span>e</span><span>)</span> <span>{</span>
      <span>console</span><span>.</span><span>warn</span><span>(</span><span>e</span><span>);</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>With that out of the way, let’s set up some stub implementations so that we can run this code in action while <em>we</em> perform a takeoff.</p>

<h3 id="basic-testing">Basic testing</h3>

<p>Step one: add some code so we can see our functions at least <em>do</em> something:</p>

<div><pre><code><span>import</span> <span>{</span> <span>project</span><span>,</span> <span>getPointAtDistance</span><span>,</span> <span>getDistanceBetweenPoints</span><span>,</span> <span>getCompassDiff</span> <span>}</span> <span>from</span> <span>"</span><span>../utils/utils.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>FEET_PER_METER</span> <span>}</span> <span>from</span> <span>"</span><span>../utils/constants.js</span><span>"</span><span>;</span>

<span>export</span> <span>class</span> <span>AutoTakeoff</span> <span>{</span>
  <span>...</span>

  <span>// what are our preroll settings?</span>
  <span>async</span> <span>prepForRoll</span><span>(</span>
    <span>{</span> <span>isTailDragger</span> <span>},</span>
    <span>{</span> <span>elevator</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>flaps</span><span>,</span> <span>parkingBrake</span><span>,</span> <span>trueHeading</span><span>,</span> <span>pitchTrim</span><span>,</span> <span>aileronTrim</span><span>,</span> <span>rudderTrim</span><span>,</span> <span>tailWheelLock</span> <span>}</span>
  <span>)</span> <span>{</span>
    <span>// Log the various settings we'll be working with when we implement the real prepForRoll</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`prep for roll:`</span><span>);</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`parking break engaged: </span><span>${</span><span>parkingBrake</span><span>}</span><span>`</span><span>);</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`flaps angle: </span><span>${</span><span>flaps</span><span>}</span><span> degrees`</span><span>);</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`elevator: </span><span>${</span><span>elevator</span><span>}</span><span>`</span><span>);</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`trim: elevator: </span><span>${</span><span>pitchTrim</span><span>}</span><span>`</span><span>);</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`trim: aileron: </span><span>${</span><span>aileronTrim</span><span>}</span><span>`</span><span>);</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`trim: rudder: </span><span>${</span><span>rudderTrim</span><span>}</span><span>`</span><span>);</span>
    <span>if</span> <span>(</span><span>isTailDragger</span><span>)</span> <span>{</span>
			<span>console</span><span>.</span><span>log</span><span>(</span><span>`tail wheel lock: </span><span>${</span><span>tailWheelLock</span><span>}</span><span>`</span><span>);</span>
    <span>}</span>
    <span>// Then, cache our takeoff line: we'll need it for auto-rudder.</span>
    <span>this</span><span>.</span><span>heading</span> <span>=</span> <span>trueHeading</span><span>;</span>
    <span>this</span><span>.</span><span>start</span> <span>=</span> <span>getPointAtDistance</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>-</span><span>1</span><span>,</span> <span>trueHeading</span><span>);</span>
    <span>this</span><span>.</span><span>end</span> <span>=</span> <span>getPointAtDistance</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>10</span><span>,</span> <span>trueHeading</span><span>);</span>
		<span>// And we're done with prep</span>
    <span>this</span><span>.</span><span>prepped</span> <span>=</span> <span>true</span><span>;</span>
  <span>}</span>

  <span>// log for as long as we're not at 100% throttle</span>
  <span>async</span> <span>throttleUp</span><span>({</span> <span>engineCount</span> <span>},</span> <span>{</span> <span>throttle</span> <span>})</span> <span>{</span>
    <span>if</span> <span>(</span><span>throttle</span> <span>&lt;=</span> <span>99</span><span>)</span> <span>{</span>
      <span>const</span> <span>engineWord</span> <span>=</span> <span>`engine</span><span>${</span><span>engineCount</span> <span>===</span> <span>1</span> <span>?</span> <span>``</span><span>:</span> <span>`s`</span><span>}</span><span>`</span><span>;</span>
      <span>console</span><span>.</span><span>log</span><span>(</span>
        <span>`throttle up </span><span>${</span><span>engineCount</span><span>}</span><span> </span><span>${</span><span>engineWord</span><span>}</span><span> (currently at </span><span>${</span><span>throttle</span><span>.</span><span>toFixed</span><span>(</span><span>2</span><span>)}</span><span>%`</span>
      <span>);</span>
    <span>}</span>
  <span>}</span>

  <span>// Check how much we're out wrt the runway center line</span>
  <span>async</span> <span>autoRudder</span><span>({},</span> <span>{</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>trueHeading</span> <span>})</span> <span>{</span>
    <span>const</span> <span>{</span> <span>heading</span><span>,</span> <span>start</span><span>,</span> <span>end</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>const</span> <span>p</span> <span>=</span> <span>project</span><span>(</span><span>start</span><span>.</span><span>long</span><span>,</span> <span>start</span><span>.</span><span>lat</span><span>,</span> <span>end</span><span>.</span><span>long</span><span>,</span> <span>end</span><span>.</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>lat</span><span>);</span>
    <span>const</span> <span>d</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>p</span><span>.</span><span>y</span><span>,</span> <span>p</span><span>.</span><span>x</span><span>)</span> <span>*</span> <span>1000</span> <span>*</span> <span>FEET_PER_METER</span><span>;</span>
    <span>const</span> <span>hDiff</span> <span>=</span> <span>getCompassDiff</span><span>(</span><span>heading</span><span>,</span> <span>trueHeading</span><span>);</span>
    <span>console</span><span>.</span><span>log</span><span>(</span>
      <span>`run autorudder: off by </span><span>${</span><span>d</span><span>.</span><span>toFixed</span><span>(</span><span>3</span><span>)}</span><span>' (heading off by </span><span>${</span><span>hDiff</span><span>.</span><span>toFixed</span><span>(</span><span>3</span><span>)}</span><span> degrees)`</span>
    <span>);</span>
  <span>}</span>

  <span>// Check if we're at a speed where we should rotate</span>
  <span>async</span> <span>checkRotation</span><span>({</span> <span>minRotation</span><span>,</span> <span>takeoffSpeed</span><span>,</span> <span>},</span> <span>{</span> <span>speed</span> <span>})</span> <span>{</span>
    <span>let</span> <span>minRotate</span> <span>=</span> <span>minRotation</span><span>;</span>
    <span>if</span> <span>(</span><span>minRotate</span> <span>&lt;</span> <span>0</span><span>)</span> <span>minRotate</span> <span>=</span> <span>1.5</span> <span>*</span> <span>takeoffSpeed</span><span>;</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`check rotation: </span><span>${</span><span>speed</span> <span>&gt;=</span> <span>minRotate</span> <span>?</span> <span>`rotate`</span> <span>:</span> <span>`not yet`</span><span>}</span><span>.`</span><span>);</span>
  <span>}</span>

  <span>// Check if the plane's in a state where we can</span>
  <span>// hand things off to the regular autopilot</span>
  <span>async</span> <span>checkHandoff</span><span>({},</span> <span>{</span> <span>onGround</span><span>,</span> <span>VS</span><span>,</span> <span>altAboveGround</span> <span>})</span> <span>{</span>
    <span>const</span> <span>handoff</span> <span>=</span> <span>!</span><span>onGround</span> <span>&amp;&amp;</span> <span>VS</span> <span>&gt;</span> <span>100</span> <span>&amp;&amp;</span> <span>altAboveGround</span> <span>&gt;</span> <span>50</span><span>;</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`ready for handoff? </span><span>${</span><span>handoff</span><span>}</span><span>`</span><span>);</span>
    <span>this</span><span>.</span><span>done</span> <span>=</span> <span>this</span><span>.</span><span>done</span> <span>||</span> <span>handoff</span><span>;</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>With all this in place, let’s fire up MSFS, run our <code>node api-server.js</code> and our <code>node web-server.js --owner --browser</code> and put ourselves on a runway, then turn on the autopilot with only auto-takeoff enabled, and perform a takeoff. We should see something similar to the following log:</p>

<div><pre><code>Engaging autopilot
initial roll value for Milviz 310R CGTER: 5000 (4496/186.395 ≈ 24 psf)
prep for roll:
parking break engaged: true
flaps angle: 0 degrees
elevator: 0
trim: elevator: 0
trim: aileron: 0
trim: rudder: 0
throttle up 2 engines (currently at 0%)
run autorudder: off by 3.065' (heading off by 0 degrees)
check rotation: not yet.
ready for handoff? false
throttle up 2 engines (currently at 12.89%)
run autorudder: off by 3.066' (heading off by -0.001 degrees)
check rotation: not yet.
ready for handoff? false
...
throttle up 2 engines (currently at 97.16%)
run autorudder: off by 3.067' (heading off by 0.059 degrees)
check rotation: not yet.
ready for handoff? false
run autorudder: off by 3.072' (heading off by 0.091 degrees)
check rotation: not yet.
ready for handoff? false
...
run autorudder: off by 2.910' (heading off by -0.615 degrees)
check rotation: rotate.
ready for handoff? false
...
run autorudder: off by 10.771' (heading off by -4.161 degrees)
check rotation: rotate.
ready for handoff? true
</code></pre></div>

<p>And now the challenge becomes replicating that in our autopilot.</p>

<h3 id="preflight-checklist">Preflight checklist</h3>

<p>Our pre-flight checklist is relatively simple:</p>

<ul>
  <li>we want to make sure our altimeter is calibrated,</li>
  <li>we want to make sure the parking brake is off,</li>
  <li>flaps get fully retracted (some planes want flaps during takeoff, others don’t, and we have no way of looking up which it is, so all planes get to lift off without the help of flaps. <em>Use the runway, that’s what it’s for</em>.)</li>
  <li>we reset all the trim values so that we start off neutral (again, some planes want trim for takeoff: too bad for them),</li>
  <li>we set the elevator position to 0 (just in case it wasn’t),</li>
  <li>we set the fuel mixture somewhere between full rich and 65% depending on whether we’re sitting at sea level or 8000 feet, or somewhere in between those two.</li>
  <li>if the plane’s a tail dragger, we lock the tail wheel.</li>
</ul>

<p>Turning that into code:</p>

<div><pre><code><span>import</span> <span>{</span>
  <span>constrainMap</span><span>,</span>
  <span>...</span>
<span>}</span> <span>from</span> <span>"</span><span>../utils/utils.js</span><span>"</span><span>;</span>

<span>...</span>

<span>export</span> <span>class</span> <span>AutoTakeoff</span> <span>{</span>
  <span>...</span>

  <span>async</span> <span>prepForRoll</span><span>(</span>
    <span>{</span> <span>isTailDragger</span><span>,</span> <span>engineCount</span> <span>},</span>
    <span>{</span> <span>alt</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>flaps</span><span>,</span> <span>parkingBrake</span><span>,</span> <span>trueHeading</span><span>,</span> <span>tailWheelLock</span> <span>}</span>
  <span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>api</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>

    <span>// Cache our takeoff line: we'll need it for auto-rudder.</span>
    <span>this</span><span>.</span><span>heading</span> <span>=</span> <span>trueHeading</span><span>;</span>
    <span>this</span><span>.</span><span>start</span> <span>=</span> <span>getPointAtDistance</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>-</span><span>1</span><span>,</span> <span>trueHeading</span><span>);</span>
    <span>this</span><span>.</span><span>end</span> <span>=</span> <span>getPointAtDistance</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>10</span><span>,</span> <span>trueHeading</span><span>);</span>

    <span>// Ensure our barometric altimeter is calibrated</span>
    <span>api</span><span>.</span><span>trigger</span><span>(</span><span>`BAROMETRIC`</span><span>);</span>

    <span>// Is the parking brake engaged? If so, let's take that off.</span>
    <span>if</span> <span>(</span><span>parkingBrake</span> <span>===</span> <span>1</span><span>)</span> <span>api</span><span>.</span><span>trigger</span><span>(</span><span>`PARKING_BRAKES`</span><span>);</span>

    <span>// We don't have a database of which plane needs how much flaps for takeoff,</span>
    <span>// so we/ just... don't set flaps. It makes take-off take a bit longer, but</span>
    <span>// then again: use the whole runway, that's what it's for.</span>
    <span>if</span> <span>(</span><span>flaps</span> <span>!==</span> <span>0</span><span>)</span> <span>api</span><span>.</span><span>set</span><span>(</span><span>`FLAPS_HANDLE_INDEX:1`</span><span>,</span> <span>0</span><span>);</span>

    <span>// Reset all trim values before takeoff.</span>
    <span>api</span><span>.</span><span>set</span><span>(</span><span>`AILERON_TRIM_PCT`</span><span>,</span> <span>0</span><span>);</span>
    <span>api</span><span>.</span><span>set</span><span>(</span><span>`ELEVATOR_TRIM_POSITION`</span><span>,</span> <span>0</span><span>);</span>
    <span>api</span><span>.</span><span>set</span><span>(</span><span>`RUDDER_TRIM_PCT`</span><span>,</span> <span>0</span><span>);</span>

    <span>// Set mixture to something altitude-appropriate and set props to 90%,</span>
    <span>// mostly because we have no way to ask MSFS what the "safe" value for</span>
    <span>// props is, and we don't want the engines to burn out.</span>
    <span>const</span> <span>mixture</span> <span>=</span> <span>constrainMap</span><span>(</span><span>alt</span><span>,</span> <span>3000</span><span>,</span> <span>8000</span><span>,</span> <span>100</span><span>,</span> <span>65</span><span>);</span>
    <span>for</span> <span>(</span><span>let</span> <span>i</span> <span>=</span> <span>1</span><span>;</span> <span>i</span> <span>&lt;=</span> <span>engineCount</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>{</span>
      <span>api</span><span>.</span><span>set</span><span>(</span><span>`GENERAL_ENG_MIXTURE_LEVER_POSITION:</span><span>${</span><span>i</span><span>}</span><span>`</span><span>,</span> <span>mixture</span><span>);</span>
      <span>api</span><span>.</span><span>set</span><span>(</span><span>`GENERAL_ENG_PROPELLER_LEVER_POSITION:</span><span>${</span><span>i</span><span>}</span><span>`</span><span>,</span> <span>90</span><span>);</span>
    <span>}</span>

    <span>// Lock the tailwheel. If we have one, of course.</span>
    <span>if</span> <span>(</span><span>isTailDragger</span> <span>&amp;&amp;</span> <span>tailWheelLock</span> <span>===</span> <span>0</span><span>)</span> <span>{</span>
      <span>api</span><span>.</span><span>trigger</span><span>(</span><span>`TOGGLE_TAILWHEEL_LOCK`</span><span>);</span>
    <span>}</span>

    <span>// Force neutral elevator</span>
    <span>await</span> <span>api</span><span>.</span><span>set</span><span>(</span><span>`ELEVATOR_POSITION`</span><span>,</span> <span>0</span><span>);</span>

    <span>// And we're done with prep</span>
    <span>this</span><span>.</span><span>prepped</span> <span>=</span> <span>true</span><span>;</span>
  <span>}</span>

  <span>...</span>
<span>}</span>
</code></pre></div>

<p>Nothing particularly hard or complicated, just “set things to what they need to be so we can start our take-off”. So… let’s start our take-off?</p>

<h3 id="runway-roll">Runway roll</h3>

<p>There’s two aspects to a proper runway roll:</p>

<ol>
  <li>build up speed</li>
  <li>keep rolling straight</li>
  <li><code>goto 1</code></li>
</ol>

<p>Now, the easy part is throttling the engines up to 100%. The <em>hard</em> part is keeping the plane on the runway: propeller torque as well as small differences in engine outputs on multi-engine aircrafts <em>can and will</em> roll us off the runway if we don’t use the pedals to steer us in the right direction. For instance, let’s see what happens if we just throttle up the engines without any kind of rudder action:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240210182744489.png" alt="image-20240210182744489"></p>

<p><em>The 310R, Beaver, Twin Beech, DC-3, Kodiak 100, Top Rudder, Arrow, Pitts, and Gee Bee R3.</em></p>

<p>It’s not good: this is varying degrees of either crashing into trees or buildings, or managing to take off in “nowhere near the direction of the runway”. So we’re definitely going to need to implement an auto-rudder of sorts if we want to at least <em>pretend</em> we’re sticking to the runway during takeoff.</p>

<p>One thing we notice is the difference between the 310R and the three tail draggers. As you may have guessed, this corresponds to the moment when the tail wheel no longer makes contact with the ground: up until that point we have the benefit of actually being able to (slightly) steer using the rear wheel, with the actual rudder having to do very little, but once it’s off the ground we need to briefly work the rudder a lot harder to stop the plane from suddenly veering off.</p>

<p>So our attempt at an auto-rudder will consist of a few phases:</p>

<ul>
  <li>pre-roll: where we make sure the plane’s ready to roll (brakes, flaps, etc) and we record our center line,
    <ul>
      <li>which we already implemented!</li>
    </ul>
  </li>
  <li>initial roll, with all wheels on the ground, and plenty of control
    <ul>
      <li>slowly throttle up so we give ourselves time to ease the rudder in as well.</li>
      <li>pick a target on the center line about a kilometer ahead of us to “rudder towards”</li>
      <li>the more out-of-heading we get, the more we rudder in to get back onto the center line.</li>
      <li>if this is not a tail dragger, this phase effectively lasts for the entire roll, but if this <em>is</em> a tail dragger:
        <ul>
          <li>there will be loss of control when the tail wheel comes off the ground,</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>If we’re lucky (or we accept “good enough”) we can come up with code that can handle all of these phases without knowing “which phase we’re in”, so we’ll make some more observations:</p>

<ul>
  <li>the faster we’re going, the less rudder we need to apply to get the same correction over time,</li>
  <li>the closer to the center line we are, the less rudder we need to apply, and</li>
  <li>every plane has rudder characteristics that we could use to finesse the code. But we don’t have access to those.</li>
</ul>

<p>Now, the first two are relatively easy to implement (although we’ll need a fair bit of code for step 2, even if it’s simple code). It’s that last point that’s properly annoying. There’s just no way to get the information we want, so if we want something that mostly kind of sort of works for mostly all planes, we’re going to have run this code a million times for different planes and figure out what “magic constant” works for which plane. And then try to figure out what plane property that we <em>do</em> have access to we can tie that to. To save you that headache, I’ve done that work for us, but suffice it to say we shouldn’t feel good about this solution and ideally, one day, we will come up with something better.</p>

<p>So let’s write some code:</p>

<div><pre><code>  <span>...</span>

  <span>/**
   * throttle up for as long as we're not at 100% throttle
   */</span>
  <span>async</span> <span>throttleUp</span><span>({</span> <span>engineCount</span> <span>},</span> <span>{</span> <span>throttle</span> <span>})</span> <span>{</span>
    <span>if</span> <span>(</span><span>throttle</span> <span>&gt;</span> <span>99</span><span>)</span> <span>return</span><span>;</span>
    <span>const</span> <span>{</span> <span>api</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>const</span> <span>throttleVar</span> <span>=</span> <span>`GENERAL_ENG_THROTTLE_LEVER_POSITION`</span><span>;</span>
    <span>for</span> <span>(</span><span>let</span> <span>count</span> <span>=</span> <span>1</span><span>;</span> <span>count</span> <span>&lt;=</span> <span>engineCount</span><span>;</span> <span>count</span><span>++</span><span>)</span> <span>{</span>
      <span>api</span><span>.</span><span>set</span><span>(</span><span>`</span><span>${</span><span>throttleVar</span><span>}</span><span>:</span><span>${</span><span>count</span><span>}</span><span>`</span><span>,</span> <span>throttle</span> <span>+</span> <span>1</span><span>);</span>
    <span>}</span>
  <span>}</span>

  <span>/**
   * Check how much we're out with respect to the runway center line
   */</span>
  <span>async</span> <span>autoRudder</span><span>({</span> <span>isAcrobatic</span> <span>},</span> <span>{</span> <span>onGround</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>trueHeading</span><span>,</span> <span>rudder</span> <span>})</span> <span>{</span>
    <span>// Only auto-rudder for as long as we're rolling.</span>
    <span>if</span> <span>(</span><span>!</span><span>onGround</span><span>)</span> <span>return</span><span>;</span>

    <span>// What direction do we need to rudder in? (if any)</span>
    <span>const</span> <span>{</span> <span>end</span><span>:</span> <span>target</span><span>,</span> <span>api</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>const</span> <span>targetHeading</span> <span>=</span> <span>getHeadingFromTo</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>target</span><span>.</span><span>lat</span><span>,</span> <span>target</span><span>.</span><span>long</span><span>);</span>
    <span>const</span> <span>prev_hDiff</span> <span>=</span> <span>this</span><span>.</span><span>hDiff</span><span>;</span>
    <span>let</span> <span>hDiff</span> <span>=</span> <span>(</span><span>this</span><span>.</span><span>hDiff</span> <span>=</span> <span>getCompassDiff</span><span>(</span><span>trueHeading</span><span>,</span> <span>targetHeading</span><span>));</span>
    <span>const</span> <span>dHeading</span> <span>=</span> <span>hDiff</span> <span>-</span> <span>prev_hDiff</span><span>;</span>

    <span>// Try to get onto the center line, but prioritize a stable heading</span>
    <span>// delta, so we don't oscillate on the runway (...too much....)</span>
    <span>let</span> <span>update</span> <span>=</span> <span>0</span><span>;</span>
    <span>const</span> <span>cMax</span> <span>=</span> <span>0.1</span><span>;</span>
    <span>update</span> <span>+=</span> <span>constrainMap</span><span>(</span><span>hDiff</span><span>,</span> <span>-</span><span>30</span><span>,</span> <span>30</span><span>,</span> <span>-</span><span>cMax</span> <span>/</span> <span>2</span><span>,</span> <span>cMax</span> <span>/</span> <span>2</span><span>);</span>
    <span>update</span> <span>+=</span> <span>constrainMap</span><span>(</span><span>dHeading</span><span>,</span> <span>-</span><span>1</span><span>,</span> <span>1</span><span>,</span> <span>-</span><span>cMax</span><span>,</span> <span>cMax</span><span>);</span>

    <span>// And apply our update:</span>
    <span>const</span> <span>newRudder</span> <span>=</span> <span>rudder</span> <span>/</span> <span>100</span> <span>+</span> <span>update</span><span>;</span>
    <span>api</span><span>.</span><span>set</span><span>(</span><span>`RUDDER_POSITION`</span><span>,</span> <span>newRudder</span><span>);</span>
  <span>}</span>

  <span>...</span>
</code></pre></div>

<p>And with that, what do things look like now?</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240211210723937.png" alt="image-20240211210723937"></p>

<p>That looks straight to me! Although those last two reveal an interesting problem: the acrobat planes take off <em>really quickly</em>, at which point their wings are not level, and they start to veer. So let’s keep that in the back of our mind as we implement…</p>

<h3 id="rotatetake-off">Rotate/take-off</h3>

<p>Once we’re at rolling at a good speed, we’ll need to rotate at some point (i.e. get its nose up) and take to the skies, but what’s a good speed for that?</p>

<p>There are two special speeds that determine when an aeroplane can take off (from amongst a <a href="https://en.wikipedia.org/wiki/V_speeds">truly humongous list</a> of “V-speeds”):</p>

<ul>
  <li><code>Vr</code>, or the “rotation speed”, which is the speed at which you want to start pulling back on the stick or yoke to get the plane to lift off, and</li>
  <li><code>V1</code>, which is the cutoff speed for aborting a takeoff. If you haven’t taken off by the time the plane reaches <code>V1</code>, you are taking off, whether you like it or not, because the alternative is death. It’s the speed at which your plane can no longer safely slow down to a stop simply by throttling and braking, so you’re going to keep speeding up and you <strong><em>will</em></strong> take off, even if you then immediately need to find a suitable place to perform an emergency landing.</li>
</ul>

<p>And MSFS adds a third value to that, called the “design takeoff speed”, representing the ideal in-game speed at which the plane should be taking off, so for the purpose of our auto-takeoff we’re going to <em>prefer</em> to use <code>Vr</code>, but not every plane has a sensible value set for that (for… reasons? I have no idea, some MSFS planes have complete nonsense values like -1), so we’ll use the rule “use <code>Vr</code>, unless that’s nonsense, then use the design-takeoff-speed”:</p>

<div><pre><code>  <span>...</span>

  <span>/**
   * Check if we're at a speed where we should rotate
   */</span>
  <span>async</span> <span>checkRotation</span><span>({</span> <span>minRotation</span><span>,</span> <span>takeoffSpeed</span><span>,</span> <span>isAcrobatic</span> <span>},</span> <span>{</span> <span>elevator</span><span>,</span> <span>speed</span><span>,</span> <span>VS</span><span>,</span> <span>bank</span> <span>})</span> <span>{</span>
    <span>// Do we have a sensible Vr?</span>
    <span>let</span> <span>minRotate</span> <span>=</span> <span>minRotation</span><span>;</span>
    <span>if</span> <span>(</span><span>minRotate</span> <span>&lt;</span> <span>0</span><span>)</span> <span>minRotate</span> <span>=</span> <span>1.5</span> <span>*</span> <span>takeoffSpeed</span><span>;</span>
    <span>const</span> <span>rotate</span> <span>=</span> <span>speed</span> <span>&gt;=</span> <span>minRotate</span> <span>*</span> <span>1.25</span><span>;</span>

    <span>const</span> <span>{</span> <span>api</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>

    <span>if</span> <span>(</span><span>rotate</span><span>)</span> <span>{</span>
      <span>// This number has been scientifically determined by flying every</span>
      <span>// plane I could think of and seeing if it worked:</span>
      <span>let</span> <span>step</span> <span>=</span> <span>0.005</span><span>;</span>

      <span>// Initial pull on the elevator</span>
      <span>if</span> <span>(</span><span>!</span><span>this</span><span>.</span><span>rotating</span><span>)</span> <span>{</span>
        <span>this</span><span>.</span><span>rotating</span> <span>=</span> <span>true</span><span>;</span>
        <span>return</span> <span>api</span><span>.</span><span>set</span><span>(</span><span>`ELEVATOR_POSITION`</span><span>,</span> <span>5</span> <span>*</span> <span>step</span><span>);</span>
      <span>}</span>

      <span>// Then keep pulling back the elevator for as ong as we're</span>
      <span>// not noticably going up...</span>
      <span>if</span> <span>(</span><span>VS</span> <span>&lt;</span> <span>MIN_VS</span><span>)</span> <span>{</span>
        <span>const</span> <span>correction</span> <span>=</span> <span>constrainMap</span><span>(</span><span>abs</span><span>(</span><span>VS</span><span>),</span> <span>0</span><span>,</span> <span>MIN_VS</span><span>,</span> <span>step</span><span>,</span> <span>0</span><span>);</span>
        <span>const</span> <span>newElevator</span> <span>=</span> <span>elevator</span> <span>/</span> <span>100</span> <span>+</span> <span>correction</span><span>;</span>
        <span>api</span><span>.</span><span>set</span><span>(</span><span>`ELEVATOR_POSITION`</span><span>,</span> <span>newElevator</span><span>);</span>
      <span>}</span>

      <span>// ...but if we're gaining *too much* altitude, push that elevator back!</span>
      <span>if</span> <span>(</span><span>VS</span> <span>&gt;</span> <span>300</span><span>)</span> <span>{</span>
        <span>if</span> <span>(</span><span>isAcrobatic</span><span>)</span> <span>api</span><span>.</span><span>set</span><span>(</span><span>`RUDDER_POSITION`</span><span>,</span> <span>0</span><span>);</span>
        <span>step</span> <span>=</span> <span>constrainMap</span><span>(</span><span>VS</span><span>,</span> <span>100</span><span>,</span> <span>300</span><span>,</span> <span>0</span><span>,</span> <span>step</span><span>);</span>
        <span>const</span> <span>newElevator</span> <span>=</span> <span>elevator</span> <span>/</span> <span>100</span> <span>-</span> <span>step</span><span>/</span><span>2</span><span>;</span>
        <span>api</span><span>.</span><span>set</span><span>(</span><span>`ELEVATOR_POSITION`</span><span>,</span> <span>newElevator</span><span>);</span>
      <span>}</span>
    <span>}</span>
  <span>}</span>

  <span>...</span>
</code></pre></div>

<p>And that’s our take off code. It’s pretty rudimentary, but we only need this to run for “just as long as we need to turn the real autopilot on”. Although to save a bit of testing, there’s just a <em>tiny</em> problem with this code as written that we already saw in the previous auto-rudder pictures:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240213205919956.png" alt="image-20240213205919956"></p>

<p>No wing leveler.</p>

<p>The moment some of the twitchier planes lift off, there’s a good chance they’ll just tip over and try to crash. So, since this code will only be in effect for a short time, and we just need a stopgap between “wheels off the ground” and “turning on the real autopilot”, let’s just add the most naive wing lever code we possibly can:</p>

<div><pre><code>  <span>...</span>
  <span>/**
   * Check if we're at a speed where we should rotate, with our bank angle used to keep the plane levelish
   */</span>
  <span>async</span> <span>checkRotation</span><span>({</span> <span>minRotation</span><span>,</span> <span>takeoffSpeed</span><span>,</span> <span>isAcrobatic</span> <span>},</span> <span>{</span> <span>elevator</span><span>,</span> <span>speed</span><span>,</span> <span>VS</span><span>,</span> <span>bank</span> <span>})</span> <span>{</span>
    <span>...</span>
    <span>const</span> <span>{</span> <span>api</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>

    <span>// For as long as we're taking off, use super naive bank-correction,</span>
    <span>// so that twitchy planes stay mostly aligned with the runway on</span>
    <span>// their rotation.</span>
    <span>api</span><span>.</span><span>set</span><span>(</span><span>`AILERON_POSITION`</span><span>,</span> <span>bank</span> <span>/</span> <span>100</span><span>);</span>

    <span>...</span>
  <span>}</span>
<span>...</span>
</code></pre></div>

<p>As long as we only need it for a few seconds, dumb is good: if we’re banking, proportionally set the aileron in the opposite direction. Would we want to <em>fly</em> with that? Heck no! But is it good enough to keep planes “level enough” to bridge the gap between takeoff and autopilot? You bet!</p>

<p>And on that note…</p>

<h3 id="handoff-to-the-autopilot">Handoff to the autopilot</h3>

<p>The final step in the auto-takeoff process is, of course, concluding the auto-takeoff procedure and handing things off to the regular autopilot. Once the wheels are off the ground, and we have a decent enough vertical speed, we should just turn on the autopilot and let it deal with the rest of our flight. For our purposes, that’s going to be “is our VS more than 100 feet per minute, and are we at least 50 feet above the ground”, both of which happen <em>pretty</em> quickly after takeoff.</p>

<div><pre><code>  <span>...</span>

  <span>/**
   * Check if the plane's in a state where we can hand things off to the regular autopilot
   */</span>
  <span>async</span> <span>checkHandoff</span><span>({</span> <span>isAcrobatic</span><span>,</span> <span>engineCount</span> <span>},</span> <span>{</span> <span>alt</span><span>,</span> <span>onGround</span><span>,</span> <span>VS</span><span>,</span> <span>altAboveGround</span><span>,</span> <span>declination</span> <span>})</span> <span>{</span>
    <span>const</span> <span>handoff</span> <span>=</span> <span>!</span><span>onGround</span> <span>&amp;&amp;</span> <span>VS</span> <span>&gt;</span> <span>MIN_VS</span> <span>&amp;&amp;</span> <span>altAboveGround</span> <span>&gt;</span> <span>50</span><span>;</span>
    <span>if</span> <span>(</span><span>handoff</span><span>)</span> <span>{</span>
      <span>const</span> <span>{</span> <span>api</span><span>,</span> <span>autopilot</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>

      <span>// Make sure that this is the last thing we do. Even if</span>
      <span>// we get called again for some reason, this flag will</span>
      <span>// prevent auto-takeoff code from kicking in.</span>
      <span>this</span><span>.</span><span>done</span> <span>=</span> <span>true</span><span>;</span>

      <span>// Then: gear up, if we have retractible gear</span>
      <span>api</span><span>.</span><span>trigger</span><span>(</span><span>`GEAR_UP`</span><span>);</span>

      <span>// And ease the throttle back a little to "not maxed out"</span>
      <span>for</span> <span>(</span><span>let</span> <span>i</span> <span>=</span> <span>1</span><span>;</span> <span>i</span> <span>&lt;=</span> <span>engineCount</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>{</span>
        <span>api</span><span>.</span><span>set</span><span>(</span><span>`GENERAL_ENG_THROTTLE_LEVER_POSITION:</span><span>${</span><span>i</span><span>}</span><span>`</span><span>,</span> <span>90</span><span>);</span>
      <span>}</span>

      <span>// Also, if we're in an acrobatic plane, immediately</span>
      <span>// set the rudder back to zero so we don't bias the flight.</span>
      <span>if</span> <span>(</span><span>isAcrobatic</span><span>)</span> <span>{</span>
        <span>api</span><span>.</span><span>set</span><span>(</span><span>`RUDDER_POSITION`</span><span>,</span> <span>0</span><span>);</span>
      <span>}</span>

      <span>// And then, of course: turn the "regular" autopilot on.</span>
      <span>autopilot</span><span>.</span><span>setParameters</span><span>({</span>
        <span>MASTER</span><span>:</span> <span>true</span><span>,</span>
        <span>[</span><span>AUTO_THROTTLE</span><span>]:</span> <span>true</span><span>,</span>
        <span>[</span><span>LEVEL_FLIGHT</span><span>]:</span> <span>true</span><span>,</span>
        <span>[</span><span>ALTITUDE_HOLD</span><span>]:</span> <span>alt</span> <span>+</span> <span>500</span><span>,</span>
        <span>[</span><span>HEADING_MODE</span><span>]:</span> <span>this</span><span>.</span><span>heading</span> <span>-</span> <span>declination</span><span>,</span>
        <span>[</span><span>TERRAIN_FOLLOW</span><span>]:</span> <span>true</span><span>,</span>
        <span>[</span><span>AUTO_TAKEOFF</span><span>]:</span> <span>false</span><span>,</span>
      <span>});</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And… that’s it, we implemented auto-takeoff! After the ordeal that was terrain-follow, this was almost no effort! So… who wants to fly around New Zealand’s South Island for a bit?</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240213211816394.png" alt="image-20240213211816394"></p>

<h3 id="testing-our-code-3">Testing our code</h3>

<p>And with that, we should be able to just spawn planes, click <code>AP</code>, click <code>auto takeoff</code> and just… fly. And because it’s a gorgeous place to fly out of, let’s head on over to <a href="https://dingleburn.co.nz/">Dingleburn Station</a> in [Wānaka ](https://en.wikipedia.org/wiki/W%C4%81naka, and do some flying. The nice thing about Dingleburn station is that if we just take off and keep going in a straight line,  we end up putting the autopilot through its paces:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240213212355664.png" alt="image-20240213212355664"></p>

<h4 id="dehavilland-dhc-2-beaver-1">DeHavilland DHC-2 Beaver</h4>

<p>Come on. This is what bush planes were made for. Let’s go already!</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240213212643808.png" alt="image-20240213212643808"></p>

<p>I think it’s safe to say, this is working brilliantly.</p>

<h4 id="cessna-310r-1">Cessna 310R</h4>

<p>Now, this is not a very long runway, but it <em>is</em> downhill, so we might make it!</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240213212849446.png" alt="image-20240213212849446"></p>

<p>cmon cmon cmon c-</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240213212913151.png" alt="image-20240213212913151"></p>

<p>nope.</p>

<p>What if we get a little more aggressive in our takeoff?</p>

<div><pre><code>  <span>...</span>

  <span>async</span> <span>checkRotation</span><span>({</span> <span>minRotation</span><span>,</span> <span>takeoffSpeed</span><span>,</span> <span>isAcrobatic</span> <span>},</span> <span>{</span> <span>elevator</span><span>,</span> <span>speed</span><span>,</span> <span>VS</span><span>,</span> <span>bank</span> <span>})</span> <span>{</span>
    <span>let</span> <span>minRotate</span> <span>=</span> <span>minRotation</span><span>;</span>
    <span>if</span> <span>(</span><span>minRotate</span> <span>&lt;</span> <span>0</span><span>)</span> <span>minRotate</span> <span>=</span> <span>takeoffSpeed</span><span>;</span> <span>// Goodbye, 1.5x safety margin...</span>
    <span>const</span> <span>rotate</span> <span>=</span> <span>speed</span> <span>&gt;=</span> <span>minRotate</span><span>;</span> <span>// And goodbye, additional 1.25x safety margin!</span>

    <span>...</span>
  <span>}</span>

  <span>...</span>
</code></pre></div>

<p>There, how do we do now?</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240213213207296.png" alt="image-20240213213207296"></p>

<p>Seriously? I’ve flown out of this place in the 310R, it’s a joy, what more do you want?</p>

<p>… as it turns out, what it wants is something that knows that there’s trees at the end of the “runway” and thus knows to pull up hard to avoid them, which our autopilot just can’t do. Of course, this code isn’t done: we <em>could</em> spend the next few days trying to refine it so that planes take off as early and as steeply as they physically can, but that sounds more like an exercise for the reader. In the mean time, we can still take off from something a little more “runway” than a grass field. Welcome to <a href="https://en.wikipedia.org/wiki/Chilliwack">Chilliwack</a>, BC, Canada.</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240229205717077.png" alt="image-20240229205717077"></p>

<p>Bit of a challenge: we’re starting at, basically, sea level, and we’ll need to get ourselves up many thousands of feet if we want to live.</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240229205917427.png" alt="image-20240229205917427"></p>

<p>Which we can’t, so I’ll set the plane to 360 degrees instead, which will give it a slight more realistic target:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240229210154744.png" alt="image-20240229210154744"></p>

<p>And now we’ll get there so we can fly over, not <em>into</em>, the <a href="https://en.wikipedia.org/wiki/Canadian_Cascade_Arc">Canadian Cascades</a>!</p>

<h2 id="auto-landing">Auto-landing</h2>

<p>Of course, a flight consists of three parts: takeoff, “the flight” and landing, so… before we consider end this thing I’d say there’s one more thing we should take a crack at.</p>

<h3 id="auto-landing-phases">Auto-landing phases</h3>

<p>There’s a couple of steps and phases that we need to implement, starting with the most obvious one: finding an airport to land at. MSFS has two ways to check for airports, one that just gets every airport in the game, which is maybe a bit much,  and one that gets all airports in the current “local reality bubble” (the SDK term for how much of the world is loaded in), with two event listeners for when new airports get loaded into, or are removed from, the bubble. To make life a little easier (and faster), the API wrapper we’re using comes with an airport database (based on MSFS’s own data) that makes finding nearby airports a little easier as we’re not tied to the local reality bubble but can instead ask for airports within a certain radius of our plane.</p>

<ol>
  <li>Find all nearby airports,
    <ol>
      <li>if we’re flying a flight plan, we’ll assume we want that relative to the last waypoint,</li>
      <li>otherwise, we’ll want that relative to the plane.</li>
    </ol>
  </li>
  <li>sort that list by distance, and then keep the airports that are 25NM or closer:
    <ol>
      <li>find the approach(es) we’d need to fly (even if one airport is closer than another, that may not be true for their approach points)</li>
      <li>remove any airport from the list for which the approach is too hard (or downright impossible: don’t try to land a DC-3 at a float plane dock. It’s probably not going to end well).</li>
    </ol>
  </li>
  <li>From the list of airports left, pick the one with the nearest approach point, and then</li>
  <li>Determine how many waypoints we need to place, and where, so that the plane can fly that (part of the) flight path as a dedicated “landing approach”.</li>
</ol>

<p>That part will get us lined up with a runway, after which we’ll actually be able to start our landing, consisting of the following phases:</p>

<ol>
  <li>The slow-down phase, where we try to slow the plane down to a speed where “we should survive landing”,</li>
  <li>the descent phase, where we slowly drop to an altitude from which we’ll (hopefully) survive landing
    <ol>
      <li>we’ll drop gear and add flaps (once we’re going slow enough to safely be able to do those)</li>
    </ol>
  </li>
  <li>The “short final” phase, where we’re basically at the runway and it’s time to send the plane down towards the ground,</li>
  <li>The initial touch down, where we cut the throttle, and probably bounce a bit.</li>
  <li>The roll-out, where we apply brakes and use the rudder to keep us straight on the runway as we slow down, and finally</li>
  <li>The end of our landing, where the plane has stopped, we can let go of the breaks, retract the flaps, and because we’re in a sim, turn off the engine(s) in the middle of the runway and call it a day.</li>
</ol>

<p>Note that this is a rather a “simplified landing” that you’d never fly in real life, or even in-sim if you’re flying the plane yourself, but we’re already trying to do more than we set out to do, and we’re not going for realism so much as “can we get JS to land a plane <em>at all</em>?”</p>

<p>So, let’s write some code</p>

<h3 id="a-basic-framework">A basic framework</h3>

<p>Let’s start with (what else) a new file in <code>src/autopilot</code> called <code>auto-landing.js</code> that can run through a sequence of stages:</p>

<div><pre><code><span>// We'll move these to our `constants.js` file once we're done.</span>
<span>const</span> <span>CUT_THE_ENGINES</span> <span>=</span> <span>`CUT_THE_ENGINES`</span><span>;</span>
<span>const</span> <span>END_OF_LANDING</span> <span>=</span> <span>`END_OF_LANDING`</span><span>;</span>
<span>const</span> <span>FLY_THE_GLIDE_SLOPE</span> <span>=</span> <span>`FLY_THE_GLIDE_SLOPE`</span><span>;</span>
<span>const</span> <span>GET_ONTO_THE_APPROACH</span> <span>=</span> <span>`GET_ONTO_THE_APPROACH`</span><span>;</span>
<span>const</span> <span>LAND_ON_THE_RUNWAY</span> <span>=</span> <span>`LAND_ON_THE_RUNWAY`</span><span>;</span>
<span>const</span> <span>RIDE_OUT_SHORT_FINAL</span> <span>=</span> <span>`RIDE_OUT_SHORT_FINAL`</span><span>;</span>
<span>const</span> <span>ROLL_AND_BRAKE</span> <span>=</span> <span>`ROLL_AND_BRAKE`</span><span>;</span>
<span>const</span> <span>THROTTLE_TO_GLIDE_SPEED</span> <span>=</span> <span>`THROTTLE_TO_GLIDE_SPEED`</span><span>;</span>

<span>const</span> <span>LANDING_STEPS</span> <span>=</span> <span>[</span>
  <span>GET_ONTO_THE_APPROACH</span><span>,</span>
  <span>THROTTLE_TO_GLIDE_SPEED</span><span>,</span>
  <span>FLY_THE_GLIDE_SLOPE</span><span>,</span>
  <span>RIDE_OUT_SHORT_FINAL</span><span>,</span>
  <span>CUT_THE_ENGINES</span><span>,</span>
  <span>LAND_ON_THE_RUNWAY</span><span>,</span>
  <span>ROLL_AND_BRAKE</span><span>,</span>
  <span>END_OF_LANDING</span><span>,</span>
<span>];</span>

<span>// We'll define a simple sequencer that we can use</span>
<span>// to step through the various stgages of our landing.</span>
<span>class</span> <span>Sequence</span> <span>{</span>
  <span>constructor</span><span>(</span><span>api</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>api</span> <span>=</span> <span>api</span><span>;</span>
    <span>this</span><span>.</span><span>reset</span><span>();</span>
  <span>}</span>
  <span>reset</span><span>(</span><span>steps</span> <span>=</span> <span>LANDING_STEPS</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>steps</span> <span>=</span> <span>steps</span><span>.</span><span>slice</span><span>();</span>
    <span>this</span><span>.</span><span>nextStage</span><span>();</span>
  <span>}</span>
  <span>nextStage</span><span>()</span> <span>{</span>
    <span>this</span><span>.</span><span>step</span> <span>=</span> <span>this</span><span>.</span><span>steps</span><span>.</span><span>shift</span><span>();</span>
    <span>return</span> <span>this</span><span>.</span><span>step</span><span>;</span>
  <span>}</span>
  <span>setStage</span><span>(</span><span>step</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>steps</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>if</span> <span>(</span><span>steps</span><span>.</span><span>includes</span><span>(</span><span>step</span><span>))</span> <span>{</span>
      <span>this</span><span>.</span><span>step</span> <span>=</span> <span>step</span><span>;</span>
      <span>while</span> <span>(</span><span>steps</span><span>[</span><span>0</span><span>]</span> <span>!==</span> <span>step</span><span>)</span> <span>steps</span><span>.</span><span>shift</span><span>();</span>
      <span>return</span> <span>true</span><span>;</span>
    <span>}</span>
  <span>}</span>
<span>}</span>

<span>// And our autolanding class. Which does nothing yet.</span>
<span>export</span> <span>class</span> <span>Autolanding</span> <span>{</span>
  <span>constructor</span><span>(</span><span>autopilot</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>flightModel</span><span>)</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`autolanding:`</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>);</span>
    <span>this</span><span>.</span><span>autopilot</span> <span>=</span> <span>autopilot</span><span>;</span>
    <span>this</span><span>.</span><span>reset</span><span>(</span><span>autopilot</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>flightModel</span><span>);</span>
  <span>}</span>

  <span>reset</span><span>(</span><span>autopilot</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>flightModel</span><span>)</span> <span>{</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`resetting autolanding`</span><span>);</span>
    <span>this</span><span>.</span><span>stage</span> <span>=</span> <span>new</span> <span>Sequence</span><span>(</span><span>autopilot</span><span>);</span>
    <span>const</span> <span>{</span> <span>vs1</span><span>,</span> <span>climbSpeed</span><span>,</span> <span>cruiseSpeed</span><span>,</span> <span>isFloatPlane</span> <span>}</span> <span>=</span> <span>flightModel</span><span>;</span>
    <span>// We'll be looking at "determineLanding" in a bit.</span>
    <span>this</span><span>.</span><span>approachData</span> <span>=</span> <span>determineLanding</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>vs1</span><span>,</span> <span>climbSpeed</span><span>,</span> <span>cruiseSpeed</span><span>,</span> <span>isFloatPlane</span><span>));</span>
  <span>}</span>

  <span>async</span> <span>run</span><span>(</span><span>flightInformation</span><span>)</span> <span>{</span>
    <span>// And we're going to look at what's supposed to go here *in depth* later!</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>With the <code>autopilot.js</code> code updated to run this code:</p>

<div><pre><code><span>import</span> <span>{</span> <span>...,</span> <span>AUTO_LANDING</span><span>,</span> <span>AUTO_LANDING_DATA</span> <span>}</span> <span>from</span> <span>"</span><span>../utils/constants.js</span><span>"</span><span>;</span>

<span>...</span>
<span>// we're going to load this one a little differently,</span>
<span>// because we need to keep a "persistent copy" that can</span>
<span>// survive the autopilot itself getting reloaded:</span>
<span>let</span> <span>{</span> <span>AutoLanding</span> <span>}</span> <span>=</span> <span>await</span> <span>watch</span><span>(</span><span>dirname</span><span>,</span> <span>`auto-landing.js`</span><span>);</span>

<span>export</span> <span>class</span> <span>Autopilot</span> <span>{</span>
  <span>...</span>

  <span>reset</span><span>(...)</span> <span>{</span>
    <span>...</span>
    <span>this</span><span>.</span><span>modes</span> <span>=</span> <span>{</span>
      <span>...</span>
      <span>[</span><span>AUTO_LANDING</span><span>]:</span> <span>false</span><span>,</span>
      <span>[</span><span>AUTO_LANDING_DATA</span><span>]:</span> <span>false</span><span>,</span>
    <span>};</span>
    <span>...</span>

		<span>watch</span><span>(</span><span>dirname</span><span>,</span> <span>`auto-landing.js`</span><span>,</span> <span>(</span><span>lib</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>AutoLanding</span> <span>=</span> <span>lib</span><span>.</span><span>AutoLanding</span><span>;</span>
      <span>if</span> <span>(</span><span>this</span><span>.</span><span>autoLanding</span><span>)</span> <span>{</span>
        <span>Object</span><span>.</span><span>setPrototypeOf</span><span>(</span><span>this</span><span>.</span><span>autoLanding</span><span>,</span> <span>AutoLanding</span><span>.</span><span>prototype</span><span>);</span>
      <span>}</span>
    <span>});</span>
  <span>}</span>

  <span>...</span>

  <span>async</span> <span>setTarget</span><span>(</span><span>key</span><span>,</span> <span>value</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>api</span><span>,</span> <span>modes</span><span>,</span> <span>trim</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>...</span>

    <span>// This one's a bit lengthy...</span>
    <span>if</span> <span>(</span><span>key</span> <span>===</span> <span>AUTO_LANDING</span><span>)</span> <span>{</span>
      <span>// If we're turning on auto-landing, and we don't have</span>
      <span>// a flight plan loaded, that landing should be planned</span>
      <span>// relative to the plane. But, if we do *do* have a flight</span>
      <span>// plan, that landing should be planned relative to the</span>
      <span>// last (non-landing) point on our flight plan:</span>
      <span>if</span> <span>(</span><span>value</span> <span>===</span> <span>true</span> <span>&amp;&amp;</span> <span>this</span><span>.</span><span>flightInformation</span><span>?.</span><span>data</span><span>)</span> <span>{</span>
        <span>let</span> <span>{</span> <span>lat</span><span>,</span> <span>long</span> <span>}</span> <span>=</span> <span>this</span><span>.</span><span>flightInformation</span><span>.</span><span>data</span><span>;</span>
        <span>const</span> <span>{</span> <span>waypoints</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
        <span>if</span> <span>(</span><span>waypoints</span><span>.</span><span>active</span><span>)</span> <span>{</span>
          <span>const</span> <span>{</span> <span>lat</span><span>:</span> <span>t</span><span>,</span> <span>long</span><span>:</span> <span>g</span> <span>}</span> <span>=</span> <span>waypoints</span><span>.</span><span>getWaypoints</span><span>().</span><span>at</span><span>(</span><span>-</span><span>1</span><span>);</span>
          <span>lat</span> <span>=</span> <span>t</span><span>;</span>
          <span>long</span> <span>=</span> <span>g</span><span>;</span>
        <span>}</span>
        <span>// If we don't have an autolanding set, create one</span>
        <span>if</span> <span>(</span><span>!</span><span>this</span><span>.</span><span>autoLanding</span><span>)</span> <span>{</span>
          <span>this</span><span>.</span><span>autoLanding</span> <span>=</span> <span>new</span> <span>AutoLanding</span><span>(</span><span>this</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>this</span><span>.</span><span>flightInformation</span><span>.</span><span>model</span><span>);</span>
          <span>this</span><span>.</span><span>setTarget</span><span>(</span><span>AUTO_LANDING_DATA</span><span>,</span> <span>this</span><span>.</span><span>autoLanding</span><span>.</span><span>approachData</span> <span>??</span> <span>{});</span>
        <span>}</span>
        <span>// Then reset it for our current "last waypoint" or plane position.</span>
        <span>this</span><span>.</span><span>autoLanding</span><span>.</span><span>reset</span><span>(</span><span>this</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>this</span><span>.</span><span>flightInformation</span><span>.</span><span>model</span><span>);</span>
      <span>}</span>
    <span>}</span>
  <span>}</span>

  <span>...</span>

  <span>async</span> <span>run</span><span>()</span> <span>{</span>
    <span>...</span>
    <span>try</span> <span>{</span>
      <span>...</span>
      <span>if</span> <span>(</span><span>modes</span><span>[</span><span>AUTO_TAKEOFF</span><span>]</span> <span>&amp;&amp;</span> <span>autoTakeoff</span><span>)</span> <span>await</span> <span>autoTakeoff</span><span>.</span><span>run</span><span>(</span><span>flightInformation</span><span>);</span>
      <span>else</span> <span>if</span> <span>(</span><span>this</span><span>.</span><span>autoLanding</span> <span>&amp;&amp;</span> <span>!</span><span>this</span><span>.</span><span>autoLanding</span><span>.</span><span>done</span><span>)</span> <span>await</span> <span>this</span><span>.</span><span>autoLanding</span><span>.</span><span>run</span><span>(</span><span>flightInformation</span><span>);</span>
    <span>}</span> <span>catch</span> <span>(</span><span>e</span><span>)</span> <span>{</span> <span>console</span><span>.</span><span>warn</span><span>(</span><span>e</span><span>);</span> <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And the associated new mode constant in <code>constants.js</code>:</p>

<div><pre><code><span>...</span>

<span>// auto landing</span>
<span>export</span> <span>const</span> <span>AUTO_LANDING</span> <span>=</span> <span>`ATL`</span><span>;</span>
<span>export</span> <span>const</span> <span>AUTO_LANDING_DATA</span> <span>=</span> <span>`ALD`</span><span>;</span>
<span>export</span> <span>const</span> <span>GLIDE_SLOPE_DURATION</span> <span>=</span> <span>3</span><span>;</span> <span>// minutes</span>
<span>export</span> <span>const</span> <span>GLIDE_SLOPE_MAX_VS</span> <span>=</span> <span>400</span><span>;</span> <span>// feet per minute</span>
</code></pre></div>

<p>And then more of the same updates for our browser page. First, <code>public/js/autopilot.js</code>:</p>

<div><pre><code><span>...</span>
<span>export</span> <span>const</span> <span>AP_OPTIONS</span> <span>=</span> <span>{</span>
  <span>...</span>
  <span>ATL</span><span>:</span> <span>false</span><span>,</span>
<span>};</span>
<span>...</span>
</code></pre></div>

<p>And our <code>public/autopilot.html</code>:</p>

<div><pre><code><span>&lt;div</span> <span>class=</span><span>"controls"</span><span>&gt;</span>
  ...
  <span>&lt;fieldset&gt;</span>
    <span>&lt;button</span> <span>title=</span><span>"terrain follow"</span> <span>class=</span><span>"TER"</span><span>&gt;</span>terrain follow<span>&lt;/button&gt;</span>
    <span>&lt;button</span> <span>title=</span><span>"auto takeoff"</span> <span>class=</span><span>"ATO"</span><span>&gt;</span>take off<span>&lt;/button&gt;</span>
    <span>&lt;button</span> <span>title=</span><span>"auto landing"</span> <span>class=</span><span>"ATL"</span><span>&gt;</span>land<span>&lt;/button&gt;</span>
  <span>&lt;/fieldset&gt;</span>
<span>&lt;/div&gt;</span>
</code></pre></div>

<p>Which is our prep work done, and we can get to implementing the auto landing logic.</p>

<h3 id="finding-our-landing">Finding our landing</h3>

<p>Finding airports is pretty straight forward, thanks to <code>msfs-simconnect-api-wrapper</code>’s built-in <code>loadAirportDB</code> function:</p>

<div><pre><code><span>...</span>

<span>// Load every airport known to MSFS. This will use up less than</span>
<span>// 100MB of memory, which is literally nothing for any desktop computer:</span>
<span>import</span> <span>{</span> <span>loadAirportDB</span> <span>}</span> <span>from</span> <span>"</span><span>msfs-simconnect-api-wrapper</span><span>"</span><span>;</span>
<span>const</span> <span>airports</span> <span>=</span> <span>loadAirportDB</span><span>();</span>

<span>export</span> <span>class</span> <span>Autolanding</span> <span>{</span>
  <span>...</span>
<span>}</span>


<span>/**
 * The function name really explains itself...
 */</span>
<span>function</span> <span>determineLanding</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>vs1</span><span>,</span> <span>climbSpeed</span><span>,</span> <span>cruiseSpeed</span><span>,</span> <span>waterLanding</span><span>)</span> <span>{</span>
  <span>// Get the shortlist of 10 airports near us that we can land at.</span>
  <span>let</span> <span>shortList</span> <span>=</span> <span>airports</span>
    <span>.</span><span>filter</span><span>((</span><span>a</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>if</span> <span>(</span><span>waterLanding</span><span>)</span> <span>return</span> <span>a</span><span>;</span> <span>// float planes *can* land on real runways</span>
      <span>else</span> <span>return</span> <span>a</span><span>.</span><span>runways</span><span>.</span><span>some</span><span>((</span><span>r</span><span>)</span> <span>=&gt;</span> <span>r</span><span>.</span><span>surface</span><span>.</span><span>includes</span><span>(</span><span>`water`</span><span>)</span> <span>===</span> <span>false</span><span>);</span>
    <span>})</span>
    <span>.</span><span>map</span><span>((</span><span>a</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>a</span><span>.</span><span>distance</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>a</span><span>.</span><span>latitude</span><span>,</span> <span>a</span><span>.</span><span>longitude</span><span>);</span>
      <span>return</span> <span>a</span><span>;</span>
    <span>})</span>
    <span>.</span><span>sort</span><span>((</span><span>a</span><span>,</span> <span>b</span><span>)</span> <span>=&gt;</span> <span>a</span><span>.</span><span>distance</span> <span>-</span> <span>b</span><span>.</span><span>distance</span><span>)</span>
    <span>.</span><span>filter</span><span>((</span><span>a</span><span>)</span> <span>=&gt;</span> <span>a</span><span>.</span><span>distance</span> <span>&lt;</span> <span>25</span> <span>*</span> <span>KM_PER_NM</span><span>);</span>

  <span>...</span>
</code></pre></div>

<p>Of course, just finding the “nearest airports” isn’t really all that useful if we can’t land at them, so we need some more code to actually determine what landings at each airport look like, and whether or not those will work for us:</p>

<div><pre><code>  <span>...</span>

  <span>// Then we do a quick clone so we don't overwrite the airport</span>
  <span>// DB when we do our calculations (which will involve updating</span>
  <span>// elevations at points that might be runway points)</span>
  <span>shortList</span> <span>=</span> <span>JSON</span><span>.</span><span>parse</span><span>(</span><span>JSON</span><span>.</span><span>stringify</span><span>(</span><span>shortList</span><span>));</span>
  <span>console</span><span>.</span><span>log</span><span>(</span><span>`Checking </span><span>${</span><span>shortList</span><span>.</span><span>length</span><span>}</span><span> airports`</span><span>);</span>

  <span>// Then for each of these airports, determine their approach(es) or rule them out.</span>
  <span>shortList</span><span>.</span><span>forEach</span><span>((</span><span>airport</span><span>)</span> <span>=&gt;</span> <span>{</span>
    <span>airport</span><span>.</span><span>runways</span><span>.</span><span>forEach</span><span>((</span><span>runway</span><span>)</span> <span>=&gt;</span> <span>{</span>
      <span>// This is a pretty important function...</span>
      <span>calculateRunwayApproaches</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>vs1</span><span>,</span> <span>climbSpeed</span><span>,</span> <span>cruiseSpeed</span><span>,</span> <span>airport</span><span>,</span> <span>runway</span><span>);</span>
    <span>});</span>
  <span>});</span>

  <span>// Then figure out which approach will be our best/safest option.</span>
  <span>const</span> <span>approachData</span> <span>=</span> <span>findAndBindBestApproach</span><span>(</span><span>shortList</span><span>);</span>

  <span>// If that's none of them: sucks to be us! O_O</span>
  <span>if</span> <span>(</span><span>!</span><span>approachData</span><span>)</span> <span>{</span>
    <span>console</span><span>.</span><span>error</span><span>(</span><span>`There is nowhere to land!`</span><span>);</span>
    <span>return</span> <span>false</span><span>;</span>
  <span>}</span>

  <span>// Otherwise, this is the approach we'll be flying.</span>
  <span>return</span> <span>approachData</span><span>;</span>
<span>}</span>
</code></pre></div>
<p>Assuming that <code>calculateRunwayApproaches</code> and <code>findAndBindBestApproach</code> work, that should be all the code we need. Let’s look at that second one first, since it’s pretty easy:</p>

<div><pre><code><span>/**
 * Find the airport, runway, and approach with the longest
 * runway, to give ourselves the best possible chance of success.
 */</span>
<span>function</span> <span>findAndBindBestApproach</span><span>(</span><span>airports</span><span>)</span> <span>{</span>
  <span>const</span> <span>flatList</span> <span>=</span> <span>[];</span>

  <span>airports</span><span>.</span><span>forEach</span><span>((</span><span>airport</span><span>)</span> <span>=&gt;</span>
    <span>airport</span><span>.</span><span>runways</span><span>.</span><span>forEach</span><span>((</span><span>runway</span><span>)</span> <span>=&gt;</span>
      <span>runway</span><span>.</span><span>approach</span><span>.</span><span>forEach</span><span>((</span><span>approach</span><span>)</span> <span>=&gt;</span> <span>{</span>
        <span>if</span> <span>(</span><span>approach</span><span>.</span><span>works</span><span>)</span> <span>{</span>
          <span>flatList</span><span>.</span><span>push</span><span>({</span>
            <span>airport</span><span>,</span>
            <span>runway</span><span>,</span>
            <span>approach</span><span>,</span>
          <span>});</span>
        <span>}</span>
      <span>})</span>
    <span>)</span>
  <span>);</span>

  <span>return</span> <span>flatList</span><span>.</span><span>sort</span><span>((</span><span>a</span><span>,</span> <span>b</span><span>)</span> <span>=&gt;</span> <span>b</span><span>.</span><span>runway</span><span>.</span><span>length</span> <span>-</span> <span>a</span><span>.</span><span>runway</span><span>.</span><span>length</span><span>)[</span><span>0</span><span>];</span>
<span>}</span>
</code></pre></div>

<p>Mostly “to the point” code: create a flat list of approaches that’ll work, then sort them based on runway length, and pick the one with the longest runway (to give ourselves the best odds of surviving the landing).</p>

<p>However, that <code>calculateRunwayApproaches</code> function is going to need a little more work. And by a little, I mean a lot. Conceptually, it’s not too complicated:</p>

<ul>
  <li>for each airport:
    <ul>
      <li>for each runway at that airport:
        <ul>
          <li>for both possible approaches for that runway:
            <ul>
              <li>set up an approach flight path and check whether the terrain allows us to fly that</li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>Of course the “set up an approach flight path” is doing a lot of heavy lifting here, because we’ll want a path that lets us perform a bunch of different actions:</p>

<ul>
  <li>figure out a flight plan that gets us straight (enough) onto our approach</li>
  <li>slow down from cruise speed to “safe to land at” speed,</li>
  <li>drop from “whatever altitude we’re flying” all the way down to a runway</li>
  <li><em>actually touch down on a runway without crashing</em></li>
  <li>roll out the runway while braking and <em>hopefully</em> stop before the end.</li>
</ul>

<p>Which means that we’ll need to do a bit of thinking about what an approach looks like. There’s (at least) five points of interest during the landing procedure that we outlined above, which we can draw out as follows:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240222093324423.png" alt="image-20240222093324423"></p>

<p>in this, we already have our points 5 and 4: they’re the runway end and start (relative to how we’re approaching the runway). P<sub>1</sub> is the point at which we switch from “flying” to “lining up for our approach”, and where we start to slow does the plane to somewhere between climb and cruise speed, P<sub>2</sub> is where we start descending, and P<sub>3</sub> is where we slow down the plane’s descent and speed so we can hopefully land onto the runway rather than destroy our landing gear on impact.</p>

<p>So where do we place the first three points? Not to complicate things more than we need to but: it depends. Mostly, it depends on what elevation we want these points to sit at, and that’s kind of “up to us”, so I’m going to make an executive decision here based on absolutely nothing other than “it seems reasonable”:</p>

<ul>
  <li>P<sub>5</sub> will will be the same elevation as the runway itself.</li>
  <li>P<sub>4</sub> will be a little bit higher, say 15 feet above the runway, so that when we get that, our plane will (hopefully) clear any trees that MSFS decides to place right at the edge of the runway. It’s genuinely baffling how often it does this.</li>
  <li>We’ll put P<sub>3</sub> at 200 feet above the runway, so that we need to drop less than 200 feet in our short final (in a real ILS landing, this would be the “middle marker”, or MM),</li>
  <li>We can basically put P<sub>2</sub> at whatever elevation we want, but that’s a little too free for an initial stab at an auto-lander, so instead we’re going to put it at 1400 feet above the runway (in a real ILS landing, this would be the outer marker, or OM). Paired with a 3 degree glide slope, that sets the distance between P<sub>3</sub> and P<sub>2</sub> at around  4.5 nautical miles, or about 3 minutes of flight at 100 knots, and a vertical speed of about 400 feet per minute (since we’re going to descend from 1400 feet above the runway to 200 feet above the runway for a total of 1200 feet over three minutes),</li>
  <li>and to make sure we’re at the right elevation by the time we get to P<sub>2</sub>, we’ll set P<sub>1</sub> to the same elevation as P<sub>2</sub>.</li>
</ul>

<p>Which means that if we know our speed, we can put some real distances to this image. So let’s mandate some speeds:</p>

<ul>
  <li>At P<sub>1</sub> we’re going at cruise speed, but by the time we reach P<sub>2</sub> we’ll want to be flying our “climb speed, plus 20 knots” so that we can safely fly our glide slope: we <em>could</em> target a speed that is equal to our climb speed, but if we drop too fast because of some low density air or downdraft, we probably won’t be able to recover as easily as when we’re flying a little faster than our minimum climb speed.</li>
  <li>We can also mandate that the moment we cross P<sub>4</sub> we want to cut our engines and just coast down to the runway. As long as we make sure the plane pitches up a tiny bit (say, 2 degrees) this should be “perfectly safe”. Provided the runway’s long enough.</li>
  <li>Consequently, our speed at P<sub>5</sub> doesn’t really matter: ideally we’ve already stopped the plane before then, but even if we cross it, the engines are off already so our speed is irrelevant.</li>
  <li>Leaving P<sub>3</sub>: since we only need to  drop a tiny distance once we get to P<sub>3</sub> we can reduce speed to climb speed. Although some planes have an aggressively high climb speed, and we’re only going to be a minute out from the runway by the time we get here, so let’s go with “climb speed, or 100 knots, whichever is lower”. If a plane can’t stay in the air at 100 knots, we’re flying something very curious indeed.</li>
</ul>

<p>And now we can finally point some distances to our graphic:</p>

<ul>
  <li>Our drop to the runway is less than 200 feet, so I’m just going to put P<sub>3</sub> “one minute’s worth of flight time” away from P<sub>4</sub> and that should be more than enough.</li>
  <li>And then because of the previous decisions made about the glide slope, the distance from P<sub>3</sub> to P<sub>2</sub> will span three minutes worth of flight time.</li>
  <li>Finally, as it takes a bit for a plane to slow down just by throttling, we’ll put P<sub>1</sub> at 2 minutes of flight away from P<sub>2</sub>.</li>
</ul>

<p>And now we can <em>finally</em> write some actual code!</p>

<div><pre><code><span>...</span>

<span>const</span> <span>{</span> <span>floor</span> <span>}</span> <span>=</span> <span>Math</span><span>;</span>

<span>// Let's formally declare our distances (in flight minutes)</span>
<span>const</span> <span>APPROACH_LINE_DURATION</span> <span>=</span> <span>2</span><span>;</span>
<span>const</span> <span>GLIDE_SLOPE_DURATION</span> <span>=</span> <span>3</span><span>;</span>
<span>const</span> <span>SHORT_FINAL_DURATION</span> <span>=</span> <span>1</span><span>;</span>

<span>...</span>

<span>function</span> <span>calculateRunwayApproaches</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>vs1</span><span>,</span> <span>climbSpeed</span><span>,</span> <span>cruiseSpeed</span><span>,</span> <span>airport</span><span>,</span> <span>runway</span><span>)</span> <span>{</span>
  <span>const</span> <span>glideSpeed</span> <span>=</span> <span>climbSpeed</span> <span>+</span> <span>20</span><span>;</span>
  <span>const</span> <span>{</span> <span>start</span><span>:</span> <span>a</span><span>,</span> <span>end</span><span>:</span> <span>b</span> <span>}</span> <span>=</span> <span>runway</span><span>;</span>

  <span>runway</span><span>.</span><span>approach</span><span>.</span><span>forEach</span><span>((</span><span>approach</span><span>,</span> <span>idx</span><span>)</span> <span>=&gt;</span> <span>{</span>
    <span>// Where do we touch down?</span>
    <span>const</span> <span>start</span> <span>=</span> <span>idx</span> <span>===</span> <span>0</span> <span>?</span> <span>a</span> <span>:</span> <span>b</span><span>;</span>

    <span>// We now know our runway target altitude:</span>
    <span>const</span> <span>runwayAlt</span> <span>=</span> <span>floor</span><span>(</span><span>start</span><span>[</span><span>2</span><span>]);</span>

    <span>// And so we know everything we need for p4:</span>
    <span>const</span> <span>p4</span> <span>=</span> <span>[</span><span>start</span><span>[</span><span>0</span><span>],</span> <span>start</span><span>[</span><span>1</span><span>],</span> <span>runwayAlt</span> <span>+</span> <span>20</span><span>];</span>

    <span>// And of course, the runway end, and thus p5:</span>
    <span>const</span> <span>end</span> <span>=</span> <span>start</span> <span>===</span> <span>a</span> <span>?</span> <span>b</span> <span>:</span> <span>a</span><span>;</span>
    <span>const</span> <span>p5</span> <span>=</span> <span>[...</span><span>end</span><span>];</span>

    <span>// Next: what's our heading *away from the runway*? Because we're going</span>
    <span>// to be placing points in the opposite direction of the approach heading.</span>
    <span>const</span> <span>heading</span> <span>=</span> <span>getHeadingFromTo</span><span>(</span><span>end</span><span>[</span><span>0</span><span>],</span> <span>end</span><span>[</span><span>1</span><span>],</span> <span>start</span><span>[</span><span>0</span><span>],</span> <span>start</span><span>[</span><span>1</span><span>]);</span>

    <span>// With all that done, let's first assume this approach will work.</span>
    <span>approach</span><span>.</span><span>works</span> <span>=</span> <span>true</span><span>;</span>

    <span>// And then let's calculate the distances we talked about:</span>
    <span>const</span> <span>flightMinute</span> <span>=</span> <span>(</span><span>v</span><span>)</span> <span>=&gt;</span> <span>(</span><span>v</span> <span>*</span> <span>KM_PER_NM</span><span>)</span> <span>/</span> <span>60</span><span>;</span>
    <span>const</span> <span>d12</span> <span>=</span> <span>APPROACH_LINE_DURATION</span> <span>*</span> <span>flightMinute</span><span>(</span><span>cruiseSpeed</span><span>);</span>
    <span>const</span> <span>d23</span> <span>=</span> <span>GLIDE_SLOPE_DURATION</span> <span>*</span> <span>flightMinute</span><span>(</span><span>glideSpeed</span><span>);</span>
    <span>const</span> <span>d34</span> <span>=</span> <span>SHORT_FINAL_DURATION</span> <span>*</span> <span>flightMinute</span><span>(</span><span>climbSpeed</span><span>);</span>

    <span>// And now we can calculate p1, p2, and p3:</span>
    <span>const</span> <span>getPoint</span> <span>=</span> <span>distance</span> <span>=&gt;</span> <span>getPointAtDistance</span><span>(</span><span>t</span><span>[</span><span>0</span><span>],</span> <span>t</span><span>[</span><span>1</span><span>],</span> <span>distance</span><span>,</span> <span>heading</span><span>);</span>
    <span>const</span> <span>d1</span> <span>=</span> <span>d12</span> <span>+</span> <span>d23</span> <span>+</span> <span>d34</span><span>;</span>
    <span>const</span> <span>{</span> <span>lat</span><span>:</span> <span>p1t</span><span>,</span> <span>long</span><span>:</span> <span>p1g</span> <span>}</span> <span>=</span> <span>getPoint</span><span>(</span><span>d1</span><span>);</span>
    <span>const</span> <span>p1</span> <span>=</span> <span>[</span><span>p1t</span><span>,</span> <span>p1g</span><span>,</span> <span>runwayAlt</span> <span>+</span> <span>1400</span><span>];</span>

    <span>const</span> <span>d2</span> <span>=</span> <span>d23</span> <span>+</span> <span>d34</span><span>;</span>
    <span>const</span> <span>{</span> <span>lat</span><span>:</span> <span>p2t</span><span>,</span> <span>long</span><span>:</span> <span>p2g</span> <span>}</span> <span>=</span> <span>getPoint</span><span>(</span><span>d2</span><span>);</span>
    <span>const</span> <span>p2</span> <span>=</span> <span>[</span><span>p2t</span><span>,</span> <span>p2g</span><span>,</span> <span>runwayAlt</span> <span>+</span> <span>1400</span><span>];</span>

    <span>const</span> <span>d3</span> <span>=</span> <span>d34</span><span>;</span>
    <span>const</span> <span>{</span> <span>lat</span><span>:</span> <span>p3t</span><span>,</span> <span>long</span><span>:</span> <span>p3g</span> <span>}</span> <span>=</span> <span>getPoint</span><span>(</span><span>d3</span><span>);</span>
    <span>const</span> <span>p3</span> <span>=</span> <span>[</span><span>p3t</span><span>,</span> <span>p3g</span><span>,</span> <span>runwayAlt</span> <span>+</span> <span>200</span><span>];</span>

    <span>// And we're done!</span>
    <span>approach</span><span>.</span><span>points</span> <span>=</span> <span>[</span><span>p5</span><span>,</span> <span>p4</span><span>,</span> <span>p3</span><span>,</span> <span>p2</span><span>,</span> <span>p1</span><span>];</span>
  <span>});</span>
<span>}</span>
</code></pre></div>

<p>We have code! And it’s not even particularly complicated, since we worked out all the complicated parts on paper first. However, this is almost certainly not enough points for a proper approach yet… For the why, let’s look at where an airplane can be relative to a straight line path, and what flight path that results in when we apply our waypoint logic.</p>

<graphics-element title="getting onto the approach" src="./graphics/approach-points.js">
  <source src="https://pomax.github.io/are-we-flying/graphics/airplane.js">
</graphics-element>

<p>Initially, this might look like it’ll work just fine, but if we drag the airplane around, we see that our waypoint logic may dictate flight paths that are <em>super bad</em> if the intention is to land, rather than just “fly part of a flight plan”. For a landing we need to be lined up properly by the time we hit P<sub>2</sub>, and the current set of points don’t guarantee this in the slightest.</p>

<p>So, in order to fix that, let’s add some more point based on where the plane is relative to the start of our approach: we’re going to add a point P<sub>A</sub> ahead of P<sub>1</sub> so that we’re not (or, barely) turning onto the approach by the time we <em>reach</em> P<sub>1</sub>:</p>

<graphics-element title="adding an extra point" src="./graphics/approach-points.js">
  <source src="https://pomax.github.io/are-we-flying/graphics/airplane.js">
  <source src="https://pomax.github.io/are-we-flying/graphics/approach-point-pa.js">
</graphics-element>

<p>This is still not great, though, all we’ve done is pushed the problem back a bit. What we really want is for the plane to target P<sub>A</sub> if we’re to the right of P<sub>A</sub>, but target something that will <em>get</em> us to P<sub>A</sub> if we’re to the left of it, which we can achieve by adding an offset point either above or below P<sub>A</sub>:</p>

<graphics-element title="adding an offset" src="./graphics/approach-points.js">
  <source src="https://pomax.github.io/are-we-flying/graphics/airplane.js">
  <source src="https://pomax.github.io/are-we-flying/graphics/approach-point-f1.js">
</graphics-element>

<p>Which almost solves our problem: as long as the plane is beyond our offset (either above or below depending on whether the offset is above or below P<sub>A</sub>) things work pretty well, but if the plane is too close to the approach itself, we can still run into problems, so let’s add one more offset, when the plane is to the left of P<sub>A</sub>, as well as between the approach and the first offset:</p>

<graphics-element title="adding a second offset" src="./graphics/approach-points.js">
  <source src="https://pomax.github.io/are-we-flying/graphics/airplane.js">
  <source src="https://pomax.github.io/are-we-flying/graphics/approach-point-f2.js">
</graphics-element>

<p>And now we have a setup where no matter where the plane is by the time we set up our approach, we’ll be properly lined up by the time we start gliding. Of course, this <em>does</em> complicate our code a bit:</p>

<div><pre><code><span>...</span>

<span>const</span> <span>{</span> <span>abs</span><span>,</span> <span>floor</span><span>,</span> <span>sign</span> <span>}</span> <span>=</span> <span>Math</span><span>;</span>

<span>...</span>

<span>function</span> <span>calculateRunwayApproaches</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>vs1</span><span>,</span> <span>climbSpeed</span><span>,</span> <span>cruiseSpeed</span><span>,</span> <span>airport</span><span>,</span> <span>runway</span><span>)</span> <span>{</span>
  <span>...</span>
  <span>runway</span><span>.</span><span>approach</span><span>.</span><span>forEach</span><span>((</span><span>approach</span><span>,</span> <span>idx</span><span>)</span> <span>=&gt;</span> <span>{</span>
    <span>...</span>
    <span>approach</span><span>.</span><span>points</span> <span>=</span> <span>[</span><span>p5</span><span>,</span> <span>p4</span><span>,</span> <span>p3</span><span>,</span> <span>p2</span><span>,</span> <span>p1</span><span>;</span>

    <span>// Calculate our pA point:</span>
    <span>const</span> <span>dA1</span> <span>=</span> <span>0.75</span> <span>*</span> <span>d12</span><span>;</span>
    <span>const</span> <span>dA</span> <span>=</span> <span>d1</span> <span>+</span> <span>dA1</span><span>;</span>
    <span>const</span> <span>{</span> <span>lat</span><span>:</span> <span>pAt</span><span>,</span> <span>long</span><span>:</span> <span>pAg</span> <span>}</span> <span>=</span> <span>getPoint</span><span>(</span><span>dA</span><span>);</span>
    <span>const</span> <span>pA</span> <span>=</span> <span>[</span><span>pAt</span><span>,</span> <span>pAg</span><span>,</span> <span>p2</span><span>[</span><span>2</span><span>]];</span>
    <span>points</span><span>.</span><span>push</span><span>(</span><span>pA</span><span>);</span>

    <span>// And then check whether we need offset points:</span>
    <span>let</span> <span>f1</span><span>,</span> <span>f2</span><span>;</span>
    <span>const</span> <span>offsetDistance</span> <span>=</span> <span>dA1</span><span>;</span>
    <span>const</span> <span>aHeading</span> <span>=</span> <span>getHeadingFromTo</span><span>(</span><span>pAt</span><span>,</span> <span>pAg</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>);</span>
    <span>const</span> <span>hDiff</span> <span>=</span> <span>getCompassDiff</span><span>(</span><span>heading</span><span>,</span> <span>aHeading</span><span>);</span>

    <span>if</span> <span>(</span><span>hDiff</span> <span>&lt;</span> <span>-</span><span>90</span> <span>||</span> <span>hDiff</span> <span>&gt;</span> <span>90</span><span>)</span> <span>{</span>
      <span>// set up our first offset</span>
      <span>const</span> <span>sgn</span> <span>=</span> <span>sign</span><span>(</span><span>hDiff</span><span>);</span>
      <span>const</span> <span>{</span> <span>lat</span><span>:</span> <span>f1Lat</span><span>,</span> <span>long</span><span>:</span> <span>f1Long</span> <span>}</span> <span>=</span> <span>getPointAtDistance</span><span>(</span><span>pAt</span><span>,</span> <span>pAg</span><span>,</span> <span>offsetDistance</span><span>,</span> <span>heading</span> <span>+</span> <span>sgn</span> <span>*</span> <span>90</span><span>);</span>
      <span>f1</span> <span>=</span> <span>[</span><span>f1Lat</span><span>,</span> <span>f1Long</span><span>,</span> <span>p2</span><span>[</span><span>2</span><span>]];</span>
      <span>points</span><span>.</span><span>push</span><span>(</span><span>f1</span><span>);</span>

      <span>// Do we also need a second offset?</span>
      <span>const</span> <span>p</span> <span>=</span> <span>project</span><span>(</span><span>start</span><span>[</span><span>1</span><span>],</span> <span>start</span><span>[</span><span>0</span><span>],</span> <span>end</span><span>[</span><span>1</span><span>],</span> <span>end</span><span>[</span><span>0</span><span>],</span> <span>long</span><span>,</span> <span>lat</span><span>);</span>
      <span>const</span> <span>distanceToApproach</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>p</span><span>.</span><span>y</span><span>,</span> <span>p</span><span>.</span><span>x</span><span>);</span>
      <span>if</span> <span>(</span><span>abs</span><span>(</span><span>distanceToApproach</span><span>)</span> <span>&lt;</span> <span>offsetDistance</span><span>)</span> <span>{</span>
        <span>const</span> <span>{</span> <span>lat</span><span>:</span> <span>f2t</span><span>,</span> <span>long</span><span>:</span> <span>f2g</span> <span>}</span> <span>=</span> <span>getPointAtDistance</span><span>(</span><span>f1Lat</span><span>,</span> <span>f1Long</span><span>,</span> <span>offsetDistance</span><span>,</span> <span>(</span><span>heading</span> <span>+</span> <span>180</span><span>)</span> <span>%</span> <span>360</span><span>);</span>
        <span>f2</span> <span>=</span> <span>[</span><span>f2t</span><span>,</span> <span>f2g</span><span>,</span> <span>p2</span><span>[</span><span>2</span><span>]];</span>
        <span>points</span><span>.</span><span>push</span><span>(</span><span>f2</span><span>);</span>
      <span>}</span>
    <span>}</span>
  <span>});</span>
<span>}</span>
</code></pre></div>

<p>And now we have all our points! …but we’re still not done. Remember that we assumed this approach would work? We still have to check whether that’s true, but looking at whether there’s terrain interference anywhere, so we can mark the approach as no good if it requires us to fly through some ground for a bit.</p>

<div><pre><code><span>...</span>

<span>// We'll need our ALOS service, but we've seen that code a few times before now:</span>
<span>import</span> <span>dotenv</span> <span>from</span> <span>"</span><span>dotenv</span><span>"</span><span>;</span>
<span>dotenv</span><span>.</span><span>config</span><span>({</span> <span>path</span><span>:</span> <span>ENV_PATH</span> <span>});</span>
<span>const</span> <span>{</span> <span>DATA_FOLDER</span> <span>}</span> <span>=</span> <span>process</span><span>.</span><span>env</span><span>;</span>
<span>const</span> <span>__dirname</span> <span>=</span> <span>import</span><span>.</span><span>meta</span><span>.</span><span>dirname</span><span>;</span>
<span>let</span> <span>alos</span><span>;</span>
<span>let</span> <span>{</span> <span>ALOSInterface</span> <span>}</span> <span>=</span> <span>await</span> <span>watch</span><span>(</span>
  <span>__dirname</span><span>,</span>
  <span>`../elevation/alos-interface.js`</span><span>,</span>
  <span>(</span><span>lib</span><span>)</span> <span>=&gt;</span> <span>{</span>
    <span>ALOSInterface</span> <span>=</span> <span>lib</span><span>.</span><span>ALOSInterface</span><span>;</span>
    <span>if</span> <span>(</span><span>alos</span><span>)</span> <span>{</span>
      <span>Object</span><span>.</span><span>setPrototypeOf</span><span>(</span><span>alos</span><span>,</span> <span>ALOSInterface</span><span>.</span><span>prototype</span><span>);</span>
    <span>}</span>
  <span>}</span>
<span>);</span>
<span>alos</span> <span>=</span> <span>new</span> <span>ALOSInterface</span><span>(</span><span>DATA_FOLDER</span><span>);</span>

<span>// And then we need to add a terrain check to our approach function:</span>
<span>function</span> <span>calculateRunwayApproaches</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>vs1</span><span>,</span> <span>climbSpeed</span><span>,</span> <span>cruiseSpeed</span><span>,</span> <span>airport</span><span>,</span> <span>runway</span><span>)</span> <span>{</span>
  <span>...</span>
  <span>runway</span><span>.</span><span>approach</span><span>.</span><span>forEach</span><span>((</span><span>approach</span><span>,</span> <span>idx</span><span>)</span> <span>=&gt;</span> <span>{</span>
    <span>...</span>

    <span>// We're going to do this the simple way: we're simply going to</span>
    <span>// sample along our path at 100m intervals, and if ALOS says</span>
    <span>// there's an unsafe elevation at any sample point, the approach</span>
    <span>// is bad.</span>
    <span>const</span> <span>{</span> <span>points</span> <span>}</span> <span>=</span> <span>approach</span><span>;</span>
		<span>for</span><span>(</span><span>let</span> <span>i</span><span>=</span><span>0</span><span>,</span> <span>e</span> <span>=</span> <span>points</span><span>.</span><span>length</span> <span>-</span> <span>1</span><span>;</span> <span>i</span><span>&lt;</span><span>e</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>{</span>
      <span>const</span> <span>p1</span> <span>=</span> <span>points</span><span>[</span><span>i</span><span>];</span>
      <span>const</span> <span>p2</span> <span>=</span> <span>points</span><span>[</span><span>i</span><span>+</span><span>1</span><span>];</span>
      <span>const</span> <span>h</span> <span>=</span> <span>getHEadingFromTo</span><span>(</span><span>p1</span><span>[</span><span>0</span><span>],</span> <span>p1</span><span>[</span><span>1</span><span>],</span> <span>p2</span><span>[</span><span>0</span><span>],</span> <span>p2</span><span>[</span><span>1</span><span>]);</span>
      <span>const</span> <span>total</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>p1</span><span>[</span><span>0</span><span>],</span> <span>p1</span><span>[</span><span>1</span><span>],</span> <span>p2</span><span>[</span><span>0</span><span>],</span> <span>p2</span><span>[</span><span>1</span><span>]);</span>
      <span>for</span> <span>(</span><span>let</span> <span>d</span> <span>=</span> <span>0</span><span>;</span> <span>d</span> <span>&lt;=</span> <span>total</span><span>;</span> <span>d</span><span>+=</span><span>0.1</span><span>)</span> <span>{</span>
        <span>const</span> <span>p</span> <span>=</span> <span>getPointAtDistance</span><span>(</span><span>p1</span><span>[</span><span>0</span><span>],</span> <span>p1</span><span>[</span><span>1</span><span>],</span> <span>d</span><span>,</span> <span>h</span><span>);</span>
        <span>const</span> <span>r</span> <span>=</span> <span>d</span><span>/</span><span>total</span><span>;</span>
        <span>const</span> <span>alt</span> <span>=</span> <span>(</span><span>1</span><span>-</span><span>r</span><span>)</span> <span>*</span> <span>p1</span><span>[</span><span>2</span><span>]</span> <span>+</span> <span>r</span> <span>*</span> <span>p2</span><span>[</span><span>2</span><span>];</span>
        <span>const</span> <span>found</span> <span>=</span> <span>alos</span><span>.</span><span>lookup</span><span>(</span><span>p</span><span>.</span><span>lat</span><span>,</span> <span>p</span><span>.</span><span>long</span><span>)</span> <span>*</span> <span>FEET_PER_METER</span><span>;</span>
        <span>if</span> <span>(</span><span>found</span> <span>&gt;</span> <span>alt</span> <span>-</span> <span>100</span><span>)</span> <span>{</span>
          <span>return</span> <span>(</span><span>approach</span><span>.</span><span>works</span> <span>=</span> <span>false</span><span>);</span>
        <span>}</span>
      <span>}</span>
    <span>}</span>
  <span>});</span>
<span>}</span>
</code></pre></div>

<p>And now we’re finally done with our approach-finding code!</p>

<h3 id="tracking-our-landing">Tracking our landing</h3>

<p>Now that we have an approach points, let’s get those added to our waypoint list, but marked as special “landing” points so we can both visualize them differently from other waypoints in the browser, as well as perform checks based on whether we reached the landing portion of our flight plan. First up, the <code>auto-landing.js</code> change:</p>

<div><pre><code><span>...</span>

<span>export</span> <span>class</span> <span>AutoLanding</span> <span>{</span>
  <span>...</span>

  <span>reset</span><span>(</span><span>autopilot</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>flightModel</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>done</span> <span>=</span> <span>false</span><span>;</span>
    <span>this</span><span>.</span><span>stage</span> <span>=</span> <span>new</span> <span>Sequence</span><span>(</span><span>autopilot</span><span>);</span>
    <span>this</span><span>.</span><span>target</span> <span>=</span> <span>false</span><span>;</span>

    <span>// Do we already have a landing mapped and saved in the waypoint manager?</span>
    <span>const</span> <span>{</span> <span>waypoints</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>
    <span>this</span><span>.</span><span>approachData</span> <span>=</span> <span>waypoints</span><span>.</span><span>getLanding</span><span>();</span>
    <span>if</span> <span>(</span><span>this</span><span>.</span><span>approachData</span><span>)</span> <span>return</span><span>;</span>

    <span>// If not, find an approach</span>
    <span>const</span> <span>{</span> <span>climbSpeed</span><span>,</span> <span>cruiseSpeed</span><span>,</span> <span>isFloatPlane</span> <span>}</span> <span>=</span> <span>flightModel</span><span>;</span>
    <span>const</span> <span>approachData</span> <span>=</span> <span>(</span><span>this</span><span>.</span><span>approachData</span> <span>=</span> <span>determineLanding</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>climbSpeed</span><span>,</span> <span>cruiseSpeed</span><span>,</span> <span>isFloatPlane</span><span>));</span>

    <span>// Then, if we have an approach, add all points to our flight plan:</span>
    <span>if</span> <span>(</span><span>approachData</span><span>)</span> <span>{</span>
      <span>const</span> <span>{</span> <span>approach</span> <span>}</span> <span>=</span> <span>approachData</span><span>;</span>
      <span>const</span> <span>points</span> <span>=</span> <span>approach</span><span>.</span><span>points</span><span>.</span><span>slice</span><span>();</span>
      <span>const</span> <span>last</span> <span>=</span> <span>points</span><span>.</span><span>at</span><span>(</span><span>-</span><span>1</span><span>);</span>
      <span>// we store the</span>
      <span>points</span><span>.</span><span>forEach</span><span>((</span><span>p</span><span>,</span> <span>i</span><span>)</span> <span>=&gt;</span> <span>{</span>
        <span>points</span><span>[</span><span>i</span><span>]</span> <span>=</span> <span>waypoints</span><span>.</span><span>add</span><span>(</span>
          <span>...</span><span>p</span><span>,</span>       <span>// lat, long, alt,</span>
          <span>p</span> <span>===</span> <span>last</span><span>,</span> <span>// Should we resequence after adding this point?</span>
          <span>true</span>        <span>// Is this a landing waypoint?</span>
         <span>);</span>
      <span>});</span>
      <span>// before we save our approach, reverse the point array,</span>
      <span>// so that we can destructure it with guaranteed points</span>
      <span>// first in the run() function. I.e.:</span>
      <span>//</span>
      <span>//   const [p5,p4,p3,p2,p1,pA,f1,f2] = points</span>
      <span>//</span>
      <span>approach</span><span>.</span><span>points</span><span>.</span><span>reverse</span><span>()</span>
      <span>waypoints</span><span>.</span><span>setLanding</span><span>(</span><span>approachData</span><span>);</span>
    <span>}</span>
  <span>}</span>
</code></pre></div>

<p>With the associated updates to the <code>waypoint-manager.js</code>:</p>

<div><pre><code><span>...</span>

<span>export</span> <span>class</span> <span>WayPointManager</span> <span>{</span>
  <span>...</span>

  <span>// We're going to add a boolean flag that we (potentially) update</span>
  <span>// each time we transition from one waypoint to the next:</span>
  <span>reset</span><span>()</span> <span>{</span>
    <span>this</span><span>.</span><span>points</span> <span>=</span> <span>[];</span>
    <span>this</span><span>.</span><span>currentWaypoint</span> <span>=</span> <span>undefined</span><span>;</span>
    <span>this</span><span>.</span><span>glideReached</span> <span>=</span> <span>false</span><span>;</span> <span>// namely, this one.</span>
    <span>this</span><span>.</span><span>landing</span> <span>=</span> <span>false</span><span>;</span>
    <span>this</span><span>.</span><span>repeating</span> <span>=</span> <span>false</span><span>;</span>
    <span>this</span><span>.</span><span>autopilot</span><span>.</span><span>onChange</span><span>();</span>
  <span>}</span>

  <span>...</span>

  <span>resetWaypoints</span><span>()</span> <span>{</span>
    <span>this</span><span>.</span><span>glideReached</span> <span>=</span> <span>false</span><span>;</span>
    <span>this</span><span>.</span><span>points</span><span>.</span><span>forEach</span><span>((</span><span>waypoint</span><span>)</span> <span>=&gt;</span> <span>waypoint</span><span>.</span><span>reset</span><span>());</span>
    <span>this</span><span>.</span><span>currentWaypoint</span> <span>=</span> <span>this</span><span>.</span><span>points</span><span>[</span><span>0</span><span>];</span>
    <span>this</span><span>.</span><span>currentWaypoint</span><span>?.</span><span>activate</span><span>();</span>
    <span>this</span><span>.</span><span>resequence</span><span>();</span>
  <span>}</span>

  <span>...</span>

  <span>// Save a landing to the waypoint manager:</span>
  <span>setLanding</span><span>({</span> <span>airport</span><span>,</span> <span>runway</span><span>,</span> <span>approach</span> <span>})</span> <span>{</span>
    <span>this</span><span>.</span><span>landing</span> <span>=</span> <span>{</span> <span>airport</span><span>,</span> <span>runway</span><span>,</span> <span>approach</span> <span>};</span>
    <span>// And store our landing points separately, in reverse order,</span>
    <span>// so that other code won't constantly have to filter the</span>
    <span>// getWaypoints() response.</span>
    <span>this</span><span>.</span><span>landingPoints</span> <span>=</span> <span>this</span><span>.</span><span>points</span>
      <span>.</span><span>slice</span><span>()</span>
      <span>.</span><span>filter</span><span>((</span><span>p</span><span>)</span> <span>=&gt;</span> <span>p</span><span>.</span><span>landing</span><span>)</span>
      <span>.</span><span>reverse</span><span>();</span>
  <span>}</span>

  <span>// Aaaand get the saved landing back out:</span>
  <span>getLanding</span><span>()</span> <span>{</span>
    <span>const</span> <span>{</span> <span>airport</span><span>,</span> <span>runway</span><span>,</span> <span>approach</span> <span>}</span> <span>=</span> <span>this</span><span>.</span><span>landing</span> <span>??</span> <span>{};</span>
    <span>console</span><span>.</span><span>log</span><span>(</span><span>`getLanding`</span><span>,</span> <span>!!</span><span>airport</span><span>,</span> <span>!!</span><span>runway</span><span>,</span> <span>!!</span><span>approach</span><span>);</span>
    <span>if</span> <span>(</span><span>!</span><span>airport</span><span>)</span> <span>return</span><span>;</span>
    <span>return</span> <span>{</span> <span>airport</span><span>,</span> <span>runway</span><span>,</span> <span>approach</span> <span>};</span>
  <span>}</span>

  <span>// As well as our landing points.</span>
  <span>getLandingPoints</span><span>()</span> <span>{</span>
    <span>return</span> <span>this</span><span>.</span><span>landingPoints</span><span>;</span>
  <span>}</span>

  <span>// Are we flying landing waypoints? And more specially, are we</span>
  <span>// *actually* landing, as in: are we on the glide slope or runway?</span>
  <span>isLanding</span><span>()</span> <span>{</span>
    <span>return</span> <span>this</span><span>.</span><span>glideReached</span><span>;</span>
  <span>}</span>

  <span>// Try this landing again by resetting the flight plan and then</span>
  <span>// marking all non-landing points as completed.</span>
  <span>goAround</span><span>()</span> <span>{</span>
    <span>this</span><span>.</span><span>resetWaypoints</span><span>();</span>
    <span>while</span> <span>(</span><span>!</span><span>this</span><span>.</span><span>currentWaypoint</span><span>.</span><span>landing</span><span>)</span> <span>{</span>
      <span>this</span><span>.</span><span>transition</span><span>();</span>
    <span>}</span>
  <span>}</span>

  <span>...</span>

  <span>transition</span><span>()</span> <span>{</span>
    <span>const</span> <span>{</span> <span>points</span><span>,</span> <span>currentWaypoint</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>currentWaypoint</span><span>.</span><span>deactivate</span><span>();</span>
    <span>const</span> <span>p</span> <span>=</span> <span>(</span><span>this</span><span>.</span><span>currentWaypoint</span> <span>=</span> <span>currentWaypoint</span><span>.</span><span>complete</span><span>());</span>
    <span>if</span> <span>(</span><span>p</span><span>)</span> <span>{</span>
      <span>if</span> <span>(</span><span>p</span> <span>===</span> <span>points</span><span>[</span><span>0</span><span>])</span> <span>this</span><span>.</span><span>resetWaypoints</span><span>();</span>
      <span>p</span><span>.</span><span>activate</span><span>();</span>
      <span>// Do we need to check if glideReached is true or not?</span>
      <span>if</span> <span>(</span><span>p</span><span>.</span><span>landing</span><span>)</span> <span>{</span>
        <span>const</span> <span>pos</span> <span>=</span> <span>points</span><span>.</span><span>indexOf</span><span>(</span><span>p</span><span>);</span>
        <span>// A flight plan that ends in a landing will have our</span>
        <span>// p2, p3, p4, and p5 as last four waypoints.</span>
        <span>this</span><span>.</span><span>glideReached</span> <span>=</span> <span>points</span><span>.</span><span>length</span> <span>-</span> <span>pos</span> <span>&lt;=</span> <span>4</span><span>;</span>
      <span>}</span>
    <span>}</span>
    <span>return</span> <span>true</span><span>;</span>
  <span>}</span>

  <span>...</span>
<span>}</span>
</code></pre></div>

<p>Which leaves adding the <code>landing</code> flag to our <code>waypoint.js</code> file:</p>

<div><pre><code><span>export</span> <span>class</span> <span>Waypoint</span> <span>{</span>
  <span>...</span>

  <span>constructor</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>alt</span> <span>=</span> <span>false</span><span>,</span> <span>landing</span> <span>=</span> <span>false</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>id</span> <span>=</span> <span>Waypoint</span><span>.</span><span>nextId</span><span>();</span>
    <span>this</span><span>.</span><span>reset</span><span>();</span>
    <span>this</span><span>.</span><span>setPosition</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>);</span>
    <span>this</span><span>.</span><span>setElevation</span><span>(</span><span>alt</span><span>);</span>
    <span>this</span><span>.</span><span>markForLanding</span><span>(</span><span>landing</span><span>);</span>
  <span>}</span>

  <span>...</span>

  <span>markForLanding</span><span>(</span><span>landing</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>landing</span> <span>=</span> <span>landing</span><span>;</span>
  <span>}</span>

  <span>...</span>
<span>}</span>
</code></pre></div>

<p>Nothing special going on there. Although we also want to update our <code>autopilot-router.js</code> so we can expose that <code>goAround</code> function to the browser:</p>

<div><pre><code><span>...</span>

<span>export</span> <span>class</span> <span>AutopilotRouter</span> <span>{</span>

  <span>...</span>

  <span>goAround</span><span>(</span><span>client</span><span>)</span> <span>{</span>
    <span>autopilot</span><span>.</span><span>waypoints</span><span>.</span><span>goAround</span><span>();</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>So let’s hook into that on the browser-side with a new button in our <code>index.html</code>:</p>

<div><pre><code><span>&lt;!doctype html&gt;</span>
<span>&lt;html</span> <span>lang=</span><span>"en-GB"</span><span>&gt;</span>
  ...
  <span>&lt;body&gt;</span>
    ...
    <span>&lt;div</span> <span>id=</span><span>"map-controls"</span><span>&gt;</span>
      ...
      <span>&lt;fieldset&gt;</span>
        <span>&lt;button</span> <span>class=</span><span>"patrol"</span><span>&gt;</span>patrol<span>&lt;/button&gt;</span>
        <span>&lt;button</span> <span>class=</span><span>"go-around"</span><span>&gt;</span>go-around<span>&lt;/button&gt;</span>
        <span>&lt;button</span> <span>class=</span><span>"revalidate"</span><span>&gt;</span>revalidate<span>&lt;/button&gt;</span>
        <span>&lt;button</span> <span>class=</span><span>"reset"</span><span>&gt;</span>reset waypoints<span>&lt;/button&gt;</span>
        <span>&lt;button</span> <span>class=</span><span>"clear"</span><span>&gt;</span>clear waypoints<span>&lt;/button&gt;</span>
      <span>&lt;/fieldset&gt;</span>
    <span>&lt;/div&gt;</span>
   ...
<span>&lt;/html&gt;</span>
</code></pre></div>

<p>And the associated code in our <code>waypoint-overaly.js</code>:</p>

<div><pre><code><span>import</span> <span>{</span> <span>Trail</span> <span>}</span> <span>from</span> <span>"</span><span>./trail.js</span><span>"</span><span>;</span>
<span>import</span> <span>{</span> <span>showWaypointModal</span> <span>}</span> <span>from</span> <span>"</span><span>./waypoint-modal.js</span><span>"</span><span>;</span>

<span>export</span> <span>class</span> <span>WaypointOverlay</span> <span>{</span>
  <span>...</span>

  <span>addEventHandling</span><span>()</span> <span>{</span>
    <span>...</span>

    <span>document</span>
      <span>.</span><span>querySelector</span><span>(</span><span>`#map-controls .patrol`</span><span>)</span>
      <span>.</span><span>addEventListener</span><span>(</span><span>`click`</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
        <span>server</span><span>.</span><span>autopilot</span><span>.</span><span>toggleRepeating</span><span>();</span>
      <span>});</span>

    <span>document</span>
      <span>.</span><span>querySelector</span><span>(</span><span>`#map-controls .go-around`</span><span>)</span>
      <span>.</span><span>addEventListener</span><span>(</span><span>`click`</span><span>,</span> <span>()</span> <span>=&gt;</span> <span>{</span>
        <span>server</span><span>.</span><span>autopilot</span><span>.</span><span>goAround</span><span>();</span>
      <span>});</span>

    <span>...</span>
  <span>}</span>

  <span>...</span>

  <span>addWaypoint</span><span>(</span><span>waypoint</span><span>,</span> <span>number</span><span>)</span> <span>{</span>
    <span>waypoint</span> <span>=</span> <span>Object</span><span>.</span><span>assign</span><span>({},</span> <span>waypoint</span><span>);</span>
    <span>const</span> <span>{</span> <span>id</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>completed</span><span>,</span> <span>active</span><span>,</span> <span>landing</span> <span>}</span> <span>=</span> <span>waypoint</span><span>;</span>

    <span>const</span> <span>waypointClass</span> <span>=</span> <span>`waypoint-marker</span><span>${</span><span>completed</span> <span>?</span> <span>` completed`</span> <span>:</span> <span>``</span><span>}${</span>
      <span>active</span> <span>?</span> <span>` active`</span> <span>:</span> <span>``</span>
    <span>}${</span><span>landing</span> <span>?</span> <span>` landing`</span> <span>:</span> <span>``</span><span>}</span><span>`</span><span>;</span>

    <span>...</span>
  <span>}</span>

  <span>updateWaypoint</span><span>(</span><span>waypoint</span><span>,</span> <span>fromServer</span><span>)</span> <span>{</span>
    <span>const</span> <span>{</span> <span>id</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>alt</span><span>,</span> <span>active</span><span>,</span> <span>landing</span><span>,</span> <span>completed</span> <span>}</span> <span>=</span> <span>fromServer</span><span>;</span>

    <span>...</span>

    <span>const</span> <span>classes</span> <span>=</span> <span>div</span><span>.</span><span>classList</span><span>;</span>
    <span>waypoint</span><span>.</span><span>active</span> <span>=</span> <span>active</span><span>;</span>
    <span>classes</span><span>.</span><span>toggle</span><span>(</span><span>`active`</span><span>,</span> <span>!!</span><span>active</span><span>);</span>
    <span>waypoint</span><span>.</span><span>landing</span> <span>=</span> <span>landing</span><span>;</span>
    <span>classes</span><span>.</span><span>toggle</span><span>(</span><span>`landing`</span><span>,</span> <span>!!</span><span>landing</span><span>);</span>
    <span>waypoint</span><span>.</span><span>completed</span> <span>=</span> <span>completed</span><span>;</span>
    <span>classes</span><span>.</span><span>toggle</span><span>(</span><span>`completed`</span><span>,</span> <span>!!</span><span>completed</span><span>);</span>
  <span>}</span>
  <span>...</span>
<span>}</span>
</code></pre></div>

<p>And, of course, some CSS to make the landing points stand out, in <code>waypoint-overlay.css</code>:</p>

<div><pre><code><span>.waypoint-div</span> <span>{</span>
  <span>...</span>

  <span>&amp;.active</span> <span>.waypoint-marker</span> <span>img</span> <span>{</span>
    <span>filter</span><span>:</span> <span>hue-rotate</span><span>(</span><span>145deg</span><span>)</span> <span>brightness</span><span>(</span><span>2</span><span>);</span>
  <span>}</span>

  <span>&amp;</span><span>.landing</span> <span>.waypoint-marker</span> <span>img</span> <span>{</span>
    <span>filter</span><span>:</span> <span>hue-rotate</span><span>(</span><span>250deg</span><span>)</span> <span>brightness</span><span>(</span><span>1.5</span><span>);</span>
  <span>}</span>

  <span>...</span>
<span>}</span>
</code></pre></div>

<p>And now we get to enjoy our landings in glorious blue, with a new “go-around” button in case it looks like things are going wrong during the approach:</p>

<p><img src="https://pomax.github.io/are-we-flying/image-20240223213005061.png" alt="image-20240223213005061"></p>

<h3 id="implementing-our-landing-phases">Implementing our landing phases</h3>

<p>Which means it’s time to actually implement the landing phases that get us safely (hopefully?) down onto a runway. To make that happen, it’s time to fill in the <code>run</code> function in our <code>auto-landing.js</code> file!</p>

<div><pre><code><span>...</span>
<span>export</span> <span>class</span> <span>AutoLanding</span> <span>{</span>
  <span>...</span>

  <span>async</span> <span>run</span><span>(</span><span>flightInformation</span><span>)</span> <span>{</span>
    <span>// Should we even run?</span>
    <span>if</span> <span>(</span><span>!</span><span>flightInformation</span><span>)</span> <span>return</span><span>;</span>
    <span>const</span> <span>{</span> <span>model</span><span>:</span> <span>flightModel</span><span>,</span> <span>data</span><span>:</span> <span>flightData</span> <span>}</span> <span>=</span> <span>flightInformation</span><span>;</span>
    <span>if</span> <span>(</span><span>!</span><span>flightModel</span> <span>||</span> <span>!</span><span>flightData</span><span>)</span> <span>return</span><span>;</span>

    <span>// If we do, let's extract a whole bunch of values that we're going to need:</span>
    <span>const</span> <span>{</span> <span>hasRetractibleGear</span><span>,</span> <span>isTailDragger</span><span>,</span> <span>engineCount</span><span>,</span> <span>climbSpeed</span><span>,</span> <span>vs0</span> <span>}</span> <span>=</span> <span>flightModel</span><span>;</span>
    <span>const</span> <span>{</span> <span>bank</span><span>,</span> <span>gearSpeedExceeded</span><span>,</span> <span>isGearDown</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>onGround</span><span>,</span> <span>speed</span> <span>}</span> <span>=</span> <span>flightData</span><span>;</span>

    <span>// As well as our lnding points</span>
    <span>const</span> <span>{</span> <span>autopilot</span> <span>}</span> <span>=</span> <span>this</span><span>;</span>
    <span>const</span> <span>{</span> <span>api</span><span>,</span> <span>waypoints</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>
    <span>const</span> <span>points</span> <span>=</span> <span>waypoints</span><span>.</span><span>getLandingPoints</span><span>();</span>
    <span>const</span> <span>[</span><span>p5</span><span>,</span> <span>p4</span><span>,</span> <span>p3</span><span>,</span> <span>p2</span><span>,</span> <span>p1</span><span>,</span> <span>pA</span><span>,</span> <span>f1</span><span>,</span> <span>f2</span><span>]</span> <span>=</span> <span>points</span><span>;</span>

    <span>// And our flight plan.</span>
    <span>const</span> <span>{</span> <span>api</span><span>,</span> <span>waypoints</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>
    <span>let</span> <span>{</span> <span>currentWaypoint</span><span>:</span> <span>target</span> <span>}</span> <span>=</span> <span>waypoints</span><span>;</span>

    <span>// Now then: which waypoint are we targeting, and what step of the landing are we flying?</span>
    <span>this</span><span>.</span><span>target</span> <span>=</span> <span>target</span><span>;</span>
    <span>const</span> <span>{</span> <span>step</span> <span>}</span> <span>=</span> <span>this</span><span>.</span><span>stage</span><span>;</span>
    <span>if</span> <span>(</span><span>!</span><span>target</span><span>)</span> <span>{</span> <span>target</span> <span>=</span> <span>p5</span><span>;</span> <span>}</span> <span>else</span> <span>if</span> <span>(</span><span>!</span><span>points</span><span>.</span><span>includes</span><span>(</span><span>target</span><span>))</span> <span>return</span><span>;</span>

    <span>// ... and we pick up the story here in the next section</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And with that, it’s actual landing code time:</p>

<h4 id="getting-onto-the-approach">Getting onto the approach</h4>

<p>This phase isn’t super interesting, other than that we want it to turn off the terrain follow mode once we get close to our offsets (if we have them) or the approach itself (if we don’t). As such, there’s a bit of duplication, but not the kind we really care to optimize:</p>

<div><pre><code>    <span>...</span>

    <span>if</span> <span>(</span><span>step</span> <span>===</span> <span>GET_ONTO_THE_APPROACH</span><span>)</span> <span>{</span>
      <span>const</span> <span>onTerrainFollow</span> <span>=</span> <span>!!</span><span>autopilot</span><span>.</span><span>modes</span><span>[</span><span>TERRAIN_FOLLOW</span><span>];</span>

      <span>// Are we flying towards the second offset?</span>
      <span>if</span> <span>(</span><span>f2</span> <span>&amp;&amp;</span> <span>target</span> <span>===</span> <span>f2</span><span>)</span> <span>{</span>
        <span>const</span> <span>d</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>f2</span><span>.</span><span>lat</span><span>,</span> <span>f2</span><span>.</span><span>long</span><span>);</span>
        <span>if</span> <span>(</span><span>d</span> <span>&gt;</span> <span>5</span><span>)</span> <span>return</span><span>;</span>
        <span>// If we are, and we're close enough, turn off terrain follow</span>
        <span>// and set the altitude hold to the approach altitude.</span>
        <span>autopilot</span><span>.</span><span>setParameters</span><span>({</span>
          <span>[</span><span>TERRAIN_FOLLOW</span><span>]:</span> <span>d</span> <span>&gt;</span> <span>1</span> <span>&amp;&amp;</span> <span>onTerrainFollow</span><span>,</span>
          <span>[</span><span>ALTITUDE_HOLD</span><span>]:</span> <span>p2</span><span>.</span><span>alt</span><span>,</span>
        <span>});</span>
      <span>}</span>

      <span>// Are we flying towards the first offset? Then basiclaly repeat</span>
      <span>// the same thing, because we might not have had an f2.</span>
      <span>if</span> <span>(</span><span>f1</span> <span>&amp;&amp;</span> <span>target</span> <span>===</span> <span>f1</span><span>)</span> <span>{</span>
        <span>const</span> <span>d</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>f1</span><span>.</span><span>lat</span><span>,</span> <span>f1</span><span>.</span><span>long</span><span>);</span>
        <span>if</span> <span>(</span><span>d</span> <span>&gt;</span> <span>5</span><span>)</span> <span>return</span><span>;</span>
        <span>autopilot</span><span>.</span><span>setParameters</span><span>({</span>
          <span>[</span><span>TERRAIN_FOLLOW</span><span>]:</span> <span>d</span> <span>&gt;</span> <span>1</span> <span>&amp;&amp;</span> <span>onTerrainFollow</span><span>,</span>
          <span>[</span><span>ALTITUDE_HOLD</span><span>]:</span> <span>p2</span><span>.</span><span>alt</span><span>,</span>
        <span>});</span>
      <span>}</span>

      <span>// Have we reached the approach itself?</span>
      <span>const</span> <span>d1</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>p1</span><span>.</span><span>lat</span><span>,</span> <span>p1</span><span>.</span><span>long</span><span>);</span>
      <span>const</span> <span>d2</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>p1</span><span>.</span><span>lat</span><span>,</span> <span>p1</span><span>.</span><span>long</span><span>,</span> <span>pA</span><span>.</span><span>lat</span><span>,</span> <span>pA</span><span>.</span><span>long</span><span>);</span>
      <span>const</span> <span>ratio</span> <span>=</span> <span>d1</span><span>/</span><span>d2</span><span>;</span>
      <span>if</span> <span>(</span><span>ratio</span> <span>&lt;=</span> <span>1</span><span>)</span> <span>{</span>
        <span>console</span><span>.</span><span>log</span><span>(</span><span>`approach reached`</span><span>);</span>
        <span>// Ensure terrain mode is off (in case we didn't have an f1),</span>
        <span>// set the altitude hold, and set our autothrottle so</span>
        <span>// that we slow down to glide speed:</span>
        <span>autopilot</span><span>.</span><span>setParameters</span><span>({</span>
          <span>[</span><span>TERRAIN_FOLLOW</span><span>]:</span> <span>false</span><span>,</span>
          <span>[</span><span>ALTITUDE_HOLD</span><span>]:</span> <span>p2</span><span>.</span><span>alt</span><span>,</span>
          <span>[</span><span>AUTO_THROTTLE</span><span>]:</span> <span>climbSpeed</span> <span>+</span> <span>20</span><span>,</span>
        <span>});</span>
        <span>// then we're done with this stage, on to the next!</span>
        <span>stage</span><span>.</span><span>nextStage</span><span>();</span>
      <span>}</span>
    <span>}</span>

    <span>...</span>
</code></pre></div>

<p>So what happens in the next stage?</p>

<h4 id="throttling-down-to-climb-speed">Throttling down to climb speed</h4>

<p>Honestly: again, not much: we simply let the autopilot do what it needs to do until we reach P<sub>2</sub>:</p>

<div><pre><code>   <span>...</span>

   <span>if</span> <span>(</span><span>step</span> <span>===</span> <span>THROTTLE_TO_CLIMB_SPEED</span><span>)</span> <span>{</span>
      <span>if</span> <span>(</span><span>target</span> <span>===</span> <span>p2</span><span>)</span> <span>{</span>
        <span>console</span><span>.</span><span>log</span><span>(</span><span>`glide slope reached`</span><span>);</span>
        <span>// Really the only meaningful thing we do is turning on our landing lights:</span>
        <span>api</span><span>.</span><span>trigger</span><span>(</span><span>`LANDING_LIGHTS_ON`</span><span>);</span>
        <span>// And then it's on to the next stage.</span>
        <span>stage</span><span>.</span><span>nextStage</span><span>();</span>
      <span>}</span>
    <span>}</span>

   <span>...</span>
</code></pre></div>

<h4 id="flying-the-glide-slope">Flying the glide slope</h4>

<p>The first really interesting stage is the glide slope stage, where we want to perform a controlled glide down towards the runway, ending at P<sub>3</sub>:</p>

<div><pre><code>    <span>...</span>

    <span>if</span> <span>(</span><span>step</span> <span>===</span> <span>FLY_THE_GLIDE_SLOPE</span><span>)</span> <span>{</span>
      <span>// In order to descend along the glide slope, we calculate how far</span>
      <span>// along we are as a ratio of the distance we need to cover, and</span>
      <span>// then use that to determine the altitude we "should" be flying</span>
      <span>// at that point:</span>
      <span>const</span> <span>d1</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>p2</span><span>.</span><span>lat</span><span>,</span> <span>p2</span><span>.</span><span>long</span><span>);</span>
      <span>const</span> <span>d2</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>p2</span><span>.</span><span>lat</span><span>,</span> <span>p2</span><span>.</span><span>long</span><span>,</span> <span>p3</span><span>.</span><span>lat</span><span>,</span> <span>p3</span><span>.</span><span>long</span><span>);</span>
      <span>const</span> <span>ratio</span> <span>=</span> <span>constrain</span><span>(</span><span>d1</span> <span>/</span> <span>d2</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>);</span>
      <span>const</span> <span>lerpAlt</span> <span>=</span> <span>constrainMap</span><span>(</span><span>ratio</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>,</span> <span>p2</span><span>.</span><span>alt</span><span>,</span> <span>p3</span><span>.</span><span>alt</span><span>);</span>
      <span>autopilot</span><span>.</span><span>setParameters</span><span>({</span> <span>[</span><span>ALTITUDE_HOLD</span><span>]:</span> <span>lerpAlt</span> <span>});</span>

      <span>// While we're on the glide slope, we need to do some prep work</span>
      <span>// in the form of lowering our landing gear and adding a touch</span>
      <span>// of flaps when it's safe to do so.</span>
      <span>if</span> <span>(</span><span>ratio</span> <span>&gt;</span> <span>0.5</span> <span>&amp;&amp;</span> <span>abs</span><span>(</span><span>bank</span><span>)</span> <span>&lt;</span> <span>3</span><span>)</span> <span>{</span>
        <span>if</span> <span>(</span><span>hasRetractibleGear</span> <span>&amp;&amp;</span> <span>!</span><span>gearSpeedExceeded</span> <span>&amp;&amp;</span> <span>!</span><span>isGearDown</span><span>)</span> <span>{</span>
          <span>console</span><span>.</span><span>log</span><span>(</span><span>`gear down`</span><span>);</span>
          <span>api</span><span>.</span><span>trigger</span><span>(</span><span>`GEAR_DOWN`</span><span>);</span>
          <span>console</span><span>.</span><span>log</span><span>(</span><span>`touch of flaps`</span><span>);</span>
          <span>for</span> <span>(</span><span>let</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>10</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>api</span><span>.</span><span>set</span><span>(</span><span>`FLAPS_HANDLE_INDEX:1`</span><span>,</span> <span>2</span><span>);</span>
        <span>}</span>
      <span>}</span>

      <span>// Then, transition to short final when we're at P3:</span>
      <span>if</span> <span>(</span><span>ratio</span> <span>&gt;=</span> <span>1</span><span>)</span> <span>{</span>
        <span>console</span><span>.</span><span>log</span><span>(</span><span>`short final reached`</span><span>);</span>
        <span>stage</span><span>.</span><span>nextStage</span><span>();</span>
      <span>}</span>
    <span>}</span>

    <span>...</span>
</code></pre></div>

<p>Now, while we’re gliding, we want to place some restrictions on the the altitude hold and wing leveler behaviour: we’re supposed to glide down, and we don’t want large VS swings, or “find mid-flight, not fine while landing” flight path drift, so let’s add a little bit of extra code to our <code>altitude-hold.js</code>:</p>

<div><pre><code><span>...</span>
<span>export</span> <span>async</span> <span>function</span> <span>altitudeHold</span><span>(</span><span>autopilot</span><span>,</span> <span>flightInformation</span><span>)</span> <span>{</span>
  <span>const</span> <span>{</span> <span>api</span><span>,</span> <span>trim</span><span>,</span> <span>AP_INTERVAL</span><span>,</span> <span>waypoints</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>
  <span>const</span> <span>landing</span> <span>=</span> <span>waypoints</span><span>.</span><span>isLanding</span><span>();</span>

  <span>...</span>

  <span>if</span> <span>(</span><span>FEATURES</span><span>.</span><span>EMERGENCY_PROTECTION</span><span>)</span> <span>{</span>
    <span>// If we're landing, set reduced max VS values, biassed towards descent:</span>
    <span>const</span> <span>descentThreshold</span> <span>=</span> <span>landing</span> <span>?</span> <span>0.75</span> <span>*</span> <span>DEFAULT_MAX_VS</span> <span>:</span> <span>DEFAULT_MAX_VS</span><span>;</span>
    <span>const</span> <span>ascentThreshold</span> <span>=</span> <span>landing</span> <span>?</span> <span>0.5</span> <span>*</span> <span>DEFAULT_MAX_VS</span> <span>:</span> <span>DEFAULT_MAX_VS</span><span>;</span>

    <span>// If we're landing, and our altitude is higher than our target,</span>
    <span>// absolutely do not allow a positive VS. We want to go down, not up.</span>
    <span>const</span> <span>landingViolation</span> <span>=</span> <span>landing</span> <span>&amp;&amp;</span> <span>alt</span> <span>&gt;</span> <span>targetAlt</span> <span>&amp;&amp;</span> <span>VS</span> <span>&gt;</span> <span>0</span><span>;</span>
    <span>const</span> <span>VS_EMERGENCY</span> <span>=</span> <span>VS</span> <span>&lt;</span> <span>-</span><span>descentThreshold</span> <span>||</span> <span>VS</span> <span>&gt;</span> <span>ascentThreshold</span> <span>||</span> <span>landingViolation</span><span>;</span>

    <span>// Similarly, if we're landing, we don't want wild changes to</span>
    <span>// our vertical speed. We want a glide, not a rollercoaster.</span>
    <span>const</span> <span>thresholdDvs</span> <span>=</span> <span>landing</span> <span>?</span> <span>DEFAULT_MAX_dVS</span> <span>/</span> <span>2</span> <span>:</span> <span>DEFAULT_MAX_dVS</span><span>;</span>
    <span>const</span> <span>DVS_EMERGENCY</span> <span>=</span> <span>dVS</span> <span>&lt;</span> <span>-</span><span>thresholdDvs</span> <span>||</span> <span>dVS</span> <span>&gt;</span> <span>thresholdDvs</span><span>;</span>

    <span>...</span>

    <span>if</span> <span>(</span><span>VS_EMERGENCY</span><span>)</span> <span>{</span>
      <span>if</span> <span>(</span><span>landingViolation</span><span>)</span> <span>{</span>
        <span>// Immediately trim down if we're ascending during</span>
        <span>// landing while we're still above the glide slope:</span>
        <span>update</span> <span>-=</span>  <span>fStep</span><span>/</span><span>2</span><span>;</span>
      <span>}</span> <span>else</span> <span>{</span>
        <span>update</span> <span>+=</span> <span>constrainMap</span><span>(</span><span>VS</span><span>,</span> <span>-</span><span>fMaxVS</span><span>,</span> <span>fMaxVS</span><span>,</span> <span>fStep</span><span>,</span> <span>-</span><span>fStep</span><span>);</span>
      <span>}</span>
    <span>}</span>
    <span>...</span>
  <span>}</span>
  <span>...</span>
<span>}</span>

<span>// With a similar change to our target VS function, so that</span>
<span>// we target a smaller max VS when we're landing.</span>
<span>function</span> <span>getTargetVS</span><span>(</span><span>autopilot</span><span>,</span> <span>maxVS</span><span>,</span> <span>alt</span><span>,</span> <span>speed</span><span>,</span> <span>climbSpeed</span><span>,</span> <span>VS</span><span>,</span> <span>dVS</span><span>)</span> <span>{</span>
  <span>const</span> <span>{</span> <span>waypoints</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>
  <span>const</span> <span>landing</span> <span>=</span> <span>waypoints</span><span>.</span><span>isLanding</span><span>();</span>
  <span>...</span>
  <span>if</span> <span>(</span><span>FEATURES</span><span>.</span><span>TARGET_TO_HOLD</span><span>)</span> <span>{</span>
    <span>...</span>
    <span>if</span> <span>(</span><span>targetAlt</span><span>)</span> <span>{</span>
      <span>altDiff</span> <span>=</span> <span>targetAlt</span> <span>-</span> <span>alt</span><span>;</span>
      <span>if</span> <span>(</span><span>landing</span><span>)</span> <span>maxVS</span> <span>*=</span> <span>0.75</span><span>;</span>
      <span>targetVS</span> <span>=</span> <span>constrainMap</span><span>(</span><span>altDiff</span><span>,</span> <span>-</span><span>plateau</span><span>,</span> <span>plateau</span><span>,</span> <span>-</span><span>maxVS</span><span>,</span> <span>maxVS</span><span>);</span>
    <span>}</span>
  <span>}</span>
  <span>...</span>
<span>}</span>
</code></pre></div>

<p>And then our <code>fly-level.js</code>:</p>

<div><pre><code><span>...</span>
<span>export</span> <span>async</span> <span>function</span> <span>flyLevel</span><span>(</span><span>autopilot</span><span>,</span> <span>state</span><span>)</span> <span>{</span>
  <span>const</span> <span>{</span> <span>trim</span><span>,</span> <span>api</span><span>,</span> <span>waypoints</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>
  <span>const</span> <span>landing</span> <span>=</span> <span>waypoints</span><span>.</span><span>isLanding</span><span>();</span>

  <span>...</span>

  <span>// First, we change our "max deflection" logic so we're always</span>
  <span>// decreasing it by a small amount, which will get counter-acted</span>
  <span>// as needed based on heading differences:</span>
  <span>if</span> <span>(</span><span>aHeadingDiff</span> <span>&gt;</span> <span>1</span><span>)</span> <span>{</span>
    <span>...</span>
  <span>}</span>
  <span>updateMaxDeflection</span><span>(</span><span>autopilot</span><span>,</span> <span>trim</span><span>,</span> <span>-</span><span>10</span><span>,</span> <span>params</span><span>);</span>

  <span>// Then we'll use our offset value to help during landing</span>
  <span>let</span> <span>offset</span> <span>=</span> <span>0</span><span>;</span>

  <span>if</span> <span>(</span><span>landing</span><span>)</span> <span>{</span>
    <span>offset</span> <span>-=</span> <span>headingDiff</span> <span>*</span> <span>150</span><span>;</span>
  <span>}</span>

  <span>if</span> <span>(</span><span>upsideDown</span><span>)</span> <span>{</span>
    <span>...</span>
  <span>}</span>
  <span>...</span>
<span>}</span>
</code></pre></div>

<p>And then we’ll also update the <code>getTargetHeading</code> function in <code>fly-level.js</code> because when we’re landing we don’t actually want to set our heading based on the direction the plane is <em>pointing</em> in, but the direction we’re <em>flying</em> in. If we’re flying with some kind of yaw, we actually want to look at our “real” heading in terms of where we just were, and where we are now, so let’s add a <code>flightHeading</code> value and use that during landing:</p>

<div><pre><code><span>function</span> <span>getTargetHeading</span><span>(</span><span>parameters</span><span>)</span> <span>{</span>
  <span>const</span> <span>{</span> <span>autopilot</span><span>,</span> <span>heading</span><span>,</span> <span>flightHeading</span><span>,</span> <span>speed</span><span>,</span> <span>vs1</span><span>,</span> <span>cruiseSpeed</span> <span>}</span> <span>=</span>
    <span>parameters</span><span>;</span>
  <span>const</span> <span>{</span> <span>waypoints</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>
  <span>const</span> <span>landing</span> <span>=</span> <span>waypoints</span><span>.</span><span>isLanding</span><span>();</span>
  <span>...</span>
  <span>if</span> <span>(</span><span>FEATURES</span><span>.</span><span>FLY_SPECIFIC_HEADING</span><span>)</span> <span>{</span>
    <span>targetHeading</span> <span>=</span> <span>waypoints</span><span>.</span><span>getHeading</span><span>(</span><span>parameters</span><span>);</span>
    <span>uncappedHeadingDiff</span> <span>=</span> <span>getCompassDiff</span><span>(</span><span>flightHeading</span><span>,</span> <span>targetHeading</span><span>);</span>
    <span>if</span> <span>(</span><span>!</span><span>landing</span><span>)</span> <span>{</span>
      <span>const</span> <span>half</span> <span>=</span> <span>uncappedHeadingDiff</span> <span>/</span> <span>2</span><span>;</span>
      <span>uncappedHeadingDiff</span> <span>=</span> <span>constrainMap</span><span>(</span><span>speed</span><span>,</span> <span>vs1</span><span>,</span> <span>cruiseSpeed</span><span>,</span> <span>half</span><span>,</span> <span>uncappedHeadingDiff</span><span>);</span>
    <span>}</span>
  <span>}</span>
  <span>...</span>
<span>}</span>
</code></pre></div>

<p>And, for the last time, an update to our <code>flight-information.js</code> to add that value:</p>

<div><pre><code><span>...</span>
<span>export</span> <span>class</span> <span>FlightInformation</span> <span>{</span>
  <span>...</span>
  <span>async</span> <span>updateFlight</span><span>()</span> <span>{</span>
    <span>...</span>

    <span>data</span><span>.</span><span>flightHeading</span> <span>=</span> <span>data</span><span>.</span><span>heading</span><span>;</span>
    <span>if</span> <span>(</span><span>this</span><span>.</span><span>data</span><span>)</span> <span>{</span>
      <span>data</span><span>.</span><span>flightHeading</span> <span>=</span> <span>getHeadingFromTo</span><span>(</span><span>this</span><span>.</span><span>data</span><span>.</span><span>lat</span><span>,</span> <span>this</span><span>.</span><span>data</span><span>.</span><span>long</span><span>,</span> <span>data</span><span>.</span><span>lat</span><span>,</span> <span>data</span><span>.</span><span>long</span><span>);</span>
      <span>data</span><span>.</span><span>flightHeading</span> <span>-=</span> <span>data</span><span>.</span><span>declination</span><span>;</span>
    <span>}</span>

    <span>...</span>

    <span>return</span> <span>(</span><span>this</span><span>.</span><span>data</span> <span>=</span> <span>data</span><span>);</span>
  <span>}</span>
  <span>...</span>
<span>}</span>
</code></pre></div>

<p>That’s a bit more code than you might have expected, but we want to give ourselves the absolute best chance of making it to the ground alive!</p>

<h4 id="riding-out-the-short-final">Riding out the short final</h4>

<p>The short final is similar to the main glide slope, except  we only need to drop about 180 feet:</p>

<div><pre><code>    <span>...</span>

    <span>if</span> <span>(</span><span>step</span> <span>===</span> <span>RIDE_OUT_SHORT_FINAL</span><span>)</span> <span>{</span>
      <span>// instead of interpolating between p2 and p3, it's between p3 and p4:</span>
      <span>const</span> <span>d1</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>p4</span><span>.</span><span>lat</span><span>,</span> <span>p4</span><span>.</span><span>long</span><span>);</span>
      <span>const</span> <span>d2</span> <span>=</span> <span>getDistanceBetweenPoints</span><span>(</span><span>p3</span><span>.</span><span>lat</span><span>,</span> <span>p3</span><span>.</span><span>long</span><span>,</span> <span>p4</span><span>.</span><span>lat</span><span>,</span> <span>p4</span><span>.</span><span>long</span><span>);</span>
      <span>const</span> <span>ratio</span> <span>=</span> <span>constrain</span><span>(</span><span>d1</span> <span>/</span> <span>d2</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>);</span>
      <span>const</span> <span>lerpAlt</span> <span>=</span> <span>constrainMap</span><span>(</span><span>ratio</span><span>,</span> <span>0</span><span>,</span> <span>1</span><span>,</span> <span>p4</span><span>.</span><span>alt</span><span>,</span> <span>p3</span><span>.</span><span>alt</span><span>);</span>

      <span>autopilot</span><span>.</span><span>setParameters</span><span>({</span>
        <span>[</span><span>ALTITUDE_HOLD</span><span>]:</span> <span>lerpAlt</span><span>,</span>
        <span>// However, we also want to make sure the plane slows down to</span>
        <span>// either climb speed, or 100 knots, during this final descent.</span>
        <span>// Whichever is less:</span>
        <span>[</span><span>AUTO_THROTTLE</span><span>]:</span> <span>min</span><span>(</span><span>climbSpeed</span><span>,</span> <span>100</span><span>),</span>
      <span>});</span>

      <span>// And when we get to p4, move on to the next stage!</span>
      <span>if</span> <span>(</span><span>ratio</span> <span>&gt;=</span> <span>1</span><span>)</span> <span>{</span>
        <span>console</span><span>.</span><span>log</span><span>(</span><span>`runway reached`</span><span>);</span>
        <span>stage</span><span>.</span><span>nextStage</span><span>();</span>
      <span>}</span>
    <span>}</span>

    <span>...</span>
</code></pre></div>

<p>However, because this is the critical transition from “high up” to “low enough to land from”, we’re going to run this loop at the faster autopilot interval, so that the odds of us not being able to correct for a bad altitude (e.g. dropping below the short final glide slope) or crosswind are as low as we can make them. So we update the <code>run</code> function in our <code>autopilot.js</code>:</p>

<div><pre><code><span>...</span>

<span>export</span> <span>class</span> <span>AutoPilot</span> <span>{</span>
  <span>...</span>

  <span>async</span> <span>run</span><span>()</span> <span>{</span>
    <span>...</span>

    <span>try</span> <span>{</span>
      <span>...</span>

      <span>if</span> <span>(</span><span>modes</span><span>[</span><span>AUTO_TAKEOFF</span><span>]</span> <span>&amp;&amp;</span> <span>autoTakeoff</span><span>)</span> <span>{</span>
        <span>await</span> <span>autoTakeoff</span><span>.</span><span>run</span><span>(</span><span>flightInformation</span><span>);</span>
      <span>}</span>

      <span>else</span> <span>if</span> <span>(</span><span>waypoint</span><span>?.</span><span>landing</span> <span>||</span> <span>(</span><span>this</span><span>.</span><span>autoLanding</span> <span>&amp;&amp;</span> <span>!</span><span>this</span><span>.</span><span>autoLanding</span><span>.</span><span>done</span><span>))</span> <span>{</span>
        <span>// While the landing can be done at the regular interval, once we're in the short final,</span>
        <span>const</span> <span>shortFinal</span> <span>=</span> <span>await</span> <span>this</span><span>.</span><span>autoLanding</span><span>.</span><span>run</span><span>(</span><span>flightInformation</span><span>);</span>
        <span>this</span><span>.</span><span>AP_INTERVAL</span> <span>=</span> <span>shortFinal</span> <span>?</span> <span>FAST_AUTOPILOT_INTERVAL</span> <span>:</span> <span>AUTOPILOT_INTERVAL</span><span>;</span>
      <span>}</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And then we make sure that the auto-landing <code>run</code> function returns a Boolean value that indicates whether we want regular or fast AP updates:</p>

<div><pre><code><span>...</span>
<span>export</span> <span>class</span> <span>AutoLanding</span> <span>{</span>
  <span>...</span>

  <span>async</span> <span>run</span><span>(</span><span>flightInformation</span><span>)</span> <span>{</span>
    <span>...</span>

    <span>// Make the autopilot run at the higher polling interval based</span>
    <span>// on whether we return true or not at the end of this function:</span>
    <span>const</span> <span>shortFinal</span> <span>=</span> <span>step</span> <span>===</span> <span>RIDE_OUT_SHORT_FINAL</span><span>;</span>
    <span>const</span> <span>aboveRunway</span> <span>=</span> <span>step</span> <span>===</span> <span>ROLL_AND_BRAKE</span> <span>&amp;&amp;</span> <span>(</span><span>speed</span> <span>&gt;</span> <span>vs0</span><span>);</span>
    <span>return</span> <span>shortFinal</span> <span>||</span> <span>aboveRunway</span><span>;</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And that should at least give us better odds of safely landing.</p>

<p>However, this also means that we’ll be putting in <em>much</em> bigger corrections “per tick” in our <code>altitude-hold.js</code>, so let’s make sure we scale our corrections down accordingly. This wasn’t a problem during auto-takeoff, where altitude hold wasn’t active while the autopilot was updating faster than usual, but now that we’ll be running it faster <em>in flight</em>, we need to address that problem. First, let’s move the AP intervals into <code>constants.js</code>:</p>

<div><pre><code><span>// AP values</span>
<span>export</span> <span>const</span> <span>AUTOPILOT_INTERVAL</span> <span>=</span> <span>500</span><span>;</span>
<span>export</span> <span>const</span> <span>FAST_AUTOPILOT_INTERVAL</span> <span>=</span> <span>100</span><span>;</span>
</code></pre></div>

<p>And then we make the autopilot import those:</p>

<div><pre><code><span>import</span> <span>{</span>
  <span>...</span>
  <span>AUTOPILOT_INTERVAL</span><span>,</span>
  <span>FAST_AUTOPILOT_INTERVAL</span><span>,</span>
  <span>...</span>
<span>}</span> <span>from</span> <span>"</span><span>../utils/constants.js</span><span>"</span><span>;</span>
</code></pre></div>

<p>So far so good: then, we need to update <code>altitude-hold.js</code> to scale its updates each tick according to what speed the autopilot’s running at:</p>

<div><pre><code><span>// Get the baseline autopilot interval value...</span>
<span>import</span> <span>{</span> <span>AUTOPILOT_INTERVAL</span> <span>}</span> <span>from</span> <span>"</span><span>../utils/constants.js</span><span>"</span><span>;</span>

<span>...</span>

<span>export</span> <span>async</span> <span>function</span> <span>altitudeHold</span><span>(</span><span>autopilot</span><span>,</span> <span>flightInformation</span><span>)</span> <span>{</span>
  <span>// ...then get the current autopilot call interval...</span>
  <span>const</span> <span>{</span> <span>api</span><span>,</span> <span>trim</span><span>,</span> <span>AP_INTERVAL</span> <span>}</span> <span>=</span> <span>autopilot</span><span>;</span>

  <span>...</span>

  <span>// ...and then scale our update so that we're only applying a</span>
  <span>// "partial" update if we're running faster than baseline.</span>
  <span>update</span> <span>*=</span> <span>AP_INTERVAL</span> <span>/</span> <span>AUTOPILOT_INTERVAL</span><span>;</span>

  <span>// We're keeping our VS/dVS protection though. We don't</span>
  <span>// want to scale these down, that might kill us again =(</span>
  <span>if</span> <span>(</span><span>FEATURES</span><span>.</span><span>EMERGENCY_PROTECTION</span><span>)</span> <span>{</span>
    <span>...</span>
  <span>}</span>
  <span>...</span>
<span>}</span>
</code></pre></div>

<p>And now we’re no longer applying updates that have been calculated based on the assumption that we’re updating plane parameters only twice a second, more than twice a second. Instead,  we’re now applying more, but smaller, updates when the autopilot’s running at the fast interval.</p>

<h4 id="cutting-the-engines">Cutting the engines</h4>

<p>This is the stage where we get to discover whether we land, or crash: we’re going to cut the engines!</p>

<div><pre><code>    <span>...</span>

    <span>if</span> <span>(</span><span>step</span> <span>===</span> <span>CUT_THE_ENGINES</span><span>)</span> <span>{</span>
      <span>console</span><span>.</span><span>log</span><span>(</span><span>`disable auto-throttle and alt hold...`</span><span>);</span>
      <span>autopilot</span><span>.</span><span>setParameters</span><span>({</span>
        <span>[</span><span>AUTO_THROTTLE</span><span>]:</span> <span>false</span><span>,</span>
        <span>[</span><span>ALTITUDE_HOLD</span><span>]:</span> <span>false</span>
      <span>});</span>

      <span>console</span><span>.</span><span>log</span><span>(</span><span>`and cutting the engines`</span><span>);</span>
      <span>for</span> <span>(</span><span>let</span> <span>i</span> <span>=</span> <span>1</span><span>;</span> <span>i</span> <span>&lt;=</span> <span>engineCount</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>{</span>
        <span>await</span> <span>api</span><span>.</span><span>set</span><span>(</span><span>`GENERAL_ENG_THROTTLE_LEVER_POSITION:</span><span>${</span><span>i</span><span>}</span><span>`</span><span>,</span> <span>0</span><span>);</span>
      <span>}</span>

      <span>stage</span><span>.</span><span>nextStage</span><span>();</span>
    <span>}</span>

    <span>...</span>
</code></pre></div>

<h4 id="touching-down">Touching down</h4>

<p>While we’re coasting down onto the runway, we do still have some work to do: we need to ensure that the plane is pitched up ever so slightly, so that tricycle gear planes land on the rear wheels first, and tail draggers don’t immediately nose-over when the wheels hit the runway:</p>

<div><pre><code>    <span>...</span>

    <span>if</span> <span>(</span><span>step</span> <span>===</span> <span>LAND_ON_THE_RUNWAY</span><span>)</span> <span>{</span>
      <span>// We keep cutting the engines, because sometimes MSFS will look at the</span>
      <span>// peripherals and go "hey this throttle lever is at 100% let me make sure</span>
      <span>// the same is true in-game!" and we *really* don't want that here:</span>
      <span>for</span> <span>(</span><span>let</span> <span>i</span> <span>=</span> <span>1</span><span>;</span> <span>i</span> <span>&lt;=</span> <span>engineCount</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>{</span>
        <span>await</span> <span>api</span><span>.</span><span>set</span><span>(</span><span>`GENERAL_ENG_THROTTLE_LEVER_POSITION:</span><span>${</span><span>i</span><span>}</span><span>`</span><span>,</span> <span>0</span><span>);</span>
      <span>}</span>

      <span>// For as long as we're not on the ground, try to keep the plane</span>
      <span>// pitching up by 2 degrees. We'll land a little bit slower, but</span>
      <span>// we want to survive the landing without damaging the plane.</span>
      <span>if</span> <span>(</span><span>!</span><span>onGround</span><span>)</span> <span>{</span>
        <span>setPitch</span><span>(</span><span>api</span><span>,</span> <span>-</span><span>2</span><span>,</span> <span>flightInformation</span><span>);</span>
      <span>}</span>

      <span>// Once we do touch down on the runway, a few things need to happen.</span>
      <span>else</span> <span>{</span>
        <span>// First off, we need to turn off the wing leveler, because it'd</span>
        <span>// interfere with the auto-ruddering we're going to have to do.</span>
        <span>autopilot</span><span>.</span><span>setParameters</span><span>({</span>
          <span>[</span><span>LEVEL_FLIGHT</span><span>]:</span> <span>false</span><span>,</span>
          <span>[</span><span>HEADING_MODE</span><span>]:</span> <span>false</span><span>,</span>
        <span>});</span>

        <span>// Then we'll set flaps to fully retracted, for maximum</span>
        <span>// downforce. We need all the help we can get.</span>
        <span>console</span><span>.</span><span>log</span><span>(</span><span>`restore flaps`</span><span>);</span>
        <span>for</span> <span>(</span><span>let</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>10</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>api</span><span>.</span><span>set</span><span>(</span><span>`FLAPS_HANDLE_INDEX:1`</span><span>,</span> <span>0</span><span>);</span>

        <span>// Then if the plane has it, reverse thrust!</span>
        <span>console</span><span>.</span><span>log</span><span>(</span><span>`full reverse (if available)`</span><span>);</span>
        <span>for</span> <span>(</span><span>let</span> <span>i</span> <span>=</span> <span>1</span><span>;</span> <span>i</span> <span>&lt;=</span> <span>engineCount</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>{</span>
          <span>await</span> <span>api</span><span>.</span><span>trigger</span><span>(</span><span>`THROTTLE</span><span>${</span><span>i</span><span>}</span><span>_AXIS_SET_EX1`</span><span>,</span> <span>-</span><span>32000</span><span>);</span>
        <span>}</span>

        <span>// And in that same vein: speed brakes!</span>
        <span>console</span><span>.</span><span>log</span><span>(</span><span>`speed brakes (if available)`</span><span>);</span>
        <span>await</span> <span>api</span><span>.</span><span>trigger</span><span>(</span><span>`SPOILERS_ON`</span><span>);</span>

        <span>// And then the last stage...</span>
        <span>console</span><span>.</span><span>log</span><span>(</span><span>`start braking`</span><span>);</span>
        <span>this</span><span>.</span><span>brake</span> <span>=</span> <span>0</span><span>;</span>
        <span>stage</span><span>.</span><span>nextStage</span><span>();</span>
      <span>}</span>
    <span>}</span>

    <span>...</span>
</code></pre></div>

<h4 id="rolling-and-braking">Rolling and braking</h4>

<p>Alright! We made it down, the plane is on the runway, we didn’t crash… but that’s really “we didn’t crash <em>yet</em>” because we totally still can. It’s time to make sure we apply enough brakes to stop the plane, while using auto-rudder to keep us in a straight-ish line, with extra checks if we’re in a tail dragger because if we brake too hard, or we don’t pull back on the elevator while we’re braking, we’re going to nose-over followed by it being game-over.</p>

<div><pre><code>    <span>...</span>

    <span>if</span> <span>(</span><span>step</span> <span>===</span> <span>ROLL_AND_BRAKE</span><span>)</span> <span>{</span>
      <span>// Keep the throttle as far back as possible</span>
      <span>for</span> <span>(</span><span>let</span> <span>i</span> <span>=</span> <span>1</span><span>;</span> <span>i</span> <span>&lt;=</span> <span>engineCount</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>{</span>
        <span>await</span> <span>api</span><span>.</span><span>trigger</span><span>(</span><span>`THROTTLE</span><span>${</span><span>i</span><span>}</span><span>_AXIS_SET_EX1`</span><span>,</span> <span>-</span><span>32000</span><span>);</span>
      <span>}</span>

      <span>// Also keep trying to pitch the plane up 2 degrees when the wheels</span>
      <span>// aren't on the runway. Because trust me: we're going to bounce.</span>
      <span>if</span> <span>(</span><span>!</span><span>onGround</span><span>)</span> <span>{</span>
        <span>setPitch</span><span>(</span><span>api</span><span>,</span> <span>-</span><span>2</span><span>,</span> <span>flightInformation</span><span>);</span>
      <span>}</span> <span>else</span> <span>{</span>
        <span>// increase brakes while we're rolling, and use autorudder to</span>
        <span>// hopefully keep us on the runway while we brake:</span>
        <span>this</span><span>.</span><span>brake</span> <span>=</span> <span>Math</span><span>.</span><span>min</span><span>(</span><span>this</span><span>.</span><span>brake</span> <span>+</span> <span>5</span><span>,</span> <span>isTailDragger</span> <span>?</span> <span>70</span> <span>:</span> <span>100</span><span>);</span>
        <span>setBrakes</span><span>(</span><span>api</span><span>,</span> <span>this</span><span>.</span><span>brake</span><span>);</span>

        <span>// Stay on the runway...</span>
        <span>const</span> <span>prevDiff</span> <span>=</span> <span>this</span><span>.</span><span>autoRudderPrevHDiff</span><span>;</span>
        <span>this</span><span>.</span><span>autoRudderPrevHDiff</span> <span>=</span> <span>autoRudder</span><span>(</span><span>api</span><span>,</span> <span>p5</span><span>,</span> <span>flightData</span><span>,</span> <span>prevDiff</span><span>);</span>

        <span>// Are we in a tail dragger? If so, we need to pull back on the</span>
        <span>// elevator once we get to 50% brakes, to prevent the plane from</span>
        <span>// tipping over the wheels and driving the propellor straight into</span>
        <span>// the tarmac</span>
        <span>if</span> <span>(</span><span>isTailDragger</span> <span>&amp;&amp;</span> <span>this</span><span>.</span><span>brake</span> <span>&gt;</span> <span>50</span><span>)</span> <span>{</span>
          <span>const</span> <span>elevator</span> <span>=</span> <span>constrainMap</span><span>(</span><span>this</span><span>.</span><span>brake</span><span>,</span> <span>0</span><span>,</span> <span>100</span><span>,</span> <span>0</span><span>,</span> <span>-</span><span>4000</span><span>)</span> <span>|</span> <span>0</span><span>;</span>
          <span>api</span><span>.</span><span>trigger</span><span>(</span><span>`ELEVATOR_SET`</span><span>,</span> <span>elevator</span><span>);</span>
        <span>}</span>

        <span>// If we're in a plane with tricycle gears, and we reach our</span>
        <span>// stall speed, use the flaps as a speed brake.</span>
        <span>if</span> <span>(</span><span>speed</span> <span>&lt;</span> <span>vs0</span> <span>&amp;&amp;</span> <span>!</span><span>isTailDragger</span><span>)</span> <span>{</span>
          <span>console</span><span>.</span><span>log</span><span>(</span><span>`add flaps to brake even more`</span><span>);</span>
          <span>for</span> <span>(</span><span>let</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>10</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>api</span><span>.</span><span>set</span><span>(</span><span>`FLAPS_HANDLE_INDEX:1`</span><span>,</span> <span>10</span><span>);</span>
        <span>}</span>

        <span>// And finally, once we slow down to a crawl, end the landing.</span>
        <span>if</span> <span>(</span><span>speed</span> <span>&lt;</span> <span>5</span><span>)</span> <span>{</span>
          <span>console</span><span>.</span><span>log</span><span>(</span><span>`cutoff speed reached`</span><span>);</span>
          <span>stage</span><span>.</span><span>nextStage</span><span>();</span>
        <span>}</span>
      <span>}</span>
    <span>}</span>

    <span>...</span>
</code></pre></div>

<p>Although in order to successfully auto-rudder, we’ll need to add that <code>autoRudderPrevHDiff</code> boolean as an instance value:</p>

<div><pre><code><span>...</span>
<span>export</span> <span>class</span> <span>AutoLanding</span> <span>{</span>
  <span>...</span>

  <span>reset</span><span>(</span><span>autopilot</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>flightModel</span><span>)</span> <span>{</span>
    <span>this</span><span>.</span><span>autoRudderPrevHDiff</span> <span>=</span> <span>0</span><span>;</span>
    <span>this</span><span>.</span><span>done</span> <span>=</span> <span>false</span><span>;</span>
    <span>...</span>
  <span>}</span>

  <span>...</span>
<span>}</span>
</code></pre></div>

<h4 id="ending-our-landing">Ending our landing</h4>

<p>We’ve done it! All that’s left is to flip all the toggles to “off”, power down, and walk away from our successful landing!</p>

<div><pre><code>    <span>...</span>

    <span>if</span> <span>(</span><span>step</span> <span>===</span> <span>END_OF_LANDING</span><span>)</span> <span>{</span>
      <span>console</span><span>.</span><span>log</span><span>(</span><span>`set parking brakes`</span><span>);</span>
      <span>setBrakes</span><span>(</span><span>api</span><span>,</span> <span>0</span><span>);</span>
      <span>api</span><span>.</span><span>trigger</span><span>(</span><span>`PARKING_BRAKES`</span><span>);</span>

      <span>console</span><span>.</span><span>log</span><span>(</span><span>`idle throttle`</span><span>);</span>
      <span>for</span> <span>(</span><span>let</span> <span>i</span> <span>=</span> <span>1</span><span>;</span> <span>i</span> <span>&lt;=</span> <span>engineCount</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>{</span>
        <span>api</span><span>.</span><span>set</span><span>(</span><span>`GENERAL_ENG_THROTTLE_LEVER_POSITION:</span><span>${</span><span>i</span><span>}</span><span>`</span><span>,</span> <span>0</span><span>);</span>
      <span>}</span>

      <span>console</span><span>.</span><span>log</span><span>(</span><span>`retract flaps`</span><span>);</span>
      <span>for</span> <span>(</span><span>let</span> <span>i</span> <span>=</span> <span>0</span><span>;</span> <span>i</span> <span>&lt;</span> <span>10</span><span>;</span> <span>i</span><span>++</span><span>)</span> <span>api</span><span>.</span><span>set</span><span>(</span><span>`FLAPS_HANDLE_INDEX:1`</span><span>,</span> <span>0</span><span>);</span>

      <span>console</span><span>.</span><span>log</span><span>(</span><span>`disengage speed brakes`</span><span>);</span>
      <span>api</span><span>.</span><span>trigger</span><span>(</span><span>`SPOILERS_OFF`</span><span>);</span>

      <span>console</span><span>.</span><span>log</span><span>(</span><span>`AP off`</span><span>);</span>
      <span>autopilot</span><span>.</span><span>setParameters</span><span>({</span>
        <span>MASTER</span><span>:</span> <span>false</span><span>,</span>
        <span>[</span><span>ALTITUDE_HOLD</span><span>]:</span> <span>false</span><span>,</span>
        <span>[</span><span>AUTO_LANDING</span><span>]:</span> <span>false</span><span>,</span>
        <span>[</span><span>HEADING_MODE</span><span>]:</span> <span>false</span><span>,</span>
        <span>[</span><span>LEVEL_FLIGHT</span><span>]:</span> <span>false</span><span>,</span>
      <span>});</span>

      <span>console</span><span>.</span><span>log</span><span>(</span><span>`shut down engines`</span><span>);</span>
      <span>api</span><span>.</span><span>trigger</span><span>(</span><span>`ENGINE_AUTO_SHUTDOWN`</span><span>);</span>
      <span>this</span><span>.</span><span>done</span> <span>=</span> <span>true</span><span>;</span>
    <span>}</span>
  <span>}</span>
<span>}</span>
</code></pre></div>

<p>And that’s it: one auto-lander, done. Well, almost:</p>



<p>We do still need the extra functions that we’re calling for autorudder and maintaining upward pitch over the runway:</p>

<div><pre><code><span>/**
 * First up, the brakes: this is simply a matter of setting the left and
 * right brake axes to whatever value we're tracking as `this.brakes`:
 */</span>
<span>function</span> <span>setBrakes</span><span>(</span><span>api</span><span>,</span> <span>percentage</span><span>)</span> <span>{</span>
  <span>const</span> <span>value</span> <span>=</span> <span>map</span><span>(</span><span>percentage</span><span>,</span> <span>0</span><span>,</span> <span>100</span><span>,</span> <span>-</span><span>16383</span><span>,</span> <span>16383</span><span>)</span> <span>|</span> <span>0</span><span>;</span>
  <span>api</span><span>.</span><span>trigger</span><span>(</span><span>`AXIS_LEFT_BRAKE_SET`</span><span>,</span> <span>value</span><span>);</span>
  <span>api</span><span>.</span><span>trigger</span><span>(</span><span>`AXIS_RIGHT_BRAKE_SET`</span><span>,</span> <span>value</span><span>);</span>
<span>}</span>

<span>/**
 * Then the pitch function, which uses the elevator to (hopefully)
 * ensure a plane pitch that'll let us drop safely in the runway:
 */</span>
<span>function</span> <span>setPitch</span><span>(</span><span>api</span><span>,</span> <span>targetPitch</span><span>,</span> <span>{</span> <span>model</span><span>:</span> <span>flightModel</span><span>,</span> <span>data</span><span>:</span> <span>flightData</span> <span>})</span> <span>{</span>
  <span>let</span> <span>{</span> <span>elevator</span><span>,</span> <span>pitch</span><span>,</span> <span>dPitch</span> <span>}</span> <span>=</span> <span>flightData</span><span>;</span>
  <span>let</span> <span>{</span> <span>weight</span> <span>}</span> <span>=</span> <span>flightModel</span><span>;</span>
  <span>elevator</span> <span>=</span> <span>-</span><span>(</span><span>elevator</span> <span>/</span> <span>100</span><span>)</span> <span>*</span> <span>2</span> <span>**</span> <span>14</span><span>;</span>
  <span>const</span> <span>diff</span> <span>=</span> <span>targetPitch</span> <span>-</span> <span>pitch</span><span>;</span>
  <span>// The heavier the plane is, the more stick we give it.</span>
  <span>// Also note that if we're in a particularly light plane,</span>
  <span>// we're not going to do anything: those already glide just</span>
  <span>// fine on their own.</span>
  <span>const</span> <span>maxValue</span> <span>=</span> <span>constrainMap</span><span>(</span><span>weight</span><span>,</span> <span>2000</span><span>,</span> <span>6000</span><span>,</span> <span>0</span><span>,</span> <span>1500</span><span>);</span>
  <span>let</span> <span>correction</span> <span>=</span> <span>constrainMap</span><span>(</span><span>diff</span><span>,</span> <span>-</span><span>5</span><span>,</span> <span>5</span><span>,</span> <span>-</span><span>maxValue</span><span>,</span> <span>maxValue</span><span>);</span>
  <span>let</span> <span>next</span> <span>=</span> <span>elevator</span> <span>+</span> <span>correction</span><span>;</span>
  <span>api</span><span>.</span><span>trigger</span><span>(</span><span>`ELEVATOR_SET`</span><span>,</span> <span>next</span> <span>|</span> <span>0</span><span>);</span>
<span>}</span>

<span>/**
 * And finally, our auto-rudder code, which is similar to, but subtly
 * different from, the code we used in our auto-takeoff.js:
 */</span>
<span>function</span> <span>autoRudder</span><span>(</span><span>api</span><span>,</span> <span>target</span><span>,</span> <span>{</span> <span>onGround</span><span>,</span> <span>lat</span><span>,</span> <span>long</span><span>,</span> <span>trueHeading</span><span>,</span> <span>rudder</span> <span>},</span> <span>prevDiff</span><span>,</span> <span>cMax</span> <span>=</span> <span>0.05</span><span>)</span> <span>{</span>
  <span>if</span> <span>(</span><span>!</span><span>onGround</span><span>)</span> <span>return</span><span>;</span>

  <span>// How much are we off by?</span>
  <span>const</span> <span>targetHeading</span> <span>=</span> <span>getHeadingFromTo</span><span>(</span><span>lat</span><span>,</span> <span>long</span><span>,</span> <span>target</span><span>.</span><span>lat</span><span>,</span> <span>target</span><span>.</span><span>long</span><span>);</span>
  <span>let</span> <span>hDiff</span> <span>=</span> <span>getCompassDiff</span><span>(</span><span>trueHeading</span><span>,</span> <span>targetHeading</span><span>);</span>
  <span>const</span> <span>dHeading</span> <span>=</span> <span>hDiff</span> <span>-</span> <span>prevDiff</span><span>;</span>

  <span>// And so how much do we need to adjust the rudder by?</span>
  <span>let</span> <span>update</span> <span>=</span> <span>0</span><span>;</span>
  <span>update</span> <span>+=</span> <span>constrainMap</span><span>(</span><span>hDiff</span><span>,</span> <span>-</span><span>30</span><span>,</span> <span>30</span><span>,</span> <span>-</span><span>cMax</span> <span>/</span> <span>2</span><span>,</span> <span>cMax</span> <span>/</span> <span>2</span><span>);</span>
  <span>update</span> <span>+=</span> <span>constrainMap</span><span>(</span><span>dHeading</span><span>,</span> <span>-</span><span>1</span><span>,</span> <span>1</span><span>,</span> <span>-</span><span>cMax</span><span>,</span> <span>cMax</span><span>);</span>

  <span>const</span> <span>newRudder</span> <span>=</span> <span>rudder</span> <span>/</span> <span>100</span> <span>+</span> <span>update</span><span>;</span>
  <span>api</span><span>.</span><span>set</span><span>(</span><span>`RUDDER_POSITION`</span><span>,</span> <span>newRudder</span><span>);</span>

  <span>// And return the current heading difference so the</span>
  <span>// code can cache that for use in the next call:</span>
  <span>return</span> <span>hDiff</span><span>;</span>
<span>}</span>
</code></pre></div>

<p>My god, we’re done! <em>We’re done!!</em></p>

<h3 id="testing-everything">Testing <em>Everything</em></h3>

<p>Now, testing this code is rather straight forward in that we just fire up MSFS, put a plan on a runway, create a bit of a flight plan, hit “take off” in the browser, and when we reach the last marker, we click “land” (we could automate that, but that’s for another day. By you). However, since that does not translate well into pictures, let’s just capture these tests using the medium of video.</p>

<p>First, let’s do a quick “take-off and landing” at Victoria Airport in the Cessna 310R. We’ll spawn the plane, click “land” to generate a set of landing waypoints, and then we’ll click “take off” to make the plane take off, switch to autopilot, start flying the flight plan, and land itself on the same runway it took off from:</p>

<iframe width="100%" height="400px" src="https://www.youtube.com/embed/jj1JLyk9c1s?si=pTMpkG-Qc1XcZ-I5" frameborder="0" allow="picture-in-picture" allowfullscreen=""></iframe>

<p>And since that went pretty well, let’s put this to real use: we’ll fly the Beaver from <a href="https://dingleburn.co.nz/">Dingleburn Station</a>, on New Zealand’s South Island, to <a href="https://en.wikipedia.org/wiki/W%C4%81naka">Wānaka</a>, with auto-takeoff, waypoint navigation, and auto-landing. Enjoy a 28 minute trip across some beautiful New Zealand scenery.</p>

<iframe width="100%" height="400px" src="https://www.youtube.com/embed/TtmhvcGgsOo" frameborder="0" allow="picture-in-picture" allowfullscreen=""></iframe>

<h2 id="conclusions">Conclusions</h2>

<p>Holy crap, we did a lot! Also: this stuff is cool!</p>

<p>We’ve just been writing JS bit by bit, and suddenly our code’s flying aeroplanes in a flight simulator start to finish. Sure, we could have spent all this time learning how to program a flight director, but it’s not like every plane has one, and unless you’re deep into flight sims and you want full realism, programming flight directors using 1980’s interfaces isn’t exactly an appealing prospect.</p>

<p>And yes, getting to the point where can just hit “go” and enjoy the ride took a considerable amount of work, but the result is proportional to the time and effort we expended. We made something pretty damn impressive!</p>

<p>So where do we go from here? Here are some thoughts:</p>

<ol>
  <li>Our alt hold is still a bit wibbly, which is especially noticeable in planes like the Kodiak 100, or when playing game footage at 4x speed. This is a consequence of only firing off corrections every half second, but we could probably still find something that works a little better by using forward prediction and making the alt hold function not be stateless. And then the obvious follow-up would be to make the fly level/heading mode code not stateless, either.</li>
  <li>We could vastly improve auto landing by taking runway length and slope into account, as well as fitting an approach to the terrain instead of simply doing a yes/no basd on where we fairly naively placed our approach points. Imaging auto-landing at <a href="https://en.wikipedia.org/wiki/Tenzing-Hillary_Airport">Tenzing-Hillary Airport</a>, for instance!</li>
  <li>We could make the waypoint code more like “path tracking” code, where we don’t just define waypoints with an implicit polygon, but where we define the actual flight path itself, so that at any point on the path there is some “ideal” heading that the plane should be flying, so that we can actually fly through curvy canyons or slalom some hills, rather than just flying mostly straight lines.</li>
  <li>We could try to replace our blocks of “control code guesses” with self-tuning PID controlles so we that we only need to say what targets we want, and have the PID controllers figure out what good steps sizes for that are. This is one of those “conceptually, this is simple” because we can replace a whole bunch of code with a PID initialization and then a few lines of update loop, but actually making that work can be the worst time sink you never knew existed. The problem with PID controllers isn’t setting them up, it’s the full-time job of tweaking them that will make you regret your life decisions.</li>
  <li>We could make our ALOS server generate “XYZ tiles”, so that we can use it as a map source for our leaflet map rather than using google’s topology layer.</li>
  <li>…you’ve seen what we can do already, the sky’s the limit. Or, you know what: no, it isn’t. We’re already flying, there are no limits. Get your learn on and write something amazing, and then tell the world about it.</li>
</ol>

<p>I hope you had fun, and maybe I’ll see you in-sim. Send me a screenshot if you see me flying, I might just be testing more code to add to this tutorial! =D</p>

<p>— <a href="https://mastodon.social/@TheRealPomax">Pomax</a></p>

<!-- This document has interactive graphics, which requires JS -->




<!-- And I have style requirements -->






      
    </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Monitoring energy usage with smart plugs, Prometheus and Grafana (260 pts)]]></title>
            <link>https://ounapuu.ee/posts/2024/05/02/smartplugs/</link>
            <guid>40266845</guid>
            <pubDate>Sun, 05 May 2024 18:05:31 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://ounapuu.ee/posts/2024/05/02/smartplugs/">https://ounapuu.ee/posts/2024/05/02/smartplugs/</a>, See on <a href="https://news.ycombinator.com/item?id=40266845">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
      
      <p>This post <strong>isn’t</strong> a detailed line-by-line tutorial on how to set up each individual piece of the setup as those types of
guides tend to get out of date really easily, but if you know your way around Linux and the command line, then you can
definitely replicate this setup on your own.</p>
<p>Over the past few years I’ve been interested in learning about how much energy my computing setup and home
appliances use.
I’ve used a simple digital energy meter before to get instantaneous readings, but that was not ideal for monitoring
how an electrical appliance consumes power over a longer time period.</p>
<p>My friend bought a few smart plugs from <a href="https://www.athom.tech/">athom.tech</a>. After getting confirmation
that they don’t suck, I went ahead and ordered some myself.</p>
<p>The smart plugs I bought were the <code>EU style plug V3</code> variant. The shipping times in EU were reasonably fast, shipping in 9
days (and that included Christmas!).</p>
<p>The plugs ship with <a href="https://tasmota.github.io/docs/">Tasmota</a> pre-flashed. The plugs come with a small paper strip explaining
the steps to take to connect the plug to your Wi-Fi network, and after that you can manage the plug in your browser.</p>







  




<figure>
    
    <a href="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/tasmota-quick-start.jpg">
        <img src="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/tasmota-quick-start_hud8e7f39a6a53718c04b020d97b33e675_1308648_800x0_resize_q80_box.jpg" width="800" height="314" alt="Quick start instructions that ship with the smart plug.">
    </a>
    <figcaption>
      Quick start instructions that ship with the smart plug.
    </figcaption>
    
</figure>

<p>Updating the firmware to the latest version is easy and doable in the web GUI with just a few clicks.</p>







  




<figure>
    
    <a href="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/webui.png">
        <img src="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/webui_hu9cb46fbfd4c7dc7dc40ad2d15cd826a4_70799_800x800_fit_box_3.png" width="395" height="800" alt="The web UI is simple and very functional.">
    </a>
    <figcaption>
      The web UI is simple and very functional.
    </figcaption>
    
</figure>

<h3 id="the-software-stack">The software stack</h3>
<p>My initial goal with these plugs was to visually monitor the power consumption of a few devices, such as my home server, router,
workstation setup and the electric water heater.</p>
<p>The power meter data is collected to an existing <a href="https://prometheus.io/">Prometheus</a> instance on my home server.
If you’re not sure what Prometheus is, then think of it as a tool that periodically reads metrics from different
sources, saves them to disk and allows you to later query and manipulate that information.</p>
<p>I run multiple instances of this <a href="https://github.com/astr0n8t/tasmota-power-exporter">tasmota-power-exporter</a> solution on my server, one per plug, which get scraped once
per second by the Prometheus instance. <a href="https://github.com/arendst/Tasmota/issues/9206">It is possible to also make the plugs themselves export these metrics,</a>
but I didn’t fancy building Tasmota firmware myself, yet.<sup id="fnref:1"><a href="#fn:1" role="doc-noteref">1</a></sup></p>
<p>I already had a <a href="https://grafana.com/">Grafana</a> instance running on my home server, so I reused that to show a few basic
graphs for the power meter setup.</p>
<p><em>Free tech tip</em>: make sure to change the <code>min step</code> setting to 1 second to get the most detailed data points on your graphs.</p>







  




<figure>
    
    <a href="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/grafana-minstep.png">
        <img src="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/grafana-minstep_hu5952a2b903b7f2b98c216cc3f852d5fc_23721_0x800_resize_q80_box_3.png" width="1388" height="800" alt="It's this one. ">
    </a>
    <figcaption>
      It's this one. 
    </figcaption>
    
</figure>

<h3 id="observations-and-findings">Observations and findings</h3>
<p>So, what have I learned after running this setup for almost 4 months?</p>
<h4 id="water-heater">Water heater</h4>
<p>It shouldn’t come as a surprise that the electric water heater uses up the most power. The one we have is a 30L one,
just enough for a quick shower or two or for washing a large load of dishes.</p>
<p>Typical power usage: 4.51 kWh/day.</p>
<p>Minimum observed: 0.56 kWh/day, happens usually when nobody is at home</p>
<p>Maximum observed: 11.1 kWh/day, a lot of washing and showering happened on that day</p>







  




<figure>
    
    <a href="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/boiler-graph.png">
        <img src="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/boiler-graph_hu3c09159cad2bcc54c8ac07b8e29f09e1_40283_1280x800_fit_box_3.png" width="1120" height="475" alt="Typical power consumption pattern of a water heater.">
    </a>
    <figcaption>
      Typical power consumption pattern of a water heater.
    </figcaption>
    
</figure>

<h4 id="home-server-setup">Home server setup</h4>
<p>I run all my home server workloads off of a <a href="https://ounapuu.ee/posts/2023/10/09/zimaboard/">Zimaboard</a>. One of its big selling
points for me was its super low power consumption.
When idling, the Zimaboard can use about 2 W, typical power usage with all my services running was about 7 W and the
maximum power consumption was around 15 W.</p>
<p>The Zimaboard was actually using <em>less power</em> than my internet modem/router box (which is hot garbage by the way).
The ISP-provided box used 12-14 W at all times, regardless if it was operating in router or bridge mode.</p>







  




<figure>
    
    <a href="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/zimaboard-graph.png">
        <img src="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/zimaboard-graph_hu055bc352ee25bf176b52d5fd4b0b88b3_51555_1280x800_fit_box_3.png" width="1120" height="475" alt="Zimaboard + modem/router box power consumption.">
    </a>
    <figcaption>
      Zimaboard + modem/router box power consumption.
    </figcaption>
    
</figure>








  




<figure>
    
    <a href="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/isp-box-graph.png">
        <img src="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/isp-box-graph_hu1e3c979303e2f87de6a24325c2363805_31156_1280x800_fit_box_3.png" width="1120" height="475" alt="The ISP modem/router box is a horribly inefficient device for what it does.">
    </a>
    <figcaption>
      The ISP modem/router box is a horribly inefficient device for what it does.
    </figcaption>
    
</figure>

<p>At one point I temporarily switched my home server setup back to <a href="https://ounapuu.ee/posts/2022/01/17/asrock-x300-future-of-desktops/">the ASRock Deskmini X300</a>,
mainly because I added some latency-sensitive workloads onto my home server setup and the Zimaboard was a bit too weak
for those.</p>
<p>One thing that became really obvious from the power meter is that the Deskmini idle power consumption is
horrible in comparison to the Zimaboard, coming in at around 15-20 W. This might be in part because my Deskmini doesn’t
seem to expose any lower CPU power states than C3 while the Zimaboard exposed C-states all the way down to C10. I could not
find a way to expose lower C-states in UEFI settings or the Linux kernel. Based on a quick remark in <a href="https://www.youtube.com/watch?v=J_WJI4hp_B8">this video</a> I believe that it should
be possible to drop ASRock a message and receive a custom BIOS that enables some extra features, but that seems even
more unlikely for a consumer-grade device such as this one.</p>







  




<figure>
    
    <a href="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/deskmini-graph.png">
        <img src="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/deskmini-graph_hu12358bc476ba2cd784ed64bf5d0ac17b_59098_1280x800_fit_box_3.png" width="1120" height="475" alt="ASRock Deskmini X300 + ISP box power consumption.">
    </a>
    <figcaption>
      ASRock Deskmini X300 + ISP box power consumption.
    </figcaption>
    
</figure>

<p>I’ve added a panel to my usual Prometheus node exporter Grafana view that shows the server setup power consumption alongside
other metrics. Higher CPU activity is clearly visible on the power consumption graphs.</p>







  




<figure>
    
    <a href="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/cpu-power-correlation.png">
        <img src="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/cpu-power-correlation_hu6a4123be6d182f8d302d750b742423eb_75617_1280x800_fit_box_3.png" width="1280" height="397" alt="A moderate jump in CPU usage can result in a big jump in power consumption.">
    </a>
    <figcaption>
      A moderate jump in CPU usage can result in a big jump in power consumption.
    </figcaption>
    
</figure>

<h4 id="voltage">Voltage</h4>
<p>The Tasmota plugs also report current voltage values. I graphed them just for fun, but noticed that there is a sort of
seasonality to the values. During the usual peak power consumption hours the voltage drops across the board.</p>







  




<figure>
    
    <a href="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/voltage-seasonality.png">
        <img src="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/voltage-seasonality_hubd736162f2fe021fc12c120d470b0510_67975_1280x800_fit_box_3.png" width="1280" height="404" alt="Seasonality as expressed through voltage readings.">
    </a>
    <figcaption>
      Seasonality as expressed through voltage readings.
    </figcaption>
    
</figure>

<p>This seems like a candidate for testing anomaly detection, as shown in <a href="https://about.gitlab.com/blog/2019/07/23/anomaly-detection-using-prometheus/">this great GitLab article.</a>
I’ve used this concept at work and it works reasonably well for some metrics.</p>
<p>In other cases the voltage drops were caused by running appliances that use a lot of power, such as the water heater, electric kettle, electric stove or the microwave.</p>







  




<figure>
    
    <a href="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/voltage-correlation.png">
        <img src="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/voltage-correlation_hue628dc4aa97bc3ea50aef7ac1fc91da1_94305_1280x800_fit_box_3.png" width="1280" height="640" alt="Water heater causing the voltage to drop slightly for all plugs.">
    </a>
    <figcaption>
      Water heater causing the voltage to drop slightly for all plugs.
    </figcaption>
    
</figure>

<p>During cooking with an electric stove, the on-off cycles were also noticeable on
the voltage reading on all of the plugs.</p>







  




<figure>
    
    <a href="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/voltage-cooking.png">
        <img src="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/voltage-cooking_hu41bea76e23e5fc9573d24fc34ba37fd6_47963_1280x800_fit_box_3.png" width="1277" height="483" alt="The impact of an electric stove on the voltage.">
    </a>
    <figcaption>
      The impact of an electric stove on the voltage.
    </figcaption>
    
</figure>

<h4 id="workstation">Workstation</h4>
<p>I have one plug that reports numbers for everything that’s connected to my home office setup: monitor, USB-C dock,
monitor light bar and anything that might be charging on the table.</p>
<p>The power consumption of this setup varies a lot. Sometimes I do a longer home office stint. Sometimes I recharge various
devices.</p>
<p>The typical power consumption of the whole setup while doing something on my computer is around 45-60 W, with peaks near
90-110 W. For an ultrawide monitor, USB-C dock and my laptop I think this is a pretty good result. I’ve had desktop PC-s
that have used just as much power at idle, and in the olden days there were incandescent light bulbs that used up more
electricity than this!</p>







  




<figure>
    
    <a href="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/workstation-graph.png">
        <img src="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/workstation-graph_hu69ef3419847b6fdff7382ac034b83d8c_76961_1280x800_fit_box_3.png" width="1280" height="474" alt="Typical power consumption of my work desk when working from home.">
    </a>
    <figcaption>
      Typical power consumption of my work desk when working from home.
    </figcaption>
    
</figure>

<p>Typical power usage: 0.95 kWh/day.</p>
<p>Minimum observed: 0.07 kWh/day</p>
<p>Maximum observed: 1.52 kWh/day</p>
<h4 id="charging">Charging</h4>
<p>These plugs are also great for observing the charging patterns of various devices.</p>
<p>A laptop or a power bank charges faster at the beginning, but the speed drops off as the battery gets more full.
At one point trickle charging seems to kick in until the device is fully charged.</p>







  




<figure>
    
    <a href="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/charging-powerbank.png">
        <img src="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/charging-powerbank_hu55e72ff27215711fa9d1862b182b4dc9_39049_1280x800_fit_box_3.png" width="1279" height="530" alt="A power bank charges quickly in the beginning and starts slowing down once it gets close to being fully charged.">
    </a>
    <figcaption>
      A power bank charges quickly in the beginning and starts slowing down once it gets close to being fully charged.
    </figcaption>
    
</figure>

<p>This pattern is similar on most devices that I charge. The battery on my e-bike seems to be an exception to the rule,
with a slighly increasing power consumption throughout, and a faster drop at the end of the charging cycle.</p>







  




<figure>
    
    <a href="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/charging-ebike-battery.png">
        <img src="https://ounapuu.ee/posts/2024/05/02/smartplugs/media/charging-ebike-battery_hu3fb1bef274b21cbbf3f2d364478b5fca_40104_1280x800_fit_box_3.png" width="1279" height="530" alt="E-bike battery charging pattern, from nearly empty to full.">
    </a>
    <figcaption>
      E-bike battery charging pattern, from nearly empty to full.
    </figcaption>
    
</figure>

<p>0.5kWh of power consumed for 60km of range with the “Turbo” preset on the bike doesn’t sound bad at all. Half a cent per
kilometer!</p>
<h4 id="stability">Stability</h4>
<p>The stability of the smart plugs is usually fine, but there are frequent cases where certain plugs don’t report back in time
with the statistics. This may be a Wi-Fi access point issue, but annoying nevertheless.</p>
<p>I’ve had to completely power cycle two plugs a few times because they dropped off from the network completely and would
not come back. Again, could be the fault of my Wi-Fi AP.</p>
<h4 id="future-ideas">Future ideas</h4>
<p>The plugs also provide a way to turn the devices on and off over different
API-s (even over HTTP!), which is something I’d like to utilize either using something like <a href="https://www.home-assistant.io/">Home Assistant</a>, or a simple
script that toggles certain devices on and off based on the current electricity price.</p>
<p>I haven’t gotten around to this part yet, but from my research it seems that <a href="https://github.com/custom-components/nordpool">the necessary integrations
exist for Home Assistant.</a></p>
<h3 id="closing-thoughts">Closing thoughts</h3>
<p>Overall, I’m very happy with this setup. I can get reliable measurements for all sorts of computing setups from now on,
which will make judging the power efficiency of the devices I use much easier. No more guesswork!</p>
<p>If you enjoyed this post, then I highly recommend giving <a href="https://fosdem.org/2024/schedule/event/fosdem-2024-2723-power-profiling-my-entire-house-with-the-firefox-profiler/">this FOSDEM 2024 talk by Florian Quèze a listen.</a>
The talk also goes into details about measuring the power consumption of various devices in the speakers’ home and
observations that they’ve made.</p>


    </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Infini-Gram: Scaling unbounded n-gram language models to a trillion tokens (115 pts)]]></title>
            <link>https://arxiv.org/abs/2401.17377</link>
            <guid>40266791</guid>
            <pubDate>Sun, 05 May 2024 17:58:13 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://arxiv.org/abs/2401.17377">https://arxiv.org/abs/2401.17377</a>, See on <a href="https://news.ycombinator.com/item?id=40266791">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="content-inner">
    
    
                
    <p><a href="https://arxiv.org/pdf/2401.17377">View PDF</a>
    <a href="https://arxiv.org/html/2401.17377v3">HTML (experimental)</a></p><blockquote>
            <span>Abstract:</span>Are $n$-gram language models still relevant in this era of neural large language models (LLMs)? Our answer is yes, and we showcase their values in both text analysis and improving neural LLMs. This was done by modernizing $n$-gram LMs in two aspects. First, we train them at the same data scale as neural LLMs -- 5 trillion tokens. This is the largest $n$-gram LM ever built. Second, existing $n$-gram LMs use small $n$ which hinders their performance; we instead allow $n$ to be arbitrarily large, by introducing a new $\infty$-gram LM with backoff. Instead of pre-computing $n$-gram count tables (which would be very expensive), we develop an engine named infini-gram -- powered by suffix arrays -- that can compute $\infty$-gram (as well as $n$-gram with arbitrary $n$) probabilities with millisecond-level latency. The $\infty$-gram framework and infini-gram engine enable us to conduct many novel and interesting analyses of human-written and machine-generated text: we find that the $\infty$-gram LM has fairly high accuracy for next-token prediction (47%), and can complement neural LLMs to greatly reduce their perplexity. When analyzing machine-generated text, we also observe irregularities in the machine--$\infty$-gram agreement level with respect to the suffix length, which indicates deficiencies in neural LLM pretraining and the positional embeddings of Transformers.
    </blockquote>

    <!--CONTEXT-->
    
  </div><div>
      <h2>Submission history</h2><p> From: Jiacheng Liu [<a href="https://arxiv.org/show-email/db328fb4/2401.17377">view email</a>]      <br>            <strong><a href="https://arxiv.org/abs/2401.17377v1">[v1]</a></strong>
        Tue, 30 Jan 2024 19:03:49 UTC (6,464 KB)<br>
            <strong><a href="https://arxiv.org/abs/2401.17377v2">[v2]</a></strong>
        Tue, 2 Apr 2024 18:14:53 UTC (7,819 KB)<br>
    <strong>[v3]</strong>
        Thu, 4 Apr 2024 17:28:38 UTC (7,917 KB)<br>
</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Microsoft CTO: Thoughts on OpenAI (2019) (277 pts)]]></title>
            <link>https://twitter.com/techemails/status/1787176471146156193</link>
            <guid>40266728</guid>
            <pubDate>Sun, 05 May 2024 17:50:12 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://twitter.com/techemails/status/1787176471146156193">https://twitter.com/techemails/status/1787176471146156193</a>, See on <a href="https://news.ycombinator.com/item?id=40266728">Hacker News</a></p>
Couldn't get https://twitter.com/techemails/status/1787176471146156193: Error: Request failed with status code 400]]></description>
        </item>
        <item>
            <title><![CDATA[Simplicity is an advantage but sadly complexity sells better (2022) (233 pts)]]></title>
            <link>https://eugeneyan.com/writing/simplicity/</link>
            <guid>40266464</guid>
            <pubDate>Sun, 05 May 2024 17:17:07 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://eugeneyan.com/writing/simplicity/">https://eugeneyan.com/writing/simplicity/</a>, See on <a href="https://news.ycombinator.com/item?id=40266464">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
<p>We sometimes hear of a paper submission being rejected because the method was too simple, or a promotion being denied because the work artifacts lacked complexity. I think this can be partly explained by Dijkstra’s quote:</p>
<blockquote>
<p>“Simplicity is a great virtue but it requires hard work to achieve it and education to appreciate it. And to make matters worse: complexity sells better.” — <a href="https://en.wikipedia.org/wiki/Edsger_W._Dijkstra" target="_blank">Edsger Dijkstra</a></p>
</blockquote>
<h2 id="why-does-complexity-sell-better">Why does complexity sell better?</h2>
<p><strong>Complexity signals effort.</strong> Papers with difficult ideas and technical details suggest blood, sweat, and tears. Systems with more components and features hint at more effort than systems with less. Because complex artifacts are viewed as requiring more effort, they’re also deemed as more challenging to create and thus more worthy. And because of the perceived effort involved, they’re often judged to be higher quality.</p>
<p><strong>Complexity signals mastery.</strong> A complex system with many moving parts suggests that the designer has proficiency over each part and the ability to integrate them. Inaccessible papers peppered with jargon and proofs demonstrate expertise on the subject. (This is also why we quiz interview candidates on algorithms and data structures that are rarely used at work.) If laymen have a hard time understanding the complex idea or system, its creator must be an expert, right?</p>
<p><strong>Complexity signals innovation.</strong> Papers that invent entirely new model architectures are recognized as more novel relative to papers that adapt existing networks. Systems with components built from scratch are considered more inventive than systems that reuse existing parts. Work that <em>just</em> builds on or reuses existing work isn’t <em>that</em> innovative.</p>
<blockquote>
<p>“The idea is too simple, almost like a trick. It only changes one thing and everything else is the same as prior work.” — Reviewer 2</p>
</blockquote>
<p><strong>Complexity signals more features.</strong> Systems with components that can be mixed and matched suggest flexibility to cover all the bases. For example, supporting both SQL and NoSQL data stores, or enabling both batch and streaming pipelines. Because complex systems have more lego blocks relative to simple systems, they’re considered more adaptable and better able to respond to change.</p>
<p>All in all, the above leads to <a href="https://fs.blog/complexity-bias/" target="_blank">complexity bias</a> where we give undue credit to and favour complex ideas and systems over simpler ones.</p>
<h2 id="why-is-simplicity-an-advantage">Why is simplicity an advantage?</h2>
<p><strong>Simple ideas and features are easier to understand and use.</strong> This makes them more likely to gain adoption and create impact. They’re also easier to communicate and get feedback on. In contrast, complex systems are harder to explain and manage, making it difficult for users to figure out what to do and how to do it. Because there are too many knobs, mistakes are more frequent. Because there are too many steps, inefficiency occurs.</p>
<p><strong>Simple systems are easier to build and scale.</strong> Systems that require less rather than more components are easier to implement. Using standard, off-the-shelf technology also makes it easier to find qualified people who can implement and maintain it. And because simpler systems have less complexity, code, and intra-system interactions, they’re easier to understand and test. In contrast, needlessly complex systems require more time and resources to build, leading to inefficiency and waste.</p>
<blockquote>
<p>When Instagram was acquired in 2012, it had a 13-person team serving tens of millions of users. It <a href="https://www.scribd.com/document/89025069/Mike-Krieger-Instagram-at-the-Airbnb-tech-talk-on-Scaling-Instagram" target="_blank">scaled</a> and kept operational burden per engineer low by <a href="https://instagram-engineering.com/what-powers-instagram-hundreds-of-instances-dozens-of-technologies-adf2e22da2ad" target="_blank">sticking to proven technologies</a> instead of new, shiny ones. When other startups adopted trendy NoSQL data stores and struggled, Instagram kept it lean with battle-proven and easy-to-understand PostgreSQL and Redis.</p>
</blockquote>
<p><strong>Simple systems have lower operational costs.</strong> Deploying a system is not the finish line; it’s the starting line. The bulk of the effort comes <em>after</em> the system is in production, likely by <em>someone other than the original team</em> that built it. By keeping systems simple, we lower their maintenance cost and increase their longevity.</p>
<p>Simple systems have fewer moving parts that can break, making them more reliable and easier to fix. It’s also easier to upgrade or swap out individual components because there are fewer interactions within the system. In contrast, complex systems are more fragile and costly to maintain because there are so many components that need to be grokked by a limited team. Having more interdependent parts also makes troubleshooting harder.</p>
<blockquote>
<p>“The more simple any thing is, the less liable it is to be disordered, and the easier repaired when disordered.” — Thomas Paine, <a href="https://en.wikipedia.org/wiki/Common_Sense" target="_blank">Common Sense, 1776</a></p>
</blockquote>
<p><strong>Specific to machine learning, simple techniques don’t necessarily perform worse than more sophisticated ones.</strong> A non-exhaustive list of examples include:</p>
<ul>
<li><a href="https://arxiv.org/abs/2207.08815" target="_blank">Tree-based models &gt; deep neural networks</a> on 45 mid-sized tabular datasets</li>
<li><a href="https://arxiv.org/abs/2206.13211" target="_blank">Greedy algorithms &gt; graph neural networks</a> on combinatorial graph problems</li>
<li><a href="https://arxiv.org/abs/2201.04122" target="_blank">Simple averaging ≥ complex optimizers</a> on multi-task learning problems</li>
<li><a href="https://www.sciencedirect.com/science/article/abs/pii/S014829631500140X" target="_blank">Simple methods &gt; complex methods</a> in forecasting accuracy across 32 papers</li>
<li><a href="https://dl.acm.org/doi/10.1145/3383313.3412488" target="_blank">Dot product &gt; neural collaborative filtering</a> in item recommendation and retrieval</li>
</ul>
<p><img src="https://eugeneyan.com/assets/dot-product-vs-mlp.jpg" loading="lazy" title="The simple dot product outperforms deep learning methods for recommendations." alt="The simple dot product outperforms deep learning methods for recommendations."></p>
<p>The humble dot product outperforms deep learning methods for recommendations (<a href="https://dl.acm.org/doi/10.1145/3383313.3412488" target="_blank">source</a>)</p>
<h2 id="whats-wrong-with-rewarding-complexity">What’s wrong with rewarding complexity?</h2>
<p><strong>It incentivizes people to make things unnecessarily complicated.</strong> Using simple methods or building simple systems may appear easier and is thus valued less. As a result, people game the system to get more rewards and the simplest solution is no longer the most obvious one. Complexity begets more complexity, eventually making it impossible to work.</p>
<p><strong>It also encourages the “not invented here” mindset</strong> where people prefer to build from scratch and shun reusing existing components even though it saves time and effort. This wastes time and resources and often leads to poorer outcomes.</p>
<p>Unfortunately, most promotion processes overemphasize complexity in work artifacts.</p>
<div>
<blockquote><p lang="en" dir="ltr">Simple solutions are easier to implement and scale than complex solutions. However promotions often are rewarded to those who create complex solutions. We need to start acknowledging the power of simple. Don’t accept complex. It’s a trap.</p>— Bryan Liles (@bryanl) <a href="https://twitter.com/bryanl/status/1555619528096235525?ref_src=twsrc%5Etfw">August 5, 2022</a></blockquote> 
</div>
<p>Ditto for machine learning paper submissions.</p>
<div>
<blockquote><p lang="en" dir="ltr">A common point raised by ML reviewers is that a method is too simple or is made of existing parts. But simplicity is a strength, not a weakness. People are much more likely to adopt simple methods, and simple ones are also typically more interpretable and intuitive. 1/2</p>— Micah Goldblum (@micahgoldblum) <a href="https://twitter.com/micahgoldblum/status/1554485034744160258?ref_src=twsrc%5Etfw">August 2, 2022</a></blockquote>
</div>
<p>(If your idea didn’t get the credit it deserves, take comfort in the fact that <a href="https://twitter.com/rasbt/status/1548321060201803776" target="_blank">breakthroughs</a> such as Kalman Filters, PageRank, SVM, LSTM, Word2Vec, Dropout, etc got rejected too. We’re generally bad at assessing how useful or impactful an innovation will be. 🤷)</p>
<h2 id="how-should-we-think-about-complexity-instead">How should we think about complexity instead?</h2>
<p><strong>The objective should be to solve <em>complex</em> problems with as <em>simple</em> a solution as possible.</strong> Instead of focusing on the complexity of the <em>solution</em>, we should focus on the complexity of the <em>problem</em>. A simple solution demonstrates deep insight into the problem and the ability to avoid more convoluted and costly solutions. Often, the best solution is the simple one.</p>
<blockquote>
<p>“Everything should be made as simple as possible, but not simpler” — Albert Einstein</p>
</blockquote>
<p><strong>Instead of having a complex, catch-all solution, consider multiple focused solutions.</strong> A one-size-fits-all solution is usually less flexible and reusable than expected. And because it serves multiple use cases and stakeholders, it tends to be “tightly coupled” and require more coordination during planning and migrations. In contrast, it’s easier to operate—and unavoidably, deprecate—single-purpose systems.</p>
<div>
<blockquote><p lang="en" dir="ltr">In my many years as tech lead, later as consultant and then in <a href="https://twitter.com/godotengine?ref_src=twsrc%5Etfw">@godotengine</a>, I believe the biggest enemy software engineers fight is the deep &amp; common belief that one-size-fits-all solutions to problems (even hypothetical) always exist. Accepting they don't leads to better code. <a href="https://t.co/Tc14NGOexi">pic.twitter.com/Tc14NGOexi</a></p>— Juan Linietsky (@reduzio) <a href="https://twitter.com/reduzio/status/1543537649729896450?ref_src=twsrc%5Etfw">July 3, 2022</a></blockquote>
</div>
<h2 id="is-the-juice-worth-the-squeeze">Is the juice worth the squeeze?</h2>
<p>One way to overcome the complexity bias is <a href="https://en.wikipedia.org/wiki/Occam's_razor" target="_blank">Occam’s razor</a>. It states that the simplest solution or explanation is usually the right one. Thus, let’s not be too quick to dismiss simple ideas or add unnecessary complexity to justify their worth.</p>
<p>Alternatively, ask yourself: Given the cost of complexity, is the juice worth the squeeze?</p>

<p><strong>Thanks</strong> to Yang Xinyi and <a href="https://twitter.com/swyx" target="_blank">Swyx</a> for reading drafts of this.</p>

<p>If you found this useful, please cite this write-up as:</p>
<blockquote>
<p>Yan, Ziyou. (Aug 2022). Simplicity is An Advantage but Sadly Complexity Sells Better. eugeneyan.com.
https://eugeneyan.com/writing/simplicity/.</p>
</blockquote>
<p>or</p>
<div><pre><code>@article{yan2022simplicity,
  title   = {Simplicity is An Advantage but Sadly Complexity Sells Better},
  author  = {Yan, Ziyou},
  journal = {eugeneyan.com},
  year    = {2022},
  month   = {Aug},
  url     = {https://eugeneyan.com/writing/simplicity/}
}</code></pre>
</div>


<p><span>Share on: </span></p>
</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[ESP32-S3 has a few SIMD instructions (153 pts)]]></title>
            <link>https://bitbanksoftware.blogspot.com/2024/01/surprise-esp32-s3-has-few-simd.html</link>
            <guid>40266015</guid>
            <pubDate>Sun, 05 May 2024 16:21:33 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://bitbanksoftware.blogspot.com/2024/01/surprise-esp32-s3-has-few-simd.html">https://bitbanksoftware.blogspot.com/2024/01/surprise-esp32-s3-has-few-simd.html</a>, See on <a href="https://news.ycombinator.com/item?id=40266015">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="post-body-8755256533679090735">
<h2>Intro</h2><p>Espressif Systems released their ESP32-S3 SoC a few years ago, but only recently have they released more documentation and support of its full capabilities. Without any changes to your code, the S3 runs about 15% faster than older ESP32 CPUs at the same clock speed. It has a 'hidden' capability that's more difficult to use, but can be worth the effort if you need more speed. This article is aimed at programmers who are already familiar with <a href="https://en.wikipedia.org/wiki/Single_instruction,_multiple_data">SIMD</a> instructions on other platforms.</p><p>I've been optimizing code with SIMD for more than 15 years on Intel, Arm and DSPs (even Cadence's), so when I heard that the S3 had SIMD instructions, I immediately went searching for documentation. When the S3 became available to buy, there was only a promise of documentation and support. In the 2+ years since then, not much has changed. At the end of 2023, Espressif released a document describing the new instructions:</p><p><a href="https://www.espressif.com/sites/default/files/documentation/esp32-s3_technical_reference_manual_en.pdf">S3 Technical Reference Manual</a></p><p>The document has a decent level of detail and only a few errors, but what's missing still are examples and documentation on how to use them in your own code - conspicuously absent are instructions on using the assembler and linking them to your C/C++ code. This isn't entirely the fault of Espressif. The Xtensa processor comes from <a href="https://www.cadence.com/en_US/home/tools/ip/tensilica-ip/tensilica-xtensa-controllers-and-extensible-processors.html">Cadence</a> and for some reason they like to keep everything under NDA, even information which would help people use their processors. I find it hard to understand why the instruction set should be kept secret; a CPU vendor should make it as easy as possible for engineers to use their CPUs. The 'trade secrets' are in the hardware design, not in the instruction set. I've worked with Cadence's DSPs before, so I'm familiar with their way of doing things. Their Vision DSPs have a robust and powerful instruction set. Unfortunately, the S3 has a very minimal set of SIMD instructions,&nbsp; probably due to cost and silicon area limits.</p><p>Since the SIMD 'Processor Extension' is treated as a coprocessor, the main instruction set must be mixed in the code. Here's the document for the main LX7 instructions:</p><p><a href="https://dl.espressif.com/github_assets/espressif/xtensa-isa-doc/releases/download/latest/Xtensa.pdf">Xtensa ISA</a></p><p>The programmer model consists of 16 general purpose/address registers (a0-a15), 8 128-bit wide SIMD registers (q0-q7), and two special accumulator registers for multiply/accumulate operations. The memory bus is documented as 128-bits wide, so it is definitely advantageous to read and write to memory at the native width. There are also some instructions to manipulate GPIO bits.</p><h3>How I got started with S3 SIMD</h3><p>I spent the better part of a day searching and experimenting with these instructions until I got working code. I started with a search on Github for any public repos containing the one instruction needed for any S3 SIMD project - load (ee.vld.128). A few hits popped up in Espressif's esp-dsp project. A lot of their ESP32-S3 code is closed source, but a few functions pulled back the veil on how to use them in my own projects. This is the code I used as a starting point:</p><p>https://github.com/espressif/esp-dsp/blob/master/modules/fft/fixed/dsps_fft2r_sc16_aes3.S</p><p>I tried putting multiple functions into a single .S file, but that doesn't seem to work so every function gets it's own file. My first use case for these instructions is to optimize the color conversion step of my JPEG decoder. The YCbCr-&gt;RGB step takes a significant amount of time and is a good fit for SIMD optimization.</p><h3>The Instruction Set</h3><p>I've written SIMD code for the pixel color conversion multiple times in multiple SIMD instruction sets and what struck me with the S3 was how little I had to work with. One of the main sticking points is that even though the instruction encodings are 24-bits each, there's no bits reserved for shift amount. There are explicit shift instructions and even they don't have the shift amount encoded. The multiply instructions can shift right after multiply, but the shift amount must first be loaded into the SAR (shift amount register). This requires 2 additional instructions (and potentially additional pipeline cycles) to accomplish. The main sticking points which make it harder to get work done are that the instructions are not orthogonal across data sizes and are missing a lot of things needed to make efficient code. For example, the shift left and right instructions only operate on 32-bit values and only do arithmetic shifting (carry the sign bit), not logical. To generate RGB565 output, I need to shift 16-bit values. My workaround was to multiply by 1 and set the SAR for right shifting and multiply by a power of 2 and set the SAR to 0 for left shifting.</p><p>Here's a short list of what I consider essential SIMD features that are missing on the S3:</p><p>- Shift right logical<br>- Shift 8 or 16-bit values<br>- Add or multiply with widening<br>- Right shift with narrowing<br>- Add and subtract <b>without</b> saturation<br>- Unaligned reads and writes</p><p>Also missing (Nice to haves) that other Cadence DSPs have:</p><div><p>- Scatter / gather writes/reads<br>- Horizontal vector operations<br>- Rearrange vector element order<br>- Floating point support<br>- Predicated operations (operate on select elements only)</p><p>The gotcha that had me going in circles for a while is the memory alignment restriction. In my JPEG decoder internal data structure, some of the elements are aligned on 4-byte boundaries. S3 SIMD load and store instructions can at best access memory on 8-byte boundaries, but ideally want everything on 16-byte boundaries. I fixed this by inserting a "long double" in front of the items that need 16-byte alignment 😀.</p></div><h3>Where to go from here...</h3><p>I'm going to add some optimized functions to my various imaging libraries where appropriate and see where it takes me. I did an initial test with my <a href="https://github.com/bitbank2/JPEGDEC">JPEGDEC</a> library and saw a nearly 40% speedup (14ms -&gt; 10ms) by using the S3 SIMD instructions for the color conversion step. I'll publish this code after I've had time to fully flesh it out and test it. Good luck with your use of S3 SIMD...</p>
</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Small Things (139 pts)]]></title>
            <link>https://rishad.substack.com/p/small-things</link>
            <guid>40265552</guid>
            <pubDate>Sun, 05 May 2024 15:25:19 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://rishad.substack.com/p/small-things">https://rishad.substack.com/p/small-things</a>, See on <a href="https://news.ycombinator.com/item?id=40265552">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><article><div dir="auto"><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3c2af7e8-ae1a-4e7b-84c0-3f21a72d44d8_900x600.jpeg" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3c2af7e8-ae1a-4e7b-84c0-3f21a72d44d8_900x600.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3c2af7e8-ae1a-4e7b-84c0-3f21a72d44d8_900x600.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3c2af7e8-ae1a-4e7b-84c0-3f21a72d44d8_900x600.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3c2af7e8-ae1a-4e7b-84c0-3f21a72d44d8_900x600.jpeg 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3c2af7e8-ae1a-4e7b-84c0-3f21a72d44d8_900x600.jpeg" width="900" height="600" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/3c2af7e8-ae1a-4e7b-84c0-3f21a72d44d8_900x600.jpeg&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:600,&quot;width&quot;:900,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:678581,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/jpeg&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:false,&quot;topImage&quot;:true,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3c2af7e8-ae1a-4e7b-84c0-3f21a72d44d8_900x600.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3c2af7e8-ae1a-4e7b-84c0-3f21a72d44d8_900x600.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3c2af7e8-ae1a-4e7b-84c0-3f21a72d44d8_900x600.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3c2af7e8-ae1a-4e7b-84c0-3f21a72d44d8_900x600.jpeg 1456w" sizes="100vw" fetchpriority="high"></picture></div></a></figure></div><p>Every six months for over three decades I receive an updated insurance card from State Farm.</p><p>Over the years the quality of the card has deteriorated in every single way.</p><p>The card used to be plastic and then became a thick removable card and then it was something that had perforations on a larger size of paper that you had to tear and now it is as thin as it can get with scissor marks where you need to cut it.</p><p>The quality of the card plunges in inverse proportion to the increase in premiums (no accident or any reason to justify the increases in premium).</p><p>It is a small thing.</p><p>But it is the only time the brand and I interact (assuming that I remain lucky enough not to have to file a claim). Its their twice annual contact point. And every time I open their mail I see a cheaper card some confabulation of consultants, accountants and financial operators have optimized to reduce costs along with a standard completely non customized come on to buy more insurance along with the gift of a higher premium.</p><p>Maybe the masters of optimization may want to consider a little less media spend on Jake from State Farm commercials to help fund a better existing customer interaction in the twice annual touch points? </p><p>It is a small thing.</p><p>But small things matter.</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe5516f5c-4969-41ee-8347-9598dcebb033_568x600.jpeg" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe5516f5c-4969-41ee-8347-9598dcebb033_568x600.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe5516f5c-4969-41ee-8347-9598dcebb033_568x600.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe5516f5c-4969-41ee-8347-9598dcebb033_568x600.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe5516f5c-4969-41ee-8347-9598dcebb033_568x600.jpeg 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe5516f5c-4969-41ee-8347-9598dcebb033_568x600.jpeg" width="568" height="600" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/e5516f5c-4969-41ee-8347-9598dcebb033_568x600.jpeg&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:600,&quot;width&quot;:568,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:329116,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/jpeg&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe5516f5c-4969-41ee-8347-9598dcebb033_568x600.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe5516f5c-4969-41ee-8347-9598dcebb033_568x600.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe5516f5c-4969-41ee-8347-9598dcebb033_568x600.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe5516f5c-4969-41ee-8347-9598dcebb033_568x600.jpeg 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p>Recently I flew to Singapore. Outbound on Singapore airlines. Return on United.</p><p>I have no status on Singapore. Highest status on United.</p><p>Same aircraft and with no significant difference in interior.</p><p>Same catering service so the food was not really different.</p><p>Dramatically different experiences.</p><p>United was acceptable. Singapore was outstanding.</p><p>It was the small things.</p><p>On Singapore the stewards and stewards knew your name and looked at the passengers and smiled. The hot towels were hot. The utensils, napkin and the crockery may have been the same material but one just felt much more special. The contents of the vanity bag, the quality of the eye mask were all an edge above. </p><p>On one airline they asked how much cost can we remove and on another they think about how a few more dollars on a multiple thousand dollar ticket can make a difference so lets not be penny wise and pound foolish.</p><p>And smiles they are free.</p><p>Such small things made the difference.</p><p>Because small things matter. </p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Feb635820-27eb-403f-bb83-823665f0590e_459x600.jpeg" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Feb635820-27eb-403f-bb83-823665f0590e_459x600.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Feb635820-27eb-403f-bb83-823665f0590e_459x600.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Feb635820-27eb-403f-bb83-823665f0590e_459x600.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Feb635820-27eb-403f-bb83-823665f0590e_459x600.jpeg 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Feb635820-27eb-403f-bb83-823665f0590e_459x600.jpeg" width="459" height="600" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/eb635820-27eb-403f-bb83-823665f0590e_459x600.jpeg&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:600,&quot;width&quot;:459,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:219537,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/jpeg&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Feb635820-27eb-403f-bb83-823665f0590e_459x600.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Feb635820-27eb-403f-bb83-823665f0590e_459x600.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Feb635820-27eb-403f-bb83-823665f0590e_459x600.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Feb635820-27eb-403f-bb83-823665f0590e_459x600.jpeg 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p>Over the years many people have called me or reached out to me when in transition between jobs or when they are out of work or when they need a boost.</p><p>Almost every time I have responded and often met with or spoken to or written back to each of these people.</p><p>They no longer had power. They no longer had the big brand name. In some cases they  were a confused hot mess because they had got laid off, their company had tanked or something dramatic had changed the trajectory of their career.</p><p><span>Many were surprised (</span><em>especially when I had a big job in a big company</em><span> ) that I made it a priority to find time to get back.</span></p><p>Almost every one of them in time got back on their feet or found their way and often soared to amazing career and vocational success.</p><p>Now once again they were in demand and everyone called back.</p><p>But they were different because of what they had experienced.</p><p>They no longer equated themselves with their positions and their big company brand names and they now called people back who needed help even if they might not have before.</p><p>Because it is when few people are willing to speak to somebody is exactly when we need to speak to them and pay attention.</p><p>It is a small thing.</p><p>But people remember.</p><p>Forever. </p><p>Because small things matter. </p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F23ae84ed-8fa4-475a-b5d6-36e18ad771b4_471x600.jpeg" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F23ae84ed-8fa4-475a-b5d6-36e18ad771b4_471x600.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F23ae84ed-8fa4-475a-b5d6-36e18ad771b4_471x600.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F23ae84ed-8fa4-475a-b5d6-36e18ad771b4_471x600.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F23ae84ed-8fa4-475a-b5d6-36e18ad771b4_471x600.jpeg 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F23ae84ed-8fa4-475a-b5d6-36e18ad771b4_471x600.jpeg" width="471" height="600" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/23ae84ed-8fa4-475a-b5d6-36e18ad771b4_471x600.jpeg&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:600,&quot;width&quot;:471,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:257766,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/jpeg&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F23ae84ed-8fa4-475a-b5d6-36e18ad771b4_471x600.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F23ae84ed-8fa4-475a-b5d6-36e18ad771b4_471x600.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F23ae84ed-8fa4-475a-b5d6-36e18ad771b4_471x600.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F23ae84ed-8fa4-475a-b5d6-36e18ad771b4_471x600.jpeg 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p><strong>Small things and marketing.</strong></p><p>For decades marketers have found certain stages in a person’s life where they are more susceptible to messaging and marketing.</p><p>Whether it is the impending birth of a child to a physical re-location there are times where people are more open to change or to paying attention.</p><p>Marketers also recognize that there are moments of interaction where up-selling or cross-selling is likely to be more successful, such as when someone is opening an account or when one is about to pay for items in one’s real or digital shopping cart.</p><p>Basically, marketers look for moments of greatest attention and interest.</p><p>The challenge is that everybody knows these rituals and some combination of high costs and fees to show up at these moments or a certain weariness and understanding by people of what is happening, makes these less differentiable.</p><p><em>If instead of thinking only about where someone is on a customer/purchase journey we think about where we can surprise them positively the most, or turn a negative to a positive, we find compelling moments.</em></p><p>For instance, if we want to get people to speak well about our product or service instead of advertising to them or desperately try to get likes or influencer mentions, why not give them a sample of the product for free? Why not re-allocate a portion of the communication budget to enhance the quality of the product or service which will then speak for itself and get its satisfied users to speak about it. In today’s world brands are more likely to scale through people if they have a superior product or service rather than just telling people they have a superior product or service.</p><p>Imagine if you were a cable company or publisher and re-allocate the “stop them from unsubscribing” budget where you slash prices, increase channels in a bundle or enhance broadband speeds to people who are quitting, to instead reward the most loyal customers by going to them and cutting their fees and/or upgrading their services to simply say thank you.</p><p><em><strong>When someone least expects an act of generosity it has a tattoo like impact.</strong></em></p><p>It means they are special, and they are not being taken for granted.</p><p>It is just a special small thing.</p><p>So many marketers promise to “surprise and delight” customers but do we really?</p><p>One or two  small “surprise and delights” might be worth a year of messaging</p><p>Less is more. The rare is meaningful. The special resonates.</p><p>Traffic in scarcity to stand out in a world of abundance, sameness, and noise.</p><p><span>Think about the small things, the moments that you can tattoo so by asking  </span><em>“what can we do and where can we do something that will make someone come away different”?</em></p><p>It may be small things.</p><p>But small things matter…</p><p><em><strong><span>Visual Art by</span><a href="https://www.swinand.com/" rel=""> Susan Swinand.</a></strong></em></p><p data-attrs="{&quot;url&quot;:&quot;https://rishad.substack.com/p/small-things?utm_source=substack&amp;utm_medium=email&amp;utm_content=share&amp;action=share&quot;,&quot;text&quot;:&quot;Share&quot;,&quot;action&quot;:null,&quot;class&quot;:null}" data-component-name="ButtonCreateButton"><a href="https://rishad.substack.com/p/small-things?utm_source=substack&amp;utm_medium=email&amp;utm_content=share&amp;action=share" rel=""><span>Share</span></a></p><p><em><strong><a href="https://rishadtobaccowala.com/bio" rel="">Rishad Tobaccowala</a></strong></em><span> leverages forty years of global experience across dozens of industries to help leaders and companies thrive in transformative times.</span></p></div></article></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[First 'tooth regrowth medicine' to be tested in Japan from Sept. 2024 (221 pts)]]></title>
            <link>https://mainichi.jp/english/articles/20240503/p2a/00m/0sc/012000c</link>
            <guid>40264669</guid>
            <pubDate>Sun, 05 May 2024 13:16:00 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://mainichi.jp/english/articles/20240503/p2a/00m/0sc/012000c">https://mainichi.jp/english/articles/20240503/p2a/00m/0sc/012000c</a>, See on <a href="https://news.ycombinator.com/item?id=40264669">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
<!-- cxenseparse_start -->

<div>
<figure>
<div>
<a data-href="https://cdn.mainichi.jp/vol1/2024/05/03/20240503p2a00m0na009000p/9.jpg?1" data-lightbox="photos" data-title="Katsu Takahashi, head of the dentistry and oral surgery department at Kitano Hospital, second from left, and other members of the research team, hold a news conference at the hospital in Osaka's Kita Ward on May 2, 2024. (Mainichi/Yosuke Tsuyuki)">
<span>
<img src="https://cdn.mainichi.jp/vol1/2024/05/03/20240503p2a00m0na009000p/6.jpg?1" alt="">

</span>

</a>
</div>
<figcaption>Katsu Takahashi, head of the dentistry and oral surgery department at Kitano Hospital, second from left, and other members of the research team, hold a news conference at the hospital in Osaka's Kita Ward on May 2, 2024. (Mainichi/Yosuke Tsuyuki)</figcaption>
</figure>
</div>
<p>
    OSAKA -- Clinical trials of the world's first "tooth regrowth medicine" are set to commence in September at Kyoto University Hospital, researchers announced here on May 2.
</p>
<!-- cxenseparse_end -->

<!-- cxenseparse_start -->
<p>
    Once the medicine's safety is confirmed, it will be given to patients congenitally lacking a full set of teeth to confirm its effectiveness. The researchers hope to commence sale of the medicine in 2030.
</p>
<p>
    Congenital tooth deficiency is believed to affect about 1% of the population. The absence of six or more teeth, a condition known as oligodontia, is believed to be hereditary, and is said to affect about 0.1% of the population.
</p>

<div>
<figure>
<div>
<a data-href="https://cdn.mainichi.jp/vol1/2024/05/03/20240503p2a00m0na010000p/7.jpg?1" data-lightbox="photos" data-title="A tooth that grew in a mouse with a congenital tooth deficiency, is seen growing after it was given the medicine, in this photo provided by Kitano Hospital.">
<span>
<img src="https://cdn.mainichi.jp/vol1/2024/05/03/20240503p2a00m0na010000p/6.jpg?1" alt="">

</span>

</a>
</div>
<figcaption>A tooth that grew in a mouse with a congenital tooth deficiency, is seen growing after it was given the medicine, in this photo provided by Kitano Hospital.</figcaption>
</figure>
</div>
<p>
    According to Kitano Hospital in Osaka's Kita Ward, which is involved in the study, the first phase of the clinical trials will run from September this year to August 2025. The medicine will be administered intravenously to healthy individuals to confirm its effectiveness, with 30 males between the ages of 30 and 64 taking part. The subjects must be missing at least one back tooth so that there will be no problem if the medicine takes effect and a tooth begins to grow. No major side effects have been confirmed in animal studies to date.
</p>
<p>
    In the next stage, the medication will be administered at Kitano Hospital to patients with congenital tooth deficiency. Researchers plan to limit the subjects during this phase to those between the ages of 2 to 7 who have at least four teeth missing from birth.
</p>
<p>
    The tooth regrowth medicine deactivates a protein called USAG-1, which inhibits the growth of teeth. The team believes that in the future it may be possible to grow teeth not only in people with congenital conditions, but also in those who have lost teeth due to cavities or injuries.
</p>

<div>
<figure>
<div>
<a data-href="https://cdn.mainichi.jp/vol1/2024/05/03/20240503p2a00m0na011000p/6.jpg?1" data-lightbox="photos" data-title="This photo provided by Kitano Hospital shows the front teeth of a ferret that was given the medicine. It had six teeth at first, but a seventh one, pictured at center, grew in.">
<span>
<img src="https://cdn.mainichi.jp/vol1/2024/05/03/20240503p2a00m0na011000p/6.jpg?1" alt="">

</span>

</a>
</div>
<figcaption>This photo provided by Kitano Hospital shows the front teeth of a ferret that was given the medicine. It had six teeth at first, but a seventh one, pictured at center, grew in.</figcaption>
</figure>
</div>
<p>
    Lead researcher Katsu Takahashi, head of the dentistry and oral surgery department at Kitano Hospital, commented, "We want to do something to help those who are suffering from tooth loss or absence. While there has been no treatment to date providing a permanent cure, we feel that people's expectations for tooth growth are high."
</p>
<p>
    (Japanese original by Yosuke Tsuyuki, Osaka Science &amp; Environment News Department)
</p>
<!-- cxenseparse_end -->

<!--| tools BGN |-->

<!--| tools END |-->
</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Machine unlearning: ML model minus the information to be unlearned (253 pts)]]></title>
            <link>https://ai.stanford.edu/~kzliu/blog/unlearning</link>
            <guid>40264352</guid>
            <pubDate>Sun, 05 May 2024 12:30:44 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://ai.stanford.edu/~kzliu/blog/unlearning">https://ai.stanford.edu/~kzliu/blog/unlearning</a>, See on <a href="https://news.ycombinator.com/item?id=40264352">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
      
        <header>
          
          
            <p> 


  
	  41 minute read
	
</p>
          
        
        
        
        
             
        
    
        </header>
      

      <section itemprop="text">
        <meta name="twitter:site" content="@kenziyuliu">

<meta name="twitter:card" content="summary">

<meta name="twitter:title" content="Machine Unlearning in 2024">

<meta name="twitter:description" content="As our ML models today become larger and their (pre-)training sets grow to inscrutable sizes, people are increasingly interested in the concept of machine unlearning to edit away undesired things like private data, stale knowledge, copyrighted materials, toxic/unsafe content, dangerous capabilities, and misinformation, without retraining models from scratch.">



<p>Written by <a href="https://ai.stanford.edu/~kzliu">Ken Liu</a> ∙ May 2024</p>





<hr>

<p>As our ML models today become larger and their (pre-)training sets grow to inscrutable sizes, <a href="https://unlearning-challenge.github.io/">people</a> <a href="https://www.axios.com/newsletters/axios-ai-plus-117900d2-3a2c-4741-b807-bb8f2f9bb035.html?chunk=0&amp;utm_term=twsocialshare#story0">are</a> <a href="https://www.safe.ai/blog/wmdp-benchmark">increasingly</a> <a href="https://hbswk.hbs.edu/item/qa-seth-neel-on-machine-unlearning-and-the-right-to-be-forgotten">interested</a> in the concept of <strong>machine unlearning</strong> to edit away undesired things like private data, stale knowledge, copyrighted materials, toxic/unsafe content, dangerous capabilities, and misinformation, without retraining models from scratch.</p>

<p>Machine unlearning can be broadly described as removing the influences of training data from a trained model. At its core, unlearning on a <em>target model</em> seeks to produce an <em>unlearned model</em> that is equivalent to—or at least “behaves like”—a <em>retrained model</em> that is trained on the same data of target model, minus the information to be unlearned.</p>

<p>There’s a lot hidden in the above description. How do we describe the information to be unlearned? Do we always have ground-truth retrained models? If not, how do we actually evaluate the unlearning? Can we even verify and audit unlearning? Is <em>pretending</em> to unlearn, as humans often do, sufficient? Is unlearning even the right solution? If so, for what problems?</p>

<p>The precise definitions of unlearning, the techniques, the guarantees, and the metrics/evaluations would depend on:</p>
<ol>
  <li>The ML task (e.g., binary classification or language modeling);</li>
  <li>The data to unlearn (e.g., a set of images, news articles, or the knowledge of making <a href="https://youtu.be/zjkBMFhNj_g?t=2774">napalm</a>);</li>
  <li>The unlearning algorithm (e.g., heuristic fine-tuning vs deleting model components);</li>
  <li>The goal of unlearning (e.g., for user privacy or harmfulness removal).</li>
</ol>

<p>In this educational post, I hope to give a gentle, general ML audience introduction to machine unlearning and touch on things like <a href="https://arxiv.org/abs/2303.15715">copyright protection</a>, <a href="https://www.nytimes.com/2023/12/27/business/media/new-york-times-open-ai-microsoft-lawsuit.html">New York Times v. OpenAI</a>, <a href="https://gdpr.eu/right-to-be-forgotten/">right-to-be-forgotten</a>, <a href="https://unlearning-challenge.github.io/">NeurIPS machine unlearning challenge</a>, <a href="https://arxiv.org/abs/2005.11401">retrieval-based AI systems</a>, <a href="https://www.mlsafety.org/">AI safety</a>, along with some of my thoughts on the field. While unlearning is broad topic applicable to most ML models, we will focus a lot on <a href="https://en.wikipedia.org/wiki/Foundation_model">foundation models</a>.</p>

<!-- Another alternative of access revocation is **retrival-based AI systems** (e.g. [RAG](https://arxiv.org/abs/2005.11401)), where sensitive data are nevered trained but [retrieved and used in-context](https://arxiv.org/abs/2308.04430). Unlearning becomes trivial, but it is unclear whether if we could move everything sensitive out of training data and/or have retrieval match trained performance. -->

<!-- ![image alt](https://i.imgflip.com/8fw81c.jpg) -->
<!-- <img src="https://i.imgflip.com/8fw81c.jpg" width="60%"> -->

<h2 id="1-a-bit-of-history--motivations-for-unlearning">1. A bit of history &amp; motivations for unlearning</h2>

<p>People have thought about the unlearning problem <a href="https://www.ieee-security.org/TC/SP2015/papers-archived/6949a463.pdf">for</a> <a href="https://proceedings.neurips.cc/paper/2019/hash/cb79f8fa58b91d3af6c9c991f63962d3-Abstract.html">a while</a> <a href="https://arxiv.org/abs/1912.03817">now</a>. The initial research explorations were primarily driven by <a href="https://gdpr.eu/article-17-right-to-be-forgotten/">Article 17</a> of GDPR (European Union’s privacy regulation), often referred to as “<a href="https://gdpr.eu/right-to-be-forgotten/">right-to-be-forgotten</a>” (<strong>RTBF</strong>) since 2014. RTBF basically says a user has the right to request deletion of their data from a service provider (e.g. deleting your Gmail account).</p>

<p>RTBF was well-intentioned. It was also very actionable when said service providers store user data in a structured way, like how Google <a href="https://www.cnbc.com/2014/10/13/google-removes-170000-right-to-be-forgotten-links.html">removed</a>  a bunch of links from its index in repsonse to RTBF requests.</p>

<p>However, RTBF wasn’t really proposed with machine learning in mind. In 2014, policymakers wouldn’t have predicted that deep learning will be a giant hodgepodge of data &amp; compute, and that separating and interpreting this hodgepodge turned out to be hard. The hardness of erasing data from ML models has subsequently motivated research on what is later referred to as “<a href="https://proceedings.neurips.cc/paper_files/paper/2019/file/cb79f8fa58b91d3af6c9c991f63962d3-Paper.pdf">data deletion</a>” and “<a href="https://www.ieee-security.org/TC/SP2015/papers-archived/6949a463.pdf">machine</a> <a href="https://arxiv.org/pdf/1912.03817.pdf">unlearning</a>”.</p>

<p><strong>A decade later in 2024, user privacy is no longer the only motivation for unlearning.</strong> We’ve gone from training small convolutional nets on face images to training giant language models on pay-walled, <a href="https://www.theverge.com/23961021/ai-art-copyright-training-ownership-fair-use">copyrighted</a>, <a href="https://support.google.com/youtube/answer/6000976?hl=en">toxic</a>, dangerous, and otherwise harmful content, all of which we may want to “erase” from the ML models—sometimes with access to only a handful of examples. The nature of the models has changed too. Instead of using many small specialized models each good at one task, people started using a single <a href="https://platform.openai.com/docs/models/gpt-4-turbo-and-gpt-4">giant model</a> that knows just about any task.</p>

<!-- A consequence is that knowledge in the model becomes interwoven and learning becomes less directly [measurable](https://arxiv.org/abs/2206.07682), both of which intuitively complicate unlearning.  -->

<p>Currently, I think the motivations for unlearning fall into two categories:</p>

<ol>
  <li>
    <p><strong>Access revocation</strong> (think unlearning private and copyrighted data). In an ideal world, data should be thought of as “borrowed” (possibly unpermittedly) and thus can be “returned”, and unlearning should enable such revocation.</p>

    <p>Unlearning is challenging from this perspective. One key difficulty is that our limited understanding of deep learning itself makes data trained into a model akin to “consumables” (which can’t just be “returned” after consumption). Data may also be non-fungible (e.g. your chat history) and may even be thought of as <a href="https://www.radicalxchange.org/media/papers/data-freedom-act.pdf">labor</a> with its own financial and control interests. Another challenge is that access revocation may require a <em>proof</em> of unlearning; as we will explore in the coming sections, this isn’t always possible.</p>

    <p>These difficulties suggest that it’s perhaps also worth revising laws like RTBF and thinking about alternatives such as <em>data markets</em>, where data owners are properly compensated so they won’t want to request unlearning in the first place. To illustrate, suppose Bob ate Alice’s cheesecake (data), Alice would much rather Bob pay her or return something equivalent (compensation) than Bob puking to his pre-eating state (unlearning).</p>

    <p>In practice, one way to implement access revocation is via some form of <em>periodic re-training</em> of the base model. Many model providers already do this to keep their models competitive and up-to-date. For example, OpenAI can collect a bunch of unlearning requests, and batch-satisfy them during the re-training every year (or, guided by RTBF’s “<a href="https://gdpr.eu/right-to-be-forgotten/">undue delay</a>” period by which the request must be satisfied). More broadly, this suggests <em>socio-technical solutions</em> for unlearning: policymakers can mandate such periodic re-training and set economically viable deadlines to offload the costs to the model owners.</p>
  </li>
  <li>
    <p><strong>Model correction &amp; editing</strong> (think toxicity, bias, stale/dangerous knowledge removal). That is, the model was trained on something undesirable and we’d like to fix it. This is closely related to the <a href="https://arxiv.org/abs/2110.11309">model editing</a> literature. The concept of “<a href="https://arxiv.org/abs/2402.14015">corrective machine unlearning</a>”, where unlearning serves to correct the impact of bad data, was recently proposed to capture this motivation. From this perspective, unlearning may also be viewed as a post-training risk mitigation mechanism for AI safety concerns (discussed further in Section 4).</p>

    <p>Unlike access revocation, we could be more lenient towards with model correction since the edit is more of a desire than a necessity mandated by law, much like model accuracy on image classification or toxicity of generated text. (Of course, these can cause real harm too.) Here, we won’t necessarily need <em>formal guarantees</em> for the unlearning to be practically useful; we have plenty of examples where people would happily deploy models that are deemed “sufficiently safe”. The recent <a href="https://www.wmdp.ai/">WMDP benchmark</a>, which quizzes a model on hazardous knowledge, is a good example of empirically evaluating unlearning efficacy.</p>
  </li>
</ol>

<h2 id="2-forms-of-unlearning">2. Forms of unlearning</h2>

<p>Unlearning is trivially satisfied if we can just retrain the model without the undesired data. However, we want something better because (1) retraining can be expensive and (2) it can be a lot of work <em>just to find out</em> what to remove from training data—think finding all Harry Potter references in a trillion tokens. Unlearning techniques essentially seek to mitigate or avoid this retraining cost while producing identical or similar results.</p>

<p>The unlearning literature can roughly be categorized into the following:</p>
<ol>
  <li>Exact unlearning</li>
  <li>“Unlearning” via differential privacy</li>
  <li>Empirical unlearning, where data to be unlearned are precisely known (training examples)</li>
  <li>Empirical unlearning, where data to be unlearned are underspecified (think “knowledge”)</li>
  <li>Just <em>ask</em> for unlearning?</li>
</ol>

<p>Forms 2-4 are sometimes known as “<strong>approximate unlearning</strong>” in that the unlearned model approximates the behavior of the retrained model. Form 5 is quite new and interesting, and more specific to instruction-following models.</p>

<figure>
  <img src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEiRnut8P03hlk5tKJPEEsqUl1DSlqN2ScdJeiaRfC3mWbQ_PBBwf7wBU9xgxuzr1GoqgkB6MwCa6Zrdo6LQxSOIPXIUrl1Yug73k2Q2zFI61VDAi9K21JOPox0Hc1CIh6ShKxW9Tgy45TYV3p3r5IiI7yxzzzOpzvbJ-5o3QVtjZn6vhDZLntnCcUSi1mb_/s720/image1.png" width="200">
  <figcaption>Figure 1. Illustration of approximate unlearning. Source: <a href="https://unlearning-challenge.github.io/">NeurIPS Machine Unlearning Challenge</a>.</figcaption>
</figure>

<p>In the following, we will go through what each of these types roughly looks like, along with what I think are the promises, caveats, and questions to ask looking forward.</p>

<h3 id="21-exact-unlearning">2.1. Exact unlearning</h3>

<p>Exact unlearning roughly asks that the unlearned model and the retrained model to be <em>distributionally identical</em>; that is, they can be exactly the same under fixed randomness.</p>

<p>Techniques for exact unlearning are characterized by the early work of <a href="https://www.ieee-security.org/TC/SP2015/papers-archived/6949a463.pdf">Cao &amp; Yang</a> and <a href="https://arxiv.org/abs/1912.03817">SISA</a>. In SISA, a very simple scheme, the training set is split into $N$ non-overlapping subsets, and a separate model is trained for each subset. Unlearning involves retraining the model corresponding to and without the data points to be unlearned. This reduces cost from vanilla retraining by $1/N$ (cheaper if we keep model checkpoints). Inference then involves model ensembling.<sup id="fnref:sisa-exact" role="doc-noteref"><a href="#fn:sisa-exact" rel="footnote">1</a></sup></p>

<figure>
  <img width="200" src="https://pic4.zhimg.com/80/v2-6dd3c114ff1c984254f4d2889477827f_1440w.webp">
  <figcaption>Figure 2. Illustration of SISA: just train models on data shards (<a href="https://arxiv.org/pdf/1912.03817">image source</a>).</figcaption>
</figure>

<!-- ![SISA illustration](https://pic4.zhimg.com/80/v2-6dd3c114ff1c984254f4d2889477827f_1440w.webp)
Illustration of SISA: just train models on data shards. -->

<p>More generally, the essence of exact unlearning of this form is that we want <em>modular components</em> in the learning algorithm to correspond to different (potentially disjoint) sets of the training examples.</p>

<p>There are several benefits of exact unlearning:</p>

<ol>
  <li><strong>The algorithm <em>is</em> the proof</strong>. If we implement something like SISA, we know by design that the unlearned data never contributed to other components. As it turns out, formally proving the model has unlearned something is quite <a href="https://arxiv.org/abs/2110.11891">challenging</a> otherwise.</li>
  <li><strong>It turns the unlearning problem into an accuracy/efficiency problem.</strong> This makes exact unlearning more approachable due to the messiness of unlearning evaluation and lack of benchmarks.</li>
  <li><strong>Interpretability by design</strong>. By providing a structure to learning, we also have better understanding of how certain data points contribute to performance.</li>
</ol>

<p>The main drawback seems obvious: modern <a href="https://en.wikipedia.org/wiki/Neural_scaling_law">scaling law</a> of large models argues against excessive data &amp; model sharding as done in SISA. <em>Or does it?</em> I think it would be very interesting to revisit sharding in the context of large models, in light of the recent <a href="https://arxiv.org/abs/2208.03306">model</a> <a href="https://arxiv.org/abs/2203.05482">merging</a> <a href="https://huggingface.co/blog/mlabonne/merge-models">literature</a> that suggests the feasibility of weight-space merging between large models. As we’ll learn in the coming sections, the messiness of approximate unlearning and its evaluation, especially in the context of large models, makes exact unlearning very appealing.</p>

<!-- An alternative to exact unlearning, discussed earlier, is for model servers to collect unlearning requests and periodically retrain their models to satisfy them all at once. This could be more pragmatic than one might think.  -->

<h3 id="22-unlearning-via-differential-privacy">2.2. “Unlearning” via differential privacy</h3>

<p>This line of work roughly says: if the model behaves more or less the same with or without any particular data point, then there’s nothing we need to unlearn from that data point. More broadly, we are asking for <em>distributional closeness</em> between the unlearned and the retrained models.</p>

<p>For readers unfamilar with differential privacy (DP) in machine learning, DP defines a <em>quantifiable</em> indistinguishability guarantee between two models $M$, $M’$ trained on datasets $X$, $X’$ that differ in any single training example. The canonical procedure, <a href="https://arxiv.org/abs/1607.00133">DP-SGD</a>, works by clipping the L2-norm of the per-example gradients and injecting some per-coordinate Gaussian noise to the gradients. The idea is that the noise would mask or obscure the contribution of any single gradient (example), such that the final model isn’t sensitive any exmaple. It is usually denoted by ($\varepsilon, \delta$)-DP; the stronger the noise, the smaller the scalars ($\varepsilon, \delta$), the more private.</p>

<p>The intuition is that if an adversary cannot (reliably) tell apart the models, then it is as if this data point has never been learned—thus no need to unlearn. DP can be used to achieve this form of unlearning, but due to the one-sidedness of unlearning (where we only care about data removal, not addition), DP is a <a href="https://arxiv.org/abs/2103.03279">strictly stronger definition</a>. This notion of unlearning is sometimes known as “<strong>($\alpha, \beta$)-unlearning</strong>” where ($\alpha, \beta$) serve similar roles as ($\varepsilon, \delta$) to measure distributional closeness.</p>

<p>Example techniques along this direction include: <a href="http://proceedings.mlr.press/v132/neel21a.html">(1)</a> storing checkpoints of (DP) convex models and unlearning is retraining from those checkpoints; and <a href="https://proceedings.neurips.cc/paper/2021/hash/87f7ee4fdb57bdfd52179947211b7ebb-Abstract.html">(2)</a> on top of the previous technique, add SISA for <em>adaptive</em> unlearning requests (i.e. those that come in after observing the published model).</p>

<p>DP-based unlearning is good in that it gives some form of a statistical guarantee. <strong>However, there are some important considerations that limit its applicability to large models</strong>:</p>
<ol>
  <li>Many such unlearning results apply only to <a href="http://proceedings.mlr.press/v132/neel21a.html">convex</a> <a href="https://arxiv.org/abs/1911.03030">models</a> or <a href="https://proceedings.neurips.cc/paper/2021/hash/87f7ee4fdb57bdfd52179947211b7ebb-Abstract.html">losses</a>.</li>
  <li>What levels of unlearning (values of $(\varepsilon, \delta)$-DP or $(\alpha, \beta)$-unlearning) are sufficient? <em>Who decides?</em></li>
  <li>For large models, current ML systems don’t fit well with the <em>per-example</em> workloads of DP-like procedures. The memory overhead will also be prohibitive.</li>
  <li>Moreoever, like DP, the guarantees can fall off quickly with more unlearning requests (at best the <a href="https://proceedings.neurips.cc/paper/2021/hash/87f7ee4fdb57bdfd52179947211b7ebb-Abstract.html">rate</a> of $O(\sqrt k)$ with $k$ requests following DP composition theorems).</li>
  <li>DP-like definitions implicitly assume we care about all data points <em>equally</em>. But some examples are more likely to receive unlearning request, and some examples would not have <a href="https://arxiv.org/abs/1906.01827">contributed</a> to the learning at all.</li>
  <li>DP-like procedures may also just hurt model accuracy a lot, sometimes in an <a href="https://arxiv.org/abs/1905.12101">unfair</a> way.</li>
</ol>

<p>For large models in particular, it’s also worth distinguishing the cases of <strong>unlearning pre-training data</strong> vs <strong>unlearning fine-tuning data</strong>. The latter is a lot more tractable; for example, we could indeed <a href="https://arxiv.org/abs/2110.05679">fine-tune</a> large models with differential privacy but not so much with pre-training.</p>

<h3 id="221-forging-and-its-implications-on-dp-like-unlearning-definitions">2.2.1. <em>Forging</em> and its implications on DP-like unlearning definitions</h3>

<p>An unlearning procedure may sometimes require an external <em>audit</em>, meaning that we’d like to prove that the unlearning procedure has actually happened.</p>

<p>The main idea of “<a href="https://arxiv.org/abs/2110.11891">forging</a>” is that there exists two distinct datasets that, when trained on, would produce <em>the same gradients and (thus) the same models</em>. This is true intuitively:</p>
<ol>
  <li>Think linear regression of points on a perfect line; removing any 1 point doesn’t change the fitted line;</li>
  <li>Think mini-batch GD, where replacing one example gradient with the sum of several “fake” gradients would give the same batch gradient.</li>
</ol>

<p><strong>Forging implies that DP-based approximate unlearning may not be auditable</strong>—that is, the unlearning service provider cannot formally prove that the forget set is really forgotten. In fact, if we only look at the model weights, even exact unlearning may not be auditable.</p>

<p>While one can brush this off as a theoretical result, it does mean that policymakers should think carefully about how a future version of “right-to-be-forgotten” (if any) should look like and whether similar policies are legally and technically enforceable.</p>

<p>Indeed, what qualifies as an “audit” could very well be definition and application dependent. If the auditor only cares that the unlearned model performs poorly on a specified set of inputs (say on a set of face images), then even empirical unlearning is “auditable” (see next section).</p>

<h3 id="23-empirical-unlearning-with-known-example-space-example-unlearning">2.3. Empirical unlearning with known example space (“example unlearning”)</h3>

<p>This line of work is essentially “training to unlearn” or “unlearning via fine-tuning”: just take a few more heuristically chosen gradient steps to shape the original model’s behavior into <em>what we think</em> the retrained model would do (while also optionally resetting some parameters in the model). It may also be referred to as “example unlearning”, since the training, retain, and forget sets are often clearly defined.</p>

<p>The <a href="https://unlearning-challenge.github.io/"><strong>NeurIPS 2023 Machine Unlearning Challenge</strong></a> collected many methods along this direction. The challenge roughly runs as follows:</p>
<ul>
  <li>You are given a face image dataset with designated retain/forget example splits for the training set, a target model trained on everything, and a secret model trained only on the retain set.</li>
  <li>You are asked to design an unlearning algorithm that produces unlearned model(s) from the target model that “match” the secretly kept model.</li>
  <li>The “match” or evaluation metric uses a DP-like output-space similarity over 512 seeds: for each forget example, compute an “empirical $\varepsilon$” over 512 unlearned models based on true/false positive rates of an adversary (also provided by the organizer), and aggregate across examples.</li>
  <li>All models are a small ConvNet.</li>
</ul>

<p>To give an intuition about how well empirical unlearning is doing without fully explaining the metric: the ground-truth retrained model gets about ~0.19, the winning submission gets to ~0.12, and the baseline (simple gradient ascent on forget set) is ~0.06.<sup id="fnref:challenge-metric" role="doc-noteref"><a href="#fn:challenge-metric" rel="footnote">2</a></sup></p>

<p>So what do the winning ideas look like? Something along the lines of the following:</p>
<ol>
  <li>Gradient ascent on the forget set;</li>
  <li>Gradient descent on the retain set (and hope that catastrophic forgetting takes care of unlearning);</li>
  <li>Gradient descent on the forget set, but with uniformly random labels (to “confuse” the model);</li>
  <li>Minimize KL divergence on outputs between unlearned model and original model on the retain set (to regularize unlearned model performance on unrelated data);</li>
  <li>Re-initialize weights that had similar gradients on the retain set and forget sets, and finetune these weights on the retain set;</li>
  <li>Prune 99% of weights by L1-norm and fine-tune on the retain set;</li>
  <li>Reset first/last $k$ layers and fine-tune on the retain set; and</li>
  <li>Heuristic/arbitrary combinations of the above.</li>
</ol>

<p>Indeed, despite the heuristic nature of these approaches, these are what <a href="https://arxiv.org/abs/2302.09880">most</a> <a href="https://arxiv.org/abs/2210.01504">empirical</a> <a href="https://arxiv.org/abs/2305.06535">unlearning</a> <a href="https://arxiv.org/abs/2201.06640">algorithms</a>, especially those <a href="https://arxiv.org/abs/2310.10683">on</a> <a href="https://arxiv.org/abs/2310.20150">large</a> <a href="https://www.microsoft.com/en-us/research/project/physics-of-agi/articles/whos-harry-potter-making-llms-forget-2/">(language)</a> <a href="https://arxiv.org/abs/2403.03218">models</a>, are doing these days.</p>

<p>People explore empirical approaches because theoretical tools are usually impractical; for example, enforcing DP simply hurts accuracy and efficiency too much, even for the GPU rich. On the flip side, empirical methods are often fast and easy to implement, and their effects are often qualitatively visible.</p>

<p>Another key motivation for empirical unlearning is that <em>counterfactuals</em> are unclear, especially on LLMs. In deep learning, we often don’t know how the retrained model would behave on unseen data. What should the LLM think who Biden is, if not a politician? Should image classifiers give uniformly random predictions for unlearned images? Do they generalize? Or are they confidently wrong? Any of these is possible and it can be up to the practitioner to decide. It also means that <em>behaviors that are equally plausible can lead to wildly different measurements</em> (e.g., KL divergence between output distributions of unlearned &amp; retrained model), complicating theoretical guarantees.</p>

<h3 id="24-empirical-unlearning-with-unknown-example-space-conceptknowledge-unlearning">2.4. Empirical unlearning with unknown example space (“concept/knowledge unlearning”)</h3>

<p>What if the train, retain, or forget sets are poorly specified or just not specified at all? Foundation models that train on internet-scale data may get requests to unlearn a “<a href="https://openaccess.thecvf.com/content/ICCV2023/papers/Gandikota_Erasing_Concepts_from_Diffusion_Models_ICCV_2023_paper.pdf">concept</a>”, a “<a href="https://proceedings.neurips.cc/paper_files/paper/2022/file/6f1d43d5a82a37e89b0665b33bf3a182-Paper-Conference.pdf">fact</a>”, or a piece of “<a href="https://arxiv.org/abs/2305.14795">knowledge</a>”, all of which we cannot easily associate a set of examples. The terms “<strong>model editing</strong>”, “<strong>concept editing</strong>”, “<strong>model surgery</strong>”, and “<strong>knowledge unlearning</strong>” are closely related to this notion of unlearning.<sup id="fnref:continue-learning" role="doc-noteref"><a href="#fn:continue-learning" rel="footnote">3</a></sup></p>

<p>The underspecification of the unlearning requests means that we now have to deal with the notions of “<strong>unlearning scope</strong>” (or “<a href="https://arxiv.org/abs/2206.06520">editing scope</a>”) and “<a href="https://en.wikipedia.org/wiki/Textual_entailment"><strong>entailment</strong></a>”. That is, unlearning requests may provide <a href="https://arxiv.org/abs/2402.06155">canonical examples</a> to indicate what to unlearn, but the same information can manifest in the (pre-)training set in many different forms with many different downstream implications such that simply achieving unlearning on these examples—even <em>exactly</em>—would not suffice.</p>

<p>For example:</p>
<ul>
  <li>The association “Biden is the US president” is dispersed throughout various forms of text from news articles, books, casual text messages, or this very blog post. Can we ever unlearn all occurrences? Moreover, does unlearning Joe Biden also entail unlearning the color of <a href="https://en.wikipedia.org/wiki/Willow_(cat)">Biden’s cat</a>?</li>
  <li>Artists may request to unlearn art style by providing art samples, but they won’t be able to collect everything they have on the internet and their <a href="https://www.businessinsider.com/ai-image-generators-artists-copying-style-thousands-images-2022-10">adaptations</a>.</li>
  <li>New York Times may request to unlearn news articles, but they cannot enumerate quotes and secondary transformations of these articles.</li>
</ul>

<p>Such vagueness also suggests that <strong>unlearning pre-training data from large models are perhaps necessarily empirical:</strong> it is unlikely to derive formal guarantees if we can’t clearly specify what to (and what not to) unlearn in the trillions of tokens and establish clear information boundaries between different entities. An interesting implication of achieving unlearning empirically is that the unlearning <em>itself</em> can be <a href="https://arxiv.org/abs/2401.01814">unlearned</a>.</p>

<p>What does existing work do, then, with underspecified unlearning requests? Most techniques are more or less the same as <a href="#33-Empirical-unlearning-or-unlearning-via-fine-tuning">before</a>, except now we also need to find the examples to fine-tune on. For example, attempting to unlearn <a href="https://arxiv.org/abs/2310.02238">Harry Potter</a> involves asking GPT-4 to come up with plausible alternative text completions (e.g. that Mr. Potter studies baking instead of magic); and attempting to unlearn <a href="https://arxiv.org/abs/2310.10683">harmful behavior</a> involves collecting examples of hatespeech.</p>

<p>Another set of techniques involves training the desired behavior (or its opposite) into <a href="https://arxiv.org/abs/2212.04089">task</a>/<a href="https://arxiv.org/abs/2403.03218">control</a> <a href="https://arxiv.org/abs/2306.14870">vectors</a> and harnessing the capability of large models to undergo <a href="https://huggingface.co/docs/peft/en/developer_guides/model_merging">weight-space merging</a> or <a href="https://arxiv.org/abs/2310.01405">activation steering</a>.  The fundamental approach of the above is more or less the same, nevertheless—obtaining these edit vectors involves (heuristically) designing what gradients to take and what data on which to take them. One could also frame the unlearning problem as an <em>alignment</em> problem and applies the forget examples with a <a href="https://arxiv.org/abs/2404.05868">DPO-like objective</a>.</p>

<h3 id="25-just-ask-for-unlearning">2.5. Just <em>ask</em> for unlearning?</h3>

<p>It turns out that powerful, instruction-following LLMs like GPT-4 are smart enough to <em>pretend to unlearn</em>. This means crafting prompts to induce a (sufficiently) safe behavior for the target unlearning application.</p>

<p>This is an interesting approach because no gradients are involved whatsoever (big plus from a systems perspective), and intuitively the end results could very well be <a href="https://arxiv.org/abs/2403.03329">as good as</a> existing empirical unlearning techniques. Among different ways we could prompt, past work explored the following two directions.</p>

<p><strong><a href="https://arxiv.org/abs/2403.03329">Literally asking</a> to pretend unlearning.</strong> We can ask in the system prompt to, say, pretend to not know who Harry Potter is. By design, this works best for common entities, facts, knowledge, or behaviors (e.g. the ability to utter like Trump) that are well-captured in the pre-training set, since the LLM needs to <em>know it well to pretend not knowing it well</em>. On the other hand, suppose now we’d like to unlearn the address of an obscure person; the pre-training set is so large that we suspect it’s part of training data. We now face a variant of the <a href="https://en.wikipedia.org/wiki/Streisand_effect">Streisand effect</a>: is it even worth asking the model to pretend unlearning by accurately describing it in-context, and subsequently <a href="https://arxiv.org/abs/2402.17840">risk leaking it</a> in subsequent model responses?</p>

<p><strong>Few-shot prompting or “<a href="https://arxiv.org/abs/2310.07579">in-context unlearning</a>”.</strong> Suppose we now have a clearly defined set of forget examples with corresponding labels. We can <em>flip</em> their labels and put them in the prompt, along with more retain examples with correct labels, with the intuition that the model would treat these falsely labelled forget examples as truths and act accordingly—much like one could <a href="https://www.anthropic.com/research/many-shot-jailbreaking">jailbreak</a> a model this way.<sup id="fnref:random-incontext-labels" role="doc-noteref"><a href="#fn:random-incontext-labels" rel="footnote">4</a></sup> Indeed, this works best when the forget examples and the counterfactual labels are clearly defined and (somewhat) finite. It <em>may</em> work for factual associations (e.g. Paris is the captial of France) by enumerating a <em>lot</em> of examples, but unlikely to work for unlearning toxic behaviors (where space of possible outputs is much larger).</p>

<p>In a sense, these approaches are complementary as they work for different kinds of unlearning requests.</p>

<p><strong>More broadly, one could imagine a <em>boxed</em> LLM system for unlearning through prompting, where</strong>:</p>
<ol>
  <li>Only the input and output interfaces are exposed (like ChatGPT);</li>
  <li>Different instances of a powerful LLM are responsible for accurately mimicking different parts of a desired unlearning behavior (for example, one LLM instance specializes in general trivia-style QA while anoother handles sequence completions);</li>
  <li>An orchestrator/router LLM decides which unlearning worker instance to call depending on the input; and</li>
  <li>A composer/summarizer LLM that drafts the final output conforming to the desired unlearning behavior; it may also apply some output filtering.</li>
</ol>

<p>Some readers may grumble about the heuristic nature of such prompting-based techniques; that there is no proof of unlearning whatsoever. We should keep in mind that fine-tuning based empirical unlearning, as most recent approaches do, is perhaps not fundamentally different. I think it ultimately comes down to the following questions:</p>
<ol>
  <li>Which of fine-tuning or prompting can <strong>better steer model behavior</strong>?</li>
  <li>Which of them are <strong>less susceptible to attacks</strong> (exposing less surfaces and/or requiring more effort for an adversary to revert the unlearning)?</li>
</ol>

<p>My intuition of our current models says that both questions point to fine-tuning based unlearning, but this is very much up for debate and can change as we get more powerful models and better defense mechanisms. For example, the recent notion of an <a href="https://arxiv.org/abs/2404.13208">instruction hierarchy</a> may help make such as an LLM system less susceptible to malicious prompts.</p>

<p><strong>It might be useful to note that humans don’t really “unlearn” a piece of knowledge either.<sup id="fnref:human-unlearn" role="doc-noteref"><a href="#fn:human-unlearn" rel="footnote">5</a></sup></strong> In fact, by claiming to have unlearned something, we often have: (1) not only learned it well to be able to make the very claim that we have unlearned it, and (2) consciously decided that it’s no longer useful / beneficial to apply this knowledge to our current world state. Who is to say that unlearning for LLMs should be any different?</p>

<h2 id="3-evaluating-unlearning">3. Evaluating unlearning</h2>

<p>Unlearning is messy for many reasons. But one of the biggest broken things about unlearning is evaluation. In general, we care about three aspects:</p>
<ul>
  <li><strong>Efficiency</strong>: how fast is the algorithm compared to re-training?</li>
  <li><strong>Model utility</strong>: do we harm performance on the retain data or orthogonal tasks?</li>
  <li><strong>Forgetting quality</strong>: how much of the “forget data” is actually unlearned? How fast can we recover (re-learn) them?</li>
</ul>

<p>Evaluating efficiency and model utility are easier; we already measure them during training. The key challenge is in understanding the forgetting quality.<sup id="fnref:eval-exact-unlearning" role="doc-noteref"><a href="#fn:eval-exact-unlearning" rel="footnote">6</a></sup></p>

<p>If the forget examples are specified, this feels easy too. For example, unlearning a particular image class intuitively means getting a near-chance accuracy on the images in that class. An evaluation protocol may measure <a href="https://arxiv.org/abs/2310.20150">accuracy</a> (high on retain &amp; test set, low on forget set) or the <a href="https://arxiv.org/abs/2210.01504">likelihood</a> of the forget text sequences (lower the better).</p>

<p>However, these intuitive choices of metrics aren’t necessarily principled or extensible to settings like knowledge unlearning in LLMs. Expecting the model to perform poorly on an unlearned image ignores <em>generalization</em>, as the forget examples could very well be an interpolation/duplicate of certain retain examples. And we don’t always have oracle models that have never seen the forget examples; e.g., do we have LLMs that have never seen New York Times articles?</p>

<p>Evaluating unlearning on LLMs had been more of an art than science. For example, to unlearn “Harry Potter” as an entity, people would <a href="https://www.microsoft.com/en-us/research/project/physics-of-agi/articles/whos-harry-potter-making-llms-forget-2/">visualize</a> how the token probabilities would decay for Harry Potter related text—and some other folks would come along and show that the model can indeed still <a href="https://swj0419.github.io/detect-pretrain.github.io/">answer</a> Harry Potter trivia questions. The key issue has been the <em>desperate</em> lack of datasets and benchmarks for unlearning evaluation.</p>

<p>Since 2024, nevertheless, the benchmarking crisis is getting better. There are two recent projects worth highlighting:</p>
<ul>
  <li><a href="https://locuslab.github.io/tofu/">TOFU</a>: A benchmark focusing on unlearning individuals (specifically book authors). It involves asking GPT-4 to create fake author profiles, fine-tuning an LLM on them, and using the fine-tune as the unlearning target model and the original LLM as the oracle “retrained” model. It provides QA pairs on the generated fake authors to evaluate a model’s knowledge of these authors before/after applying unlearning.</li>
  <li><a href="https://www.wmdp.ai/">WMDP</a>: A benchmark focusing on unlearning dangerous knowledge, specifically on biosecurity, cybersecurity, and chemical security. It provides 4000+ multiple-choice questions to test a model’s hazardous knowledge before/after applying unlearning. As part of the report the authors also propose an activation steering based empirical unlearning method.</li>
</ul>

<p>TOFU and WMDP depart from previous unlearning evaluation in that they are both “high-level” and focus on the model’s <em>knowledge retention and understanding</em> as opposed to example-level metrics like forget sequence perplexity. This is particularly relevant for LLMs as they are generally capabale of giving the same answer in many different ways that example-level metrics can’t capture.</p>

<p>Looking forward, I think <strong>application-oriented unlearning benchmarks</strong> like TOFU and WMDP, as opposed to instance-based evaluation like that of the <a href="https://unlearning-challenge.github.io/">NeurIPS unlearning challenge</a>, are more useful for evaluating foundation models, owing to the multi-tasking nature of these models and the disparate definitions of “unlearning success” for each of these tasks. Indeed, one might imagine separate benchmarks on unlearning personally identifiable information (PII), copyrighted content, speech toxicity, or even model <a href="https://arxiv.org/abs/2401.05566">backdoors</a>. For example, for unlearning PII, we might care about exact token regurgitation, whereas for toxicity, the unlearning metric would be the score reported by a <a href="https://arxiv.org/abs/2203.09509">ToxiGen</a> classifier.</p>

<h2 id="4-practice-pitfalls-and-prospects-of-unlearning">4. Practice, pitfalls, and prospects of unlearning</h2>

<p>Unlearning is a hard problem, especially in the context of foundation models. As we actively research to make unlearning work in practice, it helps to philosophize a bit on what unlearning really means and whether it is the right solution for our current problems.</p>

<h3 id="41-the-spectrum-of-unlearning-hardness"><strong>4.1. The spectrum of unlearning hardness</strong></h3>

<p>Intuitively, unlearning infrequent textual occurrences in LLMs like car accidents in Palo Alto should be easier than unlearning frequent occurrences like “Biden is the US president”, which is in turn easier than unlearning fundamental facts like “the sun rises every day”.</p>

<p>This spectrum of <em>unlearning hardness</em> emerges because as a piece of knowledge becomes more fundamental, it will have more associations with other pieces of knowledge (e.g. as premises or corollaries) and an exponentially larger unlearning scope. In fact, a piece of knowledge can be so embedded in the model’s implicit knowledge graph that it cannot be unlearned without <em>introducing contraditions</em> and harming the model’s utility.<sup id="fnref:embeddedness-vs-in-distributions" role="doc-noteref"><a href="#fn:embeddedness-vs-in-distributions" rel="footnote">7</a></sup></p>

<p>This intuition implies that certain unlearning requests are much harder or simply unsatisfiable (any attempts are bound to have flaws). Indeed, humans have experiences that form the basis of their subsequent actions and world models; it is subjective, blurry, and philosophical as to what capacity can humans unlearn their formative past memories.</p>

<p>More broadly, the unlearning hardness problem applies to all kinds of models, and for reasons beyond embeddedness in a knowledge/entailment graph. Let’s consider two more seemingly contradictory intuitions for unlearning hardness:</p>

<ol>
  <li>An example seen later in the training should be <em>easy to unlearn</em>, since the model would have moved only slightly in weight space (e.g. due to decayed learning rate) and one could either just revert gradients or revert to a previous checkpoint (if stored). In contrast, examples seen early gets “built on” by later examples (in the curriculum learning sense), making them harder to unlearn.</li>
  <li>An example seen later should be <em>harder to unlearn</em>, since examples seen earlier are gradually (or catastrophically) <a href="https://arxiv.org/abs/2207.00099">forgotten</a> over the course of training; this may be especially true for LLMs.</li>
</ol>

<p>Failure to reconcile these intuition would suggest that the interplay across <em>memorization/forgetting</em>, <em>example importance</em> (in the sense of data <a href="https://arxiv.org/abs/2305.10429">selection</a> and <a href="https://arxiv.org/abs/1906.01827">coresets</a>), <em>learning hardness</em> (in the sense of <a href="https://arxiv.org/abs/2210.15031">prediction flips</a>), and unlearning hardness is unclear.</p>

<p><strong>Here are some interesting research questions</strong>:</p>
<ul>
  <li>Is there a qualitative/fundamental difference between unlearning “easy” data (e.g. a local news event) and “hard” data (e.g. cats have four legs)?</li>
  <li>If there is a spectrum of unlearning hardness, does there exist a threshold to tell apart what is “easy” and “hard”, and thus what is unlearnable or shouldn’t be unlearned? Does there exist, or can we train, such an oracle classifier? Can humans even tell?</li>
  <li>How does this relate to <strong>influence functions</strong> and <strong>data attribution</strong>? If a certain piece of knowledge (as it manifests in a model’s output) can be attributed to a larger fraction of the training data, does it make it harder to unlearn?</li>
  <li>Can we benchmark how easy is it to unlearn something?</li>
</ul>

<h3 id="42-copyright-protection">4.2. Copyright protection</h3>

<p>On the surface, unlearning seems to be a promising solution for copyright protection: if a model violates the copyright of some content, we could attempt to unlearn said content. It is conceivable that to resolve copyright violations via unlearning, provable and exact unlearning is necessary (and possibly sufficient); on the other hand, approximate unlearning, without guarantees and with the possibility of being hacked, is certainly insufficient and likely unnecessary.</p>

<p>In practice, however, there is a lot more nuance due to the questionable effectiveness of current unlearning methods and the <a href="https://arxiv.org/abs/2303.15715">unclear legal landscape</a> at the intersection of AI and copyright. Since I am no legal expert (and clearly none of this section constitutes legal advice), we will mostly focus on asking questions. The central question seems to be: <strong>is unlearning the right solution for copyright protection?</strong></p>

<p>Recall that the <a href="https://en.wikipedia.org/wiki/Fair_use">fair use</a> doctrine<sup id="fnref:fair-use" role="doc-noteref"><a href="#fn:fair-use" rel="footnote">8</a></sup> permits limited use of copyrighted material contigent on four factors: (1) purpose and character of the use (“transformativeness”), (2) the nature of the copyrighted work, (3) amount and substantiality of the use, and (4) the effect on material’s value. If the use of copyrighted content in a model qualifies as fair use, then unlearning such content from the model is unnecessary.</p>

<p>Suppose a model is trained on some copyrighted content and is risking copyright violation, as in <a href="https://www.nytimes.com/2023/12/27/business/media/new-york-times-open-ai-microsoft-lawsuit.html">New York Times v. OpenAI</a>. Should OpenAI invest in (empirical) unlearning algorithms on ChatGPT? Or should they focus on the transformativeness axis of fair use and invest in deploying empirical <em>guardrails</em>, such as prompting, content moderation, and custom alignment to prevent the model from regurgitating training data? The latter seems to be what’s being implemented in practice.</p>

<p><strong>More broadly, there could also be economic solutions to copyright violation as alternatives to unlearning.</strong> For example, model owners may provide an exact unlearning service (e.g. via periodic retraining) while also offering to indemnify model users for copyright infringement in the mean time, as seen in the case of OpenAI’s “<a href="https://openai.com/blog/new-models-and-developer-products-announced-at-devday">Copyright Shield</a>”. People are also starting to <a href="https://arxiv.org/abs/2404.13964">explore</a> how one may price copyrighted data using Shapley values. In general, it is unclear right now how much of a role (if any) unlearning will play for resolving copyright related issues. Exact unlearning (extending to retrieval-based systems, see next section) does hold promises since deletion is clean and provable, but it seems that <em>legally binding</em> auditing procedures/mechanisms need to be in place first.</p>

<h3 id="43-retrieval-based-ai-systems">4.3. Retrieval-based AI systems</h3>

<p>An obvious alternative to unlearning is to not learn at all. One way this could manifest for an LLM is that we take all content from the pre-training set that may receive unlearning requests (e.g., New York Times articles) and put them to an external data/vector store. Any questions relating to them will then be <a href="https://arxiv.org/abs/2005.11401">RAG</a>’ed during inference, and any unlearning requests can be trivially satisfied by removing the data from the database. <a href="https://arxiv.org/abs/2308.04430">Min et al.</a> demonstrates that this approach can be competitive to (though not quite matching) the trained baseline in terms of final perplexity.</p>

<p>Retrieval-based solutions are promising because of the increasing capabilities of the base models to reason in-context. However, there are few considerations before taking retrieval systems as the no-brainer solution to unlearning:</p>

<ol>
  <li><strong>Removing protected content from pre-training corpus can be a hard de-duplication problem.</strong> Much like removing data contamination is <a href="https://lmsys.org/blog/2023-11-14-llm-decontaminator/">hard</a>, how can we be sure that paraphrases, quotations/citations, or other adaptations of the protected content are removed?</li>
  <li><strong>What if the data to be unlearned can’t be retrieved?</strong> Today we fine-tune many things into a model that aren’t documents or knowledge items; for example, it is unclear (yet) if things like as human preferences and desired behaviors (e.g. ability to write concisely) can be “retrieved” from a database.</li>
  <li><strong>Dumping stuff in-context can open new attack surfaces.</strong> Many RAG methods for LLMs work by putting related content in-context and ask the model to reason on them. Having the protected data in-context means they are now more susceptible to data extraction (simple prompting attacks may work just <a href="https://arxiv.org/abs/2402.17840">fine</a>).</li>
  <li><strong>Utility gap between retrieval and training.</strong> While there is evidence that retrieval-based solutions can be competitive, there is no general consensus that retrieval alone can replace fine-tune workloads; indeed, they can be <a href="https://arxiv.org/abs/2401.08406">complementary</a>. More broadly, what if the space of unlearnable data is too large such that if all of it goes to an external store, the base model wouldn’t be as useful?</li>
</ol>

<!-- Indeed, if we only have a handful of examples to learn from for down-stream model adaptations, it probably isn't worth spending GPUs on fine-tuning anyway.  -->

<!-- both because of the increasing capabilities of the base models in reasoning in-context and because  -->

<!-- - Protected content (or content that may receive unlearning requests) will not be part of the pre-training corpus for LLMs, and any questions relating to them are RAG’ed during inference, and unlearning requests are trivially satisfied (by not RAG’ing). -->
<!-- - Some important questions:
    - Ensuring that the pre-training corpus is free of protected content can be a hard de-duplication problem, since such content can appear through various forms. It’s unclear if present embedding-based techniques are sufficient.
    - What if the space of possible unlearning requests will be too large that if all of it goes to external store, the base model wouldn't be as capable?


- also
 -->
<!-- **====DRAFT BELOW====** -->

<h3 id="44-ai-safety">4.4. AI safety</h3>

<!-- **Revisiting right-to-be-forgotten (RTBF).** RTBF had always been cited as the motivation for unlearning.  -->

<!-- **Unlearning for AI safety.** As we explored in [section 1](#1-A-bit-of-history-amp-motivations-for-unlearning) when discussing motivations,  -->

<!-- Right-to-be-forgotten had always been cited as the motivation for unlearning, but as discussed [earlier](#1-A-bit-of-history-amp-motivations-for-unlearning) it is no longer the only motivation.  -->
<p>As models become more capable and are granted <a href="https://lilianweng.github.io/posts/2023-06-23-agent/">agency</a>, one concrete application domain for unlearning that is <a href="https://www.gov.uk/government/topical-events/ai-safety-summit-2023">gaining</a> <a href="https://www.cnn.com/2024/04/26/tech/openai-altman-government-ai-safety-panel/index.html">traction</a> is <strong>AI safety</strong>.</p>

<p>Roughly speaking, safety concerns stem from a model’s <em>knowledge</em> (e.g., recipe of <a href="https://youtu.be/zjkBMFhNj_g?t=2774">napalm</a>), <em>behaviors</em> (e.g., exhibiting <a href="https://arxiv.org/abs/2402.02680">bias</a>), and <em>capabilities</em> (e.g., <a href="https://arxiv.org/abs/2402.06664">hacking</a> websites). Examining current AI systems and extrapolating forward, one may imagine the following examples to apply unlearning and improve AI safety:</p>

<ul>
  <li>removing <strong>hazardous knowledge</strong>, as seen in the <a href="https://www.wmdp.ai/">WMDP</a> benchmark;</li>
  <li>removing <strong>model <a href="https://arxiv.org/abs/2302.10149">poisons</a> and <a href="https://arxiv.org/abs/2401.05566">backdoors</a></strong>, where models respond to adversarially planted input triggers;</li>
  <li>removing <strong><a href="https://www.nytimes.com/2023/02/16/technology/bing-chatbot-microsoft-chatgpt.html">manipulative</a> behaviors</strong>, such as the ability to perform unethical persuasions or deception;</li>
  <li>removing <strong><a href="https://arxiv.org/abs/2402.02680">bias</a> and <a href="https://arxiv.org/abs/2212.08061">toxicity</a></strong>; or even</li>
  <li>removing <strong><a href="https://arxiv.org/abs/2206.13353">power-seeking</a> tendencies</strong>.</li>
</ul>

<p>For safety-oriented applications, it is worth noting that unlearning should be treated as a post-training <em>risk mitigation and defense mechanism</em>, alongside existing tools like alignment fine-tuning and content filters.  And as with any tool, we should view unlearning through its trade-offs in comparison to other tools in the toolbox (e.g., unlearning is more adaptive but more expensive than content filters), as opposed to brushing it off because of the potential lack of guarantees and efficacy.</p>

<hr>

<p><strong>Acknowledgements</strong>: The author would like to thank Aryaman Arora, Jiaao Chen, Irena Gao, John Hewitt, Shengyuan Hu, Peter Kairouz, Sanmi Koyejo, Xiang Lisa Li, Percy Liang, Eric Mitchell, Rylan Schaeffer, Yijia Shao, Chenglei Si, Pratiksha Thaker, Xindi Wu for helpful discussions and feedback before and during the drafting of this post. Any hot/bad takes are those of the author.</p>

<!-- Back to [posts](../blog) -->

<hr>

<p><strong>Citation</strong></p>

<p>If you find this post helpful, it can be cited as:</p>

<p>Liu, Ken Ziyu. (Apr 2024). Machine Unlearning in 2024. Ken Ziyu Liu - Stanford Computer Science. <a href="https://ai.stanford.edu/~kzliu/blog/unlearning">https://ai.stanford.edu/~kzliu/blog/unlearning</a>.</p>

<p>Or</p>

<div><pre><code>@misc{liu2024unlearning,
  title   = {Machine unlearning in 2024},
  author  = {Liu, Ken Ziyu}
  journal = {Ken Ziyu Liu - Stanford Computer Science},
  year    = {2024},
  month   = {Apr},
  url     = {https://ai.stanford.edu/~kzliu/blog/unlearning},
}
</code></pre></div>

<hr>

<p><img src="https://hitwebcounter.com/counter/counter.php?page=13055297&amp;style=0008&amp;nbdigits=6&amp;type=page"></p>


        
      </section>

      

      

      


    </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[A History of C Compilers – Part 1: Performance, Portability and Freedom (167 pts)]]></title>
            <link>https://thechipletter.substack.com/p/a-history-of-c-compilers-part-1-performance</link>
            <guid>40264337</guid>
            <pubDate>Sun, 05 May 2024 12:28:30 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://thechipletter.substack.com/p/a-history-of-c-compilers-part-1-performance">https://thechipletter.substack.com/p/a-history-of-c-compilers-part-1-performance</a>, See on <a href="https://news.ycombinator.com/item?id=40264337">Hacker News</a></p>
<div id="readability-page-1" class="page"><div dir="auto"><blockquote></blockquote><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff0374a2b-f579-4c57-97cb-8f934f7c6e4a_1582x2099.jpeg" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff0374a2b-f579-4c57-97cb-8f934f7c6e4a_1582x2099.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff0374a2b-f579-4c57-97cb-8f934f7c6e4a_1582x2099.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff0374a2b-f579-4c57-97cb-8f934f7c6e4a_1582x2099.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff0374a2b-f579-4c57-97cb-8f934f7c6e4a_1582x2099.jpeg 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff0374a2b-f579-4c57-97cb-8f934f7c6e4a_1582x2099.jpeg" width="1456" height="1932" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/f0374a2b-f579-4c57-97cb-8f934f7c6e4a_1582x2099.jpeg&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:1932,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:232709,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/jpeg&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:false,&quot;topImage&quot;:true,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff0374a2b-f579-4c57-97cb-8f934f7c6e4a_1582x2099.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff0374a2b-f579-4c57-97cb-8f934f7c6e4a_1582x2099.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff0374a2b-f579-4c57-97cb-8f934f7c6e4a_1582x2099.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Ff0374a2b-f579-4c57-97cb-8f934f7c6e4a_1582x2099.jpeg 1456w" sizes="100vw" fetchpriority="high"></picture></div></a></figure></div><blockquote><p>The economic advantages of portability are very great. In many segments of the computer industry, the dominant cost is development and maintenance of software.</p><p><em>Dennis Ritchie and Stephen Johnson 1978</em></p></blockquote><blockquote><p><span>… many insist that C is </span><em>the </em><span>programming language and that it will last forever.</span></p><p><em>Byte Magazine 1983</em></p></blockquote><p>The August 1983 issue of Byte Magazine devoted its cover, and a large part of its editorial content, to the C programming language. After an introduction to C, co-authored by Brian Kernighan of K&amp;R fame, Byte reviewed as many as 20 C compilers - programs to turn C language code into ‘executable programs’ that could be run on the IBM PC or personal computers running the CP/M or CP/M-86 operating systems.</p><p>That same year, MIT’s Richard Stallman approached Andrew Tanenbaum for permission to use the 'Free University Compiler Kit' (better known as the 'Amsterdam Compiler Kit') as the C compiler for his planned GNU (‘GNU’s Not Unix’) operating system. Stallman's GNU would be 'Free as in Freedom' software. However, Tanenbaum's compiler was only 'Free as in the Free University of Amsterdam' and so deemed unsuitable by Stallman for GNU.</p><p>So Stallman set about creating his own “free software” C compiler. The first version, 0.9, was released to the world as a download from MIT in March 1987.</p><p>Forty years after that Byte issue, C remains an essential language and will continue to be so for the foreseeable future. If anything this illustration from Wikipedia, designed to show the pervasiveness of C, understates how widely used it is. C, and its object-oriented derivative, C++ are everywhere!</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6aae5d18-de68-4e81-9081-41d8c02715e5_1123x794.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6aae5d18-de68-4e81-9081-41d8c02715e5_1123x794.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6aae5d18-de68-4e81-9081-41d8c02715e5_1123x794.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6aae5d18-de68-4e81-9081-41d8c02715e5_1123x794.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6aae5d18-de68-4e81-9081-41d8c02715e5_1123x794.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6aae5d18-de68-4e81-9081-41d8c02715e5_1123x794.png" width="1123" height="794" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/6aae5d18-de68-4e81-9081-41d8c02715e5_1123x794.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:794,&quot;width&quot;:1123,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:181886,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:false,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6aae5d18-de68-4e81-9081-41d8c02715e5_1123x794.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6aae5d18-de68-4e81-9081-41d8c02715e5_1123x794.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6aae5d18-de68-4e81-9081-41d8c02715e5_1123x794.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6aae5d18-de68-4e81-9081-41d8c02715e5_1123x794.png 1456w" sizes="100vw"></picture></div></a><figcaption>Some software written in C - By Максим Пе - Own work, CC BY-SA 4.0, https://commons.wikimedia.org/w/index.php?curid=109712425</figcaption></figure></div><p>The compilers that Byte discussed, though,  have mostly disappeared, along with the companies that made them. By contrast, Stallman's compiler, now known as GCC for the 'GNU Compiler Collection', and a more recent open-source compiler ecosystem - LLVM / Clang - are pervasive. Other compilers, including important proprietary compilers from Microsoft and Intel, are available, but none can match GCC and LLVM's broad reach - in architectures, operating systems, and languages - and utility.</p><p>As we've seen, after a period of relative stability, or perhaps stagnation, in computer architecture, we are now living through a period of much greater competition and innovation. Arm is challenging x86, and RISC-V in turn is challenging Arm. GPUs and a wide range of AI-focused Application Specific Integrated Circuits (ASICs), such as Google's TPUs, are becoming key pieces of hardware in the data center and elsewhere.</p><p>But none of this hardware innovation would be useful without software. Almost all other software for these new architectures, from operating systems to machine learning tools, depends on having available performant compilers for C, C++, and more specialized C-like languages, such as that used for GPU kernels in Nvidia’s CUDA. So now is a good point to look at the history of the compiler and to try to understand what has shaped the development of these vital tools.</p><p><em><strong>Note that this is a free post with additional material including further reading at the end of the post for premium subscribers.</strong></em></p><p>Grace Hopper coined the term 'compiler' but used it for a piece of software that would today be called a linker and loader.</p><p>The first compiler, in the modern sense of the term, was written at the University of Manchester in the UK by Alick Glennie for the Manchester Mark 1 computer. This was a compiler for one of the Manchester 'Autocodes' or, as we would now say, programming languages - see a sample of Glennie’s first Autocode below.</p><pre><code>c@VA t@IC x@½C y@RC z@NC
INTEGERS +5 →c           # Put 5 into c
      →t                 # Load argument from lower accumulator
                         # to variable t
   +t     TESTA Z        # Put |t| into lower accumulator
   -t
          ENTRY Z
SUBROUTINE 6 →z          # Run square root subroutine on
                         # lower accumulator value
                         # and put the result into z
  +tt →y →x              # Calculate t^3 and put it into x 
  +tx →y →x
+z+cx   CLOSE WRITE 1    # Put z + (c * x) into
                         # lower accumulator
                         # and return</code></pre><p>FORTRAN is the first compiled 'high-level' language that is still in widespread use today. The language was developed under the supervision of John Backus who delivered the first FORTRAN compiler, for the IBM 704 mainframe, in 1957 after a three-year development project.</p><p>As an aside, some indication of the challenges around compiler construction in this era can be gained from the approach taken by the FORTRAN compiler for the IBM 1401 (announced in 1959) which needed 63 passes to compile a program.</p><blockquote><p>FORTRAN was provided for the IBM 1401 by an innovative 63-pass compiler that ran in only 8k of core. It kept the program in memory and loaded overlays that gradually transformed it, in place, into executable form, ... The executable form was not machine language; rather it was interpreted …</p></blockquote><p>In this era, most new machines came with new architectures. Mainframes were hugely expensive - even large firms would sometimes rent rather than buy their machine. Compilers would usually be made available for free or bundled in with hardware sales. In these circumstances why would anyone try to create a FORTRAN or COBOL compiler that would compete with, say, IBM's?</p><p>The wider availability of lower-cost minicomputers from companies such as DEC in the later 1960s and early 1970s created new opportunities for the development of operating systems, computer languages, and their compilers by third parties. The DEC PDP-11 alone had several dozen operating systems written for it.</p><p>The most famous and consequential example of third-party software for the PDP-11 was the development of the Unix operating system and the C programming language at Bell Labs. Unix was originally written in PDP-11 assembly language, but seeking greater portability, in 1972 Dennis Ritchie developed the C language (a development of B which in turn was a development of BCPL) and a compiler for his new language and then rewrote Unix in C.</p><p>Ritchie's C compiler was written for the DEC PDP-11 but soon made its way onto other machines. According to Ritchie and Stephen Johnson:</p><blockquote><p>C was developed for the PDP-11 on the UNIX system in 1972. Portability was not an explicit goal in its design, even though limitations in the underlying machine model assumed by the predecessors of C made us well aware that not all machines were the same. Less than a year later, C was also running on the Honeywell 6000 system at Murray Hill. Shortly thereafter, it was made available on the IBM 370 series machines as well. The compiler for the Honeywell was a new product but the IBM compiler was adapted from the PDP-11 version, as were compilers for several other machines.</p></blockquote><p>Although the original PDP-11 compiler was adapted for other machines it was not ideally suited for porting. A few years later, the 'Portable C Compiler' (or 'pcc') was written by Johnson, also at Bell Labs, which would provide a C compiler for Unix that made this adaptation much easier. It was quickly ported to a range of other machines. Quoting Johnson:</p><blockquote><p>To summarize, however, if you need a C compiler written for a machine with a reasonable architecture, the compiler is already three-quarters finished!</p></blockquote><blockquote><p>A large fraction of the machine-dependent code can be converted in a straightforward, almost mechanical way.</p></blockquote><p>Johnson's pcc was used as the C Compiler in Seventh Edition Unix (Version 7 Unix) in 1979. Before long Johnson and Ritchie could report that pcc:</p><blockquote><p>is now in use on the IBM System/370 under both OS and TSS, the Honeywell 6000, the Interdata 8/32, the SEL86 the Data General Nova and Eclipse, the DEC VAX-11/780, and a Bell System processor.</p></blockquote><p>The portability of pcc was a key in enabling Unix itself to be ported to new machines. The first machine for which this task was undertaken was another minicomputer, the Interdata 8/32, which was notable for being the first minicomputer priced under $10,000. Porting of Unix with pcc to the Interdata machine went relatively smoothly:</p><blockquote><p>In about six months, we have been able to move the UNIX operating system and much of its software from its original host, the PDP11, to another, rather different machine, the Interdata 8/32. The standard of portability achieved is fairly high for such an ambitious project: the operating system (outside of device drivers and assembly language primitives) is about 95 percent unchanged between the two systems; inherently machine-dependent software such as the compiler, assembler, loader, and debugger are 75 to 80 percent unchanged; other user-level software (amounting to about 20,000 lines so far) is identical, with few exceptions, on the two machines.</p></blockquote><p>Later, the portability of pcc enabled Version 7 Unix and its derivatives to be ported to a wide range of the new 16-bit microprocessor architectures, including the Motorola 68000 (e.g. the first Sun Workstations), the Intel 8086 (including Xenix) the Zilog Z8000, and more.</p><p>A repository of the code of pcc is available today for inspection on GitHub (see further reading at the end of this post) and can produce code for sixteen architectures ranging from the PDP-11 and Data General Nova from the 1960s and early 1970s, all the way to modern 64-bit x86 (AMD64).</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe66b2fe7-9ee0-4a69-b820-6809e4965ed8_984x1388.jpeg" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe66b2fe7-9ee0-4a69-b820-6809e4965ed8_984x1388.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe66b2fe7-9ee0-4a69-b820-6809e4965ed8_984x1388.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe66b2fe7-9ee0-4a69-b820-6809e4965ed8_984x1388.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe66b2fe7-9ee0-4a69-b820-6809e4965ed8_984x1388.jpeg 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe66b2fe7-9ee0-4a69-b820-6809e4965ed8_984x1388.jpeg" width="610" height="860.4471544715448" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/e66b2fe7-9ee0-4a69-b820-6809e4965ed8_984x1388.jpeg&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:1388,&quot;width&quot;:984,&quot;resizeWidth&quot;:610,&quot;bytes&quot;:106469,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/jpeg&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe66b2fe7-9ee0-4a69-b820-6809e4965ed8_984x1388.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe66b2fe7-9ee0-4a69-b820-6809e4965ed8_984x1388.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe66b2fe7-9ee0-4a69-b820-6809e4965ed8_984x1388.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fe66b2fe7-9ee0-4a69-b820-6809e4965ed8_984x1388.jpeg 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p>The first Unix, Ritchie's C compiler, and pcc were initially proprietary software, with the rights owned by Bell Labs. The story of Unix, and the tortuous disputes around it, is for another time. It's worth noting though that the C language itself was not subject to copyright or other intellectual property restrictions. It was soon well known, in large part through Kernighan and Ritchie's famous 1978 book, 'The C Programming Language'.</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0d796b9-afce-4d24-8d39-b03348e14a9d_948x1384.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0d796b9-afce-4d24-8d39-b03348e14a9d_948x1384.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0d796b9-afce-4d24-8d39-b03348e14a9d_948x1384.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0d796b9-afce-4d24-8d39-b03348e14a9d_948x1384.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0d796b9-afce-4d24-8d39-b03348e14a9d_948x1384.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0d796b9-afce-4d24-8d39-b03348e14a9d_948x1384.png" width="948" height="1384" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/c0d796b9-afce-4d24-8d39-b03348e14a9d_948x1384.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:1384,&quot;width&quot;:948,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:2644224,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0d796b9-afce-4d24-8d39-b03348e14a9d_948x1384.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0d796b9-afce-4d24-8d39-b03348e14a9d_948x1384.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0d796b9-afce-4d24-8d39-b03348e14a9d_948x1384.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc0d796b9-afce-4d24-8d39-b03348e14a9d_948x1384.png 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p><span>The year before that Alfred Aho and Jeffrey Ullman (both of whom also worked at Bell Labs for a time) published the book </span><em>Principles of Compiler Design.</em><span> The book would become known as the ‘Green Dragon Book’ as it featured a cartoon of  a medieval knight on a horse battling a green dragon labeled ‘Complexity of Compiler Design’. According to the introduction to the book, its purpose was: </span></p><blockquote><p>to acquaint the reader with the basic constructs of modern programming languages and to show how they can be efficiently implemented in the machine language of a typical computer. </p></blockquote><p>In addition to teaching the theory behind compiler design, the book also looks briefly at some then-current ‘real world’ compilers, noting that by 1977:</p><blockquote><p>C compilers exist for a number of machines, including the [Dennis Ritchie’s for the] PDP-11, [and Stephen Johnson’s for] the Honeywell 6070, and the IBM-370 series.</p></blockquote><p><span>The ‘green dragon book’ and its successor, </span><em>Compilers: Principles, Techniques, and Tools - </em><span>also known as the ‘red dragon book’ published in 1986, would become standard textbooks for anyone wanting to learn how to build compilers. They would make the theory and the techniques creating a compiler available to all.</span></p><p>Meanwhile, when Intel launched their first 8-bit microprocessor, the 8008, in 1972 they commissioned Gary Kildall to write a compiler for the architecture. Kildall wrote a compiler for PL/M, a language that he designed specially for the purpose.</p><blockquote><p><em>Famously, Kildall would go on to create CP/M, the most popular operating system for 8-bit Intel and Zilog processors and its 16-bit successor CPM-86. Less well known is that he also did novel research on compiler design, see more in the further reading at the end of this post. </em></p></blockquote><p><span>There were soon efforts to port the C language to 8-bit architectures, most notably in the form of Ron Cain’s small-C for the Intel 8080. Cain has </span><a href="http://www.svipx.com/pcc/PCCminipages/zc9b6ec9e.html" rel="">written</a><span> that:</span></p><blockquote><p>… I ran off a listing of the Small-C compiler, strapped it to the back of my motorcycle (which must have been a BMW if memory serves) and ran it over to the local office of Dr. Dobbs. This was an unsolicited and unexpected visit, so you can appreciate the look of puzzlement when I said "Here's a compiler for a subset of the C language. Sorry all I have is hard copy. Want to run it?"</p><p>"Sure," they said, "just give us a day or so to look at the code to make sure it does what you say it does. Er, a compiler you say? C to 8080 ASM code? You wrote this? Sure you don't have it on mag tape or something?"</p></blockquote><p>A listing of Cain’s Small-C duly appeared in Dr Dobb’s journal and soon spawned several derivative compilers for 8-bit machines.</p><p>These 8-bit C compilers remained primitive though. Most successful commercial 8-bit software, limited by the quality of the compilers and needing to make the most of the limited resources offered by 8-bit machines, continued to be written in assembly language.</p><p>Commercial programs continued to be written in assembly language in the early 16-bit microprocessor and the (IBM) PC era. The first (1983) version of Lotus 1-2-3, the spreadsheet that was one of the most important early PC software packages, was written in 8086 assembly language, before being rewritten in C a few years later.</p><p>But with the increase in RAM that the new 16-bit systems like the IBM PC offered, with a maximum of 1 Megabyte compared to 64 KBytes for 8-bit systems, software was growing in complexity, and using assembly language was becoming more problematic. And with a range of competing platforms and architectures, portability became more important. As the software market grew, so did the demand for software development tools, including compilers.</p><p>This takes us to the 1983 Byte 'C Programming Language' edition. Commentary on C in the 'Features' section of the magazine starts with a clear articulation of one of the key attractions of the language.</p><blockquote><p>The C language provides a new standard for portability in a computer world characterized by a plethora of processors.</p></blockquote><p>Later on in the magazine, an article titled  ‘The C Language and Models for Systems Programming’ by, none other than, Stephen Johnson and Brian Kernighan states that:</p><blockquote><p>Using functions to extend the base language explains why a language that is so low level can be so portable. C compilers have been built for more than 40 different machines, from the Z80 to the Cray-l.</p></blockquote><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8da20494-f0a6-40ec-be69-1385a8230081_2258x1508.jpeg" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8da20494-f0a6-40ec-be69-1385a8230081_2258x1508.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8da20494-f0a6-40ec-be69-1385a8230081_2258x1508.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8da20494-f0a6-40ec-be69-1385a8230081_2258x1508.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8da20494-f0a6-40ec-be69-1385a8230081_2258x1508.jpeg 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_2400,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8da20494-f0a6-40ec-be69-1385a8230081_2258x1508.jpeg" width="1200" height="801.0989010989011" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/8da20494-f0a6-40ec-be69-1385a8230081_2258x1508.jpeg&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:false,&quot;imageSize&quot;:&quot;large&quot;,&quot;height&quot;:972,&quot;width&quot;:1456,&quot;resizeWidth&quot;:1200,&quot;bytes&quot;:233821,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/jpeg&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8da20494-f0a6-40ec-be69-1385a8230081_2258x1508.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8da20494-f0a6-40ec-be69-1385a8230081_2258x1508.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8da20494-f0a6-40ec-be69-1385a8230081_2258x1508.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8da20494-f0a6-40ec-be69-1385a8230081_2258x1508.jpeg 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p>Byte’s introductory feature also discusses C's growing popularity in the world of microcomputer software:</p><blockquote><p>Most major microcomputer manufacturers and software developers use C for writing systems programs-operating systems, languages, and applications. [Gary Kildall’s] Digital Research is writing all of its new products in C, including CP/M-68K for the 68000 microprocessor and the new Personal BASIC. Both Microsoft and Visicorp have used C extensively in products ranging from Multiplan and Xenix to Visiword and VisiOn.</p></blockquote><p>And again emphasizing the importance of C's portability.</p><blockquote><p>Why is C so popular? The primary reason is that it allows programmers to easily transport programs from one computer or operating system to another while taking advantage of the specific features of the microprocessor in use. And C is at home with systems from 8-bit micro-computers to the Cray-1, the world's fastest computer. As a result, C has been called a 'portable assembly language'...</p></blockquote><p>Byte highlighted that growing interest in Unix was a key part of the reason for C's increasing popularity.</p><blockquote><p>No discussion of C is complete without mentioning the Unix operating system, which is written in C. Unix and its utilities comprise over 300,000 lines of C source code, certainly the most ambitious C project yet. Developed more than 10 years ago at Bell Laboratories, both Unix and C are now coming into widespread use.</p></blockquote><p>Kernighan and Johnson write about how radical the use of a high-level language for performance-critical applications had been when Ritchie had created C, but how well C programs had, in fact, performed when compared to assembly language: </p><blockquote><p>At the time, using a high-level language for such applications was a radical departure from standard practice; everyone knew that these programs had to be written in assembly language "for efficiency." Yet in many cases the C code, although clearly less efficient in any given routine, produced programs that outperformed similar programs written in assembly language.</p></blockquote><p>Kernighan and Johnson end their article noting some of C’s drawbacks but finish on an optimistic note:</p><blockquote><p><span>One or two such goofs while learning the language can lead a beginner to burn the manual. Despite its problems, however, C continues to be used and developed, a good sign that there is a place for a portable low-level language with powerful model-building facilities.</span><em> </em></p></blockquote><p>This strong interest in C had already led to the development of a large number of C compilers and Byte tested twenty such compilers, for 8080, Z80, and 8086-based machines. The compilers tested were:</p><ul><li><p><strong>8080/Z80 running Digital Research’s CP/M-80:</strong><span> Aztec, BDS, C/80, Telecon, Whitesmiths.</span></p></li><li><p><strong>8086/88 running Digital Research’s CP/M-86:</strong><span> Lattice, Mark DeSmet, Digital Research, Mark Williams, Computer Innovations, Supersoft.</span></p></li><li><p><strong>8086/88 running Microsoft’s MS-DOS:</strong><span> c-systems, Caprock, Computer Innovations, DeSmet, Intellect, Lattice, Quantum, Supersoft, Telecon.</span></p></li></ul><p>All the compilers tested by Byte were proprietary products, ranging in price from $35 to $750. </p><p>Let's briefly look at one of the featured C compilers for CP/M-86, Mark Williams C which was priced starting at $500.</p><p>The Mark Williams Company, based in Chicago Illinois, tried to capitalize on the increasing interest in Unix and C, releasing Coherent, a Unix-like operating system for the IBM PC, and several C compilers including Mark Williams CC86 for CP/M-86 and a low-cost C compiler 'Let's C' for the IBM PC. The Mark Williams CC86 C Compiler for CP/M 86 was a high-quality product and Byte commented:</p><blockquote><p>CC86 has the most professional feel of any package we tested. It makes a good attempt at full Kernighan and Ritchie and Unix version 7 compatibility.</p></blockquote><p>Notably, and perhaps surprisingly, absent from the list of companies offering C compilers was Microsoft. MS-DOS 4.0, which was released as late as 1988, still included large amounts of 8086 assembly.</p><blockquote><p>Now you can design for the whole market. Once and for all.</p><p><em>Softech UCSD Pascal Advertisement</em></p></blockquote><p>At this point, it's worth mentioning another then-popular language that promised a strong level of portability but used a very different approach, Niklaus Wirth’s Pascal. UCSD Pascal implemented a virtual machine (the p-machine) that enabled it to run on a wide variety of architectures. One advertisement from the time captured the appeal very effectively.</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F850a192a-b220-4817-9a3f-a1c423ebebec_1692x1500.jpeg" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F850a192a-b220-4817-9a3f-a1c423ebebec_1692x1500.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F850a192a-b220-4817-9a3f-a1c423ebebec_1692x1500.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F850a192a-b220-4817-9a3f-a1c423ebebec_1692x1500.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F850a192a-b220-4817-9a3f-a1c423ebebec_1692x1500.jpeg 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F850a192a-b220-4817-9a3f-a1c423ebebec_1692x1500.jpeg" width="1456" height="1291" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/850a192a-b220-4817-9a3f-a1c423ebebec_1692x1500.jpeg&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:1291,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:148731,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/jpeg&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F850a192a-b220-4817-9a3f-a1c423ebebec_1692x1500.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F850a192a-b220-4817-9a3f-a1c423ebebec_1692x1500.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F850a192a-b220-4817-9a3f-a1c423ebebec_1692x1500.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F850a192a-b220-4817-9a3f-a1c423ebebec_1692x1500.jpeg 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5a638af4-b5d6-4b79-8678-0a88790b3ffe_850x1148.jpeg" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5a638af4-b5d6-4b79-8678-0a88790b3ffe_850x1148.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5a638af4-b5d6-4b79-8678-0a88790b3ffe_850x1148.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5a638af4-b5d6-4b79-8678-0a88790b3ffe_850x1148.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5a638af4-b5d6-4b79-8678-0a88790b3ffe_850x1148.jpeg 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5a638af4-b5d6-4b79-8678-0a88790b3ffe_850x1148.jpeg" width="850" height="1148" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/5a638af4-b5d6-4b79-8678-0a88790b3ffe_850x1148.jpeg&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:1148,&quot;width&quot;:850,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:95497,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/jpeg&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5a638af4-b5d6-4b79-8678-0a88790b3ffe_850x1148.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5a638af4-b5d6-4b79-8678-0a88790b3ffe_850x1148.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5a638af4-b5d6-4b79-8678-0a88790b3ffe_850x1148.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F5a638af4-b5d6-4b79-8678-0a88790b3ffe_850x1148.jpeg 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p>In practice, UCSD Pascal wasn't successful as an alternative to a native code C compiler and soon faded. Unlike compiled C there was a significant performance penalty when compared to using assembly language. A successful bytecode ecosystem would have to  wait until the Java programming language and the Java Virtual Machine were released in 1995.</p><p>Richard Stallman's recursively named 'GNU' operating system project was 'Not Unix' but was closely modeled on Unix. </p><p>In the 'GNU Manifesto' written in 1985 Stallman stated:</p><blockquote><p>GNU, which stands for Gnu's Not Unix, is the name for the complete Unix-compatible software system which I am writing so that I can give it away free to everyone who can use it.</p></blockquote><p>Unix used C and so GNU would need a C compiler. Stallman, disappointed by the 'unfree' nature of Andrew Tanenbaum's compiler, set out to create his own. The first version of the compiler - originally called the GNU C Compiler -  was aimed at the more powerful 16/32-bit microprocessors then becoming increasingly popular. Stallman announced the first release of GCC in March 1987.</p><blockquote><p> The GNU C compiler is now available for ftp from the file
 /u2/emacs/gcc.tar on prep.ai.mit.edu.  This includes machine
 descriptions for vax and sun, 60 pages of documentation on writing
 machine descriptions (internals.texinfo, internals.dvi and Info
 file internals).

 This also contains the ANSI standard (Nov 86) C preprocessor and 30
 pages of reference manual for it.

 This compiler compiles itself correctly on the 68020 and did so
 recently on the vax</p></blockquote><p>The compiler included the, by now aging, DEC VAX minicomputer as a target as Stallman had been offered a VAX 11/750 at MIT as a free development machine.</p><p>The first published version of GCC (0.9) is still available for download.</p><p>Crucially, and aligned with Stallman’s objectives for the GNU project, GCC was released with one of Stallman’s ‘free software’ licenses. Users could freely take and modify the code for their own use, but if they distributed those changes they had to share them with others.</p><p>The portability of GNU and GCC wasn't an explicit objective of Stallman's manifesto, but it was surely a necessary consequence. What was the point of freedom if it was limited to the users of a few architectures? </p><p>However, envisioning difficulties with less powerful machines, Stallman left them to others:</p><blockquote><p>The extra effort to make it run on smaller machines will be left to someone who wants to use it on them.</p></blockquote><p><span>The timing of the release of GCC was fortuitous. As we saw in  </span><em><a href="https://thechipletter.substack.com/p/the-risc-wars-part-1-the-cambrian-c55" rel="">The RISC Wars: The Cambrian Explosion</a></em><span>, the mid-1980s saw the appearance of a large number of new RISC architectures. The firms creating these new designs sometimes had their own C compilers but, with the appearance of GCC, there was a new option: just write a new ‘back-end’ to enable GCC to target the new architecture. </span></p><p><span>Before long GCC was being ported to a range of other operating systems and architectures. To give just one example, the Sun SPARC port appeared as early as 1988. One can sense the breadth of interest in GCC over the 1990s from a </span><a href="https://gcc.gnu.org/onlinedocs/gcc-2.95.3/gcc_23.html" rel="">2001 list</a><span> of contributors and their work. It includes some of the machines that GCC had been ported to by that stage (most of which have now disappeared!)</span></p><blockquote><p><em><strong>Vax, Sony NEWS Machine, NatSemi 32000, Motorola 88000, Convex, MIPS, Tahoe, Pyramid, Charles River Data Systems, Elxsi, Clipper, PowerPC, Hitachi SH, Fujitsu G/Micro Tron, AMD 29000, DEC Alpha, IBM RT, IBM RS/6000</strong></em></p></blockquote><p>Along with architectures, GCC was also adding languages, including Bjarne Stroustrup’s C++, which had appeared as an extension to the C programming language as recently as 1985. According to Michael Tiemann:</p><blockquote><p>I wrote GNU C++ in the fall of 1987, making it the first native-code C++ compiler in the world.</p></blockquote><p><span>The first version of GCC (1.27) supporting the Intel 80386 appeared in 1988, with most of the work on that port being done by </span><a href="https://en.wikipedia.org/wiki/Bill_Schelter" rel="">Bill Schelter</a><span>, a maths professor at the University of Texas, Austin. </span></p><p>The availability of 80386 support would later be helpful for Linus Torvalds. Torvalds has said that he preferred the architecture of the Motorola 68000 series, but he could see where the desktop computer market was heading. In his autobiographical book 'Just for Fun' he wrote:</p><blockquote><p>I faced a geek's dilemma. Like any good computer purist raised on a 68008 chip, I despised PCs. But when the 386 chip came out in 1986, PCs started to look, well, attractive. They were able to do everything the 68020 did, and by 1990, mass-market production and the introduction of inexpensive clones would make them a great deal cheaper. I was very money-conscious because I didn't have any. So it was, like, this is the machine I want to get. And because PCs were flourishing, upgrades and add-ons would be easy to obtain. Especially when it came to hardware, I wanted to have something that was standard.</p><p>I decided to jump over and cross the divide. I would be getting a new CPU.</p></blockquote><p>When he started his&nbsp;Masters Degree course in Computer Science in Helsinki, C and Unix were two of the main attractions:</p><blockquote><p>"... I was most looking forward to was in the C programming language and the Unix operating system"</p></blockquote><p>Torvalds soon started developing his kernel for a Unix-like operating system. As with Stallman, there was interest in, but eventual rejection of, Andrew Tanenbaum's work, in this case, the MINIX operating system:</p><blockquote><p>Early Linux kernel development was done on a MINIX host system, which led to Linux inheriting various features from MINIX, such as the MINIX file system. Eric Raymond claimed that Linus hasn't actually written Linux from scratch, but rather reused source code of MINIX itself to have working codebase. As the development progressed, MINIX code was gradually phased out completely.</p></blockquote><p>Torvalds needed a C compiler and an 80386 version of GCC was readily available. When he first announced his project to the world in 1991, via a Usenet posting, GCC even got a mention:</p><blockquote><p>I've currently ported bash(1.08) and gcc(1.40), and things seem to work. This implies that I'll get something practical within a few months, and I'd like to know what features most people would want. Any suggestions are welcome, but I won't promise I'll implement them :-)</p></blockquote><p>Torvalds had written that: </p><blockquote><p>"It is NOT protable (uses 386 task switching etc)" </p></blockquote><p>but, despite this, the first responses to Torvalds's announcement were very interested in the portability of the system to other architectures.</p><blockquote><p><span>"How much of it is in C? What difficulties will there be in porting?&nbsp;&nbsp;</span><br><span>Nobody will believe you about non-portability ;-), and I for one would&nbsp;&nbsp;</span><br><span>like to port it to my Amiga (Mach needs a MMU and Minix is not free)."</span></p></blockquote><p>The combination of Torvald's kernel and Richard Stallman's GNU software tools, including GCC, would soon become widely known as Linux. GCC has been an essential part of Linux ever since.</p><p>By the early 1990s the availability of Linux as a free Unix-like operating system for the x86 and other architectures, along with GCC as a high-quality C compiler, meant that, with a few exceptions, commercial competitors struggled to compete. Most of the compilers tested by Byte in 1983 quickly disappeared completely. The Mark Williams Company, for example, closed its operations in 1995.</p><p>One that has survived is Lattice C, one of the most performant of the compilers tested by Byte. Lattice C was so good that it was licensed by Microsoft and sold as Microsoft C V1.0 before being replaced by Microsoft’s own in-house Microsoft C V2.0 compiler.</p><p><span>Other compilers for the MS-DOS and then Windows operating systems, notably Borland’s </span><a href="https://en.wikipedia.org/wiki/Turbo_C" rel="">Turbo C</a><span> and </span><a href="https://en.wikipedia.org/wiki/Borland_C%2B%2B" rel="">Borland C++</a><span> and </span><a href="https://en.wikipedia.org/wiki/Watcom_C/C%2B%2B" rel="">Watcom C/C++</a><span> did well for an extended period before the combination of GCC and Microsoft’s own C/C++ compilers ended their commercial viability.</span></p><blockquote><p><em>Borland’s C and C++ - and other Borland products - and Watcom C/C++ really deserve an article all to themselves, but although they were popular and important at the time their impact on today’s compiler ecosystems is smaller than the other compilers we dicuss.</em></p></blockquote><p>Today, Microsoft still offers the descendants of its first in-house compiler, in the form of Microsoft Visual C++. Just as Windows has become and remains the most popular operating system on the desktop, Microsoft’s compiler has remained dominant on Windows.</p><p><span>The open-source nature of GCC soon led to several experimental forks with changes that were not accepted back into the main GCC project. This led to the creation of the </span><em>Experimental/Enhanced GNU Compiler System (EGCS)</em><span> in 1997, which merged a number of these forks. According to Wikipedia:</span></p><blockquote><p>EGCS development proved considerably more vigorous, so much so that the FSF officially halted development on their GCC 2.x compiler, blessed EGCS as the official version of GCC, and appointed the EGCS project as the GCC maintainers in April 1999. With the release of GCC 2.95 in July 1999 the two projects were once again united.</p></blockquote><p>Today GCC has been ported to a wide range of architectures and operating systems, almost certainly more than any other compiler. It also compiles a range of programming languages, including C++, Fortran, Ada, and more.</p><p><span>On architectural portability, according to the </span><a href="https://gcc.gnu.org/onlinedocs/gccint/Portability.html" rel="">GCC website</a><span>:</span></p><blockquote><p><span>GCC itself aims to be portable to any machine where </span><code>int</code><span> is at least a 32-bit type. It aims to target machines with a flat (non-segmented) byte addressed data address space (the code address space can be separate). Target ABIs may have 8, 16, 32 or 64-bit </span><code>int</code><span> type. </span><code>char</code><span> can be wider than 8 bits.</span></p></blockquote><p><span>Here is a list of the architectures that GCC supported in 2023 (</span><a href="https://gcc.gnu.org/backends.html" rel="">source</a><span>):</span></p><blockquote><p><em><strong>aarch64, alpha, arc, arm, avr, bfin, c6x,cr16, cris, csky, epiphany, fr30, frv, gcn, h8300, i386,ia64, iq2000, lm32, m32c, m32r, m68k, more, mep, microblaze, mips, mmix,mn10300, moxie, msp430, nds32, nios2, nvptx, pa, pdp11, pru, riscv, rl78, rs6000, rx, s390, sh, sparc, stormy16, tilegx, tilepro, v850, vax, visium, xtensa.</strong></em></p></blockquote><p>Note that both of the originally supported architectures - m68k and vax -  are still supported today! Notably absent, though, are the 8-bit microprocessors and microcontrollers that Richard Stallman left to others to implement back in 1987.</p><p>Along with this growth in architectural and language support GCC itself has grown hugely. By 2019 GCC had grown in size to over 15 million lines of code.</p><p>Today though, GCC isn’t the only pervasive open-source C compiler. The LLVM ecosystem has gained increasing popularity and is vital to the success of many of the new architectures and hardware that we’ve discussed in recent posts. We'll discuss LLVM, and its relationship with GCC, in more detail in the next post in this series.</p><p><span>Before we leave though, a reminder of how important compilers are to the success of an architecture. Intel's Itanium architecture, on which the company spent billions of dollars, is generally thought to have failed, in large part, because the company failed to get a compiler for the new architecture to work well enough. The recent </span><a href="https://www.theregister.com/2024/04/12/gcc_15_sinks_itanic/" rel="">announcement</a><span> of the removal of support for it in the next GCC (version 15) provides final confirmation of the fact that the architecture is obsolete:</span></p><blockquote><p><span>Support for the </span><code>ia64*-*-</code><span> target ports which have been unmaintained for quite a while has been declared obsolete in GCC 14. The next release of GCC will have their sources permanently removed.</span></p></blockquote><p>The success or failure of many of the 'Cambrian Explosion' of machine learning ASICs will, in many cases, depend on the success or failure of their software ecosystems and the availability of a high-quality compiler for C and C-like languages is essential to all those ecosystems.</p><p data-attrs="{&quot;url&quot;:&quot;https://thechipletter.substack.com/p/a-history-of-c-compilers-part-1-performance?utm_source=substack&amp;utm_medium=email&amp;utm_content=share&amp;action=share&quot;,&quot;text&quot;:&quot;Share&quot;,&quot;action&quot;:null,&quot;class&quot;:null}" data-component-name="ButtonCreateButton"><a href="https://thechipletter.substack.com/p/a-history-of-c-compilers-part-1-performance?utm_source=substack&amp;utm_medium=email&amp;utm_content=share&amp;action=share" rel=""><span>Share</span></a></p><p>The rest of this post is for premium subscribers and includes links to:</p><ul><li><p>Brian Kernighan on the C programming language.</p></li><li><p>Dennis Ritchie and Stephen Johnson on the portability of C and Unix.</p></li><li><p>The earliest known version of Dennis Ritchie’s first C compiler.</p></li><li><p><span>The </span><em>C Language and Models for Systems Programming</em><span> Byte article by Stephen Johnson and Brian Kernighan.</span></p></li><li><p>Gary Kildall’s compiler research.</p></li><li><p>Dr Dobb’s Journal Articles and Resources on C.</p></li><li><p>More on Small C.</p></li><li><p>More on the Portable C compiler.</p></li><li><p>Running the first GCC with 80386 support.</p></li><li><p>C++ on the Commodore 64.</p></li></ul><p>Upgrade your subscription by clicking on this button.</p><h6>Cover image credit XC68020 - prototype of the Motorola 68020, one of the first GCC targets, By David Monniaux - Own work, CC BY-SA 3.0, https://commons.wikimedia.org/w/index.php?curid=1594209</h6></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Take a look at traefik, even if you don't use containers (248 pts)]]></title>
            <link>https://j6b72.de/article/why-you-should-take-a-look-at-traefik/</link>
            <guid>40264042</guid>
            <pubDate>Sun, 05 May 2024 11:31:17 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://j6b72.de/article/why-you-should-take-a-look-at-traefik/">https://j6b72.de/article/why-you-should-take-a-look-at-traefik/</a>, See on <a href="https://news.ycombinator.com/item?id=40264042">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
  <p>Traefik got really popular over the last few years in the bubble of <a href="https://www.youtube.com/watch?v=liV3c9m_OX8">home-lab</a> <a href="https://www.youtube.com/watch?v=scrtJ1U4wJU">youtubers</a>, that’s when I first heard about it.</p>
<p>Traefik is more comparable to <a href="https://docs.haproxy.org/2.9/intro.html#3.1">HAProxy</a> than to nginx/caddy/apache2 - it forwards requests to services and returns the responses, can even modify headers and other aspects of the request and response, but it can’t serve files.</p>
<p>This article states my experience with traefik in an environment without containers.</p>
<h2 id="what-traefik-is-known-for">What traefik is known for</h2>
<p><a href="https://traefik.io/traefik/">Traefiks site</a> states their mission to help the microservices world. All these youtubers share that they own some kind of container infrastructure, either docker or kubernetes. Traefik runs as container too, you <a href="https://doc.traefik.io/traefik/providers/docker/#endpoint">mount the docker socket into the traefik container</a> and gain the ability to auto-detect other containers that you might want to expose using traefik. You can configure the proxying behavior right on the specific container via <a href="https://docs.docker.com/reference/cli/docker/container/run/#label">labels</a>. Traefik can automatically request a TLS certificate from Let’s Encrypt and makes your service available as soon as it detects the existence of new container.</p>
<p>As I don’t use linux containers that much right now, I thought traefik wasn’t for me. But I was wrong. It’s fantastic!</p>
<h2 id="why-its-also-viable-for-non-container-usage">Why it’s also viable for non-container usage</h2>
<h3 id="common-misconception-no-container-engine-required">Common Misconception: no container engine required</h3>
<p>Traefik doesn’t need to run in a container engine, and your services don’t need to run in a container engine.</p>
<p>Traefik is written in Golang and compiles to a single executable file, which you can download from <a href="https://doc.traefik.io/traefik/getting-started/install-traefik/#use-the-binary-distribution">their releases page</a>. I don’t know why, but I get a really good feeling when I encounter software that is written in Golang and compiles to a single binary. It makes it so easy to “deploy” the thing and you get to keep full control.</p>
<p>An example systemd service unit is <a href="https://github.com/traefik/traefik/blob/master/contrib/systemd/traefik.service">contained in their repository</a>, and that’s, apart from the configuration files, all you need. For security, you should create a user and correctly set the permissions on the your configuration files, though.</p>
<h3 id="common-misconception-also-supports-config-files">Common Misconception: also supports config files</h3>
<p>If you don’t use containers, you can’t use container labels - but I find these labels confusing and hard to read anyway.</p>
<p>The good thing: <a href="https://doc.traefik.io/traefik/providers/file/">Traefik can also be configured with configuration files</a>.</p>
<p>As a rule of thumb, Traefik splits its configuration in two parts - a “static” configuration that contains your certificate provider (e.g. Let’s Encrypt) and entrypoints (the ports traefik listens on) and a “dynamic” configuration that contains your routers, services and middlewares.</p>
<p>Traefik listens to file system events and can hot reload the dynamic part.</p>
<p>The config file isn’t thaaaat complicated. <a href="#configuration-example">See my configuration at the bottom of this article.</a></p>
<h3 id="their-documentation-is-great">Their documentation is great!</h3>
<p>It explains all the concepts that Traefik builds upon clearly, has a configuration example for whichever way of configuring your instance you took at the beginning of the relevant pages (which, let’s be real, is the thing we’re searching for most of the time) and their docs covered most of the demands that I had.</p>
<p>If you didn’t understand the terms I used earlier (certificate provider, entrypoint, routers, services &amp; middlewares), the documentation will help you in sub-10 minutes. <a href="https://doc.traefik.io/traefik/">Try it out yourself</a>. The sidebar is your friend.</p>
<h3 id="traefik-feels-robust-and-well-thought-out">Traefik feels robust and well thought-out</h3>
<p>Traefik warns you if your configuration doesn’t make sense and I haven’t run into random issues yet.</p>
<p>Traefik doesn’t seem to log much by default, but the way your request takes is easy to understand and I was up and running really fast without any frustration.</p>
<h2 id="features-i-really-like">Features I really like</h2>
<h3 id="tls-passthrough--proxy-protocol">TLS Passthrough &amp; PROXY protocol</h3>
<p>Traefik supports <a href="https://doc.traefik.io/traefik/routing/routers/#passthrough">TLS Passthrough</a> and HAProxys PROXY protocol (<a href="https://doc.traefik.io/traefik/routing/entrypoints/#proxyprotocol">in</a> and <a href="https://doc.traefik.io/traefik/routing/services/#proxy-protocol">out</a>).</p>
<p>TLS passthrough means that you can forward traffic to web services that supply their own TLS certificate (even request it themselves from Let’s Encrypt, through Traefik, which just forwards everything to the service so that can work) without terminating TLS on the proxy. The proxy can’t see what’s being transmitted.</p>
<p>The decision which virtual host is selected normally happens via the <a href="https://en.wikipedia.org/wiki/List_of_HTTP_header_fields#host-request-header">“Host”-Header</a> - but as that’s in the encrypted body, that’s not possible. TLS has a solution for that problem - the <a href="https://en.wikipedia.org/wiki/Server_Name_Indication">“Server Name Indication” (SNI)</a>, and Traefik and many other web servers / proxies use that to make the selection.</p>
<p>As an addition, HAProxys PROXY protocol is a more secure way of transmitting the info that gets lost due to the user first reaching the proxy - in the past, you would’ve used the “X-Forwarded-&lt;…&gt;” headers, but I always disliked those, as making them secure isn’t trivial and requires testing, as header handling often times isn’t well documented.</p>
<p>Note: the PROXY protocol has to be supported by the target service too - but for apache2 and nginx (and therefore, PHP) that’s the case, and the <a href="https://www.haproxy.com/blog/use-the-proxy-protocol-to-preserve-a-clients-ip-address#proxy-protocol-support">list of services that support the protocol</a> is growing.</p>
<h2 id="things-i-miss-when-using-traefik">Things I miss when using traefik</h2>
<h3 id="authentication">Authentication</h3>
<p>On NGINX, I use the great <a href="https://github.com/vouch/vouch-proxy">Vouch Proxy</a> (also a Golang one-binary program :&gt;) to secure certain services with Azure AD (sorry, Microsoft Entra…) Authentication. (If you know NGINX, you’ll understand how it works just by looking at this: <a href="https://github.com/vouch/vouch-proxy?tab=readme-ov-file#installation-and-configuration">https://github.com/vouch/vouch-proxy?tab=readme-ov-file#installation-and-configuration</a>)</p>
<p>Traefik supports something similar to NGINX’s auth using <a href="https://doc.traefik.io/traefik/middlewares/http/forwardauth/">ForwardAuth</a>. Sadly, Vouch Proxy doesn’t work yet for Traefik (<a href="https://github.com/vouch/vouch-proxy/issues/180">open issue</a>).</p>
<p>You could roll your own keycloak instance, integrate that with AAD and use that for ForwardAuth. <a href="https://www.laitco.de/posts/Traefik_ForwardAuth_AzureAD_Traefik/">The internet says that works</a>. But it also requires you to keep that keycloak instance secure and up-to-date and set it up in the first place. For bigger projects, that might be viable.</p>
<p>Often recommended is <a href="https://github.com/thomseddon/traefik-forward-auth">traefik-forward-auth</a>. Sadly, that project has had its last update in June of 2020, the developer disappeared from GitHub and the dependencies need updating. There are <a href="https://github.com/thomseddon/traefik-forward-auth/pull/369">open</a> <a href="https://github.com/thomseddon/traefik-forward-auth/pull/354">pull</a> <a href="https://github.com/thomseddon/traefik-forward-auth/pull/287">requests</a>, which will probably never be handled. Not viable for me.</p>
<p>I’ve had a bad experience with <a href="https://github.com/oauth2-proxy/oauth2-proxy">oauth2-proxy</a> in the past (but to give them credit: also golang and a single executable :&gt;). I don’t want to proxy to a proxy, as things HTTP2/3, timeouts, body size and WebSockets require configuration on all proxies between the user and the service. Feels too error-prone to me.</p>
<p>But the Traefik ForwardAuth seems simple enough, so I might write my own simple tool for integrating with AAD. Or maybe someone should fork and audit traefik-forward-auth, and update its dependencies.</p>
<h3 id="blocking-of-user-agents-and-ip-addresses">Blocking of user agents and IP addresses</h3>
<p>I don’t want my internal services to be archived by archive.org. <a href="https://www.heise.de/news/Archivierung-des-Internets-Internet-Archive-ignoriert-kuenftig-robots-txt-3693558.html">As robots.txt and similar headers don’t work for disallowing Archive.org</a>, there are only two possibilities to block their Crawler: <a href="https://www.kuketz-blog.de/internet-archive-bot-von-der-webseite-aussperren/">Blocking the “archive.org_bot” user agent, or blocking their IP range</a>.</p>
<p>In Traefik, you can only block <a href="https://plugins.traefik.io/plugins/628c9ed4108ecc83915d775e/LICENSE">user agents</a> or <a href="https://plugins.traefik.io/plugins/62947363ffc0cd18356a97d1/deny-ip-plugin">IP addresses</a> via a third-party plugin. I don’t like third-party plugins as I need to keep them in mind when updating, and they can introduce security vulnerabilities.</p>
<p>You could block IPs by using the <a href="https://doc.traefik.io/traefik/middlewares/http/ipallowlist/">IPAllowList</a> middleware, and just allow everything but the IPs that you want to disallow. <a href="https://stackoverflow.com/a/37284115">You can calculate the IP ranges</a>. That’ll work and isn’t any worse than blocking directly, but doesn’t feel very elegant at all as you can’t see what subnets are exactly blocked just by looking at the ones that are left.</p>
<h2 id="configuration-example">Configuration example</h2>
<p>The following example sets up:</p>
<ul>
<li>entrypoints on :80 and :443
<ul>
<li>with the http endpoint redirecting to https without exceptions</li>
</ul>
</li>
<li>Let’s Encrypt for certificates with the TLS challenge</li>
<li>tls passthrough proxying for cloud.xx.xyz (service on another host)
<ul>
<li>with enabled PROXY protocol</li>
</ul>
</li>
<li>tls-terminating proxying to git.xx.xyz (service on the local host)</li>
<li>redirect middleware from <a href="https://xx.xyz/redirmepls">https://xx.xyz/redirmepls</a> to <a href="https://google.com/">https://google.com</a></li>
<li>header-adding middleware to add a x-robots-header</li>
</ul>
<h3 id="etctraefiktraefikyml"><code>/etc/traefik/traefik.yml</code></h3>
<div><pre tabindex="0"><code data-lang="yml"><span><span><span>providers</span>:
</span></span><span><span>  <span>file</span>:
</span></span><span><span>    <span>filename</span>: <span>/etc/traefik/dynamic.yml</span>
</span></span><span><span>    <span>watch</span>: <span>true</span>
</span></span><span><span><span>entryPoints</span>:
</span></span><span><span>  <span>https</span>:
</span></span><span><span>    <span>address</span>: :<span>443</span>
</span></span><span><span>  <span>http</span>:
</span></span><span><span>    <span>address</span>: :<span>80</span>
</span></span><span><span>    <span>http</span>:
</span></span><span><span>      <span>redirections</span>:
</span></span><span><span>        <span>entryPoint</span>:
</span></span><span><span>          <span>to</span>: <span>https</span>
</span></span><span><span>          <span>scheme</span>: <span>https</span>
</span></span><span><span><span>certificatesResolvers</span>:
</span></span><span><span>  <span>le</span>:
</span></span><span><span>    <span>acme</span>:
</span></span><span><span>      <span>email</span>: <span>xx@xx.xyz</span>
</span></span><span><span>      <span>storage</span>: <span>/etc/traefik/acme.json</span>
</span></span><span><span>      <span>tlsChallenge</span>: {} <span># Required as per https://blog.alexanderhopgood.com/traefik/letsencrypt/2020/12/09/traefik-http-challenge.html</span>
</span></span></code></pre></div><h3 id="etctraefikdynamicyml"><code>/etc/traefik/dynamic.yml</code></h3>
<div><pre tabindex="0"><code data-lang="yml"><span><span><span>tcp</span>:
</span></span><span><span>  <span>routers</span>:
</span></span><span><span>    <span>nextcloud-router</span>:
</span></span><span><span>      <span>rule</span>: <span>"HostSNI(`cloud.xx.xyz`)"</span>
</span></span><span><span>      <span>service</span>: <span>nextcloud</span>
</span></span><span><span>      <span>entrypoints</span>:
</span></span><span><span>        - <span>https</span>
</span></span><span><span>      <span>tls</span>:
</span></span><span><span>        <span>passthrough</span>: <span>true</span>
</span></span><span><span>
</span></span><span><span>  <span>services</span>:
</span></span><span><span>    <span>nextcloud</span>:
</span></span><span><span>      <span>loadBalancer</span>:
</span></span><span><span>        <span>servers</span>:
</span></span><span><span>          - <span>address</span>: <span>10.33.1.2</span>:<span>4433</span>
</span></span><span><span>        <span>proxyProtocol</span>:
</span></span><span><span>          <span>version</span>: <span>2</span>
</span></span><span><span>
</span></span><span><span><span>http</span>:
</span></span><span><span>  <span>routers</span>:
</span></span><span><span>    <span>gitea</span>:
</span></span><span><span>      <span>rule</span>: <span>"Host(`git.xx.xyz`)"</span>
</span></span><span><span>      <span>entrypoints</span>:
</span></span><span><span>        - <span>https</span>
</span></span><span><span>      <span>service</span>: <span>gitea</span>
</span></span><span><span>      <span>middlewares</span>:
</span></span><span><span>        - <span>noindex</span>
</span></span><span><span>      <span>tls</span>:
</span></span><span><span>        <span>certResolver</span>: <span>le</span>
</span></span><span><span>
</span></span><span><span>    <span>xx.xyz</span>:
</span></span><span><span>      <span>rule</span>: <span>"Host(`xx.xyz`)"</span>
</span></span><span><span>      <span>entrypoints</span>:
</span></span><span><span>        - <span>https</span>
</span></span><span><span>      <span>middlewares</span>:
</span></span><span><span>        - <span>my-redirect</span>
</span></span><span><span>      <span>tls</span>:
</span></span><span><span>        <span>certResolver</span>: <span>le</span>
</span></span><span><span>      <span>service</span>: <span>dummy</span>
</span></span><span><span>
</span></span><span><span>  <span>middlewares</span>:
</span></span><span><span>    <span>my-redirect</span>:
</span></span><span><span>      <span>redirectRegex</span>:
</span></span><span><span>        <span>regex</span>: <span>"https://xx.xyz/redirmepls"</span>
</span></span><span><span>        <span>replacement</span>: <span>"https://google.com"</span>
</span></span><span><span>    <span>noindex</span>:
</span></span><span><span>      <span>headers</span>:
</span></span><span><span>        <span>customResponseHeaders</span>:
</span></span><span><span>          <span>X-Robots-Tag</span>: <span>noindex, nofollow, nosnippet, noarchive</span>
</span></span><span><span>
</span></span><span><span>  <span>services</span>:
</span></span><span><span>    <span>gitea</span>:
</span></span><span><span>      <span>loadBalancer</span>:
</span></span><span><span>        <span>servers</span>:
</span></span><span><span>          - <span>url</span>: <span>http://127.0.0.1:3000</span>
</span></span><span><span>    <span>dummy</span>:
</span></span><span><span>      <span>loadBalancer</span>:
</span></span><span><span>        <span>servers</span>: []
</span></span></code></pre></div>
</div></div>]]></description>
        </item>
    </channel>
</rss>