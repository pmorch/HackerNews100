<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>HN100 - Readable Contents</title>
        <link>https://hn.algolia.com/api/v1/search_by_date?tags=%28story,poll%29&amp;numericFilters=points%3E100</link>
        <description>Uses Readability to add bodies to the RSS feed</description>
        <lastBuildDate>Tue, 18 Mar 2025 21:30:02 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[FTC Removes Posts Critical of Amazon, Microsoft, and AI Companies (212 pts)]]></title>
            <link>https://www.wired.com/story/federal-trade-commission-removed-blogs-critical-of-ai-amazon-microsoft/</link>
            <guid>43402957</guid>
            <pubDate>Tue, 18 Mar 2025 18:27:42 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.wired.com/story/federal-trade-commission-removed-blogs-critical-of-ai-amazon-microsoft/">https://www.wired.com/story/federal-trade-commission-removed-blogs-critical-of-ai-amazon-microsoft/</a>, See on <a href="https://news.ycombinator.com/item?id=43402957">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-journey-hook="client-content" data-testid="ArticlePageChunks"><p>The Trump administration’s Federal Trade Commission has removed four years worth of business guidance blogs as of Tuesday morning, including important consumer protection information related to artificial intelligence and the agency’s landmark privacy lawsuits under former chair Lina Khan against companies like Amazon and Microsoft. More than 300 blogs were removed.</p><p>On the FTC’s website, the page hosting all of the agency’s <a href="https://www.ftc.gov/business-guidance">business-related blogs and guidance</a> no longer includes any information published during former president Joe Biden’s administration, current and former FTC employees, who spoke under anonymity for fear of retaliation, tell WIRED. These blogs contained advice from the FTC on how big tech companies could avoid violating consumer protection laws.</p><p>One now deleted blog, titled <a href="https://www.ftc.gov/business-guidance/blog/2023/06/20-million-ftc-settlement-addresses-microsoft-xbox-illegal-collection-kids-data-game-changer-coppa">“Hey, Alexa! What are you doing with my data?”</a> explains how, according to two FTC complaints, Amazon and its Ring security camera products allegedly leveraged sensitive consumer data to train the ecommerce giant’s algorithms. (Amazon disagreed with the FTC’s claims.) It also provided guidance for companies operating similar products and services. Another post titled <a href="https://www.ftc.gov/business-guidance/blog/2023/06/20-million-ftc-settlement-addresses-microsoft-xbox-illegal-collection-kids-data-game-changer-coppa">“$20 million FTC settlement addresses Microsoft Xbox illegal collection of kids’ data: A game changer for COPPA compliance”</a> instructs tech companies on how to abide by Children’s Online Privacy Protection Act by using the 2023 Microsoft settlement as an example. The settlement followed <a href="https://www.ftc.gov/news-events/news/press-releases/2023/06/ftc-will-require-microsoft-pay-20-million-over-charges-it-illegally-collected-personal-information">allegations by the FTC that Microsoft obtained data</a> from children using Xbox systems without the consent of their parents or guardians.</p><p>“In terms of the message to industry on what our compliance expectations were, which is in some ways the most important part of enforcement action, they are trying to just erase those from history,” a source familiar tells WIRED.</p><p>Another removed FTC blog titled <a href="https://www.ftc.gov/business-guidance/blog/2023/05/luring-test-ai-engineering-consumer-trust">“The Luring Test: AI and the engineering of consumer trust”</a> outlines how businesses could avoid creating chatbots that violate the FTC Act’s rules against unfair or deceptive products. This blog <a data-offer-url="https://techprimers.aspendigital.org/hall-of-fame/2023-05-01/" data-event-click="{&quot;element&quot;:&quot;ExternalLink&quot;,&quot;outgoingURL&quot;:&quot;https://techprimers.aspendigital.org/hall-of-fame/2023-05-01/&quot;}" href="https://techprimers.aspendigital.org/hall-of-fame/2023-05-01/" rel="nofollow noopener" target="_blank">won an award in 2023</a> for “excellent descriptions of artificial intelligence.”</p><p>The Trump administration has received broad support from the tech industry. Big tech companies like Amazon and Meta as well as tech entrepreneurs like OpenAI CEO Sam Altman, all donated to Trump’s inauguration fund. Other Silicon Valley leaders, like Elon Musk and David Sacks, are officially advising the administration. Musk’s so-called Department of Government Efficiency (DOGE) employs technologists sourced from Musk’s tech companies. And already, federal agencies like the General Services Administration have <a href="https://www.wired.com/story/gsai-chatbot-1500-federal-workers/">started to roll out AI products like GSAi</a>, a general purpose government chatbot.</p><p>The FTC did not immediately respond to a request for comment from WIRED.</p><p>Removing blogs raises serious compliance concerns under the Federal Records Act and the Open Government Data Act, one former FTC official tells WIRED. During the Biden administration, FTC leadership would place “warning” labels above previous administrations’ public decisions it no longer agreed with, the source said, fearing that removal would violate the law.</p><p>Since President Donald Trump designated Andrew Ferguson to replace Khan as FTC chair in January, the Republican regulator has vowed to leverage his authority to go after big tech companies. Unlike Khan, however, Ferguson’s criticisms center around the Republican party’s <a href="https://www.wired.com/story/plaintext-bogus-fears-of-censorship-could-spell-the-end-of-content-moderation/">longstanding allegations that social media platforms</a>, like Facebook and Instagram, censor conservative speech online. Before being selected as chair, Ferguson told Trump that his vision for the agency also included rolling back Biden-era regulations on artificial intelligence and tougher merger standards, <a data-offer-url="https://www.nytimes.com/2024/12/10/technology/trump-ftc-andrew-ferguson.html" data-event-click="{&quot;element&quot;:&quot;ExternalLink&quot;,&quot;outgoingURL&quot;:&quot;https://www.nytimes.com/2024/12/10/technology/trump-ftc-andrew-ferguson.html&quot;}" href="https://www.nytimes.com/2024/12/10/technology/trump-ftc-andrew-ferguson.html" rel="nofollow noopener" target="_blank">the New York Times reported in December</a>.</p><p><a href="https://www.youtube.com/watch?v=GWYo_w_A_uU&amp;themeRefresh=1">In an interview with CNBC last week</a>, Ferguson argued that content moderation could equate to an antitrust violation. "If companies are degrading their product quality by kicking people off because they hold particular views, that could be an indication that there's a competition problem,” he said.</p><p>Sources speaking with WIRED on Tuesday claimed that tech companies are the only groups who benefit from the removal of these blogs.</p><p>“They are talking a big game on censorship. But at the end of the day, the thing that really hits these companies bottom line is what data they can collect, how they can use that data, whether they can train their AI models on that data, and if this administration is planning to take the foot off the gas there while stepping up its work on censorship,” the source familiar alleges. “I think that's a change big tech would be very happy with.”</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[US appeals court rules AI generated art cannot be copyrighted (283 pts)]]></title>
            <link>https://www.reuters.com/world/us/us-appeals-court-rejects-copyrights-ai-generated-art-lacking-human-creator-2025-03-18/</link>
            <guid>43402790</guid>
            <pubDate>Tue, 18 Mar 2025 18:17:33 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.reuters.com/world/us/us-appeals-court-rejects-copyrights-ai-generated-art-lacking-human-creator-2025-03-18/">https://www.reuters.com/world/us/us-appeals-court-rejects-copyrights-ai-generated-art-lacking-human-creator-2025-03-18/</a>, See on <a href="https://news.ycombinator.com/item?id=43402790">Hacker News</a></p>
Couldn't get https://www.reuters.com/world/us/us-appeals-court-rejects-copyrights-ai-generated-art-lacking-human-creator-2025-03-18/: Error: Request failed with status code 401]]></description>
        </item>
        <item>
            <title><![CDATA[Amazon to kill off local Alexa processing, all voice requests shipped to cloud (267 pts)]]></title>
            <link>https://www.theregister.com/2025/03/17/amazon_kills_on_device_alexa/</link>
            <guid>43402115</guid>
            <pubDate>Tue, 18 Mar 2025 17:27:46 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.theregister.com/2025/03/17/amazon_kills_on_device_alexa/">https://www.theregister.com/2025/03/17/amazon_kills_on_device_alexa/</a>, See on <a href="https://news.ycombinator.com/item?id=43402115">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="body">
<p>Come March 28, those who opted to have their voice commands for Amazon's AI assistant Alexa processed locally on their Echo devices will lose that option, with all spoken requests pushed to the cloud for analysis.</p>
<p>Amazon hasn't formally announced the change, and the <a href="https://www.amazon.com/gp/help/customer/display.html?nodeId=GQXLLWHBCVL6L5QD" rel="nofollow">help page</a> for the feature still makes no mention of the March 28 deprecation. But the internet souk confirmed to <em>The Register</em> that emails to users about the update, which caused a stir on social media over the weekend, are indeed legit.</p>
<p>"We are reaching out to let you know that the Alexa feature 'Do Not Send Voice Recordings' that you enabled on your supported Echo device(s) will no longer be available beginning March 28, 2025," a copy of the email sent to Echo users relayed to <em>El Reg</em> read.</p>

    

<p>"As we continue to expand Alexa's capabilities with generative AI features that rely on the processing power of Amazon's secure cloud, we have decided to no longer support this feature."</p>
<h3>All your phrase are belong to us</h3>
<p>So there it is, apparently: Alexa's latest generative AI tricks are too demanding for the hardware on the handful of Echo devices that support local processing — the 4th-gen Echo Dot, Echo Show 10, and Show 15. Less powerful Echo gadgets don't have any option for processing locally. Therefore, all spoken Alexa requests are going up into Amazon systems for remote processing.</p>
<p>Privacy-conscious users who enabled the "Do Not Send Voice Recordings" setting won't get a say; it's being disabled automatically. Not that many people bothered enabling the local option in the first place, Amazon claims.</p>

        


        

<p>"If you do not take action, your Alexa Settings will automatically be updated to 'Don't save recordings,'" Amazon told affected users.</p>
<p>"Starting on March 28, your voice recordings will be sent to and processed in the cloud, and they will be deleted after Alexa processes your requests," the email continued. "If your voice recordings setting is updated to 'Don't save recordings,' voice ID will not work and you will not be able to create a voice ID for individual users to access more personalized features."</p>

        

<p>In other words, unless you let Amazon store your recordings, you're stuck with a feature-limited Alexa. And all voice commands are going up regardless.</p>
<h3>Private, for a given definition of privacy</h3>
<p>While Echo owners may not be happy about about losing the option for on-device audio processing, the soon-to-be-scrapped feature wasn't exactly airtight with its privacy protection to begin with.</p>
<p>Another <a href="https://www.amazon.com/gp/help/customer/display.html?nodeId=G4X4X8C26Z73P8SQ" rel="nofollow">Amazon help page</a> that gives more detail on the Do Not Send Voice Recordings option notes that even when audio recordings stay local, a text transcript of each request still gets shipped off to Amazon's cloud for processing anyway. Those transcripts are stored right alongside voice recordings and don't auto-delete — you have to manually purge them via your Voice History, assuming you knew they existed in the first place.</p>
<p>Amazon customers shouldn't be surprised, though: The tech titan's approach to privacy has long raised eyebrows, particularly when it comes to Alexa and the other gadgets it plants in homes to gain an audio and visual foothold.</p>
<p>Studies have <a href="https://www.theregister.com/2022/04/27/amazon_audio_data/">claimed</a> that Amazon uses Alexa voice interaction data to help target ads — both on Echo devices and across the web. Third-party apps available for Alexa-enabled devices don't offer much comfort either, at times <a href="https://www.theregister.com/2020/07/29/amazon_google_voice_apps/">lacking</a> clear privacy policies or adequate safeguards on how user data is handled.</p>

        

<p>Then there's last year's drama in America surrounding Ring cameras, when the FTC claimed the super-corp's lax security controls allowed Amazon employees and contractors <a href="https://www.theregister.com/2024/04/25/ring_ftc_settlement/">to access</a> customers' private video feeds. The agency also <a href="https://www.theregister.com/2023/06/01/ftc_alexa_ring_amazon_settlement/">alleged</a> that Amazon unlawfully retained Alexa voice recordings of children indefinitely, violating child privacy laws.&nbsp;</p>
<ul>

<li>2018: <a href="https://www.theregister.com/2018/05/24/alexa_recording_couple/">You know that silly fear about Alexa recording everything and leaking it online? It just happened</a></li>

<li>2018: <a href="https://www.theregister.com/2018/10/15/alexa_sound_recognition/">Alexa heard what you did last summer – and she knows what that was, too: AI recognizes activities from sound</a></li>

<li>2019: <a href="https://www.theregister.com/2019/04/11/amazon_staff_listen_to_alexa/">As Alexa's secret human army is revealed, we ask: Who else has been listening in on you?</a></li>

<li>2022: <a href="https://www.theregister.com/2022/12/14/voice_assistants_failed/">Voice assistants failed because they serve their makers more than they help users</a></li>

<li>2024: <a href="https://www.theregister.com/2024/12/04/washington_dc_amazon_prime/">Amazon accused of cheating low-income Prime users out of two-day deliveries</a></li>

<li>2025: <a href="https://www.theregister.com/2025/01/02/apple_siri_lawsuit/">Apple offers to settle 'snooping Siri' lawsuit for an utterly incredible $95M</a></li>

<li>2025: <a href="https://www.theregister.com/2025/01/30/amazon_sued_for_snarfing_sensitive/">Amazon sued for allegedly slurping sensitive data via advertising SDK</a></li>
</ul>
<p>Amazon, naturally, denies that eliminating the on-device processing feature will impede user privacy.&nbsp;</p>
<p>"The Alexa experience is designed to protect our customers' privacy and keep their data secure, and that's not changing," an Amazon spokesperson told us. "We're focusing on the privacy tools and controls that our customers use most and work well with generative AI experiences that rely on the processing power of Amazon's secure cloud."</p>
<p>It's those generative AI updates, revealed in late February alongside the <a href="https://www.aboutamazon.com/news/devices/new-alexa-generative-artificial-intelligence" rel="nofollow">launch</a> of Alexa+, that appear to be driving the change. The three devices mentioned by Amazon as supporting local voice processing (Dot 4, Show 10, Show 15) are all in the <a href="https://www.amazon.com/dp/B0DCCNHWV5?ref=ods_surl_xaa_us#:~:text=What%20devices%20can%20customers%20use%20Alexa%2B%20on%3F" rel="nofollow">lineup</a> of devices supported by Alexa+, which Amazon is no doubt keen to push users to adopt.&nbsp;</p>
<p>Unlike the classic Alexa, which Amazon said will continue to be available, generative AI through Alexa+ - and the fresh stream of user data required to fuel them - will only be available to Amazon Prime subscribers, or anyone willing to shell out $19.99 per month without Prime. Whether you're sticking with Alexa or using Alexa+, commands are processed remotely.</p>
<p>Amazon told us customers will still have plenty of privacy options available, "including the option to not save their voice recordings at all." That feature, as we noted above, means losing out on many essential Alexa features, like the voice assistant being able to recognize an individual speaker and respond based on their preferences, which for many multi-user households is an essential feature.&nbsp;</p>
<p>"We'll continue learning from customer feedback, and building privacy features on their behalf," Amazon said.&nbsp;®</p>
<p>
  <em><strong>Speaking of AI...</strong> Under the direction of President Donald Trump and his US government standards body NIST, scientists linked to the federally funded Artificial Intelligence Safety Institute have been told to talk less about “AI safety,” “responsible AI,” and “AI fairness,” and focus more on “reducing ideological bias, to enable human flourishing and economic competitiveness,” in machine-learning research, WiReD magazine <a target="_blank" rel="nofollow" href="https://www.wired.com/story/ai-safety-institute-new-directive-america-first/">reports</a>.</em>
</p>                                
                    </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Show HN: I made a tool to port tweets to Bluesky mantaining their original date (191 pts)]]></title>
            <link>https://bluemigrate.com</link>
            <guid>43401855</guid>
            <pubDate>Tue, 18 Mar 2025 17:07:39 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://bluemigrate.com">https://bluemigrate.com</a>, See on <a href="https://news.ycombinator.com/item?id=43401855">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><h2>Migrate your tweets to Bluesky <span>in a few clicks</span></h2><p>Import your tweets keeping their original date.</p><div><p><a href="https://bluemigrate.com/migrate">Migrate</a></p></div><p><a target="_blank" rel="noopener noreferrer" href="https://fazier.com/launches/bluemigrate-2"><img src="https://fazier.com/api/v1/public/badges/embed_image.svg?launch_id=2099&amp;badge_type=daily&amp;theme=light" width="270" alt="Example Image"></a></p><div><h2>Featured Bluesky Profiles</h2><div><div><div><div><p><img alt="BlueMigrate" loading="lazy" width="40" height="40" decoding="async" data-nimg="1" srcset="https://bluemigrate.com/_next/image?url=https%3A%2F%2Fcdn.bsky.app%2Fimg%2Favatar%2Fplain%2Fdid%3Aplc%3Aiu4nttjmi4kwd3trqkeq2dku%2Fbafkreidlks5quizuwgy64ksfqlprps7wwb5cqgtjswvufyzyaog3ukx3sy%40jpeg&amp;w=48&amp;q=75 1x, https://bluemigrate.com/_next/image?url=https%3A%2F%2Fcdn.bsky.app%2Fimg%2Favatar%2Fplain%2Fdid%3Aplc%3Aiu4nttjmi4kwd3trqkeq2dku%2Fbafkreidlks5quizuwgy64ksfqlprps7wwb5cqgtjswvufyzyaog3ukx3sy%40jpeg&amp;w=96&amp;q=75 2x" src="https://bluemigrate.com/_next/image?url=https%3A%2F%2Fcdn.bsky.app%2Fimg%2Favatar%2Fplain%2Fdid%3Aplc%3Aiu4nttjmi4kwd3trqkeq2dku%2Fbafkreidlks5quizuwgy64ksfqlprps7wwb5cqgtjswvufyzyaog3ukx3sy%40jpeg&amp;w=96&amp;q=75"></p><div><h3>BlueMigrate</h3><p>bluemigrate.com</p></div></div><p>Import your tweets to Bluesky in a few clicks 🦋

👉 https://bluemigrate.com</p></div></div><div><div><div><p><img alt="jordan" loading="lazy" width="40" height="40" decoding="async" data-nimg="1" srcset="https://bluemigrate.com/_next/image?url=https%3A%2F%2Fcdn.bsky.app%2Fimg%2Favatar%2Fplain%2Fdid%3Aplc%3Awh7bie3ld7bmg3cz76sbjkwj%2Fbafkreifn2hbtgm7jjlprczdbvyvcsosk323tnfva2mwbdqcviyj64fn4aq%40jpeg&amp;w=48&amp;q=75 1x, https://bluemigrate.com/_next/image?url=https%3A%2F%2Fcdn.bsky.app%2Fimg%2Favatar%2Fplain%2Fdid%3Aplc%3Awh7bie3ld7bmg3cz76sbjkwj%2Fbafkreifn2hbtgm7jjlprczdbvyvcsosk323tnfva2mwbdqcviyj64fn4aq%40jpeg&amp;w=96&amp;q=75 2x" src="https://bluemigrate.com/_next/image?url=https%3A%2F%2Fcdn.bsky.app%2Fimg%2Favatar%2Fplain%2Fdid%3Aplc%3Awh7bie3ld7bmg3cz76sbjkwj%2Fbafkreifn2hbtgm7jjlprczdbvyvcsosk323tnfva2mwbdqcviyj64fn4aq%40jpeg&amp;w=96&amp;q=75"></p><div><h3>jordan</h3><p>jdan.me</p></div></div><p>Author of the critically-acclaimed "Harry Potter" series of children's fantasy novels</p></div></div><div><p><h3>Want to be here?</h3></p><p>Get hundreds of eyes on your profile by being featured on our homepage for 9.99$/week.</p></div></div></div></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Fedora 42 Beta (126 pts)]]></title>
            <link>https://www.redhat.com/en/blog/fedora-42-beta-now-available</link>
            <guid>43401595</guid>
            <pubDate>Tue, 18 Mar 2025 16:48:17 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.redhat.com/en/blog/fedora-42-beta-now-available">https://www.redhat.com/en/blog/fedora-42-beta-now-available</a>, See on <a href="https://news.ycombinator.com/item?id=43401595">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
        <p dir="ltr">Today, the&nbsp;<a href="https://www.fedoraproject.org/">Fedora Project</a> is excited to announce that the&nbsp;<a href="https://fedoramagazine.org/announcing-fedora-linux-42-beta/">beta version of Fedora 42</a>–the latest version of the free and open source operating system–is now available. Learn more about the new and updated features of Fedora 42 Beta below and don’t forget to ensure your system is fully up-to-date before upgrading from a previous release.</p><h3 dir="ltr">What’s new in Fedora 42 Beta?</h3><h4 dir="ltr">Anaconda</h4><ul><li dir="ltr" aria-level="1"><strong>Native Wayland application:</strong> Anaconda is now a native Wayland application in F42 Beta. It no longer supports X11 and instead, users can expect to have more consistent keyboard control with Anaconda being able to control keyboard layouts in the Wayland environment on Live ISOs and the remote graphical installations will use RDP instead of VNC.</li><li dir="ltr" aria-level="1"><strong>Web UI partitioning:</strong> The anaconda team have launched a new web user interface (UI) for partitioning in F42 Beta. With this new feature, the biggest benefit to Fedora users is the new guided partitioning function. This provides a more powerful automatic partitioning, where the user will select a goal and have additional customizations possible. This change also comes with a new "reinstall Fedora" which allows users to easily reinstall their system if something went wrong, and easy support for dual-boot installation. Users only need to make a free space and don’t have to understand other details.</li><li dir="ltr" aria-level="1"><strong>Web UI is now default for Fedora Workstation:</strong> This new web-based UI for the OS installer is now default for Fedora Workstation in F42 Beta. This means that users can enjoy a smooth installation experience, with features such as an installation progress indicator, built in help, configuration review and more. This new feature also includes&nbsp;<a href="https://communityblog.fedoraproject.org/anaconda-is-getting-a-new-suit-and-a-wizard/">Wizard</a> that will allow users to skip what they don't need at installation.&nbsp;</li></ul><h4 dir="ltr">KDE Plasma edition</h4><p dir="ltr">KDE Plasma has been promoted to edition status from F42 Beta onwards! You can expect to continue to enjoy the same level of quality from Fedora KDE as you always have, plus Fedora KDE is now supported on power systems (ppc64le). The full KDE stack (including KDE PIM) is also available on power. Additionally, F42 Beta offers installable live images for OpenPOWER based systems like the Talos Workstation from<a href="https://www.raptorcs.com/">&nbsp;Raptor Systems</a>.</p><h4 dir="ltr">Fedora COSMIC spin</h4><p dir="ltr">We have a new spin! Introducing the Fedora COSMIC spin - a new rust-based desktop environment developed by System76, makers of Pop!_OS. COSMIC has many unique features, such as hybrid per-workspace window/tiling management, window stacks with tabs to switch between windows and robust customization features that integrate with GTK and (later on) Qt!&nbsp;</p><h4 dir="ltr">EROFS for live media</h4><p dir="ltr">We’ve switched the read-only filesystem image format from SquashFS to EROFS for Fedora live media for all kiwi-produced live media, such as KDE desktop and mobile, COSMIC, Budgie, MiracleWM, Fedora CoreOS live media and more. This change aligns with our downstream and RHEL, which creates a more efficient ecosystem for developers to work in both upstream and downstream.</p><h4 dir="ltr">RPM support for systemd sysusers.d</h4><p dir="ltr">RPM supports creating users and groups according to configuration provided in sysusers.d snippets shipped in package payload. This new feature goes towards fully integrating this RPM functionality in Fedora.</p><h4 dir="ltr">DNF/RPM copy on write for all variants</h4><p dir="ltr">The RPM copy on write feature will provide a better experience for Fedora users as it reduces the amount of I/O and offsets CPU cost of package decompression. RPM copy on write uses reflinking capabilities in btrfs, which has been the default filesystem since Fedora 33 for most variants. Note that this behavior is not being turned on by default for this change.&nbsp;</p><h4 dir="ltr">Setuptools 74+</h4><p dir="ltr">Fedora 42 Beta will include the latest upstream release of python-setuptools. Setuptools is a package development process library designed to facilitate packaging Python projects by enhancing the former Python standard library distutils (distribution utilities). It changes quickly and often introduces breaking changes such as the removal of the&nbsp;setup.py test command in version 72.0.0 which was deprecated in 2019.</p><p dir="ltr">If your Fedora package still uses the&nbsp;setup.py test command, please update to&nbsp;%pytest,&nbsp;%tox,&nbsp;%{python3} -m unittest, etc.</p><h4 dir="ltr">DNF5</h4><p dir="ltr">There has been some work done with DNF5 that now includes new logic that will remove expired and obsolete repository keys from the system, which means users can enjoy the automatic management of repository keys during software installation or upgrades.&nbsp;</p><h4 dir="ltr">NumPy2</h4><p dir="ltr">F42 Beta will include an update to NumPy2. Most packages will be unaffected, but those using the C API may need to rebuild. This update brings more up to date fixes, performance improvements and better documentation.</p><h4 dir="ltr">Ruby 3.4</h4><p dir="ltr">Ruby 3.4 is the latest stable version of Ruby. Many new features and improvements are included for the increasingly diverse and expanding demands for Ruby. With this major update from Ruby 3.3 in Fedora 41 to Ruby 3.4 in Fedora 42, Fedora becomes the superior Ruby development platform.&nbsp;</p><h3 dir="ltr">Retirements and deprecations</h3><h4 dir="ltr">Retiring of python3.8</h4><p dir="ltr">The<a href="https://fedoraproject.org/wiki/File:Package-x-generic-16.png">&nbsp;</a><a href="https://src.fedoraproject.org/rpms/python3.8">python3.8</a> package will be retired without replacement beginning with<a href="https://fedoraproject.org/w/index.php?title=Releases/42&amp;action=edit&amp;redlink=1">&nbsp;Fedora Linux 42</a>. As Python 3.8 is EOL, and Ubuntu’s LTS also goes out of standard support by the release time of F42, we will no longer be supporting this version in Fedora Linux.</p><h4 dir="ltr">Python-pytest-runner</h4><p dir="ltr">The python-pytest-runner package will be deprecated in F42 Beta. Dependent packages are encouraged to switch to using pytest directly.</p><h4 dir="ltr">Atomic Desktops will no longer be built for PPC64LE</h4><p dir="ltr">From F42 Beta, we will no longer be building Fedora Atomic Desktops for PowerPC 64 LE. Users of Atomic Desktops on PPC64LE can either switch back to a Fedora package mode installation, or build their own images using bootable containers which are available for PPC64LE.&nbsp;</p><h4 dir="ltr">Retirement of Zezere provisioning server for Fedora IoT</h4><p dir="ltr">We will be retiring the use of the&nbsp;<a href="https://src.fedoraproject.org/rpms/zezere">Zezere</a> provisioning server, which is currently used to configure Fedora IoT devices. Instead, we’ve moved the Zezere provisioning server in favour of offering a local means for user configuration -&nbsp;systemd-firstboot. This will provide users with a more robust, well-tested configuration method that is already installed by default with&nbsp;systemd. Users will still be able to use the existing configuration options of&nbsp;FIDO Device Onboarding or&nbsp;ignition.&nbsp;</p><h3 dir="ltr">What is a Fedora Beta release?</h3><p dir="ltr">Fedora Beta releases are code-complete and will very closely resemble the final release. While the Fedora Project community will be testing this release intensely, we also want our end users to check and make sure that the features you care about are working as intended. The bugs you find and report help make your experience better as well as for millions of Fedora Linux users worldwide! Together, we can help not only make Fedora Linux stronger, but as these fixes and tweaks get pushed upstream to the kernel community, we can contribute to the betterment of the Linux ecosystem and free software holistically.</p><h3 dir="ltr">Let’s test Fedora 42 Beta together</h3><p dir="ltr">Since this is a Beta release, we expect that you may encounter bugs or missing features. To report issues encountered during testing, contact the Fedora QA team via the<a href="https://lists.fedoraproject.org/archives/list/test%40lists.fedoraproject.org/"> test mailing list</a> or in the<a href="https://chat.fedoraproject.org/#/room/#quality:fedoraproject.org"> #quality:fedoraproject.org channel on Fedora Chat</a> (Matrix). As testing progresses, common issues are tracked in the “Common Issues” category on Ask Fedora.</p><p dir="ltr">For tips on reporting a bug effectively, read<a href="https://docs.fedoraproject.org/en-US/quick-docs/howto-file-a-bug/"> how to file a bug</a>.</p>
    </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Apple restricts Pebble from being awesome with iPhones (860 pts)]]></title>
            <link>https://ericmigi.com/blog/apple-restricts-pebble-from-being-awesome-with-iphones/</link>
            <guid>43401245</guid>
            <pubDate>Tue, 18 Mar 2025 16:23:21 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://ericmigi.com/blog/apple-restricts-pebble-from-being-awesome-with-iphones/">https://ericmigi.com/blog/apple-restricts-pebble-from-being-awesome-with-iphones/</a>, See on <a href="https://news.ycombinator.com/item?id=43401245">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><p>During Pebble v1, I learned how much harder it is to build a great smartwatch experience on iPhone than it is on Android. It sounds like things have actually gotten worse over the last 8 years. </p><p>I want to set expectations accordingly. We will build a good app for iOS, but be prepared - there is no way for us to support all the functionality that Apple Watch has access to. It’s impossible for a 3rd party smartwatch to send text messages, or perform actions on notifications (like dismissing, muting, replying) and many, many other things.</p><p><img src="https://ericmigi.com/assets/apple-restricts-pebble-from-being-awesome-with-iphones-0-cleanshot_2025-03-12_at_12.07.462x.png" alt="Throwback to 2015"></p><p>Throwback to 2015</p><p>Here are the things that are harder or impossible for 3rd party smartwatches (ie non Apple Watches) to do on iPhone:</p><ul><li>There’s no way for a smartwatch to send text messages or iMessages.</li><li>You can’t reply to notifications or take ‘actions’ like marking something as done.</li><li>It’s very difficult to enable other iOS apps to work with Pebble. Basically iOS does not have the concept of ‘interprocess communication’(IPC) like on Android. What we did before was publish an SDK that other apps (like Strava) could integrate to make their own BLE connection to Pebble. It was a clunky quasi-solution that other apps didn’t like, because it was hard to test (among other things)</li><li>If you (accidentally) close our iOS app, then your watch can’t talk to app or internet</li><li>Impossible for watch to detect if you are using your phone, so your watch will buzz and display a notification even if you are staring at your iPhone</li><li>You can’t easily side load apps onto an iPhone. That means we have to publish the app on the iPhone appstore. This is a gigantic pain because Apple. Every update comes with the risk that a random app reviewer could make up some BS excuse and block the update.</li><li>Because of iOS Appstore rules, it would be hard for us to enable 3rd party watchface/app developers to charge for their work (ie we can’t easily make an appstore within our app)</li><li>Getting a <a href="https://pebble.github.io/rockyjs/">Javascript engine to run in PebbleOS</a> forced us to go through many hoops due to iOS — creating a compiler inside the Pebble iPhone app that in itself needed to be written in (cross-compiled to) JS to work with Apple's restriction on downloadable code can only be JS</li><li>As a Pebble watch/app developer, using the iOS app as relay to the watch sucks since the "developer mode" terminates every few minutes</li></ul><p>As an aside, back at Pebble, we went to <a href="https://www.theverge.com/2015/11/23/9788146/pebble-time-quick-message-reply">crazy lengths</a> to find a way to let Pebble users to send text messages from Pebble. Our bizdev team did an impressive custom SMS-over-IP deal with AT&amp;T to enable this, but the end result was a pretty rough user experience (messages sent from Pebble didn’t appear in the Messages app on iPhone).</p><p><strong>Here’s the kicker</strong> - it sounds like the situation has actually <em><strong>gotten worse</strong></em>. This 2024 <a href="https://s3.amazonaws.com/jnswire/jns-media/7d/b2/15969695/showtemp_83.pdf">class action lawsuit</a> against Apple states that: </p><ul><li>You must set notifications to display full content previews on your lockscreen for them to also be sent to a 3rd party watch (new restriction added in iOS 13).</li><li>Apple closed off the ability of smartwatches after Pebble to negotiate with carriers to
provide messaging services, and now requires users to turn off iMessage (disabling iOS’s core messaging platform) if they want to take advantage of such contracts between a third-party smartwatch maker and cellular carriers.</li></ul><h3><strong>Why are things so much harder on iOS?</strong></h3><p>Well, mostly because Apple systematically makes it nearly impossible for 3rd party wearable developers to build a smartwatch experience comparable to Apple Watch experience.</p><p>Apple claims their restrictions on competitors are only about security, privacy, crafting a better experience etc etc. At least that’s what they tell you as they tuck you into bed. I personally don’t agree - they’re clearly using their market power to lock consumers into their walled ecosystem. This causes there to be less competition, which increases prices and reduces innovation. DOJ seems to agree. For now at least…Tim Apple <a href="https://www.axios.com/2025/01/03/tim-cook-apple-donate-1-million-trump-inauguration">paid $1m</a> to <a href="https://www.tuaw.com/2025/01/22/tech-leaders-attend-trumps-inauguration-with-tim-cook/">sit near Trump at the inauguration</a>, so who knows how long until Trump tells DOJ to drop the case. There’s also an Apple Watch class-action lawsuit working its way through the system.</p><h3><strong>But we’re going to try anyways</strong></h3><p>The problem is that 40% of everyone who signed up on <a href="http://repebble.com/">rePebble.com</a> still uses an iPhone. So we’re going to make a damn iOS app. I guess we’re gluttons for punishment. Just understand a few things:</p><ul><li>Our watch will&nbsp;<em>always</em>&nbsp;appear to have less developed functionality on iOS than Android. This is Apple’s fault, not ours.</li><li>Some features will appear first on our Android app, and then eventually we’ll add them to the iOS app. This is because the majority of our development team uses Android phones, and generally we’re building things for ourselves, so naturally Android comes first.</li><li>I don’t want to see any tweets or blog posts or complaints or whatever later on about this. I’m publishing this now so you can make an informed decision about whether to buy a new watch or not. If you’re worried about this, the easiest solution is to <strong>buy an Android phone</strong>.</li></ul><h3>You can help</h3><p>Apple will never change their ways unless you, the Pebble-curious iPhone user, complain loudly or switch to Android. Which is also hard because Apple tries it’s best to lock you into their platform.</p><p><strong>Are you an iPhone user who wants to use our watches?</strong> Start by posting a comment below this post. Hopefully there will be a lot - let’s show them that people actually want this to improve.</p><p>If you live in the US, tell your elected representatives to support legislation like ACCESS Act and AICO.</p><p>If you live in Europe, thank you for voting for representatives who passed the DMA. We will be <a href="https://developer.apple.com/support/ios-interoperability/">petitioning Apple</a> under DMA Article 6 to request interoperability with Apple Watch APIs. </p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Two new PebbleOS watches (730 pts)]]></title>
            <link>https://ericmigi.com/blog/introducing-two-new-pebbleos-watches/</link>
            <guid>43400989</guid>
            <pubDate>Tue, 18 Mar 2025 15:59:27 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://ericmigi.com/blog/introducing-two-new-pebbleos-watches/">https://ericmigi.com/blog/introducing-two-new-pebbleos-watches/</a>, See on <a href="https://news.ycombinator.com/item?id=43400989">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><p><img src="https://ericmigi.com/assets/introducing-two-new-pebbleos-watches-0-c2p2_03v2.png"></p><p>We’re excited to announce two new smartwatches that run open source PebbleOS and are compatible with thousands of your beloved Pebble apps. </p><ul><li><strong>Core 2</strong> <strong>Duo</strong> has an ultra crisp black and white display, polycarbonate frame, costs $149 and starts shipping in July.</li><li><strong>Core Time 2</strong> has a larger 64-colour display, metal frame, costs $225 and starts shipping in December.</li></ul><p>Both are available in limited quantities, with worldwide shipping. Prices are in USD. Pre-ordering is the only way to get one - they will not be sold in stores. Pre-order today at <a href="http://store.repebble.com/">store.rePebble.com</a>!</p><p><a href="https://store.repebble.com/" target="_blank" rel="noopener noreferrer"><img src="https://ericmigi.com/assets/introducing-two-new-pebbleos-watches-1-group_5__282_29.png" alt=""></a></p><h2>Why are we making new Pebble-like smartwatches?</h2><p>Pretty simple - because we want one! No company has made a perfect smartwatch for people like <a href="https://www.youtube.com/watch?v=lKie-vgUGdI">us</a>, so we’re going to make the exact smartwatch we want. Read the <a href="https://ericmigi.com/blog/why-were-bringing-pebble-back">full story on my blog</a>, but it comes down to 5 key features:</p><ul><li>Always on e-paper screen</li><li>Long battery life</li><li>Simple and beautiful design</li><li>Physical buttons</li><li>Hackable</li></ul><p>No smartwatch on the market since Pebble offers this combination of features…until today!</p><hr><p><img src="https://ericmigi.com/assets/introducing-two-new-pebbleos-watches-2-01_hero_core_2_duo_34_white.png"></p><h2>Core 2 Duo</h2><p>I think you might recognize this one 😉 It’s almost exactly a Pebble 2, upgraded with modern chips and new tricks. Duo is short for ‘Do-over’.</p><p><em><strong>Similar to Pebble 2, it features</strong></em></p><ul><li>Ultra crisp 1.26” black and white e-paper display</li><li>Runs 10,000+ Pebble apps and watchfaces</li><li>Lightweight polycarbonate frame in two colour options - White or Black</li><li>Water resistant (targeting IPX8)</li><li>Microphone</li><li>Step and sleep tracking</li><li>Standard 22mm watchstrap</li></ul><p><em><strong>Improvements from Pebble</strong></em> <em><strong>2</strong></em></p><ul><li>30 day battery life (up from 7)</li><li>Nordic nRF52840 BLE chip</li><li>Speaker</li><li>Linear resonance actuator (quieter and stronger than vibrating motor)</li><li>More reliable buttons (up to 30% longer lifetime in testing)</li><li>Barometer and compass sensors</li></ul><p>Since this watch will look and feel just like a Pebble 2, you can refamiliarize yourself with it via<a href="https://www.youtube.com/watch?v=KQh1b_srGM4"> videos</a>, or<a href="https://www.starkinsider.com/2016/10/pebble-2-review-smartwatch-perfected.html?utm_source=chatgpt.com"> reviews</a>. For people interested in hacking on PebbleOS firmware, we’re offering an optional JTAG connector. I recommend buying 2 units if you want to hack, just in case!</p><p>Pre-order now for $149 on <a href="http://store.repebble.com/">store.rePebble.com</a>. Starts shipping in July.</p><hr><p><img src="https://ericmigi.com/assets/introducing-two-new-pebbleos-watches-3-f57e25fb-a9f2-4586-b3e4-cae8a5c6b8e2.png"></p><h2>Core Time 2</h2><p>This is my dream watch. It’s everything Pebble Time 2 was going to be and more! </p><p><em><strong>Features:</strong></em></p><ul><li>64-colour 1.5” e-paper display. Same display as Pebble Time 2 - much more room for text and details (53% bigger and 88% more pixels)</li><li>Runs 10,000+ Pebble apps and watchfaces</li><li>Metal frame and buttons (Black/White and likely a 3rd colour option as well)</li><li>30 day battery life (estimate)</li><li>Flat glass lens (less glare and reflections than Pebble Time family curved lens)</li><li>Touch screen</li><li>Heart rate monitor</li><li>Water resistant (targeting IPX8)</li><li>Step and sleep tracking</li><li>Linear resonance actuator (vibrator)</li><li>Microphone and speaker</li><li>Standard 22mm watch strap</li></ul><p>The industrial design is closely based on Pebble 2, which I really love. It’s slightly bigger to accommodate the larger display. Both the frame and buttons are made of metal (most likely CNC milled aluminum). More details, including final colour options, will be shared later this year. </p><p>Pre-order now for $225 on <a href="http://store.repebble.com/">store.rePebble.com</a>. Starts shipping in December.</p><p><video controls="" preload="metadata" playsinline=""><source src="https://ericmigi.com/assets/introducing-two-new-pebbleos-watches-9-side_by_side_screensizev2.mp4" type="video/mp4">Your browser does not support the video tag.</video></p><p>Left: Core 2 Duo - Right: Core Time 2</p><table><thead><tr><th></th><th><em><strong>Core 2 Duo</strong></em></th><th><em><strong>Core Time 2</strong></em></th></tr></thead><tbody><tr><td><em><strong>Display</strong></em></td><td>1.26” B/W</td><td>1.5” 64-colour</td></tr><tr><td><em><strong>Resolution</strong></em></td><td>144x168 pixels, 176 DPI</td><td>200x228 pixels, 202 DPI</td></tr><tr><td><em><strong>Interaction</strong></em></td><td>4 buttons</td><td>4 buttons + touchscreen</td></tr><tr><td><em><strong>Frame</strong></em></td><td>Polycarbonate</td><td>Metal</td></tr><tr><td><em><strong>Sensors</strong></em></td><td>6-axis IMU, compass, barometer</td><td>6-axis IMU, heart rate</td></tr><tr><td><em><strong>Starts shipping</strong></em></td><td>July</td><td>December</td></tr><tr><td><em><strong>Price</strong></em></td><td>$149</td><td>$225</td></tr><tr><td><em><strong>Mic and speaker</strong></em></td><td>✅</td><td>✅</td></tr><tr><td><em><strong>Backlight</strong></em></td><td>✅</td><td>✅</td></tr><tr><td><em><strong>Linear resonance actuator (vibrator)</strong></em></td><td>✅</td><td>✅</td></tr><tr><td><em><strong>Battery life</strong></em></td><td>30 days</td><td>30 days (est.)</td></tr><tr><td><em><strong>Connector</strong></em></td><td>Standard Pebble charger</td><td>Standard Pebble charger</td></tr><tr><td><em><strong>Water resistance</strong></em></td><td>IPX8 (target)</td><td>IPX8 (target)</td></tr><tr><td><em><strong>Health features</strong></em></td><td>Step and sleep tracking</td><td>Heart rate, step and sleep tracking</td></tr><tr><td><em><strong>Strap width</strong></em></td><td>22mm</td><td>22mm</td></tr><tr><td><em><strong>iPhone and Android apps</strong></em></td><td>✅</td><td>✅</td></tr><tr><td><em><strong>Open source</strong></em> <a href="https://github.com/pebble-dev/pebble-firmware"><em><strong>PebbleOS</strong></em></a></td><td>✅</td><td>✅</td></tr></tbody></table><p><a href="https://store.repebble.com/" target="_blank" rel="noopener noreferrer"><img src="https://ericmigi.com/assets/introducing-two-new-pebbleos-watches-5-group_5__282_29.png" alt=""></a></p><h2>Software features</h2><p>Each watch runs open source&nbsp;<a href="https://github.com/pebble-dev/pebble-firmware">PebbleOS</a>. This enables all the baseline Pebble features like receiving notifications, timeline, watchfaces, alarms, timers, calendar, music control, basic fitness tracking, etc. </p><p>The really fun part is that most of the existing 10,000+ PebbleOS watchfaces and apps will immediately work on these new watches, though some may try to access web services that no longer exist. Browse the full appstore on <a href="https://apps.rebble.io/en_US/watchfaces">apps.rebble.io</a>.</p><p>Existing apps/faces will show up with a border on Core Time 2 until developers update them, since it has a larger display (200x228 vs 144x168 pixels). Read more about on the <a href="https://developer.rebble.io/developer.pebble.com/blog/2016/10/11/Emery-SDK-Beta/index.html">old Pebble dev blog</a>.</p><p>We will publish a companion mobile app for Android and iOS. My friend and past Pebble colleague, Steve, recently joined us to lead this effort. He’s joining crc32, long-time <a href="https://github.com/pebble-dev/mobile-app/actions/runs/13609363513">Cobble</a> developer, who has been working with me since last summer. We’ll also be working on an updated SDK for creating new PebbleOS watchfaces or apps.</p><h2>Availability</h2><p>These watches will be sold exclusively through <a href="http://store.repebble.com/">store.rePebble.com</a>. Due to limited supply of display inventory, both watches will be manufactured in limited quantities. I highly recommend placing a pre-order - we will be manufacturing fewer watches than the number of people who have signed up on rePebble already! A pre-order secures your watch but gives you flexibility if you change your mind - you can get a full refund at any time up until your watch ships. </p><h2>Project Progress</h2><p><img src="https://ericmigi.com/assets/introducing-two-new-pebbleos-watches-6-group_6.png" alt="Left: Core 2 Duo running PebbleOS - Right: Engineering samples"></p><p>Left: Core 2 Duo running PebbleOS - Right: Engineering samples</p><p>Schedule-wise, <strong>Core 2 Duo</strong> is quite far along. We’ve already produced dozens of Core 2 Duo watches for testing and development. We’ve tested and confirmed our <a href="https://i.imgur.com/HwdTncx.mp4">button improvements</a>. PebbleOS has been compiled for the new architecture and runs on the watch. All firmware development is open source - you can follow the fun on <a href="https://github.com/pebble-dev/pebble-firmware/commits/main/">Github</a> and <a href="https://discord.com/channels/221364737269694464/256091649996881922">Discord</a>. Our current schedule calls for shipments to begin in July. </p><p>How are we so far along, given that PebbleOS was only open-sourced in January? Two things helped: a) I took a monetary risk and began product development a bit earlier 😉,&nbsp;and b) we found a supplier who still had inventory of some Pebble 2 components. </p><p><video controls="" preload="metadata" playsinline=""><source src="https://ericmigi.com/assets/introducing-two-new-pebbleos-watches-10-outputjdis.mp4" type="video/mp4">Your browser does not support the video tag.</video></p><p>Core Time 2 display lighting up! </p><p>For <strong>Core Time 2</strong>, we’ve finished component selection, initial industrial and mechanical design, and found sources for long lead time components. Now, we’re in the middle of creating the first prototypes. </p><p>The grand irony of hardware development is that software development is usually the slowest part of the project. Not this time! We’re extraordinarily thankful to Google for open sourcing PebbleOS, which gave us a massive boost.</p><p>We’ll share more details (like Core Time 2 frame colour options) later this year, as we get closer to mass production. Our current schedule shows shipments beginning in December. Follow along on this <a href="https://ericmigi.com/">blog</a>, via <a href="https://repebble.com/signup">email</a>, on <a href="https://bsky.app/profile/ericmigi.com">Bluesky</a> or <a href="https://twitter.com/ericmigi">Twitter</a>.</p><h3>Why were these specific specifications selected?</h3><p>Building a smartwatch is an exhausting (😂) exercise of constraint maximization. Think of it as linear algebra - we’re solving multiple equations with multiple unknown variables. The primary constraint is display selection. This choice governs the size and shape of the physical design, as well as being the component with the most power drain and biggest cost. Other variables are Bluetooth chip (governs: cost, software compatibility, engineering time), factory selection (cost, quality, speed, risk), sensors (power, cost, software), battery (size, battery life, cost) and more!</p><p>Despite what Pebble’s second Kickstarter branding proclaimed, solving this inherently requires compromise. It’s a fine line to walk and generally the data is not 100% known upfront, so it inevitably requires some degree of trusting your gut. </p><p><strong>Touchscreen</strong>: we’re adding a touchscreen to Core Time 2. Why? Very specifically, I want to add the concept of ‘complications’ to watchfaces and widgets. Like on Apple Watch, these complications/widgets will show glanceable information like weather, next calendar event, step count, etc. The touch screen adds the ability to tap on the complication and directly open the associated app. This is much faster to use than opening an app via the button menu, and saves your quick launch (long-press on the buttons) for other apps. The touchscreen may be used for other interactions, like swiping to rapidly scroll down a list, but that will be lower priority. </p><p>Core Time 2 will be the first PebbleOS watch to ship with a touchscreen, but not the first that we designed! In 2015, Pebble designed it into a watch called Cutts (or C2) and did some (very) preliminary software development work to integrate a touchscreen into PebbleOS.</p><p><strong>Battery life</strong>: I’m really excited that battery life will be increased from 7 days to 1 month! This is due to massive improvements in Bluetooth chip power efficiency over the last 10 years. </p><p><strong>Speaker</strong>: we’re adding this primarily for potential use in apps that benefit from audio output, like a ChatGPT or other AI agent app. It can’t easily be used for making voice calls, since the watches will not support Bluetooth Classic (required for headset profiles), but theoretically someone could write a custom voice calling client (eg SIP or something).</p><p><strong>Smartstraps</strong>: neither watch will support smartstraps. Sorry. Most people don’t even remember this feature even existed, which is kinda the answer to why it will not be supported. RIP.</p><h3>You shouldn’t get one if…</h3><p><strong>You need a perfectly polished smartwatch.</strong> This project is a labour of love rather than a startup trying to sell millions of watches. There may be some rough edges (literally). Things will get delayed. Some features will not be ready at launch. Things could break. Things could not last as long as you’d like. The only thing we can guarantee is that it will be awesome and a lot of fun! Every time you look down at your watch, you will smile 🙂</p><p><strong>You’re looking for a fitness or sports watch</strong>. That’s not what we’re making. From what we hear, Garmin watches are great for runners/cyclists/triathletes!   </p><p><strong>You’re comparing this to an Apple Watch</strong>. There is NO way for a 3rd party smartwatch to compete with Apple Watch. Apple restricts 3rd parties in major ways - read <a href="https://ericmigi.com/blog/apple-restricts-pebble-from-being-awesome-with-iphones">my blog post</a> for more information. For example, 3rd party watches on iOS cannot send replies to notifications.   </p><p>These watches are not made for everyone. We want to be upfront with you about what to expect. </p><blockquote><p>Watch images above feature impeccably designed watchfaces from <a href="https://ttmm.is/pebble/">TTMM</a>, including one of my all-time favourites - <a href="https://apps.rebble.io/en_US/application/57812aa56c21044501000ed5?query=ttmm&amp;section=watchfaces">TTMMBRN</a>. Thank you Albert!</p></blockquote><p><a href="https://store.repebble.com/" target="_blank" rel="noopener noreferrer"><img src="https://ericmigi.com/assets/introducing-two-new-pebbleos-watches-8-group_5__282_29.png" alt=""></a></p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[North Korea Launders Billions in Stolen Crypto (117 pts)]]></title>
            <link>https://www.coindesk.com/policy/2025/03/07/here-s-how-north-korea-launders-billions-of-stolen-crypto</link>
            <guid>43399190</guid>
            <pubDate>Tue, 18 Mar 2025 13:25:46 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.coindesk.com/policy/2025/03/07/here-s-how-north-korea-launders-billions-of-stolen-crypto">https://www.coindesk.com/policy/2025/03/07/here-s-how-north-korea-launders-billions-of-stolen-crypto</a>, See on <a href="https://news.ycombinator.com/item?id=43399190">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-module-name="article-header" data-module-version="1.0.0" data-module-instance="default"><h2>The Hermit Kingdom, which intelligence agencies say was behind the $1.5 billion Bybit hack, faces “offramping” challenges due to the size of its hauls.</h2><p><span>Updated<!-- --> <!-- -->Mar 13, 2025, 2:59 p.m. <!-- --> UTC</span><span>Published<!-- --> <!-- -->Mar 7, 2025, 8:02 p.m. <!-- --> UTC</span></p></div><div data-module-name="article-body" data-module-version="1.0.0" data-module-instance="default"><p>How does North Korea launder its crypto loot?</p><p>Each time the Hermit Kingdom successfully hacks a company or protocol — like when it pillaged $1.5 billion from <a href="https://www.coindesk.com/markets/2025/03/04/bybit-says-77-of-stolen-funds-from-record-usd1-4b-hack-still-traceable">crypto exchange Bybit</a> on Feb. 21 — it faces the significant challenge of offramping its assets.</p><p>It cannot simply send the funds to a major exchange like Binance or Coinbase, because such firms implement Know-Your-Customer (KYC) checks and work in conjunction with law enforcement agencies to freeze illegally-obtained funds as soon as they’re deposited on their platforms.</p><p>Instead, North Korea uses a well-developed network of over-the-counter (OTC) brokers to launder the stolen funds, according to Ari Redbord, global head of policy at blockchain analytics firm TRM Labs.</p><p>“They'll look to exchanges globally that don't have compliance controls in place,” Redbord, a former senior advisor to the Deputy Secretary and the Undersecretary for Terrorism and Financial Intelligence at the U.S. Treasury, told CoinDesk in an interview. “Everyone uses Chinese money laundering organizations. The cartels use them to move funds. There’s a network there that North Koreans have used for years.”</p><p>“But it’s not just China. Look around the world at places where you have no regulation or a lack of money laundering controls. Russia has been like a money laundering state for a very long time. There's tons of dark net market activity and ransomware actors that are related to Russia. North Korea has also used casinos in Macau to launder fiat.”</p><h2>Off-ramping billions</h2><p>To the best of our knowledge, North Korea has never used crypto to pay for things on the international scene. Instead, it tries to convert the tokens into government-issued currencies like the Chinese renminbi or the U.S. dollar, Redbord said.</p><p>But off-ramping billions in value isn’t easy. North Korea <a target="_blank" href="https://www.trmlabs.com/post/the-bybit-hack-following-north-koreas-largest-exploit">has stolen</a> more than $5 billion since 2017, according to TRM. Broken down on a per-month basis, that means that North Korea has needed to offramp at least $51 million per month on average — which is way too much for its money laundering network’s capabilities.</p><p>“You're inevitably seeing these funds sit in wallets over long periods of time. I don't think that's them setting up a strategic reserve of some kind; they’re just not being able to off-ramp the funds,” Redbord said. “In every world, North Korea wants to get those funds off-chain as fast as they can.”</p><p>“It’s so much money. Think about Pablo Escobar — he had this huge problem with storing cash. He didn’t know where to put it all,” Redbord added. “That's what North Korea has with crypto right now.”</p><p>In the Bybit hack’s case, the vast majority of the stolen ETH has already been bridged to Bitcoin via THORchain, a cross-chain liquidity protocol that enables permissionless crypto swaps.</p><p>The haul is now being fed through mixers (protocols that allow users to obfuscate their transactions on the blockchain) like Wasabi and CryptoMixer. These platforms typically process no more than $10 million a day, meaning that North Korea faces potential bottlenecks even before trying to offramp its stolen funds through OTC brokers. “Whether these mixers can continue to absorb the amount of money at play is an open question,” TRM <a target="_blank" href="https://www.trmlabs.com/post/bybit-hack-update-north-korea-moves-to-next-stage-of-laundering">said</a> in a recent report.</p><h2>What happens afterwards?</h2><p>Once funds are offramped through OTC brokers, the trail goes cold for blockchain analysis firms like TRM, but not necessarily for governmental agencies like the Federal Bureau of Investigation (FBI), Homeland Security Investigations (HSI) or IRS Criminal Investigation (IRS-CI), which each have a broad panoply of intelligence-gathering tools at their disposal.</p><p>Such agencies may use human intelligence (interviews, interrogations and espionage) and signals intelligence (intercepting communications or gathering information from electronic devices) to boost their investigations.</p><p>These agencies are sometimes able to retrieve stolen funds. In the case of the Colonial Pipeline ransomware attack in 2021, the Department of Justice (DOJ) was eventually able to recover <a href="https://www.coindesk.com/markets/2021/06/07/federal-officials-recover-bitcoin-ransom-from-colonial-pipeline-attack">almost 85% of the bitcoin (BTC) ransom paid to Russian cybercriminal group Darkside</a>. It’s unclear how investigators obtained the hacking group’s private keys.</p><p>The network of Chinese shell companies that North Korea uses to launder funds — whether from crypto or other sources — is constantly being monitored by U.S. agencies in collaboration with Japanese and South Korean authorities, Redbord said. And getting funds laundered through the Chinese banking system doesn’t necessarily mean the game is won for North Korea.</p><p>Back in 2019, U.S. federal prosecutors <a target="_blank" href="https://www.lawfaremedia.org/article/long-arm-us-law-patriot-act-anti-money-laundering-act-2020-and-foreign-banks">served subpoenas to three Chinese banks</a> in a North Korea money-laundering case. That would ordinarily be impossible because the U.S. government doesn’t have jurisdiction over the Chinese banking system, Redbord, who worked on the case, explained.</p><p>But a provision under the <a target="_blank" href="https://www.fincen.gov/resources/statutes-regulations/usa-patriot-act">USA PATRIOT Act</a> enables the practice under specific circumstances. If the foreign bank does not respond, the U.S. government is allowed to cut off the bank’s correspondent banking — essentially disconnecting the foreign bank from the U.S. banking system.</p><p>In that particular case, the Chinese banks eventually complied with the subpoena, Redbord said. But the strategy is hard to replicate because it requires serious political capital. “We’re talking about some of the biggest banks in the world. If you were to actually cut off correspondent banking from one of the major Chinese banks, it would not be good for the economy,” Redbord said. That’s why the Treasury Secretary and Attorney General need to sign off on this kind of strategy.</p><p>“If any administration would be willing to lean in a little bit, it would probably be this one,” Redbord said. “Issuing a subpoena to a small or mid-sized Chinese bank is probably something that would be worth doing. It does send a really strong message.”</p><p><strong><em>CORRECTION (March 13, 2025, 15:00 UTC):</em></strong>&nbsp;<em>The Bybit hackers did not bridge the majority of their funds from Ethereum to Bitcoin using THORSwap, as the article originally stated. They used THORchain.</em></p></div><div data-module-name="authors-block" data-module-version="1.0.0" data-module-instance="default"><div><h5><a href="https://www.coindesk.com/author/tom-carreras">Tom Carreras</a></h5><p>Tom writes about markets, bitcoin mining and crypto adoption in Latin America. He has a bachelor's degree in English literature from McGill University, and can usually be found in Costa Rica. He holds BTC above CoinDesk's disclosure threshold of $1,000.</p><p><a target="_blank" title="X" href="https://x.com/tom_carreras"><svg width="16" height="16" viewBox="0 0 1400 1027" fill="none" xmlns="http://www.w3.org/2000/svg" aria-labelledby="twitter-svg-a11y-label-id"><title id="twitter-svg-a11y-label-id">X icon</title><path d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z" fill="#262626"></path></svg></a><a target="_blank" title="LinkedIn" href="https://www.linkedin.com/in/tom-carreras-b72083249"><svg width="24" height="24" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M2.25362 9.21772H6.53986V22.1164H2.25362V9.21772ZM4.42543 3C2.95843 3 2 3.9631 2 5.22719C2 6.46529 2.93038 7.45638 4.36933 7.45638H4.39667C5.89171 7.45638 6.82276 6.46524 6.82276 5.22719C6.79471 3.9631 5.89176 3 4.42543 3ZM17.0638 8.91471C14.7886 8.91471 13.7693 10.1661 13.2007 11.0438V9.21772H8.91314C8.9699 10.4278 8.91314 22.1164 8.91314 22.1164H13.2007V14.9129C13.2007 14.527 13.2287 14.1427 13.3415 13.8663C13.652 13.0961 14.3574 12.2985 15.5407 12.2985C17.0931 12.2985 17.7131 13.4819 17.7131 15.2151V22.1163H22V14.72C22 10.7581 19.8856 8.91471 17.0638 8.91471Z" fill="#262626"></path></svg></a><a target="_blank" title="Email" href="mailto:tom.carreras@coindesk.com"><svg width="16" height="16" fill="#262626" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 75.294 75.294"><g><path d="M66.097,12.089h-56.9C4.126,12.089,0,16.215,0,21.286v32.722c0,5.071,4.126,9.197,9.197,9.197h56.9   c5.071,0,9.197-4.126,9.197-9.197V21.287C75.295,16.215,71.169,12.089,66.097,12.089z M61.603,18.089L37.647,33.523L13.691,18.089   H61.603z M66.097,57.206h-56.9C7.434,57.206,6,55.771,6,54.009V21.457l29.796,19.16c0.04,0.025,0.083,0.042,0.124,0.065   c0.043,0.024,0.087,0.047,0.131,0.069c0.231,0.119,0.469,0.215,0.712,0.278c0.025,0.007,0.05,0.01,0.075,0.016   c0.267,0.063,0.537,0.102,0.807,0.102c0.001,0,0.002,0,0.002,0c0.002,0,0.003,0,0.004,0c0.27,0,0.54-0.038,0.807-0.102   c0.025-0.006,0.05-0.009,0.075-0.016c0.243-0.063,0.48-0.159,0.712-0.278c0.044-0.022,0.088-0.045,0.131-0.069   c0.041-0.023,0.084-0.04,0.124-0.065l29.796-19.16v32.551C69.295,55.771,67.86,57.206,66.097,57.206z"></path></g></svg></a></p></div><p><a href="https://www.coindesk.com/author/tom-carreras"><img alt="Tom Carreras" loading="lazy" width="960" height="1280" decoding="async" data-nimg="1" srcset="https://www.coindesk.com/_next/image?url=https%3A%2F%2Fcdn.sanity.io%2Fimages%2Fs3y3vcno%2Fproduction%2Ffabbb8c177f57043e1cb890e72be2ceea65dc4bf-960x1280.png%3Fw%3D64%26h%3D64%26fit%3Dcrop%26crop%3Dfocalpoint%26auto%3Dformat&amp;w=1080&amp;q=75 1x, https://www.coindesk.com/_next/image?url=https%3A%2F%2Fcdn.sanity.io%2Fimages%2Fs3y3vcno%2Fproduction%2Ffabbb8c177f57043e1cb890e72be2ceea65dc4bf-960x1280.png%3Fw%3D64%26h%3D64%26fit%3Dcrop%26crop%3Dfocalpoint%26auto%3Dformat&amp;w=1920&amp;q=75 2x" src="https://www.coindesk.com/_next/image?url=https%3A%2F%2Fcdn.sanity.io%2Fimages%2Fs3y3vcno%2Fproduction%2Ffabbb8c177f57043e1cb890e72be2ceea65dc4bf-960x1280.png%3Fw%3D64%26h%3D64%26fit%3Dcrop%26crop%3Dfocalpoint%26auto%3Dformat&amp;w=1920&amp;q=75"></a></p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Half-Life 2 RTX (131 pts)]]></title>
            <link>https://store.steampowered.com/app/2477290/HalfLife_2_RTX/</link>
            <guid>43399168</guid>
            <pubDate>Tue, 18 Mar 2025 13:23:43 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://store.steampowered.com/app/2477290/HalfLife_2_RTX/">https://store.steampowered.com/app/2477290/HalfLife_2_RTX/</a>, See on <a href="https://news.ycombinator.com/item?id=43399168">Hacker News</a></p>
<div id="readability-page-1" class="page"><div itemscope="" itemtype="http://schema.org/Product" id="tabletGrid">
		
		<meta itemprop="image" content="https://shared.cloudflare.steamstatic.com/store_item_assets/steam/apps/2477290/21654648e70f9f5fb757c9011355f648ba46a8b7/capsule_231x87.jpg?t=1742308144">
					
		
		<div data-gpnav="columns">
		                      
         		<div><p><img src="https://cdn.cloudflare.steamstatic.com/steamcommunity/public/images/apps/2477290/610951d88c9fc23713ef021d39c6f5b65e3b811b.jpg"></p></div>
		<p>Half-Life 2 RTX</p>
		

	</div>
		


		

		

				

		<div data-panel="[]">

					
					
					
					
					
					<div id="game_area_purchase">
						
																			

						
																															<div>
									<h2>Community-Made Mod</h2>
									<p>This community-made mod requires that you own Half-Life 2.</p>
									<p>Click <a href="https://store.steampowered.com/about/communitymods/?snr=1_5_9_" target="_blank">here</a> to learn more about mods on Steam.</p>
								</div>
																				<!--[if lte IE 7]>
<style type="text/css">
.game_area_purchase_game_dropdown_right_panel .btn_addtocart { float: none; }
</style>
<![endif]-->

	<div>
		
				<h2>
			Install Half-Life 2 RTX		</h2>
						
	</div>

						
						
					</div>
					<!-- game_area_purchase -->

					
											
					
					

					
					
																								
					

					
				
								
				
				


									
									<div id="aboutThisGame" data-panel="{&quot;type&quot;:&quot;PanelGroup&quot;}">
							<h2>About This Game</h2>
							<p><strong><u>Ravenholm and Nova Proskpekt demo available now!</u></strong>&nbsp;&nbsp;</p><p>The fight for freedom begins anew. Experience the award-winning game that has captivated millions of players worldwide with its immersive story, thrilling combat, and mind-bending physics, fully overhauled with full ray tracing, new hand-crafted, physically based textures, enhanced high-poly models, and updated lighting, all in stunning 4K.&nbsp;</p><p>Half-Life 2 RTX is a free DLC for all Half-Life 2 owners developed by Orbifold Studios, a collective of passionate, community-assembled developers behind Half-Life 2: VR, Half-Life 2: Remade Assets, Project 17, and Raising the Bar: Redux.</p><p>Half-Life 2 RTX uses the latest version of RTX Remix leveraging new RTX Neural Rendering technologies, cutting-edge full ray tracing, accelerated by NVIDIA DLSS 4 with Multi Frame Generation, and NVIDIA Reflex to bring one of the greatest video games of all time to life in a whole new light.</p>						</div>
					<div id="game_area_content_descriptors">
			<h2>Mature Content Description</h2>
			<p>The developers describe the content like this:</p>
			<p><i>
			Half-life 2 RTX includes violence throughout the game directed at both humanoid and alien enemies. Includes zombies and corpses with detailed gore. 				</i>
			</p>
		</div>
	
				
				
					<div>
		<h2>System Requirements</h2>
				<div data-os="win">
							<ul>
								<strong>Minimum:</strong><br><ul><li><strong>OS:</strong> 64-bit Windows 10 / Windows 11<br></li><li><strong>Processor:</strong> Intel i5-8600, AMD Ryzen 5 3600<br></li><li><strong>Memory:</strong> 16 GB RAM<br></li><li><strong>Graphics:</strong> NVIDIA GeForce RTX 3060 TI<br></li><li><strong>Storage:</strong> 50 GB available space</li></ul>							</ul>
						</div>
	</div>
	

				
								
				</div>

		


		<div id="app_reviews_hash">
							<h2>Customer reviews for Half-Life 2 RTX</h2>

		
				<div id="review_histograms_container">
			<canvas id="review_graph_canvas"></canvas>
			<div id="review_histogram_rollup_section">
						<p>Overall Reviews:</p>
						<p><span data-tooltip-html="83% of the 601 user reviews for this game are positive.">Very Positive</span>
													<span>(601 reviews)</span>
												<a data-tooltip-text="Since this product is free, this summary includes all reviews."><img src="https://store.cloudflare.steamstatic.com/public/shared/images/ico/icon_questionmark.png"></a>
					</p></div><!--
			-->
		</div>

		<div id="reviews_filter_options">
			<div>
				<p>Review Type</p>
				<div>
					<p>
						<label for="review_type_all">All&nbsp;<span>(601)</span></label><br>
						
						<label for="review_type_positive">Positive&nbsp;<span>(504)</span></label><br>
						
						<label for="review_type_negative">Negative&nbsp;<span>(97)</span></label>
					</p>
				</div>
			</div>
			<div>
				<p>Purchase Type</p>
				<div>
					<p>
						<label for="purchase_type_all">All&nbsp;<span>(601)</span></label><br>
						
						<label for="purchase_type_steam">Steam Purchasers&nbsp;<span>(0)</span> <a data-tooltip-text="These are reviews written by customers that purchased the game directly from Steam."><img src="https://store.cloudflare.steamstatic.com/public/shared/images/ico/icon_questionmark_dark.png"></a></label><br>
						
						<label for="purchase_type_non_steam">Other&nbsp;<span>(601)</span> <a data-tooltip-text="These are reviews written by customers that did not purchase the game on Steam. (This may include legitimate sources such as other digital stores, retail stores, testing purposes, or press review purposes. Or, from inappropriate sources such as copies given in exchange for reviews.)"><img src="https://store.cloudflare.steamstatic.com/public/shared/images/ico/icon_questionmark_dark.png"></a></label>
					</p>
				</div>
			</div>
						<div>
				<p>Language</p>
				<div>
						<p>
						<label for="review_language_all">All Languages&nbsp;<span>(601)</span></label><br>
						
						<label for="review_language_mine">Your Languages&nbsp;<span>(341)</span> <a data-tooltip-html="Your preferences are currently set to show content authored in these languages: English.<br><br> Click 'customize' below to modify your preferences."><img src="https://store.cloudflare.steamstatic.com/public/shared/images/ico/icon_questionmark_dark.png"></a></label></p>
					</div>
			</div>
						<div id="reviews_date_range_menu">
				<p>Date Range</p>
				<div>
						<div><p>
							To view reviews within a date range, please click and drag a selection on a graph above or click on a specific bar.							</p><p>
							<span onclick="SetReviewsGraphVisibility( true ); "><span>Show graph</span></span></p></div>
						<p>
						<label for="review_date_range_all">Lifetime</label><br>
						
						<label for="review_date_range_histogram">Only Specific Range (Select on graph above)&nbsp;</label><br>
						
						<label for="review_date_range_exclude_histogram">Exclude Specific Range (Select on graph above)&nbsp;</label><br>
					</p></div>
			</div>
						<div>
				<p>Playtime</p>
				<div>
						<p>
							Filter reviews by the user's playtime when the review was written:						</p>

													<p>
							<label for="review_playtime_preset_0">No Minimum</label><br>
														
							<label for="review_playtime_preset_1">Over 1 hour</label><br>
														
							<label for="review_playtime_preset_10">Over 10 hours</label></p><p><span id="app_reviews_playtime_range_text_min">No minimum</span> to <span id="app_reviews_playtime_range_text_max">No maximum</span>
						</p>
						

						<p>
							<label for="review_playtime_type_all">Played across all devices</label><br>
							
							<label for="review_playtime_type_deck">Played mostly on Steam Deck</label>
						</p>

					</div>
			</div>
						<div>
				<p>Display</p>
				<div>
						<p>
							Show reviews in selected display order						</p>

						<p>
						<label for="review_context_summary">Summary</label><br>
						
						<label for="review_context_most_helpful">Most Helpful</label><br>
						
						<label for="review_context_recent">Recent</label><br>
						
						<label for="review_context_funny">Funny</label></p><p><label>&nbsp;Use new helpfulness system. Only applies to Summary and Most Helpful views.</label><br>
							<a href="https://store.steampowered.com/news/app/593110/view/4326355263805583415?snr=1_5_9_">Learn More</a>						</p>
											</div>
			</div>

			

			<p><span id="review_show_graph_button" onclick="SetReviewsGraphVisibility( true ); "><span>Show graph</span> </span>
				<span id="review_hide_graph_button" onclick="SetReviewsGraphVisibility( false ); "><span>Hide graph</span> </span>
			</p>

			
		</div>

		<div id="reviews_active_filters" data-panel="{&quot;focusable&quot;:true,&quot;clickOnActivate&quot;:true}" onclick="ShowReviewSettingsModal();">
				<p>Filters</p>

								
								
				
				
				
				<p>Excluding Off-topic Review Activity</p>
				<p>Playtime: <span id="review_playtime_preset_text"></span></p>
				<p>Played Mostly on Steam Deck</p>
			</div>

		

		
		
		
		
		


		
		
		
		
		
		
		
		

						</div>

					
		

			</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Wired is dropping paywalls for FOIA-based reporting. Others should follow (403 pts)]]></title>
            <link>https://freedom.press/issues/wired-is-dropping-paywalls-for-foia-based-reporting-others-should-follow/</link>
            <guid>43399138</guid>
            <pubDate>Tue, 18 Mar 2025 13:21:22 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://freedom.press/issues/wired-is-dropping-paywalls-for-foia-based-reporting-others-should-follow/">https://freedom.press/issues/wired-is-dropping-paywalls-for-foia-based-reporting-others-should-follow/</a>, See on <a href="https://news.ycombinator.com/item?id=43399138">Hacker News</a></p>
<div id="readability-page-1" class="page"><article>
  

  
  
  

  <section>
              
                
                  <p data-block-key="a10r4">The news business isn’t just any business — it serves a vital role in our democracy, recognized by the First Amendment. But media outlets can’t serve that role if they’re bankrupt. And as a result, news readers often find themselves blocked by paywalls from reading important stories about government business.</p><p data-block-key="cvf2a">That experience is particularly frustrating for readers who are unable to access the groundbreaking investigative reports outlets like <a href="https://www.wired.com/">Wired</a> magazine have been publishing, particularly over the first couple months of the Trump administration. Fortunately, Wired has a solution — it’s going to <a href="https://view.newsletters.cnn.com/messages/1742302072850a6bb40ceb62e/raw?utm_source=cnn_Reliable+Sources+%E2%80%93+March+18%2C+2025&amp;utm_medium=email&amp;bt_ee=yRz8lyYTdmF5KL6oF7kNSxmAt7%2BvkjCBRdNCN%2BFRvyeUW5Nt0j27VZ%2BOJJ9QAAY4&amp;bt_ts=1742302072852">stop paywalling articles that are primarily based on public records</a> obtained through the Freedom of Information Act.</p><p data-block-key="v36m">This approach makes <a href="https://freedom.press/issues/journalists-post-public-records-without-paywalls/">a lot of sense</a> from the standpoint of civil duty. They’re called public records for a reason, after all. And access to public documents is more important than ever at this moment, with government websites and records disappearing, Elon Musk’s Department of Government Efficiency doing its best to operate outside the public’s view, and the National Archives in disarray.</p><p data-block-key="5g3bf">But some may argue that, from a business standpoint, not charging for stories primarily relying on public records automatically means fewer subscriptions and therefore less revenue. We disagree. Sure, the FOIA process is time- and labor-intensive. Reporters face stonewalling, baseless denials, lengthy appeals processes, and countless other obstacles and delays. Investigative reports based on public records are among the most expensive stories to produce and share with the public.</p><p data-block-key="3anle">And yes, publishers rely on subscriptions to cover those costs — which will only increase as a result of anti-press attacks by the Trump administration. But while some readers might not subscribe to outlets that give away some of their best journalism for free, it’s just as possible that readers will recognize this sacrifice and reward these outlets with more traffic and subscriptions in the long run.</p><p data-block-key="bjnup">We commend Wired for tipping the balance that all for-profit media outlets must strike between public interest and business more toward the public interest. We <a href="https://freedom.press/issues/journalists-post-public-records-without-paywalls/">hope others</a> will follow its lead (and shoutout to outlets like <a href="https://www.404media.co/welcome-to-404-media/">404 Media</a> that also make their FOIA-based reporting available for free).</p><p data-block-key="ap74o">We also hope those who stand to benefit from these outlets’ leadership (that’s you, reader) will do their part and subscribe if you can afford it. They’re not asking for an arm and a leg. Wired is <a href="https://www.wired.com/v2/offers/wira01013?source=Site_0_EDT_WIR_SUPERFAN_0_PressFreedom__ZZ">offering</a> digital subscriptions for $10 annually at the moment. You probably spent that on a mediocre sandwich this year.</p><p data-block-key="8j8k7">The Fourth Estate needs to step up and invest in serving the public during these unprecedented times. And the public needs to return the favor and support quality journalism, so that hopefully one day we can do away with those annoying paywalls altogether.</p><p data-block-key="akc29"><b><i>Editor’s note:</i></b> <i>Katie Drummond, global editorial director of Wired, is a board member at Freedom of the Press Foundation (FPF).</i></p>
                
              
            </section>
</article></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Java 24 (115 pts)]]></title>
            <link>https://jdk.java.net/24/</link>
            <guid>43398999</guid>
            <pubDate>Tue, 18 Mar 2025 13:08:19 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://jdk.java.net/24/">https://jdk.java.net/24/</a>, See on <a href="https://news.ycombinator.com/item?id=43398999">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="main">
<h2>OpenJDK JDK 24 General-Availability Release</h2>
<p>This page provides production-ready open-source builds of the
<a href="http://openjdk.org/projects/jdk/24/">Java Development Kit,
version 24</a>, an implementation of the <a href="http://openjdk.org/projects/jdk/24/spec/">Java&nbsp;SE&nbsp;24
Platform</a> under the <a href="http://openjdk.org/legal/gplv2+ce.html">GNU General Public
License, version&nbsp;2, with the Classpath Exception</a>.</p>
<p>Commercial builds of JDK 24 from Oracle, under a <a href="https://www.java.com/freeuselicense">non-open-source license</a>,
can be found <a href="https://www.oracle.com/javadownload">here</a>.</p>
<h2>Documentation</h2>
<ul>
<li><a href="http://openjdk.org/projects/jdk/24/">Features</a></li>
<li><a href="https://jdk.java.net/24/release-notes">Release notes</a></li>
<li><a href="https://docs.oracle.com/en/java/javase/24/docs/api/index.html">API
Javadoc</a></li>
</ul>
<h2>Builds</h2>
<blockquote>
<table summary="builds">
<tbody><tr>
<th>Linux / AArch64</th>
<td><a href="https://download.java.net/java/GA/jdk24/1f9ff9062db4449d8ca828c504ffae90/36/GPL/openjdk-24_linux-aarch64_bin.tar.gz">
tar.gz</a> <span>(<a href="https://download.java.net/java/GA/jdk24/1f9ff9062db4449d8ca828c504ffae90/36/GPL/openjdk-24_linux-aarch64_bin.tar.gz.sha256">sha256</a>)</span></td>
<td><span>210076422</span></td>
</tr>
<tr>
<th>Linux / x64</th>
<td><a href="https://download.java.net/java/GA/jdk24/1f9ff9062db4449d8ca828c504ffae90/36/GPL/openjdk-24_linux-x64_bin.tar.gz">
tar.gz</a> <span>(<a href="https://download.java.net/java/GA/jdk24/1f9ff9062db4449d8ca828c504ffae90/36/GPL/openjdk-24_linux-x64_bin.tar.gz.sha256">sha256</a>)</span></td>
<td><span>212235746</span></td>
</tr>
<tr>
<th>macOS / AArch64</th>
<td><a href="https://download.java.net/java/GA/jdk24/1f9ff9062db4449d8ca828c504ffae90/36/GPL/openjdk-24_macos-aarch64_bin.tar.gz">
tar.gz</a> <span>(<a href="https://download.java.net/java/GA/jdk24/1f9ff9062db4449d8ca828c504ffae90/36/GPL/openjdk-24_macos-aarch64_bin.tar.gz.sha256">sha256</a>)</span></td>
<td><span>205831723</span></td>
</tr>
<tr>
<th>macOS / x64</th>
<td><a href="https://download.java.net/java/GA/jdk24/1f9ff9062db4449d8ca828c504ffae90/36/GPL/openjdk-24_macos-x64_bin.tar.gz">
tar.gz</a> <span>(<a href="https://download.java.net/java/GA/jdk24/1f9ff9062db4449d8ca828c504ffae90/36/GPL/openjdk-24_macos-x64_bin.tar.gz.sha256">sha256</a>)</span></td>
<td><span>208221071</span></td>
</tr>
<tr>
<th>Windows / x64</th>
<td><a href="https://download.java.net/java/GA/jdk24/1f9ff9062db4449d8ca828c504ffae90/36/GPL/openjdk-24_windows-x64_bin.zip">
zip</a> <span>(<a href="https://download.java.net/java/GA/jdk24/1f9ff9062db4449d8ca828c504ffae90/36/GPL/openjdk-24_windows-x64_bin.zip.sha256">sha256</a>)</span></td>
<td><span>211589892</span></td>
</tr>
</tbody></table>
</blockquote>
<h2>Notes</h2>
<ul>
<li>
<p>If you have difficulty downloading any of these files please
contact <a href="mailto:download-help@openjdk.org">download-help@openjdk.org</a>.</p>
</li>
</ul>
<h2>Feedback</h2>
<p>If you have suggestions or encounter bugs, please submit them
using <a href="http://bugreport.java.com/">the usual Java SE
bug-reporting channel</a>. Be sure to include complete version
information from the output of the <code>java --version</code>
command.</p>
<h2>International use restrictions</h2>
<p>Due to limited intellectual property protection and enforcement
in certain countries, the source code may only be distributed to an
authorized list of countries. You will not be able to access the
source code if you are downloading from a country that is not on
this list. We are continuously reviewing this list for addition of
other countries.</p>
</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Google announces agreement to acquire Wiz (218 pts)]]></title>
            <link>https://blog.google/inside-google/company-announcements/google-agreement-acquire-wiz/</link>
            <guid>43398780</guid>
            <pubDate>Tue, 18 Mar 2025 12:47:30 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://blog.google/inside-google/company-announcements/google-agreement-acquire-wiz/">https://blog.google/inside-google/company-announcements/google-agreement-acquire-wiz/</a>, See on <a href="https://news.ycombinator.com/item?id=43398780">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-component="uni-article-paragraph" data-analytics-module="{
           &quot;module_name&quot;: &quot;Paragraph&quot;,
           &quot;section_header&quot;: &quot;Google announces agreement to acquire Wiz&quot;
         }"><p data-block-key="ez36t"><i>Today we announced an agreement to acquire Wiz. Read our press release below, and learn more about what this means for Cloud customers and partners</i> <a href="https://cloud.google.com/blog/products/identity-security/google-announces-agreement-acquire-wiz"><i>on the Cloud blog</i></a><i>.</i></p><p data-block-key="5pg3r">MOUNTAIN VIEW, Calif. and NEW YORK, N.Y. (March 18, 2025)—Google LLC today announced it has signed a definitive agreement to acquire Wiz, Inc., a leading cloud security platform headquartered in New York, for $32 billion, subject to closing adjustments, in an all-cash transaction. Once closed, Wiz will join Google Cloud.</p><p data-block-key="betsk">This acquisition represents an investment by Google Cloud to accelerate two large and growing trends in the AI era: improved cloud security and the ability to use multiple clouds (multicloud).</p><p data-block-key="bgq0o">Both cybersecurity and cloud computing are rapidly growing industries with a vast range of solutions. The increased role of AI, and adoption of cloud services, have dramatically changed the security landscape for customers, making cybersecurity increasingly important in defending against emergent risks and protecting national security.</p><p data-block-key="abchj">Wiz delivers an easy-to-use security platform that connects to all major clouds and code environments to help prevent cybersecurity incidents. Organizations of all sizes — from start-ups and large enterprises to governments and public sector organizations — can use Wiz to protect everything they build and run in the cloud. Wiz is an innovative leader and continues to deliver new products with strong adoption, fueling rapid business growth, including over the last 12 months in which it has begun to deliver new categories of cybersecurity solutions.</p><p data-block-key="2s0im">Google Cloud is a leader in cloud infrastructure, with deep AI expertise and a track record of industry-leading security innovation. Bringing all this to Wiz will help make their solutions even better and more scalable, benefiting customers and partners across all major clouds. The combination of Google Cloud and Wiz will:<br></p><ul><li data-block-key="4uamp">Vastly improve how security is designed, operated and automated — providing an end-to-end security platform for customers, of all types and sizes, in the AI era;</li><li data-block-key="u7jk">Scale cybersecurity teams by providing them an automated security platform;</li><li data-block-key="5sb52">Lower customers’ cost of implementing and managing security controls;</li><li data-block-key="f4lcl">Protect against new threats emerging due to the advancement of AI, prevent breaches, and help organizations respond to breaches much more efficiently; and</li><li data-block-key="34l89">Boost the adoption of multicloud security and, as a result, customers’ ability to use multiple clouds; further spurring innovation in and the adoption of cloud computing.</li></ul><p data-block-key="109i3">Wiz’s products will continue to work and be available across all major clouds, including Amazon Web Services, Microsoft Azure, and Oracle Cloud platforms, and will be offered to customers through an array of partner security solutions. Google Cloud will also continue to offer customers wide choice through a variety of partner security solutions available in the <a href="https://cloud.google.com/marketplace">Google Cloud Marketplace</a>.</p><p data-block-key="3dirc">You can read more technical details about Wiz’s solutions, and how they will work with Google Cloud, on the <a href="https://cloud.google.com/blog/products/identity-security/google-announces-agreement-acquire-wiz">Google Cloud blog</a> and <a href="https://www.wiz.io/blog/wiz-joining-google">Wiz blog</a>.</p><p data-block-key="f0f35">The deal is subject to customary closing conditions including regulatory approvals.</p><p data-block-key="fmd7o"><b>Webcast</b></p><p data-block-key="drnon">Alphabet Inc. (NASDAQ: GOOG, GOOGL) will host a webcast to discuss this announcement on Tuesday, March 18, at 6:00am Pacific Time (9:00am Eastern Time). Sundar Pichai, CEO, Google and Alphabet; Thomas Kurian, CEO, Google Cloud; Assaf Rappaport, CEO, Wiz; and Anat Ashkenazi, CFO, Google and Alphabet, will discuss the transaction.</p><p data-block-key="3t9b6">The webcast can be accessed here: <a href="https://www.youtube.com/live/8jY5YBSRVEU">https://www.youtube.com/live/8jY5YBSRVEU</a>. A replay will be available for two weeks through the same link following the webcast.</p><p data-block-key="dcibi"><b>Quotes</b></p><p data-block-key="9idj0"><b>Sundar Pichai, CEO, Google:</b> “From its earliest days, Google’s strong security focus has made us a leader in keeping people safe online. Today, businesses and governments that run in the cloud are looking for even stronger security solutions, and greater choice in cloud computing providers. Together, Google Cloud and Wiz will turbocharge improved cloud security and the ability to use multiple clouds.”</p><p data-block-key="9cs0f"><b>Thomas Kurian, CEO, Google Cloud:</b> “Google Cloud and Wiz share a joint vision to make cybersecurity more accessible and simpler to use for organizations of any size and industry. Enabling more companies to prevent cyber attacks, including in very complex business software environments, will help organizations minimize the cost, disruption and hassle caused by cybersecurity incidents.”</p><p data-block-key="57nh6"><b>Assaf Rappaport, Co-Founder &amp; CEO, Wiz:</b> "Wiz and Google Cloud are fully committed to continue supporting and protecting customers across all major clouds, helping keep them safe and secure wherever they operate. This is an exciting moment for our company, but an even more important one for customers and partners, as this acquisition will bolster our mission to improve security and prevent breaches by providing additional resources and deep AI expertise.”</p><p data-block-key="37ho9"><b>Contacts</b></p><p data-block-key="c56j7">Investors:</p><p data-block-key="7n59d">investor-relations@abc.xyz</p><p data-block-key="alhm2">Press:</p><p data-block-key="e79es">press@google.com</p><p data-block-key="1d8ns"><b>About Google</b></p><p data-block-key="4r5cf">Google’s mission is to organize the world’s information and make it universally accessible and useful. Through products and platforms like Search, Maps, Gmail, Android, Google Play, Chrome and YouTube, Google plays a meaningful role in the daily lives of billions of people and has become one of the most widely-known companies in the world. Google is a subsidiary of Alphabet Inc.</p><p data-block-key="esv1d"><b>About Google Cloud</b></p><p data-block-key="ah95">Google Cloud is the new way to the cloud, providing AI, infrastructure, developer, data, security, and collaboration tools built for today and tomorrow. Google Cloud offers a powerful, fully integrated and optimized AI stack with its own planet-scale infrastructure, custom-built chips, generative AI models and development platform, as well as AI-powered applications, to help organizations transform. Customers in more than 200 countries and territories turn to Google Cloud as their trusted technology partner.</p><p data-block-key="fon0i"><b>About Wiz</b></p><p data-block-key="b2pe4">Wiz secures everything organizations build and run in the cloud and transforms security by enabling a new operating model. The Wiz CNAPP empowers security and development teams to rapidly identify and remove critical risks in cloud environments, so they can build fast and securely. With Wiz, organizations can prioritize risk and stay agile. Its customers include Agoda, Avery Dennison, BMW, Cushman &amp; Wakefield, DocuSign, Mars, Plaid, Priceline, Salesforce, and Slack, among others. The company is backed by Advent, Aglaé, Andreessen Horowitz, Blackstone, Cyberstarts, Greenoaks, Greylock, Index Ventures, Insight Partners, Lightspeed, Salesforce, Sequoia, Thrive Capital, and Wellington.</p><p data-block-key="bmc5b"><b>Forward-Looking Statements</b></p><p data-block-key="cn9ll">This release includes forward-looking statements within the meaning of the Private Securities Litigation Reform Act of 1995 regarding the acquisition of Wiz by Google. These forward-looking statements are based on current expectations and assumptions that are subject to risks and uncertainties, which could cause Alphabet Inc.'s (the "company", "we", "us" or "our") actual results to differ materially from those reflected in the forward-looking statements. Factors that could cause or contribute to such differences include, but are not limited to, the risk that the closing conditions for the acquisition will not be satisfied, including the risk that the requisite regulatory approvals will not be obtained; the risk that the definitive agreement relating to the acquisition will be terminated prior to closing; the possibility that the acquisition will not be completed in the expected timeframe or at all; potential adverse effects to the businesses of the company or Wiz during the pendency of the acquisition; our ability to successfully integrate Wiz or other businesses that we may acquire in the future; our ability to achieve the benefits that we expect to realize as a result of the acquisition of Wiz; the potential negative impact on our financial condition and results of operations if we fail to achieve the benefits that we expect to realize as a result of the acquisition of Wiz or if these benefits take longer to achieve than expected; and other risks and uncertainties discussed in the reports the company has filed previously with the SEC, such as its Annual Report on Form 10-K. We undertake no obligation to revise or publicly release the results of any revision to these forward-looking statements, which speak as of the respective date of this release, except as required by law. Given these risks and uncertainties, readers are cautioned not to place undue reliance on such forward-looking statements.</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Stamina Is a Quiet Advantage (128 pts)]]></title>
            <link>https://kupajo.com/stamina-is-a-quiet-advantage/</link>
            <guid>43398589</guid>
            <pubDate>Tue, 18 Mar 2025 12:25:52 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://kupajo.com/stamina-is-a-quiet-advantage/">https://kupajo.com/stamina-is-a-quiet-advantage/</a>, See on <a href="https://news.ycombinator.com/item?id=43398589">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-node="ch78d0t3zn46">
		<p>Stamina usually has a physical and competitive connotation — those with greater stamina can outwork and outlast opponents.</p>
<p>While stamina is the ability to sustain focused effort despite pain or discomfort, you should also think of it as the ability to stay true to your values and commitments — to hold <a href="https://kupajo.com/do-the-right-things-quietly/">fidelity to a worthy purpose</a> — especially when it’s hard to do so.</p>
<p>Stamina, in this way, is not just the thing you deploy to <a href="https://kupajo.com/its-good-to-quiver-under-the-bar/">keep running when your legs have gone volcanic</a>. It’s contributing as part of a team that, let’s say, has posed a challenging experience for all involved. It’s returning for another go at a problem that has repeatedly turned your mind into oatmeal (the kind with that creepy skin after it’s been left out awhile). It’s being a patient parent or partner despite bone-deep exhaustion.</p>
<p>It’s the ability to chip away at goals despite a lack of visible progress. To hold focus and presence in a world incentivized to distract you. To stay patient. To be on time. To push through difficult material. To follow instructions or proceed without them. To keep an open mind and be willing to renew your perspective.</p>
<p>Stamina is one of the most universally useful traits you can develop — it’s a more broadly applicable advantage than things that are situationally useful, like strength, intelligence, speed, popularity, motivation, etc.</p>
<p>Maybe a smarter, more naturally gifted person can be sporadically brilliant, and solve a tough problem way faster than you. But you, with your staying power, can more capably and reliably solve the 100 problems that follow.</p>
<blockquote><p>“[Happiness] is not attained through self-gratification, but through fidelity to a worthy purpose.”</p>
<p>~Helen Keller</p></blockquote>
	</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Google to buy Wiz for $32B (325 pts)]]></title>
            <link>https://www.reuters.com/technology/cybersecurity/google-agrees-buy-cybersecurity-startup-wiz-32-bln-ft-reports-2025-03-18/</link>
            <guid>43398518</guid>
            <pubDate>Tue, 18 Mar 2025 12:18:29 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.reuters.com/technology/cybersecurity/google-agrees-buy-cybersecurity-startup-wiz-32-bln-ft-reports-2025-03-18/">https://www.reuters.com/technology/cybersecurity/google-agrees-buy-cybersecurity-startup-wiz-32-bln-ft-reports-2025-03-18/</a>, See on <a href="https://news.ycombinator.com/item?id=43398518">Hacker News</a></p>
Couldn't get https://www.reuters.com/technology/cybersecurity/google-agrees-buy-cybersecurity-startup-wiz-32-bln-ft-reports-2025-03-18/: Error: Request failed with status code 401]]></description>
        </item>
        <item>
            <title><![CDATA[Show HN: I made a live multiplayer Minesweeper game (142 pts)]]></title>
            <link>https://www.minesweeperpro.com/</link>
            <guid>43398081</guid>
            <pubDate>Tue, 18 Mar 2025 11:17:44 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.minesweeperpro.com/">https://www.minesweeperpro.com/</a>, See on <a href="https://news.ycombinator.com/item?id=43398081">Hacker News</a></p>
Couldn't get https://www.minesweeperpro.com/: Error: Request failed with status code 403]]></description>
        </item>
        <item>
            <title><![CDATA[The Model Is the Product (206 pts)]]></title>
            <link>https://vintagedata.org/blog/posts/model-is-the-product</link>
            <guid>43397474</guid>
            <pubDate>Tue, 18 Mar 2025 09:56:37 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://vintagedata.org/blog/posts/model-is-the-product">https://vintagedata.org/blog/posts/model-is-the-product</a>, See on <a href="https://news.ycombinator.com/item?id=43397474">Hacker News</a></p>
<div id="readability-page-1" class="page"><section id="page-wrapper">
                                            
                                            
<p>There were a lot of speculation over the past years about what the next cycle of AI development could be. Agents? Reasoners? Actual multimodality? </p>
<p>I think it's time to call it: the model is the product.</p>
<p>All current factors in research and market development push in this direction.</p>
<ul>
<li>Generalist scaling is stalling. This was the whole message behind the release of GPT-4.5: capacities are growing linearly while compute costs are on a geometric curve. Even with all the efficiency gains in training and infrastructure of the past two years, OpenAI can't deploy this giant model with a remotely affordable pricing.</li>
<li>Opinionated training is working <em>much</em> better than expected. The combination of reinforcement learning and reasoning means that models are suddenly learning tasks. It's not machine learning, it's not base model either, it's a secret third thing. It's even tiny models getting suddenly scary good at math. It's coding model no longer just generating code but managing an entire code base by themselves. It's Claude playing Pokemon with very poor contextual information and no dedicated training.</li>
<li>Inference cost are in free fall. The recent optimizations from DeepSeek means that all the available GPUs could cover a demand of 10k tokens per day from a frontier model for… the entire earth population. There is nowhere this level of demand. The economics of selling tokens does not work anymore for model providers: they have to move higher up in the value chain.</li>
</ul>
<p>This is also an uncomfortable direction. All investors have been betting on the application layer. In the next stage of AI evolution, the application layer is likely to be the first to be automated and disrupted.</p>
<h2>Shapes of models to come.</h2>
<p>Over the past weeks, we have seen two prime example of this new generation of models as a product: OpenAI's DeepResearch and Claude Sonnet 3.7.</p>
<p>I've read a lot of misunderstandings about DeepResearch, which isn't helped by the multiplication of open and closed clones. OpenAI has not built a wrapper on top of O3. They have <a href="https://cdn.openai.com/deep-research-system-card.pdf">trained an entirely new model</a>, able to perform search internally, without any external calls, prompts or orchestration:</p>
<blockquote>
<p>The model learned the core browsing capabilities (searching, clicking, scrolling, interpreting files) (…) and how to reason to synthetize a large number of websites to find specific pieces of information or write comprehensive reports through reinforcement learning training on these browsing tasks.</p>
</blockquote>
<p>DeepResearch is not a standard LLM, nor a standard chatbot. It's a new form of <em>research language model</em>, explicitly designed to perform search tasks end to end. The difference is immediately striking to everyone using it seriously: the model generate lengthy reports with consistent structure and underlying source analysis process. In comparison as Hanchung Lee <a href="https://leehanchung.github.io/blogs/2025/02/26/deep-research/">underlined</a> all the other DeepSearch, including the Perplexity and Google variant, are just your usual models with a few twists:</p>
<blockquote>
<p>Google’s Gemini and Perplexity’s chat assistants also offer “Deep Research” features, but neither has published any literature on how they optimized their models or systems for the task or any substaintial quantitative evaluations (…) We will make an assumption that the fine-tuning work done is non-substantial.</p>
</blockquote>
<p>Anthropic has been laying their current vision ever clearer. In December, they introduced a controversial but, to my mind, correct <a href="https://www.anthropic.com/research/building-effective-agents">definition</a> of agent models. Similarly to DeepSearch, an agent has to perform the targeted tasks internally: they "dynamically direct their own processes and tool usage, maintaining control over how they accomplish tasks". </p>
<p>What most agent startups are currently building is not agents, it's workflows, that is "systems where LLMs and tools are orchestrated through predefined code paths." Workflows may still bring some value, especially for vertical adaptations. Yet, to anyone currently working in the big labs it's strikingly obvious that all major progress in autonomous systems will be through redesigning the models in the first place.</p>
<p>We had a very concrete demonstration of this with the release of Claude 3.7, a model primarily trained with complex code use cases in mind. All the workflow adaptation like Devin had a major boost on SWE benchmarks.</p>
<p>To give it another example done at a much smaller scale: at Pleias we're currently working on automating RAG. Current RAG systems are a lot of interconnected yet brittle workflows: routing, chunking reranking, query interpretation, query expansion, source contextualization, search engineering. With the evolving training tech stack, there is a real potential to bundle all theses processes in two separate yet interconnected models, one for data preparation and the other for search/retrieval/report generation. This requires an elaborated synthetic pipeline and entirely new reward functions for reinforcement learning. Actual training, actual research.</p>
<p>What all this all means in practice: displacing complexity. Training anticipates a wide range of actions and edge cases, so that deployment becomes much more simple. But in this process most of the value is now created and, likely in the end, captured by the model trainer. In short, what Claude aims to disrupt and replace the current workflows like this basic "agent" system from llama index:</p>
<p><img src="https://huggingface.co/datasets/Pclanglais/course-material/resolve/main/llama_index.png" alt="Llama Index Basic Agent"></p>
<p>With this:</p>
<p><img src="https://huggingface.co/datasets/Pclanglais/course-material/resolve/main/claude.png" alt="Claude Agent"></p>
<h2>Training or being trained on.</h2>
<p>To reassert: the big labs are not advancing with an hidden agenda. While they can be opaque at time, they laying it all in the open: they will bundle, they will go up the application layer and they will attempt to capture most of the value there. And the commercial consequences are quite clear. Naveen Rao, the Gen AI VP of Databricks, <a href="https://x.com/NaveenGRao/status/1886544584588619840">phrased it quite well</a>:</p>
<blockquote>
<p>all closed AI model providers will stop selling APIs in the next 2-3 years. Only open models will be available via APIs (…) Closed model providers are trying to build non-commodity capabilities and they need great UIs to deliver those. It's not just a model anymore, but an app with a UI for a purpose.</p>
</blockquote>
<p>So what is happening right now is just a lot of denial. The honeymoon period between model providers and wrappers is over. Things could evolve in both direction:</p>
<ul>
<li>Claude Code and DeepSearch are early technical and product experiments in this direction. You will notice that DeepSearch is not available through an API, only used to create value for the premium subscriptions. Claude Code is a minimalistic terminal integration. Weirdly enough, while Claude 3.7 works perfectly in Claude Code, Cursor struggles with it and I've already seen several high end users cancelling their subscriptions as a result. Actual LLM agents doesn't care about pre-existing workflows: they replace it.</li>
<li>The most high profile wrapper are now scrambling to become hybrid AI training companies. They do have some training capacities, though very little advertised. One of Cursor main assets is their small autocompletion model. WindSurf has their internal cheap code model, Codium. Perplexity always relied on home classifiers for routing and recently pivoted to train their own DeepSeek variant for search purposes.</li>
<li>For smaller wrappers, not much will change, except likely increased reliance on agnostic inference providers if the big labs entirely let go of this market. I do also expect to see much more focus on UI which is still dramatically underestimated, as even more generalist models are likely to bundle common deployment takss, especially for RAG.</li>
</ul>
<p>In short the dilemma for most successful wrappers is simple: training or being trained on. What they are doing right now is both free market research for the big labs but, even, as all outputs is ultimately generated through model providers, free data design and generation. </p>
<p>What will happen afterwards is anyone guess. Successful wrappers do have the advantage of knowing their vertical well and accumiulating a lot of precious user feedbacks. Yet, in my experience, it's easier to go down from the model to application layers than building an entirely new training capacities from scratch. Wrappers may not have been helped by their investors either. From what I overheard, there is such a negative polarization against training, they almost have to hide what is going to be their most critical value: neither cursor small nor codium are properly documented at this moment.</p>
<h2>Reinforcement learning was not priced in.</h2>
<p>This brings me to the actual painful part: currently all AI investments are correlated. Funds are operating under the following assumptions:</p>
<ul>
<li>The real value lay exclusively in an application layer independent from the model layer that is best positioned to disrupt existing market.</li>
<li>Model providers will only sell tokens at an ever lowering price, making wrappers in turn more profitable.</li>
<li>Close models wrapping will satisfy all the existing demands, even in regulated sectors with long lasting concerns over external dependencies.</li>
<li>Building any training capacity is just a waste of time. This does not include only pre-training but all forms of training.</li>
</ul>
<p>I'm afraid this increasingly look like an adventurous bet and an actual market failure to accurately price the latest technical developments, especially in RL. In the current economic ecosystem, venture funds are meant to find uncorrelated investments. They will not beat S&amp;P500 but that's not what larger institutional investors are looking for: they want to bundle risks, ensure that in a bad year at least some things will work out. Model training is like a textbook perfect example for this: lots of potential for disruption in a context where most western economies are on course for a recession. And yet model trainers can't raise, or at least not in the usual way. Prime Intellect is one of the few new western ai training companies that has a clear potential to become a frontier lab. Yet, despite their achievements including the training of the first decentralized LLM, they struggled to raise more than your usual wrapper.</p>
<p>Beyond that, aside from the big lab, the current training ecosystem is very tiny. You can count all theses companies on your hands: Prime Intellect, Moondream, Arcee, Nous, Pleias, Jina, the HuggingFace pretraining team (actually tiny)… Along with a few more academic actors (Allen AI, Eleuther…) they build and support most of the current open infrastructure for training. In Europe, I know that at least 7-8 LLM projects will integrate the Common Corpus and some of the pretraining tools we developed at Pleias — and the rest will be fineweb, and likely post-training instruction sets from Nous or Arcee. </p>
<p>There is something deeply wrong in the current funding environment. Even OpenAI senses it now. Lately, there was some <a href="https://x.com/khoomeik/status/1892743475843813680">felt irritation</a> at the lack of "vertical RL" in the current Silicon Valley startup landscape. I believe the message comes straight from Sam Altman and will likely result in some adjustment in the next YC batch but pinpoint to a larger shift: soon the big labs select partners won't be API customers but associated contractors involved in the earlier training stage. </p>
<p>If the model is the product, you cannot necessarily build it alone. Search and code are easy low hanging fruits: major use cases for two years, the market is nearly mature and you can ship a new cursor in a few months. Now many of the most lucrative AI uses cases in the future are not at this advanced stage of development — typically, think about all these rule based system that still rule most of the world economy… Small dedicated teams with a cross-expertise and a high level of focus may be best positioned to tackle this— eventually becoming potential acquihire once the initial ground work is done. We could see the same pipeline in the UI side. Some preferred partner, getting exclusive API access to close specialized models, provided they get on the road for business acquisition.</p>
<p>I haven't mentioned DeepSeek, nor Chinese labs so far. Simply because DeepSeek is already one step further: not model as a product, but as a universal infrastructure layer. Like OpenAI and Anthropic, Lian Wenfeng <a href="https://www.lesswrong.com/posts/kANyEjDDFWkhSKbcK/two-interviews-with-the-founder-of-deepseek">lays his plans in the open</a>:</p>
<blockquote>
<p>We believe that the current stage is an explosion of technological innovation, not an explosion of applications (…) If a complete upstream and downstream industrial ecosystem is formed, then there is no need for us to make applications ourselves. Of course, there is no obstacle for us to make applications if needed, but research and technological innovation will always be our first priority.</p>
</blockquote>
<p>At this stage, working only on applications is like "fighting the next wars with last war generals". I'm afraid we're at the point where many in the west are not even aware the last war is over.</p>

                </section></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Please stop externalizing your costs directly into my face (185 pts)]]></title>
            <link>https://drewdevault.com/2025/03/17/2025-03-17-Stop-externalizing-your-costs-on-me.html</link>
            <guid>43397361</guid>
            <pubDate>Tue, 18 Mar 2025 09:42:12 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://drewdevault.com/2025/03/17/2025-03-17-Stop-externalizing-your-costs-on-me.html">https://drewdevault.com/2025/03/17/2025-03-17-Stop-externalizing-your-costs-on-me.html</a>, See on <a href="https://news.ycombinator.com/item?id=43397361">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
  <article>
    <p>Over the past few months, instead of working on our priorities at SourceHut, I
have spent anywhere from 20-100% of my time in any given week mitigating
hyper-aggressive LLM crawlers at scale. This isn’t the first time SourceHut has
been at the wrong end of some malicious bullshit or paid someone else’s
externalized costs – every couple of years someone invents a new way of ruining
my day.</p>
<p>Four years ago, we decided to <a href="https://man.sr.ht/ops/builds.sr.ht-migration.md">require payment to use our CI services</a>
because it was being abused to mine cryptocurrency. We alternated between
periods of designing and deploying tools to curb this abuse and periods of
near-complete outage when they adapted to our mitigations and saturated all of
our compute with miners seeking a profit. It was bad enough having to beg my
friends and family to avoid “investing” in the scam without having the scam
break into my business and trash the place every day.</p>
<p>Two years ago, we threatened to <a href="https://sourcehut.org/blog/2023-01-09-gomodulemirror/">blacklist the Go module mirror</a> because for
some reason the Go team thinks that running terabytes of git clones all day,
every day for every Go project on git.sr.ht is cheaper than maintaining any
state or using webhooks or coordinating the work between instances or even just
designing a module system that doesn’t require Google to DoS git forges whose
entire annual budgets are considerably smaller than a single Google engineer’s
salary.</p>
<p>Now it’s LLMs. If you think these crawlers respect robots.txt then you are
several assumptions of good faith removed from reality. These bots crawl
everything they can find, robots.txt be damned, including expensive endpoints
like git blame, every page of every git log, and every commit in every repo, and
they do so using random User-Agents that overlap with end-users and come from
tens of thousands of IP addresses – mostly residential, in unrelated subnets,
each one making no more than one HTTP request over any time period we tried to
measure – actively and maliciously adapting and blending in with end-user
traffic and avoiding attempts to characterize their behavior or block their
traffic.</p>
<p>We are experiencing dozens of brief outages per week, and I have to review our
mitigations several times per day to keep that number from getting any higher.
When I do have time to work on something else, often I have to drop it when all
of our alarms go off because our current set of mitigations stopped working.
Several high-priority tasks at SourceHut have been delayed weeks or even months
because we keep being interrupted to deal with these bots, and many users have
been negatively affected because our mitigations can’t always reliably
distinguish users from bots.</p>
<p>All of my sysadmin friends are dealing with the same problems. I was asking one
of them for feedback on a draft of this article and our discussion was
interrupted to go deal with a new wave of LLM bots on their own server. Every
time I sit down for beers or dinner or to socialize with my sysadmin friends
it’s not long before we’re complaining about the bots and asking if the other
has cracked the code to getting rid of them once and for all. The desperation in
these conversations is palpable.</p>
<p>Whether it’s cryptocurrency scammers mining with FOSS compute resources or
Google engineers too lazy to design their software properly or Silicon Valley
ripping off all the data they can get their hands on at everyone else’s expense…
I am sick and tired of having all of these costs externalized directly into my
fucking face. Do something productive for society or get the hell away from my
servers. Put all of those billions and billions of dollars towards the common
good before sysadmins collectively start a revolution to do it for you.</p>
<p>Please stop legitimizing LLMs or AI image generators or GitHub Copilot or any of
this garbage. I am begging you to stop using them, stop talking about them, stop
making new ones, just <em>stop</em>. If blasting CO<sub>2</sub> into the air and
ruining all of our freshwater and traumatizing cheap laborers and making every
sysadmin you know miserable and ripping off code and books and art at scale and
ruining our fucking democracy isn’t enough for you to leave this shit alone,
what is?</p>
<p>If you personally work on developing LLMs et al, know this: I will never work
with you again, and I will remember which side you picked when the bubble
bursts.</p>

  </article>
</div><section>
  <h2>
    Articles from blogs I read
    <small>
      Generated by
      <a href="https://git.sr.ht/~sircmpwn/openring">openring</a>
    </small>
  </h2>
  <section>
    
    <div>
      <h4>
        <a href="https://blog.brixit.nl/after-fosdem-videobox-updates/" target="_blank" rel="noopener">After-FOSDEM videobox updates</a>
      </h4>
      <p>The FOSDEM video capture box is a custom device for doing all the in-room stuff for the live-streams of the event. It contains a Radxa x4 SBC, a digital audio mixer, an HDMI capture card, some USB chargers and a network switch. Every room that is  livestr…</p>
      <p><small>
        via <a href="https://blog.brixit.nl/">BrixIT Blog</a>
      </small>
      <small>March 10, 2025</small>
    </p></div>
    
    <div>
      <h4>
        <a href="https://sourcehut.org/blog/2025-03-07-whats-cooking-q1-25/" target="_blank" rel="noopener">What's cooking on SourceHut? Q1 2025</a>
      </h4>
      <p>Hello all! We’re back with another “What’s cooking”, after another too-long
hiatus since September. We did promise to resume monthly updates, but in
hindsight that seems a bit ambitious given everything on our plate. For now
we’re going to aim for the more m…</p>
      <p><small>
        via <a href="https://sourcehut.org/blog/">Blogs on Sourcehut</a>
      </small>
      <small>March 7, 2025</small>
    </p></div>
    
    <div>
      <h4>
        <a href="https://100r.co/site/log.html#feb2025" target="_blank" rel="noopener">Summary of changes for February 2025</a>
      </h4>
      <p>
Hey everyone!This is the list of all the changes we've done to our projects during the month of February.



Summary Of Changes


  100r.co, added Dinghy gelcoat, Week 10, Week 11, and Week 12 of the Victoria to Sitka logbook. Updated solar with new pictures…</p>
      <p><small>
        via <a href="https://100r.co/">Hundred Rabbits</a>
      </small>
      <small>March 1, 2025</small>
    </p></div>
    
  </section>
</section></div>]]></description>
        </item>
        <item>
            <title><![CDATA[BYD says new fast-charging system could be as quick as filling up a tank (107 pts)]]></title>
            <link>https://www.theguardian.com/technology/2025/mar/18/byd-ev-fast-charging-system-petrol-fuel-speed</link>
            <guid>43396853</guid>
            <pubDate>Tue, 18 Mar 2025 08:21:02 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.theguardian.com/technology/2025/mar/18/byd-ev-fast-charging-system-petrol-fuel-speed">https://www.theguardian.com/technology/2025/mar/18/byd-ev-fast-charging-system-petrol-fuel-speed</a>, See on <a href="https://news.ycombinator.com/item?id=43396853">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="maincontent"><p>Chinese electric vehicle (EV) maker BYD has unveiled a new charging system that it said could make it possible for EVs to charge as quickly as it takes to refill with petrol and announced for the first time that it would build a charging network across <a href="https://www.theguardian.com/world/china" data-link-name="in body link" data-component="auto-linked-tag">China</a>.</p><p>The so-called “super e-platform” will be capable of peak charging speeds of 1,000 kilowatts (kW), enabling cars that use it to travel 400km (249 miles) on a five-minute charge, founder Wang Chuanfu said at an event livestreamed from the company’s Shenzhen headquarters on Monday.</p><figure id="7915ac24-6706-4c57-b4e5-2e3be06d5b96" data-spacefinder-role="richLink" data-spacefinder-type="model.dotcomrendering.pageElements.RichLinkBlockElement"><gu-island name="RichLinkComponent" priority="feature" deferuntil="idle" props="{&quot;richLinkIndex&quot;:2,&quot;element&quot;:{&quot;_type&quot;:&quot;model.dotcomrendering.pageElements.RichLinkBlockElement&quot;,&quot;prefix&quot;:&quot;Related: &quot;,&quot;text&quot;:&quot;‘Tesla is a good target’: Elon Musk’s car business is focus of fury for political role&quot;,&quot;elementId&quot;:&quot;7915ac24-6706-4c57-b4e5-2e3be06d5b96&quot;,&quot;role&quot;:&quot;richLink&quot;,&quot;url&quot;:&quot;https://www.theguardian.com/us-news/2025/mar/17/tesla-protests-elon-musk&quot;},&quot;ajaxUrl&quot;:&quot;https://api.nextgen.guardianapps.co.uk&quot;,&quot;format&quot;:{&quot;design&quot;:0,&quot;display&quot;:0,&quot;theme&quot;:0}}"></gu-island></figure><p>Charging speeds of 1,000 kW would be twice as fast as Tesla’s superchargers, whose latest version offers up to 500 kW charging speeds. Fast-charging technology has been seen as key to increasing EV adoption.</p><p>The news will be unwelcome for already struggling Tesla, whose stock has plunged – down 15% on 10 March alone – in the wake of its owner Elon Musk’s championing of hard-right causes in Europe and slashing of federal workforce as part of his work with the Trump administration.</p><p>Since December, when Tesla’s market value hit a record high of $1.5tn, it has fallen by almost half. Besides missing sales targets, Tesla faces heightened investor pressure to produce autonomous vehicles, which Musk has promised but failed to deliver for about a decade. It is also facing increased competition with more affordable EV models, like those produced by BYD and other Chinese companies.</p><p>On Wall Street on Monday, Tesla stock fell 4.8%, its eighth consecutive weekly decline, according to <a href="https://www.barrons.com/articles/tesla-stock-price-musk-ai-model-y-10b333a4" data-link-name="in body link">Barrons</a>.</p><p>“In order to completely solve our users’ charging anxiety, we have been pursuing a goal to make the charging time of electric vehicles as short as the refuelling time of petrol vehicles,” Wang said.</p><p>“This is the first time in the industry that the unit of megawatt (charge) has been achieved on charging power,” he said.</p><p>The new charging architecture will be initially available in two new EVs – Han L sedan and Tang L SUV priced from 270,000 yuan ($37,330) – and BYD said it would build more than 4,000 ultra-fast charging piles, or units, across China to match the new platform.</p><p>The company didn’t specify the time frame or how much it would invest in building such facilities. To date, BYD owners have largely relied on other automakers’ charging facilities or public charging poles run by third-party operators to charge their vehicles.</p><figure data-spacefinder-role="inline" data-spacefinder-type="model.dotcomrendering.pageElements.NewsletterSignupBlockElement"><a data-ignore="global-link-styling" href="#EmailSignup-skip-link-11">skip past newsletter promotion</a><p id="EmailSignup-skip-link-11" tabindex="0" aria-label="after newsletter promotion" role="note">after newsletter promotion</p></figure><p>Tesla has offered its superchargers in China since 2014 and BYD’s smaller Chinese peers such as Nio, Li Auto, Xpeng and Zeekr have also been investing extensively and building charging facilities for years.</p><p>BYD mostly relies on plug-in hybrids for its sales, which hit 4.2m units last year. It has targeted selling 5-6m units this year.</p><p><em>With Reuters</em></p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Moving away from US cloud services (546 pts)]]></title>
            <link>https://martijnhols.nl/blog/moving-away-from-us-cloud-services</link>
            <guid>43396795</guid>
            <pubDate>Tue, 18 Mar 2025 08:09:37 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://martijnhols.nl/blog/moving-away-from-us-cloud-services">https://martijnhols.nl/blog/moving-away-from-us-cloud-services</a>, See on <a href="https://news.ycombinator.com/item?id=43396795">Hacker News</a></p>
<div id="readability-page-1" class="page"><article><div><div><p>Published</p><!-- --> <p><time role="button" tabindex="0" aria-expanded="false" datetime="2025-03-13">2 days ago</time>,</p><!-- --> <p><span>updated <time role="button" tabindex="0" aria-expanded="false" datetime="2025-03-15">today</time></span></p></div><p>For years, using US clouds in the EU has been questionable. <strong>Time and time again, data-sharing agreements between the EU and the US get busted</strong>, showing there's just no legal compatibility between EU privacy rights and US spying laws. Every few years, it's <a href="https://en.wikipedia.org/wiki/PRISM">revealed</a> that the US is <a href="https://www.wired.com/story/congress-spy-powers-fisa-ndaa-trump-702/">spying more</a> than expected. While everyone in the EU kinda knows storing personal data on US clouds is <span role="button" tabindex="0" aria-expanded="false">pretty much impossible to do legally</span>, they figure that since everyone is doing it, even if it's not legal, then <a href="https://blog.iusmentis.com/2025/01/17/mag-ik-ondertussen-data-in-de-cloud-zetten-als-die-fysiek-in-europa-blijft/">at least you'd be wrong with everyone else, so that makes it less bad</a>. And soon, it may become <a href="https://noyb.eu/en/us-cloud-soon-illegal-trump-punches-first-hole-eu-us-data-deal">fully illegal</a>.</p>
<p>But privacy isn't the only concern anymore. With the current political situation in the US, it's also starting to become clear that <strong>our entire digital infrastructure is at the mercy of US policies</strong>. <a href="https://berthub.eu/articles/posts/you-can-no-longer-base-your-government-and-society-on-us-clouds/">It is no longer safe to rely on US clouds for our governments and societies</a>, as the US government can shut it down at will. And it <a href="https://berthub.eu/articles/posts/servers-in-de-eu-eigen-sleutels-helpt-het/#wat-als-er-ruzie-is">doesn't matter</a> whether the servers are in the EU.</p>
<p>This isn't just speculation. In 2019 GitHub started <a href="https://www.zdnet.com/article/github-starts-blocking-developers-in-countries-facing-us-trade-sanctions/">blocking</a> individual developers due to US trade sanctions. More recently, the US imposed new <a href="https://www.theguardian.com/us-news/2025/feb/06/trump-sanction-icc">sanctions on the International Criminal Court</a> in The Netherlands. These sanctions make it illegal for US companies to provide services to <span role="button" tabindex="0" aria-expanded="false">affected persons</span>, essentially cutting them off from US services. This is a huge problem for them; <a href="https://www.theguardian.com/law/2025/jan/20/international-criminal-court-icc-braces-swift-trump-sanctions-over-israeli-arrest-warrants">the ICC fears being cut off from all of their evidence</a>, and <a href="https://www.justiceinfo.net/en/140499-can-the-icc-survive-the-u-s-sanctions-part-2.html#h-a-potential-threat-to-the-very-existence-of-the-court">it may even shut the ICC down</a>.</p>
<p>This sets a dangerous precedent. It increasingly appears that the US government will use tech companies as a weapon.</p>
<p><img alt="Taking the exit with the US cloud" loading="lazy" width="2750" height="1350" decoding="async" data-nimg="1" srcset="https://martijnhols.nl/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fcover.38be4c3b.png&amp;w=3840&amp;q=75 1x" src="https://martijnhols.nl/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fcover.38be4c3b.png&amp;w=3840&amp;q=75"></p><p>All things considered, <strong>it's high time to move away from US cloud services</strong>. In this article, I'll break down how I'm migrating away, what I switched to, and the challenges along the way.</p>
<h2 id="my-dependencies">My dependencies</h2>
<p>Before starting, I made an inventory of the US cloud services I depend on. I decided to focus on cloud services (and not software and hardware), as that's where the biggest risks are. My <span role="button" tabindex="0" aria-expanded="false">complete</span> dependency list roughly in order of reliance:</p>
<ul>
<li>Microsoft Office 365<!-- -->
<ul>
<li>Mail</li>
<li>Calendar</li>
<li>OneDrive</li>
</ul>
</li>
<li>Bitwarden</li>
<li>GitHub</li>
<li>Google search</li>
<li>Cloudflare/Google DNS</li>
<li>Docker Hub</li>
<li>NPM</li>
</ul>
<p>This list is focused on cloud services I use professionally (for my business), but I plan to migrate personal services as well (privately I also rely on WhatsApp for communication and iCloud for backups and notes).</p>
<div><p>Aside</p><div><p>While they're technically not cloud services, I also depend on online
platforms like Hacker News, Reddit,
<a href="https://www.linkedin.com/in/martijnhols/">LinkedIn</a>,
<a href="https://x.com/MartijnHols">Twitter</a> and
<a href="https://bsky.app/profile/martijnhols.nl">BlueSky</a> and WhatsApp. I use social
media like Hacker News and Reddit to reach people and stay informed, and
LinkedIn, Twitter and BlueSky are ways for people to find and follow me. These
platforms are only as good as the people on them, making most of them
irreplaceable. Not because of their infrastructure, but because of their
communities.</p></div></div>
<h2 id="replacing-the-dependencies">Replacing the dependencies</h2>
<p>With my list handy, I replaced each dependency one by one. A useful tool for finding alternatives is the <a href="https://european-alternatives.eu/">European Alternatives</a> website.</p>
<h3 id="goodbye-microsoft-office-365">Goodbye Microsoft Office 365</h3>
<p>Microsoft 365 was my most important dependency. It has all of my mail, including history that I'm legally required to save, my calendar, and most of my important files, which I'm legally required to keep long-term. Losing access to these services isn't an option.</p>
<p>On top of that, I've had long-standing usability issues with Microsoft 365. Particularly OneDrive for Mac, which was constantly draining my battery and overheating my CPU, making the switch even more appealing.</p>
<p>I went looking for an all-in-one solution; mail, calendar, and storage, mostly because it's simpler, but I also don't want to pay for everything separately. In the end, I settled on <a href="https://proton.me/">Proton</a>. I had heard of Proton Mail before as a privacy-focused highly-encrypted mail provider, but never really looked into it as I had no real need for that, and I figured it would come at the cost of usability and price. But <strong>I was seriously impressed by how good Proton software is.</strong> Their apps are really <span role="button" tabindex="0" aria-expanded="false">well-made and very usable</span>. I actually have a better experience than I did using Microsoft's. I'm impressed by how they made everything work so well without sacrificing privacy in any way.</p>

<p>The <a href="https://proton.me/business/plans">Proton Business Suite</a>, which includes 1 TB for Mail, Calendar, VPN, Pass and Drive, is only 12.99 per month (the non-business variant is 9.99). And just like Microsoft 365, it has full-fledged support for teams.</p>
<p>Another thing that impressed me about Proton is <a href="https://www.washingtonpost.com/technology/2023/06/27/gmail-switch-proton-email/">how easy</a> switching from Microsoft 365 was. Their <a href="https://proton.me/easyswitch">Easy Switch</a> tool, handled all the data importing for me in just a few clicks. All I had to do manually was update the DNS for my domains. And as a bonus, Proton allows setting up 15 custom email domains, so I can cancel all of my separate <a href="https://www.transip.nl/email-hosting/">email hosting</a> and centralize all my mailboxes.</p>
<p>Yet another bonus: the Proton Business Plan includes a VPN. I only need one very occasionally and my needs were never enough to subscribe to one, so this is a nice extra perk.</p>
<h3 id="replacing-bitwarden">Replacing Bitwarden</h3>
<p>I was very hesitant to switch password managers. I'd used Bitwarden daily for over 4 years, and despite its usability issues, it had become a core part of my toolkit.</p>
<p>But as I really wanted to ditch US cloud services, I looked into replacing it. After all, even though my vaults are encrypted, they're still hosted by Bitwarden and they can restrict my access as they see fit.</p>
<p>The obvious place to start was <a href="https://proton.me/pass">Proton Pass</a>, since it came <span role="button" tabindex="0" aria-expanded="false">bundled</span> with the Proton Business Suite. When I saw <a href="https://www.youtube.com/watch?v=CBdDYurOMyg">1Password users switching</a>, I figured it had to be good. Turns out, it really is! <strong>It has all of the features I used in Bitwarden, and more.</strong> The main new things I appreciate are sharing a password via a link, and the return of the login dropdown in login forms. Oh, I missed you so.</p>
<figure><p><img alt="Shows a login form (Email or username and password) with an autofill overaly open with an option to login as &quot;martijnhols&quot;" loading="lazy" width="500" height="249" decoding="async" data-nimg="1" srcset="https://martijnhols.nl/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fproton-pass-autofill.94d6e56f.png&amp;w=640&amp;q=75 1x, https://martijnhols.nl/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fproton-pass-autofill.94d6e56f.png&amp;w=1080&amp;q=75 2x" src="https://martijnhols.nl/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fproton-pass-autofill.94d6e56f.png&amp;w=1080&amp;q=75"></p><figcaption>The dropdown opens automatically, so I can confirm a login with a single click</figcaption></figure>
<p>Migration was even easier than mail; just export in Bitwarden and import in Proton Pass, and you're done. Even TOTP codes and secure notes transfer over seamlessly.</p>
<h3 id="the-github-challenge">The GitHub challenge</h3>
<p>I'm deeply locked into GitHub, having <a href="https://martijnhols.nl/blog/migrating-away-from-martijnhols-actions-cache">heavily customized</a> my <a href="https://github.com/MartijnHols/martijnhols.nl/actions">build pipelines</a> to work within their platform. As a result, I haven't started migrating yet.</p>
<p>GitHub only hosts my repositories and CI; I don't store any personal data on GitHub, nor do I use it to process it. I have copies of my repositories on my computer, plus occasional backups. The only real risk is my Mac's SSD self-destructing at the exact same time; then I'd lose a few days of work.</p>
<p>Still, I rely on GitHub heavily for my projects, so migrating will take time. I'll find a new home for my repositories eventually, but considering the impact, this will probably be the last thing I migrate, so I haven't really explored alternatives yet.</p>
<h3 id="escaping-google-search-almost">Escaping Google search (almost)</h3>
<p>If you've tried alternative search engines, you know: Google search is really, really good. It's very hard to find an alternative that doesn't make you want to switch back.</p>
<p>But I found it: <a href="https://www.startpage.com/">Startpage</a></p>
<figure><figcaption>Try for yourself</figcaption></figure>
<p>Startpage is a Dutch-owned search engine that promises "uncompromising" privacy. Despite that, <strong>I was really surprised by how good its search results are.</strong> Turns out that's because it's actually a Google proxy. Bummer.</p>
<p>It's unclear what Startpage's reliance on Google means for privacy, but it's still much better than using Google directly. It doesn't eliminate the US cloud dependency though. Unfortunately, fully European alternatives that don't make me want to switch back are scarce.</p>
<h3 id="disconnecting-cloudflare-google-dns">Disconnecting Cloudflare/Google DNS</h3>
<p>The promise of optimal DNS performance attracted me to the DNS servers of Cloudflare and Google, but this too comes with privacy issues and reliance on US infrastructure. As part of this de-US-ing, I've opted to replace those with <a href="https://www.quad9.net/">Quad9</a>. Quad9 is a free, Swiss-based DNS service focused on <span role="button" tabindex="0" aria-expanded="false">security</span> and privacy.</p>
<p>Switching to Quad9 is easy; just pop <a href="https://www.quad9.net/service/service-addresses-and-features#rec">their DNS IPs</a> in your router or <a href="https://docs.quad9.net/">install a provisioning profile on mobile</a> and you're done.</p>
<div><p>Aside</p><div><p>This section only covers Cloudflare's DNS servers (1.1.1.1), not its
nameservers or CDN. If you're looking to move away from Cloudflare's CDN,
check out <a href="https://jonathan-frere.com/posts/switching-to-bunny-cdn">Switching to Bunny
CDN</a> by Jonathan
Frere for a relevant experience.</p></div></div>
<h3 id="ditching-docker-hub">Ditching Docker Hub</h3>
<p>Docker Hub (a registry for <span role="button" tabindex="0" aria-expanded="false">Docker images</span>) is essential to my <span role="button" tabindex="0" aria-expanded="false">CD pipeline</span>; it stores the private images that my servers <a href="https://github.com/containrrr/watchtower">automatically pull</a> to install new versions of my apps.</p>
<p>I'm quite eager to move away from Docker Hub. I haven't been a fan of Docker Inc. for a long time; they make it really obvious their focus is entirely on enterprise customers. Docker started going downhill when they <a href="https://reddit.com/r/docker/comments/85w2vd/docker_cloud_is_shutting_down/">shut down Docker Cloud</a>. Later, they even canceled my subscription based on their "fair use" clause because they misinterpreted their logs (they were counting <a href="https://github.com/containrrr/watchtower/discussions/668">HTTP HEAD requests</a> as image pulls).</p>
<p>Since my needs are simple, I initially considered self-hosting a Docker registry with a European S3-compatible backend, looking at <del><span role="button" tabindex="0" aria-expanded="false">OVH</span></del> and <a href="https://www.scaleway.com/en/object-storage/">Scaleway Object Storage</a>. But the self-hosted Docker registries seemed to require too much complexity and it just didn't seem worth the overhead.</p>
<p>Instead, I went with <a href="https://www.scaleway.com/en/container-registry/">Scaleway Container Registry</a>. It's fully managed, straightforward to use, and keeps my images in the EU. In the end it took me less than two hours to setup and will probably cost me <span role="button" tabindex="0" aria-expanded="false">less than €1 per month</span>. Can't beat that.</p>
<h3 id="npm">NPM</h3>
<p>For NPM (a Node package registry), a key challenge is the reliance on public <span role="button" tabindex="0" aria-expanded="false">packages</span>. These are downloaded and installed in every CI build and every time someone clones the project. While these are heavily cached, NPM becoming unavailable would break most tooling.</p>
<p>Unfortunately I couldn't find any public European NPM mirrors (let me know if I missed any). I think this is because most large companies host their own private mirrors. I've used <a href="https://verdaccio.org/">Verdaccio</a> before as a private registry and cache, and setting it up should be fairly easy with a Docker image.</p>
<p>However, this requires setting up persistent storage first. I'll sort this out shortly after publishing this article. Once that's ready, I'll set up Verdaccio. That way, if NPM becomes unavailable, I'll still have access to the versions I've been using, and others can use that registry to get started.</p>
<h2 id="wrapping-up">Wrapping up</h2>
<p><strong>Migrating away from US cloud services was easier than I expected.</strong> While there are still some challenges to tackle, migrating my most important dependency (Microsoft 365) took just an afternoon. This is mostly thanks to Proton, which turned out to be a surprisingly good alternative to Microsoft 365.</p>
<p>Replacing Docker Hub required more research, mainly because I hadn't set up a custom registry or persistent storage before – something I should have solved ages ago.</p>
<p>Other services, such as GitHub, will take longer. But it's on my list and seems within reach. It even seems fun to explore European alternatives. Or maybe I'll self-host something.</p>
<p>Google Search, on the other hand, still feels unbeatable. <span role="button" tabindex="0" aria-expanded="false">Hopefully more alternatives will pop up</span>, but for now using a more privacy-focused proxy seems to be the only viable option.</p>
<p>If you're thinking about reducing your reliance on US cloud services, now is a good time to make it so. The risks, both in terms of privacy and control over your infrastructure, are getting harder to ignore. As my experience shows, some migrations may be a lot easier than you'd expect.</p>
<p>At the very least, think twice before signing up for <em>new</em> US services. Consider European services instead.</p>
<p>If you've gone through a similar transition, I'd love to hear what worked (or didn't work) for you.</p></div></article></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Block YouTube ads on AppleTV by decrypting and stripping ads from Profobuf (610 pts)]]></title>
            <link>https://ericdraken.com/pfsense-decrypt-ad-traffic/</link>
            <guid>43396735</guid>
            <pubDate>Tue, 18 Mar 2025 07:59:50 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://ericdraken.com/pfsense-decrypt-ad-traffic/">https://ericdraken.com/pfsense-decrypt-ad-traffic/</a>, See on <a href="https://news.ycombinator.com/item?id=43396735">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="page"><main id="main" role="main"><article id="post-5418"><p><a href="https://ericdraken.com/files/So-many-YouTube-ads.png"><img src="https://ericdraken.com/files/So-many-YouTube-ads-754x240.png" alt="So many ads" width="754" height="240" srcset="https://ericdraken.com/files/So-many-YouTube-ads.png 754w, https://ericdraken.com/files/So-many-YouTube-ads-300x95.png 300w, https://static.ericdraken.com/files/So-many-YouTube-ads-600x191.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/So-many-YouTube-ads-754x240.png" data-srcset="https://ericdraken.com/files/So-many-YouTube-ads.png 754w, https://ericdraken.com/files/So-many-YouTube-ads-300x95.png 300w, https://static.ericdraken.com/files/So-many-YouTube-ads-600x191.png 600w"></a></p><div><p><span>In a Nutshell</span></p><p>I discovered that putting a man-in-the-middle proxy between my Apple TV and the world lets me decrypt HTTPS traffic. From there, I can read the Protocol Buffer data Google uses to populate YouTube with ads. It is too CPU-intensive to decode Protobuf on the fly, so instead, I found a flaw in the Protobuf format which allows me to reliably change one byte to obliterate ads.</p><p>What follows is a reference guide for setting up a bare-metal network router to block malicious ads, obnoxious ads, tracking, clickbait, crypto-jackers, scam popups, Windows spying on you, etc. using blocklists to protect all networked devices.</p></div><hr><div><p><strong>Goal:</strong> Let’s build a cryptographically-strong router with FreeBSD and pfSense to completely block YouTube ads using a flaw in the Google Protocol Buffer format to completely block pre-roll, mid-roll, and end-roll YouTube ads on Apple TV and iPhones, network-wide.</p></div><div><p><strong>Disclaimer:</strong> I want to support content creators, so to be fair, after a few months of blocking YouTube ads, I am now paying for YouTube Premium; Just because I can break something, doesn’t mean I need to.</p></div><h2>Sections</h2><h3>Part 1 – Setup pfSense on Bare-Metal</h3><ol><li><a href="#why">Why block Ads and Behaviour Tracking?</a></li><li><a href="#hardware">Required Router Hardware</a></li><li><a href="#unboxing">Unboxing the Hardware</a></li><li><a href="#install">Install pfSense on Bare Metal</a></li><li><a href="#firstboot">First pfSense Boot</a></li><li><a href="#aes-ni">Enable the AES-NI Cryptographic Instruction</a></li><li><a href="#ramdisk">Enable RAM Disk</a></li><li><a href="#dashboard">Dashboard Widgets</a></li><li><a href="#pfblocker">Adblocking with pfBlockerNG</a></li><li><a href="#topology">Isolate LANs for Security</a></li><li><a href="#classb">Class B IPv4 172.31.1.0/24 Network for Untrusted Devices</a></li><li><a href="#firewall">Add Firewall Rules</a></li></ol><h3>Part 2 – Isolate Network LANs</h3><ol><li><a href="#untrusted-ap">Setup the Untrusted Wi-Fi AP</a></li><li><a href="#backups">Automatic pfSense Configuration Backups</a></li><li><a href="#bridge">Unable to Reach 172.31.1.x from 192.168.10.x</a></li><li><a href="#firmware">Replace Stock Firmware on the AC1200 Wi-Fi Access Point</a></li><li><a href="#r7000">Archer C5 v2 into the Refuse Bin, R7000 as the New Wi-Fi AP</a></li><li><a href="#wireless">Set up the Trusted Wireless Network</a></li><li><a href="#check">Network Devices Interconnectivity Check</a></li><li><a href="#sharing">Windows File Sharing Gotchas</a></li><li><a href="#psa">Public Service Announcement: Edge Browser</a></li></ol><h3>Part 3 – Setup DNS Adblocking</h3><ol><li><a href="#clickbait">Block Clickbait, Incessant Ads, and Dangerous Sites</a></li><li><a href="#trap-dns">Intercept all DNS Requests, Even to Hardcoded DNS Servers</a></li></ol><h3>Part 4 – Trick the YouTube Ad Algorithm</h3><ol><li><a href="#yt-ads">How to Restrict Apple TV YouTube Ads?</a></li><li><a href="#algo">Trick the YouTube Ad Algorithm Instead</a></li><li><a href="#ad-spend">Research into YouTube Advertizing Spend</a></li><li><a href="#new-goal-trick">New Goal: Convince YouTube I’m 70 and in Italy</a></li><li><a href="#route-vpn">Selectively Route Apple TV Over the VPN</a></li><li><a href="#route-youtube">Selectively Route Apple TV YouTube Traffic Over the VPN</a></li><li><a href="#gotcha-dns">Gotcha: DNS Race Condition</a></li><li><a href="#gotcha-403">Gotcha: Authentication Trouble, Forbidden 403 Error</a></li><li><a href="#gotcha-uk">Gotcha: YouTube is Now Showing UK Ads, Not Italian Ads</a></li><li><a href="#asn">Find a VPN Exit Node with no ASN Leak</a></li><li><a href="#dynamic-dns">Hijack Google Video DNS Queries</a></li><li><a href="#new-goal">New Goal: Programmatically add IPs to the Firewall Policy Rule</a></li><li><a href="#research-dns">Research Python Methods to Hijack DNS Queries</a><br>i. <a href="#rsync">Rsync Disk Backup</a><br>ii. <a href="#rest-api">Install pfSense REST API</a><br>iii. <a href="#unbound-python">Explore the Unbound Python Module</a></li><li><a href="#hijack-smoke">Smoke Test: A Python DNS Hijacking Script</a></li></ol><h3>Part 5 – Decrypt HTTPS Traffic</h3><ol><li><a href="#new-goal2">New Goal: Research and install a Squid-like proxy</a><br>i. <a href="#jailbreak">Fun fact: Jailbreaking iPhones in Japan</a></li><li><a href="#fake-ca">Install a Fake-but-Trusted CA Cert on Apple TV and iPhone?</a></li><li><a href="#squid">Experiment with Squid and SquidGuard</a></li><li><a href="#self-host">Self-Host the CA Certificate</a></li><li><a href="#bye-squid">Abandoning Squid: Too Slow, Too Heavy</a><br>i. <a href="#rsync-diff">Rsync Diff of Changes</a></li><li><a href="#mitmproxy">Install MITMProxy in a FreeBSD Jail</a></li><li><a href="#explore">Exploring MITMProxy</a></li><li><a href="#patch">Patch MITMProxy Source Code for Server SNI Interrogation</a></li></ol><h3>Part 6 – Intercept Apple TV and iOS YouTube Ads</h3><ol><li><a href="#smoke-block">Smoke Test: Intercept YouTube Ads with MITMProxy</a></li><li><a href="#ublock">Examine uBlock Origin Regex Patterns for Inspiration</a></li><li><a href="#alter-json">Surgically Alter the JSON Response to Remove Ads</a></li><li><a href="#protobuf">The iOS YouTube App Uses Protobuf, not JSON</a></li><li><a href="#timing">Timing Analysis to Detect Ad Videos?</a></li><li><a href="#decode-pb">Decode the YouTube Protobuf Responses</a></li><li><a href="#poly">Ad URL Polymorphism</a></li><li><a href="#smoke-proto">Smoke Test: Intercept and Decode Protobuf in Python</a><br>i. <a href="#pure-python">Pure Python Benchmarks</a><br>ii. <a href="#pure-cpp">Pure C++ Benchmarks</a></li><li><a href="#fuzzing">Fuzzing the YouTube Video Ad Responses</a></li><li><a href="#burp">Enter Burp Suite Tools for Penetration Testing</a></li><li><a href="#exfil">Exfil the Proto Schemas from the App, Cleanly?</a></li></ol><h3>Part 7 – Reverse-Engineer Protobuf Messages</h3><ol><li><a href="#deepdive">Hardcore Deep-Dive into Protobuf and Wire Format</a></li><li><a href="#protobuf-flaw">Exploit a Protobuf Flaw to Easily Remove All Ads by Changing One Byte</a></li><li><a href="#smoke-remove">Smoke Test: Remove Ads from Protobuf in O(n)-Time</a></li><li><a href="#analysis">Analysis of this Successful Adblocking Technique</a><br>i. <a href="#analysis-summary">Summary</a><br>ii. <a href="#analysis-timing">Timing Analysis</a><br>iii. <a href="#analysis-benefits">Knock-On Benefits</a><br>iv. <a href="#analysis-future">Future-Proof</a><br>v. <a href="#analysis-worried">Should Google be Worried?</a></li><li><a href="#script">The MITMProxy YouTube Adblocking Script</a></li></ol><h3>Part 8 – Summary</h3><ol><li><a href="#youtube-premium">YouTube Premium</a><br>i. <a href="#experiment">Experiment in Ad Viewing</a><br>ii. <a href="#cpv-15">$0.15 as a Ballpark CPV</a><br>iii. <a href="#cpv-1">CPV from US Advertising Spend Divided by Total Views</a><br>iv. <a href="#worth-it">Is YouTube Premium Worth It?</a></li><li><a href="#dmca">DMCA, Sony, Viacom</a></li><li><a href="#summary">Summary of Accomplishments</a></li></ol><hr><h2>Why block Malicious Ads and Behaviour Tracking?</h2><p>You are a valuable commodity that is bought and sold without your knowledge or consent. You will be tricked with clickbait, distracted with large ads, and enticed to leave the site you are on at every opportunity. Plus, everything you do online is being monitored so your habits and searches can be remarketed and sold over and over again for years.</p><p><a href="https://ericdraken.com/files/clickbait.png"><img src="https://ericdraken.com/files/clickbait-754x325.png" alt="clickbait" width="754" height="325" srcset="https://ericdraken.com/files/clickbait-754x325.png 754w, https://static.ericdraken.com/files/clickbait-300x129.png 300w, https://ericdraken.com/files/clickbait-600x259.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/clickbait-754x325.png" data-srcset="https://ericdraken.com/files/clickbait-754x325.png 754w, https://static.ericdraken.com/files/clickbait-300x129.png 300w, https://ericdraken.com/files/clickbait-600x259.png 600w"></a></p><p><strong>Privacy</strong> – Knowing what you like to watch and read, what phone you have, what you watch on Netflix, what you shop for, what you ask Alexa about, yout taste in music, etc. is <em>unbelievably</em> valuable to advertisers. Spying on people is such a big problem that Europe passed the <a href="https://en.wikipedia.org/wiki/General_Data_Protection_Regulation" target="_blank" rel="nofollow">GDPR law</a> so every site you visit asks if you are okay with cookies (and we blindly click “ok” to hide the banner). We must wrestle back privacy ourselves.</p><p><strong>Bandwidth</strong> – If privacy doesn’t concern you, how about this: it is well-known that between 25% and 40% of network traffic is ads, tracking, JavaScript to load trackers (<a href="https://github.com/fingerprintjs/fingerprintjs" target="_blank" rel="nofollow">fingerprint.js</a>, <a href="https://www.npmjs.com/package/@analytics/google-tag-manager" target="_blank" rel="nofollow">googletagmanager.js</a>), websocket traffic to collect how you scroll and what you type (<a href="https://www.hotjar.com/" target="_blank" rel="nofollow">Hotjar</a>), and the like. Do you have a 100 Mbps internet connection? Consider it 60 Mbps!</p><p><strong>Clickbait</strong> – Then there is clickbait. “You won’t believe what Tom Cruise did. He…” and you may want to click. Then you are in the spider’s web. How about fake news? Or articles that don’t say “sponsored” in size-8 font, but now say “underscored” to be clever. What is even real anymore? As soon as you click on clickbait, you may end up on a page with a dozen more ads that aren’t approved by Google but lead to a dark world of maliciousness. <strong>Clickbait is so incredibly profitable to scammers.</strong></p><p><strong>Cryptojacking</strong> – Some websites will load crypto-mining JavaScript (e.g. <a href="https://www.fortinet.com/blog/threat-research/the-growing-trend-of-coin-miner-javascript-infection" target="_blank" rel="nofollow">CoinHive.js</a>) so while you read, they overheat and abuse your computer to try to make a few pennies. Some sites will load JavaScript that tries to steal from your crypto wallet or trick you into transferring cryptocurrency.</p><div><p><strong>Takeaway:</strong> It is highly lucrative yet detrimental to you to track and trick you, and only <em>you</em> can do something about it.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Required Router Hardware</h2><p>A virtual machine, Docker image, or Raspberry Pi are not performant enough to protect a whole SMB network; We need dedicated hardware with a cryptographic instruction set so that its only function is to route, decrypt, and monitor packets in and out. Here is what I used.</p><ul><li>A mini PC with the AES-NI instruction set (e.g. J4125)</li><li>Several gigabytes of DDR4 RAM (e.g. 32 GiB)</li><li>A decent mSATA SSD drive (e.g. 128 GiB)</li><li>A USB drive to transfer pfSense</li></ul><p><a href="#top">Top ↩</a></p><hr><h2>Unboxing the Hardware</h2><p>I’ve ordered a mini J4125 PC from AliExpress, ordered 32 GB of DDR4 RAM and a 128 GB mSATA from Amazon, and will assemble them for the first time now.</p><div><p><strong>Warning:</strong> Out of caution, I searched diligently for a barebones mini PC that did not include RAM or an SSD; there is nothing stopping an overseas seller from including some generic RAM and SSD but charging Samsung prices.</p></div><div><p><strong>Tip:</strong> 128 GB of disk space on a router? Yup. That should be plenty of space to hold logs and not wear down the SSD too quickly, <strong>and</strong> to allow beautiful packet capture (and maybe an edge cache for NPM and Docker?).</p></div><p>A beautiful box, isn’t it? It only has 3 LAN ports, but it can be extended with network switches.</p><figure id="attachment_5543"><a href="https://static.ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC.jpg"><img src="https://static.ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-754x533.jpg" alt="The J4125 AES-NI quad-core fanless mini PC" width="754" height="533" srcset="https://static.ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-754x533.jpg 754w, https://static.ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-300x212.jpg 300w, https://ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-600x424.jpg 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-754x533.jpg" data-srcset="https://static.ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-754x533.jpg 754w, https://static.ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-300x212.jpg 300w, https://ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-600x424.jpg 600w"></a><figcaption>The J4125 AES-NI quad-core fanless mini PC</figcaption></figure><figure id="attachment_5544"><a href="https://static.ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC.jpg"><img src="https://ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-754x523.jpg" alt="The J4125 pfSense router from a fanless mini PC" width="754" height="523" srcset="https://ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-754x523.jpg 754w, https://static.ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-300x208.jpg 300w, https://ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-600x416.jpg 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-754x523.jpg" data-srcset="https://ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-754x523.jpg 754w, https://static.ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-300x208.jpg 300w, https://ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-600x416.jpg 600w"></a><figcaption>The pfSense router from a J4125 fanless mini PC</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Install pfSense on Bare Metal</h2><p>I’ve never used <a href="https://www.pfsense.org/getting-started/" target="_blank" rel="nofollow">pfSense</a> before, so we will explore this together. The compressed image is about 360 MB and can be flashed to a USB drive with an AppImage binary of Etcher (very cool). Decisions, decisions: VGA install or serial? Let’s serial into the new router. Why not?</p><figure id="attachment_5549"><a href="https://static.ericdraken.com/files/Lets-not-serial-into-the-router.jpg"><img src="https://static.ericdraken.com/files/Lets-not-serial-into-the-router-754x407.jpg" alt="Let's not serial into the router" width="754" height="407" srcset="https://static.ericdraken.com/files/Lets-not-serial-into-the-router-754x407.jpg 754w, https://ericdraken.com/files/Lets-not-serial-into-the-router-300x162.jpg 300w, https://static.ericdraken.com/files/Lets-not-serial-into-the-router-600x324.jpg 600w, https://static.ericdraken.com/files/Lets-not-serial-into-the-router.jpg 1066w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Lets-not-serial-into-the-router-754x407.jpg" data-srcset="https://static.ericdraken.com/files/Lets-not-serial-into-the-router-754x407.jpg 754w, https://ericdraken.com/files/Lets-not-serial-into-the-router-300x162.jpg 300w, https://static.ericdraken.com/files/Lets-not-serial-into-the-router-600x324.jpg 600w, https://static.ericdraken.com/files/Lets-not-serial-into-the-router.jpg 1066w"></a><figcaption>Let’s not serial into the router</figcaption></figure><p>Well, that looks painful. It would also be a whole production to serial into the box in case of an emergency because the serial port is inside, and there isn’t even an RS232 or JTAG connector – just some narrow header pins. Yikes. Let’s go with VGA and plug a keyboard into the USB port – get ready to navigate with arrows and tabs.</p><figure id="attachment_5552"><a href="https://static.ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable.jpg"><img src="https://static.ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-754x531.jpg" alt="J4125 mini PC BIOS over a VGA cable" width="754" height="531" srcset="https://static.ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-754x531.jpg 754w, https://static.ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-300x211.jpg 300w, https://ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-600x423.jpg 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-754x531.jpg" data-srcset="https://static.ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-754x531.jpg 754w, https://static.ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-300x211.jpg 300w, https://ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-600x423.jpg 600w"></a><figcaption>J4125 mini PC BIOS over a VGA cable</figcaption></figure><p>I’ll follow this guide on <a href="https://www.youtube.com/watch?v=9kSZ1oM-4ZM" target="_blank" rel="nofollow">YouTube</a>. I’ll pass on encrypting the disk since I would like to avoid entering a passphrase each time the mini PC reboots. A stripe disk is fine since there is only one disk. I have no idea what to expect yet, so I will pass on dropping to a shell for a more advanced configuration.</p><p><a href="#top">Top ↩</a></p><hr><h2>First pfSense Boot</h2><p>I ejected the USB containing the boot image (important) and rebooted the little box. It played a melody on the internal speaker (there is an internal buzzer and thankfully it isn’t very loud).</p><p>Do I need to have a LAN connection already, or can I just start the thing? I’ll just start pfSense and let it complain to me if it wants… and according to the YouTube <a href="https://youtu.be/9kSZ1oM-4ZM?t=610" target="_blank" rel="nofollow">tutorial</a>, I should guess which port is LAN 1. I’ll do that now.</p><p>I figured out that I should set the LAN 1 to a static IP address that is not in my existing router’s DHCP range, so I went with <code>192.168.1.3</code>. Now I can access an admin web portal (<em>admin</em>/<em>pfsense</em>). Hooray.</p><p>Yikes, the mini PC beeped at me and informed me that ‘admin’ has logged in. That startled me a bit, but hey that is pretty neat.</p><figure id="attachment_5553"><a href="https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI.png"><img src="https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-754x500.png" alt="First time logging into pFsense admin UI" width="754" height="500" srcset="https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-754x500.png 754w, https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-300x199.png 300w, https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-600x398.png 600w, https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI.png 890w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-754x500.png" data-srcset="https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-754x500.png 754w, https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-300x199.png 300w, https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-600x398.png 600w, https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI.png 890w"></a><figcaption>First time logging into pFsense admin UI</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Enable the AES-NI Cryptographic Instruction</h2><p>I played around with the wizard, used defaults, and got to the web configurator. The first thing that caught my eye was <code>AES-NI CPU Crypto: Yes (inactive)</code>. I went out of my way to get a mini PC with AES-NI. What gives?</p><p>Ah, this needs to be enabled in System &gt; Advanced &gt; Miscellaneous. Why not auto-detect this and use the best option? I’m glad I spotted that, or else this mini PC might as well be a Celeron J1900 of yesteryear.</p><p><a href="#top">Top ↩</a></p><hr><h2>Enable RAM Disk</h2><p>Having 32 GiB of RAM, let’s take advantage of that and use a generous amount of RAM for <code>/var</code> and <code>/tmp</code>, and since hopefully this 128 GiB SSD has wear levelling, let’s take a RAM Disk backup every hour.</p><figure id="attachment_5521"><a href="https://ericdraken.com/files/Lets-take-advantage-of-RAM-disk.png"><img src="https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-754x258.png" alt="Let's take advantage of RAM disk" width="754" height="258" srcset="https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-754x258.png 754w, https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-300x103.png 300w, https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-600x205.png 600w, https://ericdraken.com/files/Lets-take-advantage-of-RAM-disk.png 1149w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-754x258.png" data-srcset="https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-754x258.png 754w, https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-300x103.png 300w, https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-600x205.png 600w, https://ericdraken.com/files/Lets-take-advantage-of-RAM-disk.png 1149w"></a><figcaption>Let’s take advantage of RAM disk</figcaption></figure><p>Reboot! <code>AES-NI</code> is now active.</p><p><a href="#top">Top ↩</a></p><hr><h2>Dashboard Widgets</h2><p>This dashboard is pretty slick. I’m just discovering that there are widgets that can be added to the Dashboard, including S.M.A.R.T to alert us if the SSD is going bad. Nice.</p><figure id="attachment_5900"><a href="https://ericdraken.com/files/pfSense-dashboard.png"><img src="https://ericdraken.com/files/pfSense-dashboard-754x329.png" alt="Final pfSense dashboard after all setup" width="754" height="329" srcset="https://ericdraken.com/files/pfSense-dashboard-754x329.png 754w, https://static.ericdraken.com/files/pfSense-dashboard-300x131.png 300w, https://static.ericdraken.com/files/pfSense-dashboard-600x262.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/pfSense-dashboard-754x329.png" data-srcset="https://ericdraken.com/files/pfSense-dashboard-754x329.png 754w, https://static.ericdraken.com/files/pfSense-dashboard-300x131.png 300w, https://static.ericdraken.com/files/pfSense-dashboard-600x262.png 600w"></a><figcaption>Final pfSense dashboard after all setup</figcaption></figure><p>Hang on, when I added the Services Status widget, something called <code>PC/SC Smart Card Daemon</code> shows up. What is that? Research shows it’s a daemon for hardware smart keys that we can probably do without(?). It can be disabled in the <code>/etc/rc.bootup</code> file like so:</p><div id="crayon-63661eaabe474366916701" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>/</span><span>*</span><span> </span><span>pcscd </span><span>daemon </span><span>must </span><span>be </span><span>started </span><span>before </span><span>IPsec</span><span> </span><span>*</span><span>/</span></p><p><span>echo</span><span> </span><span>"SKIPPING PC/SC Smart Card Services..."</span><span>;</span></p><p><span># echo "Starting PC/SC Smart Card Services...";</span></p><p><span># mwexec_bg("/usr/local/sbin/pcscd");</span></p><p><span># echo "done.\n";</span></p></div></td></tr></tbody></table></div><p>Wait. After some time went by, I noticed the router slowed down, fatally.</p><figure id="attachment_5721"><a href="https://ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router.png"><img src="https://static.ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-754x475.png" alt="IPsec without the SD Card Service will cripple the router" width="754" height="475" srcset="https://static.ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-754x475.png 754w, https://ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-300x189.png 300w, https://static.ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-600x378.png 600w, https://ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router.png 923w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-754x475.png" data-srcset="https://static.ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-754x475.png 754w, https://ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-300x189.png 300w, https://static.ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-600x378.png 600w, https://ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router.png 923w"></a><figcaption>IPsec without the SD Card Service will cripple the router</figcaption></figure><div><p><strong>Warning:</strong> Do NOT try to disable the Smart Card Service as it is needed by IPsec; if you start experimenting with an IPsec VPN tunnel and the <code>pcscd</code> daemon is disabled, then your hard disk will fill up with logs and your CPU will run hot.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Adblocking with pfBlockerNG</h2><p>This unboxing and setup has been fun, but I’d like to block all the bad traffic on my network. I’ve been using a workhorse of a DNS-level adblocker called <a href="https://ericdraken.com/block-malicious-ads-with-pi-hole/" target="_blank">Pi-Hole</a> on a… yes, Pi, but it would be nice if I can reclaim that wee bit of hardware for something else and use a comparable add-on module in pfSense. Let’s explore that now.</p><blockquote><p>pfBlockerNG is a very powerful package for pfSense® which provides advertisement and malicious content blocking along with geo-blocking capabilities.</p></blockquote><p>Question: Do I install the first <code>pfBlockerNG</code> or the <code>pfBlockerNG-devel</code> which feels like a developer version? I’m a software developer, so this is for me, but am I a pfSense developer? No. Maybe it will show me advanced logs or I can mess about with LUA? Let’s Google this.</p><p>From <a href="https://forum.netgate.com/topic/156604/pfblockerng-vs-pfblockerng-devel" target="_blank" rel="nofollow">here</a>, random people are saying to install the development version. Another <a href="https://linuxincluded.com/block-ads-malvertising-on-pfsense-using-pfblockerng-dnsbl/" target="_blank" rel="nofollow">blogger</a> advocates using the dev version as well. Meh, I guess we can install <code>jq</code>, <code>rsync</code>, and Python 3.8. This doesn’t <em>feel</em> like a development version since it has exciting dependencies.</p><figure id="attachment_5522"><a href="https://static.ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one.png"><img src="https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-754x428.png" alt="Install pfBlockerNG-devel not the other one" width="754" height="428" srcset="https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-754x428.png 754w, https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-300x170.png 300w, https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-600x341.png 600w, https://static.ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one.png 1144w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-754x428.png" data-srcset="https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-754x428.png 754w, https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-300x170.png 300w, https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-600x341.png 600w, https://static.ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one.png 1144w"></a><figcaption>Install pfBlockerNG-devel not the other one</figcaption></figure><p>That was painless and only added an extra 20 MiB. It seems a lot of the dependencies are part of pfSense already. The knight at the end of Raiders would say that I have chosen wisely (hey, why did Indy age like a normal person up to Indy 4 if he drank the immortality water that the thousand-year-old knight also drank?).</p><div id="crayon-63661eaabe47e463690482" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>New</span><span> </span><span>packages </span><span>to</span><span> </span><span>be </span><span>INSTALLED</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>gmp</span><span>:</span><span> </span><span>6.2.1</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>grepcidr</span><span>:</span><span> </span><span>2.0</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>iprange</span><span>:</span><span> </span><span>1.0.4</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>jq</span><span>:</span><span> </span><span>1.6</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>libmaxminddb</span><span>:</span><span> </span><span>1.6.0</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>lighttpd</span><span>:</span><span> </span><span>1.4.59</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>lua52</span><span>:</span><span> </span><span>5.2.4</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>nettle</span><span>:</span><span> </span><span>3.7.2_2</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>pfSense</span><span>-</span><span>pkg</span><span>-</span><span>pfBlockerNG</span><span>-</span><span>devel</span><span>:</span><span> </span><span>3.1.0</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>py38</span><span>-</span><span>maxminddb</span><span>:</span><span> </span><span>2.0.3</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>py38</span><span>-</span><span>sqlite3</span><span>:</span><span> </span><span>3.8.10_7</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>rsync</span><span>:</span><span> </span><span>3.2.3_1</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>whois</span><span>:</span><span> </span><span>5.5.7</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>xxhash</span><span>:</span><span> </span><span>0.8.0</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>zstd</span><span>:</span><span> </span><span>1.5.0</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p></div></td></tr></tbody></table></div><p>Wizard time.</p><figure id="attachment_5523"><a href="https://static.ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one.png"><img src="https://static.ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-754x269.png" alt="The pfBlockerNG wizard had four steps but step three is like 50 steps in one" width="754" height="269" srcset="https://static.ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-754x269.png 754w, https://ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-300x107.png 300w, https://ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-600x214.png 600w, https://static.ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one.png 1151w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-754x269.png" data-srcset="https://static.ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-754x269.png 754w, https://ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-300x107.png 300w, https://ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-600x214.png 600w, https://static.ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one.png 1151w"></a><figcaption>The pfBlockerNG wizard had four steps but step three is like 50 steps in one</figcaption></figure><p>There are a lot of options in step three. This is not like Pi-hole at all. I’m going to <a href="https://www.youtube.com/watch?v=xizAeAqYde4" target="_blank" rel="nofollow">come back to this</a> and set up my network instead so I accomplish retiring my Nighthawk R700 or giving it new life as a Wi-Fi AP.</p><div><p><strong>Fix:</strong> If the <code>pfb_dnsbl</code> service won’t start or the status tab states <code>[ Missing CRON task ]</code>, try deleting the empty file <code>/var/run/booting</code> (<a href="https://www.reddit.com/r/pfBlockerNG/comments/9x5sid/pfb_dnsbl_service_will_not_start/" target="_blank" rel="nofollow">ref</a>).</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Isolate LANs for Security</h2><p>An opportunity has presented itself: I can create real networks on each of the three router Gigabit ports (not VLANs), and should I do so? Yes, yes I should. I would like a dedicated hardware network for all my home-phoning spy devices (Alexas and Apple TV) so they don’t flood my network with metrics info and “sure I’m muted and not listening to you” audio payloads back to their HQs.</p><p>I can see it now: A Wi-Fi AP on a hardware LAN that is isolated from everything else and dedicated to these gadgets, <strong>and</strong> runs through the adblocker <strong>and</strong> traps hard-coded DNS queries to <code>1.1.1.1</code> and <code>9.9.9.9</code> and others (I’ll have to explore this) so YouTube on my TV doesn’t sneakily bypass <del>Pi-Hole</del> any DNS-level blocker. It’s so Utopian an outcome I may not be able to sleep.</p><p>I’ve decided that my bottom-shelf TP-Link wireless router that is so old that <code>AC1200</code> might as well be “A.D. 1200” is going to be my Wi-Fi AP for those IoT spy devices.</p><p>In sum, there will be a dedicated hardware LAN</p><ul><li>with a wireless AP (AC1200) for Amazon/Apple gadgets and the TV.</li><li>with a wired switch for all the beefy computers and clusters in my lab.</li><li>with another wireless AP (R7000) just for iPhones and watches.</li></ul><p>As an aside, since doing an Offensive Security hacking course in my spare time, and I rare-earth-magnet-strongly suggest isolating Wi-Fi devices from any critical LAN segments connected to devices that touch daily banking or stock trading (or crypto wallets).</p><p><a href="#top">Top ↩</a></p><hr><h2>Class B IPv4 172.31.1.0/24 Network for Untrusted Devices</h2><p>The class B IPv4 range 172.16/16 is a valid range of private IP addresses. I’m not uncomfortable with Alexa and Apple TV being even on the same class network as my main LAN segment, so I will banish them to the class B private network at the hardware level, and my more trusted LANs will be on the traditional class C network (192.168/16). This helps mitigate any misconfigured <code>iptables</code> rules by naturally having no routes between the two networks.</p><figure id="attachment_5524"><a href="https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices.png"><img src="https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-754x371.png" alt="Set up a physical network for the untrusted smart devices" width="754" height="371" srcset="https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-754x371.png 754w, https://static.ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-300x148.png 300w, https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-600x295.png 600w, https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices.png 1146w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-754x371.png" data-srcset="https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-754x371.png 754w, https://static.ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-300x148.png 300w, https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-600x295.png 600w, https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices.png 1146w"></a><figcaption>Set up a physical network for the untrusted smart devices</figcaption></figure><p>Be sure to enable the DHCP resolver on the physical NIC that will connect smart devices (which mainly just tell me the weather and creepily listen to me sleep).</p><p>From this point, DHCP works on this new network, but by default, it assigns IP addresses but does <em>no</em> routing. All traffic is blocked by default.</p><p><a href="#top">Top ↩</a></p><hr><h2>Add Firewall Rules</h2><p>We need to manually add rules so traffic on the physical NICs goe somewhere.</p><figure id="attachment_5525"><a href="https://ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet.png"><img src="https://static.ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-754x252.png" alt="Our first rule to allow eth3 to access the Internet" width="754" height="252" srcset="https://static.ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-754x252.png 754w, https://ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-300x100.png 300w, https://ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-600x200.png 600w, https://ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet.png 1157w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-754x252.png" data-srcset="https://static.ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-754x252.png 754w, https://ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-300x100.png 300w, https://ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-600x200.png 600w, https://ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet.png 1157w"></a><figcaption>Our first rule to allow eth3 to access the Internet</figcaption></figure><p>There is a logging message. Let me reproduce it below.</p><blockquote><p>Hint: the firewall has limited local log space. Don’t turn on logging for everything.</p></blockquote><p>I read that to mean, “Congratulations on not cheaping out on your SSD. Now go forth and log everything, my son.”</p><p>I’m not a new-age, fancy-jazz, coloured-light- or smart-plug-controlling guy who forgot how to turn on a light without his phone, so I do not need to have smart devices on the same network as my phone (why create dozens of wireless attack vectors into your home?). I’m classicly trained to actuate an electromechanical current interrupter on the wall and light let there be.</p><p><a href="#top">Top ↩</a></p><hr><h2>Setup the Untrusted Wi-Fi AP</h2><p>How do I reach the admin UI of AC1200 Wi-Fi AP now? I factory reset it, plugged the WAN NIC into the ETH3 NIC of the pfSense router, but both devices are just blinking at me.</p><p>I suppose I can just Wi-Fi into the factory-reset AC1200. Yikes, 2016 was a bad year for responsive web UIs I take it. This is horrible; I’ll pull out a netbook for this. One sec.</p><p>It seems the Archer C5 has no AP Mode. This is my problem, not yours, but I’m still going to vent.</p><p>Oh, and the “refresh” icon on the top of the DCHP Leases page in pfSense is not “refresh”, but “reload service”. Whoops.</p><p>Well, I bricked the AC1200 router. I will have to run an Ethernet cable manually… but, wait, my thin notebook has no Ethernet ports and needs a USB-NIC adapter. Happy Friday.</p><div><p><strong>Tip:</strong> Connect LAN to LAN, not the AP’s WAN to pfSense’s LAN unless you want to do double NATing.</p></div><p>There were shenanigans, but I set the LAN IP of the AC1200 to <code>172.31.1.100</code>, the ETH3 NIC IP of the pfSense router to <code>172.31.1.1/24</code>, and set the pfSense DHCP service on ETH3 to assign addresses <code>172.31.1.101~150</code>. What <em>failed</em> was setting the AC1200 to <code>172.31.1.2</code> as it was unreachable (reason unknown). Oh yes, I had to turn off firewally things and <code>NAT Boost</code>, and basically drop the horsepower of this TP-Link router down to that of a potato battery. The above settings allow me to access the AC1200 remotely now.</p><p>The other video ran its course, so I started following this <a href="https://www.youtube.com/watch?v=FPgPHJvLmh0" target="_blank" rel="nofollow">YouTube video</a> (set the speed to 1.5x).</p><figure id="attachment_5526"><a href="https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads.jpg"><img src="https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-754x474.jpg" alt="There are some good tutorials on advanced pfSense... if you can sit through the ads" width="754" height="474" srcset="https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-754x474.jpg 754w, https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-300x189.jpg 300w, https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-600x377.jpg 600w, https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads.jpg 965w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-754x474.jpg" data-srcset="https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-754x474.jpg 754w, https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-300x189.jpg 300w, https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-600x377.jpg 600w, https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads.jpg 965w"></a><figcaption>There are some good tutorials on advanced pfSense… if you can sit through the ads</figcaption></figure><p>One more thing: I installed the <code>nmap</code> package for pfSense and scanned the AC1200 router, and found some sneaky ports open.</p><div id="crayon-63661eaabe487832563043" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>Running</span><span>:</span><span> </span><span>/</span><span>usr</span><span>/</span><span>local</span><span>/</span><span>bin</span><span>/</span><span>nmap</span><span>&nbsp;&nbsp;</span><span>-</span><span>sT</span><span> </span><span>-</span><span>P0</span><span> </span><span>-</span><span>e</span><span> </span><span>igb1</span><span> </span><span>'172.31.1.100'</span></p><p><span>Starting </span><span>Nmap</span><span> </span><span>7.91</span><span> </span><span>(</span><span> </span><span>https</span><span>:</span><span>/</span><span>/</span><span>nmap</span><span>.org</span><span> </span><span>)</span><span> </span><span>at</span><span> </span><span>2021</span><span>-</span><span>11</span><span>-</span><span>15</span><span> </span><span>17</span><span>:</span><span>40</span><span> </span><span>PST</span></p><p><span>Nmap </span><span>scan </span><span>report </span><span>for</span><span> </span><span>172.31.1.100</span></p><p><span>Host </span><span>is</span><span> </span><span>up</span><span> </span><span>(</span><span>0.0017s</span><span> </span><span>latency</span><span>)</span><span>.</span></p><p><span>Not</span><span> </span><span>shown</span><span>:</span><span> </span><span>969</span><span> </span><span>closed </span><span>ports</span><span>,</span><span> </span><span>28</span><span> </span><span>filtered </span><span>ports</span></p><p><span>PORT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>STATE </span><span>SERVICE</span></p><p><span>22</span><span>/</span><span>tcp&nbsp;&nbsp;&nbsp;&nbsp;</span><span>open&nbsp;&nbsp;</span><span>ssh</span></p><p><span>80</span><span>/</span><span>tcp&nbsp;&nbsp;&nbsp;&nbsp;</span><span>open&nbsp;&nbsp;</span><span>http</span></p><p><span>20005</span><span>/</span><span>tcp </span><span>open&nbsp;&nbsp;</span><span>btx</span></p></div></td></tr></tbody></table></div><p>Port <code>20005/tcp</code> is a print server port that I’ve now closed. However, the Archer C5 AC1200 is vulnerable to all kinds of Kali <a href="https://www.hackingtutorials.org/wifi-hacking-tutorials/tp-link-archer-c5-router-hacking/" target="_blank" rel="nofollow">mischief</a> so it was wise to put it on its own network. I’m not sure how to close port 22 and the <code>SSHd</code> service on it the AC1200 because the stock firmware is ancient and crippled, so I’ll just have to block port 22 on the whole LAN segment.</p><p>I’ve also taken care of disallowing private networks to ingress on the WAN (see the next section to set up DMZ).</p><p><a href="#top">Top ↩</a></p><hr><h2>Unable to Reach 172.31.1.x from 192.168.10.x</h2><p>Ping and Traceroute are aiding me in my efforts to connect to the AC1200 Wi-Fi AP from my <em>Trusted</em> LAN. I went ahead and added the subnet to the Symantec Firewall rules just in case (Symantec has its place now and then, but yes, definitely have available PC CPU horsepower to spare).</p><figure id="attachment_5529"><a href="https://static.ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet.png"><img src="https://static.ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-754x248.png" alt="Configure Symantec to allow the Untrusted subnet" width="754" height="248" srcset="https://static.ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-754x248.png 754w, https://ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-300x99.png 300w, https://ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-600x197.png 600w, https://static.ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet.png 940w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-754x248.png" data-srcset="https://static.ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-754x248.png 754w, https://ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-300x99.png 300w, https://ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-600x197.png 600w, https://static.ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet.png 940w"></a><figcaption>Configure Symantec to allow the Untrusted subnet</figcaption></figure><p>Now, it seems ICMP packets are no longer blocked between networks, but I still cannot ping the AP web management UI even though I can see the pings in the traffic logs.</p><p>I’ve even added an “any to any” firewall rule on the Untrusted network. No change.</p><div><p><strong>Warning:</strong> If you run <code>nmap</code> as I did, software firewalls may detect a port scan and kick your network connection for an hour by default.</p><p><a href="https://ericdraken.com/files/Disable-Symantec-port-scan-detection.png"><img src="https://ericdraken.com/files/Disable-Symantec-port-scan-detection.png" alt="Disable Symantec port scan detection" width="474" height="647" srcset="https://ericdraken.com/files/Disable-Symantec-port-scan-detection.png 474w, https://static.ericdraken.com/files/Disable-Symantec-port-scan-detection-220x300.png 220w" sizes="(max-width: 474px) 100vw, 474px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Disable-Symantec-port-scan-detection.png" data-srcset="https://ericdraken.com/files/Disable-Symantec-port-scan-detection.png 474w, https://static.ericdraken.com/files/Disable-Symantec-port-scan-detection-220x300.png 220w"></a></p></div><p>Let’s try a stealth scan instead: <code>sudo nmap -sS -v 172.31.1.*</code>.</p><figure id="attachment_5530"><a href="https://ericdraken.com/files/I-think-a-port-scan-has-been-detected.png"><img src="https://ericdraken.com/files/I-think-a-port-scan-has-been-detected-754x319.png" alt="I think a port scan has been detected" width="754" height="319" srcset="https://ericdraken.com/files/I-think-a-port-scan-has-been-detected-754x319.png 754w, https://static.ericdraken.com/files/I-think-a-port-scan-has-been-detected-300x127.png 300w, https://ericdraken.com/files/I-think-a-port-scan-has-been-detected-600x254.png 600w, https://ericdraken.com/files/I-think-a-port-scan-has-been-detected.png 1069w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/I-think-a-port-scan-has-been-detected-754x319.png" data-srcset="https://ericdraken.com/files/I-think-a-port-scan-has-been-detected-754x319.png 754w, https://static.ericdraken.com/files/I-think-a-port-scan-has-been-detected-300x127.png 300w, https://ericdraken.com/files/I-think-a-port-scan-has-been-detected-600x254.png 600w, https://ericdraken.com/files/I-think-a-port-scan-has-been-detected.png 1069w"></a><figcaption>I think a port scan has still been detected</figcaption></figure><p>Nope, pfSense doesn’t like that at all. And, the whole network stopped working. Nice security! Also, dang.</p><p>The good news is that I’ve isolated the packet malaise to the TP-Link AC1200 box itself. I suspect that I need to add <code>net.ipv4.ip_forward=1</code> to forward packets with no addresses in them, but I’d need root access to the AC1200. Let’s burn it to the ground and rebuild from its sprinkler-soaked ashes.</p><p><a href="#top">Top ↩</a></p><hr><h2>Replace Stock Firmware on the AC1200 Wi-Fi Access Point</h2><p>Of course, I cannot actually stop Untrusted LAN devices from reaching the AC1200 as they all exist downstream from the pfSense box.</p><p>DD-WRT open-source router firmware, meet my ancient Archer C5 and do your thing.</p><figure id="attachment_5532"><a href="https://ericdraken.com/files/DD-WRT-supports-the-Archer-C5.png"><img src="https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-754x251.png" alt="DD-WRT supports the Archer C5" width="754" height="251" srcset="https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-754x251.png 754w, https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-300x100.png 300w, https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-600x199.png 600w, https://ericdraken.com/files/DD-WRT-supports-the-Archer-C5.png 954w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-754x251.png" data-srcset="https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-754x251.png 754w, https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-300x100.png 300w, https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-600x199.png 600w, https://ericdraken.com/files/DD-WRT-supports-the-Archer-C5.png 954w"></a><figcaption>DD-WRT supports the Archer C5</figcaption></figure><p>The Archer C5 did not accept the DD-WRT firmware. Hmm… how about OpenWRT?</p><figure id="attachment_5533"><a href="https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5.png"><img src="https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5-754x292.png" alt="OpenWRT supports the Archer C5" width="754" height="292" srcset="https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5-754x292.png 754w, https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5-300x116.png 300w, https://static.ericdraken.com/files/OpenWRT-supports-the-Archer-C5-600x232.png 600w, https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5.png 755w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5-754x292.png" data-srcset="https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5-754x292.png 754w, https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5-300x116.png 300w, https://static.ericdraken.com/files/OpenWRT-supports-the-Archer-C5-600x232.png 600w, https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5.png 755w"></a><figcaption>OpenWRT supports the Archer C5</figcaption></figure><p>The Archer C5 did not accept the OpenWRT firmware either. What the actual facepalm (WTAF)?</p><p><strong>Wait.</strong> My hardware is revision 2 using the Broadcom chipsets which are notoriously difficult networking chips.</p><div><p><strong>Careful:</strong> Devices with Broadcom Wi-Fi chipsets have limited OpenWrt supportability (due to limited FLOSS driver availability for Broadcom chips). (REF: OpenWRT.org)</p></div><p>Alright, so OpenWRT, DD-WRT, and Tomato projects have no firmware for this AC1200 with unpopular Broadcom chipsets. Into the refuse bin it goes.</p><p><a href="#top">Top ↩</a></p><hr><h2>Archer C5 v2 into the Refuse Bin, R7000 as the New Wi-Fi AP</h2><p>I’ve dismantled the AC1200 so I do not forget why I threw it out. It’s too bad because it’s so pretty on the inside, and they always say, “It is what is inside that counts… except if you are a router with Broadcom chips.”</p><figure id="attachment_5534"><a href="https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips.jpg"><img src="https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-754x566.jpg" alt="Inside the Archer C5 v2 with Broadcom chips" width="754" height="566" srcset="https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-754x566.jpg 754w, https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-300x225.jpg 300w, https://ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-600x450.jpg 600w, https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips.jpg 1008w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-754x566.jpg" data-srcset="https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-754x566.jpg 754w, https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-300x225.jpg 300w, https://ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-600x450.jpg 600w, https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips.jpg 1008w"></a><figcaption>Inside the Archer C5 v2 with Broadcom chips</figcaption></figure><p>The R7000 is factory reset, and here is the first problem:</p><div><p><strong>Tip:</strong> On factory reset, the Nighthawk R7000 is pretty uptight about the format of the password. One rule is that no more than two identical consecutive characters are allowed. Well, thanks Netgear for pretty much providing a Regex to password crackers. Let’s disable all those rules with a few keystrokes to delete the JavaScript “blocking” the form submission. Now my admin password does not conform to the Regex and is super long. Muhahaha to Netgear password crackers.</p></div><p>The R7000 is in AP mode, but I can still access the pfSense web management page from the Untrusted network. Let’s lock down the web UI in pfSense under Firewall Rules.</p><figure id="attachment_5847"><a href="https://ericdraken.com/files/Untrusted-network-firewall-rules.png"><img src="https://static.ericdraken.com/files/Untrusted-network-firewall-rules-754x310.png" alt="Untrusted network firewall rules" width="754" height="310" srcset="https://static.ericdraken.com/files/Untrusted-network-firewall-rules-754x310.png 754w, https://ericdraken.com/files/Untrusted-network-firewall-rules-300x124.png 300w, https://static.ericdraken.com/files/Untrusted-network-firewall-rules-600x247.png 600w, https://ericdraken.com/files/Untrusted-network-firewall-rules.png 1156w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Untrusted-network-firewall-rules-754x310.png" data-srcset="https://static.ericdraken.com/files/Untrusted-network-firewall-rules-754x310.png 754w, https://ericdraken.com/files/Untrusted-network-firewall-rules-300x124.png 300w, https://static.ericdraken.com/files/Untrusted-network-firewall-rules-600x247.png 600w, https://ericdraken.com/files/Untrusted-network-firewall-rules.png 1156w"></a><figcaption>Untrusted network firewall rules</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Set up the Trusted Wireless Network</h2><p>The Untrusted network is now looking good. It’s time to make the <em>other</em> R7000 Nighthawk I have into a Wi-Fi AP as well so my phone and watch have a safe place to connect to, as well as a laptop when I want to RDP into my wired machines from the kitchen. I was saving that for a honeypot AP, but I can come back to that later.</p><p>Let’s see if I can Wi-Fi into the Wireless LAN’s R7000…</p><div><p><strong>Tip:</strong> Remember to physically unplug the pfSense upstream router from the R7000 because the R7000 is too helpful and will enter into AP mode by sensing any upstream routers, then you cannot get into the web UI anymore.</p></div><p>Since only my trusted devices should be on the Wireless LAN, I’ll turn off 2.4 GHz wi-fi because anything recent and wireless should support 5 GHz. That means those pesky AliExpress Pineapple wi-fi password stealers on the cheap side only use 2.4 GHz, so a neighbour is going to have to put in some effort to snoop on my network. Plus, 5 GHz is blocked more easily by walls and concrete, so I prefer it for averting medium-range snooping. But, I so am going to set up a honeypot and to brake check my faith in humanity.</p><p>It is normally straightforward to put a Wi-Fi router into AP mode by disabling WAN and DHCP.</p><p><a href="#top">Top ↩</a></p><hr><h2>Network Devices Interconnectivity Check</h2><p>Do all my dozens of computers, laptops, Pis, clusters, NAS drives, and the like still connect as before? Most important is my web-scraping bot in a hardened, RAIDed, dedicated machine with its own UPS. But alas, I cannot SSH into it even though the SSH handshake packets make it to the hefty box.</p><p>Could this be our old frienemy IPv4 forwarding being disabled? Possibly. I’m able to SSH into the machine from my iPhone (seriously) when on the same network.</p><p>Nope. Adding <code>net.ipv4.ip_forward = 1</code> in the right place with a restart did not yield joy.</p><p>According to <code>dmesg -w</code> (to tail <code>dmesg</code> logs), UFW (Uncomplicated Firewall) is not blocking ICMP requests or TCP requests on port 22. When I do something nutty like try to SSH on, say, port 23, then I can see the UFW block logs in <code>dmesg</code>. Confirmed: Packets can reach that machine.</p><p>Running <code>tcpdump src 192.168.10.100</code> where the IP is from the Trusted network on the target machine shows it <em>is</em> responding to pings. I’m even getting replies to SSH handshake requests. So now we know that <em>return</em> packets are being dropped. Interesting! Aside: <code>tcpdump</code> is awesome.</p><p>Let’s follow the trail. Digging a little deeper I see replies to ICMP and SSH handshakes are being sent to some IP over HTTPS that I do not recognize. Bizzare. When I run the usual <code>ipinfo</code> tools I see that <a href="https://ericdraken.com/ssh-using-real-ip-bypass-vpn/" target="_blank">replies are going over a VPN</a> that I completely forgot about. Ha. Replies to a different subnet are egressing over the VPN, but cannot return properly. Neat.</p><figure id="attachment_5438"><a href="https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter.png"><img src="https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-754x303.png" alt="VPN causes ACK packets to return over the wrong adapter" width="754" height="303" srcset="https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-754x303.png 754w, https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-300x121.png 300w, https://static.ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-600x241.png 600w, https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter.png 1056w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-754x303.png" data-srcset="https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-754x303.png 754w, https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-300x121.png 300w, https://static.ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-600x241.png 600w, https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter.png 1056w"></a><figcaption>VPN causes ACK packets to return over the wrong adapter</figcaption></figure><p>Now that I remember what I did in 2019, I re-added NAT alias rules, and it’s showtime again.</p><p><a href="#top">Top ↩</a></p><hr><h2>Windows File Sharing Gotchas</h2><p>Your path may be smoother, but I’ve always seem to make the Trench Run instead of remote-piloting a handful of lead-filled X-Wings at light speed right <em>through</em> the Death Star’s reactor to make it go boom: the easy way.</p><p>I’ve added some rules to allow Static DHCP devices to talk to each other – Windows devices – but by default, the Private Network in the Windows Defender uses the local subnet as the rule scope. That means different subnets are isolated. We can’t just relax the pfSense DHCP subnet mask to say <code>192.168.20.0/16</code> because it conflicts with another subnet. Instead, just to get file sharing working, I relax the <code>scope</code> in Advanced Settings like below. Be sure to modify In and Out for SMB and ICMP.</p><figure id="attachment_5491"><a href="https://ericdraken.com/files/Windows-file-sharing-across-subnets.png"><img src="https://static.ericdraken.com/files/Windows-file-sharing-across-subnets-754x427.png" alt="Windows file sharing across subnets" width="754" height="427" srcset="https://static.ericdraken.com/files/Windows-file-sharing-across-subnets-754x427.png 754w, https://ericdraken.com/files/Windows-file-sharing-across-subnets-300x170.png 300w, https://static.ericdraken.com/files/Windows-file-sharing-across-subnets-600x340.png 600w, https://ericdraken.com/files/Windows-file-sharing-across-subnets.png 1496w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Windows-file-sharing-across-subnets-754x427.png" data-srcset="https://static.ericdraken.com/files/Windows-file-sharing-across-subnets-754x427.png 754w, https://ericdraken.com/files/Windows-file-sharing-across-subnets-300x170.png 300w, https://static.ericdraken.com/files/Windows-file-sharing-across-subnets-600x340.png 600w, https://ericdraken.com/files/Windows-file-sharing-across-subnets.png 1496w"></a><figcaption>Windows file sharing across subnets</figcaption></figure><p>Again, please add whatever subnets you desire instead of <code>any</code>.</p><p><a href="#top">Top ↩</a></p><hr><h2>Public Service Announcement: Edge Browser</h2><p>Why does the Microsoft Edge browser start automatically and run in the background, and why can’t I kill it when I <code>ctrl+alt+del</code>? If you’ve asked yourself this, you’re not alone. It turns out Edge starts up when you log in and it keeps running in the background. Here is the fix:</p><figure id="attachment_5540"><a href="https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser..png"><img src="https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-754x238.png" alt="Prevent Microsoft Edge from starting or running in the background. Sneaky browser." width="754" height="238" srcset="https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-754x238.png 754w, https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-300x95.png 300w, https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-600x190.png 600w, https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser..png 1214w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-754x238.png" data-srcset="https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-754x238.png 754w, https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-300x95.png 300w, https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-600x190.png 600w, https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser..png 1214w"></a><figcaption>Prevent Microsoft Edge from starting or running in the background. Sneaky browser.</figcaption></figure><p>I suggest downloading Winaero Tweaker and applying registry tweaks to cut down on the Redmond Spy Machine.</p><figure id="attachment_5565"><a href="https://ericdraken.com/files/Stop-Microsoft-from-spying-on-you.png"><img src="https://static.ericdraken.com/files/Stop-Microsoft-from-spying-on-you-754x454.png" alt="Stop Microsoft from spying on you" width="754" height="454" srcset="https://static.ericdraken.com/files/Stop-Microsoft-from-spying-on-you-754x454.png 754w, https://static.ericdraken.com/files/Stop-Microsoft-from-spying-on-you-300x181.png 300w, https://ericdraken.com/files/Stop-Microsoft-from-spying-on-you-600x361.png 600w, https://ericdraken.com/files/Stop-Microsoft-from-spying-on-you.png 899w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Stop-Microsoft-from-spying-on-you-754x454.png" data-srcset="https://static.ericdraken.com/files/Stop-Microsoft-from-spying-on-you-754x454.png 754w, https://static.ericdraken.com/files/Stop-Microsoft-from-spying-on-you-300x181.png 300w, https://ericdraken.com/files/Stop-Microsoft-from-spying-on-you-600x361.png 600w, https://ericdraken.com/files/Stop-Microsoft-from-spying-on-you.png 899w"></a><figcaption>Stop Microsoft from spying on you</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Block Clickbait, Endless Ads, and Dangerous Sites</h2><p>Thanks to web-browser and DNS-level adblockers (i.e. Pi-hole), it’s commonplace to block bad sites, crypto-miners, fingerprinters, trackers, remarketers, banners, pop-ups, fake tech-support scam alerts, and all manner of unscrupulousness designed to take advantage of you. Let’s take pfBlockerNG on pfSense for spin.</p><figure id="attachment_5429"><a href="https://static.ericdraken.com/files/pfBlockerNG-blocking-ad-domains.png"><img src="https://ericdraken.com/files/pfBlockerNG-blocking-ad-domains-754x282.png" alt="pfBlockerNG blocking ad domains with graphs" width="754" height="282" srcset="https://ericdraken.com/files/pfBlockerNG-blocking-ad-domains-754x282.png 754w, https://ericdraken.com/files/pfBlockerNG-blocking-ad-domains-300x112.png 300w, https://static.ericdraken.com/files/pfBlockerNG-blocking-ad-domains-600x224.png 600w, https://static.ericdraken.com/files/pfBlockerNG-blocking-ad-domains.png 1149w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/pfBlockerNG-blocking-ad-domains-754x282.png" data-srcset="https://ericdraken.com/files/pfBlockerNG-blocking-ad-domains-754x282.png 754w, https://ericdraken.com/files/pfBlockerNG-blocking-ad-domains-300x112.png 300w, https://static.ericdraken.com/files/pfBlockerNG-blocking-ad-domains-600x224.png 600w, https://static.ericdraken.com/files/pfBlockerNG-blocking-ad-domains.png 1149w"></a><figcaption>pfBlockerNG blocking ad domains with graphs</figcaption></figure><p>The pie chart looks great. I followed this <a href="https://tekgru.com/how-to-block-ads-on-pfsense-with-pfblockerng-and-dnsbl/" target="_blank" rel="nofollow">pfBlockerNG tutorial</a>.</p><figure id="attachment_5433"><a href="https://static.ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog.png"><img src="https://ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-754x396.png" alt="Tekgru.com pfBlockerNG tutorial blog" width="754" height="396" srcset="https://ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-754x396.png 754w, https://static.ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-300x157.png 300w, https://ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-600x315.png 600w, https://static.ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog.png 764w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-754x396.png" data-srcset="https://ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-754x396.png 754w, https://static.ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-300x157.png 300w, https://ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-600x315.png 600w, https://static.ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog.png 764w"></a><figcaption>Tekgru.com pfBlockerNG tutorial blog</figcaption></figure><p><strong><span>This is mportant:</span></strong> If you have multiple network interfaces (the mini PC has four), then you need to enable the Permit Firewall Rules for multiple interfaces and select them.</p><figure id="attachment_5434"><a href="https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces.png"><img src="https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-754x125.png" alt="DNSBL Perfmit Firewall Rules for multiple interfaces" width="754" height="125" srcset="https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-754x125.png 754w, https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-300x50.png 300w, https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-600x100.png 600w, https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces.png 1005w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-754x125.png" data-srcset="https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-754x125.png 754w, https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-300x50.png 300w, https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-600x100.png 600w, https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces.png 1005w"></a><figcaption>DNSBL Perfmit Firewall Rules for multiple interfaces</figcaption></figure><p>Would you like to have discretion over blocklists? Let’s add a DNS blocklist related to gambling and reload pfBlockerNG to see if a poker site is blocked on the Trusted LAN.</p><figure id="attachment_5435"><a href="https://static.ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked.png"><img src="https://ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-754x187.png" alt="Some sketchy poker sites are now blocked" width="754" height="187" srcset="https://ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-754x187.png 754w, https://ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-300x74.png 300w, https://static.ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-600x148.png 600w, https://static.ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked.png 881w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-754x187.png" data-srcset="https://ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-754x187.png 754w, https://ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-300x74.png 300w, https://static.ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-600x148.png 600w, https://static.ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked.png 881w"></a><figcaption>Some sketchy poker sites are now blocked</figcaption></figure><p>If you would prefer the connection to just close instead of rendering a PHP page, create a new PHP script with the following code and select it in the pfBlockerNG settings page:</p><div id="crayon-63661eaabe495363075859" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>&lt;?php</span></p><p><span># nano /usr/local/www/pfblockerng/www/killed.php</span></p><p><span>ignore_user_abort</span><span>(</span><span>true</span><span>)</span><span>;</span></p><p><span>fastcgi_finish_request</span><span>(</span><span>)</span><span>;</span></p></div></td></tr></tbody></table></div><p><a href="#top">Top ↩</a></p><hr><h2>Intercept All DNS Requests, Even to Hardcoded DNS Servers</h2><p>Let’s make sure all clients behind the pfSense router use the local Unbound DNS server so pfBlockerNG can act on them. We do not want apps and home assistants to bypass our DNS server, so we have to add some NAT rules.</p><figure id="attachment_5439"><a href="https://static.ericdraken.com/files/Trap-all-DNS-and-DNSTLS-requests.png"><img src="https://static.ericdraken.com/files/Trap-all-DNS-and-DNSTLS-requests.png" alt="Trap all DNS and DNS+TLS requests" width="563" height="316" srcset="https://static.ericdraken.com/files/Trap-all-DNS-and-DNSTLS-requests.png 563w, https://ericdraken.com/files/Trap-all-DNS-and-DNSTLS-requests-300x168.png 300w" sizes="(max-width: 563px) 100vw, 563px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Trap-all-DNS-and-DNSTLS-requests.png" data-srcset="https://static.ericdraken.com/files/Trap-all-DNS-and-DNSTLS-requests.png 563w, https://ericdraken.com/files/Trap-all-DNS-and-DNSTLS-requests-300x168.png 300w"></a><figcaption>Trap all DNS and DNS+TLS requests</figcaption></figure><p>First, we have to block DNS over TLS (for now) and only allow local DNS requests (note the rule order):</p><figure id="attachment_5655"><a href="https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries.png"><img src="https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-754x386.png" alt="Overarching DNS rules allowing only internal DNS queries" width="754" height="386" srcset="https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-754x386.png 754w, https://ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-300x154.png 300w, https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-600x307.png 600w, https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries.png 949w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-754x386.png" data-srcset="https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-754x386.png 754w, https://ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-300x154.png 300w, https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-600x307.png 600w, https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries.png 949w"></a><figcaption>Overarching DNS rules allowing only internal DNS queries</figcaption></figure><div><p><strong>Note:</strong> DNS over TLS must be blocked (for now) for all clients behind the pfSense router in order to allow DNS query trapping to succeed. An iPhone may show a Privacy Warning that the network is blocking encrypted DNS traffic. That is okay because we are encrypting upstream DNS requests to Cloudflare.</p><p><a href="https://static.ericdraken.com/files/We-can-ignore-the-Privacy-Warning-in-devices-behind-the-pfSense-router.png"><img src="https://static.ericdraken.com/files/We-can-ignore-the-Privacy-Warning-in-devices-behind-the-pfSense-router.png" alt="We can ignore the Privacy Warning in devices behind the pfSense router" width="521" height="489" srcset="https://static.ericdraken.com/files/We-can-ignore-the-Privacy-Warning-in-devices-behind-the-pfSense-router.png 521w, https://ericdraken.com/files/We-can-ignore-the-Privacy-Warning-in-devices-behind-the-pfSense-router-300x282.png 300w" sizes="(max-width: 521px) 100vw, 521px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/We-can-ignore-the-Privacy-Warning-in-devices-behind-the-pfSense-router.png" data-srcset="https://static.ericdraken.com/files/We-can-ignore-the-Privacy-Warning-in-devices-behind-the-pfSense-router.png 521w, https://ericdraken.com/files/We-can-ignore-the-Privacy-Warning-in-devices-behind-the-pfSense-router-300x282.png 300w"></a></p></div><p>Here is a NAT rule for one interface. I started by making a rule for each interface except WAN (obviously) like this below.</p><figure id="attachment_5440"><a href="https://static.ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface.png"><img src="https://ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-754x739.png" alt="Example rule to trap DNS queries on a given interface" width="754" height="739" srcset="https://ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-754x739.png 754w, https://ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-300x294.png 300w, https://static.ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-600x588.png 600w, https://static.ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface.png 1031w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-754x739.png" data-srcset="https://ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-754x739.png 754w, https://ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-300x294.png 300w, https://static.ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-600x588.png 600w, https://static.ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface.png 1031w"></a><figcaption>Example rule to trap DNS queries on a given interface</figcaption></figure><div><p><strong>Tip:</strong> NAT reflection should be disabled so the wild Internet cannot access our DNS server.</p></div><p>To make life simpler, I made a firewall alias of all non-WAN interfaces called <code>Non_WAN</code>. Covering IPv4 and IPV6 to redirect local DNS queries on port 53 to localhost are the following redirect rules:</p><figure id="attachment_5660"><a href="https://ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost.png"><img src="https://ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-754x165.png" alt="Firewall DNS query redirect rules to localhost" width="754" height="165" srcset="https://ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-754x165.png 754w, https://static.ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-300x66.png 300w, https://static.ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-600x131.png 600w, https://ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost.png 945w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-754x165.png" data-srcset="https://ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-754x165.png 754w, https://static.ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-300x66.png 300w, https://static.ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-600x131.png 600w, https://ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost.png 945w"></a><figcaption>Firewall DNS query redirect rules to localhost</figcaption></figure><p>Let’s also log trapped DNS requests. Head to the <code>Services &gt; DNS Resolver</code> page, click “Display Custom Options”, and add the lines:</p><p>Well, hello there, Microsoft Windows. What are you up to trying to reach Google Tag Manager? Naughty OS. That request is now black-holed to a non-existent IP at <code>10.10.10.1</code>.</p><figure id="attachment_5445"><a href="https://static.ericdraken.com/files/Windows-is-trying-to-reach-Google-Tag-Manager.png"><img src="https://static.ericdraken.com/files/Windows-is-trying-to-reach-Google-Tag-Manager.png" alt="Windows is trying to reach Google Tag Manager" width="439" height="476" srcset="https://static.ericdraken.com/files/Windows-is-trying-to-reach-Google-Tag-Manager.png 439w, https://static.ericdraken.com/files/Windows-is-trying-to-reach-Google-Tag-Manager-277x300.png 277w" sizes="(max-width: 439px) 100vw, 439px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Windows-is-trying-to-reach-Google-Tag-Manager.png" data-srcset="https://static.ericdraken.com/files/Windows-is-trying-to-reach-Google-Tag-Manager.png 439w, https://static.ericdraken.com/files/Windows-is-trying-to-reach-Google-Tag-Manager-277x300.png 277w"></a><figcaption>Windows is trying to reach Google Tag Manager</figcaption></figure><p>Let’s turn our attention to the TV and see how it fares under DNS interception.</p><p><a href="#top">Top ↩</a></p><hr><h2>How to Restrict Apple TV and iPhone YouTube Ads?</h2><div><p><strong>YouTube:</strong> Regarding YouTube, YouTube has been showing 7-second and 15-second ads, twice, back-to-back, nearly every few minutes. Why are the ads incessant and so long? I do not mind the occasional ad, similar to live TV, but these frequent ads would warrant FTC complaints it they were on live TV.</p></div><p>YouTube is tricky because ads are also videos that come from the same domain, so domain-name blockers like pfBlockerNG cannot act on them. The best pfBlockerNG and Pi-hole can do is block <code>googleadservices.com</code> only after you watch an ad video and click on the ad.</p><p>Many people opt to use a web browser like Firefox or Chrome with <a href="https://chrome.google.com/webstore/detail/ublock-origin/cjpalhdlnbpafiamejdnhcphjbkeiagm?hl=en" target="_blank" rel="nofollow">uBlock Origin</a> that acts on JavaScript as a workaround. It might be enough to watch YouTube on a web browser and stream that to a smart TV. However, we cannot restrict ads on the iPhone (without jailbreaking and compromising it).</p><p>What are our options? How can we safely restrict YouTube ads on all network devices?</p><p><a href="#top">Top ↩</a></p><hr><h2>Trick the YouTube Ad Algorithm Instead</h2><div><p><strong>Thought Experiment:</strong> Among friends, let’s say that English-speaking countries get ads for the most ridiculous things because their residents are assumed to have disposable income. Can we instead make YouTube think we are an undesirable advertising target?</p></div><p>What do ads in other parts of the world look like? Are those living in Antarctica or <a href="https://xkcd.com/713/" target="_blank" rel="nofollow">Low Earth Orbit</a> getting a lot of ads too?</p><figure id="attachment_5449"><a href="https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers.png"><img src="https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers.png" alt="Xkcd.com: Mess with advertisers" width="683" height="264" srcset="https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers.png 683w, https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers-300x116.png 300w, https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers-600x232.png 600w" sizes="(max-width: 683px) 100vw, 683px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers.png" data-srcset="https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers.png 683w, https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers-300x116.png 300w, https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers-600x232.png 600w"></a><figcaption>Xkcd.com: Mess with advertisers</figcaption></figure><p>What would happen if we leverage the capabilities of this pfSense router to route YouTube Location Tracking information through a VPN that terminates in some remote part of the world with fewer YouTube viewers per capita? In other words, let’s make ourselves undesirable to advertisers and see if we get fewer ads.</p><figure id="attachment_5880"><a href="https://ericdraken.com/files/soured-the-milk.jpg"><img src="https://ericdraken.com/files/soured-the-milk.jpg" alt="Scotty from TNG episode 'Relics' understands the plan" width="620" height="448" srcset="https://ericdraken.com/files/soured-the-milk.jpg 620w, https://ericdraken.com/files/soured-the-milk-300x217.jpg 300w, https://ericdraken.com/files/soured-the-milk-600x434.jpg 600w" sizes="(max-width: 620px) 100vw, 620px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/soured-the-milk.jpg" data-srcset="https://ericdraken.com/files/soured-the-milk.jpg 620w, https://ericdraken.com/files/soured-the-milk-300x217.jpg 300w, https://ericdraken.com/files/soured-the-milk-600x434.jpg 600w"></a><figcaption>Scotty from TNG episode ‘Relics’ understands the plan</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Research into YouTube Advertizing Spend</h2><p>Let’s do some <a href="https://www.statista.com/statistics/272859/mobile-advertising-spending-worldwide/" rel="nofollow">YouTube demographics research</a> to find a part of the world avoided by advertisers.</p><figure id="attachment_5452"><a href="https://ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020.png"><img src="https://static.ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-754x427.png" alt="Mobile advertiser spend by country in 2020 (REF: statista.com)" width="754" height="427" srcset="https://static.ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-754x427.png 754w, https://static.ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-300x170.png 300w, https://ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-600x340.png 600w, https://ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020.png 1203w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-754x427.png" data-srcset="https://static.ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-754x427.png 754w, https://static.ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-300x170.png 300w, https://ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-600x340.png 600w, https://ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020.png 1203w"></a><figcaption>Mobile advertiser spend by country in 2020</figcaption></figure><p>Let’s also check some <a href="https://medium.com/@ChannelMeter/youtubes-top-countries-47b0d26dded" target="_blank" rel="nofollow">YouTube statistics</a> about viewers by country for insights. Thinking about following some Reddit advice and VPN’ing into India? Think again.</p><figure id="attachment_5453"><a href="https://static.ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter.png"><img src="https://ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-754x425.png" alt="Total YouTube views by country in 2019 (REF: ChannelMeter)" width="754" height="425" srcset="https://ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-754x425.png 754w, https://static.ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-300x169.png 300w, https://ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-600x338.png 600w, https://static.ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter.png 1000w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-754x425.png" data-srcset="https://ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-754x425.png 754w, https://static.ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-300x169.png 300w, https://ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-600x338.png 600w, https://static.ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter.png 1000w"></a><figcaption>Total YouTube views by country in 2019 (REF: ChannelMeter)</figcaption></figure><p>That was 2019. This is <a href="https://backlinko.com/youtube-users" target="_blank" rel="nofollow">2020</a>:</p><figure id="attachment_5454"><a href="https://ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_.png"><img src="https://ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_.png" alt="Top ten YouTube countries with population (REF: backlinko.com)" width="710" height="417" srcset="https://ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_.png 710w, https://ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_-300x176.png 300w, https://static.ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_-600x352.png 600w" sizes="(max-width: 710px) 100vw, 710px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_.png" data-srcset="https://ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_.png 710w, https://ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_-300x176.png 300w, https://static.ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_-600x352.png 600w"></a><figcaption>Top ten YouTube countries with population (REF: backlinko.com)</figcaption></figure><p>I’m not a digital advertiser, but I can see that people in the UK and Canada watch a large number of videos per sitting. If I <em>were</em> an advertiser though, I’d pump those two countries with video ad after video ad because, statistically, those residents will take the eyeball kicking. All things being equal, I definitely need a VPN to terminate outside of Canada, the UK, and the United States (English-speaking countries) to enjoy YouTube more.</p><p>Does age play a factor? Who <strong>don’t</strong> advertisers want? I want to be that guy on paper.</p><figure id="attachment_5455"><a href="https://static.ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_.png"><img src="https://static.ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_.png" alt="YouTube age demographics as of 2020 (REF: backlinko.com)" width="710" height="176" srcset="https://static.ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_.png 710w, https://ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_-300x74.png 300w, https://static.ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_-600x149.png 600w" sizes="(max-width: 710px) 100vw, 710px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_.png" data-srcset="https://static.ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_.png 710w, https://ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_-300x74.png 300w, https://static.ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_-600x149.png 600w"></a><figcaption>YouTube age demographics as of 2020 (REF: backlinko.com)</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><div><p><a name="new-goal-trick"></a><strong>New Goal:</strong> Let’s trick YouTube into believing I am a 70-year-old male living in Italy. Yes, that should definitely cut down on the Nespresso and Starbucks ads, at least.</p></div><p>How then to convince YouTube that I am a retired Sicilian living on a small chain island? I embellished that last part. Seventy and in Italy is sufficient.</p><p>Let’s do this. In the YouTube account…</p><figure id="attachment_5457"><a href="https://ericdraken.com/files/I-am-71-years-old.png"><img src="https://ericdraken.com/files/I-am-71-years-old.png" alt="I am 71 years old" width="601" height="516" srcset="https://ericdraken.com/files/I-am-71-years-old.png 601w, https://ericdraken.com/files/I-am-71-years-old-300x258.png 300w, https://ericdraken.com/files/I-am-71-years-old-600x515.png 600w" sizes="(max-width: 601px) 100vw, 601px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/I-am-71-years-old.png" data-srcset="https://ericdraken.com/files/I-am-71-years-old.png 601w, https://ericdraken.com/files/I-am-71-years-old-300x258.png 300w, https://ericdraken.com/files/I-am-71-years-old-600x515.png 600w"></a><figcaption>I am <del>Iron Man</del> 71 years old</figcaption></figure><figure id="attachment_5458"><a href="https://static.ericdraken.com/files/I-am-in-Italy.png"><img src="https://static.ericdraken.com/files/I-am-in-Italy.png" alt="I am in Italy" width="317" height="455" srcset="https://static.ericdraken.com/files/I-am-in-Italy.png 317w, https://ericdraken.com/files/I-am-in-Italy-209x300.png 209w" sizes="(max-width: 317px) 100vw, 317px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/I-am-in-Italy.png" data-srcset="https://static.ericdraken.com/files/I-am-in-Italy.png 317w, https://ericdraken.com/files/I-am-in-Italy-209x300.png 209w"></a><figcaption>I am in Italy</figcaption></figure><p>It is doubtful that this is all it takes for our goal. Let’s find a VPN exit point in Italy.</p><figure id="attachment_5459"><a href="https://ericdraken.com/out/nordvpn"><img src="https://ericdraken.com/files/NordVPN-has-60-servers-in-Italy-754x383.png" alt="NordVPN has 60+ servers in Italy" width="754" height="383" srcset="https://ericdraken.com/files/NordVPN-has-60-servers-in-Italy-754x383.png 754w, https://static.ericdraken.com/files/NordVPN-has-60-servers-in-Italy-300x153.png 300w, https://ericdraken.com/files/NordVPN-has-60-servers-in-Italy-600x305.png 600w, https://static.ericdraken.com/files/NordVPN-has-60-servers-in-Italy.png 1166w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/NordVPN-has-60-servers-in-Italy-754x383.png" data-srcset="https://ericdraken.com/files/NordVPN-has-60-servers-in-Italy-754x383.png 754w, https://static.ericdraken.com/files/NordVPN-has-60-servers-in-Italy-300x153.png 300w, https://ericdraken.com/files/NordVPN-has-60-servers-in-Italy-600x305.png 600w, https://static.ericdraken.com/files/NordVPN-has-60-servers-in-Italy.png 1166w"></a><figcaption>NordVPN has 60+ servers in Italy</figcaption></figure><p>Nice. <a href="https://ericdraken.com/out/nordvpn" target="_blank">NordVPN</a> has about 60 servers in Italy (that’s an affiliate link by the way).</p><p><a href="#top">Top ↩</a></p><hr><h2>Selectively Route Apple TV Over the VPN</h2><p>Let’s go through some tutorials to set up <em>OpenVPN</em> in pfSense. Just kidding! We’re going to use WireGuard – we have the Intel AES-NI crypto instruction set because we didn’t go cheap and get a yesteryear J1900 mini PC that sellers are trying to offload.</p><p>I’ll now install the FreeBSD WireGuard package.</p><figure id="attachment_5462"><a href="https://static.ericdraken.com/files/Install-the-WireGuard-package-in-pfSense.png"><img src="https://ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-754x328.png" alt="Install the WireGuard package in pfSense" width="754" height="328" srcset="https://ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-754x328.png 754w, https://static.ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-300x131.png 300w, https://static.ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-600x261.png 600w, https://static.ericdraken.com/files/Install-the-WireGuard-package-in-pfSense.png 1144w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-754x328.png" data-srcset="https://ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-754x328.png 754w, https://static.ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-300x131.png 300w, https://static.ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-600x261.png 600w, https://static.ericdraken.com/files/Install-the-WireGuard-package-in-pfSense.png 1144w"></a><figcaption>Install the WireGuard package in pfSense</figcaption></figure><p>Next, add a tunnel and enable it. According to this <a href="https://www.reddit.com/r/PFSENSE/comments/m0989o/nordvpn_wireguard_setup_works/" target="_blank" rel="nofollow">thread</a> and this <a href="https://www.reddit.com/r/PFSENSE/comments/m0989o/nordvpn_wireguard_setup_works/" target="_blank" rel="nofollow">thread</a> on Reddit, we need to get some information for WireGuard and NordLynx from a sacrificial Linux VM to transpose the settings (i.e. private key) to the pfSense router. No problem.</p><figure id="attachment_5463"><a href="https://ericdraken.com/files/Connect-to-Italy-over-WireGuard.png"><img src="https://ericdraken.com/files/Connect-to-Italy-over-WireGuard.png" alt="Connect to Italy over WireGuard" width="547" height="85" srcset="https://ericdraken.com/files/Connect-to-Italy-over-WireGuard.png 547w, https://static.ericdraken.com/files/Connect-to-Italy-over-WireGuard-300x47.png 300w" sizes="(max-width: 547px) 100vw, 547px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Connect-to-Italy-over-WireGuard.png" data-srcset="https://ericdraken.com/files/Connect-to-Italy-over-WireGuard.png 547w, https://static.ericdraken.com/files/Connect-to-Italy-over-WireGuard-300x47.png 300w"></a><figcaption>Connect to Italy over WireGuard</figcaption></figure><figure id="attachment_5464"><a href="https://static.ericdraken.com/files/WireGuard-config-information-via-wg-show.png"><img src="https://static.ericdraken.com/files/WireGuard-config-information-via-wg-show.png" alt="WireGuard config information via wg show" width="608" height="233" srcset="https://static.ericdraken.com/files/WireGuard-config-information-via-wg-show.png 608w, https://static.ericdraken.com/files/WireGuard-config-information-via-wg-show-300x115.png 300w, https://ericdraken.com/files/WireGuard-config-information-via-wg-show-600x230.png 600w" sizes="(max-width: 608px) 100vw, 608px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/WireGuard-config-information-via-wg-show.png" data-srcset="https://static.ericdraken.com/files/WireGuard-config-information-via-wg-show.png 608w, https://static.ericdraken.com/files/WireGuard-config-information-via-wg-show-300x115.png 300w, https://ericdraken.com/files/WireGuard-config-information-via-wg-show-600x230.png 600w"></a><figcaption>WireGuard config information via wg show</figcaption></figure><p>Run <code>sudo wg showconf nordlynx</code> to see your private key needed by the pfSense tunnel config.</p><p>Here are various screenshots that show the steps in more detail.</p><figure id="attachment_5477"><a href="https://static.ericdraken.com/files/VPN-WireGuard-Tunnels.png"><img src="https://static.ericdraken.com/files/VPN-WireGuard-Tunnels-754x450.png" alt="VPN > WireGuard > Tunnels" width="754" height="450" srcset="https://static.ericdraken.com/files/VPN-WireGuard-Tunnels-754x450.png 754w, https://static.ericdraken.com/files/VPN-WireGuard-Tunnels-300x179.png 300w, https://ericdraken.com/files/VPN-WireGuard-Tunnels-600x358.png 600w, https://static.ericdraken.com/files/VPN-WireGuard-Tunnels.png 1154w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/VPN-WireGuard-Tunnels-754x450.png" data-srcset="https://static.ericdraken.com/files/VPN-WireGuard-Tunnels-754x450.png 754w, https://static.ericdraken.com/files/VPN-WireGuard-Tunnels-300x179.png 300w, https://ericdraken.com/files/VPN-WireGuard-Tunnels-600x358.png 600w, https://static.ericdraken.com/files/VPN-WireGuard-Tunnels.png 1154w"></a><figcaption>VPN &gt; WireGuard &gt; Tunnels</figcaption></figure><figure id="attachment_5478"><a href="https://ericdraken.com/files/VPN-WireGuard-Peers.png"><img src="https://ericdraken.com/files/VPN-WireGuard-Peers-754x563.png" alt="VPN > WireGuard > Peers" width="754" height="563" srcset="https://ericdraken.com/files/VPN-WireGuard-Peers-754x563.png 754w, https://ericdraken.com/files/VPN-WireGuard-Peers-300x224.png 300w, https://ericdraken.com/files/VPN-WireGuard-Peers-600x448.png 600w, https://ericdraken.com/files/VPN-WireGuard-Peers.png 1147w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/VPN-WireGuard-Peers-754x563.png" data-srcset="https://ericdraken.com/files/VPN-WireGuard-Peers-754x563.png 754w, https://ericdraken.com/files/VPN-WireGuard-Peers-300x224.png 300w, https://ericdraken.com/files/VPN-WireGuard-Peers-600x448.png 600w, https://ericdraken.com/files/VPN-WireGuard-Peers.png 1147w"></a><figcaption>VPN &gt; WireGuard &gt; Peers</figcaption></figure><div><p><strong>Tip:</strong> Enter <code>1.0.0.0</code> and then <code>0</code> as the subnet mask. Do not go for <code>0.0.0.0</code> as there is a glitch or bug in the UI or whathaveyou. The result will still be <code>0.0.0.0/0</code>.</p></div><figure id="attachment_5479"><a href="https://static.ericdraken.com/files/VPN-WireGuard-Settings.png"><img src="https://static.ericdraken.com/files/VPN-WireGuard-Settings-754x345.png" alt="VPN > WireGuard > Settings" width="754" height="345" srcset="https://static.ericdraken.com/files/VPN-WireGuard-Settings-754x345.png 754w, https://ericdraken.com/files/VPN-WireGuard-Settings-300x137.png 300w, https://ericdraken.com/files/VPN-WireGuard-Settings-600x275.png 600w, https://static.ericdraken.com/files/VPN-WireGuard-Settings.png 1153w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/VPN-WireGuard-Settings-754x345.png" data-srcset="https://static.ericdraken.com/files/VPN-WireGuard-Settings-754x345.png 754w, https://ericdraken.com/files/VPN-WireGuard-Settings-300x137.png 300w, https://ericdraken.com/files/VPN-WireGuard-Settings-600x275.png 600w, https://static.ericdraken.com/files/VPN-WireGuard-Settings.png 1153w"></a><figcaption>VPN &gt; WireGuard &gt; Settings</figcaption></figure><figure id="attachment_5480"><a href="https://static.ericdraken.com/files/Interfaces-Interface-Assignments.png"><img src="https://static.ericdraken.com/files/Interfaces-Interface-Assignments-754x248.png" alt="Interfaces > Interface Assignments" width="754" height="248" srcset="https://static.ericdraken.com/files/Interfaces-Interface-Assignments-754x248.png 754w, https://ericdraken.com/files/Interfaces-Interface-Assignments-300x99.png 300w, https://static.ericdraken.com/files/Interfaces-Interface-Assignments-600x197.png 600w, https://static.ericdraken.com/files/Interfaces-Interface-Assignments.png 1153w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Interfaces-Interface-Assignments-754x248.png" data-srcset="https://static.ericdraken.com/files/Interfaces-Interface-Assignments-754x248.png 754w, https://ericdraken.com/files/Interfaces-Interface-Assignments-300x99.png 300w, https://static.ericdraken.com/files/Interfaces-Interface-Assignments-600x197.png 600w, https://static.ericdraken.com/files/Interfaces-Interface-Assignments.png 1153w"></a><figcaption>Interfaces &gt; Interface Assignments</figcaption></figure><p>That should be enough to allow Diagnostics to <code>curl</code> Italy.</p><figure id="attachment_5466"><a href="https://static.ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense.png"><img src="https://ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-754x203.png" alt="Successfully connected to NordVPN through WireGuard on pfSense" width="754" height="203" srcset="https://ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-754x203.png 754w, https://static.ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-300x81.png 300w, https://static.ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-600x161.png 600w, https://static.ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense.png 1148w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-754x203.png" data-srcset="https://ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-754x203.png 754w, https://static.ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-300x81.png 300w, https://static.ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-600x161.png 600w, https://static.ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense.png 1148w"></a><figcaption>Successfully connected to NordVPN through WireGuard on pfSense</figcaption></figure><figure id="attachment_5468"><a href="https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified.png"><img src="https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified-754x479.png" alt="Successfully connect to Italy and verified" width="754" height="479" srcset="https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified-754x479.png 754w, https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified-300x191.png 300w, https://ericdraken.com/files/Successfully-connect-to-Italy-and-verified-600x381.png 600w, https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified.png 757w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified-754x479.png" data-srcset="https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified-754x479.png 754w, https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified-300x191.png 300w, https://ericdraken.com/files/Successfully-connect-to-Italy-and-verified-600x381.png 600w, https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified.png 757w"></a><figcaption>Successfully connect to Italy and verified</figcaption></figure><p>Now that the easy part is out of the way, let’s set some Policy rules to send the Apple TV traffic over the VPN to Italy as a baseline test.</p><p>From Netgate, on the <a href="https://docs.netgate.com/pfsense/en/latest/nat/process-order.html" target="_blank" rel="nofollow">order of Firewall/NAT processing</a>:</p><blockquote><p>Traffic from LAN to WAN is processed as described in the following more detailed example.</p><ul><li>Port forwards or 1:1 NAT on the LAN interface (e.g. proxy or DNS redirects)</li><li>Firewall rules for the LAN interface:<ul><li>Floating rules inbound on LAN</li><li>Rules for interface groups including the LAN interface</li><li>LAN tab rules</li></ul></li><li>1:1 NAT or Outbound NAT rules on WAN</li><li>Floating rules that match outbound on WAN</li></ul></blockquote><p>I’ll make an alias, for now, to hold some clients that have static DHCP entries and hostnames I gave them in pfSense.</p><figure id="attachment_5483"><a href="https://static.ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page.png"><img src="https://ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-754x171.png" alt="VPN clients in the Firewall > Aliases > IP page" width="754" height="171" srcset="https://ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-754x171.png 754w, https://static.ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-300x68.png 300w, https://ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-600x136.png 600w, https://static.ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page.png 1149w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-754x171.png" data-srcset="https://ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-754x171.png 754w, https://static.ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-300x68.png 300w, https://ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-600x136.png 600w, https://static.ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page.png 1149w"></a><figcaption>VPN clients in the Firewall &gt; Aliases &gt; IP page</figcaption></figure><p>Floating rules <strong>in</strong> have high precedence, so I’ll add some rules below the automatic pfBlockerNG rules that were created, and I’ll add a nice little blue separator while I’m here.</p><figure id="attachment_5484"><a href="https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy.png"><img src="https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-754x463.png" alt="Floating rule to route select clients over the VPN to Italy" width="754" height="463" srcset="https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-754x463.png 754w, https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-300x184.png 300w, https://static.ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-600x369.png 600w, https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy.png 1151w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-754x463.png" data-srcset="https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-754x463.png 754w, https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-300x184.png 300w, https://static.ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-600x369.png 600w, https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy.png 1151w"></a><figcaption>Floating rule to route select clients over the VPN to Italy</figcaption></figure><p>And here is that rule as a very long screenshot:</p><figure id="attachment_5485"><a href="https://ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN.png"><img src="https://static.ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-754x1712.png" alt="Firewall > Rules > Floating rule to route select clients over the VPN" width="754" height="1712" srcset="https://static.ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-754x1712.png 754w, https://ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-132x300.png 132w, https://ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-600x1363.png 600w, https://ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN.png 1147w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-754x1712.png" data-srcset="https://static.ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-754x1712.png 754w, https://ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-132x300.png 132w, https://ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-600x1363.png 600w, https://ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN.png 1147w"></a><figcaption>Firewall &gt; Rules &gt; Floating rule to route select clients over the VPN</figcaption></figure><p>Apply. Wait. Let’s try it out using one of my notebooks connected to the Untrusted network.</p><figure id="attachment_5492"><a href="https://ericdraken.com/files/Google-is-entirely-in-Italian-now.png"><img src="https://static.ericdraken.com/files/Google-is-entirely-in-Italian-now-754x393.png" alt="Google is entirely in Italian now" width="754" height="393" srcset="https://static.ericdraken.com/files/Google-is-entirely-in-Italian-now-754x393.png 754w, https://static.ericdraken.com/files/Google-is-entirely-in-Italian-now-300x156.png 300w, https://ericdraken.com/files/Google-is-entirely-in-Italian-now-600x312.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Google-is-entirely-in-Italian-now-754x393.png" data-srcset="https://static.ericdraken.com/files/Google-is-entirely-in-Italian-now-754x393.png 754w, https://static.ericdraken.com/files/Google-is-entirely-in-Italian-now-300x156.png 300w, https://ericdraken.com/files/Google-is-entirely-in-Italian-now-600x312.png 600w"></a><figcaption>Google is entirely in Italian now</figcaption></figure><p>Google is in Italian. Very cool. Now for the Apple TV.</p><figure id="attachment_5509"><a href="https://ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy.jpg"><img src="https://ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-754x318.jpg" alt="Apple TV's YouTube reports I am in Italy" width="754" height="318" srcset="https://ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-754x318.jpg 754w, https://static.ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-300x126.jpg 300w, https://ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-600x253.jpg 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-754x318.jpg" data-srcset="https://ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-754x318.jpg 754w, https://static.ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-300x126.jpg 300w, https://ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-600x253.jpg 600w"></a><figcaption>Apple TV’s YouTube reports I am in Italy</figcaption></figure><p>Winner winner, chicken diner. All my YouTube is in Italian. I get some ads, not as many, but because Italians speak slowly and with a kind of sexy accent I do not mind the ads for Nutella at all.</p><p>With this technique, I no longer feel manipulated by non-English ads. I have personalized ads <em>off</em>, but given my new status as a retired gentleman I should turn that back on to scare away advertising dollars, er, euros. I wonder if Netflix and Amazon Prime behave any differently…</p><figure id="attachment_5508"><a href="https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked.jpg"><img src="https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-754x524.jpg" alt="Some Netflix assets are being blocked" width="754" height="524" srcset="https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-754x524.jpg 754w, https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-300x208.jpg 300w, https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-600x417.jpg 600w, https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked.jpg 1276w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-754x524.jpg" data-srcset="https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-754x524.jpg 754w, https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-300x208.jpg 300w, https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-600x417.jpg 600w, https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked.jpg 1276w"></a><figcaption>Some Netflix assets are being blocked</figcaption></figure><p>Dang. Netflix is having problems. Amazon Prime is even worse. It looks like some CSS or font files are blocked as well, and the thumbnails aren’t loading. It’s time to move to Phase Two: Tunnel only YouTube traffic over the VPN.</p><div><p><strong>Warning:</strong> Do not try to send all the Apple TV traffic over a VPN because Netflix, Prime, and others are wise to VPN providers and have gotten great at geofencing.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Selectively Route Apple TV YouTube Traffic Over the VPN</h2><p>Let’s start by adding Firewall Policy rules to send the most common YouTube domains over the VPN.</p><p>As I’m about to add the rules, my hands hover over the keyboard not knowing what domains to tunnel. They need to be FQDN (fully-qualified domain names, no wildcards). Let’s open up a Chromium-based browser and see what traffic it generates in DevTools.</p><figure id="attachment_5559"><a href="https://static.ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls.png"><img src="https://ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-754x440.png" alt="Add the domains column to DevTools to see where YouTube calls" width="754" height="440" srcset="https://ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-754x440.png 754w, https://static.ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-300x175.png 300w, https://static.ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-600x350.png 600w, https://static.ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls.png 1031w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-754x440.png" data-srcset="https://ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-754x440.png 754w, https://static.ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-300x175.png 300w, https://static.ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-600x350.png 600w, https://static.ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls.png 1031w"></a><figcaption>Add the domains column to DevTools to see where YouTube calls</figcaption></figure><p>Here are some candidate FQDNs to add:</p><div id="crayon-63661eaabe4aa191315272" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>www</span><span>.youtube</span><span>.com</span></p><p><span>youtube</span><span>.com</span></p><p><span>googlevideo</span><span>.com</span></p><p><span>accounts</span><span>.google</span><span>.com</span></p><p><span>googleapis</span><span>.com</span></p><p><span>gstatic</span><span>.com</span></p></div></td></tr></tbody></table></div><p>But wait, I hear you ask, why <code>accounts.google.com</code> and <code>gstatic.com</code>? This is a preventative measure just in case one of those domains is geo-jacked (Geo-IP LowJacking). I wouldn’t put it past Google engineers to geo-jack the fonts domains like <code>fonts.googleapis.com</code>, but I’ll take a chance they don’t in the interest of scaling to billions of page views efficiently.</p><p>Here are my new rules where I chain two of them using a tag so I can limit YouTube tunnelling to only the same untrusted machines (including Apple TV).</p><figure id="attachment_5496"><a href="https://static.ericdraken.com/files/YouTube-domains-to-tunnel.png"><img src="https://static.ericdraken.com/files/YouTube-domains-to-tunnel-754x422.png" alt="YouTube domains to tunnel" width="754" height="422" srcset="https://static.ericdraken.com/files/YouTube-domains-to-tunnel-754x422.png 754w, https://static.ericdraken.com/files/YouTube-domains-to-tunnel-300x168.png 300w, https://static.ericdraken.com/files/YouTube-domains-to-tunnel-600x336.png 600w, https://static.ericdraken.com/files/YouTube-domains-to-tunnel.png 1146w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/YouTube-domains-to-tunnel-754x422.png" data-srcset="https://static.ericdraken.com/files/YouTube-domains-to-tunnel-754x422.png 754w, https://static.ericdraken.com/files/YouTube-domains-to-tunnel-300x168.png 300w, https://static.ericdraken.com/files/YouTube-domains-to-tunnel-600x336.png 600w, https://static.ericdraken.com/files/YouTube-domains-to-tunnel.png 1146w"></a><figcaption>YouTube domains to tunnel</figcaption></figure><figure id="attachment_5497"><a href="https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule.png"><img src="https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-754x132.png" alt="Use a match rule before the tunnel rule" width="754" height="132" srcset="https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-754x132.png 754w, https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-300x53.png 300w, https://static.ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-600x105.png 600w, https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule.png 1140w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-754x132.png" data-srcset="https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-754x132.png 754w, https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-300x53.png 300w, https://static.ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-600x105.png 600w, https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule.png 1140w"></a><figcaption>Use a match rule before the tunnel rule</figcaption></figure><figure id="attachment_5498"><a href="https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them.png"><img src="https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-754x1673.png" alt="The first rule matches VPN clients and tags them" width="754" height="1673" srcset="https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-754x1673.png 754w, https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-135x300.png 135w, https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-600x1331.png 600w, https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them.png 1145w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-754x1673.png" data-srcset="https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-754x1673.png 754w, https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-135x300.png 135w, https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-600x1331.png 600w, https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them.png 1145w"></a><figcaption>The first rule matches VPN clients and tags them</figcaption></figure><figure id="attachment_5499"><a href="https://ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN.png"><img src="https://ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-754x1674.png" alt="The second rule tunnels tagged requests through the VPN" width="754" height="1674" srcset="https://ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-754x1674.png 754w, https://static.ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-135x300.png 135w, https://static.ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-600x1332.png 600w, https://ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN.png 1142w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-754x1674.png" data-srcset="https://ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-754x1674.png 754w, https://static.ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-135x300.png 135w, https://static.ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-600x1332.png 600w, https://ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN.png 1142w"></a><figcaption>The second rule tunnels tagged requests through the VPN</figcaption></figure><p>And with that, YouTube thinks I’m in Milan, Netflix and Prime Video think I am still in Canada, and the ads… oh the ads… they are few and far between, and when they do come on, they are just a treat to listen to in that slow, lack-of-harsh-aspirants-or-yelling of a beautiful language Italian is.</p><figure id="attachment_5571"><a href="https://ericdraken.com/files/YouTube-Italy.jpg"><img src="https://static.ericdraken.com/files/YouTube-Italy-754x386.jpg" alt="YouTube, Italy" width="754" height="386" srcset="https://static.ericdraken.com/files/YouTube-Italy-754x386.jpg 754w, https://ericdraken.com/files/YouTube-Italy-300x154.jpg 300w, https://static.ericdraken.com/files/YouTube-Italy-600x308.jpg 600w, https://ericdraken.com/files/YouTube-Italy.jpg 1200w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/YouTube-Italy-754x386.jpg" data-srcset="https://static.ericdraken.com/files/YouTube-Italy-754x386.jpg 754w, https://ericdraken.com/files/YouTube-Italy-300x154.jpg 300w, https://static.ericdraken.com/files/YouTube-Italy-600x308.jpg 600w, https://ericdraken.com/files/YouTube-Italy.jpg 1200w"></a><figcaption>YouTube, Italy</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><p><em>Time goes by…</em></p><hr><h2>Gotcha: DNS Race Condition</h2><p>A day has gone by and I’ve noticed that I only get Nutella and Ferrero Roche ads in the middle of videos, not at the start. Odd. I did some research and this is what I found:</p><figure id="attachment_5561"><a href="https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases.png"><img src="https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases.png" alt="Pertinent information about pfSense and hostname aliases" width="696" height="589" srcset="https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases.png 696w, https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases-300x254.png 300w, https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases-600x508.png 600w" sizes="(max-width: 696px) 100vw, 696px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases.png" data-srcset="https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases.png 696w, https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases-300x254.png 300w, https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases-600x508.png 600w"></a><figcaption>Pertinent information about pfSense and hostname aliases</figcaption></figure><p>This means that the hostnames are resolved to IP addresses <strong>once</strong> and those IPs are used in my VPN tunnelling policy rules.</p><blockquote><p>A hostname entry in a host or network type alias is <strong>periodically resolved and updated by the firewall every few minutes</strong>. The default interval is 300 seconds (5 minutes), and can be changed by adjusting the value of Aliases Hostnames Resolve Interval on System &gt; Advanced, Firewall &amp; NAT tab. – pfSense</p></blockquote><p>Ah-ha, so I suspect there is a DNS race condition. Let me explain:</p><p>This happens if, say, the Alias Daemon updates the IPs of the FQDNs. Then, I turn on the Apple TV for the first time all day. Since the usual TTL (time-to-live) of DNS queries is 1440 seconds (30 minutes), all the YouTube DNS entries will be cache misses and will need to be updated. At this point, the IPs from the second DNS queries may be from a pool and are not guaranteed to be the same that the Alias Daemon has. When the Alias Daemon checks again in five minutes, it may resolve the FQDNs to yet different IPs!</p><p>Let’s solve this by overwriting whatever TTL (time-to-live) YouTube has in its DNS entries:</p><figure id="attachment_5568"><a href="https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry.png"><img src="https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-754x181.png" alt="Do not abide by the minimum TTL of the target DNS entry" width="754" height="181" srcset="https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-754x181.png 754w, https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-300x72.png 300w, https://static.ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-600x144.png 600w, https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry.png 1069w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-754x181.png" data-srcset="https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-754x181.png 754w, https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-300x72.png 300w, https://static.ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-600x144.png 600w, https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry.png 1069w"></a><figcaption>Do not abide by the minimum TTL of the target DNS entry</figcaption></figure><p>And with that, no more DNS lookup race condition.</p><p><a href="#top">Top ↩</a></p><hr><h2>Gotcha: Authentication Trouble, Forbidden 403 Error</h2><p>Sometimes videos will not play. For security, YouTube embeds your IP in the <code>googlevideo.com</code> request. I’ve known about this since my post about <a href="https://ericdraken.com/download-youtube-videos-with-php/" target="_blank">Download YouTube 4K Videos with PHP</a> back in 2016. The new problem is that various JavaScript and “are you human?” assets are tunnelled over VPN, but those darn domains like <code>r5---sn-hpa7kn76.googlevideo.com</code> are not tunnelled and thus come from the wrong IP. Queue the <code>403 Forbidden</code> error.</p><figure id="attachment_5569"><a href="https://ericdraken.com/files/YouTube-authentication-failure.png"><img src="https://static.ericdraken.com/files/YouTube-authentication-failure-754x359.png" alt="YouTube authentication failure" width="754" height="359" srcset="https://static.ericdraken.com/files/YouTube-authentication-failure-754x359.png 754w, https://static.ericdraken.com/files/YouTube-authentication-failure-300x143.png 300w, https://ericdraken.com/files/YouTube-authentication-failure-600x286.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/YouTube-authentication-failure-754x359.png" data-srcset="https://static.ericdraken.com/files/YouTube-authentication-failure-754x359.png 754w, https://static.ericdraken.com/files/YouTube-authentication-failure-300x143.png 300w, https://ericdraken.com/files/YouTube-authentication-failure-600x286.png 600w"></a><figcaption>YouTube authentication failure</figcaption></figure><p>Let’s fail fast with a quick experiment: I’ve gotten the IP of the above second-level domain name (SLD), added it manually to the list of domains/IPs to VPN tunnel, applied the change, and refreshed YouTube:</p><figure id="attachment_5574"><a href="https://ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well..png"><img src="https://static.ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-754x360.png" alt="Success. We need to route the mangled domains over the VPN as well." width="754" height="360" srcset="https://static.ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-754x360.png 754w, https://static.ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-300x143.png 300w, https://ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-600x287.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-754x360.png" data-srcset="https://static.ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-754x360.png 754w, https://static.ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-300x143.png 300w, https://ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-600x287.png 600w"></a><figcaption>Success. We need to route the mangled domains over the VPN as well.</figcaption></figure><p>Excellent. Now, we just need a way to tunnel that wildcard <code>*.googlevideo.com</code> domain. Unfortunately, the NAT and Firewall rules work with IPs, not <a href="https://www.reddit.com/r/PFSENSE/comments/7wwnun/wildcard_domains_in_aliases/" target="_blank" rel="nofollow">wildcard domain names</a>. Can we predict or enumerate these domains?</p><p>Here is a Wireshark capture of DNS requests to <code>*.googlevideo.com</code> to show that the SLDs (second-level domains) are not eyeballably predictable:</p><figure id="attachment_5663"><a href="https://static.ericdraken.com/files/Random-SLDs-from-googlevideo.com_.png"><img src="https://ericdraken.com/files/Random-SLDs-from-googlevideo.com_-754x270.png" alt="Random SLDs from googlevideo.com" width="754" height="270" srcset="https://ericdraken.com/files/Random-SLDs-from-googlevideo.com_-754x270.png 754w, https://ericdraken.com/files/Random-SLDs-from-googlevideo.com_-300x107.png 300w, https://static.ericdraken.com/files/Random-SLDs-from-googlevideo.com_-600x215.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Random-SLDs-from-googlevideo.com_-754x270.png" data-srcset="https://ericdraken.com/files/Random-SLDs-from-googlevideo.com_-754x270.png 754w, https://ericdraken.com/files/Random-SLDs-from-googlevideo.com_-300x107.png 300w, https://static.ericdraken.com/files/Random-SLDs-from-googlevideo.com_-600x215.png 600w"></a><figcaption>Random SLDs from googlevideo.com</figcaption></figure><p>Let’s drop into a web browser with adblocking disabled and walk the HAR waterfall of my interaction with YouTube that led to ads showing up.</p><figure id="attachment_5666"><a href="https://static.ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_.png"><img src="https://ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-754x255.png" alt="Waterfall showing ad interactions coming from www.youtube.com" width="754" height="255" srcset="https://ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-754x255.png 754w, https://static.ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-300x101.png 300w, https://static.ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-600x203.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-754x255.png" data-srcset="https://ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-754x255.png 754w, https://static.ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-300x101.png 300w, https://static.ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-600x203.png 600w"></a><figcaption>Waterfall showing ad interactions coming from www.youtube.com</figcaption></figure><p>What are GET requests like</p><p><code>GET https://r7---sn-uxa0n-t8ge.googlevideo.com/generate_204</code></p><p>doing, exactly? I’ll give this problem some thought offline.</p><p><a href="#top">Top ↩</a></p><hr><h2>Gotcha: YouTube is Now Showing UK Ads, Not Italian Ads</h2><p>Before I could even solve the previous gotcha, British ads started showing up with the same frequency as if we did nothing. Ads from the UK are even more incessant than those from Canada, trailing behind the USA and India according to my earlier stats. It would be a complete failure if we get UK ads. Why does this happen suddenly? I’ve opened a fresh browser in a VM and tunnelled all traffic through Italy. The only leak I can find is when I query <code>ipinfo.io</code> on my Italian tunnel and see a UK address in the ASN. Could this small leak be our undoing?</p><figure id="attachment_5672"><a href="https://ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information.png"><img src="https://static.ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-754x419.png" alt="It is possible the VPN is leaking unintended information" width="754" height="419" srcset="https://static.ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-754x419.png 754w, https://ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-300x167.png 300w, https://static.ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-600x333.png 600w, https://ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information.png 1499w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-754x419.png" data-srcset="https://static.ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-754x419.png 754w, https://ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-300x167.png 300w, https://static.ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-600x333.png 600w, https://ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information.png 1499w"></a><figcaption>It is possible the VPN is leaking unintended information</figcaption></figure><p>Even with my browser’s language set to <code>en_US</code> and location data off, this is the only leak I can spot. Then, in addition to a VPN exiting in Italy, it has to be one that doesn’t leak <code>ASN</code> (Autonomous System Numbers – used for automated routing) that gives up a different country. Dang, Google, you’re good. I’m going to have to bring my A+ game to this one.</p><p><a href="#top">Top ↩</a></p><hr><h2>Find a VPN Exit Node with no ASN Leak</h2><p>By visiting <code>https://nordvpn.com/servers/tools/</code>, I can see the VPN endpoint nodes in Italy. There are many Wireguard endpoints with <a href="https://ericdraken.com/out/nordvpn" target="_blank">NordVPN</a>. Just to move things forward for this exercise, I’ll add an OpenVPN tunnel in pfSense and connect to several VPN nodes and examine the ASNs. It’s better than nothing, and more importantly, I’d like to eliminate the <code>ASN</code> as the leak of GeoIP information. Here is the <a href="https://support.nordvpn.com/Connectivity/Router/1626958942/pfSense-2-5-Setup-with-NordVPN.htm" target="_blank" rel="nofollow">guide</a> I used.</p><p>Through trial and error, I found a VPN node that is registered to an ISP in Italy as found in the <code>Abuse</code> and <code>ASN</code> info.</p><figure id="attachment_5678"><a href="https://static.ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks.png"><img src="https://ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-754x382.png" alt="Found an exit node with no ASN leaks" width="754" height="382" srcset="https://ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-754x382.png 754w, https://static.ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-300x152.png 300w, https://static.ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-600x304.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-754x382.png" data-srcset="https://ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-754x382.png 754w, https://static.ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-300x152.png 300w, https://static.ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-600x304.png 600w"></a><figcaption>Found an exit node with no ASN leaks</figcaption></figure><p>Beautiful. Bellissimo.</p><figure id="attachment_5681"><a href="https://ericdraken.com/files/Italian-content-with-Italian-ads-again.jpg"><img src="https://ericdraken.com/files/Italian-content-with-Italian-ads-again-754x283.jpg" alt="Italian content with Italian ads again" width="754" height="283" srcset="https://ericdraken.com/files/Italian-content-with-Italian-ads-again-754x283.jpg 754w, https://ericdraken.com/files/Italian-content-with-Italian-ads-again-300x113.jpg 300w, https://static.ericdraken.com/files/Italian-content-with-Italian-ads-again-600x226.jpg 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Italian-content-with-Italian-ads-again-754x283.jpg" data-srcset="https://ericdraken.com/files/Italian-content-with-Italian-ads-again-754x283.jpg 754w, https://ericdraken.com/files/Italian-content-with-Italian-ads-again-300x113.jpg 300w, https://static.ericdraken.com/files/Italian-content-with-Italian-ads-again-600x226.jpg 600w"></a><figcaption>Italian content with Italian ads again</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Hijack Google Video DNS Queries</h2><p>To make any of this work, I need a technique to route the wildcard <code>*.googlevideos.com</code> domain through the VPN.</p><div><p><strong>Thought Experiment:</strong> Suppose I write a plugin for pfSense that periodically <code>grep</code>s the DNS query log, keeps track of the <code>*.googlevideo.com</code> queries, and adds them to a unique list of aliases for Google Video domains; if backed by an LRU eviction policy, this could keep working indefinitely. However, if each video uses a unique, mangled domain, then this does not work unless I hit refresh on every single video.</p></div><p>On the other hand, if I “hold up” the DNS query for the <code>*.googlevideo.com</code> domains, add the IPs to some alias list, <em>then</em> allow the DNS response to finish the round trip, we may be in business!</p><figure id="attachment_5583"><a href="https://static.ericdraken.com/files/pfSense-DNS-resolver-has-user-Python-support.png"><img src="https://static.ericdraken.com/files/pfSense-DNS-resolver-has-user-Python-support.png" alt="pfSense DNS resolver has user Python support" width="585" height="257" srcset="https://static.ericdraken.com/files/pfSense-DNS-resolver-has-user-Python-support.png 585w, https://ericdraken.com/files/pfSense-DNS-resolver-has-user-Python-support-300x132.png 300w" sizes="(max-width: 585px) 100vw, 585px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/pfSense-DNS-resolver-has-user-Python-support.png" data-srcset="https://static.ericdraken.com/files/pfSense-DNS-resolver-has-user-Python-support.png 585w, https://ericdraken.com/files/pfSense-DNS-resolver-has-user-Python-support-300x132.png 300w"></a><figcaption>pfSense DNS resolver has user Python support</figcaption></figure><p>Where to even start? Here are some <a href="https://github.com/NLnetLabs/unbound/tree/master/pythonmod/examples" target="_blank" rel="nofollow">Python example scripts</a> just to get some inspiration. A quick, mental reverse-engineering of a handful of scripts reveals that there are some event hooks available. Nice.</p><p>Among friends, let’s say that I can build up the pool of Google video IPs in real-time. How then to add these IPs programmatically to the firewall alias list for YouTube <em>without</em> restarting the firewall? One person actually hacked the PHP scripts in pfSense. Tempting, but I’ll do more research. Another person created a <a href="https://github.com/jaredhendrickson13/pfsense-api" target="_blank" rel="nofollow">REST API for pfSense</a>. Jackpot!</p><p><a href="#top">Top ↩</a></p><hr><div><p><a name="new-goal"></a><strong>New Goal:</strong> We need to add IPs to the firewall policy rule to route YouTube videos over a VPN to avoid incessant and obnoxious North-American ads, but the IPs keep changing due to changing, mangled second-level domain names (SLDs). Using Python 3 and a REST API, we will monitor the appropriate DNS queries, note the IP(s) of the response, hold the response, add the IP(s) to the VPN tunnelling policy rule, then release the DNS query response.</p></div><h2>Research Python Methods to Hijack DNS Requests</h2><p>Why this approach? It’s future-proof, modular, elegant, maintainable, automated, and it lends itself to a future decision tree that could truly restrict YouTube ads outright.</p><p>First, I will enable SSHd in pfSense and take a peek around.</p><figure id="attachment_5588"><a href="https://ericdraken.com/files/Enable-SSHd-in-pfSense.png"><img src="https://ericdraken.com/files/Enable-SSHd-in-pfSense-754x177.png" alt="Enable SSHd in pfSense" width="754" height="177" srcset="https://ericdraken.com/files/Enable-SSHd-in-pfSense-754x177.png 754w, https://static.ericdraken.com/files/Enable-SSHd-in-pfSense-300x71.png 300w, https://static.ericdraken.com/files/Enable-SSHd-in-pfSense-600x141.png 600w, https://ericdraken.com/files/Enable-SSHd-in-pfSense.png 1140w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Enable-SSHd-in-pfSense-754x177.png" data-srcset="https://ericdraken.com/files/Enable-SSHd-in-pfSense-754x177.png 754w, https://static.ericdraken.com/files/Enable-SSHd-in-pfSense-300x71.png 300w, https://static.ericdraken.com/files/Enable-SSHd-in-pfSense-600x141.png 600w, https://ericdraken.com/files/Enable-SSHd-in-pfSense.png 1140w"></a><figcaption>Enable SSHd in pfSense</figcaption></figure><figure id="attachment_5589"><a href="https://ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials.png"><img src="https://ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-754x424.png" alt="SSH into pfSense using the GUI credentials" width="754" height="424" srcset="https://ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-754x424.png 754w, https://static.ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-300x169.png 300w, https://static.ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-600x337.png 600w, https://ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials.png 1052w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-754x424.png" data-srcset="https://ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-754x424.png 754w, https://static.ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-300x169.png 300w, https://static.ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-600x337.png 600w, https://ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials.png 1052w"></a><figcaption>SSH into pfSense using the GUI credentials</figcaption></figure><h3>Rsync Disk Backup</h3><p>Let’s take this opportunity to make a disk backup. <code>du -h</code> or “duh” shows that only 800 MiB is in use on the SSD. Let’s <code>rsync</code> the whole box from our local machine in about four minutes.</p><div id="crayon-63661eaabe4b8255504186" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p></div></td><td><div><p><span># Rsync the pfSense router locally, then compress to an archive.</span></p><p><span># Tell the remote rsync to preserve ownership information.</span></p><p><span># Fix brace expansion and execute (easy to read with tr and sed).</span></p><p><span>cat</span><span> </span><span>&lt;&lt;</span><span> </span><span>EOF</span><span> </span><span>|</span><span> </span><span>tr</span><span> </span><span>-</span><span>s</span><span> </span><span>' '</span><span> </span><span>|</span><span> </span><span>sed</span><span> </span><span>'s/, "/,"/g'</span><span> </span><span>|</span><span> </span><span>bash</span></p><p><span>time</span><span> </span><span>\</span></p><p><span>rsync</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>archive</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>acls</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>xattrs</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>hard</span><span>-</span><span>links</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>fake</span><span>-</span><span>super</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>numeric</span><span>-</span><span>ids</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>checksum</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>info</span><span>=</span><span>progress2</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>no</span><span>-</span><span>compress</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>whole</span><span>-</span><span>file</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>inplace</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>rsync</span><span>-</span><span>path</span><span>=</span><span>"/usr/local/bin/rsync --fake-super --numeric-ids"</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>exclude</span><span>=</span><span>{</span><span>"/dev/*"</span><span>,</span><span>"/proc/*"</span><span>,</span><span>"/sys/*"</span><span>,</span><span>"/tmp/*"</span><span>,</span><span>"/run/*"</span><span>,</span><span>\</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"/var/*"</span><span>,</span><span>"/mnt/*"</span><span>,</span><span>"/media/*"</span><span>,</span><span>"/lost+found"</span><span>}</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>rsh</span><span>=</span><span>"ssh -p 2222"</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>admin</span><span>@</span><span>pfsense</span><span>:</span><span>/</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>~</span><span>/</span><span>.pfsense</span><span>-</span><span>backup</span><span> </span><span>&amp;&amp;</span><span> </span><span>\</span></p><p><span>tar</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>gzip</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>create</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>file</span><span> </span><span>~</span><span>/</span><span>pfsense</span><span>-</span><span>backup</span><span>-</span><span>`</span><span>date</span><span> </span><span>+</span><span>"%Y-%m-%d"</span><span>`</span><span>.tar</span><span>.gz</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>~</span><span>/</span><span>.pfsense</span><span>-</span><span>backup</span></p><p><span>EOF</span></p></div></td></tr></tbody></table></div><div><p><strong>Tip:</strong> To verify the owners and permissions are set in the extended attributes locally, run<br><code>getfattr -d -m ^ -R -- ~/.pfsense-backup</code></p></div><h3>Install pfSense REST API</h3><p>Now that we have a pfSense backup (I’m told just backing up <code>config.xml</code> works too), let’s install the <a href="https://github.com/jaredhendrickson13/pfsense-api" target="_blank" rel="nofollow">REST API</a>.</p><p>This part had me confused. You see, I was looking at the bottom of the screen wondering how the heck I could copy a truncated hash as a token. After a few tries, I noticed the green message at the top that I had been trained to ignore. It has the token.</p><figure id="attachment_5627"><a href="https://static.ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token.png"><img src="https://static.ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-754x634.png" alt="Tricky UI screen to get the API token" width="754" height="634" srcset="https://static.ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-754x634.png 754w, https://ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-300x252.png 300w, https://ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-600x504.png 600w, https://static.ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token.png 1142w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-754x634.png" data-srcset="https://static.ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-754x634.png 754w, https://ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-300x252.png 300w, https://ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-600x504.png 600w, https://static.ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token.png 1142w"></a><figcaption>Tricky UI screen to get the API token</figcaption></figure><p>Next, with the API credentials set up, let’s try out the API:</p><div id="crayon-63661eaabe4bb158173225" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>curl</span><span> </span><span>-</span><span>k</span><span> </span><span>-</span><span>s</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>-</span><span>H</span><span> </span><span>"Content-Type: application/json"</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>-</span><span>H</span><span> </span><span>"Authorization: 61646d696e 978c197c37a882f6da23553c152c1203"</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>-</span><span>X</span><span> </span><span>GET</span><span> </span><span>https</span><span>:</span><span>/</span><span>/</span><span>pfsense</span><span>/</span><span>api</span><span>/</span><span>v1</span><span>/</span><span>firewall</span><span>/</span><span>alias</span><span> </span><span>\</span></p><p><span>|</span><span> </span><span>jq</span><span> </span><span>'.data[] | select(.name == "VPN_domains")'</span></p></div></td></tr></tbody></table></div><figure id="attachment_5628"><a href="https://static.ericdraken.com/files/Successful-API-test.png"><img src="https://static.ericdraken.com/files/Successful-API-test.png" alt="Successful API test" width="746" height="347" srcset="https://static.ericdraken.com/files/Successful-API-test.png 746w, https://ericdraken.com/files/Successful-API-test-300x140.png 300w, https://static.ericdraken.com/files/Successful-API-test-600x279.png 600w" sizes="(max-width: 746px) 100vw, 746px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Successful-API-test.png" data-srcset="https://static.ericdraken.com/files/Successful-API-test.png 746w, https://ericdraken.com/files/Successful-API-test-300x140.png 300w, https://static.ericdraken.com/files/Successful-API-test-600x279.png 600w"></a><figcaption>Successful API test</figcaption></figure><h3>Explore the Unbound Python Module</h3><p>Running <code>find / -name "py*"</code> shows that the current version of Python is 3.8.</p><p>As for the Unbound DNS Resolver, I had some luck tinkering in <code>nano</code> and writing simple Python 3.8 code to log DNS query messages. We now have both parts needed to dynamically update the firewall aliases and tunnel all YouTube traffic once and for all.</p><p>If you are looking for Python module docs for Unbound, here they are:</p><figure id="attachment_5635"><a href="https://static.ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound.png"><img src="https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-754x318.png" alt="There are no readily available Python module docs for Unbound" width="754" height="318" srcset="https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-754x318.png 754w, https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-300x126.png 300w, https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-600x253.png 600w, https://static.ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound.png 1134w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-754x318.png" data-srcset="https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-754x318.png 754w, https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-300x126.png 300w, https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-600x253.png 600w, https://static.ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound.png 1134w"></a><figcaption>There are no readily available Python module docs for Unbound</figcaption></figure><p>Run these commands to quickly get the documentation.</p><div id="crayon-63661eaabe4be389439522" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># Do this in a PyCharm venv terminal</span></p><p><span>git </span><span>clone</span><span> </span><span>--</span><span>depth</span><span> </span><span>1</span><span> </span><span>-</span><span>b</span><span> </span><span>master</span><span> </span><span>--</span><span>single</span><span>-</span><span>branch </span><span>https</span><span>:</span><span>/</span><span>/</span><span>github</span><span>.com</span><span>/</span><span>NLnetLabs</span><span>/</span><span>unbound</span><span>.git</span><span> </span><span>unbound</span></p><p><span>pip3 </span><span>install </span><span>sphinx</span></p><p><span>cd</span><span> </span><span>unbound</span></p><p><span>sphinx</span><span>-</span><span>build</span><span> </span><span>-</span><span>b</span><span> </span><span>html </span><span>pythonmod</span><span>/</span><span>doc</span><span>/</span><span> </span><span>doc</span><span>/</span><span>html</span><span>/</span><span>pythonmod</span><span>/</span></p></div></td></tr></tbody></table></div><div><p><strong>Warning:</strong> The example code is from Python 2.4, so be prepared to run Black and PyCharm code formatting, or run <code>2to3</code>. Also, the most important part of this whole exercise (getting the IPs from the DNS reply) is missing, so here is the hint: <code>import ipaddress</code>. Don’t forget to manually hack the byte strings to pull out the proper IP addresses in binary form, first.</p></div><p>Now we have Python docs and access to all the capabilities. Excellent.</p><figure id="attachment_5639"><a href="https://static.ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx.png"><img src="https://ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-754x311.png" alt="Successful generation of Unbound Python docs with Sphinx" width="754" height="311" srcset="https://ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-754x311.png 754w, https://ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-300x124.png 300w, https://static.ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-600x248.png 600w, https://static.ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx.png 1280w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-754x311.png" data-srcset="https://ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-754x311.png 754w, https://ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-300x124.png 300w, https://static.ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-600x248.png 600w, https://static.ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx.png 1280w"></a><figcaption>Successful generation of Unbound Python docs with Sphinx</figcaption></figure><p>Next, take a backup of your OS or VM and install <code>libtools</code> and <code>swig</code> wherever, <code>./configure --with-pythonmodule</code>, <code>make</code>, fix some errors in the Unbound code, <code>make</code> again, then you’ll have the generated python module (<code>unboundmodule.py</code>) in order to remove all the missing-method red error lines in PyCharm.</p><figure id="attachment_5644"><a href="https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about.png"><img src="https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-754x314.png" alt="PyCharm can now find the missing methods we don't actually need to worry about" width="754" height="314" srcset="https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-754x314.png 754w, https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-300x125.png 300w, https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-600x249.png 600w, https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about.png 885w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-754x314.png" data-srcset="https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-754x314.png 754w, https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-300x125.png 300w, https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-600x249.png 600w, https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about.png 885w"></a><figcaption>PyCharm can now find the missing methods we don’t actually need to worry about</figcaption></figure><figure id="attachment_5647"><a href="https://static.ericdraken.com/files/First-successful-DNS-response-logging-script.png"><img src="https://static.ericdraken.com/files/First-successful-DNS-response-logging-script-754x489.png" alt="First successful DNS response logging script" width="754" height="489" srcset="https://static.ericdraken.com/files/First-successful-DNS-response-logging-script-754x489.png 754w, https://static.ericdraken.com/files/First-successful-DNS-response-logging-script-300x194.png 300w, https://ericdraken.com/files/First-successful-DNS-response-logging-script-600x389.png 600w, https://static.ericdraken.com/files/First-successful-DNS-response-logging-script.png 889w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/First-successful-DNS-response-logging-script-754x489.png" data-srcset="https://static.ericdraken.com/files/First-successful-DNS-response-logging-script-754x489.png 754w, https://static.ericdraken.com/files/First-successful-DNS-response-logging-script-300x194.png 300w, https://ericdraken.com/files/First-successful-DNS-response-logging-script-600x389.png 600w, https://static.ericdraken.com/files/First-successful-DNS-response-logging-script.png 889w"></a><figcaption>First successful DNS response logging script</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Smoke Test: A Python DNS-Hijacking Script</h2><p>Here is a smoke test of the ability to hijack <code>*.google.com</code> DNS requests with reply IPs that the script has caught in just a few minutes (the timestamps are just to maintain a crude LRU cache):</p><figure id="attachment_5651"><a href="https://ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_.png"><img src="https://static.ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-754x733.png" alt="Smoke test for collecting IP addresses of *.google.com" width="754" height="733" srcset="https://static.ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-754x733.png 754w, https://static.ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-300x292.png 300w, https://ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-600x583.png 600w, https://ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_.png 1145w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-754x733.png" data-srcset="https://static.ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-754x733.png 754w, https://static.ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-300x292.png 300w, https://ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-600x583.png 600w, https://ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_.png 1145w"></a><figcaption>Smoke test for collecting IP addresses of *.google.com</figcaption></figure><p>Duplicate IP addresses are possible, and that is fine. I let the smoke test run overnight. Here is the PoC (proof of concept) script I ran as the Unbound Python module script.</p><div id="crayon-63661eaabe4c3362457631" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p><p>65</p><p>66</p><p>67</p><p>68</p><p>69</p><p>70</p><p>71</p><p>72</p><p>73</p><p>74</p><p>75</p><p>76</p><p>77</p><p>78</p><p>79</p><p>80</p><p>81</p><p>82</p><p>83</p><p>84</p><p>85</p><p>86</p><p>87</p><p>88</p><p>89</p><p>90</p><p>91</p><p>92</p><p>93</p><p>94</p><p>95</p><p>96</p><p>97</p><p>98</p><p>99</p><p>100</p><p>101</p><p>102</p><p>103</p><p>104</p><p>105</p><p>106</p><p>107</p><p>108</p><p>109</p><p>110</p><p>111</p><p>112</p><p>113</p><p>114</p><p>115</p><p>116</p><p>117</p><p>118</p><p>119</p><p>120</p><p>121</p><p>122</p><p>123</p><p>124</p><p>125</p><p>126</p><p>127</p><p>128</p><p>129</p><p>130</p><p>131</p><p>132</p><p>133</p><p>134</p><p>135</p><p>136</p><p>137</p><p>138</p><p>139</p><p>140</p><p>141</p><p>142</p><p>143</p><p>144</p><p>145</p><p>146</p><p>147</p><p>148</p><p>149</p><p>150</p><p>151</p><p>152</p><p>153</p><p>154</p><p>155</p><p>156</p><p>157</p><p>158</p><p>159</p><p>160</p><p>161</p><p>162</p><p>163</p><p>164</p><p>165</p><p>166</p><p>167</p><p>168</p><p>169</p><p>170</p><p>171</p><p>172</p><p>173</p><p>174</p><p>175</p><p>176</p><p>177</p><p>178</p><p>179</p><p>180</p><p>181</p><p>182</p><p>183</p><p>184</p><p>185</p><p>186</p><p>187</p><p>188</p><p>189</p><p>190</p><p>191</p><p>192</p><p>193</p><p>194</p><p>195</p><p>196</p><p>197</p><p>198</p><p>199</p><p>200</p><p>201</p><p>202</p><p>203</p><p>204</p><p>205</p><p>206</p><p>207</p><p>208</p><p>209</p><p>210</p><p>211</p><p>212</p><p>213</p><p>214</p><p>215</p><p>216</p><p>217</p><p>218</p><p>219</p><p>220</p><p>221</p><p>222</p><p>223</p><p>224</p><p>225</p><p>226</p><p>227</p><p>228</p><p>229</p><p>230</p><p>231</p><p>232</p><p>233</p><p>234</p><p>235</p><p>236</p><p>237</p><p>238</p><p>239</p><p>240</p><p>241</p><p>242</p><p>243</p><p>244</p><p>245</p><p>246</p><p>247</p><p>248</p><p>249</p><p>250</p><p>251</p><p>252</p><p>253</p><p>254</p><p>255</p><p>256</p><p>257</p><p>258</p><p>259</p><p>260</p><p>261</p><p>262</p><p>263</p><p>264</p><p>265</p><p>266</p><p>267</p><p>268</p><p>269</p><p>270</p><p>271</p><p>272</p><p>273</p><p>274</p><p>275</p><p>276</p><p>277</p><p>278</p><p>279</p><p>280</p><p>281</p><p>282</p><p>283</p><p>284</p><p>285</p><p>286</p><p>287</p><p>288</p><p>289</p><p>290</p><p>291</p><p>292</p><p>293</p><p>294</p><p>295</p><p>296</p><p>297</p><p>298</p><p>299</p><p>300</p><p>301</p></div></td><td><div><p><span># -*- coding: utf-8 -*-</span></p><p><span>#&nbsp;&nbsp;Copyright (c) 2021. Eric Draken (ericdraken.com)</span></p><p><span>import</span><span> </span><span>ipaddress</span></p><p><span>import</span><span> </span><span>json</span></p><p><span>import</span><span> </span><span>os</span></p><p><span>import</span><span> </span><span>ssl</span></p><p><span>import</span><span> </span><span>sys</span></p><p><span>import</span><span> </span><span>time</span></p><p><span>import</span><span> </span><span>urllib</span><span>.</span><span>request</span></p><p><span>from</span><span> </span><span>typing </span><span>import</span><span> </span><span>Final</span><span>,</span><span> </span><span>Union</span></p><p><span>FILENAME</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>os.path</span><span>.</span><span>splitext</span><span>(</span><span>os.path</span><span>.</span><span>basename</span><span>(</span><span>__file__</span><span>)</span><span>)</span><span>[</span><span>0</span><span>]</span><span>.</span><span>upper</span><span>(</span><span>)</span></p><p><span>ALIAS_VPN_WILDCARDS</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>"VPN_wildcards"</span></p><p><span>ALIAS_VPN_DOMAINS</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>"VPN_domains"</span></p><p><span>ALIAS_VPN_WILDCARDS_TTL</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>60</span><span> </span><span>*</span><span> </span><span>60</span><span>&nbsp;&nbsp;</span><span># 1 Hour</span></p><p><span>ALIAS_VPN_WILDCARDS_CAPACITY</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>500</span></p><p><span>AUTH_CODE</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>"61646d696e 978c197c37a882f6da23553c1xxxxxxx"</span></p><p><span>TEST_MODE</span><span> </span><span>=</span><span> </span><span>True</span></p><p><span>if</span><span> </span><span>TEST_MODE</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>API_ALIAS_URL</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>"https://pfsense/api/v1/firewall/alias"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>API_ALIAS_ENTRY_URL</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>"https://pfsense/api/v1/firewall/alias/entry"</span></p><p><span>else</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>API_ALIAS_URL</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>"https://127.0.0.1/api/v1/firewall/alias"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>API_ALIAS_ENTRY_URL</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>"https://127.0.0.1/api/v1/firewall/alias/entry"</span></p><p><span># ***********************************</span></p><p><span>__wildcard_patterns</span><span> </span><span>=</span><span> </span><span>set</span><span>(</span><span>)</span></p><p><span>if</span><span> </span><span>TEST_MODE</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>log_info</span><span>(</span><span>msg</span><span>=</span><span>""</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>print</span><span>(</span><span>f</span><span>"{FILENAME}: {msg}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>log_err</span><span>(</span><span>msg</span><span>=</span><span>""</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>print</span><span>(</span><span>f</span><span>"{FILENAME}: {msg}"</span><span>)</span></p><p><span>else</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># noinspection PyUnresolvedReferences,PyUnboundLocalVariable</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>except</span><span> </span><span>NameError</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Added to suppress IDE errors about missing functions and constants</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>from</span><span> </span><span>unbound</span><span>.</span><span>pythonmod</span><span>.</span><span>unboundmodule </span><span>import</span><span> </span><span>(</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>register_inplace_cb_reply</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>register_inplace_cb_reply_cache</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>register_inplace_cb_reply_local</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MODULE_EVENT_NEW</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MODULE_EVENT_PASS</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MODULE_WAIT_MODULE</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MODULE_EVENT_MODDONE</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MODULE_FINISHED</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_err</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MODULE_ERROR</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Clarity of log messages</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>__old_log_info</span><span> </span><span>=</span><span> </span><span>log_info</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>__old_log_err</span><span> </span><span>=</span><span> </span><span>log_err</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>log_info</span><span>(</span><span>msg</span><span>=</span><span>""</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>__old_log_info</span><span>(</span><span>f</span><span>"{FILENAME}: {msg}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>log_err</span><span>(</span><span>msg</span><span>=</span><span>""</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>__old_log_err</span><span>(</span><span>f</span><span>"{FILENAME}: {msg}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>log_response</span><span>(</span><span>qstate</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>not</span><span> </span><span>qstate</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>r</span><span> </span><span>=</span><span> </span><span>None</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>qstate</span><span>.</span><span>return_msg </span><span>and</span><span> </span><span>qstate</span><span>.</span><span>return_msg</span><span>.</span><span>rep</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>r</span><span> </span><span>=</span><span> </span><span>qstate</span><span>.</span><span>return_msg</span><span>.</span><span>rep</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>q</span><span> </span><span>=</span><span> </span><span>None</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>qstate</span><span>.</span><span>return_msg </span><span>and</span><span> </span><span>qstate</span><span>.</span><span>return_msg</span><span>.</span><span>qinfo</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>q</span><span> </span><span>=</span><span> </span><span>qstate</span><span>.</span><span>return_msg</span><span>.</span><span>qinfo</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>q</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>test</span><span> </span><span>=</span><span> </span><span>str</span><span>(</span><span>q</span><span>.</span><span>qname_str</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>any</span><span>(</span><span>x</span><span> </span><span>in</span><span> </span><span>test</span><span> </span><span>for</span><span> </span><span>x</span><span> </span><span>in</span><span> </span><span>__wildcard_patterns</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>"HIT Query: %s, type: %s (%d), class: %s (%d) "</span><span> </span><span>%</span><span> </span><span>(</span><span>q</span><span>.</span><span>qname_str</span><span>,</span><span> </span><span>q</span><span>.</span><span>qtype_str</span><span>,</span><span> </span><span>q</span><span>.</span><span>qtype</span><span>,</span><span> </span><span>q</span><span>.</span><span>qclass_str</span><span>,</span><span> </span><span>q</span><span>.</span><span>qclass</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>r</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Do not crash the whole Unbound service</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>i</span><span> </span><span>in</span><span> </span><span>range</span><span>(</span><span>0</span><span>,</span><span> </span><span>r</span><span>.</span><span>rrset_count</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>rr</span><span> </span><span>=</span><span> </span><span>r</span><span>.</span><span>rrsets</span><span>[</span><span>i</span><span>]</span><span>&nbsp;&nbsp;</span><span># ReplyInfo_RRSet</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>rk</span><span> </span><span>=</span><span> </span><span>rr</span><span>.</span><span>rk</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>rk</span><span>.</span><span>rrset_class_str</span><span> </span><span>==</span><span> </span><span>"IN"</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>d</span><span> </span><span>=</span><span> </span><span>rr</span><span>.</span><span>entry</span><span>.</span><span>data</span><span>&nbsp;&nbsp;</span><span># RRSetData_RRData</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>j</span><span> </span><span>in</span><span> </span><span>range</span><span>(</span><span>0</span><span>,</span><span> </span><span>d</span><span>.</span><span>count</span><span> </span><span>+</span><span> </span><span>d</span><span>.</span><span>rrsig_count</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>rk</span><span>.</span><span>type_str</span><span> </span><span>==</span><span> </span><span>"A"</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ip</span><span> </span><span>=</span><span> </span><span>ipaddress</span><span>.</span><span>IPv4Address</span><span>(</span><span>d</span><span>.</span><span>rr_data</span><span>[</span><span>j</span><span>]</span><span>[</span><span>2</span><span>:</span><span>]</span><span>)</span><span>.</span><span>exploded</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>elif</span><span> </span><span>rk</span><span>.</span><span>type_str</span><span> </span><span>==</span><span> </span><span>"AAAA"</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ip</span><span> </span><span>=</span><span> </span><span>ipaddress</span><span>.</span><span>IPv6Address</span><span>(</span><span>d</span><span>.</span><span>rr_data</span><span>[</span><span>j</span><span>]</span><span>[</span><span>2</span><span>:</span><span>]</span><span>)</span><span>.</span><span>exploded</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Not an A or AAAA record</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>continue</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"{j}: IP: {ip!s}, TTL={d.rr_ttl[j]!s}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>add_wildcard_ips</span><span>(</span><span>str</span><span>(</span><span>ip</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>except</span><span> </span><span>Exception</span><span> </span><span>as</span><span> </span><span>e</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>exc_type</span><span>,</span><span> </span><span>exc_obj</span><span>,</span><span> </span><span>exc_tb</span><span> </span><span>=</span><span> </span><span>sys</span><span>.</span><span>exc_info</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_err</span><span>(</span><span>f</span><span>"{exc_type}, {exc_tb.tb_lineno}, {e}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>inplace_reply_callback</span><span>(</span><span>qinfo</span><span>,</span><span> </span><span>qstate</span><span>,</span><span> </span><span>rep</span><span>,</span><span> </span><span>rcode</span><span>,</span><span> </span><span>edns</span><span>,</span><span> </span><span>opt_list_out</span><span>,</span><span> </span><span>region</span><span>,</span><span> </span><span>*</span><span>*</span><span>kwargs</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_response</span><span>(</span><span>qstate</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>inplace_cache_callback</span><span>(</span><span>qinfo</span><span>,</span><span> </span><span>qstate</span><span>,</span><span> </span><span>rep</span><span>,</span><span> </span><span>rcode</span><span>,</span><span> </span><span>edns</span><span>,</span><span> </span><span>opt_list_out</span><span>,</span><span> </span><span>region</span><span>,</span><span> </span><span>*</span><span>*</span><span>kwargs</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># log_response(qstate)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>inplace_local_callback</span><span>(</span><span>qinfo</span><span>,</span><span> </span><span>qstate</span><span>,</span><span> </span><span>rep</span><span>,</span><span> </span><span>rcode</span><span>,</span><span> </span><span>edns</span><span>,</span><span> </span><span>opt_list_out</span><span>,</span><span> </span><span>region</span><span>,</span><span> </span><span>*</span><span>*</span><span>kwargs</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># log_response(qstate)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>init_standard</span><span>(</span><span>id_</span><span>,</span><span> </span><span>env</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>"Init start"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Register the inplace_reply_callback function as an inplace callback</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># function when answering a resolved query.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>not</span><span> </span><span>register_inplace_cb_reply</span><span>(</span><span>inplace_reply_callback</span><span>,</span><span> </span><span>env</span><span>,</span><span> </span><span>id_</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Register the inplace_cache_callback function as an inplace callback</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># function when answering from cache.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>not</span><span> </span><span>register_inplace_cb_reply_cache</span><span>(</span><span>inplace_cache_callback</span><span>,</span><span> </span><span>env</span><span>,</span><span> </span><span>id_</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Register the inplace_local_callback function as an inplace callback</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># function when answering from local data.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>not</span><span> </span><span>register_inplace_cb_reply_local</span><span>(</span><span>inplace_local_callback</span><span>,</span><span> </span><span>env</span><span>,</span><span> </span><span>id_</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Prepare the aliases</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>recreate_vpn_wildcards</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>global</span><span> </span><span>__wildcard_patterns</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>__wildcard_patterns</span><span> </span><span>=</span><span> </span><span>get_wildcard_patterns</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>"Init finished"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>deinit</span><span>(</span><span>id_</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>inform_super</span><span>(</span><span>id_</span><span>,</span><span> </span><span>qstate</span><span>,</span><span> </span><span>superqstate</span><span>,</span><span> </span><span>qdata</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>operate</span><span>(</span><span>id_</span><span>,</span><span> </span><span>event</span><span>,</span><span> </span><span>qstate</span><span>,</span><span> </span><span>qdata</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Wait for the Python module</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>event</span><span> </span><span>==</span><span> </span><span>MODULE_EVENT_NEW</span><span>)</span><span> </span><span>or</span><span> </span><span>(</span><span>event</span><span> </span><span>==</span><span> </span><span>MODULE_EVENT_PASS</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>qstate</span><span>.</span><span>ext_state</span><span>[</span><span>id_</span><span>]</span><span> </span><span>=</span><span> </span><span>MODULE_WAIT_MODULE</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Release when the Python module is finished</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>elif</span><span> </span><span>event</span><span> </span><span>==</span><span> </span><span>MODULE_EVENT_MODDONE</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>qstate</span><span>.</span><span>ext_state</span><span>[</span><span>id_</span><span>]</span><span> </span><span>=</span><span> </span><span>MODULE_FINISHED</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>qstate</span><span>.</span><span>ext_state</span><span>[</span><span>id_</span><span>]</span><span> </span><span>=</span><span> </span><span>MODULE_ERROR</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>def</span><span> </span><span>request</span><span>(</span><span>url</span><span>:</span><span> </span><span>str</span><span>,</span><span> </span><span>method</span><span>:</span><span> </span><span>str</span><span> </span><span>=</span><span> </span><span>"GET"</span><span>,</span><span> </span><span>body</span><span>:</span><span> </span><span>object</span><span> </span><span>=</span><span> </span><span>None</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Must be HTTPS</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>req</span><span> </span><span>=</span><span> </span><span>urllib</span><span>.</span><span>request</span><span>.</span><span>Request</span><span>(</span><span>url</span><span>=</span><span>url</span><span>,</span><span> </span><span>method</span><span>=</span><span>method</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>req</span><span>.</span><span>add_header</span><span>(</span><span>"Content-Type"</span><span>,</span><span> </span><span>"application/json"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>req</span><span>.</span><span>add_header</span><span>(</span><span>"Accept"</span><span>,</span><span> </span><span>"application/json"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>req</span><span>.</span><span>add_header</span><span>(</span><span>"Authorization"</span><span>,</span><span> </span><span>AUTH_CODE</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span> </span><span>=</span><span> </span><span>ssl</span><span>.</span><span>create_default_context</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span>.</span><span>check_hostname</span><span> </span><span>=</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span>.</span><span>verify_mode</span><span> </span><span>=</span><span> </span><span>ssl</span><span>.</span><span>CERT_NONE</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>data</span><span> </span><span>=</span><span> </span><span>None</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>body</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>data</span><span> </span><span>=</span><span> </span><span>json</span><span>.</span><span>dumps</span><span>(</span><span>body</span><span>)</span><span>.</span><span>encode</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>req</span><span>.</span><span>add_header</span><span>(</span><span>"Content-Length"</span><span>,</span><span> </span><span>str</span><span>(</span><span>len</span><span>(</span><span>data</span><span>)</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>res</span><span> </span><span>=</span><span> </span><span>urllib</span><span>.</span><span>request</span><span>.</span><span>urlopen</span><span>(</span><span>req</span><span>,</span><span> </span><span>data</span><span>,</span><span> </span><span>context</span><span>=</span><span>ctx</span><span>,</span><span> </span><span>timeout</span><span>=</span><span>1</span><span>)</span><span>&nbsp;&nbsp;</span><span># Short timeout!</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>json_</span><span> </span><span>=</span><span> </span><span>json</span><span>.</span><span>load</span><span>(</span><span>res</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>"data"</span><span> </span><span>not</span><span> </span><span>in</span><span> </span><span>json_</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_err</span><span>(</span><span>f</span><span>"data attribute is missing: {json_}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># log_info(json_)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>json_</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>except</span><span> </span><span>Exception</span><span> </span><span>as</span><span> </span><span>e</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_err</span><span>(</span><span>e</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>False</span></p><p><span>def</span><span> </span><span>recreate_vpn_wildcards</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Check if the VPN_wildcard_ips alias exists</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>aliases</span><span> </span><span>=</span><span> </span><span>request</span><span>(</span><span>API_ALIAS_URL</span><span>,</span><span> </span><span>"GET"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>alias </span><span>in</span><span> </span><span>aliases</span><span>[</span><span>"data"</span><span>]</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>"name"</span><span> </span><span>in</span><span> </span><span>alias </span><span>and</span><span> </span><span>alias</span><span>[</span><span>"name"</span><span>]</span><span> </span><span>==</span><span> </span><span>ALIAS_VPN_WILDCARDS</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"Deleting existing {ALIAS_VPN_WILDCARDS}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># FIXME: If tied to a rule... it 400s</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>request</span><span>(</span><span>API_ALIAS_URL</span><span>,</span><span> </span><span>"DELETE"</span><span>,</span><span> </span><span>{</span><span>"id"</span><span>:</span><span> </span><span>ALIAS_VPN_WILDCARDS</span><span>,</span><span> </span><span>"apply"</span><span>:</span><span> </span><span>True</span><span>}</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>break</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Create</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"Creating {ALIAS_VPN_WILDCARDS}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>request</span><span>(</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>API_ALIAS_URL</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"POST"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"name"</span><span>:</span><span> </span><span>ALIAS_VPN_WILDCARDS</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"type"</span><span>:</span><span> </span><span>"host"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"descr"</span><span>:</span><span> </span><span>f</span><span>"Automatic {ALIAS_VPN_DOMAINS} wildcard expansions"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"address"</span><span>:</span><span> </span><span>[</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"detail"</span><span>:</span><span> </span><span>[</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"apply"</span><span>:</span><span> </span><span>True</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Check</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>aliases</span><span> </span><span>=</span><span> </span><span>request</span><span>(</span><span>API_ALIAS_URL</span><span>,</span><span> </span><span>"GET"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>alias </span><span>in</span><span> </span><span>aliases</span><span>[</span><span>"data"</span><span>]</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>"name"</span><span> </span><span>in</span><span> </span><span>alias </span><span>and</span><span> </span><span>alias</span><span>[</span><span>"name"</span><span>]</span><span> </span><span>==</span><span> </span><span>ALIAS_VPN_WILDCARDS</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"Successfully created {ALIAS_VPN_WILDCARDS}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"Unable to create {ALIAS_VPN_WILDCARDS}"</span><span>)</span></p><p><span>def</span><span> </span><span>evict_wildcard_ips</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>cutoff</span><span> </span><span>=</span><span> </span><span>int</span><span>(</span><span>time</span><span>.</span><span>time</span><span>(</span><span>)</span><span>)</span><span> </span><span>-</span><span> </span><span>ALIAS_VPN_WILDCARDS_TTL</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>res</span><span> </span><span>=</span><span> </span><span>request</span><span>(</span><span>API_ALIAS_URL</span><span>,</span><span> </span><span>"GET"</span><span>,</span><span> </span><span>{</span><span>"name"</span><span>:</span><span> </span><span>ALIAS_VPN_WILDCARDS</span><span>}</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>data</span><span>:</span><span> </span><span>dict</span><span> </span><span>=</span><span> </span><span>res</span><span>[</span><span>"data"</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>data</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>alias</span><span> </span><span>=</span><span> </span><span>data</span><span>.</span><span>popitem</span><span>(</span><span>)</span><span>[</span><span>1</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>addresses</span><span> </span><span>=</span><span> </span><span>str</span><span>(</span><span>alias</span><span>[</span><span>"address"</span><span>]</span><span>)</span><span>.</span><span>split</span><span>(</span><span>" "</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>timestamps</span><span> </span><span>=</span><span> </span><span>str</span><span>(</span><span>alias</span><span>[</span><span>"detail"</span><span>]</span><span>)</span><span>.</span><span>split</span><span>(</span><span>"||"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>assert</span><span> </span><span>len</span><span>(</span><span>addresses</span><span>)</span><span> </span><span>==</span><span> </span><span>len</span><span>(</span><span>timestamps</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>evictable</span><span> </span><span>=</span><span> </span><span>[</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>timestamp</span><span>,</span><span> </span><span>address </span><span>in</span><span> </span><span>zip</span><span>(</span><span>timestamps</span><span>,</span><span> </span><span>addresses</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>int</span><span>(</span><span>timestamp</span><span>)</span><span> </span><span>&lt;</span><span> </span><span>cutoff</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>evictable</span><span>.</span><span>append</span><span>(</span><span>address</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>len</span><span>(</span><span>evictable</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"Evicting {evictable}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>request</span><span>(</span><span>url</span><span>=</span><span>API_ALIAS_ENTRY_URL</span><span>,</span><span> </span><span>method</span><span>=</span><span>"DELETE"</span><span>,</span><span> </span><span>body</span><span>=</span><span>{</span><span>"name"</span><span>:</span><span> </span><span>ALIAS_VPN_WILDCARDS</span><span>,</span><span> </span><span>"address"</span><span>:</span><span> </span><span>evictable</span><span>,</span><span> </span><span>"apply"</span><span>:</span><span> </span><span>True</span><span>}</span><span>)</span></p><p><span>def</span><span> </span><span>add_wildcard_ips</span><span>(</span><span>ips</span><span>:</span><span> </span><span>Union</span><span>[</span><span>str</span><span>,</span><span> </span><span>list</span><span>]</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>isinstance</span><span>(</span><span>ips</span><span>,</span><span> </span><span>str</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ips</span><span> </span><span>=</span><span> </span><span>[</span><span>ips</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ips_repr</span><span> </span><span>=</span><span> </span><span>", "</span><span>.</span><span>join</span><span>(</span><span>ips</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"Adding [{ips_repr}]"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>res</span><span> </span><span>=</span><span> </span><span>request</span><span>(</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>API_ALIAS_ENTRY_URL</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"POST"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"name"</span><span>:</span><span> </span><span>ALIAS_VPN_WILDCARDS</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"type"</span><span>:</span><span> </span><span>"host"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"descr"</span><span>:</span><span> </span><span>ips_repr</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"address"</span><span>:</span><span> </span><span>ips</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"detail"</span><span>:</span><span> </span><span>[</span><span>str</span><span>(</span><span>int</span><span>(</span><span>time</span><span>.</span><span>time</span><span>(</span><span>)</span><span>)</span><span>)</span><span>]</span><span> </span><span>*</span><span> </span><span>len</span><span>(</span><span>ips</span><span>)</span><span>,</span><span>&nbsp;&nbsp;</span><span># Must be a string</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>details</span><span> </span><span>=</span><span> </span><span>res</span><span>[</span><span>"data"</span><span>]</span><span>[</span><span>"detail"</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># len("1638002792||") == 12</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>len</span><span>(</span><span>details</span><span>)</span><span> </span><span>&gt;=</span><span> </span><span>(</span><span>12</span><span> </span><span>*</span><span> </span><span>ALIAS_VPN_WILDCARDS_CAPACITY</span><span>)</span><span> </span><span>-</span><span> </span><span>2</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>"Capacity reached. Starting eviction..."</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>evict_wildcard_ips</span><span>(</span><span>)</span></p><p><span>def</span><span> </span><span>get_wildcard_patterns</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>patterns</span><span> </span><span>=</span><span> </span><span>set</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>res</span><span> </span><span>=</span><span> </span><span>request</span><span>(</span><span>API_ALIAS_URL</span><span>,</span><span> </span><span>"GET"</span><span>,</span><span> </span><span>{</span><span>"name"</span><span>:</span><span> </span><span>ALIAS_VPN_DOMAINS</span><span>}</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>data</span><span>:</span><span> </span><span>dict</span><span> </span><span>=</span><span> </span><span>res</span><span>[</span><span>"data"</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>data</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>alias</span><span> </span><span>=</span><span> </span><span>data</span><span>.</span><span>popitem</span><span>(</span><span>)</span><span>[</span><span>1</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>details</span><span> </span><span>=</span><span> </span><span>str</span><span>(</span><span>alias</span><span>[</span><span>"detail"</span><span>]</span><span>)</span><span>.</span><span>split</span><span>(</span><span>"||"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>detail </span><span>in</span><span> </span><span>details</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>"*."</span><span> </span><span>in</span><span> </span><span>detail </span><span>or</span><span> </span><span>".*"</span><span> </span><span>in</span><span> </span><span>detail</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>patterns</span><span>.</span><span>add</span><span>(</span><span>detail</span><span>.</span><span>replace</span><span>(</span><span>"*."</span><span>,</span><span> </span><span>"."</span><span>)</span><span>.</span><span>replace</span><span>(</span><span>".*"</span><span>,</span><span> </span><span>"."</span><span>)</span><span>)</span><span>&nbsp;&nbsp;</span><span># TODO: Make robust</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>addresses</span><span> </span><span>=</span><span> </span><span>str</span><span>(</span><span>alias</span><span>[</span><span>"address"</span><span>]</span><span>)</span><span>.</span><span>split</span><span>(</span><span>" "</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>address </span><span>in</span><span> </span><span>addresses</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>patterns</span><span>.</span><span>add</span><span>(</span><span>address</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"Found wildcard patterns: {patterns}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>patterns</span></p><p><span>if</span><span> </span><span>TEST_MODE</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>__name__</span><span> </span><span>==</span><span> </span><span>"__main__"</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>"Init start"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>recreate_vpn_wildcards</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>add_wildcard_ips</span><span>(</span><span>"1.2.3.4"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>add_wildcard_ips</span><span>(</span><span>[</span><span>"1.2.3.4"</span><span>,</span><span> </span><span>"1.2.3.5"</span><span>]</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>evict_wildcard_ips</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>get_wildcard_patterns</span><span>(</span><span>)</span></p></div></td></tr></tbody></table></div><p>When I woke up, the Unbound DNS resolver service <strong>segfaulted</strong>. Here are the logs:</p><figure id="attachment_5653"><a href="https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update.png"><img src="https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update.png" alt="We can see a full FQDN alias re-process on each firewall config update" width="626" height="913" srcset="https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update.png 626w, https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update-206x300.png 206w, https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update-600x875.png 600w" sizes="(max-width: 626px) 100vw, 626px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update.png" data-srcset="https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update.png 626w, https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update-206x300.png 206w, https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update-600x875.png 600w"></a><figcaption>We can see a full FQDN alias re-process on each firewall config update</figcaption></figure><div><p><strong>Failure:</strong> Capturing all the IPs from the DNS queries to <code>*.googlevideo.com</code> and <code>*.google.com</code> puts pfSense into a crawl as all the rules need to be reloaded on each addition.</p></div><p><a href="#top">Top ↩</a></p><hr><div><p><a name="new-goal2"></a><strong>New Goal:</strong> Research and install a Squid-like proxy, create a fake-but-trusted CA certificate, host it, install it in a browser as a PoC, decode TLS traffic, and victory dance.</p></div><p>Actually, it is <em>not</em> illegal to <a href="https://github.com/NSSpiral/Blackb0x" target="_blank" rel="nofollow">jailbreak most Apple TV boxes</a>, so we could break in, add a root certificate valid for the pfSense box, MITM traffic from the Apple TV, and then Microsoft Bob is your uncle. That works because the pfSense box as the gateway can decrypt Apple TV traffic, inspect the request headers for the offending ad <code>hostname</code>, block the request, and re-encrypt other valid requests to Mountainview, California.</p><p>But, then my iPhone would still show ads because it is harder to jailbreak, plus banking apps may detect this and not work anymore. Jailbreaking is too extreme, anyway.</p><div><p><a name="jailbreak"></a><strong>Fun fact:</strong> I used a jailbroken iPhone all the time in Japan because of a quirky cellphone law. You see, because of icky perverts who like to take photos inappropriately on elevators and escalators, Japan passed a law that made the camera shutter sound mandatory on all photos.<br><span>&nbsp;</span><br>Super unfortunate was that taking a <em>screenshot</em> of a web page also made the same loud, unmuteable shutter sound. Imagine you are on a train and you screenshot a Google map, it makes that loud shutter noise, and then you get dirty looks from the train riders. Yeah, I had to jailbreak and zero out the camera sound file.</p></div><p>Let’s see what it takes to spy on the HTTPS traffic from the Apple TV and iPhone to see if we can block ad URLs that way.</p><p><a href="#top">Top ↩</a></p><hr><h2>Install a Fake-but-Trusted CA Cert on Apple TV and iPhone?</h2><p>Not wanting to jailbreak and add self-signed certs to Apple TV and iPhone, how hard would it be instead to add fake-but-trusted Certificate Authority (CA) certificates to each device?</p><p>The ‘A’ in CA means there is no one higher to vet such a certificate. The ‘A’ is so powerful, that back in 2001 only a Windows patch was able to revoke some <a href="https://en.wikipedia.org/wiki/Verisign#2001:_Code_signing_certificate_mistake" target="_blank" rel="nofollow">dangerous Verisign certificates</a>. As a thought experiment, new CAs must come into existence from time to time. Let’s Encrypt is relatively new, for example. There should then be an in-warranty way to get a fake, trusted CA cert into an Apple TV and iPhone. If that is possible, then an entire world of MITM spycraft is available to decrypt TLS packets in the clear and use good ‘ol URL blocking on requests like</p><div id="crayon-63661eaabe4ce917346489" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>https</span><span>:</span><span>/</span><span>/</span><span>www</span><span>.youtube</span><span>.com</span><span>/</span><span>pagead</span><span>/</span><span>viewthroughconversion</span><span>/</span><span>.</span><span>.</span><span>.</span></p><p><span>https</span><span>:</span><span>/</span><span>/</span><span>www</span><span>.youtube</span><span>.com</span><span>/</span><span>pagead</span><span>/</span><span>conversion</span><span>/</span><span>.</span><span>.</span><span>.</span></p></div></td></tr></tbody></table></div><p>Let’s see how easy this would be.</p><figure id="attachment_5684"><a href="https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too.jpg"><img src="https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-754x353.jpg" alt="We can add fake, trusted CA certs to iPhone too" width="754" height="353" srcset="https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-754x353.jpg 754w, https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-300x141.jpg 300w, https://static.ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-600x281.jpg 600w, https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too.jpg 1280w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-754x353.jpg" data-srcset="https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-754x353.jpg 754w, https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-300x141.jpg 300w, https://static.ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-600x281.jpg 600w, https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too.jpg 1280w"></a><figcaption>We can add fake, trusted CA certs to iPhone too</figcaption></figure><p>In fact, there are many, many CAs. Here is a quick <code>find / -name "*.pem"</code> in pfSense:</p><figure id="attachment_5702"><a href="https://static.ericdraken.com/files/Many-CAs-exist-already.png"><img src="https://static.ericdraken.com/files/Many-CAs-exist-already-754x320.png" alt="Many CAs exist already" width="754" height="320" srcset="https://static.ericdraken.com/files/Many-CAs-exist-already-754x320.png 754w, https://static.ericdraken.com/files/Many-CAs-exist-already-300x127.png 300w, https://static.ericdraken.com/files/Many-CAs-exist-already-600x254.png 600w, https://static.ericdraken.com/files/Many-CAs-exist-already.png 880w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Many-CAs-exist-already-754x320.png" data-srcset="https://static.ericdraken.com/files/Many-CAs-exist-already-754x320.png 754w, https://static.ericdraken.com/files/Many-CAs-exist-already-300x127.png 300w, https://static.ericdraken.com/files/Many-CAs-exist-already-600x254.png 600w, https://static.ericdraken.com/files/Many-CAs-exist-already.png 880w"></a><figcaption>Many CAs exist already</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Experiment with Squid and SquidGuard</h2><p>I’m aware of <a href="https://mitmproxy.org/" target="_blank" rel="nofollow">mitmproxy</a>, but it needs to be side-channel installed onto the pfSense router. Let’s see if the <code>squid3</code> proxy that is available as a pfSense package can do what we need. First, I will take a bare-metal backup again so I can roll back in case <code>mitmproxy</code> is better.</p><figure id="attachment_5691"><a href="https://static.ericdraken.com/files/Install-squid3-and-ancillary-packages.png"><img src="https://ericdraken.com/files/Install-squid3-and-ancillary-packages-754x348.png" alt="Install squid3 and ancillary packages" width="754" height="348" srcset="https://ericdraken.com/files/Install-squid3-and-ancillary-packages-754x348.png 754w, https://static.ericdraken.com/files/Install-squid3-and-ancillary-packages-300x139.png 300w, https://ericdraken.com/files/Install-squid3-and-ancillary-packages-600x277.png 600w, https://static.ericdraken.com/files/Install-squid3-and-ancillary-packages.png 1147w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Install-squid3-and-ancillary-packages-754x348.png" data-srcset="https://ericdraken.com/files/Install-squid3-and-ancillary-packages-754x348.png 754w, https://static.ericdraken.com/files/Install-squid3-and-ancillary-packages-300x139.png 300w, https://ericdraken.com/files/Install-squid3-and-ancillary-packages-600x277.png 600w, https://static.ericdraken.com/files/Install-squid3-and-ancillary-packages.png 1147w"></a><figcaption>Install squid3 and ancillary packages</figcaption></figure><p>I’ve installed those packages, and naturally, there are more buttons and options than in a space shuttle. I’ll find a <a href="https://turbofuture.com/internet/Intercepting-HTTPS-Traffic-Using-the-Squid-Proxy-in-pfSense" target="_blank" rel="nofollow">guide</a>.</p><p>I’ve followed the steps in the guide, however, since I have a large SSD and generous RAM, I’ve made a dedicated folder <code>/squid_cache</code> (and <code>chown squid:proxy</code>) with 8 GiB of cache and a juicy allowance on the per-item cache size which should also help with Docker and NPM speed-up. Two birds, one stone. With Transparent HTTPS support, this should be pretty rad.</p><div><p><strong>Tip:</strong> If web traffic slows down while using Squid, here are some System Tunables that can make Squid faster (<a href="https://forum.netgate.com/topic/85937/pfsense-2-2-3-internet-is-very-slow-via-squid3/12" target="_blank" rel="nofollow">ref</a>):</p><p><code>vfs.read_max 128</code><br><code>kern.ipc.nmbclusters 32768</code></p><p>Also, for local disk cache, <code>aufs</code> is asynchronous <code>ufs</code> (great for Docker too) and uses POSIX-threads to avoid blocking the main Squid process on disk-I/O.<br></p></div><p>We can actually generate a CA cert in pfSense itself.</p><figure id="attachment_5695"><a href="https://static.ericdraken.com/files/Generate-a-CA-in-pfSense.png"><img src="https://static.ericdraken.com/files/Generate-a-CA-in-pfSense-754x275.png" alt="Generate a CA in pfSense" width="754" height="275" srcset="https://static.ericdraken.com/files/Generate-a-CA-in-pfSense-754x275.png 754w, https://ericdraken.com/files/Generate-a-CA-in-pfSense-300x109.png 300w, https://ericdraken.com/files/Generate-a-CA-in-pfSense-600x219.png 600w, https://static.ericdraken.com/files/Generate-a-CA-in-pfSense.png 1137w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Generate-a-CA-in-pfSense-754x275.png" data-srcset="https://static.ericdraken.com/files/Generate-a-CA-in-pfSense-754x275.png 754w, https://ericdraken.com/files/Generate-a-CA-in-pfSense-300x109.png 300w, https://ericdraken.com/files/Generate-a-CA-in-pfSense-600x219.png 600w, https://static.ericdraken.com/files/Generate-a-CA-in-pfSense.png 1137w"></a><figcaption>Generate a CA in pfSense</figcaption></figure><p>Now, how to get it into the Apple TV and iPhone? It should be hosted somewhere, right? How about on the router?</p><p><a href="#top">Top ↩</a></p><hr><h2>Self-Host the MITM CA Certificate</h2><p>Self-hosting with a single command is ridiculously easy. From the SSH shell into pfSense, I can create a web folder and server like so:</p><div id="crayon-63661eaabe4d3248535284" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>mkdir</span><span> </span><span>/</span><span>www</span></p><p><span>chown</span><span> </span><span>-</span><span>R</span><span> </span><span>squid</span><span>:</span><span>proxy</span><span> </span><span>/</span><span>www</span></p><p><span>chmod</span><span> </span><span>-</span><span>R</span><span> </span><span>644</span><span> </span><span>/</span><span>www</span></p><p><span>echo</span><span> </span><span>"Hello"</span><span> </span><span>&gt;</span><span> </span><span>/</span><span>www</span><span>/</span><span>index</span><span>.php</span></p><p><span>php</span><span> </span><span>-</span><span>S</span><span> </span><span>0.0.0.0</span><span>:</span><span>8000</span><span> </span><span>-</span><span>t</span><span> </span><span>/</span><span>www</span></p></div></td></tr></tbody></table></div><p>When I visit <code>//pfsense:8000</code> I should get a blank page with “Hello”. From here, clients behind the pfSense router can temporarily access static documents.</p><p>To make like easier, here is a PHP script to cause the MITM cert to download.</p><div id="crayon-63661eaabe4d5989096513" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>&lt;?php</span></p><p><span>$file</span><span> </span><span>=</span><span> </span><span>'/www/mitm.crt'</span><span>;</span></p><p><span>if</span><span> </span><span>(</span><span>file_exists</span><span>(</span><span>$file</span><span>)</span><span>)</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>header</span><span>(</span><span>'Content-Description: File Transfer'</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>header</span><span>(</span><span>'Content-Type: application/octet-stream'</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>header</span><span>(</span><span>'Content-Disposition: attachment; filename="'</span><span>.</span><span>basename</span><span>(</span><span>$file</span><span>)</span><span>.</span><span>'"'</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>header</span><span>(</span><span>'Expires: 0'</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>header</span><span>(</span><span>'Cache-Control: must-revalidate'</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>header</span><span>(</span><span>'Pragma: public'</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>header</span><span>(</span><span>'Content-Length: '</span><span> </span><span>.</span><span> </span><span>filesize</span><span>(</span><span>$file</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>readfile</span><span>(</span><span>$file</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>exit</span><span>;</span></p><p><span>}</span></p><p><span>echo</span><span> </span><span>"Not found"</span><span>;</span></p></div></td></tr></tbody></table></div><p>As another smoke test, I’ll add the MITM CA to Chrome (manually) and enable the SSL Filtering. The defaults are fine in Squid. Here is the log file when I visit <code>https://ericdraken.com</code>:</p><figure id="attachment_5704"><a href="https://ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client.png"><img src="https://ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-754x122.png" alt="Successful capture of TLS requests from a downstream client" width="754" height="122" srcset="https://ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-754x122.png 754w, https://static.ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-300x48.png 300w, https://static.ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-600x97.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-754x122.png" data-srcset="https://ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-754x122.png 754w, https://static.ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-300x48.png 300w, https://static.ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-600x97.png 600w"></a><figcaption>Successful capture of TLS requests from a downstream client</figcaption></figure><p>Excellent.</p><p>However, on every other browser and machine there are HTTPS errors like so:</p><figure id="attachment_5705"><a href="https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing.png"><img src="https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-754x485.png" alt="MITM certificate errors if the CA cert is missing" width="754" height="485" srcset="https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-754x485.png 754w, https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-300x193.png 300w, https://ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-600x386.png 600w, https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing.png 966w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-754x485.png" data-srcset="https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-754x485.png 754w, https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-300x193.png 300w, https://ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-600x386.png 600w, https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing.png 966w"></a><figcaption>MITM certificate errors if the CA cert is missing</figcaption></figure><div><p><strong>Locked out?</strong> If you get locked out of pfSense with a TLS error, you may have to disable Remote Cert Checks as the pfSense web configurator uses a self-signed certificate. Or else, you can bypass the proxy for the pfSense UI under <em>Bypass Proxy for These Destination IPs</em> with <code>pfsense; pfsense.localdomain</code>.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Abandoning Squid: Too Slow, Too Heavy</h2><p>After a day of painfully setting up Squid and SquidGuard and adding blacklists and even manual regex for things like <code>.+?/pagead/.+</code>, I’m having nothing but issues with Squid. Here are the top pain points:</p><ul><li>It’s slow. It’s really slow.</li><li>The ACL (Access Control List) settings are cumbersome.</li><li>There is an issue with <code>https://http/*</code> (<a href="https://forum.netgate.com/topic/141472/https-filter-with-https-http" target="_blank" rel="nofollow">ref</a>).</li><li>The SquidGuard URL filter takes eons to update a list.</li><li>The Squid UI is unbelievably lacking.</li></ul><p>Squid makes me sad. I don’t get sad, but Squid makes me sad with its promise and ultimate letdown. I’ve now obliterated Squid and restored the router from the <code>rsync</code> backup I made earlier. Here is a handy little script to show a diff of what has been added by Squid and related packages.</p><h3>Rsync Diff of Changes</h3><div id="crayon-63661eaabe4d9273516381" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p></div></td><td><div><p><span># Show the changed files since the last rsync.</span></p><p><span># Fix brace expansion and execute (easy to read with tr and sed).</span></p><p><span>cat</span><span> </span><span>&lt;&lt;</span><span> </span><span>EOF</span><span> </span><span>|</span><span> </span><span>tr</span><span> </span><span>-</span><span>s</span><span> </span><span>' '</span><span> </span><span>|</span><span> </span><span>sed</span><span> </span><span>'s/, "/,"/g'</span><span> </span><span>|</span><span> </span><span>bash</span></p><p><span>time</span><span> </span><span>\</span></p><p><span>rsync</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>verbose</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>human</span><span>-</span><span>readable</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>links</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>recursive</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>checksum</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>update</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>delete</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>dry</span><span>-</span><span>run</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>exclude</span><span>=</span><span>{</span><span>"/dev/*"</span><span>,</span><span>"/proc/*"</span><span>,</span><span>"/sys/*"</span><span>,</span><span>"/tmp/*"</span><span>,</span><span>"/run/*"</span><span>,</span><span>\</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"/var/*"</span><span>,</span><span>"/mnt/*"</span><span>,</span><span>"/media/*"</span><span>,</span><span>"/lost+found"</span><span>}</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>rsh</span><span>=</span><span>"ssh -p 2222"</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>~</span><span>/</span><span>.pfsense</span><span>-</span><span>backup</span><span>/</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>admin</span><span>@</span><span>pfsense</span><span>:</span><span>/</span><span> </span><span>|</span><span> </span><span>grep</span><span> </span><span>-</span><span>v</span><span> </span><span>'/$'</span><span>&nbsp;&nbsp;</span><span># Hide folders</span></p><p><span>EOF</span></p></div></td></tr></tbody></table></div><p>The output is something like this under the <code>--dry-run</code> option:</p><div id="crayon-63661eaabe4db777065170" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="hide"></td><td><div><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squidGuard</span><span>/</span><span>squidguard_conf</span><span>.xml</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squidGuard</span><span>/</span><span>squidGuard_blk_rebuild</span><span>.conf</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squidGuard</span><span>/</span><span>squidGuard__usrdbrebuild</span><span>.conf</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squidGuard</span><span>/</span><span>squidGuard</span><span>.conf</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squidGuard</span><span>/</span><span>blacklist</span><span>.files</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squid</span><span>/</span><span>squidGuard</span><span>.conf</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squid</span><span>/</span><span>squid</span><span>.conf</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squid</span><span>/</span><span>serverkey</span><span>.pem</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squid</span><span>/</span><span>exclude_domains</span><span>.conf</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>lightsquid</span><span>/</span><span>lightsquid</span><span>.cfg</span></p><p><span>.</span><span>.</span><span>.</span></p></div></td></tr></tbody></table></div><p><a href="#top">Top ↩</a></p><hr><h2>Install MITMProxy in a FreeBSD Jail</h2><p>Even though written in Python, I’ll give <a href="https://mitmproxy.org/" target="_blank" rel="nofollow">mitmproxy</a> a try next; at the very least it can be purpose-built to block YouTube ads with its rich API and Python-hook extensibility. It was a coin toss between <code>mitmproxy</code> and <code>SSLSplit</code> – a Metasploit hack tool – to achieve on-the-fly TLS interception, but the former can be scripted with Python and has a satisfying UI. Let’s go.</p><div><p><strong>Careful:</strong> Please read the whole section before trying any commands because I backtracked a bit but want to explain why.</p></div><div id="crayon-63661eaabe4de391025133" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>set </span><span>LATEST</span><span>=</span><span>7.0.4</span></p><p><span>mkdir</span><span> </span><span>/</span><span>tmp</span><span>/</span><span>mitm</span><span>-</span><span>$</span><span>{</span><span>LATEST</span><span>}</span><span> </span><span>&amp;&amp;</span><span> </span><span>cd</span><span> </span><span>/</span><span>tmp</span><span>/</span><span>mitm</span><span>-</span><span>$</span><span>{</span><span>LATEST</span><span>}</span></p><p><span>curl </span><span>https</span><span>:</span><span>/</span><span>/</span><span>snapshots</span><span>.mitmproxy</span><span>.org</span><span>/</span><span>$</span><span>{</span><span>LATEST</span><span>}</span><span>/</span><span>mitmproxy</span><span>-</span><span>$</span><span>{</span><span>LATEST</span><span>}</span><span>-</span><span>linux</span><span>.tar</span><span>.gz</span><span> </span><span>--</span><span>output</span><span> </span><span>mitmproxy</span><span>-</span><span>$</span><span>{</span><span>LATEST</span><span>}</span><span>.tar</span><span>.gz</span></p><p><span>tar</span><span> </span><span>-</span><span>xvzf</span><span> </span><span>mitmproxy</span><span>-</span><span>$</span><span>{</span><span>LATEST</span><span>}</span><span>.tar</span><span>.gz</span><span> </span><span>&amp;&amp;</span><span> </span><span>rm</span><span> </span><span>mitmproxy</span><span>-</span><span>$</span><span>{</span><span>LATEST</span><span>}</span><span>.tar</span><span>.gz</span></p></div></td></tr></tbody></table></div><p>You’ll notice that there are only three binaries about 24 MiB each. As I understand it, they have a self-contained Python 3 environment and frozen dependencies. I’d like to jail these binaries because, well, because. First, let’s see if there is a vulnerability report for <code>mitmproxy</code> at <a href="https://vuxml.freebsd.org/freebsd/index.html" target="_blank" rel="nofollow">vuxml.freebsd.org</a>. Nothing. How about at <a href="https://www.exploit-db.com/" target="_blank" rel="nofollow">Exploit-DB</a>? Nothing again. Good.</p><p>First, what version of FreeBSD is this pfSense install?</p><div id="crayon-63661eaabe4e0675538432" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>freebsd</span><span>-</span><span>version</span><span> </span><span>-</span><span>k</span></p><p><span># 12.2-Stable</span></p><p><span>getconf</span><span> </span><span>LONG_BIT</span></p><p><span># 64 - This means we are using a 64-bit build</span></p></div></td></tr></tbody></table></div><p>Now, according to this <a href="https://blog.viktorpetersson.com/2018/01/27/jails-on-pfsense.html" target="_blank" rel="nofollow">guide</a>, I’ll need to set up jails myself as they are disabled in a default pfSense installation. Not knowing FreeBSD at all before today, I had to hack around to find a URL to download the <code>ezjail</code> package manually. After another bare-metal backup, here are the steps I took:</p><div id="crayon-63661eaabe4e2901951388" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p></div></td><td><div><p><span># Set versions</span></p><p><span>set </span><span>EZ_VER</span><span>=</span><span>3.4.2_1</span></p><p><span>set </span><span>BSD_VER</span><span>=</span><span>12</span></p><p><span># Install the ezjail package manually</span></p><p><span>mkdir</span><span> </span><span>/</span><span>tmp</span><span>/</span><span>ezjail</span><span> </span><span>&amp;&amp;</span><span> </span><span>cd</span><span> </span><span>/</span><span>tmp</span><span>/</span><span>ezjail</span></p><p><span>curl </span><span>https</span><span>:</span><span>/</span><span>/</span><span>pkg</span><span>.freebsd</span><span>.org</span><span>/</span><span>FreeBSD</span><span>:</span><span>$</span><span>{</span><span>BSD_VER</span><span>}</span><span>:</span><span>amd64</span><span>/</span><span>latest</span><span>/</span><span>All</span><span>/</span><span>ezjail</span><span>-</span><span>$</span><span>{</span><span>EZ_VER</span><span>}</span><span>.pkg</span><span> </span><span>--</span><span>output</span><span> </span><span>ezjail</span><span>-</span><span>$</span><span>{</span><span>EZ_VER</span><span>}</span><span>.pkg</span></p><p><span>pkg</span><span> </span><span>add</span><span> </span><span>ezjail</span><span>-</span><span>$</span><span>{</span><span>EZ_VER</span><span>}</span><span>.pkg</span></p><p><span># Add a missing jail RC file</span></p><p><span># NOTE: Version 12 does not exist, so use 11</span></p><p><span>curl</span><span> </span><span>--</span><span>output </span><span>jail</span><span>.tmp</span><span> </span><span>https</span><span>:</span><span>/</span><span>/</span><span>raw</span><span>.githubusercontent</span><span>.com</span><span>/</span><span>freebsd</span><span>/</span><span>freebsd</span><span>/</span><span>stable</span><span>/</span><span>11</span><span>/</span><span>etc</span><span>/</span><span>rc</span><span>.d</span><span>/</span><span>jail</span></p><p><span># Check that we did not get a 404d file</span></p><p><span>(</span><span>cat</span><span> </span><span>jail</span><span>.tmp</span><span> </span><span>|</span><span> </span><span>grep</span><span> </span><span>-</span><span>q</span><span> </span><span>"FreeBSD"</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>&amp;&amp;</span><span> </span><span>mv</span><span> </span><span>jail</span><span>.tmp</span><span> </span><span>/</span><span>etc</span><span>/</span><span>rc</span><span>.d</span><span>/</span><span>jail</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>&amp;&amp;</span><span> </span><span>chmod</span><span> </span><span>+</span><span>x</span><span> </span><span>/</span><span>etc</span><span>/</span><span>rc</span><span>.d</span><span>/</span><span>jail</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>&amp;&amp;</span><span> </span><span>chmod</span><span> </span><span>u</span><span>-</span><span>w</span><span> </span><span>/</span><span>etc</span><span>/</span><span>rc</span><span>.d</span><span>/</span><span>jail</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>&amp;&amp;</span><span> </span><span>echo</span><span> </span><span>"Success"</span><span>)</span><span> </span><span>\</span></p><p><span>||</span><span> </span><span>echo</span><span> </span><span>"Download failed"</span></p><p><span># Enable jails by writing a file that may not exist</span></p><p><span>echo</span><span> </span><span>'ezjail_enable="YES"'</span><span> </span><span>|</span><span> </span><span>tee</span><span> </span><span>-</span><span>a</span><span> </span><span>/</span><span>etc</span><span>/</span><span>rc</span><span>.conf</span><span>.local</span></p><p><span># Init jails (takes about 30s)</span></p><p><span>ezjail</span><span>-</span><span>admin </span><span>install</span></p></div></td></tr></tbody></table></div><p>We need to do some hacking to get <code>jail</code> working on pfSense’s take on FreeBSD because <code>jail</code> is missing completely. What I’ve done is copy the <code>jail</code> binaries <em>from</em> a jail (via <code>ezjail</code>) back to the root system.</p><div id="crayon-63661eaabe4e5525186613" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>cd</span><span> </span><span>/</span><span>usr</span><span>/</span><span>sbin</span><span>/</span></p><p><span>cp</span><span> </span><span>/</span><span>usr</span><span>/</span><span>jails</span><span>/</span><span>basejail</span><span>/</span><span>usr</span><span>/</span><span>sbin</span><span>/</span><span>jail </span><span>jail</span><span> </span><span>&amp;&amp;</span><span> </span><span>chmod</span><span> </span><span>+</span><span>x</span><span> </span><span>jail</span></p><p><span>cp</span><span> </span><span>/</span><span>usr</span><span>/</span><span>jails</span><span>/</span><span>basejail</span><span>/</span><span>usr</span><span>/</span><span>sbin</span><span>/</span><span>jail </span><span>jls</span><span> </span><span>&amp;&amp;</span><span> </span><span>chmod</span><span> </span><span>+</span><span>x</span><span> </span><span>jls</span></p><p><span>cp</span><span> </span><span>/</span><span>usr</span><span>/</span><span>jails</span><span>/</span><span>basejail</span><span>/</span><span>usr</span><span>/</span><span>sbin</span><span>/</span><span>jail </span><span>jexec</span><span> </span><span>&amp;&amp;</span><span> </span><span>chmod</span><span> </span><span>+</span><span>x</span><span> </span><span>jexec</span></p></div></td></tr></tbody></table></div><p>Let’s set up a jail for <code>mitmproxy</code>.</p><div id="crayon-63661eaabe4e7652363682" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p></div></td><td><div><p><span># Ignore the warnings that many ports are already bound to 127.0.1.1</span></p><p><span>ezjail</span><span>-</span><span>admin </span><span>create </span><span>mitmproxy</span><span> </span><span>'lo0|127.0.1.1'</span></p><p><span># Disable procfs as we don't need processor info</span></p><p><span>sed</span><span> </span><span>-</span><span>I</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>-</span><span>e</span><span> </span><span>'s/procfs_enable=\"YES\"/procfs_enable=\"NO\"/g'</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>/</span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>ezjail</span><span>/</span><span>mitmproxy</span></p><p><span># Start the jail</span></p><p><span>ezjail</span><span>-</span><span>admin </span><span>start </span><span>mitmproxy</span></p><p><span># Show the jail</span></p><p><span>ezjail</span><span>-</span><span>admin </span><span>list</span></p><p><span># Log into the jail</span></p><p><span># We should get: `root@mitmproxy:~ # `</span></p><p><span>ezjail</span><span>-</span><span>admin </span><span>console </span><span>mitmproxy</span></p><p><span># exit</span></p><p><span># TIP: To delete a jail later:</span></p><p><span># ezjail-admin delete mitmproxy</span></p><p><span># chflags -R noschg /usr/jails/mitmproxy</span></p><p><span># rm -rf /usr/jails/mitmproxy</span></p></div></td></tr></tbody></table></div><p><strong><span>This is very important:</span></strong> We must enable raw sockets in this jail to allow transparent proxy mode to work. If not, MITMProxy will report errors like “Transparent mode failure: FileNotFoundError(2, ‘No such file or directory’)” or “Cannot open connection, no hostname given.” This is because raw sockets are inaccessible and server information is unavailable. We can easily edit the <code>ezjail</code> config file per jail like so:</p><div id="crayon-63661eaabe4e9785826618" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p></div></td><td><div><p><span># Edit: /usr/local/etc/ezjail/mitmproxy</span></p><p><span>#</span></p><p><span># To specify the start-up order of your ezjails, use these lines to</span></p><p><span># create a Jail dependency tree. See rcorder(8) for more details.</span></p><p><span>#</span></p><p><span># PROVIDE: standard_ezjail</span></p><p><span># REQUIRE:</span></p><p><span># BEFORE:</span></p><p><span>#</span></p><p><span># This is very important to work properly with pfSense</span></p><p><span>export </span><span>jail_mitmproxy_parameters</span><span>=</span><span>"allow.raw_sockets=1"</span></p><p><span>export </span><span>jail_mitmproxy_hostname</span><span>=</span><span>"mitmproxy"</span></p><p><span>export </span><span>jail_mitmproxy_ip</span><span>=</span><span>"lo0|127.0.1.1"</span></p><p><span>export </span><span>jail_mitmproxy_rootdir</span><span>=</span><span>"/usr/jails/mitmproxy"</span></p><p><span>export </span><span>jail_mitmproxy_exec_start</span><span>=</span><span>"/bin/sh /etc/rc"</span></p><p><span>export </span><span>jail_mitmproxy_exec_stop</span><span>=</span><span>""</span></p><p><span>export </span><span>jail_mitmproxy_mount_enable</span><span>=</span><span>"YES"</span></p><p><span>export </span><span>jail_mitmproxy_devfs_enable</span><span>=</span><span>"YES"</span></p><p><span>export </span><span>jail_mitmproxy_devfs_ruleset</span><span>=</span><span>"devfsrules_jail"</span></p><p><span>export </span><span>jail_mitmproxy_procfs_enable</span><span>=</span><span>"NO"</span></p><p><span>export </span><span>jail_mitmproxy_fdescfs_enable</span><span>=</span><span>"YES"</span></p><p><span># Restart the jail:</span></p><p><span># /usr/local/etc/rc.d/ezjail restart mitmproxy</span></p></div></td></tr></tbody></table></div><p><strong><span>This is also very important:</span></strong> MITMProxy calls <code>sudo -n /sbin/pfctl -s state</code> but there is no <code>sudo</code> in <code>jail</code>. Run <code>pkg install sudo</code> inside the jail.</p><div><p><strong>Sanity Check:</strong> If you are unsuccessful when you run <code>ping 1.1.1.1</code> inside the jail, you may get an error like this: “ssend socket: Operation not permitted”. If you are successful, then <code>ping</code> works as it needs access to raw sockets.</p></div><p>Now we can copy over the <code>mitmproxy</code> binaries and take them for a spin.</p><div id="crayon-63661eaabe4ec017278571" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># Copy the binaries into the new jail</span></p><p><span>cp</span><span> </span><span>-</span><span>r</span><span> </span><span>/</span><span>tmp</span><span>/</span><span>mitm</span><span>-</span><span>$</span><span>{</span><span>LATEST</span><span>}</span><span> </span><span>/</span><span>usr</span><span>/</span><span>jails</span><span>/</span><span>mitmproxy</span><span>/</span><span>root</span><span>/</span></p><p><span># Deal with some FreeBSD shenanigans about 'ELF binary type 0 not known'</span></p><p><span>brandelf</span><span> </span><span>-</span><span>t</span><span> </span><span>freebsd </span><span>mitm</span><span>*</span></p></div></td></tr></tbody></table></div><p>Things are getting tricky with this next part. Running any of the binaries above results in:</p><div id="crayon-63661eaabe4ee320462538" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># root@mitmproxy:~/mitm-7.0.4 # ./mitmproxy</span></p><p><span># ELF interpreter /lib64/ld-linux-x86-64.so.2 not found, error 2</span></p><p><span># Abort</span></p></div></td></tr></tbody></table></div><p>So, there is no <code>/lib64</code> folder nor any similar dynamic linker that I could find. I tried this, however:</p><div id="crayon-63661eaabe4ef345377858" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>root</span><span>@</span><span>mitmproxy</span><span>:</span><span>~</span><span> </span><span># ln -s /libexec/ld-elf.so.1 /lib64/ld-linux-x86-64.so.2</span></p><p><span>root</span><span>@</span><span>mitmproxy</span><span>:</span><span>~</span><span> </span><span># cd mitm-7.0.4/</span></p><p><span>root</span><span>@</span><span>mitmproxy</span><span>:</span><span>~</span><span>/</span><span>mitm</span><span>-</span><span>7.0.4</span><span> </span><span># ./mitmproxy</span></p><p><span>ld</span><span>-</span><span>elf</span><span>.so</span><span>.</span><span>1</span><span>:</span><span> </span><span>Shared </span><span>object</span><span> </span><span>"libdl.so.2"</span><span> </span><span>not</span><span> </span><span>found</span><span>,</span><span> </span><span>required </span><span>by</span><span> </span><span>"mitmproxy"</span></p><p><span>root</span><span>@</span><span>mitmproxy</span><span>:</span><span>~</span><span>/</span><span>mitm</span><span>-</span><span>7.0.4</span><span> </span><span># ldd mitmproxy</span></p><p><span>mitmproxy</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>libdl</span><span>.so</span><span>.</span><span>2</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>not</span><span> </span><span>found</span><span> </span><span>(</span><span>0</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>libz</span><span>.so</span><span>.</span><span>1</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>not</span><span> </span><span>found</span><span> </span><span>(</span><span>0</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>libpthread</span><span>.so</span><span>.</span><span>0</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>not</span><span> </span><span>found</span><span> </span><span>(</span><span>0</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>libc</span><span>.so</span><span>.</span><span>6</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>not</span><span> </span><span>found</span><span> </span><span>(</span><span>0</span><span>)</span></p><p><span>root</span><span>@</span><span>mitmproxy</span><span>:</span><span>~</span><span>/</span><span>mitm</span><span>-</span><span>7.0.4</span><span> </span><span># </span></p></div></td></tr></tbody></table></div><p>Apparently, there is a <code>pkg install compat6x</code> that can solve this for us (unavailable on pfSense), however, this is getting ridiculous! Let’s try a new tactic. Since we are in a jail, we are not bound to the crippled (read: secured) pfSense environment. Maybe we can install the <code>mitmproxy</code> package normally in a jail?</p><p><code>pkg install mitmproxy</code></p><div id="crayon-63661eaabe4f2162327378" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>.</span><span>.</span><span>.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>py38</span><span>-</span><span>urwid</span><span>:</span><span> </span><span>2.1.2</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>py38</span><span>-</span><span>werkzeug</span><span>:</span><span> </span><span>2.0.1</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>py38</span><span>-</span><span>wsproto</span><span>:</span><span> </span><span>1.0.0</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>py38</span><span>-</span><span>zstandard</span><span>:</span><span> </span><span>0.15.2</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>python38</span><span>:</span><span> </span><span>3.8.12</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>readline</span><span>:</span><span> </span><span>8.1.1</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>sqlite3</span><span>:</span><span> </span><span>3.35.5_3</span><span>,</span><span>1</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>zstd</span><span>:</span><span> </span><span>1.5.0</span></p><p><span>Number </span><span>of </span><span>packages </span><span>to</span><span> </span><span>be </span><span>installed</span><span>:</span><span> </span><span>50</span></p><p><span>The </span><span>process </span><span>will </span><span>require</span><span> </span><span>206</span><span> </span><span>MiB </span><span>more</span><span> </span><span>space</span><span>.</span></p><p><span>33</span><span> </span><span>MiB </span><span>to</span><span> </span><span>be </span><span>downloaded</span><span>.</span></p><p><span>Proceed </span><span>with </span><span>this</span><span> </span><span>action</span><span>?</span><span> </span><span>[</span><span>y</span><span>/</span><span>N</span><span>]</span><span>:</span><span> </span></p></div></td></tr></tbody></table></div><p>And, Bingo was his name-o. After this, simply running <code>mitmproxy</code> in the jailed console opens the MITMProxy UI. Nice. Note, this version <em>may</em> be one or two minor versions behind the master branch. Let’s clean up with <code>rm -rf ~/mitm* /lib64</code> and do another bare-metal backup.</p><p><a href="#top">Top ↩</a></p><hr><h2>Exploring MITMProxy</h2><p>This is getting exciting. First, in pfSense, add a virtual IP for <code>127.0.1.1</code> attached to <code>localhost</code>. Then, add a NAT rule to temporarily forward port <code>[Private IPs]:8080</code> to <code>127.0.1.1:8080</code> to access the proxy from the LANs.</p><p>If not in the jail console, I’ll run</p><div id="crayon-63661eaabe4f4407729574" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>ezjail</span><span>-</span><span>admin </span><span>console </span><span>mitmproxy</span></p><p><span>mitmproxy</span><span> </span><span>--</span><span>listen</span><span>-</span><span>port</span><span> </span><span>8080</span><span> </span><span>--</span><span>set </span><span>console_focus_follow</span><span>=</span><span>true</span></p></div></td></tr></tbody></table></div><p>and add the proxy setting <code>192.168.20.1:8080</code> to my sacrificial notebook (that is auto-wiped daily). When the browser opens, we can already see colourful log entries in the MITMProxy UI.</p><figure id="attachment_5733"><a href="https://ericdraken.com/files/First-logs-of-MITMProxy.png"><img src="https://static.ericdraken.com/files/First-logs-of-MITMProxy-754x117.png" alt="First logs of MITMProxy" width="754" height="117" srcset="https://static.ericdraken.com/files/First-logs-of-MITMProxy-754x117.png 754w, https://static.ericdraken.com/files/First-logs-of-MITMProxy-300x47.png 300w, https://static.ericdraken.com/files/First-logs-of-MITMProxy-600x93.png 600w, https://ericdraken.com/files/First-logs-of-MITMProxy.png 1428w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/First-logs-of-MITMProxy-754x117.png" data-srcset="https://static.ericdraken.com/files/First-logs-of-MITMProxy-754x117.png 754w, https://static.ericdraken.com/files/First-logs-of-MITMProxy-300x47.png 300w, https://static.ericdraken.com/files/First-logs-of-MITMProxy-600x93.png 600w, https://ericdraken.com/files/First-logs-of-MITMProxy.png 1428w"></a><figcaption>First logs of MITMProxy</figcaption></figure><p>The next step is to get the auto-generated CA PEM file used by MITMProxy (<code>~/.mitmproxy/mitmproxy-ca-cert.pem</code>). Since any CA cert here is snake oil, I’ll use the provided one. TLS traffic from my devices is safe as long as I use my own proxies.</p><p>Let’s put our experience from our previous attempt at self-hosting a CA into action. However, there is no PHP in the jail, so we can use a Python 3 web server instead.</p><div id="crayon-63661eaabe4f6549194476" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>set </span><span>PYTHON</span><span>=</span><span>'/usr/local/bin/python3.8'</span></p><p><span>mkdir</span><span> </span><span>~</span><span>/</span><span>www</span></p><p><span># Both Python and mitmproxy run as 'root'</span></p><p><span>chmod</span><span> </span><span>444</span><span> </span><span>~</span><span>/</span><span>.mitmproxy</span><span>/</span><span>mitmproxy</span><span>-</span><span>ca</span><span>-</span><span>cert</span><span>.pem</span></p><p><span>ln</span><span> </span><span>-</span><span>s</span><span> </span><span>~</span><span>/</span><span>.mitmproxy</span><span>/</span><span>mitmproxy</span><span>-</span><span>ca</span><span>-</span><span>cert</span><span>.pem</span><span> </span><span>~</span><span>/</span><span>www</span><span>/</span><span>cert</span><span>.pem</span></p><p><span>$PYTHON</span><span> </span><span>-</span><span>m</span><span> </span><span>http</span><span>.server</span><span> </span><span>--</span><span>bind</span><span> </span><span>127.0.1.1</span><span> </span><span>--</span><span>directory</span><span> </span><span>~</span><span>/</span><span>www</span><span> </span><span>8001</span></p></div></td></tr></tbody></table></div><div><p><strong>Tip:</strong> MITMProxy conveniently has onboarding settings to serve the same CA cert, as we did manually, just by visiting <code>mitm.it</code>.</p></div><p>After installing the CA in the Trusted Root Store on my clean notebook (and rebooting), I am treated to this display:</p><figure id="attachment_5734"><a href="https://ericdraken.com/files/MITM-TLS-interception-is-working-well.png"><img src="https://ericdraken.com/files/MITM-TLS-interception-is-working-well-754x293.png" alt="MITM TLS interception is working well" width="754" height="293" srcset="https://ericdraken.com/files/MITM-TLS-interception-is-working-well-754x293.png 754w, https://ericdraken.com/files/MITM-TLS-interception-is-working-well-300x117.png 300w, https://static.ericdraken.com/files/MITM-TLS-interception-is-working-well-600x233.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/MITM-TLS-interception-is-working-well-754x293.png" data-srcset="https://ericdraken.com/files/MITM-TLS-interception-is-working-well-754x293.png 754w, https://ericdraken.com/files/MITM-TLS-interception-is-working-well-300x117.png 300w, https://static.ericdraken.com/files/MITM-TLS-interception-is-working-well-600x233.png 600w"></a><figcaption>MITM TLS interception is working well</figcaption></figure><p>Let’s see if we can get this cert on my iPhone.</p><figure id="attachment_5738"><a href="https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone.png"><img src="https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-754x372.png" alt="Successfully added a root CA to the iPhone" width="754" height="372" srcset="https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-754x372.png 754w, https://ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-300x148.png 300w, https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-600x296.png 600w, https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone.png 934w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-754x372.png" data-srcset="https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-754x372.png 754w, https://ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-300x148.png 300w, https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-600x296.png 600w, https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone.png 934w"></a><figcaption>Successfully added a root CA to the iPhone</figcaption></figure><p>This is incredibly exciting. Can we LoJack the Apple TV box next?</p><figure id="attachment_5746"><a href="https://static.ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV.jpg"><img src="https://ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-754x204.jpg" alt="Successfully installed a root CA on the Apple TV" width="754" height="204" srcset="https://ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-754x204.jpg 754w, https://static.ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-300x81.jpg 300w, https://ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-600x162.jpg 600w, https://static.ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV.jpg 1201w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-754x204.jpg" data-srcset="https://ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-754x204.jpg 754w, https://static.ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-300x81.jpg 300w, https://ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-600x162.jpg 600w, https://static.ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV.jpg 1201w"></a><figcaption>Successfully installed a root CA on the Apple TV</figcaption></figure><p>Excellent.</p><p>But wait, the router is slowing down. <code>mitmproxy</code> is burning up the CPU… on idle.</p><figure id="attachment_5741"><a href="https://ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle.png"><img src="https://static.ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-754x111.png" alt="MITMProxy is burning up the CPU while on idle" width="754" height="111" srcset="https://static.ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-754x111.png 754w, https://ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-300x44.png 300w, https://ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-600x88.png 600w, https://ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle.png 1309w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-754x111.png" data-srcset="https://static.ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-754x111.png 754w, https://ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-300x44.png 300w, https://ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-600x88.png 600w, https://ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle.png 1309w"></a><figcaption>MITMProxy is burning up the CPU while on idle</figcaption></figure><p>Of course: Python is a single-threaded paradigm with the GIL (Global Interpreter Lock) ensuring threads do not actually run concurrently – unless they are blocking on I/O, which is the case here(?). Except, most of the CPU work is to generate TLS certs on the fly for each request. Yikes. Running <code>mitmdump</code> forgoes the UI and extreme logging. The extreme logging of all the headers and full responses heavily slows down <code>mitmproxy</code>, but <code>mitmdump</code> by default only logs entries like classic Apache logs – much kinder on the CPU.</p><div><p><strong>Certificate Pinning</strong> Some advanced, high-security web servers have trouble with the MITMProxy certificates due to <a href="https://security.stackexchange.com/a/29990/114882" target="_blank" rel="nofollow">Certificate Pinning</a> – this is a technique where the server or the client know the fingerprint of the expected certificate in advance so it cannot be forged. A workaround is to use the <code>--ignore-hosts</code> option to let them bypass the proxy.</p></div><p>For my fun, I’ll go with this CLI command:</p><div id="crayon-63661eaabe4fb287054412" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># Try to avoid compression to save CPU usage</span></p><p><span># Ignore some difficult sites</span></p><p><span>mitmproxy</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>listen</span><span>-</span><span>port</span><span> </span><span>8080</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>listen</span><span>-</span><span>host</span><span> </span><span>127.0.1.1</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>anticomp</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>mode </span><span>regular</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>ignore</span><span>-</span><span>hosts</span><span> </span><span>'^(?:.+\.)?apple\.com:443$'</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>ignore</span><span>-</span><span>hosts</span><span> </span><span>'^(?:.+\.)?icloud\.com:443$'</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>set </span><span>console_focus_follow</span><span>=</span><span>true</span></p></div></td></tr></tbody></table></div><p>While on YouTube, we can see the page ads clear as day with their unencrypted headers; can a simple regex now block them? They are exposed, and afraid, and their days have run out.</p><figure id="attachment_5742"><a href="https://ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs.png"><img src="https://static.ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-754x368.png" alt="MITMProxy can see the YouTube ad URLs" width="754" height="368" srcset="https://static.ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-754x368.png 754w, https://ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-300x147.png 300w, https://static.ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-600x293.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-754x368.png" data-srcset="https://static.ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-754x368.png 754w, https://ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-300x147.png 300w, https://static.ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-600x293.png 600w"></a><figcaption>MITMProxy can see the YouTube ad URLs</figcaption></figure><p>We can even see details about each request. For example, all the SAN info is laid out for this wide-reaching certificate. There are curiously a lot of <code>*-cn.com</code> domains covered by this cert.</p><figure id="attachment_5744"><a href="https://ericdraken.com/files/We-can-see-rich-request-and-response-details.png"><img src="https://ericdraken.com/files/We-can-see-rich-request-and-response-details-754x282.png" alt="We can see rich request and response details" width="754" height="282" srcset="https://ericdraken.com/files/We-can-see-rich-request-and-response-details-754x282.png 754w, https://static.ericdraken.com/files/We-can-see-rich-request-and-response-details-300x112.png 300w, https://static.ericdraken.com/files/We-can-see-rich-request-and-response-details-600x224.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/We-can-see-rich-request-and-response-details-754x282.png" data-srcset="https://ericdraken.com/files/We-can-see-rich-request-and-response-details-754x282.png 754w, https://static.ericdraken.com/files/We-can-see-rich-request-and-response-details-300x112.png 300w, https://static.ericdraken.com/files/We-can-see-rich-request-and-response-details-600x224.png 600w"></a><figcaption>We can see rich request and response details</figcaption></figure><div id="crayon-63661eaabe4fe369532479" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># Try to avoid compression to save CPU usage</span></p><p><span># Use a script to block YouTube ads</span></p><p><span>mitmdump</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>listen</span><span>-</span><span>port</span><span> </span><span>8080</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>listen</span><span>-</span><span>host</span><span> </span><span>127.0.1.1</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>anticomp</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>mode </span><span>regular</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>ignore</span><span>-</span><span>hosts</span><span> </span><span>'^(.+\.)?apple\.com(:443)?$'</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>ignore</span><span>-</span><span>hosts</span><span> </span><span>'^(.+\.)?icloud\.com(:443)?$'</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>scripts</span><span> </span><span>"youtube.py"</span><span>&nbsp;&nbsp;</span><span># &lt;-- This is new</span></p></div></td></tr></tbody></table></div><p>Shortly, I’ll write a Python script to block YouTube <code>/pagead/</code> URLs.</p><p><a href="#top">Top ↩</a></p><hr><h2>Patch MITMProxy Source Code for Server SNI Interrogation</h2><p>This step may be optional for most, but as a reminder to myself, to make <code>--allowed-hosts</code> work better in Transparent Proxy Mode, the SNI of the server request needs to be checked against the list of regular expressions or else only the server’s IP is used for matching in many cases. Here is a quick patch I made that can be applied directly in the jail shell (or just type a few lines manually) for <code>mitmproxy</code> version 7.0.4:</p><div id="crayon-63661eaabe500315717351" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p></div></td><td><div><p>Index:<span> </span>venv/lib/python3.8/site-packages/mitmproxy/addons/next_layer.py</p><p>IDEA<span> </span>additional<span> </span>info:</p><p>Subsystem:<span> </span>com.intellij.openapi.diff.impl.patch.CharsetEP</p><p><span>&lt;+&gt;UTF-8</span></p><p>===================================================================</p><p>diff<span> </span>--git<span> </span>a/usr/local/lib/python3.8/site-packages/mitmproxy/addons/next_layer.py<span> </span>b/usr/local/lib/python3.8/site-packages/mitmproxy/addons/next_layer.py</p><p><span>--- a/usr/local/lib/python3.8/site-packages/mitmproxy/addons/next_layer.py&nbsp;&nbsp;(date 1641187083049)</span></p><p><span>+++ b/usr/local/lib/python3.8/site-packages/mitmproxy/addons/next_layer.py&nbsp;&nbsp;(date 1641187083049)</span></p><p><span>@@ -59,7 +59,7 @@</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; re.compile(x, re.IGNORECASE) for x in ctx.options.allow_hosts</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ]</span></p><p><span>-&nbsp;&nbsp;&nbsp;&nbsp;def ignore_connection(self, server_address: Optional[connection.Address], data_client: bytes) -&gt; Optional[bool]:</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;def ignore_connection(self, server: Optional[connection.Server], data_client: bytes) -&gt; Optional[bool]:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; """</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Returns:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; True, if the connection should be ignored.</span></p><p><span>@@ -70,8 +70,11 @@</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hostnames: List[str] = []</span></p><p><span>-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if server_address is not None:</span></p><p><span>-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hostnames.append(server_address[0])</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if server is not None:</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if server.address is not None:</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hostnames.append(server.address[0])</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if server.sni is not None:</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hostnames.append(server.sni)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if is_tls_record_magic(data_client):</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ch = parse_client_hello(data_client)</span></p><p><span>@@ -122,7 +125,7 @@</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return stack_match(context, layers)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # 1. check for --ignore/--allow</span></p><p><span>-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore = self.ignore_connection(context.server.address, data_client)</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore = self.ignore_connection(context.server, data_client)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ignore is True:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return layers.TCPLayer(context, ignore=True)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ignore is None:</span></p></div></td></tr></tbody></table></div><p>With the above patch, I can now reliably intercept a few hosts and let all others pass through.</p><figure id="attachment_5835"><a href="https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode.png"><img src="https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-754x476.png" alt="Reliable server host interception in MITMProxy transparent proxy mode" width="754" height="476" srcset="https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-754x476.png 754w, https://ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-300x189.png 300w, https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-600x379.png 600w, https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode.png 906w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-754x476.png" data-srcset="https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-754x476.png 754w, https://ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-300x189.png 300w, https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-600x379.png 600w, https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode.png 906w"></a><figcaption>Reliable server host interception in MITMProxy transparent proxy mode</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Smoke Test: Intercept YouTube Ads with MITMProxy</h2><p>After reading the docs and navigating the <code>mitmproxy</code> source code in the PyCharm IDE, I’ve written a little script to block ads and tracking URLs coming from YouTube from my clean notebook. I won’t reproduce the code just yet because it didn’t succeed in blocking ads as hoped, so instead, I’ll spend the time investigating why.</p><p>Here are the smoke test filters I used where for a given top-level domain, URLs with the following partial strings are blocked:</p><div id="crayon-63661eaabe504280523207" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>blocked_partials</span><span>:</span><span> </span><span>dict</span><span> </span><span>=</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"youtube.com"</span><span>:</span><span> </span><span>[</span><span>"/pagead/"</span><span>,</span><span> </span><span>"/log_event?"</span><span>,</span><span> </span><span>"/stats/ads"</span><span>,</span><span> </span><span>"/stats/qoe?"</span><span>,</span><span> </span><span>"/ptracking?"</span><span>,</span><span> </span><span>"/generate_204"</span><span>,</span><span> </span><span>"el=adunit"</span><span>,</span><span> </span><span>"adformat="</span><span>,</span><span> </span><span>"/activeview?"</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"google.com"</span><span>:</span><span> </span><span>[</span><span>"/pagead/"</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"google.ca"</span><span>:</span><span> </span><span>[</span><span>"/pagead/"</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"ggpht.com"</span><span>:</span><span> </span><span>[</span><span>"."</span><span>]</span><span>,</span></p><p><span>}</span></p></div></td></tr></tbody></table></div><p>My initial results on blocking are positive. Everything I wanted to be blocked is faithfully blocked. Note, the <code>(failed)</code> entries are due to my script, and the <code>502</code> failures are due to pfBlockerNG black-holing the request.</p><figure id="attachment_5748"><a href="https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working.png"><img src="https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-754x350.png" alt="MITMProxy blocking script is working" width="754" height="350" srcset="https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-754x350.png 754w, https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-300x139.png 300w, https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-600x278.png 600w, https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working.png 1565w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-754x350.png" data-srcset="https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-754x350.png 754w, https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-300x139.png 300w, https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-600x278.png 600w, https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working.png 1565w"></a><figcaption>MITMProxy blocking script is working</figcaption></figure><p>Even in the DevTools network panel, the requests are truly blocked.</p><figure id="attachment_5749"><a href="https://ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel.png"><img src="https://static.ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-754x369.png" alt="YouTube requests are truly blocked in DevTools network panel" width="754" height="369" srcset="https://static.ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-754x369.png 754w, https://ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-300x147.png 300w, https://ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-600x293.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-754x369.png" data-srcset="https://static.ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-754x369.png 754w, https://ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-300x147.png 300w, https://ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-600x293.png 600w"></a><figcaption>YouTube requests are truly blocked in DevTools network panel</figcaption></figure><p>Then how come I am still seeing ads? I’ve disabled HTTP/2 so that subsequent requests on the same channel don’t slide by. Mind you, sometimes the ads skip on their own, or fail to play, but they still show up. Interesting. Could YouTube be using WebSockets? I need some inspiration, so I’ll look at uBlock Origin’s regex filters for some ideas.</p><div><p><strong>Tip:</strong> If you see the error <span>OpenSSL Error([(‘SSL routines’, ‘ssl3_read_bytes’, ‘tlsv1 alert internal error’)])</span>, then the DNS blocker (i.e. pfBlockerNG) is breaking the upstream TLS handshake for a given domain. Either whitelist it in pfBlockerNG (so the request goes through), or intercept it and block the connection in <code>mitmproxy</code>. This error happens to black-holed domains when the upstream TLS cert cannot be sniffed. The cleanest strategy is to use <strong>transparent MITM mode</strong>.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Examine uBlock Origin Regex Patterns for Inspiration</h2><p>Here are some of the regex/filters that uBlock Origin uses on YouTube.</p><figure id="attachment_5753"><a href="https://static.ericdraken.com/files/filters-from-a-web-browser.png"><img src="https://static.ericdraken.com/files/filters-from-a-web-browser.png" alt="uBlock Origin YouTube regex/filters from a web browser" width="746" height="322" srcset="https://static.ericdraken.com/files/filters-from-a-web-browser.png 746w, https://static.ericdraken.com/files/filters-from-a-web-browser-300x129.png 300w, https://ericdraken.com/files/filters-from-a-web-browser-600x259.png 600w" sizes="(max-width: 746px) 100vw, 746px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/filters-from-a-web-browser.png" data-srcset="https://static.ericdraken.com/files/filters-from-a-web-browser.png 746w, https://static.ericdraken.com/files/filters-from-a-web-browser-300x129.png 300w, https://ericdraken.com/files/filters-from-a-web-browser-600x259.png 600w"></a><figcaption>uBlock Origin YouTube regex/filters from a web browser</figcaption></figure><p>At first blush, it seems that a community of like-minded individuals is playing whack-a-mole with YouTube’s HTML and JavaScript. This has got me thinking: How does a video know to play an ad with JavaScript?</p><p>How does YouTube know if the ad converts? They must target ads for individuals, so a given video must receive some unique information about an ad, such as the click link and alt text. WebSockets would be a pain to maintain, especially with all the mobile clients. They must be using stateless JSON to relay that pertinent information in an innocuous URL request that has no telltale signs of ad-ness. Let’s hunt for this info in the JSON replies captured by <code>mitmproxy</code>.</p><figure id="attachment_5755"><a href="https://static.ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response.png"><img src="https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-754x362.png" alt="Key advertizement information contained in a JSON response" width="754" height="362" srcset="https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-754x362.png 754w, https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-300x144.png 300w, https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-600x288.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-754x362.png" data-srcset="https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-754x362.png 754w, https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-300x144.png 300w, https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-600x288.png 600w"></a><figcaption>Key advertizement information contained in a JSON response</figcaption></figure><p>Snap, Crackle, and Pop. We have a new plan: surgically alter the JSON response body to eliminate or Byzantine-up the ad information.</p><p><a href="#top">Top ↩</a></p><hr><h2>Surgically Alter the JSON Response to Remove Ads</h2><p>After a bit more playful exploration, a trove of blocklorne URLs is right there in the JSON payload. In fact, most of what I am trying to block shows up right here:</p><div id="crayon-63661eaabe509451695984" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p></div></td><td><div><p><span> </span><span>.</span><span>.</span><span>.</span></p><p><span> </span><span>"playerAds"</span><span>:</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"playerLegacyDesktopWatchAdsRenderer"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"playerAdParams"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"showContentThumbnail"</span><span>:</span><span> </span><span>true</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"enabledEngageTypes"</span><span>:</span><span> </span><span>"3,6,4,5,17,1"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"gutParams"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"tag"</span><span>:</span><span> </span><span>"\\4061\\ytpwmpu"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"showCompanion"</span><span>:</span><span> </span><span>true</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"showInstream"</span><span>:</span><span> </span><span>true</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"useGut"</span><span>:</span><span> </span><span>true</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;</span><span>"playbackTracking"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"videostatsPlaybackUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://s.youtube.com/api/stats/playback?cl=417308503&amp;docid=IgF3..."</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"videostatsDelayplayUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://s.youtube.com/api/stats/delayplay?cl=417308503&amp;docid=IgF..."</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"videostatsWatchtimeUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://s.youtube.com/api/stats/watchtime?cl=417308503&amp;docid=IgF..."</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"ptrackingUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://www.youtube.com/ptracking?ei=KnzDYZv1B86ikwa0no7AAg&amp;oid=MjD-gn49GocgAFypi8EDnQ&amp;plid=AAXTwR1aNKG2iTgr&amp;pltype=content&amp;ptchn=HnyfMqiRRG1u-2MsSQLbXA&amp;ptk=youtube_single&amp;video_id=IgF3OX8nT0w"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"qoeUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://s.youtube.com/api/stats/qoe?cl=417308503&amp;docid=IgF3OX8nT..."</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"atrUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://s.youtube.com/api/stats/atr?docid=IgF3OX8nT0w&amp;ei=KnzDYZv1B86ikwa0no7AAg&amp;feature=g-high-trv&amp;len=1213&amp;ns=yt&amp;plid=AAXTwR1aNKG2iTgr&amp;ver=2"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"elapsedMediaTimeSeconds"</span><span>:</span><span> </span><span>5</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"videostatsScheduledFlushWalltimeSeconds"</span><span>:</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>10</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>20</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>30</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"videostatsDefaultFlushIntervalSeconds"</span><span>:</span><span> </span><span>40</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"youtubeRemarketingUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://www.youtube.com/pagead/viewthroughconversion/962985656/?backend=innertube&amp;cname=1&amp;cver=2_20211221&amp;data=backend%3Dinnertube%3Bcname%3D1%3Bcver%3D2_20211221%3Bptype%3Df_view%3Btype%3Dview%3Butuid%3DHnyfMqiRRG1u-2MsSQLbXA%3Butvid%3DIgF3OX8nT0w&amp;foc_id=HnyfMqiRRG1u-2MsSQLbXA&amp;label=followon_view&amp;ptype=f_view&amp;random=37068419&amp;utuid=HnyfMqiRRG1u-2MsSQLbXA"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"elapsedMediaTimeSeconds"</span><span>:</span><span> </span><span>0</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"googleRemarketingUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://www.google.com/pagead/1p-user-list/962985656/?backend=innertube&amp;cname=1&amp;cver=2_20211221&amp;data=backend%3Dinnertube%3Bcname%3D1%3Bcver%3D2_20211221%3Bptype%3Df_view%3Btype%3Dview%3Butuid%3DHnyfMqiRRG1u-2MsSQLbXA%3Butvid%3DIgF3OX8nT0w&amp;is_vtc=0&amp;ptype=f_view&amp;random=838827488&amp;utuid=HnyfMqiRRG1u-2MsSQLbXA"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"elapsedMediaTimeSeconds"</span><span>:</span><span> </span><span>0</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;</span><span>}</span><span>,</span></p></div></td></tr></tbody></table></div><p>However, YouTube has bobby-trapped their UI and there is more than one way their obfuscated JavaScript code can pull down the ad details.</p><p><strong>Let’s blow it all away right now.</strong></p><p>After a lot of fun taking apart the YouTube UI and HTTP workflow, taking into account cookies and naughty service workers, I am successfully able to strip away all the pre-roll, post-roll, mid-video, and, well, all the video ads. Here is a screenshot from <code>mitmdump</code> showing how select REST queries are intercepted, decrypted, modified, put back into the response, and the headers updated (content length, etc.).</p><figure id="attachment_5758"><a href="https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses.png"><img src="https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-754x221.png" alt="Success in removing YouTube ads via decrypted JSON responses" width="754" height="221" srcset="https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-754x221.png 754w, https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-300x88.png 300w, https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-600x176.png 600w, https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses.png 1175w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-754x221.png" data-srcset="https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-754x221.png 754w, https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-300x88.png 300w, https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-600x176.png 600w, https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses.png 1175w"></a><figcaption>Success in removing YouTube ads via decrypted JSON responses</figcaption></figure><p>With this new ability, we could even inject JavaScript into the main YouTube web page and subvert their JavaScript in a sort of ECMAScript arms race, possibly even leveraging some of the filters from uBlock Origin. However, we can hang our hats on this accomplishment for today.</p><div><p><strong>Success:</strong> We can strip out ads from the JSON payload for YouTube web ads using a router.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>The iOS YouTube App Uses Protobuf, not JSON</h2><p>I can see very similar data in the Protocol Buffer (Protobuf) version of the same API calls as the web version to that of the YouTube iOS app. That complicates things, somewhat: We cannot lean on JSONPath to hunt down advertisement sections of JSON because with Protobuf the keys are just numbers that can even change.</p><figure id="attachment_5761"><a href="https://ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf.png"><img src="https://static.ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-754x255.png" alt="The iOS version of the YouTube app uses Protobuf" width="754" height="255" srcset="https://static.ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-754x255.png 754w, https://static.ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-300x102.png 300w, https://ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-600x203.png 600w, https://ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf.png 1279w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-754x255.png" data-srcset="https://static.ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-754x255.png 754w, https://static.ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-300x102.png 300w, https://ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-600x203.png 600w, https://ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf.png 1279w"></a><figcaption>The iOS version of the YouTube app uses Protobuf</figcaption></figure><div><p><strong>Fun fact:</strong> YouTube compiles a large list of all the ads you are going to see and sends that to you in a sneaky payload. In fact, it is easier to visualize this when reading Protobuf. If you manage to exhaust that list, then another large list will be coming your way.</p></div><p>I can see strings like “Telus” and “Samsung TV” and “Boxing Week” and “Buy now”. Remember when YouTube was a fun place? A fable about a Golden Goose comes to mind, Alphabet.</p><p>What is a Protocol Buffer? Here is an infographic from <a href="https://www.datascienceblog.net/post/programming/essential-protobuf-guide-python/" target="_blank" rel="nofollow">Data Science Blog</a>.</p><figure id="attachment_5764"><a href="https://static.ericdraken.com/files/Protobuf-introduction.png"><img src="https://static.ericdraken.com/files/Protobuf-introduction-754x424.png" alt="Protobuf introduction" width="754" height="424" srcset="https://static.ericdraken.com/files/Protobuf-introduction-754x424.png 754w, https://static.ericdraken.com/files/Protobuf-introduction-300x169.png 300w, https://static.ericdraken.com/files/Protobuf-introduction-600x338.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Protobuf-introduction-754x424.png" data-srcset="https://static.ericdraken.com/files/Protobuf-introduction-754x424.png 754w, https://static.ericdraken.com/files/Protobuf-introduction-300x169.png 300w, https://static.ericdraken.com/files/Protobuf-introduction-600x338.png 600w"></a><figcaption>Protobuf introduction (Credit: <a href="https://www.datascienceblog.net/post/programming/essential-protobuf-guide-python/" target="_blank" rel="nofollow">Data Science Blog</a>)</figcaption></figure><p>As a consequence of being able to see unencrypted traffic from my iPhone, I’m taken aback by the sheer amount of tracking information laid bare; It’s like I have electrodes on my head and chest while I’m running on a treadmill and a bunch of scientists in white lab coats with clipboards are standing shoulder-to-shoulder recording everything about my internals.</p><div><p><strong>Privacy concern:</strong> Your apps are tracking you like crazy: what you do, how long you dwell, when you leave a given app, and so much more. The URL <code>https://play.googleapis.com/log/batch</code> shows up a lot in my logs.</p></div><p>The next question is: Does the iOS app protocol behave like the web app?</p><p><a href="#top">Top ↩</a></p><hr><h2>Timing Analysis to Detect Ad Videos?</h2><p>The iOS network traffic is not like the web traffic; Google has teams and teams of engineers dedicated to making sure blocking their ads isn’t computationally feasible. Daunted but undeterred, I was staring at network requests to let my mind zone out and wander when I noticed a pattern I had not noticed before.</p><p>For the <em>web</em> version of YouTube, I can eyeball which URLs are ads and which are the videos I want to watch. Take a look:</p><figure id="attachment_5806"><a href="https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos.png"><img src="https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-754x552.png" alt="Which are ad videos and which are content videos?" width="754" height="552" srcset="https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-754x552.png 754w, https://static.ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-300x220.png 300w, https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-600x439.png 600w, https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos.png 1122w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-754x552.png" data-srcset="https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-754x552.png 754w, https://static.ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-300x220.png 300w, https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-600x439.png 600w, https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos.png 1122w"></a><figcaption>Which are ad videos and which are content videos?</figcaption></figure><p>How am I able to eyeball which video URLs are ads in this chaos?</p><figure id="attachment_5807"><a href="https://static.ericdraken.com/files/Two-ad-videos-between-content-videos.png"><img src="https://static.ericdraken.com/files/Two-ad-videos-between-content-videos-754x552.png" alt="Two ad videos between content videos" width="754" height="552" srcset="https://static.ericdraken.com/files/Two-ad-videos-between-content-videos-754x552.png 754w, https://static.ericdraken.com/files/Two-ad-videos-between-content-videos-300x220.png 300w, https://ericdraken.com/files/Two-ad-videos-between-content-videos-600x439.png 600w, https://static.ericdraken.com/files/Two-ad-videos-between-content-videos.png 1122w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Two-ad-videos-between-content-videos-754x552.png" data-srcset="https://static.ericdraken.com/files/Two-ad-videos-between-content-videos-754x552.png 754w, https://static.ericdraken.com/files/Two-ad-videos-between-content-videos-300x220.png 300w, https://ericdraken.com/files/Two-ad-videos-between-content-videos-600x439.png 600w, https://static.ericdraken.com/files/Two-ad-videos-between-content-videos.png 1122w"></a><figcaption>Two ad videos between content videos</figcaption></figure><p>Take a look at the query parameter <code>range</code>. For the web version, a chunk of the video I want is fetched from the 0th byte, then immediately another video is fetched with a <code>range</code> starting again at the 0th byte. Both happen near-simultaneously – faster than a human can click on a new video. It turns out this, as well as examining the <code>clen</code> parameter for the length of the full video (short videos are likely ads), can reasonably allow us to detect and doctor ad videos.</p><p>However, the iOS YouTube protocol does <strong>not</strong> use the <code>range</code> query parameter or even the <code>Range</code> header; video chunks use a counter like <code>&amp;nr=2</code> and <code>&amp;nr=3</code> etc. We must reverse engineer the Protobuf responses.</p><p><a href="#top">Top ↩</a></p><hr><h2>Decode the YouTube Protobuf Responses</h2><p>Here are some decoded Protobuf log files I created then opened in the PyCharm IDE.</p><figure id="attachment_5767"><a href="https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE.png"><img src="https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-754x161.png" alt="Let's examine some Protobuf logs in the IDE" width="754" height="161" srcset="https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-754x161.png 754w, https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-300x64.png 300w, https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-600x128.png 600w, https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE.png 1123w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-754x161.png" data-srcset="https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-754x161.png 754w, https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-300x64.png 300w, https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-600x128.png 600w, https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE.png 1123w"></a><figcaption>Let’s examine some Protobuf logs in the IDE</figcaption></figure><p>After logging decoded Protobuf messages to disk for offline analysis, I did notice something that piqued my interest.</p><div id="crayon-63661eaabe511016360233" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>2</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>1</span><span>:</span><span> </span><span>has_unlimited</span><span>_</span>entitlement</p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>2</span><span>:</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>2</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>1</span><span>:</span><span> </span><span>has_premium_lite</span><span>_</span>entitlement</p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>2</span><span>:</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p></div></td></tr></tbody></table></div><p>I wonder what would happen if I were to, say, toggle those? This is tantalizing, but it is cheating, and hence no fun. Back to heuristics.</p><div><p><strong>Thought Experiment:</strong> As with JSON, can I blow away the Protobuf sections that serve up ads? Could I instead detect the ad videos in the payload, then dynamically modify their responses to be, say, a cached 0.01s video file? The 30s ~ 300s of unskippable ads could be over in the blink of an eye without blocking all those URLs.</p></div><figure id="attachment_5768"><a href="https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload.png"><img src="https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-754x428.png" alt="Intercepted ad URLs from the Protobuf payload" width="754" height="428" srcset="https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-754x428.png 754w, https://ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-300x170.png 300w, https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-600x341.png 600w, https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload.png 962w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-754x428.png" data-srcset="https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-754x428.png 754w, https://ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-300x170.png 300w, https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-600x341.png 600w, https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload.png 962w"></a><figcaption>Intercepted ad URLs from the Protobuf payload</figcaption></figure><p>Let’s start by blocking the ads as intended.</p><p><a href="#top">Top ↩</a></p><hr><h2>Ad URL Polymorphism</h2><p>The Protobuf responses are a hot mess of bytes, but there are human-readable URLs that can be grepped.</p><p>You’d think a simple LRU cache that blocks soon-encountered ad URLs could be the way to go, but, alas, the ad URLs do not quite match the URLs sent over the wire. Also, who is to say that YouTube won’t randomize the position of query-string parameters one day? We need an <code>O(1)</code> lookup of flagged ad URLs that are polymorphic (and group homomorphic) to live ad URLs.</p><figure id="attachment_5775"><a href="https://static.ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs.png"><img src="https://static.ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs.png" alt="Detected ad URLs vs intercepted ad URLs" width="748" height="169" srcset="https://static.ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs.png 748w, https://ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs-300x68.png 300w, https://ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs-600x136.png 600w" sizes="(max-width: 748px) 100vw, 748px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs.png" data-srcset="https://static.ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs.png 748w, https://ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs-300x68.png 300w, https://ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs-600x136.png 600w"></a><figcaption>Detected ad URLs vs intercepted ad URLs</figcaption></figure><p>It might be tempting to split a query string into a sorted dictionary and reassemble it, but we have no way of knowing what the query string boundary is. Plus, a live ad URL could add a key and disrupt the sorting.</p><p>Addionally, I’ve encountered URLs like this that purposely try to obfuscate the query params:</p><blockquote><p>https://r4—sn-vgqsrns6.googlevideo.com/videoplayback<br>/expire/1640607416<br>/ei/WFrJYdWnFfyTsfIP4s2BsAk<br><span>/ip/121.35.98.26</span><br>/id/o-AE7swWOPOwXu3GyRght<br>/source/youtube<br>/requiressl/yes<br>/mh/wU/<br>mm/31,26/…</p></blockquote><p>Notice how <code>/ip/121.35.98.26/</code> is just <code>&amp;ip=121.35.98.26</code>?</p><p>I propose heuristically scanning for query and path parameters of ad URLs with high entropy and using those as keys (fingerprints). For example, in</p><blockquote><p>https://<span>rr6—sn-uxa0n-t8gz</span>.googlevideo.com/initplayback?source=youtube<br>&amp;orc=1&amp;oeis=1&amp;c=IOS&amp;oss=1&amp;oda=1&amp;oad=5500&amp;ovd=5500&amp;oaad=11000&amp;oavd=11000<br>&amp;ocs=700&amp;oputc=1&amp;oses=1&amp;ofpcc=1&amp;osbr=1&amp;osnz=1&amp;msp=1&amp;odeak=1&amp;odepv=1<br>&amp;osfc=1&amp;id=<span>58cc678216d6aaca</span>&amp;ip=<span>121.35.98.26</span>&amp;initcwndbps=<span>2125000</span><br>&amp;mt=<span>1640373902</span></p></blockquote><p>One could note the following candidates in descending order of length:</p><ul><li>rr6—sn-uxa0n-t8gz</li><li>58cc678216d6aaca</li><li>121.35.98.26</li><li>1640373902</li><li>2125000</li></ul><p>Any or all of them could be lookup keys each pointing to the same dictionary of deconstructed query parameters. A lookup of a live URL would involve the same process of finding the highest entropy parameters and checking the URL dictionary for a match. The cache data structure can even be multi-level with the root keys being just the length of the high-entropy strings.</p><div><p><strong>Failure:</strong> Even with the ability to block polymorphic URLs, the video ads are still indistinguishable from content video without context from the Protobuf structure.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Smoke Test: Intercept and Decode Protobuf in Python</h2><div><p><strong>Python is Slow:</strong> Decoding ~500 kiB of raw Protobuf in pure Python is painfully slow.</p></div><p>Decoding ~500 kiB of Protobuf in pure Python, especially the decoding step of converting it to over 1 MiB of human-readable text to parse the ad URLs, takes more time than the connection timeout most of the time. I’ll run some benchmarks using pure Python vs. the native C++ library.</p><h3>Pure Python Benchmarks</h3><div id="crayon-63661eaabe517325973514" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>from</span><span> </span><span>timeit</span><span> </span><span>import</span><span> </span><span>repeat</span></p><p><span>from</span><span> </span><span>mitmproxy</span><span>.</span><span>contentviews</span><span>.</span><span>protobuf </span><span>import</span><span> </span><span>format_pbuf</span></p><p><span>with</span><span> </span><span>open</span><span>(</span><span>"proto.raw"</span><span>,</span><span> </span><span>"rb"</span><span>)</span><span> </span><span>as</span><span> </span><span>f</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>data</span><span>:</span><span> </span><span>bytes</span><span> </span><span>=</span><span> </span><span>f</span><span>.</span><span>read</span><span>(</span><span>)</span></p><p><span>print</span><span>(</span><span>repeat</span><span>(</span><span>lambda</span><span>:</span><span> </span><span>format_pbuf</span><span>(</span><span>data</span><span>)</span><span>,</span><span> </span><span>number</span><span>=</span><span>5</span><span>)</span><span>)</span></p><p><span># On a i7-6700 CPU @ 3.40GHz desktop</span></p><p><span># [2.10792827908881, 2.0718665630556643, 2.0739889848046005, 2.065321908099577, 2.070936748990789]</span></p><p><span># On the pfSense router:</span></p><p><span># [24.182968072011136, 22.833560551982373, 23.53838806191925, 22.842924927012064, 22.81738876597956]</span></p></div></td></tr></tbody></table></div><h3>Pure C++ Benchmarks</h3><div id="crayon-63661eaabe519209175894" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># On a i7-6700 CPU @ 3.40GHz desktop</span></p><p><span>TIMEFORMAT</span><span>=</span><span>%</span><span>R</span></p><p><span>for</span><span> </span><span>i</span><span> </span><span>in</span><span> </span><span>{</span><span>1..5</span><span>}</span><span>;</span><span> </span><span>do</span><span> </span><span>time</span><span> </span><span>protoc</span><span> </span><span>--</span><span>decode_raw</span><span> </span><span>&lt;</span><span> </span><span>proto</span><span>.raw</span><span> </span><span>&gt;</span><span> </span><span>/</span><span>dev</span><span>/</span><span>null</span><span>;</span><span> </span><span>done</span></p><p><span># 0.018</span></p><p><span># 0.017</span></p><p><span># 0.022</span></p><p><span># 0.018</span></p><p><span># 0.018</span></p><p><span># On the pfSense router:</span></p><p><span>printf</span><span> </span><span>'foreach f ( 1 2 3 4 5 )\n time protoc --decode_raw &lt; proto.raw &gt; /dev/null \n end \n'</span><span> </span><span>|</span><span> </span><span>tcsh</span></p><p><span># 0.030u 0.114s 0:00.14 100.0%&nbsp;&nbsp;30+153k 2+0io 0pf+0w</span></p><p><span># 0.024u 0.104s 0:00.12 100.0%&nbsp;&nbsp;8+132k 2+0io 0pf+0w</span></p><p><span># 0.022u 0.106s 0:00.12 100.0%&nbsp;&nbsp;34+156k 2+0io 0pf+0w</span></p><p><span># 0.016u 0.114s 0:00.13 92.3%&nbsp;&nbsp; 8+143k 2+0io 0pf+0w</span></p><p><span># 0.023u 0.102s 0:00.12 100.0%&nbsp;&nbsp;8+132k 2+0io 0pf+0w</span></p></div></td></tr></tbody></table></div><p>If you caught that, it takes about <strong>23s</strong> in Python, and <strong>100ms</strong> in C++! In this Never Ending Story, we have to find a way to parse the raw Protobuf payloads in Python using the C++ library <code>libprotobuf.so</code>. In the interest of time, I’ll use <code>subprocess.Popen</code> and communicate with the C++ <code>protoc</code> binary directly (since raw decoding is not supported in Python anyway).</p><p><a href="#top">Top ↩</a></p><hr><h2>Fuzzing the YouTube Video Ad Responses</h2><p>How about fuzzing the ad video responses? Now being able to isolate ad videos, as a smoke test, I sent back <code>200</code> responses with empty bodies and the iOS app went bananas; it was as if there is an infinite loop with no delay just hammering YouTube’s own servers trying to get the next part of the video in panic mode. I felt bad for their servers, so I stopped. Then, what would a happy-path response payload look like?</p><figure id="attachment_5783"><a href="https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video.png"><img src="https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-754x345.png" alt="Infinite spin-lock loop of YouTube trying to get the next bytes of the ad video" width="754" height="345" srcset="https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-754x345.png 754w, https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-300x137.png 300w, https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-600x274.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-754x345.png" data-srcset="https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-754x345.png 754w, https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-300x137.png 300w, https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-600x274.png 600w"></a><figcaption>Infinite spin-lock loop of YouTube trying to get the next bytes of the ad video</figcaption></figure><p>Try as I might, when I send back empty <code>200</code>s, <code>404</code>s, <code>503</code>s, truncate response bodies, or just null-out part of the ad video, the iOS app crawls then crashes spectacularly with a dying breath of a messed up iOS UI. I now block some error reporting endpoint at <code>/error_204/</code> that indicates a “dev assertion failed” so I don’t make some overworked QA pull out their hair.</p><div><p><strong>Failure:</strong> We’ve learned that blocking ad URLs causes the app to deploy countermeasures and even when defeated, the app hangs forever on the ad screen. We’ve also learned that fuzzing ad videos often causes the app to crash – there is even session meta data in the video response chunks.</p></div><p>Let’s go back to what worked with JSON and obliterate the section of the Protobuf responses that contain the array of ad details.</p><p><a href="#top">Top ↩</a></p><hr><h2>Enter Burp Suite Tools for Penetration Testing</h2><p>There is a library for <a href="https://portswigger.net/burp" target="_blank" rel="nofollow">Burp Suite</a> called <code>blackboxprotobuf</code> (get the <a href="https://github.com/nccgroup/blackboxprotobuf/tree/master/lib" target="_blank" rel="nofollow">original Burp Suite version</a>, <strong>not</strong> the PyPi fork, unless you like infinite recursion bugs) that is designed to decode raw Protobuf wire messages, inject something naughty, then re-encode them again to see how a Protobuf endpoint behaves. We are going to have so much fun together in this next section.</p><div id="crayon-63661eaabe51d734281067" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># Install blackboxprotobuf from source</span></p><p><span>mkdir</span><span> </span><span>blackboxprotobuf_src</span><span> </span><span>&amp;&amp;</span><span> </span><span>cd</span><span> </span><span>blackboxprotobuf_src</span></p><p><span>git </span><span>clone</span><span> </span><span>https</span><span>:</span><span>/</span><span>/</span><span>github</span><span>.com</span><span>/</span><span>nccgroup</span><span>/</span><span>blackboxprotobuf</span><span>.git</span><span> </span><span>.</span></p><p><span>pip3 </span><span>install </span><span>poetry</span></p><p><span>cd</span><span> </span><span>lib</span></p><p><span>poetry </span><span>install</span></p><p><span># pwd -&gt; blackboxprotobuf_src/lib/</span></p><p><span>cp</span><span> </span><span>-</span><span>r</span><span> </span><span>blackboxprotobuf </span><span>your</span><span>/</span><span>project</span><span>/</span><span>folder</span></p><p><span># We only need this folder tree for the Py3 API</span></p></div></td></tr></tbody></table></div><p>You may encounter a small world of pain because some forks of blackboxprotobuf will cause a stack overflow due to deep recursion. You can see this by adding <code>sys.setrecursionlimit(200)</code>.</p><p>Compiling the original library source code for Burp Suite and using the C++ bindings will allow us to transcode ~500 kiB of raw Protobuf bytes in just a few seconds.</p><div><p><strong>Tip:</strong> At the top of your import chain before you import <code>protobuf</code>, add</p><div id="crayon-63661eaabe51f564481961" data-nosnippet="data-nosnippet" data-settings=" no-popup minimize scroll-mouseover"><table><tbody><tr><td data-settings="hide"></td><td><div><p><span>import</span><span> </span><span>os</span></p><p><span>os</span><span>.</span><span>environ</span><span>[</span><span>"PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION"</span><span>]</span><span> </span><span>=</span><span> </span><span>"cpp"</span></p></div></td></tr></tbody></table></div><p>to use the C++ <code>libprotobuf.so</code> implementation whenever possible.<br></p></div><p>It is now possible to generate a best-guess <code>.proto</code> schema with a single function:</p><div id="crayon-63661eaabe521008674169" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>import</span><span> </span><span>os</span></p><p><span>os</span><span>.</span><span>environ</span><span>[</span><span>"PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION"</span><span>]</span><span> </span><span>=</span><span> </span><span>"cpp"</span></p><p><span>from</span><span> </span><span>mitmdump</span><span>.</span><span>blackboxprotobuf</span><span>.</span><span>lib </span><span>import</span><span> </span><span>protobuf_to_json</span></p><p><span>data</span><span>:</span><span> </span><span>bytes</span><span> </span><span>=</span><span> </span><span>.</span><span>.</span><span>.</span></p><p><span>message</span><span>,</span><span> </span><span>typedef</span><span> </span><span>=</span><span> </span><span>protobuf_to_json</span><span>(</span><span>data</span><span>)</span></p><p><span># print(message)</span></p><p><span>print</span><span>(</span><span>typedef</span><span>)</span></p></div></td></tr></tbody></table></div><p>The schema isn’t perfect, and it is huge and deeply nested, and takes forever to pretty-print, and is probably wrong, but is just good enough to pull out the ad details like so (Protobuf to JSON in this sample):</p><figure id="attachment_5798"><a href="https://static.ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads.png"><img src="https://ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-754x300.png" alt="Sample Protobuf to JSON showing a section of ads" width="754" height="300" srcset="https://ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-754x300.png 754w, https://static.ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-300x119.png 300w, https://static.ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-600x238.png 600w, https://static.ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads.png 755w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-754x300.png" data-srcset="https://ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-754x300.png 754w, https://static.ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-300x119.png 300w, https://static.ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-600x238.png 600w, https://static.ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads.png 755w"></a><figcaption>Sample Protobuf to JSON showing a section of ads</figcaption></figure><p>The Python schema is huge and looks like this for about 250,000 more charcters:</p><div id="crayon-63661eaabe524527915615" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>OrderedDict</span><span>(</span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>'1'</span><span>,</span><span> </span><span>OrderedDict</span><span>(</span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>'type'</span><span>,</span><span> </span><span>'message'</span><span>)</span><span>,</span><span> </span><span>(</span><span>'message_typedef'</span><span>,</span><span> </span><span>OrderedDict</span><span>(</span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>'6'</span><span>,</span><span> </span><span>OrderedDict</span><span>(</span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>'type'</span><span>,</span><span> </span><span>'message'</span><span>)</span><span>,</span><span> </span><span>(</span><span>'message_typedef'</span><span>,</span><span> </span><span>OrderedDict</span><span>(</span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>'1'</span><span>,</span><span> </span><span>OrderedDict</span><span>(</span><span>[</span><span>.</span><span>.</span><span>.</span></p></div></td></tr></tbody></table></div><p>Reverse engineering the Protobuf schema sounds good on paper, but our target is spectacularly complex and a moving target.</p><p><a href="#top">Top ↩</a></p><hr><h2>Exfil the Proto Schemas from the App, Cleanly?</h2><p>As fun as it to reverse the Protobuf and generate a best-guess schema, wouldn’t it be more ninja-like to exfil the actual, working <code>.proto</code> or schema files from the smartphone app? Let’s pull out the Protobuf schemas from the Android version of the YouTube app and see if the schemas are the same or compatible.</p><p>This is what I tried <em>at first</em>, but it went nowhere with the <a href="https://github.com/marin-m/pbtk" target="_blank" rel="nofollow">Protobuf Toolkit</a> (PBTK). I reproduce it here so I remember what I tried:</p><div id="crayon-63661eaabe527948865294" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>sudo </span><span>apt </span><span>update</span></p><p><span>sudo </span><span>apt </span><span>install </span><span>libqt5x11extras5 </span><span>python3</span><span>-</span><span>pyqt5</span><span>.qtwebengine</span><span> </span><span>python3</span><span>-</span><span>pyqt5</span></p><p><span>pip3 </span><span>install </span><span>pyqt5 </span><span>pyqtwebengine </span><span>requests </span><span>websocket</span><span>-</span><span>client</span></p><p><span>mkdir</span><span> </span><span>pbtk</span><span> </span><span>&amp;&amp;</span><span> </span><span>cd</span><span> </span><span>pbtk</span></p><p><span>git </span><span>clone</span><span> </span><span>https</span><span>:</span><span>/</span><span>/</span><span>github</span><span>.com</span><span>/</span><span>marin</span><span>-</span><span>m</span><span>/</span><span>pbtk</span><span> </span><span>.</span></p><p><span>.</span><span>/</span><span>gui</span><span>.py</span></p></div></td></tr></tbody></table></div><p>After installing Qt dependencies (pronounced “cute”), I was treated to a GUI.</p><figure id="attachment_5799"><a href="https://static.ericdraken.com/files/PBTK-The-Protobuf-Toolkit.png"><img src="https://static.ericdraken.com/files/PBTK-The-Protobuf-Toolkit.png" alt="PBTK - The Protobuf Toolkit" width="694" height="581" srcset="https://static.ericdraken.com/files/PBTK-The-Protobuf-Toolkit.png 694w, https://ericdraken.com/files/PBTK-The-Protobuf-Toolkit-300x251.png 300w, https://static.ericdraken.com/files/PBTK-The-Protobuf-Toolkit-600x502.png 600w" sizes="(max-width: 694px) 100vw, 694px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/PBTK-The-Protobuf-Toolkit.png" data-srcset="https://static.ericdraken.com/files/PBTK-The-Protobuf-Toolkit.png 694w, https://ericdraken.com/files/PBTK-The-Protobuf-Toolkit-300x251.png 300w, https://static.ericdraken.com/files/PBTK-The-Protobuf-Toolkit-600x502.png 600w"></a><figcaption>PBTK – The Protobuf Toolkit</figcaption></figure><p>Next, I got the most recent release of a 100 MiB Android APK file from <a href="https://apkpure.com/" target="_blank" rel="nofollow">apkpure.com</a>.</p><p>Excited in vain, the most PBTK could get was a 59-byte proto file. Another tool called <a href="https://ibotpeaches.github.io/Apktool/install/" target="_blank" rel="nofollow">Apktool</a> also looked promising, but the best it can do is <em>disassemble</em> bytecode, not decompile it – this may be good enough for Pen Testers, however.</p><p>What ended up working for APK decompilation is a combination of a dedicated person’s <a href="https://github.com/pxb1988/dex2jar" target="_blank" rel="nofollow">dex2jar tool</a> and a <a href="http://java-decompiler.github.io/" target="_blank" rel="nofollow">Java Decompiler</a>. A helpful guide can be found <a href="https://stackoverflow.com/a/4177581/1938889" target="_blank" rel="nofollow">here</a>.</p><div id="crayon-63661eaabe529630536553" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># Follow the install steps at https://stackoverflow.com/a/4177581/1938889</span></p><p><span>cd</span><span> </span><span>dex2jar</span></p><p><span>chmod</span><span> </span><span>-</span><span>R</span><span> </span><span>+</span><span>x</span><span> </span><span>*</span><span>.sh</span></p><p><span>sh</span><span> </span><span>d2j</span><span>-</span><span>dex2jar</span><span>.sh</span><span> </span><span>-</span><span>f</span><span> </span><span>-</span><span>o</span><span> </span><span>.</span><span>.</span><span>/</span><span>output</span><span>.jar</span><span> </span><span>.</span><span>.</span><span>/</span><span>YouTube_v16</span><span>.</span><span>49.37_apkpure.com.apk</span></p><p><span>cd</span><span> </span><span>.</span><span>.</span><span>/</span><span>jd</span><span>-</span><span>gui</span></p><p><span>java</span><span> </span><span>-</span><span>jar </span><span>jd</span><span>-</span><span>gui</span><span>-</span><span>1.6.6.jar</span></p></div></td></tr></tbody></table></div><p>You can see that Google went out of its way to complicate reverse engineering.</p><figure id="attachment_5800"><a href="https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes.png"><img src="https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-754x302.png" alt="YouTube APK reversed into obfuscated Java classes" width="754" height="302" srcset="https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-754x302.png 754w, https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-300x120.png 300w, https://ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-600x240.png 600w, https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes.png 1079w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-754x302.png" data-srcset="https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-754x302.png 754w, https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-300x120.png 300w, https://ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-600x240.png 600w, https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes.png 1079w"></a><figcaption>YouTube APK reversed into obfuscated Java classes</figcaption></figure><p>Google thoughtfully did leave some hints.</p><figure id="attachment_5802"><a href="https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable.png"><img src="https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-754x353.png" alt="All the Protobuf schemas laid bare and human-readable" width="754" height="353" srcset="https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-754x353.png 754w, https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-300x141.png 300w, https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-600x281.png 600w, https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable.png 1091w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-754x353.png" data-srcset="https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-754x353.png 754w, https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-300x141.png 300w, https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-600x281.png 600w, https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable.png 1091w"></a><figcaption>All the Protobuf classes laid bare and human-readable</figcaption></figure><p>Upon deeper inspection, the Protobuf classes are right here, in Java, decorated with getters and setters. Since we are using Python, and we cannot get the true schema files, I will leave this approach for now.</p><p><a href="#top">Top ↩</a></p><hr><h2>Hardcore Deep-Dive into Protobuf and Wire Format</h2><p>After gazing into a sea of decrypted network traffic again, then triggering errors and assertion fails on my iPhone with Protobuf fuzzing, and taking a peek at the error logs being phoned home, I’ve noticed that ads register for “slots” in a given video. They can register for pre-roll, mid-roll, end-roll, full-page, and ad pods (back-to-back ads). Blocking an ad URL causes an error along the lines of “some ad that doesn’t exist booked a slot” and UI panic sets in.</p><p>I’m going to Sun Tzu the <a href="https://developers.google.com/protocol-buffers/docs/encoding" target="_blank" rel="nofollow">Protobuf Wire Format</a> and come back in a bit…</p><p>I’m back. The Wire Format is surprisingly elegant, except for <a href="https://developers.google.com/protocol-buffers/docs/encoding#signed_integers" target="_blank" rel="nofollow">ZigZag encoding</a>. Through trial and error, editing out chunks of Protobuf with a hex editor is just a no-go.</p><p>While computationally expensive, decoding, editing, and re-encoding without the original schema leads to a modified encoding. This is likely because we cannot detect if ZigZag encoding is being used, or if a number is an <code>int32</code>, <code>int64</code>, <code>sint32/64</code>, <code>varint</code>, etc., plus the order of object fields is normally non-deterministic. Here is some <a href="https://developers.google.com/protocol-buffers/docs/encoding#implications" target="_blank" rel="nofollow">Protobuf trivia</a> on the matter:</p><figure id="attachment_5810"><a href="https://ericdraken.com/files/Protobuf-serialization-gotachas.png"><img src="https://ericdraken.com/files/Protobuf-serialization-gotachas-754x323.png" alt="Protobuf serialization gotachas" width="754" height="323" srcset="https://ericdraken.com/files/Protobuf-serialization-gotachas-754x323.png 754w, https://ericdraken.com/files/Protobuf-serialization-gotachas-300x128.png 300w, https://ericdraken.com/files/Protobuf-serialization-gotachas-600x257.png 600w, https://ericdraken.com/files/Protobuf-serialization-gotachas.png 850w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Protobuf-serialization-gotachas-754x323.png" data-srcset="https://ericdraken.com/files/Protobuf-serialization-gotachas-754x323.png 754w, https://ericdraken.com/files/Protobuf-serialization-gotachas-300x128.png 300w, https://ericdraken.com/files/Protobuf-serialization-gotachas-600x257.png 600w, https://ericdraken.com/files/Protobuf-serialization-gotachas.png 850w"></a><figcaption>Protobuf serialization gotachas</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Exploit a Protobuf Flaw to Easily Remove All Ads by Changing One Byte</h2><p>Casually poring over the C++ source code, an interesting comment in the Protobuf code caught my eye:</p><blockquote><p><code>UnknownFieldSet</code> is used to keep track of fields that were seen when parsing a protocol message but whose field numbers or types are unrecognized. This most frequently occurs when new fields are added to a message type and then messages containing those fields are read by old software that was compiled before the new types were added. (<a href="https://developers.google.com/protocol-buffers/docs/proto3#unknowns" target="_blank" rel="nofollow">ref</a>)</p></blockquote><p>Yes, what to do with unknown fields? What to do indeed. And, how easy would it be to say, change a <code>49399797</code> field key to, say, <code>49399796</code> thus making an entire substructure of advertisement and tracking information suddenly unavailable? Tantalizing.</p><p>And, if we can calculate the field tags in bytes with bit-twiddling, then can we use a simple regex to AMF<a title="Adios, My Friend" rel="nofollow" id="return-note-5418-1" href="#note-5418-1"><sup>1</sup></a> the section of ads in <code>O(n)</code> time?</p><p>As a motivating example, I’d like to find the field key <code>49399797</code> which is not as simple as searching for <code>2F1C7F5</code>. Here is an implementation of a tag-scanning algorithm so you can see the bit-twiddling:</p><div id="crayon-63661eaabe52e139325226" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>def</span><span> </span><span>DecodeVarint</span><span>(</span><span>buffer</span><span>,</span><span> </span><span>pos</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;</span><span>mask</span><span> </span><span>=</span><span> </span><span>(</span><span>1</span><span> </span><span>&lt;&lt;</span><span> </span><span>64</span><span>)</span><span> </span><span>-</span><span> </span><span>1</span></p><p><span>&nbsp;&nbsp;</span><span>result</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>&nbsp;&nbsp;</span><span>shift</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>&nbsp;&nbsp;</span><span>while</span><span> </span><span>1</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span> </span><span>=</span><span> </span><span>buffer</span><span>[</span><span>pos</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>result</span><span> </span><span>|=</span><span> </span><span>(</span><span>(</span><span>b</span><span> </span><span>&amp;</span><span> </span><span>0x7f</span><span>)</span><span> </span><span>&lt;&lt;</span><span> </span><span>shift</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>pos</span><span> </span><span>+=</span><span> </span><span>1</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>not</span><span> </span><span>(</span><span>b</span><span> </span><span>&amp;</span><span> </span><span>0x80</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>result</span><span> </span><span>&amp;=</span><span> </span><span>mask</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>result</span><span> </span><span>=</span><span> </span><span>int</span><span>(</span><span>result</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>(</span><span>result</span><span>,</span><span> </span><span>pos</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>shift</span><span> </span><span>+=</span><span> </span><span>7</span></p></div></td></tr></tbody></table></div><p>We know the wire type is <code>2</code> (length-delimited nested string/message), and one target field <em>key</em> is <code>49399797</code>. When bit-twiddled, we get the target <em>tag</em></p><p><code>AA FF B8 BC 01</code></p><p>where the final <code>01</code> happens to mean <code>2</code> (the wire type) in hex. In binary, this is:</p><p><code>10101010 11111111 10111000 10111100 00000001</code></p><p>Let’s lose the MSB from each byte as per the var-length wire format:</p><p><code>.0101010 .1111111 .0111000 .0111100 .0000001</code></p><p>Then we shift and add only the first four bytes since the LSB is first:</p><div id="crayon-63661eaabe531447697148" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>42</span><span> </span><span>+</span><span> </span><span>(</span><span>127</span><span> </span><span>*</span><span> </span><span>2</span><span>^</span><span>7</span><span>)</span><span> </span><span>+</span><span> </span><span>(</span><span>56</span><span> </span><span>*</span><span> </span><span>2</span><span>^</span><span>14</span><span>)</span><span> </span><span>+</span><span> </span><span>(</span><span>188</span><span> </span><span>*</span><span> </span><span>2</span><span>^</span><span>21</span><span>)</span><span> </span><span>=</span></p><p><span>42</span><span> </span><span>+</span><span> </span><span>(</span><span>127</span><span> </span><span>*</span><span> </span><span>128</span><span>)</span><span> </span><span>+</span><span> </span><span>(</span><span>56</span><span> </span><span>*</span><span> </span><span>16384</span><span>)</span><span> </span><span>+</span><span> </span><span>(</span><span>188</span><span> </span><span>*</span><span> </span><span>2097152</span><span>)</span><span> </span><span>=</span></p><p><span>42</span><span> </span><span>+</span><span> </span><span>16256</span><span> </span><span>+</span><span> </span><span>917504</span><span> </span><span>+</span><span> </span><span>394264576</span><span> </span><span>=</span></p><p><span>395198378</span></p></div></td></tr></tbody></table></div><p>Finally, we shift out the number of wire type bits (3) to get back the field key:</p><p><code>395198378 &gt;&gt; 3 = 49399797</code></p><p>And that, folks, is a taste of how Wire Format works.</p><p>Fantastic. Now, all we have to do is scan the Protobuf bytes for classic ad URL signatures like <code>/pagead/</code> to bound our field search, then move backward from there until we find the target(s) field tags and thus field keys we would like to denature (e.g. <code>49399797</code> –&gt; <code>49399796</code>).</p><div id="crayon-63661eaabe533307450758" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>&gt;&gt;</span><span> </span><span>Request</span><span>(</span><span>POST </span><span>youtubei</span><span>.googleapis</span><span>.com</span><span>:</span><span>443</span><span>/</span><span>youtubei</span><span>/</span><span>v1</span><span>/</span><span>browse</span><span>?</span><span>key</span><span>=</span><span>.</span><span>.</span><span>.</span><span>)</span></p><p><span>&lt;&lt;</span><span> </span><span>Response</span><span>(</span><span>200</span><span>,</span><span> </span><span>application</span><span>/</span><span>x</span><span>-</span><span>protobuf</span><span>,</span><span> </span><span>1.87m</span><span>)</span></p><p><span>Intercepting </span><span>https</span><span>:</span><span>/</span><span>/</span><span>youtubei</span><span>.googleapis</span><span>.com</span><span>/</span><span>youtubei</span><span>/</span><span>v1</span><span>/</span><span>browse</span><span>?</span><span>key</span><span>=</span><span>.</span><span>.</span><span>.</span><span> </span><span>(</span><span>Protobuf</span><span>)</span></p><p><span>Found </span><span>key</span><span> </span><span>49399797</span><span> </span><span>at</span><span> </span><span>position</span><span> </span><span>4465</span></p><p><span>Found </span><span>key</span><span> </span><span>50195462</span><span> </span><span>at</span><span> </span><span>position</span><span> </span><span>4477</span></p></div></td></tr></tbody></table></div><p>Notice how the Protobuf response payload is <strong>1.87 MiB</strong>? As I said, Google makes it computationally expensive to decode, alter, and re-encode without the C++ source proto files, but a quick linear scan takes no effort at all.</p><figure id="attachment_5822"><a href="https://static.ericdraken.com/files/Walking-backward-from-the-ad-marker.png"><img src="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png" alt="Walking backward from the ad marker" width="754" height="617" srcset="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png 754w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-300x246.png 300w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-600x491.png 600w, https://static.ericdraken.com/files/Walking-backward-from-the-ad-marker.png 966w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png" data-srcset="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png 754w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-300x246.png 300w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-600x491.png 600w, https://static.ericdraken.com/files/Walking-backward-from-the-ad-marker.png 966w"></a><figcaption>Walking backward from the ad marker</figcaption></figure><p>Just a quick note, there is more than one field tag, but not all of them represent ads. That is why we need to backtrack from the <code>/pagead/</code> markers.</p><figure id="attachment_5892"><a href="https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present.png"><img src="https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present.png" alt="Multiple identical field tags may be present" width="675" height="99" srcset="https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present.png 675w, https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present-300x44.png 300w, https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present-600x88.png 600w" sizes="(max-width: 675px) 100vw, 675px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present.png" data-srcset="https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present.png 675w, https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present-300x44.png 300w, https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present-600x88.png 600w"></a><figcaption>Multiple identical field tags may be present</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Smoke Test: Remove Ads from Protobuf in O(n)-Time</h2><p><strong><span>It works!</span></strong> In one pass with no additional memory, I’m able to scan a huge 1.8 MiB chunk of jibberish-looking Protobuf data, and in the screenshot below only at the 30,593<sup>th</sup> byte (of 1.8 MiB) is our target found, and then backtracking ~600 characters yields our target field key to denature. Not only is this amazing, but I don’t even need to block <code>*.googleadservices.com</code> or URLs with <code>/pagead/</code> in them; Those requests are never made in the first place, anymore.</p><figure id="attachment_5838"><a href="https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response.png"><img src="https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-754x329.png" alt="Successfully able to remove ads from the Protobuf response" width="754" height="329" srcset="https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-754x329.png 754w, https://static.ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-300x131.png 300w, https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-600x262.png 600w, https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response.png 1313w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-754x329.png" data-srcset="https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-754x329.png 754w, https://static.ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-300x131.png 300w, https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-600x262.png 600w, https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response.png 1313w"></a><figcaption>Successfully able to remove ads from the Protobuf response</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Analysis of this Successful Adblocking Technique</h2><h3>Summary</h3><p>By taking advantage of a feature (flaw?) in Protobuf that allows it to be backward compatible with schema changes, along with the fact that Protobuf is very sensitive to byte changes due to its compact nature, we can change a single byte in a critical location and tell Protobuf that an entire section of deeply-nested data is from a future schema version and it should be ignored.</p><h3>Timing Analysis</h3><p>Google returns huge responses in Protobuf (e.g. 1.8 MiB) – including even the layout of the iOS app – so only C++/Swift is fast enough to understand it all before the connection times out. I’ve shown that Python is several orders of magnitude too slow in decoding these Protobuf payloads, so connections do time out waiting on Python. With web-based JSON, the whole payload needs to be parsed, edited, and re-serialized; With my Protobuf technique, it takes microseconds thanks to a single linear scan and then ultra-quick backtracking. This technique is suitable for real-time adblocking without blocklists.</p><h3>Knock-On Benefits</h3><p>All those <code>*.googleadservices.com</code> and <code>/pagead/*</code> URLs on Apple devices originate from the Protobuf payload. This means they all go away for free – we don’t need to block them. In fact, the YouTube app is zippier because fewer connections are made to ad URLs in the first place. This means we can avoid keeping a blocklist of YouTube ad URLs and stay on the sidelines of the whack-a-mole fun. Ads do not register for video location “slots” on the Apple devices and the content just plays.</p><h3>Future-Proof</h3><p>This is a heuristic technique that looks for two strings: <code>/pagead/</code> and some calculated field tag nearby, so this technique is designed to be future-proof.</p><figure id="attachment_5822"><a href="https://static.ericdraken.com/files/Walking-backward-from-the-ad-marker.png"><img src="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png" alt="Walking backward from the ad marker" width="754" height="617" srcset="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png 754w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-300x246.png 300w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-600x491.png 600w, https://static.ericdraken.com/files/Walking-backward-from-the-ad-marker.png 966w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png" data-srcset="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png 754w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-300x246.png 300w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-600x491.png 600w, https://static.ericdraken.com/files/Walking-backward-from-the-ad-marker.png 966w"></a><figcaption>Walking backward from the ad marker to find the field key</figcaption></figure><p>Even if Google changes the field tag (and breaks millions of apps and Apple TVs before they upgrade), it’s an academic exercise to enhance the following script to discover the new field tag(s) automatically.</p><h3>Should Google be Worried?</h3><p>No, not at all.</p><p>This is a <strong>highly-specialized technique</strong> to block Apple-device YouTube ads (or Instagram, Whatsapp, Facebook, etc. tracker blocking). The CPU requirements to decrypt and re-encrypt HTTPS traffic greatly exceed those available to Raspberry Pis. Even if some company takes my script and considers making and selling a NIC dongle, it would likely not be powerful enough. An <a href="https://www.nvidia.com/en-us/shield/shield-tv/" target="_blank" rel="nofollow">Nvidia Shield</a> could handle it, but if you already have Android devices, then just hack the binaries; My technique is for Apple device owners where we don’t want to compromise the OS so that further reduces the audience of this technique.</p><p><a href="#top">Top ↩</a></p><hr><h2>The MITMProxy YouTube Adblocking Script</h2><p>Here is the MITMProxy addon script that serves as a proof-of-concept to block YouTube ads on networked Apple devices. The script can be run as follows (note the prerequisites in the script and be sure to install them first). Name it <code>youtube.py</code> and run the following command:</p><p><code>mitmdump --listen-port 8080 --listen-host 127.0.0.1 -s "youtube.py"</code></p><p>Here is the script, including a fairness function to allow ads 5% of the time:</p><div id="crayon-63661eaabe539122026764" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p><p>65</p><p>66</p><p>67</p><p>68</p><p>69</p><p>70</p><p>71</p><p>72</p><p>73</p><p>74</p><p>75</p><p>76</p><p>77</p><p>78</p><p>79</p><p>80</p><p>81</p><p>82</p><p>83</p><p>84</p><p>85</p><p>86</p><p>87</p><p>88</p><p>89</p><p>90</p><p>91</p><p>92</p><p>93</p><p>94</p><p>95</p><p>96</p><p>97</p><p>98</p><p>99</p><p>100</p><p>101</p><p>102</p><p>103</p><p>104</p><p>105</p><p>106</p><p>107</p><p>108</p><p>109</p><p>110</p><p>111</p><p>112</p><p>113</p><p>114</p><p>115</p><p>116</p><p>117</p><p>118</p><p>119</p><p>120</p><p>121</p><p>122</p><p>123</p><p>124</p><p>125</p><p>126</p><p>127</p><p>128</p><p>129</p><p>130</p><p>131</p><p>132</p><p>133</p><p>134</p><p>135</p><p>136</p><p>137</p><p>138</p><p>139</p><p>140</p><p>141</p><p>142</p><p>143</p><p>144</p><p>145</p><p>146</p><p>147</p><p>148</p><p>149</p><p>150</p><p>151</p><p>152</p><p>153</p><p>154</p><p>155</p><p>156</p><p>157</p><p>158</p><p>159</p><p>160</p><p>161</p><p>162</p><p>163</p><p>164</p><p>165</p><p>166</p><p>167</p><p>168</p><p>169</p><p>170</p><p>171</p><p>172</p><p>173</p><p>174</p><p>175</p><p>176</p><p>177</p><p>178</p><p>179</p><p>180</p><p>181</p><p>182</p><p>183</p><p>184</p><p>185</p><p>186</p><p>187</p><p>188</p><p>189</p><p>190</p><p>191</p><p>192</p><p>193</p><p>194</p><p>195</p><p>196</p><p>197</p><p>198</p><p>199</p><p>200</p><p>201</p><p>202</p><p>203</p><p>204</p><p>205</p><p>206</p><p>207</p><p>208</p><p>209</p><p>210</p><p>211</p><p>212</p><p>213</p><p>214</p><p>215</p><p>216</p><p>217</p><p>218</p><p>219</p><p>220</p><p>221</p><p>222</p><p>223</p><p>224</p><p>225</p><p>226</p><p>227</p><p>228</p><p>229</p><p>230</p><p>231</p><p>232</p><p>233</p><p>234</p><p>235</p><p>236</p><p>237</p><p>238</p><p>239</p><p>240</p><p>241</p><p>242</p><p>243</p><p>244</p><p>245</p><p>246</p><p>247</p><p>248</p><p>249</p><p>250</p><p>251</p><p>252</p><p>253</p><p>254</p><p>255</p><p>256</p><p>257</p><p>258</p><p>259</p><p>260</p><p>261</p><p>262</p><p>263</p><p>264</p><p>265</p><p>266</p><p>267</p><p>268</p><p>269</p><p>270</p><p>271</p><p>272</p><p>273</p><p>274</p><p>275</p><p>276</p><p>277</p><p>278</p><p>279</p><p>280</p><p>281</p><p>282</p><p>283</p><p>284</p><p>285</p><p>286</p><p>287</p><p>288</p><p>289</p><p>290</p><p>291</p><p>292</p><p>293</p><p>294</p><p>295</p><p>296</p><p>297</p><p>298</p><p>299</p><p>300</p><p>301</p><p>302</p><p>303</p><p>304</p><p>305</p><p>306</p><p>307</p><p>308</p><p>309</p><p>310</p><p>311</p><p>312</p><p>313</p><p>314</p><p>315</p><p>316</p><p>317</p><p>318</p><p>319</p><p>320</p><p>321</p><p>322</p><p>323</p><p>324</p><p>325</p><p>326</p><p>327</p><p>328</p><p>329</p><p>330</p><p>331</p><p>332</p><p>333</p><p>334</p><p>335</p><p>336</p><p>337</p><p>338</p><p>339</p><p>340</p><p>341</p><p>342</p><p>343</p><p>344</p><p>345</p><p>346</p><p>347</p><p>348</p><p>349</p><p>350</p><p>351</p><p>352</p><p>353</p><p>354</p><p>355</p><p>356</p><p>357</p><p>358</p><p>359</p><p>360</p><p>361</p><p>362</p><p>363</p><p>364</p><p>365</p><p>366</p><p>367</p><p>368</p></div></td><td><div><p><span># -*- coding: utf-8 -*-</span></p><p><span>#&nbsp;&nbsp;Copyright (c) 2021. Eric Draken (ericdraken.com)</span></p><p><span>#&nbsp;&nbsp;Block YouTube ads on Apple devices by exploiting a Protobuf flaw</span></p><p><span>#</span></p><p><span>#&nbsp;&nbsp;FreeBSD Prerequisites:</span></p><p><span>#&nbsp;&nbsp;pkg install protobuf</span></p><p><span>#&nbsp;&nbsp;pkg install py38-pip</span></p><p><span>#&nbsp;&nbsp;pip install jsonpath-ng</span></p><p><span>#</span></p><p><span>import</span><span> </span><span>hashlib</span></p><p><span>import</span><span> </span><span>inspect</span></p><p><span>import</span><span> </span><span>json</span></p><p><span>import</span><span> </span><span>re</span></p><p><span>import</span><span> </span><span>subprocess</span></p><p><span>import</span><span> </span><span>sys</span></p><p><span>import</span><span> </span><span>traceback</span></p><p><span>from</span><span> </span><span>datetime</span><span> </span><span>import</span><span> </span><span>datetime</span></p><p><span>from</span><span> </span><span>json</span><span> </span><span>import</span><span> </span><span>JSONDecodeError</span></p><p><span>from</span><span> </span><span>typing </span><span>import</span><span> </span><span>Final</span></p><p><span>from</span><span> </span><span>google</span><span>.</span><span>protobuf</span><span>.</span><span>internal</span><span>.</span><span>encoder </span><span>import</span><span> </span><span>TagBytes</span></p><p><span>from</span><span> </span><span>google</span><span>.</span><span>protobuf</span><span>.</span><span>text_format </span><span>import</span><span> </span><span>WIRETYPE_LENGTH_DELIMITED</span></p><p><span>from</span><span> </span><span>jsonpath_ng </span><span>import</span><span> </span><span>DatumInContext</span></p><p><span>from</span><span> </span><span>jsonpath_ng </span><span>import</span><span> </span><span>jsonpath</span><span>,</span><span> </span><span>parse</span></p><p><span>from</span><span> </span><span>jsonpath_ng</span><span>.</span><span>ext </span><span>import</span><span> </span><span>parse</span></p><p><span>from</span><span> </span><span>mitmproxy </span><span>import</span><span> </span><span>ctx</span><span>,</span><span> </span><span>http</span></p><p><span>from</span><span> </span><span>mitmproxy</span><span>.</span><span>addons</span><span>.</span><span>next_layer </span><span>import</span><span> </span><span>NextLayer</span></p><p><span>from</span><span> </span><span>mitmproxy</span><span>.</span><span>flow </span><span>import</span><span> </span><span>Error</span></p><p><span>from</span><span> </span><span>mitmproxy</span><span>.</span><span>proxy </span><span>import</span><span> </span><span>layer</span><span>,</span><span> </span><span>layers</span></p><p><span>TRUNCATE_LEN</span><span>:</span><span> </span><span>Final</span><span>[</span><span>int</span><span>]</span><span> </span><span>=</span><span> </span><span>120</span></p><p><span>DEBUG_MODE</span><span>:</span><span> </span><span>bool</span><span> </span><span>=</span><span> </span><span>False</span></p><p><span>class</span><span> </span><span>Logger</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Helper to bypass the async logger loop to view logs in real-time"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>info</span><span>(</span><span>self</span><span>,</span><span> </span><span>msg</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>print</span><span>(</span><span>msg</span><span>)</span><span> </span><span>if</span><span> </span><span>DEBUG_MODE </span><span>else</span><span> </span><span>ctx</span><span>.</span><span>log</span><span>.</span><span>info</span><span>(</span><span>msg</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>warn</span><span>(</span><span>self</span><span>,</span><span> </span><span>msg</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>print</span><span>(</span><span>msg</span><span>)</span><span> </span><span>if</span><span> </span><span>DEBUG_MODE </span><span>else</span><span> </span><span>ctx</span><span>.</span><span>log</span><span>.</span><span>warn</span><span>(</span><span>msg</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>error</span><span>(</span><span>self</span><span>,</span><span> </span><span>msg</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>print</span><span>(</span><span>msg</span><span>)</span><span> </span><span>if</span><span> </span><span>DEBUG_MODE </span><span>else</span><span> </span><span>ctx</span><span>.</span><span>log</span><span>.</span><span>error</span><span>(</span><span>msg</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>alert</span><span>(</span><span>self</span><span>,</span><span> </span><span>msg</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>print</span><span>(</span><span>msg</span><span>)</span><span> </span><span>if</span><span> </span><span>DEBUG_MODE </span><span>else</span><span> </span><span>ctx</span><span>.</span><span>log</span><span>.</span><span>alert</span><span>(</span><span>msg</span><span>)</span></p><p><span>logger</span><span> </span><span>=</span><span> </span><span>Logger</span><span>(</span><span>)</span></p><p><span>def</span><span> </span><span>trunc</span><span>(</span><span>msg</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>str</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Helper for viewing very long URLs"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>msg</span><span> </span><span>=</span><span> </span><span>str</span><span>(</span><span>msg</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>len</span><span>(</span><span>msg</span><span>)</span><span> </span><span>&gt;</span><span> </span><span>TRUNCATE_LEN</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>f</span><span>"{msg[:TRUNCATE_LEN-3]}..."</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>msg</span></p><p><span>class</span><span> </span><span>KilledError</span><span>(</span><span>Error</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Better logging messages than just 'Connection killed.'"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>__init__</span><span>(</span><span>self</span><span>,</span><span> </span><span>reason</span><span>:</span><span> </span><span>str</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>None</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>_msg</span><span> </span><span>=</span><span> </span><span>Error</span><span>.</span><span>KILLED_MESSAGE</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>reason</span><span> </span><span>=</span><span> </span><span>reason</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>super</span><span>(</span><span>)</span><span>.</span><span>__init__</span><span>(</span><span>self</span><span>.</span><span>_msg</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>@</span><span>property</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>msg</span><span>(</span><span>self</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>caller</span><span> </span><span>=</span><span> </span><span>inspect</span><span>.</span><span>stack</span><span>(</span><span>)</span><span>[</span><span>1</span><span>]</span><span>.</span><span>function</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># These are the only two methods that compare the msg</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># with KILLED_MESSAGE to perform business logic</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>"killable"</span><span> </span><span>in</span><span> </span><span>caller </span><span>or</span><span> </span><span>"check_killed"</span><span> </span><span>in</span><span> </span><span>caller</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>self</span><span>.</span><span>_msg</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>self</span><span>.</span><span>reason</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Needed to satisfy a flow setter</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>@</span><span>msg</span><span>.</span><span>setter</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>msg</span><span>(</span><span>self</span><span>,</span><span> </span><span>msg</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>_msg</span><span> </span><span>=</span><span> </span><span>msg</span></p><p><span>class</span><span> </span><span>JSONPathReplacement</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Helper class to organize JSON ad replacements"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>__init__</span><span>(</span><span>self</span><span>,</span><span> </span><span>tag</span><span>:</span><span> </span><span>str</span><span>,</span><span> </span><span>target_path</span><span>:</span><span> </span><span>str</span><span>,</span><span> </span><span>replacement</span><span>:</span><span> </span><span>any</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>None</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>tag</span><span>:</span><span> </span><span>str</span><span> </span><span>=</span><span> </span><span>tag</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>target_path</span><span> </span><span>=</span><span> </span><span>target_path</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>target</span><span>:</span><span> </span><span>jsonpath</span><span>.</span><span>Root</span><span> </span><span>=</span><span> </span><span>parse</span><span>(</span><span>target_path</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>replacement</span><span>:</span><span> </span><span>any</span><span> </span><span>=</span><span> </span><span>replacement</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>update</span><span>(</span><span>self</span><span>,</span><span> </span><span>obj</span><span>:</span><span> </span><span>object</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>found</span><span> </span><span>=</span><span> </span><span>self</span><span>.</span><span>target</span><span>.</span><span>find</span><span>(</span><span>obj</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>found</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>index</span><span>,</span><span> </span><span>item </span><span>in</span><span> </span><span>enumerate</span><span>(</span><span>found</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>target</span><span>.</span><span>update</span><span>(</span><span>item</span><span>,</span><span> </span><span>self</span><span>.</span><span>replacement</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"Replaced `{self.target_path}[{index}]` with `{self.replacement}`"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>DEBUG_MODE</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>found_again</span><span> </span><span>=</span><span> </span><span>self</span><span>.</span><span>target</span><span>.</span><span>find</span><span>(</span><span>obj</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>replacement_json</span><span> </span><span>=</span><span> </span><span>json</span><span>.</span><span>dumps</span><span>(</span><span>self</span><span>.</span><span>replacement</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>index</span><span>,</span><span> </span><span>item_ </span><span>in</span><span> </span><span>enumerate</span><span>(</span><span>found_again</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>item</span><span>:</span><span> </span><span>DatumInContext</span><span> </span><span>=</span><span> </span><span>item_</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>json</span><span>.</span><span>dumps</span><span>(</span><span>item</span><span>.</span><span>value</span><span>)</span><span> </span><span>!=</span><span> </span><span>replacement_json</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>error</span><span>(</span><span>f</span><span>"Replacement of `{self.target_path}` did not succeed. Found `{json.dumps(item.value)}`"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>info</span><span>(</span><span>f</span><span>"-Skipping `{self.target_path}`"</span><span>)</span></p><p><span>class</span><span> </span><span>ProtobufDebugParser</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Use the C++ protoc binary to parse raw Protobuf data. This is for debugging."""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>cmd</span><span> </span><span>=</span><span> </span><span>[</span><span>"protoc"</span><span>,</span><span> </span><span>"--decode_raw"</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>url_re</span><span> </span><span>=</span><span> </span><span>re</span><span>.</span><span>compile</span><span>(</span><span>r</span><span>"(https?://[^\s\\]+)"</span><span>,</span><span> </span><span>re</span><span>.</span><span>IGNORECASE</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>format_response</span><span>(</span><span>self</span><span>,</span><span> </span><span>data</span><span>:</span><span> </span><span>bytes</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>list</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>protoc_proc</span><span> </span><span>=</span><span> </span><span>subprocess</span><span>.</span><span>Popen</span><span>(</span><span>self</span><span>.</span><span>cmd</span><span>,</span><span> </span><span>shell</span><span>=</span><span>False</span><span>,</span><span> </span><span>stdin</span><span>=</span><span>subprocess</span><span>.</span><span>PIPE</span><span>,</span><span> </span><span>stdout</span><span>=</span><span>subprocess</span><span>.</span><span>PIPE</span><span>,</span><span> </span><span>stderr</span><span>=</span><span>subprocess</span><span>.</span><span>PIPE</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>stdout</span><span>,</span><span> </span><span>stderr</span><span>)</span><span> </span><span>=</span><span> </span><span>protoc_proc</span><span>.</span><span>communicate</span><span>(</span><span>data</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>stderr</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>raise</span><span> </span><span>Exception</span><span>(</span><span>stderr</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>stdout</span><span>.</span><span>splitlines</span><span>(</span><span>keepends</span><span>=</span><span>False</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>parse_response</span><span>(</span><span>self</span><span>,</span><span> </span><span>data</span><span>:</span><span> </span><span>bytes</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>list</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>protoc_proc</span><span> </span><span>=</span><span> </span><span>subprocess</span><span>.</span><span>Popen</span><span>(</span><span>self</span><span>.</span><span>cmd</span><span>,</span><span> </span><span>shell</span><span>=</span><span>False</span><span>,</span><span> </span><span>stdin</span><span>=</span><span>subprocess</span><span>.</span><span>PIPE</span><span>,</span><span> </span><span>stdout</span><span>=</span><span>subprocess</span><span>.</span><span>PIPE</span><span>,</span><span> </span><span>stderr</span><span>=</span><span>subprocess</span><span>.</span><span>PIPE</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>grep_process</span><span> </span><span>=</span><span> </span><span>subprocess</span><span>.</span><span>Popen</span><span>(</span><span>[</span><span>"grep"</span><span>,</span><span> </span><span>"https://"</span><span>]</span><span>,</span><span> </span><span>shell</span><span>=</span><span>False</span><span>,</span><span> </span><span>stdin</span><span>=</span><span>protoc_proc</span><span>.</span><span>stdout</span><span>,</span><span> </span><span>stdout</span><span>=</span><span>subprocess</span><span>.</span><span>PIPE</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>_</span><span>,</span><span> </span><span>stderr</span><span>)</span><span> </span><span>=</span><span> </span><span>protoc_proc</span><span>.</span><span>communicate</span><span>(</span><span>data</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>stdout</span><span>,</span><span> </span><span>_</span><span>)</span><span> </span><span>=</span><span> </span><span>grep_process</span><span>.</span><span>communicate</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>stderr</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>raise</span><span> </span><span>Exception</span><span>(</span><span>stderr</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>urls</span><span> </span><span>=</span><span> </span><span>stdout</span><span>.</span><span>splitlines</span><span>(</span><span>keepends</span><span>=</span><span>False</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>matches</span><span> </span><span>=</span><span> </span><span>[</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>url </span><span>in</span><span> </span><span>urls</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>match</span><span> </span><span>=</span><span> </span><span>self</span><span>.</span><span>url_re</span><span>.</span><span>search</span><span>(</span><span>url</span><span>.</span><span>decode</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>match</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>matches</span><span>.</span><span>append</span><span>(</span><span>match</span><span>.</span><span>group</span><span>(</span><span>0</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>matches</span></p><p><span>class</span><span> </span><span>YouTubeAdBlocker</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Intercept certain YouTube domains and modify the JSON or Protobuf to remove ads from YouTube"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Set this to the blackhole IP used by pfBlockerNG, or even a partial blackhole IP</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>blackhole_ip_prefix</span><span>:</span><span> </span><span>Final</span><span>[</span><span>str</span><span>]</span><span> </span><span>=</span><span> </span><span>"10.10.10."</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Intercept only these wildcard domains and no others</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>intercept_hosts</span><span> </span><span>=</span><span> </span><span>r</span><span>"\.youtube\.com|google\.(com|ca)|googleapis\.com|googleadservices\.com|googlevideo\.com"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>intercept_hosts_re</span><span> </span><span>=</span><span> </span><span>re</span><span>.</span><span>compile</span><span>(</span><span>intercept_hosts</span><span>,</span><span> </span><span>re</span><span>.</span><span>IGNORECASE</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ad_url_search_string</span><span> </span><span>=</span><span> </span><span>b</span><span>"/pagead/"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ad_url_search_limit</span><span> </span><span>=</span><span> </span><span>80_000</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>target_field_tag</span><span> </span><span>=</span><span> </span><span>50195462</span><span>&nbsp;&nbsp;</span><span># This is just one of several field tags</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>protobuf_parser</span><span> </span><span>=</span><span> </span><span>ProtobufDebugParser</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Block requests from wildcard domains with any of the follow URL strings</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>blocked_partials</span><span>:</span><span> </span><span>dict</span><span> </span><span>=</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"youtube.com"</span><span>:</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"pagead/"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"log_event?"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"stats/ads"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"stats/qoe?"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"ptracking?"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"generate_204"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"error_204"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"adformat="</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"activeview?"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"_ad_"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"ai?"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"sw.js"</span><span>,</span><span>&nbsp;&nbsp;</span><span># Just say no to service workers</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"google.com"</span><span>:</span><span> </span><span>[</span><span>"pagead/"</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"google.ca"</span><span>:</span><span> </span><span>[</span><span>"pagead/"</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"googleapis.com"</span><span>:</span><span> </span><span>[</span><span>"pagead/"</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Strip sections of JSON that contain ad information (for web YouTube)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>json_replacements</span><span> </span><span>=</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"yt_ad"</span><span>,</span><span> </span><span>"$.responseContext.serviceTrackingParams[*].params[?(@.key == 'yt_ad')].value"</span><span>,</span><span> </span><span>"0"</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"adPlacements"</span><span>,</span><span> </span><span>"$..adPlacements"</span><span>,</span><span> </span><span>[</span><span>]</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"adPlacementRenderer"</span><span>,</span><span> </span><span>"$..adPlacementRenderer"</span><span>,</span><span> </span><span>{</span><span>}</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"adPlacementConfig"</span><span>,</span><span> </span><span>"$..adPlacementConfig"</span><span>,</span><span> </span><span>{</span><span>}</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"adVideoId"</span><span>,</span><span> </span><span>"$..adVideoId"</span><span>,</span><span> </span><span>""</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"playerAdParams"</span><span>,</span><span> </span><span>"$..playerAdParams"</span><span>,</span><span> </span><span>{</span><span>}</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"showCompanion"</span><span>,</span><span> </span><span>"$..showCompanion"</span><span>,</span><span> </span><span>False</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"showInstream"</span><span>,</span><span> </span><span>"$..showInstream"</span><span>,</span><span> </span><span>False</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"useGut"</span><span>,</span><span> </span><span>"$..useGut"</span><span>,</span><span> </span><span>False</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"gutParams"</span><span>,</span><span> </span><span>"$..gutParams"</span><span>,</span><span> </span><span>{</span><span>}</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>@</span><span>staticmethod</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>in_allowed_ads_window</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Allow ads 5% of the time to support content creators which follows the CRTC rules for Student Radio.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;REF: https://crtc.gc.ca/eng/television/publicit/publicit.htm"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>now</span><span> </span><span>=</span><span> </span><span>datetime</span><span>.</span><span>now</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>0</span><span> </span><span>&lt;=</span><span> </span><span>now</span><span>.</span><span>minute</span><span> </span><span>&lt;=</span><span> </span><span>2</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""The following methods are hooks that are called during the normal flow of MITMProxy"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># noinspection PyMethodMayBeStatic</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>load</span><span>(</span><span>self</span><span>,</span><span> </span><span>_</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Do not allow piped requests we could miss</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span>.</span><span>options</span><span>.</span><span>http2</span><span> </span><span>=</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span>.</span><span>options</span><span>.</span><span>update</span><span>(</span><span>http2</span><span>=</span><span>False</span><span>,</span><span> </span><span>anticomp</span><span>=</span><span>True</span><span>,</span><span> </span><span>mode</span><span>=</span><span>"transparent"</span><span>,</span><span> </span><span>termlog_verbosity</span><span>=</span><span>"debug"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>except</span><span> </span><span>KeyError</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span>.</span><span>options</span><span>.</span><span>update</span><span>(</span><span>http2</span><span>=</span><span>False</span><span>,</span><span> </span><span>anticomp</span><span>=</span><span>True</span><span>,</span><span> </span><span>mode</span><span>=</span><span>"transparent"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"{self.__class__.__name__} loaded"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>running</span><span>(</span><span>self</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Intercept requests only for YouTube domains"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>ctx</span><span>.</span><span>options</span><span>.</span><span>allow_hosts</span><span> </span><span>!=</span><span> </span><span>[</span><span>self</span><span>.</span><span>intercept_hosts</span><span>]</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span>.</span><span>options</span><span>.</span><span>allow_hosts</span><span> </span><span>=</span><span> </span><span>[</span><span>self</span><span>.</span><span>intercept_hosts</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span>.</span><span>options</span><span>.</span><span>ignore_hosts</span><span> </span><span>=</span><span> </span><span>[</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>next_layer_addon</span><span>:</span><span> </span><span>NextLayer</span><span> </span><span>=</span><span> </span><span>ctx</span><span>.</span><span>master</span><span>.</span><span>addons</span><span>.</span><span>get</span><span>(</span><span>"NextLayer"</span><span>.</span><span>lower</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>next_layer_addon</span><span>.</span><span>configure</span><span>(</span><span>"allow_hosts"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"Updated interceptable YouTube hosts"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>next_layer</span><span>(</span><span>self</span><span>,</span><span> </span><span>nextlayer</span><span>:</span><span> </span><span>layer</span><span>.</span><span>NextLayer</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Allow blocked domains that resolve the blackhole IP to pass through"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>nextlayer</span><span>.</span><span>context</span><span>.</span><span>server</span><span>.</span><span>address </span><span>and</span><span> </span><span>nextlayer</span><span>.</span><span>context</span><span>.</span><span>server</span><span>.</span><span>address</span><span>[</span><span>0</span><span>]</span><span>.</span><span>startswith</span><span>(</span><span>self</span><span>.</span><span>blackhole_ip_prefix</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>nextlayer</span><span>.</span><span>layer</span><span> </span><span>=</span><span> </span><span>layers</span><span>.</span><span>TCPLayer</span><span>(</span><span>nextlayer</span><span>.</span><span>context</span><span>,</span><span> </span><span>ignore</span><span>=</span><span>True</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># noinspection PyMethodMayBeStatic</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>error</span><span>(</span><span>self</span><span>,</span><span> </span><span>flow</span><span>:</span><span> </span><span>http</span><span>.</span><span>HTTPFlow</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""The TLS failed due to an ad-blocker info page with no verified TLS"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>flow</span><span>.</span><span>error </span><span>and</span><span> </span><span>(</span><span>"OpenSSL Error"</span><span> </span><span>in</span><span> </span><span>flow</span><span>.</span><span>error</span><span>.</span><span>msg </span><span>and</span><span> </span><span>"alert internal error"</span><span> </span><span>in</span><span> </span><span>flow</span><span>.</span><span>error</span><span>.</span><span>msg</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>flow</span><span>.</span><span>kill</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>request</span><span>(</span><span>self</span><span>,</span><span> </span><span>flow</span><span>:</span><span> </span><span>http</span><span>.</span><span>HTTPFlow</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>None</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Block ad URLs that pfBlockerNG and Pi-hole cannot detect"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Skip inspecting certain requests</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>flow</span><span>.</span><span>response </span><span>or</span><span> </span><span>flow</span><span>.</span><span>error </span><span>or</span><span> </span><span>(</span><span>flow</span><span>.</span><span>reply </span><span>and</span><span> </span><span>flow</span><span>.</span><span>reply</span><span>.</span><span>state</span><span> </span><span>==</span><span> </span><span>"taken"</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Occasionally skip blocking ads to support content creators</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>self</span><span>.</span><span>in_allowed_ads_window</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>test_url</span><span>:</span><span> </span><span>str</span><span> </span><span>=</span><span> </span><span>flow</span><span>.</span><span>request</span><span>.</span><span>url</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>test_host</span><span>:</span><span> </span><span>str</span><span> </span><span>=</span><span> </span><span>flow</span><span>.</span><span>request</span><span>.</span><span>pretty_host</span><span>.</span><span>lower</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>host</span><span>,</span><span> </span><span>partials </span><span>in</span><span> </span><span>self</span><span>.</span><span>blocked_partials</span><span>.</span><span>items</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>test_host</span><span>.</span><span>endswith</span><span>(</span><span>host</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>partial </span><span>in</span><span> </span><span>partials</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>partial </span><span>in</span><span> </span><span>test_url</span><span>.</span><span>lower</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>msg</span><span> </span><span>=</span><span> </span><span>f</span><span>"✘ [{host} -&gt; {partial}] blocking {trunc(flow.request.pretty_url)}..."</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>info</span><span>(</span><span>msg</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Should be a connection refused error</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>flow</span><span>.</span><span>kill</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>flow</span><span>.</span><span>error</span><span> </span><span>=</span><span> </span><span>KilledError</span><span>(</span><span>msg</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>response</span><span>(</span><span>self</span><span>,</span><span> </span><span>flow</span><span>:</span><span> </span><span>http</span><span>.</span><span>HTTPFlow</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""This is the main workhorse. Intercept JSON and Protobuf responses and modify them</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to remove or denature ad information"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Skip inspecting certain responses</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>not</span><span> </span><span>flow</span><span>.</span><span>response </span><span>or</span><span> </span><span>flow</span><span>.</span><span>error </span><span>or</span><span> </span><span>not</span><span> </span><span>flow</span><span>.</span><span>response</span><span>.</span><span>headers</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"&gt;&gt; {flow.request}\n&lt;&lt; {flow.response}\n\n"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Occasionally skip blocking ads to support content creators</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>self</span><span>.</span><span>in_allowed_ads_window</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>test_path</span><span>:</span><span> </span><span>str</span><span> </span><span>=</span><span> </span><span>flow</span><span>.</span><span>request</span><span>.</span><span>url</span><span>.</span><span>lower</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>test_content_type</span><span>:</span><span> </span><span>str</span><span> </span><span>=</span><span> </span><span>str</span><span>(</span><span>flow</span><span>.</span><span>response</span><span>.</span><span>headers</span><span>.</span><span>get</span><span>(</span><span>"content-type"</span><span>)</span><span>)</span><span>.</span><span>lower</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Examine the Protobuf payload</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>"protobuf"</span><span> </span><span>in</span><span> </span><span>test_content_type</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"Intercepting {trunc(test_path)} Protobuf"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Capture rich Protobuf information to disk for offline analysis</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>DEBUG_MODE</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># TODO: This copying can be avoided, but this is debug mode, so we allow it</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>body</span><span> </span><span>=</span><span> </span><span>bytearray</span><span>(</span><span>flow</span><span>.</span><span>response</span><span>.</span><span>get_content</span><span>(</span><span>strict</span><span>=</span><span>False</span><span>)</span><span> </span><span>or</span><span> </span><span>b</span><span>""</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>lines</span><span> </span><span>=</span><span> </span><span>self</span><span>.</span><span>protobuf_parser</span><span>.</span><span>format_response</span><span>(</span><span>body</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>filename</span><span> </span><span>=</span><span> </span><span>""</span><span>.</span><span>join</span><span>(</span><span>x</span><span> </span><span>for</span><span> </span><span>x</span><span> </span><span>in</span><span> </span><span>test_path</span><span>[</span><span>:</span><span>100</span><span>]</span><span> </span><span>if</span><span> </span><span>(</span><span>x</span><span>.</span><span>isalnum</span><span>(</span><span>)</span><span> </span><span>or</span><span> </span><span>x</span><span> </span><span>in</span><span> </span><span>"._- "</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>filename</span><span> </span><span>=</span><span> </span><span>f</span><span>"protobuf-{filename}-{hashlib.md5(test_path.encode()).hexdigest()}"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>with</span><span> </span><span>open</span><span>(</span><span>f</span><span>"{filename}.formatted"</span><span>,</span><span> </span><span>mode</span><span>=</span><span>"w"</span><span>,</span><span> </span><span>buffering</span><span>=</span><span>True</span><span>)</span><span> </span><span>as</span><span> </span><span>f</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>line </span><span>in</span><span> </span><span>lines</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>f</span><span>.</span><span>write</span><span>(</span><span>f</span><span>"{line}\n"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>with</span><span> </span><span>open</span><span>(</span><span>f</span><span>"{filename}.raw"</span><span>,</span><span> </span><span>mode</span><span>=</span><span>"wb"</span><span>)</span><span> </span><span>as</span><span> </span><span>f</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>f</span><span>.</span><span>write</span><span>(</span><span>flow</span><span>.</span><span>response</span><span>.</span><span>raw_content </span><span>or</span><span> </span><span>b</span><span>""</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>with</span><span> </span><span>open</span><span>(</span><span>f</span><span>"{filename}.decoded"</span><span>,</span><span> </span><span>mode</span><span>=</span><span>"wb"</span><span>)</span><span> </span><span>as</span><span> </span><span>f</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>f</span><span>.</span><span>write</span><span>(</span><span>body </span><span>or</span><span> </span><span>b</span><span>""</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># TODO: Use a memory view or some more efficient search structure</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>body</span><span>:</span><span> </span><span>bytearray</span><span> </span><span>=</span><span> </span><span>bytearray</span><span>(</span><span>flow</span><span>.</span><span>response</span><span>.</span><span>get_content</span><span>(</span><span>strict</span><span>=</span><span>False</span><span>)</span><span> </span><span>or</span><span> </span><span>b</span><span>""</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Find a telltale ad URL, but limit the search</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>distance</span><span> </span><span>=</span><span> </span><span>body</span><span>[</span><span>:</span><span> </span><span>self</span><span>.</span><span>ad_url_search_limit</span><span>]</span><span>.</span><span>find</span><span>(</span><span>self</span><span>.</span><span>ad_url_search_string</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>distance</span><span> </span><span>&lt;</span><span> </span><span>0</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"Found {self.ad_url_search_string} at position {distance}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Search forward for an ad URL signature, then backtrack to find the field tag</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>tag_bytes</span><span> </span><span>=</span><span> </span><span>TagBytes</span><span>(</span><span>self</span><span>.</span><span>target_field_tag</span><span>,</span><span> </span><span>WIRETYPE_LENGTH_DELIMITED</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new_bytes</span><span> </span><span>=</span><span> </span><span>TagBytes</span><span>(</span><span>self</span><span>.</span><span>target_field_tag</span><span> </span><span>-</span><span> </span><span>1</span><span>,</span><span> </span><span>WIRETYPE_LENGTH_DELIMITED</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>target_pos</span><span> </span><span>=</span><span> </span><span>body</span><span>[</span><span>:</span><span> </span><span>distance</span><span> </span><span>-</span><span> </span><span>1</span><span>]</span><span>[</span><span>::</span><span>-</span><span>1</span><span>]</span><span>.</span><span>find</span><span>(</span><span>tag_bytes</span><span>[</span><span>::</span><span>-</span><span>1</span><span>]</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>target_pos</span><span> </span><span>&gt;</span><span> </span><span>0</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>target_pos</span><span> </span><span>=</span><span> </span><span>distance</span><span> </span><span>-</span><span> </span><span>1</span><span> </span><span>-</span><span> </span><span>target_pos</span><span> </span><span>-</span><span> </span><span>len</span><span>(</span><span>tag_bytes</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"Found {self.target_field_tag} at position {target_pos}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>assert</span><span> </span><span>body</span><span>[</span><span>target_pos</span><span>]</span><span> </span><span>==</span><span> </span><span>tag_bytes</span><span>[</span><span>0</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>assert</span><span> </span><span>body</span><span>[</span><span>target_pos</span><span> </span><span>+</span><span> </span><span>1</span><span>]</span><span> </span><span>==</span><span> </span><span>tag_bytes</span><span>[</span><span>1</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>assert</span><span> </span><span>body</span><span>[</span><span>target_pos</span><span> </span><span>+</span><span> </span><span>2</span><span>]</span><span> </span><span>==</span><span> </span><span>tag_bytes</span><span>[</span><span>2</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>ind</span><span>,</span><span> </span><span>b</span><span> </span><span>in</span><span> </span><span>enumerate</span><span>(</span><span>new_bytes</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>body</span><span>[</span><span>target_pos</span><span> </span><span>+</span><span> </span><span>ind</span><span>]</span><span> </span><span>=</span><span> </span><span>b</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""NOTE: There are other field keys in different sections, </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and there may be multiple ad sections to denature. What preceded</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is a PoC of the technique that already blocks 90% of ads."""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Example Protobuf path:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"4 {"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;49399797 {"</span><span>&nbsp;&nbsp;</span><span># Damage this key</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;&nbsp;&nbsp;1 {"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ... /pagead/"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Example Protobuf path</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 {"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;50195462 {"</span><span>&nbsp;&nbsp;</span><span># Damage this key</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 {"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;153515154 {"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ... /pagead/"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Put the contents back in the response body</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>flow</span><span>.</span><span>response</span><span>.</span><span>set_content</span><span>(</span><span>bytes</span><span>(</span><span>body</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>except</span><span> </span><span>Exception</span><span> </span><span>as</span><span> </span><span>e</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_</span><span>,</span><span> </span><span>_</span><span>,</span><span> </span><span>exc_traceback</span><span> </span><span>=</span><span> </span><span>sys</span><span>.</span><span>exc_info</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>traceback_</span><span> </span><span>=</span><span> </span><span>traceback</span><span>.</span><span>format_tb</span><span>(</span><span>exc_traceback</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>alert</span><span>(</span><span>f</span><span>"{e!r}, {traceback_}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>elif</span><span> </span><span>"json"</span><span> </span><span>in</span><span> </span><span>test_content_type</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"Intercepting {trunc(test_path)} JSON"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Examine the JSON payload</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>obj</span><span> </span><span>=</span><span> </span><span>flow</span><span>.</span><span>response</span><span>.</span><span>json</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>replacement </span><span>in</span><span> </span><span>self</span><span>.</span><span>json_replacements</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>replacement</span><span>.</span><span>update</span><span>(</span><span>obj</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>flow</span><span>.</span><span>response</span><span>.</span><span>set_content</span><span>(</span><span>json</span><span>.</span><span>dumps</span><span>(</span><span>obj</span><span>,</span><span> </span><span>ensure_ascii</span><span>=</span><span>False</span><span>)</span><span>.</span><span>encode</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>except</span><span> </span><span>(</span><span>TypeError</span><span>,</span><span> </span><span>JSONDecodeError</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>pass</span><span>&nbsp;&nbsp;</span><span># Do not stop the show</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>except</span><span> </span><span>Exception</span><span> </span><span>as</span><span> </span><span>e</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_</span><span>,</span><span> </span><span>_</span><span>,</span><span> </span><span>exc_traceback</span><span> </span><span>=</span><span> </span><span>sys</span><span>.</span><span>exc_info</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>traceback_</span><span> </span><span>=</span><span> </span><span>traceback</span><span>.</span><span>format_tb</span><span>(</span><span>exc_traceback</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>alert</span><span>(</span><span>f</span><span>"{e!r}, {traceback_}"</span><span>)</span></p><p><span># Register the addon</span></p><p><span>addons</span><span> </span><span>=</span><span> </span><span>[</span><span>YouTubeAdBlocker</span><span>(</span><span>)</span><span>]</span></p></div></td></tr></tbody></table></div><p>This script happens to work in Python for a TLS-decrypting man-in-the-middle proxy written in Python. As a working proof-of-concept, it’s pretty rad. Of course, it can be rewritten in Rust or Go or anything but single-threaded Python, but as an intellectual exercise to defeat ads that are served from the same domain as content, it’s elegant.</p><p><a href="#top">Top ↩</a></p><hr><h2>YouTube Premium</h2><p>It’s unknown if CAD <del>$9.99/mo</del> $11.99/mo ($13.43/mo with tax) is even reasonable: Do I personally incur CAD $11.99 of cost to advertisers each month?</p><figure id="attachment_5906"><a href="https://static.ericdraken.com/files/youtube-advertising-cost.png"><img src="https://ericdraken.com/files/youtube-advertising-cost-754x282.png" alt="How much does YouTube advertising cost?" width="754" height="282" srcset="https://ericdraken.com/files/youtube-advertising-cost-754x282.png 754w, https://ericdraken.com/files/youtube-advertising-cost-300x112.png 300w, https://ericdraken.com/files/youtube-advertising-cost-600x225.png 600w, https://static.ericdraken.com/files/youtube-advertising-cost.png 785w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/youtube-advertising-cost-754x282.png" data-srcset="https://ericdraken.com/files/youtube-advertising-cost-754x282.png 754w, https://ericdraken.com/files/youtube-advertising-cost-300x112.png 300w, https://ericdraken.com/files/youtube-advertising-cost-600x225.png 600w, https://static.ericdraken.com/files/youtube-advertising-cost.png 785w"></a><figcaption><a href="https://www.webfx.com/social-media/pricing/how-much-does-youtube-advertising-cost/" target="_blank" rel="nofollow">Source</a></figcaption></figure><p>Since ads are auctioned, the CPV (cost-per-view) varies. Also, many ad campaigns have a capped daily budget, so theoretically there should be fewer ads in the evenings as budgets run out during the day.</p><h3>Experiment in Ad Viewing</h3><p>I watched YouTube on and off for a day on a clean notebook computer with private browsing. My history showed that I only “watched” 10 videos:</p><ul><li>I fast-forwarded through a few of them to get past the “like and subscribe” runtime padding.</li><li>I jumped to the end of one just to get to the “top three” from a “top twenty” list.</li><li>Two were low quality so I left early.</li><li>The rest were music videos.</li></ul><p>In all, for watching parts of 10 videos, I was exposed to 8 ads, and only two were skippable (which I skipped).</p><h3>$0.15 as a Ballpark CPV</h3><p>Let’s use USD $0.15 as a CPV. In one day, let’s say, I incurred 8 x $0.15, or $1.20 to advertisers. Extrapolated to one month, that is roughly USD $36/mo. Do I really cost advertisers USD $36/mo for very casual YouTube viewing? That sounds terrible for advertisers.</p><h3>CPV from US Advertising Spend Divided by Total Views</h3><p>From <a href="https://www.statista.com/statistics/289658/youtube-global-net-advertising-revenues/" target="_blank" rel="nofollow">Statistica</a>, in 2019, US YouTube advertisers spent $15.1 billion dollars. Also in 2019, US residents had 916 billion views (<a href="#ad-spend">ref</a>). That works out to an average of $15.1B / 916B, or USD $0.0165 per view. Then for me, that is only USD 13 cents. Extrapolated to one month, I theoreticaly cost advertisers only USD $3.96/mo.</p><h3>Is YouTube Premium Worth It?</h3><p><a href="https://static.ericdraken.com/files/YouTube-Premium.png"><img src="https://static.ericdraken.com/files/YouTube-Premium-754x324.png" alt="YouTube Premium subscription fee as of Jan, 2022" width="754" height="324" srcset="https://static.ericdraken.com/files/YouTube-Premium-754x324.png 754w, https://static.ericdraken.com/files/YouTube-Premium-300x129.png 300w, https://ericdraken.com/files/YouTube-Premium-600x258.png 600w, https://static.ericdraken.com/files/YouTube-Premium.png 807w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/YouTube-Premium-754x324.png" data-srcset="https://static.ericdraken.com/files/YouTube-Premium-754x324.png 754w, https://static.ericdraken.com/files/YouTube-Premium-300x129.png 300w, https://ericdraken.com/files/YouTube-Premium-600x258.png 600w, https://static.ericdraken.com/files/YouTube-Premium.png 807w"></a></p><p>When I allowed ads for my experiment, I hit the hardware mute button. I also looked away because I have several computers with a lot going on. Ad spend is wasted on me, but I still want to support content creators. For me, CAD $13.48/mo is more than I incur on actual ads and more than I pay for a Netflix subscription. The only way to justify the cost is to have YouTube playing constantly in the background on a TV.</p><p>However, I truly enjoy a handful of creators, so I may start watching them in the background on non-stop play. Let’s give the three-month YouTube Premium trial a chance, and I will still be monitoring what they track about me.</p><figure id="attachment_5913"><a href="https://static.ericdraken.com/files/youtube-premium-traffic.png"><img src="https://ericdraken.com/files/youtube-premium-traffic-754x282.png" alt="YouTube Premium network traffic" width="754" height="282" srcset="https://ericdraken.com/files/youtube-premium-traffic-754x282.png 754w, https://static.ericdraken.com/files/youtube-premium-traffic-300x112.png 300w, https://ericdraken.com/files/youtube-premium-traffic-600x224.png 600w, https://static.ericdraken.com/files/youtube-premium-traffic.png 1503w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/youtube-premium-traffic-754x282.png" data-srcset="https://ericdraken.com/files/youtube-premium-traffic-754x282.png 754w, https://static.ericdraken.com/files/youtube-premium-traffic-300x112.png 300w, https://ericdraken.com/files/youtube-premium-traffic-600x224.png 600w, https://static.ericdraken.com/files/youtube-premium-traffic.png 1503w"></a><figcaption>YouTube Premium network traffic</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>DMCA, Sony, Viacom</h2><p>Recently I learned that due to abuses of the <a href="https://en.wikipedia.org/wiki/Digital_Millennium_Copyright_Act" target="_blank" rel="nofollow">DMCA Act of 1998</a>, YouTube content creators who make reaction videos and “easter egg” videos may have their videos claimed by big companies like Sony and Viacom. That means that from when a claim is made, all ad revenue goes to those big companies, and not even to the creators. That means in all likelihood I unknowingly may not even be supporting my favourite YouTube creators.</p><div><p><strong>Did you know?</strong> Many fair-use and video-game-commentary videos may have automated copyright claims against them, meaning that ad revenue goes to big companies with deep legal pockets and your favourite creators may get nothing, so more and more creators leave YouTube for Twitch.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Summary of Accomplishments</h2><p>I rarely give up, so this is an example of going into an extreme problem-solving mode to solve a fun problem loosely using cryptography and reverse engineering. In the end, a single byte turned it all around, so it was all worth it to come to an elegant and satisfying solution.</p><div><p><strong>Success:</strong> We were able to set up a hardware router from scratch, segment LANs into trusted and untrusted zones, set up traditional DNS adblocking, add a transparent MITM proxy, and ultimately block YouTube ads on networked Apple devices.</p><p>Note: This was a hard problem – now solved – so I am paying for YouTube Premium to give the CPU a rest.</p></div><p><a href="#top">Top ↩</a></p><hr> <hr><span itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemscope="" itemprop="mainEntityOfPage" itemtype="https://schema.org/WebPage" itemid="https://google.com/article"><meta itemprop="headline" content="Block YouTube Ads on AppleTV by Decrypting and Stripping Ads from Profobuf"><meta itemprop="articleBody" content="Apple TV and iPhone YouTube ads are not blocked by DNS adblockers (e.g. Pi-hole), so I heavily researched this and discovered a flaw in Protobuf that allows me to restrict YouTube ads on Apple TV and iOS by simply changing one byte in the Protobuf responses after decrypting HTTPS network traffic."><meta itemprop="description" content="Apple TV and iPhone YouTube ads are not blocked by DNS adblockers (e.g. Pi-hole), so I heavily researched this and discovered a flaw in Protobuf that allows me to restrict YouTube ads on Apple TV and iOS by simply changing one byte in the Protobuf responses after decrypting HTTPS network traffic."><span itemprop="image" itemscope="" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://ericdraken.com/files/pfsense-featured.png"><meta itemprop="width" content="150"><meta itemprop="height" content="50"></span><meta itemprop="datePublished" content="2022-01-6"><meta itemprop="dateModified" content="2022-06-9"><span itemprop="publisher" itemscope="" itemtype="https://schema.org/Organization"><span itemprop="logo" itemscope="" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://secure.gravatar.com/avatar/1b8450e7611d06cec2a2c3a6dcfc1b30?s=96&amp;d=mm&amp;r=g"><meta itemprop="width" content="32"><meta itemprop="height" content="32"></span><meta itemprop="name" content="Eric"></span></span></article></main></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Rhombus Language (215 pts)]]></title>
            <link>https://rhombus-lang.org</link>
            <guid>43394881</guid>
            <pubDate>Tue, 18 Mar 2025 01:37:19 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://rhombus-lang.org">https://rhombus-lang.org</a>, See on <a href="https://news.ycombinator.com/item?id=43394881">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><div><pre>
 
<a href="https://docs.racket-lang.org/rhombus-reference/class.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._class._rhombus/defn))">class</a> Rect<span>(</span>left, top, right, bottom<span>)</span>
                     
<a href="https://docs.racket-lang.org/rhombus-reference/ref-function.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._fun._rhombus/defn))">fun</a> area<span>(</span>r<span>)</span>:
  <a href="https://docs.racket-lang.org/rhombus-reference/Definitions.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._let._rhombus/defn))">let</a> w <a href="https://docs.racket-lang.org/rhombus-reference/Equality.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._~3d))">=</a> r<a href="https://docs.racket-lang.org/rhombus-reference/Dot.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._..))">.</a>right <a href="https://docs.racket-lang.org/rhombus-reference/Numbers.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._-))">-</a> r<a href="https://docs.racket-lang.org/rhombus-reference/Dot.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._..))">.</a>left
  <a href="https://docs.racket-lang.org/rhombus-reference/Definitions.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._let._rhombus/defn))">let</a> h <a href="https://docs.racket-lang.org/rhombus-reference/Equality.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._~3d))">=</a> r<a href="https://docs.racket-lang.org/rhombus-reference/Dot.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._..))">.</a>bottom <a href="https://docs.racket-lang.org/rhombus-reference/Numbers.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._-))">-</a> r<a href="https://docs.racket-lang.org/rhombus-reference/Dot.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._..))">.</a>top
  w<a href="https://docs.racket-lang.org/rhombus-reference/Numbers.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._*))">*</a>h
                                
area<span>(</span>Rect<span>(</span><span>0</span>, <span>0</span>, <span>10</span>, <span>5</span><span>)</span><span>)</span>

</pre></div>
<div><pre>
 
<a href="https://docs.racket-lang.org/rhombus-reference/class.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._class._rhombus/defn))">class</a> Rect<span>(</span>left, top, right, bottom<span>)</span>
                     
<a href="https://docs.racket-lang.org/rhombus-reference/ref-function.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._fun._rhombus/defn))">fun</a> rect_like_to_rect<span>(</span>v<span>)</span>:
  <a href="https://docs.racket-lang.org/rhombus-reference/Matching.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._match))">match</a> v
  | Rect<span>(</span><a href="https://docs.racket-lang.org/rhombus-reference/Matching.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core).__._rhombus/bind))">_</a>, <a href="https://docs.racket-lang.org/rhombus-reference/Matching.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core).__._rhombus/bind))">_</a>, <a href="https://docs.racket-lang.org/rhombus-reference/Matching.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core).__._rhombus/bind))">_</a>, <a href="https://docs.racket-lang.org/rhombus-reference/Matching.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core).__._rhombus/bind))">_</a><span>)</span>: v
  | <span>{</span><span>"LT"</span>: <span>[</span>l, t<span>]</span>, <span>"RB"</span>: <span>[</span>r, b<span>]</span><span>}</span>: Rect<span>(</span>l, t, r, b<span>)</span>
  | <span>{</span><span>"TL"</span>: <span>[</span>t, l<span>]</span>, <span>"RB"</span>: <span>[</span>b, r<span>]</span><span>}</span>: Rect<span>(</span>l, t, r, b<span>)</span>
                                
rect_like_to_rect<span>(</span><span>{</span><span>"TL"</span>: <span>[</span><span>0</span>, <span>2</span><span>]</span>, <span>"RB"</span>: <span>[</span><span>10</span>, <span>5</span><span>]</span><span>}</span><span>)</span>

rect_like_to_rect<span>(</span><span>{</span><span>"LT"</span>: <span>[</span><span>0</span>, <span>2</span><span>]</span>, <span>"RB"</span>: <span>[</span><span>10</span>, <span>5</span><span>]</span><span>}</span><span>)</span>

</pre></div>

<div><pre>
                     
<a href="https://docs.racket-lang.org/rhombus-reference/ref-function.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._fun._rhombus/defn))">fun</a> all_same<span>(</span><span>[</span>str0, str, <a href="https://docs.racket-lang.org/rhombus-reference/Repetitions.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._......._rhombus/bind))">...</a><span>]</span><span>)</span>:
  <a href="https://docs.racket-lang.org/rhombus-reference/Booleans.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._all))">all</a><span>(</span>str0 <a href="https://docs.racket-lang.org/rhombus-reference/Equality.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._~3d~3d))">==</a> str, <a href="https://docs.racket-lang.org/rhombus-reference/Repetitions.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._......))">...</a><span>)</span>
 
all_same<span>(</span><span>[</span><span>"hello"</span>, <span>"hello"</span>, <span>"hello"</span><span>]</span><span>)</span>

all_same<span>(</span><span>[</span><span>"hello"</span>, <span>"goodbye"</span>, <span>"hello"</span><span>]</span><span>)</span>

</pre></div>
<div><pre>
 
<a href="https://docs.racket-lang.org/rhombus-reference/class.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._class._rhombus/defn))">class</a> Posn<span>(</span>x, y<span>)</span>
 
<a href="https://docs.racket-lang.org/rhombus-reference/ref-function.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._fun._rhombus/defn))">fun</a> flip_all<span>(</span><span>[</span>Posn<span>(</span>x, y<span>)</span>, <a href="https://docs.racket-lang.org/rhombus-reference/Repetitions.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._......._rhombus/bind))">...</a><span>]</span><span>)</span>:
  <span>[</span>Posn<span>(</span>y, x<span>)</span>, <a href="https://docs.racket-lang.org/rhombus-reference/Repetitions.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._......))">...</a><span>]</span>
 
flip_all<span>(</span><span>[</span>Posn<span>(</span><span>1</span>, <span>2</span><span>)</span>, Posn<span>(</span><span>3</span>, <span>4</span><span>)</span><span>]</span><span>)</span>

flip_all<span>(</span><span>[</span>Posn<span>(</span><span>5</span>, <span>6</span><span>)</span><span>]</span><span>)</span>

</pre></div>
<div><pre>
 
<a href="https://docs.racket-lang.org/rhombus-reference/class.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._class._rhombus/defn))">class</a> Tree<span>(</span>val, children <a href="https://docs.racket-lang.org/rhombus-reference/Annotations.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._~3a~3a._rhombus/bind))">::</a> <a href="https://docs.racket-lang.org/rhombus-reference/Lists.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._.List._(.List..of._rhombus/annot)))">List.of</a><span>(</span>Tree<span>)</span><span>)</span>:
  <a href="https://docs.racket-lang.org/rhombus-reference/class.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._method._rhombus/class_clause))">method</a> flatten<span>(</span><span>)</span>: 
    <a href="https://docs.racket-lang.org/rhombus-reference/Iteration.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._for))">for</a> <a href="https://docs.racket-lang.org/rhombus-reference/Multiple_Values.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._fold._rhombus/reducer))">fold</a><span>(</span>lst = <span>[</span>val<span>]</span><span>)</span> <span>(</span>child <a href="https://docs.racket-lang.org/rhombus-reference/Membership_Tests.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._in))">in</a> children<span>)</span>:
      
      lst <a href="https://docs.racket-lang.org/rhombus-reference/Appendables.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._++))">++</a> child<a href="https://docs.racket-lang.org/rhombus-reference/Dot.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._..))">.</a>flatten<span>(</span><span>)</span>
 
Tree<span>(</span><span>1</span>, <span>[</span>Tree<span>(</span><span>2</span>, <span>[</span>Tree<span>(</span><span>4</span>, <span>[</span><span>]</span><span>)</span><span>]</span><span>)</span>,
         Tree<span>(</span><span>3</span>, <span>[</span>Tree<span>(</span><span>5</span>, <span>[</span><span>]</span><span>)</span><span>]</span><span>)</span><span>]</span><span>)</span>
  <a href="https://docs.racket-lang.org/rhombus-reference/Dot.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._..))">.</a>flatten<span>(</span><span>)</span> 
</pre></div>


<div><pre>
 
<a href="https://docs.racket-lang.org/rhombus-reference/class.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._class._rhombus/defn))">class</a> Rect<span>(</span>left, top, right, bottom<span>)</span>
 
<a href="https://docs.racket-lang.org/rhombus-meta/Binding_Macros.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core-meta)._bind._(bind..macro._rhombus/defn)))">bind.macro</a> <span>'</span>OriginRect<span>(</span><a href="https://docs.racket-lang.org/rhombus-reference/stxobj.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._~24))">$</a>right, <a href="https://docs.racket-lang.org/rhombus-reference/stxobj.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._~24))">$</a>bottom<span>)</span><span>'</span>:
  <span>'</span>Rect<span>(</span><span>0</span>, <span>0</span>, <a href="https://docs.racket-lang.org/rhombus-reference/stxobj.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._~24))">$</a>right, <a href="https://docs.racket-lang.org/rhombus-reference/stxobj.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._~24))">$</a>bottom<span>)</span><span>'</span>
 
<a href="https://docs.racket-lang.org/rhombus-reference/ref-function.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._fun._rhombus/defn))">fun</a> area<span>(</span>r<span>)</span>:
  <a href="https://docs.racket-lang.org/rhombus-reference/Matching.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._match))">match</a> r
  | OriginRect<span>(</span>r, b<span>)</span>: r<a href="https://docs.racket-lang.org/rhombus-reference/Numbers.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._*))">*</a>b
  | Rect<span>(</span>l, t, r, b<span>)</span>: <span>(</span>r<a href="https://docs.racket-lang.org/rhombus-reference/Numbers.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._-))">-</a>l<span>)</span><a href="https://docs.racket-lang.org/rhombus-reference/Numbers.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._*))">*</a><span>(</span>b<a href="https://docs.racket-lang.org/rhombus-reference/Numbers.html#(def._((submod._(lib._rhombus/private/amalgam..rkt)._core)._-))">-</a>t<span>)</span>
                      
area<span>(</span>Rect<span>(</span><span>0</span>, <span>0</span>, <span>10</span>, <span>5</span><span>)</span><span>)</span>

</pre></div>
</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[But how to get to that European cloud? (102 pts)]]></title>
            <link>https://berthub.eu/articles/posts/now-how-to-get-that-european-cloud/</link>
            <guid>43394087</guid>
            <pubDate>Mon, 17 Mar 2025 23:52:34 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://berthub.eu/articles/posts/now-how-to-get-that-european-cloud/">https://berthub.eu/articles/posts/now-how-to-get-that-european-cloud/</a>, See on <a href="https://news.ycombinator.com/item?id=43394087">Hacker News</a></p>
<div id="readability-page-1" class="page"><article>
  

  
  

  <div>
  <p>The very short version: It has now become clear that <a href="https://berthub.eu/articles/posts/you-can-no-longer-base-your-government-and-society-on-us-clouds/">European governments can no longer rely on American clouds</a>, and that we lack good and comprehensive alternatives. Market forces have <a href="https://berthub.eu/articles/posts/the-european-cloud-ladder/">failed to deliver a truly European cloud</a>, and businesses won’t naturally buy as yet unproven cloud services, even when adorned with a beautiful European 🇪🇺 flag, so for now nothing will happen.</p>
<p>This means it’s time for <em>industrial policy</em>, which requires politics to be proficient in “industry.” Such proficiency is the only way to develop policies and plans that don’t go off the rails (which, unfortunately, can happen in many ways).</p>
<p>With a coherent strategy (see below for a suggestion), governments and industry can rapidly improve the cloud situation, allowing Europe to once more manage its own services <a href="https://berthub.eu/articles/posts/communicating-without-musk-and-trump-cloud-kootwijk/">without American prying eyes</a> and without fearing the <a href="https://berthub.eu/articles/posts/servers-in-de-eu-eigen-sleutels-helpt-het/#wat-als-er-ruzie-is">consequences of sanctions &amp; transatlantic disputes</a>.</p>
<p>That concludes the short version.</p>
<blockquote>
<p>This page originates from a productive discussion on <a href="https://www.bnr.nl/podcast/de-technoloog/10568644/we-bouwen-ons-eigen-cloudbedrijf-in-tijden-van-trump">the BNR podcast <em>De Technoloog</em></a>, along with conversations with <a href="https://berthub.eu/articles/posts/digitale-soevereiniteit-rijksoverheid-13-februari-2025/">members of parliaments</a>, civil servants, and entrepreneurs. It is also written with knowledge of <a href="https://berthub.eu/articles/EuroStack_Initiative_Letter_14_March.pdf">this new letter about the EuroStack to the European Commission</a> (<a href="https://www.linkedin.com/posts/euro-stack_european-industry-support-for-eurostack-vision-activity-7307279544082706432-DTti?utm_source=share&amp;utm_medium=member_desktop&amp;rcm=ACoAAAAQ2LUB1m6uzl_IBhQqGcdDlgLy03aa7MU">LinkedIn post</a>).</p>
</blockquote>
<p>In the article <a href="https://berthub.eu/articles/posts/the-european-cloud-ladder/">“The (European) cloud ladder: from virtual server to MS 365”</a>, I outline what is and isn’t available in Europe. There are already plenty of components, at a sufficient scale, to build upon. We can start improving parts of the cloud almost immediately, and eventually develop something with capabilities comparable to AWS, Google, and Microsoft Azure. But it will take a decade of hard work.</p>
<p>Europe and the EU have overcome massive challenges before.</p>
<p>For example, at one point, it was unthinkable that we could operate without the American GPS system. Today, <em>every phone and every smartwatch</em> also uses the EU Galileo satellite system, and Galileo is now the best satellite navigation system in the world. It only cost €15 billion!</p>
<p>Similarly, we once had many separate aerospace and defense companies, but after more than 10 years of mergers and restructuring, <a href="https://en.wikipedia.org/wiki/History_of_Airbus">we got Airbus</a>, which now makes the best large aircraft in the world. That was once unimaginable too.</p>
<p>By now, almost everyone agrees that we need to <a href="https://berthub.eu/articles/posts/you-can-no-longer-base-your-government-and-society-on-us-clouds/">do something similar for “the cloud”—and take it even further: we also need European solutions for workplaces, word processors, and other office applications</a>.</p>
<p>Massive sums of money are already being discussed—tens to hundreds of billions of euros—so funding will be available one way or another. If we can <a href="https://ec.europa.eu/commission/presscorner/detail/sv/statement_25_673">spend €800 billion on defense</a>, we can do something for the cloud as well.</p>
<p>It’s also worth noting that Europe is full of technical talent, including the people who built much of the technology powering the major American cloud providers. The only issue? Much of that European talent is employed by American companies or working on open-source projects as a hobby in their attic (🙋‍♂️).</p>
<p>The question is: how do we combine talent and funding to create a better European cloud? Because <a href="https://berthub.eu/articles/posts/europe-must-invest-in-xyz/">we need to do more than just declare that Europe should invest in things</a>.</p>
<h2 id="governments--contracts">Governments &amp; Contracts</h2>
<p>Roughly speaking, governments <em>produce</em> almost nothing themselves—except for policy, and even that is sometimes outsourced (to lobbyists or consultants).</p>
<p>However, governments do commission vast amounts of roads, bridges, and other infrastructure projects. That’s already complex enough, but at least you have a fairly clear idea of what you want in advance, and there’s an industry that routinely delivers these kinds of projects.</p>
<p>Things get trickier with more complex projects full of surprises, such as <a href="https://nos.nl/artikel/2555536-verbouwing-binnenhof-duurt-weer-langer-2028-is-niet-haalbaar">the renovation of Dutch parliamentary estate het Binnenhof</a>. Sometimes, these projects spiral completely out of control. The most recent examples come from Germany, such as <a href="https://en.wikipedia.org/wiki/Berlin_Brandenburg_Airport#Construction_progress_and_issues">Berlin’s airport</a> or the <a href="https://de.wikipedia.org/wiki/Stuttgart_21">new Stuttgart train station</a>.</p>
<p>But all of this pales in comparison to the challenge of launching a new IT project. And this isn’t just a government problem—even if you know <em>exactly</em> what you want, <a href="https://en.wikipedia.org/wiki/Agile_software_development">the IT world has more or less given up</a>.
<em>“We can tell you what it will cost, when it will be finished, or what it will do. Pick at most two.”</em> Or, honestly, just one.</p>
<p>In practice, it often turns out that the project’s goals, purpose, or target audience are unclear, making everything even harder. In the Netherlands, the <a href="https://www.adviescollegeicttoetsing.nl/">Advisory Board for IT Assessment</a> is doing excellent work with research and recommendations—but their findings are almost always painful to read.</p>
<p>It would be fantastic if governments took a more hands-on approach to creating successful IT solutions again, but there’s a long way to go before they can regain the capability to do things in-house. Still, I’d be excited about that prospect.</p>
<h2 id="ordering-a-cloud">Ordering a Cloud</h2>
<p>The market hasn’t provided a solution, so governments must now figure out how to foster the creation of a functional cloud. As mentioned earlier, this problem can actually be broken down into smaller, manageable pieces—<a href="https://berthub.eu/articles/posts/taking-the-airbus-to-the-ikea-cloud/">we don’t need to build an entire Airbus or IKEA right away</a>.</p>
<p>For politicians and decision-makers, it’s tempting to see this as another Galileo: allocate €15 billion, and a consortium will build a cloud. The big political decision, then, is simply to fund it, which is doable in politics (for example, for “<a href="https://digital-strategy.ec.europa.eu/en/policies/ai-factories">AI factories</a>”).</p>
<p>But this approach won’t work because, unlike Galileo, there is no industry ready to deliver such a project (even though some companies like to pretend there is). And crucially, Galileo had a crystal-clear objective:  1) Deliver exactly what GPS offers. 2) Build on top of that with further innovation.</p>
<p>What we need across <a href="https://berthub.eu/articles/posts/the-european-cloud-ladder/">different layers of the cloud</a> is largely not <em>off the shelf</em>. It’s not just about servers and hardware—it requires <em>development</em>.</p>
<center>
<p><img loading="lazy" src="https://berthub.eu/articles/UI_Desgin.png"><br>
What you get if you ask an enterprise IT company to build you something. Source: <a href="https://www.spyvee.com/apple-ui-vs-google-ui-vs-your-companys-ui/">Eric Burke via spyvee.com</a></p>

</center>
<h2 id="learning-from-past-experiences">Learning from Past Experiences</h2>
<p>There are some lessons to be learned here. To develop Galileo, the EU was able to lean heavily on the European Space Agency (ESA). ESA has extensive experience in commissioning satellites and designing and testing massive projects. It costs a pretty penny, but the results are solid. Take, for example, the <a href="https://www.arianespace.com/news/ariane-6-performs-first-commercial-flight-with-successful-launch-of-cso-3-satellite/">Ariane 6 rocket</a>, which performed well in its first two launches <a href="https://www.youtube.com/watch?v=bvim4rsNHkQ">instead of exploding 17 times</a> before getting it right (though that approach can also work—it does accelerate innovation).</p>
<p>However, we don’t have a “Cloud ESA,” though we sometimes hope that <a href="https://www.tno.nl/nl/digitaal/data-sharing/gaia-europees-initiatief-digitale/">an organization like TNO could fill that role</a>.</p>
<blockquote>
<p>A persistent misconception is that you need to put tens of billions on the table upfront before you can “build a cloud.” That’s not true, you can start with much less and still create credible services. But an even bigger misconception: just because you spend billions doesn’t mean you’ll actually end up with something useful! In many cases, the money might just get <a href="https://berthub.eu/articles/posts/gaia-x-is-an-expensive-distraction/">burned up in endless meetings</a>.</p>
</blockquote>
<h2 id="what-about-subsidies">What About Subsidies?</h2>
<p>Another option is to make funding available through subsidies, which can work well for certain objectives. For example, subsidies have been highly effective in promoting home insulation and have helped the Netherlands become the world leader in solar panels per capita. Due to a policy oversight, the Netherlands has now installed the equivalent of nearly <a href="https://berthub.eu/articles/posts/the-gigantic-unregulated-power-plants-in-the-cloud/">50 nuclear power plants worth of solar panels</a>. This is a massive impact.</p>
<p>Europe has extensive experience in distributing R&amp;D subsidies. The <strong>massive</strong> Horizon Europe program allocates around <a href="https://en.wikipedia.org/wiki/Horizon_Europe">€15 billion per year</a> for this purpose. I’ve personally been a Horizon Europe reviewer for the European Commission, and I hate to say it, but this system is terrible for real innovation. You need to submit a highly detailed plan outlining exactly what you’re going to do, and deviating from that plan is an absolute bureaucratic nightmare. No true innovative entrepreneur wants to deal with this.</p>
<p>The ones who <em>do</em> want to deal with it are slow-moving consortia, staffed with entire floors of people who love defining and checking “work packages” full of “milestones.” These milestones get met, everyone is happy, the money is spent, and you end up with <em>something</em>. But chances are, it won’t actually solve the problem you set out to address. Some of the <a href="https://www.rvo.nl/subsidies-financiering/ipcei/cloud-infrastructuur-en-services-cis">IPCEI-CIS initiatives in the Netherlands</a> may also fall into this trap—though I sincerely hope they succeed.</p>
<p>And this brings us to a crucial point: if we want to build an innovative and modern cloud here, it <em>cannot</em> happen without <em>enthusiastic</em> programmers, developers, and entrepreneurs. <strong>There is no other way.</strong> And rigid, bureaucratic subsidies will never generate that enthusiasm.</p>
<blockquote>
<p>My former company, PowerDNS, went through a failed subsidy program in the early 2000s. It was a traumatic experience—being treated as a potential fraudster while trying to do your best. We barely made it out unscathed. It’s something you never forget.</p>
</blockquote>
<h2 id="smart-procurement">Smart Procurement?</h2>
<p>One major problem is that businesses and governments are <em>very</em> clear about <strong>not wanting to deal with new things</strong>. The <a href="https://www.bankinfosecurity.com/eu-commission-microsoft-appeal-edps-office-365-decision-a-25327">European Commission, for example, is currently in a ridiculous legal battle against its own privacy watchdog</a> just to keep using Microsoft 365. Or take the Dutch Ministry of the Interior, which shares the IP addresses of all its secret service job applicants with Google <a href="https://berthub.eu/tkconv/document.html?nummer=2025D07118">because it’s supposedly tens of thousands of euros per year cheaper than European alternatives</a>. These are strong signals.</p>
<p>Now, every entrepreneur knows that you have to develop products <a href="https://hbr.org/2011/08/henry-ford-never-said-the-fast">that customers don’t yet realize they need</a>. But you should at least be able to reasonably predict that they <em>will</em> need them in the future and they need to be open to trying something new.</p>
<p>And here’s a direct quote from the Dutch Ministry of Economic Affairs’ policy (<a href="https://berthub.eu/tkconv/document.html?nummer=2025D10933">as stated by the State Secretary of the Interior</a>):</p>
<blockquote>
<p>“There are no possibilities to award government contracts exclusively to European and/or Dutch companies. This is legally impossible due to obligations arising from the <a href="https://www.wto.org/english/tratop_e/gproc_e/gp_gpa_e.htm">(WTO) Government Procurement Agreement</a> and our trade agreements.”</p>
</blockquote>
<p>Well, that’s it then. If this is the stance, then European industry is given <em>zero</em> pathway to success. <em>“We’ll only buy from you once your products are the absolute best, according to our procurement standards.”</em> But during the early years of development, your products will <em>inevitably</em> have rough edges and won’t yet do <em>everything</em>. And they will certainly be more expensive, because we don’t allow European companies to get away with selling our data—<a href="https://mastodon.nl/@bert_hubert/114074678596980744">but somehow, American companies can</a>.</p>
<p>I actually doubt whether the minister is correct about this “Government Procurement Agreement.” It would have to be the United States that sues us at the WTO, and the U.S. itself no longer believes in the WTO. In fact, almost no one does anymore.</p>
<p>Despite all this, <em>smart procurement</em> could play a huge role. Governments are the largest purchasers of IT services across Europe. If done wisely, this could effectively signal to the market, entrepreneurs, and developers that their products are in demand. And the scale of government IT is so vast that there are plenty of projects where a (small) risk could be taken—projects that aren’t mission-critical 24/7 and aren’t overly complex.</p>
<p>It’s also possible to <em>procure solutions</em> for specific <em>gaps</em> in European digital services through targeted tenders, such as <a href="https://www.rvo.nl/onderwerpen/innovation-impact-challenge">this innovation challenge</a>:</p>
<ul>
<li><strong>Email is dominated globally by “free” services</strong> (Gmail, Outlook.com). These services are ultimately paid for by selling <em>us</em>. While paid email services exist in Europe, we now know that competing with “free” is nearly impossible. So, build a “Eumail” platform that provides free email to everyone. This probably should not need to be government-run, but the platform could be <em>commissioned</em> and funded to deliver top-tier services. Doing this properly might cost €100 million per year, but imagine the impact!</li>
<li><strong>A European anti-DDoS shield.</strong> This market is currently dominated by a small number of U.S. companies, which means they have visibility into our internet traffic. Some of these companies (like Cloudflare) even offer free services, leading to the same issue as above. <a href="https://www.nbip.nl/en/nawas/">We already have a great non-profit initiative</a>, but it could be expanded significantly.</li>
<li><strong>European governments currently broadcast press conferences via YouTube.</strong> It’s high time for a reliable, user-friendly “Eutube,” so that crucial public information doesn’t get sandwiched between conspiracy theorists. This is becoming an existential issue.</li>
<li><strong>All major web browsers are American, and largely controlled by Google.</strong> Firefox has a much bigger market share than most people realize (especially now that Chrome and Edge are blocking ad blockers). But Firefox, despite being open source, is <em>mostly funded by Google</em>! A great move would be to take over that funding and finance “fEUerfox” for 10 years, ensuring a browsing experience that doesn’t route everything through the U.S.</li>
<li><strong>The open-source ecosystem now largely depends on Microsoft GitHub,</strong> which is heavily AI-focused. And, once again, <em>free</em>. There is a <a href="https://en.wikipedia.org/wiki/Codeberg">European alternative</a>, but since it doesn’t monetize user data, it has limited resources and lacks many features. This could be funded for a <em>trivial</em> amount of money.</li>
<li><strong>Local media now rely overwhelmingly on Facebook (!!) for publishing and engaging with readers.</strong> Since <em>all</em> politics is local, it’s crucial that local journalism isn’t controlled by Meta. <a href="https://www.pubhubs.net/">There are existing initiatives</a>, but no viable business model. Fixing this would cost very little, yet the benefits would be enormous.</li>
<li><strong>Many national media organizations are completely dependent on Google Docs.</strong> Google Docs, on its own, isn’t as complex as the full MS-365 suite. There are already open-source alternatives that are <em>almost</em> good enough. A robust, public, alternative could allow media organizations to operate independently of U.S. surveillance.</li>
</ul>
<p>With a <em>series</em> of well-structured procurement contracts spread across Europe, we could massively accelerate the development of <em>better</em> European cloud services. Especially if these initiatives build on one another. But, as mentioned, it takes courage to prevent “smart procurement” from simply being won by Amazon, Google, and Microsoft.</p>
<p>As a suggestion for the minister: Procurement rules state that you <em>cannot</em> explicitly exclude any company (except on <em>national security</em> grounds). However, you <strong>can</strong> include criteria in your selection process. For example, requiring that vendors <strong>only</strong> fall under European surveillance laws. That’s a completely reasonable demand — and no U.S. (or U.S.-linked) company could ever comply.</p>
<p>With targeted contracts, the industry could, for example, collectively improve or further develop open-source products that are <a href="https://min.io/">essential</a> for large-scale <a href="https://www.keycloak.org/">cloud usage</a>. After all, everyone needs the same core functionality. A group like Germany’s <a href="https://www.sovereign.tech/">Sovereign Tech Agency</a> demonstrates how this can be done. The Dutch foundation <a href="https://nlnet.nl/NGI0/">NLnet</a> is also making great strides in this area.</p>
<p>The beauty of this kind of smart procurement is that it empowers <em>the market</em> to build great things, without requiring a rigid blueprint for <em>how</em> to do it. You don’t need a “Cloud ESA” for this. But you <em>can</em> strongly encourage valuable developments. And, with a billion euros, you could go a <em>very</em> long way.</p>
<h2 id="but-industrial-policy-isnt-easy">But Industrial Policy Isn’t Easy</h2>
<p>At the same time, this is industrial policy. For the past 50 years, that’s been a dirty word. But when the free market doesn’t deliver what you need, and private companies <em>won’t</em> solve it for you, then you <em>have</em> to do something.</p>
<p>If you want to engage in industrial policy, two things are critical:</p>
<ol>
<li><strong>You need a deep understanding of politics.</strong></li>
<li><strong>You need a deep understanding of industry.</strong></li>
</ol>
<p>And <em>that</em> is going to be a massive challenge.</p>
<p>At the highest levels of European governments, there are almost no (technical) experts. Worse still, it seems that these leadership circles <em>actively dislike</em> technology and would rather discuss other topics.</p>
<p>But this knowledge is essential. While it’s not a good idea to <a href="https://civitas.org.uk/press/governments-can-do-and-should-pick-winners/">try to “pick winners”</a>, recognizing quality (or the lack thereof) is absolutely crucial.</p>
<h2 id="the-european-cloud-industry-why-hasnt-it-taken-off">The European Cloud Industry: Why Hasn’t It Taken Off?</h2>
<p>The European cloud industry has struggled to take off, partly because existing players lacked the will or vision to compete effectively (among many other reasons). It’s tempting to place too much value on the ideas of the relatively most successful existing players, but it’s essential to understand why these companies haven’t broken through earlier.</p>

<center>
<p><img loading="lazy" src="https://berthub.eu/articles/clouds-marktaandeel.png"><br>
Not to be taken too seriously, but this is a roughly to-scale comparison of U.S. cloud providers versus European ones. Take a close look at the bottom right, near the “e” in Google.</p>
</center>  
<p>Additionally, there are many organizations in the market that convincingly claim to be the future. Unfortunately, heavy investment in PR often creates a better initial impression than heavy investment in technology. By now, I have a solid list of <em>timewasters</em> for anyone wondering whether an initiative is legitimate or just hot air (feel free to email me).</p>
<blockquote>
<p>I initially didn’t want to mention this, but several proofreaders spontaneously reported bad experiences, which I have also had myself. If you are approached by the company Arqiver or the “EU FED Cloud,” be aware that they did not leave a good impression on me at all.</p>
</blockquote>
<p>There are also <em>false prophets</em>—we all want quick solutions, and sometimes we get (too) excited about people who promise them. For example, in Germany, some claim they have <a href="https://www.arvato-systems.com/blog/delos-cloud-azure-service-portfolio">“made Microsoft’s cloud European” through SAP</a>. However, this turns out to be <a href="https://berthub.eu/articles/posts/servers-in-de-eu-eigen-sleutels-helpt-het/">not quite the case</a>. If the U.S. refuses to cooperate, they (by their own admission) would be <em>down</em> within a few months.</p>
<p>Amazon also claims they are <em>going to</em> do something similar, but <a href="https://aws.amazon.com/compliance/europe-digital-sovereignty/">they’ve been saying that for years</a>, and they conveniently avoid addressing <a href="https://aws.amazon.com/blogs/security/aws-digital-sovereignty-pledge-announcing-a-new-independent-sovereign-cloud-in-europe/">what happens in case of a conflict with the U.S.</a>. We should also be very cautious about believing in “saviors” like the Lidl Cloud, or even <a href="https://berthub.eu/articles/posts/communicating-without-musk-and-trump-cloud-kootwijk/">Cloud Kootwijk</a>. Seeing is believing.</p>
<p>Another risk factor is the confusion between <em>open</em>, <em>standardized</em>, and <em>autonomous</em>. Many hardcore technologists firmly believe that federated, open, standardized systems are the solution. And to some extent, they are right. But having such technologies available is only a <em>necessary</em> condition—it’s not a solution in itself. Just because the technical prerequisites are met doesn’t mean a market will automatically emerge.</p>
<p>Having standards for interchangeable services is a great thing because it enables choice. We don’t need a single <em>EU Cloud Airbus</em>! At the same time, a <em>profitable</em> business model must emerge—we can’t try to create a market where there’s no money to be made, because that market simply <em>won’t happen</em>.</p>
<p>Finally, there’s always the temptation to rely on large, established defense and IT companies that claim that <em>this time</em>, they can deliver something fresh and innovative. And sure, maybe they can. But these companies are fundamentally not designed for real innovation or rapid development. Moreover, we must question whether they even <em>want</em> to—virtually all major existing players are completely entangled with U.S. big tech. That’s a problem in itself. Even if we develop new software in Europe, we still need large companies that are willing to manage and integrate it.</p>
<p>Summarizing, industrial policy is not easy. It will only succeed if governments independently develop and retain <em>deep</em> knowledge of industry, allowing them to determine what works, what doesn’t, and which direction will lead to a stronger European cloud industry.</p>
<h2 id="open-source">Open Source</h2>
<p>Europe may not excel at commercialization, but we <em>are</em> good at collaboration (more on this later). Nearly every initiative aimed at “doing cloud better in Europe” revolves around open source, because that’s where we have a strong foundation. However, this won’t happen <em>automatically</em>.</p>
<p>The initiatives mentioned earlier—such as “Eumail” and “Eutube”—will deliver the best results if they are built on shared code, libraries, and infrastructure. That way, every euro invested benefits multiple projects simultaneously.</p>
<p><a href="https://berthub.eu/articles/posts/open-source-by-itself-is-no-alternative-for-big-tech/">At the same time, open source is not a solution in itself</a>. Successful IT services depend on robust support, training, integration, and reliable operations.</p>
<p>We also need to carefully consider how companies will actually make money. Our lovely European services should not be overshadowed by competitors who offer the same software but undercut us in pricing by <em>selling user data</em>.</p>
<p>As mentioned before, industrial policy is anything but simple—even when open source is part of the equation.</p>
<h2 id="other-options">Other Options</h2>
<p>To shake things up, we need to do things differently. As mentioned, Europe has a wealth of talent. The “American way” of creating successful new companies through risky startups is one approach. I’ve previously written about <a href="https://berthub.eu/articles/posts/is-europe-just-not-good-at-innovating/">why that approach doesn’t work well here</a>. We can’t just <em>play</em> Silicon Valley in Europe. And even in the U.S., that model mostly produces products that spy on users, flood everything with ads, and push unwanted AI. So, it’s not exactly the best model either. They can’t even seem to establish a basic bank that allows people to transfer money (!!) without requiring apps full of trackers for some reason.</p>
<p>So, what <em>can</em> we do? Earlier, I mentioned that traditional subsidies don’t drive innovation. In Germany, they’ve addressed this by creating <a href="https://sprind.org/en">SPRIND</a>, and I’m very enthusiastic about it (partly because they sometimes hire me as a reviewer, and also because the director was formerly the head of my old company, PowerDNS).</p>
<blockquote>
<p>“The Federal Agency for Breakthrough Innovation SPRIND invests in new groundbreaking technologies and topics that have the potential to fundamentally improve our lives.”</p>
</blockquote>
<p>Applying for support for your project is done via <a href="https://sprind.org/en/new-project">a very simple form</a>. Then, experts review the project <strong>and actively work with you to improve your proposal</strong>. After that, you give <a href="https://sprind.org/en/actions/your-project">a presentation</a>, and if all goes well, you receive funding. The goal is for the entire process to take 12 weeks. There have already been cases where scientists burst into tears upon simply being told that their work was good.</p>
<p>This almost sounds too good to be true, but in Germany, a country not exactly known for its dynamic government or flexible procedures, it’s working like a charm.</p>
<p>And unlike Silicon Valley, what works in Germany <em>can</em> be replicated elsewhere in Europe. We’re in a very similar situation. You could almost directly copy this and create a <em>Sprin-NL</em>.</p>
<h2 id="a-coherent-strategy">A Coherent Strategy</h2>
<p>This is just a blog post, but from the above, a <a href="https://www.managementboek.nl/boek/9781781256176/good-strategy-bad-strategy-richard-rumelt">coherent strategy</a> emerges:</p>
<ol>
<li>Clearly communicate that European privacy standards <em>will</em> eventually be enforced, making the use of U.S. cloud services increasingly uncertain—especially for <a href="https://www.dataprotection.ie/en/organisations/know-your-obligations/lawful-processing/special-category-data">sensitive personal data</a> (Article 9 GDPR).</li>
<li>Governments should actively signal a genuine willingness to do business <em>within</em> Europe. Be prepared to take a creative approach to procurement and use WTO GPA Article III exceptions for privacy and security (if not now, then when?). Also, recognize that the U.S. itself no longer believes in the WTO—so let’s not use WTO rules just to do them a favor!</li>
<li>Hire people within government agencies who have <em>deep</em> industry knowledge. That’s the only way to develop effective industrial policies. Also, start doing more projects <em>in-house</em> without relying on consultants or external procurement—nothing teaches you more than hands-on experience.</li>
<li>Work with experts to identify key cloud functionalities that <em>do not</em> yet have strong open-source implementations, then commission their development or improve existing software. Follow <a href="https://berthub.eu/articles/posts/manifest-big-tech-alternatieven/">these principles</a> to ensure the results are well-documented, secure, and easy to use. Germany’s <a href="https://www.sovereign.tech/">Sovereign Tech Agency</a> demonstrates how this can be done effectively.</li>
<li>At the EU level, commission the development of key services like “Eumail,” “Eutube,” and a European alternative to Google Docs. Encourage the use of software from point 4 and support providers that embrace these solutions.</li>
<li>Follow an “Airbus model”: use procurement policies to encourage the consolidation of the European industry—something made easier if the software from point 4 sees widespread adoption.</li>
<li>Take legal action based on point 1 to show that enforcement is serious.</li>
<li>Establish <em>Sprin-NL</em> or actively participate in a potential <em>Sprin-EU</em>.</li>
<li>In the event of a trade war, consider imposing import tariffs on U.S. cloud services.</li>
</ol>
<p>Some of these steps (such as points 3, 4, and 8) are good ideas regardless. Others only make sense as part of a broader, <em>coherent</em> package. For example, it wouldn’t make much sense to pursue legal action (point 7) to force companies to switch to alternative providers if those providers don’t yet exist.</p>
<h2 id="conclusion">Conclusion</h2>
<p>There are multiple ways to make progress. Governments can take a more hands-on approach, using smarter procurement strategies for standard IT needs as well as special initiatives like Eumail and Eutube. They can credibly signal their intention to start buying European open-source solutions again (and stop fighting legal battles that prevent them from doing so). Better-designed subsidies could help, or something like a <em>Sprin-NL</em> could be established.</p>
<p>In all likelihood, we need to do <em>all</em> of these things simultaneously. The urgency is high enough that we must bet on multiple strategies at once.</p>
<p>The common thread in all of this is that governments need much <em>deeper</em> technological expertise and must integrate that knowledge into policy-making. Because only with a strong understanding of industry can you implement <em>effective</em> industrial policy.</p>
<p>And if we do this well, we might just be able to create a European <em>Airbus</em> for our industry, building something meaningful by working together to elevate essential software to the next level or helping to consolidate key players.</p>
<p>This way, we can regain control and stand on our own feet again.</p>
<p>Good luck!</p>

</div>

  



</article></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Past and Present Futures of User Interface Design (195 pts)]]></title>
            <link>https://www.datagubbe.se/futui/</link>
            <guid>43393924</guid>
            <pubDate>Mon, 17 Mar 2025 23:35:02 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.datagubbe.se/futui/">https://www.datagubbe.se/futui/</a>, See on <a href="https://news.ycombinator.com/item?id=43393924">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>



<p><b>Revolutionizing the desktop since 1975</b></p>
<p><i>Spring 2025</i></p>

<p>
In 1968, Douglas Engelbart demonstrated a computer system called the oN-Line System, or NLS. The NLS is the source of a lot of computer firsts. Among other things, Engelbart showed video conferencing, collaborative text editing, embedded graphics, copying and pasting, and hypertext - all of it accessible through a mouse and keyboard. This event has since become known as <a href="https://www.youtube.com/watch?v=yJDv-zdhzMY">"The Mother of All Demos"</a>.
</p>

<p>
Recently, Amelia Wattenberger published <a href="https://wattenberger.com/thoughts/our-interfaces-have-lost-their-senses">an article with ideas about a possible future for user interfaces</a>.
In short, she asks for interfaces with more tactile "friction", praises multi-modality and suggest variations in both input devices and feedback options. We'll return to her text, but first, let's look at some other visions of future user interfaces.
</p>

<h3>Xerox Alto</h3>

<p>
<a href="https://www.datagubbe.se/futui/smalltalk-76.png"><img src="https://www.datagubbe.se/futui/smalltalk-76_crop.png" alt="A screenshot of Smalltalk-76, showing a paint program that looks a lot like MSPaint."></a>
<br>
<i>Smalltalk-76 (from 1976), displaying a paint program written in Smalltalk-76. It looks curiously like Microsoft Paint - or, more correctly, it's the other way around. Click the image to view the full version.</i>
</p>

<p>
The Xerox Alto wasn't as much a vision as an actual product. Inspired by Engelbart and others, a team of researchers at Xerox PARC set about creating computers for the office of the future. This resulted in the Alto, a machine that would probably be recognizable to a lot of present day computer users.
The Alto was the origin of Smalltalk, a programming language with its own GUI environment - the one that inspired Steve Jobs to commission the Lisa. Looking at that GUI now, it's baffling how little desktop interfaces have changed since then, almost 50 years ago.
</p>

<p>
<img src="https://www.datagubbe.se/futui/alto.jpg" alt="A man sitting in front of a Xerox Alto computer.">
<br>
<i>A man and his Alto. The screen was in portrait mode: Xerox was all about paper.</i>
</p>

<p>
<a href="https://www.youtube.com/watch?v=M0zgj2p7Ww4">In a commercial for the Alto</a>, we meet a man - some kind of upper middle management, presumably - going about his daily business. He works in a spacious private office and, using the Alto, he can read and send email and produce laser printouts. Eventually, the Alto conjures up a high resolution image of flowers. The man wonders why, and the computer replies - with text on screen - that it's the man's wedding anniversary. "I forgot," says the man, to which the Alto replies, "It's okay, we're only human."
</p>

<p>
Despite being a very advanced system for its time, the Alto was of course incapable of such banter - and yet, the commercial's producers saw fit to include it, in order to spice things up.
</p>


<h3>Sun Starfire</h3>

<p>
Commercials like that for the Alto always feel a bit stuffy and contrived. Upping the ante in several ways, <a href="https://www.youtube.com/watch?v=w9OKcKisUrY">Sun Microsystem's 1994 commercial for Starfire</a> (an imaginary future computer), is a cringe-filled orgy in stilty acting and terrible writing. The protagonist once more seems to be upper middle management, and she's working on a presentation of an electric car. <b><i>Future!</i></b> She also engages in a bunch of strange and/or morally questionable activities. We'll probably never know why the producers decided to give her a cold, or why she spends so much of her time spying on co-workers using the live CCTV function on her expensive computer. But I digress.
</p>

<p>
The commercial presents several concepts that - like in Engelbart's demo - are now commonplace. Tablet computers, video conferencing, touch screens, AI-augmented image and video editing, and instant scanning (today we'd probably just photograph the document with our smartphone). Granted, imminent mainstream adoption of such functions was fairly obvious in 1994.
</p>

<p>
<img src="https://www.datagubbe.se/futui/starfire.jpg" alt="A woman standing in front of a large, curved touchscreen. The screen wraps around the desk. A computer mouse is visible, but no keyboard.">
<br>
<i>A woman and her ginormous Starfire. Note the apparent lack of a keyboard. A mouse is present, however, despite the massive touchscreen.</i>
</p>

<p>
Our hero is working on her presentation in a grotesquely spacious private office, which is probably necessary considering the sheer size of the Starfire. Actually operating it includes a lot of swiping and tapping on its humongous screen - mixed with talking to it, of course.
</p>

<h3>The Office of the Future</h3>

<p>
There are many other, similar, visions of our digital future. Plenty of them include touch interfaces and speaking to our computers. In fact, many of these visions are curiously reminiscent of how computers work in Star Trek. There's some vague touch-type interface (LCARS), but you can also speak to the computer - which will reply in conversational English. And of course there's video conferencing.
</p>

<p>
<img src="https://www.datagubbe.se/futui/startrek3.jpg" alt="A still from an episode of Star Trek. Captain Janeway and some of her crew are using the LCARS computer interface. In the background, a video conference is going on.">
<br>
<i>Star Trek: The quintessential computer of the future. Touchy, talky and, er, video-y.</i>
</p>

<p>
Some of the more outlandish suggestions in the Starfire commercial (such as a roll of film slowly pouring a texture onto a 3D model) are clearly intended to raise eyebrows, rather than reflect actually working interfaces. Other concepts are recurring in visions of future UI:s, like giant touch displays and the constant desire to talk to our machines.
</p>

<p>
These suggestions also seem genuine, which brings us to Wattenberger's recent article.
</p>

<h3>Tactile computing</h3>

<p>
Wattenberger touches on some relevant issues, especially regarding the prevalence of touchscreens and their inherent lack of tactile feedback. Alas, I think the reasoning presented conflates a desire for "genuine" experiences with something that can be competitive in a global, mass market economy. The former doesn't necessarily <i>disappear</i> because of the latter, but "friction" isn't something that's going to sell a lot of software.
</p>

<p>
To riff of Wattenberger's own example: Most doughs aren't kneaded by humans. We have machines for that - even in our homes - and the majority of our bread is produced at an industrial scale. That doesn't mean we can't knead our own dough if we want to, or that an artisanal bakery can't do well in an affluent neighborhood.
</p>

<p>
Computers are successful not because they introduce friction, but because they <i>reduce</i> it. If friction was a selling point, we'd give up spreadsheet software today and go back to the tactile way - using paper worksheets.
</p>

<p>
We're still allowed to dream, of course. I <a href="https://www.datagubbe.se/cosy/">absolutely agree</a> that more aspects of everyday life should be more tactile than an unyielding flatscreen. Most of that already exists, in the form of actual push buttons, keyboards, joysticks, levers, sliders and turning knobs. It's a question of hardware rather than software. Which is where the harsh reality of capitalism comes in and ruins everything: if it's cheaper with a touchscreen, and at all feasible, it's going to be a touchscreen. Not just in regular smart devices, but in cars, elevators, coffee machines and stovetops as well. Given this, I'd rather we spent some energy on making those interfaces as good as humanly possible, instead of trying to reinvent things that already work well.
</p>

<p>
The interface suggestions made toward the end of the text is what usually crops up when talking about revolutionizing the way we work with computers: an infinite canvas and - harking back to both the Alto, Starfire and Star Trek - some voice control.
</p>

<h3>Design and Reality</h3>

<p>
The infinite canvas isn't bad, necessarily, but the unstructured sprawl of mixed information they often lead to seems to offer little value to the vast majority of computer users. When adding structure and bounds to the canvas, the idea does seem to appeal to a wider audience: spreadsheets are very popular. But there's a limited amount of spreadsheet-type tasks, and at some point we need a different kind of interface and another way to structure our data.
Wouter van Oortmerssen (of CryEngine and WebAssembly fame) released <a href="https://strlen.com/treesheets/">TreeSheets</a> some 16 years ago. While it's an interesting concept, it doesn't seem to have caught on.
</p>

<p>
Traits like structure and relationships also come into play when we work with information. We seem to need a mental model - a spatial psychological abstraction - of our data, to know from which angle to attack it. Such a model can be hard to build when everything exists in a vast 2D space without clear boundaries. That's where things like tree views, lists and grids come into play. Most users aren't performing the kind of work that lends itself to an infinite canvas, anyway: File an order, take the next call, file another one.
In short: if infinite canvases really were that great, I think we'd see a lot more of them.
</p>

<p>
Enormous computer screens, like that of the Starfire, are now cheaper than ever to buy. Touch technology is everywhere. Thankfully, manufacturers have realized that the combination is untenable: Imagine having to raise your arm to swipe, pinch and tap across an ultra-wide screen several times per minute. Touch works best on small surfaces, even if it <i>looks impressive</i> on a bigger screen. For a while, manufacturers wanted us to buy touchscreen laptops. I haven't seen one of those in the wild for several years now - but pure tablets are commonplace. It seems as if there is a keyboard and mouse around, we pick them over touch for most desktop-type tasks.
</p>

<p>
Voice control always adds a certain futuristic vibe to a demo. In reality, it seems we're stuck with several circumstances making it effectively pointless. Our best LLM:s are a far cry from the AI:s in Star Trek, but even for simpler tasks use cases appear limited. I work with developers and other IT professionals all day, hang out with similar people on my free time, ride a commute jam packed with project managing office dwellers, and regularly find myself in big cities - but I haven't heard a single "Hey, Siri" for years. Like with the scarcity of touchscreen laptops, I'm sure that means <i>something</i>.
</p>

<p>
Infinite canvases, laissez-faire touchscreens and voice control seem very <i>designer-y</i> to me. By that I mean they're reflecting how a graphical designer would like to work with a computer at certain points in their creative process.
</p>

<p>
But we shouldn't build entire paradigms, or even just individual interfaces, based on the assumption that everyone else is using computers the same way we ourselves do. Most people don't conceptualize graphic design ideas or freestyle pretend corporate presentations. Some are controlling an industrial process, editing a feature film, designing an airplane or writing code. Most, however, are probably filing a customer complaint, ordering food, booking a flight, or doing some accounting.
</p>
<p>
Some people have the luxury of working in their own, private offices - or at home. Most computer users don't. They're confined to open floor plan offices, hotel lobbies, bustling trading desks, loud workshops or busy stores. Most of them probably perform tasks where speaking - even if it had been in a quiet and solitary environment - is less efficient than typing, tapping or clicking.
</p>

<p>
The same goes for multi-sensory interfaces in general. Voice control have many apparent drawbacks, but so do UI:s with audio feedback. Ever been in an open floorplan office where people have audio notifications enabled when receiving a chat message? Welcome to hell.
</p>

<p>
Even in a spacious private office, audio signals can be annoying. They interfere with music, for example, which is something a lot of people use their computers for both at work and at home. Generally, relying on a single type of feedback is a bad UI idea: Apart from poor accessibility, it reduces the user's freedom to customize their working environment. Some, like me, are annoyed by sound. Others seem to love it, and others still <i>require it</i> if they're to use a computer at all.
</p>

<h3>The Actual Future</h3>

<p>
The desktop user interface is a mainstay of computing. Bread and butter, if you will. A pointer, icons, windows, menus and buttons, controlled using a keyboard and a mouse. Ingenious simplicity.
</p>

<p>
For almost half a century now, we haven't really managed to come up with something better, and that's not for lack of trying. This fact seems to annoy a lot of people looking for a problem to solve - which every so often leads to something rather silly. Removing scrollbars from desktop programs for example, only to realize that people then don't understand there's scrollable content, and then responding by <i>cooking up some other way of doing scrolling</i> instead of just reinstating scrollbars.
</p>

<p>
Blundering about like that isn't inventing a new paradigm, no matter what individual designers claim - it's just making an existing one worse. But is there a real new paradigm around the corner? Is the desktop going to disappear? I honestly don't know, but I sincerely doubt it. It's probably just going to get slightly worse in some aspects, and hopefully slightly better in others.
</p>

<p>
Truly new paradigms do appear from time to time, mostly out of necessity. The smartphone is a great example. It needs to pack a lot of different input methods into one tiny little surface, and touch is great for that. The results aren't always optimal, but they're good enough compromises, vastly improving the flexibility of such a small device.
</p>

<p>
To me, trying to reinvent the desktop experience feels a bit like complaining about steering wheels in cars. To others, it's a great opportunity to confuse <i>change</i> with <i>improvement</i> and <i>different</i> with <i>better</i>.
With that said, I'm on board with Wattenberger's wish for slightly more tactile computers. In fact, if I'm being honest, I'd probably want computers and computing to be more like it <i>actually</i> was in 1994, and much less like our current Starfirey world.
</p>

<p>
Since that's probably not going to happen, I instead urge UI designers to consider the powerful concepts of <i>consistency</i> and <i>familiarity</i> just a bit more often than they presently seem to do.
</p>


</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[GIMP 3.0 Released (1218 pts)]]></title>
            <link>https://testing.gimp.org/news/2025/03/16/gimp-3-0-released/</link>
            <guid>43393822</guid>
            <pubDate>Mon, 17 Mar 2025 23:25:53 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://testing.gimp.org/news/2025/03/16/gimp-3-0-released/">https://testing.gimp.org/news/2025/03/16/gimp-3-0-released/</a>, See on <a href="https://news.ycombinator.com/item?id=43393822">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
                    <p>At long last, the <strong>first release of <span>GIMP</span> 3.0 is here</strong>! This is the end result of
seven years of hard work by volunteer developers, designers, artists, and community members (for reference, <span>GIMP</span> 2.10 was first <a href="https://www.gimp.org/news/2018/04/27/gimp-2-10-0-released/">published in 2018</a>
and the initial development version of <span>GIMP</span> 3.0 was <a href="https://www.gimp.org/news/2020/11/06/gimp-2-99-2-released/">released in 2020</a>). With <span>GIMP</span> 3.0 you can do more than ever before, more easily, more&nbsp;quickly!</p>
<figure>
<img src="https://testing.gimp.org/news/2025/03/16/gimp-3-0-released/gimp-3.0-splash.jpg" alt="GIMP 3.0: splash screen by Sevenix">
<figcaption>
<em><span>GIMP</span> 3.0 splash screen, by Sevenix (<span>CC</span> by-sa 4.0)</em>
</figcaption>
</figure>

<p>While we can’t cover every single change in <span>GIMP</span> from 2.10, we want to highlight some of the biggest ones as you start exploring this new&nbsp;release.</p>
<h2 id="highlights">Highlights<a href="#highlights" title="Permanent link">¶</a></h2>
<ul>
<li>
<p>Need to tweak a filter you applied hours ago?
New in <span>GIMP</span> 3.0 is non-destructive editing for
most commonly-used filters. See the changes in
real time with on-canvas&nbsp;preview.</p>
</li>
<li>
<p>Exchange files with more applications, including
<span>BC7</span> <span>DDS</span> files as well as better <span>PSD</span> export and
many new&nbsp;formats.</p>
</li>
<li>
<p>Don’t know how big to make your drawing?
Simply set your paint tool to expand layers automatically as&nbsp;needed.</p>
</li>
<li>
<p>Making pro-quality text got easier, too. Style your text,
apply outlines, shadows, bevels, and more, and you can
still edit your text, change font and size,
and even tweak the style&nbsp;settings.</p>
</li>
<li>
<p>Organizing your layers has become much easier with the ability to
  select multiple items at once, move them or transform them all&nbsp;together!</p>
</li>
<li>
<p>Color Management was again improved, as our long-term project to make
  <span>GIMP</span> an advanced image editor for all&nbsp;usages.</p>
</li>
<li>
<p>Updated graphical toolkit (<span>GTK3</span>) for modern desktop&nbsp;usage.</p>
</li>
<li>
<p>New Wilber&nbsp;logo!</p>
</li>
</ul>
<figure>
<img src="https://testing.gimp.org/images/frontpage/wilber-big.png" alt="GIMP 3.0: Wilber logo by Aryeom">
<figcaption>
<em>New <span>GIMP</span> logo, Wilber, by Aryeom (<span>CC</span> by-sa 4.0)</em>
</figcaption>
</figure>

<h2 id="learn-more">Learn More<a href="#learn-more" title="Permanent link">¶</a></h2>
<p>We’ve prepared <a href="https://testing.gimp.org/release-notes/gimp-3.0.html">release notes</a> to go over all the changes, improvements, new features, and more. And if you’d like even more details, you can peruse the <a href="https://gitlab.gnome.org/GNOME/gimp/-/blob/master/NEWS"><span>NEWS</span></a> changelog for all 2.99 and 3.0 <span>RC</span>&nbsp;releases.</p>
<p>But to see it for yourself, you can get <span>GIMP</span> 3.0 directly from our <a href="https://www.gimp.org/downloads/">Downloads page</a> and try it&nbsp;out!</p>
<p><a href="https://testing.gimp.org/release-notes/gimp-3.0.html" title="GIMP 3.0.0 Release Notes">
    » <span>READ</span> <span>COMPLETE</span> <span>RELEASE</span> <span>NOTES</span>&nbsp;«
</a></p>
<h2 id="other-releases-in-gimpverse">Other Releases in GIMPVerse<a href="#other-releases-in-gimpverse" title="Permanent link">¶</a></h2>
<p>To accompany our release of <span>GIMP</span> 3.0.0, packagers should also be aware
that we&nbsp;released:</p>
<ul>
<li>babl 0.1.112 (<a href="https://download.gimp.org/babl/0.1/">tarball</a>)</li>
<li><span>GEGL</span> 0.4.56 (<a href="https://download.gimp.org/gegl/0.4/">tarball</a>)</li>
<li><span>GIMP</span> Manual 3.0.0 (<a href="https://download.gimp.org/gimp/help/">tarball</a> and
  <a href="https://download.gimp.org/gimp/help/windows/3.0/">Windows installers</a>)</li>
</ul>
<h2 id="enjoy-gimp-30">Enjoy <span>GIMP</span> 3.0!<a href="#enjoy-gimp-30" title="Permanent link">¶</a></h2>
<p><span>GIMP</span> 3.0 is a new milestone. The application is in active
development and if you think this is awesome, wait until
you see our plans for the&nbsp;future!</p>
<p>
  <span>
    <a href="https://testing.gimp.org/downloads/">
      Download <span>GIMP</span>&nbsp;3.0.0
    </a>
  </span>
</p>

<h2 id="support-gimp-development">Support <span>GIMP</span> development<a href="#support-gimp-development" title="Permanent link">¶</a></h2>
<p>Don’t forget you can <a href="https://www.gimp.org/donating/">donate and personally fund <span>GIMP</span> developers</a>, as a way to
give back and accelerate the development of <span>GIMP</span>. Community commitment helps the project to grow&nbsp;stronger!</p>
<p>
  <a href="https://www.gimp.org/donating/">
    <span>
    Support us by<br> <strong>Donating</strong>
    </span>
  </a>
</p>
                  </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Amazon plans to lay off 14,000 managerial positions to save $3.5B yearly (254 pts)]]></title>
            <link>https://techstartups.com/2025/03/17/amazon-to-lay-off-14000-managerial-positions-to-save-3-5-billion-annually/</link>
            <guid>43393079</guid>
            <pubDate>Mon, 17 Mar 2025 21:50:22 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://techstartups.com/2025/03/17/amazon-to-lay-off-14000-managerial-positions-to-save-3-5-billion-annually/">https://techstartups.com/2025/03/17/amazon-to-lay-off-14000-managerial-positions-to-save-3-5-billion-annually/</a>, See on <a href="https://news.ycombinator.com/item?id=43393079">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="post-95763">
	    
	    		    
	    	
			
			<hr><br>
			
						
			

	    
	    				
			    	    <p><img src="https://techstartups.com/wp-content/uploads/2024/02/Jeff-Bezos-sells-about-2-billion-of-Amazon-shares-960x565.jpg" alt="">
			    	    </p>
			
			
		    <div>
				
				<p data-pm-slice="1 1 []">Amazon is set to cut around 14,000 managerial positions by early 2025, aiming to save between $2.1 billion and $3.6 billion annually. This reduction marks a 13% drop in Amazon’s global management workforce, shrinking the number of managers from 105,770 to 91,936.</p>
<p>This move follows <a href="https://techstartups.com/2025/01/30/amazon-lays-off-employees-in-communications-and-sustainability-units-in-latest-round-of-cuts/" target="_blank" rel="noopener">recent layoffs</a> in Amazon’s communications and sustainability units, as the company pushes to streamline operations and restructure teams.</p>
<p>According to <a href="https://www.businessinsider.com/amazon-could-cut-managers-save-3-billion-analysts-2024-10" target="_blank" rel="noopener">Business Insider</a>, the<span> job cut is part of</span> CEO Andy Jassy’s strategy to simplify decision-making and speed up processes. Last month, Jassy announced plans to boost the ratio of individual contributors to managers by at least 15% by the end of the first quarter of 2025. He emphasized that reducing managerial layers would streamline operations and enable Amazon to make faster decisions without getting bogged down by bureaucracy.</p>
<p>In a note released Thursday, Morgan Stanley projected that Amazon’s plan could cut around 13,834 managerial roles by early next year, saving the company between $2.1 billion and $3.6 billion.&nbsp;The estimate is based on the assumption that managers make up 7% of Amazon’s workforce.</p>
<blockquote><p><em>“Morgan Stanley estimated that this effort could lead to the elimination of roughly 13,834 manager roles by early next year, resulting in cost savings of $2.1 billion to $3.6 billion,” Business Insider reported.</em></p></blockquote>
<p>As part of this plan, Amazon has launched a “bureaucracy tipline,” encouraging employees to flag inefficient procedures that slow down work. Managers have also been instructed to increase their direct reports, limit senior hires, and review pay structures to support the shift toward a leaner management model.</p>
<p>This layoff wave continues Amazon’s cost-cutting efforts that saw over 27,000 job cuts in 2022 and 2023. The company has also pulled back on projects that didn’t yield profits, including its “Try Before You Buy” clothing initiative and a speedy brick-and-mortar delivery service.</p>
<p>Amazon’s workforce saw significant growth during the pandemic, swelling to over 1.6 million by the end of 2021, up from 798,000 in late 2019. Although numbers have dipped since then, the company is still recalibrating its staffing needs.</p>
<p>Earlier this year, Amazon mandated that corporate employees return to the office five days a week. Some staff were asked to relocate to designated office hubs, prompting some to leave rather than move.</p>
<p>Management restructuring is another key part of Jassy’s approach, with efforts to reduce layers between employees and leadership.</p>
<p>This move places Amazon alongside other tech companies trimming their workforce. Layoffs.FYI, a site tracking job cuts in tech, <a href="https://layoffs.fyi/" target="_blank" rel="noopener">reports</a> that 81 tech companies have eliminated 22,692 jobs so far this year.</p>
				
				
				<hr>
				
							</div>

		    			<h5>Trending Now</h5>
			  	<div>
									<div>
														<p><a href="https://techstartups.com/2025/03/07/microsoft-is-plotting-a-future-without-openai/">
								    									    	<img src="https://techstartups.com/wp-content/uploads/2025/03/Moving-Away-700x466.jpg" alt="">
								    </a>
								</p>
														
							</div>
									<div>
														<p><a href="https://techstartups.com/2025/03/17/amazon-to-lay-off-14000-managerial-positions-to-save-3-5-billion-annually/">
								    									    	<img src="https://techstartups.com/wp-content/uploads/2024/02/Jeff-Bezos-sells-about-2-billion-of-Amazon-shares-700x466.jpg" alt="">
								    </a>
								</p>
														
							</div>
						  	</div>
						
						
						
						
						
						
	    </div></div>]]></description>
        </item>
    </channel>
</rss>