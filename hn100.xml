<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>HN100 - Readable Contents</title>
        <link>https://hn.algolia.com/api/v1/search_by_date?tags=%28story,poll%29&amp;numericFilters=points%3E100</link>
        <description>Uses Readability to add bodies to the RSS feed</description>
        <lastBuildDate>Sun, 27 Aug 2023 07:00:03 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[Block YouTube ads on AppleTV by decrypting and stripping ads from Profobuf (258 pts)]]></title>
            <link>https://ericdraken.com/pfsense-decrypt-ad-traffic/</link>
            <guid>37279109</guid>
            <pubDate>Sun, 27 Aug 2023 03:13:13 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://ericdraken.com/pfsense-decrypt-ad-traffic/">https://ericdraken.com/pfsense-decrypt-ad-traffic/</a>, See on <a href="https://news.ycombinator.com/item?id=37279109">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="page"><main id="main" role="main"><article id="post-5418"><p><a href="https://ericdraken.com/files/So-many-YouTube-ads.png"><img src="https://ericdraken.com/files/So-many-YouTube-ads-754x240.png" alt="So many ads" width="754" height="240" srcset="https://ericdraken.com/files/So-many-YouTube-ads.png 754w, https://ericdraken.com/files/So-many-YouTube-ads-300x95.png 300w, https://static.ericdraken.com/files/So-many-YouTube-ads-600x191.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/So-many-YouTube-ads-754x240.png" data-srcset="https://ericdraken.com/files/So-many-YouTube-ads.png 754w, https://ericdraken.com/files/So-many-YouTube-ads-300x95.png 300w, https://static.ericdraken.com/files/So-many-YouTube-ads-600x191.png 600w"></a></p><div><p><span>In a Nutshell</span></p><p>I discovered that putting a man-in-the-middle proxy between my Apple TV and the world lets me decrypt HTTPS traffic. From there, I can read the Protocol Buffer data Google uses to populate YouTube with ads. It is too CPU-intensive to decode Protobuf on the fly, so instead, I found a flaw in the Protobuf format which allows me to reliably change one byte to obliterate ads.</p><p>What follows is a reference guide for setting up a bare-metal network router to block malicious ads, obnoxious ads, tracking, clickbait, crypto-jackers, scam popups, Windows spying on you, etc. using blocklists to protect all networked devices.</p></div><hr><div><p><strong>Goal:</strong> Let’s build a cryptographically-strong router with FreeBSD and pfSense to completely block YouTube ads using a flaw in the Google Protocol Buffer format to completely block pre-roll, mid-roll, and end-roll YouTube ads on Apple TV and iPhones, network-wide.</p></div><div><p><strong>Disclaimer:</strong> I want to support content creators, so to be fair, after a few months of blocking YouTube ads, I am now paying for YouTube Premium; Just because I can break something, doesn’t mean I need to.</p></div><h2>Sections</h2><h3>Part 1 – Setup pfSense on Bare-Metal</h3><ol><li><a href="#why">Why block Ads and Behaviour Tracking?</a></li><li><a href="#hardware">Required Router Hardware</a></li><li><a href="#unboxing">Unboxing the Hardware</a></li><li><a href="#install">Install pfSense on Bare Metal</a></li><li><a href="#firstboot">First pfSense Boot</a></li><li><a href="#aes-ni">Enable the AES-NI Cryptographic Instruction</a></li><li><a href="#ramdisk">Enable RAM Disk</a></li><li><a href="#dashboard">Dashboard Widgets</a></li><li><a href="#pfblocker">Adblocking with pfBlockerNG</a></li><li><a href="#topology">Isolate LANs for Security</a></li><li><a href="#classb">Class B IPv4 172.31.1.0/24 Network for Untrusted Devices</a></li><li><a href="#firewall">Add Firewall Rules</a></li></ol><h3>Part 2 – Isolate Network LANs</h3><ol><li><a href="#untrusted-ap">Setup the Untrusted Wi-Fi AP</a></li><li><a href="#backups">Automatic pfSense Configuration Backups</a></li><li><a href="#bridge">Unable to Reach 172.31.1.x from 192.168.10.x</a></li><li><a href="#firmware">Replace Stock Firmware on the AC1200 Wi-Fi Access Point</a></li><li><a href="#r7000">Archer C5 v2 into the Refuse Bin, R7000 as the New Wi-Fi AP</a></li><li><a href="#wireless">Set up the Trusted Wireless Network</a></li><li><a href="#check">Network Devices Interconnectivity Check</a></li><li><a href="#sharing">Windows File Sharing Gotchas</a></li><li><a href="#psa">Public Service Announcement: Edge Browser</a></li></ol><h3>Part 3 – Setup DNS Adblocking</h3><ol><li><a href="#clickbait">Block Clickbait, Incessant Ads, and Dangerous Sites</a></li><li><a href="#trap-dns">Intercept all DNS Requests, Even to Hardcoded DNS Servers</a></li></ol><h3>Part 4 – Trick the YouTube Ad Algorithm</h3><ol><li><a href="#yt-ads">How to Restrict Apple TV YouTube Ads?</a></li><li><a href="#algo">Trick the YouTube Ad Algorithm Instead</a></li><li><a href="#ad-spend">Research into YouTube Advertizing Spend</a></li><li><a href="#new-goal-trick">New Goal: Convince YouTube I’m 70 and in Italy</a></li><li><a href="#route-vpn">Selectively Route Apple TV Over the VPN</a></li><li><a href="#route-youtube">Selectively Route Apple TV YouTube Traffic Over the VPN</a></li><li><a href="#gotcha-dns">Gotcha: DNS Race Condition</a></li><li><a href="#gotcha-403">Gotcha: Authentication Trouble, Forbidden 403 Error</a></li><li><a href="#gotcha-uk">Gotcha: YouTube is Now Showing UK Ads, Not Italian Ads</a></li><li><a href="#asn">Find a VPN Exit Node with no ASN Leak</a></li><li><a href="#dynamic-dns">Hijack Google Video DNS Queries</a></li><li><a href="#new-goal">New Goal: Programmatically add IPs to the Firewall Policy Rule</a></li><li><a href="#research-dns">Research Python Methods to Hijack DNS Queries</a><br>i. <a href="#rsync">Rsync Disk Backup</a><br>ii. <a href="#rest-api">Install pfSense REST API</a><br>iii. <a href="#unbound-python">Explore the Unbound Python Module</a></li><li><a href="#hijack-smoke">Smoke Test: A Python DNS Hijacking Script</a></li></ol><h3>Part 5 – Decrypt HTTPS Traffic</h3><ol><li><a href="#new-goal2">New Goal: Research and install a Squid-like proxy</a><br>i. <a href="#jailbreak">Fun fact: Jailbreaking iPhones in Japan</a></li><li><a href="#fake-ca">Install a Fake-but-Trusted CA Cert on Apple TV and iPhone?</a></li><li><a href="#squid">Experiment with Squid and SquidGuard</a></li><li><a href="#self-host">Self-Host the CA Certificate</a></li><li><a href="#bye-squid">Abandoning Squid: Too Slow, Too Heavy</a><br>i. <a href="#rsync-diff">Rsync Diff of Changes</a></li><li><a href="#mitmproxy">Install MITMProxy in a FreeBSD Jail</a></li><li><a href="#explore">Exploring MITMProxy</a></li><li><a href="#patch">Patch MITMProxy Source Code for Server SNI Interrogation</a></li></ol><h3>Part 6 – Intercept Apple TV and iOS YouTube Ads</h3><ol><li><a href="#smoke-block">Smoke Test: Intercept YouTube Ads with MITMProxy</a></li><li><a href="#ublock">Examine uBlock Origin Regex Patterns for Inspiration</a></li><li><a href="#alter-json">Surgically Alter the JSON Response to Remove Ads</a></li><li><a href="#protobuf">The iOS YouTube App Uses Protobuf, not JSON</a></li><li><a href="#timing">Timing Analysis to Detect Ad Videos?</a></li><li><a href="#decode-pb">Decode the YouTube Protobuf Responses</a></li><li><a href="#poly">Ad URL Polymorphism</a></li><li><a href="#smoke-proto">Smoke Test: Intercept and Decode Protobuf in Python</a><br>i. <a href="#pure-python">Pure Python Benchmarks</a><br>ii. <a href="#pure-cpp">Pure C++ Benchmarks</a></li><li><a href="#fuzzing">Fuzzing the YouTube Video Ad Responses</a></li><li><a href="#burp">Enter Burp Suite Tools for Penetration Testing</a></li><li><a href="#exfil">Exfil the Proto Schemas from the App, Cleanly?</a></li></ol><h3>Part 7 – Reverse-Engineer Protobuf Messages</h3><ol><li><a href="#deepdive">Hardcore Deep-Dive into Protobuf and Wire Format</a></li><li><a href="#protobuf-flaw">Exploit a Protobuf Flaw to Easily Remove All Ads by Changing One Byte</a></li><li><a href="#smoke-remove">Smoke Test: Remove Ads from Protobuf in O(n)-Time</a></li><li><a href="#analysis">Analysis of this Successful Adblocking Technique</a><br>i. <a href="#analysis-summary">Summary</a><br>ii. <a href="#analysis-timing">Timing Analysis</a><br>iii. <a href="#analysis-benefits">Knock-On Benefits</a><br>iv. <a href="#analysis-future">Future-Proof</a><br>v. <a href="#analysis-worried">Should Google be Worried?</a></li><li><a href="#script">The MITMProxy YouTube Adblocking Script</a></li></ol><h3>Part 8 – Summary</h3><ol><li><a href="#youtube-premium">YouTube Premium</a><br>i. <a href="#experiment">Experiment in Ad Viewing</a><br>ii. <a href="#cpv-15">$0.15 as a Ballpark CPV</a><br>iii. <a href="#cpv-1">CPV from US Advertising Spend Divided by Total Views</a><br>iv. <a href="#worth-it">Is YouTube Premium Worth It?</a></li><li><a href="#dmca">DMCA, Sony, Viacom</a></li><li><a href="#summary">Summary of Accomplishments</a></li></ol><hr><h2>Why block Malicious Ads and Behaviour Tracking?</h2><p>You are a valuable commodity that is bought and sold without your knowledge or consent. You will be tricked with clickbait, distracted with large ads, and enticed to leave the site you are on at every opportunity. Plus, everything you do online is being monitored so your habits and searches can be remarketed and sold over and over again for years.</p><p><a href="https://ericdraken.com/files/clickbait.png"><img src="https://ericdraken.com/files/clickbait-754x325.png" alt="clickbait" width="754" height="325" srcset="https://ericdraken.com/files/clickbait-754x325.png 754w, https://static.ericdraken.com/files/clickbait-300x129.png 300w, https://ericdraken.com/files/clickbait-600x259.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/clickbait-754x325.png" data-srcset="https://ericdraken.com/files/clickbait-754x325.png 754w, https://static.ericdraken.com/files/clickbait-300x129.png 300w, https://ericdraken.com/files/clickbait-600x259.png 600w"></a></p><p><strong>Privacy</strong> – Knowing what you like to watch and read, what phone you have, what you watch on Netflix, what you shop for, what you ask Alexa about, yout taste in music, etc. is <em>unbelievably</em> valuable to advertisers. Spying on people is such a big problem that Europe passed the <a href="https://en.wikipedia.org/wiki/General_Data_Protection_Regulation" target="_blank" rel="nofollow">GDPR law</a> so every site you visit asks if you are okay with cookies (and we blindly click “ok” to hide the banner). We must wrestle back privacy ourselves.</p><p><strong>Bandwidth</strong> – If privacy doesn’t concern you, how about this: it is well-known that between 25% and 40% of network traffic is ads, tracking, JavaScript to load trackers (<a href="https://github.com/fingerprintjs/fingerprintjs" target="_blank" rel="nofollow">fingerprint.js</a>, <a href="https://www.npmjs.com/package/@analytics/google-tag-manager" target="_blank" rel="nofollow">googletagmanager.js</a>), websocket traffic to collect how you scroll and what you type (<a href="https://www.hotjar.com/" target="_blank" rel="nofollow">Hotjar</a>), and the like. Do you have a 100 Mbps internet connection? Consider it 60 Mbps!</p><p><strong>Clickbait</strong> – Then there is clickbait. “You won’t believe what Tom Cruise did. He…” and you may want to click. Then you are in the spider’s web. How about fake news? Or articles that don’t say “sponsored” in size-8 font, but now say “underscored” to be clever. What is even real anymore? As soon as you click on clickbait, you may end up on a page with a dozen more ads that aren’t approved by Google but lead to a dark world of maliciousness. <strong>Clickbait is so incredibly profitable to scammers.</strong></p><p><strong>Cryptojacking</strong> – Some websites will load crypto-mining JavaScript (e.g. <a href="https://www.fortinet.com/blog/threat-research/the-growing-trend-of-coin-miner-javascript-infection" target="_blank" rel="nofollow">CoinHive.js</a>) so while you read, they overheat and abuse your computer to try to make a few pennies. Some sites will load JavaScript that tries to steal from your crypto wallet or trick you into transferring cryptocurrency.</p><div><p><strong>Takeaway:</strong> It is highly lucrative yet detrimental to you to track and trick you, and only <em>you</em> can do something about it.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Required Router Hardware</h2><p>A virtual machine, Docker image, or Raspberry Pi are not performant enough to protect a whole SMB network; We need dedicated hardware with a cryptographic instruction set so that its only function is to route, decrypt, and monitor packets in and out. Here is what I used.</p><ul><li>A mini PC with the AES-NI instruction set (e.g. J4125)</li><li>Several gigabytes of DDR4 RAM (e.g. 32 GiB)</li><li>A decent mSATA SSD drive (e.g. 128 GiB)</li><li>A USB drive to transfer pfSense</li></ul><p><a href="#top">Top ↩</a></p><hr><h2>Unboxing the Hardware</h2><p>I’ve ordered a mini J4125 PC from AliExpress, ordered 32 GB of DDR4 RAM and a 128 GB mSATA from Amazon, and will assemble them for the first time now.</p><div><p><strong>Warning:</strong> Out of caution, I searched diligently for a barebones mini PC that did not include RAM or an SSD; there is nothing stopping an overseas seller from including some generic RAM and SSD but charging Samsung prices.</p></div><div><p><strong>Tip:</strong> 128 GB of disk space on a router? Yup. That should be plenty of space to hold logs and not wear down the SSD too quickly, <strong>and</strong> to allow beautiful packet capture (and maybe an edge cache for NPM and Docker?).</p></div><p>A beautiful box, isn’t it? It only has 3 LAN ports, but it can be extended with network switches.</p><figure id="attachment_5543"><a href="https://static.ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC.jpg"><img src="https://static.ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-754x533.jpg" alt="The J4125 AES-NI quad-core fanless mini PC" width="754" height="533" srcset="https://static.ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-754x533.jpg 754w, https://static.ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-300x212.jpg 300w, https://ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-600x424.jpg 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-754x533.jpg" data-srcset="https://static.ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-754x533.jpg 754w, https://static.ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-300x212.jpg 300w, https://ericdraken.com/files/The-J4125-AES-NI-quad-core-fanless-mini-PC-600x424.jpg 600w"></a><figcaption>The J4125 AES-NI quad-core fanless mini PC</figcaption></figure><figure id="attachment_5544"><a href="https://static.ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC.jpg"><img src="https://ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-754x523.jpg" alt="The J4125 pfSense router from a fanless mini PC" width="754" height="523" srcset="https://ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-754x523.jpg 754w, https://static.ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-300x208.jpg 300w, https://ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-600x416.jpg 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-754x523.jpg" data-srcset="https://ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-754x523.jpg 754w, https://static.ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-300x208.jpg 300w, https://ericdraken.com/files/The-J4125-pfSense-router-from-a-fanless-mini-PC-600x416.jpg 600w"></a><figcaption>The pfSense router from a J4125 fanless mini PC</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Install pfSense on Bare Metal</h2><p>I’ve never used <a href="https://www.pfsense.org/getting-started/" target="_blank" rel="nofollow">pfSense</a> before, so we will explore this together. The compressed image is about 360 MB and can be flashed to a USB drive with an AppImage binary of Etcher (very cool). Decisions, decisions: VGA install or serial? Let’s serial into the new router. Why not?</p><figure id="attachment_5549"><a href="https://static.ericdraken.com/files/Lets-not-serial-into-the-router.jpg"><img src="https://static.ericdraken.com/files/Lets-not-serial-into-the-router-754x407.jpg" alt="Let's not serial into the router" width="754" height="407" srcset="https://static.ericdraken.com/files/Lets-not-serial-into-the-router-754x407.jpg 754w, https://ericdraken.com/files/Lets-not-serial-into-the-router-300x162.jpg 300w, https://static.ericdraken.com/files/Lets-not-serial-into-the-router-600x324.jpg 600w, https://static.ericdraken.com/files/Lets-not-serial-into-the-router.jpg 1066w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Lets-not-serial-into-the-router-754x407.jpg" data-srcset="https://static.ericdraken.com/files/Lets-not-serial-into-the-router-754x407.jpg 754w, https://ericdraken.com/files/Lets-not-serial-into-the-router-300x162.jpg 300w, https://static.ericdraken.com/files/Lets-not-serial-into-the-router-600x324.jpg 600w, https://static.ericdraken.com/files/Lets-not-serial-into-the-router.jpg 1066w"></a><figcaption>Let’s not serial into the router</figcaption></figure><p>Well, that looks painful. It would also be a whole production to serial into the box in case of an emergency because the serial port is inside, and there isn’t even an RS232 or JTAG connector – just some narrow header pins. Yikes. Let’s go with VGA and plug a keyboard into the USB port – get ready to navigate with arrows and tabs.</p><figure id="attachment_5552"><a href="https://static.ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable.jpg"><img src="https://static.ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-754x531.jpg" alt="J4125 mini PC BIOS over a VGA cable" width="754" height="531" srcset="https://static.ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-754x531.jpg 754w, https://static.ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-300x211.jpg 300w, https://ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-600x423.jpg 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-754x531.jpg" data-srcset="https://static.ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-754x531.jpg 754w, https://static.ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-300x211.jpg 300w, https://ericdraken.com/files/J4125-mini-PC-BIOS-over-a-VGA-cable-600x423.jpg 600w"></a><figcaption>J4125 mini PC BIOS over a VGA cable</figcaption></figure><p>I’ll follow this guide on <a href="https://www.youtube.com/watch?v=9kSZ1oM-4ZM" target="_blank" rel="nofollow">YouTube</a>. I’ll pass on encrypting the disk since I would like to avoid entering a passphrase each time the mini PC reboots. A stripe disk is fine since there is only one disk. I have no idea what to expect yet, so I will pass on dropping to a shell for a more advanced configuration.</p><p><a href="#top">Top ↩</a></p><hr><h2>First pfSense Boot</h2><p>I ejected the USB containing the boot image (important) and rebooted the little box. It played a melody on the internal speaker (there is an internal buzzer and thankfully it isn’t very loud).</p><p>Do I need to have a LAN connection already, or can I just start the thing? I’ll just start pfSense and let it complain to me if it wants… and according to the YouTube <a href="https://youtu.be/9kSZ1oM-4ZM?t=610" target="_blank" rel="nofollow">tutorial</a>, I should guess which port is LAN 1. I’ll do that now.</p><p>I figured out that I should set the LAN 1 to a static IP address that is not in my existing router’s DHCP range, so I went with <code>192.168.1.3</code>. Now I can access an admin web portal (<em>admin</em>/<em>pfsense</em>). Hooray.</p><p>Yikes, the mini PC beeped at me and informed me that ‘admin’ has logged in. That startled me a bit, but hey that is pretty neat.</p><figure id="attachment_5553"><a href="https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI.png"><img src="https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-754x500.png" alt="First time logging into pFsense admin UI" width="754" height="500" srcset="https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-754x500.png 754w, https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-300x199.png 300w, https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-600x398.png 600w, https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI.png 890w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-754x500.png" data-srcset="https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-754x500.png 754w, https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-300x199.png 300w, https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI-600x398.png 600w, https://ericdraken.com/files/First-time-logging-into-pFsense-admin-UI.png 890w"></a><figcaption>First time logging into pFsense admin UI</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Enable the AES-NI Cryptographic Instruction</h2><p>I played around with the wizard, used defaults, and got to the web configurator. The first thing that caught my eye was <code>AES-NI CPU Crypto: Yes (inactive)</code>. I went out of my way to get a mini PC with AES-NI. What gives?</p><p>Ah, this needs to be enabled in System &gt; Advanced &gt; Miscellaneous. Why not auto-detect this and use the best option? I’m glad I spotted that, or else this mini PC might as well be a Celeron J1900 of yesteryear.</p><p><a href="#top">Top ↩</a></p><hr><h2>Enable RAM Disk</h2><p>Having 32 GiB of RAM, let’s take advantage of that and use a generous amount of RAM for <code>/var</code> and <code>/tmp</code>, and since hopefully this 128 GiB SSD has wear levelling, let’s take a RAM Disk backup every hour.</p><figure id="attachment_5521"><a href="https://ericdraken.com/files/Lets-take-advantage-of-RAM-disk.png"><img src="https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-754x258.png" alt="Let's take advantage of RAM disk" width="754" height="258" srcset="https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-754x258.png 754w, https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-300x103.png 300w, https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-600x205.png 600w, https://ericdraken.com/files/Lets-take-advantage-of-RAM-disk.png 1149w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-754x258.png" data-srcset="https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-754x258.png 754w, https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-300x103.png 300w, https://static.ericdraken.com/files/Lets-take-advantage-of-RAM-disk-600x205.png 600w, https://ericdraken.com/files/Lets-take-advantage-of-RAM-disk.png 1149w"></a><figcaption>Let’s take advantage of RAM disk</figcaption></figure><p>Reboot! <code>AES-NI</code> is now active.</p><p><a href="#top">Top ↩</a></p><hr><h2>Dashboard Widgets</h2><p>This dashboard is pretty slick. I’m just discovering that there are widgets that can be added to the Dashboard, including S.M.A.R.T to alert us if the SSD is going bad. Nice.</p><figure id="attachment_5900"><a href="https://ericdraken.com/files/pfSense-dashboard.png"><img src="https://ericdraken.com/files/pfSense-dashboard-754x329.png" alt="Final pfSense dashboard after all setup" width="754" height="329" srcset="https://ericdraken.com/files/pfSense-dashboard-754x329.png 754w, https://static.ericdraken.com/files/pfSense-dashboard-300x131.png 300w, https://static.ericdraken.com/files/pfSense-dashboard-600x262.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/pfSense-dashboard-754x329.png" data-srcset="https://ericdraken.com/files/pfSense-dashboard-754x329.png 754w, https://static.ericdraken.com/files/pfSense-dashboard-300x131.png 300w, https://static.ericdraken.com/files/pfSense-dashboard-600x262.png 600w"></a><figcaption>Final pfSense dashboard after all setup</figcaption></figure><p>Hang on, when I added the Services Status widget, something called <code>PC/SC Smart Card Daemon</code> shows up. What is that? Research shows it’s a daemon for hardware smart keys that we can probably do without(?). It can be disabled in the <code>/etc/rc.bootup</code> file like so:</p><div id="crayon-63661eaabe474366916701" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>/</span><span>*</span><span> </span><span>pcscd </span><span>daemon </span><span>must </span><span>be </span><span>started </span><span>before </span><span>IPsec</span><span> </span><span>*</span><span>/</span></p><p><span>echo</span><span> </span><span>"SKIPPING PC/SC Smart Card Services..."</span><span>;</span></p><p><span># echo "Starting PC/SC Smart Card Services...";</span></p><p><span># mwexec_bg("/usr/local/sbin/pcscd");</span></p><p><span># echo "done.\n";</span></p></div></td></tr></tbody></table></div><p>Wait. After some time went by, I noticed the router slowed down, fatally.</p><figure id="attachment_5721"><a href="https://ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router.png"><img src="https://static.ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-754x475.png" alt="IPsec without the SD Card Service will cripple the router" width="754" height="475" srcset="https://static.ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-754x475.png 754w, https://ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-300x189.png 300w, https://static.ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-600x378.png 600w, https://ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router.png 923w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-754x475.png" data-srcset="https://static.ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-754x475.png 754w, https://ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-300x189.png 300w, https://static.ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router-600x378.png 600w, https://ericdraken.com/files/IPSec-without-the-SD-Card-Service-will-cripple-the-router.png 923w"></a><figcaption>IPsec without the SD Card Service will cripple the router</figcaption></figure><div><p><strong>Warning:</strong> Do NOT try to disable the Smart Card Service as it is needed by IPsec; if you start experimenting with an IPsec VPN tunnel and the <code>pcscd</code> daemon is disabled, then your hard disk will fill up with logs and your CPU will run hot.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Adblocking with pfBlockerNG</h2><p>This unboxing and setup has been fun, but I’d like to block all the bad traffic on my network. I’ve been using a workhorse of a DNS-level adblocker called <a href="https://ericdraken.com/block-malicious-ads-with-pi-hole/" target="_blank">Pi-Hole</a> on a… yes, Pi, but it would be nice if I can reclaim that wee bit of hardware for something else and use a comparable add-on module in pfSense. Let’s explore that now.</p><blockquote><p>pfBlockerNG is a very powerful package for pfSense® which provides advertisement and malicious content blocking along with geo-blocking capabilities.</p></blockquote><p>Question: Do I install the first <code>pfBlockerNG</code> or the <code>pfBlockerNG-devel</code> which feels like a developer version? I’m a software developer, so this is for me, but am I a pfSense developer? No. Maybe it will show me advanced logs or I can mess about with LUA? Let’s Google this.</p><p>From <a href="https://forum.netgate.com/topic/156604/pfblockerng-vs-pfblockerng-devel" target="_blank" rel="nofollow">here</a>, random people are saying to install the development version. Another <a href="https://linuxincluded.com/block-ads-malvertising-on-pfsense-using-pfblockerng-dnsbl/" target="_blank" rel="nofollow">blogger</a> advocates using the dev version as well. Meh, I guess we can install <code>jq</code>, <code>rsync</code>, and Python 3.8. This doesn’t <em>feel</em> like a development version since it has exciting dependencies.</p><figure id="attachment_5522"><a href="https://static.ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one.png"><img src="https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-754x428.png" alt="Install pfBlockerNG-devel not the other one" width="754" height="428" srcset="https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-754x428.png 754w, https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-300x170.png 300w, https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-600x341.png 600w, https://static.ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one.png 1144w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-754x428.png" data-srcset="https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-754x428.png 754w, https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-300x170.png 300w, https://ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one-600x341.png 600w, https://static.ericdraken.com/files/Install-pfBlockerNG-devel-not-the-other-one.png 1144w"></a><figcaption>Install pfBlockerNG-devel not the other one</figcaption></figure><p>That was painless and only added an extra 20 MiB. It seems a lot of the dependencies are part of pfSense already. The knight at the end of Raiders would say that I have chosen wisely (hey, why did Indy age like a normal person up to Indy 4 if he drank the immortality water that the thousand-year-old knight also drank?).</p><div id="crayon-63661eaabe47e463690482" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>New</span><span> </span><span>packages </span><span>to</span><span> </span><span>be </span><span>INSTALLED</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>gmp</span><span>:</span><span> </span><span>6.2.1</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>grepcidr</span><span>:</span><span> </span><span>2.0</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>iprange</span><span>:</span><span> </span><span>1.0.4</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>jq</span><span>:</span><span> </span><span>1.6</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>libmaxminddb</span><span>:</span><span> </span><span>1.6.0</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>lighttpd</span><span>:</span><span> </span><span>1.4.59</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>lua52</span><span>:</span><span> </span><span>5.2.4</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>nettle</span><span>:</span><span> </span><span>3.7.2_2</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>pfSense</span><span>-</span><span>pkg</span><span>-</span><span>pfBlockerNG</span><span>-</span><span>devel</span><span>:</span><span> </span><span>3.1.0</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>py38</span><span>-</span><span>maxminddb</span><span>:</span><span> </span><span>2.0.3</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>py38</span><span>-</span><span>sqlite3</span><span>:</span><span> </span><span>3.8.10_7</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>rsync</span><span>:</span><span> </span><span>3.2.3_1</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>whois</span><span>:</span><span> </span><span>5.5.7</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>xxhash</span><span>:</span><span> </span><span>0.8.0</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>zstd</span><span>:</span><span> </span><span>1.5.0</span><span> </span><span>[</span><span>pfSense</span><span>]</span></p></div></td></tr></tbody></table></div><p>Wizard time.</p><figure id="attachment_5523"><a href="https://static.ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one.png"><img src="https://static.ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-754x269.png" alt="The pfBlockerNG wizard had four steps but step three is like 50 steps in one" width="754" height="269" srcset="https://static.ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-754x269.png 754w, https://ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-300x107.png 300w, https://ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-600x214.png 600w, https://static.ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one.png 1151w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-754x269.png" data-srcset="https://static.ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-754x269.png 754w, https://ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-300x107.png 300w, https://ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one-600x214.png 600w, https://static.ericdraken.com/files/The-pfBlockerNG-wizard-had-four-steps-but-step-three-is-like-50-steps-in-one.png 1151w"></a><figcaption>The pfBlockerNG wizard had four steps but step three is like 50 steps in one</figcaption></figure><p>There are a lot of options in step three. This is not like Pi-hole at all. I’m going to <a href="https://www.youtube.com/watch?v=xizAeAqYde4" target="_blank" rel="nofollow">come back to this</a> and set up my network instead so I accomplish retiring my Nighthawk R700 or giving it new life as a Wi-Fi AP.</p><div><p><strong>Fix:</strong> If the <code>pfb_dnsbl</code> service won’t start or the status tab states <code>[ Missing CRON task ]</code>, try deleting the empty file <code>/var/run/booting</code> (<a href="https://www.reddit.com/r/pfBlockerNG/comments/9x5sid/pfb_dnsbl_service_will_not_start/" target="_blank" rel="nofollow">ref</a>).</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Isolate LANs for Security</h2><p>An opportunity has presented itself: I can create real networks on each of the three router Gigabit ports (not VLANs), and should I do so? Yes, yes I should. I would like a dedicated hardware network for all my home-phoning spy devices (Alexas and Apple TV) so they don’t flood my network with metrics info and “sure I’m muted and not listening to you” audio payloads back to their HQs.</p><p>I can see it now: A Wi-Fi AP on a hardware LAN that is isolated from everything else and dedicated to these gadgets, <strong>and</strong> runs through the adblocker <strong>and</strong> traps hard-coded DNS queries to <code>1.1.1.1</code> and <code>9.9.9.9</code> and others (I’ll have to explore this) so YouTube on my TV doesn’t sneakily bypass <del>Pi-Hole</del> any DNS-level blocker. It’s so Utopian an outcome I may not be able to sleep.</p><p>I’ve decided that my bottom-shelf TP-Link wireless router that is so old that <code>AC1200</code> might as well be “A.D. 1200” is going to be my Wi-Fi AP for those IoT spy devices.</p><p>In sum, there will be a dedicated hardware LAN</p><ul><li>with a wireless AP (AC1200) for Amazon/Apple gadgets and the TV.</li><li>with a wired switch for all the beefy computers and clusters in my lab.</li><li>with another wireless AP (R7000) just for iPhones and watches.</li></ul><p>As an aside, since doing an Offensive Security hacking course in my spare time, and I rare-earth-magnet-strongly suggest isolating Wi-Fi devices from any critical LAN segments connected to devices that touch daily banking or stock trading (or crypto wallets).</p><p><a href="#top">Top ↩</a></p><hr><h2>Class B IPv4 172.31.1.0/24 Network for Untrusted Devices</h2><p>The class B IPv4 range 172.16/16 is a valid range of private IP addresses. I’m not uncomfortable with Alexa and Apple TV being even on the same class network as my main LAN segment, so I will banish them to the class B private network at the hardware level, and my more trusted LANs will be on the traditional class C network (192.168/16). This helps mitigate any misconfigured <code>iptables</code> rules by naturally having no routes between the two networks.</p><figure id="attachment_5524"><a href="https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices.png"><img src="https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-754x371.png" alt="Set up a physical network for the untrusted smart devices" width="754" height="371" srcset="https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-754x371.png 754w, https://static.ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-300x148.png 300w, https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-600x295.png 600w, https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices.png 1146w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-754x371.png" data-srcset="https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-754x371.png 754w, https://static.ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-300x148.png 300w, https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices-600x295.png 600w, https://ericdraken.com/files/Set-up-a-physical-network-for-the-untrusted-smart-devices.png 1146w"></a><figcaption>Set up a physical network for the untrusted smart devices</figcaption></figure><p>Be sure to enable the DHCP resolver on the physical NIC that will connect smart devices (which mainly just tell me the weather and creepily listen to me sleep).</p><p>From this point, DHCP works on this new network, but by default, it assigns IP addresses but does <em>no</em> routing. All traffic is blocked by default.</p><p><a href="#top">Top ↩</a></p><hr><h2>Add Firewall Rules</h2><p>We need to manually add rules so traffic on the physical NICs goe somewhere.</p><figure id="attachment_5525"><a href="https://ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet.png"><img src="https://static.ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-754x252.png" alt="Our first rule to allow eth3 to access the Internet" width="754" height="252" srcset="https://static.ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-754x252.png 754w, https://ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-300x100.png 300w, https://ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-600x200.png 600w, https://ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet.png 1157w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-754x252.png" data-srcset="https://static.ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-754x252.png 754w, https://ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-300x100.png 300w, https://ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet-600x200.png 600w, https://ericdraken.com/files/Our-first-rule-to-allow-eth3-to-access-the-Internet.png 1157w"></a><figcaption>Our first rule to allow eth3 to access the Internet</figcaption></figure><p>There is a logging message. Let me reproduce it below.</p><blockquote><p>Hint: the firewall has limited local log space. Don’t turn on logging for everything.</p></blockquote><p>I read that to mean, “Congratulations on not cheaping out on your SSD. Now go forth and log everything, my son.”</p><p>I’m not a new-age, fancy-jazz, coloured-light- or smart-plug-controlling guy who forgot how to turn on a light without his phone, so I do not need to have smart devices on the same network as my phone (why create dozens of wireless attack vectors into your home?). I’m classicly trained to actuate an electromechanical current interrupter on the wall and light let there be.</p><p><a href="#top">Top ↩</a></p><hr><h2>Setup the Untrusted Wi-Fi AP</h2><p>How do I reach the admin UI of AC1200 Wi-Fi AP now? I factory reset it, plugged the WAN NIC into the ETH3 NIC of the pfSense router, but both devices are just blinking at me.</p><p>I suppose I can just Wi-Fi into the factory-reset AC1200. Yikes, 2016 was a bad year for responsive web UIs I take it. This is horrible; I’ll pull out a netbook for this. One sec.</p><p>It seems the Archer C5 has no AP Mode. This is my problem, not yours, but I’m still going to vent.</p><p>Oh, and the “refresh” icon on the top of the DCHP Leases page in pfSense is not “refresh”, but “reload service”. Whoops.</p><p>Well, I bricked the AC1200 router. I will have to run an Ethernet cable manually… but, wait, my thin notebook has no Ethernet ports and needs a USB-NIC adapter. Happy Friday.</p><div><p><strong>Tip:</strong> Connect LAN to LAN, not the AP’s WAN to pfSense’s LAN unless you want to do double NATing.</p></div><p>There were shenanigans, but I set the LAN IP of the AC1200 to <code>172.31.1.100</code>, the ETH3 NIC IP of the pfSense router to <code>172.31.1.1/24</code>, and set the pfSense DHCP service on ETH3 to assign addresses <code>172.31.1.101~150</code>. What <em>failed</em> was setting the AC1200 to <code>172.31.1.2</code> as it was unreachable (reason unknown). Oh yes, I had to turn off firewally things and <code>NAT Boost</code>, and basically drop the horsepower of this TP-Link router down to that of a potato battery. The above settings allow me to access the AC1200 remotely now.</p><p>The other video ran its course, so I started following this <a href="https://www.youtube.com/watch?v=FPgPHJvLmh0" target="_blank" rel="nofollow">YouTube video</a> (set the speed to 1.5x).</p><figure id="attachment_5526"><a href="https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads.jpg"><img src="https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-754x474.jpg" alt="There are some good tutorials on advanced pfSense... if you can sit through the ads" width="754" height="474" srcset="https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-754x474.jpg 754w, https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-300x189.jpg 300w, https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-600x377.jpg 600w, https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads.jpg 965w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-754x474.jpg" data-srcset="https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-754x474.jpg 754w, https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-300x189.jpg 300w, https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads-600x377.jpg 600w, https://ericdraken.com/files/There-are-some-good-tutorials-on-advanced-pfSense...-if-you-can-sit-through-the-ads.jpg 965w"></a><figcaption>There are some good tutorials on advanced pfSense… if you can sit through the ads</figcaption></figure><p>One more thing: I installed the <code>nmap</code> package for pfSense and scanned the AC1200 router, and found some sneaky ports open.</p><div id="crayon-63661eaabe487832563043" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>Running</span><span>:</span><span> </span><span>/</span><span>usr</span><span>/</span><span>local</span><span>/</span><span>bin</span><span>/</span><span>nmap</span><span>&nbsp;&nbsp;</span><span>-</span><span>sT</span><span> </span><span>-</span><span>P0</span><span> </span><span>-</span><span>e</span><span> </span><span>igb1</span><span> </span><span>'172.31.1.100'</span></p><p><span>Starting </span><span>Nmap</span><span> </span><span>7.91</span><span> </span><span>(</span><span> </span><span>https</span><span>:</span><span>/</span><span>/</span><span>nmap</span><span>.org</span><span> </span><span>)</span><span> </span><span>at</span><span> </span><span>2021</span><span>-</span><span>11</span><span>-</span><span>15</span><span> </span><span>17</span><span>:</span><span>40</span><span> </span><span>PST</span></p><p><span>Nmap </span><span>scan </span><span>report </span><span>for</span><span> </span><span>172.31.1.100</span></p><p><span>Host </span><span>is</span><span> </span><span>up</span><span> </span><span>(</span><span>0.0017s</span><span> </span><span>latency</span><span>)</span><span>.</span></p><p><span>Not</span><span> </span><span>shown</span><span>:</span><span> </span><span>969</span><span> </span><span>closed </span><span>ports</span><span>,</span><span> </span><span>28</span><span> </span><span>filtered </span><span>ports</span></p><p><span>PORT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>STATE </span><span>SERVICE</span></p><p><span>22</span><span>/</span><span>tcp&nbsp;&nbsp;&nbsp;&nbsp;</span><span>open&nbsp;&nbsp;</span><span>ssh</span></p><p><span>80</span><span>/</span><span>tcp&nbsp;&nbsp;&nbsp;&nbsp;</span><span>open&nbsp;&nbsp;</span><span>http</span></p><p><span>20005</span><span>/</span><span>tcp </span><span>open&nbsp;&nbsp;</span><span>btx</span></p></div></td></tr></tbody></table></div><p>Port <code>20005/tcp</code> is a print server port that I’ve now closed. However, the Archer C5 AC1200 is vulnerable to all kinds of Kali <a href="https://www.hackingtutorials.org/wifi-hacking-tutorials/tp-link-archer-c5-router-hacking/" target="_blank" rel="nofollow">mischief</a> so it was wise to put it on its own network. I’m not sure how to close port 22 and the <code>SSHd</code> service on it the AC1200 because the stock firmware is ancient and crippled, so I’ll just have to block port 22 on the whole LAN segment.</p><p>I’ve also taken care of disallowing private networks to ingress on the WAN (see the next section to set up DMZ).</p><p><a href="#top">Top ↩</a></p><hr><h2>Unable to Reach 172.31.1.x from 192.168.10.x</h2><p>Ping and Traceroute are aiding me in my efforts to connect to the AC1200 Wi-Fi AP from my <em>Trusted</em> LAN. I went ahead and added the subnet to the Symantec Firewall rules just in case (Symantec has its place now and then, but yes, definitely have available PC CPU horsepower to spare).</p><figure id="attachment_5529"><a href="https://static.ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet.png"><img src="https://static.ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-754x248.png" alt="Configure Symantec to allow the Untrusted subnet" width="754" height="248" srcset="https://static.ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-754x248.png 754w, https://ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-300x99.png 300w, https://ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-600x197.png 600w, https://static.ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet.png 940w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-754x248.png" data-srcset="https://static.ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-754x248.png 754w, https://ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-300x99.png 300w, https://ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet-600x197.png 600w, https://static.ericdraken.com/files/Configure-Symantec-to-allow-the-Untrusted-subnet.png 940w"></a><figcaption>Configure Symantec to allow the Untrusted subnet</figcaption></figure><p>Now, it seems ICMP packets are no longer blocked between networks, but I still cannot ping the AP web management UI even though I can see the pings in the traffic logs.</p><p>I’ve even added an “any to any” firewall rule on the Untrusted network. No change.</p><div><p><strong>Warning:</strong> If you run <code>nmap</code> as I did, software firewalls may detect a port scan and kick your network connection for an hour by default.</p><p><a href="https://ericdraken.com/files/Disable-Symantec-port-scan-detection.png"><img src="https://ericdraken.com/files/Disable-Symantec-port-scan-detection.png" alt="Disable Symantec port scan detection" width="474" height="647" srcset="https://ericdraken.com/files/Disable-Symantec-port-scan-detection.png 474w, https://static.ericdraken.com/files/Disable-Symantec-port-scan-detection-220x300.png 220w" sizes="(max-width: 474px) 100vw, 474px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Disable-Symantec-port-scan-detection.png" data-srcset="https://ericdraken.com/files/Disable-Symantec-port-scan-detection.png 474w, https://static.ericdraken.com/files/Disable-Symantec-port-scan-detection-220x300.png 220w"></a></p></div><p>Let’s try a stealth scan instead: <code>sudo nmap -sS -v 172.31.1.*</code>.</p><figure id="attachment_5530"><a href="https://ericdraken.com/files/I-think-a-port-scan-has-been-detected.png"><img src="https://ericdraken.com/files/I-think-a-port-scan-has-been-detected-754x319.png" alt="I think a port scan has been detected" width="754" height="319" srcset="https://ericdraken.com/files/I-think-a-port-scan-has-been-detected-754x319.png 754w, https://static.ericdraken.com/files/I-think-a-port-scan-has-been-detected-300x127.png 300w, https://ericdraken.com/files/I-think-a-port-scan-has-been-detected-600x254.png 600w, https://ericdraken.com/files/I-think-a-port-scan-has-been-detected.png 1069w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/I-think-a-port-scan-has-been-detected-754x319.png" data-srcset="https://ericdraken.com/files/I-think-a-port-scan-has-been-detected-754x319.png 754w, https://static.ericdraken.com/files/I-think-a-port-scan-has-been-detected-300x127.png 300w, https://ericdraken.com/files/I-think-a-port-scan-has-been-detected-600x254.png 600w, https://ericdraken.com/files/I-think-a-port-scan-has-been-detected.png 1069w"></a><figcaption>I think a port scan has still been detected</figcaption></figure><p>Nope, pfSense doesn’t like that at all. And, the whole network stopped working. Nice security! Also, dang.</p><p>The good news is that I’ve isolated the packet malaise to the TP-Link AC1200 box itself. I suspect that I need to add <code>net.ipv4.ip_forward=1</code> to forward packets with no addresses in them, but I’d need root access to the AC1200. Let’s burn it to the ground and rebuild from its sprinkler-soaked ashes.</p><p><a href="#top">Top ↩</a></p><hr><h2>Replace Stock Firmware on the AC1200 Wi-Fi Access Point</h2><p>Of course, I cannot actually stop Untrusted LAN devices from reaching the AC1200 as they all exist downstream from the pfSense box.</p><p>DD-WRT open-source router firmware, meet my ancient Archer C5 and do your thing.</p><figure id="attachment_5532"><a href="https://ericdraken.com/files/DD-WRT-supports-the-Archer-C5.png"><img src="https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-754x251.png" alt="DD-WRT supports the Archer C5" width="754" height="251" srcset="https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-754x251.png 754w, https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-300x100.png 300w, https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-600x199.png 600w, https://ericdraken.com/files/DD-WRT-supports-the-Archer-C5.png 954w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-754x251.png" data-srcset="https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-754x251.png 754w, https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-300x100.png 300w, https://static.ericdraken.com/files/DD-WRT-supports-the-Archer-C5-600x199.png 600w, https://ericdraken.com/files/DD-WRT-supports-the-Archer-C5.png 954w"></a><figcaption>DD-WRT supports the Archer C5</figcaption></figure><p>The Archer C5 did not accept the DD-WRT firmware. Hmm… how about OpenWRT?</p><figure id="attachment_5533"><a href="https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5.png"><img src="https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5-754x292.png" alt="OpenWRT supports the Archer C5" width="754" height="292" srcset="https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5-754x292.png 754w, https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5-300x116.png 300w, https://static.ericdraken.com/files/OpenWRT-supports-the-Archer-C5-600x232.png 600w, https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5.png 755w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5-754x292.png" data-srcset="https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5-754x292.png 754w, https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5-300x116.png 300w, https://static.ericdraken.com/files/OpenWRT-supports-the-Archer-C5-600x232.png 600w, https://ericdraken.com/files/OpenWRT-supports-the-Archer-C5.png 755w"></a><figcaption>OpenWRT supports the Archer C5</figcaption></figure><p>The Archer C5 did not accept the OpenWRT firmware either. What the actual facepalm (WTAF)?</p><p><strong>Wait.</strong> My hardware is revision 2 using the Broadcom chipsets which are notoriously difficult networking chips.</p><div><p><strong>Careful:</strong> Devices with Broadcom Wi-Fi chipsets have limited OpenWrt supportability (due to limited FLOSS driver availability for Broadcom chips). (REF: OpenWRT.org)</p></div><p>Alright, so OpenWRT, DD-WRT, and Tomato projects have no firmware for this AC1200 with unpopular Broadcom chipsets. Into the refuse bin it goes.</p><p><a href="#top">Top ↩</a></p><hr><h2>Archer C5 v2 into the Refuse Bin, R7000 as the New Wi-Fi AP</h2><p>I’ve dismantled the AC1200 so I do not forget why I threw it out. It’s too bad because it’s so pretty on the inside, and they always say, “It is what is inside that counts… except if you are a router with Broadcom chips.”</p><figure id="attachment_5534"><a href="https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips.jpg"><img src="https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-754x566.jpg" alt="Inside the Archer C5 v2 with Broadcom chips" width="754" height="566" srcset="https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-754x566.jpg 754w, https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-300x225.jpg 300w, https://ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-600x450.jpg 600w, https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips.jpg 1008w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-754x566.jpg" data-srcset="https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-754x566.jpg 754w, https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-300x225.jpg 300w, https://ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips-600x450.jpg 600w, https://static.ericdraken.com/files/Inside-the-Archer-C5-v2-with-Broadcom-chips.jpg 1008w"></a><figcaption>Inside the Archer C5 v2 with Broadcom chips</figcaption></figure><p>The R7000 is factory reset, and here is the first problem:</p><div><p><strong>Tip:</strong> On factory reset, the Nighthawk R7000 is pretty uptight about the format of the password. One rule is that no more than two identical consecutive characters are allowed. Well, thanks Netgear for pretty much providing a Regex to password crackers. Let’s disable all those rules with a few keystrokes to delete the JavaScript “blocking” the form submission. Now my admin password does not conform to the Regex and is super long. Muhahaha to Netgear password crackers.</p></div><p>The R7000 is in AP mode, but I can still access the pfSense web management page from the Untrusted network. Let’s lock down the web UI in pfSense under Firewall Rules.</p><figure id="attachment_5847"><a href="https://ericdraken.com/files/Untrusted-network-firewall-rules.png"><img src="https://static.ericdraken.com/files/Untrusted-network-firewall-rules-754x310.png" alt="Untrusted network firewall rules" width="754" height="310" srcset="https://static.ericdraken.com/files/Untrusted-network-firewall-rules-754x310.png 754w, https://ericdraken.com/files/Untrusted-network-firewall-rules-300x124.png 300w, https://static.ericdraken.com/files/Untrusted-network-firewall-rules-600x247.png 600w, https://ericdraken.com/files/Untrusted-network-firewall-rules.png 1156w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Untrusted-network-firewall-rules-754x310.png" data-srcset="https://static.ericdraken.com/files/Untrusted-network-firewall-rules-754x310.png 754w, https://ericdraken.com/files/Untrusted-network-firewall-rules-300x124.png 300w, https://static.ericdraken.com/files/Untrusted-network-firewall-rules-600x247.png 600w, https://ericdraken.com/files/Untrusted-network-firewall-rules.png 1156w"></a><figcaption>Untrusted network firewall rules</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Set up the Trusted Wireless Network</h2><p>The Untrusted network is now looking good. It’s time to make the <em>other</em> R7000 Nighthawk I have into a Wi-Fi AP as well so my phone and watch have a safe place to connect to, as well as a laptop when I want to RDP into my wired machines from the kitchen. I was saving that for a honeypot AP, but I can come back to that later.</p><p>Let’s see if I can Wi-Fi into the Wireless LAN’s R7000…</p><div><p><strong>Tip:</strong> Remember to physically unplug the pfSense upstream router from the R7000 because the R7000 is too helpful and will enter into AP mode by sensing any upstream routers, then you cannot get into the web UI anymore.</p></div><p>Since only my trusted devices should be on the Wireless LAN, I’ll turn off 2.4 GHz wi-fi because anything recent and wireless should support 5 GHz. That means those pesky AliExpress Pineapple wi-fi password stealers on the cheap side only use 2.4 GHz, so a neighbour is going to have to put in some effort to snoop on my network. Plus, 5 GHz is blocked more easily by walls and concrete, so I prefer it for averting medium-range snooping. But, I so am going to set up a honeypot and to brake check my faith in humanity.</p><p>It is normally straightforward to put a Wi-Fi router into AP mode by disabling WAN and DHCP.</p><p><a href="#top">Top ↩</a></p><hr><h2>Network Devices Interconnectivity Check</h2><p>Do all my dozens of computers, laptops, Pis, clusters, NAS drives, and the like still connect as before? Most important is my web-scraping bot in a hardened, RAIDed, dedicated machine with its own UPS. But alas, I cannot SSH into it even though the SSH handshake packets make it to the hefty box.</p><p>Could this be our old frienemy IPv4 forwarding being disabled? Possibly. I’m able to SSH into the machine from my iPhone (seriously) when on the same network.</p><p>Nope. Adding <code>net.ipv4.ip_forward = 1</code> in the right place with a restart did not yield joy.</p><p>According to <code>dmesg -w</code> (to tail <code>dmesg</code> logs), UFW (Uncomplicated Firewall) is not blocking ICMP requests or TCP requests on port 22. When I do something nutty like try to SSH on, say, port 23, then I can see the UFW block logs in <code>dmesg</code>. Confirmed: Packets can reach that machine.</p><p>Running <code>tcpdump src 192.168.10.100</code> where the IP is from the Trusted network on the target machine shows it <em>is</em> responding to pings. I’m even getting replies to SSH handshake requests. So now we know that <em>return</em> packets are being dropped. Interesting! Aside: <code>tcpdump</code> is awesome.</p><p>Let’s follow the trail. Digging a little deeper I see replies to ICMP and SSH handshakes are being sent to some IP over HTTPS that I do not recognize. Bizzare. When I run the usual <code>ipinfo</code> tools I see that <a href="https://ericdraken.com/ssh-using-real-ip-bypass-vpn/" target="_blank">replies are going over a VPN</a> that I completely forgot about. Ha. Replies to a different subnet are egressing over the VPN, but cannot return properly. Neat.</p><figure id="attachment_5438"><a href="https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter.png"><img src="https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-754x303.png" alt="VPN causes ACK packets to return over the wrong adapter" width="754" height="303" srcset="https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-754x303.png 754w, https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-300x121.png 300w, https://static.ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-600x241.png 600w, https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter.png 1056w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-754x303.png" data-srcset="https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-754x303.png 754w, https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-300x121.png 300w, https://static.ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter-600x241.png 600w, https://ericdraken.com/files/VPN-causes-ACK-packets-to-return-over-the-wrong-adapter.png 1056w"></a><figcaption>VPN causes ACK packets to return over the wrong adapter</figcaption></figure><p>Now that I remember what I did in 2019, I re-added NAT alias rules, and it’s showtime again.</p><p><a href="#top">Top ↩</a></p><hr><h2>Windows File Sharing Gotchas</h2><p>Your path may be smoother, but I’ve always seem to make the Trench Run instead of remote-piloting a handful of lead-filled X-Wings at light speed right <em>through</em> the Death Star’s reactor to make it go boom: the easy way.</p><p>I’ve added some rules to allow Static DHCP devices to talk to each other – Windows devices – but by default, the Private Network in the Windows Defender uses the local subnet as the rule scope. That means different subnets are isolated. We can’t just relax the pfSense DHCP subnet mask to say <code>192.168.20.0/16</code> because it conflicts with another subnet. Instead, just to get file sharing working, I relax the <code>scope</code> in Advanced Settings like below. Be sure to modify In and Out for SMB and ICMP.</p><figure id="attachment_5491"><a href="https://ericdraken.com/files/Windows-file-sharing-across-subnets.png"><img src="https://static.ericdraken.com/files/Windows-file-sharing-across-subnets-754x427.png" alt="Windows file sharing across subnets" width="754" height="427" srcset="https://static.ericdraken.com/files/Windows-file-sharing-across-subnets-754x427.png 754w, https://ericdraken.com/files/Windows-file-sharing-across-subnets-300x170.png 300w, https://static.ericdraken.com/files/Windows-file-sharing-across-subnets-600x340.png 600w, https://ericdraken.com/files/Windows-file-sharing-across-subnets.png 1496w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Windows-file-sharing-across-subnets-754x427.png" data-srcset="https://static.ericdraken.com/files/Windows-file-sharing-across-subnets-754x427.png 754w, https://ericdraken.com/files/Windows-file-sharing-across-subnets-300x170.png 300w, https://static.ericdraken.com/files/Windows-file-sharing-across-subnets-600x340.png 600w, https://ericdraken.com/files/Windows-file-sharing-across-subnets.png 1496w"></a><figcaption>Windows file sharing across subnets</figcaption></figure><p>Again, please add whatever subnets you desire instead of <code>any</code>.</p><p><a href="#top">Top ↩</a></p><hr><h2>Public Service Announcement: Edge Browser</h2><p>Why does the Microsoft Edge browser start automatically and run in the background, and why can’t I kill it when I <code>ctrl+alt+del</code>? If you’ve asked yourself this, you’re not alone. It turns out Edge starts up when you log in and it keeps running in the background. Here is the fix:</p><figure id="attachment_5540"><a href="https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser..png"><img src="https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-754x238.png" alt="Prevent Microsoft Edge from starting or running in the background. Sneaky browser." width="754" height="238" srcset="https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-754x238.png 754w, https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-300x95.png 300w, https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-600x190.png 600w, https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser..png 1214w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-754x238.png" data-srcset="https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-754x238.png 754w, https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-300x95.png 300w, https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser.-600x190.png 600w, https://ericdraken.com/files/Prevent-Microsoft-Edge-from-starting-or-running-in-the-background.-Sneaky-browser..png 1214w"></a><figcaption>Prevent Microsoft Edge from starting or running in the background. Sneaky browser.</figcaption></figure><p>I suggest downloading Winaero Tweaker and applying registry tweaks to cut down on the Redmond Spy Machine.</p><figure id="attachment_5565"><a href="https://ericdraken.com/files/Stop-Microsoft-from-spying-on-you.png"><img src="https://static.ericdraken.com/files/Stop-Microsoft-from-spying-on-you-754x454.png" alt="Stop Microsoft from spying on you" width="754" height="454" srcset="https://static.ericdraken.com/files/Stop-Microsoft-from-spying-on-you-754x454.png 754w, https://static.ericdraken.com/files/Stop-Microsoft-from-spying-on-you-300x181.png 300w, https://ericdraken.com/files/Stop-Microsoft-from-spying-on-you-600x361.png 600w, https://ericdraken.com/files/Stop-Microsoft-from-spying-on-you.png 899w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Stop-Microsoft-from-spying-on-you-754x454.png" data-srcset="https://static.ericdraken.com/files/Stop-Microsoft-from-spying-on-you-754x454.png 754w, https://static.ericdraken.com/files/Stop-Microsoft-from-spying-on-you-300x181.png 300w, https://ericdraken.com/files/Stop-Microsoft-from-spying-on-you-600x361.png 600w, https://ericdraken.com/files/Stop-Microsoft-from-spying-on-you.png 899w"></a><figcaption>Stop Microsoft from spying on you</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Block Clickbait, Endless Ads, and Dangerous Sites</h2><p>Thanks to web-browser and DNS-level adblockers (i.e. Pi-hole), it’s commonplace to block bad sites, crypto-miners, fingerprinters, trackers, remarketers, banners, pop-ups, fake tech-support scam alerts, and all manner of unscrupulousness designed to take advantage of you. Let’s take pfBlockerNG on pfSense for spin.</p><figure id="attachment_5429"><a href="https://static.ericdraken.com/files/pfBlockerNG-blocking-ad-domains.png"><img src="https://ericdraken.com/files/pfBlockerNG-blocking-ad-domains-754x282.png" alt="pfBlockerNG blocking ad domains with graphs" width="754" height="282" srcset="https://ericdraken.com/files/pfBlockerNG-blocking-ad-domains-754x282.png 754w, https://ericdraken.com/files/pfBlockerNG-blocking-ad-domains-300x112.png 300w, https://static.ericdraken.com/files/pfBlockerNG-blocking-ad-domains-600x224.png 600w, https://static.ericdraken.com/files/pfBlockerNG-blocking-ad-domains.png 1149w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/pfBlockerNG-blocking-ad-domains-754x282.png" data-srcset="https://ericdraken.com/files/pfBlockerNG-blocking-ad-domains-754x282.png 754w, https://ericdraken.com/files/pfBlockerNG-blocking-ad-domains-300x112.png 300w, https://static.ericdraken.com/files/pfBlockerNG-blocking-ad-domains-600x224.png 600w, https://static.ericdraken.com/files/pfBlockerNG-blocking-ad-domains.png 1149w"></a><figcaption>pfBlockerNG blocking ad domains with graphs</figcaption></figure><p>The pie chart looks great. I followed this <a href="https://tekgru.com/how-to-block-ads-on-pfsense-with-pfblockerng-and-dnsbl/" target="_blank" rel="nofollow">pfBlockerNG tutorial</a>.</p><figure id="attachment_5433"><a href="https://static.ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog.png"><img src="https://ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-754x396.png" alt="Tekgru.com pfBlockerNG tutorial blog" width="754" height="396" srcset="https://ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-754x396.png 754w, https://static.ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-300x157.png 300w, https://ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-600x315.png 600w, https://static.ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog.png 764w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-754x396.png" data-srcset="https://ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-754x396.png 754w, https://static.ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-300x157.png 300w, https://ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog-600x315.png 600w, https://static.ericdraken.com/files/Tekgru.com-pfBlockerNG-tutorial-blog.png 764w"></a><figcaption>Tekgru.com pfBlockerNG tutorial blog</figcaption></figure><p><strong><span>This is mportant:</span></strong> If you have multiple network interfaces (the mini PC has four), then you need to enable the Permit Firewall Rules for multiple interfaces and select them.</p><figure id="attachment_5434"><a href="https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces.png"><img src="https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-754x125.png" alt="DNSBL Perfmit Firewall Rules for multiple interfaces" width="754" height="125" srcset="https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-754x125.png 754w, https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-300x50.png 300w, https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-600x100.png 600w, https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces.png 1005w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-754x125.png" data-srcset="https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-754x125.png 754w, https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-300x50.png 300w, https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces-600x100.png 600w, https://ericdraken.com/files/DNSBL-Perfmit-Firewall-Rules-for-multiple-interfaces.png 1005w"></a><figcaption>DNSBL Perfmit Firewall Rules for multiple interfaces</figcaption></figure><p>Would you like to have discretion over blocklists? Let’s add a DNS blocklist related to gambling and reload pfBlockerNG to see if a poker site is blocked on the Trusted LAN.</p><figure id="attachment_5435"><a href="https://static.ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked.png"><img src="https://ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-754x187.png" alt="Some sketchy poker sites are now blocked" width="754" height="187" srcset="https://ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-754x187.png 754w, https://ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-300x74.png 300w, https://static.ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-600x148.png 600w, https://static.ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked.png 881w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-754x187.png" data-srcset="https://ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-754x187.png 754w, https://ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-300x74.png 300w, https://static.ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked-600x148.png 600w, https://static.ericdraken.com/files/Some-sketchy-poker-sites-are-now-blocked.png 881w"></a><figcaption>Some sketchy poker sites are now blocked</figcaption></figure><p>If you would prefer the connection to just close instead of rendering a PHP page, create a new PHP script with the following code and select it in the pfBlockerNG settings page:</p><div id="crayon-63661eaabe495363075859" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>&lt;?php</span></p><p><span># nano /usr/local/www/pfblockerng/www/killed.php</span></p><p><span>ignore_user_abort</span><span>(</span><span>true</span><span>)</span><span>;</span></p><p><span>fastcgi_finish_request</span><span>(</span><span>)</span><span>;</span></p></div></td></tr></tbody></table></div><p><a href="#top">Top ↩</a></p><hr><h2>Intercept All DNS Requests, Even to Hardcoded DNS Servers</h2><p>Let’s make sure all clients behind the pfSense router use the local Unbound DNS server so pfBlockerNG can act on them. We do not want apps and home assistants to bypass our DNS server, so we have to add some NAT rules.</p><figure id="attachment_5439"><a href="https://static.ericdraken.com/files/Trap-all-DNS-and-DNSTLS-requests.png"><img src="https://static.ericdraken.com/files/Trap-all-DNS-and-DNSTLS-requests.png" alt="Trap all DNS and DNS+TLS requests" width="563" height="316" srcset="https://static.ericdraken.com/files/Trap-all-DNS-and-DNSTLS-requests.png 563w, https://ericdraken.com/files/Trap-all-DNS-and-DNSTLS-requests-300x168.png 300w" sizes="(max-width: 563px) 100vw, 563px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Trap-all-DNS-and-DNSTLS-requests.png" data-srcset="https://static.ericdraken.com/files/Trap-all-DNS-and-DNSTLS-requests.png 563w, https://ericdraken.com/files/Trap-all-DNS-and-DNSTLS-requests-300x168.png 300w"></a><figcaption>Trap all DNS and DNS+TLS requests</figcaption></figure><p>First, we have to block DNS over TLS (for now) and only allow local DNS requests (note the rule order):</p><figure id="attachment_5655"><a href="https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries.png"><img src="https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-754x386.png" alt="Overarching DNS rules allowing only internal DNS queries" width="754" height="386" srcset="https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-754x386.png 754w, https://ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-300x154.png 300w, https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-600x307.png 600w, https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries.png 949w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-754x386.png" data-srcset="https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-754x386.png 754w, https://ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-300x154.png 300w, https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries-600x307.png 600w, https://static.ericdraken.com/files/Overarching-DNS-rules-allowing-only-internal-DNS-queries.png 949w"></a><figcaption>Overarching DNS rules allowing only internal DNS queries</figcaption></figure><div><p><strong>Note:</strong> DNS over TLS must be blocked (for now) for all clients behind the pfSense router in order to allow DNS query trapping to succeed. An iPhone may show a Privacy Warning that the network is blocking encrypted DNS traffic. That is okay because we are encrypting upstream DNS requests to Cloudflare.</p><p><a href="https://static.ericdraken.com/files/We-can-ignore-the-Privacy-Warning-in-devices-behind-the-pfSense-router.png"><img src="https://static.ericdraken.com/files/We-can-ignore-the-Privacy-Warning-in-devices-behind-the-pfSense-router.png" alt="We can ignore the Privacy Warning in devices behind the pfSense router" width="521" height="489" srcset="https://static.ericdraken.com/files/We-can-ignore-the-Privacy-Warning-in-devices-behind-the-pfSense-router.png 521w, https://ericdraken.com/files/We-can-ignore-the-Privacy-Warning-in-devices-behind-the-pfSense-router-300x282.png 300w" sizes="(max-width: 521px) 100vw, 521px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/We-can-ignore-the-Privacy-Warning-in-devices-behind-the-pfSense-router.png" data-srcset="https://static.ericdraken.com/files/We-can-ignore-the-Privacy-Warning-in-devices-behind-the-pfSense-router.png 521w, https://ericdraken.com/files/We-can-ignore-the-Privacy-Warning-in-devices-behind-the-pfSense-router-300x282.png 300w"></a></p></div><p>Here is a NAT rule for one interface. I started by making a rule for each interface except WAN (obviously) like this below.</p><figure id="attachment_5440"><a href="https://static.ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface.png"><img src="https://ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-754x739.png" alt="Example rule to trap DNS queries on a given interface" width="754" height="739" srcset="https://ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-754x739.png 754w, https://ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-300x294.png 300w, https://static.ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-600x588.png 600w, https://static.ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface.png 1031w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-754x739.png" data-srcset="https://ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-754x739.png 754w, https://ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-300x294.png 300w, https://static.ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface-600x588.png 600w, https://static.ericdraken.com/files/Example-rule-to-trap-DNS-queries-on-a-given-interface.png 1031w"></a><figcaption>Example rule to trap DNS queries on a given interface</figcaption></figure><div><p><strong>Tip:</strong> NAT reflection should be disabled so the wild Internet cannot access our DNS server.</p></div><p>To make life simpler, I made a firewall alias of all non-WAN interfaces called <code>Non_WAN</code>. Covering IPv4 and IPV6 to redirect local DNS queries on port 53 to localhost are the following redirect rules:</p><figure id="attachment_5660"><a href="https://ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost.png"><img src="https://ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-754x165.png" alt="Firewall DNS query redirect rules to localhost" width="754" height="165" srcset="https://ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-754x165.png 754w, https://static.ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-300x66.png 300w, https://static.ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-600x131.png 600w, https://ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost.png 945w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-754x165.png" data-srcset="https://ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-754x165.png 754w, https://static.ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-300x66.png 300w, https://static.ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost-600x131.png 600w, https://ericdraken.com/files/Firewall-DNS-query-redirect-rules-to-localhost.png 945w"></a><figcaption>Firewall DNS query redirect rules to localhost</figcaption></figure><p>Let’s also log trapped DNS requests. Head to the <code>Services &gt; DNS Resolver</code> page, click “Display Custom Options”, and add the lines:</p><p>Well, hello there, Microsoft Windows. What are you up to trying to reach Google Tag Manager? Naughty OS. That request is now black-holed to a non-existent IP at <code>10.10.10.1</code>.</p><figure id="attachment_5445"><a href="https://static.ericdraken.com/files/Windows-is-trying-to-reach-Google-Tag-Manager.png"><img src="https://static.ericdraken.com/files/Windows-is-trying-to-reach-Google-Tag-Manager.png" alt="Windows is trying to reach Google Tag Manager" width="439" height="476" srcset="https://static.ericdraken.com/files/Windows-is-trying-to-reach-Google-Tag-Manager.png 439w, https://static.ericdraken.com/files/Windows-is-trying-to-reach-Google-Tag-Manager-277x300.png 277w" sizes="(max-width: 439px) 100vw, 439px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Windows-is-trying-to-reach-Google-Tag-Manager.png" data-srcset="https://static.ericdraken.com/files/Windows-is-trying-to-reach-Google-Tag-Manager.png 439w, https://static.ericdraken.com/files/Windows-is-trying-to-reach-Google-Tag-Manager-277x300.png 277w"></a><figcaption>Windows is trying to reach Google Tag Manager</figcaption></figure><p>Let’s turn our attention to the TV and see how it fares under DNS interception.</p><p><a href="#top">Top ↩</a></p><hr><h2>How to Restrict Apple TV and iPhone YouTube Ads?</h2><div><p><strong>YouTube:</strong> Regarding YouTube, YouTube has been showing 7-second and 15-second ads, twice, back-to-back, nearly every few minutes. Why are the ads incessant and so long? I do not mind the occasional ad, similar to live TV, but these frequent ads would warrant FTC complaints it they were on live TV.</p></div><p>YouTube is tricky because ads are also videos that come from the same domain, so domain-name blockers like pfBlockerNG cannot act on them. The best pfBlockerNG and Pi-hole can do is block <code>googleadservices.com</code> only after you watch an ad video and click on the ad.</p><p>Many people opt to use a web browser like Firefox or Chrome with <a href="https://chrome.google.com/webstore/detail/ublock-origin/cjpalhdlnbpafiamejdnhcphjbkeiagm?hl=en" target="_blank" rel="nofollow">uBlock Origin</a> that acts on JavaScript as a workaround. It might be enough to watch YouTube on a web browser and stream that to a smart TV. However, we cannot restrict ads on the iPhone (without jailbreaking and compromising it).</p><p>What are our options? How can we safely restrict YouTube ads on all network devices?</p><p><a href="#top">Top ↩</a></p><hr><h2>Trick the YouTube Ad Algorithm Instead</h2><div><p><strong>Thought Experiment:</strong> Among friends, let’s say that English-speaking countries get ads for the most ridiculous things because their residents are assumed to have disposable income. Can we instead make YouTube think we are an undesirable advertising target?</p></div><p>What do ads in other parts of the world look like? Are those living in Antarctica or <a href="https://xkcd.com/713/" target="_blank" rel="nofollow">Low Earth Orbit</a> getting a lot of ads too?</p><figure id="attachment_5449"><a href="https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers.png"><img src="https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers.png" alt="Xkcd.com: Mess with advertisers" width="683" height="264" srcset="https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers.png 683w, https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers-300x116.png 300w, https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers-600x232.png 600w" sizes="(max-width: 683px) 100vw, 683px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers.png" data-srcset="https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers.png 683w, https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers-300x116.png 300w, https://static.ericdraken.com/files/Xkcd.com-Mess-with-advertisers-600x232.png 600w"></a><figcaption>Xkcd.com: Mess with advertisers</figcaption></figure><p>What would happen if we leverage the capabilities of this pfSense router to route YouTube Location Tracking information through a VPN that terminates in some remote part of the world with fewer YouTube viewers per capita? In other words, let’s make ourselves undesirable to advertisers and see if we get fewer ads.</p><figure id="attachment_5880"><a href="https://ericdraken.com/files/soured-the-milk.jpg"><img src="https://ericdraken.com/files/soured-the-milk.jpg" alt="Scotty from TNG episode 'Relics' understands the plan" width="620" height="448" srcset="https://ericdraken.com/files/soured-the-milk.jpg 620w, https://ericdraken.com/files/soured-the-milk-300x217.jpg 300w, https://ericdraken.com/files/soured-the-milk-600x434.jpg 600w" sizes="(max-width: 620px) 100vw, 620px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/soured-the-milk.jpg" data-srcset="https://ericdraken.com/files/soured-the-milk.jpg 620w, https://ericdraken.com/files/soured-the-milk-300x217.jpg 300w, https://ericdraken.com/files/soured-the-milk-600x434.jpg 600w"></a><figcaption>Scotty from TNG episode ‘Relics’ understands the plan</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Research into YouTube Advertizing Spend</h2><p>Let’s do some <a href="https://www.statista.com/statistics/272859/mobile-advertising-spending-worldwide/" rel="nofollow">YouTube demographics research</a> to find a part of the world avoided by advertisers.</p><figure id="attachment_5452"><a href="https://ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020.png"><img src="https://static.ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-754x427.png" alt="Mobile advertiser spend by country in 2020 (REF: statista.com)" width="754" height="427" srcset="https://static.ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-754x427.png 754w, https://static.ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-300x170.png 300w, https://ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-600x340.png 600w, https://ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020.png 1203w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-754x427.png" data-srcset="https://static.ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-754x427.png 754w, https://static.ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-300x170.png 300w, https://ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020-600x340.png 600w, https://ericdraken.com/files/Mobile-advertiser-spend-by-country-in-2020.png 1203w"></a><figcaption>Mobile advertiser spend by country in 2020</figcaption></figure><p>Let’s also check some <a href="https://medium.com/@ChannelMeter/youtubes-top-countries-47b0d26dded" target="_blank" rel="nofollow">YouTube statistics</a> about viewers by country for insights. Thinking about following some Reddit advice and VPN’ing into India? Think again.</p><figure id="attachment_5453"><a href="https://static.ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter.png"><img src="https://ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-754x425.png" alt="Total YouTube views by country in 2019 (REF: ChannelMeter)" width="754" height="425" srcset="https://ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-754x425.png 754w, https://static.ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-300x169.png 300w, https://ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-600x338.png 600w, https://static.ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter.png 1000w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-754x425.png" data-srcset="https://ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-754x425.png 754w, https://static.ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-300x169.png 300w, https://ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter-600x338.png 600w, https://static.ericdraken.com/files/Total-YouTube-views-by-country-in-2019-REF-ChannelMeter.png 1000w"></a><figcaption>Total YouTube views by country in 2019 (REF: ChannelMeter)</figcaption></figure><p>That was 2019. This is <a href="https://backlinko.com/youtube-users" target="_blank" rel="nofollow">2020</a>:</p><figure id="attachment_5454"><a href="https://ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_.png"><img src="https://ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_.png" alt="Top ten YouTube countries with population (REF: backlinko.com)" width="710" height="417" srcset="https://ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_.png 710w, https://ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_-300x176.png 300w, https://static.ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_-600x352.png 600w" sizes="(max-width: 710px) 100vw, 710px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_.png" data-srcset="https://ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_.png 710w, https://ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_-300x176.png 300w, https://static.ericdraken.com/files/Top-ten-YouTube-countries-with-population-REF-backlinko.com_-600x352.png 600w"></a><figcaption>Top ten YouTube countries with population (REF: backlinko.com)</figcaption></figure><p>I’m not a digital advertiser, but I can see that people in the UK and Canada watch a large number of videos per sitting. If I <em>were</em> an advertiser though, I’d pump those two countries with video ad after video ad because, statistically, those residents will take the eyeball kicking. All things being equal, I definitely need a VPN to terminate outside of Canada, the UK, and the United States (English-speaking countries) to enjoy YouTube more.</p><p>Does age play a factor? Who <strong>don’t</strong> advertisers want? I want to be that guy on paper.</p><figure id="attachment_5455"><a href="https://static.ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_.png"><img src="https://static.ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_.png" alt="YouTube age demographics as of 2020 (REF: backlinko.com)" width="710" height="176" srcset="https://static.ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_.png 710w, https://ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_-300x74.png 300w, https://static.ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_-600x149.png 600w" sizes="(max-width: 710px) 100vw, 710px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_.png" data-srcset="https://static.ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_.png 710w, https://ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_-300x74.png 300w, https://static.ericdraken.com/files/YouTube-age-demographics-as-of-2020-REF-backlinko.com_-600x149.png 600w"></a><figcaption>YouTube age demographics as of 2020 (REF: backlinko.com)</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><div><p><a name="new-goal-trick"></a><strong>New Goal:</strong> Let’s trick YouTube into believing I am a 70-year-old male living in Italy. Yes, that should definitely cut down on the Nespresso and Starbucks ads, at least.</p></div><p>How then to convince YouTube that I am a retired Sicilian living on a small chain island? I embellished that last part. Seventy and in Italy is sufficient.</p><p>Let’s do this. In the YouTube account…</p><figure id="attachment_5457"><a href="https://ericdraken.com/files/I-am-71-years-old.png"><img src="https://ericdraken.com/files/I-am-71-years-old.png" alt="I am 71 years old" width="601" height="516" srcset="https://ericdraken.com/files/I-am-71-years-old.png 601w, https://ericdraken.com/files/I-am-71-years-old-300x258.png 300w, https://ericdraken.com/files/I-am-71-years-old-600x515.png 600w" sizes="(max-width: 601px) 100vw, 601px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/I-am-71-years-old.png" data-srcset="https://ericdraken.com/files/I-am-71-years-old.png 601w, https://ericdraken.com/files/I-am-71-years-old-300x258.png 300w, https://ericdraken.com/files/I-am-71-years-old-600x515.png 600w"></a><figcaption>I am <del>Iron Man</del> 71 years old</figcaption></figure><figure id="attachment_5458"><a href="https://static.ericdraken.com/files/I-am-in-Italy.png"><img src="https://static.ericdraken.com/files/I-am-in-Italy.png" alt="I am in Italy" width="317" height="455" srcset="https://static.ericdraken.com/files/I-am-in-Italy.png 317w, https://ericdraken.com/files/I-am-in-Italy-209x300.png 209w" sizes="(max-width: 317px) 100vw, 317px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/I-am-in-Italy.png" data-srcset="https://static.ericdraken.com/files/I-am-in-Italy.png 317w, https://ericdraken.com/files/I-am-in-Italy-209x300.png 209w"></a><figcaption>I am in Italy</figcaption></figure><p>It is doubtful that this is all it takes for our goal. Let’s find a VPN exit point in Italy.</p><figure id="attachment_5459"><a href="https://ericdraken.com/out/nordvpn"><img src="https://ericdraken.com/files/NordVPN-has-60-servers-in-Italy-754x383.png" alt="NordVPN has 60+ servers in Italy" width="754" height="383" srcset="https://ericdraken.com/files/NordVPN-has-60-servers-in-Italy-754x383.png 754w, https://static.ericdraken.com/files/NordVPN-has-60-servers-in-Italy-300x153.png 300w, https://ericdraken.com/files/NordVPN-has-60-servers-in-Italy-600x305.png 600w, https://static.ericdraken.com/files/NordVPN-has-60-servers-in-Italy.png 1166w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/NordVPN-has-60-servers-in-Italy-754x383.png" data-srcset="https://ericdraken.com/files/NordVPN-has-60-servers-in-Italy-754x383.png 754w, https://static.ericdraken.com/files/NordVPN-has-60-servers-in-Italy-300x153.png 300w, https://ericdraken.com/files/NordVPN-has-60-servers-in-Italy-600x305.png 600w, https://static.ericdraken.com/files/NordVPN-has-60-servers-in-Italy.png 1166w"></a><figcaption>NordVPN has 60+ servers in Italy</figcaption></figure><p>Nice. <a href="https://ericdraken.com/out/nordvpn" target="_blank">NordVPN</a> has about 60 servers in Italy (that’s an affiliate link by the way).</p><p><a href="#top">Top ↩</a></p><hr><h2>Selectively Route Apple TV Over the VPN</h2><p>Let’s go through some tutorials to set up <em>OpenVPN</em> in pfSense. Just kidding! We’re going to use WireGuard – we have the Intel AES-NI crypto instruction set because we didn’t go cheap and get a yesteryear J1900 mini PC that sellers are trying to offload.</p><p>I’ll now install the FreeBSD WireGuard package.</p><figure id="attachment_5462"><a href="https://static.ericdraken.com/files/Install-the-WireGuard-package-in-pfSense.png"><img src="https://ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-754x328.png" alt="Install the WireGuard package in pfSense" width="754" height="328" srcset="https://ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-754x328.png 754w, https://static.ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-300x131.png 300w, https://static.ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-600x261.png 600w, https://static.ericdraken.com/files/Install-the-WireGuard-package-in-pfSense.png 1144w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-754x328.png" data-srcset="https://ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-754x328.png 754w, https://static.ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-300x131.png 300w, https://static.ericdraken.com/files/Install-the-WireGuard-package-in-pfSense-600x261.png 600w, https://static.ericdraken.com/files/Install-the-WireGuard-package-in-pfSense.png 1144w"></a><figcaption>Install the WireGuard package in pfSense</figcaption></figure><p>Next, add a tunnel and enable it. According to this <a href="https://www.reddit.com/r/PFSENSE/comments/m0989o/nordvpn_wireguard_setup_works/" target="_blank" rel="nofollow">thread</a> and this <a href="https://www.reddit.com/r/PFSENSE/comments/m0989o/nordvpn_wireguard_setup_works/" target="_blank" rel="nofollow">thread</a> on Reddit, we need to get some information for WireGuard and NordLynx from a sacrificial Linux VM to transpose the settings (i.e. private key) to the pfSense router. No problem.</p><figure id="attachment_5463"><a href="https://ericdraken.com/files/Connect-to-Italy-over-WireGuard.png"><img src="https://ericdraken.com/files/Connect-to-Italy-over-WireGuard.png" alt="Connect to Italy over WireGuard" width="547" height="85" srcset="https://ericdraken.com/files/Connect-to-Italy-over-WireGuard.png 547w, https://static.ericdraken.com/files/Connect-to-Italy-over-WireGuard-300x47.png 300w" sizes="(max-width: 547px) 100vw, 547px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Connect-to-Italy-over-WireGuard.png" data-srcset="https://ericdraken.com/files/Connect-to-Italy-over-WireGuard.png 547w, https://static.ericdraken.com/files/Connect-to-Italy-over-WireGuard-300x47.png 300w"></a><figcaption>Connect to Italy over WireGuard</figcaption></figure><figure id="attachment_5464"><a href="https://static.ericdraken.com/files/WireGuard-config-information-via-wg-show.png"><img src="https://static.ericdraken.com/files/WireGuard-config-information-via-wg-show.png" alt="WireGuard config information via wg show" width="608" height="233" srcset="https://static.ericdraken.com/files/WireGuard-config-information-via-wg-show.png 608w, https://static.ericdraken.com/files/WireGuard-config-information-via-wg-show-300x115.png 300w, https://ericdraken.com/files/WireGuard-config-information-via-wg-show-600x230.png 600w" sizes="(max-width: 608px) 100vw, 608px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/WireGuard-config-information-via-wg-show.png" data-srcset="https://static.ericdraken.com/files/WireGuard-config-information-via-wg-show.png 608w, https://static.ericdraken.com/files/WireGuard-config-information-via-wg-show-300x115.png 300w, https://ericdraken.com/files/WireGuard-config-information-via-wg-show-600x230.png 600w"></a><figcaption>WireGuard config information via wg show</figcaption></figure><p>Run <code>sudo wg showconf nordlynx</code> to see your private key needed by the pfSense tunnel config.</p><p>Here are various screenshots that show the steps in more detail.</p><figure id="attachment_5477"><a href="https://static.ericdraken.com/files/VPN-WireGuard-Tunnels.png"><img src="https://static.ericdraken.com/files/VPN-WireGuard-Tunnels-754x450.png" alt="VPN > WireGuard > Tunnels" width="754" height="450" srcset="https://static.ericdraken.com/files/VPN-WireGuard-Tunnels-754x450.png 754w, https://static.ericdraken.com/files/VPN-WireGuard-Tunnels-300x179.png 300w, https://ericdraken.com/files/VPN-WireGuard-Tunnels-600x358.png 600w, https://static.ericdraken.com/files/VPN-WireGuard-Tunnels.png 1154w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/VPN-WireGuard-Tunnels-754x450.png" data-srcset="https://static.ericdraken.com/files/VPN-WireGuard-Tunnels-754x450.png 754w, https://static.ericdraken.com/files/VPN-WireGuard-Tunnels-300x179.png 300w, https://ericdraken.com/files/VPN-WireGuard-Tunnels-600x358.png 600w, https://static.ericdraken.com/files/VPN-WireGuard-Tunnels.png 1154w"></a><figcaption>VPN &gt; WireGuard &gt; Tunnels</figcaption></figure><figure id="attachment_5478"><a href="https://ericdraken.com/files/VPN-WireGuard-Peers.png"><img src="https://ericdraken.com/files/VPN-WireGuard-Peers-754x563.png" alt="VPN > WireGuard > Peers" width="754" height="563" srcset="https://ericdraken.com/files/VPN-WireGuard-Peers-754x563.png 754w, https://ericdraken.com/files/VPN-WireGuard-Peers-300x224.png 300w, https://ericdraken.com/files/VPN-WireGuard-Peers-600x448.png 600w, https://ericdraken.com/files/VPN-WireGuard-Peers.png 1147w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/VPN-WireGuard-Peers-754x563.png" data-srcset="https://ericdraken.com/files/VPN-WireGuard-Peers-754x563.png 754w, https://ericdraken.com/files/VPN-WireGuard-Peers-300x224.png 300w, https://ericdraken.com/files/VPN-WireGuard-Peers-600x448.png 600w, https://ericdraken.com/files/VPN-WireGuard-Peers.png 1147w"></a><figcaption>VPN &gt; WireGuard &gt; Peers</figcaption></figure><div><p><strong>Tip:</strong> Enter <code>1.0.0.0</code> and then <code>0</code> as the subnet mask. Do not go for <code>0.0.0.0</code> as there is a glitch or bug in the UI or whathaveyou. The result will still be <code>0.0.0.0/0</code>.</p></div><figure id="attachment_5479"><a href="https://static.ericdraken.com/files/VPN-WireGuard-Settings.png"><img src="https://static.ericdraken.com/files/VPN-WireGuard-Settings-754x345.png" alt="VPN > WireGuard > Settings" width="754" height="345" srcset="https://static.ericdraken.com/files/VPN-WireGuard-Settings-754x345.png 754w, https://ericdraken.com/files/VPN-WireGuard-Settings-300x137.png 300w, https://ericdraken.com/files/VPN-WireGuard-Settings-600x275.png 600w, https://static.ericdraken.com/files/VPN-WireGuard-Settings.png 1153w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/VPN-WireGuard-Settings-754x345.png" data-srcset="https://static.ericdraken.com/files/VPN-WireGuard-Settings-754x345.png 754w, https://ericdraken.com/files/VPN-WireGuard-Settings-300x137.png 300w, https://ericdraken.com/files/VPN-WireGuard-Settings-600x275.png 600w, https://static.ericdraken.com/files/VPN-WireGuard-Settings.png 1153w"></a><figcaption>VPN &gt; WireGuard &gt; Settings</figcaption></figure><figure id="attachment_5480"><a href="https://static.ericdraken.com/files/Interfaces-Interface-Assignments.png"><img src="https://static.ericdraken.com/files/Interfaces-Interface-Assignments-754x248.png" alt="Interfaces > Interface Assignments" width="754" height="248" srcset="https://static.ericdraken.com/files/Interfaces-Interface-Assignments-754x248.png 754w, https://ericdraken.com/files/Interfaces-Interface-Assignments-300x99.png 300w, https://static.ericdraken.com/files/Interfaces-Interface-Assignments-600x197.png 600w, https://static.ericdraken.com/files/Interfaces-Interface-Assignments.png 1153w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Interfaces-Interface-Assignments-754x248.png" data-srcset="https://static.ericdraken.com/files/Interfaces-Interface-Assignments-754x248.png 754w, https://ericdraken.com/files/Interfaces-Interface-Assignments-300x99.png 300w, https://static.ericdraken.com/files/Interfaces-Interface-Assignments-600x197.png 600w, https://static.ericdraken.com/files/Interfaces-Interface-Assignments.png 1153w"></a><figcaption>Interfaces &gt; Interface Assignments</figcaption></figure><p>That should be enough to allow Diagnostics to <code>curl</code> Italy.</p><figure id="attachment_5466"><a href="https://static.ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense.png"><img src="https://ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-754x203.png" alt="Successfully connected to NordVPN through WireGuard on pfSense" width="754" height="203" srcset="https://ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-754x203.png 754w, https://static.ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-300x81.png 300w, https://static.ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-600x161.png 600w, https://static.ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense.png 1148w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-754x203.png" data-srcset="https://ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-754x203.png 754w, https://static.ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-300x81.png 300w, https://static.ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense-600x161.png 600w, https://static.ericdraken.com/files/Successfully-connected-to-NordVPN-through-WireGuard-on-pfSense.png 1148w"></a><figcaption>Successfully connected to NordVPN through WireGuard on pfSense</figcaption></figure><figure id="attachment_5468"><a href="https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified.png"><img src="https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified-754x479.png" alt="Successfully connect to Italy and verified" width="754" height="479" srcset="https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified-754x479.png 754w, https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified-300x191.png 300w, https://ericdraken.com/files/Successfully-connect-to-Italy-and-verified-600x381.png 600w, https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified.png 757w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified-754x479.png" data-srcset="https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified-754x479.png 754w, https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified-300x191.png 300w, https://ericdraken.com/files/Successfully-connect-to-Italy-and-verified-600x381.png 600w, https://static.ericdraken.com/files/Successfully-connect-to-Italy-and-verified.png 757w"></a><figcaption>Successfully connect to Italy and verified</figcaption></figure><p>Now that the easy part is out of the way, let’s set some Policy rules to send the Apple TV traffic over the VPN to Italy as a baseline test.</p><p>From Netgate, on the <a href="https://docs.netgate.com/pfsense/en/latest/nat/process-order.html" target="_blank" rel="nofollow">order of Firewall/NAT processing</a>:</p><blockquote><p>Traffic from LAN to WAN is processed as described in the following more detailed example.</p><ul><li>Port forwards or 1:1 NAT on the LAN interface (e.g. proxy or DNS redirects)</li><li>Firewall rules for the LAN interface:<ul><li>Floating rules inbound on LAN</li><li>Rules for interface groups including the LAN interface</li><li>LAN tab rules</li></ul></li><li>1:1 NAT or Outbound NAT rules on WAN</li><li>Floating rules that match outbound on WAN</li></ul></blockquote><p>I’ll make an alias, for now, to hold some clients that have static DHCP entries and hostnames I gave them in pfSense.</p><figure id="attachment_5483"><a href="https://static.ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page.png"><img src="https://ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-754x171.png" alt="VPN clients in the Firewall > Aliases > IP page" width="754" height="171" srcset="https://ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-754x171.png 754w, https://static.ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-300x68.png 300w, https://ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-600x136.png 600w, https://static.ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page.png 1149w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-754x171.png" data-srcset="https://ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-754x171.png 754w, https://static.ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-300x68.png 300w, https://ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page-600x136.png 600w, https://static.ericdraken.com/files/VPN-clients-in-the-Firewall-Aliases-IP-page.png 1149w"></a><figcaption>VPN clients in the Firewall &gt; Aliases &gt; IP page</figcaption></figure><p>Floating rules <strong>in</strong> have high precedence, so I’ll add some rules below the automatic pfBlockerNG rules that were created, and I’ll add a nice little blue separator while I’m here.</p><figure id="attachment_5484"><a href="https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy.png"><img src="https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-754x463.png" alt="Floating rule to route select clients over the VPN to Italy" width="754" height="463" srcset="https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-754x463.png 754w, https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-300x184.png 300w, https://static.ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-600x369.png 600w, https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy.png 1151w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-754x463.png" data-srcset="https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-754x463.png 754w, https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-300x184.png 300w, https://static.ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy-600x369.png 600w, https://ericdraken.com/files/Floating-rule-to-route-select-clients-over-the-VPN-to-Italy.png 1151w"></a><figcaption>Floating rule to route select clients over the VPN to Italy</figcaption></figure><p>And here is that rule as a very long screenshot:</p><figure id="attachment_5485"><a href="https://ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN.png"><img src="https://static.ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-754x1712.png" alt="Firewall > Rules > Floating rule to route select clients over the VPN" width="754" height="1712" srcset="https://static.ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-754x1712.png 754w, https://ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-132x300.png 132w, https://ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-600x1363.png 600w, https://ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN.png 1147w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-754x1712.png" data-srcset="https://static.ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-754x1712.png 754w, https://ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-132x300.png 132w, https://ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN-600x1363.png 600w, https://ericdraken.com/files/Firewall-Rules-Floating-rule-to-route-select-clients-over-the-VPN.png 1147w"></a><figcaption>Firewall &gt; Rules &gt; Floating rule to route select clients over the VPN</figcaption></figure><p>Apply. Wait. Let’s try it out using one of my notebooks connected to the Untrusted network.</p><figure id="attachment_5492"><a href="https://ericdraken.com/files/Google-is-entirely-in-Italian-now.png"><img src="https://static.ericdraken.com/files/Google-is-entirely-in-Italian-now-754x393.png" alt="Google is entirely in Italian now" width="754" height="393" srcset="https://static.ericdraken.com/files/Google-is-entirely-in-Italian-now-754x393.png 754w, https://static.ericdraken.com/files/Google-is-entirely-in-Italian-now-300x156.png 300w, https://ericdraken.com/files/Google-is-entirely-in-Italian-now-600x312.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Google-is-entirely-in-Italian-now-754x393.png" data-srcset="https://static.ericdraken.com/files/Google-is-entirely-in-Italian-now-754x393.png 754w, https://static.ericdraken.com/files/Google-is-entirely-in-Italian-now-300x156.png 300w, https://ericdraken.com/files/Google-is-entirely-in-Italian-now-600x312.png 600w"></a><figcaption>Google is entirely in Italian now</figcaption></figure><p>Google is in Italian. Very cool. Now for the Apple TV.</p><figure id="attachment_5509"><a href="https://ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy.jpg"><img src="https://ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-754x318.jpg" alt="Apple TV's YouTube reports I am in Italy" width="754" height="318" srcset="https://ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-754x318.jpg 754w, https://static.ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-300x126.jpg 300w, https://ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-600x253.jpg 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-754x318.jpg" data-srcset="https://ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-754x318.jpg 754w, https://static.ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-300x126.jpg 300w, https://ericdraken.com/files/Apple-TVs-YouTube-reports-I-am-in-Italy-600x253.jpg 600w"></a><figcaption>Apple TV’s YouTube reports I am in Italy</figcaption></figure><p>Winner winner, chicken diner. All my YouTube is in Italian. I get some ads, not as many, but because Italians speak slowly and with a kind of sexy accent I do not mind the ads for Nutella at all.</p><p>With this technique, I no longer feel manipulated by non-English ads. I have personalized ads <em>off</em>, but given my new status as a retired gentleman I should turn that back on to scare away advertising dollars, er, euros. I wonder if Netflix and Amazon Prime behave any differently…</p><figure id="attachment_5508"><a href="https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked.jpg"><img src="https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-754x524.jpg" alt="Some Netflix assets are being blocked" width="754" height="524" srcset="https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-754x524.jpg 754w, https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-300x208.jpg 300w, https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-600x417.jpg 600w, https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked.jpg 1276w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-754x524.jpg" data-srcset="https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-754x524.jpg 754w, https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-300x208.jpg 300w, https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked-600x417.jpg 600w, https://ericdraken.com/files/Some-Netflix-assets-are-being-blocked.jpg 1276w"></a><figcaption>Some Netflix assets are being blocked</figcaption></figure><p>Dang. Netflix is having problems. Amazon Prime is even worse. It looks like some CSS or font files are blocked as well, and the thumbnails aren’t loading. It’s time to move to Phase Two: Tunnel only YouTube traffic over the VPN.</p><div><p><strong>Warning:</strong> Do not try to send all the Apple TV traffic over a VPN because Netflix, Prime, and others are wise to VPN providers and have gotten great at geofencing.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Selectively Route Apple TV YouTube Traffic Over the VPN</h2><p>Let’s start by adding Firewall Policy rules to send the most common YouTube domains over the VPN.</p><p>As I’m about to add the rules, my hands hover over the keyboard not knowing what domains to tunnel. They need to be FQDN (fully-qualified domain names, no wildcards). Let’s open up a Chromium-based browser and see what traffic it generates in DevTools.</p><figure id="attachment_5559"><a href="https://static.ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls.png"><img src="https://ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-754x440.png" alt="Add the domains column to DevTools to see where YouTube calls" width="754" height="440" srcset="https://ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-754x440.png 754w, https://static.ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-300x175.png 300w, https://static.ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-600x350.png 600w, https://static.ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls.png 1031w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-754x440.png" data-srcset="https://ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-754x440.png 754w, https://static.ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-300x175.png 300w, https://static.ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls-600x350.png 600w, https://static.ericdraken.com/files/Add-the-domains-column-to-DevTools-to-see-where-YouTube-calls.png 1031w"></a><figcaption>Add the domains column to DevTools to see where YouTube calls</figcaption></figure><p>Here are some candidate FQDNs to add:</p><div id="crayon-63661eaabe4aa191315272" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>www</span><span>.youtube</span><span>.com</span></p><p><span>youtube</span><span>.com</span></p><p><span>googlevideo</span><span>.com</span></p><p><span>accounts</span><span>.google</span><span>.com</span></p><p><span>googleapis</span><span>.com</span></p><p><span>gstatic</span><span>.com</span></p></div></td></tr></tbody></table></div><p>But wait, I hear you ask, why <code>accounts.google.com</code> and <code>gstatic.com</code>? This is a preventative measure just in case one of those domains is geo-jacked (Geo-IP LowJacking). I wouldn’t put it past Google engineers to geo-jack the fonts domains like <code>fonts.googleapis.com</code>, but I’ll take a chance they don’t in the interest of scaling to billions of page views efficiently.</p><p>Here are my new rules where I chain two of them using a tag so I can limit YouTube tunnelling to only the same untrusted machines (including Apple TV).</p><figure id="attachment_5496"><a href="https://static.ericdraken.com/files/YouTube-domains-to-tunnel.png"><img src="https://static.ericdraken.com/files/YouTube-domains-to-tunnel-754x422.png" alt="YouTube domains to tunnel" width="754" height="422" srcset="https://static.ericdraken.com/files/YouTube-domains-to-tunnel-754x422.png 754w, https://static.ericdraken.com/files/YouTube-domains-to-tunnel-300x168.png 300w, https://static.ericdraken.com/files/YouTube-domains-to-tunnel-600x336.png 600w, https://static.ericdraken.com/files/YouTube-domains-to-tunnel.png 1146w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/YouTube-domains-to-tunnel-754x422.png" data-srcset="https://static.ericdraken.com/files/YouTube-domains-to-tunnel-754x422.png 754w, https://static.ericdraken.com/files/YouTube-domains-to-tunnel-300x168.png 300w, https://static.ericdraken.com/files/YouTube-domains-to-tunnel-600x336.png 600w, https://static.ericdraken.com/files/YouTube-domains-to-tunnel.png 1146w"></a><figcaption>YouTube domains to tunnel</figcaption></figure><figure id="attachment_5497"><a href="https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule.png"><img src="https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-754x132.png" alt="Use a match rule before the tunnel rule" width="754" height="132" srcset="https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-754x132.png 754w, https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-300x53.png 300w, https://static.ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-600x105.png 600w, https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule.png 1140w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-754x132.png" data-srcset="https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-754x132.png 754w, https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-300x53.png 300w, https://static.ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule-600x105.png 600w, https://ericdraken.com/files/Use-a-match-rule-before-the-tunnel-rule.png 1140w"></a><figcaption>Use a match rule before the tunnel rule</figcaption></figure><figure id="attachment_5498"><a href="https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them.png"><img src="https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-754x1673.png" alt="The first rule matches VPN clients and tags them" width="754" height="1673" srcset="https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-754x1673.png 754w, https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-135x300.png 135w, https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-600x1331.png 600w, https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them.png 1145w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-754x1673.png" data-srcset="https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-754x1673.png 754w, https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-135x300.png 135w, https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them-600x1331.png 600w, https://static.ericdraken.com/files/The-first-rule-matches-VPN-clients-and-tags-them.png 1145w"></a><figcaption>The first rule matches VPN clients and tags them</figcaption></figure><figure id="attachment_5499"><a href="https://ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN.png"><img src="https://ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-754x1674.png" alt="The second rule tunnels tagged requests through the VPN" width="754" height="1674" srcset="https://ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-754x1674.png 754w, https://static.ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-135x300.png 135w, https://static.ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-600x1332.png 600w, https://ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN.png 1142w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-754x1674.png" data-srcset="https://ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-754x1674.png 754w, https://static.ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-135x300.png 135w, https://static.ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN-600x1332.png 600w, https://ericdraken.com/files/The-second-rule-tunnels-tagged-requests-through-the-VPN.png 1142w"></a><figcaption>The second rule tunnels tagged requests through the VPN</figcaption></figure><p>And with that, YouTube thinks I’m in Milan, Netflix and Prime Video think I am still in Canada, and the ads… oh the ads… they are few and far between, and when they do come on, they are just a treat to listen to in that slow, lack-of-harsh-aspirants-or-yelling of a beautiful language Italian is.</p><figure id="attachment_5571"><a href="https://ericdraken.com/files/YouTube-Italy.jpg"><img src="https://static.ericdraken.com/files/YouTube-Italy-754x386.jpg" alt="YouTube, Italy" width="754" height="386" srcset="https://static.ericdraken.com/files/YouTube-Italy-754x386.jpg 754w, https://ericdraken.com/files/YouTube-Italy-300x154.jpg 300w, https://static.ericdraken.com/files/YouTube-Italy-600x308.jpg 600w, https://ericdraken.com/files/YouTube-Italy.jpg 1200w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/YouTube-Italy-754x386.jpg" data-srcset="https://static.ericdraken.com/files/YouTube-Italy-754x386.jpg 754w, https://ericdraken.com/files/YouTube-Italy-300x154.jpg 300w, https://static.ericdraken.com/files/YouTube-Italy-600x308.jpg 600w, https://ericdraken.com/files/YouTube-Italy.jpg 1200w"></a><figcaption>YouTube, Italy</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><p><em>Time goes by…</em></p><hr><h2>Gotcha: DNS Race Condition</h2><p>A day has gone by and I’ve noticed that I only get Nutella and Ferrero Roche ads in the middle of videos, not at the start. Odd. I did some research and this is what I found:</p><figure id="attachment_5561"><a href="https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases.png"><img src="https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases.png" alt="Pertinent information about pfSense and hostname aliases" width="696" height="589" srcset="https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases.png 696w, https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases-300x254.png 300w, https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases-600x508.png 600w" sizes="(max-width: 696px) 100vw, 696px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases.png" data-srcset="https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases.png 696w, https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases-300x254.png 300w, https://static.ericdraken.com/files/Pertinent-information-about-pfSense-and-hostname-aliases-600x508.png 600w"></a><figcaption>Pertinent information about pfSense and hostname aliases</figcaption></figure><p>This means that the hostnames are resolved to IP addresses <strong>once</strong> and those IPs are used in my VPN tunnelling policy rules.</p><blockquote><p>A hostname entry in a host or network type alias is <strong>periodically resolved and updated by the firewall every few minutes</strong>. The default interval is 300 seconds (5 minutes), and can be changed by adjusting the value of Aliases Hostnames Resolve Interval on System &gt; Advanced, Firewall &amp; NAT tab. – pfSense</p></blockquote><p>Ah-ha, so I suspect there is a DNS race condition. Let me explain:</p><p>This happens if, say, the Alias Daemon updates the IPs of the FQDNs. Then, I turn on the Apple TV for the first time all day. Since the usual TTL (time-to-live) of DNS queries is 1440 seconds (30 minutes), all the YouTube DNS entries will be cache misses and will need to be updated. At this point, the IPs from the second DNS queries may be from a pool and are not guaranteed to be the same that the Alias Daemon has. When the Alias Daemon checks again in five minutes, it may resolve the FQDNs to yet different IPs!</p><p>Let’s solve this by overwriting whatever TTL (time-to-live) YouTube has in its DNS entries:</p><figure id="attachment_5568"><a href="https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry.png"><img src="https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-754x181.png" alt="Do not abide by the minimum TTL of the target DNS entry" width="754" height="181" srcset="https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-754x181.png 754w, https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-300x72.png 300w, https://static.ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-600x144.png 600w, https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry.png 1069w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-754x181.png" data-srcset="https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-754x181.png 754w, https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-300x72.png 300w, https://static.ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry-600x144.png 600w, https://ericdraken.com/files/Do-not-abide-by-the-minimum-TTL-of-the-target-DNS-entry.png 1069w"></a><figcaption>Do not abide by the minimum TTL of the target DNS entry</figcaption></figure><p>And with that, no more DNS lookup race condition.</p><p><a href="#top">Top ↩</a></p><hr><h2>Gotcha: Authentication Trouble, Forbidden 403 Error</h2><p>Sometimes videos will not play. For security, YouTube embeds your IP in the <code>googlevideo.com</code> request. I’ve known about this since my post about <a href="https://ericdraken.com/download-youtube-videos-with-php/" target="_blank">Download YouTube 4K Videos with PHP</a> back in 2016. The new problem is that various JavaScript and “are you human?” assets are tunnelled over VPN, but those darn domains like <code>r5---sn-hpa7kn76.googlevideo.com</code> are not tunnelled and thus come from the wrong IP. Queue the <code>403 Forbidden</code> error.</p><figure id="attachment_5569"><a href="https://ericdraken.com/files/YouTube-authentication-failure.png"><img src="https://static.ericdraken.com/files/YouTube-authentication-failure-754x359.png" alt="YouTube authentication failure" width="754" height="359" srcset="https://static.ericdraken.com/files/YouTube-authentication-failure-754x359.png 754w, https://static.ericdraken.com/files/YouTube-authentication-failure-300x143.png 300w, https://ericdraken.com/files/YouTube-authentication-failure-600x286.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/YouTube-authentication-failure-754x359.png" data-srcset="https://static.ericdraken.com/files/YouTube-authentication-failure-754x359.png 754w, https://static.ericdraken.com/files/YouTube-authentication-failure-300x143.png 300w, https://ericdraken.com/files/YouTube-authentication-failure-600x286.png 600w"></a><figcaption>YouTube authentication failure</figcaption></figure><p>Let’s fail fast with a quick experiment: I’ve gotten the IP of the above second-level domain name (SLD), added it manually to the list of domains/IPs to VPN tunnel, applied the change, and refreshed YouTube:</p><figure id="attachment_5574"><a href="https://ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well..png"><img src="https://static.ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-754x360.png" alt="Success. We need to route the mangled domains over the VPN as well." width="754" height="360" srcset="https://static.ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-754x360.png 754w, https://static.ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-300x143.png 300w, https://ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-600x287.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-754x360.png" data-srcset="https://static.ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-754x360.png 754w, https://static.ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-300x143.png 300w, https://ericdraken.com/files/Success.-We-need-to-route-the-mangled-domains-over-the-VPN-as-well.-600x287.png 600w"></a><figcaption>Success. We need to route the mangled domains over the VPN as well.</figcaption></figure><p>Excellent. Now, we just need a way to tunnel that wildcard <code>*.googlevideo.com</code> domain. Unfortunately, the NAT and Firewall rules work with IPs, not <a href="https://www.reddit.com/r/PFSENSE/comments/7wwnun/wildcard_domains_in_aliases/" target="_blank" rel="nofollow">wildcard domain names</a>. Can we predict or enumerate these domains?</p><p>Here is a Wireshark capture of DNS requests to <code>*.googlevideo.com</code> to show that the SLDs (second-level domains) are not eyeballably predictable:</p><figure id="attachment_5663"><a href="https://static.ericdraken.com/files/Random-SLDs-from-googlevideo.com_.png"><img src="https://ericdraken.com/files/Random-SLDs-from-googlevideo.com_-754x270.png" alt="Random SLDs from googlevideo.com" width="754" height="270" srcset="https://ericdraken.com/files/Random-SLDs-from-googlevideo.com_-754x270.png 754w, https://ericdraken.com/files/Random-SLDs-from-googlevideo.com_-300x107.png 300w, https://static.ericdraken.com/files/Random-SLDs-from-googlevideo.com_-600x215.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Random-SLDs-from-googlevideo.com_-754x270.png" data-srcset="https://ericdraken.com/files/Random-SLDs-from-googlevideo.com_-754x270.png 754w, https://ericdraken.com/files/Random-SLDs-from-googlevideo.com_-300x107.png 300w, https://static.ericdraken.com/files/Random-SLDs-from-googlevideo.com_-600x215.png 600w"></a><figcaption>Random SLDs from googlevideo.com</figcaption></figure><p>Let’s drop into a web browser with adblocking disabled and walk the HAR waterfall of my interaction with YouTube that led to ads showing up.</p><figure id="attachment_5666"><a href="https://static.ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_.png"><img src="https://ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-754x255.png" alt="Waterfall showing ad interactions coming from www.youtube.com" width="754" height="255" srcset="https://ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-754x255.png 754w, https://static.ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-300x101.png 300w, https://static.ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-600x203.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-754x255.png" data-srcset="https://ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-754x255.png 754w, https://static.ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-300x101.png 300w, https://static.ericdraken.com/files/Waterfall-showing-ad-interactions-coming-from-www.youtube.com_-600x203.png 600w"></a><figcaption>Waterfall showing ad interactions coming from www.youtube.com</figcaption></figure><p>What are GET requests like</p><p><code>GET https://r7---sn-uxa0n-t8ge.googlevideo.com/generate_204</code></p><p>doing, exactly? I’ll give this problem some thought offline.</p><p><a href="#top">Top ↩</a></p><hr><h2>Gotcha: YouTube is Now Showing UK Ads, Not Italian Ads</h2><p>Before I could even solve the previous gotcha, British ads started showing up with the same frequency as if we did nothing. Ads from the UK are even more incessant than those from Canada, trailing behind the USA and India according to my earlier stats. It would be a complete failure if we get UK ads. Why does this happen suddenly? I’ve opened a fresh browser in a VM and tunnelled all traffic through Italy. The only leak I can find is when I query <code>ipinfo.io</code> on my Italian tunnel and see a UK address in the ASN. Could this small leak be our undoing?</p><figure id="attachment_5672"><a href="https://ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information.png"><img src="https://static.ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-754x419.png" alt="It is possible the VPN is leaking unintended information" width="754" height="419" srcset="https://static.ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-754x419.png 754w, https://ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-300x167.png 300w, https://static.ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-600x333.png 600w, https://ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information.png 1499w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-754x419.png" data-srcset="https://static.ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-754x419.png 754w, https://ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-300x167.png 300w, https://static.ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information-600x333.png 600w, https://ericdraken.com/files/It-is-possible-the-VPN-is-leaking-unintended-information.png 1499w"></a><figcaption>It is possible the VPN is leaking unintended information</figcaption></figure><p>Even with my browser’s language set to <code>en_US</code> and location data off, this is the only leak I can spot. Then, in addition to a VPN exiting in Italy, it has to be one that doesn’t leak <code>ASN</code> (Autonomous System Numbers – used for automated routing) that gives up a different country. Dang, Google, you’re good. I’m going to have to bring my A+ game to this one.</p><p><a href="#top">Top ↩</a></p><hr><h2>Find a VPN Exit Node with no ASN Leak</h2><p>By visiting <code>https://nordvpn.com/servers/tools/</code>, I can see the VPN endpoint nodes in Italy. There are many Wireguard endpoints with <a href="https://ericdraken.com/out/nordvpn" target="_blank">NordVPN</a>. Just to move things forward for this exercise, I’ll add an OpenVPN tunnel in pfSense and connect to several VPN nodes and examine the ASNs. It’s better than nothing, and more importantly, I’d like to eliminate the <code>ASN</code> as the leak of GeoIP information. Here is the <a href="https://support.nordvpn.com/Connectivity/Router/1626958942/pfSense-2-5-Setup-with-NordVPN.htm" target="_blank" rel="nofollow">guide</a> I used.</p><p>Through trial and error, I found a VPN node that is registered to an ISP in Italy as found in the <code>Abuse</code> and <code>ASN</code> info.</p><figure id="attachment_5678"><a href="https://static.ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks.png"><img src="https://ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-754x382.png" alt="Found an exit node with no ASN leaks" width="754" height="382" srcset="https://ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-754x382.png 754w, https://static.ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-300x152.png 300w, https://static.ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-600x304.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-754x382.png" data-srcset="https://ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-754x382.png 754w, https://static.ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-300x152.png 300w, https://static.ericdraken.com/files/Found-an-exit-node-with-no-ASN-leaks-600x304.png 600w"></a><figcaption>Found an exit node with no ASN leaks</figcaption></figure><p>Beautiful. Bellissimo.</p><figure id="attachment_5681"><a href="https://ericdraken.com/files/Italian-content-with-Italian-ads-again.jpg"><img src="https://ericdraken.com/files/Italian-content-with-Italian-ads-again-754x283.jpg" alt="Italian content with Italian ads again" width="754" height="283" srcset="https://ericdraken.com/files/Italian-content-with-Italian-ads-again-754x283.jpg 754w, https://ericdraken.com/files/Italian-content-with-Italian-ads-again-300x113.jpg 300w, https://static.ericdraken.com/files/Italian-content-with-Italian-ads-again-600x226.jpg 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Italian-content-with-Italian-ads-again-754x283.jpg" data-srcset="https://ericdraken.com/files/Italian-content-with-Italian-ads-again-754x283.jpg 754w, https://ericdraken.com/files/Italian-content-with-Italian-ads-again-300x113.jpg 300w, https://static.ericdraken.com/files/Italian-content-with-Italian-ads-again-600x226.jpg 600w"></a><figcaption>Italian content with Italian ads again</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Hijack Google Video DNS Queries</h2><p>To make any of this work, I need a technique to route the wildcard <code>*.googlevideos.com</code> domain through the VPN.</p><div><p><strong>Thought Experiment:</strong> Suppose I write a plugin for pfSense that periodically <code>grep</code>s the DNS query log, keeps track of the <code>*.googlevideo.com</code> queries, and adds them to a unique list of aliases for Google Video domains; if backed by an LRU eviction policy, this could keep working indefinitely. However, if each video uses a unique, mangled domain, then this does not work unless I hit refresh on every single video.</p></div><p>On the other hand, if I “hold up” the DNS query for the <code>*.googlevideo.com</code> domains, add the IPs to some alias list, <em>then</em> allow the DNS response to finish the round trip, we may be in business!</p><figure id="attachment_5583"><a href="https://static.ericdraken.com/files/pfSense-DNS-resolver-has-user-Python-support.png"><img src="https://static.ericdraken.com/files/pfSense-DNS-resolver-has-user-Python-support.png" alt="pfSense DNS resolver has user Python support" width="585" height="257" srcset="https://static.ericdraken.com/files/pfSense-DNS-resolver-has-user-Python-support.png 585w, https://ericdraken.com/files/pfSense-DNS-resolver-has-user-Python-support-300x132.png 300w" sizes="(max-width: 585px) 100vw, 585px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/pfSense-DNS-resolver-has-user-Python-support.png" data-srcset="https://static.ericdraken.com/files/pfSense-DNS-resolver-has-user-Python-support.png 585w, https://ericdraken.com/files/pfSense-DNS-resolver-has-user-Python-support-300x132.png 300w"></a><figcaption>pfSense DNS resolver has user Python support</figcaption></figure><p>Where to even start? Here are some <a href="https://github.com/NLnetLabs/unbound/tree/master/pythonmod/examples" target="_blank" rel="nofollow">Python example scripts</a> just to get some inspiration. A quick, mental reverse-engineering of a handful of scripts reveals that there are some event hooks available. Nice.</p><p>Among friends, let’s say that I can build up the pool of Google video IPs in real-time. How then to add these IPs programmatically to the firewall alias list for YouTube <em>without</em> restarting the firewall? One person actually hacked the PHP scripts in pfSense. Tempting, but I’ll do more research. Another person created a <a href="https://github.com/jaredhendrickson13/pfsense-api" target="_blank" rel="nofollow">REST API for pfSense</a>. Jackpot!</p><p><a href="#top">Top ↩</a></p><hr><div><p><a name="new-goal"></a><strong>New Goal:</strong> We need to add IPs to the firewall policy rule to route YouTube videos over a VPN to avoid incessant and obnoxious North-American ads, but the IPs keep changing due to changing, mangled second-level domain names (SLDs). Using Python 3 and a REST API, we will monitor the appropriate DNS queries, note the IP(s) of the response, hold the response, add the IP(s) to the VPN tunnelling policy rule, then release the DNS query response.</p></div><h2>Research Python Methods to Hijack DNS Requests</h2><p>Why this approach? It’s future-proof, modular, elegant, maintainable, automated, and it lends itself to a future decision tree that could truly restrict YouTube ads outright.</p><p>First, I will enable SSHd in pfSense and take a peek around.</p><figure id="attachment_5588"><a href="https://ericdraken.com/files/Enable-SSHd-in-pfSense.png"><img src="https://ericdraken.com/files/Enable-SSHd-in-pfSense-754x177.png" alt="Enable SSHd in pfSense" width="754" height="177" srcset="https://ericdraken.com/files/Enable-SSHd-in-pfSense-754x177.png 754w, https://static.ericdraken.com/files/Enable-SSHd-in-pfSense-300x71.png 300w, https://static.ericdraken.com/files/Enable-SSHd-in-pfSense-600x141.png 600w, https://ericdraken.com/files/Enable-SSHd-in-pfSense.png 1140w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Enable-SSHd-in-pfSense-754x177.png" data-srcset="https://ericdraken.com/files/Enable-SSHd-in-pfSense-754x177.png 754w, https://static.ericdraken.com/files/Enable-SSHd-in-pfSense-300x71.png 300w, https://static.ericdraken.com/files/Enable-SSHd-in-pfSense-600x141.png 600w, https://ericdraken.com/files/Enable-SSHd-in-pfSense.png 1140w"></a><figcaption>Enable SSHd in pfSense</figcaption></figure><figure id="attachment_5589"><a href="https://ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials.png"><img src="https://ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-754x424.png" alt="SSH into pfSense using the GUI credentials" width="754" height="424" srcset="https://ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-754x424.png 754w, https://static.ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-300x169.png 300w, https://static.ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-600x337.png 600w, https://ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials.png 1052w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-754x424.png" data-srcset="https://ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-754x424.png 754w, https://static.ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-300x169.png 300w, https://static.ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials-600x337.png 600w, https://ericdraken.com/files/SSH-into-pfSense-using-the-GUI-credentials.png 1052w"></a><figcaption>SSH into pfSense using the GUI credentials</figcaption></figure><h3>Rsync Disk Backup</h3><p>Let’s take this opportunity to make a disk backup. <code>du -h</code> or “duh” shows that only 800 MiB is in use on the SSD. Let’s <code>rsync</code> the whole box from our local machine in about four minutes.</p><div id="crayon-63661eaabe4b8255504186" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p></div></td><td><div><p><span># Rsync the pfSense router locally, then compress to an archive.</span></p><p><span># Tell the remote rsync to preserve ownership information.</span></p><p><span># Fix brace expansion and execute (easy to read with tr and sed).</span></p><p><span>cat</span><span> </span><span>&lt;&lt;</span><span> </span><span>EOF</span><span> </span><span>|</span><span> </span><span>tr</span><span> </span><span>-</span><span>s</span><span> </span><span>' '</span><span> </span><span>|</span><span> </span><span>sed</span><span> </span><span>'s/, "/,"/g'</span><span> </span><span>|</span><span> </span><span>bash</span></p><p><span>time</span><span> </span><span>\</span></p><p><span>rsync</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>archive</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>acls</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>xattrs</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>hard</span><span>-</span><span>links</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>fake</span><span>-</span><span>super</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>numeric</span><span>-</span><span>ids</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>checksum</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>info</span><span>=</span><span>progress2</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>no</span><span>-</span><span>compress</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>whole</span><span>-</span><span>file</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>inplace</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>rsync</span><span>-</span><span>path</span><span>=</span><span>"/usr/local/bin/rsync --fake-super --numeric-ids"</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>exclude</span><span>=</span><span>{</span><span>"/dev/*"</span><span>,</span><span>"/proc/*"</span><span>,</span><span>"/sys/*"</span><span>,</span><span>"/tmp/*"</span><span>,</span><span>"/run/*"</span><span>,</span><span>\</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"/var/*"</span><span>,</span><span>"/mnt/*"</span><span>,</span><span>"/media/*"</span><span>,</span><span>"/lost+found"</span><span>}</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>rsh</span><span>=</span><span>"ssh -p 2222"</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>admin</span><span>@</span><span>pfsense</span><span>:</span><span>/</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>~</span><span>/</span><span>.pfsense</span><span>-</span><span>backup</span><span> </span><span>&amp;&amp;</span><span> </span><span>\</span></p><p><span>tar</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>gzip</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>create</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>file</span><span> </span><span>~</span><span>/</span><span>pfsense</span><span>-</span><span>backup</span><span>-</span><span>`</span><span>date</span><span> </span><span>+</span><span>"%Y-%m-%d"</span><span>`</span><span>.tar</span><span>.gz</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>~</span><span>/</span><span>.pfsense</span><span>-</span><span>backup</span></p><p><span>EOF</span></p></div></td></tr></tbody></table></div><div><p><strong>Tip:</strong> To verify the owners and permissions are set in the extended attributes locally, run<br><code>getfattr -d -m ^ -R -- ~/.pfsense-backup</code></p></div><h3>Install pfSense REST API</h3><p>Now that we have a pfSense backup (I’m told just backing up <code>config.xml</code> works too), let’s install the <a href="https://github.com/jaredhendrickson13/pfsense-api" target="_blank" rel="nofollow">REST API</a>.</p><p>This part had me confused. You see, I was looking at the bottom of the screen wondering how the heck I could copy a truncated hash as a token. After a few tries, I noticed the green message at the top that I had been trained to ignore. It has the token.</p><figure id="attachment_5627"><a href="https://static.ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token.png"><img src="https://static.ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-754x634.png" alt="Tricky UI screen to get the API token" width="754" height="634" srcset="https://static.ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-754x634.png 754w, https://ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-300x252.png 300w, https://ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-600x504.png 600w, https://static.ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token.png 1142w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-754x634.png" data-srcset="https://static.ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-754x634.png 754w, https://ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-300x252.png 300w, https://ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token-600x504.png 600w, https://static.ericdraken.com/files/Tricky-UI-screen-to-get-the-API-token.png 1142w"></a><figcaption>Tricky UI screen to get the API token</figcaption></figure><p>Next, with the API credentials set up, let’s try out the API:</p><div id="crayon-63661eaabe4bb158173225" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>curl</span><span> </span><span>-</span><span>k</span><span> </span><span>-</span><span>s</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>-</span><span>H</span><span> </span><span>"Content-Type: application/json"</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>-</span><span>H</span><span> </span><span>"Authorization: 61646d696e 978c197c37a882f6da23553c152c1203"</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>-</span><span>X</span><span> </span><span>GET</span><span> </span><span>https</span><span>:</span><span>/</span><span>/</span><span>pfsense</span><span>/</span><span>api</span><span>/</span><span>v1</span><span>/</span><span>firewall</span><span>/</span><span>alias</span><span> </span><span>\</span></p><p><span>|</span><span> </span><span>jq</span><span> </span><span>'.data[] | select(.name == "VPN_domains")'</span></p></div></td></tr></tbody></table></div><figure id="attachment_5628"><a href="https://static.ericdraken.com/files/Successful-API-test.png"><img src="https://static.ericdraken.com/files/Successful-API-test.png" alt="Successful API test" width="746" height="347" srcset="https://static.ericdraken.com/files/Successful-API-test.png 746w, https://ericdraken.com/files/Successful-API-test-300x140.png 300w, https://static.ericdraken.com/files/Successful-API-test-600x279.png 600w" sizes="(max-width: 746px) 100vw, 746px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Successful-API-test.png" data-srcset="https://static.ericdraken.com/files/Successful-API-test.png 746w, https://ericdraken.com/files/Successful-API-test-300x140.png 300w, https://static.ericdraken.com/files/Successful-API-test-600x279.png 600w"></a><figcaption>Successful API test</figcaption></figure><h3>Explore the Unbound Python Module</h3><p>Running <code>find / -name "py*"</code> shows that the current version of Python is 3.8.</p><p>As for the Unbound DNS Resolver, I had some luck tinkering in <code>nano</code> and writing simple Python 3.8 code to log DNS query messages. We now have both parts needed to dynamically update the firewall aliases and tunnel all YouTube traffic once and for all.</p><p>If you are looking for Python module docs for Unbound, here they are:</p><figure id="attachment_5635"><a href="https://static.ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound.png"><img src="https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-754x318.png" alt="There are no readily available Python module docs for Unbound" width="754" height="318" srcset="https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-754x318.png 754w, https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-300x126.png 300w, https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-600x253.png 600w, https://static.ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound.png 1134w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-754x318.png" data-srcset="https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-754x318.png 754w, https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-300x126.png 300w, https://ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound-600x253.png 600w, https://static.ericdraken.com/files/There-are-no-readily-available-Python-module-docs-for-Unbound.png 1134w"></a><figcaption>There are no readily available Python module docs for Unbound</figcaption></figure><p>Run these commands to quickly get the documentation.</p><div id="crayon-63661eaabe4be389439522" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># Do this in a PyCharm venv terminal</span></p><p><span>git </span><span>clone</span><span> </span><span>--</span><span>depth</span><span> </span><span>1</span><span> </span><span>-</span><span>b</span><span> </span><span>master</span><span> </span><span>--</span><span>single</span><span>-</span><span>branch </span><span>https</span><span>:</span><span>/</span><span>/</span><span>github</span><span>.com</span><span>/</span><span>NLnetLabs</span><span>/</span><span>unbound</span><span>.git</span><span> </span><span>unbound</span></p><p><span>pip3 </span><span>install </span><span>sphinx</span></p><p><span>cd</span><span> </span><span>unbound</span></p><p><span>sphinx</span><span>-</span><span>build</span><span> </span><span>-</span><span>b</span><span> </span><span>html </span><span>pythonmod</span><span>/</span><span>doc</span><span>/</span><span> </span><span>doc</span><span>/</span><span>html</span><span>/</span><span>pythonmod</span><span>/</span></p></div></td></tr></tbody></table></div><div><p><strong>Warning:</strong> The example code is from Python 2.4, so be prepared to run Black and PyCharm code formatting, or run <code>2to3</code>. Also, the most important part of this whole exercise (getting the IPs from the DNS reply) is missing, so here is the hint: <code>import ipaddress</code>. Don’t forget to manually hack the byte strings to pull out the proper IP addresses in binary form, first.</p></div><p>Now we have Python docs and access to all the capabilities. Excellent.</p><figure id="attachment_5639"><a href="https://static.ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx.png"><img src="https://ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-754x311.png" alt="Successful generation of Unbound Python docs with Sphinx" width="754" height="311" srcset="https://ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-754x311.png 754w, https://ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-300x124.png 300w, https://static.ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-600x248.png 600w, https://static.ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx.png 1280w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-754x311.png" data-srcset="https://ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-754x311.png 754w, https://ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-300x124.png 300w, https://static.ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx-600x248.png 600w, https://static.ericdraken.com/files/Successful-generation-of-Unbound-Python-docs-with-Sphinx.png 1280w"></a><figcaption>Successful generation of Unbound Python docs with Sphinx</figcaption></figure><p>Next, take a backup of your OS or VM and install <code>libtools</code> and <code>swig</code> wherever, <code>./configure --with-pythonmodule</code>, <code>make</code>, fix some errors in the Unbound code, <code>make</code> again, then you’ll have the generated python module (<code>unboundmodule.py</code>) in order to remove all the missing-method red error lines in PyCharm.</p><figure id="attachment_5644"><a href="https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about.png"><img src="https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-754x314.png" alt="PyCharm can now find the missing methods we don't actually need to worry about" width="754" height="314" srcset="https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-754x314.png 754w, https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-300x125.png 300w, https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-600x249.png 600w, https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about.png 885w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-754x314.png" data-srcset="https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-754x314.png 754w, https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-300x125.png 300w, https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about-600x249.png 600w, https://static.ericdraken.com/files/PyCharm-can-now-find-the-missing-methods-we-dont-actually-need-to-worry-about.png 885w"></a><figcaption>PyCharm can now find the missing methods we don’t actually need to worry about</figcaption></figure><figure id="attachment_5647"><a href="https://static.ericdraken.com/files/First-successful-DNS-response-logging-script.png"><img src="https://static.ericdraken.com/files/First-successful-DNS-response-logging-script-754x489.png" alt="First successful DNS response logging script" width="754" height="489" srcset="https://static.ericdraken.com/files/First-successful-DNS-response-logging-script-754x489.png 754w, https://static.ericdraken.com/files/First-successful-DNS-response-logging-script-300x194.png 300w, https://ericdraken.com/files/First-successful-DNS-response-logging-script-600x389.png 600w, https://static.ericdraken.com/files/First-successful-DNS-response-logging-script.png 889w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/First-successful-DNS-response-logging-script-754x489.png" data-srcset="https://static.ericdraken.com/files/First-successful-DNS-response-logging-script-754x489.png 754w, https://static.ericdraken.com/files/First-successful-DNS-response-logging-script-300x194.png 300w, https://ericdraken.com/files/First-successful-DNS-response-logging-script-600x389.png 600w, https://static.ericdraken.com/files/First-successful-DNS-response-logging-script.png 889w"></a><figcaption>First successful DNS response logging script</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Smoke Test: A Python DNS-Hijacking Script</h2><p>Here is a smoke test of the ability to hijack <code>*.google.com</code> DNS requests with reply IPs that the script has caught in just a few minutes (the timestamps are just to maintain a crude LRU cache):</p><figure id="attachment_5651"><a href="https://ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_.png"><img src="https://static.ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-754x733.png" alt="Smoke test for collecting IP addresses of *.google.com" width="754" height="733" srcset="https://static.ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-754x733.png 754w, https://static.ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-300x292.png 300w, https://ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-600x583.png 600w, https://ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_.png 1145w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-754x733.png" data-srcset="https://static.ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-754x733.png 754w, https://static.ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-300x292.png 300w, https://ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_-600x583.png 600w, https://ericdraken.com/files/Smoke-test-for-collecting-IP-addresses-of-.google.com_.png 1145w"></a><figcaption>Smoke test for collecting IP addresses of *.google.com</figcaption></figure><p>Duplicate IP addresses are possible, and that is fine. I let the smoke test run overnight. Here is the PoC (proof of concept) script I ran as the Unbound Python module script.</p><div id="crayon-63661eaabe4c3362457631" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p><p>65</p><p>66</p><p>67</p><p>68</p><p>69</p><p>70</p><p>71</p><p>72</p><p>73</p><p>74</p><p>75</p><p>76</p><p>77</p><p>78</p><p>79</p><p>80</p><p>81</p><p>82</p><p>83</p><p>84</p><p>85</p><p>86</p><p>87</p><p>88</p><p>89</p><p>90</p><p>91</p><p>92</p><p>93</p><p>94</p><p>95</p><p>96</p><p>97</p><p>98</p><p>99</p><p>100</p><p>101</p><p>102</p><p>103</p><p>104</p><p>105</p><p>106</p><p>107</p><p>108</p><p>109</p><p>110</p><p>111</p><p>112</p><p>113</p><p>114</p><p>115</p><p>116</p><p>117</p><p>118</p><p>119</p><p>120</p><p>121</p><p>122</p><p>123</p><p>124</p><p>125</p><p>126</p><p>127</p><p>128</p><p>129</p><p>130</p><p>131</p><p>132</p><p>133</p><p>134</p><p>135</p><p>136</p><p>137</p><p>138</p><p>139</p><p>140</p><p>141</p><p>142</p><p>143</p><p>144</p><p>145</p><p>146</p><p>147</p><p>148</p><p>149</p><p>150</p><p>151</p><p>152</p><p>153</p><p>154</p><p>155</p><p>156</p><p>157</p><p>158</p><p>159</p><p>160</p><p>161</p><p>162</p><p>163</p><p>164</p><p>165</p><p>166</p><p>167</p><p>168</p><p>169</p><p>170</p><p>171</p><p>172</p><p>173</p><p>174</p><p>175</p><p>176</p><p>177</p><p>178</p><p>179</p><p>180</p><p>181</p><p>182</p><p>183</p><p>184</p><p>185</p><p>186</p><p>187</p><p>188</p><p>189</p><p>190</p><p>191</p><p>192</p><p>193</p><p>194</p><p>195</p><p>196</p><p>197</p><p>198</p><p>199</p><p>200</p><p>201</p><p>202</p><p>203</p><p>204</p><p>205</p><p>206</p><p>207</p><p>208</p><p>209</p><p>210</p><p>211</p><p>212</p><p>213</p><p>214</p><p>215</p><p>216</p><p>217</p><p>218</p><p>219</p><p>220</p><p>221</p><p>222</p><p>223</p><p>224</p><p>225</p><p>226</p><p>227</p><p>228</p><p>229</p><p>230</p><p>231</p><p>232</p><p>233</p><p>234</p><p>235</p><p>236</p><p>237</p><p>238</p><p>239</p><p>240</p><p>241</p><p>242</p><p>243</p><p>244</p><p>245</p><p>246</p><p>247</p><p>248</p><p>249</p><p>250</p><p>251</p><p>252</p><p>253</p><p>254</p><p>255</p><p>256</p><p>257</p><p>258</p><p>259</p><p>260</p><p>261</p><p>262</p><p>263</p><p>264</p><p>265</p><p>266</p><p>267</p><p>268</p><p>269</p><p>270</p><p>271</p><p>272</p><p>273</p><p>274</p><p>275</p><p>276</p><p>277</p><p>278</p><p>279</p><p>280</p><p>281</p><p>282</p><p>283</p><p>284</p><p>285</p><p>286</p><p>287</p><p>288</p><p>289</p><p>290</p><p>291</p><p>292</p><p>293</p><p>294</p><p>295</p><p>296</p><p>297</p><p>298</p><p>299</p><p>300</p><p>301</p></div></td><td><div><p><span># -*- coding: utf-8 -*-</span></p><p><span>#&nbsp;&nbsp;Copyright (c) 2021. Eric Draken (ericdraken.com)</span></p><p><span>import</span><span> </span><span>ipaddress</span></p><p><span>import</span><span> </span><span>json</span></p><p><span>import</span><span> </span><span>os</span></p><p><span>import</span><span> </span><span>ssl</span></p><p><span>import</span><span> </span><span>sys</span></p><p><span>import</span><span> </span><span>time</span></p><p><span>import</span><span> </span><span>urllib</span><span>.</span><span>request</span></p><p><span>from</span><span> </span><span>typing </span><span>import</span><span> </span><span>Final</span><span>,</span><span> </span><span>Union</span></p><p><span>FILENAME</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>os.path</span><span>.</span><span>splitext</span><span>(</span><span>os.path</span><span>.</span><span>basename</span><span>(</span><span>__file__</span><span>)</span><span>)</span><span>[</span><span>0</span><span>]</span><span>.</span><span>upper</span><span>(</span><span>)</span></p><p><span>ALIAS_VPN_WILDCARDS</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>"VPN_wildcards"</span></p><p><span>ALIAS_VPN_DOMAINS</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>"VPN_domains"</span></p><p><span>ALIAS_VPN_WILDCARDS_TTL</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>60</span><span> </span><span>*</span><span> </span><span>60</span><span>&nbsp;&nbsp;</span><span># 1 Hour</span></p><p><span>ALIAS_VPN_WILDCARDS_CAPACITY</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>500</span></p><p><span>AUTH_CODE</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>"61646d696e 978c197c37a882f6da23553c1xxxxxxx"</span></p><p><span>TEST_MODE</span><span> </span><span>=</span><span> </span><span>True</span></p><p><span>if</span><span> </span><span>TEST_MODE</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>API_ALIAS_URL</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>"https://pfsense/api/v1/firewall/alias"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>API_ALIAS_ENTRY_URL</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>"https://pfsense/api/v1/firewall/alias/entry"</span></p><p><span>else</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>API_ALIAS_URL</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>"https://127.0.0.1/api/v1/firewall/alias"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>API_ALIAS_ENTRY_URL</span><span>:</span><span> </span><span>Final</span><span> </span><span>=</span><span> </span><span>"https://127.0.0.1/api/v1/firewall/alias/entry"</span></p><p><span># ***********************************</span></p><p><span>__wildcard_patterns</span><span> </span><span>=</span><span> </span><span>set</span><span>(</span><span>)</span></p><p><span>if</span><span> </span><span>TEST_MODE</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>log_info</span><span>(</span><span>msg</span><span>=</span><span>""</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>print</span><span>(</span><span>f</span><span>"{FILENAME}: {msg}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>log_err</span><span>(</span><span>msg</span><span>=</span><span>""</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>print</span><span>(</span><span>f</span><span>"{FILENAME}: {msg}"</span><span>)</span></p><p><span>else</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># noinspection PyUnresolvedReferences,PyUnboundLocalVariable</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>except</span><span> </span><span>NameError</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Added to suppress IDE errors about missing functions and constants</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>from</span><span> </span><span>unbound</span><span>.</span><span>pythonmod</span><span>.</span><span>unboundmodule </span><span>import</span><span> </span><span>(</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>register_inplace_cb_reply</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>register_inplace_cb_reply_cache</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>register_inplace_cb_reply_local</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MODULE_EVENT_NEW</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MODULE_EVENT_PASS</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MODULE_WAIT_MODULE</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MODULE_EVENT_MODDONE</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MODULE_FINISHED</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_err</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>MODULE_ERROR</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Clarity of log messages</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>__old_log_info</span><span> </span><span>=</span><span> </span><span>log_info</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>__old_log_err</span><span> </span><span>=</span><span> </span><span>log_err</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>log_info</span><span>(</span><span>msg</span><span>=</span><span>""</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>__old_log_info</span><span>(</span><span>f</span><span>"{FILENAME}: {msg}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>log_err</span><span>(</span><span>msg</span><span>=</span><span>""</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>__old_log_err</span><span>(</span><span>f</span><span>"{FILENAME}: {msg}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>log_response</span><span>(</span><span>qstate</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>not</span><span> </span><span>qstate</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>r</span><span> </span><span>=</span><span> </span><span>None</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>qstate</span><span>.</span><span>return_msg </span><span>and</span><span> </span><span>qstate</span><span>.</span><span>return_msg</span><span>.</span><span>rep</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>r</span><span> </span><span>=</span><span> </span><span>qstate</span><span>.</span><span>return_msg</span><span>.</span><span>rep</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>q</span><span> </span><span>=</span><span> </span><span>None</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>qstate</span><span>.</span><span>return_msg </span><span>and</span><span> </span><span>qstate</span><span>.</span><span>return_msg</span><span>.</span><span>qinfo</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>q</span><span> </span><span>=</span><span> </span><span>qstate</span><span>.</span><span>return_msg</span><span>.</span><span>qinfo</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>q</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>test</span><span> </span><span>=</span><span> </span><span>str</span><span>(</span><span>q</span><span>.</span><span>qname_str</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>any</span><span>(</span><span>x</span><span> </span><span>in</span><span> </span><span>test</span><span> </span><span>for</span><span> </span><span>x</span><span> </span><span>in</span><span> </span><span>__wildcard_patterns</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>"HIT Query: %s, type: %s (%d), class: %s (%d) "</span><span> </span><span>%</span><span> </span><span>(</span><span>q</span><span>.</span><span>qname_str</span><span>,</span><span> </span><span>q</span><span>.</span><span>qtype_str</span><span>,</span><span> </span><span>q</span><span>.</span><span>qtype</span><span>,</span><span> </span><span>q</span><span>.</span><span>qclass_str</span><span>,</span><span> </span><span>q</span><span>.</span><span>qclass</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>r</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Do not crash the whole Unbound service</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>i</span><span> </span><span>in</span><span> </span><span>range</span><span>(</span><span>0</span><span>,</span><span> </span><span>r</span><span>.</span><span>rrset_count</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>rr</span><span> </span><span>=</span><span> </span><span>r</span><span>.</span><span>rrsets</span><span>[</span><span>i</span><span>]</span><span>&nbsp;&nbsp;</span><span># ReplyInfo_RRSet</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>rk</span><span> </span><span>=</span><span> </span><span>rr</span><span>.</span><span>rk</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>rk</span><span>.</span><span>rrset_class_str</span><span> </span><span>==</span><span> </span><span>"IN"</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>d</span><span> </span><span>=</span><span> </span><span>rr</span><span>.</span><span>entry</span><span>.</span><span>data</span><span>&nbsp;&nbsp;</span><span># RRSetData_RRData</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>j</span><span> </span><span>in</span><span> </span><span>range</span><span>(</span><span>0</span><span>,</span><span> </span><span>d</span><span>.</span><span>count</span><span> </span><span>+</span><span> </span><span>d</span><span>.</span><span>rrsig_count</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>rk</span><span>.</span><span>type_str</span><span> </span><span>==</span><span> </span><span>"A"</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ip</span><span> </span><span>=</span><span> </span><span>ipaddress</span><span>.</span><span>IPv4Address</span><span>(</span><span>d</span><span>.</span><span>rr_data</span><span>[</span><span>j</span><span>]</span><span>[</span><span>2</span><span>:</span><span>]</span><span>)</span><span>.</span><span>exploded</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>elif</span><span> </span><span>rk</span><span>.</span><span>type_str</span><span> </span><span>==</span><span> </span><span>"AAAA"</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ip</span><span> </span><span>=</span><span> </span><span>ipaddress</span><span>.</span><span>IPv6Address</span><span>(</span><span>d</span><span>.</span><span>rr_data</span><span>[</span><span>j</span><span>]</span><span>[</span><span>2</span><span>:</span><span>]</span><span>)</span><span>.</span><span>exploded</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Not an A or AAAA record</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>continue</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"{j}: IP: {ip!s}, TTL={d.rr_ttl[j]!s}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>add_wildcard_ips</span><span>(</span><span>str</span><span>(</span><span>ip</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>except</span><span> </span><span>Exception</span><span> </span><span>as</span><span> </span><span>e</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>exc_type</span><span>,</span><span> </span><span>exc_obj</span><span>,</span><span> </span><span>exc_tb</span><span> </span><span>=</span><span> </span><span>sys</span><span>.</span><span>exc_info</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_err</span><span>(</span><span>f</span><span>"{exc_type}, {exc_tb.tb_lineno}, {e}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>inplace_reply_callback</span><span>(</span><span>qinfo</span><span>,</span><span> </span><span>qstate</span><span>,</span><span> </span><span>rep</span><span>,</span><span> </span><span>rcode</span><span>,</span><span> </span><span>edns</span><span>,</span><span> </span><span>opt_list_out</span><span>,</span><span> </span><span>region</span><span>,</span><span> </span><span>*</span><span>*</span><span>kwargs</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_response</span><span>(</span><span>qstate</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>inplace_cache_callback</span><span>(</span><span>qinfo</span><span>,</span><span> </span><span>qstate</span><span>,</span><span> </span><span>rep</span><span>,</span><span> </span><span>rcode</span><span>,</span><span> </span><span>edns</span><span>,</span><span> </span><span>opt_list_out</span><span>,</span><span> </span><span>region</span><span>,</span><span> </span><span>*</span><span>*</span><span>kwargs</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># log_response(qstate)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>inplace_local_callback</span><span>(</span><span>qinfo</span><span>,</span><span> </span><span>qstate</span><span>,</span><span> </span><span>rep</span><span>,</span><span> </span><span>rcode</span><span>,</span><span> </span><span>edns</span><span>,</span><span> </span><span>opt_list_out</span><span>,</span><span> </span><span>region</span><span>,</span><span> </span><span>*</span><span>*</span><span>kwargs</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># log_response(qstate)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>init_standard</span><span>(</span><span>id_</span><span>,</span><span> </span><span>env</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>"Init start"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Register the inplace_reply_callback function as an inplace callback</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># function when answering a resolved query.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>not</span><span> </span><span>register_inplace_cb_reply</span><span>(</span><span>inplace_reply_callback</span><span>,</span><span> </span><span>env</span><span>,</span><span> </span><span>id_</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Register the inplace_cache_callback function as an inplace callback</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># function when answering from cache.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>not</span><span> </span><span>register_inplace_cb_reply_cache</span><span>(</span><span>inplace_cache_callback</span><span>,</span><span> </span><span>env</span><span>,</span><span> </span><span>id_</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Register the inplace_local_callback function as an inplace callback</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># function when answering from local data.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>not</span><span> </span><span>register_inplace_cb_reply_local</span><span>(</span><span>inplace_local_callback</span><span>,</span><span> </span><span>env</span><span>,</span><span> </span><span>id_</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Prepare the aliases</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>recreate_vpn_wildcards</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>global</span><span> </span><span>__wildcard_patterns</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>__wildcard_patterns</span><span> </span><span>=</span><span> </span><span>get_wildcard_patterns</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>"Init finished"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>deinit</span><span>(</span><span>id_</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>inform_super</span><span>(</span><span>id_</span><span>,</span><span> </span><span>qstate</span><span>,</span><span> </span><span>superqstate</span><span>,</span><span> </span><span>qdata</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>operate</span><span>(</span><span>id_</span><span>,</span><span> </span><span>event</span><span>,</span><span> </span><span>qstate</span><span>,</span><span> </span><span>qdata</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Wait for the Python module</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>(</span><span>event</span><span> </span><span>==</span><span> </span><span>MODULE_EVENT_NEW</span><span>)</span><span> </span><span>or</span><span> </span><span>(</span><span>event</span><span> </span><span>==</span><span> </span><span>MODULE_EVENT_PASS</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>qstate</span><span>.</span><span>ext_state</span><span>[</span><span>id_</span><span>]</span><span> </span><span>=</span><span> </span><span>MODULE_WAIT_MODULE</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Release when the Python module is finished</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>elif</span><span> </span><span>event</span><span> </span><span>==</span><span> </span><span>MODULE_EVENT_MODDONE</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>qstate</span><span>.</span><span>ext_state</span><span>[</span><span>id_</span><span>]</span><span> </span><span>=</span><span> </span><span>MODULE_FINISHED</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>qstate</span><span>.</span><span>ext_state</span><span>[</span><span>id_</span><span>]</span><span> </span><span>=</span><span> </span><span>MODULE_ERROR</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>True</span></p><p><span>def</span><span> </span><span>request</span><span>(</span><span>url</span><span>:</span><span> </span><span>str</span><span>,</span><span> </span><span>method</span><span>:</span><span> </span><span>str</span><span> </span><span>=</span><span> </span><span>"GET"</span><span>,</span><span> </span><span>body</span><span>:</span><span> </span><span>object</span><span> </span><span>=</span><span> </span><span>None</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Must be HTTPS</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>req</span><span> </span><span>=</span><span> </span><span>urllib</span><span>.</span><span>request</span><span>.</span><span>Request</span><span>(</span><span>url</span><span>=</span><span>url</span><span>,</span><span> </span><span>method</span><span>=</span><span>method</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>req</span><span>.</span><span>add_header</span><span>(</span><span>"Content-Type"</span><span>,</span><span> </span><span>"application/json"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>req</span><span>.</span><span>add_header</span><span>(</span><span>"Accept"</span><span>,</span><span> </span><span>"application/json"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>req</span><span>.</span><span>add_header</span><span>(</span><span>"Authorization"</span><span>,</span><span> </span><span>AUTH_CODE</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span> </span><span>=</span><span> </span><span>ssl</span><span>.</span><span>create_default_context</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span>.</span><span>check_hostname</span><span> </span><span>=</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span>.</span><span>verify_mode</span><span> </span><span>=</span><span> </span><span>ssl</span><span>.</span><span>CERT_NONE</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>data</span><span> </span><span>=</span><span> </span><span>None</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>body</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>data</span><span> </span><span>=</span><span> </span><span>json</span><span>.</span><span>dumps</span><span>(</span><span>body</span><span>)</span><span>.</span><span>encode</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>req</span><span>.</span><span>add_header</span><span>(</span><span>"Content-Length"</span><span>,</span><span> </span><span>str</span><span>(</span><span>len</span><span>(</span><span>data</span><span>)</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>res</span><span> </span><span>=</span><span> </span><span>urllib</span><span>.</span><span>request</span><span>.</span><span>urlopen</span><span>(</span><span>req</span><span>,</span><span> </span><span>data</span><span>,</span><span> </span><span>context</span><span>=</span><span>ctx</span><span>,</span><span> </span><span>timeout</span><span>=</span><span>1</span><span>)</span><span>&nbsp;&nbsp;</span><span># Short timeout!</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>json_</span><span> </span><span>=</span><span> </span><span>json</span><span>.</span><span>load</span><span>(</span><span>res</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>"data"</span><span> </span><span>not</span><span> </span><span>in</span><span> </span><span>json_</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_err</span><span>(</span><span>f</span><span>"data attribute is missing: {json_}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># log_info(json_)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>json_</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>except</span><span> </span><span>Exception</span><span> </span><span>as</span><span> </span><span>e</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_err</span><span>(</span><span>e</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>False</span></p><p><span>def</span><span> </span><span>recreate_vpn_wildcards</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Check if the VPN_wildcard_ips alias exists</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>aliases</span><span> </span><span>=</span><span> </span><span>request</span><span>(</span><span>API_ALIAS_URL</span><span>,</span><span> </span><span>"GET"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>alias </span><span>in</span><span> </span><span>aliases</span><span>[</span><span>"data"</span><span>]</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>"name"</span><span> </span><span>in</span><span> </span><span>alias </span><span>and</span><span> </span><span>alias</span><span>[</span><span>"name"</span><span>]</span><span> </span><span>==</span><span> </span><span>ALIAS_VPN_WILDCARDS</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"Deleting existing {ALIAS_VPN_WILDCARDS}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># FIXME: If tied to a rule... it 400s</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>request</span><span>(</span><span>API_ALIAS_URL</span><span>,</span><span> </span><span>"DELETE"</span><span>,</span><span> </span><span>{</span><span>"id"</span><span>:</span><span> </span><span>ALIAS_VPN_WILDCARDS</span><span>,</span><span> </span><span>"apply"</span><span>:</span><span> </span><span>True</span><span>}</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>break</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Create</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"Creating {ALIAS_VPN_WILDCARDS}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>request</span><span>(</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>API_ALIAS_URL</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"POST"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"name"</span><span>:</span><span> </span><span>ALIAS_VPN_WILDCARDS</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"type"</span><span>:</span><span> </span><span>"host"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"descr"</span><span>:</span><span> </span><span>f</span><span>"Automatic {ALIAS_VPN_DOMAINS} wildcard expansions"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"address"</span><span>:</span><span> </span><span>[</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"detail"</span><span>:</span><span> </span><span>[</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"apply"</span><span>:</span><span> </span><span>True</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Check</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>aliases</span><span> </span><span>=</span><span> </span><span>request</span><span>(</span><span>API_ALIAS_URL</span><span>,</span><span> </span><span>"GET"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>alias </span><span>in</span><span> </span><span>aliases</span><span>[</span><span>"data"</span><span>]</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>"name"</span><span> </span><span>in</span><span> </span><span>alias </span><span>and</span><span> </span><span>alias</span><span>[</span><span>"name"</span><span>]</span><span> </span><span>==</span><span> </span><span>ALIAS_VPN_WILDCARDS</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"Successfully created {ALIAS_VPN_WILDCARDS}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"Unable to create {ALIAS_VPN_WILDCARDS}"</span><span>)</span></p><p><span>def</span><span> </span><span>evict_wildcard_ips</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>cutoff</span><span> </span><span>=</span><span> </span><span>int</span><span>(</span><span>time</span><span>.</span><span>time</span><span>(</span><span>)</span><span>)</span><span> </span><span>-</span><span> </span><span>ALIAS_VPN_WILDCARDS_TTL</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>res</span><span> </span><span>=</span><span> </span><span>request</span><span>(</span><span>API_ALIAS_URL</span><span>,</span><span> </span><span>"GET"</span><span>,</span><span> </span><span>{</span><span>"name"</span><span>:</span><span> </span><span>ALIAS_VPN_WILDCARDS</span><span>}</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>data</span><span>:</span><span> </span><span>dict</span><span> </span><span>=</span><span> </span><span>res</span><span>[</span><span>"data"</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>data</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>alias</span><span> </span><span>=</span><span> </span><span>data</span><span>.</span><span>popitem</span><span>(</span><span>)</span><span>[</span><span>1</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>addresses</span><span> </span><span>=</span><span> </span><span>str</span><span>(</span><span>alias</span><span>[</span><span>"address"</span><span>]</span><span>)</span><span>.</span><span>split</span><span>(</span><span>" "</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>timestamps</span><span> </span><span>=</span><span> </span><span>str</span><span>(</span><span>alias</span><span>[</span><span>"detail"</span><span>]</span><span>)</span><span>.</span><span>split</span><span>(</span><span>"||"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>assert</span><span> </span><span>len</span><span>(</span><span>addresses</span><span>)</span><span> </span><span>==</span><span> </span><span>len</span><span>(</span><span>timestamps</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>evictable</span><span> </span><span>=</span><span> </span><span>[</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>timestamp</span><span>,</span><span> </span><span>address </span><span>in</span><span> </span><span>zip</span><span>(</span><span>timestamps</span><span>,</span><span> </span><span>addresses</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>int</span><span>(</span><span>timestamp</span><span>)</span><span> </span><span>&lt;</span><span> </span><span>cutoff</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>evictable</span><span>.</span><span>append</span><span>(</span><span>address</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>len</span><span>(</span><span>evictable</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"Evicting {evictable}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>request</span><span>(</span><span>url</span><span>=</span><span>API_ALIAS_ENTRY_URL</span><span>,</span><span> </span><span>method</span><span>=</span><span>"DELETE"</span><span>,</span><span> </span><span>body</span><span>=</span><span>{</span><span>"name"</span><span>:</span><span> </span><span>ALIAS_VPN_WILDCARDS</span><span>,</span><span> </span><span>"address"</span><span>:</span><span> </span><span>evictable</span><span>,</span><span> </span><span>"apply"</span><span>:</span><span> </span><span>True</span><span>}</span><span>)</span></p><p><span>def</span><span> </span><span>add_wildcard_ips</span><span>(</span><span>ips</span><span>:</span><span> </span><span>Union</span><span>[</span><span>str</span><span>,</span><span> </span><span>list</span><span>]</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>isinstance</span><span>(</span><span>ips</span><span>,</span><span> </span><span>str</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ips</span><span> </span><span>=</span><span> </span><span>[</span><span>ips</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ips_repr</span><span> </span><span>=</span><span> </span><span>", "</span><span>.</span><span>join</span><span>(</span><span>ips</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"Adding [{ips_repr}]"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>res</span><span> </span><span>=</span><span> </span><span>request</span><span>(</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>API_ALIAS_ENTRY_URL</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"POST"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"name"</span><span>:</span><span> </span><span>ALIAS_VPN_WILDCARDS</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"type"</span><span>:</span><span> </span><span>"host"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"descr"</span><span>:</span><span> </span><span>ips_repr</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"address"</span><span>:</span><span> </span><span>ips</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"detail"</span><span>:</span><span> </span><span>[</span><span>str</span><span>(</span><span>int</span><span>(</span><span>time</span><span>.</span><span>time</span><span>(</span><span>)</span><span>)</span><span>)</span><span>]</span><span> </span><span>*</span><span> </span><span>len</span><span>(</span><span>ips</span><span>)</span><span>,</span><span>&nbsp;&nbsp;</span><span># Must be a string</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>details</span><span> </span><span>=</span><span> </span><span>res</span><span>[</span><span>"data"</span><span>]</span><span>[</span><span>"detail"</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># len("1638002792||") == 12</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>len</span><span>(</span><span>details</span><span>)</span><span> </span><span>&gt;=</span><span> </span><span>(</span><span>12</span><span> </span><span>*</span><span> </span><span>ALIAS_VPN_WILDCARDS_CAPACITY</span><span>)</span><span> </span><span>-</span><span> </span><span>2</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>"Capacity reached. Starting eviction..."</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>evict_wildcard_ips</span><span>(</span><span>)</span></p><p><span>def</span><span> </span><span>get_wildcard_patterns</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>patterns</span><span> </span><span>=</span><span> </span><span>set</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>res</span><span> </span><span>=</span><span> </span><span>request</span><span>(</span><span>API_ALIAS_URL</span><span>,</span><span> </span><span>"GET"</span><span>,</span><span> </span><span>{</span><span>"name"</span><span>:</span><span> </span><span>ALIAS_VPN_DOMAINS</span><span>}</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>data</span><span>:</span><span> </span><span>dict</span><span> </span><span>=</span><span> </span><span>res</span><span>[</span><span>"data"</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>data</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>alias</span><span> </span><span>=</span><span> </span><span>data</span><span>.</span><span>popitem</span><span>(</span><span>)</span><span>[</span><span>1</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>details</span><span> </span><span>=</span><span> </span><span>str</span><span>(</span><span>alias</span><span>[</span><span>"detail"</span><span>]</span><span>)</span><span>.</span><span>split</span><span>(</span><span>"||"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>detail </span><span>in</span><span> </span><span>details</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>"*."</span><span> </span><span>in</span><span> </span><span>detail </span><span>or</span><span> </span><span>".*"</span><span> </span><span>in</span><span> </span><span>detail</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>patterns</span><span>.</span><span>add</span><span>(</span><span>detail</span><span>.</span><span>replace</span><span>(</span><span>"*."</span><span>,</span><span> </span><span>"."</span><span>)</span><span>.</span><span>replace</span><span>(</span><span>".*"</span><span>,</span><span> </span><span>"."</span><span>)</span><span>)</span><span>&nbsp;&nbsp;</span><span># TODO: Make robust</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>addresses</span><span> </span><span>=</span><span> </span><span>str</span><span>(</span><span>alias</span><span>[</span><span>"address"</span><span>]</span><span>)</span><span>.</span><span>split</span><span>(</span><span>" "</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>address </span><span>in</span><span> </span><span>addresses</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>patterns</span><span>.</span><span>add</span><span>(</span><span>address</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>f</span><span>"Found wildcard patterns: {patterns}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>patterns</span></p><p><span>if</span><span> </span><span>TEST_MODE</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>__name__</span><span> </span><span>==</span><span> </span><span>"__main__"</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>log_info</span><span>(</span><span>"Init start"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>recreate_vpn_wildcards</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>add_wildcard_ips</span><span>(</span><span>"1.2.3.4"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>add_wildcard_ips</span><span>(</span><span>[</span><span>"1.2.3.4"</span><span>,</span><span> </span><span>"1.2.3.5"</span><span>]</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>evict_wildcard_ips</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>get_wildcard_patterns</span><span>(</span><span>)</span></p></div></td></tr></tbody></table></div><p>When I woke up, the Unbound DNS resolver service <strong>segfaulted</strong>. Here are the logs:</p><figure id="attachment_5653"><a href="https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update.png"><img src="https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update.png" alt="We can see a full FQDN alias re-process on each firewall config update" width="626" height="913" srcset="https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update.png 626w, https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update-206x300.png 206w, https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update-600x875.png 600w" sizes="(max-width: 626px) 100vw, 626px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update.png" data-srcset="https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update.png 626w, https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update-206x300.png 206w, https://static.ericdraken.com/files/We-can-see-a-full-FQDN-alias-re-process-on-each-firewall-config-update-600x875.png 600w"></a><figcaption>We can see a full FQDN alias re-process on each firewall config update</figcaption></figure><div><p><strong>Failure:</strong> Capturing all the IPs from the DNS queries to <code>*.googlevideo.com</code> and <code>*.google.com</code> puts pfSense into a crawl as all the rules need to be reloaded on each addition.</p></div><p><a href="#top">Top ↩</a></p><hr><div><p><a name="new-goal2"></a><strong>New Goal:</strong> Research and install a Squid-like proxy, create a fake-but-trusted CA certificate, host it, install it in a browser as a PoC, decode TLS traffic, and victory dance.</p></div><p>Actually, it is <em>not</em> illegal to <a href="https://github.com/NSSpiral/Blackb0x" target="_blank" rel="nofollow">jailbreak most Apple TV boxes</a>, so we could break in, add a root certificate valid for the pfSense box, MITM traffic from the Apple TV, and then Microsoft Bob is your uncle. That works because the pfSense box as the gateway can decrypt Apple TV traffic, inspect the request headers for the offending ad <code>hostname</code>, block the request, and re-encrypt other valid requests to Mountainview, California.</p><p>But, then my iPhone would still show ads because it is harder to jailbreak, plus banking apps may detect this and not work anymore. Jailbreaking is too extreme, anyway.</p><div><p><a name="jailbreak"></a><strong>Fun fact:</strong> I used a jailbroken iPhone all the time in Japan because of a quirky cellphone law. You see, because of icky perverts who like to take photos inappropriately on elevators and escalators, Japan passed a law that made the camera shutter sound mandatory on all photos.<br><span>&nbsp;</span><br>Super unfortunate was that taking a <em>screenshot</em> of a web page also made the same loud, unmuteable shutter sound. Imagine you are on a train and you screenshot a Google map, it makes that loud shutter noise, and then you get dirty looks from the train riders. Yeah, I had to jailbreak and zero out the camera sound file.</p></div><p>Let’s see what it takes to spy on the HTTPS traffic from the Apple TV and iPhone to see if we can block ad URLs that way.</p><p><a href="#top">Top ↩</a></p><hr><h2>Install a Fake-but-Trusted CA Cert on Apple TV and iPhone?</h2><p>Not wanting to jailbreak and add self-signed certs to Apple TV and iPhone, how hard would it be instead to add fake-but-trusted Certificate Authority (CA) certificates to each device?</p><p>The ‘A’ in CA means there is no one higher to vet such a certificate. The ‘A’ is so powerful, that back in 2001 only a Windows patch was able to revoke some <a href="https://en.wikipedia.org/wiki/Verisign#2001:_Code_signing_certificate_mistake" target="_blank" rel="nofollow">dangerous Verisign certificates</a>. As a thought experiment, new CAs must come into existence from time to time. Let’s Encrypt is relatively new, for example. There should then be an in-warranty way to get a fake, trusted CA cert into an Apple TV and iPhone. If that is possible, then an entire world of MITM spycraft is available to decrypt TLS packets in the clear and use good ‘ol URL blocking on requests like</p><div id="crayon-63661eaabe4ce917346489" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>https</span><span>:</span><span>/</span><span>/</span><span>www</span><span>.youtube</span><span>.com</span><span>/</span><span>pagead</span><span>/</span><span>viewthroughconversion</span><span>/</span><span>.</span><span>.</span><span>.</span></p><p><span>https</span><span>:</span><span>/</span><span>/</span><span>www</span><span>.youtube</span><span>.com</span><span>/</span><span>pagead</span><span>/</span><span>conversion</span><span>/</span><span>.</span><span>.</span><span>.</span></p></div></td></tr></tbody></table></div><p>Let’s see how easy this would be.</p><figure id="attachment_5684"><a href="https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too.jpg"><img src="https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-754x353.jpg" alt="We can add fake, trusted CA certs to iPhone too" width="754" height="353" srcset="https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-754x353.jpg 754w, https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-300x141.jpg 300w, https://static.ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-600x281.jpg 600w, https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too.jpg 1280w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-754x353.jpg" data-srcset="https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-754x353.jpg 754w, https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-300x141.jpg 300w, https://static.ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too-600x281.jpg 600w, https://ericdraken.com/files/We-can-add-fake-trusted-CA-certs-to-iPhone-too.jpg 1280w"></a><figcaption>We can add fake, trusted CA certs to iPhone too</figcaption></figure><p>In fact, there are many, many CAs. Here is a quick <code>find / -name "*.pem"</code> in pfSense:</p><figure id="attachment_5702"><a href="https://static.ericdraken.com/files/Many-CAs-exist-already.png"><img src="https://static.ericdraken.com/files/Many-CAs-exist-already-754x320.png" alt="Many CAs exist already" width="754" height="320" srcset="https://static.ericdraken.com/files/Many-CAs-exist-already-754x320.png 754w, https://static.ericdraken.com/files/Many-CAs-exist-already-300x127.png 300w, https://static.ericdraken.com/files/Many-CAs-exist-already-600x254.png 600w, https://static.ericdraken.com/files/Many-CAs-exist-already.png 880w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Many-CAs-exist-already-754x320.png" data-srcset="https://static.ericdraken.com/files/Many-CAs-exist-already-754x320.png 754w, https://static.ericdraken.com/files/Many-CAs-exist-already-300x127.png 300w, https://static.ericdraken.com/files/Many-CAs-exist-already-600x254.png 600w, https://static.ericdraken.com/files/Many-CAs-exist-already.png 880w"></a><figcaption>Many CAs exist already</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Experiment with Squid and SquidGuard</h2><p>I’m aware of <a href="https://mitmproxy.org/" target="_blank" rel="nofollow">mitmproxy</a>, but it needs to be side-channel installed onto the pfSense router. Let’s see if the <code>squid3</code> proxy that is available as a pfSense package can do what we need. First, I will take a bare-metal backup again so I can roll back in case <code>mitmproxy</code> is better.</p><figure id="attachment_5691"><a href="https://static.ericdraken.com/files/Install-squid3-and-ancillary-packages.png"><img src="https://ericdraken.com/files/Install-squid3-and-ancillary-packages-754x348.png" alt="Install squid3 and ancillary packages" width="754" height="348" srcset="https://ericdraken.com/files/Install-squid3-and-ancillary-packages-754x348.png 754w, https://static.ericdraken.com/files/Install-squid3-and-ancillary-packages-300x139.png 300w, https://ericdraken.com/files/Install-squid3-and-ancillary-packages-600x277.png 600w, https://static.ericdraken.com/files/Install-squid3-and-ancillary-packages.png 1147w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Install-squid3-and-ancillary-packages-754x348.png" data-srcset="https://ericdraken.com/files/Install-squid3-and-ancillary-packages-754x348.png 754w, https://static.ericdraken.com/files/Install-squid3-and-ancillary-packages-300x139.png 300w, https://ericdraken.com/files/Install-squid3-and-ancillary-packages-600x277.png 600w, https://static.ericdraken.com/files/Install-squid3-and-ancillary-packages.png 1147w"></a><figcaption>Install squid3 and ancillary packages</figcaption></figure><p>I’ve installed those packages, and naturally, there are more buttons and options than in a space shuttle. I’ll find a <a href="https://turbofuture.com/internet/Intercepting-HTTPS-Traffic-Using-the-Squid-Proxy-in-pfSense" target="_blank" rel="nofollow">guide</a>.</p><p>I’ve followed the steps in the guide, however, since I have a large SSD and generous RAM, I’ve made a dedicated folder <code>/squid_cache</code> (and <code>chown squid:proxy</code>) with 8 GiB of cache and a juicy allowance on the per-item cache size which should also help with Docker and NPM speed-up. Two birds, one stone. With Transparent HTTPS support, this should be pretty rad.</p><div><p><strong>Tip:</strong> If web traffic slows down while using Squid, here are some System Tunables that can make Squid faster (<a href="https://forum.netgate.com/topic/85937/pfsense-2-2-3-internet-is-very-slow-via-squid3/12" target="_blank" rel="nofollow">ref</a>):</p><p><code>vfs.read_max 128</code><br><code>kern.ipc.nmbclusters 32768</code></p><p>Also, for local disk cache, <code>aufs</code> is asynchronous <code>ufs</code> (great for Docker too) and uses POSIX-threads to avoid blocking the main Squid process on disk-I/O.<br></p></div><p>We can actually generate a CA cert in pfSense itself.</p><figure id="attachment_5695"><a href="https://static.ericdraken.com/files/Generate-a-CA-in-pfSense.png"><img src="https://static.ericdraken.com/files/Generate-a-CA-in-pfSense-754x275.png" alt="Generate a CA in pfSense" width="754" height="275" srcset="https://static.ericdraken.com/files/Generate-a-CA-in-pfSense-754x275.png 754w, https://ericdraken.com/files/Generate-a-CA-in-pfSense-300x109.png 300w, https://ericdraken.com/files/Generate-a-CA-in-pfSense-600x219.png 600w, https://static.ericdraken.com/files/Generate-a-CA-in-pfSense.png 1137w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Generate-a-CA-in-pfSense-754x275.png" data-srcset="https://static.ericdraken.com/files/Generate-a-CA-in-pfSense-754x275.png 754w, https://ericdraken.com/files/Generate-a-CA-in-pfSense-300x109.png 300w, https://ericdraken.com/files/Generate-a-CA-in-pfSense-600x219.png 600w, https://static.ericdraken.com/files/Generate-a-CA-in-pfSense.png 1137w"></a><figcaption>Generate a CA in pfSense</figcaption></figure><p>Now, how to get it into the Apple TV and iPhone? It should be hosted somewhere, right? How about on the router?</p><p><a href="#top">Top ↩</a></p><hr><h2>Self-Host the MITM CA Certificate</h2><p>Self-hosting with a single command is ridiculously easy. From the SSH shell into pfSense, I can create a web folder and server like so:</p><div id="crayon-63661eaabe4d3248535284" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>mkdir</span><span> </span><span>/</span><span>www</span></p><p><span>chown</span><span> </span><span>-</span><span>R</span><span> </span><span>squid</span><span>:</span><span>proxy</span><span> </span><span>/</span><span>www</span></p><p><span>chmod</span><span> </span><span>-</span><span>R</span><span> </span><span>644</span><span> </span><span>/</span><span>www</span></p><p><span>echo</span><span> </span><span>"Hello"</span><span> </span><span>&gt;</span><span> </span><span>/</span><span>www</span><span>/</span><span>index</span><span>.php</span></p><p><span>php</span><span> </span><span>-</span><span>S</span><span> </span><span>0.0.0.0</span><span>:</span><span>8000</span><span> </span><span>-</span><span>t</span><span> </span><span>/</span><span>www</span></p></div></td></tr></tbody></table></div><p>When I visit <code>//pfsense:8000</code> I should get a blank page with “Hello”. From here, clients behind the pfSense router can temporarily access static documents.</p><p>To make like easier, here is a PHP script to cause the MITM cert to download.</p><div id="crayon-63661eaabe4d5989096513" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>&lt;?php</span></p><p><span>$file</span><span> </span><span>=</span><span> </span><span>'/www/mitm.crt'</span><span>;</span></p><p><span>if</span><span> </span><span>(</span><span>file_exists</span><span>(</span><span>$file</span><span>)</span><span>)</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>header</span><span>(</span><span>'Content-Description: File Transfer'</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>header</span><span>(</span><span>'Content-Type: application/octet-stream'</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>header</span><span>(</span><span>'Content-Disposition: attachment; filename="'</span><span>.</span><span>basename</span><span>(</span><span>$file</span><span>)</span><span>.</span><span>'"'</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>header</span><span>(</span><span>'Expires: 0'</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>header</span><span>(</span><span>'Cache-Control: must-revalidate'</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>header</span><span>(</span><span>'Pragma: public'</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>header</span><span>(</span><span>'Content-Length: '</span><span> </span><span>.</span><span> </span><span>filesize</span><span>(</span><span>$file</span><span>)</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>readfile</span><span>(</span><span>$file</span><span>)</span><span>;</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>exit</span><span>;</span></p><p><span>}</span></p><p><span>echo</span><span> </span><span>"Not found"</span><span>;</span></p></div></td></tr></tbody></table></div><p>As another smoke test, I’ll add the MITM CA to Chrome (manually) and enable the SSL Filtering. The defaults are fine in Squid. Here is the log file when I visit <code>https://ericdraken.com</code>:</p><figure id="attachment_5704"><a href="https://ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client.png"><img src="https://ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-754x122.png" alt="Successful capture of TLS requests from a downstream client" width="754" height="122" srcset="https://ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-754x122.png 754w, https://static.ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-300x48.png 300w, https://static.ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-600x97.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-754x122.png" data-srcset="https://ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-754x122.png 754w, https://static.ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-300x48.png 300w, https://static.ericdraken.com/files/Successful-capture-of-TLS-requests-from-a-downstream-client-600x97.png 600w"></a><figcaption>Successful capture of TLS requests from a downstream client</figcaption></figure><p>Excellent.</p><p>However, on every other browser and machine there are HTTPS errors like so:</p><figure id="attachment_5705"><a href="https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing.png"><img src="https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-754x485.png" alt="MITM certificate errors if the CA cert is missing" width="754" height="485" srcset="https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-754x485.png 754w, https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-300x193.png 300w, https://ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-600x386.png 600w, https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing.png 966w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-754x485.png" data-srcset="https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-754x485.png 754w, https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-300x193.png 300w, https://ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing-600x386.png 600w, https://static.ericdraken.com/files/MITM-certificate-errors-if-the-CA-cert-is-missing.png 966w"></a><figcaption>MITM certificate errors if the CA cert is missing</figcaption></figure><div><p><strong>Locked out?</strong> If you get locked out of pfSense with a TLS error, you may have to disable Remote Cert Checks as the pfSense web configurator uses a self-signed certificate. Or else, you can bypass the proxy for the pfSense UI under <em>Bypass Proxy for These Destination IPs</em> with <code>pfsense; pfsense.localdomain</code>.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Abandoning Squid: Too Slow, Too Heavy</h2><p>After a day of painfully setting up Squid and SquidGuard and adding blacklists and even manual regex for things like <code>.+?/pagead/.+</code>, I’m having nothing but issues with Squid. Here are the top pain points:</p><ul><li>It’s slow. It’s really slow.</li><li>The ACL (Access Control List) settings are cumbersome.</li><li>There is an issue with <code>https://http/*</code> (<a href="https://forum.netgate.com/topic/141472/https-filter-with-https-http" target="_blank" rel="nofollow">ref</a>).</li><li>The SquidGuard URL filter takes eons to update a list.</li><li>The Squid UI is unbelievably lacking.</li></ul><p>Squid makes me sad. I don’t get sad, but Squid makes me sad with its promise and ultimate letdown. I’ve now obliterated Squid and restored the router from the <code>rsync</code> backup I made earlier. Here is a handy little script to show a diff of what has been added by Squid and related packages.</p><h3>Rsync Diff of Changes</h3><div id="crayon-63661eaabe4d9273516381" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p></div></td><td><div><p><span># Show the changed files since the last rsync.</span></p><p><span># Fix brace expansion and execute (easy to read with tr and sed).</span></p><p><span>cat</span><span> </span><span>&lt;&lt;</span><span> </span><span>EOF</span><span> </span><span>|</span><span> </span><span>tr</span><span> </span><span>-</span><span>s</span><span> </span><span>' '</span><span> </span><span>|</span><span> </span><span>sed</span><span> </span><span>'s/, "/,"/g'</span><span> </span><span>|</span><span> </span><span>bash</span></p><p><span>time</span><span> </span><span>\</span></p><p><span>rsync</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>verbose</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>human</span><span>-</span><span>readable</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>links</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>recursive</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>checksum</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>update</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>delete</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>dry</span><span>-</span><span>run</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>exclude</span><span>=</span><span>{</span><span>"/dev/*"</span><span>,</span><span>"/proc/*"</span><span>,</span><span>"/sys/*"</span><span>,</span><span>"/tmp/*"</span><span>,</span><span>"/run/*"</span><span>,</span><span>\</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span>"/var/*"</span><span>,</span><span>"/mnt/*"</span><span>,</span><span>"/media/*"</span><span>,</span><span>"/lost+found"</span><span>}</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>rsh</span><span>=</span><span>"ssh -p 2222"</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>~</span><span>/</span><span>.pfsense</span><span>-</span><span>backup</span><span>/</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>admin</span><span>@</span><span>pfsense</span><span>:</span><span>/</span><span> </span><span>|</span><span> </span><span>grep</span><span> </span><span>-</span><span>v</span><span> </span><span>'/$'</span><span>&nbsp;&nbsp;</span><span># Hide folders</span></p><p><span>EOF</span></p></div></td></tr></tbody></table></div><p>The output is something like this under the <code>--dry-run</code> option:</p><div id="crayon-63661eaabe4db777065170" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="hide"></td><td><div><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squidGuard</span><span>/</span><span>squidguard_conf</span><span>.xml</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squidGuard</span><span>/</span><span>squidGuard_blk_rebuild</span><span>.conf</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squidGuard</span><span>/</span><span>squidGuard__usrdbrebuild</span><span>.conf</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squidGuard</span><span>/</span><span>squidGuard</span><span>.conf</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squidGuard</span><span>/</span><span>blacklist</span><span>.files</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squid</span><span>/</span><span>squidGuard</span><span>.conf</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squid</span><span>/</span><span>squid</span><span>.conf</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squid</span><span>/</span><span>serverkey</span><span>.pem</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>squid</span><span>/</span><span>exclude_domains</span><span>.conf</span></p><p><span>deleting </span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>lightsquid</span><span>/</span><span>lightsquid</span><span>.cfg</span></p><p><span>.</span><span>.</span><span>.</span></p></div></td></tr></tbody></table></div><p><a href="#top">Top ↩</a></p><hr><h2>Install MITMProxy in a FreeBSD Jail</h2><p>Even though written in Python, I’ll give <a href="https://mitmproxy.org/" target="_blank" rel="nofollow">mitmproxy</a> a try next; at the very least it can be purpose-built to block YouTube ads with its rich API and Python-hook extensibility. It was a coin toss between <code>mitmproxy</code> and <code>SSLSplit</code> – a Metasploit hack tool – to achieve on-the-fly TLS interception, but the former can be scripted with Python and has a satisfying UI. Let’s go.</p><div><p><strong>Careful:</strong> Please read the whole section before trying any commands because I backtracked a bit but want to explain why.</p></div><div id="crayon-63661eaabe4de391025133" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>set </span><span>LATEST</span><span>=</span><span>7.0.4</span></p><p><span>mkdir</span><span> </span><span>/</span><span>tmp</span><span>/</span><span>mitm</span><span>-</span><span>$</span><span>{</span><span>LATEST</span><span>}</span><span> </span><span>&amp;&amp;</span><span> </span><span>cd</span><span> </span><span>/</span><span>tmp</span><span>/</span><span>mitm</span><span>-</span><span>$</span><span>{</span><span>LATEST</span><span>}</span></p><p><span>curl </span><span>https</span><span>:</span><span>/</span><span>/</span><span>snapshots</span><span>.mitmproxy</span><span>.org</span><span>/</span><span>$</span><span>{</span><span>LATEST</span><span>}</span><span>/</span><span>mitmproxy</span><span>-</span><span>$</span><span>{</span><span>LATEST</span><span>}</span><span>-</span><span>linux</span><span>.tar</span><span>.gz</span><span> </span><span>--</span><span>output</span><span> </span><span>mitmproxy</span><span>-</span><span>$</span><span>{</span><span>LATEST</span><span>}</span><span>.tar</span><span>.gz</span></p><p><span>tar</span><span> </span><span>-</span><span>xvzf</span><span> </span><span>mitmproxy</span><span>-</span><span>$</span><span>{</span><span>LATEST</span><span>}</span><span>.tar</span><span>.gz</span><span> </span><span>&amp;&amp;</span><span> </span><span>rm</span><span> </span><span>mitmproxy</span><span>-</span><span>$</span><span>{</span><span>LATEST</span><span>}</span><span>.tar</span><span>.gz</span></p></div></td></tr></tbody></table></div><p>You’ll notice that there are only three binaries about 24 MiB each. As I understand it, they have a self-contained Python 3 environment and frozen dependencies. I’d like to jail these binaries because, well, because. First, let’s see if there is a vulnerability report for <code>mitmproxy</code> at <a href="https://vuxml.freebsd.org/freebsd/index.html" target="_blank" rel="nofollow">vuxml.freebsd.org</a>. Nothing. How about at <a href="https://www.exploit-db.com/" target="_blank" rel="nofollow">Exploit-DB</a>? Nothing again. Good.</p><p>First, what version of FreeBSD is this pfSense install?</p><div id="crayon-63661eaabe4e0675538432" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>freebsd</span><span>-</span><span>version</span><span> </span><span>-</span><span>k</span></p><p><span># 12.2-Stable</span></p><p><span>getconf</span><span> </span><span>LONG_BIT</span></p><p><span># 64 - This means we are using a 64-bit build</span></p></div></td></tr></tbody></table></div><p>Now, according to this <a href="https://blog.viktorpetersson.com/2018/01/27/jails-on-pfsense.html" target="_blank" rel="nofollow">guide</a>, I’ll need to set up jails myself as they are disabled in a default pfSense installation. Not knowing FreeBSD at all before today, I had to hack around to find a URL to download the <code>ezjail</code> package manually. After another bare-metal backup, here are the steps I took:</p><div id="crayon-63661eaabe4e2901951388" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p></div></td><td><div><p><span># Set versions</span></p><p><span>set </span><span>EZ_VER</span><span>=</span><span>3.4.2_1</span></p><p><span>set </span><span>BSD_VER</span><span>=</span><span>12</span></p><p><span># Install the ezjail package manually</span></p><p><span>mkdir</span><span> </span><span>/</span><span>tmp</span><span>/</span><span>ezjail</span><span> </span><span>&amp;&amp;</span><span> </span><span>cd</span><span> </span><span>/</span><span>tmp</span><span>/</span><span>ezjail</span></p><p><span>curl </span><span>https</span><span>:</span><span>/</span><span>/</span><span>pkg</span><span>.freebsd</span><span>.org</span><span>/</span><span>FreeBSD</span><span>:</span><span>$</span><span>{</span><span>BSD_VER</span><span>}</span><span>:</span><span>amd64</span><span>/</span><span>latest</span><span>/</span><span>All</span><span>/</span><span>ezjail</span><span>-</span><span>$</span><span>{</span><span>EZ_VER</span><span>}</span><span>.pkg</span><span> </span><span>--</span><span>output</span><span> </span><span>ezjail</span><span>-</span><span>$</span><span>{</span><span>EZ_VER</span><span>}</span><span>.pkg</span></p><p><span>pkg</span><span> </span><span>add</span><span> </span><span>ezjail</span><span>-</span><span>$</span><span>{</span><span>EZ_VER</span><span>}</span><span>.pkg</span></p><p><span># Add a missing jail RC file</span></p><p><span># NOTE: Version 12 does not exist, so use 11</span></p><p><span>curl</span><span> </span><span>--</span><span>output </span><span>jail</span><span>.tmp</span><span> </span><span>https</span><span>:</span><span>/</span><span>/</span><span>raw</span><span>.githubusercontent</span><span>.com</span><span>/</span><span>freebsd</span><span>/</span><span>freebsd</span><span>/</span><span>stable</span><span>/</span><span>11</span><span>/</span><span>etc</span><span>/</span><span>rc</span><span>.d</span><span>/</span><span>jail</span></p><p><span># Check that we did not get a 404d file</span></p><p><span>(</span><span>cat</span><span> </span><span>jail</span><span>.tmp</span><span> </span><span>|</span><span> </span><span>grep</span><span> </span><span>-</span><span>q</span><span> </span><span>"FreeBSD"</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>&amp;&amp;</span><span> </span><span>mv</span><span> </span><span>jail</span><span>.tmp</span><span> </span><span>/</span><span>etc</span><span>/</span><span>rc</span><span>.d</span><span>/</span><span>jail</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>&amp;&amp;</span><span> </span><span>chmod</span><span> </span><span>+</span><span>x</span><span> </span><span>/</span><span>etc</span><span>/</span><span>rc</span><span>.d</span><span>/</span><span>jail</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>&amp;&amp;</span><span> </span><span>chmod</span><span> </span><span>u</span><span>-</span><span>w</span><span> </span><span>/</span><span>etc</span><span>/</span><span>rc</span><span>.d</span><span>/</span><span>jail</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>&amp;&amp;</span><span> </span><span>echo</span><span> </span><span>"Success"</span><span>)</span><span> </span><span>\</span></p><p><span>||</span><span> </span><span>echo</span><span> </span><span>"Download failed"</span></p><p><span># Enable jails by writing a file that may not exist</span></p><p><span>echo</span><span> </span><span>'ezjail_enable="YES"'</span><span> </span><span>|</span><span> </span><span>tee</span><span> </span><span>-</span><span>a</span><span> </span><span>/</span><span>etc</span><span>/</span><span>rc</span><span>.conf</span><span>.local</span></p><p><span># Init jails (takes about 30s)</span></p><p><span>ezjail</span><span>-</span><span>admin </span><span>install</span></p></div></td></tr></tbody></table></div><p>We need to do some hacking to get <code>jail</code> working on pfSense’s take on FreeBSD because <code>jail</code> is missing completely. What I’ve done is copy the <code>jail</code> binaries <em>from</em> a jail (via <code>ezjail</code>) back to the root system.</p><div id="crayon-63661eaabe4e5525186613" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>cd</span><span> </span><span>/</span><span>usr</span><span>/</span><span>sbin</span><span>/</span></p><p><span>cp</span><span> </span><span>/</span><span>usr</span><span>/</span><span>jails</span><span>/</span><span>basejail</span><span>/</span><span>usr</span><span>/</span><span>sbin</span><span>/</span><span>jail </span><span>jail</span><span> </span><span>&amp;&amp;</span><span> </span><span>chmod</span><span> </span><span>+</span><span>x</span><span> </span><span>jail</span></p><p><span>cp</span><span> </span><span>/</span><span>usr</span><span>/</span><span>jails</span><span>/</span><span>basejail</span><span>/</span><span>usr</span><span>/</span><span>sbin</span><span>/</span><span>jail </span><span>jls</span><span> </span><span>&amp;&amp;</span><span> </span><span>chmod</span><span> </span><span>+</span><span>x</span><span> </span><span>jls</span></p><p><span>cp</span><span> </span><span>/</span><span>usr</span><span>/</span><span>jails</span><span>/</span><span>basejail</span><span>/</span><span>usr</span><span>/</span><span>sbin</span><span>/</span><span>jail </span><span>jexec</span><span> </span><span>&amp;&amp;</span><span> </span><span>chmod</span><span> </span><span>+</span><span>x</span><span> </span><span>jexec</span></p></div></td></tr></tbody></table></div><p>Let’s set up a jail for <code>mitmproxy</code>.</p><div id="crayon-63661eaabe4e7652363682" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p></div></td><td><div><p><span># Ignore the warnings that many ports are already bound to 127.0.1.1</span></p><p><span>ezjail</span><span>-</span><span>admin </span><span>create </span><span>mitmproxy</span><span> </span><span>'lo0|127.0.1.1'</span></p><p><span># Disable procfs as we don't need processor info</span></p><p><span>sed</span><span> </span><span>-</span><span>I</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>-</span><span>e</span><span> </span><span>'s/procfs_enable=\"YES\"/procfs_enable=\"NO\"/g'</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>/</span><span>usr</span><span>/</span><span>local</span><span>/</span><span>etc</span><span>/</span><span>ezjail</span><span>/</span><span>mitmproxy</span></p><p><span># Start the jail</span></p><p><span>ezjail</span><span>-</span><span>admin </span><span>start </span><span>mitmproxy</span></p><p><span># Show the jail</span></p><p><span>ezjail</span><span>-</span><span>admin </span><span>list</span></p><p><span># Log into the jail</span></p><p><span># We should get: `root@mitmproxy:~ # `</span></p><p><span>ezjail</span><span>-</span><span>admin </span><span>console </span><span>mitmproxy</span></p><p><span># exit</span></p><p><span># TIP: To delete a jail later:</span></p><p><span># ezjail-admin delete mitmproxy</span></p><p><span># chflags -R noschg /usr/jails/mitmproxy</span></p><p><span># rm -rf /usr/jails/mitmproxy</span></p></div></td></tr></tbody></table></div><p><strong><span>This is very important:</span></strong> We must enable raw sockets in this jail to allow transparent proxy mode to work. If not, MITMProxy will report errors like “Transparent mode failure: FileNotFoundError(2, ‘No such file or directory’)” or “Cannot open connection, no hostname given.” This is because raw sockets are inaccessible and server information is unavailable. We can easily edit the <code>ezjail</code> config file per jail like so:</p><div id="crayon-63661eaabe4e9785826618" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p></div></td><td><div><p><span># Edit: /usr/local/etc/ezjail/mitmproxy</span></p><p><span>#</span></p><p><span># To specify the start-up order of your ezjails, use these lines to</span></p><p><span># create a Jail dependency tree. See rcorder(8) for more details.</span></p><p><span>#</span></p><p><span># PROVIDE: standard_ezjail</span></p><p><span># REQUIRE:</span></p><p><span># BEFORE:</span></p><p><span>#</span></p><p><span># This is very important to work properly with pfSense</span></p><p><span>export </span><span>jail_mitmproxy_parameters</span><span>=</span><span>"allow.raw_sockets=1"</span></p><p><span>export </span><span>jail_mitmproxy_hostname</span><span>=</span><span>"mitmproxy"</span></p><p><span>export </span><span>jail_mitmproxy_ip</span><span>=</span><span>"lo0|127.0.1.1"</span></p><p><span>export </span><span>jail_mitmproxy_rootdir</span><span>=</span><span>"/usr/jails/mitmproxy"</span></p><p><span>export </span><span>jail_mitmproxy_exec_start</span><span>=</span><span>"/bin/sh /etc/rc"</span></p><p><span>export </span><span>jail_mitmproxy_exec_stop</span><span>=</span><span>""</span></p><p><span>export </span><span>jail_mitmproxy_mount_enable</span><span>=</span><span>"YES"</span></p><p><span>export </span><span>jail_mitmproxy_devfs_enable</span><span>=</span><span>"YES"</span></p><p><span>export </span><span>jail_mitmproxy_devfs_ruleset</span><span>=</span><span>"devfsrules_jail"</span></p><p><span>export </span><span>jail_mitmproxy_procfs_enable</span><span>=</span><span>"NO"</span></p><p><span>export </span><span>jail_mitmproxy_fdescfs_enable</span><span>=</span><span>"YES"</span></p><p><span># Restart the jail:</span></p><p><span># /usr/local/etc/rc.d/ezjail restart mitmproxy</span></p></div></td></tr></tbody></table></div><p><strong><span>This is also very important:</span></strong> MITMProxy calls <code>sudo -n /sbin/pfctl -s state</code> but there is no <code>sudo</code> in <code>jail</code>. Run <code>pkg install sudo</code> inside the jail.</p><div><p><strong>Sanity Check:</strong> If you are unsuccessful when you run <code>ping 1.1.1.1</code> inside the jail, you may get an error like this: “ssend socket: Operation not permitted”. If you are successful, then <code>ping</code> works as it needs access to raw sockets.</p></div><p>Now we can copy over the <code>mitmproxy</code> binaries and take them for a spin.</p><div id="crayon-63661eaabe4ec017278571" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># Copy the binaries into the new jail</span></p><p><span>cp</span><span> </span><span>-</span><span>r</span><span> </span><span>/</span><span>tmp</span><span>/</span><span>mitm</span><span>-</span><span>$</span><span>{</span><span>LATEST</span><span>}</span><span> </span><span>/</span><span>usr</span><span>/</span><span>jails</span><span>/</span><span>mitmproxy</span><span>/</span><span>root</span><span>/</span></p><p><span># Deal with some FreeBSD shenanigans about 'ELF binary type 0 not known'</span></p><p><span>brandelf</span><span> </span><span>-</span><span>t</span><span> </span><span>freebsd </span><span>mitm</span><span>*</span></p></div></td></tr></tbody></table></div><p>Things are getting tricky with this next part. Running any of the binaries above results in:</p><div id="crayon-63661eaabe4ee320462538" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># root@mitmproxy:~/mitm-7.0.4 # ./mitmproxy</span></p><p><span># ELF interpreter /lib64/ld-linux-x86-64.so.2 not found, error 2</span></p><p><span># Abort</span></p></div></td></tr></tbody></table></div><p>So, there is no <code>/lib64</code> folder nor any similar dynamic linker that I could find. I tried this, however:</p><div id="crayon-63661eaabe4ef345377858" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>root</span><span>@</span><span>mitmproxy</span><span>:</span><span>~</span><span> </span><span># ln -s /libexec/ld-elf.so.1 /lib64/ld-linux-x86-64.so.2</span></p><p><span>root</span><span>@</span><span>mitmproxy</span><span>:</span><span>~</span><span> </span><span># cd mitm-7.0.4/</span></p><p><span>root</span><span>@</span><span>mitmproxy</span><span>:</span><span>~</span><span>/</span><span>mitm</span><span>-</span><span>7.0.4</span><span> </span><span># ./mitmproxy</span></p><p><span>ld</span><span>-</span><span>elf</span><span>.so</span><span>.</span><span>1</span><span>:</span><span> </span><span>Shared </span><span>object</span><span> </span><span>"libdl.so.2"</span><span> </span><span>not</span><span> </span><span>found</span><span>,</span><span> </span><span>required </span><span>by</span><span> </span><span>"mitmproxy"</span></p><p><span>root</span><span>@</span><span>mitmproxy</span><span>:</span><span>~</span><span>/</span><span>mitm</span><span>-</span><span>7.0.4</span><span> </span><span># ldd mitmproxy</span></p><p><span>mitmproxy</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>libdl</span><span>.so</span><span>.</span><span>2</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>not</span><span> </span><span>found</span><span> </span><span>(</span><span>0</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>libz</span><span>.so</span><span>.</span><span>1</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>not</span><span> </span><span>found</span><span> </span><span>(</span><span>0</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>libpthread</span><span>.so</span><span>.</span><span>0</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>not</span><span> </span><span>found</span><span> </span><span>(</span><span>0</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>libc</span><span>.so</span><span>.</span><span>6</span><span> </span><span>=</span><span>&gt;</span><span> </span><span>not</span><span> </span><span>found</span><span> </span><span>(</span><span>0</span><span>)</span></p><p><span>root</span><span>@</span><span>mitmproxy</span><span>:</span><span>~</span><span>/</span><span>mitm</span><span>-</span><span>7.0.4</span><span> </span><span># </span></p></div></td></tr></tbody></table></div><p>Apparently, there is a <code>pkg install compat6x</code> that can solve this for us (unavailable on pfSense), however, this is getting ridiculous! Let’s try a new tactic. Since we are in a jail, we are not bound to the crippled (read: secured) pfSense environment. Maybe we can install the <code>mitmproxy</code> package normally in a jail?</p><p><code>pkg install mitmproxy</code></p><div id="crayon-63661eaabe4f2162327378" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>.</span><span>.</span><span>.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>py38</span><span>-</span><span>urwid</span><span>:</span><span> </span><span>2.1.2</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>py38</span><span>-</span><span>werkzeug</span><span>:</span><span> </span><span>2.0.1</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>py38</span><span>-</span><span>wsproto</span><span>:</span><span> </span><span>1.0.0</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>py38</span><span>-</span><span>zstandard</span><span>:</span><span> </span><span>0.15.2</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>python38</span><span>:</span><span> </span><span>3.8.12</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>readline</span><span>:</span><span> </span><span>8.1.1</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>sqlite3</span><span>:</span><span> </span><span>3.35.5_3</span><span>,</span><span>1</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>zstd</span><span>:</span><span> </span><span>1.5.0</span></p><p><span>Number </span><span>of </span><span>packages </span><span>to</span><span> </span><span>be </span><span>installed</span><span>:</span><span> </span><span>50</span></p><p><span>The </span><span>process </span><span>will </span><span>require</span><span> </span><span>206</span><span> </span><span>MiB </span><span>more</span><span> </span><span>space</span><span>.</span></p><p><span>33</span><span> </span><span>MiB </span><span>to</span><span> </span><span>be </span><span>downloaded</span><span>.</span></p><p><span>Proceed </span><span>with </span><span>this</span><span> </span><span>action</span><span>?</span><span> </span><span>[</span><span>y</span><span>/</span><span>N</span><span>]</span><span>:</span><span> </span></p></div></td></tr></tbody></table></div><p>And, Bingo was his name-o. After this, simply running <code>mitmproxy</code> in the jailed console opens the MITMProxy UI. Nice. Note, this version <em>may</em> be one or two minor versions behind the master branch. Let’s clean up with <code>rm -rf ~/mitm* /lib64</code> and do another bare-metal backup.</p><p><a href="#top">Top ↩</a></p><hr><h2>Exploring MITMProxy</h2><p>This is getting exciting. First, in pfSense, add a virtual IP for <code>127.0.1.1</code> attached to <code>localhost</code>. Then, add a NAT rule to temporarily forward port <code>[Private IPs]:8080</code> to <code>127.0.1.1:8080</code> to access the proxy from the LANs.</p><p>If not in the jail console, I’ll run</p><div id="crayon-63661eaabe4f4407729574" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>ezjail</span><span>-</span><span>admin </span><span>console </span><span>mitmproxy</span></p><p><span>mitmproxy</span><span> </span><span>--</span><span>listen</span><span>-</span><span>port</span><span> </span><span>8080</span><span> </span><span>--</span><span>set </span><span>console_focus_follow</span><span>=</span><span>true</span></p></div></td></tr></tbody></table></div><p>and add the proxy setting <code>192.168.20.1:8080</code> to my sacrificial notebook (that is auto-wiped daily). When the browser opens, we can already see colourful log entries in the MITMProxy UI.</p><figure id="attachment_5733"><a href="https://ericdraken.com/files/First-logs-of-MITMProxy.png"><img src="https://static.ericdraken.com/files/First-logs-of-MITMProxy-754x117.png" alt="First logs of MITMProxy" width="754" height="117" srcset="https://static.ericdraken.com/files/First-logs-of-MITMProxy-754x117.png 754w, https://static.ericdraken.com/files/First-logs-of-MITMProxy-300x47.png 300w, https://static.ericdraken.com/files/First-logs-of-MITMProxy-600x93.png 600w, https://ericdraken.com/files/First-logs-of-MITMProxy.png 1428w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/First-logs-of-MITMProxy-754x117.png" data-srcset="https://static.ericdraken.com/files/First-logs-of-MITMProxy-754x117.png 754w, https://static.ericdraken.com/files/First-logs-of-MITMProxy-300x47.png 300w, https://static.ericdraken.com/files/First-logs-of-MITMProxy-600x93.png 600w, https://ericdraken.com/files/First-logs-of-MITMProxy.png 1428w"></a><figcaption>First logs of MITMProxy</figcaption></figure><p>The next step is to get the auto-generated CA PEM file used by MITMProxy (<code>~/.mitmproxy/mitmproxy-ca-cert.pem</code>). Since any CA cert here is snake oil, I’ll use the provided one. TLS traffic from my devices is safe as long as I use my own proxies.</p><p>Let’s put our experience from our previous attempt at self-hosting a CA into action. However, there is no PHP in the jail, so we can use a Python 3 web server instead.</p><div id="crayon-63661eaabe4f6549194476" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>set </span><span>PYTHON</span><span>=</span><span>'/usr/local/bin/python3.8'</span></p><p><span>mkdir</span><span> </span><span>~</span><span>/</span><span>www</span></p><p><span># Both Python and mitmproxy run as 'root'</span></p><p><span>chmod</span><span> </span><span>444</span><span> </span><span>~</span><span>/</span><span>.mitmproxy</span><span>/</span><span>mitmproxy</span><span>-</span><span>ca</span><span>-</span><span>cert</span><span>.pem</span></p><p><span>ln</span><span> </span><span>-</span><span>s</span><span> </span><span>~</span><span>/</span><span>.mitmproxy</span><span>/</span><span>mitmproxy</span><span>-</span><span>ca</span><span>-</span><span>cert</span><span>.pem</span><span> </span><span>~</span><span>/</span><span>www</span><span>/</span><span>cert</span><span>.pem</span></p><p><span>$PYTHON</span><span> </span><span>-</span><span>m</span><span> </span><span>http</span><span>.server</span><span> </span><span>--</span><span>bind</span><span> </span><span>127.0.1.1</span><span> </span><span>--</span><span>directory</span><span> </span><span>~</span><span>/</span><span>www</span><span> </span><span>8001</span></p></div></td></tr></tbody></table></div><div><p><strong>Tip:</strong> MITMProxy conveniently has onboarding settings to serve the same CA cert, as we did manually, just by visiting <code>mitm.it</code>.</p></div><p>After installing the CA in the Trusted Root Store on my clean notebook (and rebooting), I am treated to this display:</p><figure id="attachment_5734"><a href="https://ericdraken.com/files/MITM-TLS-interception-is-working-well.png"><img src="https://ericdraken.com/files/MITM-TLS-interception-is-working-well-754x293.png" alt="MITM TLS interception is working well" width="754" height="293" srcset="https://ericdraken.com/files/MITM-TLS-interception-is-working-well-754x293.png 754w, https://ericdraken.com/files/MITM-TLS-interception-is-working-well-300x117.png 300w, https://static.ericdraken.com/files/MITM-TLS-interception-is-working-well-600x233.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/MITM-TLS-interception-is-working-well-754x293.png" data-srcset="https://ericdraken.com/files/MITM-TLS-interception-is-working-well-754x293.png 754w, https://ericdraken.com/files/MITM-TLS-interception-is-working-well-300x117.png 300w, https://static.ericdraken.com/files/MITM-TLS-interception-is-working-well-600x233.png 600w"></a><figcaption>MITM TLS interception is working well</figcaption></figure><p>Let’s see if we can get this cert on my iPhone.</p><figure id="attachment_5738"><a href="https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone.png"><img src="https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-754x372.png" alt="Successfully added a root CA to the iPhone" width="754" height="372" srcset="https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-754x372.png 754w, https://ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-300x148.png 300w, https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-600x296.png 600w, https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone.png 934w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-754x372.png" data-srcset="https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-754x372.png 754w, https://ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-300x148.png 300w, https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone-600x296.png 600w, https://static.ericdraken.com/files/Successfully-added-a-root-CA-to-the-iPhone.png 934w"></a><figcaption>Successfully added a root CA to the iPhone</figcaption></figure><p>This is incredibly exciting. Can we LoJack the Apple TV box next?</p><figure id="attachment_5746"><a href="https://static.ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV.jpg"><img src="https://ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-754x204.jpg" alt="Successfully installed a root CA on the Apple TV" width="754" height="204" srcset="https://ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-754x204.jpg 754w, https://static.ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-300x81.jpg 300w, https://ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-600x162.jpg 600w, https://static.ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV.jpg 1201w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-754x204.jpg" data-srcset="https://ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-754x204.jpg 754w, https://static.ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-300x81.jpg 300w, https://ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV-600x162.jpg 600w, https://static.ericdraken.com/files/Successfully-installed-a-root-CA-on-the-Apple-TV.jpg 1201w"></a><figcaption>Successfully installed a root CA on the Apple TV</figcaption></figure><p>Excellent.</p><p>But wait, the router is slowing down. <code>mitmproxy</code> is burning up the CPU… on idle.</p><figure id="attachment_5741"><a href="https://ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle.png"><img src="https://static.ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-754x111.png" alt="MITMProxy is burning up the CPU while on idle" width="754" height="111" srcset="https://static.ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-754x111.png 754w, https://ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-300x44.png 300w, https://ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-600x88.png 600w, https://ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle.png 1309w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-754x111.png" data-srcset="https://static.ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-754x111.png 754w, https://ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-300x44.png 300w, https://ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle-600x88.png 600w, https://ericdraken.com/files/MITMProxy-is-burning-up-the-CPU-while-on-idle.png 1309w"></a><figcaption>MITMProxy is burning up the CPU while on idle</figcaption></figure><p>Of course: Python is a single-threaded paradigm with the GIL (Global Interpreter Lock) ensuring threads do not actually run concurrently – unless they are blocking on I/O, which is the case here(?). Except, most of the CPU work is to generate TLS certs on the fly for each request. Yikes. Running <code>mitmdump</code> forgoes the UI and extreme logging. The extreme logging of all the headers and full responses heavily slows down <code>mitmproxy</code>, but <code>mitmdump</code> by default only logs entries like classic Apache logs – much kinder on the CPU.</p><div><p><strong>Certificate Pinning</strong> Some advanced, high-security web servers have trouble with the MITMProxy certificates due to <a href="https://security.stackexchange.com/a/29990/114882" target="_blank" rel="nofollow">Certificate Pinning</a> – this is a technique where the server or the client know the fingerprint of the expected certificate in advance so it cannot be forged. A workaround is to use the <code>--ignore-hosts</code> option to let them bypass the proxy.</p></div><p>For my fun, I’ll go with this CLI command:</p><div id="crayon-63661eaabe4fb287054412" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># Try to avoid compression to save CPU usage</span></p><p><span># Ignore some difficult sites</span></p><p><span>mitmproxy</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>listen</span><span>-</span><span>port</span><span> </span><span>8080</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>listen</span><span>-</span><span>host</span><span> </span><span>127.0.1.1</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>anticomp</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>mode </span><span>regular</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>ignore</span><span>-</span><span>hosts</span><span> </span><span>'^(?:.+\.)?apple\.com:443$'</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>ignore</span><span>-</span><span>hosts</span><span> </span><span>'^(?:.+\.)?icloud\.com:443$'</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>set </span><span>console_focus_follow</span><span>=</span><span>true</span></p></div></td></tr></tbody></table></div><p>While on YouTube, we can see the page ads clear as day with their unencrypted headers; can a simple regex now block them? They are exposed, and afraid, and their days have run out.</p><figure id="attachment_5742"><a href="https://ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs.png"><img src="https://static.ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-754x368.png" alt="MITMProxy can see the YouTube ad URLs" width="754" height="368" srcset="https://static.ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-754x368.png 754w, https://ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-300x147.png 300w, https://static.ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-600x293.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-754x368.png" data-srcset="https://static.ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-754x368.png 754w, https://ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-300x147.png 300w, https://static.ericdraken.com/files/MITMProxy-can-see-the-YouTube-ad-URLs-600x293.png 600w"></a><figcaption>MITMProxy can see the YouTube ad URLs</figcaption></figure><p>We can even see details about each request. For example, all the SAN info is laid out for this wide-reaching certificate. There are curiously a lot of <code>*-cn.com</code> domains covered by this cert.</p><figure id="attachment_5744"><a href="https://ericdraken.com/files/We-can-see-rich-request-and-response-details.png"><img src="https://ericdraken.com/files/We-can-see-rich-request-and-response-details-754x282.png" alt="We can see rich request and response details" width="754" height="282" srcset="https://ericdraken.com/files/We-can-see-rich-request-and-response-details-754x282.png 754w, https://static.ericdraken.com/files/We-can-see-rich-request-and-response-details-300x112.png 300w, https://static.ericdraken.com/files/We-can-see-rich-request-and-response-details-600x224.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/We-can-see-rich-request-and-response-details-754x282.png" data-srcset="https://ericdraken.com/files/We-can-see-rich-request-and-response-details-754x282.png 754w, https://static.ericdraken.com/files/We-can-see-rich-request-and-response-details-300x112.png 300w, https://static.ericdraken.com/files/We-can-see-rich-request-and-response-details-600x224.png 600w"></a><figcaption>We can see rich request and response details</figcaption></figure><div id="crayon-63661eaabe4fe369532479" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># Try to avoid compression to save CPU usage</span></p><p><span># Use a script to block YouTube ads</span></p><p><span>mitmdump</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>listen</span><span>-</span><span>port</span><span> </span><span>8080</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>listen</span><span>-</span><span>host</span><span> </span><span>127.0.1.1</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>anticomp</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>mode </span><span>regular</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>ignore</span><span>-</span><span>hosts</span><span> </span><span>'^(.+\.)?apple\.com(:443)?$'</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>ignore</span><span>-</span><span>hosts</span><span> </span><span>'^(.+\.)?icloud\.com(:443)?$'</span><span> </span><span>\</span></p><p><span>&nbsp;&nbsp;</span><span>--</span><span>scripts</span><span> </span><span>"youtube.py"</span><span>&nbsp;&nbsp;</span><span># &lt;-- This is new</span></p></div></td></tr></tbody></table></div><p>Shortly, I’ll write a Python script to block YouTube <code>/pagead/</code> URLs.</p><p><a href="#top">Top ↩</a></p><hr><h2>Patch MITMProxy Source Code for Server SNI Interrogation</h2><p>This step may be optional for most, but as a reminder to myself, to make <code>--allowed-hosts</code> work better in Transparent Proxy Mode, the SNI of the server request needs to be checked against the list of regular expressions or else only the server’s IP is used for matching in many cases. Here is a quick patch I made that can be applied directly in the jail shell (or just type a few lines manually) for <code>mitmproxy</code> version 7.0.4:</p><div id="crayon-63661eaabe500315717351" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p></div></td><td><div><p>Index:<span> </span>venv/lib/python3.8/site-packages/mitmproxy/addons/next_layer.py</p><p>IDEA<span> </span>additional<span> </span>info:</p><p>Subsystem:<span> </span>com.intellij.openapi.diff.impl.patch.CharsetEP</p><p><span>&lt;+&gt;UTF-8</span></p><p>===================================================================</p><p>diff<span> </span>--git<span> </span>a/usr/local/lib/python3.8/site-packages/mitmproxy/addons/next_layer.py<span> </span>b/usr/local/lib/python3.8/site-packages/mitmproxy/addons/next_layer.py</p><p><span>--- a/usr/local/lib/python3.8/site-packages/mitmproxy/addons/next_layer.py&nbsp;&nbsp;(date 1641187083049)</span></p><p><span>+++ b/usr/local/lib/python3.8/site-packages/mitmproxy/addons/next_layer.py&nbsp;&nbsp;(date 1641187083049)</span></p><p><span>@@ -59,7 +59,7 @@</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; re.compile(x, re.IGNORECASE) for x in ctx.options.allow_hosts</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ]</span></p><p><span>-&nbsp;&nbsp;&nbsp;&nbsp;def ignore_connection(self, server_address: Optional[connection.Address], data_client: bytes) -&gt; Optional[bool]:</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;def ignore_connection(self, server: Optional[connection.Server], data_client: bytes) -&gt; Optional[bool]:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; """</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Returns:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; True, if the connection should be ignored.</span></p><p><span>@@ -70,8 +70,11 @@</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hostnames: List[str] = []</span></p><p><span>-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if server_address is not None:</span></p><p><span>-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hostnames.append(server_address[0])</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if server is not None:</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if server.address is not None:</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hostnames.append(server.address[0])</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if server.sni is not None:</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hostnames.append(server.sni)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if is_tls_record_magic(data_client):</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ch = parse_client_hello(data_client)</span></p><p><span>@@ -122,7 +125,7 @@</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return stack_match(context, layers)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # 1. check for --ignore/--allow</span></p><p><span>-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore = self.ignore_connection(context.server.address, data_client)</span></p><p><span>+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ignore = self.ignore_connection(context.server, data_client)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ignore is True:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return layers.TCPLayer(context, ignore=True)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if ignore is None:</span></p></div></td></tr></tbody></table></div><p>With the above patch, I can now reliably intercept a few hosts and let all others pass through.</p><figure id="attachment_5835"><a href="https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode.png"><img src="https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-754x476.png" alt="Reliable server host interception in MITMProxy transparent proxy mode" width="754" height="476" srcset="https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-754x476.png 754w, https://ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-300x189.png 300w, https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-600x379.png 600w, https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode.png 906w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-754x476.png" data-srcset="https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-754x476.png 754w, https://ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-300x189.png 300w, https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode-600x379.png 600w, https://static.ericdraken.com/files/Reliable-server-host-interception-in-MITMProxy-transparent-proxy-mode.png 906w"></a><figcaption>Reliable server host interception in MITMProxy transparent proxy mode</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Smoke Test: Intercept YouTube Ads with MITMProxy</h2><p>After reading the docs and navigating the <code>mitmproxy</code> source code in the PyCharm IDE, I’ve written a little script to block ads and tracking URLs coming from YouTube from my clean notebook. I won’t reproduce the code just yet because it didn’t succeed in blocking ads as hoped, so instead, I’ll spend the time investigating why.</p><p>Here are the smoke test filters I used where for a given top-level domain, URLs with the following partial strings are blocked:</p><div id="crayon-63661eaabe504280523207" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>blocked_partials</span><span>:</span><span> </span><span>dict</span><span> </span><span>=</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"youtube.com"</span><span>:</span><span> </span><span>[</span><span>"/pagead/"</span><span>,</span><span> </span><span>"/log_event?"</span><span>,</span><span> </span><span>"/stats/ads"</span><span>,</span><span> </span><span>"/stats/qoe?"</span><span>,</span><span> </span><span>"/ptracking?"</span><span>,</span><span> </span><span>"/generate_204"</span><span>,</span><span> </span><span>"el=adunit"</span><span>,</span><span> </span><span>"adformat="</span><span>,</span><span> </span><span>"/activeview?"</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"google.com"</span><span>:</span><span> </span><span>[</span><span>"/pagead/"</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"google.ca"</span><span>:</span><span> </span><span>[</span><span>"/pagead/"</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"ggpht.com"</span><span>:</span><span> </span><span>[</span><span>"."</span><span>]</span><span>,</span></p><p><span>}</span></p></div></td></tr></tbody></table></div><p>My initial results on blocking are positive. Everything I wanted to be blocked is faithfully blocked. Note, the <code>(failed)</code> entries are due to my script, and the <code>502</code> failures are due to pfBlockerNG black-holing the request.</p><figure id="attachment_5748"><a href="https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working.png"><img src="https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-754x350.png" alt="MITMProxy blocking script is working" width="754" height="350" srcset="https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-754x350.png 754w, https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-300x139.png 300w, https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-600x278.png 600w, https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working.png 1565w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-754x350.png" data-srcset="https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-754x350.png 754w, https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-300x139.png 300w, https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working-600x278.png 600w, https://static.ericdraken.com/files/MITMProxy-blocking-script-is-working.png 1565w"></a><figcaption>MITMProxy blocking script is working</figcaption></figure><p>Even in the DevTools network panel, the requests are truly blocked.</p><figure id="attachment_5749"><a href="https://ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel.png"><img src="https://static.ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-754x369.png" alt="YouTube requests are truly blocked in DevTools network panel" width="754" height="369" srcset="https://static.ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-754x369.png 754w, https://ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-300x147.png 300w, https://ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-600x293.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-754x369.png" data-srcset="https://static.ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-754x369.png 754w, https://ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-300x147.png 300w, https://ericdraken.com/files/YouTube-requests-are-truly-blocked-in-DevTools-network-panel-600x293.png 600w"></a><figcaption>YouTube requests are truly blocked in DevTools network panel</figcaption></figure><p>Then how come I am still seeing ads? I’ve disabled HTTP/2 so that subsequent requests on the same channel don’t slide by. Mind you, sometimes the ads skip on their own, or fail to play, but they still show up. Interesting. Could YouTube be using WebSockets? I need some inspiration, so I’ll look at uBlock Origin’s regex filters for some ideas.</p><div><p><strong>Tip:</strong> If you see the error <span>OpenSSL Error([(‘SSL routines’, ‘ssl3_read_bytes’, ‘tlsv1 alert internal error’)])</span>, then the DNS blocker (i.e. pfBlockerNG) is breaking the upstream TLS handshake for a given domain. Either whitelist it in pfBlockerNG (so the request goes through), or intercept it and block the connection in <code>mitmproxy</code>. This error happens to black-holed domains when the upstream TLS cert cannot be sniffed. The cleanest strategy is to use <strong>transparent MITM mode</strong>.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Examine uBlock Origin Regex Patterns for Inspiration</h2><p>Here are some of the regex/filters that uBlock Origin uses on YouTube.</p><figure id="attachment_5753"><a href="https://static.ericdraken.com/files/filters-from-a-web-browser.png"><img src="https://static.ericdraken.com/files/filters-from-a-web-browser.png" alt="uBlock Origin YouTube regex/filters from a web browser" width="746" height="322" srcset="https://static.ericdraken.com/files/filters-from-a-web-browser.png 746w, https://static.ericdraken.com/files/filters-from-a-web-browser-300x129.png 300w, https://ericdraken.com/files/filters-from-a-web-browser-600x259.png 600w" sizes="(max-width: 746px) 100vw, 746px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/filters-from-a-web-browser.png" data-srcset="https://static.ericdraken.com/files/filters-from-a-web-browser.png 746w, https://static.ericdraken.com/files/filters-from-a-web-browser-300x129.png 300w, https://ericdraken.com/files/filters-from-a-web-browser-600x259.png 600w"></a><figcaption>uBlock Origin YouTube regex/filters from a web browser</figcaption></figure><p>At first blush, it seems that a community of like-minded individuals is playing whack-a-mole with YouTube’s HTML and JavaScript. This has got me thinking: How does a video know to play an ad with JavaScript?</p><p>How does YouTube know if the ad converts? They must target ads for individuals, so a given video must receive some unique information about an ad, such as the click link and alt text. WebSockets would be a pain to maintain, especially with all the mobile clients. They must be using stateless JSON to relay that pertinent information in an innocuous URL request that has no telltale signs of ad-ness. Let’s hunt for this info in the JSON replies captured by <code>mitmproxy</code>.</p><figure id="attachment_5755"><a href="https://static.ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response.png"><img src="https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-754x362.png" alt="Key advertizement information contained in a JSON response" width="754" height="362" srcset="https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-754x362.png 754w, https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-300x144.png 300w, https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-600x288.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-754x362.png" data-srcset="https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-754x362.png 754w, https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-300x144.png 300w, https://ericdraken.com/files/Key-advertizement-information-contained-in-a-JSON-response-600x288.png 600w"></a><figcaption>Key advertizement information contained in a JSON response</figcaption></figure><p>Snap, Crackle, and Pop. We have a new plan: surgically alter the JSON response body to eliminate or Byzantine-up the ad information.</p><p><a href="#top">Top ↩</a></p><hr><h2>Surgically Alter the JSON Response to Remove Ads</h2><p>After a bit more playful exploration, a trove of blocklorne URLs is right there in the JSON payload. In fact, most of what I am trying to block shows up right here:</p><div id="crayon-63661eaabe509451695984" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p></div></td><td><div><p><span> </span><span>.</span><span>.</span><span>.</span></p><p><span> </span><span>"playerAds"</span><span>:</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"playerLegacyDesktopWatchAdsRenderer"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"playerAdParams"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"showContentThumbnail"</span><span>:</span><span> </span><span>true</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"enabledEngageTypes"</span><span>:</span><span> </span><span>"3,6,4,5,17,1"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"gutParams"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"tag"</span><span>:</span><span> </span><span>"\\4061\\ytpwmpu"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"showCompanion"</span><span>:</span><span> </span><span>true</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"showInstream"</span><span>:</span><span> </span><span>true</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"useGut"</span><span>:</span><span> </span><span>true</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;</span><span>"playbackTracking"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"videostatsPlaybackUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://s.youtube.com/api/stats/playback?cl=417308503&amp;docid=IgF3..."</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"videostatsDelayplayUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://s.youtube.com/api/stats/delayplay?cl=417308503&amp;docid=IgF..."</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"videostatsWatchtimeUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://s.youtube.com/api/stats/watchtime?cl=417308503&amp;docid=IgF..."</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"ptrackingUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://www.youtube.com/ptracking?ei=KnzDYZv1B86ikwa0no7AAg&amp;oid=MjD-gn49GocgAFypi8EDnQ&amp;plid=AAXTwR1aNKG2iTgr&amp;pltype=content&amp;ptchn=HnyfMqiRRG1u-2MsSQLbXA&amp;ptk=youtube_single&amp;video_id=IgF3OX8nT0w"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"qoeUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://s.youtube.com/api/stats/qoe?cl=417308503&amp;docid=IgF3OX8nT..."</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"atrUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://s.youtube.com/api/stats/atr?docid=IgF3OX8nT0w&amp;ei=KnzDYZv1B86ikwa0no7AAg&amp;feature=g-high-trv&amp;len=1213&amp;ns=yt&amp;plid=AAXTwR1aNKG2iTgr&amp;ver=2"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"elapsedMediaTimeSeconds"</span><span>:</span><span> </span><span>5</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"videostatsScheduledFlushWalltimeSeconds"</span><span>:</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>10</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>20</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>30</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"videostatsDefaultFlushIntervalSeconds"</span><span>:</span><span> </span><span>40</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"youtubeRemarketingUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://www.youtube.com/pagead/viewthroughconversion/962985656/?backend=innertube&amp;cname=1&amp;cver=2_20211221&amp;data=backend%3Dinnertube%3Bcname%3D1%3Bcver%3D2_20211221%3Bptype%3Df_view%3Btype%3Dview%3Butuid%3DHnyfMqiRRG1u-2MsSQLbXA%3Butvid%3DIgF3OX8nT0w&amp;foc_id=HnyfMqiRRG1u-2MsSQLbXA&amp;label=followon_view&amp;ptype=f_view&amp;random=37068419&amp;utuid=HnyfMqiRRG1u-2MsSQLbXA"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"elapsedMediaTimeSeconds"</span><span>:</span><span> </span><span>0</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"googleRemarketingUrl"</span><span>:</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"baseUrl"</span><span>:</span><span> </span><span>"https://www.google.com/pagead/1p-user-list/962985656/?backend=innertube&amp;cname=1&amp;cver=2_20211221&amp;data=backend%3Dinnertube%3Bcname%3D1%3Bcver%3D2_20211221%3Bptype%3Df_view%3Btype%3Dview%3Butuid%3DHnyfMqiRRG1u-2MsSQLbXA%3Butvid%3DIgF3OX8nT0w&amp;is_vtc=0&amp;ptype=f_view&amp;random=838827488&amp;utuid=HnyfMqiRRG1u-2MsSQLbXA"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"elapsedMediaTimeSeconds"</span><span>:</span><span> </span><span>0</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;</span><span>}</span><span>,</span></p></div></td></tr></tbody></table></div><p>However, YouTube has bobby-trapped their UI and there is more than one way their obfuscated JavaScript code can pull down the ad details.</p><p><strong>Let’s blow it all away right now.</strong></p><p>After a lot of fun taking apart the YouTube UI and HTTP workflow, taking into account cookies and naughty service workers, I am successfully able to strip away all the pre-roll, post-roll, mid-video, and, well, all the video ads. Here is a screenshot from <code>mitmdump</code> showing how select REST queries are intercepted, decrypted, modified, put back into the response, and the headers updated (content length, etc.).</p><figure id="attachment_5758"><a href="https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses.png"><img src="https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-754x221.png" alt="Success in removing YouTube ads via decrypted JSON responses" width="754" height="221" srcset="https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-754x221.png 754w, https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-300x88.png 300w, https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-600x176.png 600w, https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses.png 1175w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-754x221.png" data-srcset="https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-754x221.png 754w, https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-300x88.png 300w, https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses-600x176.png 600w, https://static.ericdraken.com/files/Success-in-removing-YouTube-ads-via-decrypted-JSON-responses.png 1175w"></a><figcaption>Success in removing YouTube ads via decrypted JSON responses</figcaption></figure><p>With this new ability, we could even inject JavaScript into the main YouTube web page and subvert their JavaScript in a sort of ECMAScript arms race, possibly even leveraging some of the filters from uBlock Origin. However, we can hang our hats on this accomplishment for today.</p><div><p><strong>Success:</strong> We can strip out ads from the JSON payload for YouTube web ads using a router.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>The iOS YouTube App Uses Protobuf, not JSON</h2><p>I can see very similar data in the Protocol Buffer (Protobuf) version of the same API calls as the web version to that of the YouTube iOS app. That complicates things, somewhat: We cannot lean on JSONPath to hunt down advertisement sections of JSON because with Protobuf the keys are just numbers that can even change.</p><figure id="attachment_5761"><a href="https://ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf.png"><img src="https://static.ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-754x255.png" alt="The iOS version of the YouTube app uses Protobuf" width="754" height="255" srcset="https://static.ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-754x255.png 754w, https://static.ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-300x102.png 300w, https://ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-600x203.png 600w, https://ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf.png 1279w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-754x255.png" data-srcset="https://static.ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-754x255.png 754w, https://static.ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-300x102.png 300w, https://ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf-600x203.png 600w, https://ericdraken.com/files/The-iOS-version-of-the-YouTube-app-uses-Protobuf.png 1279w"></a><figcaption>The iOS version of the YouTube app uses Protobuf</figcaption></figure><div><p><strong>Fun fact:</strong> YouTube compiles a large list of all the ads you are going to see and sends that to you in a sneaky payload. In fact, it is easier to visualize this when reading Protobuf. If you manage to exhaust that list, then another large list will be coming your way.</p></div><p>I can see strings like “Telus” and “Samsung TV” and “Boxing Week” and “Buy now”. Remember when YouTube was a fun place? A fable about a Golden Goose comes to mind, Alphabet.</p><p>What is a Protocol Buffer? Here is an infographic from <a href="https://www.datascienceblog.net/post/programming/essential-protobuf-guide-python/" target="_blank" rel="nofollow">Data Science Blog</a>.</p><figure id="attachment_5764"><a href="https://static.ericdraken.com/files/Protobuf-introduction.png"><img src="https://static.ericdraken.com/files/Protobuf-introduction-754x424.png" alt="Protobuf introduction" width="754" height="424" srcset="https://static.ericdraken.com/files/Protobuf-introduction-754x424.png 754w, https://static.ericdraken.com/files/Protobuf-introduction-300x169.png 300w, https://static.ericdraken.com/files/Protobuf-introduction-600x338.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Protobuf-introduction-754x424.png" data-srcset="https://static.ericdraken.com/files/Protobuf-introduction-754x424.png 754w, https://static.ericdraken.com/files/Protobuf-introduction-300x169.png 300w, https://static.ericdraken.com/files/Protobuf-introduction-600x338.png 600w"></a><figcaption>Protobuf introduction (Credit: <a href="https://www.datascienceblog.net/post/programming/essential-protobuf-guide-python/" target="_blank" rel="nofollow">Data Science Blog</a>)</figcaption></figure><p>As a consequence of being able to see unencrypted traffic from my iPhone, I’m taken aback by the sheer amount of tracking information laid bare; It’s like I have electrodes on my head and chest while I’m running on a treadmill and a bunch of scientists in white lab coats with clipboards are standing shoulder-to-shoulder recording everything about my internals.</p><div><p><strong>Privacy concern:</strong> Your apps are tracking you like crazy: what you do, how long you dwell, when you leave a given app, and so much more. The URL <code>https://play.googleapis.com/log/batch</code> shows up a lot in my logs.</p></div><p>The next question is: Does the iOS app protocol behave like the web app?</p><p><a href="#top">Top ↩</a></p><hr><h2>Timing Analysis to Detect Ad Videos?</h2><p>The iOS network traffic is not like the web traffic; Google has teams and teams of engineers dedicated to making sure blocking their ads isn’t computationally feasible. Daunted but undeterred, I was staring at network requests to let my mind zone out and wander when I noticed a pattern I had not noticed before.</p><p>For the <em>web</em> version of YouTube, I can eyeball which URLs are ads and which are the videos I want to watch. Take a look:</p><figure id="attachment_5806"><a href="https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos.png"><img src="https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-754x552.png" alt="Which are ad videos and which are content videos?" width="754" height="552" srcset="https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-754x552.png 754w, https://static.ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-300x220.png 300w, https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-600x439.png 600w, https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos.png 1122w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-754x552.png" data-srcset="https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-754x552.png 754w, https://static.ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-300x220.png 300w, https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos-600x439.png 600w, https://ericdraken.com/files/Which-are-ad-videos-and-which-are-content-videos.png 1122w"></a><figcaption>Which are ad videos and which are content videos?</figcaption></figure><p>How am I able to eyeball which video URLs are ads in this chaos?</p><figure id="attachment_5807"><a href="https://static.ericdraken.com/files/Two-ad-videos-between-content-videos.png"><img src="https://static.ericdraken.com/files/Two-ad-videos-between-content-videos-754x552.png" alt="Two ad videos between content videos" width="754" height="552" srcset="https://static.ericdraken.com/files/Two-ad-videos-between-content-videos-754x552.png 754w, https://static.ericdraken.com/files/Two-ad-videos-between-content-videos-300x220.png 300w, https://ericdraken.com/files/Two-ad-videos-between-content-videos-600x439.png 600w, https://static.ericdraken.com/files/Two-ad-videos-between-content-videos.png 1122w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Two-ad-videos-between-content-videos-754x552.png" data-srcset="https://static.ericdraken.com/files/Two-ad-videos-between-content-videos-754x552.png 754w, https://static.ericdraken.com/files/Two-ad-videos-between-content-videos-300x220.png 300w, https://ericdraken.com/files/Two-ad-videos-between-content-videos-600x439.png 600w, https://static.ericdraken.com/files/Two-ad-videos-between-content-videos.png 1122w"></a><figcaption>Two ad videos between content videos</figcaption></figure><p>Take a look at the query parameter <code>range</code>. For the web version, a chunk of the video I want is fetched from the 0th byte, then immediately another video is fetched with a <code>range</code> starting again at the 0th byte. Both happen near-simultaneously – faster than a human can click on a new video. It turns out this, as well as examining the <code>clen</code> parameter for the length of the full video (short videos are likely ads), can reasonably allow us to detect and doctor ad videos.</p><p>However, the iOS YouTube protocol does <strong>not</strong> use the <code>range</code> query parameter or even the <code>Range</code> header; video chunks use a counter like <code>&amp;nr=2</code> and <code>&amp;nr=3</code> etc. We must reverse engineer the Protobuf responses.</p><p><a href="#top">Top ↩</a></p><hr><h2>Decode the YouTube Protobuf Responses</h2><p>Here are some decoded Protobuf log files I created then opened in the PyCharm IDE.</p><figure id="attachment_5767"><a href="https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE.png"><img src="https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-754x161.png" alt="Let's examine some Protobuf logs in the IDE" width="754" height="161" srcset="https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-754x161.png 754w, https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-300x64.png 300w, https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-600x128.png 600w, https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE.png 1123w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-754x161.png" data-srcset="https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-754x161.png 754w, https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-300x64.png 300w, https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE-600x128.png 600w, https://ericdraken.com/files/Lets-examine-some-Protobuf-logs-in-the-IDE.png 1123w"></a><figcaption>Let’s examine some Protobuf logs in the IDE</figcaption></figure><p>After logging decoded Protobuf messages to disk for offline analysis, I did notice something that piqued my interest.</p><div id="crayon-63661eaabe511016360233" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>2</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>1</span><span>:</span><span> </span><span>has_unlimited</span><span>_</span>entitlement</p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>2</span><span>:</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>2</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>1</span><span>:</span><span> </span><span>has_premium_lite</span><span>_</span>entitlement</p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>2</span><span>:</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p></div></td></tr></tbody></table></div><p>I wonder what would happen if I were to, say, toggle those? This is tantalizing, but it is cheating, and hence no fun. Back to heuristics.</p><div><p><strong>Thought Experiment:</strong> As with JSON, can I blow away the Protobuf sections that serve up ads? Could I instead detect the ad videos in the payload, then dynamically modify their responses to be, say, a cached 0.01s video file? The 30s ~ 300s of unskippable ads could be over in the blink of an eye without blocking all those URLs.</p></div><figure id="attachment_5768"><a href="https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload.png"><img src="https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-754x428.png" alt="Intercepted ad URLs from the Protobuf payload" width="754" height="428" srcset="https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-754x428.png 754w, https://ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-300x170.png 300w, https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-600x341.png 600w, https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload.png 962w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-754x428.png" data-srcset="https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-754x428.png 754w, https://ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-300x170.png 300w, https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload-600x341.png 600w, https://static.ericdraken.com/files/Intercepted-ad-URLs-from-the-Protobuf-payload.png 962w"></a><figcaption>Intercepted ad URLs from the Protobuf payload</figcaption></figure><p>Let’s start by blocking the ads as intended.</p><p><a href="#top">Top ↩</a></p><hr><h2>Ad URL Polymorphism</h2><p>The Protobuf responses are a hot mess of bytes, but there are human-readable URLs that can be grepped.</p><p>You’d think a simple LRU cache that blocks soon-encountered ad URLs could be the way to go, but, alas, the ad URLs do not quite match the URLs sent over the wire. Also, who is to say that YouTube won’t randomize the position of query-string parameters one day? We need an <code>O(1)</code> lookup of flagged ad URLs that are polymorphic (and group homomorphic) to live ad URLs.</p><figure id="attachment_5775"><a href="https://static.ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs.png"><img src="https://static.ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs.png" alt="Detected ad URLs vs intercepted ad URLs" width="748" height="169" srcset="https://static.ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs.png 748w, https://ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs-300x68.png 300w, https://ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs-600x136.png 600w" sizes="(max-width: 748px) 100vw, 748px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs.png" data-srcset="https://static.ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs.png 748w, https://ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs-300x68.png 300w, https://ericdraken.com/files/Detected-ad-URLs-vs-intercepted-ad-URLs-600x136.png 600w"></a><figcaption>Detected ad URLs vs intercepted ad URLs</figcaption></figure><p>It might be tempting to split a query string into a sorted dictionary and reassemble it, but we have no way of knowing what the query string boundary is. Plus, a live ad URL could add a key and disrupt the sorting.</p><p>Addionally, I’ve encountered URLs like this that purposely try to obfuscate the query params:</p><blockquote><p>https://r4—sn-vgqsrns6.googlevideo.com/videoplayback<br>/expire/1640607416<br>/ei/WFrJYdWnFfyTsfIP4s2BsAk<br><span>/ip/121.35.98.26</span><br>/id/o-AE7swWOPOwXu3GyRght<br>/source/youtube<br>/requiressl/yes<br>/mh/wU/<br>mm/31,26/…</p></blockquote><p>Notice how <code>/ip/121.35.98.26/</code> is just <code>&amp;ip=121.35.98.26</code>?</p><p>I propose heuristically scanning for query and path parameters of ad URLs with high entropy and using those as keys (fingerprints). For example, in</p><blockquote><p>https://<span>rr6—sn-uxa0n-t8gz</span>.googlevideo.com/initplayback?source=youtube<br>&amp;orc=1&amp;oeis=1&amp;c=IOS&amp;oss=1&amp;oda=1&amp;oad=5500&amp;ovd=5500&amp;oaad=11000&amp;oavd=11000<br>&amp;ocs=700&amp;oputc=1&amp;oses=1&amp;ofpcc=1&amp;osbr=1&amp;osnz=1&amp;msp=1&amp;odeak=1&amp;odepv=1<br>&amp;osfc=1&amp;id=<span>58cc678216d6aaca</span>&amp;ip=<span>121.35.98.26</span>&amp;initcwndbps=<span>2125000</span><br>&amp;mt=<span>1640373902</span></p></blockquote><p>One could note the following candidates in descending order of length:</p><ul><li>rr6—sn-uxa0n-t8gz</li><li>58cc678216d6aaca</li><li>121.35.98.26</li><li>1640373902</li><li>2125000</li></ul><p>Any or all of them could be lookup keys each pointing to the same dictionary of deconstructed query parameters. A lookup of a live URL would involve the same process of finding the highest entropy parameters and checking the URL dictionary for a match. The cache data structure can even be multi-level with the root keys being just the length of the high-entropy strings.</p><div><p><strong>Failure:</strong> Even with the ability to block polymorphic URLs, the video ads are still indistinguishable from content video without context from the Protobuf structure.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Smoke Test: Intercept and Decode Protobuf in Python</h2><div><p><strong>Python is Slow:</strong> Decoding ~500 kiB of raw Protobuf in pure Python is painfully slow.</p></div><p>Decoding ~500 kiB of Protobuf in pure Python, especially the decoding step of converting it to over 1 MiB of human-readable text to parse the ad URLs, takes more time than the connection timeout most of the time. I’ll run some benchmarks using pure Python vs. the native C++ library.</p><h3>Pure Python Benchmarks</h3><div id="crayon-63661eaabe517325973514" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>from</span><span> </span><span>timeit</span><span> </span><span>import</span><span> </span><span>repeat</span></p><p><span>from</span><span> </span><span>mitmproxy</span><span>.</span><span>contentviews</span><span>.</span><span>protobuf </span><span>import</span><span> </span><span>format_pbuf</span></p><p><span>with</span><span> </span><span>open</span><span>(</span><span>"proto.raw"</span><span>,</span><span> </span><span>"rb"</span><span>)</span><span> </span><span>as</span><span> </span><span>f</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>data</span><span>:</span><span> </span><span>bytes</span><span> </span><span>=</span><span> </span><span>f</span><span>.</span><span>read</span><span>(</span><span>)</span></p><p><span>print</span><span>(</span><span>repeat</span><span>(</span><span>lambda</span><span>:</span><span> </span><span>format_pbuf</span><span>(</span><span>data</span><span>)</span><span>,</span><span> </span><span>number</span><span>=</span><span>5</span><span>)</span><span>)</span></p><p><span># On a i7-6700 CPU @ 3.40GHz desktop</span></p><p><span># [2.10792827908881, 2.0718665630556643, 2.0739889848046005, 2.065321908099577, 2.070936748990789]</span></p><p><span># On the pfSense router:</span></p><p><span># [24.182968072011136, 22.833560551982373, 23.53838806191925, 22.842924927012064, 22.81738876597956]</span></p></div></td></tr></tbody></table></div><h3>Pure C++ Benchmarks</h3><div id="crayon-63661eaabe519209175894" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># On a i7-6700 CPU @ 3.40GHz desktop</span></p><p><span>TIMEFORMAT</span><span>=</span><span>%</span><span>R</span></p><p><span>for</span><span> </span><span>i</span><span> </span><span>in</span><span> </span><span>{</span><span>1..5</span><span>}</span><span>;</span><span> </span><span>do</span><span> </span><span>time</span><span> </span><span>protoc</span><span> </span><span>--</span><span>decode_raw</span><span> </span><span>&lt;</span><span> </span><span>proto</span><span>.raw</span><span> </span><span>&gt;</span><span> </span><span>/</span><span>dev</span><span>/</span><span>null</span><span>;</span><span> </span><span>done</span></p><p><span># 0.018</span></p><p><span># 0.017</span></p><p><span># 0.022</span></p><p><span># 0.018</span></p><p><span># 0.018</span></p><p><span># On the pfSense router:</span></p><p><span>printf</span><span> </span><span>'foreach f ( 1 2 3 4 5 )\n time protoc --decode_raw &lt; proto.raw &gt; /dev/null \n end \n'</span><span> </span><span>|</span><span> </span><span>tcsh</span></p><p><span># 0.030u 0.114s 0:00.14 100.0%&nbsp;&nbsp;30+153k 2+0io 0pf+0w</span></p><p><span># 0.024u 0.104s 0:00.12 100.0%&nbsp;&nbsp;8+132k 2+0io 0pf+0w</span></p><p><span># 0.022u 0.106s 0:00.12 100.0%&nbsp;&nbsp;34+156k 2+0io 0pf+0w</span></p><p><span># 0.016u 0.114s 0:00.13 92.3%&nbsp;&nbsp; 8+143k 2+0io 0pf+0w</span></p><p><span># 0.023u 0.102s 0:00.12 100.0%&nbsp;&nbsp;8+132k 2+0io 0pf+0w</span></p></div></td></tr></tbody></table></div><p>If you caught that, it takes about <strong>23s</strong> in Python, and <strong>100ms</strong> in C++! In this Never Ending Story, we have to find a way to parse the raw Protobuf payloads in Python using the C++ library <code>libprotobuf.so</code>. In the interest of time, I’ll use <code>subprocess.Popen</code> and communicate with the C++ <code>protoc</code> binary directly (since raw decoding is not supported in Python anyway).</p><p><a href="#top">Top ↩</a></p><hr><h2>Fuzzing the YouTube Video Ad Responses</h2><p>How about fuzzing the ad video responses? Now being able to isolate ad videos, as a smoke test, I sent back <code>200</code> responses with empty bodies and the iOS app went bananas; it was as if there is an infinite loop with no delay just hammering YouTube’s own servers trying to get the next part of the video in panic mode. I felt bad for their servers, so I stopped. Then, what would a happy-path response payload look like?</p><figure id="attachment_5783"><a href="https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video.png"><img src="https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-754x345.png" alt="Infinite spin-lock loop of YouTube trying to get the next bytes of the ad video" width="754" height="345" srcset="https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-754x345.png 754w, https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-300x137.png 300w, https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-600x274.png 600w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-754x345.png" data-srcset="https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-754x345.png 754w, https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-300x137.png 300w, https://ericdraken.com/files/Infinite-spin-lock-loop-of-YouTube-trying-to-get-the-next-bytes-of-the-ad-video-600x274.png 600w"></a><figcaption>Infinite spin-lock loop of YouTube trying to get the next bytes of the ad video</figcaption></figure><p>Try as I might, when I send back empty <code>200</code>s, <code>404</code>s, <code>503</code>s, truncate response bodies, or just null-out part of the ad video, the iOS app crawls then crashes spectacularly with a dying breath of a messed up iOS UI. I now block some error reporting endpoint at <code>/error_204/</code> that indicates a “dev assertion failed” so I don’t make some overworked QA pull out their hair.</p><div><p><strong>Failure:</strong> We’ve learned that blocking ad URLs causes the app to deploy countermeasures and even when defeated, the app hangs forever on the ad screen. We’ve also learned that fuzzing ad videos often causes the app to crash – there is even session meta data in the video response chunks.</p></div><p>Let’s go back to what worked with JSON and obliterate the section of the Protobuf responses that contain the array of ad details.</p><p><a href="#top">Top ↩</a></p><hr><h2>Enter Burp Suite Tools for Penetration Testing</h2><p>There is a library for <a href="https://portswigger.net/burp" target="_blank" rel="nofollow">Burp Suite</a> called <code>blackboxprotobuf</code> (get the <a href="https://github.com/nccgroup/blackboxprotobuf/tree/master/lib" target="_blank" rel="nofollow">original Burp Suite version</a>, <strong>not</strong> the PyPi fork, unless you like infinite recursion bugs) that is designed to decode raw Protobuf wire messages, inject something naughty, then re-encode them again to see how a Protobuf endpoint behaves. We are going to have so much fun together in this next section.</p><div id="crayon-63661eaabe51d734281067" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># Install blackboxprotobuf from source</span></p><p><span>mkdir</span><span> </span><span>blackboxprotobuf_src</span><span> </span><span>&amp;&amp;</span><span> </span><span>cd</span><span> </span><span>blackboxprotobuf_src</span></p><p><span>git </span><span>clone</span><span> </span><span>https</span><span>:</span><span>/</span><span>/</span><span>github</span><span>.com</span><span>/</span><span>nccgroup</span><span>/</span><span>blackboxprotobuf</span><span>.git</span><span> </span><span>.</span></p><p><span>pip3 </span><span>install </span><span>poetry</span></p><p><span>cd</span><span> </span><span>lib</span></p><p><span>poetry </span><span>install</span></p><p><span># pwd -&gt; blackboxprotobuf_src/lib/</span></p><p><span>cp</span><span> </span><span>-</span><span>r</span><span> </span><span>blackboxprotobuf </span><span>your</span><span>/</span><span>project</span><span>/</span><span>folder</span></p><p><span># We only need this folder tree for the Py3 API</span></p></div></td></tr></tbody></table></div><p>You may encounter a small world of pain because some forks of blackboxprotobuf will cause a stack overflow due to deep recursion. You can see this by adding <code>sys.setrecursionlimit(200)</code>.</p><p>Compiling the original library source code for Burp Suite and using the C++ bindings will allow us to transcode ~500 kiB of raw Protobuf bytes in just a few seconds.</p><div><p><strong>Tip:</strong> At the top of your import chain before you import <code>protobuf</code>, add</p><div id="crayon-63661eaabe51f564481961" data-nosnippet="data-nosnippet" data-settings=" no-popup minimize scroll-mouseover"><table><tbody><tr><td data-settings="hide"></td><td><div><p><span>import</span><span> </span><span>os</span></p><p><span>os</span><span>.</span><span>environ</span><span>[</span><span>"PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION"</span><span>]</span><span> </span><span>=</span><span> </span><span>"cpp"</span></p></div></td></tr></tbody></table></div><p>to use the C++ <code>libprotobuf.so</code> implementation whenever possible.<br></p></div><p>It is now possible to generate a best-guess <code>.proto</code> schema with a single function:</p><div id="crayon-63661eaabe521008674169" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>import</span><span> </span><span>os</span></p><p><span>os</span><span>.</span><span>environ</span><span>[</span><span>"PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION"</span><span>]</span><span> </span><span>=</span><span> </span><span>"cpp"</span></p><p><span>from</span><span> </span><span>mitmdump</span><span>.</span><span>blackboxprotobuf</span><span>.</span><span>lib </span><span>import</span><span> </span><span>protobuf_to_json</span></p><p><span>data</span><span>:</span><span> </span><span>bytes</span><span> </span><span>=</span><span> </span><span>.</span><span>.</span><span>.</span></p><p><span>message</span><span>,</span><span> </span><span>typedef</span><span> </span><span>=</span><span> </span><span>protobuf_to_json</span><span>(</span><span>data</span><span>)</span></p><p><span># print(message)</span></p><p><span>print</span><span>(</span><span>typedef</span><span>)</span></p></div></td></tr></tbody></table></div><p>The schema isn’t perfect, and it is huge and deeply nested, and takes forever to pretty-print, and is probably wrong, but is just good enough to pull out the ad details like so (Protobuf to JSON in this sample):</p><figure id="attachment_5798"><a href="https://static.ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads.png"><img src="https://ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-754x300.png" alt="Sample Protobuf to JSON showing a section of ads" width="754" height="300" srcset="https://ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-754x300.png 754w, https://static.ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-300x119.png 300w, https://static.ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-600x238.png 600w, https://static.ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads.png 755w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-754x300.png" data-srcset="https://ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-754x300.png 754w, https://static.ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-300x119.png 300w, https://static.ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads-600x238.png 600w, https://static.ericdraken.com/files/Sample-Protobuf-to-JSON-showing-a-section-of-ads.png 755w"></a><figcaption>Sample Protobuf to JSON showing a section of ads</figcaption></figure><p>The Python schema is huge and looks like this for about 250,000 more charcters:</p><div id="crayon-63661eaabe524527915615" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>OrderedDict</span><span>(</span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>'1'</span><span>,</span><span> </span><span>OrderedDict</span><span>(</span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>'type'</span><span>,</span><span> </span><span>'message'</span><span>)</span><span>,</span><span> </span><span>(</span><span>'message_typedef'</span><span>,</span><span> </span><span>OrderedDict</span><span>(</span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>'6'</span><span>,</span><span> </span><span>OrderedDict</span><span>(</span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>'type'</span><span>,</span><span> </span><span>'message'</span><span>)</span><span>,</span><span> </span><span>(</span><span>'message_typedef'</span><span>,</span><span> </span><span>OrderedDict</span><span>(</span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>'1'</span><span>,</span><span> </span><span>OrderedDict</span><span>(</span><span>[</span><span>.</span><span>.</span><span>.</span></p></div></td></tr></tbody></table></div><p>Reverse engineering the Protobuf schema sounds good on paper, but our target is spectacularly complex and a moving target.</p><p><a href="#top">Top ↩</a></p><hr><h2>Exfil the Proto Schemas from the App, Cleanly?</h2><p>As fun as it to reverse the Protobuf and generate a best-guess schema, wouldn’t it be more ninja-like to exfil the actual, working <code>.proto</code> or schema files from the smartphone app? Let’s pull out the Protobuf schemas from the Android version of the YouTube app and see if the schemas are the same or compatible.</p><p>This is what I tried <em>at first</em>, but it went nowhere with the <a href="https://github.com/marin-m/pbtk" target="_blank" rel="nofollow">Protobuf Toolkit</a> (PBTK). I reproduce it here so I remember what I tried:</p><div id="crayon-63661eaabe527948865294" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>sudo </span><span>apt </span><span>update</span></p><p><span>sudo </span><span>apt </span><span>install </span><span>libqt5x11extras5 </span><span>python3</span><span>-</span><span>pyqt5</span><span>.qtwebengine</span><span> </span><span>python3</span><span>-</span><span>pyqt5</span></p><p><span>pip3 </span><span>install </span><span>pyqt5 </span><span>pyqtwebengine </span><span>requests </span><span>websocket</span><span>-</span><span>client</span></p><p><span>mkdir</span><span> </span><span>pbtk</span><span> </span><span>&amp;&amp;</span><span> </span><span>cd</span><span> </span><span>pbtk</span></p><p><span>git </span><span>clone</span><span> </span><span>https</span><span>:</span><span>/</span><span>/</span><span>github</span><span>.com</span><span>/</span><span>marin</span><span>-</span><span>m</span><span>/</span><span>pbtk</span><span> </span><span>.</span></p><p><span>.</span><span>/</span><span>gui</span><span>.py</span></p></div></td></tr></tbody></table></div><p>After installing Qt dependencies (pronounced “cute”), I was treated to a GUI.</p><figure id="attachment_5799"><a href="https://static.ericdraken.com/files/PBTK-The-Protobuf-Toolkit.png"><img src="https://static.ericdraken.com/files/PBTK-The-Protobuf-Toolkit.png" alt="PBTK - The Protobuf Toolkit" width="694" height="581" srcset="https://static.ericdraken.com/files/PBTK-The-Protobuf-Toolkit.png 694w, https://ericdraken.com/files/PBTK-The-Protobuf-Toolkit-300x251.png 300w, https://static.ericdraken.com/files/PBTK-The-Protobuf-Toolkit-600x502.png 600w" sizes="(max-width: 694px) 100vw, 694px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/PBTK-The-Protobuf-Toolkit.png" data-srcset="https://static.ericdraken.com/files/PBTK-The-Protobuf-Toolkit.png 694w, https://ericdraken.com/files/PBTK-The-Protobuf-Toolkit-300x251.png 300w, https://static.ericdraken.com/files/PBTK-The-Protobuf-Toolkit-600x502.png 600w"></a><figcaption>PBTK – The Protobuf Toolkit</figcaption></figure><p>Next, I got the most recent release of a 100 MiB Android APK file from <a href="https://apkpure.com/" target="_blank" rel="nofollow">apkpure.com</a>.</p><p>Excited in vain, the most PBTK could get was a 59-byte proto file. Another tool called <a href="https://ibotpeaches.github.io/Apktool/install/" target="_blank" rel="nofollow">Apktool</a> also looked promising, but the best it can do is <em>disassemble</em> bytecode, not decompile it – this may be good enough for Pen Testers, however.</p><p>What ended up working for APK decompilation is a combination of a dedicated person’s <a href="https://github.com/pxb1988/dex2jar" target="_blank" rel="nofollow">dex2jar tool</a> and a <a href="http://java-decompiler.github.io/" target="_blank" rel="nofollow">Java Decompiler</a>. A helpful guide can be found <a href="https://stackoverflow.com/a/4177581/1938889" target="_blank" rel="nofollow">here</a>.</p><div id="crayon-63661eaabe529630536553" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span># Follow the install steps at https://stackoverflow.com/a/4177581/1938889</span></p><p><span>cd</span><span> </span><span>dex2jar</span></p><p><span>chmod</span><span> </span><span>-</span><span>R</span><span> </span><span>+</span><span>x</span><span> </span><span>*</span><span>.sh</span></p><p><span>sh</span><span> </span><span>d2j</span><span>-</span><span>dex2jar</span><span>.sh</span><span> </span><span>-</span><span>f</span><span> </span><span>-</span><span>o</span><span> </span><span>.</span><span>.</span><span>/</span><span>output</span><span>.jar</span><span> </span><span>.</span><span>.</span><span>/</span><span>YouTube_v16</span><span>.</span><span>49.37_apkpure.com.apk</span></p><p><span>cd</span><span> </span><span>.</span><span>.</span><span>/</span><span>jd</span><span>-</span><span>gui</span></p><p><span>java</span><span> </span><span>-</span><span>jar </span><span>jd</span><span>-</span><span>gui</span><span>-</span><span>1.6.6.jar</span></p></div></td></tr></tbody></table></div><p>You can see that Google went out of its way to complicate reverse engineering.</p><figure id="attachment_5800"><a href="https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes.png"><img src="https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-754x302.png" alt="YouTube APK reversed into obfuscated Java classes" width="754" height="302" srcset="https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-754x302.png 754w, https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-300x120.png 300w, https://ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-600x240.png 600w, https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes.png 1079w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-754x302.png" data-srcset="https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-754x302.png 754w, https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-300x120.png 300w, https://ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes-600x240.png 600w, https://static.ericdraken.com/files/YouTube-APK-reversed-into-obfuscated-Java-classes.png 1079w"></a><figcaption>YouTube APK reversed into obfuscated Java classes</figcaption></figure><p>Google thoughtfully did leave some hints.</p><figure id="attachment_5802"><a href="https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable.png"><img src="https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-754x353.png" alt="All the Protobuf schemas laid bare and human-readable" width="754" height="353" srcset="https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-754x353.png 754w, https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-300x141.png 300w, https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-600x281.png 600w, https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable.png 1091w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-754x353.png" data-srcset="https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-754x353.png 754w, https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-300x141.png 300w, https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable-600x281.png 600w, https://ericdraken.com/files/All-the-Protobuf-schemas-laid-bare-and-human-readable.png 1091w"></a><figcaption>All the Protobuf classes laid bare and human-readable</figcaption></figure><p>Upon deeper inspection, the Protobuf classes are right here, in Java, decorated with getters and setters. Since we are using Python, and we cannot get the true schema files, I will leave this approach for now.</p><p><a href="#top">Top ↩</a></p><hr><h2>Hardcore Deep-Dive into Protobuf and Wire Format</h2><p>After gazing into a sea of decrypted network traffic again, then triggering errors and assertion fails on my iPhone with Protobuf fuzzing, and taking a peek at the error logs being phoned home, I’ve noticed that ads register for “slots” in a given video. They can register for pre-roll, mid-roll, end-roll, full-page, and ad pods (back-to-back ads). Blocking an ad URL causes an error along the lines of “some ad that doesn’t exist booked a slot” and UI panic sets in.</p><p>I’m going to Sun Tzu the <a href="https://developers.google.com/protocol-buffers/docs/encoding" target="_blank" rel="nofollow">Protobuf Wire Format</a> and come back in a bit…</p><p>I’m back. The Wire Format is surprisingly elegant, except for <a href="https://developers.google.com/protocol-buffers/docs/encoding#signed_integers" target="_blank" rel="nofollow">ZigZag encoding</a>. Through trial and error, editing out chunks of Protobuf with a hex editor is just a no-go.</p><p>While computationally expensive, decoding, editing, and re-encoding without the original schema leads to a modified encoding. This is likely because we cannot detect if ZigZag encoding is being used, or if a number is an <code>int32</code>, <code>int64</code>, <code>sint32/64</code>, <code>varint</code>, etc., plus the order of object fields is normally non-deterministic. Here is some <a href="https://developers.google.com/protocol-buffers/docs/encoding#implications" target="_blank" rel="nofollow">Protobuf trivia</a> on the matter:</p><figure id="attachment_5810"><a href="https://ericdraken.com/files/Protobuf-serialization-gotachas.png"><img src="https://ericdraken.com/files/Protobuf-serialization-gotachas-754x323.png" alt="Protobuf serialization gotachas" width="754" height="323" srcset="https://ericdraken.com/files/Protobuf-serialization-gotachas-754x323.png 754w, https://ericdraken.com/files/Protobuf-serialization-gotachas-300x128.png 300w, https://ericdraken.com/files/Protobuf-serialization-gotachas-600x257.png 600w, https://ericdraken.com/files/Protobuf-serialization-gotachas.png 850w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Protobuf-serialization-gotachas-754x323.png" data-srcset="https://ericdraken.com/files/Protobuf-serialization-gotachas-754x323.png 754w, https://ericdraken.com/files/Protobuf-serialization-gotachas-300x128.png 300w, https://ericdraken.com/files/Protobuf-serialization-gotachas-600x257.png 600w, https://ericdraken.com/files/Protobuf-serialization-gotachas.png 850w"></a><figcaption>Protobuf serialization gotachas</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Exploit a Protobuf Flaw to Easily Remove All Ads by Changing One Byte</h2><p>Casually poring over the C++ source code, an interesting comment in the Protobuf code caught my eye:</p><blockquote><p><code>UnknownFieldSet</code> is used to keep track of fields that were seen when parsing a protocol message but whose field numbers or types are unrecognized. This most frequently occurs when new fields are added to a message type and then messages containing those fields are read by old software that was compiled before the new types were added. (<a href="https://developers.google.com/protocol-buffers/docs/proto3#unknowns" target="_blank" rel="nofollow">ref</a>)</p></blockquote><p>Yes, what to do with unknown fields? What to do indeed. And, how easy would it be to say, change a <code>49399797</code> field key to, say, <code>49399796</code> thus making an entire substructure of advertisement and tracking information suddenly unavailable? Tantalizing.</p><p>And, if we can calculate the field tags in bytes with bit-twiddling, then can we use a simple regex to AMF<a title="Adios, My Friend" rel="nofollow" id="return-note-5418-1" href="#note-5418-1"><sup>1</sup></a> the section of ads in <code>O(n)</code> time?</p><p>As a motivating example, I’d like to find the field key <code>49399797</code> which is not as simple as searching for <code>2F1C7F5</code>. Here is an implementation of a tag-scanning algorithm so you can see the bit-twiddling:</p><div id="crayon-63661eaabe52e139325226" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>def</span><span> </span><span>DecodeVarint</span><span>(</span><span>buffer</span><span>,</span><span> </span><span>pos</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;</span><span>mask</span><span> </span><span>=</span><span> </span><span>(</span><span>1</span><span> </span><span>&lt;&lt;</span><span> </span><span>64</span><span>)</span><span> </span><span>-</span><span> </span><span>1</span></p><p><span>&nbsp;&nbsp;</span><span>result</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>&nbsp;&nbsp;</span><span>shift</span><span> </span><span>=</span><span> </span><span>0</span></p><p><span>&nbsp;&nbsp;</span><span>while</span><span> </span><span>1</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span> </span><span>=</span><span> </span><span>buffer</span><span>[</span><span>pos</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>result</span><span> </span><span>|=</span><span> </span><span>(</span><span>(</span><span>b</span><span> </span><span>&amp;</span><span> </span><span>0x7f</span><span>)</span><span> </span><span>&lt;&lt;</span><span> </span><span>shift</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>pos</span><span> </span><span>+=</span><span> </span><span>1</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>not</span><span> </span><span>(</span><span>b</span><span> </span><span>&amp;</span><span> </span><span>0x80</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>result</span><span> </span><span>&amp;=</span><span> </span><span>mask</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>result</span><span> </span><span>=</span><span> </span><span>int</span><span>(</span><span>result</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>(</span><span>result</span><span>,</span><span> </span><span>pos</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>shift</span><span> </span><span>+=</span><span> </span><span>7</span></p></div></td></tr></tbody></table></div><p>We know the wire type is <code>2</code> (length-delimited nested string/message), and one target field <em>key</em> is <code>49399797</code>. When bit-twiddled, we get the target <em>tag</em></p><p><code>AA FF B8 BC 01</code></p><p>where the final <code>01</code> happens to mean <code>2</code> (the wire type) in hex. In binary, this is:</p><p><code>10101010 11111111 10111000 10111100 00000001</code></p><p>Let’s lose the MSB from each byte as per the var-length wire format:</p><p><code>.0101010 .1111111 .0111000 .0111100 .0000001</code></p><p>Then we shift and add only the first four bytes since the LSB is first:</p><div id="crayon-63661eaabe531447697148" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>42</span><span> </span><span>+</span><span> </span><span>(</span><span>127</span><span> </span><span>*</span><span> </span><span>2</span><span>^</span><span>7</span><span>)</span><span> </span><span>+</span><span> </span><span>(</span><span>56</span><span> </span><span>*</span><span> </span><span>2</span><span>^</span><span>14</span><span>)</span><span> </span><span>+</span><span> </span><span>(</span><span>188</span><span> </span><span>*</span><span> </span><span>2</span><span>^</span><span>21</span><span>)</span><span> </span><span>=</span></p><p><span>42</span><span> </span><span>+</span><span> </span><span>(</span><span>127</span><span> </span><span>*</span><span> </span><span>128</span><span>)</span><span> </span><span>+</span><span> </span><span>(</span><span>56</span><span> </span><span>*</span><span> </span><span>16384</span><span>)</span><span> </span><span>+</span><span> </span><span>(</span><span>188</span><span> </span><span>*</span><span> </span><span>2097152</span><span>)</span><span> </span><span>=</span></p><p><span>42</span><span> </span><span>+</span><span> </span><span>16256</span><span> </span><span>+</span><span> </span><span>917504</span><span> </span><span>+</span><span> </span><span>394264576</span><span> </span><span>=</span></p><p><span>395198378</span></p></div></td></tr></tbody></table></div><p>Finally, we shift out the number of wire type bits (3) to get back the field key:</p><p><code>395198378 &gt;&gt; 3 = 49399797</code></p><p>And that, folks, is a taste of how Wire Format works.</p><p>Fantastic. Now, all we have to do is scan the Protobuf bytes for classic ad URL signatures like <code>/pagead/</code> to bound our field search, then move backward from there until we find the target(s) field tags and thus field keys we would like to denature (e.g. <code>49399797</code> –&gt; <code>49399796</code>).</p><div id="crayon-63661eaabe533307450758" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"></td><td><div><p><span>&gt;&gt;</span><span> </span><span>Request</span><span>(</span><span>POST </span><span>youtubei</span><span>.googleapis</span><span>.com</span><span>:</span><span>443</span><span>/</span><span>youtubei</span><span>/</span><span>v1</span><span>/</span><span>browse</span><span>?</span><span>key</span><span>=</span><span>.</span><span>.</span><span>.</span><span>)</span></p><p><span>&lt;&lt;</span><span> </span><span>Response</span><span>(</span><span>200</span><span>,</span><span> </span><span>application</span><span>/</span><span>x</span><span>-</span><span>protobuf</span><span>,</span><span> </span><span>1.87m</span><span>)</span></p><p><span>Intercepting </span><span>https</span><span>:</span><span>/</span><span>/</span><span>youtubei</span><span>.googleapis</span><span>.com</span><span>/</span><span>youtubei</span><span>/</span><span>v1</span><span>/</span><span>browse</span><span>?</span><span>key</span><span>=</span><span>.</span><span>.</span><span>.</span><span> </span><span>(</span><span>Protobuf</span><span>)</span></p><p><span>Found </span><span>key</span><span> </span><span>49399797</span><span> </span><span>at</span><span> </span><span>position</span><span> </span><span>4465</span></p><p><span>Found </span><span>key</span><span> </span><span>50195462</span><span> </span><span>at</span><span> </span><span>position</span><span> </span><span>4477</span></p></div></td></tr></tbody></table></div><p>Notice how the Protobuf response payload is <strong>1.87 MiB</strong>? As I said, Google makes it computationally expensive to decode, alter, and re-encode without the C++ source proto files, but a quick linear scan takes no effort at all.</p><figure id="attachment_5822"><a href="https://static.ericdraken.com/files/Walking-backward-from-the-ad-marker.png"><img src="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png" alt="Walking backward from the ad marker" width="754" height="617" srcset="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png 754w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-300x246.png 300w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-600x491.png 600w, https://static.ericdraken.com/files/Walking-backward-from-the-ad-marker.png 966w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png" data-srcset="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png 754w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-300x246.png 300w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-600x491.png 600w, https://static.ericdraken.com/files/Walking-backward-from-the-ad-marker.png 966w"></a><figcaption>Walking backward from the ad marker</figcaption></figure><p>Just a quick note, there is more than one field tag, but not all of them represent ads. That is why we need to backtrack from the <code>/pagead/</code> markers.</p><figure id="attachment_5892"><a href="https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present.png"><img src="https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present.png" alt="Multiple identical field tags may be present" width="675" height="99" srcset="https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present.png 675w, https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present-300x44.png 300w, https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present-600x88.png 600w" sizes="(max-width: 675px) 100vw, 675px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present.png" data-srcset="https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present.png 675w, https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present-300x44.png 300w, https://static.ericdraken.com/files/Multiple-identical-field-tags-may-be-present-600x88.png 600w"></a><figcaption>Multiple identical field tags may be present</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Smoke Test: Remove Ads from Protobuf in O(n)-Time</h2><p><strong><span>It works!</span></strong> In one pass with no additional memory, I’m able to scan a huge 1.8 MiB chunk of jibberish-looking Protobuf data, and in the screenshot below only at the 30,593<sup>th</sup> byte (of 1.8 MiB) is our target found, and then backtracking ~600 characters yields our target field key to denature. Not only is this amazing, but I don’t even need to block <code>*.googleadservices.com</code> or URLs with <code>/pagead/</code> in them; Those requests are never made in the first place, anymore.</p><figure id="attachment_5838"><a href="https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response.png"><img src="https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-754x329.png" alt="Successfully able to remove ads from the Protobuf response" width="754" height="329" srcset="https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-754x329.png 754w, https://static.ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-300x131.png 300w, https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-600x262.png 600w, https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response.png 1313w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-754x329.png" data-srcset="https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-754x329.png 754w, https://static.ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-300x131.png 300w, https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response-600x262.png 600w, https://ericdraken.com/files/Successfully-able-to-remove-ads-from-the-Protobuf-response.png 1313w"></a><figcaption>Successfully able to remove ads from the Protobuf response</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>Analysis of this Successful Adblocking Technique</h2><h3>Summary</h3><p>By taking advantage of a feature (flaw?) in Protobuf that allows it to be backward compatible with schema changes, along with the fact that Protobuf is very sensitive to byte changes due to its compact nature, we can change a single byte in a critical location and tell Protobuf that an entire section of deeply-nested data is from a future schema version and it should be ignored.</p><h3>Timing Analysis</h3><p>Google returns huge responses in Protobuf (e.g. 1.8 MiB) – including even the layout of the iOS app – so only C++/Swift is fast enough to understand it all before the connection times out. I’ve shown that Python is several orders of magnitude too slow in decoding these Protobuf payloads, so connections do time out waiting on Python. With web-based JSON, the whole payload needs to be parsed, edited, and re-serialized; With my Protobuf technique, it takes microseconds thanks to a single linear scan and then ultra-quick backtracking. This technique is suitable for real-time adblocking without blocklists.</p><h3>Knock-On Benefits</h3><p>All those <code>*.googleadservices.com</code> and <code>/pagead/*</code> URLs on Apple devices originate from the Protobuf payload. This means they all go away for free – we don’t need to block them. In fact, the YouTube app is zippier because fewer connections are made to ad URLs in the first place. This means we can avoid keeping a blocklist of YouTube ad URLs and stay on the sidelines of the whack-a-mole fun. Ads do not register for video location “slots” on the Apple devices and the content just plays.</p><h3>Future-Proof</h3><p>This is a heuristic technique that looks for two strings: <code>/pagead/</code> and some calculated field tag nearby, so this technique is designed to be future-proof.</p><figure id="attachment_5822"><a href="https://static.ericdraken.com/files/Walking-backward-from-the-ad-marker.png"><img src="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png" alt="Walking backward from the ad marker" width="754" height="617" srcset="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png 754w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-300x246.png 300w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-600x491.png 600w, https://static.ericdraken.com/files/Walking-backward-from-the-ad-marker.png 966w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png" data-srcset="https://ericdraken.com/files/Walking-backward-from-the-ad-marker-754x617.png 754w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-300x246.png 300w, https://ericdraken.com/files/Walking-backward-from-the-ad-marker-600x491.png 600w, https://static.ericdraken.com/files/Walking-backward-from-the-ad-marker.png 966w"></a><figcaption>Walking backward from the ad marker to find the field key</figcaption></figure><p>Even if Google changes the field tag (and breaks millions of apps and Apple TVs before they upgrade), it’s an academic exercise to enhance the following script to discover the new field tag(s) automatically.</p><h3>Should Google be Worried?</h3><p>No, not at all.</p><p>This is a <strong>highly-specialized technique</strong> to block Apple-device YouTube ads (or Instagram, Whatsapp, Facebook, etc. tracker blocking). The CPU requirements to decrypt and re-encrypt HTTPS traffic greatly exceed those available to Raspberry Pis. Even if some company takes my script and considers making and selling a NIC dongle, it would likely not be powerful enough. An <a href="https://www.nvidia.com/en-us/shield/shield-tv/" target="_blank" rel="nofollow">Nvidia Shield</a> could handle it, but if you already have Android devices, then just hack the binaries; My technique is for Apple device owners where we don’t want to compromise the OS so that further reduces the audience of this technique.</p><p><a href="#top">Top ↩</a></p><hr><h2>The MITMProxy YouTube Adblocking Script</h2><p>Here is the MITMProxy addon script that serves as a proof-of-concept to block YouTube ads on networked Apple devices. The script can be run as follows (note the prerequisites in the script and be sure to install them first). Name it <code>youtube.py</code> and run the following command:</p><p><code>mitmdump --listen-port 8080 --listen-host 127.0.0.1 -s "youtube.py"</code></p><p>Here is the script, including a fairness function to allow ads 5% of the time:</p><div id="crayon-63661eaabe539122026764" data-nosnippet="data-nosnippet" data-settings=" minimize scroll-always"><table><tbody><tr><td data-settings="show"><div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p><p>65</p><p>66</p><p>67</p><p>68</p><p>69</p><p>70</p><p>71</p><p>72</p><p>73</p><p>74</p><p>75</p><p>76</p><p>77</p><p>78</p><p>79</p><p>80</p><p>81</p><p>82</p><p>83</p><p>84</p><p>85</p><p>86</p><p>87</p><p>88</p><p>89</p><p>90</p><p>91</p><p>92</p><p>93</p><p>94</p><p>95</p><p>96</p><p>97</p><p>98</p><p>99</p><p>100</p><p>101</p><p>102</p><p>103</p><p>104</p><p>105</p><p>106</p><p>107</p><p>108</p><p>109</p><p>110</p><p>111</p><p>112</p><p>113</p><p>114</p><p>115</p><p>116</p><p>117</p><p>118</p><p>119</p><p>120</p><p>121</p><p>122</p><p>123</p><p>124</p><p>125</p><p>126</p><p>127</p><p>128</p><p>129</p><p>130</p><p>131</p><p>132</p><p>133</p><p>134</p><p>135</p><p>136</p><p>137</p><p>138</p><p>139</p><p>140</p><p>141</p><p>142</p><p>143</p><p>144</p><p>145</p><p>146</p><p>147</p><p>148</p><p>149</p><p>150</p><p>151</p><p>152</p><p>153</p><p>154</p><p>155</p><p>156</p><p>157</p><p>158</p><p>159</p><p>160</p><p>161</p><p>162</p><p>163</p><p>164</p><p>165</p><p>166</p><p>167</p><p>168</p><p>169</p><p>170</p><p>171</p><p>172</p><p>173</p><p>174</p><p>175</p><p>176</p><p>177</p><p>178</p><p>179</p><p>180</p><p>181</p><p>182</p><p>183</p><p>184</p><p>185</p><p>186</p><p>187</p><p>188</p><p>189</p><p>190</p><p>191</p><p>192</p><p>193</p><p>194</p><p>195</p><p>196</p><p>197</p><p>198</p><p>199</p><p>200</p><p>201</p><p>202</p><p>203</p><p>204</p><p>205</p><p>206</p><p>207</p><p>208</p><p>209</p><p>210</p><p>211</p><p>212</p><p>213</p><p>214</p><p>215</p><p>216</p><p>217</p><p>218</p><p>219</p><p>220</p><p>221</p><p>222</p><p>223</p><p>224</p><p>225</p><p>226</p><p>227</p><p>228</p><p>229</p><p>230</p><p>231</p><p>232</p><p>233</p><p>234</p><p>235</p><p>236</p><p>237</p><p>238</p><p>239</p><p>240</p><p>241</p><p>242</p><p>243</p><p>244</p><p>245</p><p>246</p><p>247</p><p>248</p><p>249</p><p>250</p><p>251</p><p>252</p><p>253</p><p>254</p><p>255</p><p>256</p><p>257</p><p>258</p><p>259</p><p>260</p><p>261</p><p>262</p><p>263</p><p>264</p><p>265</p><p>266</p><p>267</p><p>268</p><p>269</p><p>270</p><p>271</p><p>272</p><p>273</p><p>274</p><p>275</p><p>276</p><p>277</p><p>278</p><p>279</p><p>280</p><p>281</p><p>282</p><p>283</p><p>284</p><p>285</p><p>286</p><p>287</p><p>288</p><p>289</p><p>290</p><p>291</p><p>292</p><p>293</p><p>294</p><p>295</p><p>296</p><p>297</p><p>298</p><p>299</p><p>300</p><p>301</p><p>302</p><p>303</p><p>304</p><p>305</p><p>306</p><p>307</p><p>308</p><p>309</p><p>310</p><p>311</p><p>312</p><p>313</p><p>314</p><p>315</p><p>316</p><p>317</p><p>318</p><p>319</p><p>320</p><p>321</p><p>322</p><p>323</p><p>324</p><p>325</p><p>326</p><p>327</p><p>328</p><p>329</p><p>330</p><p>331</p><p>332</p><p>333</p><p>334</p><p>335</p><p>336</p><p>337</p><p>338</p><p>339</p><p>340</p><p>341</p><p>342</p><p>343</p><p>344</p><p>345</p><p>346</p><p>347</p><p>348</p><p>349</p><p>350</p><p>351</p><p>352</p><p>353</p><p>354</p><p>355</p><p>356</p><p>357</p><p>358</p><p>359</p><p>360</p><p>361</p><p>362</p><p>363</p><p>364</p><p>365</p><p>366</p><p>367</p><p>368</p></div></td><td><div><p><span># -*- coding: utf-8 -*-</span></p><p><span>#&nbsp;&nbsp;Copyright (c) 2021. Eric Draken (ericdraken.com)</span></p><p><span>#&nbsp;&nbsp;Block YouTube ads on Apple devices by exploiting a Protobuf flaw</span></p><p><span>#</span></p><p><span>#&nbsp;&nbsp;FreeBSD Prerequisites:</span></p><p><span>#&nbsp;&nbsp;pkg install protobuf</span></p><p><span>#&nbsp;&nbsp;pkg install py38-pip</span></p><p><span>#&nbsp;&nbsp;pip install jsonpath-ng</span></p><p><span>#</span></p><p><span>import</span><span> </span><span>hashlib</span></p><p><span>import</span><span> </span><span>inspect</span></p><p><span>import</span><span> </span><span>json</span></p><p><span>import</span><span> </span><span>re</span></p><p><span>import</span><span> </span><span>subprocess</span></p><p><span>import</span><span> </span><span>sys</span></p><p><span>import</span><span> </span><span>traceback</span></p><p><span>from</span><span> </span><span>datetime</span><span> </span><span>import</span><span> </span><span>datetime</span></p><p><span>from</span><span> </span><span>json</span><span> </span><span>import</span><span> </span><span>JSONDecodeError</span></p><p><span>from</span><span> </span><span>typing </span><span>import</span><span> </span><span>Final</span></p><p><span>from</span><span> </span><span>google</span><span>.</span><span>protobuf</span><span>.</span><span>internal</span><span>.</span><span>encoder </span><span>import</span><span> </span><span>TagBytes</span></p><p><span>from</span><span> </span><span>google</span><span>.</span><span>protobuf</span><span>.</span><span>text_format </span><span>import</span><span> </span><span>WIRETYPE_LENGTH_DELIMITED</span></p><p><span>from</span><span> </span><span>jsonpath_ng </span><span>import</span><span> </span><span>DatumInContext</span></p><p><span>from</span><span> </span><span>jsonpath_ng </span><span>import</span><span> </span><span>jsonpath</span><span>,</span><span> </span><span>parse</span></p><p><span>from</span><span> </span><span>jsonpath_ng</span><span>.</span><span>ext </span><span>import</span><span> </span><span>parse</span></p><p><span>from</span><span> </span><span>mitmproxy </span><span>import</span><span> </span><span>ctx</span><span>,</span><span> </span><span>http</span></p><p><span>from</span><span> </span><span>mitmproxy</span><span>.</span><span>addons</span><span>.</span><span>next_layer </span><span>import</span><span> </span><span>NextLayer</span></p><p><span>from</span><span> </span><span>mitmproxy</span><span>.</span><span>flow </span><span>import</span><span> </span><span>Error</span></p><p><span>from</span><span> </span><span>mitmproxy</span><span>.</span><span>proxy </span><span>import</span><span> </span><span>layer</span><span>,</span><span> </span><span>layers</span></p><p><span>TRUNCATE_LEN</span><span>:</span><span> </span><span>Final</span><span>[</span><span>int</span><span>]</span><span> </span><span>=</span><span> </span><span>120</span></p><p><span>DEBUG_MODE</span><span>:</span><span> </span><span>bool</span><span> </span><span>=</span><span> </span><span>False</span></p><p><span>class</span><span> </span><span>Logger</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Helper to bypass the async logger loop to view logs in real-time"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>info</span><span>(</span><span>self</span><span>,</span><span> </span><span>msg</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>print</span><span>(</span><span>msg</span><span>)</span><span> </span><span>if</span><span> </span><span>DEBUG_MODE </span><span>else</span><span> </span><span>ctx</span><span>.</span><span>log</span><span>.</span><span>info</span><span>(</span><span>msg</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>warn</span><span>(</span><span>self</span><span>,</span><span> </span><span>msg</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>print</span><span>(</span><span>msg</span><span>)</span><span> </span><span>if</span><span> </span><span>DEBUG_MODE </span><span>else</span><span> </span><span>ctx</span><span>.</span><span>log</span><span>.</span><span>warn</span><span>(</span><span>msg</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>error</span><span>(</span><span>self</span><span>,</span><span> </span><span>msg</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>print</span><span>(</span><span>msg</span><span>)</span><span> </span><span>if</span><span> </span><span>DEBUG_MODE </span><span>else</span><span> </span><span>ctx</span><span>.</span><span>log</span><span>.</span><span>error</span><span>(</span><span>msg</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>alert</span><span>(</span><span>self</span><span>,</span><span> </span><span>msg</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>print</span><span>(</span><span>msg</span><span>)</span><span> </span><span>if</span><span> </span><span>DEBUG_MODE </span><span>else</span><span> </span><span>ctx</span><span>.</span><span>log</span><span>.</span><span>alert</span><span>(</span><span>msg</span><span>)</span></p><p><span>logger</span><span> </span><span>=</span><span> </span><span>Logger</span><span>(</span><span>)</span></p><p><span>def</span><span> </span><span>trunc</span><span>(</span><span>msg</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>str</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Helper for viewing very long URLs"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>msg</span><span> </span><span>=</span><span> </span><span>str</span><span>(</span><span>msg</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>len</span><span>(</span><span>msg</span><span>)</span><span> </span><span>&gt;</span><span> </span><span>TRUNCATE_LEN</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>f</span><span>"{msg[:TRUNCATE_LEN-3]}..."</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>msg</span></p><p><span>class</span><span> </span><span>KilledError</span><span>(</span><span>Error</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Better logging messages than just 'Connection killed.'"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>__init__</span><span>(</span><span>self</span><span>,</span><span> </span><span>reason</span><span>:</span><span> </span><span>str</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>None</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>_msg</span><span> </span><span>=</span><span> </span><span>Error</span><span>.</span><span>KILLED_MESSAGE</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>reason</span><span> </span><span>=</span><span> </span><span>reason</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>super</span><span>(</span><span>)</span><span>.</span><span>__init__</span><span>(</span><span>self</span><span>.</span><span>_msg</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>@</span><span>property</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>msg</span><span>(</span><span>self</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>caller</span><span> </span><span>=</span><span> </span><span>inspect</span><span>.</span><span>stack</span><span>(</span><span>)</span><span>[</span><span>1</span><span>]</span><span>.</span><span>function</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># These are the only two methods that compare the msg</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># with KILLED_MESSAGE to perform business logic</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>"killable"</span><span> </span><span>in</span><span> </span><span>caller </span><span>or</span><span> </span><span>"check_killed"</span><span> </span><span>in</span><span> </span><span>caller</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>self</span><span>.</span><span>_msg</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>self</span><span>.</span><span>reason</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Needed to satisfy a flow setter</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>@</span><span>msg</span><span>.</span><span>setter</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>msg</span><span>(</span><span>self</span><span>,</span><span> </span><span>msg</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>_msg</span><span> </span><span>=</span><span> </span><span>msg</span></p><p><span>class</span><span> </span><span>JSONPathReplacement</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Helper class to organize JSON ad replacements"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>__init__</span><span>(</span><span>self</span><span>,</span><span> </span><span>tag</span><span>:</span><span> </span><span>str</span><span>,</span><span> </span><span>target_path</span><span>:</span><span> </span><span>str</span><span>,</span><span> </span><span>replacement</span><span>:</span><span> </span><span>any</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>None</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>tag</span><span>:</span><span> </span><span>str</span><span> </span><span>=</span><span> </span><span>tag</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>target_path</span><span> </span><span>=</span><span> </span><span>target_path</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>target</span><span>:</span><span> </span><span>jsonpath</span><span>.</span><span>Root</span><span> </span><span>=</span><span> </span><span>parse</span><span>(</span><span>target_path</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>replacement</span><span>:</span><span> </span><span>any</span><span> </span><span>=</span><span> </span><span>replacement</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>update</span><span>(</span><span>self</span><span>,</span><span> </span><span>obj</span><span>:</span><span> </span><span>object</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>found</span><span> </span><span>=</span><span> </span><span>self</span><span>.</span><span>target</span><span>.</span><span>find</span><span>(</span><span>obj</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>found</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>index</span><span>,</span><span> </span><span>item </span><span>in</span><span> </span><span>enumerate</span><span>(</span><span>found</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>self</span><span>.</span><span>target</span><span>.</span><span>update</span><span>(</span><span>item</span><span>,</span><span> </span><span>self</span><span>.</span><span>replacement</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"Replaced `{self.target_path}[{index}]` with `{self.replacement}`"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>DEBUG_MODE</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>found_again</span><span> </span><span>=</span><span> </span><span>self</span><span>.</span><span>target</span><span>.</span><span>find</span><span>(</span><span>obj</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>replacement_json</span><span> </span><span>=</span><span> </span><span>json</span><span>.</span><span>dumps</span><span>(</span><span>self</span><span>.</span><span>replacement</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>index</span><span>,</span><span> </span><span>item_ </span><span>in</span><span> </span><span>enumerate</span><span>(</span><span>found_again</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>item</span><span>:</span><span> </span><span>DatumInContext</span><span> </span><span>=</span><span> </span><span>item_</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>json</span><span>.</span><span>dumps</span><span>(</span><span>item</span><span>.</span><span>value</span><span>)</span><span> </span><span>!=</span><span> </span><span>replacement_json</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>error</span><span>(</span><span>f</span><span>"Replacement of `{self.target_path}` did not succeed. Found `{json.dumps(item.value)}`"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>else</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>info</span><span>(</span><span>f</span><span>"-Skipping `{self.target_path}`"</span><span>)</span></p><p><span>class</span><span> </span><span>ProtobufDebugParser</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Use the C++ protoc binary to parse raw Protobuf data. This is for debugging."""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>cmd</span><span> </span><span>=</span><span> </span><span>[</span><span>"protoc"</span><span>,</span><span> </span><span>"--decode_raw"</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>url_re</span><span> </span><span>=</span><span> </span><span>re</span><span>.</span><span>compile</span><span>(</span><span>r</span><span>"(https?://[^\s\\]+)"</span><span>,</span><span> </span><span>re</span><span>.</span><span>IGNORECASE</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>format_response</span><span>(</span><span>self</span><span>,</span><span> </span><span>data</span><span>:</span><span> </span><span>bytes</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>list</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>protoc_proc</span><span> </span><span>=</span><span> </span><span>subprocess</span><span>.</span><span>Popen</span><span>(</span><span>self</span><span>.</span><span>cmd</span><span>,</span><span> </span><span>shell</span><span>=</span><span>False</span><span>,</span><span> </span><span>stdin</span><span>=</span><span>subprocess</span><span>.</span><span>PIPE</span><span>,</span><span> </span><span>stdout</span><span>=</span><span>subprocess</span><span>.</span><span>PIPE</span><span>,</span><span> </span><span>stderr</span><span>=</span><span>subprocess</span><span>.</span><span>PIPE</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>stdout</span><span>,</span><span> </span><span>stderr</span><span>)</span><span> </span><span>=</span><span> </span><span>protoc_proc</span><span>.</span><span>communicate</span><span>(</span><span>data</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>stderr</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>raise</span><span> </span><span>Exception</span><span>(</span><span>stderr</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>stdout</span><span>.</span><span>splitlines</span><span>(</span><span>keepends</span><span>=</span><span>False</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>parse_response</span><span>(</span><span>self</span><span>,</span><span> </span><span>data</span><span>:</span><span> </span><span>bytes</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>list</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>protoc_proc</span><span> </span><span>=</span><span> </span><span>subprocess</span><span>.</span><span>Popen</span><span>(</span><span>self</span><span>.</span><span>cmd</span><span>,</span><span> </span><span>shell</span><span>=</span><span>False</span><span>,</span><span> </span><span>stdin</span><span>=</span><span>subprocess</span><span>.</span><span>PIPE</span><span>,</span><span> </span><span>stdout</span><span>=</span><span>subprocess</span><span>.</span><span>PIPE</span><span>,</span><span> </span><span>stderr</span><span>=</span><span>subprocess</span><span>.</span><span>PIPE</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>grep_process</span><span> </span><span>=</span><span> </span><span>subprocess</span><span>.</span><span>Popen</span><span>(</span><span>[</span><span>"grep"</span><span>,</span><span> </span><span>"https://"</span><span>]</span><span>,</span><span> </span><span>shell</span><span>=</span><span>False</span><span>,</span><span> </span><span>stdin</span><span>=</span><span>protoc_proc</span><span>.</span><span>stdout</span><span>,</span><span> </span><span>stdout</span><span>=</span><span>subprocess</span><span>.</span><span>PIPE</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>_</span><span>,</span><span> </span><span>stderr</span><span>)</span><span> </span><span>=</span><span> </span><span>protoc_proc</span><span>.</span><span>communicate</span><span>(</span><span>data</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>(</span><span>stdout</span><span>,</span><span> </span><span>_</span><span>)</span><span> </span><span>=</span><span> </span><span>grep_process</span><span>.</span><span>communicate</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>stderr</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>raise</span><span> </span><span>Exception</span><span>(</span><span>stderr</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>urls</span><span> </span><span>=</span><span> </span><span>stdout</span><span>.</span><span>splitlines</span><span>(</span><span>keepends</span><span>=</span><span>False</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>matches</span><span> </span><span>=</span><span> </span><span>[</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>url </span><span>in</span><span> </span><span>urls</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>match</span><span> </span><span>=</span><span> </span><span>self</span><span>.</span><span>url_re</span><span>.</span><span>search</span><span>(</span><span>url</span><span>.</span><span>decode</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>match</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>matches</span><span>.</span><span>append</span><span>(</span><span>match</span><span>.</span><span>group</span><span>(</span><span>0</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>matches</span></p><p><span>class</span><span> </span><span>YouTubeAdBlocker</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Intercept certain YouTube domains and modify the JSON or Protobuf to remove ads from YouTube"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Set this to the blackhole IP used by pfBlockerNG, or even a partial blackhole IP</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>blackhole_ip_prefix</span><span>:</span><span> </span><span>Final</span><span>[</span><span>str</span><span>]</span><span> </span><span>=</span><span> </span><span>"10.10.10."</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Intercept only these wildcard domains and no others</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>intercept_hosts</span><span> </span><span>=</span><span> </span><span>r</span><span>"\.youtube\.com|google\.(com|ca)|googleapis\.com|googleadservices\.com|googlevideo\.com"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>intercept_hosts_re</span><span> </span><span>=</span><span> </span><span>re</span><span>.</span><span>compile</span><span>(</span><span>intercept_hosts</span><span>,</span><span> </span><span>re</span><span>.</span><span>IGNORECASE</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ad_url_search_string</span><span> </span><span>=</span><span> </span><span>b</span><span>"/pagead/"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ad_url_search_limit</span><span> </span><span>=</span><span> </span><span>80_000</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>target_field_tag</span><span> </span><span>=</span><span> </span><span>50195462</span><span>&nbsp;&nbsp;</span><span># This is just one of several field tags</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>protobuf_parser</span><span> </span><span>=</span><span> </span><span>ProtobufDebugParser</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Block requests from wildcard domains with any of the follow URL strings</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>blocked_partials</span><span>:</span><span> </span><span>dict</span><span> </span><span>=</span><span> </span><span>{</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"youtube.com"</span><span>:</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"pagead/"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"log_event?"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"stats/ads"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"stats/qoe?"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"ptracking?"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"generate_204"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"error_204"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"adformat="</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"activeview?"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"_ad_"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"ai?"</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"sw.js"</span><span>,</span><span>&nbsp;&nbsp;</span><span># Just say no to service workers</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"google.com"</span><span>:</span><span> </span><span>[</span><span>"pagead/"</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"google.ca"</span><span>:</span><span> </span><span>[</span><span>"pagead/"</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"googleapis.com"</span><span>:</span><span> </span><span>[</span><span>"pagead/"</span><span>]</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>}</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Strip sections of JSON that contain ad information (for web YouTube)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>json_replacements</span><span> </span><span>=</span><span> </span><span>[</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"yt_ad"</span><span>,</span><span> </span><span>"$.responseContext.serviceTrackingParams[*].params[?(@.key == 'yt_ad')].value"</span><span>,</span><span> </span><span>"0"</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"adPlacements"</span><span>,</span><span> </span><span>"$..adPlacements"</span><span>,</span><span> </span><span>[</span><span>]</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"adPlacementRenderer"</span><span>,</span><span> </span><span>"$..adPlacementRenderer"</span><span>,</span><span> </span><span>{</span><span>}</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"adPlacementConfig"</span><span>,</span><span> </span><span>"$..adPlacementConfig"</span><span>,</span><span> </span><span>{</span><span>}</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"adVideoId"</span><span>,</span><span> </span><span>"$..adVideoId"</span><span>,</span><span> </span><span>""</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"playerAdParams"</span><span>,</span><span> </span><span>"$..playerAdParams"</span><span>,</span><span> </span><span>{</span><span>}</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"showCompanion"</span><span>,</span><span> </span><span>"$..showCompanion"</span><span>,</span><span> </span><span>False</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"showInstream"</span><span>,</span><span> </span><span>"$..showInstream"</span><span>,</span><span> </span><span>False</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"useGut"</span><span>,</span><span> </span><span>"$..useGut"</span><span>,</span><span> </span><span>False</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>JSONPathReplacement</span><span>(</span><span>"gutParams"</span><span>,</span><span> </span><span>"$..gutParams"</span><span>,</span><span> </span><span>{</span><span>}</span><span>)</span><span>,</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>@</span><span>staticmethod</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>in_allowed_ads_window</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Allow ads 5% of the time to support content creators which follows the CRTC rules for Student Radio.</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;REF: https://crtc.gc.ca/eng/television/publicit/publicit.htm"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>now</span><span> </span><span>=</span><span> </span><span>datetime</span><span>.</span><span>now</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span><span> </span><span>0</span><span> </span><span>&lt;=</span><span> </span><span>now</span><span>.</span><span>minute</span><span> </span><span>&lt;=</span><span> </span><span>2</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""The following methods are hooks that are called during the normal flow of MITMProxy"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># noinspection PyMethodMayBeStatic</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>load</span><span>(</span><span>self</span><span>,</span><span> </span><span>_</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Do not allow piped requests we could miss</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span>.</span><span>options</span><span>.</span><span>http2</span><span> </span><span>=</span><span> </span><span>False</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span>.</span><span>options</span><span>.</span><span>update</span><span>(</span><span>http2</span><span>=</span><span>False</span><span>,</span><span> </span><span>anticomp</span><span>=</span><span>True</span><span>,</span><span> </span><span>mode</span><span>=</span><span>"transparent"</span><span>,</span><span> </span><span>termlog_verbosity</span><span>=</span><span>"debug"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>except</span><span> </span><span>KeyError</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span>.</span><span>options</span><span>.</span><span>update</span><span>(</span><span>http2</span><span>=</span><span>False</span><span>,</span><span> </span><span>anticomp</span><span>=</span><span>True</span><span>,</span><span> </span><span>mode</span><span>=</span><span>"transparent"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"{self.__class__.__name__} loaded"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>running</span><span>(</span><span>self</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Intercept requests only for YouTube domains"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>ctx</span><span>.</span><span>options</span><span>.</span><span>allow_hosts</span><span> </span><span>!=</span><span> </span><span>[</span><span>self</span><span>.</span><span>intercept_hosts</span><span>]</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span>.</span><span>options</span><span>.</span><span>allow_hosts</span><span> </span><span>=</span><span> </span><span>[</span><span>self</span><span>.</span><span>intercept_hosts</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>ctx</span><span>.</span><span>options</span><span>.</span><span>ignore_hosts</span><span> </span><span>=</span><span> </span><span>[</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>next_layer_addon</span><span>:</span><span> </span><span>NextLayer</span><span> </span><span>=</span><span> </span><span>ctx</span><span>.</span><span>master</span><span>.</span><span>addons</span><span>.</span><span>get</span><span>(</span><span>"NextLayer"</span><span>.</span><span>lower</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>next_layer_addon</span><span>.</span><span>configure</span><span>(</span><span>"allow_hosts"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"Updated interceptable YouTube hosts"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>next_layer</span><span>(</span><span>self</span><span>,</span><span> </span><span>nextlayer</span><span>:</span><span> </span><span>layer</span><span>.</span><span>NextLayer</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Allow blocked domains that resolve the blackhole IP to pass through"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>nextlayer</span><span>.</span><span>context</span><span>.</span><span>server</span><span>.</span><span>address </span><span>and</span><span> </span><span>nextlayer</span><span>.</span><span>context</span><span>.</span><span>server</span><span>.</span><span>address</span><span>[</span><span>0</span><span>]</span><span>.</span><span>startswith</span><span>(</span><span>self</span><span>.</span><span>blackhole_ip_prefix</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>nextlayer</span><span>.</span><span>layer</span><span> </span><span>=</span><span> </span><span>layers</span><span>.</span><span>TCPLayer</span><span>(</span><span>nextlayer</span><span>.</span><span>context</span><span>,</span><span> </span><span>ignore</span><span>=</span><span>True</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span># noinspection PyMethodMayBeStatic</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>error</span><span>(</span><span>self</span><span>,</span><span> </span><span>flow</span><span>:</span><span> </span><span>http</span><span>.</span><span>HTTPFlow</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""The TLS failed due to an ad-blocker info page with no verified TLS"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>flow</span><span>.</span><span>error </span><span>and</span><span> </span><span>(</span><span>"OpenSSL Error"</span><span> </span><span>in</span><span> </span><span>flow</span><span>.</span><span>error</span><span>.</span><span>msg </span><span>and</span><span> </span><span>"alert internal error"</span><span> </span><span>in</span><span> </span><span>flow</span><span>.</span><span>error</span><span>.</span><span>msg</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>flow</span><span>.</span><span>kill</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>request</span><span>(</span><span>self</span><span>,</span><span> </span><span>flow</span><span>:</span><span> </span><span>http</span><span>.</span><span>HTTPFlow</span><span>)</span><span> </span><span>-&gt;</span><span> </span><span>None</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""Block ad URLs that pfBlockerNG and Pi-hole cannot detect"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Skip inspecting certain requests</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>flow</span><span>.</span><span>response </span><span>or</span><span> </span><span>flow</span><span>.</span><span>error </span><span>or</span><span> </span><span>(</span><span>flow</span><span>.</span><span>reply </span><span>and</span><span> </span><span>flow</span><span>.</span><span>reply</span><span>.</span><span>state</span><span> </span><span>==</span><span> </span><span>"taken"</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Occasionally skip blocking ads to support content creators</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>self</span><span>.</span><span>in_allowed_ads_window</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>test_url</span><span>:</span><span> </span><span>str</span><span> </span><span>=</span><span> </span><span>flow</span><span>.</span><span>request</span><span>.</span><span>url</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>test_host</span><span>:</span><span> </span><span>str</span><span> </span><span>=</span><span> </span><span>flow</span><span>.</span><span>request</span><span>.</span><span>pretty_host</span><span>.</span><span>lower</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>host</span><span>,</span><span> </span><span>partials </span><span>in</span><span> </span><span>self</span><span>.</span><span>blocked_partials</span><span>.</span><span>items</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>test_host</span><span>.</span><span>endswith</span><span>(</span><span>host</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>partial </span><span>in</span><span> </span><span>partials</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>partial </span><span>in</span><span> </span><span>test_url</span><span>.</span><span>lower</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>msg</span><span> </span><span>=</span><span> </span><span>f</span><span>"✘ [{host} -&gt; {partial}] blocking {trunc(flow.request.pretty_url)}..."</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>info</span><span>(</span><span>msg</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Should be a connection refused error</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>flow</span><span>.</span><span>kill</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>flow</span><span>.</span><span>error</span><span> </span><span>=</span><span> </span><span>KilledError</span><span>(</span><span>msg</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;</span><span>def</span><span> </span><span>response</span><span>(</span><span>self</span><span>,</span><span> </span><span>flow</span><span>:</span><span> </span><span>http</span><span>.</span><span>HTTPFlow</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""This is the main workhorse. Intercept JSON and Protobuf responses and modify them</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;to remove or denature ad information"""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Skip inspecting certain responses</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>not</span><span> </span><span>flow</span><span>.</span><span>response </span><span>or</span><span> </span><span>flow</span><span>.</span><span>error </span><span>or</span><span> </span><span>not</span><span> </span><span>flow</span><span>.</span><span>response</span><span>.</span><span>headers</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"&gt;&gt; {flow.request}\n&lt;&lt; {flow.response}\n\n"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Occasionally skip blocking ads to support content creators</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>self</span><span>.</span><span>in_allowed_ads_window</span><span>(</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>test_path</span><span>:</span><span> </span><span>str</span><span> </span><span>=</span><span> </span><span>flow</span><span>.</span><span>request</span><span>.</span><span>url</span><span>.</span><span>lower</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>test_content_type</span><span>:</span><span> </span><span>str</span><span> </span><span>=</span><span> </span><span>str</span><span>(</span><span>flow</span><span>.</span><span>response</span><span>.</span><span>headers</span><span>.</span><span>get</span><span>(</span><span>"content-type"</span><span>)</span><span>)</span><span>.</span><span>lower</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Examine the Protobuf payload</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>"protobuf"</span><span> </span><span>in</span><span> </span><span>test_content_type</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"Intercepting {trunc(test_path)} Protobuf"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Capture rich Protobuf information to disk for offline analysis</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>DEBUG_MODE</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># TODO: This copying can be avoided, but this is debug mode, so we allow it</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>body</span><span> </span><span>=</span><span> </span><span>bytearray</span><span>(</span><span>flow</span><span>.</span><span>response</span><span>.</span><span>get_content</span><span>(</span><span>strict</span><span>=</span><span>False</span><span>)</span><span> </span><span>or</span><span> </span><span>b</span><span>""</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>lines</span><span> </span><span>=</span><span> </span><span>self</span><span>.</span><span>protobuf_parser</span><span>.</span><span>format_response</span><span>(</span><span>body</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>filename</span><span> </span><span>=</span><span> </span><span>""</span><span>.</span><span>join</span><span>(</span><span>x</span><span> </span><span>for</span><span> </span><span>x</span><span> </span><span>in</span><span> </span><span>test_path</span><span>[</span><span>:</span><span>100</span><span>]</span><span> </span><span>if</span><span> </span><span>(</span><span>x</span><span>.</span><span>isalnum</span><span>(</span><span>)</span><span> </span><span>or</span><span> </span><span>x</span><span> </span><span>in</span><span> </span><span>"._- "</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>filename</span><span> </span><span>=</span><span> </span><span>f</span><span>"protobuf-{filename}-{hashlib.md5(test_path.encode()).hexdigest()}"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>with</span><span> </span><span>open</span><span>(</span><span>f</span><span>"{filename}.formatted"</span><span>,</span><span> </span><span>mode</span><span>=</span><span>"w"</span><span>,</span><span> </span><span>buffering</span><span>=</span><span>True</span><span>)</span><span> </span><span>as</span><span> </span><span>f</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>line </span><span>in</span><span> </span><span>lines</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>f</span><span>.</span><span>write</span><span>(</span><span>f</span><span>"{line}\n"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>with</span><span> </span><span>open</span><span>(</span><span>f</span><span>"{filename}.raw"</span><span>,</span><span> </span><span>mode</span><span>=</span><span>"wb"</span><span>)</span><span> </span><span>as</span><span> </span><span>f</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>f</span><span>.</span><span>write</span><span>(</span><span>flow</span><span>.</span><span>response</span><span>.</span><span>raw_content </span><span>or</span><span> </span><span>b</span><span>""</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>with</span><span> </span><span>open</span><span>(</span><span>f</span><span>"{filename}.decoded"</span><span>,</span><span> </span><span>mode</span><span>=</span><span>"wb"</span><span>)</span><span> </span><span>as</span><span> </span><span>f</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>f</span><span>.</span><span>write</span><span>(</span><span>body </span><span>or</span><span> </span><span>b</span><span>""</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># TODO: Use a memory view or some more efficient search structure</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>body</span><span>:</span><span> </span><span>bytearray</span><span> </span><span>=</span><span> </span><span>bytearray</span><span>(</span><span>flow</span><span>.</span><span>response</span><span>.</span><span>get_content</span><span>(</span><span>strict</span><span>=</span><span>False</span><span>)</span><span> </span><span>or</span><span> </span><span>b</span><span>""</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Find a telltale ad URL, but limit the search</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>distance</span><span> </span><span>=</span><span> </span><span>body</span><span>[</span><span>:</span><span> </span><span>self</span><span>.</span><span>ad_url_search_limit</span><span>]</span><span>.</span><span>find</span><span>(</span><span>self</span><span>.</span><span>ad_url_search_string</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>distance</span><span> </span><span>&lt;</span><span> </span><span>0</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>return</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"Found {self.ad_url_search_string} at position {distance}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Search forward for an ad URL signature, then backtrack to find the field tag</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>tag_bytes</span><span> </span><span>=</span><span> </span><span>TagBytes</span><span>(</span><span>self</span><span>.</span><span>target_field_tag</span><span>,</span><span> </span><span>WIRETYPE_LENGTH_DELIMITED</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>new_bytes</span><span> </span><span>=</span><span> </span><span>TagBytes</span><span>(</span><span>self</span><span>.</span><span>target_field_tag</span><span> </span><span>-</span><span> </span><span>1</span><span>,</span><span> </span><span>WIRETYPE_LENGTH_DELIMITED</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>target_pos</span><span> </span><span>=</span><span> </span><span>body</span><span>[</span><span>:</span><span> </span><span>distance</span><span> </span><span>-</span><span> </span><span>1</span><span>]</span><span>[</span><span>::</span><span>-</span><span>1</span><span>]</span><span>.</span><span>find</span><span>(</span><span>tag_bytes</span><span>[</span><span>::</span><span>-</span><span>1</span><span>]</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>if</span><span> </span><span>target_pos</span><span> </span><span>&gt;</span><span> </span><span>0</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>target_pos</span><span> </span><span>=</span><span> </span><span>distance</span><span> </span><span>-</span><span> </span><span>1</span><span> </span><span>-</span><span> </span><span>target_pos</span><span> </span><span>-</span><span> </span><span>len</span><span>(</span><span>tag_bytes</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"Found {self.target_field_tag} at position {target_pos}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>assert</span><span> </span><span>body</span><span>[</span><span>target_pos</span><span>]</span><span> </span><span>==</span><span> </span><span>tag_bytes</span><span>[</span><span>0</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>assert</span><span> </span><span>body</span><span>[</span><span>target_pos</span><span> </span><span>+</span><span> </span><span>1</span><span>]</span><span> </span><span>==</span><span> </span><span>tag_bytes</span><span>[</span><span>1</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>assert</span><span> </span><span>body</span><span>[</span><span>target_pos</span><span> </span><span>+</span><span> </span><span>2</span><span>]</span><span> </span><span>==</span><span> </span><span>tag_bytes</span><span>[</span><span>2</span><span>]</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>ind</span><span>,</span><span> </span><span>b</span><span> </span><span>in</span><span> </span><span>enumerate</span><span>(</span><span>new_bytes</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>body</span><span>[</span><span>target_pos</span><span> </span><span>+</span><span> </span><span>ind</span><span>]</span><span> </span><span>=</span><span> </span><span>b</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>"""NOTE: There are other field keys in different sections, </span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and there may be multiple ad sections to denature. What preceded</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;is a PoC of the technique that already blocks 90% of ads."""</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Example Protobuf path:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"4 {"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;49399797 {"</span><span>&nbsp;&nbsp;</span><span># Damage this key</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;&nbsp;&nbsp;1 {"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ... /pagead/"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Example Protobuf path</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 {"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;50195462 {"</span><span>&nbsp;&nbsp;</span><span># Damage this key</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 {"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;153515154 {"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>b</span><span>"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ... /pagead/"</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Put the contents back in the response body</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>flow</span><span>.</span><span>response</span><span>.</span><span>set_content</span><span>(</span><span>bytes</span><span>(</span><span>body</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>except</span><span> </span><span>Exception</span><span> </span><span>as</span><span> </span><span>e</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_</span><span>,</span><span> </span><span>_</span><span>,</span><span> </span><span>exc_traceback</span><span> </span><span>=</span><span> </span><span>sys</span><span>.</span><span>exc_info</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>traceback_</span><span> </span><span>=</span><span> </span><span>traceback</span><span>.</span><span>format_tb</span><span>(</span><span>exc_traceback</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>alert</span><span>(</span><span>f</span><span>"{e!r}, {traceback_}"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>elif</span><span> </span><span>"json"</span><span> </span><span>in</span><span> </span><span>test_content_type</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>warn</span><span>(</span><span>f</span><span>"Intercepting {trunc(test_path)} JSON"</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span># Examine the JSON payload</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>try</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>obj</span><span> </span><span>=</span><span> </span><span>flow</span><span>.</span><span>response</span><span>.</span><span>json</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>for</span><span> </span><span>replacement </span><span>in</span><span> </span><span>self</span><span>.</span><span>json_replacements</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>replacement</span><span>.</span><span>update</span><span>(</span><span>obj</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>flow</span><span>.</span><span>response</span><span>.</span><span>set_content</span><span>(</span><span>json</span><span>.</span><span>dumps</span><span>(</span><span>obj</span><span>,</span><span> </span><span>ensure_ascii</span><span>=</span><span>False</span><span>)</span><span>.</span><span>encode</span><span>(</span><span>)</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>except</span><span> </span><span>(</span><span>TypeError</span><span>,</span><span> </span><span>JSONDecodeError</span><span>)</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>pass</span><span>&nbsp;&nbsp;</span><span># Do not stop the show</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>except</span><span> </span><span>Exception</span><span> </span><span>as</span><span> </span><span>e</span><span>:</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>_</span><span>,</span><span> </span><span>_</span><span>,</span><span> </span><span>exc_traceback</span><span> </span><span>=</span><span> </span><span>sys</span><span>.</span><span>exc_info</span><span>(</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>traceback_</span><span> </span><span>=</span><span> </span><span>traceback</span><span>.</span><span>format_tb</span><span>(</span><span>exc_traceback</span><span>)</span></p><p><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span>logger</span><span>.</span><span>alert</span><span>(</span><span>f</span><span>"{e!r}, {traceback_}"</span><span>)</span></p><p><span># Register the addon</span></p><p><span>addons</span><span> </span><span>=</span><span> </span><span>[</span><span>YouTubeAdBlocker</span><span>(</span><span>)</span><span>]</span></p></div></td></tr></tbody></table></div><p>This script happens to work in Python for a TLS-decrypting man-in-the-middle proxy written in Python. As a working proof-of-concept, it’s pretty rad. Of course, it can be rewritten in Rust or Go or anything but single-threaded Python, but as an intellectual exercise to defeat ads that are served from the same domain as content, it’s elegant.</p><p><a href="#top">Top ↩</a></p><hr><h2>YouTube Premium</h2><p>It’s unknown if CAD <del>$9.99/mo</del> $11.99/mo ($13.43/mo with tax) is even reasonable: Do I personally incur CAD $11.99 of cost to advertisers each month?</p><figure id="attachment_5906"><a href="https://static.ericdraken.com/files/youtube-advertising-cost.png"><img src="https://ericdraken.com/files/youtube-advertising-cost-754x282.png" alt="How much does YouTube advertising cost?" width="754" height="282" srcset="https://ericdraken.com/files/youtube-advertising-cost-754x282.png 754w, https://ericdraken.com/files/youtube-advertising-cost-300x112.png 300w, https://ericdraken.com/files/youtube-advertising-cost-600x225.png 600w, https://static.ericdraken.com/files/youtube-advertising-cost.png 785w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/youtube-advertising-cost-754x282.png" data-srcset="https://ericdraken.com/files/youtube-advertising-cost-754x282.png 754w, https://ericdraken.com/files/youtube-advertising-cost-300x112.png 300w, https://ericdraken.com/files/youtube-advertising-cost-600x225.png 600w, https://static.ericdraken.com/files/youtube-advertising-cost.png 785w"></a><figcaption><a href="https://www.webfx.com/social-media/pricing/how-much-does-youtube-advertising-cost/" target="_blank" rel="nofollow">Source</a></figcaption></figure><p>Since ads are auctioned, the CPV (cost-per-view) varies. Also, many ad campaigns have a capped daily budget, so theoretically there should be fewer ads in the evenings as budgets run out during the day.</p><h3>Experiment in Ad Viewing</h3><p>I watched YouTube on and off for a day on a clean notebook computer with private browsing. My history showed that I only “watched” 10 videos:</p><ul><li>I fast-forwarded through a few of them to get past the “like and subscribe” runtime padding.</li><li>I jumped to the end of one just to get to the “top three” from a “top twenty” list.</li><li>Two were low quality so I left early.</li><li>The rest were music videos.</li></ul><p>In all, for watching parts of 10 videos, I was exposed to 8 ads, and only two were skippable (which I skipped).</p><h3>$0.15 as a Ballpark CPV</h3><p>Let’s use USD $0.15 as a CPV. In one day, let’s say, I incurred 8 x $0.15, or $1.20 to advertisers. Extrapolated to one month, that is roughly USD $36/mo. Do I really cost advertisers USD $36/mo for very casual YouTube viewing? That sounds terrible for advertisers.</p><h3>CPV from US Advertising Spend Divided by Total Views</h3><p>From <a href="https://www.statista.com/statistics/289658/youtube-global-net-advertising-revenues/" target="_blank" rel="nofollow">Statistica</a>, in 2019, US YouTube advertisers spent $15.1 billion dollars. Also in 2019, US residents had 916 billion views (<a href="#ad-spend">ref</a>). That works out to an average of $15.1B / 916B, or USD $0.0165 per view. Then for me, that is only USD 13 cents. Extrapolated to one month, I theoreticaly cost advertisers only USD $3.96/mo.</p><h3>Is YouTube Premium Worth It?</h3><p><a href="https://static.ericdraken.com/files/YouTube-Premium.png"><img src="https://static.ericdraken.com/files/YouTube-Premium-754x324.png" alt="YouTube Premium subscription fee as of Jan, 2022" width="754" height="324" srcset="https://static.ericdraken.com/files/YouTube-Premium-754x324.png 754w, https://static.ericdraken.com/files/YouTube-Premium-300x129.png 300w, https://ericdraken.com/files/YouTube-Premium-600x258.png 600w, https://static.ericdraken.com/files/YouTube-Premium.png 807w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://static.ericdraken.com/files/YouTube-Premium-754x324.png" data-srcset="https://static.ericdraken.com/files/YouTube-Premium-754x324.png 754w, https://static.ericdraken.com/files/YouTube-Premium-300x129.png 300w, https://ericdraken.com/files/YouTube-Premium-600x258.png 600w, https://static.ericdraken.com/files/YouTube-Premium.png 807w"></a></p><p>When I allowed ads for my experiment, I hit the hardware mute button. I also looked away because I have several computers with a lot going on. Ad spend is wasted on me, but I still want to support content creators. For me, CAD $13.48/mo is more than I incur on actual ads and more than I pay for a Netflix subscription. The only way to justify the cost is to have YouTube playing constantly in the background on a TV.</p><p>However, I truly enjoy a handful of creators, so I may start watching them in the background on non-stop play. Let’s give the three-month YouTube Premium trial a chance, and I will still be monitoring what they track about me.</p><figure id="attachment_5913"><a href="https://static.ericdraken.com/files/youtube-premium-traffic.png"><img src="https://ericdraken.com/files/youtube-premium-traffic-754x282.png" alt="YouTube Premium network traffic" width="754" height="282" srcset="https://ericdraken.com/files/youtube-premium-traffic-754x282.png 754w, https://static.ericdraken.com/files/youtube-premium-traffic-300x112.png 300w, https://ericdraken.com/files/youtube-premium-traffic-600x224.png 600w, https://static.ericdraken.com/files/youtube-premium-traffic.png 1503w" sizes="(max-width: 754px) 100vw, 754px" data-old-src="https://ericdraken.com/minified/fcf7107d/assets/images/lazy_placeholder.gif" data-src="https://ericdraken.com/files/youtube-premium-traffic-754x282.png" data-srcset="https://ericdraken.com/files/youtube-premium-traffic-754x282.png 754w, https://static.ericdraken.com/files/youtube-premium-traffic-300x112.png 300w, https://ericdraken.com/files/youtube-premium-traffic-600x224.png 600w, https://static.ericdraken.com/files/youtube-premium-traffic.png 1503w"></a><figcaption>YouTube Premium network traffic</figcaption></figure><p><a href="#top">Top ↩</a></p><hr><h2>DMCA, Sony, Viacom</h2><p>Recently I learned that due to abuses of the <a href="https://en.wikipedia.org/wiki/Digital_Millennium_Copyright_Act" target="_blank" rel="nofollow">DMCA Act of 1998</a>, YouTube content creators who make reaction videos and “easter egg” videos may have their videos claimed by big companies like Sony and Viacom. That means that from when a claim is made, all ad revenue goes to those big companies, and not even to the creators. That means in all likelihood I unknowingly may not even be supporting my favourite YouTube creators.</p><div><p><strong>Did you know?</strong> Many fair-use and video-game-commentary videos may have automated copyright claims against them, meaning that ad revenue goes to big companies with deep legal pockets and your favourite creators may get nothing, so more and more creators leave YouTube for Twitch.</p></div><p><a href="#top">Top ↩</a></p><hr><h2>Summary of Accomplishments</h2><p>I rarely give up, so this is an example of going into an extreme problem-solving mode to solve a fun problem loosely using cryptography and reverse engineering. In the end, a single byte turned it all around, so it was all worth it to come to an elegant and satisfying solution.</p><div><p><strong>Success:</strong> We were able to set up a hardware router from scratch, segment LANs into trusted and untrusted zones, set up traditional DNS adblocking, add a transparent MITM proxy, and ultimately block YouTube ads on networked Apple devices.</p><p>Note: This was a hard problem – now solved – so I am paying for YouTube Premium to give the CPU a rest.</p></div><p><a href="#top">Top ↩</a></p><hr> <hr><span itemscope="" itemtype="http://schema.org/BlogPosting"><meta itemscope="" itemprop="mainEntityOfPage" itemtype="https://schema.org/WebPage" itemid="https://google.com/article"><meta itemprop="headline" content="Block YouTube Ads on AppleTV by Decrypting and Stripping Ads from Profobuf"><meta itemprop="articleBody" content="Apple TV and iPhone YouTube ads are not blocked by DNS adblockers (e.g. Pi-hole), so I heavily researched this and discovered a flaw in Protobuf that allows me to restrict YouTube ads on Apple TV and iOS by simply changing one byte in the Protobuf responses after decrypting HTTPS network traffic."><meta itemprop="description" content="Apple TV and iPhone YouTube ads are not blocked by DNS adblockers (e.g. Pi-hole), so I heavily researched this and discovered a flaw in Protobuf that allows me to restrict YouTube ads on Apple TV and iOS by simply changing one byte in the Protobuf responses after decrypting HTTPS network traffic."><span itemprop="image" itemscope="" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://ericdraken.com/files/pfsense-featured.png"><meta itemprop="width" content="150"><meta itemprop="height" content="50"></span><meta itemprop="datePublished" content="2022-01-6"><meta itemprop="dateModified" content="2022-06-9"><span itemprop="publisher" itemscope="" itemtype="https://schema.org/Organization"><span itemprop="logo" itemscope="" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://secure.gravatar.com/avatar/1b8450e7611d06cec2a2c3a6dcfc1b30?s=96&amp;d=mm&amp;r=g"><meta itemprop="width" content="32"><meta itemprop="height" content="32"></span><meta itemprop="name" content="Eric"></span></span></article></main></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[If you're interested in eye-tracking, I'm interested in funding you (239 pts)]]></title>
            <link>https://twitter.com/paulg/status/1695596853864321055</link>
            <guid>37278345</guid>
            <pubDate>Sun, 27 Aug 2023 00:51:13 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://twitter.com/paulg/status/1695596853864321055">https://twitter.com/paulg/status/1695596853864321055</a>, See on <a href="https://news.ycombinator.com/item?id=37278345">Hacker News</a></p>
Couldn't get https://twitter.com/paulg/status/1695596853864321055: Error [ERR_FR_TOO_MANY_REDIRECTS]: Maximum number of redirects exceeded]]></description>
        </item>
        <item>
            <title><![CDATA[Linux on a Commodore 64 (147 pts)]]></title>
            <link>https://github.com/onnokort/semu-c64</link>
            <guid>37277907</guid>
            <pubDate>Sat, 26 Aug 2023 23:36:32 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://github.com/onnokort/semu-c64">https://github.com/onnokort/semu-c64</a>, See on <a href="https://news.ycombinator.com/item?id=37277907">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><h2 tabindex="-1" dir="auto">Running Linux on a Commodore C-64</h2>
<p dir="auto">"But does it run Linux?" can now be finally and affirmatively answered for the Commodore C64!</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/onnokort/semu-c64/blob/master/booted.jpeg"><img src="https://github.com/onnokort/semu-c64/raw/master/booted.jpeg" alt="Booted"></a></p>
<p dir="auto">There is a catch (rather: a couple) of course: It runs <em>extremely</em> slowly and it needs a RAM Expansion Unit (REU), as there is no chance to fit it all into just 64KiB.</p>
<p dir="auto">It even emulates virtual memory with an MMU.</p>
<p dir="auto">I have <strong>not</strong> tested it on <strong>real hardware yet</strong>, that's the next challenge .. for you. So please send me a link to a timelapse video of an original unit with REU booting Linux :D</p>
<h2 tabindex="-1" dir="auto">Building it</h2>
<p dir="auto">Just use <code>make</code>. You need <a href="https://github.com/llvm-mos/"><code>mos-c64-clang</code></a>.</p>
<p dir="auto">Change the single <code>C64</code> variable at the top of the Makefile and you should be able to switch between a <code>x86_64</code> and an <code>llvm-mos-6502</code> build of the code.</p>
<p dir="auto">The notes from the <a href="https://github.com/onnokort/semu-c64/blob/master/README.original.md">original README</a> apply for the most part. The kernel configuration is different, though, as the kernel from the original <code>semu</code> is too bloated with huge section alignments. A more fitting kernel configuration can be found in the <code>config</code> subfolder. Finally, to assemble it all into the REU image needed for the VICE emulator, use the <code>mk_linux_reu.py</code> script. It still uses the original <code>initrd</code> image, as that works just well.</p>
<h2 tabindex="-1" dir="auto">Running it</h2>
<p dir="auto">To run it, simply create a <code>.d64</code> file containing the compiled <code>semu</code> executable (or simply select the correct path for a virtual disk drive in the emulator). Then (in VICE EMU), go to Preferences | Settings | Cartridges | RAM Expansion Module, enable it and select the file <code>reufile.linux</code>, and make sure to select the correct size (16MiB) as well. If you started <code>x64</code> from the console, a message that it loaded successfully should appear.</p>
<p dir="auto">Then, do <code>LOAD "SEMU",8,1</code> and <code>run</code> and ... <em>wait</em> ... (hours!). With "warp mode" enabled in the emulator, the first boot messages should appear within a few minutes, though.</p>
<p dir="auto">You can also use the PC <code>semu</code> binary with the <code>-k</code> option to load the reufile.linux into the PC emulator and you should get a 100% identical boot sequence, as everything should be deterministic until the first keypress.</p>
<p dir="auto">I plan to add an archive with all the neccessary premade binaries as soon as I figured out how to do that on github. Look for something on the "Releases" tab.</p>
<h2 tabindex="-1" dir="auto">Further notes</h2>
<ul dir="auto">
<li>
<p dir="auto">The screenshots took VICE <em>a couple hours</em> in "warp mode" (activate it with Alt-W) to generate. So, as is, a real C64 should be able to boot Linux within a week or so.</p>
</li>
<li>
<p dir="auto">The compiled 6502 code is not really optimized yet, and it might be realistic to squeeze a factor 10x of performance out of this. Maybe even a simple form of JIT compilation? It should also be possible to implement starting a checkpointed VM (quickly precomputed on <code>x86-64</code>) to avoid the lengthy boot process. Maybe <code>X</code> on an emulated framebuffer device in 320x200 graphics mode? VIC-II DRI? :D</p>
</li>
<li>
<p dir="auto">I also tested a minimal micropython port (I can clean it up and post it on github if there is interest), that one does not use the MMU and is almost barely remotely usable with lots of optimism at 100% speed...</p>
</li>
<li>
<p dir="auto">The generated <code>semu</code> executable is a generic RISCV32 emulator and it simply assumes that the REU maps to the address range 0x00000000 .. 0x01000000. You should be able to compile any (embedded, bare-bones) RISCV32 executable that uses just the emulated UART, fill it up to a size of 16MiB, load it as a REU-image into VICE and run it using the same <code>semu</code> 6510 binary.</p>
</li>
<li>
<p dir="auto">Likewise, I made a simple <a href="https://github.com/mist64/kernalemu">kernalemu</a> fork with "REU support" which seems to run a lot faster than Vice.</p>
</li>
<li>
<p dir="auto">The emulated UART does upper-/lowercase PETSCII&lt;-&gt;ASCII translation. That could use a lot of improvement, though ...</p>
</li>
</ul>
<h2 tabindex="-1" dir="auto">Thanks</h2>
<p dir="auto">This is in essence a fork of the very nicely minimalist RISC-V32 emulator named <a href="https://github.com/sysprog21/semu">semu</a>, compiled and ported using the new <a href="https://github.com/llvm-mos/">llvm-mos</a> and would not have been so possible without all that previous work.</p>
<h2 tabindex="-1" dir="auto">(Boot animation)</h2>
<p dir="auto"><a target="_blank" rel="noopener noreferrer" href="https://github.com/onnokort/semu-c64/blob/master/boot_anim.gif"><img src="https://github.com/onnokort/semu-c64/raw/master/boot_anim.gif" alt="(Boot animation)" data-animated-image=""></a></p>
<p dir="auto">Time not to scale.</p>
</article>
          </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Airbnb allowing host to place cameras in the room where I would be sleeping (108 pts)]]></title>
            <link>https://old.reddit.com/r/BestofRedditorUpdates/comments/1623v0b/airbnb_allowing_host_to_place_cameras_in_the_room/</link>
            <guid>37277016</guid>
            <pubDate>Sat, 26 Aug 2023 21:20:02 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://old.reddit.com/r/BestofRedditorUpdates/comments/1623v0b/airbnb_allowing_host_to_place_cameras_in_the_room/">https://old.reddit.com/r/BestofRedditorUpdates/comments/1623v0b/airbnb_allowing_host_to_place_cameras_in_the_room/</a>, See on <a href="https://news.ycombinator.com/item?id=37277016">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><p>TW: <span>Invasion of Privacy</span></p>

<p><a href="https://www.reddit.com/r/BestofRedditorUpdates/comments/15tx7yy/airbnb_allowing_host_to_place_cameras_in_the_room/">New Update from Last Week's BORU</a>. To skip to the update, just go to 🔴🔴 and read ahead</p>

<p>Previous BORUs on the subject:</p>

<p><a href="https://www.reddit.com/r/BestofRedditorUpdates/comments/zqt49j/airbnb_allowing_host_to_place_cameras_in_the_room/"><strong>Airbnb Allowing host to place cameras in the room where I would be sleeping</strong></a> Dec 20, 2022</p>

<p><a href="https://www.reddit.com/r/BestofRedditorUpdates/comments/10teee3/update_on_the_oop_taking_on_airbnb_for_letting_a/"><strong>First Update</strong></a> Feb 04 2023</p>

<p><a href="https://www.reddit.com/r/BestofRedditorUpdates/comments/11saoz0/new_update_from_court_in_ongoing_case_airbnb/"><strong>Second Update (by OOP)</strong></a> March 15 2023</p>

<p>If you're just looking for the story without the commentary, the Second Update has it all.</p>

<p>Reminder that OP is <a href="https://old.reddit.com/u/AtypicalCommonplace">u/AtypicalCommonplace</a>. I am not OP. I've tried to hyperlink all of the resources/links from the post as is.</p>

<p>Quick Summary of previous events: OOP is a woman and a lawyer. She stayed at an AirBnB in NYC in 2022. Upon completing the initial booking, the owner revealed the property had cameras monitoring the <em>inside</em> of the studio apartment. OOP sought to cancel and get refunded. Her other posts describe her attempts to receive the refund, suing AirBnB and taking them to arbitration and the process leading up to the arbitration itself over the course of several months in 2023.</p>

<p><strong>Previous Update:</strong></p>

<p><a href="https://www.reddit.com/user/AtypicalCommonplace/comments/15np1c3/case_closed_airbnb_cameras_yadda_yadda_yadda/"><strong>Case Closed (Airbnb, Cameras, Yadda Yadda Yadda)</strong></a> Aug 10 2023</p>

<p>TLDR: Our hearing was held Aug 1st, the arbitrator has 30 days to decide. Arbitration turned out to be a pretty awful experience and I'm not very hopeful but still glad I fought!</p>

<p><a href="https://www.reddit.com/r/BestofRedditorUpdates/comments/11saoz0/new_update_from_court_in_ongoing_case_airbnb/">For the latest full case update you can go here -ish</a></p>

<p>I've been writing this post in my head in the two seconds I have each day now that I've morphed from single woman to mom of two (I met a single dad on reddit - RIP R4R - and my life is now utterly changed and I'm happier and more exhausted than I have ever been!) but now that I am over a week out I figured I'd post an update for anywhere who is still here!</p>

<p>As noted above, our hearing was finally held on August 1st and lasted SIX (6!!!) hours so was pretty mentally and emotionally exhausting. I keep thinking of things I should have said (of course now after the fact) but the long and short of the argument I was trying to make was that, look, if Airbnb is basically saying that you CAN have a camera in a private space then it COULD record the bed and, um, that's bad (and reminder, <a href="https://www.airbnb.com/help/article/3061">against Airbnb's policies</a>).</p>

<p>But because Airbnb conceded that they would pay me what I was promised on September 26th, 2022 (almost a year ago! fun!) the hearing itself got super bogged down into the weeds of whether I had PROOF that there was a camera (reminder, I didn't because the first customer service rep told me that the hosts' acknowledgment that there was one wasn't enough). Their contention from the start has been that the <a href="https://www.airbnb.com/help/article/2908">Terms of Service</a> basically make you sign away all of your rights and even if the company itself erred they aren't liable for anything. Side note - have y'all watched "<a href="https://www.youtube.com/watch?v=5jY1ecibLYo">Joan is Awful</a>" because the whole ToS madness reminded me of that.</p>

<p>Of course, my whole issue here is that it SHOULDN'T take someone 12+ hours, months of time, and filing a case in arbitration to get what was promised to them, and which they relied on, from a corporation that obviously has the time and resources to squash me like a little bug. They also argued that while the terms of service SAY that cameras can't be "inside" what they REALLY mean is "inside and monitoring" so, if that is the case , why not just remove the "inside" piece from the ambiguous language? I continue to be baffled why they fought this so hard but I digress. Here's what I wrote regarding that in my opening argument,</p>

<p>When I began this case I was a single woman. I’m have a partner and am the mother to two small children. Truth be told, if this were to happen today, I wouldn’t have had the time or energy to spend a week of my vacation fighting customer service representatives, nor would I have had the ability to attempt to seek resolution or argue this matter in arbitration. I would have had to give up even though the law of promissory estoppel, as I will argue today, make it plainly clear that I was owed what I was promised.</p>

<p>Thus, should this case only result in my recouping of the $1,502.78, it, in effect, means that in order for a consumer to be able to effectively rely upon a promise made by a company, they must also be willing to jump through hours of time, months of effort, and eventually litigation in order to receive what was promised. The impact is a chilling effect - consumers are forced to choose between expending time and energy or simply “giving up.” What of consumers who don’t have the privilege of time? Where would their justice be?</p>

<p>I think what was most surprising to me, though perhaps it shouldn't be, was the way in which the lawyers tried to attack my character. Saying I was doing this for youtube views (did I bring up the fact that the youtube video has since been removed by myself? lol no) or for a "reddit following." They dug up reddit posts that I had made about this case in the heat of anger that I almost immediately realized were mean and unfair and so I took them down - but wayback is a thing and everything can be found and I guess they wanted to show that, yes, this case kind of turned me into an asshole at times. I kind of lost in in a tumbling bridge of sadness way at this point. We had already played recordings of me crying with customer service (embarrassing) and in order to "prove" that I was impacted by this I had to submit anxiety medications my doctor had prescribed me that I was then cross-examined on (double embarrassing), so I don't really get the point that was other than to try and kick me while I was down. Of course, I know the lawyers are only doing their jobs but I guess I felt sad that that is a job anyone would choose to do.</p>

<p>So - why am I still posting here, knowing that it could get me in trouble? Well, first I would argue to whoever is checking these posts that the hearing itself was never ordered to be confidential and I am not sharing anything deemed confidential but, more than that, I think that people have a right to know what they will be up against if they try and challenge a large corporation in arbitration which is meant to be a "fair and efficient hearing." Unfortunately, my experiences in arbitration didn't feel that way at all. I suppose I could delightfully be proven wrong but, sadly, the moral of the story here, to me, is that it isn't worth it. Which, you know, is what corporations WANT us to think and feel so we DO give up. When both arbitration rules and a company's own terms of service (23.3 here) say you are supposed to enter into good faith negotiations before moving forward, and when a company fails to enter into these in any way shape or form - I think the rule should just be that the consumer wins. Otherwise we are enabling a massive imbalance of power that will only lead to the further erosion of fairness and consumer rights.</p>

<p>But who cares what I think ;)</p>

<p>The one silver lining in all of this has been receiving more mental health support. As y'all know, part of what frustrated me so much about this was the very real knowledge I have those cameras in private areas can and will ultimately lead to victimization from already marginalized people. And I've begun talking to my therapist about <a href="https://www.brainline.org/article/secondary-ptsd-or-secondary-traumatic-stress-should-not-be-underestimated">secondary PTSD</a> and am looking into talking to psychology students who may be interested in a dissertation specifically on how 2PTSD impacts lawyers representing survivors.</p>

<p>Oh, and, of course, had I never received as much support from reddit I may never have turned my dating life over to the wonders of the anonymous internet (I used a throwaway account for my R4R post) and <a href="https://imgur.com/gallery/LGRDtPI">wouldn't now have this in my life.</a> (OP's note. The link is to an image of a child's hand or hands intertwined with that of two adults.)</p>

<p>So, in the end.....</p>

<ul>
<li>Audre Lorde was right, the master's tools cannot dismantle the master's house,</li>
<li>Arbitration is not as pro se and consumer-friendly as it is made out to be</li>
<li>If you're reading this airbnb, which I know you are, please please please please please please please don't allow cameras inside any private area. <a href="https://osce.usmission.gov/taking-a-lesson-from-traffickers-harnessing-technology-to-further-the-anti-trafficking-movement/">The risk is, truly, too great.</a></li>
<li>But reddit remains a pretty cool place. Thanks y'all &lt;3</li>
</ul>

<p>🔴🔴🔴🔴</p>

<p><a href="https://www.reddit.com/user/AtypicalCommonplace/comments/15v6cab/airbnb_camera_arbitration_case_update_we/"><strong>Airbnb Camera Arbitration Case Update: WE WON!!!!!!!!!!!!!!!!!! ... thirty five dollars.</strong></a> August 19 2023</p>

<p>The day after I made my last post I woke up with a pit in my stomach and just had a feeling the decision was going to come out. And, low and behold, on August 7th, the arbitrator made their decision.</p>

<p>In short, Airbnb made a promise and they should keep that promise because I relied on it. So I am owed the money promised ($1502 in total - and yes, that is the actual number) - But it was my fault for not doing more research on the property before booking and I had no proof that there actually WAS a camera there was no deceptive language or material omission in the listing. And because I didn't lose money over this case (meaning I didn't like quit my job, though I have had to take on fewer clients in general) and I didn't have any out of pocket medical expenses, and because I agreed to the ToS which doesn't make airbnb liable anyways, I'm basically SOOL. And I wasn't going to try and push MAKING UP a fee I incurred just for the right thing to happen. The judge DID apply interest between Sept when I was told that I would get the refund and March when a "Selttlement" of that amount was made.</p>

<p>Reminder here, if I HADN'T brought this to arbitration then airbnb was just going to KEEP my money because I refused to stay at a place once they told me, AFTER I BOOKED, there were cameras INSIDE a PRIVATE BOOKING. AFTER I also relied on airbnb confirming it was not ok! And confirming I didn't need to go there to verify the camera was inside because the listing was enough!</p>

<p>It;s wild to me that the end result, given these very facts alone (that there was a promise made that I relied on and was reassured I could rely on - (y'all in the recordings I even ask exactly when I will get the refund due to a concern about my credit card balance since I'd need to go book at a hotel before airbnb reimbursed me) - that I wasn't awarded any compensation for being put through the ringer to actually GET THAT. It honestly blows my mind that because "all I lost was time" then that isn;t worth anything. And yet, the lawyers, the arbitrator, everyone but me is MAKING MONEY off of the fact that I have to work this hard to get the $1500. The arbitrator made more than I did in this case. The lawyers made more than I did in this case. Like, for that reason alone I am just......fuming.</p>

<p>But ADD TO THE FACT that this is about cameras! Not hidden cameras that airbnb doesn't know about. No. We are talking cameras inside spaces. And this is where I get even angrier. Because airbnb is making the MOST off of this because hey won't have to piss off hosts with cameras inside studios by making it explicit they can't have them. I literally cannot imagine any other reason why they still would not have clarified the policy to this day (even their own employees were confused as per our phone calls) - side note, reminder, I was on these phone calls so these were not confidential nor is this hearing- sorry I am paranoid they are going to try and sue me lol!) So that is what is getting at the root of what is eating me alive in this case. Because I wasn't given a fair shot at this,</p>

<p>For example, I was supposed to be afforded the right to discovery. I asked for, for example, notes about the creation of the policy itself. So that I could, you know, show there is a REASON this is against their policy!!</p>

<p>I asked for copies of internal emails sent about me so that I could, you know, show they knew about me trying to reach out and willfully didn't attempt a settlement in good faith which is, against their own terms of service (see pgh 23.3).</p>

<p>I asked for internal notes from the customer service reps to each other about my calls, etc. I asked for notes from a meeting I know incurred internally about my case because a friend of mine was at it. I asked for reasons behind why I was later told the unit was taken down two months after I reported it.</p>

<p>I won't get too into the weeds but, basically Airbnb objected to everything except recordings of my phone calls (which they had verbally agreed to at a previous hearing) but they did not submit their objections to the arbitrator on the due date of June 21. I asked literally half a dozen times where my discovery was, as there was no ruling to be made on an unfiled objection and I received nothing other than my recorded calls. I get no answer until mid July when I write an email demanding to receive discovery. The arbitrator only orders discovery on notes about the host. Airbnb asks for an extension and gets one after it is now weeks after discovery was due. I get only notes of the listing and call recordings with my host and airbnb and nothing internal. It is now july 22 and the hearing is on August 1t. I still have nothing internal from airbnb to prepare with and request a delay in hearing for arguments to be made on discovery. I bring up the fact California law outlines that discovery must at least 15 days before the hearing for full fairness. My request to delay was denied.</p>

<p>Instead we have a phone call where Airbnb basically says it would be too burdensome to have to look through emails with my name because airbnb has "6,000 employees" (I truly feel this was made for me to feel small.) They claimed they had no record of a meeting I know occurred because my friend was there but I wasn't willing to sell out my friend to "prove" it (the judge wanted to see the email I had - wasn't going to do that.) ANd on and on. And all my requests for discovery were denied and the hearing happened the next day. I was NOT prepared to move forward with basically nothing, but I did what I could with what I had. But I honestly couldn't believe that basically no discovery was allowed.</p>

<p>Anyways, this has already gotten incredibly way too long but I continue to think it's important to know just how wild arbitration is. Some folks called out in the BORU update that I am a lawyer and should have known that but I am one of those wild people who, while I have heard the most horrible stories from the depths of humanity, I still just have a fundamental belief that folks are going to do the right thing. There;s definitely an amount of white, cis, and socioeconomically hangin- in-there privilege there too, I know. But I just didn't actually believe I would wind up with......nothing. And I can't believe I had to fight it this hard to not end up in the negative and just end up.....neutral. And to see how little my time is worth in a court of law, how little anyone's would be. And you're, really, the only one with anything to lose.</p>

<p>It;s been a bit of a mindfuck.</p>

<p>But what REALLY REALLY REALLY kills me. Is that the decision didn't even get things right. There are things I could ARGUE with, yes, (they argue the camera could have been in the kitchen and there was a partition there and the photos I have showing only one door doesn't "prove" that was the door that was being talked about and thus I didn't KNOW it was in a room with a bed), sure. But there were fundamental basic things about the case that objectively were or were not true that the arbitrator gets wrong. Like the timeline in when I canceled the booking and what langauge was told to me after i booked v. before.</p>

<p>But there is NO right to appeal EVEN IF the arbitrator gets the facts wrong.</p>

<p>No y'all. I kid you not. This is real. If an arbitrator gets the law wrong, or gets the facts wrong, you're SOOL. It;s wild.</p>

<p>Something else that's wild?</p>

<p>One reason that you can, however, get a case booted from arbitration to court is if the arbitrator refuses to delay the hearing thus prejudicing the rights of either party. And guess what happened in this case....</p>

<p>Oh, and also, Airbnb's ToS 23.5 states that there's an exception to arbitration for public injunctions - here's how that reads:</p>

<p>You and Airbnb each agree that the following causes of action and/or claims for relief are exceptions to the Arbitration Agreement and will be brought in a judicial proceeding in a court of competent jurisdiction (as defined by Section 22):.....(iii) a request for the remedy of public injunctive relief; .........You and Airbnb agree that the remedy of public injunctive relief will proceed after the arbitration of all arbitrable claims, remedies, or causes of action, and will be stayed pending the outcome of the arbitration pursuant to section 3 of the Federal Arbitration Act.</p>

<p>So.....</p>

<p>What the heck do I do? I've contacted a few lawyers and keep getting the "that's a great argument, but it will be a heck of a fight" so, while I have a few willing to take this on on an hourly basis, none so far would do so on a contingency basis (meaning I wouldn't pay them they would just get a percentage of whatever I win monetarily.") And I don't have the money to do that and I do not have the personal energy to go it alone.</p>

<p>Truth be told, I am in a really solid place in life at the moment. Questioning a lot, as always, feeling stuck on my career and figuring out what is next, but in love and building a home and making a family feels fulfilling in ways I never imagined. And it's ok if I want to put down this weight as well. I have the hope that maybe I will find someone whose fire is lit by this. Maybe someone who does want to file a suit on contingency. Maybe someone is starting a class action so the US can be like Canada and realize the absurdity of forced arbitration clauses. Maybe a reporter wants to write about this so someone ELSE will be inspired to do something. But it's out of my hands at this point - other than my experience and passion I've not much else to offer so I'm passing the baton.</p>

<p>Thanks, all, for being on this wild ride with me and making me feel a little less alone when it felt like a whole lot of others were trying to make me feel pretty insignificant. And who knows...</p>
</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Thoughts about what worked in math circles (175 pts)]]></title>
            <link>https://buttondown.email/j2kun/archive/thoughts-about-what-worked-in-math-circles/</link>
            <guid>37276502</guid>
            <pubDate>Sat, 26 Aug 2023 20:20:07 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://buttondown.email/j2kun/archive/thoughts-about-what-worked-in-math-circles/">https://buttondown.email/j2kun/archive/thoughts-about-what-worked-in-math-circles/</a>, See on <a href="https://news.ycombinator.com/item?id=37276502">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>

                

                
                    
                        
<p>After about 7 months of math circles
with a group of 7- turning 8-year-old boys and girls,
I decided to take a break to breathe
and reflect on what worked and what didn't.</p>
<p>It's interesting how big a gulf there is
between what math topic you think will be interesting
to a 7-year-old
and what actually captures their attention.
Let me start by giving some examples
of things I <em>thought</em> would catch their interest
but flopped.</p>
<ul>
<li><a href="https://amzn.to/3DiBtPY" target="_blank">The game SET</a>.</li>
<li><a href="https://en.wikipedia.org/wiki/Fold-and-cut_theorem" target="_blank">Fold-and-cut puzzles</a>.</li>
<li><a href="https://amzn.to/3DeG9X5" target="_blank">Geometry snacks</a>.</li>
<li><a href="https://www.youtube.com/watch?v=wKV0GYvR2X8" target="_blank">Cutting a Mobius strip</a>.</li>
<li>Tessellations (<a href="https://momath.org/wp-content/uploads/2022/03/ChaimGoodman-Strauss2021RosenthalPrizeLessonPlan.pdf" target="_blank">Tooti Tooti</a>, pdf link).</li>
<li><a href="https://amzn.to/3Ko8m1F" target="_blank">Prime Climb</a>.</li>
<li>Making <a href="https://en.wikipedia.org/wiki/Flexagon" target="_blank">flexagons</a>.</li>
<li>Ruler and compass constructions.</li>
</ul>
<p>Things I didn't think they'd like but they loved:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Knights_and_Knaves" target="_blank">Knights and Knaves puzzles</a>,
  and more generally any topic about propositional logic (blue-eyed islanders.</li>
<li>Manually scheduling a round-robin tournament's worth of sports games,
  trying to minimize the latency of the entire tournament. (I originally phrased it as a soccer tournament, but that week the kid who loves soccer the most didn't show up, and so it turned into a DANCE competition, which was much more fun)</li>
<li>Seven bridges problems, and trying to find the smallest "impossible" bridge problem.</li>
<li>Trying to figure out who is better at penalty kicks based on counts of scores/misses.</li>
<li>Coming up with your own Pascal's triangle-type pattern.</li>
</ul>
<p>And then there were the problems
I thought they would love, and they did.</p>
<ul>
<li>The Function Machine game (guess a function given the ability to query it as a black-box)</li>
<li>Variations of <a href="https://en.wikipedia.org/wiki/Nim" target="_blank">Nim</a>.</li>
<li><a href="https://amzn.to/43odWrr" target="_blank">The Turing Tumble</a>.</li>
<li>Fair cake cutting (with real cookies and oddly-distributed toppings).</li>
<li>Game theory games like Prisoner's dilemma and Chicken.</li>
<li>Making mocktails for 3 people, given a recipe for 1 drink, and again with a recipe that serves 5. (fractions practice). Measurements were in quarters of ounces.</li>
</ul>
<p><img alt="cookies with oddly distributed toppings" src="https://buttondown.imgix.net/images/281bd56a-61a7-4e26-84c1-98dfd6638c8b.jpg?w=960&amp;fit=max"> 
 <img alt="A poster with two recipes on it, the first making 1 drink and the second making 5" src="https://buttondown.imgix.net/images/1a6c1f86-5791-4c67-ad24-7aaf00f73fb2.jpg?w=960&amp;fit=max"> </p>
<p>Back in 2019 I wrote an article,
<a href="https://github.com/j2kun/essays/blob/main/attention-spans-for-math-and-stories.md" target="_blank">Attention spans for math and stories</a>
in which I described how I have used storytelling
with kids of various ages
(not in a math context)
to get them participating in activities and feeling welcome in a group.
I tied it back to math,</p>
<blockquote>
<p>To have good mathematical content revolving around stories,
mathematicians should learn to tell stories well.</p>
</blockquote>
<p>Somehow, though, my story-telling game
was off during some of my math circles.
I think through all my reading and learning about math circles,
I had internalized a different viewpoint.
That viewpoint, roughly speaking,
is that the math should speak for itself.
Much math circle literature
seems to suggest that a facilitator
should start with an open-ended mystery
(like, "can you draw a perfect shape?")
and then sit quiet until the participants
start asking questions and exploring on their own
(in this example, maybe discovering ruler and compass constructions).</p>
<p>I suspect this might work
with an older group of students,
or a group of students who have already bought into math
in some sense.
I know, for example, that many parents
who find math circles are desperately
searching for resources because their kid's
math ability is beyond their comprehension.
Some of these kids are believed to be on the autism spectrum as well.</p>
<p>The group I worked with were as typical
upper middle class kids as you could find.
They came to math circle after soccer practice.
When they got bored during the circle they
goofed off and roughhoused.
Though they had never played "Among Us,"
they constantly called things "sus."
More importantly,
they just didn't care about number patterns
unless it was couched in a more engaging format.
Geometry was a complete dud,
because it's even harder to come up with stories
about arbitrary figures with shaded regions you want to find the area of.
They didn't think tessellations were pretty.
And they didn't have the dexterity required
to make enough cuts and folds
to construct objects out of paper,
so they ended the fold-and-cut
and flexagon activities feeling frustrated.</p>
<p>But the idea that there are two people,
one of whom is a ROTTEN LIAR,
and you have to figure out who is the liar
based on the clues in what they say?
That's gold.
For that knights and knaves puzzle,
I wrote down the phrases Alice and Bob
said on pieces of paper,
taped them to plastic straws,
and held them up like signs.
The first puzzle was:</p>
<ul>
<li>Alice: Bob is a liar!</li>
<li>Bob: Neither of us are liars.</li>
</ul>
<p>The kids all jumped to say who they thought was the most "sus",
and they predicted that Alice was suspicious for blaming Bob.
With a bit of discussion,
they realized that they can't both be telling the truth
because their claims are mutually contradictory
(though they didn't have the word for this and often called it "opposites").
Then we talked about how many possibilities there are.
First they thought 2, then 4.
It's 4: two liars, liar truth-teller,
truth-teller liar, and two truth-tellers.
Then we proceeded to inspect each option,
and after a while they agreed
that the only possibility was that
Alice was telling the truth and Bob was lying (correct!).</p>
<p>Then an interesting thing happened.
As I moved on to the next knights-and-knaves puzzle they asked if they got the first one right.
And I said, "well, do you think you got it right?"
One boy admitted he wasn't entirely certain,
and then we all agreed to keep thinking about it
until we were convinced by the proof.
So it was planting the seed:
how do you know if you've truly proved something?
Later in that session he remarked to one of the girl's comments,
"No, we already proved that case!"</p>
<p>After the months of weekly sessions, however,
I think the kids are warming up to the idea
of the math speaking for its own sake.
While I led the Seven Bridge of Konigsberg
problem with a story,
they quickly discarded the story and focused on the challenge.
And in a later session they asked to revisit it
because they wanted to try to find the "smallest impossible bridges problem."
Indeed, they did!
While we didn't solve the original problem,
the idea of simplifying a problem,
making it smaller and smaller until you can solve it,
and then gradually adding back complexity,
was clearly on display those weeks.</p>
<p>And though they hated flexagons,
for an "end of the session" gift
I made them each a hexaflexagon
from a <a href="https://thinkzone.wlonk.com/Flexagon/Flexagon.htm" target="_blank">printed template</a>
which critically had bright, distinct pictures on each face.
Weeks later, one girl's dad
told me that she is obsessed with it,
only recently discovering the sixth face.
I let him know that you can draw a map of the flexagon's movements,
much like the Seven Bridges maps we drew,
to get a clear picture of the whole configuration space.
I have yet to hear back whether they were able to figure it out.</p>
<p>So I have hope that this group can graduate to appreciating
the math for its own sake.
But if I were to start with a new group
of kids who had no <em>a priori</em> love of math,
I'd have to be a bit more deliberate in framing
the problems in engaging stories.</p>
                    
                

                
            </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Attention didn’t collapse. It was stolen (2022) (121 pts)]]></title>
            <link>https://www.theguardian.com/science/2022/jan/02/attention-span-focus-screens-apps-smartphones-social-media</link>
            <guid>37276485</guid>
            <pubDate>Sat, 26 Aug 2023 20:18:24 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.theguardian.com/science/2022/jan/02/attention-span-focus-screens-apps-smartphones-social-media">https://www.theguardian.com/science/2022/jan/02/attention-span-focus-screens-apps-smartphones-social-media</a>, See on <a href="https://news.ycombinator.com/item?id=37276485">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="maincontent"><p><span><span>W</span></span>hen he was nine years old, my godson Adam developed a brief but freakishly intense obsession with Elvis Presley. He took to singing Jailhouse Rock at the top of his voice with all the low crooning and pelvis-jiggling of the King himself. One day, as I tucked him in, he looked at me very earnestly and asked: “Johann, will you take me to Graceland one day?” Without really thinking, I agreed. I never gave it another thought, until everything had gone wrong.</p><p>Ten years later, Adam was lost. He had dropped out of school when he was 15, and he spent almost all his waking hours alternating blankly between screens – a blur of YouTube, WhatsApp and porn. (I’ve changed his name and some minor details to preserve his privacy.) He seemed to be whirring at the speed of Snapchat, and nothing still or serious could gain any traction in his mind. During the decade in which Adam had become a man, this fracturing seemed to be happening to many of us. Our ability to pay attention was cracking and breaking. I had just turned 40, and wherever my generation gathered, we would lament our lost capacity for concentration. I still read a lot of books, but with each year that passed, it felt more and more like running up a down escalator. Then one evening, as we lay on my sofa, each staring at our own ceaselessly shrieking screens, I looked at him and felt a low dread. “Adam,” I said softly, “let’s go to Graceland.” I reminded him of the promise I had made. I could see that the idea of breaking this numbing routine ignited something in him, but I told him there was one condition he had to stick to if we went. He had to switch his phone off during the day. He swore he would.</p><p>When you arrive at the gates of Graceland, there is no longer a human being whose job is to show you around. You are handed an iPad, you put in little earbuds, and the iPad tells you what to do – turn left; turn right; walk forward. In each room, a photograph of where you are appears on the screen, while a narrator describes it. So as we walked around we were surrounded by blank-faced people, looking almost all the time at their screens. As we walked, I felt more and more tense. When we got to the jungle room – Elvis’s favourite place in the mansion – the iPad was chattering away when a middle-aged man standing next to me turned to say something to his wife. In front of us, I could see the large fake plants that Elvis had bought to turn this room into his own artificial jungle. “Honey,” he said, “this is amazing. Look.” He waved the iPad in her direction, and began to move his finger across it. “If you swipe left, you can see the jungle room to the left. And if you swipe right, you can see the jungle room to the right.”</p><p>His wife stared, smiled, and began to swipe at her own iPad. I leaned forward. “But, sir,” I said, “there’s an old-fashioned form of swiping you can do. It’s called turning your head. Because we’re here. We’re in the jungle room. You can see it unmediated. Here. Look.” I waved my hand, and the fake green leaves rustled a little. Their eyes returned to their screens. “Look!” I said. “Don’t you see? <em> </em>We’re <em>actually there. </em>There’s no need for your screen. <em>We are in the jungle room.</em>” They hurried away. I turned to Adam, ready to laugh about it all – but he was in a corner, holding his phone under his jacket, flicking through Snapchat.</p><p>At every stage in the trip, he had broken his promise. When the plane first touched down in New Orleans two weeks before, he took out his phone while we were still in our seats. “You promised not to use it,” I said. He replied: “I meant I wouldn’t make phone calls. I can’t not use Snapchat and texting, obviously.” He said this with baffled honesty, as though I had asked him to hold his breath for 10 days. In the jungle room, I suddenly snapped and tried to wrestle his phone from his grasp, and he stomped away. That night I found him in the Heartbreak Hotel, sitting next to a swimming pool (shaped like a giant guitar), looking sad. I realised as I sat with him that, as with so much anger, my rage towards him was really anger towards myself. His inability to focus was something I felt happening to me too. I was losing my ability to be present, and I hated it. “I know something’s wrong,” Adam said, holding his phone tightly in his hand. “But I have no idea how to fix it.” Then he went back to texting.</p><figure id="f8286d25-ef9d-44b0-b3ea-5a908860b483" data-spacefinder-role="inline" data-spacefinder-type="model.dotcomrendering.pageElements.ImageBlockElement"><div id="img-2"><picture><source srcset="https://i.guim.co.uk/img/media/56e6443b4e0e6055b0fc5482d5d11176e1debb42/0_0_6720_4480/master/6720.jpg?width=620&amp;dpr=2&amp;s=none" media="(min-width: 660px) and (-webkit-min-device-pixel-ratio: 1.25), (min-width: 660px) and (min-resolution: 120dpi)"><source srcset="https://i.guim.co.uk/img/media/56e6443b4e0e6055b0fc5482d5d11176e1debb42/0_0_6720_4480/master/6720.jpg?width=620&amp;dpr=1&amp;s=none" media="(min-width: 660px)"><source srcset="https://i.guim.co.uk/img/media/56e6443b4e0e6055b0fc5482d5d11176e1debb42/0_0_6720_4480/master/6720.jpg?width=605&amp;dpr=2&amp;s=none" media="(min-width: 480px) and (-webkit-min-device-pixel-ratio: 1.25), (min-width: 480px) and (min-resolution: 120dpi)"><source srcset="https://i.guim.co.uk/img/media/56e6443b4e0e6055b0fc5482d5d11176e1debb42/0_0_6720_4480/master/6720.jpg?width=605&amp;dpr=1&amp;s=none" media="(min-width: 480px)"><source srcset="https://i.guim.co.uk/img/media/56e6443b4e0e6055b0fc5482d5d11176e1debb42/0_0_6720_4480/master/6720.jpg?width=445&amp;dpr=2&amp;s=none" media="(min-width: 320px) and (-webkit-min-device-pixel-ratio: 1.25), (min-width: 320px) and (min-resolution: 120dpi)"><source srcset="https://i.guim.co.uk/img/media/56e6443b4e0e6055b0fc5482d5d11176e1debb42/0_0_6720_4480/master/6720.jpg?width=445&amp;dpr=1&amp;s=none" media="(min-width: 320px)"><img alt="Johann Hari at his home in London." src="https://i.guim.co.uk/img/media/56e6443b4e0e6055b0fc5482d5d11176e1debb42/0_0_6720_4480/master/6720.jpg?width=445&amp;dpr=1&amp;s=none" width="445" height="296.66666666666663" loading="lazy"></picture></div><figcaption><span><svg width="18" height="13" viewBox="0 0 18 13"><path d="M18 3.5v8l-1.5 1.5h-15l-1.5-1.5v-8l1.5-1.5h3.5l2-2h4l2 2h3.5l1.5 1.5zm-9 7.5c1.9 0 3.5-1.6 3.5-3.5s-1.6-3.5-3.5-3.5-3.5 1.6-3.5 3.5 1.6 3.5 3.5 3.5z"></path></svg></span><span>Johann Hari at his home in London.</span> Photograph: Antonio Olmos/The Observer</figcaption></figure><p>I realised then that I needed to understand what was really happening to him and to so many of us. That moment turned out to be the start of a journey that transformed how I think about attention. I travelled all over the world in the next three years, from Miami to Moscow to Melbourne, interviewing the leading experts in the world about focus. What I learned persuaded me that we are not now facing simply a normal anxiety about attention, of the kind every generation goes through as it ages. We are living in a serious attention crisis – one with huge implications for how we live. I learned there are twelve factors that have been proven to reduce people’s ability to pay attention and that many of these factors have been rising in the past few decades – sometimes dramatically.</p><p>I went to Portland, Oregon, to interview Prof Joel Nigg, who is one of the leading experts in the world on children’s attention problems, and he told me we need to ask if we are now developing “an attentional pathogenic culture” – an environment in which sustained and deep focus is harder for all of us. When I asked him what he would do if he was in charge of our culture and he actually wanted to destroy people’s attention, he said: “Probably what our society is doing.” Prof Barbara Demeneix, a leading French scientist who has studied some key factors that can disrupt attention – she is an expert on the effects of chemical pollution – told me bluntly: “There is no way we can have a normal brain today.” We can see the effects all around us. A small study of college students found they now only focus on any one task for 65 seconds. A different study of office workers found they only focus on average for three minutes. This isn’t happening because we all individually became weak-willed. Your focus didn’t collapse. It was stolen.</p><hr><p><span><span>W</span></span>hen I first got back from Graceland, I thought my attention was failing because I wasn’t strong enough as an individual and because I had been taken over by my phone. I went into a spiral of negative thoughts, reproaching myself. I’d say – you’re weak, you’re lazy, you’re not disciplined enough. I thought the solution was obvious: be more disciplined, and banish your phone. So I went online and booked myself a little room by the beach in Provincetown, at the tip of Cape Cod. I announced triumphantly to everyone – I am going to be there for three months, with no smartphone, and no computer that can get online. I’m done. I’m tired of being wired. I knew I could only do it because I was very lucky and had money from my previous books. I knew it couldn’t be a long-term solution. I did it because I thought that if I didn’t, I might lose some crucial aspects of my ability to think deeply. I also hoped that if I stripped everything back for a time, I might start to be able to glimpse the changes we could all make in a more sustainable way.</p><p>In my first webless week, I stumbled around in a haze of decompression. Provincetown is a little gay resort town with the highest proportion of same-sex couples in the US. I ate cupcakes, read books, talked with strangers and sang songs. Everything radically slowed down. Normally I follow the news every hour or so, getting a drip-feed of anxiety-provoking facts and trying to smush them together into some kind of sense. Instead, I simply read a physical newspaper once a day. Every few hours, I would feel an unfamiliar sensation gurgling inside me and I would ask myself: what is that? Ah, yes. Calm.</p><p>Later, I realised when I interviewed the experts and studied their research that there were many reasons why my attention was starting to heal from that first day. Prof Earl Miller, a neuroscientist at Massachusetts Institute of Technology, explained one to me. He said “your brain can only produce one or two thoughts” in your conscious mind at once. That’s it. “We’re very, very single-minded.” We have “very limited cognitive capacity”. But we have fallen for an enormous delusion. The average teenager now believes they can follow six forms of media at the same time. When neuroscientists studied this, they found that when people believe they are doing several things at once, they are actually juggling. “They’re switching back and forth. They don’t notice the switching because their brain sort of papers it over to give a seamless experience of consciousness, but what they’re actually doing is switching and reconfiguring their brain moment-to-moment, task-to-task – [and] that comes with a cost.” Imagine, say, you are doing your tax return, and you receive a text, and you look at it – it’s only a glance, taking three seconds – and then you go back to your tax return. In that moment, “your brain has to reconfigure, when it goes from one task to another”, he said. You have to remember what you were doing before, and you have to remember what you thought about it. When this happens, the evidence shows that “your performance drops. You’re slower. All as a result of the switching.”</p><p>This is called the “switch-cost effect”. It means that if you check your texts while trying to work, you aren’t only losing the little bursts of time you spend looking at the texts themselves – you are also losing the time it takes to refocus afterwards, which turns out to be a huge amount. For example, one study at the Carnegie Mellon University’s human computer interaction lab took 136 students and got them to sit a test. Some of them had to have their phones switched off, and others had their phones on and received intermittent text messages. The students who received messages performed, on average, 20% worse. It seems to me that almost all of us are currently losing that 20% of our brainpower, almost all the time. Miller told me that as a result we now live in “a perfect storm of cognitive degradation”.</p><p>For the first time in a very long time, in Provincetown I was doing one thing at a time, without being interrupted. I was living within the limits of what my brain could actually handle. I felt my attention growing and improving with every day that passed, but then, one day, I experienced an abrupt setback. I was walking down the beach and every few steps I saw the same thing that had been scratching at me since Memphis. People seemed to be using Provincetown simply as a backdrop for selfies, rarely looking up, at the ocean or each other. Only this time, the itch I felt wasn’t to yell: You’re wasting your lives, put the damn phone down. It was to yell: Give <em>me </em>that phone! <em>Mine! </em>For so long, I had received the thin, insistent signals of the web every few hours throughout the day, the trickle of likes and comments that say: I see you. You matter. Now they were gone. Simone de Beauvoir said that when she became an atheist, it felt like the world had fallen silent. Losing the web felt like that. After the rhetorical heat of social media, ordinary social interactions seemed pleasing but low volume. No normal social interaction floods you with hearts.</p><figure id="635f2691-8217-41c0-a752-a7cfbd80e21f" data-spacefinder-role="inline" data-spacefinder-type="model.dotcomrendering.pageElements.ImageBlockElement"><div id="img-3"><picture><source srcset="https://i.guim.co.uk/img/media/60ab661c6dd26e979e40e05619298040a51876ed/0_141_4222_2534/master/4222.jpg?width=620&amp;dpr=2&amp;s=none" media="(min-width: 660px) and (-webkit-min-device-pixel-ratio: 1.25), (min-width: 660px) and (min-resolution: 120dpi)"><source srcset="https://i.guim.co.uk/img/media/60ab661c6dd26e979e40e05619298040a51876ed/0_141_4222_2534/master/4222.jpg?width=620&amp;dpr=1&amp;s=none" media="(min-width: 660px)"><source srcset="https://i.guim.co.uk/img/media/60ab661c6dd26e979e40e05619298040a51876ed/0_141_4222_2534/master/4222.jpg?width=605&amp;dpr=2&amp;s=none" media="(min-width: 480px) and (-webkit-min-device-pixel-ratio: 1.25), (min-width: 480px) and (min-resolution: 120dpi)"><source srcset="https://i.guim.co.uk/img/media/60ab661c6dd26e979e40e05619298040a51876ed/0_141_4222_2534/master/4222.jpg?width=605&amp;dpr=1&amp;s=none" media="(min-width: 480px)"><source srcset="https://i.guim.co.uk/img/media/60ab661c6dd26e979e40e05619298040a51876ed/0_141_4222_2534/master/4222.jpg?width=445&amp;dpr=2&amp;s=none" media="(min-width: 320px) and (-webkit-min-device-pixel-ratio: 1.25), (min-width: 320px) and (min-resolution: 120dpi)"><source srcset="https://i.guim.co.uk/img/media/60ab661c6dd26e979e40e05619298040a51876ed/0_141_4222_2534/master/4222.jpg?width=445&amp;dpr=1&amp;s=none" media="(min-width: 320px)"><img alt="Provincetown: a place to switch off." src="https://i.guim.co.uk/img/media/60ab661c6dd26e979e40e05619298040a51876ed/0_141_4222_2534/master/4222.jpg?width=445&amp;dpr=1&amp;s=none" width="445" height="267.08432022738043" loading="lazy"></picture></div><figcaption><span><svg width="18" height="13" viewBox="0 0 18 13"><path d="M18 3.5v8l-1.5 1.5h-15l-1.5-1.5v-8l1.5-1.5h3.5l2-2h4l2 2h3.5l1.5 1.5zm-9 7.5c1.9 0 3.5-1.6 3.5-3.5s-1.6-3.5-3.5-3.5-3.5 1.6-3.5 3.5 1.6 3.5 3.5 3.5z"></path></svg></span><span>Provincetown: a place to switch off.</span> Photograph: Maddie Meyer/Getty Images</figcaption></figure><p>I realised that to heal my attention, it was not enough simply to strip out distractions. That makes you feel good at first – but then it creates a vacuum where all the noise was. I realised I had to fill the vacuum. To do that, I started to think a lot about an area of psychology I had learned about years before – the science of flow states. Almost everyone reading this will have experienced a flow state at some point. It’s when you are doing something meaningful to you, and you really get into it, and time falls away, and your ego seems to vanish, and you find yourself focusing deeply and effortlessly. Flow is the deepest form of attention human beings can offer. But how do we get there?</p><p>I later interviewed Prof Mihaly Csikszentmihalyi in Claremont, California, who was the first scientist to study flow states and researched them for more than 40 years. From his research, I learned there are three key factors which you need to get into flow. First you need to choose <em>one</em> goal. Flow takes all your mental energy, deployed deliberately in one direction. Second, that goal needs to be meaningful to you – you can’t flow into a goal that you don’t care about. Third, it helps if what you are doing is at the edge of your abilities – if, say, the rock you are climbing is slightly higher and harder than the last rock you climbed. So every morning, I started to write – a different kind of writing from my earlier work, one that stretched me. Within a few days, I started to flow, and hours of focus would pass without it feeling like a challenge. I felt I was focusing in the way I had when I was a teenager, in long effortless stretches. I had feared my brain was breaking. I cried with relief when I realised that in the right circumstances, its full power could come back.</p><p>At the end of every day, I would sit on the beach and watch the light slowly change. The light on the cape is unlike the light anywhere else I have ever been and in Provincetown, I could see more clearly than I ever had before in my life – my own thoughts, my own goals, my own dreams. I was living in the light. So when the time came to leave the beach house and come back to the hyperlinked world, I became convinced I had cracked the code of attention. I returned to the world determined to integrate the lessons I had learned in my everyday life. When I was reunited with my phone and laptop after taking a ferry back to where they were stashed in Boston, they seemed alien, and alienating. But within a few months, my screen time was back to four hours a day, and my attention was fraying and breaking again.</p><hr><p><span><span>I</span></span>n Moscow, the former Google engineer James Williams – who has become the most important philosopher of attention in the western world – told me I had made a crucial mistake. Individual abstinence is “not the solution, for the same reason that wearing a gas mask for two days a week outside isn’t the answer to pollution. It might, for a short period of time, keep certain effects at bay, but it’s not sustainable, and it doesn’t address the systemic issues.” He said that our attention is being deeply altered by huge invasive forces in wider society. Saying the solution was to just adjust your own habits – to pledge to break up with your phone, say – was just “pushing it back on to the individual” he said, when “it’s really the environmental changes that will really make the difference”.</p><p>Nigg said it might help me grasp what’s happening if we compare our rising attention problems to our rising obesity rates. Fifty years ago there was very little obesity, but today it is endemic in the western world. This is not because we suddenly became greedy or self-indulgent. He said: “Obesity is not a medical epidemic – it’s a social epidemic. We have bad food, for example, and so people are getting fat.” The way we live changed dramatically – our food supply changed, and we built cities that are hard to walk or cycle around, and those changes in our environment led to changes in our bodies. We gained mass, en masse. Something similar, he said, might be happening with the changes in our attention.</p><p>I learned that the factors harming our attention are not all immediately obvious. I had been focused on tech at first, but in fact the causes range very widely – from the food we eat to the air we breathe, from the hours we work to the hours we no longer sleep. They include many things we have come to take for granted – from how we deprive our children of play, to how our schools strip learning of meaning by basing everything on tests. I came to believe we need to respond to this incessant invasion of our attention at two levels. The first is individual. There are all sorts of changes we can make at a personal level that will protect our focus. I would say that by doing most of them, I have boosted my focus by about 20%. But we have to level with people. Those changes will only take you so far. At the moment it’s as though we are all having itching powder poured over us all day, and the people pouring the powder are saying: “You might want to learn to meditate. Then you wouldn’t scratch so much.” Meditation is a useful tool – but we actually need to stop the people who are pouring itching powder on us. We need to band together to take on the forces stealing our attention and take it back.</p><figure id="43c0ea5b-1633-4a0b-a24c-c03d20aba213" data-spacefinder-role="immersive" data-spacefinder-type="model.dotcomrendering.pageElements.ImageBlockElement"><div id="img-4"><picture><source srcset="https://i.guim.co.uk/img/media/01455678a4bb646a319e2dcfa238ddfd9dc19570/0_0_2480_1550/master/2480.jpg?width=1300&amp;dpr=2&amp;s=none" media="(min-width: 1300px) and (-webkit-min-device-pixel-ratio: 1.25), (min-width: 1300px) and (min-resolution: 120dpi)"><source srcset="https://i.guim.co.uk/img/media/01455678a4bb646a319e2dcfa238ddfd9dc19570/0_0_2480_1550/master/2480.jpg?width=1300&amp;dpr=1&amp;s=none" media="(min-width: 1300px)"><source srcset="https://i.guim.co.uk/img/media/01455678a4bb646a319e2dcfa238ddfd9dc19570/0_0_2480_1550/master/2480.jpg?width=1140&amp;dpr=2&amp;s=none" media="(min-width: 1140px) and (-webkit-min-device-pixel-ratio: 1.25), (min-width: 1140px) and (min-resolution: 120dpi)"><source srcset="https://i.guim.co.uk/img/media/01455678a4bb646a319e2dcfa238ddfd9dc19570/0_0_2480_1550/master/2480.jpg?width=1140&amp;dpr=1&amp;s=none" media="(min-width: 1140px)"><source srcset="https://i.guim.co.uk/img/media/01455678a4bb646a319e2dcfa238ddfd9dc19570/0_0_2480_1550/master/2480.jpg?width=1125&amp;dpr=2&amp;s=none" media="(min-width: 980px) and (-webkit-min-device-pixel-ratio: 1.25), (min-width: 980px) and (min-resolution: 120dpi)"><source srcset="https://i.guim.co.uk/img/media/01455678a4bb646a319e2dcfa238ddfd9dc19570/0_0_2480_1550/master/2480.jpg?width=1125&amp;dpr=1&amp;s=none" media="(min-width: 980px)"><source srcset="https://i.guim.co.uk/img/media/01455678a4bb646a319e2dcfa238ddfd9dc19570/0_0_2480_1550/master/2480.jpg?width=965&amp;dpr=2&amp;s=none" media="(min-width: 740px) and (-webkit-min-device-pixel-ratio: 1.25), (min-width: 740px) and (min-resolution: 120dpi)"><source srcset="https://i.guim.co.uk/img/media/01455678a4bb646a319e2dcfa238ddfd9dc19570/0_0_2480_1550/master/2480.jpg?width=965&amp;dpr=1&amp;s=none" media="(min-width: 740px)"><source srcset="https://i.guim.co.uk/img/media/01455678a4bb646a319e2dcfa238ddfd9dc19570/0_0_2480_1550/master/2480.jpg?width=725&amp;dpr=2&amp;s=none" media="(min-width: 660px) and (-webkit-min-device-pixel-ratio: 1.25), (min-width: 660px) and (min-resolution: 120dpi)"><source srcset="https://i.guim.co.uk/img/media/01455678a4bb646a319e2dcfa238ddfd9dc19570/0_0_2480_1550/master/2480.jpg?width=725&amp;dpr=1&amp;s=none" media="(min-width: 660px)"><source srcset="https://i.guim.co.uk/img/media/01455678a4bb646a319e2dcfa238ddfd9dc19570/0_0_2480_1550/master/2480.jpg?width=645&amp;dpr=2&amp;s=none" media="(min-width: 480px) and (-webkit-min-device-pixel-ratio: 1.25), (min-width: 480px) and (min-resolution: 120dpi)"><source srcset="https://i.guim.co.uk/img/media/01455678a4bb646a319e2dcfa238ddfd9dc19570/0_0_2480_1550/master/2480.jpg?width=645&amp;dpr=1&amp;s=none" media="(min-width: 480px)"><source srcset="https://i.guim.co.uk/img/media/01455678a4bb646a319e2dcfa238ddfd9dc19570/0_0_2480_1550/master/2480.jpg?width=465&amp;dpr=2&amp;s=none" media="(min-width: 320px) and (-webkit-min-device-pixel-ratio: 1.25), (min-width: 320px) and (min-resolution: 120dpi)"><source srcset="https://i.guim.co.uk/img/media/01455678a4bb646a319e2dcfa238ddfd9dc19570/0_0_2480_1550/master/2480.jpg?width=465&amp;dpr=1&amp;s=none" media="(min-width: 320px)"><img alt="Illusration of a man with a magnet for a head pulling social media logos towards him" src="https://i.guim.co.uk/img/media/01455678a4bb646a319e2dcfa238ddfd9dc19570/0_0_2480_1550/master/2480.jpg?width=465&amp;dpr=1&amp;s=none" width="465" height="290.625" loading="lazy"></picture></div><figcaption><span><svg width="18" height="13" viewBox="0 0 18 13"><path d="M18 3.5v8l-1.5 1.5h-15l-1.5-1.5v-8l1.5-1.5h3.5l2-2h4l2 2h3.5l1.5 1.5zm-9 7.5c1.9 0 3.5-1.6 3.5-3.5s-1.6-3.5-3.5-3.5-3.5 1.6-3.5 3.5 1.6 3.5 3.5 3.5z"></path></svg></span><span>Illustration by Eric Chow.</span></figcaption></figure><p>This can sound a bit abstract – but I met people who were putting it into practice in many places. To give one example: there is strong scientific evidence that stress and exhaustion ruin your attention. Today, about 35% of workers feel they can never switch off their phones because their boss might email them at any time of day or night. In France, ordinary workers decided this was intolerable and pressured their government for change – so now, they have a legal <a href="https://www.theguardian.com/money/2016/dec/31/french-workers-win-legal-right-to-avoid-checking-work-email-out-of-hours" data-link-name="in body link">“right to disconnect”</a>. It’s simple. You have a right to defined work hours, and you have a right to not be contacted by your employer outside those hours. Companies that break the rules get huge fines. There are lots of potential collective changes like this that can restore part of our focus. We could, for example, force social media companies to abandon their current business model, which is specifically designed to invade our attention in order to keep us scrolling. There are alternative ways these sites could work – ones that would heal our attention instead of hacking it.</p><p>Some scientists say these worries about attention are a moral panic, comparable to the anxieties in the past about comic books or rap music, and that the evidence is shaky. Other scientists say the evidence is strong and these anxieties are like the early warnings about the obesity epidemic or the climate crisis in the 1970s. I think that given this uncertainty, we can’t wait for perfect evidence. We have to act based on a reasonable assessment of risk. If the people warning about the effects on our attention turn out to be wrong, and we still do what they suggest, what will be the cost? We will spend less time being harassed by our bosses, and we’ll be tracked and manipulated less by technology – along with lots of other improvements in our lives that are desirable in any case. But if they turn out to be right, and we don’t do what they say, what’s the cost? We will have – as the former Google engineer Tristan Harris told me – downgraded humanity, stripping us of our attention at the very time when we face big collective crises that require it more than ever.</p><p>But none of these changes will happen unless we fight for them. Just as the feminist movement reclaimed women’s right to their own bodies (and still has to fight for it today), I believe we now need an attention movement to reclaim our minds. I believe we need to act urgently, because this may be like the climate crisis, or the obesity crisis – the longer we wait, the harder it will get. The more our attention degrades, the harder it will be to summon the personal and political energy to take on the forces stealing our focus. The first step it requires is a shift in our consciousness. We need to stop blaming ourselves, or making only demands for tiny tweaks from our employers and from tech companies. We own our own minds – and together, we can take them back from the forces that are stealing them.</p><p><span data-dcr-style="bullet"></span> The above is an edited extract from <em>Stolen Focus: Why You Can’t Pay Attention</em> by Johann Hari, published by Bloomsbury on 6 January. To support the <em>Guardian</em> and <em>Observer</em> order your copy at <a href="http://guardianbookshop.com/" data-link-name="in body link">guardianbookshop.com</a>. Delivery charges may apply</p><p><span data-dcr-style="bullet"></span> This article was amended on 7 March 2022 to include reference to Prof Barbara Demeneix’s area of scientific study.</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Gojekyll: A fast, partially compatible Go clone of Jekyll (121 pts)]]></title>
            <link>https://github.com/osteele/gojekyll</link>
            <guid>37276424</guid>
            <pubDate>Sat, 26 Aug 2023 20:11:42 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://github.com/osteele/gojekyll">https://github.com/osteele/gojekyll</a>, See on <a href="https://news.ycombinator.com/item?id=37276424">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><h2 tabindex="-1" dir="auto">Gojekyll</h2>

<p dir="auto"><a href="#contributors-"><img src="https://camo.githubusercontent.com/fffc4276a1ca141037578a00b4ce0bc82dd78a00b541735ba7da21b7508ef0df/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f616c6c5f636f6e7472696275746f72732d352d6f72616e67652e7376673f7374796c653d666c61742d737175617265" alt="All Contributors" data-canonical-src="https://img.shields.io/badge/all_contributors-5-orange.svg?style=flat-square"></a></p>

<p dir="auto"><a href="https://github.com/osteele/gojekyll/actions?query=workflow%3A%22Build+Status%22"><img src="https://github.com/osteele/gojekyll/actions/workflows/go.yml/badge.svg" alt="go badge"></a>
<a href="https://github.com/osteele/gojekyll/actions?query=workflow%3Agolangci-lint"><img src="https://github.com/osteele/gojekyll/actions/workflows/golangci-lint.yml/badge.svg" alt="Golangci-lint badge"></a>
<a href="https://coveralls.io/r/osteele/gojekyll" rel="nofollow"><img src="https://camo.githubusercontent.com/4021f2aeae0f7f3b4e27dc15b3ca3e288291f1e08df52b0138ffdd0505217989/68747470733a2f2f696d672e736869656c64732e696f2f636f766572616c6c732f6f737465656c652f676f6a656b796c6c2e7376673f6272616e63683d6d6173746572" alt="Coveralls badge" data-canonical-src="https://img.shields.io/coveralls/osteele/gojekyll.svg?branch=master"></a>
<a href="https://goreportcard.com/report/github.com/osteele/gojekyll" rel="nofollow"><img src="https://camo.githubusercontent.com/c137ca810589d58634d9b3b9f42b8a67b674d1a303bcc9552b00414f4bbede65/68747470733a2f2f676f7265706f7274636172642e636f6d2f62616467652f6769746875622e636f6d2f6f737465656c652f676f6a656b796c6c" alt="Go Report Card badge" data-canonical-src="https://goreportcard.com/badge/github.com/osteele/gojekyll"></a>
<a href="https://github.com/osteele/gojekyll/blob/master/LICENSE"><img src="https://camo.githubusercontent.com/83d3746e5881c1867665223424263d8e604df233d0a11aae0813e0414d433943/68747470733a2f2f696d672e736869656c64732e696f2f62616467652f6c6963656e73652d4d49542d626c75652e737667" alt="MIT License" data-canonical-src="https://img.shields.io/badge/license-MIT-blue.svg"></a></p>
<p dir="auto">This project was created by Oliver Steele (<a href="https://github.com/osteele">@osteele</a>), and is currently maintained by Daniil Gentili (<a href="https://github.com/danog">@danog</a>).</p>
<p dir="auto">Gojekyll is a partially-compatible clone of the <a href="https://jekyllrb.com/" rel="nofollow">Jekyll</a>
static site generator, written in the <a href="https://golang.org/" rel="nofollow">Go</a> programming
language. It provides <code>build</code> and <code>serve</code> commands, with directory watch and
live reload.</p>
<table>
<thead>
<tr>
<th>&nbsp;</th>
<th>Gojekyll</th>
<th>Jekyll</th>
<th>Hugo</th>
</tr>
</thead>
<tbody>
<tr>
<td>Stable</td>
<td></td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td>Fast</td>
<td>✓<br>(<a href="https://github.com/osteele/gojekyll/blob/main/docs/benchmarks.md">~20×Jekyll</a>)</td>
<td></td>
<td>✓</td>
</tr>
<tr>
<td>Template language</td>
<td>Liquid</td>
<td>Liquid</td>
<td>Go, Ace and Amber templates</td>
</tr>
<tr>
<td>SASS</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td>Jekyll compatibility</td>
<td><a href="#current-limitations">partial</a></td>
<td>✓</td>
<td></td>
</tr>
<tr>
<td>Plugins</td>
<td><a href="https://github.com/osteele/gojekyll/blob/main/docs/plugins.md">some</a></td>
<td>yes</td>
<td>shortcodes, theme components</td>
</tr>
<tr>
<td>Windows support</td>
<td>✓</td>
<td>✓</td>
<td>✓</td>
</tr>
<tr>
<td>Implementation language</td>
<td>Go</td>
<td>Ruby</td>
<td>Go</td>
</tr>
</tbody>
</table>

<ul dir="auto">
<li><a href="#usage">Usage</a></li>
<li><a href="#installation">Installation</a>
<ul dir="auto">
<li><a href="#docker">Docker</a></li>
<li><a href="#binary-downloads">Binary Downloads</a></li>
<li><a href="#from-source">From Source</a></li>
</ul>
</li>
<li><a href="#optional-install-command-line-autocompletion">[Optional] Install command-line autocompletion</a></li>
<li><a href="#status">Status</a>
<ul dir="auto">
<li><a href="#current-limitations">Current Limitations</a></li>
<li><a href="#other-differences">Other Differences</a></li>
<li><a href="#feature-checklist">Feature Checklist</a></li>
</ul>
</li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
<li><a href="#contributors">Contributors</a></li>
<li><a href="#attribution">Attribution</a></li>
<li><a href="#related">Related</a></li>
<li><a href="#license">License</a></li>
</ul>

<h2 tabindex="-1" dir="auto">Usage</h2>
<div dir="auto" data-snippet-clipboard-copy-content="gojekyll build       # builds the site in the current directory into _site
gojekyll serve       # serve the app at http://localhost:4000; reload on changes
gojekyll help
gojekyll help build"><pre>gojekyll build       <span><span>#</span> builds the site in the current directory into _site</span>
gojekyll serve       <span><span>#</span> serve the app at http://localhost:4000; reload on changes</span>
gojekyll <span>help</span>
gojekyll <span>help</span> build</pre></div>
<h2 tabindex="-1" dir="auto">Installation</h2>
<h3 tabindex="-1" dir="auto">Docker</h3>
<p dir="auto">You can use <code>gojekyll</code> with the official <code>danog/gojekyll</code> image, for example to build the site in the current directory into <code>_site</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="docker run --user $UID:$GID -v $PWD:/app --pull always --rm -it danog/gojekyll build -s /app"><pre>docker run --user <span>$UID</span>:<span>$GID</span> -v <span>$PWD</span>:/app --pull always --rm -it danog/gojekyll build -s /app</pre></div>
<p dir="auto">Another example, serve the website in the current directory on <code>http://localhost:4040</code>, automatically reloading on changes:</p>
<div dir="auto" data-snippet-clipboard-copy-content="docker run --user $UID:$GID -v $PWD:/app --pull always --network host --rm -it danog/gojekyll serve -s /app"><pre>docker run --user <span>$UID</span>:<span>$GID</span> -v <span>$PWD</span>:/app --pull always --network host --rm -it danog/gojekyll serve -s /app</pre></div>
<h3 tabindex="-1" dir="auto">Binary Downloads</h3>
<ol dir="auto">
<li>Linux, Mac OS and Windows binaries for x86, amd64, armv6/v7, armv8, riscv64 are available from the <a href="https://github.com/osteele/gojekyll/releases">releases
page</a>.</li>
<li>Download the latest version of <a href="https://github.com/sass/dart-sass/releases">dart-sass</a> and <a href="https://katiek2.github.io/path-doc/" rel="nofollow">add it to your PATH</a>, or see the <a href="https://katiek2.github.io/path-doc/" rel="nofollow">Sass website</a> for full installation instructions.</li>
<li>[Optional] <strong>Themes</strong>. To use a theme, you need to install Ruby and
<a href="http://bundler.io/" rel="nofollow">bundler</a>. Create a <code>Gemfile</code> that lists the theme., and
run <code>bundle install</code>. The <a href="https://jekyllrb.com/docs/themes/" rel="nofollow">Jekyll theme
instructions</a> provide more detail, and
should work for Gojekyll too.</li>
</ol>
<h3 tabindex="-1" dir="auto">From Source</h3>
<p dir="auto">Pre-requisites:</p>
<ol dir="auto">
<li><strong>Install go</strong> (1) via <a href="https://brew.sh/" rel="nofollow">Homebrew</a>: <code>brew install go</code>; or (2)
<a href="https://golang.org/doc/install#tarball" rel="nofollow">download</a>.</li>
<li>See items (2-3) under <a href="#binary-downloads">Binary Downloads</a>, above.</li>
</ol>
<p dir="auto">Then run:</p>
<div dir="auto" data-snippet-clipboard-copy-content="go install github.com/osteele/gojekyll@latest"><pre>go install github.com/osteele/gojekyll@latest</pre></div>
<h2 tabindex="-1" dir="auto">[Optional] Install command-line autocompletion</h2>
<p dir="auto">Add this to your <code>.bashrc</code> or <code>.zshrc</code>:</p>
<div dir="auto" data-snippet-clipboard-copy-content="# Bash:
eval &quot;$(gojekyll --completion-script-bash)&quot;
# Zsh:
eval &quot;$(gojekyll --completion-script-zsh)&quot;"><pre><span><span>#</span> Bash:</span>
<span>eval</span> <span><span>"</span><span><span>$(</span>gojekyll --completion-script-bash<span>)</span></span><span>"</span></span>
<span><span>#</span> Zsh:</span>
<span>eval</span> <span><span>"</span><span><span>$(</span>gojekyll --completion-script-zsh<span>)</span></span><span>"</span></span></pre></div>
<h2 tabindex="-1" dir="auto">Status</h2>
<p dir="auto">This project works on the GitHub Pages sites that I and other contributors care
about. It looks credible on a spot-check of other Jekyll sites.</p>
<h3 tabindex="-1" dir="auto">Current Limitations</h3>
<p dir="auto">Missing features:</p>
<ul dir="auto">
<li>Pagination</li>
<li>Math</li>
<li>Plugin system. (<a href="https://github.com/osteele/gojekyll/blob/main/docs/plugins.md">Some individual plugins</a> are emulated.)</li>
<li>Liquid filter <code>sassify</code> is not implemented</li>
<li>Liquid is run in strict mode: undefined filters and variables are errors.</li>
<li>Missing markdown features:
<ul dir="auto">
<li><a href="https://kramdown.gettalong.org/syntax.html#attribute-list-definitions" rel="nofollow">attribute lists</a></li>
<li><a href="https://kramdown.gettalong.org/syntax.html#html-blocks" rel="nofollow"><code>markdown="span"</code>, <code>markdown="block"</code></a></li>
<li>Markdown configuration options</li>
</ul>
</li>
</ul>
<p dir="auto">Also see the <a href="#feature-status">detailed status</a> below.</p>
<h3 tabindex="-1" dir="auto">Other Differences</h3>
<p dir="auto">These will probably not change:</p>
<p dir="auto">By design:</p>
<ul dir="auto">
<li>Plugins must be listed in the config file, not a Gemfile.</li>
<li>The wrong type in a <code>_config.yml</code> file – for example, a list where a string is
expected, or vice versa – is generally an error.</li>
<li>Server live reload is always on.</li>
<li><code>serve --watch</code> (the default) reloads the <code>_config.yml</code> and data files too.</li>
<li><code>serve</code> generates pages on the fly; it doesn't write to the file system.</li>
<li>Files are cached in <code>/tmp/gojekyll-${USER}</code>, not <code>./.sass-cache</code></li>
</ul>
<p dir="auto">Upstream:</p>
<ul dir="auto">
<li>Markdown:
<ul dir="auto">
<li><code>&lt;</code> and <code>&gt;</code> inside markdown is interpreted as HTML. For example, <code>This is &lt;b&gt;bold&lt;/b&gt;</code> renders as <b>bold</b>. This behavior matches the <a href="https://daringfireball.net/projects/markdown/syntax#html" rel="nofollow">Markdown
spec</a>, but differs
from Jekyll's default Kramdown processor.</li>
<li>The autogenerated id of a header that includes HTML is computed from the
text of the title, ignoring its attributes. For example, the id of <code>## Title (&lt;a href="https://example.com/path/to/details"&gt;ref&lt;/a&gt;))</code> is <code>#title-ref</code>,
not <code>#title-https-example-path-to-details-ref</code>.</li>
<li>Autogenerated header ids replace punctuation by the hyphens, rather than the
empty string. For example, the id of <code>## Either/or</code> is <code>#either-or</code> not
<code>#eitheror</code>; the id of <code>## I'm Lucky</code> is <code>#i-m-lucky</code> not <code>#im-lucky</code>.</li>
</ul>
</li>
</ul>
<p dir="auto">Muzukashii:</p>
<ul dir="auto">
<li>An extensible plugin mechanism – support for plugins that aren't compiled into
the executable.</li>
</ul>
<h3 tabindex="-1" dir="auto">Feature Checklist</h3>
<ul>
<li> Content
<ul>
<li> Front Matter</li>
<li> Posts</li>
<li> Static Files</li>
<li> Variables</li>
<li> Collections</li>
<li> Data Files</li>
<li> Assets
<ul>
<li> Coffeescript</li>
<li> Sass/SCSS</li>
</ul>
</li>
</ul>
</li>
<li> Customization
<ul>
<li> Templates
<ul>
<li> Jekyll filters
<ul>
<li> <code>scssify</code></li>
<li> everything else</li>
</ul>
</li>
<li> Jekyll tags</li>
</ul>
</li>
<li> Includes</li>
<li> Permalinks</li>
<li> Pagination</li>
<li> Plugins – partial; see <a href="https://github.com/osteele/gojekyll/blob/main/docs/plugins.md">here</a></li>
<li> Themes</li>
<li> Layouts</li>
</ul>
</li>
<li> Server
<ul>
<li> Directory watch</li>
</ul>
</li>
<li> Commands
<ul>
<li> <code>build</code>
<ul>
<li> <code>--source</code>, <code>--destination</code>, <code>--drafts</code>, <code>--future</code>, <code>--unpublished</code></li>
<li> <code>--incremental</code>, <code>--watch</code>, <code>--force_polling</code>, <code>JEKYLL_ENV=production</code></li>
<li> <code>--baseurl</code>, <code>--config</code>, <code>--lsi</code></li>
<li> <code>--limit-posts</code></li>
</ul>
</li>
<li> <code>clean</code></li>
<li> <code>help</code></li>
<li> <code>serve</code>
<ul>
<li> <code>--open-uri</code>, <code>--host</code>, <code>--port</code></li>
<li> <code>--incremental</code>, <code>–watch</code>, <code>--force_polling</code></li>
<li> <code>--baseurl</code>, <code>--config</code></li>
<li> <code>--detach</code>, <code>--ssl</code>-* – not planned</li>
</ul>
</li>
<li> <code>doctor</code>, <code>import</code>, <code>new</code>, <code>new-theme</code> – not planned</li>
</ul>
</li>
<li> Windows</li>
</ul>
<h2 tabindex="-1" dir="auto">Troubleshooting</h2>
<p dir="auto">If the error is "403 API rate limit exceeded", you are probably building a
repository that uses the <code>jekyll-github-metadata</code> gem. Try setting the
<code>JEKYLL_GITHUB_TOKEN</code>, <code>JEKYLL_GITHUB_TOKEN</code>, or <code>OCTOKIT_ACCESS_TOKEN</code>
environment variable to the value of a <a href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token">GitHub personal access
token</a> and trying again.</p>
<h2 tabindex="-1" dir="auto">Contributors</h2>
<p dir="auto">Thanks goes to these wonderful people (<a href="https://allcontributors.org/docs/en/emoji-key" rel="nofollow">emoji key</a>):</p>



<table>
  <tbody><tr>
    <td><a href="https://code.osteele.com/" rel="nofollow"><img src="https://avatars.githubusercontent.com/u/674?v=4?s=100" width="100px;" alt=""><br><sub><b>Oliver Steele</b></sub></a><br><a href="https://github.com/osteele/gojekyll/commits?author=osteele" title="Code">💻</a> <a href="#design-osteele" title="Design">🎨</a> <a href="https://github.com/osteele/gojekyll/commits?author=osteele" title="Documentation">📖</a> <a href="#ideas-osteele" title="Ideas, Planning, &amp; Feedback">🤔</a> <a href="#infra-osteele" title="Infrastructure (Hosting, Build-Tools, etc)">🚇</a> <a href="#maintenance-osteele" title="Maintenance">🚧</a> <a href="#projectManagement-osteele" title="Project Management">📆</a> <a href="https://github.com/osteele/gojekyll/pulls?q=is%3Apr+reviewed-by%3Aosteele" title="Reviewed Pull Requests">👀</a> <a href="https://github.com/osteele/gojekyll/commits?author=osteele" title="Tests"><g-emoji alias="warning">⚠️</g-emoji></a></td>
    <td><a href="https://bep.is/" rel="nofollow"><img src="https://avatars.githubusercontent.com/u/394382?v=4?s=100" width="100px;" alt=""><br><sub><b>Bjørn Erik Pedersen</b></sub></a><br><a href="https://github.com/osteele/gojekyll/commits?author=bep" title="Documentation">📖</a></td>
    <td><a href="https://tqdev.com/" rel="nofollow"><img src="https://avatars.githubusercontent.com/u/1288217?v=4?s=100" width="100px;" alt=""><br><sub><b>Maurits van der Schee</b></sub></a><br><a href="https://github.com/osteele/gojekyll/commits?author=mevdschee" title="Code">💻</a></td>
    <td><a href="https://daniil.it/" rel="nofollow"><img src="https://avatars.githubusercontent.com/u/7339644?v=4?s=100" width="100px;" alt=""><br><sub><b>Daniil Gentili</b></sub></a><br><a href="https://github.com/osteele/gojekyll/commits?author=danog" title="Code">💻</a></td>
    <td><a href="http://cameronelliott.com/" rel="nofollow"><img src="https://avatars.githubusercontent.com/u/868689?v=4?s=100" width="100px;" alt=""><br><sub><b>Cameron Elliott</b></sub></a><br><a href="#ideas-cameronelliott" title="Ideas, Planning, &amp; Feedback">🤔</a></td>
  </tr>
</tbody></table>



<p dir="auto">This project follows the
<a href="https://github.com/all-contributors/all-contributors">all-contributors</a>
specification. <a href="https://github.com/osteele/gojekyll/blob/main/CONTRIBUTING.md">Contributions of any kind welcome</a>!</p>
<h2 tabindex="-1" dir="auto">Attribution</h2>
<p dir="auto">Gojekyll uses these libraries:</p>
<table>
<thead>
<tr>
<th>Package</th>
<th>Author(s)</th>
<th>Usage</th>
<th>License</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/jaschaephraim/lrserver">github.com/jaschaephraim/lrserver</a></td>
<td>Jascha Ephraim</td>
<td>Live Reload</td>
<td>MIT License</td>
</tr>
<tr>
<td><a href="https://github.com/kyokomi/emoji">github.com/kyokomi/emoji</a></td>
<td>kyokomi</td>
<td><code>jemoji</code> plugin emulation</td>
<td>MIT License</td>
</tr>
<tr>
<td><a href="https://github.com/osteele/liquid">github.com/osteele/liquid</a></td>
<td>yours truly</td>
<td>Liquid processor</td>
<td>MIT License</td>
</tr>
<tr>
<td><a href="https://github.com/pkg/browser">github.com/pkg/browser</a></td>
<td><a href="https://github.com/pkg">pkg</a></td>
<td><code>serve --open-url</code> option</td>
<td>BSD 2-clause "Simplified" License</td>
</tr>
<tr>
<td><a href="https://github.com/radovskyb/watcher">github.com/radovskyb/watcher</a></td>
<td>Benjamin Radovsky</td>
<td>Polling file watch (<code>--force_polling</code>)</td>
<td>BSD 3-clause "New" or "Revised" License</td>
</tr>
<tr>
<td><a href="https://github.com/danog/blackfriday">github.com/danog/blackfriday</a></td>
<td>Russ Ross, Daniil Gentili</td>
<td>Markdown processing</td>
<td>Simplified BSD License</td>
</tr>
<tr>
<td><a href="https://github.com/sass/dart-sass">github.com/sass/dart-sass</a></td>
<td>Listed <a href="https://github.com/sass/dart-sass">here</a></td>
<td>The reference implementation of Sass, written in Dart.</td>
<td>MIT License</td>
</tr>
<tr>
<td><a href="https://github.com/tdewolff/minify">github.com/tdewolff/minify</a></td>
<td>Taco de Wolff</td>
<td>CSS minimization</td>
<td>MIT License</td>
</tr>
<tr>
<td><a href="https://github.com/bep/godartsass">github.com/bep/godartsass</a></td>
<td>Drew Wells</td>
<td>Go API backed by the native Dart Sass Embedded executable.</td>
<td>MIT License</td>
</tr>
<tr>
<td><a href="https://github.com/alecthomas/kingpin">github.com/alecthomas/kingpin/v2</a></td>
<td>Alec Thomas</td>
<td>command-line arguments</td>
<td>MIT License</td>
</tr>
<tr>
<td><a href="https://github.com/alecthomas/chroma">github.com/alecthomas/chroma</a></td>
<td>Alec Thomas</td>
<td>Syntax highlighter</td>
<td>MIT License</td>
</tr>
<tr>
<td><a href="https://github.com/go-yaml/yaml">gopkg.in/yaml.v2</a></td>
<td>Canonical</td>
<td>YAML support</td>
<td>Apache License 2.0</td>
</tr>
</tbody>
</table>
<p dir="auto">In addition, the following pieces of text were taken from Jekyll and its plugins.
They are used under the terms of the MIT License.</p>
<table>
<thead>
<tr>
<th>Source</th>
<th>Use</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://jekyllrb.com/docs/templates/" rel="nofollow">Jekyll template documentation</a></td>
<td>test cases</td>
<td>filter examples</td>
</tr>
<tr>
<td><code>jekyll help</code> command</td>
<td><code>gojekyll help</code> text</td>
<td>help text</td>
</tr>
<tr>
<td><a href="https://github.com/jekyll/jekyll-feed"><code>jekyll-feed</code> plugin</a></td>
<td>plugin emulation</td>
<td><code>feed.xml</code> template</td>
</tr>
<tr>
<td><a href="https://github.com/jekyll/jekyll-redirect-from"><code>jekyll-redirect-from</code> plugin</a></td>
<td>plugin emulation</td>
<td>redirect page template</td>
</tr>
<tr>
<td><a href="https://github.com/jekyll/jekyll-redirect-from"><code>jekyll-sitemap</code> plugin</a></td>
<td>plugin emulation</td>
<td>sitemap template</td>
</tr>
<tr>
<td><a href="https://github.com/jekyll/jekyll-redirect-from"><code>jekyll-seo-tag</code> plugin</a></td>
<td>plugin emulation</td>
<td>feed template</td>
</tr>
</tbody>
</table>
<p dir="auto">The theme for in-browser error reporting was adapted from facebookincubator/create-react-app.</p>
<p dir="auto">The gopher image in the <code>testdata</code> directory is from <a href="https://commons.wikimedia.org/wiki/File:Gophercolor.jpg" rel="nofollow">Wikimedia
Commons</a>. It is used
under the <a href="https://creativecommons.org/licenses/by-sa/3.0/deed.en" rel="nofollow">Creative Commons Attribution-Share Alike 3.0 Unported
license</a>.</p>
<p dir="auto">In addition to being totally and obviously inspired by Jekyll and its plugins,
Jekyll's solid <em>documentation</em> was indispensible --- especially since I wanted
to implement Jekyll as documented, not port its source code. The <a href="https://jekyllrb.com/docs/home/" rel="nofollow">Jekyll
docs</a> were always open in at least one tab
during development.</p>
<h2 tabindex="-1" dir="auto">Related</h2>
<p dir="auto"><a href="https://gohugo.io/" rel="nofollow">Hugo</a> is the pre-eminent Go static site generator. It isn't
Jekyll-compatible (-), but it's highly polished, performant, and productized
(+++).</p>
<p dir="auto"><a href="https://github.com/osteele/liquid">Liquid</a> is a pure Go implementation of
Liquid templates. I created it in order to use in this project.</p>
<p dir="auto"><a href="https://jekyllrb.com/" rel="nofollow">Jekyll</a>, of course.</p>
<h2 tabindex="-1" dir="auto">License</h2>
<p dir="auto">MIT</p>
</article>
          </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[90% of “eco-friendly” paper straws contain traces of toxic forever chemicals (255 pts)]]></title>
            <link>https://scienceswitch.com/2023/08/27/90-of-eco-friendly-paper-straws-contain-traces-of-toxic-forever-chemicals/</link>
            <guid>37275856</guid>
            <pubDate>Sat, 26 Aug 2023 19:03:33 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://scienceswitch.com/2023/08/27/90-of-eco-friendly-paper-straws-contain-traces-of-toxic-forever-chemicals/">https://scienceswitch.com/2023/08/27/90-of-eco-friendly-paper-straws-contain-traces-of-toxic-forever-chemicals/</a>, See on <a href="https://news.ycombinator.com/item?id=37275856">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>

							<p>The growing movement against single-use plastics has led many bars and restaurants to swap plastic straws for paper ones. On the surface, this seems like an easy win – we get to sip our drinks through an eco-friendly alternative while keeping tons of plastic out of landfills and oceans. But the truth about paper straws is more complicated.</p>
<p>A <a href="https://www.scimex.org/newsfeed/paper-straws-contain-forever-chemicals-which-mean-they-might-not-be-better-than-plastic-ones">study conducted</a> at the University of Antwerp found that a shocking 90% of so-called eco-friendly paper straws actually contain traces of “forever chemicals.” Forever chemicals, more formally known as <a href="https://chemtrust.org/pfas/">per-and polyfluoroalkyl substances</a>&nbsp;(PFAS), are compounds that don’t break down once released into the environment or our bodies. They stick around virtually forever, which is how they got their ominous nickname.</p>
<p>PFAS have been linked to concerning health effects including high cholesterol, reduced immune response, thyroid disease, and increased risk of certain cancers. So why are they turning up in paper straws? The researchers tested 39 different brands of straws made from various materials like paper, bamboo, glass, stainless steel, and plastic. PFAS were detected in the majority – 69% overall.</p>
<p>But paper straws were by far the worst offenders, with PFAS identified in a whopping 90% of brands tested. The concentrations varied quite a bit, but the frequent presence of the chemicals suggests they were likely intentionally added in some cases. PFAS are sometimes used as a <a href="https://www.theguardian.com/environment/2022/jan/26/water-resistant-products-toxic-pfas-study">water-resistant coating</a> – not something you want leaching into your daily iced tea.</p>
<p>Among the PFAS found in paper straws was <a href="https://pubchem.ncbi.nlm.nih.gov/compound/Perfluorooctanoic-acid">perfluorooctanoic acid</a> (PFOA), which has actually been <a href="https://chemicalwatch.com/189390/global-ban-on-pfoa-enters-into-force-for-most-countries">globally banned since 2020</a> due to health risks including cancer and organ damage. Also frequently detected were other concerning PFAS chemicals <a href="https://en.wikipedia.org/wiki/Trifluoroacetic_acid">trifluoroacetic acid</a>&nbsp;(TFA) and <a href="https://en.wikipedia.org/wiki/Triflic_acid">trifluoromethanesulfonic acid</a> (TFMS). While bamboo straws fared slightly better than paper ones, <a href="https://www.sciencedirect.com/science/article/abs/pii/S0045653521007074?via%3Dihub">PFAS was still found in 80%</a> of the bamboo brands tested. Plastic and glass straws also occasionally contained PFAS, though less commonly than plant-based options.</p>
<p>The one material that seems safest is stainless steel – the researchers did not detect any PFAS compounds in the steel straws analyzed. While the PFAS levels measured in this study were fairly low, these chemicals have the ominous ability to accumulate in the human body and the environment over time. The findings raise the question – if paper straws leach PFAS into our drinks over months and years of use, could they be harming our health?</p>
<p>Unfortunately the current research didn’t examine whether the chemicals transfer into liquids. But previous studies have shown PFAS can migrate from food packaging materials into actual food and drinks. More research is critically needed to determine if PFAS leach out of paper straws during typical use.</p>
<p>In the meantime, it’s clear we need to rethink the assumption that paper and other plant-based products are inherently better for health and sustainability compared to plastic. The revelation about paper straws casts doubt on the idea that swapping plastic for paper is a foolproof eco-friendly solution. After all, PFAS spreading from straws into waterways and landfills still contribute to environmental contamination – regardless of that paper label.</p>
<p>The study was published in the journal&nbsp;<i><a href="https://www.tandfonline.com/doi/full/10.1080/19440049.2023.2240908" rel="noopener">Food Additives and Contaminants</a></i>.</p>
			
			
			
							
						</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Historic algorithms help unlock shortest-path problem breakthrough (141 pts)]]></title>
            <link>https://cacm.acm.org/news/275684-historic-algorithms-help-unlock-shortest-path-problem-breakthrough/fulltext</link>
            <guid>37275676</guid>
            <pubDate>Sat, 26 Aug 2023 18:44:05 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://cacm.acm.org/news/275684-historic-algorithms-help-unlock-shortest-path-problem-breakthrough/fulltext">https://cacm.acm.org/news/275684-historic-algorithms-help-unlock-shortest-path-problem-breakthrough/fulltext</a>, See on <a href="https://news.ycombinator.com/item?id=37275676">Hacker News</a></p>
<div id="readability-page-1" class="page"><section id="container">



<hr>
<div id="articleFullText">
<p><span>
By Chris Edwards
<br>
Communications of the ACM,
September 2023,
Vol. 66 No. 9, Pages 10-12<br>
10.1145/3607866<br>
<a href="#comments">Comments</a>
</span></p>


<div id="asset-46144">
<figure>
<img alt="connected buildings, illustration" src="https://cacm.acm.org/system/assets/0004/6144/081723_CACMpg10_Historic-Algorithms.large.jpg?1692291292&amp;1692291292" title="connected buildings, illustration">
<figcaption>
<p>Credit: Andrij Borys Associates, Shutterstock</p>
</figcaption>
</figure>
</div>
<p>
<iframe width="560" height="315" src="https://www.youtube.com/embed/awvBpvlbG1M" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen=""></iframe>
</p>


<p>Computer science pioneer Edsger Dijkstra's algorithms form the backbone of many computer subroutines, thanks to their elegant efficiency. However, seemingly subtle changes in requirements can lead to these often conceptually simple formulations failing to provide an accurate answer. The replacement algorithms provide the correct answers but are frequently orders of magnitude slower.</p>
<p>A recent breakthrough in combinatorial techniques has shown how these early algorithms can be revived. </p>
<p>Shortest-path problems provide good examples of the sensitivity of an algorithm to the specifics of their requirements. The underpinning for many applications from navigation to chip layout, these problems present a simple, basic proposition: Find the path through a network of directed paths that offers the lowest cost based on the weights applied to each hop. That weighting may reflect distance or delay, properties that are always positive in the physical world.</p>
<p>Problems start when you encounter a similar network where paths can have negative weights. "When you're dealing with the situation when edge weights correspond to cost, negative weights are natural," says Aaron Bernstein, assistant professor of computer science at Rutgers University, New Brunswick, NJ.</p>
<p>In finance, for example, there may be situations in currency or options trading where buying and selling in one sequence is more profitable than taking a different path, and these can be modeled using negative weights as long as the search algorithm is fast enough. But those negative weights can throw Dijkstra's shortest-path algorithm for a loop.</p>
<p>The issue lies in the efficient greediness of the algorithm developed in the mid-1950s: It will often remove negative-weight paths from consideration. It processes each vertex in turn and does not return, so the algorithm may not consider whether a high weight combined with one that carries a negative weight might result in a lower cost than a single hop with a low weight.</p>
<p>A revised approach, often known as the Bellman-Ford algorithm, handles the negative-weight connections correctly, but because it relies on the ability to process nodes, it lacks the raw efficiency of Dijkstra's technique, which completes in a time based on the sum of the number of nodes and connections. Bellman-Ford instead needs many more steps: The total is based on the product of the number of nodes and vertices.</p>
<p>Though computer scientists have attempted to find more efficient solutions to the problem using similar combinatorial techniques to those used in these longstanding algorithms, they failed to narrow the computational gap between them by a significant amount. Over the past few decades, greater advances were made by representing the graph as coefficients in a matrix and using the tools of linear algebra. Such techniques have proven successful for a wide range of path-related problems, not just for identifying the shortest route but for applications such as maximizing flow through a network of pipes or transportation routes, as demonstrated in a paper presented at last year's Symposium on Foundations of Computer Science (FOCS).</p>
<p>Georgia Institute of Technology Ph.D. student Li Chen, working with mathematicians at Switzerland's ETH Zurich, Stanford University, and the University of Toronto, developed a mechanism based on gradient descent, the same core approach as the one used to train neural networks, to progressively move to the best answer for maximizing flow through a network. This algorithm managed to bring the computation time down to almost linear performance.</p>
<p>The downside to recently developed techniques based on optimization is that they are more difficult to implement and understand than traditional combinatorial algorithms. "This type of approach often uses a lot of dynamic algorithms, which tend to be complicated. They involve many moving parts that you have to put together," says Danupon Nanongkai, director and scientific member of the Max Planck Institute for Informatics in Saarbrücken, Germany.</p>
<hr>
<blockquote>
<p><em>The Bellman-Ford algorithm handles the negative-weight connections correctly but lacks the raw efficiency of Dijkstra's technique.</em></p>
</blockquote>
<hr>
<p>Bernstein, Nanongkai, and Christian Wulff-Nilsen, associate professor of computer science at the University of Copenhagen, wanted to see if they could find an efficient combinatorial solution to the single-source, shortest-path problem with negative weights.</p>
<p>The team first turned to an early-1990s paper by Andrew Goldberg and colleagues that had reduced the complexity to the square root of the number of vertices multiplied by the number of nodes by trying to scale the weight values to become positive and so allow the shortest path to be found using Dijkstra's approach. "The original goal was just to improve the Goldberg result by a little bit but, in the end, it turned out that once everything was in place we could go all the way," says Nanongkai.</p>
<p>A long-standing technique for scaling is the use of price functions, though it can be difficult to assign prices efficiently and in a way that does not distort the relationship between weights. The team found an efficient algorithm which worked on a specific type of graph: those with low diameter. That proved to be the key to a bigger breakthrough and one that may help uncover more efficient combinatorial solutions to other problems.</p>
<p>Low-diameter graphs are structures where the paths are short and can be seen as strongly connected to each other. The low-diameter property has been a key component of finding ways to cut graphs into sections so processing can be distributed across multiple computers. Ensuring that strongly connected components are kept on the same machine helps minimize network traffic.</p>
<p>The team found it was possible to divide the input graph into clusters of low-diameter subgraphs, and then to progressively rework the weights using a series of price functions to build a restructured graph that could be processed almost completely using Dijkstra's algorithm. This involved the random removal of paths with negative weights that would enable the source graph to be converted into a directed acyclic graph: one with only forward paths and no loops connecting the strongly connected clusters to each other. This form was selected because it opened the door to tools that would allow the use of the fastest algorithm. A later phase then reintroduces the missing negative-weight edges. The small number of these paths can be processed using the Bellman-Ford algorithm with comparatively little impact on runtime.</p>
<p>Though a form of low-diameter decomposition built for directed graphs proved fundamental to the solution, Bernstein says it was not immediately obvious as the traditional decomposition was developed for undirected graphs. "When we started to look at it, it was unclear what low-diameter decomposition in this context would mean and it didn't occur to us that it could be a relevant notion. It was only because we started working from a different direction and found we were dealing with graphs connected to the low-diameter property that we started to see how it could be used," he says.</p>
<p>The decomposition made it possible to break the price-function calculations into several steps, and do so in an efficient way without risking the distortion that a single-step approach would impose.</p>
<p>"In a sense, what our algorithm is doing is decomposing the graph, solving things with a few negative edge weights, fixing those, and then moving up. It's continually trying to make sure there are few negative edge weights, solving those and then figuring out the next, progressively trying to make things less and less negative," Bernstein adds.</p>
<hr>
<blockquote>
<p><em>The core algorithm has several elements with a logarithmic dependency on the number of vertices in the graph, each of which represents room for improvement.</em></p>
</blockquote>
<hr>
<p>Wulff-Nilsen notes, "This progressive improvement is done by changing the edges using price functions several times. So, it's not as if we just find one price point."</p>
<p>The result was an algorithm with near-linear performance, and with slightly better performance on its task compared to the optimization technique of maximum flow presented by Chen at the same FOCS event last year. Both shared the best-paper award at the symposium, and a number of teachers have since incorporated the combinatorial algorithm and colleagues into their classes because of its relative simplicity.</p>
<p>Though the core algorithm is near-linear, it has several elements that have a logarithmic dependency on the number of vertices in the graph, each of which presents room for improvement. Karl Bringmann and Alejandro Cassis of Saarland University teamed up with Nick Fischer of the Weizmann Institute of Science in Israel and managed to optimize away six of the eight log factors in a paper published in April. Some they regarded as simple, such as changing the order in which elements are presented to the underlying Dijkstra algorithm, but others were "more involved."</p>
<p>In their work, Bringmann and colleagues came up with what they describe as a more direct form of decomposition for their more efficient algorithm, together with a different form of low-diameter decomposition they did not use for this particular problem.</p>
<p>Such treatments could turn out to be as useful for directed graphs as low-diameter decomposition as they have been for work with undirected graphs. "I think people were excited to see that low-diameter decomposition could be used in this way. People have been talking to all of us about using this for other directed-graph problems," Bernstein claims.</p>
<p>Taking the low-diameter decomposition full circle, Bernstein, Nanongkai, and others published a paper in March demonstrating a distributed algorithm for shortest-path calculation. However, finding efficient combinatorial solutions to problems such as flow maximization remains an uphill struggle, and despite their greater complexity and reliance on techniques that call for the manipulation of dynamic data structures, the optimization-based approaches remain key tools for computer science.</p>
<p>Bernstein observes, "The optimization techniques really are the only way we know to solve some problems. Our algorithm showed a combinatorial solution for one problem, but it's still one particular problem. For minimum-cost flow, for example, we don't yet have an idea of how to do it combinatorially."</p>
<p><img alt="*" src="http://dl.acm.org/images/bullet.gif">&nbsp;<strong>Further Reading</strong></p>
<p><em>Bernstein, A., Nanongkai, D., and Wulff-Nilsen, C.</em><br>
<strong>Negative-Weight Single-Source Shortest Paths in Near-Linear Time <em>Proceedings of the 63<sup>rd</sup> IEEE Annual Symp. on Foundations of Computer Science</em> (2022), 600–611</strong></p>
<p><em>Chen, L., Kyng, R., Liu, Y.P., Peng, R., Probst Gutenberg, M., and Sachdeva, S.</em><br>
<strong>Maximum Flow and Minimum-Cost Flow in Almost-Linear Time <em>Proceedings of the 63<sup>rd</sup> IEEE Annual Symp. on Foundations of Computer Science</em> (2022), 612–623</strong></p>
<p><em>Bringmann, K., Cassis, A., and Fischer, N.</em><br>
<strong>Negative-Weight Single-Source Shortest Paths in Near-Linear Time: Now Faster! ArXiv 2304.05279 (2023)</strong></p>
<p><em>Linial, N. and Saks, M.</em><br>
<strong>Low-Diameter Graph Decompositions <em>Combinatorica 13</em> (4) (1993) 441–454</strong></p>

<p><a href="#PageTop">Back to Top</a></p>

<div id="article-authorinfo"><h3>Author</h3>
<p><strong>Chris Edwards</strong> is a Surrey, U.K.-based writer who reports on electronics, IT, and synthetic biology.</p>
</div>

<div id="article-permission">
<hr><p><strong>©2023 ACM&nbsp;&nbsp;0001-0782/23/8</strong></p>
<p>Permission to make digital or hard copies of part or all of this work for personal or classroom use is granted without fee provided that copies are not made or distributed for profit or commercial advantage and that copies bear this notice and full citation on the first page. Copyright for components of this work owned by others than ACM must be honored. Abstracting with credit is permitted. To copy otherwise, to republish, to post on servers, or to redistribute to lists, requires prior specific permission and/or fee. Request permission to publish from <a href="mailto:permissions@acm.org">permissions@acm.org</a> or fax (212) 869-0481.</p>
</div>

<p>The Digital Library is published by the Association for Computing Machinery. Copyright&nbsp;©&nbsp;2023 ACM, Inc.</p>



<hr>

<p>
No entries found
</p>

</div>
<div id="article-contents-widget">
<h6>Article Contents:</h6>
<ul>
<li><a href="#body-1">Article</a></li>
<li><a href="#authorinfo">Author</a></li>
</ul>
</div>
<a href="https://cacm.acm.org/news/275684-historic-algorithms-help-unlock-shortest-path-problem-breakthrough/%3Ciframe%20width=" 560"="" height="315" src="https://www.youtube.com/embed/awvBpvlbG1M" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen=""> "&gt;</a>
</section></div>]]></description>
        </item>
        <item>
            <title><![CDATA[A video of the transformation of a single cell into a salamander (160 pts)]]></title>
            <link>https://pmdvod.nationalgeographic.com/NG_Video/772/995/1442844739770_1550184269599_1442865731523_mp4_video_1024x576_1632000_primary_audio_eng_3.mp4</link>
            <guid>37275401</guid>
            <pubDate>Sat, 26 Aug 2023 18:17:16 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://pmdvod.nationalgeographic.com/NG_Video/772/995/1442844739770_1550184269599_1442865731523_mp4_video_1024x576_1632000_primary_audio_eng_3.mp4">https://pmdvod.nationalgeographic.com/NG_Video/772/995/1442844739770_1550184269599_1442865731523_mp4_video_1024x576_1632000_primary_audio_eng_3.mp4</a>, See on <a href="https://news.ycombinator.com/item?id=37275401">Hacker News</a></p>
&lt;Not HTML&gt;]]></description>
        </item>
        <item>
            <title><![CDATA[Slack’s Migration to a Cellular Architecture (310 pts)]]></title>
            <link>https://slack.engineering/slacks-migration-to-a-cellular-architecture/</link>
            <guid>37274871</guid>
            <pubDate>Sat, 26 Aug 2023 17:27:28 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://slack.engineering/slacks-migration-to-a-cellular-architecture/">https://slack.engineering/slacks-migration-to-a-cellular-architecture/</a>, See on <a href="https://news.ycombinator.com/item?id=37274871">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="content-area">
		<main id="primary">
			<article id="post-16208">
				<!-- .entry__header -->

									<div>
						<h2>Summary</h2>
<p><span>In recent years, </span><a href="https://aws.amazon.com/solutions/guidance/cell-based-architecture-on-aws/"><span>cellular architectures</span></a><span> have become increasingly popular for large online services as a way to increase redundancy and limit the blast radius of site failures. In pursuit of these goals, we have migrated the most critical user-facing services at Slack from a monolithic to a cell-based architecture over the last 1.5 years. In this series of blog posts, we’ll discuss our reasons for embarking on this massive migration, illustrate the design of our cellular topology along with the engineering trade-offs we made along the way, and talk about our strategies for successfully shipping deep changes across many connected services.</span></p>
<h2><b>Background: the incident</b></h2>
<figure id="attachment_16211" aria-describedby="caption-attachment-16211"><img decoding="async" src="https://slack.engineering/wp-content/uploads/sites/7/2023/08/image1.jpg?w=640" alt="Graph of TCP retransmits by AZ, with one AZ worse than the others" width="640" height="188" srcset="https://slack.engineering/wp-content/uploads/sites/7/2023/08/image1.jpg 1600w, https://slack.engineering/wp-content/uploads/sites/7/2023/08/image1.jpg?resize=640,188 640w, https://slack.engineering/wp-content/uploads/sites/7/2023/08/image1.jpg?resize=768,226 768w, https://slack.engineering/wp-content/uploads/sites/7/2023/08/image1.jpg?resize=1280,376 1280w, https://slack.engineering/wp-content/uploads/sites/7/2023/08/image1.jpg?resize=1536,451 1536w" sizes="(max-width: 479px) 90vw, (max-width: 599px) 432px, 536px"><figcaption id="caption-attachment-16211">TCP retransmits by AZ, 2021-06-30 outage</figcaption></figure>
<p><span>At Slack, we conduct an incident review after each notable service outage. Below is an excerpt from our internal report summarizing one such incident and our findings:&nbsp;</span></p>
<p><i><span>At 11:45am PDT on 2021-06-30, our cloud provider experienced a network disruption in one of several availability zones in our U.S. East Coast region, where the majority of Slack is hosted. A network link that connects one availability zone with several other availability zones containing Slack servers experienced intermittent faults, causing slowness and degraded connections between Slack servers and degrading service for Slack customers.</span></i></p>
<p><i><span>At 12:33pm PDT on 2021-06-30, the network link was automatically removed from service by our cloud provider, restoring full service to Slack customers. After a series of automated checks by our cloud provider, the network link entered service again.</span></i></p>
<p><i><span>At 5:22pm PDT on 2021-06-30, the same network link experienced the same intermittent faults. At 5:31pm PDT on 2021-06-30, the cloud provider permanently removed the network link from service, restoring full service to our customers.</span></i></p>
<p><span>At first glance, this appears to be pretty unremarkable; a piece of physical hardware upon which we were reliant failed, so we served some errors until it was removed from service. However, as we went through the reflective process of incident review, we were led to wonder why, in fact, this outage was visible to our users </span><i><span>at all</span></i><span>.&nbsp;</span></p>
<p><span>Slack operates a global, multi-regional edge network, but most of our core computational infrastructure resides in multiple Availability Zones within a single region, us-east-1. Availability Zones (AZs) are isolated datacenters within a single region; in addition to the physical isolation they offer, components of cloud services upon which we rely (virtualization, storage, networking, etc.) are blast-radius limited such that they should not fail simultaneously across multiple AZs. This enables builders of services hosted in the cloud (such as Slack) to architect services in such a way that the availability of the entire service in a region is greater than the availability of any one underlying AZ. So to restate the question above — why didn’t this strategy work out for us on June 30? Why did one failed AZ result in user-visible errors?</span></p>
<p><span>As it turns out, detecting failure in distributed systems is a hard problem. A single Slack API request from a user (for example, loading messages in a channel) may fan out into hundreds of RPCs to service backends, each of which must complete to return a correct response to the user. Our service frontends are continuously attempting to detect and exclude failed backends, but we’ve got to record some failures before we can exclude a failed server! To make things even harder, some of our key datastores (including </span><a href="https://slack.engineering/scaling-datastores-at-slack-with-vitess/"><span>our main datastore Vitess</span></a><span>) offer strongly consistent semantics. This is enormously useful to us as application developers but also requires that there be a single backend available for any given write. If a shard primary is unavailable to an application frontend, writes to that shard will fail until the primary returns or a secondary is promoted to take its place.</span></p>
<p><span>We might class the outage above as a </span><a href="https://www.microsoft.com/en-us/research/wp-content/uploads/2017/06/paper-1.pdf"><i><span>gray failure</span></i></a><span>. In a gray failure, different components have different views of the availability of the system. In our incident, systems within the impacted AZ saw complete availability of backends within their AZ, but backends outside the AZ were unavailable, and vice versa systems in unimpacted AZs saw the impacted AZ as unavailable. Even clients within the same AZ would have different views of backends in the impacted AZ, depending on whether their network flows happened to traverse the failed equipment. Informally, it seems that this is quite a lot of complexity to ask a distributed system to deal with along the way to doing its real job of serving messages and cat GIFs to our customers.</span></p>
<p><span>Rather than try to solve automatic remediation of gray failures, our solution to this conundrum was to make the computers’ job easier by tapping the power of human judgment. During the outage, it was quite clear to engineers responding that the impact was largely due to one AZ being unreachable — nearly every graph we had aggregated by target AZ looked similar to the retransmits graph above. If we had a button that told all our systems “This AZ is bad; avoid it.” we would absolutely have smashed it! So we set out to build a button that would drain traffic from an AZ.</span></p>
<h2><b>Our solution: AZs are cells, and cells may be drained</b></h2>
<p><span>Like a lot of satisfying infrastructure work, an AZ drain button is conceptually simple yet complicated in practice. The design goals we chose are:</span></p>
<ol>
<li><span>Remove as much traffic as possible from an AZ within 5 minutes. Slack’s </span><a href="https://slack.com/terms/service-level-agreement"><span>99.99% availability SLA</span></a><span>&nbsp;allows us less than 1 hour per year of total unavailability, and so to support it effectively we need tools that work quickly.</span></li>
<li><span>Drains must not result in user-visible errors. An important quality of draining is that it is a </span><a href="https://www.oreilly.com/content/generic-mitigations/"><span>generic mitigation</span></a><span>: as long as a failure is contained within a single AZ, a drain may be effectively used to mitigate even if the root cause is not yet understood. This lends itself to an experimental approach wherein, during in an incident, an operator may try draining an AZ to see if it enables recovery, then undrain if it does not. If draining results in additional errors this approach is not useful.</span></li>
<li><span>Drains and undrains must be incremental. When undraining, an operator should be able to assign as little as 1% of traffic to an AZ to test whether it has truly recovered.</span></li>
<li><span>The draining mechanism must not rely on resources in the AZ being drained. For example, it’s not OK to activate a drain by just SSHing to every server and forcing it to healthcheck down. This ensures that drains may be put in place even if an AZ is completely offline.</span></li>
</ol>
<p><span>A naive implementation that fits these requirements would have us plumb a signal into each of our RPC clients that, when received, causes them to fail a specified percentage of traffic away from a particular AZ. This turns out to have a lot of complexity lurking within. Slack does not share a common codebase or even runtime; services in the user-facing request path are written in Hack, Go, Java, and C++. This would necessitate a separate implementation in each language. Beyond that concern, we support a number of internal service discovery interfaces including the Envoy xDS API, the Consul API, and even DNS. Notably, DNS does not offer an abstraction for something like an AZ or partial draining; clients expect to resolve a DNS address and receive a list of IPs and no more. Finally, we rely heavily on open-source systems like Vitess, for which code-level changes present an unpleasant choice between maintaining an internal fork and doing the additional work to get changes merged into upstream.</span></p>
<p><span>The main strategy we settled on is called </span><i><span>siloing</span></i><span>. Services may be said to be </span><i><span>siloed</span></i><span>&nbsp;if they only receive traffic from within their AZ and only send traffic upstream to servers in their AZ. The overall architectural effect of this is that each service appears to be N virtual services, one per AZ. Importantly, we may effectively remove traffic from all siloed services in an AZ simply by redirecting user requests away from that AZ. If no new requests from users are arriving in a siloed AZ, internal services in that AZ will naturally quiesce as they have no new work to do.</span></p>
<figure id="attachment_16212" aria-describedby="caption-attachment-16212"><img decoding="async" src="https://slack.engineering/wp-content/uploads/sites/7/2023/08/image2.jpg?w=640" alt="A digram showing request failures across multiple AZs caused by a failure in a single AZ." width="640" height="434" srcset="https://slack.engineering/wp-content/uploads/sites/7/2023/08/image2.jpg 1160w, https://slack.engineering/wp-content/uploads/sites/7/2023/08/image2.jpg?resize=640,435 640w, https://slack.engineering/wp-content/uploads/sites/7/2023/08/image2.jpg?resize=768,522 768w" sizes="(max-width: 479px) 90vw, (max-width: 599px) 432px, 536px"><figcaption id="caption-attachment-16212">Our original architecture. Backends are spread across AZs, so errors present in frontends in all AZs.</figcaption></figure>
<p><span>And so we finally arrive at our cellular architecture. All services are present in all AZs, but each service only communicates with services within its AZ. Failure of a system within one AZ is contained within that AZ, and we may dynamically route traffic away to avoid those failures simply by redirecting at the frontend.</span></p>
<figure id="attachment_16213" aria-describedby="caption-attachment-16213"><img decoding="async" loading="lazy" src="https://slack.engineering/wp-content/uploads/sites/7/2023/08/image3.jpg?w=640" alt="A digram showing client requests siloed within AZs, routing around a failed AZ." width="640" height="424" srcset="https://slack.engineering/wp-content/uploads/sites/7/2023/08/image3.jpg 1160w, https://slack.engineering/wp-content/uploads/sites/7/2023/08/image3.jpg?resize=640,424 640w, https://slack.engineering/wp-content/uploads/sites/7/2023/08/image3.jpg?resize=768,508 768w" sizes="(max-width: 479px) 90vw, (max-width: 599px) 432px, 536px"><figcaption id="caption-attachment-16213">Siloed architecture. Failure in one AZ is contained to that AZ; traffic may be routed away.</figcaption></figure>
<p><span>Siloing allows us to concentrate our efforts on the traffic-shifting implementation in one place: the systems that route queries from users into the core services in us-east-1. Over the last several years we have invested heavily in </span><a href="https://slack.engineering/migrating-millions-of-concurrent-websockets-to-envoy/"><span>migrating from HAProxy to the Envoy / xDS ecosystem,</span></a><span>&nbsp;and so all our edge load balancers are now running Envoy and receive configuration from Rotor, our in-house xDS control plane. This enabled us to power AZ draining by simply using two out-of-the-box Envoy features: weighted clusters and dynamic weight assignment via RTDS. When we drain an AZ, we simply send a signal through Rotor to the edge Envoy load balancers instructing them to reweight their per-AZ target clusters at us-east-1. If an AZ at us-east-1 is reweighted to zero, Envoy will continue handling in-flight requests but assign all new requests to another AZ, and thus the AZ is drained. Let’s see how this satisfies our goals:</span></p>
<ol>
<li><span>Propagation through the control plane is on the order of seconds; Envoy load balancers will apply new weights immediately.</span></li>
<li><span>Drains are graceful; no queries to a drained AZ will be abandoned by the load balancing layer.</span></li>
<li><span>Weights provide gradual drains with a granularity of 1%.</span></li>
<li><span>Edge load balancers are located in different regions entirely, and the control plane is replicated regionally and resilient against the failure of any single AZ.</span></li>
</ol>
<p><span>Here is a graph showing bandwidth per AZ as we gradually drain traffic from one AZ into two others. Note how pronounced the “knees” in the graph are; this reflects the low propagation time and high granularity afforded us by the Envoy/xDS implementation.</span></p>
<figure id="attachment_16214" aria-describedby="caption-attachment-16214"><img decoding="async" loading="lazy" src="https://slack.engineering/wp-content/uploads/sites/7/2023/08/image4.jpg?w=640" alt="Graph showing queries per second per AZ. One AZ's rate drops while the others rise at 3 distinct points in time and then the rates re-converge at an even split." width="640" height="416" srcset="https://slack.engineering/wp-content/uploads/sites/7/2023/08/image4.jpg 1999w, https://slack.engineering/wp-content/uploads/sites/7/2023/08/image4.jpg?resize=640,416 640w, https://slack.engineering/wp-content/uploads/sites/7/2023/08/image4.jpg?resize=768,499 768w, https://slack.engineering/wp-content/uploads/sites/7/2023/08/image4.jpg?resize=1280,832 1280w, https://slack.engineering/wp-content/uploads/sites/7/2023/08/image4.jpg?resize=1536,999 1536w, https://slack.engineering/wp-content/uploads/sites/7/2023/08/image4.jpg?resize=1920,1249 1920w" sizes="(max-width: 479px) 90vw, (max-width: 599px) 432px, 536px"><figcaption id="caption-attachment-16214">Queries per second, by AZ.</figcaption></figure>
<p><span>In our next post we’ll dive deeper into the details of our technical implementation. We’ll discuss how siloing is implemented for internal services, and which services can’t be siloed and what we do about them. We’ll also discuss how we’ve changed the way we operate and build services at Slack now that we have this powerful new tool at our disposal. Stay tuned!</span></p>
					</div><!-- .entry__content -->
				<!-- .entry__footer -->
			</article><!-- #post-16208 -->

		
		</main><!-- #primary -->

		
<!-- #secondary -->
	</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[For many home-schoolers, parents are no longer doing the teaching (144 pts)]]></title>
            <link>https://www.washingtonpost.com/education/interactive/2023/homeschooling-microschools-pods-esa-vouchers/</link>
            <guid>37274404</guid>
            <pubDate>Sat, 26 Aug 2023 16:41:32 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.washingtonpost.com/education/interactive/2023/homeschooling-microschools-pods-esa-vouchers/">https://www.washingtonpost.com/education/interactive/2023/homeschooling-microschools-pods-esa-vouchers/</a>, See on <a href="https://news.ycombinator.com/item?id=37274404">Hacker News</a></p>
Couldn't get https://www.washingtonpost.com/education/interactive/2023/homeschooling-microschools-pods-esa-vouchers/: Error [ERR_FR_TOO_MANY_REDIRECTS]: Maximum number of redirects exceeded]]></description>
        </item>
        <item>
            <title><![CDATA[n8n.io - A powerful workflow automation tool (201 pts)]]></title>
            <link>https://n8n.io</link>
            <guid>37274052</guid>
            <pubDate>Sat, 26 Aug 2023 16:06:42 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://n8n.io">https://n8n.io</a>, See on <a href="https://news.ycombinator.com/item?id=37274052">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-v-691fb278="" id="__nuxt" data-server-rendered="true"><div data-v-43b42ddf="" data-v-691fb278=""><div data-v-43b42ddf=""><p data-v-43b42ddf="">
        Workflow automation for technical people
      </p> <h2 data-v-43b42ddf="">
        Build complex automations 10x faster, without fighting APIs
      </h2> <p data-v-43b42ddf="">Your days spent slogging through a spaghetti of scripts are over. <br>Use JavaScript when you need flexibility and UI for everything else.</p> <div data-v-0e3fb934="" data-v-43b42ddf=""><a href="https://github.com/n8n-io/n8n" data-v-0e3fb934=""><div data-v-0e3fb934="" data-v-43b42ddf=""><p><img src="https://n8n.io/_nuxt/image/87df9a.svg" width="32" height="32" alt="GitHub logo" loading="lazy" srcset="https://n8niostorageaccount.blob.core.windows.net/n8nio-strapi-blobs-prod/assets/github_white_3112efbe15_d6f929e422.svg" data-v-43b42ddf=""></p> </div></a></div></div> <div data-v-43b42ddf=""><p><img src="https://n8n.io/_nuxt/image/a57c32.svg" alt="" loading="lazy" data-v-43b42ddf=""> <span data-v-43b42ddf="">Full source code available</span></p><p><img src="https://n8n.io/_nuxt/image/a57c32.svg" alt="" loading="lazy" data-v-43b42ddf=""> <span data-v-43b42ddf="">Self host-able</span></p><p><img src="https://n8n.io/_nuxt/image/a57c32.svg" alt="" loading="lazy" data-v-43b42ddf=""> <span data-v-43b42ddf="">55,385 community members</span></p></div> <p><img src="https://n8n.io/_nuxt/image/f4908d.svg" alt="homepage bg mobile" srcset="https://n8niostorageaccount.blob.core.windows.net/n8nio-strapi-blobs-stage/assets/Group_491_1_3966733d3a.svg" format="webp" fetchpriority="high" data-v-43b42ddf=""> <img src="https://n8n.io/_nuxt/image/f07ac5.svg" alt="n8n_image" srcset="https://n8niostorageaccount.blob.core.windows.net/n8nio-strapi-blobs-stage/assets/Frame_1035_bf4f8a8954.svg" fetchpriority="high" format="webp" data-v-43b42ddf=""></p></div><div data-v-53511fec="" data-v-691fb278=""><div data-index="0" data-v-5efc53c4="" data-v-53511fec=""><h3 data-v-5efc53c4="" data-v-53511fec="">
          Code when you need, no code when you don’t&nbsp;
        </h3> <p><span data-v-5efc53c4="" data-v-53511fec=""><p>Connect APIs with no code to automate basic tasks. Or write vanilla Javascript when you need to manipulate complex data.</p>
</span></p></div><div data-index="1" data-v-5efc53c4="" data-v-53511fec=""><h3 data-v-5efc53c4="" data-v-53511fec="">
          Build custom scenarios at speed
        </h3> <p><span data-v-5efc53c4="" data-v-53511fec=""><p>You can implement multiple triggers. Branch and merge your workflows. And even pause flows to wait for external events.</p>
</span></p></div><div data-index="2" data-v-5efc53c4="" data-v-53511fec=""><h3 data-v-5efc53c4="" data-v-53511fec="">
          Integrate with any app
        </h3> <p><span data-v-5efc53c4="" data-v-53511fec=""><p>Interface easily with any API or service with custom HTTP requests.</p>
</span></p></div><div data-index="3" data-v-5efc53c4="" data-v-53511fec=""><h3 data-v-5efc53c4="" data-v-53511fec="">
          Independent instances for each environment
        </h3> <p><span data-v-5efc53c4="" data-v-53511fec=""><p>Avoid breaking live workflows by separating dev and prod environments with unique sets of auth data.</p>
</span></p></div><div data-index="4" data-v-5efc53c4="" data-v-53511fec=""><h3 data-v-5efc53c4="" data-v-53511fec="">
          Bulk operations&nbsp;
        </h3> <p><span data-v-5efc53c4="" data-v-53511fec=""><p>n8n nodes let you process data at scale with a built-in iteration functionality in every node.</p>
</span></p></div><div data-index="5" data-v-5efc53c4="" data-v-53511fec=""><h3 data-v-5efc53c4="" data-v-53511fec="">
          Painless debugging
        </h3> <p><span data-v-5efc53c4="" data-v-53511fec=""><p>See the execution data of every workflow. Integrate error nodes into workflows to catch errors. And rerun individual nodes to test fixes fast.</p>
</span></p></div><div data-index="6" data-v-5efc53c4="" data-v-53511fec=""><h3 data-v-5efc53c4="" data-v-53511fec="">
          Host on your own infrastructure
        </h3> <p><span data-v-5efc53c4="" data-v-53511fec=""><p>Fully on-prem for those that need the security</p>
</span></p></div></div><div data-v-4aa551c5="" data-v-691fb278=""> <div data-v-4aa551c5=""><ul data-v-4aa551c5=""><li role="presentation" data-v-4aa551c5=""><span role="tab" data-v-4aa551c5="">
          Customer integrations
        </span></li><li role="presentation" data-v-4aa551c5=""><span role="tab" data-v-4aa551c5="">
          SaaS backend prototyping
        </span></li><li role="presentation" data-v-4aa551c5=""><span role="tab" data-v-4aa551c5="">
          Lead automation
        </span></li><li role="presentation" data-v-4aa551c5=""><span role="tab" data-v-4aa551c5="">
          CRM customization
        </span></li></ul></div> <div data-v-4aa551c5=""><div data-v-4aa551c5=""><div data-v-4aa551c5=""><h3>Optimize engineering resources</h3>
<p>Save time building customer integrations. Engineer faster POCs. And keep your customer-specific functionality separate from product. All without writing a single line of code.</p>
</div> <div data-v-4aa551c5=""><p><img src="https://n8n.io/_nuxt/image/736d75.png" alt="eng-resources" loading="lazy" srcset="https://n8niostorageaccount.blob.core.windows.net/n8nio-strapi-blobs-stage/assets/common_uses_cases_engineering_resources_96ca4f3e48.png" format="webp" data-v-4aa551c5=""></p> </div></div><div data-v-4aa551c5=""><div data-v-4aa551c5=""><h3>Build and test new features faster</h3>
<p>Avoid throwing away features that took forever to build. With n8n, you can quickly set up end points to test what works. And easily debug to fix what doesn’t.</p>
</div> <div data-v-4aa551c5=""><p><img src="https://n8n.io/_nuxt/image/0ebf9c.png" alt="common_uses_cases_newFeatures" loading="lazy" srcset="https://n8niostorageaccount.blob.core.windows.net/n8nio-strapi-blobs-stage/assets/common_uses_cases_new_Features_bd1ae37b46.png" format="webp" data-v-4aa551c5=""></p> </div></div><div data-v-4aa551c5=""><div data-v-4aa551c5=""><h3>Save time&nbsp;managing leads</h3>
<p>Take the stress out of managing your leads by connecting all your marketing tools to run on autopilot.</p>
</div> <div data-v-4aa551c5=""><p><img src="https://n8n.io/_nuxt/image/b0bef3.png" alt="common_uses_cases_leads" loading="lazy" srcset="https://n8niostorageaccount.blob.core.windows.net/n8nio-strapi-blobs-stage/assets/common_uses_cases_leads_ae5eddfdbf.png" format="webp" data-v-4aa551c5=""></p> </div></div><div data-v-4aa551c5=""><div data-v-4aa551c5=""><h3>CRM customization</h3>
<p>Push past the limitations of your CRM by building custom integrations to move any data you want between your apps and systems.</p>
</div> <div data-v-4aa551c5=""><p><img src="https://n8n.io/_nuxt/image/d6a2ea.png" alt="common_uses_cases_CRM" loading="lazy" srcset="https://n8niostorageaccount.blob.core.windows.net/n8nio-strapi-blobs-stage/assets/common_uses_cases_CRM_085a831754.png" format="webp" data-v-4aa551c5=""></p> </div></div></div></div><div data-v-53511fec="" data-v-691fb278=""><div data-index="0" data-v-5efc53c4="" data-v-53511fec=""><h3 data-v-5efc53c4="" data-v-53511fec="">
          Scalable performance
        </h3> <p><span data-v-5efc53c4="" data-v-53511fec=""><p>220 workflow executions per sec on a single instance, and add more instances if required. <a href="https://docs.n8n.io/hosting/scaling/performance-benchmarking/">More info</a></p>
</span></p></div><div data-index="1" data-v-5efc53c4="" data-v-53511fec=""><h3 data-v-5efc53c4="" data-v-53511fec="">
          Customizable error handling
        </h3> <p><span data-v-5efc53c4="" data-v-53511fec=""><p>Get notified whenever a workflow fails — be it via email, Slack or a log aggregator</p>
</span></p></div><div data-index="2" data-v-5efc53c4="" data-v-53511fec=""><h3 data-v-5efc53c4="" data-v-53511fec="">
          Share workflows with a click
        </h3> <p><span data-v-5efc53c4="" data-v-53511fec=""><p>Reuse, export to JSON, or import workflows with a single copy/paste.</p>
</span></p></div><div data-index="3" data-v-5efc53c4="" data-v-53511fec=""><h3 data-v-5efc53c4="" data-v-53511fec="">
          Use 600+ templates to move faster
        </h3> <p><span data-v-5efc53c4="" data-v-53511fec=""><p>Get a head start on your workflows with templates developed by our core team and community.</p>
</span></p></div><div data-index="4" data-v-5efc53c4="" data-v-53511fec=""><h3 data-v-5efc53c4="" data-v-53511fec="">
          350+ native integrations
        </h3> <p><span data-v-5efc53c4="" data-v-53511fec=""><p>Connect to all your favorite apps. Or write your own integration with a general connector to the rest.</p>
</span></p></div><div data-index="5" data-v-5efc53c4="" data-v-53511fec=""><h3 data-v-5efc53c4="" data-v-53511fec="">
          Automated API auth
        </h3> <p><span data-v-5efc53c4="" data-v-53511fec=""><p>All you have to do is enter the API key. n8n handles the rest of the auth. No reading through docs required.</p>
</span></p></div></div><div data-v-59da2cda="" data-v-691fb278=""><div data-v-4dc91236="" data-v-59da2cda=""><p><img src="https://n8n.io/_nuxt/image/502eb8.svg" alt="how-it-works-1" loading="lazy" srcset="https://n8niostorageaccount.blob.core.windows.net/n8nio-strapi-blobs-prod/assets/how_It_Works_1_db22134a11.svg" data-v-4dc91236=""></p> <div data-v-4dc91236=""><h3 data-v-4dc91236="">Pull in data</h3> <p data-v-4dc91236="">Set up triggers for app events or specific times to fetch data across your app stack</p></div> <p><img src="https://n8n.io/_nuxt/image/579b4a.svg" width="64" height="73" alt="arrow_primary" loading="lazy" data-v-4dc91236=""> <img src="https://n8n.io/_nuxt/image/fe7f83.svg" width="105" height="116" alt="arrow_secondary" loading="lazy" data-v-4dc91236=""></p></div><div data-v-4dc91236="" data-v-59da2cda=""><p><img src="https://n8n.io/_nuxt/image/8fd21a.svg" alt="how-it-works-2" loading="lazy" srcset="https://n8niostorageaccount.blob.core.windows.net/n8nio-strapi-blobs-prod/assets/how_It_Works_2_dd2c4fc758.svg" data-v-4dc91236=""></p> <div data-v-4dc91236=""><h3 data-v-4dc91236="">Set up steps</h3> <p data-v-4dc91236="">Use 220+ app nodes to create, read, and update the valuable data across your apps</p></div> <p><img src="https://n8n.io/_nuxt/image/579b4a.svg" width="64" height="73" alt="arrow_primary" loading="lazy" data-v-4dc91236=""> <img src="https://n8n.io/_nuxt/image/fe7f83.svg" width="105" height="116" alt="arrow_secondary" loading="lazy" data-v-4dc91236=""></p></div><div data-v-4dc91236="" data-v-59da2cda=""><p><img src="https://n8n.io/_nuxt/image/1f8301.svg" alt="how-it-works-3" loading="lazy" srcset="https://n8niostorageaccount.blob.core.windows.net/n8nio-strapi-blobs-prod/assets/how_It_Works_3_7a4b095a4b.svg" data-v-4dc91236=""></p> <div data-v-4dc91236=""><h3 data-v-4dc91236="">Save time - every day</h3> <p data-v-4dc91236="">From monthly syncs to millions of executions, sit back as your workflow does the heavy lifting</p></div> <!----> <!----></div></div><div data-v-7442cf86="" data-v-691fb278=""><div data-v-67dbc12e="" data-v-7442cf86=""> <p>Your workflows<br>
Your way</p> <ul data-v-67dbc12e=""><li data-v-67dbc12e=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="16" fill="none" style="color:#8287eb" data-v-67dbc12e=""><path fill="currentColor" d="m23.472 6.728-6-6a1.8 1.8 0 0 0-2.544 2.544L17.854 6.2H1.8a1.8 1.8 0 0 0 0 3.6h16.054l-2.926 2.928a1.801 1.801 0 1 0 2.544 2.544l6-6a1.797 1.797 0 0 0 0-2.544Z" data-v-67dbc12e=""></path></svg> <p><strong>Full source code available:</strong><br>
Audit, tweak, and fork our codebase to suit your needs.</p></li><li data-v-67dbc12e=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="16" fill="none" style="color:#8287eb" data-v-67dbc12e=""><path fill="currentColor" d="m23.472 6.728-6-6a1.8 1.8 0 0 0-2.544 2.544L17.854 6.2H1.8a1.8 1.8 0 0 0 0 3.6h16.054l-2.926 2.928a1.801 1.801 0 1 0 2.544 2.544l6-6a1.797 1.797 0 0 0 0-2.544Z" data-v-67dbc12e=""></path></svg> <p><strong>Self-hostable:</strong> Easily keep your data secure. And ensure compliance with data privacy laws.</p></li><li data-v-67dbc12e=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="16" fill="none" style="color:#8287eb" data-v-67dbc12e=""><path fill="currentColor" d="m23.472 6.728-6-6a1.8 1.8 0 0 0-2.544 2.544L17.854 6.2H1.8a1.8 1.8 0 0 0 0 3.6h16.054l-2.926 2.928a1.801 1.801 0 1 0 2.544 2.544l6-6a1.797 1.797 0 0 0 0-2.544Z" data-v-67dbc12e=""></path></svg> <p><strong>Embeddable:</strong> White label our UI to give your customers access to 220+ native integrations.</p></li></ul> </div><div data-v-67dbc12e="" data-v-7442cf86=""> <p>Build without blowing your budget</p> <ul data-v-67dbc12e=""><li data-v-67dbc12e=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="16" fill="none" style="color:#8287eb" data-v-67dbc12e=""><path fill="currentColor" d="m23.472 6.728-6-6a1.8 1.8 0 0 0-2.544 2.544L17.854 6.2H1.8a1.8 1.8 0 0 0 0 3.6h16.054l-2.926 2.928a1.801 1.801 0 1 0 2.544 2.544l6-6a1.797 1.797 0 0 0 0-2.544Z" data-v-67dbc12e=""></path></svg> <p>Other platforms’ per-execution pricing can eat up your budget insanely fast.</p></li><li data-v-67dbc12e=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="16" fill="none" style="color:#8287eb" data-v-67dbc12e=""><path fill="currentColor" d="m23.472 6.728-6-6a1.8 1.8 0 0 0-2.544 2.544L17.854 6.2H1.8a1.8 1.8 0 0 0 0 3.6h16.054l-2.926 2.928a1.801 1.801 0 1 0 2.544 2.544l6-6a1.797 1.797 0 0 0 0-2.544Z" data-v-67dbc12e=""></path></svg> <p>With n8n, you can self-host for free. Or <strong>pay for a package of workflows</strong> in the cloud.</p></li><li data-v-67dbc12e=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="16" fill="none" style="color:#8287eb" data-v-67dbc12e=""><path fill="currentColor" d="m23.472 6.728-6-6a1.8 1.8 0 0 0-2.544 2.544L17.854 6.2H1.8a1.8 1.8 0 0 0 0 3.6h16.054l-2.926 2.928a1.801 1.801 0 1 0 2.544 2.544l6-6a1.797 1.797 0 0 0 0-2.544Z" data-v-67dbc12e=""></path></svg> <p>So you can make your flows as complex as you like — at no extra cost.</p></li></ul> </div><div data-v-67dbc12e="" data-v-7442cf86=""> <p>Resolve 99% of issues&nbsp;in hours, not months</p> <ul data-v-67dbc12e=""><li data-v-67dbc12e=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="16" fill="none" style="color:#8287eb" data-v-67dbc12e=""><path fill="currentColor" d="m23.472 6.728-6-6a1.8 1.8 0 0 0-2.544 2.544L17.854 6.2H1.8a1.8 1.8 0 0 0 0 3.6h16.054l-2.926 2.928a1.801 1.801 0 1 0 2.544 2.544l6-6a1.797 1.797 0 0 0 0-2.544Z" data-v-67dbc12e=""></path></svg> <p>You don’t have to wait weeks for someone on your vendor’s team to fix your issue. (If they can fix it at all.)</p></li><li data-v-67dbc12e=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="16" fill="none" style="color:#8287eb" data-v-67dbc12e=""><path fill="currentColor" d="m23.472 6.728-6-6a1.8 1.8 0 0 0-2.544 2.544L17.854 6.2H1.8a1.8 1.8 0 0 0 0 3.6h16.054l-2.926 2.928a1.801 1.801 0 1 0 2.544 2.544l6-6a1.797 1.797 0 0 0 0-2.544Z" data-v-67dbc12e=""></path></svg> <p>Get access to a <strong>6K-strong forum</strong> of n8n engineers and community experts available 24/7 to answer your questions.</p></li><li data-v-67dbc12e=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="16" fill="none" style="color:#8287eb" data-v-67dbc12e=""><path fill="currentColor" d="m23.472 6.728-6-6a1.8 1.8 0 0 0-2.544 2.544L17.854 6.2H1.8a1.8 1.8 0 0 0 0 3.6h16.054l-2.926 2.928a1.801 1.801 0 1 0 2.544 2.544l6-6a1.797 1.797 0 0 0 0-2.544Z" data-v-67dbc12e=""></path></svg> <p>You can expect same-day responses (almost) every time.</p></li></ul> </div></div><div data-v-2dd2ed8c="" data-v-691fb278=""><p data-v-2dd2ed8c="">
        Scale your company's operations with our advanced on-prem or cloud automation
      </p>  <!----></div><div data-v-17ea5a8e="" data-v-691fb278=""><p>Stop struggling with your scripts<br>
Start creating workflows 10X faster — with n8n</p> </div> <p><a href="https://www.producthunt.com/posts/n8n-1-0?utm_source=badge-featured&amp;utm_medium=badge&amp;utm_souce=badge-n8n-1-0" target="_blank" data-v-691fb278=""><img src="https://api.producthunt.com/widgets/embed-image/v1/featured.svg?post_id=406015&amp;theme=dark" alt="n8n 1.0 - Workflow automation for technical people | Product Hunt" width="250" height="54" data-v-691fb278=""></a></p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Google Maps is a critical dependency for nutrition facts on mcdonalds.com (109 pts)]]></title>
            <link>https://mastodon.social/@simevidas/110956696765338181</link>
            <guid>37273907</guid>
            <pubDate>Sat, 26 Aug 2023 15:49:36 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://mastodon.social/@simevidas/110956696765338181">https://mastodon.social/@simevidas/110956696765338181</a>, See on <a href="https://news.ycombinator.com/item?id=37273907">Hacker News</a></p>
&lt;Unparsable&gt;]]></description>
        </item>
        <item>
            <title><![CDATA[Rust Cryptography Should Be Written in Rust (109 pts)]]></title>
            <link>https://briansmith.org/rust-cryptography-should-be-written-in-rust-01</link>
            <guid>37273701</guid>
            <pubDate>Sat, 26 Aug 2023 15:23:08 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://briansmith.org/rust-cryptography-should-be-written-in-rust-01">https://briansmith.org/rust-cryptography-should-be-written-in-rust-01</a>, See on <a href="https://news.ycombinator.com/item?id=37273701">Hacker News</a></p>
<div id="readability-page-1" class="page"><article>

<p>Cryptography libraries for Rust should be written entirely in Rust.

</p><p>Rust should be improved to provide the necessary building blocks that are
   needed to write cryptography code that is free from timing side channels and
   similar hazards. These facilities should not be restricted to code within
   Rust -provided or -endorsed libraries; anybody should be able to use them to
   publish a crate that correctly implements cryptography. The standard Rust
   toolchain (rustc, Cargo, etc.) should ensure that these facilities work
    as specified.

</p><p>Rust should provide safe, direct access to architecture-specific instructions
   that are required to implement cryptography with optimal performance. Rust
   should provide a safe mechanism for dispatching to microarchitecture-specific
   implementations at runtime. There is no need to trade off performance vs.
   safety.

</p><p>In some cases (e.g. WebAssembly and other virtual machine architectures) the
   target may need to be extended to provide the necessary facilities so
   that Rust compilers can produce safe code. The Rust community should work with
   the communities implementing these architectures to help them provide what is
   needed.

</p><p>The Rust Foundation is led by several organizations that have experts in
   maintaining FIPS-validated software libraries: ARM, Amazon Web Services, Google,
   and Microsoft. They should support the Rust community by letting their experts
   help the Rust community create FIPS-validated cryptography libraries written
   entirely in safe Rust that expose safe and idiomatic Rust APIs.

</p><p>We should help formal methods cryptography projects generate and/or verify
   safe Rust code.

</p><p>The word "safe" above refers to Rust's sense of safety: All of these facilities
   should be provided such that they can be used without any use of the
   <code>unsafe</code> keyword in the crypto code.

</p><p>All of the above is achievable with reasonable effort, time, and cost. It is
   often impractical for people to advocate for or work on pure Rust cryptography,
   even if they want to do so—especially when they may work for organizations that
   already have committed to doing something else. The community has to kindly
   demand pure Rust cryptography, politely but firmly refuse compromises, and
   generously support the individuals who are actively working towards making safe
   Rust cryptography a reality.
</p></article></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Let Maintainers Be Maintainers (175 pts)]]></title>
            <link>https://graydon2.dreamwidth.org/306832.html</link>
            <guid>37272929</guid>
            <pubDate>Sat, 26 Aug 2023 13:52:38 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://graydon2.dreamwidth.org/306832.html">https://graydon2.dreamwidth.org/306832.html</a>, See on <a href="https://news.ycombinator.com/item?id=37272929">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><p>A short note about corporate free / open source software (FOSS), and corporate-employed maintainers. Or specifically "corporate-employed maintainers .. with bad incentives". I tried to come up with a pithy name, but that's the best I could do: CEMBIs.</p><p>I've worked professionally in FOSS for a long time. I've seen a lot of corporate approaches to FOSS participation over that time, and seen the FOSS community develop a fairly nuanced understanding of what sorts of corporate strategies are welcome or unwelcome, healthy or harmful to a project. We have articulated a lot of thoughts about (say) open core and dual licensing business models, or (say) which forms of corporate "embrace" represent a step on an "extend/extinguish" path, or (say) which forms of telemetry are appropriate and which put users at risk of surveillance.</p><p>What I haven't seen a lot of discussion of, and wish I did see, is the structure and content of relationships that exist between corporate-employed FOSS maintainers and their employers. And I think this matters because the people doing corporate FOSS aren't soul-less automata executing corporate strategy. They are people with their own motivations, incentives, a certain amount of autonomy, but (most relevant to my concerns) a set of performance-evaluation criteria they have to satisfy to remain employed and/or get promoted.</p><p>Companies incentivize lots of things, but I worry (and in many cases I either know first hand or have heard second hand) that companies often have an incentive structure that rewards <em>novelty</em>, especially in the form of <em>features</em> if not entire <em>products</em>. There's a good reason for this when the company is "making products to sell": this year's new-and-improved is always sellable over last year's tired old model. But it's also just a reflection of the "growth orientation" or capitalism in general: whatever activity the company accomplished last year, a common measure of health and vitality isn't consistent execution but <em>growth of the business</em>. Failure to grow is treated as stagnation which is treated as equivalent to death. This orientation can be embedded so deep in a company's DNA that it's the incentive structure given to <em>everyone</em> who works there, regardless of whether they're making products, auditing the accounts, or <em>maintaining corporate infrastructure</em>.</p><p>And to a large measure, that's what FOSS is. Not always, but usually: <a href="https://en.wikipedia.org/wiki/Infrastructure">infrastructure</a>. It's stuff that's supposed to work the same way from one day to the next. Stuff that's not supposed to be noticed because it just works. Reliably, efficiently, silently. Stuff that has a massive installed base of users relying on it, massive social and institutional inertia, and thereby massive (and sensible) built-in resistance to novelty. You don't actually want novelty in the electrical grid, the drinking water system, sewers, roads, bridges, rail lines, telecoms .. you want this stuff to be <em>absolutely rock solid</em> and not novel in the least. That's what maybe 90 or 95% of FOSS is like, certainly the stuff that <em>needs</em> reliable corporate maintainers.</p><p>For corporate-employed FOSS maintainers working at a firm with these "growth and novelty" incentives -- CEMBIs -- this leads to a real quandry. They're in a position where their job performance is very likely to be evaluated in terms of visible growth and novelty (it might be dressed up in more abstract terms like "real-world impact" or "visibility" but it still means the same thing) even though that is exactly the wrong thing for the health of the project they're maintaining. The incentives are bad. If they do the <em>best</em> thing for the project <em>as infrastructure</em> -- triage and fix bugs from the backlog, optimize performance, increase security and reliability, pay down tech debt, simplify and automate ongoing maintenance -- the bias of their organization is likely to view them as "doing nothing", or at best doing "low-value work" that only counts as "reducing fixed costs", not leading the way towards new growth. To be seen in a positive light by their employer, the CEMBI winds uphaving to do essentially <em>anti-maintenance work</em>: make the program "do something new and exciting", that it didn't do yesterday. Ignore maintenance of "what is", focus on "what's next".</p><p>Seeing this over and over in FOSS makes me a bit sad. I guess I've maybe been watching too many re-runs of The West Wing lately, but while I've been thinking about this subject, I keep thinking of the "<a href="https://en.wikipedia.org/wiki/Let_Bartlet_Be_Bartlet">Let Bartlet Be Bartlet</a>" episode near the end of the first season, where the characters come around to the idea that maybe it'd be best to just do what they were elected to do. I keep thinking it'd be nice if employers could incentivize their employees to do what they were hired to do. To "<b>Let Maintainers Be Maintainers</b>". Maintaining FOSS isn't low-value work. It's <em>essential</em> work, stuff that you ignore at your medium and long-term peril. As a new homeowner I will make more salient analogies: it's testing the wiring for faults, testing the walls for mould, replacing the roof before it leaks. It's work that <em>has to be done</em> in order for FOSS to keep functioning over the long term. Software actually does "break down and wear out": requirements change; upstream and downstream platforms and libraries change incompatibly; patterns of usage change; hardware changes; new subsystems become performance bottlenecks; new bugs are discovered, some of which will be high severity security vulnerabilities, others will merely grow in importance as they're encountered more often. Software maintenance is <em>real and important work</em>, and if a company hires a maintainer of a project "in order to support the project", it's what that company should be incentivizing and evaluating those maintainers in terms of.</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Armed with traffic cones, protesters are immobilizing driverless cars (119 pts)]]></title>
            <link>https://www.npr.org/2023/08/26/1195695051/driverless-cars-san-francisco-waymo-cruise</link>
            <guid>37272801</guid>
            <pubDate>Sat, 26 Aug 2023 13:39:28 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.npr.org/2023/08/26/1195695051/driverless-cars-san-francisco-waymo-cruise">https://www.npr.org/2023/08/26/1195695051/driverless-cars-san-francisco-waymo-cruise</a>, See on <a href="https://news.ycombinator.com/item?id=37272801">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="storytext">
      <div id="res1195707564">
            <div data-crop-type="">
        <picture>
            <source srcset="https://media.npr.org/assets/img/2023/08/24/gettyimages-1529169379_custom-f2b47c72fca593e41bbbe81da6997a9de2e8cc0a-s400-c85.webp 400w,
https://media.npr.org/assets/img/2023/08/24/gettyimages-1529169379_custom-f2b47c72fca593e41bbbe81da6997a9de2e8cc0a-s600-c85.webp 600w,
https://media.npr.org/assets/img/2023/08/24/gettyimages-1529169379_custom-f2b47c72fca593e41bbbe81da6997a9de2e8cc0a-s800-c85.webp 800w,
https://media.npr.org/assets/img/2023/08/24/gettyimages-1529169379_custom-f2b47c72fca593e41bbbe81da6997a9de2e8cc0a-s900-c85.webp 900w,
https://media.npr.org/assets/img/2023/08/24/gettyimages-1529169379_custom-f2b47c72fca593e41bbbe81da6997a9de2e8cc0a-s1200-c85.webp 1200w,
https://media.npr.org/assets/img/2023/08/24/gettyimages-1529169379_custom-f2b47c72fca593e41bbbe81da6997a9de2e8cc0a-s1600-c85.webp 1600w,
https://media.npr.org/assets/img/2023/08/24/gettyimages-1529169379_custom-f2b47c72fca593e41bbbe81da6997a9de2e8cc0a-s1800-c85.webp 1800w" sizes="(min-width: 1300px) 763px, (min-width: 1025px) calc(100vw - 496px), (min-width: 768px) calc(100vw - 171px), calc(100vw - 30px)" type="image/webp">
            <source srcset="https://media.npr.org/assets/img/2023/08/24/gettyimages-1529169379_custom-f2b47c72fca593e41bbbe81da6997a9de2e8cc0a-s400-c85.jpg 400w,
https://media.npr.org/assets/img/2023/08/24/gettyimages-1529169379_custom-f2b47c72fca593e41bbbe81da6997a9de2e8cc0a-s600-c85.jpg 600w,
https://media.npr.org/assets/img/2023/08/24/gettyimages-1529169379_custom-f2b47c72fca593e41bbbe81da6997a9de2e8cc0a-s800-c85.jpg 800w,
https://media.npr.org/assets/img/2023/08/24/gettyimages-1529169379_custom-f2b47c72fca593e41bbbe81da6997a9de2e8cc0a-s900-c85.jpg 900w,
https://media.npr.org/assets/img/2023/08/24/gettyimages-1529169379_custom-f2b47c72fca593e41bbbe81da6997a9de2e8cc0a-s1200-c85.jpg 1200w,
https://media.npr.org/assets/img/2023/08/24/gettyimages-1529169379_custom-f2b47c72fca593e41bbbe81da6997a9de2e8cc0a-s1600-c85.jpg 1600w,
https://media.npr.org/assets/img/2023/08/24/gettyimages-1529169379_custom-f2b47c72fca593e41bbbe81da6997a9de2e8cc0a-s1800-c85.jpg 1800w" sizes="(min-width: 1300px) 763px, (min-width: 1025px) calc(100vw - 496px), (min-width: 768px) calc(100vw - 171px), calc(100vw - 30px)" type="image/jpeg">
            <img src="https://media.npr.org/assets/img/2023/08/24/gettyimages-1529169379_custom-f2b47c72fca593e41bbbe81da6997a9de2e8cc0a-s1100-c50.jpg" alt="" loading="lazy">
        </picture>
        
</div>
<div>
    <div>
        <p>
                Members of Safe Street Rebel place a cone on a self-driving Cruise car in San Francisco.
                <b aria-label="Image credit">
                    
                    Josh Edelson/AFP via Getty Images
                    
                </b>
                <b><b>hide caption</b></b>
            </p>


            <p><b><b>toggle caption</b></b>
    </p></div>

    <p><span aria-label="Image credit">
        
        Josh Edelson/AFP via Getty Images
        
    </span>
</p></div>
<div>
        <picture>
            <source data-original="https://media.npr.org/assets/img/2023/08/24/gettyimages-1529169379_custom-f2b47c72fca593e41bbbe81da6997a9de2e8cc0a-s1200.webp" type="image/webp">
            <source data-original="https://media.npr.org/assets/img/2023/08/24/gettyimages-1529169379_custom-f2b47c72fca593e41bbbe81da6997a9de2e8cc0a-s1200.jpg" type="image/jpeg">
            <img data-original="https://media.npr.org/assets/img/2023/08/24/gettyimages-1529169379_custom-f2b47c72fca593e41bbbe81da6997a9de2e8cc0a-s1200.jpg" alt="" src="https://media.npr.org/assets/img/2023/08/24/gettyimages-1529169379_custom-f2b47c72fca593e41bbbe81da6997a9de2e8cc0a-s1200.jpg">
        </picture>
    </div>
<div>
        <p>Members of Safe Street Rebel place a cone on a self-driving Cruise car in San Francisco.</p>
        <p><span aria-label="Image credit">
            
            Josh Edelson/AFP via Getty Images
            
        </span>
    </p></div>
   </div>
   <p>Two people dressed in dark colors and wearing masks dart into a busy street on a hill in San Francisco. One of them hauls a big orange traffic cone. They sprint toward a <a href="https://www.npr.org/2023/08/10/1193272085/san-francisco-has-lots-of-self-driving-cars-theyre-driving-first-responders-nuts">driverless car </a>and quickly set the cone on the hood.</p>   <p>The vehicle's side lights burst on and start flashing orange. And then, it sits there immobile.</p>   <p>"All right, looks good," one of them says after making sure no one is inside. "Let's get out of here." They hop on e-bikes and pedal off.</p>   <p>All it takes to render the technology-packed self-driving car inoperable is a traffic cone. If all goes according to plan, it will stay there, frozen, until someone comes and removes it. </p>   
   <p>An anonymous activist group called Safe Street Rebel is responsible for this so-called coning incident and dozens of others over the past few months.<strong> </strong>The group's goal is to incapacitate the driverless cars roaming San Francisco's streets as a protest against the city being used as a testing ground for this<strong> </strong>emerging technology.</p>   <p>Over the past couple of years, driverless cars have become ubiquitous throughout San Francisco. It began with human safety drivers on board who were there to make sure everything ran smoothly. And then, many cars started operating with no humans at all. </p>   <p>They're mostly run by Cruise, which is owned by GM, and Waymo, which is owned by Google parent company Alphabet. Both companies have <a href="https://www.wsj.com/articles/americas-most-tech-forward-city-has-doubts-about-self-driving-cars-d6b098e0">poured billions of dollars</a> into developing these autonomous vehicles. Neither Cruise nor Waymo responded to questions about why the cars can be disabled by traffic cones.</p>   
   
<!-- END ID="RES1195711343" CLASS="BUCKETWRAP INTERNALLINK INSETTWOCOLUMN INSET2COL " -->
   
   
<!-- END ID="RES1195712271" CLASS="BUCKETWRAP INTERNALLINK INSETTWOCOLUMN INSET2COL " -->
   
   
<!-- END ID="RES1195712538" CLASS="BUCKETWRAP INTERNALLINK INSETTWOCOLUMN INSET2COL " -->
   <p>Waymo says it has a permit for 250 cars and it deploys about 100 at any given time. Cruise says it runs 100 in San Francisco during the day and 300 at night. The Department of Motor Vehicles made Cruise <a href="https://www.nytimes.com/2023/08/18/technology/cruise-crash-driverless-car-san-francisco.html">cut that number in half</a> after one of its cars collided with a firetruck last week. </p>   <h3>Street theater protests are nothing new in San Francisco</h3>   <p>Earlier this month, the California Public Utilities Commission voted 3-1 to let the two companies <a href="https://www.npr.org/2023/08/10/1193272085/san-francisco-has-lots-of-self-driving-cars-theyre-driving-first-responders-nuts">run their vehicles at all hours of the day</a> picking up passengers like taxis.</p>   
   <p>The lead-up to the commission's vote prompted the Safe Street Rebel group to start "coning," as they call it.  Members have long used street theater shenanigans to gain attention in their fight against cars and to promote public transportation. </p>   <p>Coning driverless cars fits in line with a long history of protests against the impact of the tech industry on San Francisco. Throughout the years, activists have <a href="https://www.npr.org/sections/alltechconsidered/2013/12/17/251960183/in-a-divided-san-francisco-private-tech-buses-drive-tension">blockaded Google's private commuter buses</a> from picking up employees in the city. And when scooter companies flooded the sidewalks with electric scooters, people <a href="https://www.cnet.com/culture/the-mad-tale-of-the-electric-scooter-craze-with-bird-lime-and-spin-in-san-francisco/">threw them into San Francisco Bay</a>.</p>   <p>"Then there was the burning of Lime scooters in front of a Google bus," says Manissa Maharawal, an assistant professor at American University who has <a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/anti.12744">studied these protests</a>. </p>   <p>She points out that when tech companies test their products in the city, residents don't have much say in those decisions: "There's been various iterations of this where it's like, 'Oh, yep, let's try that out in San Francisco again,' with very little input from anyone who lives here."</p>   <p>That gets to the crux of Safe Street Rebel's protest. The group only agreed to speak to NPR if they could remain anonymous because it's unclear if what they're doing is legal.<strong> </strong></p>   <p>"We thought that putting cones on these [driverless cars] was a funny image that could captivate people," says one organizer. "One of these self-driving cars with billions of dollars of venture capital investment money and R&amp;D, just being disabled by a common traffic cone."</p>   <h3>First responders aren't happy with driverless cars</h3>   <p>Safe Street Rebel has <a href="https://www.safestreetrebel.com/conesf/">cataloged hundreds of near misses and blunders</a> with Cruise and Waymo vehicles over the past few months — even without traffic cones. </p>   <p>The cars have <a href="https://sfstandard.com/2023/07/12/watch-san-francisco-cruise-robotaxi-appears-to-almost-get-hit-by-bus/">run red lights</a>, <a href="https://www.dmv.ca.gov/portal/file/cruise_032323-pdf/">rear-ended a bus</a> and blocked crosswalks and bike paths. In one incident, dozens of confused cars <a href="https://www.cbsnews.com/sanfrancisco/news/dead-end-sf-street-plagued-with-confused-waymo-cars-trying-to-turn-around-every-5-minutes/">congregated in a residential cul-de-sac</a>, clogging the street. In another, a Waymo <a href="https://techcrunch.com/2023/06/06/a-waymo-self-driving-car-killed-a-dog-in-unavoidable-accident/">ran over and killed a dog</a>. </p>   
   <p>"We don't really need traffic cones to show how vulnerable they are," says the Safe Street Rebel<strong> </strong>organizer.</p>   <p>Both Cruise and Waymo say their vehicles are far safer than human drivers and compared to humans they've had relatively<strong> </strong>few incidents. They say they've driven millions of driverless miles without any human fatalities or life-threatening injuries. An Uber self-driving car, operating in full autonomous mode and with a safety driver in the vehicle, <a href="https://www.wired.com/story/uber-self-driving-car-fatal-crash/">killed a pedestrian in Arizona</a> in 2018.</p>   <div id="res1195817069">
            <div data-crop-type="">
        <picture>
            <source srcset="https://media.npr.org/assets/img/2023/08/24/undefined_custom-5d9e84b1a56d3ab8b4f65e946ae5d917e61024f5-s200-c85.webp 200w,
https://media.npr.org/assets/img/2023/08/24/undefined_custom-5d9e84b1a56d3ab8b4f65e946ae5d917e61024f5-s300-c85.webp 300w,
https://media.npr.org/assets/img/2023/08/24/undefined_custom-5d9e84b1a56d3ab8b4f65e946ae5d917e61024f5-s400-c85.webp 400w,
https://media.npr.org/assets/img/2023/08/24/undefined_custom-5d9e84b1a56d3ab8b4f65e946ae5d917e61024f5-s600-c85.webp 600w,
https://media.npr.org/assets/img/2023/08/24/undefined_custom-5d9e84b1a56d3ab8b4f65e946ae5d917e61024f5-s800-c85.webp 800w,
https://media.npr.org/assets/img/2023/08/24/undefined_custom-5d9e84b1a56d3ab8b4f65e946ae5d917e61024f5-s1600-c85.webp 1600w" sizes="(min-width: 1300px) 300px, (min-width: 1025px) 300px, (min-width: 768px) 252px, calc(100vw - 30px)" type="image/webp">
            <source srcset="https://media.npr.org/assets/img/2023/08/24/undefined_custom-5d9e84b1a56d3ab8b4f65e946ae5d917e61024f5-s200-c85.jpg 200w,
https://media.npr.org/assets/img/2023/08/24/undefined_custom-5d9e84b1a56d3ab8b4f65e946ae5d917e61024f5-s300-c85.jpg 300w,
https://media.npr.org/assets/img/2023/08/24/undefined_custom-5d9e84b1a56d3ab8b4f65e946ae5d917e61024f5-s400-c85.jpg 400w,
https://media.npr.org/assets/img/2023/08/24/undefined_custom-5d9e84b1a56d3ab8b4f65e946ae5d917e61024f5-s600-c85.jpg 600w,
https://media.npr.org/assets/img/2023/08/24/undefined_custom-5d9e84b1a56d3ab8b4f65e946ae5d917e61024f5-s800-c85.jpg 800w,
https://media.npr.org/assets/img/2023/08/24/undefined_custom-5d9e84b1a56d3ab8b4f65e946ae5d917e61024f5-s1600-c85.jpg 1600w" sizes="(min-width: 1300px) 300px, (min-width: 1025px) 300px, (min-width: 768px) 252px, calc(100vw - 30px)" type="image/jpeg">
            <img src="https://media.npr.org/assets/img/2023/08/24/undefined_custom-5d9e84b1a56d3ab8b4f65e946ae5d917e61024f5-s1100-c50.jpg" alt="" loading="lazy">
        </picture>
        
</div>
<div>
    <div>
        <p>
                A Waymo driverless car gets coned in San Francisco.
                <b aria-label="Image credit">
                    
                    Dara Kerr/NPR
                    
                </b>
                <b><b>hide caption</b></b>
            </p>


            <p><b><b>toggle caption</b></b>
    </p></div>

    <p><span aria-label="Image credit">
        
        Dara Kerr/NPR
        
    </span>
</p></div>
<div>
        <picture>
            <source data-original="https://media.npr.org/assets/img/2023/08/24/undefined_custom-5d9e84b1a56d3ab8b4f65e946ae5d917e61024f5-s1400.webp" type="image/webp">
            <source data-original="https://media.npr.org/assets/img/2023/08/24/undefined_custom-5d9e84b1a56d3ab8b4f65e946ae5d917e61024f5-s1400.jpg" type="image/jpeg">
            <img data-original="https://media.npr.org/assets/img/2023/08/24/undefined_custom-5d9e84b1a56d3ab8b4f65e946ae5d917e61024f5-s1400.jpg" alt="" src="https://media.npr.org/assets/img/2023/08/24/undefined_custom-5d9e84b1a56d3ab8b4f65e946ae5d917e61024f5-s1400.jpg">
        </picture>
    </div>
<div>
        <p>A Waymo driverless car gets coned in San Francisco.</p>
        <p><span aria-label="Image credit">
            
            Dara Kerr/NPR
            
        </span>
    </p></div>
   </div>
   <p>Safe Street Rebel isn't the only group that's had issues with the autonomous vehicles. San Francisco's police and fire departments have also said the cars <a href="https://www.npr.org/2023/08/10/1193272085/san-francisco-has-lots-of-self-driving-cars-theyre-driving-first-responders-nuts">aren't yet ready for public roads</a>. They've <a href="https://missionlocal.org/2023/08/cruise-waymo-autonomous-vehicle-robot-taxi-driverless-car-reports-san-francisco/">tallied 55 incidents where self-driving cars have gotten in the way of rescue operations</a> in just the past six months. </p>   <p>Those incidents include driving through yellow emergency tape, blocking firehouse driveways, <a href="https://missionlocal.org/2023/05/waymo-cruise-fire-department-police-san-francisco/">running over fire hoses</a> and refusing to move for first responders. </p>   <h3>Autonomous vehicles are programmed to be overly conservative</h3>   <p>Ziwen Wan, a Ph.D. candidate in computer science at University of California, Irvine, has <a href="https://www.universityofcalifornia.edu/news/autonomous-vehicles-can-be-tricked-dangerous-driving-behavior">studied why driverless cars may be acting this way</a>. He used open source data for his research, so his findings aren't based specifically on Cruise and Waymo. Wan found that ordinary objects on the road can lead to dangerous driving behavior. Part of this, he says, is because the cars are programmed to be overly conservative. </p>   <p>"The software can make the autonomous vehicle behave as conservatively as possible because a safety violation would be very serious," Wan says. "But this may lead to concerns on the other side, like in some cases, even though it's safe it will fail to drive normally."</p>   <p>That abnormal driving includes abrupt halts, swerves, erratic behavior or just stopping in the middle of the road. </p>   <p>"The traffic cone protest is an example of how things in the real world can really confound machines, even ones as sophisticated and finely tuned as this,"<strong> </strong>says<strong> </strong>Margaret O'Mara, a history professor at the University of Washington who <a href="https://www.margaretomara.com/">studies the tech industry</a>. "It's a reminder that in this very high-tech world, the most low-tech things can literally put a wrench in the machine."</p>   
   <p>Despite the bumps in the road, both Waymo and Cruise are rapidly expanding their robo-taxi programs throughout the U.S. Waymo is already giving rides in Phoenix and is testing with human safety drivers in Los Angeles and Austin. And Cruise is offering rides in Phoenix and Austin and testing in Dallas, Houston, Miami, Nashville and Charlotte.</p>   <p>Meanwhile, in San Francisco, members of Safe Street Rebel continue to go out at night and stalk the vehicles one cone at a time.</p>
</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[E-ink is so Retropunk (601 pts)]]></title>
            <link>https://rmkit.dev/eink-is-so-retropunk/</link>
            <guid>37272652</guid>
            <pubDate>Sat, 26 Aug 2023 13:21:16 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://rmkit.dev/eink-is-so-retropunk/">https://rmkit.dev/eink-is-so-retropunk/</a>, See on <a href="https://news.ycombinator.com/item?id=37272652">Hacker News</a></p>
<div id="readability-page-1" class="page"><article itemscope="" itemtype="http://schema.org/BlogPosting">

  

  <div itemprop="articleBody">
    <p>I’ve long been struggling to describe why e-ink is so much fun for me, but I
think I’ve finally realized what it is: <strong>e-ink is just so so so retropunk</strong>.</p>

<p><img src="https://i.imgur.com/8760cI9.jpg" alt=""></p>

<p>An e-ink device is a hacker’s dream - or at least, this hacker’s dream.  They
are a return to the magical feeling of computers of the 80s and 90s. It’s a
world where Microsoft and Apple never existed and we don’t have to suffer with
abstractions on top of abstractions.  It’s DOS for the 2020s. It’s graphing
calculators for grown-ups.</p>

<h2 id="features">Features</h2>

<p>The e-ink devices I favor are low powered ARM devices running linux without a
display server or gigabytes of RAM. Let’s break down why that’s so awesome:</p>

<ul>
  <li>Low Powered: They can last for weeks on a single charge</li>
  <li>ARM is a simple architecture with a low instruction count and even lower cost</li>
  <li>Linux: as much as I like it, Android is a complicated mess</li>
  <li>Apps are simple: they talk to the kernel to read input and draw directly to the framebuffer</li>
  <li>Low RAM and slow CPUs: There’s no room to build complicated stacks of software, which means no window managers, no browsers and definitely no electron apps</li>
</ul>

<p>As similar as they are to the computers of the early 90s, they are different in
some tangible ways:</p>

<ul>
  <li>The resolution is much higher than an old computer - The PPI is between 200 - 300</li>
  <li>All devices supports touch events, some even support a pen stylus</li>
  <li>They are super portable, weighing between 200 - 400 grams, with displays ranging from 6” to 10”</li>
</ul>

<h2 id="the-software">The Software</h2>

<p>Since the devices are niche, the software ecosystem is way more
<strong>homebrew</strong> (as in the Homebrew Computing Club): people write and share their
apps and the community is tight knit. The people who use eink devices are
enthusiasts: they’ve given up the joys of color displays to work on these
under-powered devices that are devoid of app stores, tracking pixels, pay to
play features and constant distractions. There’s no email on these devices,
there’s no chat or social networks, there’s only simple applications.</p>

<p>Don’t be fooled though: the device constraints lead to interesting and quirky
software. In the <a href="https://toltec-dev.org/">reMarkable eco-system</a>, there’s dozens of
applications, including:</p>

<ul>
  <li>multi-tasking application launchers like <a href="https://github.com/Eeems/oxide/">oxide</a> and <a href="https://github.com/rmkit-dev/rmkit/tree/master/src/remux">remux</a></li>
  <li><a href="https://github.com/timower/rM2-stuff">terminal emulators</a></li>
  <li>an <a href="https://github.com/bkirwi/folly">interactive fiction interpreter</a></li>
  <li>an <a href="https://github.com/bkirwi/sill">experimental shell that you can write into</a></li>
  <li>alternative ebook readers like <a href="https://github.com/koreader/koreader/">koreader</a> and <a href="https://github.com/LinusCDE/plato/">plato</a></li>
  <li>a <a href="https://rmkit.dev/apps/sas">simple app script that follows the unix philosphy</a></li>
  <li><a href="https://github.com/LinusCDE/chessmarkable">a chess board</a></li>
  <li>even a <a href="https://github.com/LinusCDE/doomarkable">port of doom</a></li>
  <li>and so <a href="https://rmkit.dev/">much more</a> - like <a href="https://toltec-dev.org/stable/">much, much, more</a></li>
</ul>

<p>Since eink is currently niche, it also means green fields: there are lots of
opportunities to write applications that fills out the ecosystem. In short, a
hacker’s playground.</p>

<h2 id="how-to-get-started">How to get started</h2>

<p>Convinced that you should hack on eink devices? Grab a reMarkable or Kobo and
get hacking ;) Join the <a href="https://discord.gg/hAKFTcuu">reMarkable discord
server</a> or browse the <a href="https://www.mobileread.com/forums/forumdisplay.php?f=247">Mobile Read Kobo
Forums</a>.</p>

<p>For reMarkable, the toltec repository is a good place to get started - one of
the maintainers, Eeems, <a href="https://eeems.website/toltec/">has written a great
tutorial</a>.</p>

<p>If you want more specific advice, feel free to directly <a href="https://rmkit.dev/about">get in touch</a></p>

<h2 id="why-write-a-post-now">Why write a post now?</h2>

<p>Several years ago, I started hacking on e-ink devices and had an enormous
amount of fun writing applications and seeing what others have built.
Unfortunately, I’ve had several false starts with writing about e-ink: whether
it was about what I’ve actually done, or the lessons learned along the way or
even a set of things to consider when developing e-ink apps, the posts would
lay half finished because they just never felt compelling - my enthusiasm for
e-ink just wasn’t coming through.</p>

<p>Instead of trying to push any of those posts to completion, I’ve decided to try
to articulate what is so cool about e-ink to me.</p>

<h2 id="appendix-hacker-unfriendly-devices">Appendix: Hacker unfriendly devices</h2>

<h4 id="kindles">Kindles</h4>

<p>The Kindle requires a jailbreak to use and is running a modified version of
Kindle Fire. The Kindle Scribe is still secured, though. For this reason, I don’t
particularly recommend the Kindle devices.</p>

<h4 id="onyx">Onyx</h4>

<p>In every eink thread that comes up, the Onyx is brought up as not following the
GPL: <a href="https://www.reddit.com/r/Onyx_Boox/comments/p9ztru/lets_help_onyx_become_a_better_company/">they use a modified linux kernel and haven’t published the source for it</a>.</p>

<h4 id="pine">Pine</h4>

<p>The Pine Note is cool and open, but it’s software is still in development. Use
only if you are willing to take on an <a href="https://wiki.pine64.org/wiki/PineNote#State_of_the_software">early product aimed at early adopters and
developers</a> - In other words,
maybe the Pine Note is too hacker friendly.</p>

  </div>

</article></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Fish – A friendly interactive shell (230 pts)]]></title>
            <link>https://github.com/fish-shell/fish-shell</link>
            <guid>37272611</guid>
            <pubDate>Sat, 26 Aug 2023 13:17:34 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://github.com/fish-shell/fish-shell">https://github.com/fish-shell/fish-shell</a>, See on <a href="https://news.ycombinator.com/item?id=37272611">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><h2 tabindex="-1" dir="auto"><a href="https://fishshell.com/" rel="nofollow">fish</a> - the friendly interactive shell <a href="https://github.com/fish-shell/fish-shell/actions"><img alt="Build Status" src="https://github.com/fish-shell/fish-shell/workflows/make%20test/badge.svg">
</a> <a href="https://cirrus-ci.com/github/fish-shell/fish-shell" rel="nofollow"><img alt="Cirrus CI Build Status" src="https://camo.githubusercontent.com/a3f090242fed30c7af9884c39e814e1e0ab15cecf6beb4797da42cbe6e4d4815/68747470733a2f2f6170692e6369727275732d63692e636f6d2f6769746875622f666973682d7368656c6c2f666973682d7368656c6c2e7376673f6272616e63683d6d6173746572" data-canonical-src="https://api.cirrus-ci.com/github/fish-shell/fish-shell.svg?branch=master"></a></h2>
<p dir="auto">fish is a smart and user-friendly command line shell for macOS, Linux,
and the rest of the family. fish includes features like syntax
highlighting, autosuggest-as-you-type, and fancy tab completions that
just work, with no configuration required.</p>
<p dir="auto">For downloads, screenshots and more, go to <a href="https://fishshell.com/" rel="nofollow">https://fishshell.com/</a>.</p>
<a name="user-content-quick-start"></a>
<h2 tabindex="-1" dir="auto">Quick Start</h2>
<p dir="auto">fish generally works like other shells, like bash or zsh. A few
important differences can be found at
<a href="https://fishshell.com/docs/current/tutorial.html" rel="nofollow">https://fishshell.com/docs/current/tutorial.html</a> by searching for the
magic phrase “unlike other shells”.</p>
<p dir="auto">Detailed user documentation is available by running <code>help</code> within
fish, and also at <a href="https://fishshell.com/docs/current/index.html" rel="nofollow">https://fishshell.com/docs/current/index.html</a></p>
<a name="user-content-getting-fish"></a>
<h2 tabindex="-1" dir="auto">Getting fish</h2>
<a name="user-content-macos"></a>
<h3 tabindex="-1" dir="auto">macOS</h3>
<p dir="auto">fish can be installed:</p>
<ul dir="auto">
<li>using <a href="http://brew.sh/" rel="nofollow">Homebrew</a>: <code>brew install fish</code></li>
<li>using <a href="https://www.macports.org/" rel="nofollow">MacPorts</a>:
<code>sudo port install fish</code></li>
<li>using the <a href="https://fishshell.com/" rel="nofollow">installer from fishshell.com</a></li>
<li>as a <a href="https://fishshell.com/" rel="nofollow">standalone app from fishshell.com</a></li>
</ul>
<p dir="auto">Note: The minimum supported macOS version is 10.10 "Yosemite".</p>
<a name="user-content-packages-for-linux"></a>
<h3 tabindex="-1" dir="auto">Packages for Linux</h3>
<p dir="auto">Packages for Debian, Fedora, openSUSE, and Red Hat Enterprise
Linux/CentOS are available from the <a href="https://software.opensuse.org/download.html?project=shells%3Afish&amp;package=fish" rel="nofollow">openSUSE Build
Service</a>.</p>
<p dir="auto">Packages for Ubuntu are available from the <a href="https://launchpad.net/~fish-shell/+archive/ubuntu/release-3" rel="nofollow">fish
PPA</a>,
and can be installed using the following commands:</p>
<pre>sudo apt-add-repository ppa:fish-shell/release-3
sudo apt update
sudo apt install fish
</pre>
<p dir="auto">Instructions for other distributions may be found at
<a href="https://fishshell.com/" rel="nofollow">fishshell.com</a>.</p>
<a name="user-content-windows"></a>
<h3 tabindex="-1" dir="auto">Windows</h3>
<ul dir="auto">
<li>On Windows 10, fish can be installed under the WSL Windows Subsystem
for Linux with the instructions for the appropriate distribution
listed above under “Packages for Linux”, or from source with the
instructions below.</li>
<li>Fish can also be installed on all versions of Windows using
<a href="https://cygwin.com/" rel="nofollow">Cygwin</a> (from the <strong>Shells</strong> category).</li>
</ul>
<a name="user-content-building-from-source"></a>
<h3 tabindex="-1" dir="auto">Building from source</h3>
<p dir="auto">If packages are not available for your platform, GPG-signed tarballs are
available from <a href="https://fishshell.com/" rel="nofollow">fishshell.com</a> and
<a href="https://github.com/fish-shell/fish-shell/releases">fish-shell on
GitHub</a>. See the
<a href="#building">Building</a> section for instructions.</p>
<a name="user-content-running-fish"></a>
<h2 tabindex="-1" dir="auto">Running fish</h2>
<p dir="auto">Once installed, run <code>fish</code> from your current shell to try fish out!</p>
<a name="user-content-dependencies"></a>
<h3 tabindex="-1" dir="auto">Dependencies</h3>
<p dir="auto">Running fish requires:</p>
<ul dir="auto">
<li>curses or ncurses (preinstalled on most *nix systems)</li>
<li>some common *nix system utilities (currently <code>mktemp</code>), in
addition to the basic POSIX utilities (<code>cat</code>, <code>cut</code>, <code>dirname</code>,
<code>ls</code>, <code>mkdir</code>, <code>mkfifo</code>, <code>rm</code>, <code>sort</code>, <code>tee</code>, <code>tr</code>,
<code>uname</code> and <code>sed</code> at least, but the full coreutils plus <code>find</code> and
<code>awk</code> is preferred)</li>
<li>The gettext library, if compiled with
translation support</li>
</ul>
<p dir="auto">The following optional features also have specific requirements:</p>
<ul dir="auto">
<li>builtin commands that have the <code>--help</code> option or print usage
messages require <code>nroff</code> or <code>mandoc</code> for
display</li>
<li>automated completion generation from manual pages requires Python 3.5+</li>
<li>the <code>fish_config</code> web configuration tool requires Python 3.5+ and a web browser</li>
<li>system clipboard integration (with the default Ctrl-V and Ctrl-X
bindings) require either the <code>xsel</code>, <code>xclip</code>,
<code>wl-copy</code>/<code>wl-paste</code> or <code>pbcopy</code>/<code>pbpaste</code> utilities</li>
<li>full completions for <code>yarn</code> and <code>npm</code> require the
<code>all-the-package-names</code> NPM module</li>
<li><code>colorls</code> is used, if installed, to add color when running <code>ls</code> on platforms
that do not have color support (such as OpenBSD)</li>
</ul>
<a name="user-content-switching-to-fish"></a>
<h3 tabindex="-1" dir="auto">Switching to fish</h3>
<p dir="auto">If you wish to use fish as your default shell, use the following
command:</p>
<pre>chsh -s /usr/local/bin/fish
</pre>
<p dir="auto"><code>chsh</code> will prompt you for your password and change your default
shell. (Substitute <code>/usr/local/bin/fish</code> with whatever path fish was
installed to, if it differs.) Log out, then log in again for the changes
to take effect.</p>
<p dir="auto">Use the following command if fish isn’t already added to <code>/etc/shells</code>
to permit fish to be your login shell:</p>
<pre>echo /usr/local/bin/fish | sudo tee -a /etc/shells
</pre>
<p dir="auto">To switch your default shell back, you can run <code>chsh -s /bin/bash</code>
(substituting <code>/bin/bash</code> with <code>/bin/tcsh</code> or <code>/bin/zsh</code> as
appropriate).</p>
<a name="user-content-building"></a>
<h2 tabindex="-1" dir="auto">Building</h2>
<a name="user-content-id1"></a>
<h3 tabindex="-1" dir="auto">Dependencies</h3>
<p dir="auto">Compiling fish from a tarball requires:</p>
<ul dir="auto">
<li>a C++11 compiler (g++ 4.8 or later, or clang 3.3 or later)</li>
<li>CMake (version 3.5 or later)</li>
<li>a curses implementation such as ncurses (headers and libraries)</li>
<li>PCRE2 (headers and libraries) - optional, this will be downloaded if missing</li>
<li>gettext (headers and libraries) - optional, for translation support</li>
</ul>
<p dir="auto">Sphinx is also optionally required to build the documentation from a
cloned git repository.</p>
<p dir="auto">Additionally, running the test suite requires Python 3.5+ and the pexpect package.</p>
<a name="user-content-dependencies-git-master"></a>
<h3 tabindex="-1" dir="auto">Dependencies, git master</h3>
<p dir="auto">Building from git master currently requires, in addition to the dependencies for a tarball:</p>
<ul dir="auto">
<li>Rust (version 1.67 or later)</li>
<li>libclang, even if you are compiling with GCC</li>
<li>an Internet connection</li>
</ul>
<p dir="auto">fish is in the process of being ported to Rust, replacing all C++ code, and as such these dependencies are a bit awkward and in flux.</p>
<p dir="auto">In general, we would currently not recommend running from git master if you just want to <em>use</em> fish.
Given the nature of the port, what is currently there is mostly a slower and buggier version of the last C++-based release.</p>
<a name="user-content-building-from-source-all-platforms-makefile-generator"></a>
<h3 tabindex="-1" dir="auto">Building from source (all platforms) - Makefile generator</h3>
<p dir="auto">To install into <code>/usr/local</code>, run:</p>
<div dir="auto" data-snippet-clipboard-copy-content="mkdir build; cd build
cmake ..
make
sudo make install"><pre>mkdir build<span>;</span> <span>cd</span> build
cmake ..
make
sudo make install</pre></div>
<p dir="auto">The install directory can be changed using the
<code>-DCMAKE_INSTALL_PREFIX</code> parameter for <code>cmake</code>.</p>
<a name="user-content-build-options"></a>
<h3 tabindex="-1" dir="auto">Build options</h3>
<p dir="auto">In addition to the normal CMake build options (like <code>CMAKE_INSTALL_PREFIX</code>), fish has some other options available to customize it.</p>
<ul dir="auto">
<li>BUILD_DOCS=ON|OFF - whether to build the documentation. This is automatically set to OFF when Sphinx isn't installed.</li>
<li>INSTALL_DOCS=ON|OFF - whether to install the docs. This is automatically set to on when BUILD_DOCS is or prebuilt documentation is available (like when building in-tree from a tarball).</li>
<li>FISH_USE_SYSTEM_PCRE2=ON|OFF - whether to use an installed pcre2. This is normally autodetected.</li>
<li>MAC_CODESIGN_ID=String|OFF - the codesign ID to use on Mac, or "OFF" to disable codesigning.</li>
<li>WITH_GETTEXT=ON|OFF - whether to build with gettext support for translations.</li>
</ul>
<p dir="auto">Note that fish does <em>not</em> support static linking and will attempt to error out if it detects it.</p>
<a name="user-content-help-it-didnt-build"></a>
<h3 tabindex="-1" dir="auto">Help, it didn’t build!</h3>
<p dir="auto">If fish reports that it could not find curses, try installing a curses
development package and build again.</p>
<p dir="auto">On Debian or Ubuntu you want:</p>
<pre>sudo apt install build-essential cmake ncurses-dev libncurses5-dev libpcre2-dev gettext
</pre>
<p dir="auto">On RedHat, CentOS, or Amazon EC2:</p>
<pre>sudo yum install ncurses-devel
</pre>
<a name="user-content-contributing-changes-to-the-code"></a>
<h2 tabindex="-1" dir="auto">Contributing Changes to the Code</h2>
<p dir="auto">See the <a href="https://github.com/fish-shell/fish-shell/blob/master/CONTRIBUTING.rst">Guide for Developers</a>.</p>
<a name="user-content-contact-us"></a>
<h2 tabindex="-1" dir="auto">Contact Us</h2>
<p dir="auto">Questions, comments, rants and raves can be posted to the official fish
mailing list at <a href="https://lists.sourceforge.net/lists/listinfo/fish-users" rel="nofollow">https://lists.sourceforge.net/lists/listinfo/fish-users</a>
or join us on our <a href="https://gitter.im/fish-shell/fish-shell" rel="nofollow">gitter.im
channel</a>. Or use the <a href="https://unix.stackexchange.com/questions/tagged/fish" rel="nofollow">fish tag
on Unix &amp; Linux Stackexchange</a>.
There is also a fish tag on Stackoverflow, but it is typically a poor fit.</p>
<p dir="auto">Found a bug? Have an awesome idea? Please <a href="https://github.com/fish-shell/fish-shell/issues/new">open an
issue</a>.</p>

</article>
          </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[This isn’t the way to speed up Rust compile times (105 pts)]]></title>
            <link>https://xeiaso.net/blog/serde-precompiled-stupid</link>
            <guid>37272445</guid>
            <pubDate>Sat, 26 Aug 2023 12:55:52 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://xeiaso.net/blog/serde-precompiled-stupid">https://xeiaso.net/blog/serde-precompiled-stupid</a>, See on <a href="https://news.ycombinator.com/item?id=37272445">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><div>
<div>
    <p><img src="https://cdn.xeiaso.net/sticker/cadey/coffee/64" alt="Cadey is coffee">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#cadey"><b>Cadey</b></a>&gt; By the way, this
problem was fixed with the release of <a href="https://github.com/serde-rs/serde/commit/360606b9a63ba4e594dc20ddf0e20228b60b34cb">serde
v1.0.185</a>.
Please enjoy the technical overview of the problem and problem space
regardless.</p></div>
<div>
    <p><img src="https://cdn.xeiaso.net/sticker/mara/happy/64" alt="Mara is happy">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#mara"><b>Mara</b></a>&gt; You could have read this a week
ago if you subscribed to
<a href="https://patreon.com/cadey">Patreon</a>.</p></div>
</div>
<p>Recently serde, one of the most popular Rust libraries made a decision
that supposedly sped up compile times by using a precompiled version
of a procedural macro instead of compiling it on the fly. Like any
technical decision, there are tradeoffs and advantages to everything.
I don't think the inherent ecosystem risks in slinging around
precompiled binaries are worth the build speed advantages, and in this
article I'm going to cover all of the moving parts for this space.</p>
<figure><picture><source type="image/avif" srcset="https://cdn.xeiaso.net/file/christine-static/hero/waifu-perch.avif"><source type="image/webp" srcset="https://cdn.xeiaso.net/file/christine-static/hero/waifu-perch.webp"><img loading="lazy" alt="hero image waifu-perch" src="https://cdn.xeiaso.net/file/christine-static/hero/waifu-perch-smol.png"></picture><figcaption>Anything v3 -- 1girl, green hair, green eyes, smile, hoodie, skirt, river, bridge in the distance, long hair, wearing uggs, summer, beach, space needle, crabs, -amputee</figcaption></figure>
<h2>serde</h2>
<p><a href="https://serde.rs/">serde</a> is one of the biggest libraries in the Rust
ecosystem. It provides the tooling for serializing and deserializing
(ser/de) arbitrary data structures into arbitrary formats. The main
difference between serde and other approaches is that serde <em>doesn't
prefer an individual encoding format</em>. Compare this struct in Rust vs
the equivalent struct in Go:</p>
<pre><code><span>#[</span><span>derive</span><span>(Debug, Deserialize, Eq, PartialEq, Clone, Serialize)]
</span><span>pub struct </span><span>WebMention {
</span><span>    </span><span>pub </span><span>source</span><span>: String,
</span><span>    </span><span>pub </span><span>title</span><span>: Option&lt;String&gt;,
</span><span>}
</span></code></pre>
<pre><code><span>type </span><span>WebMention </span><span>struct </span><span>{
</span><span>    </span><span>Source </span><span>string  </span><span>`</span><span>json:"source"</span><span>`
</span><span>    </span><span>Title</span><span>  *</span><span>string </span><span>`</span><span>json:"title"</span><span>`
</span><span>}
</span></code></pre>
<p>Besides syntax, the main difference is in how the
serialization/deserialization works. In Go the
<a href="https://pkg.go.dev/encoding/json">encoding/json</a> package uses
<a href="https://en.wikipedia.org/wiki/Reflective_programming">runtime
reflection</a> to
parse the structure metadata. This does work, but it's expensive
compared to having all that information already there.</p>
<p>The way serde works is by having an implementation of
<a href="https://docs.rs/serde/latest/serde/trait.Deserialize.html">Deserialize</a>
or
<a href="https://docs.rs/serde/latest/serde/trait.Serialize.html">Serialize</a>
on the data types you want to encode or decode. This effectively
pushes all of the data that is normally inspected at runtime with
reflection into compile-time data. In the process, this makes the code
run a little bit faster and more deterministically, but at the cost of
adding some time at compile time to determine that reflection data up
front.</p>
<p>I think this is a fair tradeoff due to the fundamental improvements in
developer experience. In Go, you have to declare the encoding/decoding
rules for every codec individually. This can lead to stuctures that
look like this:</p>
<pre><code><span>type </span><span>WebMention </span><span>struct </span><span>{
</span><span>    </span><span>Source </span><span>string  </span><span>`</span><span>json:"source" yaml:"source" toml:"source"</span><span>`
</span><span>    </span><span>Title</span><span>  *</span><span>string </span><span>`</span><span>json:"title" yaml:"title" toml:"source"</span><span>`
</span><span>}
</span></code></pre>
<div>
    <p><img src="https://cdn.xeiaso.net/sticker/aoi/wut/64" alt="Aoi is wut">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#aoi"><b>Aoi</b></a>&gt; Hey, in your code you have the
struct tag <code>toml:"source"</code> defined on the <code>Title</code> field, didn't you
mean to say <code>toml:"title"</code>?</p></div>

<div>
    <p><img src="https://cdn.xeiaso.net/sticker/cadey/coffee/64" alt="Cadey is coffee">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#cadey"><b>Cadey</b></a>&gt; Good catch! The fact that you
have to declare the same thing over and over again makes it ripe for
messing things up in annoyingly trivial ways. It would be so much
better if this was all declared once. Here's the correct way to tag
this struct:</p></div>
<pre><code><span>type </span><span>WebMention </span><span>struct </span><span>{
</span><span>    </span><span>Source </span><span>string  </span><span>`</span><span>json:"source" yaml:"source" toml:"source"</span><span>`
</span><span>    </span><span>Title</span><span>  *</span><span>string </span><span>`</span><span>json:"title" yaml:"title" toml:"title"</span><span>`
</span><span>}
</span></code></pre>
<p>This becomes unwieldy and can make your code harder to read. Some
codecs get around this by reading and using the same tag rules that
encoding/json does, but the Rust equivalent works for <em>any</em> codec that
can be serialized into or deserialized from. That same <code>WebMention</code>
struct works with JSON, YAML, TOML, <a href="https://msgpack.org/">msgpack</a>,
or anything else you can imagine. serde is one of the most used
packages for a reason: it's so convenient and widespread that it's
widely seen as being effectively in the standard library.</p>
<p>If you need to add additional behavior such as <a href="https://github.com/Xe/site/blob/f30057e759c604f7fcc700df6e1cbc6027af45f0/src/app/config/markdown_string.rs">parsing a string to
markdown</a>,
you can do that with your own implementation of the Deserialize trait.
I do this with the <a href="https://xeiaso.net/vods">VODs pages</a> in order to define my stream
VOD information in configuration. The markdown inside strings compiles
to the HTML you see <a href="https://xeiaso.net/vods/2023/3/cursorless">on the VOD
page</a>, including the
embedded video on <a href="https://xeiaso.net/blog/xedn">XeDN</a>. This is incredibly valuable to
me and something I really want to keep doing until I figure out how to
switch my site to using something like
<a href="https://www.contentlayer.dev/">contentlayer</a> and <a href="https://mdxjs.com/">MDX</a>.</p>
<div>
    <p><img src="https://cdn.xeiaso.net/sticker/mara/hacker/128" alt="Mara is hacker">
    </p>
    </div>
<h2>The downsides</h2>
<p>It's not all sunshine, puppies and roses though. The main downside to
the serde approach is the fact that it relies on a procedural macro.
Procedural macros are effectively lisp-style "syntax hygenic" macros.
Effectively you can view them as a function that takes in some syntax,
does stuff to it, and then returns the result to be compiled in the
program.</p>
<p>This is how it can derive the serialization/deserialization code, it
takes the tokens that make up the struct type, walks through the
fields, and inserts the correct serialization or deserialization code
so that you can construct values correctly. If it doesn't know how to
deal with a given type, it will blow up at compile-time, meaning that
you may need to resort to <a href="https://serde.rs/remote-derive.html">increasingly annoying
hacks</a> to get things working.</p>
<div>
    <p><img src="https://cdn.xeiaso.net/sticker/cadey/coffee/128" alt="Cadey is coffee">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#cadey"><b>Cadey</b></a>&gt; Pedantically, this
whole support works at the language token level, not at the type
level. You need to write wrappers around remote types in order to add
serde support because proc macros don't have access to the tokens that
make up other type definitions. You <em>could</em> do all of this at compile
time in theory with a perfectly spherical compiler that supports
type-level metaprogramming, but the Rust compiler of today can't do
that.</p></div>
<p>When you <a href="https://doc.rust-lang.org/reference/procedural-macros.html">write your own procedural
macro</a>,
you create a separate crate for this. This separate crate is compiled
against a special set of libraries that allow it to take tokens from
the Rust compiler and emit tokens back to the rust compiler. These
compiled proc macros are run as dynamic libraries inside invocations
of the Rust compiler. This means that proc macros can do <em>anything</em> as
the permissions of the Rust compiler, including crashing the compiler,
stealing your SSH key and uploading it to a remote server, running
arbitrary commands with sudo power, and much more.</p>
<div>
    <p><img src="https://cdn.xeiaso.net/sticker/mara/hacker/128" alt="Mara is hacker">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#mara"><b>Mara</b></a>&gt; To be fair, most
people do use this power for good. The library
<a href="https://github.com/launchbadge/sqlx">sqlx</a> will allow you to check
your query syntax against an actual database to ensure that your
syntax is correct (and so they don't have to implement a compliant
parser for every dialect/subdialect of SQL). You could also envision
many different worlds where people would do behavior that sounds
suspect (such as downloading API schema from remote servers), but it
provides such a huge developer experience advantage that the tradeoff
would be worth the downsides. Everything's a tradeoff.</p></div>
<h2>A victim of success</h2>
<p>Procedural macros are not free. They take nonzero amounts of time to
run because they are effectively extending the compiler with arbitrary
extra behavior at runtime. This gives you a lot of power to do things
like what serde does, but as more of the ecosystem uses it more and
more, it starts taking nontrivial amounts of time for the macros to
run. This causes more and more of your build time being spent waiting
around for a proc macro to finish crunching things, and if the proc
macro isn't written cleverly enough it will potentially waste time
doing the same behavior over and over again.</p>
<p>This can slow down build times, which make people investigate the
problem and (rightly) blame serde for making their builds slow.
Amusingly enough, serde is used by the Rust compiler rustc and package
manager cargo. This means that the extra time compiling proc macros
are biting literally everyone, including the Rust team.</p>
<div>
    <p><img src="https://cdn.xeiaso.net/sticker/mara/hmm/128" alt="Mara is hmm">
    </p>
    <div><p>&lt;<a href="https://xeiaso.net/characters#mara"><b>Mara</b></a>&gt; Keep in mind though
that the Rust compiler is already <em>very damn fast</em>. One of the
standard benchmarks we use across hardware is the "how fast do you
compile <a href="https://github.com/Xe/site">xesite</a>" test. Xesite is a fairly
complicated Rust program that uses a bunch of crates and weird
language features like the procedural macro
<a href="https://maud.lambda.xyz/">maud</a> to generate HTML. If you want to run
the benchmark for yourself, install
<a href="https://github.com/sharkdp/hyperfine">hyperfine</a> and run the
following command: <code></code></p><pre><code>hyperfine --prepare "cargo clean" "cargo
build --release"</code></pre><p>Here's the results on our new MacBook Pro
M2 Max:<code><pre>$ hyperfine --prepare "cargo clean" "cargo build --release"
Benchmark 1: cargo build --release
Time (mean ± σ):     41.872 s ±  0.295 s    [User: 352.774 s, System: 22.339 s]
Range (min … max):   41.389 s … 42.169 s    10 runs
</pre></code>In comparison, the homelab shellbox machine that
production builds are made on scores this much:<code><pre>hyperfine --prepare "cargo clean" "cargo build --release"
Benchmark 1: cargo build --release
Time (mean ± σ):     103.852 s ±  0.654 s    [User: 1058.321 s, System: 42.296 s]
Range (min … max):   102.272 s … 104.843 s    10
runs</pre></code>Procedural macros are plenty fast, it's always a
tradeoff because they always could be faster. For additional timing
information about xesite builds, look at the <a href="https://cdn.xeiaso.net/file/christine-static/blog/2023/serde/cargo-timing-20230819T184813Z.html">timing
report</a>.</p></div></div>
<h2>The change</h2>
<p>In essence, the change makes serde's derive macro use a precompiled
binary instead of compiling a new procedural macro binary every time
you build the serde_derive dependency. This removes the need for that
macro to be compiled from source, which can speed up build times
across the entire ecosystem in a few cases.</p>
<div>
    <p><img src="https://cdn.xeiaso.net/sticker/cadey/coffee/128" alt="Cadey is coffee">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#cadey"><b>Cadey</b></a>&gt; To be fair, this
precompiled binary fiasco only affects x86_84/amd64 Linux hosts. The
majority of CI runs on the planet use x86_64 Linux hosts. Given how
much of a meme "Rust has slow compile times" has become over the last
decade, it makes sense that something had to give. It would be nice if
this affected more than <em>cold</em> CI runs (IE: ones without a
pre-populated build cache), but I guess this is the best they can do
given the constraints of the compiler as it exists today.</p></div>
<p>However, this means that the most commonly used crate is shipping an
arbitrary binary for production builds without any way to opt-out.
This could allow a sufficiently determined attacker to use the
serde_derive library as a way to get code execution on <em>every CI
instance where Rust is used</em> at the same time.</p>
<div>
    <p><img src="https://cdn.xeiaso.net/sticker/aoi/wut/64" alt="Aoi is wut">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#aoi"><b>Aoi</b></a>&gt; Can't you do this anyways with a
proc macro given that it's a dynamic library in the
compiler?</p></div>

<div>
    <p><img src="https://cdn.xeiaso.net/sticker/cadey/coffee/64" alt="Cadey is coffee">
    </p>
    <div><p>&lt;<a href="https://xeiaso.net/characters#cadey"><b>Cadey</b></a>&gt; Well, yeah, sure. The main
difficulty is that when you're doing it in a proc macro you have to
have the code in a human-readable format somewhere along the line.
This would allow users to discover that the version of the code
distributed with the crate differs from the version inside source
control fairly trivially. Compare this to what you'd have to do in
order to determine if a binary is compiled from different source code.
That requires a completely different set of skills than comparing
source code.</p><p>
Combine that with the fact that the Rust ecosystem doesn't currently
have a solid story around cryptographic signatures for crates and you
get a pretty terrible situation all around.</p><a href="https://cdn.xeiaso.net/file/christine-static/blog/2023/serde/gpg-ux.jpg" target="_blank"><picture><source type="image/avif" srcset="https://cdn.xeiaso.net/file/christine-static/blog/2023/serde/gpg-ux.avif"><source type="image/webp" srcset="https://cdn.xeiaso.net/file/christine-static/blog/2023/serde/gpg-ux.webp"><img loading="lazy" alt="hero image blog/2023/serde/gpg-ux" src="https://cdn.xeiaso.net/file/christine-static/blog/2023/serde/gpg-ux-smol.png"></picture></a></div></div>
<p>But this does speed things up for everyone...at the cost of using serde
as a weapon to force ecosystem change.</p>
<p>In my testing the binary they ship is a statically linked Linux
binary:</p>
<pre><code><span>$ file ./serde_derive-x86_64-unknown-linux-gnu
</span><span>./serde_derive-x86_64-unknown-linux-gnu: ELF 64-bit LSB pie executable, x86-64, version 1 (SYSV), static-pie linked, BuildID[sha1]=b8794565e3bf04d9d58ee87843e47b039595c1ff, stripped
</span><span>
</span><span>$ ldd ./serde_derive-x86_64-unknown-linux-gnu
</span><span>        statically linked
</span></code></pre>
<div>
    <p><img src="https://cdn.xeiaso.net/sticker/mara/hacker/64" alt="Mara is hacker">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#mara"><b>Mara</b></a>&gt; Note: you should <a href="https://catonmat.net/ldd-arbitrary-code-execution">never run
<code>ldd</code> on untrusted
executables</a>. <code>ldd</code>
works by setting the environment variable <code>LD_TRACE_LOADED_OBJECTS=1</code>
and then executing the command. This causes your system's C dynamic
linker/loader to print all of the dependencies, however malicious
applications can and will still execute their malicious code even when
that environment variable is set. I've seen evidence of applications
exhibiting different malicious behavior when that variable is set.
Stay safe and use virtual machines when dealing with unknown
code.</p></div>


<details>
<summary>Out of date "file not found" error with a friend using cargo2nix</summary>
<div>
    <p><img src="https://cdn.xeiaso.net/sticker/cadey/coffee/128" alt="Cadey is coffee">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#cadey"><b>Cadey</b></a>&gt; This is out of
date. The friend of mine in question has since rebooted their system
and cannot reproduce this problem. We assume rac's machine got
bitflipped or something.</p></div>
<p>Frustratingly, a friend of mine that uses
<a href="https://github.com/cargo2nix/cargo2nix">cargo2nix</a> is reporting
getting a "file not found" error when trying to build programs
depending on serde. This is esepecially confusing given that the
binary is a statically linked binary, but I guess we'll figure out
what's going on in the future.</p>
<div>
    <p><img src="https://cdn.xeiaso.net/sticker/aoi/wut/64" alt="Aoi is wut">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#aoi"><b>Aoi</b></a>&gt; Wait, but if the proc macro binary
exists how could the file not be found?</p></div>

<div>
    <p><img src="https://cdn.xeiaso.net/sticker/mara/hacker/64" alt="Mara is hacker">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#mara"><b>Mara</b></a>&gt; That's the fun part. That error
message doesn't just show up when you ask the computer to run a binary
that doesn't exist. It also shows up when the binary is loading and
the kernel is loading the dynamically linked dependencies. So the
program binary can exist but if a dynamic dependecy doesn't, it'll
bail and fail like that.</p></div>

<div>
    <p><img src="https://cdn.xeiaso.net/sticker/cadey/coffee/64" alt="Cadey is coffee">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#cadey"><b>Cadey</b></a>&gt; Yeeep, this is one of the
worst errors in the Linux ecosystem. Don't feel bad about it being
confusing, this bites <em>everyone</em> eventually. The first time I
encountered it, I spent more time than I'm comfortable admitting
figuring it out. I had to resort to using strace. I felt like a
massive idiot when I figured it out.</p></div>
</details>
<p>There's also additional concerns around <a href="https://github.com/serde-rs/serde/issues/2538#issuecomment-1684117378">the binary in question not
being totally
reproducible</a>,
which is slightly concerning from a security standpoint. If we're
going to be trusting some random guy's binaries, I think we are in the
right to demand that it is byte-for-byte reproducible on commodity
hardware without having to reverse-engineer the build process and
figure out which <em>nightly version of the compiler</em> is being used to
compile this binary blob that will be run everywhere.</p>
<p>I also can't imagine that distribution maintainers are happy with this
now that Rust is basically required to be in distribution package
managers. It's unfortunate to see <a href="https://crates.io/">crates.io</a> turn
from a source code package manager to a binary package manager like
this.</p>
<div>
    <p><img src="https://cdn.xeiaso.net/sticker/numa/delet/64" alt="Numa is delet">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#numa"><b>Numa</b></a>&gt; Nah, trust me bro. It's totes a
legit binary, don't think about it so much and just run this arbitrary
code on your system. What could go wrong?</p></div>

<div>
    <p><img src="https://cdn.xeiaso.net/sticker/aoi/coffee/64" alt="Aoi is coffee">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#aoi"><b>Aoi</b></a>&gt; Uhhhh, a lot??? Especially if
this becomes a common practice that is validated by the biggest
project using it. This feels like it could have a massive chilling
effect across the entire ecosystem where this behavior becomes more
normalized and expected. I don't know if I'd want to see that become a
reality.</p></div>
<h3>This doesn't even make build times faster</h3>
<p>The most frustrating part about this whole affair is that while I was
writing the majority of this article, I assumed that it actually sped
up compliation. Guess what: it only speeds up compilation when you
are doing a brand new build without an existing build cache. In many
cases this means that you only gain the increased build speed in very
limited cases: when you are doing a brand new clean build or when you
update serde_derive.</p>
<div>
    <p><img src="https://cdn.xeiaso.net/sticker/aoi/wut/128" alt="Aoi is wut">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#aoi"><b>Aoi</b></a>&gt; I guess these are some
semi-common usecases where this would be useful, but I don't think
this is worth the extra threat vector.</p></div>
<p>This would be much more worth the tradeoff if it actually gave a
significant compile speed tradeoff, but in order for this to make
sense you'd need to be building many copies of serde_derive in your
CI builds constantly. Or you'd need to have every procedural macro in
the ecosystem also follow this approach. Even then, you'd probably
only save about 20-30 seconds in cold builds on extreme cases. I
really don't think it's worth it.</p>
<h2>The middle path</h2>
<p>Everything sucks here. This is a Kobayashi Maru situation. In order to
really obviate the need for these precompiled binary blobs being used
to sidestep compile time you'd need a complete redesign of the
procedural macro system.</p>
<div>
    <p><img src="https://cdn.xeiaso.net/sticker/cadey/angy/128" alt="Cadey is angy">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#cadey"><b>Cadey</b></a>&gt; Or, you'd need the
proper compile-time reflection support that
<a href="https://thephd.dev/">ThePHD</a> was going to work on until the whole
RustConf debacle happened. This would entirely obviate the need for
the derive macro serde uses in its current form. We could have had
nice things.</p></div>
<p>One of the huge advantages of the proc macro system as it currently
exists is that you can easily use any Rust library you want at compile
time. This makes doing things like generating C library bindings on
the fly using <a href="https://rust-lang.github.io/rust-bindgen/"><code>bindgen</code></a>
trivial.</p>
<div>
    <p><img src="https://cdn.xeiaso.net/sticker/aoi/wut/64" alt="Aoi is wut">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#aoi"><b>Aoi</b></a>&gt; How does that work though? It can't
do something awful like parsing the C/C++ headers manually, can
it?</p></div>

<div>
    <p><img src="https://cdn.xeiaso.net/sticker/numa/happy/64" alt="Numa is happy">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#numa"><b>Numa</b></a>&gt; That's the neat part, it
actually does do that by using <a href="https://clang.llvm.org/">clang</a>'s
C/C++ parser!</p></div>

<div>
    <p><img src="https://cdn.xeiaso.net/sticker/aoi/coffee/64" alt="Aoi is coffee">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#aoi"><b>Aoi</b></a>&gt; That's horrifying.</p></div>

<div>
    <p><img src="https://cdn.xeiaso.net/sticker/mara/hacker/64" alt="Mara is hacker">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#mara"><b>Mara</b></a>&gt; It is yeah, but this is what
you have to do in the real world to get things working. It's worth
noting that you don't have to always do this at compile time. You can
commit the intermediate code to your git repo or <a href="https://github.com/tailscale/pam/blob/main/cmd/pam_tailscale/src/pam.rs">write your bindings
by
hand</a>,
but I think it's better to take the build speed loss and have things
get generated for you so you can't forget to do it.</p></div>
<p>Maybe there could be a lot of speed to be gained with aggressive
caching of derived compiler code. I think that could solve a lot of
the issues at the cost of extra disk space being used. Disk space is
plenty cheap though, definitely cheaper than developer time. The
really cool advantage of making it at the derive macro level is that
it would also apply for traits like
<a href="https://doc.rust-lang.org/std/fmt/trait.Debug.html">Debug</a> and
<a href="https://doc.rust-lang.org/std/clone/trait.Clone.html">Clone</a> that are
commonly derived anyways.</p>
<p>I have no idea what the complexities and caveates of doing this would
be, but it could also be interesting to have the crate publishing step
do aggressive borrow checking logic for every supported platform but
then disable the borrow checker on crates downloaded from crates.io.
The borrow checker contributes a lot of time to the compilation
process, and if you gate acceptance to crates.io on the borrow checker
passing then you can get away without needing to run the extra borrow
checker logic when compiling dependencies.</p>
<div>
    <p><img src="https://cdn.xeiaso.net/sticker/aoi/wut/64" alt="Aoi is wut">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#aoi"><b>Aoi</b></a>&gt; Yeah but when the borrow checker
changes behavior slightly within the same Rust edition, what happens?
What if there is a bug that allows something to pass muster in one
version of rustc that shouldn't be allowed, making the code in
crates.io fundamentally wrong?</p></div>

<div>
    <p><img src="https://cdn.xeiaso.net/sticker/cadey/coffee/64" alt="Cadey is coffee">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#cadey"><b>Cadey</b></a>&gt; I claimed ignorance of the
problems for a reason! I realize that this would nearly impossible in
practice, but I feel like this could be more of a viable option than
telling people it's okay to put binaries in the mostly source-code
based package store that is
<a href="https://crates.io/">crates.io</a>.</p></div>
<details>
<summary>Tangent about using WebAssembly</summary>
<h3>WASM for procedural macros?</h3>
<div>
    <p><img src="https://cdn.xeiaso.net/sticker/aoi/wut/64" alt="Aoi is wut">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#aoi"><b>Aoi</b></a>&gt; Wait, how is this relevant here?
This seems like a nonsequitor, doing proc macro compliation/running
with WebAssembly would undoubtedly be slower, right? If only going by
the rule that a layer of abstraction is by definition more overhead
than not having it?</p></div>

<div>
    <p><img src="https://cdn.xeiaso.net/sticker/cadey/coffee/64" alt="Cadey is coffee">
    </p>
    <div><p>&lt;<a href="https://xeiaso.net/characters#cadey"><b>Cadey</b></a>&gt; The maintainer of serde is
also the creator of <a href="https://github.com/dtolnay/watt">watt</a>, a runtime
for executing precompiled procedural macros with WebAssembly. Adopting
a solution like this would vastly improve the security, isolation, and
reproducibility of procedural macros. I really wish this was more
widespread. With optimizations such as adopting
<a href="https://wasmtime.dev/">wasmtime</a> for executing these proc macros, it
could be made a lot faster on standard development/production
environments while also not leaving people on obscure targets like
rv64-gc in the dust.</p><p>I'm also pretty sure that there is an
easier argument to be made for shipping easily replicatable WASM blobs
<a href="https://ziglang.org/news/goodbye-cpp/">like Zig does</a> instead of
shipping around machine code like serde does.</p></div></div>
<p>One of the core issues with procedural macros is that they run
unsandboxed machine code. Sandboxing programs is basically impossible
to do cross-platform without a bunch of ugly hacks at every level.</p>
<p>I guess you'd need to totally rewrite the proc macro system to use
<a href="https://webassembly.org/">WebAssembly</a> instead of native machine
code. Doing this with WebAssembly would let the Rust compiler control
the runtime environment that applications would run under. This would
let packages do things like:</p>
<ul>
<li>Declare what permissions it needs and have permissions changes on
updates to the macros cause users to have to confirm them</li>
<li>Declare "cache storage" so that things like derive macro
implementations could avoid needing to recompute code that has
already passed muster.</li>
<li>Let people ship precompiled binaries without having to worry as much
about supporting every platform under the sun. The same binary would
run perfectly on every platform.</li>
<li>More easily prove reproducibility of the proc macro binaries,
especially if the binaries were built on the crates.io registry
server somehow.</li>
<li>Individually allow/deny execution of commands so that common
behaviors like <code>bindgen</code>, <code>pkg-config</code>, and compiling embedded C
source code continue working.</li>
</ul>
<p>This would require <em>a lot</em> of work and would probably break a lot of
existing proc macro behavior unless care was taken to make things as
compatible. One of the main pain points would be dealing with C
dependencies as it is nearly impossible* to deterministically prove
where the dependencies in question are located without running a bunch
of shell script and C code.</p>
<div>
    <p><img src="https://cdn.xeiaso.net/sticker/cadey/coffee/128" alt="Cadey is coffee">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#cadey"><b>Cadey</b></a>&gt; *If you are using
Nix, this is trivial, but sadly we aren't at a place where Nix is used
by everyone yet.</p></div>
<p>One of the biggest headaches would be making a WebAssembly JIT/VM that
would work well enough across platforms that the security benefits
would make up for the slight loss in execution speed. This is
annoyingly hard to sell given that the current state of the world is
suffering from long compilation times. It also doesn't help that
WebAssembly is still very relatively new so there's not yet the level
of maturity needed to make things stable. There is a POSIX-like layer
for WebAssembly programs called <a href="https://wasi.dev/">WASI</a> that does
bridge a lot of the gap, but it misses a lot of other things that
would be needed for full compatibility including network socket and
subprocess execution support.</p>
<div>
    <p><img src="https://cdn.xeiaso.net/sticker/mara/happy/128" alt="Mara is happy">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#mara"><b>Mara</b></a>&gt; There is an extension
to WASI called <a href="https://wasix.org/">WASIX</a> that does solve nearly all
of the compatibility problems, but WASIX isn't standard yet and my
runtime of choice <a href="https://wazero.io/">wazero</a> doesn't have out-of-the
box support for it yet. Hopefully <a href="https://github.com/tetratelabs/wazero/issues/1495">it will be supported
soon</a>! I just wish
it wasn't associated to the wasmer mark of Cain.</p></div>
</details>
<hr>
<p>This entire situation sucks. I really wish things were better.
Hopefully the fixes in
<a href="https://github.com/serde-rs/serde/pull/2580">serde-rs/serde#2580</a>
will be adopted and make this entire thing a non-issue. I understand
why the serde team is making the decisions they are, but I just keep
thinking that this isn't the way to speed up Rust compile times. There
has to be other options.</p>
<p>I don't know why they made serde a malware vector by adding this
unconditional precompiled binary in a patch release in exchange for
making cold builds in CI barely faster.</p>
<p>The biggest fear I have is that this practice becomes widespread
across the Rust ecosystem. I really hate that the Rust ecosystem seems
to have so much drama. It's scaring people away from using the tool to
build scalable and stable systems.</p>
<div>
    <p><img src="https://cdn.xeiaso.net/sticker/cadey/percussive-maintenance/64" alt="Cadey is percussive-maintenance">
    </p>
    <p>&lt;<a href="https://xeiaso.net/characters#cadey"><b>Cadey</b></a>&gt; I mean at some
level, to be in a community is to eventually cause conflict. I'm not
tired of the conflicts existing, I'm tired of the conflicts being
poorly handled and spilling out into GitHub hellthreads that leave
everyone unhappy. Let's hope this event doesn't spill out into even
more intelligent and highly capable people burning out and
leaving.</p></div>
</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[This venture-backed startup has quietly bought more than 80 mom-and-pop shops (207 pts)]]></title>
            <link>https://techcrunch.com/2023/08/24/this-venture-backed-startup-has-quietly-bought-more-than-80-mom-and-pop-shops/</link>
            <guid>37272298</guid>
            <pubDate>Sat, 26 Aug 2023 12:37:18 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://techcrunch.com/2023/08/24/this-venture-backed-startup-has-quietly-bought-more-than-80-mom-and-pop-shops/">https://techcrunch.com/2023/08/24/this-venture-backed-startup-has-quietly-bought-more-than-80-mom-and-pop-shops/</a>, See on <a href="https://news.ycombinator.com/item?id=37272298">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
				<p id="speakable-summary"><a href="https://www.teamshares.com/" target="_blank" rel="noopener">Teamshares</a> is a low-flying, New York-based startup with big ambitions to capitalize on an opportunity in plain sight: that of small businesses without a succession plan.</p>
<p>It’s not a small market. According to the U.S. Small Business Administration, small businesses represent 99.7% of U.S. employer firms and 64% of private-sector jobs. Meanwhile, just 15% or so of small business owners pass along their company to a family member, with many others simply closing up shop at some point.</p>
<p>With an aging population in the U.S., Teamshares is betting this market will grow even bigger, which is why since 2018, it has snapped up 84 small businesses from retiring owners. These owners like its pitch. Though Teamshares says that it sometimes pays below market price for a company, it installs a new president that it trains and grants 10% of the business’s stock to its employees. <span>Moreover</span>, it promises to increase those employees’ ownership to 80% within 20 years. It sounds almost valiant, like when KKR bought out a door company in 2015 and promised every employee a payout of at least $15,000 if the company met its targets when sold. When in 2022, KKR sold the company for 10 times what it paid, its 800 employees saw a payout of <a href="https://hbswk.hbs.edu/item/how-kkr-got-more-by-giving-ownership-to-the-factory-floor" target="_blank" rel="noopener">$360 million</a>.</p>
<p>But Teamshares isn’t in the private equity business. It’s a fintech company that has raised $245 million in venture capital to date, including from QED Investors, Spark Capital, Union Square Ventures, Inspired Capital, Khosla Ventures and Slow Ventures. It has also secured another $150 million in debt.</p>
<p>Those backers aren’t funding Teamshares so that it can grow and resell the businesses it acquires. In fact, according to co-founder and CEO Michael Brown, Teamshares doesn’t want to sell the companies it is buying — ever. The plan instead is to generate revenue from a growing array of fintech products that it sells to the businesses it buys. Think insurance, think credit cards. If everything goes as planned, Teamshares will eventually replace the majority of vendors these companies use — and become a brand known to many others outside of its immediate sphere. Certainly, it’s among the more unique fintech models this reporter can recall. More below, edited for length.</p>
<p><strong>TC: Other than some exceptions like KKR, which is focused in part on employee ownership because owners tend to be better employees, I don’t know of another venture-backed company doing what you’re doing. How did you settle on this broader idea?</strong></p>
<p>MB:&nbsp; I spent the first seven years of my career in investment banking. And that’s where I met <a href="https://www.linkedin.com/in/alexeu/" target="_blank" rel="noopener">Alex Eu</a> and <a href="https://www.linkedin.com/in/kevinshiiba/" target="_blank" rel="noopener">Kevin Shiiba</a>, the other two founders. Kevin decided he wanted to join the tech industry very early [and joined the] coding bootcamp General Assembly; Alex and I went and bought one, and then eventually eight, small businesses. We transitioned from being financial spreadsheet people to being operators and later entrepreneurs; learning how to operate a businesses informs [our work] today.</p>
<p><strong>How did you exit those businesses?</strong></p>
<p>We still own the ones in Canada; they’re running themselves today. There’s a president, a vice president. They’re just sort of like a dormant legacy business, but they’ve started the employee ownership journey, too, and that’s continuing on.</p>
<p><strong>You make money off those businesses through dividends? Is this how you’ll make money at Teamshares?</strong></p>
<p>How Teamshares makes money is we buy businesses, we dilute ourselves voluntarily to get employee ownership jump-started. We [carve out] 10% for all the employees and an additional 5% for [a president who we hire to run each business], and that stock is a gift — it’s earned over time through service.</p>
<p>From a financial standpoint, we’re [structured] just like Berkshire Hathaway, so if we buy a business with $5 million in revenue, then that becomes our revenue the next day. We profit from the profits of the business that was acquired, proportionate to our ownership, and we sell our stock back over time to the companies until it becomes 80% employee owned. We also have new revenue streams that we’ve just started launching. We built a neobank, we’re soon to launch credit cards, and we’re building an insurance business as well, so there’s a secondary layer of financial products that will basically replace the vendors that the companies used to use.</p>
<p><strong>These products are going to be available exclusively to Teamshares companies or you start there and expand out?</strong></p>
<p>The hope is the latter. We only build something if a product doesn’t exist for our exact use case, which is some combination of really traditional small business or employee ownership. And there’s not a lot of stuff [out there]. When we set out, we didn’t think we’d build a neobank, but there just wasn’t something that existed to our satisfaction, in part because small businesses still unfortunately receive a lot of checks. But the hope would be that in the future — let’s call it in the next five years — we could scale up and open these products up and have small businesses generally get to know Teamshares.</p>
<p><strong>What do the companies you’ve acquired so far have in common?</strong></p>
<p>Where <em>we</em> have commonality in the companies is around employee ownership, financial education, the president program and financial infrastructure. So, we’re audited by KPMG, for example, and we help these companies go from mom-and-pop accounting to having real financial infrastructure and being able to produce statement financials every month that are in accordance with GAAP. But we really believe in the companies [operating as] independently as possible. We provide support, and we work closely with the presidents. But we don’t think that it’s a good idea to try and integrate all the companies.</p>
<p><strong>So you aren’t trying to roll up similar companies, or swaths of similar companies?</strong></p>
<p>There are some exceptions where, for example, we’ve been buying pizza shops in a state back East, and those are being integrated to create one larger company that’s going to create more employee ownership wealth than could a stand-alone set of pizza shops. We’re doing this again in pool maintenance, where a lot of the businesses are really [small] and actually [buying] a first one that’s small but big enough to support the cost of a president, and then you can add smaller ones. So there’s a roll-up-esque element of certain companies we work with, but in general, we think these are really high-quality businesses that can operate fairly independently and we actually make a very devout customer promise that the companies are going to become 80% employee owned, or never for sale again.</p>
<p><strong>What’s your investing criteria?</strong></p>
<p>There are over 40 specific industries [represented in Teamshares’ current portfolio], but they really fall into about six categories, which are business services, consumer services, distribution, manufacturing, restaurants, and retail. So they’re all traditional businesses that are, on average, 30 years old, with annual revenue of between $2 million and $10 million generally.</p>
<p>We have a belief that employee ownership works in every industry, and our actual final decision — amongst the 70,000 leads we get every year — is all done on a case-by-case basis. But we start off by filtering the companies on what we call our structural criteria. So is it a true retirement sale? Are the owners of that age? Are there two or more managers? Is there low customer concentration? Do the earnings show up on the tax returns?</p>
<p><strong>You’re planning to sell these companies your products. Are there other ways the companies in the Teamshares ecosystem can work together?</strong></p>
<p>Absolutely. We’re now getting to the size where we’re starting to organize the companies, around industry groups. So there’s talk of the restaurant companies all kind of banding together [toward the goal of] common purchasing. The presidents [sometimes] share knowledge about what’s the best sort of ERP system and other software to use? Then there’s other things that don’t make sense for us to build but we can arrange large, corporate vendor partnerships. So, for example, you know, lots of these companies need vehicles, so having a national account with one of the major vehicle lessors is going to make sense.</p>
<p><strong>You mentioned Berkshire Hathaway early on. Is that what you aspire to build? Do you want Teamshares to go public?</strong></p>
<p>The most probable outcome is we go public, but there are ways to stay private, too. We do not plan to ever sell Teamshares; we would want it to be independent.</p>
<p>In terms of the Berkshire Hathaway piece, we subscribe to a lot of their philosophy about being very long-term minded and being pretty efficient in our underwriting and keeping things simple. But we’re not a one-for-one translation of the model. Their model is to have the permanent ownership forever, whereas our model has employee ownership as a twist, so we’re actually forgoing some amount of future growth by making employee ownership happen. And we believe that’s the right thing to do. And we believe the companies will be bigger and better for it.</p>
<p>Also Berkshire Hathaway can only buy companies that already have a CEO in place, whereas that’s not a luxury you can have in small business. We realized we had to build up a new generation of people, generally in their 30s and 40s, who were ready for something more entrepreneurial and ready for something really mission aligned. And so we recruit people from some really great companies — McKinsey, USAA, Tesla and Amazon — and train them to run these small businesses.</p>
<p><strong>How many employees do you have, and how big is your tech team?</strong></p>
<p>We have about 140 people altogether, and a 70-person tech team, so we’ve closed seven companies a month with two people. We’ve created a lot of leverage through building a lot of software for ourselves and for the companies.</p>
			</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[The EU’s Digital Services Act is now in effect (105 pts)]]></title>
            <link>https://www.theverge.com/23845672/eu-digital-services-act-explained</link>
            <guid>37271653</guid>
            <pubDate>Sat, 26 Aug 2023 11:01:26 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.theverge.com/23845672/eu-digital-services-act-explained">https://www.theverge.com/23845672/eu-digital-services-act-explained</a>, See on <a href="https://news.ycombinator.com/item?id=37271653">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><p>The European Union’s Digital Services Act (DSA) has officially gone into effect. Starting on August 25th, 2023, tech giants like Google, Facebook, Amazon, and more must comply with sweeping legislation that holds online platforms legally accountable for the content posted to them.</p><p>Even though this new law was passed in the EU, we’ll likely see far-reaching global effects as companies adjust their policies to comply. Here’s what exactly the DSA does and how the EU plans on enforcing it.</p><p><h3>What is the Digital Services Act?</h3></p><p>The overarching goal of the DSA is to foster safer online environments. Under the new rules, online platforms must implement ways to prevent and remove posts containing illegal goods, services, or content while simultaneously giving users the means to report this type of content.</p><p>Additionally, the DSA bans targeted advertising based on a person’s sexual orientation, religion, ethnicity, or political beliefs and puts restrictions on targeting ads to children. It also requires online platforms to provide more transparency on how their algorithms work. </p><p>The DSA carves out additional rules for what it considers “very large online platforms,” forcing them to give users the right to opt out of recommendation systems and profiling, share key data with researchers and authorities, cooperate with crisis response requirements, and perform external and independent auditing. </p><p>The European Parliament <a href="https://www.europarl.europa.eu/news/en/press-room/20220701IPR34364/digital-services-landmark-rules-adopted-for-a-safer-open-online-environment">passed the DSA in July 2022</a>. While the EU doesn’t require smaller companies to comply with the DSA just yet, it asked very large online platforms to comply four months after their designation as such, <a href="https://ec.europa.eu/commission/presscorner/detail/en/ip_23_2413">which occurred in April</a>.</p><p><h3>Which online platforms are affected?</h3></p><p>The EU considers very large online platforms (or very large online search engines) as those with over 45 million monthly users in the EU. So far, the EU has designed 19 platforms and search engines that fall into that category, including the following:</p><div><ul><li>Alibaba AliExpress</li><li>Amazon Store</li><li>Apple App Store</li><li>Booking.com</li><li>Facebook</li><li>Google Play</li><li>Google Maps</li><li>Google Shopping</li><li>Instagram</li><li>LinkedIn</li><li>Pinterest</li><li>Snapchat</li><li>TikTok</li><li>Twitter</li><li>Wikipedia</li><li>YouTube</li><li>Zalando</li><li>Bing</li><li>Google Search</li></ul></div><p>The EU will require each of these platforms to update their user numbers at least every six months. If a platform has less than 45 million monthly users for an entire year, they’ll be removed from the list.</p><p><h3>What are online platforms doing to comply?</h3></p><p>Many of these companies have already outlined the ways in which they’re going to comply with the DSA. Here’s a brief overview of the most notable ones.</p><p><h4>Google</h4></p><p>While Google says it already complies with some of the policies envisioned by the DSA, including the ability to give YouTube creators to appeal video removals and restrictions, <a href="https://www.theverge.com/2023/8/24/23845117/google-expanding-ads-transparency-center-comply-eu-dsa">Google announced that it’s expanding</a> its Ads Transparency Center to meet the requirements outlined by the legislation.</p><p>The company also committed to expanding data access to researchers to provide more information about “how Google Search, YouTube, Google Maps, Google Play and Shopping work in practice.” It will also improve its transparency reporting and analyze potential “risks of illegal content dissemination, or risks to fundamental rights, public health or civic discourse.”</p><p><h4>Meta</h4></p><p>Meta, the parent company of Facebook and Instagram, is working to expand its Ad Library, which currently compiles the ads shown on its platforms. The company will soon start displaying and archiving all the ads that target users in the EU while also including the parameters used to target the ads, as well as who was served the ad.</p><div><p>In June, Meta released <a href="https://www.theverge.com/2023/6/29/23778068/meta-facebook-instagram-social-media-algorithms-ai-transparency">a lengthy report about how its algorithm works</a> across Facebook and Instagram as part of its push toward transparency. It will also start <a href="https://www.theverge.com/2023/8/22/23841173/instagram-facebook-meta-chronological-feed-stories-reels-european-union-digital-services-act">allowing European users to view content chronologically on Reels</a>, Stories, and Search on both Facebook and Instagram — without being subject to its personalization engine.</p></div><p><h4>TikTok</h4></p><p>Similar to the measures Meta is rolling out, TikTok has also announced that it’s making its algorithm optional for users in the EU. When the algorithm is disabled, users will see videos from “both the places where they live and around the world” in their For You and Live feeds instead of videos based on personal interests. </p><p>It will also enable users to view content chronologically on their Following and Friends feeds. TikTok is making some changes to its advertising policies as well. For European users aged 13 to 17, TikTok will stop showing personalized ads based on their activity in the app.</p><p><h4>Snap</h4></p><p>Snapchat will also give users in the EU the option to opt out of personalized feeds on its Discover and Spotlight pages and <a href="https://help.snapchat.com/hc/en-us/articles/17338132910484-Personalisation-on-Snapchat?_ga=2.55027560.2100881955.1692971960-1974149196.1692971960">has also published reports</a> on how it ranks the posts on these feeds. The company has committed to providing users with more information about why their posts or account has been removed and will give them the tools they need to appeal the decision.</p><p>In addition, Snapchat will no longer serve personalized ads to European Snapchat users aged 13 to 17. It will also create an archive of targeted advertisements it shows in the EU and will give European Snapchat users over the age of 18 more control over the ads they see.</p><p><h3>What happens if these platforms don't comply?</h3></p><p>Online platforms that don’t comply with the DSA’s rules could see fines of up to 6 percent of their global turnover. <a href="https://ec.europa.eu/commission/presscorner/detail/en/QANDA_20_2348">According to the EU Commission</a>, the Digital Services Coordinator and the Commission&nbsp;will have the power to “require immediate actions where necessary to address very serious harms.” A platform continually refusing to comply could result in a temporary suspension in the EU.</p><p>The EU is already seeing some companies push back on the DSA. In July, Amazon filed a petition that asks the EU to reevaluate its classification as a very large online platform, claiming that it’s getting “unfairly singled out.” <a href="https://www.reuters.com/business/retail-consumer/zalando-sues-eu-commission-over-landmark-online-content-rules-2023-06-27/">German retailer Zalando also filed a lawsuit</a> against the EU Commission, similarly claiming that it doesn’t meet the definition of a very large online platform.</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Clean mount lists in Linux (171 pts)]]></title>
            <link>https://dbohdan.com/clean-mount-lists</link>
            <guid>37271611</guid>
            <pubDate>Sat, 26 Aug 2023 10:54:39 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://dbohdan.com/clean-mount-lists">https://dbohdan.com/clean-mount-lists</a>, See on <a href="https://news.ycombinator.com/item?id=37271611">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>

<p>Default installations of Linux distributions mount more filesystems than they used to. This is because of <a href="https://en.wikipedia.org/wiki/Loop_device">loop devices</a>, <a href="https://en.wikipedia.org/wiki/Cgroups">cgroups</a>, and, in Ubuntu, <a href="https://en.wikipedia.org/wiki/Snap_(software)">snaps</a>. As a result, the output from GNU df(1) as well as from <a href="https://en.wikipedia.org/wiki/Util-linux">lsblk(8) and mount(8)</a> is more difficult to understand at a glance.</p>
<p>It is possible to make the output of these commands more readable by removing some of the “noise” devices. The following is a list of command arguments that remove irrelevant devices. After the list, I show how to replace the default commands in <a href="https://fishshell.com/">fish</a>. You can adapt the replacement script for other shells.</p>
<h2 id="contents">Contents</h2>
<nav id="TOC" role="doc-toc">
<ul>
<li>
<a href="#df">df</a>
</li>
<li>
<a href="#lsblk">lsblk</a>
</li>
<li>
<a href="#mount">mount</a>
<ul>
<li>
<a href="#include-list">Include list</a>
</li>
<li>
<a href="#exclude-list">Exclude list</a>
</li>
<li>
<a href="#fish">fish configuration</a>
</li>
</ul>
</li>
<li>
<a href="#findmnt">findmnt instead of df and mount</a>
</li>
</ul>
</nav>
<h2 id="df">df</h2>
<p>GNU df(1) allows you to exclude <a href="https://en.wikipedia.org/wiki/Tmpfs">tmpfs</a> with a simple option. In Ubuntu 22.04, this removes <code>/dev/shm</code>, <code>/run</code>, <code>/run/user/*</code>, and other mount points from its output. In an improvement from Ubuntu 20.04, df(1) is already <a href="https://bugs.launchpad.net/ubuntu/+source/apt/+bug/1756595">patched</a> to exclude <a href="https://en.wikipedia.org/wiki/SquashFS">Squashfs</a> (snaps).</p>
<p>Command:</p>
<pre><code>df -x tmpfs</code></pre>
<p>The improvement on my system is as follows:</p>
<pre><code>&gt; df | wc -l
25
&gt; df -x tmpfs | wc -l
19</code></pre>
<h2 id="lsblk">lsblk</h2>
<p>The command lsblk(8) can exclude devices by major device type. Snaps are loopback devices. According to <a href="https://www.kernel.org/doc/Documentation/admin-guide/devices.txt"><code>devices.txt</code></a> in the Linux kernel admin guide, the device type for loopback devices is 7.</p>
<p>Command:</p>
<pre><code>lsblk -e 7</code></pre>
<p>Improvement:</p>
<pre><code>&gt; lsblk | wc -l
56
&gt; lsblk -e 7 | wc -l
28</code></pre>
<h2 id="mount">mount</h2>
<p>We can simplify the output of GNU mount(8) by either excluding certain filesystem types or only including certain filesystem types.</p>
<h3 id="include-list">Include list</h3>
<p>Example command:</p>
<pre><code>mount -l -t btrfs,fat,exfat,ext2,ext4,iso9660,ntfs3,ufs,vfat,xfs,zfs</code></pre>
<p>Choose the type based on what filesystems you work with. For a list of supported filesystem type, look in <code>/proc/filesystems</code> and <code>/lib/modules/"$(uname -r)"/kernel/fs/</code>.</p>
<h3 id="exclude-list">Exclude list</h3>
<p>This is a little more involved, since mount(8) seems to lack a built-in “exclude” option. We can filter the output by the type column with awk.</p>
<p>Example command:</p>
<pre><code>mount | awk '$5 !~ /(autofs|binfmt_misc|bpf|cgroup2|configfs|debugfs|devpts|devtmpfs|fuse|hugetlbfs|mqueue|nfsd|nsfs|proc|pstore|ramfs|rpc_pipefs|securityfs|squashfs|sysfs|tmpfs|tracefs)/'</code></pre>
<p>The improvement with the exclude list is,</p>
<pre><code>&gt; mount | wc -l
77
&gt; mount | awk '...' | wc -l
19</code></pre>
<h3 id="fish">fish configuration</h3>
<p>This configuration script replaces commands with wrappers that use arguments from the previous sections by default. They only use the arguments if you do not give arguments of your own. To ignore the wrapper and run, for example, <code>mount</code> without any arguments, use <code>command mount</code> or <code>mount --</code>.</p>
<h4 id="installation">Installation</h4>
<pre><code>cd ~/.config/fish/conf.d/
curl -O https://dbohdan.com/clean-mount-lists.fish
less clean-mount-lists.fish  # Examine the code.</code></pre>
<h4 id="source">Source</h4>
<pre><code># clean-mount-lists 0.2.0
# Wrap commands to show cleaner mount lists in Linux.
# See https://dbohdan.com/clean-mount-lists
# License: MIT.
# https://dbohdan.mit-license.org/@2023

if status is-interactive; and test "$(uname)" = Linux
    if not set --query clean_mount_lists_exclude
        set --universal clean_mount_lists_exclude \
            autofs binfmt_misc bpf cgroup2 configfs debugfs devpts \
            devtmpfs fuse hugetlbfs mqueue nfsd nsfs proc pstore ramfs \
            rpc_pipefs securityfs squashfs sysfs tmpfs tracefs
    end

    function df --wraps df
        if test (count $argv) -eq 0
            # `-x` requires GNU df(1).
            command df -h -x tmpfs
        else
            command df $argv
        end
    end

    function mount --wraps mount
        if test (count $argv) -eq 0
            set --local re (string join '|' $clean_mount_lists_exclude)

            command mount | awk -v re=$re '$5 !~ re'
        else
            command mount $argv
        end
    end

    function lsblk --wraps lsblk
        if test (count $argv) -eq 0
            command lsblk -e 7
        else
            command lsblk $argv
        end
    end
end
</code></pre>
<h2 id="findmnt">findmnt instead of df and mount</h2>
<p><a href="https://linux.die.net/man/8/findmnt">findmnt(8)</a> from util-linux is an alternative to df(1) and mount(8) with better options for filtering. For example,</p>
<pre><code>findmnt --df --options rw --real</code></pre>
<p>produces output like <code>df -h</code>, but only for real and read-write filesystems.</p>
<p>Thanks to the <a href="https://news.ycombinator.com/item?id=37271611">HN discussion thread</a> for suggesting findmnt(8) and the <code>--options rw --real</code> invocation.</p>


          </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[As I get older, I just don't care about new technology (160 pts)]]></title>
            <link>https://old.reddit.com/r/webdev/comments/1613yqj/as_i_get_older_i_just_dont_care_about_new/</link>
            <guid>37271401</guid>
            <pubDate>Sat, 26 Aug 2023 10:19:59 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://old.reddit.com/r/webdev/comments/1613yqj/as_i_get_older_i_just_dont_care_about_new/">https://old.reddit.com/r/webdev/comments/1613yqj/as_i_get_older_i_just_dont_care_about_new/</a>, See on <a href="https://news.ycombinator.com/item?id=37271401">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><p>Maybe it's just the depressive phase I'm currently in, or if I'm just getting older and have less and less patience for things, but I just don't care about new technology.</p>

<p>Trying to do this Next 12 -&gt; Next 13 upgrade is not fun work for a production app, and on top of that there is this whole new "app" concept in Next... and I just don't care. I adopted Turborepo and regret that 10x over.</p>

<p>I want to build things for people. Not constantly update my tools because other developers are bored.</p>

<p>(please take this all with a grain of salt. I'm tired and depressed and my coworkers are useless)</p>
</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[NES Emulator in Common Lisp (2016) (127 pts)]]></title>
            <link>https://github.com/samanthadoran/potential-disco</link>
            <guid>37271269</guid>
            <pubDate>Sat, 26 Aug 2023 10:01:54 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://github.com/samanthadoran/potential-disco">https://github.com/samanthadoran/potential-disco</a>, See on <a href="https://news.ycombinator.com/item?id=37271269">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-target="readme-toc.content">
            <article itemprop="text"><h2 tabindex="-1" dir="auto">potential-disco</h2>
<p dir="auto">Trying to emulate the NES again in Common Lisp</p>
<p dir="auto">TODO: Other mapppers besides NROM<br>
TODO: Audio<br>
TODO: Run at proper speed instead of just letting it go however fast it pleases.<br>
TODO: Write more idiomatic Lisp</p>
<h4 tabindex="-1" dir="auto">Examples</h4>
<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/44db2860bd2f8ad6ab26a51e4bf860a822f4e85ab3e9077f1168e520a2e60c6a/68747470733a2f2f692e6779617a6f2e636f6d2f35623862313631626537343238313235356534386236336462343561373238352e676966"><img src="https://camo.githubusercontent.com/44db2860bd2f8ad6ab26a51e4bf860a822f4e85ab3e9077f1168e520a2e60c6a/68747470733a2f2f692e6779617a6f2e636f6d2f35623862313631626537343238313235356534386236336462343561373238352e676966" alt="Super Mario Bros" data-animated-image="" data-canonical-src="https://i.gyazo.com/5b8b161be74281255e48b63db45a7285.gif"></a>
<a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/2d3447d9e5b3ad4174558df1047905c4c0558694704cd9e015e9a5f123d09e4c/68747470733a2f2f692e6779617a6f2e636f6d2f64396166346236663332613162363739306265343636323763323033353330362e676966"><img src="https://camo.githubusercontent.com/2d3447d9e5b3ad4174558df1047905c4c0558694704cd9e015e9a5f123d09e4c/68747470733a2f2f692e6779617a6f2e636f6d2f64396166346236663332613162363739306265343636323763323033353330362e676966" alt="Galaga" data-animated-image="" data-canonical-src="https://i.gyazo.com/d9af4b6f32a1b6790be46627c2035306.gif"></a>
<a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/ed8c3793ee37feefbef576d326c9d5d29edcd59846609841a43a2de90cf7c474/68747470733a2f2f692e6779617a6f2e636f6d2f65646663316463343234356365306266626266393961663865383438373065302e676966"><img src="https://camo.githubusercontent.com/ed8c3793ee37feefbef576d326c9d5d29edcd59846609841a43a2de90cf7c474/68747470733a2f2f692e6779617a6f2e636f6d2f65646663316463343234356365306266626266393961663865383438373065302e676966" alt="Donkey Kong" data-animated-image="" data-canonical-src="https://i.gyazo.com/edfc1dc4245ce0bfbbf99af8e84870e0.gif"></a>
<a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/1ae921f93fa87a01b0ef491f96a4f881f2110f8df0f784b412f9324768d80fb2/68747470733a2f2f692e6779617a6f2e636f6d2f65663231636436356466373236373636323633376337333561613430366264652e676966"><img src="https://camo.githubusercontent.com/1ae921f93fa87a01b0ef491f96a4f881f2110f8df0f784b412f9324768d80fb2/68747470733a2f2f692e6779617a6f2e636f6d2f65663231636436356466373236373636323633376337333561613430366264652e676966" alt="Volley Ball" data-animated-image="" data-canonical-src="https://i.gyazo.com/ef21cd65df7267662637c735aa406bde.gif"></a>
<a target="_blank" rel="noopener noreferrer nofollow" href="https://camo.githubusercontent.com/5b102ced9fb1c697db6b3c919ece21454a21445396600a911a2c572cd72929a8/68747470733a2f2f692e6779617a6f2e636f6d2f66366630373637663338303633383862393966623334333139303430366237312e706e67"><img src="https://camo.githubusercontent.com/5b102ced9fb1c697db6b3c919ece21454a21445396600a911a2c572cd72929a8/68747470733a2f2f692e6779617a6f2e636f6d2f66366630373637663338303633383862393966623334333139303430366237312e706e67" alt="NesTest" data-canonical-src="https://i.gyazo.com/f6f0767f3806388b99fb343190406b71.png"></a></p>
<h4 tabindex="-1" dir="auto">Usage</h4>
<p dir="auto">In your favorite common lisp repl (I haven't tested outside of
sbcl), just run</p>
<div data-snippet-clipboard-copy-content="(asdf:load-system :console)
(nes:setup-and-emulate path-to-rom)"><pre><code>(asdf:load-system :console)
(nes:setup-and-emulate path-to-rom)
</code></pre></div>
<p dir="auto">Where path to rom is a string<br>
The controls map to..
Start: Tab<br>
Select: Grave<br>
Left, Down, Right, Up: W, A, S, D<br>
A, B: Left Arrow, Down Arrow<br>
I'm sorry, they aren't re-mappable yet. =(</p>
</article>
          </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[66% of Americans say they want extended European-style vacation policies at work (129 pts)]]></title>
            <link>https://www.cnbc.com/2023/08/25/66percent-of-americans-say-they-want-extended-european-style-vacation-policies-at-work.html</link>
            <guid>37270881</guid>
            <pubDate>Sat, 26 Aug 2023 08:47:17 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.cnbc.com/2023/08/25/66percent-of-americans-say-they-want-extended-european-style-vacation-policies-at-work.html">https://www.cnbc.com/2023/08/25/66percent-of-americans-say-they-want-extended-european-style-vacation-policies-at-work.html</a>, See on <a href="https://news.ycombinator.com/item?id=37270881">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="MakeItRegularArticle-ArticleBody-5" data-module="ArticleBody" data-test="articleBody-1" data-analytics="MakeItRegularArticle-articleBody-5-1"><div><p>In many parts of Europe, it's common for workers to <a href="https://www.cnbc.com/2023/08/18/9-european-countries-where-workers-get-more-than-a-month-of-vacation.html">take off weeks at a time</a>, especially during the summer. Envious Americans say it's time for the U.S. to follow suit.</p><p>Some 66% of U.S. workers say companies should adopt extended vacation policies, like a month off in August, in their workplaces, according to a <a href="https://pro.morningconsult.com/analysis/us-sentiment-four-day-work-week" target="_blank">Morning Consult survey</a> of 1,047 U.S. adults.</p><p>While the average American is lucky to get <a href="https://www.bls.gov/charts/employee-benefits/paid-leave-sick-vacation-days-by-service-requirement.htm" target="_blank">11 vacation days</a> from their employer each year, workers in the European Union are guaranteed&nbsp;at least<a href="https://cepr.net/images/stories/reports/no-vacation-nation-2019-05.pdf#page=5" target="_blank">&nbsp;20 working days of paid vacation</a> due to the European Union Working Time Directive, which passed in the early 1990s. Several countries offer even more by law before paid public holidays come into play, which can add up to more than a month of business days in vacation time per year.</p><p>But not all U.S. workers say they'd welcome longer vacation policies: 21% of Americans say companies should not adopt extended PTO policies in their workplace, while the remaining respondents say they don't know or don't have an opinion.</p><p>The survey didn't specifically address the concerns of those against extended time off work, says Ellyn Briggs, brands analyst at Morning Consult. However, in responses to a separate question about people's attitudes toward a four-day workweek, roughly half of American workers say they'd use their extra time to catch up on work or learn a work-related skill.</p><p>Separately, 41% of U.S. workers report being more satisfied in their career today than before, which is nearly double the share of those who feel less satisfied in their career today, according to Morning Consult data. "These data points suggest a portion of employed U.S. adults generally enjoy their work and seek new opportunities to improve upon it," Briggs says. "Extended periods off may hold little appeal for this group."</p><p>That being said, generous vacations aren't the only European practice that Americans say should become the norm here: 65% of U.S. workers would like to see extended lunch breaks, 62% want workweeks shorter than 40 hours, and 51% support slower employee response time outside of work hours, similar to many labor laws common throughout Europe.</p><p><em><strong>Want to be smarter and more successful with your money, work &amp; life?&nbsp;</strong></em><a href="https://www.cnbc.com/makeitnewsletter/?__source=makeit%7Cnlarticleteaser"><em><strong>Sign up for our new newsletter</strong></em></a><em><strong>!</strong></em></p><p><em>Get CNBC's free&nbsp;</em><a href="https://www.cnbc.com/buffett-whitepaper/">Warren Buffett Guide to Investing</a><em>, which distills the billionaire's No. 1 best piece of advice for regular investors, do's and don'ts, and three key investing principles into a clear and simple guidebook.</em></p><p><em><strong>Check out: </strong></em><a href="https://www.cnbc.com/2023/07/09/how-a-norway-28-year-old-prepares-for-required-3-week-summer-vacation.html"><em><strong>28-year-old social media manager in Norway is required to take 3 weeks of vacation in summer</strong></em></a></p></div><div id="Placeholder-ArticleBody-Video-107268190" data-test="VideoPlaceHolder" role="region" tabindex="0" data-vilynx-id="7000306846" aria-labelledby="Placeholder-ArticleBody-Video-107268190"><p><img src="https://image.cnbcfm.com/api/v1/image/107268257-mm-torres-still.jpg?v=1688993102&amp;w=750&amp;h=422&amp;vtcrop=y" alt="How a Gen Z couple earning $43,000 in Nashville, Tennessee spends their money"><span></span><span><span data-test="PlayButton"></span></span></p></div></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Uncle Sam accuses SpaceX of not considering asylees and refugees for employment (102 pts)]]></title>
            <link>https://www.theregister.com/2023/08/25/spacex_discrimination_lawsuit/</link>
            <guid>37270634</guid>
            <pubDate>Sat, 26 Aug 2023 07:41:28 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.theregister.com/2023/08/25/spacex_discrimination_lawsuit/">https://www.theregister.com/2023/08/25/spacex_discrimination_lawsuit/</a>, See on <a href="https://news.ycombinator.com/item?id=37270634">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="body">
<p>Fresh from blowing up a small portion of Texas with Starship, SpaceX is once again being forced to focus on more earthly matters, like discriminatory hiring practices, in a lawsuit brought by the US Department of Justice.</p>
<p>The <a target="_blank" rel="nofollow" href="https://www.justice.gov/media/1311656/dl?inline">complaint</a> [PDF] filed Wednesday through the Office of the Chief Administrative Hearing Officer, part of the department's Executive Office for Immigration Review, accuses SpaceX of discriminating against asylees and refugees and "routinely" discouraging people with this citizenship status against even applying for roles at the company.</p>
<p>We're all used to CEO Elon Musk saying things of dubious veracity as the owner of <span>Twitter</span> X, but in this case the DoJ claims that statements from both SpaceX and its boss were so wrong they broke federal law, specifically the Immigration and Nationality Act (INA). The rules stipulate that asylees and refugees cannot be discriminated against for their citizenship status in the process of applying for job.</p>

    

<p>SpaceX fell foul of the law, the DoJ alleges, because it repeatedly and incorrectly claimed it could only hire US citizens and lawful permanent residents, thereby discouraging asylees and refugees from even bothering. Between September 2018 and May 2022, it was accused of tracking applicants by citizen status and marking asylees and refugees as ineligible for employment under the International Traffic in Arms Regulations (ITAR).</p>

        


        

<p>Explaining why this was way off-piste, the DoJ said in a <a target="_blank" href="https://www.justice.gov/opa/pr/justice-department-sues-spacex-discriminating-against-asylees-and-refugees-hiring">statement</a> yesterday: "Under these regulations, asylees, refugees, lawful permanent residents, US citizens and US nationals working at US companies can access export-controlled items without authorization from the US government. Therefore, these laws do not require SpaceX to treat asylees and refugees differently than US citizens or green card holders."</p>
<p>The DoJ added that asylees and refugees "undergo thorough vetting by the United States government. Under the INA, employers cannot discriminate against them in hiring, unless a law, regulation, executive order or government contract requires the employer to do so. In this instance, no law, regulation, executive order or government contract required or permitted SpaceX to engage in the widespread discrimination against asylees or refugees that the department's investigation found."</p>

        

<p>The complaint alleges that SpaceX's incorrect stance went right to the top, highlighting a number of times where Musk said that the working at the company was off-limits to anyone who wasn't a US citizen or lacked a green card.</p>
<p>On June 16, 2020, Musk posted on Twitter: "US law requires at least a green card to be hired at SpaceX, as rockets are considered advanced weapons technology."</p>
<p>It also said that during an international space conference in September 2016, "SpaceX's CEO stated the SpaceX had to comply with ITAR, which meant that a normal work visa is insufficient to work at SpaceX unless the company can obtain 'special permission from the Secretary of Defense or Secretary of State.' He then added that SpaceX is 'not allowed' to hire people who don't have a 'green card' and that 'unless [you] can somehow get a green card, we are legally prevented from hiring anyone.'"</p>
<ul>

<li><a href="https://www.theregister.com/2023/08/23/spacex_counter_omnispace/">SpaceX, T-Mobile US phone service will interfere with ours, claims rival</a></li>

<li><a href="https://www.theregister.com/2023/07/06/spacex_denies_environmental_lawsuit/">SpaceX says, sure, Starship blew up but you can forget about the rest of that lawsuit</a></li>

<li><a href="https://www.theregister.com/2023/05/10/vast_trip_space_station/">This upstart is selling tickets for a SpaceX trip to the world's first private space station</a></li>

<li><a href="https://www.theregister.com/2023/04/26/us_faa_starship/">US watchdog grounds SpaceX Starship after that explosion</a></li>
</ul>
<p>In an online video dating all the way back to 2012, the complaint quoted Musk as saying: "It's quite difficult for us to employ people that don't have a green card because of US ITAR rules." He added that his "first advice" to non-US citizens hoping for a job at SpaceX would be: "Do anything you can to get a green card."</p>
<p>The complaint also claimed that SpaceX's Vice President of Human Resources said on an online chat forum in 2016: "To comply with US government space technology export regulations including ITAR, applicants must generally be US citizens or lawful permanent residents."</p>

        

<p>The DoJ points out that not everyone working at SpaceX is a rocket scientist, also employing "welders, cooks, crane operators, baristas and dishwashers... The jobs at issue in the lawsuit are not limited to those that require advanced degrees."</p>
<p>Assistant Attorney General Kristen Clarke of the Justice Department's Civil Rights Division said: "Our investigation found that SpaceX failed to fairly consider or hire asylees and refugees because of their citizenship status and imposed what amounted to a ban on their hire regardless of their qualification, in violation of federal law.</p>
<p>"Our investigation also found that SpaceX recruiters and high-level officials took actions that actively discouraged asylees and refugees from seeking work opportunities at the company.</p>
<p>"Asylees and refugees have overcome many obstacles in their lives, and unlawful employment discrimination based on their citizenship status should not be one of them. Through this lawsuit we will hold SpaceX accountable for its illegal employment practices and seek relief that allows asylees and refugees to fairly compete for job opportunities and contribute their talents to SpaceX's workforce."</p>
<p>The suit seeks "fair consideration and back pay for asylees and refugees who were deterred or denied employment at SpaceX due to the alleged discrimination," civil penalties to be determined in court, and policy changes to ensure the company does not flout the INA again.</p>
<p>It could be that SpaceX has been erring on the side caution when it comes to ITAR because it has a number of lucrative contracts with NASA and the US Department of Defense. Accidental violation of export control laws and regulations could indeed put such contracts at risk.</p>
<p>However, by law, asylees and refugees should never fall under these restrictions, thus the DoJ believes SpaceX has, for lack of a better term, done goofed.</p>
<p><em>The Register</em> has asked SpaceX to comment. ®</p>                                
                    </div></div>]]></description>
        </item>
    </channel>
</rss>