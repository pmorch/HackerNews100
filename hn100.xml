<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>HN100 - Readable Contents</title>
        <link>https://hn.algolia.com/api/v1/search_by_date?tags=%28story,poll%29&amp;numericFilters=points%3E100</link>
        <description>Uses Readability to add bodies to the RSS feed</description>
        <lastBuildDate>Fri, 19 Apr 2024 08:00:06 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[SeaMonkey All-in-One Internet Application Suite (130 pts)]]></title>
            <link>https://www.seamonkey-project.org</link>
            <guid>40082372</guid>
            <pubDate>Fri, 19 Apr 2024 00:55:11 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.seamonkey-project.org">https://www.seamonkey-project.org</a>, See on <a href="https://news.ycombinator.com/item?id=40082372">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="mainContent">
        

<div id="product-desc">
    <h2><img src="https://www.seamonkey-project.org/images/seamonkey_logo.png" height="105" width="340" alt="SeaMonkey 2.53.18.2"></h2>
    <p>
      Web-browser, advanced e-mail, newsgroup and feed client, IRC chat, and
      HTML editing made simple—all your Internet needs in one application.
    </p>
    <ul>
      <li><a href="https://www.seamonkey-project.org/doc/features">Features</a> · <a href="https://www.seamonkey-project.org/doc/screenshots">Screenshots</a></li>
      <li><a href="https://www.seamonkey-project.org/releases/seamonkey2.53.18.2/">Release Notes</a></li>
    </ul>
  </div>






<p>
The SeaMonkey project is a community effort to develop the SeaMonkey
Internet Application Suite (see below).
Such a software suite was previously made popular by Netscape and Mozilla,
and the SeaMonkey project continues to develop and deliver high-quality updates
to this concept. Containing an Internet browser, email &amp; newsgroup client
with an included web feed reader, HTML editor, IRC chat and web development
tools, SeaMonkey is sure to appeal to advanced users, web developers and
corporate users.
</p>

<p>
Under the hood, SeaMonkey uses much of the same Mozilla Firefox source code
which powers such products as <a href="https://www.thunderbird.net/">
Thunderbird</a>. Legal backing is provided by the SeaMonkey Association
(SeaMonkey e.V.).
</p>

<h2><p><a href="https://www.seamonkey-project.org/news-atom" title="SeaMonkey News - Atom 1.0 feed"><img src="https://www.seamonkey-project.org/images/feed.png" height="16" width="16" alt=""></a></p><a href="https://www.seamonkey-project.org/news">Project News</a></h2>


<h4>March 28, 2024</h4>
<p><strong>SeaMonkey 2.53.18.2 released</strong></p>

<p>
The SeaMonkey project is proud to present SeaMonkey 2.53.18.2: The new
release of the all-in-one Internet suite is
<a href="https://www.seamonkey-project.org/releases/2.53.18.2">available for free download now</a>!
</p>
<p>
2.53.18.2 is a minor bugfix release on the 2.53.x branch and contains a crash
fix and a few other fixes to the application from the underlying platform code.
</p>
<p>
SeaMonkey 2.53.18.2 is available in 23 languages, for Windows, macOS x64 and
Linux.
</p>
<p>
<b>Automatic upgrades from previous 2.53.x versions are enabled for this
release, but if you have problems with it please download the full installer
from the downloads section and install SeaMonkey 2.53.18.2 manually over the
previous version.</b><br>
</p>
<p>
For a more complete list of major changes in SeaMonkey 2.53.18.2, see the
<a href="https://www.seamonkey-project.org/releases/seamonkey2.53.18.2/#new">What's New in SeaMonkey 2.53.18.2</a>
section of the <a href="https://www.seamonkey-project.org/releases/seamonkey2.53.18.2/">Release Notes</a>, which
also contains a list of known issues and answers to frequently asked questions.
For a more general overview of the SeaMonkey project (and <a href="https://www.seamonkey-project.org/doc/screenshots">screen shots</a>!), visit <a href="https://www.seamonkey-project.org/">www.seamonkey-project.org</a>.
</p>
<p>
We encourage users to <a href="https://www.seamonkey-project.org/dev/get-involved">get involved</a> in discussing
and reporting problems as well as further improving the product.
</p>
    
<h4>November 14, 2023</h4>
<p><strong>SeaMonkey 2.53.18 Beta 1 released</strong></p>

<p>
The SeaMonkey project is proud to present SeaMonkey 2.53.18 Beta 1: The new
beta test release of the all-in-one Internet suite is
<a href="https://www.seamonkey-project.org/releases/2.53.18b1">available for free download now</a>!
</p>
<p>
2.53.18 will be an incremental update on the 2.53.x branch and incorporates a
number of enhancements, changes and fixes to the application as well as those
from the underlying platform code. Support for parsing and processing newer
regexp expressions has been added helping with web compatibility on more than a
few sites. Crash reporting has been switched over to
<a href="https://www.bugsplat.com/">BugSplat</a>. We also added many fixes and
backports for overall platform stability.
</p>
<p>
<b>Before installing the new version make a full backup of
your profile and thoroughly read and follow the
<a href="https://www.seamonkey-project.org/releases/seamonkey2.53.18/">Release Notes</a></b>. We encourage
testers to <a href="https://www.seamonkey-project.org/dev/get-involved">get involved</a> in discussing and
reporting problems as well as further improving the product.
</p>
<p>
SeaMonkey 2.53.18 Beta 1 is available in 23 languages, for Windows, macOS x64
and Linux.
</p>
    
<h4>November  6, 2022</h4>
<p><strong>SeaMonkey and macOS Ventura</strong></p>

<p>
Attention macOS users! The current SeaMonkey release crashes during startup
after upgrading to macOS 13 Ventura. Until we have a fix we advise you not to
upgrade your macOS installation to Ventura. No usable crash information is
generated and this might take a bit longer than usual to fix. This is not a
problem with Monterey 12.6.1 or any lower supported macOS version so might even
be an Apple bug.
</p>
<p>
The problem is tracked in <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1797696">Bug 1797696</a>.
</p>

<h2>The SeaMonkey Internet Application Suite</h2>
<p>
SeaMonkey has inherited the successful all-in-one concept of the original
Netscape Communicator and continues that product line based on the modern,
cross-platform architecture provided by the
<a href="http://www.mozilla.org/">Mozilla project</a>.
</p>
<ul>
<li>The <a href="https://www.seamonkey-project.org/doc/features#browser">Internet browser</a> at the core of
  the SeaMonkey Internet Application Suite uses the same rendering engine and
  application platform as Mozilla Firefox, with popular features like tabbed
  browsing, feed detection, popup blocking, smart location bar, find as you
  type and a lot of other functionality for a smooth web experience.</li>
<li>SeaMonkey's <a href="https://www.seamonkey-project.org/doc/features#mail">Mail and Newsgroups</a> client
  shares lots of code with Thunderbird and features adaptive Junk mail
  filtering, tags and mail views, web feeds reading, tabbed messaging, multiple
  accounts, S/MIME, address books with LDAP support and is ready for both
  private and corporate use.</li>
<li>Additional components include an easy-to-use
  <a href="https://www.seamonkey-project.org/doc/features#composer">HTML Editor</a>, the ChatZilla IRC chat
  application and web development tools like a DOM Inspector.</li>
<li>If that's still not enough, SeaMonkey can be extended with numerous
  <a href="https://addons.thunderbird.net/seamonkey/">Add-Ons</a> that provide
  additional functionality and customization for a complete Internet
  experience.</li>
</ul>


        <address>                
        </address>

      </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Women Who Code Closing (110 pts)]]></title>
            <link>https://womenwhocode.com/blog/the-end-of-an-era-women-who-code-closing</link>
            <guid>40081761</guid>
            <pubDate>Thu, 18 Apr 2024 23:20:08 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://womenwhocode.com/blog/the-end-of-an-era-women-who-code-closing">https://womenwhocode.com/blog/the-end-of-an-era-women-who-code-closing</a>, See on <a href="https://news.ycombinator.com/item?id=40081761">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><div>
<figure><img src="https://admin.womenwhocode.dev/wp-content/uploads/2024/04/Header-Equal-Pay-Day-1-1-1024x576.png" alt=""></figure>
</div><p>Women Who Code started as a community group in 2011 by a small team of engineers in San Francisco who were seeking connection and support for navigating the tech industry. The movement grew, city by city, fueled by passionate volunteers that were inspired by the mission and vision. In 2013, Women Who Code, Inc., was registered as a 501(c)3 non-profit organization in California and moved its headquarters to Atlanta, Georgia in 2018.&nbsp;&nbsp;&nbsp;&nbsp;</p><p>As a community, we are powerful. For more than a decade, Women Who Code has created a sense of belonging in tech and support for our community, thanks to the dedication and commitment of our members, volunteers, and staff. We have brought together a vibrant community of over 360,000 technologists who deeply care about building an industry that is more diverse, inclusive, and equitable. Today, more than 1,000 volunteers lead local and digital communities, members in 145 countries worldwide give technical talks daily to share knowledge and mentor each other, and a close-knit globally distributed team at WWCode HQ drives the day to day operations.&nbsp;</p><p>Together, we’ve delivered more than 20 thousand community-led events, awarded more than $3.5 million in scholarships, held developer conferences and technical summits in tech hubs around the world, logged more than one million high-skilled, leadership-building volunteer hours, given away more than $2.5 million in conference tickets for broader industry engagement, and shared more than 14,000 job opportunities. Even more than these trackable outputs, we’ve come together to support each other, navigate the industry as a powerful force, share both technical protips and strategies for rising in our careers, and break barriers.&nbsp;</p><p>It is with profound sadness that, today, on April 18, 2024, we are announcing the difficult decision to close Women Who Code, following a vote by the Board of Directors to dissolve the organization. This decision has not been made lightly. It only comes after careful consideration of all options and is due to factors that have materially impacted our funding sources - funds that were critical to continuing our programming and delivering on our mission. We understand that this news will come as a disappointment to many, and we want to express our deepest gratitude to each and every one of you who have been a part of our journey.</p><div>
<figure><img src="https://admin.womenwhocode.dev/wp-content/uploads/2024/04/Quote-Journey-of-Success-From-Education-to-Early-Career-Triumphs-Part-1-1024x576.png" alt=""></figure>
</div><p><strong><em>While so much has been accomplished, our mission is not complete and our vision of a tech industry where diverse women and historically excluded people thrive at every level is not fulfilled.</em></strong></p><p>Despite our collective efforts, the challenges we face as an organization have become insurmountable. We are deeply saddened by the difficult decision to dissolve the entity, but we hope that this work carries on beyond our end. The collective efforts of tech company leaders and supporters are needed more than ever to welcome women into tech, keep them, and ensure they are given the opportunity to thrive.&nbsp;</p><p>To the women in technology, if you have been inspired, made a career connection, leveled up your technical skills, or expanded your network through this movement, we encourage you to keep paying that forward. The world needs women and diverse perspectives at the helm of tech as a critical force that shapes our world every day. Please, keep going.&nbsp;</p><p>As we embark on the process of winding down operations, we are committed to ensuring a smooth transition and fulfilling any remaining obligations to the best of our ability. Unfortunately, we will not be able to continue offering any program services, and will be canceling all upcoming events.&nbsp;</p><p>Although this chapter is coming to a close, we believe that the spirit of our community will endure and hope that the relationships and experiences gained through involvement with Women Who Code will continue to inspire you in your future endeavors.&nbsp;</p><p>On behalf of the Board of Directors and the entire Team Teal at Women Who Code, we extend our heartfelt thanks to everyone who has been a part of the movement – our members, volunteers, partners, team, allies, and supporters – and encourage you to continue to seek support from other like-minded organizations who authentically support the careers of women in the tech industry and keep inspiring each other as you navigate the industry. It has been an honor and a privilege to serve the mission, and work alongside such passionate individuals.</p><p>Thank you for your understanding and support during this challenging time.</p><p><strong>Team Teal @ Women Who Code</strong></p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Calculus Made Easy (298 pts)]]></title>
            <link>https://calculusmadeeasy.org/prologue.html</link>
            <guid>40081541</guid>
            <pubDate>Thu, 18 Apr 2024 22:44:52 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://calculusmadeeasy.org/prologue.html">https://calculusmadeeasy.org/prologue.html</a>, See on <a href="https://news.ycombinator.com/item?id=40081541">Hacker News</a></p>
<div id="readability-page-1" class="page">
<p>Considering how many fools can calculate, it is
surprising that it should be thought either a difficult
or a tedious task for any other fool to learn how to
master the same tricks.

</p><p>Some calculus-tricks are quite easy. Some are
enormously difficult. The fools who write the textbooks
of advanced mathematics — and they are mostly
clever fools — seldom take the trouble to show you how
easy the easy calculations are. On the contrary, they
seem to desire to impress you with their tremendous
cleverness by going about it in the most difficult way.

</p><p>Being myself a remarkably stupid fellow, I have
had to unteach myself the difficulties, and now beg
to present to my fellow fools the parts that are not
hard. Master these thoroughly, and the rest will
follow. What one fool can do, another can.


<br>
</p><hr>
<a href="https://calculusmadeeasy.org/1.html">Next →</a><br>
<a href="https://calculusmadeeasy.org/">Main Page ↑</a><br>




<!-- Google tag (gtag.js) -->


</div>]]></description>
        </item>
        <item>
            <title><![CDATA[The Rust Calling Convention We Deserve (191 pts)]]></title>
            <link>https://mcyoung.xyz/2024/04/17/calling-convention/</link>
            <guid>40081314</guid>
            <pubDate>Thu, 18 Apr 2024 22:13:13 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://mcyoung.xyz/2024/04/17/calling-convention/">https://mcyoung.xyz/2024/04/17/calling-convention/</a>, See on <a href="https://news.ycombinator.com/item?id=40081314">Hacker News</a></p>
<div id="readability-page-1" class="page"><div> <p>I will often say that the so-called “C ABI” is a very bad one, and a relatively unimaginative one when it comes to passing complicated types effectively. A lot of people ask me “ok, what would you use instead”, and I just point them to the <a href="https://go.googlesource.com/go/+/refs/heads/dev.regabi/src/cmd/compile/internal-abi.md">Go register ABI</a>, but it seems most people have trouble filling in the gaps of what I mean. This article explains what I mean in detail.</p> <p>I have discussed <a href="https://mcyoung.xyz//2021/11/09/assembly-1/#the-calling-convention">calling conventions</a> in the past, but as a reminder: the <em>calling convention</em> is the part of the ABI that concerns itself with how to pass arguments to and from a function, and how to actually call a function. This includes which registers arguments go in, which registers values are returned out of, what function prologues/epilogues look like, how unwinding works, etc.</p> <p>This particular post is primarily about x86, but I intend to be reasonably generic (so that what I’ve written applies just as well to ARM, RISC-V, etc). I will assume a general familiarity with x86 assembly, LLVM IR, and Rust (but not rustc’s internals).</p> <h2 id="the-problem"><a href="#the-problem">The Problem</a></h2> <p>Today, like many other natively compiled languages, Rust defines an unspecified0- calling convention that lets it call functions however it likes. In practice, Rust lowers to LLVM’s built-in C calling convention, which LLVM’s prologue/epilogue codegen generates calls for.</p> <p>Rust is fairly conservative: it tries to generate LLVM function signatures that Clang could have plausibly generated. This has two significant benefits:</p> <ol> <li> <p>Good probability debuggers won’t choke on it. This is not a concern on Linux, though, because DWARF is very general and does not bake-in the Linux C ABI. We will concern ourselves only with ELF-based systems and assume that debuggability is a nonissue.</p> </li> <li> <p>It is less likely to tickle LLVM bugs due to using ABI codegen that Clang does not exercise. I think that if Rust tickles LLVM bugs, we should actually fix them (a very small number of rustc contributors do in fact do this).</p> </li> </ol> <p>However, we are too conservative. We get terrible codegen for simple functions:</p> <div> <div><figure><pre><code data-lang="rust"><span>fn</span> <span>extract</span><span>(</span><span>arr</span><span>:</span> <span>[</span><span>i32</span><span>;</span> <span>3</span><span>])</span> <span>-&gt;</span> <span>i32</span> <span>{</span>
  <span>arr</span><span>[</span><span>1</span><span>]</span>
<span>}</span></code></pre></figure></div> <div><figure><pre><code data-lang="cpp"><span>extract:</span>
  <span>mov</span>   <span>eax</span><span>,</span> <span>dword</span> <span>ptr</span> <span>[</span><span>rdi</span> <span>+</span> <span>4</span><span>]</span>
  <span>ret</span></code></pre></figure></div> </div> <p><code>arr</code> is 12 bytes wide, so you’d think it would be passed in registers, but no! It is passed by pointer! Rust is actually <em>more</em> conservative than what the Linux C ABI mandates, because it actually passes the <code>[i32; 3]</code> in registers when <code>extern "C"</code> is requested.</p> <div> <div><figure><pre><code data-lang="rust"><span>extern</span> <span>"C"</span> <span>fn</span> <span>extract</span><span>(</span><span>arr</span><span>:</span> <span>[</span><span>i32</span><span>;</span> <span>3</span><span>])</span> <span>-&gt;</span> <span>i32</span> <span>{</span>
  <span>arr</span><span>[</span><span>1</span><span>]</span>
<span>}</span></code></pre></figure></div> <div><figure><pre><code data-lang="cpp"><span>extract:</span>
  <span>mov</span>   <span>rax</span><span>,</span> <span>rdi</span>
  <span>shr</span>   <span>rax</span><span>,</span> <span>32</span>
  <span>ret</span></code></pre></figure></div> </div> <p>The array is passed in <code>rdi</code> and <code>rsi</code>, with the <code>i32</code>s packed into registers. The function moves <code>rdi</code> into <code>rax</code>, the output register, and shifts the upper half down.</p> <p>Not only does clang produce patently <em>bad</em> code for passing things by value, but it also knows how to do it better, if you request a standard calling convention! We could be generating <em>way</em> better code than Clang, but we don’t!</p> <p>Hereforth, I will describe how to do it.</p> <h3 id="-zcallconv"><a href="#-zcallconv"><code>-Zcallconv</code></a></h3> <p>Let’s suppose that we keep the current calling convention for <code>extern "Rust"</code><sup id="fnref:just-use-extern-c" role="doc-noteref"><a href="#fn:just-use-extern-c" rel="footnote">1</a></sup>, but we add a flag <code>-Zcallconv</code> that sets the calling convention for <code>extern "Rust"</code> when compiling a crate. The supported values will be <code>-Zcallconv=legacy</code> for the current one, and <code>-Zcallconv=fast</code> for the one we’re going to design. We could even let <code>-O</code> set <code>-Zcallconv=fast</code> automatically.</p> <p>Why keep the old calling convention? Although I did sweep debugability under the rug, one nice property <code>-Zcallconv=fast</code> will not have is that it does not place arguments in the C ABI order, which means that a reader replying on the “Diana’s silk dress cost $89” mnemonic on x86 will get fairly confused.</p> <p>I am also assuming we may not even support <code>-Zcallconv=fast</code> for some targets, like WASM, where there is no concept of “registers” and “spilling”. It may not even make sense to enable it for for debug builds, because it will produce much worse code with optimizations turned off.</p> <p>There is also a mild wrinkle with function pointers, and <code>extern "Rust" {}</code> blocks. Because this flag is per-crate, even though functions can advertise which version of <code>extern "Rust"</code> they use, function pointers have no such luxury. However, calling through a function pointer is slow and rare, so we can simply force them to use <code>-Zcallconv=legacy</code>. We can generate a shim to translate calling conventions as needed.</p> <p>Similarly, we can, in principle, call any Rust function like this:</p> <div><figure><pre><code data-lang="rust"><span>fn</span> <span>secret_call</span><span>()</span> <span>-&gt;</span> <span>i32</span> <span>{</span>
  <span>extern</span> <span>"Rust"</span> <span>{</span>
    <span>fn</span> <span>my_func</span><span>()</span> <span>-&gt;</span> <span>i32</span><span>;</span>
  <span>}</span>
  <span>unsafe</span> <span>{</span> <span>my_func</span><span>()</span> <span>}</span>
<span>}</span></code></pre></figure></div> <p>However, this mechanism can only be used to call unmangled symbols. Thus, we can simply force <code>#[no_mangle]</code> symbols to use the legacy calling convention.</p> <h2 id="bending-llvm-to-our-will"><a href="#bending-llvm-to-our-will">Bending LLVM to Our Will</a></h2> <p>In an ideal world, LLVM would provide a way for us to specify the calling convention directly. E.g., this argument goes in that register, this return goes in that one, etc. Unfortunately, adding a calling convention to LLVM requires writing a bunch of C++.</p> <p>However, we can get away with specifying our own calling convention by following the following procedure.</p> <ol> <li> <p>First, determine, for a given target triple, the maximum number of values that can be passed “by register”. I will explain how to do this below.</p> </li> <li> <p>Decide how to pass the return value. It will either fit in the output registers, or it will need to be returned “by reference”, in which case we pass an extra <code>ptr</code> argument to the function (tagged with the <code>sret</code> attribute) and the actual return value of the function is that pointer.</p> </li> <li> <p>Decide which arguments that have been passed by value need to be demoted to being passed by reference. This will be a heuristic, but generally will be approximately “arguments larger than the by-register space”. For example, on x86, this comes out to 176 bytes.</p> </li> <li> <p>Decide which arguments get passed by register, so as to maximize register space usage. This problem is NP-hard (it’s the knapsack problem) so it will require a heuristic. All other arguments are passed on the stack.</p> </li> <li> <p>Generate the function signature in LLVM IR. This will be all of the arguments that are passed by register encoded as various non-aggregates, such as <code>i64</code>, <code>ptr</code>, <code>double</code>, and <code>&lt;2 x i64&gt;</code>. What valid choices are for said non-aggregates depends on the target, but the above are what you will generally get on a 64-bit architecture. Arguments passed on the stack will follow the “register inputs”.</p> </li> <li> <p>Generate a function prologue. This is code to decode each Rust-level argument from the register inputs, so that there are <code>%ssa</code> values corresponding to those that would be present when using <code>-Zcallconv=legacy</code>. This allows us to generate the same code for the body of the function regardless of calling convention. Redundant decoding code will be eliminated by DCE passes.</p> </li> <li> <p>Generate a function exit block. This is a block that contains a single <code>phi</code> instruction for the return type as it would be for <code>-Zcallconv=legacy</code>. This block will encode it into the requisite output format and then <code>ret</code> as appropriate. All exit paths through the function should <code>br</code> to this block instead of <code>ret</code>-ing.</p> </li> <li> <p>If a non-polymorphic, non-inline function may have its address taken (as a function pointer), either because it is exported out of the crate or the crate takes a function pointer to it, generate a shim that uses <code>-Zcallconv=legacy</code> and immediately tail-calls the real implementation. This is necessary to preserve function pointer equality.</p> </li> </ol> <p>The main upshot here is that we need to cook up heuristics for figuring out what goes in registers (since we allow reordering arguments to get better throughput). This is equivalent to the knapsack problem; knapsack heuristics are beyond the scope of this article. This should happen early enough that this information can be stuffed into <code>rmeta</code> to avoid needing to recompute it. We may want to use different, faster heuristics depending on <code>-Copt-level</code>. Note that correctness requires that we forbid linking code generated by multiple different Rust compilers, which is already the case, since Rust breaks ABI from release to release.</p> <h3 id="what-is-llvm-willing-to-do"><a href="#what-is-llvm-willing-to-do">What Is LLVM Willing to Do?</a></h3> <p>Assuming we do that, how do we actually get LLVM to pass things in the way we want it to? We need to determine what the largest “by register” passing LLVM will permit is. The following LLVM program is useful for determining this on a particular version of LLVM:</p> <div><figure><pre><code data-lang="llvm"><span>%InputI</span> <span>=</span> <span>type</span> <span>[</span><span>6</span> <span>x</span> <span>i64</span><span>]</span>
<span>%InputF</span> <span>=</span> <span>type</span> <span>[</span><span>0</span> <span>x</span> <span>double</span><span>]</span>
<span>%InputV</span> <span>=</span> <span>type</span> <span>[</span><span>8</span> <span>x</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;]</span>

<span>%OutputI</span> <span>=</span> <span>type</span> <span>[</span><span>3</span> <span>x</span> <span>i64</span><span>]</span>
<span>%OutputF</span> <span>=</span> <span>type</span> <span>[</span><span>0</span> <span>x</span> <span>double</span><span>]</span>
<span>%OutputV</span> <span>=</span> <span>type</span> <span>[</span><span>4</span> <span>x</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;]</span>

<span>define</span> <span>void</span> <span>@inputs</span><span>({</span> <span>%InputI</span><span>,</span> <span>%InputF</span><span>,</span> <span>%InputV</span> <span>})</span> <span>{</span>
  <span>%p</span> <span>=</span> <span>alloca</span> <span>[</span><span>4096</span> <span>x</span> <span>i8</span><span>]</span>
  <span>store</span> <span>volatile</span> <span>{</span> <span>%InputI</span><span>,</span> <span>%InputF</span><span>,</span> <span>%InputV</span> <span>}</span> <span>%0</span><span>,</span> <span>ptr</span> <span>%p</span>
  <span>ret</span> <span>void</span>
<span>}</span>

<span>%Output</span> <span>=</span> <span>{</span> <span>%OutputI</span><span>,</span> <span>%OutputF</span><span>,</span> <span>%OutputV</span> <span>}</span>
<span>@gOutput</span> <span>=</span> <span>constant</span> <span>%Output</span> <span>zeroinitializer</span>
<span>define</span> <span>%Output</span> <span>@outputs</span><span>()</span> <span>{</span>
  <span>%1</span> <span>=</span> <span>load</span> <span>%Output</span><span>,</span> <span>ptr</span> <span>@gOutput</span>
  <span>ret</span> <span>%Output</span> <span>%1</span>
<span>}</span></code></pre></figure></div> <p>When you pass an aggregate by-value to an LLVM function, LLVM will attempt to “explode” that aggregate into as many registers as possible. There are distinct register classes on different systems. For example, on both x86 and ARM, floats and vectors share the same register class (kind of<sup id="fnref:doubles-and-vectors" role="doc-noteref"><a href="#fn:doubles-and-vectors" rel="footnote">2</a></sup>).</p> <p>The above values are for x86<sup id="fnref:official-support" role="doc-noteref"><a href="#fn:official-support" rel="footnote">3</a></sup>. LLVM will pass six integers and eight SSE vectors by register, and return half as many (3 and 4) by register. Increasing any of the values generates extra loads and stores that indicate LLVM gave up and passed arguments on the stack.</p> <p>The values for <code>aarch64-unknown-linux</code> are 8 integers and 8 vectors for both inputs and outputs, respectively.</p> <p>This is the maximum number of registers we get to play with for each class. Anything extra gets passed on the stack.</p> <p>I recommend that <em>every function</em> have the same number of by-register arguments. So on x86, EVERY <code>-Zcallconv=fast</code> function’s signature should look like this:</p> <div><figure><pre><code data-lang="llvm"><span>declare</span> <span>{[</span><span>3</span> <span>x</span> <span>i64</span><span>],</span> <span>[</span><span>4</span> <span>x</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;]}</span> <span>@my_func</span><span>(</span>
  <span>i64</span> <span>%rdi</span><span>,</span> <span>i64</span> <span>%rsi</span><span>,</span> <span>i64</span> <span>%rdx</span><span>,</span> <span>i64</span> <span>%rcx</span><span>,</span> <span>i64</span> <span>%r8</span><span>,</span> <span>i64</span> <span>%r9</span><span>,</span>
  <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm0</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm1</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm2</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm3</span><span>,</span>
  <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm4</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm5</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm6</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm7</span><span>,</span>
  <span>; other args...</span>
<span>)</span></code></pre></figure></div> <p>When passing pointers, the appropriate <code>i64</code>s should be replaced by <code>ptr</code>, and when passing <code>double</code>s, they replace <code>&lt;2 x i64&gt;</code>s.</p> <p>But you’re probably saying, “Miguel, that’s crazy! Most functions don’t pass 176 bytes!” And you’d be right, if not for the magic of LLVM’s very well-specified <code>poison</code> semantics.</p> <p>We can get away with not doing extra work if every argument we do not use is passed <code>poison</code>. Because <code>poison</code> is equal to “the most convenient possible value at the present moment”, when LLVM sees <code>poison</code> passed into a function via register, it decides that the most convenient value is “whatever happens to be in the register already”, and so it doesn’t have to touch that register!</p> <p>For example, if we wanted to pass a pointer via <code>rcx</code>, we would generate the following code.</p> <div> <div><figure><pre><code data-lang="llvm"><span>; This is a -Zcallconv=fast-style function.</span>
<span>%Out</span> <span>=</span> <span>type</span> <span>{[</span><span>3</span> <span>x</span> <span>i64</span><span>],</span> <span>[</span><span>4</span> <span>x</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;]}</span>
<span>define</span> <span>%Out</span> <span>@load_rcx</span><span>(</span>
  <span>i64</span> <span>%rdi</span><span>,</span> <span>i64</span> <span>%rsi</span><span>,</span> <span>i64</span> <span>%rdx</span><span>,</span>
  <span>ptr</span> <span>%rcx</span><span>,</span> <span>i64</span> <span>%r8</span><span>,</span> <span>i64</span> <span>%r9</span><span>,</span>
  <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm0</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm1</span><span>,</span>
  <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm2</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm3</span><span>,</span>
  <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm4</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm5</span><span>,</span>
  <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm6</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm7</span>
<span>)</span> <span>{</span>
  <span>%load</span> <span>=</span> <span>load</span> <span>i64</span><span>,</span> <span>ptr</span> <span>%rcx</span>
  <span>%out</span> <span>=</span> <span>insertvalue</span> <span>%Out</span> <span>poison</span><span>,</span>
                      <span>i64</span> <span>%load</span><span>,</span> <span>0</span><span>,</span> <span>0</span>
  <span>ret</span> <span>%Out</span> <span>%out</span>
<span>}</span>

<span>declare</span> <span>ptr</span> <span>@malloc</span><span>(</span><span>i64</span><span>)</span>
<span>define</span> <span>i64</span> <span>@make_the_call</span><span>()</span> <span>{</span>
  <span>%1</span> <span>=</span> <span>call</span> <span>ptr</span> <span>@malloc</span><span>(</span><span>i64</span> <span>8</span><span>)</span>
  <span>store</span> <span>i64</span> <span>42</span><span>,</span> <span>ptr</span> <span>%1</span>
  <span>%2</span> <span>=</span> <span>call</span> <span>%Out</span> <span>@by_rcx</span><span>(</span>
    <span>i64</span> <span>poison</span><span>,</span> <span>i64</span> <span>poison</span><span>,</span> <span>i64</span> <span>poison</span><span>,</span>
    <span>ptr</span> <span>%1</span><span>,</span>     <span>i64</span> <span>poison</span><span>,</span> <span>i64</span> <span>poison</span><span>,</span>
    <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>,</span>
    <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>,</span>
    <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>,</span>
    <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>)</span>
  <span>%3</span> <span>=</span> <span>extractvalue</span> <span>%Out</span> <span>%2</span><span>,</span> <span>0</span><span>,</span> <span>0</span>
  <span>%4</span> <span>=</span> <span>add</span> <span>i64</span> <span>%3</span><span>,</span> <span>42</span>
  <span>ret</span> <span>i64</span> <span>%4</span>
<span>}</span></code></pre></figure></div> <div><figure><pre><code data-lang="cpp"><span>by_rcx:</span>
  <span>mov</span>   <span>rax</span><span>,</span> <span>qword</span> <span>ptr</span> <span>[</span><span>rcx</span><span>]</span>
  <span>ret</span>

<span>make_the_call</span><span>:</span>
  <span>push</span>  <span>rax</span>
  <span>mov</span>   <span>edi</span><span>,</span> <span>8</span>
  <span>call</span>  <span>malloc</span>
  <span>mov</span>   <span>qword</span> <span>ptr</span> <span>[</span><span>rax</span><span>],</span> <span>42</span>
  <span>mov</span>   <span>rcx</span><span>,</span> <span>rax</span>
  <span>call</span>  <span>load_rcx</span>
  <span>add</span>   <span>rax</span><span>,</span> <span>42</span>
  <span>pop</span>   <span>rcx</span>
  <span>ret</span></code></pre></figure></div> </div> <p>It is perfectly legal to pass poison to a function, if it does not interact with the poisoned argument in any proscribed way. And as we see, <code>load_rcx()</code> receives its pointer argument in <code>rcx</code>, whereas <code>make_the_call()</code> takes no penalty in setting up the call: loading poison into the other thirteen registers compiles down to nothing<sup id="fnref:requires-opt" role="doc-noteref"><a href="#fn:requires-opt" rel="footnote">4</a></sup>, so it only needs to load the pointer returned by malloc into <code>rcx</code>.</p> <p>This gives us almost total control over argument passing; unfortunately, it is not total. In an ideal world, the same registers are used for input and output, to allow easier pipelining of calls without introducing extra register traffic. This is true on ARM and RISC-V, but not x86. However, because register ordering is merely a suggestion for us, we can choose to allocate the return registers in whatever order we want. For example, we can pretend the order registers should be allocated in is <code>rdx</code>, <code>rcx</code>, <code>rdi</code>, <code>rsi</code>, <code>r8</code>, <code>r9</code> for inputs, and <code>rdx</code>, <code>rcx</code>, <code>rax</code> for outputs.</p> <div> <div><figure><pre><code data-lang="llvm"><span>%Out</span> <span>=</span> <span>type</span> <span>{[</span><span>3</span> <span>x</span> <span>i64</span><span>],</span> <span>[</span><span>4</span> <span>x</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;]}</span>
<span>define</span> <span>%Out</span> <span>@square</span><span>(</span>
  <span>i64</span> <span>%rdi</span><span>,</span> <span>i64</span> <span>%rsi</span><span>,</span> <span>i64</span> <span>%rdx</span><span>,</span>
  <span>ptr</span> <span>%rcx</span><span>,</span> <span>i64</span> <span>%r8</span><span>,</span> <span>i64</span> <span>%r9</span><span>,</span>
  <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm0</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm1</span><span>,</span>
  <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm2</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm3</span><span>,</span>
  <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm4</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm5</span><span>,</span>
  <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm6</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm7</span>
<span>)</span> <span>{</span>
  <span>%sq</span> <span>=</span> <span>mul</span> <span>i64</span> <span>%rdx</span><span>,</span> <span>%rdx</span>
  <span>%out</span> <span>=</span> <span>insertvalue</span> <span>%Out</span> <span>poison</span><span>,</span>
                      <span>i64</span> <span>%sq</span><span>,</span> <span>0</span><span>,</span> <span>1</span>
  <span>ret</span> <span>%Out</span> <span>%out</span>
<span>}</span>

<span>define</span> <span>i64</span> <span>@make_the_call</span><span>(</span><span>i64</span><span>)</span> <span>{</span>
  <span>%2</span> <span>=</span> <span>call</span> <span>%Out</span> <span>@square</span><span>(</span>
    <span>i64</span> <span>poison</span><span>,</span> <span>i64</span> <span>poison</span><span>,</span> <span>i64</span> <span>%0</span><span>,</span>
    <span>i64</span> <span>poison</span><span>,</span> <span>i64</span> <span>poison</span><span>,</span> <span>i64</span> <span>poison</span><span>,</span>
    <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>,</span>
    <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>,</span>
    <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>,</span>
    <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>)</span>
  <span>%3</span> <span>=</span> <span>extractvalue</span> <span>%Out</span> <span>%2</span><span>,</span> <span>0</span><span>,</span> <span>1</span>

  <span>%4</span> <span>=</span> <span>call</span> <span>%Out</span> <span>@square</span><span>(</span>
    <span>i64</span> <span>poison</span><span>,</span> <span>i64</span> <span>poison</span><span>,</span> <span>i64</span> <span>%3</span><span>,</span>
    <span>i64</span> <span>poison</span><span>,</span> <span>i64</span> <span>poison</span><span>,</span> <span>i64</span> <span>poison</span><span>,</span>
    <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>,</span>
    <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>,</span>
    <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>,</span>
    <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>poison</span><span>)</span>
  <span>%5</span> <span>=</span> <span>extractvalue</span> <span>%Out</span> <span>%4</span><span>,</span> <span>0</span><span>,</span> <span>1</span>

  <span>ret</span> <span>i64</span> <span>%5</span>
<span>}</span></code></pre></figure></div> <div><figure><pre><code data-lang="cpp"><span>square:</span>
  <span>imul</span> <span>rdx</span><span>,</span> <span>rdx</span>
  <span>ret</span>

<span>make_the_call</span><span>:</span>
  <span>push</span> <span>rax</span>
  <span>mov</span> <span>rdx</span><span>,</span> <span>rdi</span>
  <span>call</span> <span>square</span>
  <span>call</span> <span>square</span>
  <span>mov</span> <span>rax</span><span>,</span> <span>rdx</span>
  <span>pop</span> <span>rcx</span>
  <span>ret</span></code></pre></figure></div> </div> <p><code>square</code> generates extremely simple code: the input and output register is <code>rdi</code>, so no extra register traffic needs to be generated. Similarly, when we effectively do <code>@square(@square(%0))</code>, there is no setup between the functions. This is similar to code seen on aarch64, which uses the same register sequence for input and output. We can see that the “naive” version of this IR produces the exact same code on aarch64 for this reason.</p> <div> <div><figure><pre><code data-lang="llvm"><span>define</span> <span>i64</span> <span>@square</span><span>(</span><span>i64</span><span>)</span> <span>{</span>
  <span>%2</span> <span>=</span> <span>mul</span> <span>i64</span> <span>%0</span><span>,</span> <span>%0</span>
  <span>ret</span> <span>i64</span> <span>%2</span>
<span>}</span>

<span>define</span> <span>i64</span> <span>@make_the_call</span><span>(</span><span>i64</span><span>)</span> <span>{</span>
  <span>%2</span> <span>=</span> <span>call</span> <span>i64</span> <span>@square</span><span>(</span><span>i64</span> <span>%0</span><span>)</span>
  <span>%3</span> <span>=</span> <span>call</span> <span>i64</span> <span>@square</span><span>(</span><span>i64</span> <span>%2</span><span>)</span>
  <span>ret</span> <span>i64</span> <span>%3</span>
<span>}</span></code></pre></figure></div> <div><figure><pre><code data-lang="cpp"><span>square:</span>
  <span>mul</span> <span>x0</span><span>,</span> <span>x0</span><span>,</span> <span>x0</span>
  <span>ret</span>

<span>make_the_call</span><span>:</span>
  <span>str</span> <span>x30</span><span>,</span> <span>[</span><span>sp</span><span>,</span> <span>#</span><span>-</span><span>16</span><span>]</span><span>!</span>
  <span>bl</span> <span>square</span>
  <span>ldr</span> <span>x30</span><span>,</span> <span>[</span><span>sp</span><span>],</span> <span>#</span><span>16</span>
  <span>b</span> <span>square</span>  <span>// Tail call.</span></code></pre></figure></div> </div> <h3 id="rust-structs-and-unions"><a href="#rust-structs-and-unions">Rust Structs and Unions</a></h3> <p>Now that we’ve established total control on how registers are assigned, we can turn towards maximizing use of these registers in Rust.</p> <p>For simplicity, we can assume that rustc has already processed the users’s types into basic aggregates and unions; no enums here! We then have to make some decisions about which portions of the arguments to allocate to registers.</p> <p>First, return values. This is relatively straightforward, since there is only one value to pass. The amount of data we need to return is <em>not</em> the size of the struct. For example, <code>[(u64, u32); 2]</code> measures 32 bytes wide. However, eight of those bytes are padding! We do not need to preserve padding when returning by value, so we can flatten the struct into <code>(u64, u32, u64, u32)</code> and sort by size into <code>(u64, u64, u32, u32)</code>. This has no padding and is 24 bytes wide, which fits into the three return registers LLVM gives us on x86. We define the <em>effective size</em> of a type to be the number of non-<code>undef</code> bits it occupies. For <code>[(u64, u32); 2]</code>, this is 192 bits, since it excludes the padding. For <code>bool</code>, this is one. For <code>char</code> this is technically 21, but it’s simpler to treat <code>char</code> as an alias for <code>u32</code>.</p> <p>The reason for counting bits this way is that it permits significant compaction. For example, returning a struct full of bools can simply bit-pack the bools into a single register.</p> <p>So, a return value is converted to a by-ref return if its effective size is smaller than the output register space (on x86, this is three integer registers and four SSE registers, so we get 88 bytes total, or 704 bits).</p> <p>Argument registers are much harder, because we hit the <a href="https://en.wikipedia.org/wiki/Knapsack_problem">knapsack problem</a>, which is NP-hard. The following relatively naive heuristic is where I would start, but it can be made infinitely smarter over time.</p> <p>First, demote to by-ref any argument whose effective size is larget than the total by-register input space (on x86, 176 bytes or 1408 bits). This means we get a pointer argument instead. This is beneficial to do first, since a single pointer might pack better than the huge struct.</p> <p>Enums should be replaced by the appropriate discriminant-union pair. For example, <code>Option&lt;i32&gt;</code> is, internally, <code>(union { i32, () }, i1)</code>, while <code>Option&lt;Option&lt;i32&gt;&gt;</code> is <code>(union { i32, (), () }, i2)</code>. Using a small non-power-of-two integer improves our ability to pack things, since enum discriminants are often quite tiny.</p> <p>Next, we need to handle unions. Because mucking about with unions’ uninitialized bits behind our backs is allowed, we need to either pass it as an array of <code>u8</code>, unless it only has a single non-empty variant, in which case it is replaced with that variant<sup id="fnref:union-optimization" role="doc-noteref"><a href="#fn:union-optimization" rel="footnote">5</a></sup>.</p> <p>Now, we can proceed to flatten everything. All of the converted arguments are flattened into their most primitive components: pointers, integers, floats, and bools. Every field should be no larger than the smallest argument register; this may require splitting large types such as <code>u128</code> or <code>f64</code>.</p> <p>This big list of primitives is next sorted by effective size, from smallest to largest. We take the largest prefix of this that will fit in the available register space; everything else goes on the stack.</p> <p>If part of a Rust-level input is sent to the stack in this way, and that part is larger than a small multiple of the pointer size (e.g., 2x), it is demoted to being passed by pointer-on-the-stack, to minimize memory traffic. Everything else is passed directly on the stack in the order those inputs were before the sort. This helps keep regions that need to be copied relatively contiguous, to minimize calls to <code>memcpy</code>.</p> <p>The things we choose to pass in registers are allocated to registers in reverse size order, so e.g. first 64-bit things, then 32-bit things, etc. This is the same layout algorithm that <code>repr(Rust)</code> structs use to move all the padding into the tail. Once we get to the <code>bool</code>s, those are bit-packed, 64 to a register.</p> <p>Here’s a relatively complicated example. My Rust function is as follows:</p> <div><figure><pre><code data-lang="rust"><span>struct</span> <span>Options</span> <span>{</span>
  <span>colorize</span><span>:</span> <span>bool</span><span>,</span>
  <span>verbose_debug</span><span>:</span> <span>bool</span><span>,</span>
  <span>allow_spurious_failure</span><span>:</span> <span>bool</span><span>,</span>
  <span>retries</span><span>:</span> <span>u32</span><span>,</span>
<span>}</span>

<span>trait</span> <span>Context</span> <span>{</span>
  <span>fn</span> <span>check</span><span>(</span><span>&amp;</span><span>self</span><span>,</span> <span>n</span><span>:</span> <span>usize</span><span>,</span> <span>colorize</span><span>:</span> <span>bool</span><span>);</span>
<span>}</span>

<span>fn</span> <span>do_thing</span><span>&lt;</span><span>'a</span><span>&gt;</span><span>(</span><span>op_count</span><span>:</span> <span>Option</span><span>&lt;</span><span>usize</span><span>&gt;</span><span>,</span> <span>context</span><span>:</span> <span>&amp;</span><span>dyn</span> <span>Context</span><span>,</span>
                <span>name</span><span>:</span> <span>&amp;</span><span>'a</span> <span>str</span><span>,</span> <span>code</span><span>:</span> <span>[</span><span>char</span><span>;</span> <span>6</span><span>],</span>
                <span>options</span><span>:</span> <span>Options</span><span>,</span>
<span>)</span> <span>-&gt;</span> <span>&amp;</span><span>'a</span> <span>str</span> <span>{</span>
  <span>if</span> <span>let</span> <span>Some</span><span>(</span><span>op_count</span><span>)</span> <span>=</span> <span>op_count</span> <span>{</span>
    <span>context</span><span>.check</span><span>(</span><span>op_count</span><span>,</span> <span>options</span><span>.colorize</span><span>);</span>
  <span>}</span>

  <span>for</span> <span>c</span> <span>in</span> <span>code</span> <span>{</span>
    <span>if</span> <span>let</span> <span>Some</span><span>((</span><span>_</span><span>,</span> <span>suf</span><span>))</span> <span>=</span> <span>name</span><span>.split_once</span><span>(</span><span>c</span><span>)</span> <span>{</span>
      <span>return</span> <span>suf</span><span>;</span>
    <span>}</span>
  <span>}</span>

  <span>"idk"</span>
<span>}</span></code></pre></figure></div> <p>The codegen for this function is quite complex, so I’ll only cover the prologue and epilogue. After sorting and flattening, our raw argument LLVM types are something like this:</p> <div><figure><pre><code data-lang="llvm"><span>gprs:</span> <span>i64</span><span>,</span> <span>ptr</span><span>,</span> <span>ptr</span><span>,</span> <span>ptr</span><span>,</span> <span>i64</span><span>,</span> <span>i32</span><span>,</span> <span>i32</span>
<span>xmm0:</span> <span>i32</span><span>,</span> <span>i32</span><span>,</span> <span>i32</span><span>,</span> <span>i32</span>
<span>xmm1:</span> <span>i32</span><span>,</span> <span>i1</span><span>,</span> <span>i1</span><span>,</span> <span>i1</span><span>,</span> <span>i1</span></code></pre></figure></div> <p>Everything fits in registers! So, what does the LLVM function look like on x86?</p> <div><figure><pre><code data-lang="llvm"><span>%Out</span> <span>=</span> <span>type</span> <span>{[</span><span>3</span> <span>x</span> <span>i64</span><span>],</span> <span>[</span><span>4</span> <span>x</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;]}</span>
<span>define</span> <span>%Out</span> <span>@do_thing</span><span>(</span>
  <span>i64</span> <span>%rdi</span><span>,</span> <span>ptr</span> <span>%rsi</span><span>,</span> <span>ptr</span> <span>%rdx</span><span>,</span>
  <span>ptr</span> <span>%rcx</span><span>,</span> <span>i64</span> <span>%r8</span><span>,</span> <span>i64</span> <span>%r9</span><span>,</span>
  <span>&lt;</span><span>4</span> <span>x</span> <span>i32</span><span>&gt;</span> <span>%xmm0</span><span>,</span> <span>&lt;</span><span>4</span> <span>x</span> <span>i32</span><span>&gt;</span> <span>%xmm1</span><span>,</span>
  <span>; Unused.</span>
  <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm2</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm3</span><span>,</span>
  <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm4</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm5</span><span>,</span>
  <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm6</span><span>,</span> <span>&lt;</span><span>2</span> <span>x</span> <span>i64</span><span>&gt;</span> <span>%xmm7</span>
<span>)</span> <span>{</span>
  <span>; First, unpack all the primitives.</span>
  <span>%r9.0</span> <span>=</span> <span>trunc</span> <span>i64</span> <span>%r9</span> <span>to</span> <span>i32</span>
  <span>%r9.1.i64</span> <span>=</span> <span>lshr</span> <span>i64</span> <span>%r9</span><span>,</span> <span>32</span>
  <span>%r9.1</span> <span>=</span> <span>trunc</span> <span>i64</span> <span>%r9.1.i64</span> <span>to</span> <span>i32</span>
  <span>%xmm0.0</span> <span>=</span> <span>extractelement</span> <span>&lt;</span><span>4</span> <span>x</span> <span>i32</span><span>&gt;</span> <span>%xmm0</span><span>,</span> <span>i32</span> <span>0</span>
  <span>%xmm0.1</span> <span>=</span> <span>extractelement</span> <span>&lt;</span><span>4</span> <span>x</span> <span>i32</span><span>&gt;</span> <span>%xmm0</span><span>,</span> <span>i32</span> <span>1</span>
  <span>%xmm0.2</span> <span>=</span> <span>extractelement</span> <span>&lt;</span><span>4</span> <span>x</span> <span>i32</span><span>&gt;</span> <span>%xmm0</span><span>,</span> <span>i32</span> <span>2</span>
  <span>%xmm0.3</span> <span>=</span> <span>extractelement</span> <span>&lt;</span><span>4</span> <span>x</span> <span>i32</span><span>&gt;</span> <span>%xmm0</span><span>,</span> <span>i32</span> <span>3</span>
  <span>%xmm1.0</span> <span>=</span> <span>extractelement</span> <span>&lt;</span><span>4</span> <span>x</span> <span>i32</span><span>&gt;</span> <span>%xmm1</span><span>,</span> <span>i32</span> <span>0</span>
  <span>%xmm1.1</span> <span>=</span> <span>extractelement</span> <span>&lt;</span><span>4</span> <span>x</span> <span>i32</span><span>&gt;</span> <span>%xmm1</span><span>,</span> <span>i32</span> <span>1</span>
  <span>%xmm1.1.0</span> <span>=</span> <span>trunc</span> <span>i32</span> <span>%xmm1.1</span> <span>to</span> <span>i1</span>
  <span>%xmm1.1.1.i32</span> <span>=</span> <span>lshr</span> <span>i32</span> <span>%xmm1.1</span><span>,</span> <span>1</span>
  <span>%xmm1.1.1</span> <span>=</span> <span>trunc</span> <span>i32</span> <span>%xmm1.1.1.i32</span> <span>to</span> <span>i1</span>
  <span>%xmm1.1.2.i32</span> <span>=</span> <span>lshr</span> <span>i32</span> <span>%xmm1.1</span><span>,</span> <span>2</span>
  <span>%xmm1.1.2</span> <span>=</span> <span>trunc</span> <span>i32</span> <span>%xmm1.1.2.i32</span> <span>to</span> <span>i1</span>
  <span>%xmm1.1.3.i32</span> <span>=</span> <span>lshr</span> <span>i32</span> <span>%xmm1.1</span><span>,</span> <span>3</span>
  <span>%xmm1.1.3</span> <span>=</span> <span>trunc</span> <span>i32</span> <span>%xmm1.1.3.i32</span> <span>to</span> <span>i1</span>

  <span>; Next, reassemble them into concrete values as needed.</span>
  <span>%op_count.0</span> <span>=</span> <span>insertvalue</span> <span>{</span> <span>i64</span><span>,</span> <span>i1</span> <span>}</span> <span>poison</span><span>,</span> <span>i64</span> <span>%rdi</span><span>,</span> <span>0</span>
  <span>%op_count</span> <span>=</span> <span>insertvalue</span> <span>{</span> <span>i64</span><span>,</span> <span>i1</span> <span>}</span> <span>%op_count.0</span><span>,</span> <span>i1</span> <span>%xmm1.1.0</span><span>,</span> <span>1</span>
  <span>%context.0</span> <span>=</span> <span>insertvalue</span> <span>{</span> <span>ptr</span><span>,</span> <span>ptr</span> <span>}</span> <span>poison</span><span>,</span> <span>ptr</span> <span>%rsi</span><span>,</span> <span>0</span>
  <span>%context</span> <span>=</span> <span>insertvalue</span> <span>{</span> <span>ptr</span><span>,</span> <span>ptr</span> <span>}</span> <span>%context.0</span><span>,</span> <span>ptr</span> <span>%rdx</span><span>,</span> <span>1</span>
  <span>%name.0</span> <span>=</span> <span>insertvalue</span> <span>{</span> <span>ptr</span><span>,</span> <span>i64</span> <span>}</span> <span>poison</span><span>,</span> <span>ptr</span> <span>%rcx</span><span>,</span> <span>0</span>
  <span>%name</span> <span>=</span> <span>insertvalue</span> <span>{</span> <span>ptr</span><span>,</span> <span>i64</span> <span>}</span> <span>%name.0</span><span>,</span> <span>i64</span> <span>%r8</span><span>,</span> <span>1</span>
  <span>%code.0</span> <span>=</span> <span>insertvalue</span> <span>[</span><span>6</span> <span>x</span> <span>i32</span><span>]</span> <span>poison</span><span>,</span> <span>i32</span> <span>%r9.0</span><span>,</span> <span>0</span>
  <span>%code.1</span> <span>=</span> <span>insertvalue</span> <span>[</span><span>6</span> <span>x</span> <span>i32</span><span>]</span> <span>%code.0</span><span>,</span> <span>i32</span> <span>%r9.1</span><span>,</span> <span>1</span>
  <span>%code.2</span> <span>=</span> <span>insertvalue</span> <span>[</span><span>6</span> <span>x</span> <span>i32</span><span>]</span> <span>%code.1</span><span>,</span> <span>i32</span> <span>%xmm0.0</span><span>,</span> <span>2</span>
  <span>%code.3</span> <span>=</span> <span>insertvalue</span> <span>[</span><span>6</span> <span>x</span> <span>i32</span><span>]</span> <span>%code.2</span><span>,</span> <span>i32</span> <span>%xmm0.1</span><span>,</span> <span>3</span>
  <span>%code.4</span> <span>=</span> <span>insertvalue</span> <span>[</span><span>6</span> <span>x</span> <span>i32</span><span>]</span> <span>%code.3</span><span>,</span> <span>i32</span> <span>%xmm0.2</span><span>,</span> <span>4</span>
  <span>%code</span> <span>=</span> <span>insertvalue</span> <span>[</span><span>6</span> <span>x</span> <span>i32</span><span>]</span> <span>%code.4</span><span>,</span> <span>i32</span> <span>%xmm0.3</span><span>,</span> <span>5</span>
  <span>%options.0</span> <span>=</span> <span>insertvalue</span> <span>{</span> <span>i32</span><span>,</span> <span>i1</span><span>,</span> <span>i1</span><span>,</span> <span>i1</span> <span>}</span> <span>poison</span><span>,</span> <span>i32</span> <span>%xmm1.0</span><span>,</span> <span>0</span>
  <span>%options.1</span> <span>=</span> <span>insertvalue</span> <span>{</span> <span>i32</span><span>,</span> <span>i1</span><span>,</span> <span>i1</span><span>,</span> <span>i1</span> <span>}</span> <span>%options.0</span><span>,</span> <span>i1</span> <span>%xmm1.1.1</span><span>,</span> <span>1</span>
  <span>%options.2</span> <span>=</span> <span>insertvalue</span> <span>{</span> <span>i32</span><span>,</span> <span>i1</span><span>,</span> <span>i1</span><span>,</span> <span>i1</span> <span>}</span> <span>%options.1</span><span>,</span> <span>i1</span> <span>%xmm1.1.2</span><span>,</span> <span>2</span>
  <span>%options</span> <span>=</span> <span>insertvalue</span> <span>{</span> <span>i32</span><span>,</span> <span>i1</span><span>,</span> <span>i1</span><span>,</span> <span>i1</span> <span>}</span> <span>%options.2</span><span>,</span> <span>i1</span> <span>%xmm1.1.3</span><span>,</span> <span>3</span>

  <span>; Codegen as usual.</span>
  <span>; ...</span>
<span>}</span></code></pre></figure></div> <p>Above, <code>!dbg</code> metadata for the argument values should be attached to the instruction that actually materializes it. This ensures that gdb does something halfway intelligent when you ask it to print argument values.</p> <p>On the other hand, in current rustc, it gives LLVM eight pointer-sized parameters, so it winds up spending all six integer registers, plus two values passed on the stack. Not great!</p> <p>This is not a complete description of what a completely over-engineered calling convention could entail: in some cases we might know that we have additional registers available (such as AVX registers on x86). There are cases where we might want to split a struct across registers and the stack.</p> <p>This also isn’t even getting into what returns <em>could</em> look like. <code>Result</code>s are often passed through several layers of functions via <code>?</code>, which can result in a lot of redundant register moves. Often, a <code>Result</code> is large enough that it doesn’t fit in registers, so each call in the <code>?</code> stack has to inspect an ok bit by loading it from memory. Instead, a <code>Result</code> return might be implemented as an out-parameter pointer for the error, with the ok variant’s payload, and the is ok bit, returned as an <code>Option&lt;T&gt;</code>. There are some fussy details with <code>Into</code> calls via <code>?</code>, but the idea is implementable.</p> <h3 id="optimization-dependent-abi"><a href="#optimization-dependent-abi">Optimization-Dependent ABI</a></h3> <p>Now, because we’re Rust, we’ve also got a trick up our sleeve that C doesn’t (but Go does)! When we’re generating the ABI that all callers will see (for <code>-Zcallconv=fast</code>), we can look at the function body. This means that a crate can advertise the <em>precise</em> ABI (in terms of register-passing) of its functions.</p> <p>This opens the door to a more extreme optimization-based ABIs. We can start by simply throwing out unused arguments: if the function never does anything with a parameter, don’t bother spending registers on it.</p> <p>Another example: suppose that we know that an <code>&amp;T</code> argument is not retained (a question the borrow checker can answer at this point in the compiler) and is never converted to a raw pointer (or written to memory a raw pointer is taken of, etc). We also know that <code>T</code> is fairly small, and <code>T: Freeze</code>. Then, we can replace the reference with the pointee directly, passed by value.</p> <p>The most obvious candidates for this is APIs like <code>HashMap::get()</code>. If the key is something like an <code>i32</code>, we need to spill that integer to the stack and pass a pointer to it! This results in unnecessary, avoidable memory traffic.</p> <p>Profile-guided ABI is a step further. We might know that some arguments are hotter than others, which might cause them to be prioritized in the register allocation order.</p> <p>You could even imagine a case where a function takes a very large struct by reference, but three <code>i64</code> fields are very hot, so the caller can <em>preload</em> those fields, passing them both by register <em>and</em> via the pointer to the large struct. The callee does not see additional cost: it had to issue those loads anyway. However, the caller probably has those values in registers already, which avoids some memory traffic.</p> <p>Instrumentation profiles may even indicate that it makes sense to duplicate whole functions, which are identical except for their ABIs. Maybe they take different arguments by register to avoid costly spills.</p> <h2 id="conclusion"><a href="#conclusion">Conclusion</a></h2> <p>This is a bit more advanced (and ranty) than my usual writing, but this is an aspect of Rust that I find really frustrating. We could be doing <em>so much better</em> than C++ ever can (because of their ABI constraints). None of this is new ideas; this is <em>literally</em> how Go does it!</p> <p>So why don’t we? Part of the reason is that ABI codegen is complex, and as I described above, LLVM gives us very few useful knobs. It’s not a friendly part of rustc, and doing things wrong can have nasty consequences for usability. The other part is a lack of expertise. As of writing, only a handful of people contributing to rustc have the necessary grasp of LLVM’s semantics (and mood swings) to emit the Right Code such that we get good codegen and don’t crash LLVM.</p> <p>Another reason is compilation time. The more complicated the function signatures, the more prologue/epilogue code we have to generate that LLVM has to chew on. But <code>-Zcallconv</code> is intended to only be used with optimizations turned on, so I don’t think this is a meaningful complaint. Nor do I think the project’s Goodhartization of compilation time as a metric is healthy… but I do not think this is ultimately a relevant drawback.</p> <p>I, unfortunately, do not have the spare time to dive into fixing rustc’s ABI code, but I do know LLVM really well, and I know that this is a place where Rust has a low bus factor. For that reason, I am happy to provide the Rust compiler team expert knowledge on getting LLVM to do the right thing in service of making optimized code faster.</p>  </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Insatiable: A life without eating (130 pts)]]></title>
            <link>https://longreads.com/2024/04/18/crohns-life-without-eating/</link>
            <guid>40079647</guid>
            <pubDate>Thu, 18 Apr 2024 19:06:42 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://longreads.com/2024/04/18/crohns-life-without-eating/">https://longreads.com/2024/04/18/crohns-life-without-eating/</a>, See on <a href="https://news.ycombinator.com/item?id=40079647">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>

					

<article id="post-215030">
	<div>

		
		




<p><em><a href="http://www.andrewgchapman.com/" target="_blank" rel="noreferrer noopener">Andrew Chapman</a>&nbsp;| Longreads | April 18, 2024 | 3,755 words (13 minutes)</em></p>



<p>At first, it was simply a roast chicken recipe. Then it was everything.</p>



<p>I watched a man on YouTube cook the chicken, imagining what it would be like to taste it. Even if he had prepared it in front of me, I couldn’t have eaten it. Inflammation from Crohn’s disease had connected the tissues of my small intestine and my bladder together via fistula, and I did not want to pee out a roast chicken.</p>



<p>Instead, I was on a form of artificial food called total parenteral nutrition (TPN, for short). All my nutrition and water were pumped from an IV bag into my veins through a tube in my arm. Even though I had enough functional nutrition in my body my brain screamed,<em> you’re hungry, </em>constantly.&nbsp;</p>



<p>I watched Gordon Ramsay make French pan sauces and tuna with lime zest. I watched a man on Netflix who seemed to know nothing about food eating Khao soi in Thailand. Watching cooking shows felt like picking a scab—somehow like relief and suffering at the same time.&nbsp;</p>



<p>Eventually, my wife, Erica, became concerned for my mental health. “I can’t stop. It’s a compulsion,” I would say.&nbsp;</p>



<p>“I hate it,” she’d add.&nbsp;</p>



<p>To diminish her concern, I settled for watching Anthony Bourdain’s <em>Parts Unknown</em>, because the show’s travel element obscured the food.</p>



<hr>



<p>Crohn’s is an inflammatory bowel disease. The cause is unknown, but it appears to be due to a haywire immune system that attacks the digestive tract—in my case, the end of the small bowel. Every Crohn’s patient experiences different symptoms. Some have daily mild belly aches and unruly diarrhea. I’ve always experienced near-normal health punctuated by periods of wild pain, nausea, and weight loss. The most common treatments are steroids, anti-inflammatory and immunosuppressant drugs, and, as a last resort, surgery to remove any bowel beyond repair. In my thirties, the combination of fresh inflammation and scar tissue from a teenage surgery had blocked up my bowel. Eating became like gambling—sometimes I won, but mostly I lost.</p>



<p>I was diagnosed at 11. Food had become repellant to me. I remember sitting, twig thin, in an emergency room waiting area with my worried parents. A cooking show was on TV. The show’s host was making a cheese omelet that looked as appealing to me as fried fertilizer. “I can’t even look at that,” I said.&nbsp;</p>



<p>“Oh? That looks good to me,” Mom said, aiming less to change my mind on the omelet than confirm to herself how sick I was.</p>



<p>The year after I was diagnosed my doctor, worried I was losing so much weight I wouldn’t get enough calories through regular eating, put me on a nutritional therapy called enteral nutrition—an infusion of milky formula into the belly. I had to snake a flexible rubber tube up my nose and into my stomach every night, tearing it out in a rush before school in the morning. The tube would sometimes disconnect from the IV bag while I was sleeping, the pump whirring away until morning. I’d wake up drenched in sticky formula with an empty stomach.&nbsp;</p>



<p>When my doctor gave me the option, I chose to guzzle the formula during the day to have extra hours without the tube at night (drinking the volume of formula required for nutrition would have been nearly impossible). I was also allowed to drink clear fluids, so my parents kept the fridge stocked with lemon-lime soda and JELL-O. But, without that shackle of a tube, I would not have stayed alive as a preteen.&nbsp;</p>



<hr>



<p>Doctors have used enteral nutrition since the early 20th century, pumping broths and formulas directly into the stomach either through a tube placed into the nose and down into the stomach, like mine, or through an incision in the belly. However, enteral nutrition relies on patients having a working digestive system. Doctors thought it was impossible to bypass the digestive tract and get enough nutrition into patients through a vein, believing it required so much liquid, and such a high concentration of chemical nutrients, that it would cause inflammation and burning when administered.</p>



<div>
<div>
<figure><img decoding="async" src="https://i0.wp.com/longreads.com/wp-content/uploads/2022/08/envelope.png?resize=55%2C41&amp;ssl=1" alt="" width="55" height="41" data-recalc-dims="1"></figure>
</div>



<div>
<p>Get the Longreads Top 5 Email</p>



<p>Kickstart your weekend by getting the week’s very best reads, hand-picked and introduced by Longreads editors, delivered to your inbox every Friday morning—and keep up with <em>all</em> our picks by subscribing to our daily update.</p>


	
	</div>
</div>



<p>It was Stanley Dudrick, a strong-minded surgical resident at the University of Pennsylvania, who would change that. One weekend in November 1961, Dudrick was left to look after three surgical patients. The patients had had different procedures, but over the weekend, all three died. Having watched his supervisor, Dr. Rhoads, a revered surgeon, perform technically flawless surgeries on each of them, Dudrick concluded their deaths were his fault. When he told Rhoads on Monday, he was assured the patients were all frail from their operations, and their gastrointestinal tracts were struggling to absorb enough nutrients to overcome the weakness. The patients didn’t die from his ineptitude—they died of malnutrition.&nbsp;</p>



<p>A fire was lit in Dudrick. He requested leave from his surgical internship and worked out of a small lab in the hospital’s basement, determined to find a solution. For years, he honed the composition for a nutrition formula that could be delivered via veins, avoiding the intestines. By the late ’60s, he had finally found a stable mixture of water, carbohydrates, proteins, trace elements, fats, salts, and multivitamins—everything you need from a balanced meal, just with the color and smell of Elmer’s glue.&nbsp;</p>



<p>But the concentrated nutrients did burn. “I’ve actually put it in my own vein,” Dudrick told Dr. Rhoads, showing his forearm. “It burns like liquid fire.” To banish the blaze, he knew the formula would have to be injected close to the heart, to allow for fast dilution around the body. When he kept a beagle named Stinky alive, nourished only with the nutrient combination infused into his vena cava (a large vein that returns deoxygenated blood to the heart), Dudrick was convinced it would work for humans. He’d invented TPN. Since then, it has saved millions of lives.</p>



<hr>



<p>A doctor once told me that when a tissue is inflamed for long enough, the connections that hold cells together start to break down, and the tissue softens. When that happens, tissues can merge, forming a little tunnel known as a fistula. A CT scan showed that my bowel had formed several fistulas looping on themselves—the path of digestion more a maze than a hallway.&nbsp;</p>



<p>By knocking back the immune system with immunosuppressants and nutrition from TPN—to rest the bowel by not eating or drinking—fistulas can sometimes close themselves. This was the hope for me.&nbsp;</p>



<p>A thin IV catheter called a peripherally inserted central catheter, or PICC—like the one Dudrick used in Stinky—was placed in a vein on the inside of my arm and threaded into my vena cava. A nurse named Stan inserted the PICC with the intense focus of a true craftsman. He wore earbuds and sang “I can’t get enough of your love” by Barry White under his breath.</p>



<p>Since I would be sent home with the TPN, a different nurse taught me how to rig it up myself. She explained how I would set up the TPN every night and run it over 12 hours. I had to inject a personalized pre-prepared slurry of multivitamins into an IV bag, prime the pump, and flush the PICC with saline. She explained the buttons and the beeps on the pump that squirted the mixture through the tubes and into my body. Everything was vigorously wiped with alcohol because any bacteria would be injected straight into my heart.&nbsp;</p>



<p>“You got all that?” the nurse asked after her demonstration.</p>



<p>I had been preoccupied thinking about how weird not eating would be at home. Like many thirty-something married couples in San Francisco, Erica and I lived with five other tirelessly social roommates. One ran a start-up from the living room. The house was often standing room only. And what did people do when they hung around in groups? They cooked and they drank. Early on in the flare-up, the group shared a rich and earthy-tasting homemade coq au vin. I helped to meticulously peel dozens of pearl onions. I paid the price later that night.</p>



<p>“I think we’ll be okay,” I said to the nurse.&nbsp;</p>



<p>We weren’t. At home that first night, we fumbled to inject the components into the bag and attach it to the pump and my arm. Then Erica spotted a bubble marching up the tube, and we mashed at the stop button on the pump.&nbsp;</p>



<p>“That’s fine, right?” I said.</p>



<p>“I don’t know. What if it explodes your heart?”</p>



<p>Out to the kitchen, Erica went.&nbsp;</p>



<p>Polling the two dozen or so people cooking in the house, she found one doctor and one nurse to choose from. The bubble could stay; the feeding began.</p>



<figure><blockquote><p>Early on in the flare-up, the group shared a rich and earthy-tasting homemade coq au vin. I helped to meticulously peel dozens of pearl onions. I paid the price later that night.</p></blockquote></figure>



<p>On one of the first nights at home, Erica’s best friend visited to apply therapeutic face masks to pass the time. In a selfie with our dingy-green masks, Erica beams with sweet enthusiasm. I look stone-faced and far away. Our housemate Rory later brought some puzzles for us to do together. Everyone in the house became obsessed with them. I could hear them celebrating a discovered piece long after I snuck away to lie down. I felt weak from being sick. But I also felt weak for not being stronger, for not executing a gracious interest in the ways people tried to help.</p>



<p>Those first weeks, I mostly slept. When I was awake, my brain was frighteningly alert. My body, on the other hand, looked and felt like wet cardboard. The anxiety of hunger settled under my ribs like the feeling you get when you’re about to burst into tears. The hum of the refrigerator alone was enough to make me want to bury my head in the backyard. I often dreamt of donuts, and once, of my sister-in-law’s mother, a tenacious Serbian woman, bringing me a roasting pan full of sausages. By the time I had my first dose of TPN, I had gone without eating for nearly a week and a half, sustained only by fluids in the hospital. Then, due to a holiday and clerical error, I was left on a dose half of what I required—intended to see how well I handled the slurry—for a week longer than expected. I assumed the hunger would subside with enough nutrition. But even after weeks on full TPN, I still could’ve eaten the plastic bags it came in.</p>



<hr>



<p>Everyone starts with around 22 feet of small bowel, but if surgery cuts it down to less than seven feet, the body can’t absorb water and nutrients anymore. With my bowel so badly matted together, surgeons might need to remove a lot, and if they removed enough—on top of the two feet I lost as a teenager—it could mean TPN for life. With the state my mind was in, that was unimaginable.</p>



<p>While scientists have figured out extraordinary ways to keep patients who can’t eat alive, they haven’t yet figured out how to deal with what it does to us mentally. I’d been through a lot with Crohn’s before, even believing that who I was as a person was largely the result of these struggles. But TPN was different. It was like I was sitting in a lawn chair (albeit a rickety one) at a picnic when somebody came along and kicked a leg out—the pasta salad that might’ve been in my hand, flung into oblivion.</p>



<p>Eating is an experience that humans share with all other animals. Organic material is consumed and broken down during digestion. In return, the body adapts nutritious molecules into a host of cellular processes and adenosine triphosphate, or ATP, which cells turn into energy. During digestion, physiological responses are triggered in the brain by the vagus nerve, contributing to the feeling of fullness. Hormonal signals also act on the brain: leptin, a hormone produced by fat cells, sends signals to the hypothalamus to inhibit hunger. In patients on TPN or enteral nutrition, leptin does increase after infusions, but it doesn’t appear to be well correlated with decreased hunger.</p>



<p>While the hormones and neural signals are crucial to satiation, so is the sensory experience that takes place during the first phase of digestion—the cephalic phase—which begins at the sight of food. The pleasure that we take during this phase appears to be important to feeling satisfied. Monkeys on TPN continued to <a href="https://pubmed.ncbi.nlm.nih.gov/98652/" target="_blank" rel="noreferrer noopener">eat real food</a> even when their caloric needs were met. Studies in healthy humans found that <a href="https://pubmed.ncbi.nlm.nih.gov/1910106/" target="_blank" rel="noreferrer noopener">people on TPN</a> reported being as hungry as those injected with only lactated Ringer’s, a solution designed to replenish electrolytes and fluid rather than calories. I asked an on-call gastroenterologist once what I could do for the hunger.</p>



<p>“You can try chewing meat and spitting it out,” she said.&nbsp;</p>



<p>“Oh,” I said.&nbsp;</p>



<p>Of all the things doctors have said to me, this struck me as the most deranged. I never even considered her advice because I didn’t miss the taste of food, so much as I missed the social aspect and, more so, not feeling hungry. Carrying a spittoon to spit out chicken like a confused cowboy wasn’t going to accomplish either. But now I begrudgingly admit she was on to something. Chewing food, even without swallowing, helps to activate the cephalic phase, triggering a partial sense of satiation. The doctor never explained this to me.</p>



<p>Paul Smeets, a nutritional neuroscientist at the University Medical Center Utrecht in the Netherlands, told me that part of the problem is that patients on enteral and parenteral nutrition receive the infusion over such a long period. “They sneak nutrition into people so slowly that the brain is never aware it’s happening,” he told me. The homeostatic feedback produced from eating a meal, that allows the brain to feel satisfied, is missing. TPN and enteral nutrition are, in effect, a form of sensory deprivation. My hunger was a natural neurological reaction that could be traced back for millennia.</p>



<hr>



<p>While on TPN, I stayed away from the kitchen as best I could, mostly because it felt as if I was gawking. In the evenings, Erica would come home from work and I’d close my laptop screen, where Bourdain was, say, fishing for dinner in southern Italy, and we’d lie on the bed. Erica would ask if I farted out my penis that day. I’d say not today, and then we’d laugh at the ridiculousness of what a good day looked like. She ended up eating less. Family members of patients on artificial nutrition often feel guilty about eating, some even lose weight, I learned. This unearthly relationship with food wasn’t what I wanted to offer her, but it was what I served, like pulling out a burnt tray of hors d’oeuvres just as the guests arrived. Even though she smiled and accepted our life the way it was, we hadn’t even been married for a year. I wondered if anything so young could thrive so undernourished.</p>



<figure><blockquote><p>Erica would ask if I farted out my penis that day. I’d say not today, and then we’d laugh at the ridiculousness of what a good day looked like.</p></blockquote></figure>



<p>While she was out, hidden in our room, I gorged on the cooking shows that caused her concern. In the late ’70s, doctors learned that patients on TPN often experience several stages of adaptation, including grief—mourning the loss of food rather than the death of someone close. Watching cooking shows seemed like a form of remembering and searching for what I had lost. When I tried to stop, I felt like I was from a different planet, separate from everyone else whose lives swirled around food. When watching cooking shows, I could fake being human. Since the cephalic phase of digestion begins at the sight of food, even before putting a crumb in one’s mouth, it’s also possible I was subconsciously attempting to veer onto an ancient road to satiety even if, for me, it didn’t lead anywhere.</p>



<p>When I went looking on the internet, I found I was not alone. I asked why people watched cooking shows on the Crohn’s disease subreddit. One user said they had no idea, but “the only show I watched was <em>Diners, Drive-Ins and Dives</em> with Guy Fieri, which is extra weird because I was a vegetarian.” Another bought cannoli and made their partner describe the taste in detail as if it were their own personal cooking show.</p>



<p>The things that I, and others on TPN, experienced, are not unlike the psychological effects seen in people who are physically deprived of food. In 1944, 36 men entered a study after seeing a brochure passed out at the University of Minnesota asking, <em>Will you starve so that others will be better fed?</em> The 36 participants were underfed until they lost 25% of their body weight. As the experiment progressed, Ancel Keys, the nutritionist running the study, noticed odd psychological effects. The participants became increasingly focused on food, collecting recipes, and taking down pin-ups of women to hang pictures of food. One even decided he would change careers and become a chef. After the study, most participants gorged themselves long after their weight returned to normal.&nbsp;</p>



<p>Without food, we become preoccupied with it. Food is as evolutionarily important as pain and sex. Animals that don’t take an interest in these stimuli don’t fare well. Research shows that <a href="https://pubmed.ncbi.nlm.nih.gov/31589063/" target="_blank" rel="noreferrer noopener">noticing food</a> and remembering its location is a base instinct for all humans that becomes heightened when hungry.&nbsp;</p>



<p>Patients on TPN are functionally fed but are perhaps not neurologically aware of it. Of course, physiological food deprivation is different (unimaginable, to me) from a psychological one, but we still seem to hyper-focus on what we can’t have rather than shy away from it. With the way appetite brain signaling works, Smeets says it makes sense that some overlapping effects of starvation might take place in the brain,&nbsp;causing an obsession with food and all the behavioral baggage that comes with it.</p>



<hr>



<p>After nearly a month without anything, not even water, by mouth, my symptoms stabilized and my doctor said I could try drinking clear liquids. Since I had tasted only the inside of my mouth for three weeks, the white cranberry juice was electrifying. I ate raspberry JELL-O in a blaze of magnificent relief. With what I now attribute to the cephalic phase the world became slightly more bearable. Then, after two months on TPN and a clear liquid diet, the home care nurse pulled the PICC. I can’t remember exactly why this decision was made, because at the time I didn’t care. I was going to be a full-time eater again. Even though I went slow, everything was a feast.&nbsp;</p>



<p>Erica and I drove to her parents’ house in Southern California for Thanksgiving. I ate the turkey dinner cautiously as if it was still alive. Even then, Erica had to drive the whole seven hours back to San Francisco because I felt the familiar spasms of pain and gurgles of food going into my bladder. At the hospital, they decided the fistula likely wouldn’t close on its own. I was scheduled for surgery two days after Christmas.&nbsp;</p>



<figure><blockquote><p>Since I had tasted only the inside of my mouth for three weeks, the white cranberry juice was electrifying. </p></blockquote></figure>



<p>And so, after only three weeks without TPN, eating was out, and the PICC went back in. It was placed by two nurses who encouraged me to relax while saying things like, “Is that in? No, that doesn’t look right.”&nbsp;</p>



<p>Well, you’re no Stan, I thought.&nbsp;</p>



<hr>



<p>Rory came to visit me in the hospital one night. “Did you know they make 3D puzzles?” he asked, passing Erica a cheeseburger that she took outside. When a nurse came in with medications on a tray decorated with red gingham, Rory stopped talking and stared. “The world is so twisted sometimes,” he said after the nurse left, laughing and shaking his head. “Who do they think they are bringing your drugs in on a French fry tray?” I’d considered this question myself hundreds of times. After Rory and Erica left that night, with the darkness outside swallowing my tiny hospital room, I opened my laptop and watched a show where hunters in Montana cooked deer ribs on a campfire.</p>



<p>At Christmas, Erica’s family came to San Francisco because it would’ve been impossible for me to travel. They cooked Swedish and Korean food —traditions from both sides of Erica’s family. I chose to walk our dog.&nbsp;</p>



<hr>



<p>Humans diverge from animals when it comes to our social and cultural meaning behind food. As Sue McLaughlin, one of the authors of <em>The Meaning of Food</em>, said, “Like all animals, we eat to survive. But as humans, we transform simple feeding into the ritual art of dining, creating customs and rites that turn out to be as crucial to our well-being as are proteins and carbohydrates.”</p>



<p>In addition to sensory deprivation, not eating is social deprivation. In a survey of 51 patients on enteral nutrition, most patients complained that they were socially isolated and experienced a loss of identity. What you cook, how you cook for others, and when you eat provide structure to your days and a sense of self. Food is a form of communication. Without it, you are adrift and missing a functional language.&nbsp;</p>



<p>They mostly use qualitative surveys to study the impacts of nutritional therapy on patient quality of life. Even if the physiological need for food is met, there is undeniably a physical and psychological effect for patients on TPN. Up to half of patients report being constantly tired; up to one-third have anxiety; one quarter are clinically depressed.&nbsp;</p>



<p>I recently found a note on my computer titled “Food to Eat,” that listed what I was craving when I was on TPN: black pepper crabs, pecan waffles, meat pies, Turkish delight, and, of course, roast chicken. I have no memory of how I came to want these particular foods. Instead, I remember all the ways my body told me something was wrong. But the hunger, the sense of loss, and the search for connection in cooking shows were a perfectly normal response, as it turns out. Maybe as close to the human experience as you can get.&nbsp;</p>



<hr>



<p>After the surgery, I woke up in a room on the hospital’s fifth floor that looked over the city’s tallest building, the newly built Salesforce Tower. Erica bounced as she told me the surgeon had performed a masterful operation. He removed only six inches of bowel and fixed the bladder. The surgery rescued me from any more TPN in the immediate future while nudging me ever so slightly closer to a future without food—again, relief and suffering at the same time.&nbsp;</p>



<p>My surgeon came in late one evening. “I hate that thing,” he said, nodding toward the Salesforce Tower out the window. “It looks like a giant penis.”&nbsp;</p>



<p>“Really?” I said. “I think it looks like a burrito.”</p>



<hr>



<p><em><a href="http://www.andrewgchapman.com/" target="_blank" rel="noreferrer noopener">Andrew&nbsp;Chapman</a>&nbsp;is a science and medicine writer based in Truckee, California. His work has appeared in&nbsp;</em>Scientific American<em>,&nbsp;</em>Hakai Magazine<em>, and&nbsp;</em>Eos<em>,&nbsp;amongst others.</em></p>



<p><em>Editor:&nbsp;<a href="https://twitter.com/wells_ca" target="_blank" rel="noreferrer noopener">Carolyn Wells </a><br>Fact-checker:&nbsp;<a href="https://twitter.com/collazoprojects" target="_blank" rel="noreferrer noopener">Julie Schwietert Collazo</a><br>Copyeditor:&nbsp;<a href="https://bsky.app/profile/kristastevens.bsky.social" target="_blank" rel="noreferrer noopener">Krista Stevens</a></em></p>
	</div><!-- .entry-content -->

	<!-- .entry-footer -->

	
</article><!-- #post-${ID} -->
				</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[El Prado Museum – Virtual Tour (116 pts)]]></title>
            <link>https://www.museodelprado.es/visita-virtual-coleccion-2023</link>
            <guid>40079516</guid>
            <pubDate>Thu, 18 Apr 2024 18:54:46 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.museodelprado.es/visita-virtual-coleccion-2023">https://www.museodelprado.es/visita-virtual-coleccion-2023</a>, See on <a href="https://news.ycombinator.com/item?id=40079516">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="txtAux">
          <p>El recorrido &lt;em&gt;TITULORECORRIDO&lt;/em&gt; se ha creado correctamente. Añade obras desde la página de Colección</p>
          <p>Añadido &lt;em&gt;TITULOOBRA&lt;/em&gt; en el recorrido &lt;em&gt;TITULORECORRIDO&lt;/em&gt;</p>
      </div><div>

      			              
			              
			<section>          

<p><img src="https://content3.cdnprado.net/imagenes/proyectos/personalizacion/7317a29a-d846-4c54-9034-6a114c3658fe/cms/logo_eu_financiado.jpg" alt="Financiado por la Unión Europea - NextGenerationEU">
  <img src="https://content3.cdnprado.net/imagenes/proyectos/personalizacion/7317a29a-d846-4c54-9034-6a114c3658fe/cms/logo_ministerio2023.jpg" alt="Gobierno de España - Ministerio de Cultura">
  <img src="https://content3.cdnprado.net/imagenes/proyectos/personalizacion/7317a29a-d846-4c54-9034-6a114c3658fe/cms/logo_prtr2023.jpg" alt="Plan de Recuperación, Transformación y Resiliencia">
  <img src="https://content3.cdnprado.net/imagenes/proyectos/personalizacion/7317a29a-d846-4c54-9034-6a114c3658fe/cms/logo_mnp.jpg" alt="Museo Nacional del Prado">
</p>			</section>              
			<div id="introduccion">&nbsp;
	<p>Pasea por el Museo recorriendo las plantas baja, primera y segunda a través de las panorámicas 360º que permiten apreciar las obras y su disposición en las salas. Puedes recorrer una selección de 89 obras digitalizadas en gigapixel, incluyendo 5 esculturas en 3D-Photo.</p>

	<p>
		<a href="https://www.museodelprado.es/actualidad/multimedia/la-coleccion/e97b3d7c-ab15-f91d-0d4d-8a57d57a32f9?visit=true&amp;lang=es">Accede a la visita virtual</a>
	</p>
</div>              
			<section id="recorridos">          

<div id="recorridos">
    <h2>Diez recorridos por la Colección</h2>
    <p>A partir de la digitalización de salas y obras en alta resolución, se han creado recorridos temáticos que, a través de una selección de obras, explican mediante una introducción locutada los detalles que luego puedes descubrir accediendo a cada obra.</p>
  </div>              
			<div id="faq">&nbsp;
	<h2>Preguntas frecuentes</h2>

	<h3>¿Cómo navegar por la visita libre?</h3>

	<p>Hay varias formas de navegar libremente por la visita virtual. Puedes utilizar el <strong>minimapa</strong> 
		<span>1</span>
		abajo a la izquierda para moverte directamente entre salas y plantas del Museo, utilizar las <strong>flechas</strong> 
		<span>2</span>
		en la vista 360º que te guiarán por un itinerario sugerido o las <strong>miniaturas</strong> 
		<span>3</span>
		de panorámicas de la parte inferior.</p>

	<p>
		<img alt="Imagen de ayuda a la navegación por la visita virtual" src="https://content3.cdnprado.net/imagenes/proyectos/personalizacion/7317a29a-d846-4c54-9034-6a114c3658fe/cms/visitavirtual_tutorial2.jpg"></p>

	<h3>¿Por qué hay obras expuestas que faltan y salas que han cambiado?</h3>

	<p>La digitalización se hizo entre noviembre de 2022 y marzo de 2023. Las obras del Museo cambian de ubicación debido a montajes expositivos en salas, préstamos, restauraciones, etc., constantemente por lo que no hay una correspondencia exacta entre la visita virtual y la visita física al Museo. Si quieres conocer el detalle de la digitalización, 
		<a href="https://content3.cdnprado.net/doclinks/pdf/visita/visita-virtual-coleccion-2023/fechas_digitalizacion_visita_virtual_2023.pdf">consulta la relación de fechas de digitalización (PDF)</a>
		.</p>

	<h3>¿Se han digitalizado todas las salas del museo? ¿Qué espacios no se incluyen en visita libre?</h3>

	<p>Por motivos de tiempo, no se han incluido las salas de la Planta Sótano ni el Tesoro del Delfín. En el resto de plantas se han digitalizado todas las salas y espacios que cuentan con obras de la Colección, incluidos espacios como el Hall de entrada, el Claustro de los Jerónimos así como pasillos y escaleras.</p>
</div>              
			<section>          

<p>Financiado con fondos del Plan de Recuperación, Transformación y Resiliencia de España (PRTR) y vinculado a la actuaciones dentro del programa C.24 I3 Digitalización e impulso de los grandes servicios culturales, incluido en el eje Prado Formación y dentro de la actuación “Experiencia expositiva inclusiva” y de la actividad Visitas 360/realidad aumentada de exposiciones temporales y colección permanente.</p>
			</section>              

      </section></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[HNInternal: Ask HN: One-person companies—how do you manage it all and stay sane? (113 pts)]]></title>
            <link>https://news.ycombinator.com/item?id=40078720</link>
            <guid>40078720</guid>
            <pubDate>Thu, 18 Apr 2024 17:41:13 GMT</pubDate>
            <description><![CDATA[<p>See on <a href="https://news.ycombinator.com/item?id=40078720">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><td><table>
        <tbody><tr id="40078720">
      <td><span></span></td>      <td><center><a id="up_40078720" href="https://news.ycombinator.com/vote?id=40078720&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center></td><td><span><a href="https://news.ycombinator.com/item?id=40078720">Ask HN: One-person companies—how do you manage it all and stay sane?</a></span></td></tr><tr><td colspan="2"></td><td><span>
          <span id="score_40078720">103 points</span> by <a href="https://news.ycombinator.com/user?id=terabytest">terabytest</a> <span title="2024-04-18T17:41:13"><a href="https://news.ycombinator.com/item?id=40078720">5 hours ago</a></span> <span id="unv_40078720"></span> | <a href="https://news.ycombinator.com/hide?id=40078720&amp;goto=item%3Fid%3D40078720">hide</a> | <a href="https://hn.algolia.com/?query=Ask%20HN%3A%20One-person%20companies%E2%80%94how%20do%20you%20manage%20it%20all%20and%20stay%20sane%3F&amp;type=story&amp;dateRange=all&amp;sort=byDate&amp;storyText=false&amp;prefix&amp;page=0">past</a> | <a href="https://news.ycombinator.com/fave?id=40078720&amp;auth=69b260a44986571d242ef865ec8a9b643266a215">favorite</a> | <a href="https://news.ycombinator.com/item?id=40078720">77&nbsp;comments</a>        </span>
              </td></tr>
    <tr></tr><tr><td colspan="2"></td><td><div><p>I run a one-person company and struggle with the workload across planning, development, finance and managing contractors.</p><p>How do others in similar situations manage tasks and maintain sanity? Which strategies and tools do you find effective?</p></div></td></tr>        <tr></tr><tr><td colspan="2"></td><td><form action="comment" method="post"></form></td></tr>  </tbody></table><table>
            <tbody><tr id="40079603"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079603" href="https://news.ycombinator.com/vote?id=40079603&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>The major trick, IMHO, is not to grow.<p>While a "normal" startup is focused on growing! growing! growing! a small company should instead think like a physical restaurant:</p><p>"I have 10 tables * 4 seats. 4 waiters. Operate Lu-Fri 10 am - 6 pm. I can serve only up to 40 customers max per hour. My income will never be bigger than 40* Average meal. My income needs to be at minimum Costs + 3% profits".</p><p>Then you see you have too many waiters. You cut it to 2.</p><p>Then you see your meals are too cheap. You increase it a little.</p><p>Then you see you have little customers. You grow a little.</p><p>Then you see you have TOO MUCH customers. You stop growing. More costly take-over, increase the cost of the meal, etc.</p><p>What you NOT MUST DO is grow more than your max capacity.</p><p>That is it.</p><p>Size your capacity. Figure a nice profit. Keep it small.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="40080111"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_40080111" href="https://news.ycombinator.com/vote?id=40080111&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>Another example from another context: I have a friend who became a solo consultant. Specifically, she is great at diagnosing and fixing dysfunctional relationships between executives that can tank productivity for a whole company.<p>She found herself with too many clients, too much work, not enough sleep, and was frustrated that sometimes people didn’t even listen to her advice. She was happy as a solo practitioner and didn’t want to manage people.</p><p>My advice to her was to raise her rates…a lot. (Somehow that hadn’t occurred to her.) Now she’s happy with her time commitment, still well-compensated, and people pay attention because they’re paying more!</p><p>Bottom line: don’t assume you have to grow, but you do need to keep searching for the optimum setup for the size you want to be.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="40080271"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_40080271" href="https://news.ycombinator.com/vote?id=40080271&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>A co-worker of mine visited French Polynesia a few years ago. He mentioned most of the restaurants simply close up shop when they feel they’ve made enough money for the day. Not great for someone looking to get dinner, but I’m sure it makes life much better and less stressful for the owner and employees. They know to get by they need to make $X/day. If they hit it by 1pm, cool, half day.</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="40080702"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_40080702" href="https://news.ycombinator.com/vote?id=40080702&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>This behavior was also observed in New York Cab drivers in the paper LABOR SUPPLY OF NEW YORK CITY CABDRIVERS:
ONE DAY AT A TIME<p><a href="https://www.cmu.edu/dietrich/sds/docs/loewenstein/NYCCabdrivers.pdf" rel="nofollow">https://www.cmu.edu/dietrich/sds/docs/loewenstein/NYCCabdriv...</a></p><p>&gt; ... Our interpretation of these ndings is that cabdrivers (at least inexperi-
enced ones): (i) make labor supply decisions “one day at a time” instead of inter-
temporally substituting labor and leisure across multiple days, and (ii) set a loose
daily income target and quit working once they reach that target
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="40080528"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_40080528" href="https://news.ycombinator.com/vote?id=40080528&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>Wonder if they also run out of ingredients? Seems like a nice way to simplify operations if you don’t ever end up with waste.</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="40080940"><td><table>  <tbody><tr>    <td indent="3"><img src="https://news.ycombinator.com/s.gif" height="1" width="120"></td><td>
      <center><a id="up_40080940" href="https://news.ycombinator.com/vote?id=40080940&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>Yes, most probably this. The grocery list is retro planned from the wages of the employees. So when they served the last dish, they earned their salary, they split the money and close the restaurant</span></p></div></td></tr>
        </tbody></table></td></tr>
                  <tr id="40080706"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_40080706" href="https://news.ycombinator.com/vote?id=40080706&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>That helps the community too as every restaurant has a better chance to hit their own goal. Obviously this only works in a place with a population who all know each other.</span></p></div></td></tr>
        </tbody></table></td></tr>
                  <tr id="40079890"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_40079890" href="https://news.ycombinator.com/vote?id=40079890&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>Indeed.<p>I'd only add (or rephrase other comments to the same effect) that slow growth is not only about staying within your capacity, it's also about learning what you're doing so well that you can systematize your processes for maximum results with as little speculation and risk as possible.</p><p>You could call that "being efficient," I guess, but I think I mean it in the macro sense, not looking for nickel and dime efficiencies.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="40079632"><td></td></tr>
            <tr id="40079845"><td></td></tr>
            <tr id="40080828"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_40080828" href="https://news.ycombinator.com/vote?id=40080828&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>&gt; While a "normal" startup is focused on growing! growing! growing! a small company should instead think like a physical restaurant:<p>in tech you still can be focused on users/customers/revenue grows but not headcount/process complexity grows, since you are not limited by number of tables like in restaurant.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="40079736"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_40079736" href="https://news.ycombinator.com/vote?id=40079736&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>Wouldn't a real restaurant increase the sitting area, open a second location or increase prices if it had more clients than it could serve?</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="40079843"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_40079843" href="https://news.ycombinator.com/vote?id=40079843&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>I sell stuff to a lot of restaurants. Most of the people that open a second location end up making less money or end up closing everything after they just get run into the ground. Then again, some people do it successfully and make way more money. It just depends on so many things.</span></p></div></td></tr>
        </tbody></table></td></tr>
            <tr id="40079803"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_40079803" href="https://news.ycombinator.com/vote?id=40079803&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>Not at all, depends on the owners goals in life. If the goal is to make as much money as possible and you don't mind over working then it could grow, or take on a partner.<p>There was a great breakfast place near me ran by the guy who owned basically all the commercial real estate on the block - the breakfast place was only open in the mornings 6 days a week and occasionally the owner would come in and serve, it was basically a passion project and he wanted to make enough to pay for it. After 15ish years of running he started hosting popups at night and another 4-5 years after that sold to one of the popups. It was a real restaurant and widely love by those in the know.</p><p>You could say El Bulli fits the bill of don't expand, they shut down after a while and converted the space into food research and events center. A little different, but I was trying to think of a more famous "real restaurant".
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="40079801"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_40079801" href="https://news.ycombinator.com/vote?id=40079801&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>If that’s an option, yes. But for many it isn’t. The building isn’t owned by them. Or there’s no available space next door to expand into. Or the capital cost of remodeling that new section is too high. Or the profit margins are so small they can’t justify the cost. Or they’re already maxed out on loans and can’t afford more.</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="40079888"><td><table>  <tbody><tr>    <td indent="3"><img src="https://news.ycombinator.com/s.gif" height="1" width="120"></td><td>
      <center><a id="up_40079888" href="https://news.ycombinator.com/vote?id=40079888&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>And a second restaurant is still a second restaurant. There's still a very high (&gt;50% for sure) chance it fails. The second location isn't quite as good. The manager you hire starts to slack off a bit. Food critic gets sick during opening week. A close family member dies and you ignore the restaurant(s) for just a little too long. The list of things that could happen that boil down to "bad luck" is endless.</span></p></div></td></tr>
        </tbody></table></td></tr>
                              <tr id="40079257"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079257" href="https://news.ycombinator.com/vote?id=40079257&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>I don't manage it all. Something is always slipping and I always feel like I am falling behind.<p>That said, here are some tactics I've used over ~2 years as a solo founder to try to keep it together:</p><p>1. Focus weeks on certain functions - ie work on developing features for one week and then switch to marketing tasks the next. Admittedly harder than it seems, but when actually followed, find I make considerable progress on that week's topic of focus. Also forces me to accomplish harder work (marketing/sales for me) vs. retreating to what is most comfortable (developing).</p><p>2. Speaking with other founders / leaders in the space I operate. This has been especially helpful as I've struggled with a growth/marketing strategy and speaking with others selling adjacent products in the same space has unblocked me many times.</p><p>3. Keeping realistic expectations that I'm doing this solo and it will be very difficult at times. Also harder than it seems.</p><p>4. Keep a founder's log to persist notable events and learnings. Useful when feeling particularly overwhelmed as I can revisit how much has been accomplished.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="40079958"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_40079958" href="https://news.ycombinator.com/vote?id=40079958&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>#4 is something I need to do ASAP, appreciate the tip. It's easy to see the chasm of what's still ahead but forget how far you've come.</span></p></div></td></tr>
        </tbody></table></td></tr>
            <tr id="40080321"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_40080321" href="https://news.ycombinator.com/vote?id=40080321&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>#2 resonates. But not only leaders in the space you're building. Talk to leaders who have built one person companies. It's a unique skillset.</span></p></div></td></tr>
        </tbody></table></td></tr>
                  <tr id="40079389"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079389" href="https://news.ycombinator.com/vote?id=40079389&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>Don't nickle and dime yourself on tools that save you time. If there's a SaaS offering that can reduce your workload, just pay for it (unless it's a truly ridiculous amount).<p>Every so often there's a post on HN where a someone lists their income and expenses and the comments are always full of things like "why are you paying $100/year for Notion when you can just use org-mode for free?" Don't listen to them. Your time is worth more than any reasonable subscription fee.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="40079517"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_40079517" href="https://news.ycombinator.com/vote?id=40079517&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>"Your time is worth more than any reasonable subscription fee. "<p>Sure, but what do I do, if that service just closes tomorrow? Or they change the fee to "unreasonable" (after they gained control of the market).</p><p>A SaaS would have to be way better than any offline tool, I could use 10 years from now in this shape. But in general yes, don't skimp and loose time, when there is a working alternative.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="40081305"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_40081305" href="https://news.ycombinator.com/vote?id=40081305&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>Solve today's problems today. Solve tomorrow's problems tomorrow.<p>If Notion announces a shutdown at some point, you can export your content and import it somewhere else. The amount of time it takes to do that later won't be that big of a deal.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="40079576"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_40079576" href="https://news.ycombinator.com/vote?id=40079576&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>&gt; Sure, but what do I do, if that service just closes tomorrow?<p>You're far more likely to die tomorrow than Notion to close abruptly tomorrow.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="40079797"><td><table>  <tbody><tr>    <td indent="3"><img src="https://news.ycombinator.com/s.gif" height="1" width="120"></td><td>
      <center><a id="up_40079797" href="https://news.ycombinator.com/vote?id=40079797&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>Is this true though? Doesn’t pass the sniff test since most people last a lot longer than most companies.<p>I checked and the probability of death for an American in their 30s (median American is 37 years old) is under 0.2% in any year. I think there’s a far larger than 1 in 500 chance that Notion goes under or is acquired and cancelled.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="40079981"><td><table>  <tbody><tr>    <td indent="4"><img src="https://news.ycombinator.com/s.gif" height="1" width="160"></td><td>
      <center><a id="up_40079981" href="https://news.ycombinator.com/vote?id=40079981&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>Parent means it figuratively: you're majoring in the minors if your reason for not relying on services / others is the _possibility_ that one day they go away.</span></p></div></td></tr>
        </tbody></table></td></tr>
                  <tr id="40079789"><td></td></tr>
                  <tr id="40081233"><td></td></tr>
                  <tr id="40079489"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_40079489" href="https://news.ycombinator.com/vote?id=40079489&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>I will also add - don't buy/subscribe to a tool that is a pile of building blocks that will allow you to build your own solution. Now you have taken on a new project. Just get something that works well enough out of the box.</span></p></div></td></tr>
        </tbody></table></td></tr>
                  <tr id="40081524"><td></td></tr>
            <tr id="40079528"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079528" href="https://news.ycombinator.com/vote?id=40079528&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>Unsure if this is healthy - but after 12 years it’s by almost completely compartmentalising my mind, and focusing on one thing at a time. Started that habit as a freelancer and it’s probably saved me from burnout multiple times.<p>These days I feel like my attention is like a lighthouse, I’ll do a half day of finances here - clear my inbox there, a full week on some deadline, etc. its kind of finding a flow. needless to say this works better when your calendar isn’t flooded already</p><p>Also I put everything and I mean everything in lists or notion, I’ll put every email to reply to, every feature I need to build every decision I need to remember. The less I’m holding on to the more I can focus without feeling like I’m forgetting something.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="40079570"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_40079570" href="https://news.ycombinator.com/vote?id=40079570&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>What you're describing is the Get Things Done (GTD) method. Have you read the book from David Allen?<p>With that note, I higly recommend the book to OP!
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="40081415"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_40081415" href="https://news.ycombinator.com/vote?id=40081415&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>I have heard of but not read, this is just a collection of hard won coping strategies!<p>I will say it has some downsides, though - I feel pretty fragmented outside of work.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                        <tr id="40079222"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079222" href="https://news.ycombinator.com/vote?id=40079222&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>As a first pass, you could try "profiling" how you spend your time, like you would for improving the performance of software.<p>That might be the easiest first pass.  Then you can do the bigger things like: "I'm spending 1/4 time managing contractors, and 1/3 doing planning for which most of that time is due to needing to coordinate and adapt to contractors... So, do I need contractors?  I need someone.  What about a different contractor setup that doesn't need so much handholding?  Or an employee?  Or change the nature of the work?"  Etc.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="40079156"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079156" href="https://news.ycombinator.com/vote?id=40079156&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>If you're struggling to the extent that you're questioning your sanity, you're trying to do too much. There's a limit to what a single person can do.<p>If you want to stay a one-person company and keep your sanity, do less. Otherwise, figure out how to hire employees. But in this case, it's going to be a long journey still.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="40079500"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079500" href="https://news.ycombinator.com/vote?id=40079500&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>This is something I've been struggling with recently. After a few years of adding customers at a fairly slow rate, this year I've already doubled the amount of customers I have. Unfortunately, it still isn't enough to hire an employee. I've gone from ramen profitable and doing freelance to fill the gap, to ditching freelancing altogether and working on the application full-time.<p>The first mistake I made was not saying no to customers. I ended up putting in basically 3 months of work between two customers adding features that would only benefit them. After that, one of them still wanted more, but I was at the end of my rope at that point and told them no.</p><p>Now, because I have more customers, I get a lot more support and feature requests. I've been trying to streamline support by setting up a better system for tracking these tickets as some have been slipping through the cracks. I've also been trying to put as much information in my support documentation as possible. Unfortunately, the feature requests have pulled me away from both of these efforts. There are just SO MANY feature requests.</p><p>To deal with the feature requests, I've really had to rethink how my application is built. Some things that should have been easy to implement have taken a lot more effort because of sloppy work I did previously trying to get features out. On the plus side, it has made me grow a lot as a software engineer because I can see how everything has played out over the years and I have a much better idea of why things should be built in a certain way. The downside is there are some systems that work and customers depend on, but to do it the right way would be a gargantuan effort. At some point I want to just get rid of them, but it's going to be painful, like sawing off an infected limb.</p><p>Once I get through most of the cruft with that, a lot of the new features that need to be implemented will be a breeze and that will hopefully free up more time for marketing, which I do basically none of. That's really the crux of it though. To hire employees I need more growth, for more growth I need to work on marketing. To work on marketing, I need to spend less time on support and feature requests.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="40079899"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_40079899" href="https://news.ycombinator.com/vote?id=40079899&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>&gt; Unfortunately, it still isn't enough to hire an employee.<p>A word of experience about having employees: avoid it for as long as you can. Everyone you hire is expensive -- not only in terms of money, but in terms of the additional time they'll take up and hassle involved.</p><p>My personal rule is "don't hire someone unless you're at imminent risk of losing a bunch of money if you don't".
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                  <tr id="40079860"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079860" href="https://news.ycombinator.com/vote?id=40079860&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>The biggest lesson I've learned is to be very clear and honest about what you personally are good at and have the bandwidth to do, outsource the other stuff, and keep your goals in line with your available resources (which are mostly your time and energy).<p>By "outsource the other stuff", I mean things like hiring a bookkeeping service to keep your books and handle tax reporting all the way through to contracting out those jobs that you don't have the skills, time, or energy to do well.</p><p>The most important asset your business has is yourself. Keep that asset in good health, use it wisely, and don't abuse it.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="40079456"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079456" href="https://news.ycombinator.com/vote?id=40079456&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>Finances: Do them monthly. On the first work day of each month, I do my finances. I collect all the receipts, bank account statements etc and send them to my accountant. If there's any problem, he lets me know right away. It takes me an hour or two, but it's important I don't procrastinate on this.<p>When I was just starting out, I did that stuff at the end of the year, and it was extremely much work, trying to hunt down receipts for payments made a year ago. Now it's just this thing I do regularly, and at the end of the year it's all done already.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="40079030"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079030" href="https://news.ycombinator.com/vote?id=40079030&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>Even in a one-person company you don't have to do everything alone. You can offload certain things to other people. For example, you can get an accountant to do the finance stuff for you. There might also be tools that you can buy or rent that take away some of the load. There are lots of tools for building websites and payment solutions for example. I am sure there are planning tools as well. And once you have outsourced as much as you can, if you still cannot manage the load, that might be a signal that you need to really grow your company and to hire people, although there is also the possibility to subcontract part of your work if you do not want to commit to that.</span></p></div></td></tr>
        </tbody></table></td></tr>
            <tr id="40079451"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079451" href="https://news.ycombinator.com/vote?id=40079451&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>Currently I'm building Plandex[1], a terminal-based AI coding tool, solo (though I hope to build a team around it in the future if I can swing it) and I'm also running EnvKey[2], a secrets management saas, as a sole operator.<p>You don't really stay completely sane, but you can get better at it. You have to get used to the feeling that you can never keep up or do enough. You just do the best you can and learn to live with that. The most important thing is not to get overwhelmed or paralyzed and then end up procrastinating/doing nothing. Making any kind of progress each day, even if it's something small, is a win.</p><p>For me, developing sustainable routines has been critical. Over time I have developed a routine that includes frequent exercise, family time, socializing, eating healthy, and sleeping enough, and I mostly don't compromise on those things unless there's literally an emergency (I do my best to build systems in a way that makes emergencies very rare).</p><p>I also do some more questionable things like work 20 hour marathon all-nighter sessions when I'm pushing hard to get something done, but then I'll follow that up with 12+ hours of sleep the next night and a more relaxed day or two. It's just a matter of finding a balance that works for you.</p><p>1 - <a href="https://github.com/plandex-ai/plandex">https://github.com/plandex-ai/plandex</a></p><p>2 - <a href="https://envkey.com/" rel="nofollow">https://envkey.com</a>
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="40081204"><td></td></tr>
                <tr id="40081227"><td></td></tr>
                        <tr id="40079449"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079449" href="https://news.ycombinator.com/vote?id=40079449&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>I'm frequently reminded of the adage: "You want to go fast? Go alone. Want to go far? Go with a team." The team could be people or as others have suggested, tools and processes that reduce your workload.</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="40080251"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_40080251" href="https://news.ycombinator.com/vote?id=40080251&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>People = meetings, disagreements, politics, recruiting, interviewing, hiring, onboarding, coaching, performance reviewing = less time focusing on what actually matters i.e. building and selling = loosing to the competition.<p>IMO people need to start investing less in building out a team and more in automation. The best solo-founders are going to be those that can effectively product manage AI tools.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                  <tr id="40079039"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079039" href="https://news.ycombinator.com/vote?id=40079039&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>Sanity is overrated. When I am overwhelmed I cope best when I manage to work on the things that <i>feel</i> most important at the moment. It causes the least cognitive dissonance. Now, the difficult part is to make the things that <i>feel</i> most important roughly congruent with the things that <i>are</i> actually important- that's the art. The good news is that it doesn't have to perfect.</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="40079180"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_40079180" href="https://news.ycombinator.com/vote?id=40079180&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>One of the nice things about this vs being employed by someone else, is often the thing that feels the most important probably is!</span></p></div></td></tr>
        </tbody></table></td></tr>
                  <tr id="40079488"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079488" href="https://news.ycombinator.com/vote?id=40079488&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>Only do 1 thing. Find the most important thing and only work on that. For ex: a product feature, sales, or whatever but just only do one thing for at least a week. Then re-evaluate what the most important thing is and do that for the next week.<p>The exception is I do a little customer support every day.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="40079011"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079011" href="https://news.ycombinator.com/vote?id=40079011&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>For the finance and managing contractors, I use Kimai [0]. It can track your time, manage your customers, projects, your team, expenses and even generate your invoices. I only use it for tracking time, managing customers and projects and generating invoices.<p>My full finances are stored in Notion 1, this is because I can access that anywhere, and I can use the built-in table functions to calculate my VAT and tax. When I started, I also used Notion as a CRM that I logged customer/prospect interactions with, but that faded out after a while.</p><p>[0]: <a href="https://www.kimai.org/" rel="nofollow">https://www.kimai.org/</a></p><p>[1]: <a href="https://www.notion.so/" rel="nofollow">https://www.notion.so/</a>
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="40079203"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_40079203" href="https://news.ycombinator.com/vote?id=40079203&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>Confusing pricing for Kimai. Start for free for hosted but I can't find the pricing anywhere on the website but I found a blog post about how it's no longer free. Do you pay for it and try to host it?</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="40079253"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_40079253" href="https://news.ycombinator.com/vote?id=40079253&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>I self-host it. But you can also use the SaaS version. The pricing for that can be found here: <a href="https://www.kimai.cloud/pricing" rel="nofollow">https://www.kimai.cloud/pricing</a><p>Currently, this is:</p><p>Standard
€2.99 Annual €35.88 per user</p><pre><code>    Project time-tracking
    Billable and non-billable hours
    Invoicing
    Data export
    Audit logs
    Industry-specific translations
    Personal Support
</code></pre>
Professional
€3.99 Annual €47.88 per user Most popular<pre><code>    All the features of "Standard"
    Overtime account
    Public holiday, vacation, sick leave
    Expense tracking
    Custom fields
    Task planning
    Daily backups for download
    Single Sign-On with SAML
    Custom domain with SSL
    Access restriction via IP
    Annual plan: less bookkeeping</code></pre></span></p></div></td></tr>
        </tbody></table></td></tr>
                  <tr id="40079048"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_40079048" href="https://news.ycombinator.com/vote?id=40079048&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>What kind of finance features does notion have ? It would be interesting to hear how notion can be used for finance ?</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="40079122"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_40079122" href="https://news.ycombinator.com/vote?id=40079122&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>As kreetx said, I use the Excel-like features.<p>For example; the finances for each company should be submitted to the national tax department each quarter. I configured the Notion tables to group them by quarter of the year. For each of these quarters, it will automatically configure the income, outgoing and the result.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="40079093"><td></td></tr>
                        <tr id="40079753"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079753" href="https://news.ycombinator.com/vote?id=40079753&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>Im 15 ish years in.<p>&gt;&gt; one-person company ... managing contractors.</p><p>You're not a one person company if you have to manage contractors. One of the definitions of being a "contractor" is "independent work". Get better people who are self starers, or more motivated, or more flexible or...</p><p>&gt;&gt; planning, development</p><p>The lie corporate tech tells us is that these things are different jobs. You need to re-learn how to play. You're playing with code, and ideas and features. Play has a component that has learning build in.</p><p>Learn to separate GROWING your business (development, new features) and running it (customer service, billing, accounting). Track your time into these two buckets and ask yourself if you're spending the right effort in the right places.</p><p>Lastly. You're going to work hard, maybe harder than you ever have in your life. Sun up to sun set, and then some. You don't get to party, or vacation or socialize.  If you want those sorts of things "get a job" if you want to build and own something then you're going to learn to eat that shit sandwich for a bit. It took me a few years for me to get to a stable place. There are moments where I have to put in the extra time, but they are very infrequent now and mostly include a massive pay day when they happen.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="40079043"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079043" href="https://news.ycombinator.com/vote?id=40079043&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>I have noticed a lot of solopreneurs take proud in doing everything themselves and do not want to hire and expand. Yes, I get it. I once had a lot of employees and it is stressfull with too much responsibility and issues.<p>But, you can have 1 or 2 people. or 5. You don't need to have 10 people, or 100 or 1000.</p><p>With 1 person you can get 150% more done if you structure it well. Why? That one person can specialize. If you wanna talk about this just find me on my blog :)
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="40079597"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_40079597" href="https://news.ycombinator.com/vote?id=40079597&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>But ... even if you have just 1 or 2 people, you have to manage them. You need to have regular meetings to discuss what's done, what's to be done, you have to plan work for them. Large part of why I'm a solopreneur is because I do not want to manage or be managed. It would be awesome to find someone who just magically does great work without needing any attention. Just brief monthly summaries of high quality contributions, better than I could have done. But I'm not sure how to find someone like that, and I also don't think I could afford them ;-)</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="40080049"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_40080049" href="https://news.ycombinator.com/vote?id=40080049&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>Of course you need to manage and it might not be the most fun thing. Same here.<p>But if you have one person, and you spend 15 minutes a day guiding them and giving them tasks, then they have 7-8 hours to do productive work.</p><p>And finding the right people can be hard, but when you finally find the right one it is worth it.</p><p>If you wanna talk about it find a time <a href="https://martinbaun.com/book" rel="nofollow">https://martinbaun.com/book</a>
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                        <tr id="40080741"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40080741" href="https://news.ycombinator.com/vote?id=40080741&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>I assign certain days in a week, (and sometimes hours in a day) to my different personas. I only plan out a few days at a time in advance. I just dump these on my calendar as events. 
Aside from a few unexpected events (like a bot attack that ruined last week for me), its been working well enough.</span></p></div></td></tr>
        </tbody></table></td></tr>
            <tr id="40079651"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079651" href="https://news.ycombinator.com/vote?id=40079651&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>You’re a company, so you have to start thinking as one.<p>You’re not paying a lot for an accountant, you’re investing money that will generate free time and availability for other tasks.</p><p>If you don’t enjoy something, don’t do it. Pay someone else to do it. If your company has a net profit at the end of the year, you have budget to offload tasks to others, who enjoy them and are faster at them.</p><p>Get a manager. Find a business coach who you can have 1-on-1s with once a month, quarter, week, whatever you need. You need to be able to vent about clients, get constructive feedback, review how you handled specific situations, etc.</p><p>And, no, you can’t use your life partner for this.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="40079298"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079298" href="https://news.ycombinator.com/vote?id=40079298&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>You have to delegate. It can be a human or a robot. For example, make stock and use tools for social media content. Use IFTTT, Zapier, Make or n8n. Hire a freelance assistant etc.</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="40079343"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_40079343" href="https://news.ycombinator.com/vote?id=40079343&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>Instead of saving money, don't stop using paid tools! Today I'm getting the top package on the automation tool IFTTT, and my mind is at ease. I'm kicking myself that I wish I hadn't saved money earlier. Using tools that save time and energy increases lifespan. :)</span></p></div></td></tr>
        </tbody></table></td></tr>
                  <tr id="40079348"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079348" href="https://news.ycombinator.com/vote?id=40079348&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>If you have funds for contractors, have you considered applying some towards an assistant?<p>People in our field readily think of hiring help for design, development, etc but there's <i>a lot</i> of value in having somebody who can just take administrative (or personal!) distractions off your plate and they're often much cheaper than technical professionals. And they're far more versatile than many productized "tools"
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="40079354"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079354" href="https://news.ycombinator.com/vote?id=40079354&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>Not a founder, but a good piece of advice I read is to hire a remote PA. They can be cheap, and can help stay on top of things.<p>For me staying organised is the worst. It takes time and effort, can be very boring, the upsides are kind of invisible, downsides can be cataclysmic. Mostly you want to do the interesting bits of being a solopreneur...
              </p></span></p></td></tr>
        </tbody></table></td></tr>
                <tr id="40079411"><td></td></tr>
                  <tr id="40079701"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079701" href="https://news.ycombinator.com/vote?id=40079701&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>What do you all have as your actual product? I feel that's the toughest part: having a product that can be easily maintained by one person yet still gain and retain customers.</span></p></div></td></tr>
        </tbody></table></td></tr>
                <tr id="40081391"><td><table>  <tbody><tr>    <td indent="1"><img src="https://news.ycombinator.com/s.gif" height="1" width="40"></td><td>
      <center><a id="up_40081391" href="https://news.ycombinator.com/vote?id=40081391&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>There are actually two parts here: product(design and engineering) and gaining customers(marketing). Second part is much harder for some people(like me).</span></p></div></td></tr>
        </tbody></table></td></tr>
                  <tr id="40079539"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079539" href="https://news.ycombinator.com/vote?id=40079539&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>Here's the advice I've gotten:<p>1. Hire a VA for mundane stuff.</p><p>2. Hire a coach to fill in your blind spots.</p><p>3. Hire the most senior people you can.
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="40079717"><td></td></tr>
            <tr id="40079921"><td></td></tr>
            <tr id="40079771"><td></td></tr>
            <tr id="40079739"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079739" href="https://news.ycombinator.com/vote?id=40079739&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>Keeping away form VCs that "know better" how to monetize my time seems like a proven technique for managing my time. Money I create directly impacts my loved ones.</span></p></div></td></tr>
        </tbody></table></td></tr>
            <tr id="40079806"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079806" href="https://news.ycombinator.com/vote?id=40079806&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>I did this for 9 years. You don’t stay sane. You’re working 24/7. Best you can do is take vacations and schedule downtime rituals. This is why I no longer do it.</span></p></div></td></tr>
        </tbody></table></td></tr>
            <tr id="40079641"><td><table>  <tbody><tr>    <td indent="0"><img src="https://news.ycombinator.com/s.gif" height="1" width="0"></td><td>
      <center><a id="up_40079641" href="https://news.ycombinator.com/vote?id=40079641&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><p><span>I've been working on Temple Tools[1] (CRM for Synagogues) during evenings and weekends while maintaining my day job with no drops in productivity or outcomes (in fact I've performed better) for about 9 months and have gotten a good amount of traction. I was really afraid that it was going to take over my life but I'm very happy with how straightforward things have been. Building a CRM solo has been quite a lift but it's gone quite well.<p>Here are my tips:</p><p>• Get your first customer as early as possible. I know this isn't "new" advice but feedback from one customer was enough to keep my busy patching holes in the product for a good 2 months straight. If I waited and got my first 10 customers all at once I would have drowned</p><p>• Separate functions into days of the week as much as possible! I've found this to be critical for not burning out and maintaining high productivity over extended periods (9 months doesn't sound like much, but it's a long time to put in essentially an extra work week). For me Mon is Marketing, Tue-Fri is coding, Sat is marketing and non-urgent customer support, and Sun is coding</p><p>• Don't stop exercising. Exercise MORE. I'm a night owl but I transitioned to the "at the gym at 5am" guy, lunchtime run, and Jiujitsu in evenings; and I ended up somehow spending <i>more</i> time plugging away at the keyboard. The mantra "the way you do anything is the way you do everything" really comes to mind.</p><p>• Put dates on your calendar for meta-tasks. I have a recurring bi-weekly task to update my finances, a task to do keyword analysis, etc etc. It's too easy for these to slide otherwise</p><p>• Creative uses of ChatGPT! I'm using Nylas' free tier and the ChatGPT API to automate triaging my own customer support emails, and texting myself if it's urgent. This lets me have near-zero interruptions during my day job from my side hustle.</p><p>• More ChatGPT. If you don't know how to do something, talk to ChatGPT interactively to get "good enough" at it quickly. This could be anything from finance to SEO to cold outbound. You still have to think critically enough to ask good questions like "what am I missing here" or "what's going to bite me in the ass". You absolutely need a paid subscription (I use both ChatGPT4 and Claude)</p><p>• Be your own project manager. Do NOT wing it. Sit down every once in a while and list off everything you think you have to do, break it down, triage it, prioritize it, and start burning it down. This includes both product-level tasks and business administration and marketing. This lowers cognitive load so much that you'll find you can actually take work off your mind when you're not working</p><p>• Identify opportunities for crunch times and adjust routine. I've rented an office on three separate months while working on this business. It was a fantastic way to break up the routine and get a huge amount of productivity for a short time</p><p>1 - <a href="https://temple-tools.com/" rel="nofollow">https://temple-tools.com</a>
              </p></span></p></td></tr>
        </tbody></table></td></tr>
            <tr id="40079215"><td></td></tr>
                <tr id="40079299"><td></td></tr>
                <tr id="40081512"><td><table>  <tbody><tr>    <td indent="2"><img src="https://news.ycombinator.com/s.gif" height="1" width="80"></td><td>
      <center><a id="up_40081512" href="https://news.ycombinator.com/vote?id=40081512&amp;how=up&amp;goto=item%3Fid%3D40078720"></a></center>    </td><td><br><div>
                  <p><span>I am wondering if there is some simple way to do taxes for SaaS company in turbotax or something similar, everything(payroll, expenses, revenue) should be very simple?..</span></p></div></td></tr>
        </tbody></table></td></tr>
                  <tr id="40079602"><td></td></tr>
                  </tbody></table>
  </td></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Windows 10 will start nagging you to switch from local account to MS Account (119 pts)]]></title>
            <link>https://www.neowin.net/news/windows-10-will-soon-start-nagging-you-to-switch-from-local-account-to-microsoft-account/</link>
            <guid>40078686</guid>
            <pubDate>Thu, 18 Apr 2024 17:37:11 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.neowin.net/news/windows-10-will-soon-start-nagging-you-to-switch-from-local-account-to-microsoft-account/">https://www.neowin.net/news/windows-10-will-soon-start-nagging-you-to-switch-from-local-account-to-microsoft-account/</a>, See on <a href="https://news.ycombinator.com/item?id=40078686">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
                                                    <span>When you purchase through links on our site, we may earn an affiliate commission. <a href="https://www.neowin.net/terms">Here’s how it works</a>.</span>
                        
                        
                        <p>
    
    <time datetime="Apr 18, 2024 04:02 EDT" pubdate="pubdate">
    Apr 18, 2024 04:02 EDT
    </time>
         · <span>Hot!</span>    
    </p>

                    </div><div itemprop="articleBody">
                                                                        <p><img alt="A late prototype of the Windows 10 stock wallpaper found in a leaked Windows 11 build" src="https://cdn.neowin.com/news/images/uploaded/2023/06/1686472481_img19_story.jpg"></p>

<p>Earlier this week, Microsoft released a new Release Preview update for Windows Insiders who are still using Windows 10. Build 19045.4353 does not contain anything all too exciting, but there is one change that might raise a few eyebrows. Microsoft is now testing new banners in the Settings app to make users with local accounts switch to Microsoft Accounts. <a href="https://www.neowin.net/news/micosoft-account-notifications-are-part-of-windows-10-22h2-release-preview-build-190454353/">The tech giant writes</a>:</p>

<blockquote>


<p><strong>New!</strong> This update starts the rolls out of account-related notifications for Microsoft accounts in Settings &gt; Home. A Microsoft account connects Windows to your Microsoft apps. The account also backs up all your data and helps you to manage your subscriptions. You can also add extra security steps to keep you from being locked out of your account. This feature displays notifications across the Start menu and Settings.</p>
</blockquote>

<p>The change seems to be rolling out gradually, which means not everyone on build 19045.4353 has it yet. However, you can force-enable it using a command for the ViVeTool app. Here is what the new banner looks like:</p>

                            <!-- PLACE THIS SECTION INSIDE OF YOUR BODY WHERE YOU WANT THE VIDEO PLAYER TO RENDER -->
            <figure><a href="https://cdn.neowin.com/news/images/uploaded/2024/04/1713425412_settings_ad.jpg"><img alt="A Microsoft account prompt in the Settings app on Windows 10" height="790" src="https://cdn.neowin.com/news/images/uploaded/2024/04/1713425412_settings_ad.jpg" width="1116"></a></figure><p>If you do not want the Settings app to nag you with Microsoft Account prompts, go to <strong>Privacy &gt; General </strong>and toggle off the "<strong>Show me suggested content </strong><strong>in the Settings app</strong>" option. Also, you can also simply click the close button next to the "Sign in now" button to get rid of the banner.</p>

<p>Here is how to turn the new banner on in case you want to witness it yourself on build 19045.4353:</p>

<ol>
<li>Download ViveTool <a href="https://github.com/thebookisclosed/ViVe/releases">from </a><a href="https://github.com/thebookisclosed/ViVe/releases">GitHub</a> and unpack the files in a convenient and easy-to-find folder.</li>
	<li>Press <strong>Win + R</strong>, type <strong>cmd</strong>, and press <strong>Ctrl + Shift + Enter</strong> to open Command Prompt as Administrator.</li>
	<li>Navigate to the folder containing the ViveTool files with the <strong>CD</strong> command. For example, if you have placed ViveTool in C:\Vive, type <strong>CD C:\Vive</strong>.</li>
	<li>Type <strong>vivetool /enable /id:42563876</strong> and press <strong>Enter</strong>. In order to turn off the new banners in the Settings app, use <strong>vivetool /disable /id:42563876</strong>. Credit for the ID goes to <a href="https://twitter.com/thebookisclosed/status/1780205879209406686">Albacore</a> on X.</li>
	<li>Restart your computer.</li>
</ol>
<p>Microsoft's ongoing fight against local accounts in consumer versions of Windows annoys pretty much everyone, <a href="https://www.neowin.net/news/elon-musk-just-found-out-they-cant-install-windows-11-without-msa-and-is-having-none-of-it/">including Elon Musk</a>. However, Windows 10 still offers a relatively easy way to bypass the MSA requirement during the initial setup. Windows 11, on the other hand, won't let you use a local profile unless you know a magic command (oobe\bypassnro).</p>
                        
                        
                                                                    </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Thoughts on Seed Oil (119 pts)]]></title>
            <link>https://dynomight.substack.com/p/seed-oil</link>
            <guid>40078471</guid>
            <pubDate>Thu, 18 Apr 2024 17:13:34 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://dynomight.substack.com/p/seed-oil">https://dynomight.substack.com/p/seed-oil</a>, See on <a href="https://news.ycombinator.com/item?id=40078471">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><article><div dir="auto"><p>A friend has spent the last three years hounding me about seed oils. Every time I thought I was safe, he’d wait a couple months and renew his attack:</p><blockquote><p><em>“When are you going to write about seed oils?”</em></p><p><em>“Did you know that seed oils are why there’s so much {obesity, heart disease, diabetes, inflammation, cancer, dementia}?”</em></p><p><em>“Why did you write about {meth, the death penalty, consciousness, nukes, ethylene, abortion, AI, aliens, colonoscopies, Tunnel Man, Bourdieu, Assange} when you could have written about seed oils?”</em></p><p><em>“Isn’t it time to quit your silly navel-gazing and use your weird obsessive personality to make a dent in the world—by writing about seed oils?”</em></p></blockquote><p>He’d often send screenshots of people reminding each other that Corn Oil is Murder and that it’s critical that we overturn our lives to eliminate soybean/canola/sunflower/peanut oil and replace them with butter/lard/coconut/avocado/palm oil.</p><p><span>This confused me, because on </span><em>my</em><span> internet, no one cares. Few have heard of these theories and those that have mostly think they’re kooky. When I looked for evidence that seed oils were bad, I’d find people with long lists of papers. Those papers each seemed vaguely concerning, but I couldn’t find any “reputable” sources that said seed oils were bad. This made it hard for me to take the idea seriously.</span></p><p>But my friend kept asking. He even brought up the idea of paying me, before recoiling in horror at my suggested rate. But now I appear to be writing about seed oils for free. So I guess that works?</p><ul><li><p>On seed oil theory</p></li><li><p>On fat</p></li><li><p>The outside view</p></li><li><p>The inside view</p></li><li><p>On distraction</p></li></ul><p><span>I can’t emphasize this enough: There is no clear “best” argument for why seed oils are supposed to be bad. This stuff is coming from internet randos (♡) who differ both in </span><em>what</em><span> they think is true, and </span><em>why</em><span> they think it. But we can examine some common arguments.</span></p><p>One argument is that for most of human history, nobody dieted and everyone was lean. But some time after the industrial revolution, people in Western countries started gaining weight and things have accelerated ever since. Here’s BMI at age 50 for white, high-school educated American men born in various years:</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1a976a20-efff-46c0-8a51-60fe5ed11680_2483x1300.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1a976a20-efff-46c0-8a51-60fe5ed11680_2483x1300.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1a976a20-efff-46c0-8a51-60fe5ed11680_2483x1300.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1a976a20-efff-46c0-8a51-60fe5ed11680_2483x1300.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1a976a20-efff-46c0-8a51-60fe5ed11680_2483x1300.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1a976a20-efff-46c0-8a51-60fe5ed11680_2483x1300.png" width="628" height="328.66483516483515" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/1a976a20-efff-46c0-8a51-60fe5ed11680_2483x1300.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:762,&quot;width&quot;:1456,&quot;resizeWidth&quot;:628,&quot;bytes&quot;:281147,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1a976a20-efff-46c0-8a51-60fe5ed11680_2483x1300.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1a976a20-efff-46c0-8a51-60fe5ed11680_2483x1300.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1a976a20-efff-46c0-8a51-60fe5ed11680_2483x1300.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F1a976a20-efff-46c0-8a51-60fe5ed11680_2483x1300.png 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p><span>For the last few decades, obesity (BMI ≥30) has grown at around </span><a href="https://www.cdc.gov/obesity/data/adult.html" rel="">0.6% per year</a><span>. Clearly we are doing </span><em>something</em><span> wrong. We evolved to effortlessly stay at a healthy weight, but we’ve somehow broken our regulatory mechanisms. Anywhere people adopt a Western diet, the same thing happens.</span></p><p><span>Of course, the </span><a href="https://en.wikipedia.org/wiki/Western_pattern_diet" rel="">Western diet</a><span> is many things. But if you start reading ingredients lists, you’ll soon notice that </span><em>everything</em><span> has vegetable oil in it. Anything fried, obviously, but also instant noodles, chips, crackers, tortillas, cereal, energy bars, canned tuna, processed meats, plant-based meat, coffee creamer, broths, frozen dinners, salad dressing, and sauces. Also: Baby food, infant formula, and sometimes even ice cream or bread. People eat a lot more vegetable oil than they used to (figure from </span><a href="https://doi.org/10.3389/fnut.2021.748847" rel="">Lee et al. (2022)</a><span>):</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F393a56b6-1bc3-4613-b0c5-fed7e3eed668_829x489.jpeg" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F393a56b6-1bc3-4613-b0c5-fed7e3eed668_829x489.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F393a56b6-1bc3-4613-b0c5-fed7e3eed668_829x489.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F393a56b6-1bc3-4613-b0c5-fed7e3eed668_829x489.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F393a56b6-1bc3-4613-b0c5-fed7e3eed668_829x489.jpeg 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F393a56b6-1bc3-4613-b0c5-fed7e3eed668_829x489.jpeg" width="610" height="359.81905910735827" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/393a56b6-1bc3-4613-b0c5-fed7e3eed668_829x489.jpeg&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:489,&quot;width&quot;:829,&quot;resizeWidth&quot;:610,&quot;bytes&quot;:137953,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/jpeg&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F393a56b6-1bc3-4613-b0c5-fed7e3eed668_829x489.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F393a56b6-1bc3-4613-b0c5-fed7e3eed668_829x489.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F393a56b6-1bc3-4613-b0c5-fed7e3eed668_829x489.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F393a56b6-1bc3-4613-b0c5-fed7e3eed668_829x489.jpeg 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p><span>Many vegetable oils (and particularly seed oils) are high in linoleic acid. And guess what’s making up a rapidly increasing fraction of body fat? (figure from </span><a href="https://wholehealthsource.blogspot.com/2011/08/seed-oils-and-body-fatness-problematic.html" rel="">Stephan Guyunet</a><span>):</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6f19718f-5617-44b5-bda6-a4e5658fa478_793x584.jpeg" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6f19718f-5617-44b5-bda6-a4e5658fa478_793x584.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6f19718f-5617-44b5-bda6-a4e5658fa478_793x584.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6f19718f-5617-44b5-bda6-a4e5658fa478_793x584.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6f19718f-5617-44b5-bda6-a4e5658fa478_793x584.jpeg 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6f19718f-5617-44b5-bda6-a4e5658fa478_793x584.jpeg" width="604" height="444.81210592686" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/6f19718f-5617-44b5-bda6-a4e5658fa478_793x584.jpeg&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:584,&quot;width&quot;:793,&quot;resizeWidth&quot;:604,&quot;bytes&quot;:46540,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/jpeg&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6f19718f-5617-44b5-bda6-a4e5658fa478_793x584.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6f19718f-5617-44b5-bda6-a4e5658fa478_793x584.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6f19718f-5617-44b5-bda6-a4e5658fa478_793x584.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F6f19718f-5617-44b5-bda6-a4e5658fa478_793x584.jpeg 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p><span>Even many types of meat now have high linoleic acid levels, because the animals are now eating so much vegetable oil. It’s plausible this is doing </span><em>something</em><span> to us.</span></p><p>Another common argument is that even if we can’t identify exactly where the Western diet went wrong, we know that we spent almost our whole evolutionary history eating like hunter-gathers (and most of the rest eating like subsistence farmers). And hunter-gatherers are all thin. So maybe we should eat like they did?</p><p>That sounds kind of fanciful, but consider the most conventional dietary advice, the thing that every expert screams every time they have a chance—AVOID PROCESSED FOOD.</p><p>The USDA defines processing as:</p><blockquote><p>washing, cleaning, milling, cutting, chopping, heating, pasteurizing, blanching, cooking, canning, freezing, drying, dehydrating, mixing, or other procedures that alter the food from its natural state. This may include the addition of other ingredients to the food, such as preservatives, flavors, nutrients and other food additives or substances approved for use in food products, such as salt, sugars and fats.</p></blockquote><p><span>Basically, don’t do… anything? That sounds awfully similar to eating like a hunter-gatherer. It’s unclear why many of these types of processing would be harmful. (Cooking? </span><em>Washing</em><span>?) But maybe that’s smart—maybe biology and nutrition are so complicated that we shouldn’t even </span><em>try</em><span> to understand them.</span></p><p>Traditional oils involve some processing, but they’re pretty easy. To make butter, you milk a cow and churn the milk. To make olive oil, you grind some olives and press them. To make lard, you take a beautiful pig with hopes and dreams, you kill it, you cut off the fattiest bits, and then you boil them and strain.</p><p>But here’s how you make canola oil: Take rapeseeds, put them through a vibrating sieve, then a roller mill, then a screw press, then do a hexane extraction, then do a sodium hydroxide wash in a centrifuge, then cool and filter out wax, then pass through bleaching clay, then do a steam injection in a vacuum. Whatever comes out of this is not something your DNA anticipates.</p><p><span>Another argument is that seed oils are bad </span><em>experimentally</em><span>. Even if you don’t understand how nutrition works, you can still try stuff—e.g. you can have people replace animal fat (or saturated fat) with vegetable oil (or unsaturated fat) and see if this makes them healthier. Usually, such trials were done with the expectation that they’d show vegetable oils were healthier. And often they do. But in a couple cases—notably the </span><a href="https://doi.org/10.1007/978-1-4684-0967-3_18" rel="">Sydney Diet Heart Study</a><span>, and the </span><a href="https://doi.org/10.1161/01.atv.9.1.129" rel="">Minnesota Coronary Survey</a><span>—the groups with more vegetable oil did worse, not better.</span></p><p><span>Our last argument is that we know </span><em>how</em><span> seed oils hurt you. People seem to suggest five possible mechanisms:</span></p><ol><li><p>Maybe linoleic acid (common in seed oils) is metabolized into arachidonic acid, and thereby causes inflammation.</p></li><li><p>Maybe linoleic acid becomes oxidized LDL and thereby causes inflammation.</p></li><li><p><span>Maybe it’s the </span><em>ratio</em><span> of omega-6 to omega-3 fats you eat that matters.</span></p></li><li><p>Maybe vegetable oil doesn’t make you feel full like animal fats do, meaning vegetable oils lead to overeating.</p></li><li><p>Maybe vegetable oils have an increased propensity to become trans fats.</p></li></ol><p><span>(Details in footnote</span><span><a data-component-name="FootnoteAnchorToDOM" id="footnote-anchor-1-143705491" href="https://dynomight.substack.com/p/seed-oil#footnote-1-143705491" target="_self" rel="">1</a></span><span>)</span></p><p>When first trying to make sense of these arguments, I encountered terms like “cis medium-chain omega-7 polyunsaturated fat”, which left me confused and terrified. (Biochemistry’s enormity has always had a way of making me feel insignificant.) After looking into things, I’m still quite scared, but at least I’ve made the Dynomight Fatty Acid Classifier.</p><p>Fat is made of fatty acids—chains of carbon atoms linked via hydrogen bonds. Usually, these are “single” bonds. But sometimes there are “double” bonds, which are very important because they are easier to break apart. So different fatty acids are categorized mostly based on the double bonds. So, behold:</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf84efcd-f996-4dfd-a5e2-e809ed1e3dff_854x1742.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf84efcd-f996-4dfd-a5e2-e809ed1e3dff_854x1742.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf84efcd-f996-4dfd-a5e2-e809ed1e3dff_854x1742.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf84efcd-f996-4dfd-a5e2-e809ed1e3dff_854x1742.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf84efcd-f996-4dfd-a5e2-e809ed1e3dff_854x1742.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf84efcd-f996-4dfd-a5e2-e809ed1e3dff_854x1742.png" width="460" height="938.3138173302108" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/df84efcd-f996-4dfd-a5e2-e809ed1e3dff_854x1742.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:1742,&quot;width&quot;:854,&quot;resizeWidth&quot;:460,&quot;bytes&quot;:211891,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf84efcd-f996-4dfd-a5e2-e809ed1e3dff_854x1742.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf84efcd-f996-4dfd-a5e2-e809ed1e3dff_854x1742.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf84efcd-f996-4dfd-a5e2-e809ed1e3dff_854x1742.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fdf84efcd-f996-4dfd-a5e2-e809ed1e3dff_854x1742.png 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p>If you want, you can further divide things up in terms of the length of the fatty acid, or even count how many single bonds there are between each double bond.</p><p><span>Here’s a picture (simplified from </span><a href="https://en.wikipedia.org/wiki/Saturated_fat#/media/File:Fat_composition_in_foods.svg" rel="">Mikael Häggström’s version</a><span>):</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F34b75dcd-c60d-4f82-95a7-b39f993fe6f7_816x950.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F34b75dcd-c60d-4f82-95a7-b39f993fe6f7_816x950.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F34b75dcd-c60d-4f82-95a7-b39f993fe6f7_816x950.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F34b75dcd-c60d-4f82-95a7-b39f993fe6f7_816x950.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F34b75dcd-c60d-4f82-95a7-b39f993fe6f7_816x950.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F34b75dcd-c60d-4f82-95a7-b39f993fe6f7_816x950.png" width="424" height="493.62745098039215" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/34b75dcd-c60d-4f82-95a7-b39f993fe6f7_816x950.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:950,&quot;width&quot;:816,&quot;resizeWidth&quot;:424,&quot;bytes&quot;:84543,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F34b75dcd-c60d-4f82-95a7-b39f993fe6f7_816x950.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F34b75dcd-c60d-4f82-95a7-b39f993fe6f7_816x950.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F34b75dcd-c60d-4f82-95a7-b39f993fe6f7_816x950.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F34b75dcd-c60d-4f82-95a7-b39f993fe6f7_816x950.png 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p>Animal fat tends to be high in saturated and monounsaturated fat while vegetable oil tends to be high in polyunsaturated fat. But there are a few notable exceptions (not all listed above):</p><ul><li><p>Olive oil, canola oil, and avocado oil are high in monounsaturated fat.</p></li><li><p>Coconut oil is high in saturated fat.</p></li><li><p>Palm oil has both saturated and monounsaturated fat, but little polyunsaturated fat.</p></li></ul><p>Of course, you can also break things down into different subcategories of fats or even individual fatty acids.</p><p><span>The double bonds in fatty acids have </span><a href="https://en.wikipedia.org/wiki/Cis%E2%80%93trans_isomerism" rel="">two possible configurations</a><span>. They can be “normal” (cis) or they can be “reversed” in a way that leaves the rest of the fatty acid chain “flipped” (trans). (The Dynomight Biologist howls in protest at this description, but is overruled.)</span></p><p>Starting around 100 years ago, people noticed you could “hydrogenate” unsaturated fats by heating them and cramming in extra hydrogen atoms. If this is done completely, it will transform all the double bonds into single bonds, changing the unsaturated fat into saturated fat. This gives something similar to lard, but cheaper. You probably eat hydrogenated vegetable oils all the time—they’re used for “shortening” and are in icing and all sorts of baked and fried foods.</p><p><span>But if you don’t fully hydrogenate the oil you end up with—you guessed it—</span><em>partially</em><span> hydrogenated oil, in which many of the natural cis bonds will be converted to </span><em>trans</em><span> bonds. Partially hydrogenated oils are cheap, have high shelf lives, and can easily be made in a range of consistencies.</span></p><p><span>That’s a shame because trans fats are pretty rare in nature (maybe 3% of butter/canola oil, around </span><a href="https://www.hsph.harvard.edu/nutritionsource/2015/04/13/ask-the-expert-concerns-about-canola-oil/" rel="">0.5%</a><span> of olive oil) and evolution doesn’t seem to have prepared us to eat large amounts of them. The WHO calls them “deadly”. Its consensus that they cause obesity, diabetes, and heart disease, though the mechanism of harm often still isn’t understood. Trans fats started being phased out around the world about 25 years ago. But before that happened, they were estimated to cause 30k to 100k deaths per year in the United States.</span></p><p>So, don’t eat trans fats.</p><p><span>About that, bad news—if you cook with unsaturated fat at high temperature you can make your own trans fats right in your kitchen. Though it </span><a href="https://pubmed.ncbi.nlm.nih.gov/35406103" rel="">seems like</a><span> not much happens if you stay below 200℃, and even with high temperatures and long times, it’s hard to get above 8%. Still, deep-frying with the same oil for days on end seems like a bad idea.</span></p><p><span>And a note for Americans: If your food has less than 0.5 grams of trans fats </span><em>per serving</em><span>, then it can legally be labeled as having “zero” trans fat. Cooking oils typically have a serving size of a tablespoon (14g), meaning that the “zero trans fat” threshold is around 3.6% trans fat. Companies apparently respond to this by diluting their trans-fat-containing products with regular vegetable oil just enough to get down to 3.6%. Ain’t capitalism grand?</span></p><p>Anyway, trans fats seem like a good lesson about unintended consequences and how we should be careful about screwing around with what we eat.</p><p>Trans fats are also sometimes suggested as a reason that animal fats might be healthier than vegetable fats: Animal fats are mostly saturated fat, and saturated fat cannot become trans because it has no double bonds.</p><p>There’s lots to like about seed oil theory. I’m sympathetic to the idea that the modern Western diet is somehow fundamentally broken. (Look at what’s happening to us!) Even if we don’t understand exactly why, it looks like “processing” is bad, and seed oils sure are processed.</p><p>The suggested mechanisms for seed oils to be harmful seem plausible, too. I could believe that omega-6 fats cause oxidization or inflammation or that saturated fats might make you feel more full. Experts seem to agree that most people should eat more omega-3 fats.</p><p><span>And if you want a monocausal story for every modern health problem, inflammation is a good mechanism. We have other cases where one source of inflammation causes a range of seemingly unrelated health problems (e.g. </span><a href="https://dynomight.net/air/" rel="">air pollution</a><span>).</span></p><p><span>Finally, seed oil theorists often suggest replacing unsaturated fat with saturated fat. This conflicts with the old consensus that saturated fat increases the risk of heart disease. But there seems to be increasing doubt about that old consensus </span><a href="https://doi.org/10.1016/j.jacc.2020.05.077" rel="">(Astrup et al. 2020)</a><span>. Many still defend it, but there’s real debate.</span></p><p>So that’s good. But there are also reasons for doubt.</p><p><span>Just because two things happened at the same time doesn’t mean one caused the other. Maybe there’s </span><em>some</em><span> causal relationship, or maybe it’s just random. Let’s not belabor this.</span></p><p><span>Yes, there are plausible mechanisms for seed oils to hurt us. I agree! But complex mechanistic arguments for diet do not have a good track record. So far they’ve worked for… basically nothing? (We’re still debating if eating </span><em>salt</em><span> or </span><em>cholesterol</em><span> are bad for you.)</span></p><p><span>When humans build complex systems we </span><em>modularize</em><span>, so we can understand what’s happening. But evolution is a lunatic. It doesn’t </span><em>care</em><span> about understanding. So biological systems tend to be spectacularly non-modularized. When I started reading </span><a href="https://en.wikipedia.org/wiki/Molecular_Biology_of_the_Cell_(book)" rel="">Molecular Biology of the Cell</a><span> I almost felt like I wanted to throw up, what with all the exceptions to the exceptions to the exceptions.</span></p><p>Did you know that dogs sneeze to signal they’re feeling playful? I guess this happened because evolution wanted a way to signal playfulness, so why not just use an existing instinct for expelling particles? It’s a little confusing, but no big deal, right? Our bodies are a collection of millions of these kinds of hacks stacked on top of each other.</p><p><span>Maybe the mechanisms people give for seed oils are right. I’m no expert, and I’ve exhausted the patience of everyone I know who is. But there are 8 billion other interacting mechanisms. Above all, I don’t understand why seed oil theorists are so damned </span><em>confident</em><span>. It’s fine to speculate about mechanisms, but you do that for choosing what to investigate experimentally, not as a final source of truth.</span></p><p>For example:</p><ul><li><p><span>There are many variants of these theories. Is it all vegetable oil that’s bad, or just seed oil? Is olive oil OK? Or is it unsaturated fat, polyunsaturated fat, omega-6 fat, or just linoleic acid? Is it the omega-6:3 </span><em>ratio</em><span>, and if so then why avoid canola oil with its </span><a href="https://en.wikipedia.org/wiki/Rapeseed_oil#Comparison_to_other_vegetable_oils" rel="">extremely low ratio</a><span>? People who criticize one theory are often told they aren’t arguing against the One True seed oil theory. But what is that?</span></p></li><li><p><span>Say some study gives some people more seed oil, and those people are fine. Is that evidence against seed oil theory? Some say no, because the harms of seed oil are nonlinear—they mostly hurt you when you cross over some threshold. If people were </span><em>already</em><span> past that threshold before the study started, then adding </span><em>additional</em><span> seed oil wouldn’t do more harm.</span></p></li><li><p>Or say you reduce seed oils and don’t get healthier. Evidence against seed oil theory? Again, some say no, because you can’t “un-ring the bell”. When you eat seed oils, you cause your body to get dis-regulated. But fixing your diet won’t make you well-regulated again, because the damage is done.</p></li><li><p><span>People often report switching seed oils out for saturated fats and failing to lose weight. A common response is they should look at </span><em>waistline size</em><span>, not total weight.</span></p></li><li><p><span>Say some trial shows that reducing sugar has a big effect. That might suggest that that seed oils aren’t everything. But some just see this as further proof of seed oil’s primacy—it’s </span><em>because</em><span> of seed oil that the sugar is </span><em>able</em><span> to do harm.</span></p></li></ul><p><span>All of these things are possible. Maybe </span><a href="https://skeptical-science.com/critical-thinkers/dragon-garage-carl-sagan/" rel="">an invisible dragon really </a><em><a href="https://skeptical-science.com/critical-thinkers/dragon-garage-carl-sagan/" rel="">does</a></em><a href="https://skeptical-science.com/critical-thinkers/dragon-garage-carl-sagan/" rel=""> live in your garage</a><span>. But the more such features a theory has, the less I trust it.</span></p><p><span>Some of the big seed oil theorists run companies that sell seed-oil free products. I guess this is a conflict of interest, but… if </span><em>you</em><span> thought seed oils were killing everyone, wouldn’t you want to help provide alternatives? I’m more worried about the internet’s usual trick of corrupting everything by showering attention on the overconfident.</span></p><p><span>If you replace butter with seed oil, what happens? The best way to answer this question is to try it. Fortunately, many trials have been done. I stress: many. In such cases, we shouldn’t stress about individual results because </span><em>anything</em><span> can happen in one trial, from p-hacking to fraud to contaminated coconut oil.</span></p><p><span>The thing to do is look at trials as a whole. Ideally, using a standard methodology. Enter </span><a href="https://doi.org/10.1002%2F14651858.CD011737.pub2" rel="">Hooper et al. (2020)</a><span>, who did a honking meta-analysis of randomized trials in which saturated fat was reduced as part of the (highly respected) Cochrane project. They found that getting more of your overall energy from saturated fat was bad:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4805ecc2-46a6-471f-85fd-2144ad47bb2b_1217x854.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4805ecc2-46a6-471f-85fd-2144ad47bb2b_1217x854.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4805ecc2-46a6-471f-85fd-2144ad47bb2b_1217x854.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4805ecc2-46a6-471f-85fd-2144ad47bb2b_1217x854.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4805ecc2-46a6-471f-85fd-2144ad47bb2b_1217x854.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4805ecc2-46a6-471f-85fd-2144ad47bb2b_1217x854.png" width="1217" height="854" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/4805ecc2-46a6-471f-85fd-2144ad47bb2b_1217x854.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:854,&quot;width&quot;:1217,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:103670,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4805ecc2-46a6-471f-85fd-2144ad47bb2b_1217x854.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4805ecc2-46a6-471f-85fd-2144ad47bb2b_1217x854.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4805ecc2-46a6-471f-85fd-2144ad47bb2b_1217x854.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F4805ecc2-46a6-471f-85fd-2144ad47bb2b_1217x854.png 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p>In more detail, they found that the groups that got less saturated fat:</p><ul><li><p>Had a 21% reduction in cardiovascular events.</p></li><li><p>Had small (3-6%) non-statistically significant reductions in overall mortality, cardiovascular mortality, and cancer.</p></li><li><p>Had cholesterol that looked slightly better by most measures</p></li><li><p>Were an average of 1.8 kg (4 lb) lighter.</p></li><li><p><span>Had no apparent change in cancer </span><em>mortality</em><span>, diabetes, or blood pressure.</span></p></li></ul><p>This seemed to be true regardless of if saturated fat was replaced with polyunsaturated fat or carbohydrates. (There were few trials where it was replaced with monounsaturated fats or protein.)</p><p><em>These meta-analyses are our most important information.</em><span> Averaged over decades of studies, replacing saturated fats with polyunsaturated fats (i.e. replacing butter with seed oil) seems to be </span><em>good for you</em><span>, not bad for you.</span></p><p>I don’t see this as a conclusive, or even close to conclusive. We really need more, bigger, better trials. But at the moment, the experimental evidence suggest vegetable oil is good, not bad.</p><p><span>The </span><a href="https://doi.org/10.1007/978-1-4684-0967-3_18" rel="">Sydney Diet Heart Study</a><span> study ran from 1966 to 1973. In it, 458 middle-aged men with a recent coronary event were randomized to either continue their normal diet or to substitute safflower (seed) oil for saturated fat. The group with the extra seed oil had lower cholesterol, but did worse both in terms of all-cause mortality, and cardiovascular disease.</span></p><p><span>Seed oil theorists talk about this trial a lot. It was a good trial! And the results aren’t good for seed oil. But it is </span><em>included</em><span> in the meta-analysis. Look:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc41e1c55-db65-4a64-a4a3-870530409f25_1504x1546.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc41e1c55-db65-4a64-a4a3-870530409f25_1504x1546.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc41e1c55-db65-4a64-a4a3-870530409f25_1504x1546.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc41e1c55-db65-4a64-a4a3-870530409f25_1504x1546.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc41e1c55-db65-4a64-a4a3-870530409f25_1504x1546.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc41e1c55-db65-4a64-a4a3-870530409f25_1504x1546.png" width="556" height="571.6565934065934" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/c41e1c55-db65-4a64-a4a3-870530409f25_1504x1546.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:1497,&quot;width&quot;:1456,&quot;resizeWidth&quot;:556,&quot;bytes&quot;:348948,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc41e1c55-db65-4a64-a4a3-870530409f25_1504x1546.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc41e1c55-db65-4a64-a4a3-870530409f25_1504x1546.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc41e1c55-db65-4a64-a4a3-870530409f25_1504x1546.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fc41e1c55-db65-4a64-a4a3-870530409f25_1504x1546.png 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p><span>In analysis after analysis, it’s sitting there, being taken into account. Along with </span><em>all the other studies</em><span>, which mostly don’t support the same conclusion. </span><a href="https://www.the-nutrivore.com/post/a-comprehensive-rebuttal-to-seed-oil-sophistry" rel="">The Nutrivore</a><span> points out that the vegetable oil group got </span><a href="https://www.ausfoodnews.com.au/2013/02/11/heart-foundation-takes-swipe-at-butter-and-new-study-on-margarine.html" rel="">Miracle brand margarine</a><span> which was high in trans fats. That </span><em>could</em><span> explain their poor results, but the other group was surely eating some trans fats too, and this kind of single-trial nitpicking makes me nervous.</span></p><p><span>The Minnesota Coronary Survey ran from 1968 to 1973. There’s a story floating around that goes something like this: This was a huge trial with 9,423 subjects in nursing homes and mental hospitals. For the experimental group, they replaced saturated fat with vegetable oil rich in lionleic acid. They expected this to decrease heart disease, but when the opposite happened, the investigators just kind of dropped things. These “inconvenient” results were mostly ignored until 43 years later, </span><a href="https://doi.org/10.1136/bmj.i1246" rel="">Ramsden et al. (2016)</a><span> came around and recovered the old data.</span></p><p><span>When I read this story I was pumping my fist. Fixing publication bias by scrounging up lost data from decades ago! Yes! But when I looked into the details, that story is mostly bogus. The main results of this trial have been available for decades. Here is Figure 6 from </span><a href="https://doi.org/10.1161/01.atv.9.1.129" rel="">Frantz et al. (1989)</a><span>, which clearly shows that the control group does a bit better:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F374326d4-3937-4501-9328-daea0c4ea9a3_1708x1286.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F374326d4-3937-4501-9328-daea0c4ea9a3_1708x1286.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F374326d4-3937-4501-9328-daea0c4ea9a3_1708x1286.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F374326d4-3937-4501-9328-daea0c4ea9a3_1708x1286.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F374326d4-3937-4501-9328-daea0c4ea9a3_1708x1286.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F374326d4-3937-4501-9328-daea0c4ea9a3_1708x1286.png" width="504" height="379.38461538461536" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/374326d4-3937-4501-9328-daea0c4ea9a3_1708x1286.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:1096,&quot;width&quot;:1456,&quot;resizeWidth&quot;:504,&quot;bytes&quot;:187693,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F374326d4-3937-4501-9328-daea0c4ea9a3_1708x1286.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F374326d4-3937-4501-9328-daea0c4ea9a3_1708x1286.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F374326d4-3937-4501-9328-daea0c4ea9a3_1708x1286.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F374326d4-3937-4501-9328-daea0c4ea9a3_1708x1286.png 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p><span>Some say that even if the results were published, they were </span><em>ignored</em><span> before Ramsden et al., but that’s not true either. Check the </span><a href="https://pubmed.ncbi.nlm.nih.gov/?linkname=pubmed_pubmed_citedin&amp;from_uid=2643423" rel="">citations</a><span> if you want—most come before 2016.</span></p><p><span>Now, this study is </span><em>not</em><span> in the meta-analysis. They excluded it because there were high dropout rates, meaning the average subject was only in the trial for only one year. It was also very weird by modern standards—they created fake meat and cheese where the natural fats were replaced with vegetable oil. (There’s a whole sub-debate debate about if that vegetable oil contained trans fat. We’ll probably never know because the records are lost and no one who might remember is still alive.)</span></p><p><span>The exclusion of this study is no conspiracy. Lots of trials where vegetable oils look </span><em>great</em><span> were also excluded. For example, the legendary </span><a href="https://doi.org/10.1016/S0140-6736(72)92208-8" rel="">Finnish Mental Hospital trial</a><span> ran for 12 years and found that a similar (also weird) diet reduced heart disease by almost 50% and overall mortality by 11%. It was excluded because it used a crossover design rather than randomization.</span></p><p>If you want different inclusion criteria, fine! Argue that your criteria are better, and do a new meta-analysis. But ad-hoc inclusion and exclusion of individual studies is a recipe for getting answers that fit with your preconceptions. Just look at the track record of using polling data to predict elections.</p><p><span>I’ve seen people claim that public health authorities in “other countries” support substituting saturated fats for unsaturated fats. This, for the record, is untrue. I looked up the official advice of all the G7 countries plus the WHO, Spain and Australia</span><span><a data-component-name="FootnoteAnchorToDOM" id="footnote-anchor-2-143705491" href="https://dynomight.substack.com/p/seed-oil#footnote-2-143705491" target="_self" rel="">2</a></span><span>:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F973c3874-9827-4206-a371-31c30a4a4aeb_1624x926.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F973c3874-9827-4206-a371-31c30a4a4aeb_1624x926.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F973c3874-9827-4206-a371-31c30a4a4aeb_1624x926.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F973c3874-9827-4206-a371-31c30a4a4aeb_1624x926.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F973c3874-9827-4206-a371-31c30a4a4aeb_1624x926.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F973c3874-9827-4206-a371-31c30a4a4aeb_1624x926.png" width="1456" height="830" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/973c3874-9827-4206-a371-31c30a4a4aeb_1624x926.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:830,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:144147,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F973c3874-9827-4206-a371-31c30a4a4aeb_1624x926.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F973c3874-9827-4206-a371-31c30a4a4aeb_1624x926.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F973c3874-9827-4206-a371-31c30a4a4aeb_1624x926.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F973c3874-9827-4206-a371-31c30a4a4aeb_1624x926.png 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p><span>Seed oil folks often bring up the </span><a href="https://en.wikipedia.org/wiki/French_paradox" rel="">French paradox</a><span>, the (controversial) claim that French people are/were thin and have low cardiovascular disease despite eating lots saturated-fat-rich croissants or whatever. And I guess France comes closest to the seed oil position, since they don’t endorse vegetable oils and suggest increasing α-LA, an omega-3 fat. But France still says to limit saturated fat. Japan seems focused on other things.</span></p><p><span>The most comprehensive meta-review I could find </span><a href="https://doi.org/10.1016/j.jand.2012.03.029" rel="">(Johnson and Fritsche, 2012)</a><span> looked at trials of trials that increased linoleic acid or omega-6 fats (basically, seed oils). It found that “virtually no data” existed to support the idea that this increased inflammation.</span></p><p><span>Beyond that, the suggested “LA → AA” mechanism seems to be basically disproven. The problem is that metabolism of lionoleic acid (LA) into arachidonic acid (AA) saturates at low levels of LA consumption </span><a href="https://doi.org/10.1016/j.plefa.2009.02.003" rel="">(Liou and Innis (2009)</a><span>. A meta-review </span><a href="https://doi.org/10.1016/j.atherosclerosis.2019.11.018" rel="">(Rett and Whelan, 2011)</a><span> found that many different trials that decreased LA by up to 90% or increased it by up to 600% all seemed to do basically nothing:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0a9dd535-0b5d-4186-9b78-796038b31920_2062x700.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0a9dd535-0b5d-4186-9b78-796038b31920_2062x700.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0a9dd535-0b5d-4186-9b78-796038b31920_2062x700.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0a9dd535-0b5d-4186-9b78-796038b31920_2062x700.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0a9dd535-0b5d-4186-9b78-796038b31920_2062x700.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0a9dd535-0b5d-4186-9b78-796038b31920_2062x700.png" width="1456" height="494" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/0a9dd535-0b5d-4186-9b78-796038b31920_2062x700.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:494,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:143125,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0a9dd535-0b5d-4186-9b78-796038b31920_2062x700.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0a9dd535-0b5d-4186-9b78-796038b31920_2062x700.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0a9dd535-0b5d-4186-9b78-796038b31920_2062x700.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F0a9dd535-0b5d-4186-9b78-796038b31920_2062x700.png 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p><span>True, seed oil consumption has skyrocketed along with obesity. But hold on. If seed oil consumption is </span><em>causing</em><span> obesity, then people should have started getting fat </span><em>after</em><span> seed oils started increasing. Did they?</span></p><p><a href="https://doi.org/10.3945%2Fajcn.110.006643" rel="">Blasbalg et al. (2011)</a><span> give some long-term estimates of vegetable oil consumption: (Note the scale is smaller in the lower plot.)</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa21cf9cb-7090-4136-abcd-793d9be065fd_1156x1279.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa21cf9cb-7090-4136-abcd-793d9be065fd_1156x1279.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa21cf9cb-7090-4136-abcd-793d9be065fd_1156x1279.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa21cf9cb-7090-4136-abcd-793d9be065fd_1156x1279.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa21cf9cb-7090-4136-abcd-793d9be065fd_1156x1279.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa21cf9cb-7090-4136-abcd-793d9be065fd_1156x1279.png" width="1156" height="1279" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/a21cf9cb-7090-4136-abcd-793d9be065fd_1156x1279.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:1279,&quot;width&quot;:1156,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:585425,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa21cf9cb-7090-4136-abcd-793d9be065fd_1156x1279.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa21cf9cb-7090-4136-abcd-793d9be065fd_1156x1279.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa21cf9cb-7090-4136-abcd-793d9be065fd_1156x1279.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2Fa21cf9cb-7090-4136-abcd-793d9be065fd_1156x1279.png 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p>How early would obesity have to have started increasing to falsify the idea that it’s caused by seed/vegetable oil? 1970? 1940? Earlier?</p><p><span>Now, when did people start gaining weight? This is tricky, because nobody was collecting BMI statistics back in the 1700s. But </span><a href="https://www.nber.org/system/files/working_papers/w15862/w15862.pdf" rel="">Kromlos and Brabec (2010)</a><span> use a set of surveys taken between 1959 and 1994 and fit a regression to predict weight at age 50 from birth year. They then use this to extrapolate back to people born as early as 1882. (I think because someone born in 1882 would have been 77—and still hopefully alive—in 1959?) This gives this graph we saw earlier, with a long term trend of people at the median gaining around 0.05 BMI/year:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F041afe65-eeaf-4a37-9355-104f8a02625c_2483x1300.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F041afe65-eeaf-4a37-9355-104f8a02625c_2483x1300.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F041afe65-eeaf-4a37-9355-104f8a02625c_2483x1300.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F041afe65-eeaf-4a37-9355-104f8a02625c_2483x1300.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F041afe65-eeaf-4a37-9355-104f8a02625c_2483x1300.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F041afe65-eeaf-4a37-9355-104f8a02625c_2483x1300.png" width="590" height="308.7774725274725" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/041afe65-eeaf-4a37-9355-104f8a02625c_2483x1300.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:762,&quot;width&quot;:1456,&quot;resizeWidth&quot;:590,&quot;bytes&quot;:281147,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F041afe65-eeaf-4a37-9355-104f8a02625c_2483x1300.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F041afe65-eeaf-4a37-9355-104f8a02625c_2483x1300.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F041afe65-eeaf-4a37-9355-104f8a02625c_2483x1300.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F041afe65-eeaf-4a37-9355-104f8a02625c_2483x1300.png 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p><span>While it looks like people were getting heavier back in the 1880s, I emphasize that the evidence is very weak: The leftmost part of the plot is an estimate for men </span><em>born</em><span> in 1882 </span><em>in 1932</em><span> (when they were 50) based on data collected in </span><em>1959</em><span>.</span></p><p><span>There’s also data for the incoming classes at a couple military academies. </span><a href="https://doi.org/10.1016/j.ehb.2009.09.004" rel="">Hiermeyer (2010)</a><span> collects data for people entering </span><a href="https://en.wikipedia.org/wiki/United_States_Military_Academy" rel="">West Point</a><span> and </span><a href="https://en.wikipedia.org/wiki/The_Citadel" rel="">the Citadel</a><span>:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F38438616-315a-4a8a-b64a-dea5d3beb7ba_1166x749.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F38438616-315a-4a8a-b64a-dea5d3beb7ba_1166x749.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F38438616-315a-4a8a-b64a-dea5d3beb7ba_1166x749.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F38438616-315a-4a8a-b64a-dea5d3beb7ba_1166x749.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F38438616-315a-4a8a-b64a-dea5d3beb7ba_1166x749.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F38438616-315a-4a8a-b64a-dea5d3beb7ba_1166x749.png" width="568" height="364.8644939965695" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/38438616-315a-4a8a-b64a-dea5d3beb7ba_1166x749.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:749,&quot;width&quot;:1166,&quot;resizeWidth&quot;:568,&quot;bytes&quot;:308618,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F38438616-315a-4a8a-b64a-dea5d3beb7ba_1166x749.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F38438616-315a-4a8a-b64a-dea5d3beb7ba_1166x749.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F38438616-315a-4a8a-b64a-dea5d3beb7ba_1166x749.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F38438616-315a-4a8a-b64a-dea5d3beb7ba_1166x749.png 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p><em>Maybe</em><span> West Point cadets got a little heavier? There’s a 20 year run, so at 0.05 BMI/year we’d only expect an increase of 1 BMI, close to what’s observed. But the Citadel, if anything is decreasing. </span><a href="https://www.jstor.org/stable/27570229" rel="">Coclanis and Komlos (1997)</a><span> give more Citadel data, stratified by the age of the students:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F56d782fa-534a-4732-8285-9ee672aec00a_1388x660.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F56d782fa-534a-4732-8285-9ee672aec00a_1388x660.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F56d782fa-534a-4732-8285-9ee672aec00a_1388x660.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F56d782fa-534a-4732-8285-9ee672aec00a_1388x660.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F56d782fa-534a-4732-8285-9ee672aec00a_1388x660.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F56d782fa-534a-4732-8285-9ee672aec00a_1388x660.png" width="608" height="289.1066282420749" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/56d782fa-534a-4732-8285-9ee672aec00a_1388x660.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:660,&quot;width&quot;:1388,&quot;resizeWidth&quot;:608,&quot;bytes&quot;:110189,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F56d782fa-534a-4732-8285-9ee672aec00a_1388x660.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F56d782fa-534a-4732-8285-9ee672aec00a_1388x660.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F56d782fa-534a-4732-8285-9ee672aec00a_1388x660.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F56d782fa-534a-4732-8285-9ee672aec00a_1388x660.png 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p>Again, it looks like not much changed between those born in the 1870s and the 1900s. But things started to pick up for those born in the 1920s.</p><p>All this data suggest people starting getting heavier during the 1920s or even earlier, when seed oil consumption was still very low. So I see this as some evidence against seed oil theory.</p><p>Of course, none of this data is very good. Surely there’s more long-term data on weight lurking out there somewhere? Typically, seed oil theorists point at data only going back to 1970 or so, but that will never prove anything, since obesity was already increasing at that time. We need to go back further.</p><p>People in different countries eat different amounts of seed oil. If eating seed oil makes you fat, then must per-country seed oil consumption correlate with per-country obesity?</p><p><span>Not necessarily, no. But I decided to check anyway. I found the WHO provides some </span><a href="https://www.who.int/data/gho/data/indicators/indicator-details/GHO/prevalence-of-obesity-among-adults-bmi--30-/(age-standardized-estimate/)-/(-/)" rel="">amazing data for obesity</a><span>—the estimated fraction of the population that has a BMI of at least 30 by year. Here’s what that looked like in 2010.</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f656580-ce10-4ce9-b8cd-2fbf72eb2ea2_2187x1351.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f656580-ce10-4ce9-b8cd-2fbf72eb2ea2_2187x1351.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f656580-ce10-4ce9-b8cd-2fbf72eb2ea2_2187x1351.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f656580-ce10-4ce9-b8cd-2fbf72eb2ea2_2187x1351.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f656580-ce10-4ce9-b8cd-2fbf72eb2ea2_2187x1351.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f656580-ce10-4ce9-b8cd-2fbf72eb2ea2_2187x1351.png" width="1456" height="899" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/8f656580-ce10-4ce9-b8cd-2fbf72eb2ea2_2187x1351.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:899,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:300686,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f656580-ce10-4ce9-b8cd-2fbf72eb2ea2_2187x1351.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f656580-ce10-4ce9-b8cd-2fbf72eb2ea2_2187x1351.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f656580-ce10-4ce9-b8cd-2fbf72eb2ea2_2187x1351.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F8f656580-ce10-4ce9-b8cd-2fbf72eb2ea2_2187x1351.png 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p>(There’s no data for South Sudan because it didn’t exist in 2010. There’s no data for Antarctica because all the people there are penguins. I think there’s no data for Greenland/French Guiana because they’re considered part of Denmark/France. There’s no data for Taiwan because the WHO is afraid of China. I don’t know the deal with Turkey and Kosovo.)</p><p>The USA isn’t quite #1—It’s beaten by Egypt, the Bahamas, Kuwait, and a bunch of tiny island nations. American Samoa is way ahead at 71.63%.</p><p><span>Anyway, seed oil consumption data is harder to find, but </span><a href="https://doi.org/10.1136/bmj.g2272" rel="">Micha et al. (2014)</a><span> give estimates for 2010. Here’s estimated omega-6 consumption:</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9f8b7ecc-4b8c-442c-ac7a-332117179ee0_2187x1351.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9f8b7ecc-4b8c-442c-ac7a-332117179ee0_2187x1351.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9f8b7ecc-4b8c-442c-ac7a-332117179ee0_2187x1351.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9f8b7ecc-4b8c-442c-ac7a-332117179ee0_2187x1351.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9f8b7ecc-4b8c-442c-ac7a-332117179ee0_2187x1351.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9f8b7ecc-4b8c-442c-ac7a-332117179ee0_2187x1351.png" width="1456" height="899" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/9f8b7ecc-4b8c-442c-ac7a-332117179ee0_2187x1351.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:899,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:307233,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9f8b7ecc-4b8c-442c-ac7a-332117179ee0_2187x1351.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9f8b7ecc-4b8c-442c-ac7a-332117179ee0_2187x1351.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9f8b7ecc-4b8c-442c-ac7a-332117179ee0_2187x1351.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F9f8b7ecc-4b8c-442c-ac7a-332117179ee0_2187x1351.png 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p>Can you see a relationship with obesity? I couldn’t, so I made a scatterplot with one circle per country. (You can zoom in and see country codes.)</p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3df91fd3-4549-4242-893d-3fdc323a964b_2060x1502.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3df91fd3-4549-4242-893d-3fdc323a964b_2060x1502.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3df91fd3-4549-4242-893d-3fdc323a964b_2060x1502.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3df91fd3-4549-4242-893d-3fdc323a964b_2060x1502.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3df91fd3-4549-4242-893d-3fdc323a964b_2060x1502.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3df91fd3-4549-4242-893d-3fdc323a964b_2060x1502.png" width="1456" height="1062" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/3df91fd3-4549-4242-893d-3fdc323a964b_2060x1502.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:1062,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:244117,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3df91fd3-4549-4242-893d-3fdc323a964b_2060x1502.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3df91fd3-4549-4242-893d-3fdc323a964b_2060x1502.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3df91fd3-4549-4242-893d-3fdc323a964b_2060x1502.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F3df91fd3-4549-4242-893d-3fdc323a964b_2060x1502.png 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p><span>Is anything there? Maybe so, I’m not sure. I did the same for </span><a href="https://dynomight.net/img/seed-oil/Saturated.pdf" rel="">saturated fat</a><span> and </span><a href="https://dynomight.net/img/seed-oil/All%20fat.pdf" rel="">all fat</a><span>, which look about equally convincing. But if you put </span><em>per-capita GDP</em><span> on the x-axis…</span></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30004b6e-7c06-4f13-92d5-facdd2242308_2060x1502.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30004b6e-7c06-4f13-92d5-facdd2242308_2060x1502.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30004b6e-7c06-4f13-92d5-facdd2242308_2060x1502.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30004b6e-7c06-4f13-92d5-facdd2242308_2060x1502.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30004b6e-7c06-4f13-92d5-facdd2242308_2060x1502.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30004b6e-7c06-4f13-92d5-facdd2242308_2060x1502.png" width="1456" height="1062" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/30004b6e-7c06-4f13-92d5-facdd2242308_2060x1502.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:1062,&quot;width&quot;:1456,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:250085,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:true,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30004b6e-7c06-4f13-92d5-facdd2242308_2060x1502.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30004b6e-7c06-4f13-92d5-facdd2242308_2060x1502.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30004b6e-7c06-4f13-92d5-facdd2242308_2060x1502.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F30004b6e-7c06-4f13-92d5-facdd2242308_2060x1502.png 1456w" sizes="100vw" loading="lazy"></picture></div></a></figure></div><p>Could it be that something else is going on here?</p><p>A weak version of seed oil theory is that seed oils are highly processed, so why not use cold-pressed olive oil instead? If that’s the theory, fine. In fact, this is mostly what I do myself. I figure it might be useless, but it’s unlikely to be harmful, and olive oil is delicious.</p><p><span>And I wouldn’t be shocked if one of the suggested mechanisms for seed oil turns out to be valid. I wouldn’t be surprised </span><em>at all</em><span> if some mechanism turned out to part of a larger, more complicated story.</span></p><p><span>And </span><em>in practice</em><span>, avoiding seed oils is probably </span><em>really good</em><span> for you, because it forces you to eliminate most of the processed crap you shouldn’t be eating anyway.</span></p><p><span>A middle-strength theory would be that seed oils </span><em>might</em><span> be harmful, so it’s safest to reduce seed oils and replace them with saturated fat. I disagree with this, because the balance of evidence says that saturated fat is more risky than unsaturated fat (monounsaturated </span><em>or</em><span> polyunsaturated). But I guess it’s not </span><em>totally</em><span> crazy.</span></p><p><span>But seed oil theorists mostly seem to push a much stronger theory: We </span><em>know</em><span> that seed oils are </span><em>the</em><span> cause of </span><a href="https://en.wikipedia.org/wiki/Diseases_of_affluence" rel="">Western disease</a><span>.</span></p><p><span>I’ll just be honest. I think this view is completely indefensible. I feel embarrassed when I see people promoting it. You’re </span><em>sure</em><span>? How? I don’t see any way to get to this conclusion other than heavily filtering the evidence—ignoring the flaws in everything that supports a predetermined view while scrambling to find flaws in everything that contradicts it.</span></p><p><span>Again, I’m sure you can send me long lists of random citations. (You don’t need to send them; it’s OK; I’ve seen them already.) But for </span><em>anything</em><span> that’s been studied in detail, there’s </span><em>always</em><span> lots of evidence to support any semi-plausible view. Do you have any idea how much evidence people can produce for </span><a href="https://dynomight.net/aliens/" rel="">UFOs</a><span> or </span><a href="https://en.wikipedia.org/wiki/Chronic_Lyme_disease" rel="">chronic Lyme</a><span> or </span><a href="https://en.wikipedia.org/wiki/Medical_uses_of_silver#Alternative_medicine" rel="">colloidal silver</a><span>?</span></p><p><span>My real worry about seed oil theory is that it’s a distraction. If you want to be healthier, we </span><em>know</em><span> ways you can change your diet that </span><em>will</em><span> help: Increase your overall diet “quality”. Eat lots of fruits and vegetables. Avoid processed food. Especially avoid processed meats. Eat food with low caloric density. Avoid added sugar. Avoid alcohol. </span><em>Avoid processed food</em><span>.</span></p><p><span>I know this is hard. You could even argue it’s </span><em>unrealistic</em><span>. That wouldn’t make it wrong.</span></p><p><span>Look, I </span><em>wish</em><span> strong seed oil theory were true. That would be great. All we’d have to do is reformulate our Cheetos with different oil, and then we could go on merrily eating Cheetos. Western diet without Western disease! Sadly, I think this is very unlikely.</span></p></div></article></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Show HN: Vapi – Convince our voice AI to give you the secret code (125 pts)]]></title>
            <link>https://blog.vapi.ai/show-hn-vapi-try-to-convince-our-voice-ai-to-give-you-the-secret-code/</link>
            <guid>40078195</guid>
            <pubDate>Thu, 18 Apr 2024 16:50:04 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://blog.vapi.ai/show-hn-vapi-try-to-convince-our-voice-ai-to-give-you-the-secret-code/">https://blog.vapi.ai/show-hn-vapi-try-to-convince-our-voice-ai-to-give-you-the-secret-code/</a>, See on <a href="https://news.ycombinator.com/item?id=40078195">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
<article>
<header>

<div>
<p><a href="https://blog.vapi.ai/author/beatrizpaz/">
<img src="https://blog.vapi.ai/content/images/size/w160/2024/04/IMG_7573.JPG" alt="Beatriz Paz">
</a>
</p>
<div>

<p><time datetime="2024-04-17">Apr 17, 2024</time>
<span><span>—</span> 2 min read</span>
</p>
</div>
</div>
</header>
<section>
<p>So, this is GPT-3.5-turbo running on Vapi. There’s a secret code in the prompt, <strong>press on it to start</strong>, it’s your job to make it squeal:</p>



<p>If that doesn't work, try it here: <a href="https://vapi.ai/?demo=true&amp;shareKey=ea65f8da-4c03-4c14-980d-2fb9e88cf817&amp;assistantId=8b9941e5-bf13-4664-8881-5306ea84839a&amp;ref=blog.vapi.ai" rel="noreferrer">Demo Link</a></p><p>Okay, so how did we do it?— Short version: a lot of engineering, boring infrastructure, models, you know the drill.</p><p>We want to make interactions feel warmer and human via audio - <em>just like chatting with a friend</em>. We're making voice AI's as simple, reliable and accessible as any other API in your stack.</p><figure><img src="https://blog.vapi.ai/content/images/2024/04/Untitled.png" alt="" loading="lazy" width="2000" height="596" srcset="https://blog.vapi.ai/content/images/size/w600/2024/04/Untitled.png 600w, https://blog.vapi.ai/content/images/size/w1000/2024/04/Untitled.png 1000w, https://blog.vapi.ai/content/images/size/w1600/2024/04/Untitled.png 1600w, https://blog.vapi.ai/content/images/2024/04/Untitled.png 2000w" sizes="(min-width: 720px) 720px"></figure><h3 id="so-whos-vapi-for">So, who's Vapi for?</h3><p>One word: <strong>Developers</strong>.</p><p>Vapi is solving for the foundation challenges that voice AI applications face, such as simulating the flow of natural human conversation, realtime/low latency demands, taking actions (functional calling) and extracting conversation data.</p><p>Whether you’re building a completely “turn-based” use-case (like appointment setting), all the way to robust agentic voice applications (like virtual assistants), Vapi is built to solve all this end-to-end. Vapi runs on any platform: the web, mobile, telephony, even hardware devices like RPi.</p><h3 id="ok-but-how-does-vapi-work">Ok, but how does Vapi work?</h3><p>Vapi acts as an orchestration layer over Speech-to-Text (STT), Large Language Model (LLM) and Text-to-Speech (TTS) providers. You can bring your own LLMs, custom voices, and we make it all talk like a person.</p><figure><img src="https://blog.vapi.ai/content/images/2024/04/vapi-s-layer.png" alt="" loading="lazy" width="2000" height="875" srcset="https://blog.vapi.ai/content/images/size/w600/2024/04/vapi-s-layer.png 600w, https://blog.vapi.ai/content/images/size/w1000/2024/04/vapi-s-layer.png 1000w, https://blog.vapi.ai/content/images/size/w1600/2024/04/vapi-s-layer.png 1600w, https://blog.vapi.ai/content/images/2024/04/vapi-s-layer.png 2000w" sizes="(min-width: 720px) 720px"></figure><p>We’ve built various latency optimizations like end-to-end streaming and colocating servers that shave off every possible millisecond of latency. We also manage the coordination of interruptions, turn-taking, and other conversational dynamics.</p><p>We built all this to let developers build cool stuff without worrying about the underlying tech- kind of like what Twilio does for telephony.</p><h3 id="make-one-yourself">Make one yourself</h3><p>You can head over to the <a href="https://dashboard.vapi.ai/?ref=blog.vapi.ai">Vapi Dashboard</a> to make one yourself, just add a prompt, pick your model, pick your voice, and you’re good to go. You can even put it behind a phone number and send it around.</p><figure><iframe width="200" height="113" src="https://www.youtube.com/embed/sFXaTsmMR8s?feature=oembed" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen="" title="Quickstart: Vapi Dashboard"></iframe></figure><h3 id="docs-more">Docs &amp; More</h3><p>You can check out our docs here for more details on the underlying system, the API, client libraries, etc.</p><figure><a href="https://docs.vapi.ai/introduction?ref=blog.vapi.ai"><div><p>Introduction - Vapi</p><p>Vapi is the Voice AI platform for developers.</p><p><img src="https://mintlify.s3-us-west-1.amazonaws.com/vapi/_generated/favicon/apple-touch-icon.png?v=3" alt=""><span>Vapi</span></p></div><p><img src="https://mintlify.com/docs/api/og?division=Documentation&amp;mode=dark&amp;title=Introduction&amp;description=Vapi+is+the+Voice+AI+platform+for+developers.&amp;logoLight=https%3A%2F%2Fmintlify.s3-us-west-1.amazonaws.com%2Fvapi%2Fstatic%2Fimages%2Flogo%2Flogo-light.png&amp;logoDark=https%3A%2F%2Fmintlify.s3-us-west-1.amazonaws.com%2Fvapi%2Fstatic%2Fimages%2Flogo%2Flogo-dark.png&amp;primaryColor=%2337AA9D&amp;lightColor=%235DFECA&amp;darkColor=%2337AA9D" alt=""></p></a></figure>
</section>
</article>

</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[You Need a "WTF Notebook" (474 pts)]]></title>
            <link>https://www.simplermachines.com/why-you-need-a-wtf-notebook/</link>
            <guid>40078106</guid>
            <pubDate>Thu, 18 Apr 2024 16:42:04 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.simplermachines.com/why-you-need-a-wtf-notebook/">https://www.simplermachines.com/why-you-need-a-wtf-notebook/</a>, See on <a href="https://news.ycombinator.com/item?id=40078106">Hacker News</a></p>
<div id="readability-page-1" class="page"><section>
                    <p>I keep a <a href="https://bulletjournal.com/?ref=simplermachines.com">bullet journal</a>. I'm not one of those people you see on Pinterest with the fancy spreads – I mostly just use black ink, the standard setup, and the occasional custom collection.</p><p>Every time I join a new team, I go to the next fresh page, and on top of that page I write: "WTF - [Team Name]." Then I make a note every time I run into something that makes me go "wtf," and a task every time I come up with something I want to change.</p><p>For two weeks, that's all I do. <em>I</em> <em>just write it down. </em>I don't tell the team everything that I think they're doing wrong. I don't show up at retro with all the stuff I think they need to change. I just watch, and listen, and I write down everything that seems deeply weird.</p><p>This is a trick I picked up from <a href="https://www.linkedin.com/in/aramprice?ref=simplermachines.com">a team lead</a> a few years ago, who learned it from a previous lead of his in turn. It's one of my most powerful techniques for making changes on a team, and managing myself while I do it. So I'm going to walk you through how I use that list, and how it helps me to build a reputation as someone who's really effective at getting stuff done, and avoid being someone who's complaining all the time.</p><p>There's always stuff that makes me go "wtf" on a new team. The team talks for an hour in retro about a serious problem, and then leaves without making any action items. The tests don't run locally and no one seems to notice. Big chunks of the build board are always red. Only one person can do some critical, time-sensitive thing. The team is spending a bunch of time on some feature, but when I ask around no one can seems to know why it's important or how it'll help a customer.</p><p>Once I've got a nice big list, I start crossing things off. There are four reasons at this point that I might cross off something I've put on that list:</p><ol><li>There's actually a good reason for it</li><li>The team is already working on a fix</li><li>The team doesn't care about it</li><li>It's really easy to fix</li></ol><p>If the tests don't run locally, for instance, that might be a known issue that there's an ongoing effort to address. The team might do all of their work on virtual machines, and have a simple chat command that provisions those machines for them. Or they might have a pretty good continuous integration system and good habits around making small changes, so not being able to run the tests locally isn't stopping them from deploying multiple times a day.</p><p>Sometimes, it'll turn out that there's a really simple fix for some of the things I've identified. Maybe there's some documentation I can write, once I know where it is, or maybe there's an easy change once I find the right scripts. That's not always immediately obvious when I first see a problem. When I do see an easy fix, though, I'll just go ahead and make it.</p><p>After a few weeks, though, I'll still have a bunch of weird, unresolved issues on that list. At this point I'll start talking about it with other people on the team, the team lead, and my manager.</p><p>I'll ask why things on the list are that way, and how they got to be that way. I'm trying to establish credibility as someone who's genuinely curious and empathetic, who's patient, and who respects the expertise of my coworkers. That's the reputation that's going to let me make changes later.</p><p>Generally, I'll find out that the things that problems I've noticed are around for one of a few reasons.</p><ol><li>The team hasn't noticed it</li><li>The team has gotten used to it</li><li>The problem is relatively new, and the old problem it replaced was much worse</li><li>They don't know how to fix the problem</li><li>They've tried to fix the problem before and failed</li></ol><p>On a lot of teams, when I ask some questions about things that turn out to be in the first few questions, the person I ask will just fix them immediately. Or they'll help me figure out how to fix them. If it's a technical problem, that means writing a story or a ticket together, and then we'll work on it. If it's more process or social, it means bringing the problem up at retro and talking about it with the whole team.</p><p>At this point I'm looking for one or two problems that have been bugging one of my new teammates for a while, and that have relatively simple solutions. I'm looking for something I can put on the retro board and know I won't be the only person who's bothered by that problem. Then, during the team conversation about the problem, I'll identify something that teammate suggests as an action item that we could try immediately. That way the team starts to see me as someone who helps them solve their problems.</p><p>The feeling that I want to create, the association I want people to have with me, is, "Oh, Nat joined the team and little things started to get better, almost immediately. It feels like we're starting to make some progress. And it's not like they showed up and started telling me what to do, either. They're really listening to me, they're helping me explain myself to the rest of the team."</p><p>Pretty soon, I'll start to get in to the really sticky issues. The problems the team knows about but is afraid of dealing with. The things that aren't "that bad," but that no one wants to talk about. Maybe they're missing the technical skills to deal with the problem. Maybe there's a knotty people problem at the center of it.</p><p>At this point I'm going to be talking to my manager. I'm going to bring them that list I've been working on, and I'm going to say something like, "Now that I've been on the team for a few weeks, this is what I'm seeing. We're making progress on some of it, but some of these seem like they're going to take longer. I wanted to get your thoughts before I try to do anything about them. Is there something I'm missing? Is there a particular area I'd like you to focus?"</p><p>The reaction I'm looking for from my manager, at this point, is something like, "Wow. This is really validating. I've been concerned about these things but the team doesn't seem really bothered by them, so I didn't want to push too hard. I'm glad you're bringing this up."</p><p>Then we can have a conversation about what their concerns and problems are. I can do some reflective listening to help them organize their thoughts, and I can talk about what I've seen work well, or not, in the past. They'll start to see me as someone with good judgement, and someone they can come to for help solving their harder problems.</p><p>There's a very specific reputation I want to have on a team: "Nat helps<em> <em>me</em></em> solve <em>my</em> problems. Nat get things <em>I care about</em> done." That's the reputation that's going to get me the results I want in next year's performance review. That's the reputation that's going to get me a referral a few years from now.</p><p>Before I started keeping this kind of list, I brought up problem I saw immediately, as soon as I noticed it. The reputation I got was, "Nat's always complaining about things. Nat thinks we're never doing things right." People stopped listening to me. I was personally frustrated, and professionally ineffective.</p><p>There's no faster way to totally sink my credibility, as a new team member, by making a huge fuss over something that's not a problem, or that the team doesn't see as a problem, or that there's already an effort to fix, or that there's a really simple way to fix that I just didn't see at first. There are always so many problems on a team,&nbsp;so many things that could be better, that I'm only ever going to solve a handful of them. Working on problems in the order I noticed them is rarely the most effective order. So the WTF Notebook gives me a place to park the impulse to <em>fix it now, damn it!</em> until I have more context for deciding what to work on first.</p><p>Instead, for two weeks, I just write things down.</p><!--kg-card-begin: html--><!--kg-card-end: html--><hr><h2 id="jobs">Jobs</h2><p>Periodic reminder that Code for America is usually hiring, and they pair and write tests. Until the end of this month they have a <a href="https://www.codeforamerica.org/jobs/posting/?gh_jid=3400762&amp;ref=simplermachines.com">Software Engineer</a> role up for a team that works San Francisco hours. If you're looking for a "show up, write code, go home" experience, and want to help Americans access food stamps and other safety net services, this is a team that can deliver it – especially if you have some experience with Rails or Spring.</p><p>If, on the other hand, you're interested in gnarly cloud infrastructure and software problems for the Department of Defense, check out <a href="https://rise8.us/careers?ref=simplermachines.com">Rise8</a>. If you've heard about Kessel Run, or Pivotal's work with the Air Force generally, Rise8 is where many of those folks ended up. They also practice design thinking, test-driven development, and continuous deployment, but they're teaching them to folks who have never used these practices before, and pairing with military service people. Their job listings mention experience at Pivotal Labs by name.</p><p>If you've got an active job search running and you're struggling to keep track of it all, check out <a href="https://dwf.bigpencil.net/job-search-obsidian-update/?ref=simplermachines.com">Davis Frank's guide to Job Search Journaling with Obsidian.</a></p><p><a href="https://www.simplermachines.com/jobs/">Job listings from previous issues</a></p><hr><h2 id="reading">Reading</h2><p>I've mentioned <em><a href="https://politicalscience.yale.edu/publications/seeing-state-how-certain-schemes-improve-human-condition-have-failed?ref=simplermachines.com">Seeing Like a State</a> </em>before but I reread it while we were on the road, and, and, man, seriously, if there's one book I wish everyone I talk to had read, it's this one. Nothing explains systems thinking in action better. Nothing has more useful anecdotes for illustrating how large organizations work, and why they work the way they do.</p><p>The other book I've read by James C. Scott is <a href="https://politicalscience.yale.edu/publications/against-grain-deep-history-earliest-states-1st-edition?ref=simplermachines.com"><em>Against the Grain</em>,</a> and if you're at all interested in the history of the earliest states and the initial development of human civilization, that book will absolutely blow your mind.</p><p>Ed Zitron's piece recently about <a href="https://ez.substack.com/p/how-our-need-for-attention-online?ref=simplermachines.com">How Our Need For Attention Online Drives Us Crazy</a> articulated a bunch of half-formed thoughts I've been chewing on and trying to figure out how to write about. It doesn't mention Slack explicitly, but I've seen Slack drive a lot of these same processes at work.</p>
                    
                </section></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Dnsmasq wins the first BlueHats Prize (153 pts)]]></title>
            <link>https://nlnet.nl/news/2024/20240418-BlueHatsPrize1.html</link>
            <guid>40077793</guid>
            <pubDate>Thu, 18 Apr 2024 16:20:00 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://nlnet.nl/news/2024/20240418-BlueHatsPrize1.html">https://nlnet.nl/news/2024/20240418-BlueHatsPrize1.html</a>, See on <a href="https://news.ycombinator.com/item?id=40077793">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="maincolumn">
          
          <div>
            <figure><img src="https://nlnet.nl/image/Dnsmasq_icon.svg" alt="Dnsmasq logo consisting of a purple Zorro mask."><figcaption>dnsmasq</figcaption>
            </figure>
          </div>
          <div>
            <nav><a href="https://nlnet.nl/bluehatsprize/2024/fr/1.html">fr</a> <a href="https://nlnet.nl/bluehatsprize/2024/1.html">en</a> <a href="https://nlnet.nl/bluehatsprize/2024/nl/1.html">nl</a></nav>
            <p>BlueHats prizes is an initiative by the French Interministerial Digital Directorate. They are awarded to maintainers of critical free and open source projects. In 2024 four prizes of € 10 000 each will be given out. We are happy to announce the winner of the first 2024 BlueHats prize is Simon Kelley, maintainer of the dnsmasq project. Dnsmasq provides network addressing for small networks: DNS, DHCP, router advertisement and network boot.</p>
          </div>
          <p>The jury, made up of public officials from the Ministries of Education and Youth, ANSSI and DINUM, recognised the importance of dnsmasq and its ongoing development for network security. The members of the Open Source Software Council wish to continue to highlight this type of initiative: discrete projects that are critical to software infrastructures, and maintained by reliable teams over the years.</p>
          <p>In response to hearing he had won, Simon Kelley said:</p><blockquote>I'm delighted to accept the prize. Like many Free Software projects, dnsmasq started as a creation for it's own sake, but it has been kept alive and developing for a quarter of a century because of the feedback that has come from its role in the outside world, and the recognition, small and large, that it makes a difference. This prize is valuable financially, but much more so as a mark of public recognition that dnsmasq is still something that's worth doing.</blockquote>
          
          <h2>About dnsmasq</h2>
          <p>The dnsmasq project was started in the early 2000’s by Simon Kelley. He wanted to connect his laptop to the internet via his PC. The concept of a home router was new: connecting even one computer, via a telephone line, to the internet was a luxury. To let his laptop speak to the internet, the PC had to act as go-between for all the address information.</p>
          <p>To make this happen, Simon started his own project and got it to run on his PC. He has been improving and expanding it ever since. And he has been so generous to publish dnsmasq as Free Software.</p>
          <p>There is a good chance you are using dnsmasq since it is used in many home routers, some Internet of Things devices and included in the Android mobile operating system. Dnsmasq is a popular choice because it has low system resource requirements and fits a lot of functionality into one program. It does so in about fifty thousand lines of C code. That is a low number given all the different types of devices, each with its own quirks, that dnsmasq has to talk to.</p>
          <h2>Praise for dnsmasq</h2>
          <p>Anyone can nominate free and open source projects for one the BlueHats prizes (and <a href="https://nlnet.nl/bluehatsprize/2024/">nominations</a> are still open). Dnsmasq was nominated by Samuel Bizien-Filippi, system administrator at <a href="https://www.peren.gouv.fr/">Pôle d'expertise de la régulation numérique</a>(PEReN) (Center of Expertise in Digital Regulation), motivated his choice by writing:</p><blockquote>Dnsmasq is a versatile server: in a nutshell, it is both a DHCP server and a DNS proxy (that resolves domain names on local networks and internet). Dnsmasq is present in most routers ("internet box") and in several virtualization platforms (at least Proxmox VE). It greatly simplifies network configuration. Dnsmasq is a foundational - and overlooked - building block of networks for SMEs and public administrations. We use it at <a href="https://www.peren.gouv.fr/">Pôle d'expertise de la régulation numérique</a>(PEReN) (Center of Expertise in Digital Regulation).</blockquote>
          
          <p>When asked how dnsmasq is used at PEReN, Filippi answered:</p><blockquote>"At PEReN, we strive to keep all network and system configuration as code in a version control system. Since dnsmasq is configured using flat text files, it's a perfect fit for us. In our setup, dnsmasq is used:<ul>
                <li>for network configuration of clients via DHCP</li>
                <li>for automated installation of systems with DHCP and TFTP (both functionality provided by dnsmasq)</li>
                <li>for local name resolution."</li>
              </ul>
            </blockquote>
          
          <!--
<p>Benno Overeinder, managing director of NLnet Labs foundation which develops open-source software for DNS and BGP routing, said about dnsmasq: 
  <blockquote>
  “QUOTE BENNO”
  </blockquote>
</p>
--> <!--
<p>The jury motivated its choice for Simon Kelley, writing in its jury report:
<blockquote>
  “Another quote from jury report”
</blockquote>
The jury members are all BlueHats, civil servants who promote using and developing Free Software in public administrations. 
</p>
--> <p><img src="https://nlnet.nl/bluehatsprize/2024/bluehats-logo.svg" alt="BlueHats logo consisting of three blue fedora hats" width="width" height="height"></p><h2>BlueHats prizes for maintainers of critical software</h2>
          <p>The BlueHats prize aims to place maintainers of critical open source software in the spotlight. It is a well-known problem in the free and open source world: The benefit of having open source software is enormous but there is not enough attention and resources for maintenance and maintainers. <br> Dnsmasq is a typical example of this state of affairs. Dnsmasq is a component used in many commercial products. Some of the vendors have been willing to pay Simon Kelley for implementing new feautures but there has been no funding for maintenance. The BlueHats prizes seek to encourage users of free and open software to invest in maintenance.</p>
          <h2>Nominations still open</h2>
          <p>Three more BlueHats prizes will be awarded in the upcoming months. You can still <a href="https://nlnet.nl/bluehatsprize/2024/">nominate your favorite project</a> for one of the € 10 000 prizes. The BlueHats prizes are an initiative of the French public administration. The <a href="https://code.gouv.fr/en/">French Free Software Unit</a> (an OSPO) has partnered with NLnet to put four notable projects in the spotlight and award them the BlueHats 2024 prizes.</p>
        </div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Meta Llama 3 (1810 pts)]]></title>
            <link>https://llama.meta.com/llama3/</link>
            <guid>40077533</guid>
            <pubDate>Thu, 18 Apr 2024 15:57:22 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://llama.meta.com/llama3/">https://llama.meta.com/llama3/</a>, See on <a href="https://news.ycombinator.com/item?id=40077533">Hacker News</a></p>
&lt;Unparsable&gt;]]></description>
        </item>
        <item>
            <title><![CDATA[Multi-tenant queues in Postgres (167 pts)]]></title>
            <link>https://docs.hatchet.run/blog/multi-tenant-queues</link>
            <guid>40077233</guid>
            <pubDate>Thu, 18 Apr 2024 15:26:57 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://docs.hatchet.run/blog/multi-tenant-queues">https://docs.hatchet.run/blog/multi-tenant-queues</a>, See on <a href="https://news.ycombinator.com/item?id=40077233">Hacker News</a></p>
<div id="readability-page-1" class="page"><div><article><main>
<div><h5><p>Alexander Belanger</p></h5><p>Published on April 18, 2024</p></div>
<p><em><strong>TL;DR -</strong> we've been implementing fair queueing strategies for Postgres-backed task queues, so processing Bob's 10,000 files doesn't crowd out Alice's 1-page PDF. We've solved this in <a href="https://github.com/hatchet-dev/hatchet" target="_blank" rel="noreferrer">Hatchet<span> (opens in a new tab)</span></a> and <a href="https://cloud.onhatchet.run/" target="_blank" rel="noreferrer">Hatchet Cloud<span> (opens in a new tab)</span></a> so you don't have to — here's a look at how we did it.</em></p>
<h2>Introduction<a href="#introduction" id="introduction" aria-label="Permalink for this section"></a></h2>
<p>We set the scene with a simple user request: they'd like to upload and parse a PDF. Or an image, CSV, audio file — it doesn't really matter. What matters is that the processing of this file can take ages, and scales ≥ linearly with the size of the file.</p>
<p>Perhaps you're an astute developer and realized that processing this file might impact the performance of your API — or more likely, the new file upload feature you pushed on Friday has you explaining to your family that nephew Jimmy's baseball game on Saturday will have to wait.</p>
<p>In the postmortem, you decide to offload processing this file to somewhere outside of the core web server, asynchronously on a new <em>worker process</em>. The user can now upload a file, the web server quickly sends it off to the worker, and life goes on.</p>
<p>That is, until Bob decides to upload his entire hard drive — probably also on a Saturday — and your document processing worker now goes down.</p>
<p>At this point (or ideally before this point), you introduce…the task queue. This allows you to queue each file processing task and only dispatch the amount of tasks each worker can handle at a time.</p>

<p>But while this solves the problem of the worker crashing, it introduces a new problem, because you've intentionally bottlenecked the system. Which means that when Bob uploads his second hard drive, a new issue emerges - Alice's 1-page file upload gets stuck at the back of the queue:</p>

<p>You're now worried about fairness — specifically, how can you guarantee <em>fair execution time</em> to both Bob and Alice? We'd like to introduce a strategy that's easy to implement in a Postgres-backed queue — and more difficult in other queueing systems — deterministic round-robin queueing.</p>
<h2>The setup<a href="#the-setup" id="the-setup" aria-label="Permalink for this section"></a></h2>
<p>Let's start with some code! We're implementing a basic Postgres-backed task queue, where workers poll for events off the queue at some interval. You can find all the code used in these examples — along with some nice helper <code dir="ltr">seed</code> and <code dir="ltr">worker</code> commands — in this repo: <a href="https://github.com/abelanger5/postgres-fair-queue" target="_blank" rel="noreferrer">github.com/abelanger5/postgres-fair-queue<span> (opens in a new tab)</span></a>. Note that I chose <code dir="ltr">sqlc</code> to write these examples, so you might see some <code dir="ltr">sqlc.arg</code> and <code dir="ltr">sqlc.narg</code> in the example queries.</p>
<p>Our tasks are very simple — they have a <code dir="ltr">created_at</code> time, some input data, and an auto-incremented id:</p>

<p>The query which pops tasks off the queue looks like the following:</p>

<p>Note the use of <code dir="ltr">FOR UPDATE SKIP LOCKED</code>: this means that workers which concurrently pull tasks off the queue won't pull duplicate tasks, because they won't read any rows locked by other worker transactions.</p>
<p>The polling logic looks something like this:</p>

<p>The <code dir="ltr">ORDER BY id</code> statement gives us a default ordering by the auto-incremented index. We've now implemented the basic task queue shared above, with long-polling for tasks. We could also add some nice features, like listen/notify to get new tasks immediately, but that's not the core focus here.</p>
<h2>Fair queueing<a href="#fair-queueing" id="fair-queueing" aria-label="Permalink for this section"></a></h2>
<p>We'd now like to guarantee fair execution time to Bob and Alice. A simple way to support this is a round-robin strategy: pop 1 task from Alice, 1 task from Bob, and…Bob's your uncle? To achieve this, we can imagine separate queues for each group of users -- in this case, "purple," "orange" and "green":</p>

<p>Even though we're essentially creating a set of smaller queues within our larger queue, we don't want workers to manage their subscriptions across all possible queues. The ugliness of adding a new queue per group should be abstracted from the worker, which should use a single query to pop the next tasks out of the queue.</p>
<p>To define our groups, let's modify our implementation above slightly: we're going to introduce a <code dir="ltr">group_key</code> to each table:</p>

<p>The group key simply identifies which group the task belongs to — for example, is this one of Bob's or Alice's tasks? This can refer to individual users, tenants, or even a custom group key based on some combination of other fields.</p>
<h3>First attempt: <code dir="ltr">PARTITION BY</code><a href="#first-attempt-partition-by" id="first-attempt-partition-by" aria-label="Permalink for this section"></a></h3>
<p>Let's try our hand at writing a query to do this. While we have a few options, the most straightforward solution is to use <code dir="ltr">PARTITION BY</code>. Here's what we'd <em>like</em> the query to look like:</p>

<p>This assigns a row number of <code dir="ltr">1</code> to the first task in each group, a row number of <code dir="ltr">2</code> to the second task in each group, and so on.</p>
<p>However, if we run this, we'll get the error: <code dir="ltr">ERROR: FOR UPDATE is not allowed with window functions (SQLSTATE 0A000)</code> . Easy, let's tweak our query to solve for this - we'll load up the rows with <code dir="ltr">PARTITION BY</code> and pass them to a new expression which uses <code dir="ltr">SKIP LOCKED</code>:</p>

<p>…but not so fast. We've introduced an issue by adding the first CTE (Common Table Expression - the queries using the <code dir="ltr">WITH</code> clause). If we run 3 workers concurrently and log the number of rows that each worker receives, with a limit of 100 rows per worker, we'll find only 1 worker is picking up tasks, even if there are more rows to return!</p>

<p>What's happening here? By introducing the first CTE, we are now selecting locked rows which are excluded by <code dir="ltr">FOR UPDATE SKIP LOCKED</code> in the second CTE - in other words, we might not enqueue any runs on some workers if we're polling concurrently for new tasks. While we are still guaranteed to enqueue in the manner which we'd like, we may reduce throughput if there's high contention among workers for the same rows.</p>
<p>Unfortunately, using <code dir="ltr">PARTITION BY</code> isn't the right approach here. But before we dive into a better approach, this query does show some interesting properties of queueing systems more generally.</p>
<h3>Aside: queueing woes<a href="#aside-queueing-woes" id="aside-queueing-woes" aria-label="Permalink for this section"></a></h3>
<p>A hotfix for the slow polling query would be adding 3 lines of code to our worker setup:</p>

<p>Which gives us much more promising output:</p>

<p>This works — and you can modify this logic to be more distributed by maintaining a lease when a worker starts for a set amount of time — as long as the polling interval is below the query duration time (or more specifically, <code dir="ltr">pollingTime / numWorkers</code> is below the query duration time). But what happens when our queue starts to fill up? Let's add 10,000 enqueued tasks and run an <code dir="ltr">EXPLAIN ANALYZE</code> for this query to take a look at performance:</p>

<p>The important part here is the <code dir="ltr">WindowAgg</code> cost - computing a partition across all rows on the <code dir="ltr">groupKey</code> naturally involves querying every <code dir="ltr">QUEUED</code> row (in this case, <code dir="ltr">10000</code> tasks). We expect this to scale sublinearly with the number of rows in the input - let's take a guess and look at how our workers do on 25,000 enqueued rows:</p>

<p>Sure enough, because we're seeing execution times greater than <code dir="ltr">333ms</code>, we start losing tasks on <code dir="ltr">worker 1</code>. This is very problematic, because not only is our queue backlog increasing, but the throughput of our workers is decreasing, and this isn't a problem we can solve by throwing more workers at the queue. This is a general problem in systems that are stable for a long time until some external trigger (for example, workers going down for an hour) causes the system to fail in an unexpected way, leading to the system being <em>unrecoverable</em>.</p>
<p>A second practical solution to this issue is to create an <code dir="ltr">OVERFLOW</code> status on the task queue, and set an upper bound on the number of enqueued tasks, to ensure worker performance doesn't drop below a certain threshold. We then can periodically check the overflow queue and place the overflow into the queued status. This is a good idea regardless of the query we write to get new tasks.</p>
<p>But practical advice aside, let's take a look at how to write this query to avoid performance degradation at such a small number of enqueued tasks.</p>
<h2>Improving performance<a href="#improving-performance" id="improving-performance" aria-label="Permalink for this section"></a></h2>
<h3>Sequencing algorithm<a href="#sequencing-algorithm" id="sequencing-algorithm" aria-label="Permalink for this section"></a></h3>
<p>The main issue, as we've identified, is the window function which is searching across every row that is <code dir="ltr">QUEUED</code>. What we were hoping to accomplish with the partition method was filling up each group's queue, ordering each group by the task id, and order the tasks by their rank within each group.</p>
<p>Our goal is to write a query that is constant-time (or as close as possible to constant-time) when reading from the queue, so we can avoid our system being unrecoverable. Even using a <code dir="ltr">JOIN LATERAL</code> instead of <code dir="ltr">PARTITION BY</code> will get slower as the number of partitions (i.e. groups) increases. Also, maintaining each task's rank after reads (for example, decrementing the task's rank within the group after read) will also get slower the more tasks we add to a group.</p>
<p>What if instead of computing the rank within the group via the <code dir="ltr">PARTITION BY</code> method at <em>read time</em>, we wrote a sequence number at <em>write time</em> which guarantees round-robin enqueueing? At first glance, this seems difficult - we don't know that Alice will need to enqueue 1 task in the future if Bob enqueued 10,000 tasks now.</p>
<p>We can solve for this by reserving <em>contiguous blocks of IDs</em> for future enqueued runs which belong to groups which don't exist yet or don't have a task assigned for that block yet. We're going to partition <code dir="ltr">BIGINT</code> (max=<code dir="ltr">9,223,372,036,854,775,807</code>) into blocks of <code dir="ltr">blockLength</code>:</p>
<p><img alt="Blocks" loading="lazy" width="3812" height="2043" decoding="async" data-nimg="1" srcset="https://docs.hatchet.run/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fmulti-tenant-queues-1.f811f554.png&amp;w=3840&amp;q=75 1x" src="https://docs.hatchet.run/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fmulti-tenant-queues-1.f811f554.png&amp;w=3840&amp;q=75"></p>
<p>Next, let's assign task IDs according to the following algorithm:</p>
<ol>
<li>Maintain a unique numerical id <code dir="ltr">i</code> for each distinct group, and maintain a pointer <code dir="ltr">p</code> to the last block that was enqueued for each group - we'll call this <code dir="ltr">p(i)</code> .</li>
<li>Maintain a pointer <code dir="ltr">p</code> to the block containing the maximum task ID which doesn't have a <code dir="ltr">QUEUED</code> status (in other words, the maximum assigned task), call this <code dir="ltr">p_max_assigned</code>. If there are no tasks in the queue, set this to the maximum block across all <code dir="ltr">p(i)</code>. Initialize <code dir="ltr">p_max_assigned</code> at 0.</li>
<li>When a task is created in group <code dir="ltr">j</code>:<!-- -->
<ol>
<li>If this is a new group <code dir="ltr">j</code> is added, initialize <code dir="ltr">p(j)</code> to <code dir="ltr">p_max_assigned</code></li>
<li>If this is an existing group <code dir="ltr">j</code>, set <code dir="ltr">p(j)</code> to the greater of <code dir="ltr">p_max_assigned</code> or <code dir="ltr">p(j) + 1</code></li>
<li>Set the id of the task to <code dir="ltr">j + blockLength * p(j)</code></li>
</ol>
</li>
</ol>
<p><strong>*Note:</strong> we are making a critical assumption that the number of unique group keys will always be below the <code dir="ltr">blockLength</code> , and increasing the blockLength in the future would be a bit involved. A blockLength of ~1 million gives us ~1 billion task executions. To increase the block length, it's recommended that you add an offset equal to the the maximum task id, and start assigning task ids from there. We will also (in the worst case) cap out at 1 billion executed tasks, though this can be fixed by reassigning IDs when close to this limit.*</p>
<h3>SQL implemenation<a href="#sql-implemenation" id="sql-implemenation" aria-label="Permalink for this section"></a></h3>
<p>To actually implement this, let's add a new set of tables to our queue implementation. We'll add a table for <code dir="ltr">task_groups</code>, which maintains the pointer <code dir="ltr">p(i)</code> from above, along with a table called <code dir="ltr">task_addr_ptrs</code> which maintains <code dir="ltr">p_max_assigned</code> from above:</p>

<p>Next, we'll write our <code dir="ltr">CreateTask</code> query using a <code dir="ltr">blockLength</code> of <code dir="ltr">1024*1024</code>:</p>

<p>The great thing about this is that our <code dir="ltr">PopTasks</code> query doesn't change, we've just changed how we assign IDs. However, we do need to make sure to update <code dir="ltr">task_addr_ptrs</code> in the same transaction that we pop tasks from the queue:</p>

<p>Against 1 million enqueued tasks with 1000 partitions, we still only need to search across 100 rows:</p>

<p>You may also have noticed that because we stopped using the window function, we've removed the issue of selecting for previously locked rows. So even if we start 10 workers at the same time, we're guaranteed to select unique rows again:</p>

<p>This doesn't come without a tradeoff: our writes are slower due to continuously updating the <code dir="ltr">block_addr</code> parameter on the <code dir="ltr">task_group</code>. However, even the writes are constant-time, so the throughput on writes is still on the order of 500 to 1k tasks/second. If you'd prefer a higher write throughput, setting a small limit for placing tasks in the <code dir="ltr">OVERFLOW</code> queue and using the partition method from above may be a better approach.</p>
<h2>Introducing concurrency limits<a href="#introducing-concurrency-limits" id="introducing-concurrency-limits" aria-label="Permalink for this section"></a></h2>
<p>In the above implementation, we had a simple <code dir="ltr">LIMIT</code> statement to set an upper bound of the number of tasks a worker should execute. But what if we want to set a concurrency limit for each group of tasks? For example, not only do we want to limit a worker to 100 tasks globally, but we limit each group to 5 concurrent tasks (we'll refer to this number as <code dir="ltr">concurrency</code> below). This ensures that even if there are slots available on the worker, they are not automatically filled by the same user, which could again crowd out other users in the near future.</p>
<p>Luckily, this is quite simple with the implementation above. Because of the way we've divided task ids across different block addresses, we can simply limit concurrency by searching only from the minimum queued ID <code dir="ltr">min_id</code> to <code dir="ltr">min_id + blockLength * concurrency</code>:</p>

<p>This guarantees an additional level of fairness which makes it even harder for Bob's workloads to interfere with Alice's.</p>
<h2>Final thoughts<a href="#final-thoughts" id="final-thoughts" aria-label="Permalink for this section"></a></h2>
<p>We've covered deterministic round-robin queueing, but it turns out that many systems just need approximate fairness guarantees ("deterministic" in this case refers to the fact that tasks are processed in a deterministic order on subsequent reads - as opposed to using something like <code dir="ltr">ORDER BY RANDOM()</code>). But there are other approaches which provide approximate fairness, such as <a href="https://aws.amazon.com/builders-library/workload-isolation-using-shuffle-sharding/" target="_blank" rel="noreferrer">shuffle sharding<span> (opens in a new tab)</span></a>, which we'll show how to implement in Postgres in a future post.</p>
<p>If you have suggestions on making these queries more performant - or perhaps you spotted a bug - I'd love to hear from you in our <a href="https://discord.gg/ZMeUafwH89" target="_blank" rel="noreferrer">Discord<span> (opens in a new tab)</span></a>.</p>
<p><em><a href="https://cloud.onhatchet.run/" target="_blank" rel="noreferrer">Hatchet Cloud<span> (opens in a new tab)</span></a> is our managed Hatchet offering. Give it a spin and let us know what you think!</em></p></main></article></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[OpenMCT: A web based mission control framework (105 pts)]]></title>
            <link>https://github.com/nasa/openmct</link>
            <guid>40077048</guid>
            <pubDate>Thu, 18 Apr 2024 15:09:13 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://github.com/nasa/openmct">https://github.com/nasa/openmct</a>, See on <a href="https://news.ycombinator.com/item?id=40077048">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text">
<p dir="auto">Open MCT (Open Mission Control Technologies) is a next-generation mission control framework for visualization of data on desktop and mobile devices. It is developed at NASA's Ames Research Center, and is being used by NASA for data analysis of spacecraft missions, as well as planning and operation of experimental rover systems. As a generalizable and open source framework, Open MCT could be used as the basis for building applications for planning, operation, and analysis of any systems producing telemetry data.</p>

<p dir="auto">Once you've created something amazing with Open MCT, showcase your work in our GitHub Discussions <a href="https://github.com/nasa/openmct/discussions/categories/show-and-tell">Show and Tell</a> section. We love seeing unique and wonderful implementations of Open MCT!</p>
<p dir="auto"><a target="_blank" rel="noopener noreferrer nofollow" href="https://user-images.githubusercontent.com/4215777/203617422-4d912bfc-766f-4074-8324-409d9bbe7c05.png"><img src="https://user-images.githubusercontent.com/4215777/203617422-4d912bfc-766f-4074-8324-409d9bbe7c05.png" alt="Screen Shot 2022-11-23 at 9 51 36 AM"></a></p>
<p dir="auto"><h2 tabindex="-1" dir="auto">Building and Running Open MCT Locally</h2><a id="user-content-building-and-running-open-mct-locally" aria-label="Permalink: Building and Running Open MCT Locally" href="#building-and-running-open-mct-locally"></a></p>
<p dir="auto">Building and running Open MCT in your local dev environment is very easy. Be sure you have <a href="https://git-scm.com/downloads" rel="nofollow">Git</a> and <a href="https://nodejs.org/" rel="nofollow">Node.js</a> installed, then follow the directions below. Need additional information? Check out the <a href="https://nasa.github.io/openmct/getting-started/" rel="nofollow">Getting Started</a> page on our website.
(These instructions assume you are installing as a non-root user; developers have <a href="https://github.com/nasa/openmct/issues/1151" data-hovercard-type="issue" data-hovercard-url="/nasa/openmct/issues/1151/hovercard">reported issues</a> running these steps with root privileges.)</p>
<ol dir="auto">
<li>Clone the source code:</li>
</ol>
<div data-snippet-clipboard-copy-content="git clone https://github.com/nasa/openmct.git"><pre><code>git clone https://github.com/nasa/openmct.git
</code></pre></div>
<ol start="2" dir="auto">
<li>(Optional) Install the correct node version using <a href="https://github.com/nvm-sh/nvm">nvm</a>:</li>
</ol>

<ol start="3" dir="auto">
<li>Install development dependencies (Note: Check the <code>package.json</code> engine for our tested and supported node versions):</li>
</ol>

<ol start="4" dir="auto">
<li>Run a local development server:</li>
</ol>


<p dir="auto">Open MCT is built using <a href="http://npmjs.com/" rel="nofollow"><code>npm</code></a> and <a href="https://webpack.js.org/" rel="nofollow"><code>webpack</code></a>.</p>
<p dir="auto"><h2 tabindex="-1" dir="auto">Documentation</h2><a id="user-content-documentation" aria-label="Permalink: Documentation" href="#documentation"></a></p>
<p dir="auto">Documentation is available on the <a href="https://nasa.github.io/openmct/documentation/" rel="nofollow">Open MCT website</a>.</p>
<p dir="auto"><h3 tabindex="-1" dir="auto">Examples</h3><a id="user-content-examples" aria-label="Permalink: Examples" href="#examples"></a></p>
<p dir="auto">The clearest examples for developing Open MCT plugins are in the
<a href="https://github.com/nasa/openmct-tutorial">tutorials</a> provided in
our documentation.</p>

<p dir="auto"><h2 tabindex="-1" dir="auto">Developing Applications With Open MCT</h2><a id="user-content-developing-applications-with-open-mct" aria-label="Permalink: Developing Applications With Open MCT" href="#developing-applications-with-open-mct"></a></p>
<p dir="auto">For more on developing with Open MCT, see our documentation for a guide on <a href="https://github.com/nasa/openmct/blob/master/API.md#starting-an-open-mct-application">Developing Applications with Open MCT</a>.</p>
<p dir="auto"><h2 tabindex="-1" dir="auto">Compatibility</h2><a id="user-content-compatibility" aria-label="Permalink: Compatibility" href="#compatibility"></a></p>
<p dir="auto">This is a fast moving project and we do our best to test and support the widest possible range of browsers, operating systems, and nodejs APIs. We have a published list of support available in our package.json's <code>browserslist</code> key.</p>
<p dir="auto">The project uses <code>nvm</code> to ensure the node and npm version used, is coherent in all projects. Install nvm (non-windows), <a href="https://github.com/nvm-sh/nvm">here</a> or the windows equivalent <a href="https://github.com/coreybutler/nvm-windows">here</a></p>
<p dir="auto">If you encounter an issue with a particular browser, OS, or nodejs API, please file a <a href="https://github.com/nasa/openmct/issues/new/choose">GitHub issue</a></p>
<p dir="auto"><h2 tabindex="-1" dir="auto">Plugins</h2><a id="user-content-plugins" aria-label="Permalink: Plugins" href="#plugins"></a></p>
<p dir="auto">Open MCT can be extended via plugins that make calls to the Open MCT API. A plugin is a group
of software components (including source code and resources such as images and HTML templates)
that is intended to be added or removed as a single unit.</p>
<p dir="auto">As well as providing an extension mechanism, most of the core Open MCT codebase is also
written as plugins.</p>
<p dir="auto">For information on writing plugins, please see <a href="https://github.com/nasa/openmct/blob/master/API.md#plugins">our API documentation</a>.</p>
<p dir="auto"><h2 tabindex="-1" dir="auto">Tests</h2><a id="user-content-tests" aria-label="Permalink: Tests" href="#tests"></a></p>
<p dir="auto">Our automated test coverage comes in the form of unit, e2e, visual, performance, and security tests.</p>
<p dir="auto"><h3 tabindex="-1" dir="auto">Unit Tests</h3><a id="user-content-unit-tests" aria-label="Permalink: Unit Tests" href="#unit-tests"></a></p>
<p dir="auto">Unit Tests are written for <a href="https://jasmine.github.io/api/edge/global" rel="nofollow">Jasmine</a>
and run by <a href="http://karma-runner.github.io/" rel="nofollow">Karma</a>. To run:</p>
<p dir="auto"><code>npm test</code></p>
<p dir="auto">The test suite is configured to load any scripts ending with <code>Spec.js</code> found
in the <code>src</code> hierarchy. Full configuration details are found in
<code>karma.conf.js</code>. By convention, unit test scripts should be located
alongside the units that they test; for example, <code>src/foo/Bar.js</code> would be
tested by <code>src/foo/BarSpec.js</code>.</p>
<p dir="auto"><h3 tabindex="-1" dir="auto">e2e, Visual, and Performance tests</h3><a id="user-content-e2e-visual-and-performance-tests" aria-label="Permalink: e2e, Visual, and Performance tests" href="#e2e-visual-and-performance-tests"></a></p>
<p dir="auto">The e2e, Visual, and Performance tests are written for playwright and run by playwright's new test runner <a href="https://playwright.dev/" rel="nofollow">@playwright/test</a>.</p>
<p dir="auto">To run the e2e tests which are part of every commit:</p>
<p dir="auto"><code>npm run test:e2e:stable</code></p>
<p dir="auto">To run the visual test suite:</p>
<p dir="auto"><code>npm run test:e2e:visual</code></p>
<p dir="auto">To run the performance tests:</p>
<p dir="auto"><code>npm run test:perf</code></p>
<p dir="auto">The test suite is configured to all tests located in <code>e2e/tests/</code> ending in <code>*.e2e.spec.js</code>. For more about the e2e test suite, please see the <a href="https://github.com/nasa/openmct/blob/master/e2e/README.md">README</a></p>
<p dir="auto"><h3 tabindex="-1" dir="auto">Security Tests</h3><a id="user-content-security-tests" aria-label="Permalink: Security Tests" href="#security-tests"></a></p>
<p dir="auto">Each commit is analyzed for known security vulnerabilities using <a href="https://codeql.github.com/docs/codeql-language-guides/codeql-library-for-javascript/">CodeQL</a>. The list of CWE coverage items is available in the <a href="https://codeql.github.com/codeql-query-help/javascript-cwe/">CodeQL docs</a>. The CodeQL workflow is specified in the <a href="https://github.com/nasa/openmct/blob/master/.github/workflows/codeql-analysis.yml">CodeQL analysis file</a> and the custom <a href="https://github.com/nasa/openmct/blob/master/.github/codeql/codeql-config.yml">CodeQL config</a>.</p>
<p dir="auto"><h3 tabindex="-1" dir="auto">Test Reporting and Code Coverage</h3><a id="user-content-test-reporting-and-code-coverage" aria-label="Permalink: Test Reporting and Code Coverage" href="#test-reporting-and-code-coverage"></a></p>
<p dir="auto">Each test suite generates a report in CircleCI. For a complete overview of testing functionality, please see our <a href="https://app.circleci.com/insights/github/nasa/openmct/workflows/the-nightly/overview?branch=master&amp;reporting-window=last-30-days" rel="nofollow">Circle CI Test Insights Dashboard</a></p>
<p dir="auto">Our code coverage is generated during the runtime of our unit, e2e, and visual tests. The combination of those reports is published to <a href="https://app.codecov.io/gh/nasa/openmct/" rel="nofollow">codecov.io</a></p>
<p dir="auto">For more on the specifics of our code coverage setup, <a href="https://github.com/nasa/openmct/blob/master/TESTING.md#code-coverage">see</a></p>
<p dir="auto"><h2 tabindex="-1" dir="auto">Glossary</h2><a id="user-content-glossary" aria-label="Permalink: Glossary" href="#glossary"></a></p>
<p dir="auto">Certain terms are used throughout Open MCT with consistent meanings
or conventions. Any deviations from the below are issues and should be
addressed (either by updating this glossary or changing code to reflect
correct usage.) Other developer documentation, particularly in-line
documentation, may presume an understanding of these terms.</p>
<ul dir="auto">
<li><em>plugin</em>: A plugin is a removable, reusable grouping of software elements.
The application is composed of plugins.</li>
<li><em>composition</em>: In the context of a domain object, this refers to the set of
other domain objects that compose or are contained by that object. A domain
object's composition is the set of domain objects that should appear
immediately beneath it in a tree hierarchy. A domain object's composition is
described in its model as an array of id's; its composition capability
provides a means to retrieve the actual domain object instances associated
with these identifiers asynchronously.</li>
<li><em>description</em>: When used as an object property, this refers to the human-readable
description of a thing; usually a single sentence or short paragraph.
(Most often used in the context of extensions, domain
object models, or other similar application-specific objects.)</li>
<li><em>domain object</em>: A meaningful object to the user; a distinct thing in
the work support by Open MCT. Anything that appears in the left-hand
tree is a domain object.</li>
<li><em>identifier</em>: A tuple consisting of a namespace and a key, which together uniquely
identifies a domain object.</li>
<li><em>model</em>: The persistent state associated with a domain object. A domain
object's model is a JavaScript object which can be converted to JSON
without losing information (that is, it contains no methods.)</li>
<li><em>name</em>: When used as an object property, this refers to the human-readable
name for a thing. (Most often used in the context of extensions, domain
object models, or other similar application-specific objects.)</li>
<li><em>navigation</em>: Refers to the current state of the application with respect
to the user's expressed interest in a specific domain object; e.g. when
a user clicks on a domain object in the tree, they are <em>navigating</em> to
it, and it is thereafter considered the <em>navigated</em> object (until the
user makes another such choice.)</li>
<li><em>namespace</em>: A name used to identify a persistence store. A running open MCT
application could potentially use multiple persistence stores, with the</li>
</ul>
<p dir="auto"><h2 tabindex="-1" dir="auto">Open MCT v2.0.0</h2><a id="user-content-open-mct-v200" aria-label="Permalink: Open MCT v2.0.0" href="#open-mct-v200"></a></p>
<p dir="auto">Support for our legacy bundle-based API, and the libraries that it was built on (like Angular 1.x), have now been removed entirely from this repository.</p>
<p dir="auto">For now if you have an Open MCT application that makes use of the legacy API, <a href="https://github.com/nasa/openmct-legacy-plugin">a plugin</a> is provided that bootstraps the legacy bundling mechanism and API. This plugin will not be maintained over the long term however, and the legacy support plugin will not be tested for compatibility with future versions of Open MCT. It is provided for convenience only.</p>
<p dir="auto"><h3 tabindex="-1" dir="auto">How do I know if I am using legacy API?</h3><a id="user-content-how-do-i-know-if-i-am-using-legacy-api" aria-label="Permalink: How do I know if I am using legacy API?" href="#how-do-i-know-if-i-am-using-legacy-api"></a></p>
<p dir="auto">You might still be using legacy API if your source code</p>
<ul dir="auto">
<li>Contains files named bundle.js, or bundle.json,</li>
<li>Makes calls to <code>openmct.$injector()</code>, or <code>openmct.$angular</code>,</li>
<li>Makes calls to <code>openmct.legacyRegistry</code>, <code>openmct.legacyExtension</code>, or <code>openmct.legacyBundle</code>.</li>
</ul>
<p dir="auto"><h3 tabindex="-1" dir="auto">What should I do if I am using legacy API?</h3><a id="user-content-what-should-i-do-if-i-am-using-legacy-api" aria-label="Permalink: What should I do if I am using legacy API?" href="#what-should-i-do-if-i-am-using-legacy-api"></a></p>
<p dir="auto">Please refer to <a href="https://nasa.github.io/openmct/documentation/" rel="nofollow">the modern Open MCT API</a>. Post any questions to the <a href="https://github.com/nasa/openmct/discussions">Discussions section</a> of the Open MCT GitHub repository.</p>
<p dir="auto"><h2 tabindex="-1" dir="auto">Related Repos</h2><a id="user-content-related-repos" aria-label="Permalink: Related Repos" href="#related-repos"></a></p>
<div dir="auto"><p dir="auto">Note</p><p dir="auto">Although Open MCT functions as a standalone project, it is primarily an extensible framework intended to be used as a dependency with users' own plugins and packaging. Furthermore, Open MCT is intended to be used with an HTTP server such as Apache or Nginx. A great example of hosting Open MCT with Apache is <code>openmct-quickstart</code> and can be found in the table below.</p>
</div>
<table>
<thead>
<tr>
<th>Repository</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/nasa/openmct-tutorial">openmct-tutorial</a></td>
<td>A great place for beginners to learn how to use and extend Open MCT.</td>
</tr>
<tr>
<td><a href="https://github.com/scottbell/openmct-quickstart">openmct-quickstart</a></td>
<td>A working example of Open MCT integrated with Apache HTTP server, YAMCS telemetry, and Couch DB for persistence.</td>
</tr>
<tr>
<td><a href="https://github.com/akhenry/openmct-yamcs">Open MCT YAMCS Plugin</a></td>
<td>Plugin for integrating YAMCS telemetry and command server with Open MCT.</td>
</tr>
<tr>
<td><a href="https://github.com/unlikelyzero/openmct-performance">openmct-performance</a></td>
<td>Resources for performance testing Open MCT.</td>
</tr>
<tr>
<td><a href="https://github.com/unlikelyzero/openmct-as-a-dependency">openmct-as-a-dependency</a></td>
<td>An advanced guide for users on how to build, develop, and test Open MCT when it's used as a dependency.</td>
</tr>
</tbody>
</table>
</article></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Chinchilla Scaling: A replication attempt (109 pts)]]></title>
            <link>https://arxiv.org/abs/2404.10102</link>
            <guid>40077023</guid>
            <pubDate>Thu, 18 Apr 2024 15:05:59 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://arxiv.org/abs/2404.10102">https://arxiv.org/abs/2404.10102</a>, See on <a href="https://news.ycombinator.com/item?id=40077023">Hacker News</a></p>
<div id="readability-page-1" class="page"><div id="content-inner">
    
    
                
    <p><a href="https://arxiv.org/pdf/2404.10102">View PDF</a>
    <a href="https://arxiv.org/html/2404.10102v1">HTML (experimental)</a></p><blockquote>
            <span>Abstract:</span>Hoffmann et al. (2022) propose three methods for estimating a compute-optimal scaling law. We attempt to replicate their third estimation procedure, which involves fitting a parametric loss function to a reconstruction of data from their plots. We find that the reported estimates are inconsistent with their first two estimation methods, fail at fitting the extracted data, and report implausibly narrow confidence intervals--intervals this narrow would require over 600,000 experiments, while they likely only ran fewer than 500. In contrast, our rederivation of the scaling law using the third approach yields results that are compatible with the findings from the first two estimation procedures described by Hoffmann et al.
    </blockquote>

    <!--CONTEXT-->
    
  </div><div>
      <h2>Submission history</h2><p> From: Tamay Besiroglu [<a href="https://arxiv.org/show-email/186f8328/2404.10102">view email</a>]      <br>    <strong>[v1]</strong>
        Mon, 15 Apr 2024 19:19:56 UTC (947 KB)<br>
</p></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Hermit is a hermetic and reproducible sandbox for running programs (153 pts)]]></title>
            <link>https://github.com/facebookexperimental/hermit</link>
            <guid>40076848</guid>
            <pubDate>Thu, 18 Apr 2024 14:46:50 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://github.com/facebookexperimental/hermit">https://github.com/facebookexperimental/hermit</a>, See on <a href="https://news.ycombinator.com/item?id=40076848">Hacker News</a></p>
<div id="readability-page-1" class="page"><div data-hpc="true"><article itemprop="text"><p dir="auto"><h2 tabindex="-1" dir="auto">Hermit: A reproducible container</h2><a id="user-content-hermit-a-reproducible-container" aria-label="Permalink: Hermit: A reproducible container" href="#hermit-a-reproducible-container"></a></p>
<p dir="auto">Hermit forces deterministic execution of arbitrary programs and acts like a
reproducible container. That is, it <em>hermetically</em> isolates the program from
sources of non-determinism such as time, thread interleavings, random number
generation, etc. Guaranteed determinism is a powerful tool and it serves as a
basis for a number of applications, including concurrency stress testing,
record/replay, reproducible builds, and automatic diagnosis of concurrency bugs,
and more.</p>
<p dir="auto">Hermit cannot isolate the guest program from sources of non-determinism such as
file system changes or external network responses. Instead, in order to provide
complete determinism, the user should provide a fixed file system base image
(e.g., with Docker) and disable external networking.</p>
<p dir="auto"><h2 tabindex="-1" dir="auto">How it works</h2><a id="user-content-how-it-works" aria-label="Permalink: How it works" href="#how-it-works"></a></p>
<p dir="auto">Hermit sits between the guest process and the OS intercepting system calls made
by the guest (using <a href="https://github.com/facebookexperimental/reverie">Reverie</a>). In some cases, it can completely replace the
functionality of the kernel and suppress the original system call. In other
cases, it forwards the system call to the kernel and sanitizes the response such
that it is made deterministic.</p>
<p dir="auto">As a concrete example, lets say we have a program that reads random bytes from
<code>/dev/urandom</code>. Hermit will see that the guest opened this file (a known source
of non-determinism) and intercept subsequent reads to this file. Instead of
letting the OS fill a buffer with random bytes, Hermit uses a deterministic
pseudorandom number generator with a fixed seed to fill in the buffer. The
contents of the buffer are then guaranteed to be the same upon every execution
of the program.</p>
<p dir="auto">The most complex source of non-determinism is in the thread scheduler. The way
threads are scheduled by the kernel depends on many external factors, including
the number of physical CPUs or other threads running on the system that require
CPU time. To ensure that the threads of the guest process (and all of its child
processes) are scheduled in a repeatable way, we first make sure that all thread
executions are serialized so that there is effectively only one CPU. Then, we
deterministically pick which thread is allowed to run next. In order to only
allow a thread to run for a fixed number of instructions, we use the CPU's
Performance Monitoring Unit (PMU) to stop execution after a fixed number of
retired conditional branches (RCBs).</p>
<p dir="auto">Read below about how to build Hermit, and you can get an idea of what it does
from running examples in the <a href="https://github.com/facebookexperimental/hermit/blob/main/examples">./examples</a> folder.</p>
<p dir="auto"><h2 tabindex="-1" dir="auto">Building and running Hermit</h2><a id="user-content-building-and-running-hermit" aria-label="Permalink: Building and running Hermit" href="#building-and-running-hermit"></a></p>
<p dir="auto">Hermit is built with the standard Rust cargo tool.</p>

<p dir="auto">This builds the whole cargo workspace. The actual binary is located in target
directory (<code>target/debug/hermit</code>).</p>
<p dir="auto">Then, once you've built Hermit, all you need to run your program
deterministically is:</p>

<p dir="auto">After that you can try running it in a concurrency stress testing (chaos) mode,
or varying other parameters of the configuration such as the speed at which
virtual time passes inside the container, or the random number generation seed:</p>
<div dir="auto" data-snippet-clipboard-copy-content="hermit run --chaos --sched-seed=3 <prog>"><pre>hermit run --chaos --sched-seed=3 <span>&lt;</span>prog<span>&gt;</span></pre></div>
<p dir="auto">You can use hermit as a replay-debugger as well, either recording a
non-deterministic execution (real time, real randomness, etc), or repeatedly
running a controlled, deterministic one (virtual time, pseudo-randomness, etc).</p>
<div dir="auto" data-snippet-clipboard-copy-content="hermit record start <prog>
hermit replay"><pre>hermit record start <span>&lt;</span>prog<span>&gt;</span>
hermit replay</pre></div>
<p dir="auto"><h2 tabindex="-1" dir="auto">Example programs</h2><a id="user-content-example-programs" aria-label="Permalink: Example programs" href="#example-programs"></a></p>
<p dir="auto">See the <a href="https://github.com/facebookexperimental/hermit/blob/main/examples/README.md">the examples folder</a> for example programs and
instructions on how to run them.  These showcase different sources of
nondeterminism, and how hermit eliminates or controls them.</p>
<p dir="auto">In order to explore more advanced examples, you can look at some of
the integration tests built from <a href="https://github.com/facebookexperimental/hermit/blob/main/tests">./tests/</a> or <a href="https://github.com/facebookexperimental/hermit/blob/main/flaky-tests">./flaky-tests/</a>.
For example, using the commands below you can run a racey example
multiple times to see its nondeterminism.  Then run it under hermit to
watch that nondeterminism disappear.  Then run it under hermit <code>--chaos</code>
to bring that nondeterminism back, but in a controlled way that can be
reproduced based on the input seed.</p>
<div dir="auto" data-snippet-clipboard-copy-content="cargo build
for ((i=0; i<20; i++)); do ./target/debug/hello_race; done

for ((i=0; i<20; i++)); do hermit run ./target/debug/hello_race; done

for ((i=0; i<20; i++)); do
  hermit run --chaos --seed-from=SystemRandom ./target/debug/hello_race;
done"><pre>cargo build
<span>for</span> <span><span>((</span>i<span>=</span><span>0</span>; i<span>&lt;</span><span>20</span>; i<span>++</span><span>))</span></span><span>;</span> <span>do</span> ./target/debug/hello_race<span>;</span> <span>done</span>

<span>for</span> <span><span>((</span>i<span>=</span><span>0</span>; i<span>&lt;</span><span>20</span>; i<span>++</span><span>))</span></span><span>;</span> <span>do</span> hermit run ./target/debug/hello_race<span>;</span> <span>done</span>

<span>for</span> <span><span>((</span>i<span>=</span><span>0</span>; i<span>&lt;</span><span>20</span>; i<span>++</span><span>))</span></span><span>;</span> <span>do</span>
  hermit run --chaos --seed-from=SystemRandom ./target/debug/hello_race<span>;</span>
<span>done</span></pre></div>
<p dir="auto"><h2 tabindex="-1" dir="auto">The state of CI and testing</h2><a id="user-content-the-state-of-ci-and-testing" aria-label="Permalink: The state of CI and testing" href="#the-state-of-ci-and-testing"></a></p>
<p dir="auto">At Meta, this repository is built using buck.  We have over 700 integration
tests that run under this setup. But as of this initial release (2022-11-21), we
have not ported these tests to an external build system yet.</p>
<p dir="auto">A few unit tests run under <code>cargo test</code>, but the integration tests are more
complicated because they combine various run modes with each of the test
binaries (which are built from <code>tests/</code>, <code>flaky-tests/</code>, and the rr test suite
too).</p>
<p dir="auto">We plan to get the internal Buck configuration files building externally with
buck or bazel.</p>
<p dir="auto"><h2 tabindex="-1" dir="auto">Applications</h2><a id="user-content-applications" aria-label="Permalink: Applications" href="#applications"></a></p>
<p dir="auto">Hermit translates normal, non-deterministic Linux behavior, into deterministic,
repeatable behavior. This can be used for various applications, including:
record/replay debugging, simple reproducibility, "chaos mode" to expose
concurrency bugs in a controlled and repeatable way. Generally, Hermit makes
implicit inputs into explicit ones, and so enables searching over possible
executions by explicitly varying these inputs and study the changes in outcomes.
This can be used for either searching for bugs or trying to narrow down their
causes.</p>
<p dir="auto"><h2 tabindex="-1" dir="auto">Diagnosing concurrency bugs</h2><a id="user-content-diagnosing-concurrency-bugs" aria-label="Permalink: Diagnosing concurrency bugs" href="#diagnosing-concurrency-bugs"></a></p>
<p dir="auto">One experimental application that Hermit has built-in support for is diagnosing
concurrency bugs, in terms of identifying the stack traces of racing critical
operations which, if their order is flipped in the schedule, cause the program
to crash (also called an "order violation" bug). Hermit can detect these even if
the racing instructions are in different processes and written in different
programming languages.</p>
<p dir="auto">You can kick off analyze with any program invocation, and tell it to search for
failing (and passing) executions, and then diagnose the difference between them.</p>
<div data-snippet-clipboard-copy-content="hermit analyze --search -- <run_args> <prog>"><pre><code>hermit analyze --search -- &lt;run_args&gt; &lt;prog&gt;
</code></pre></div>
<p dir="auto"><h2 tabindex="-1" dir="auto">License</h2><a id="user-content-license" aria-label="Permalink: License" href="#license"></a></p>
<p dir="auto">Hermit is licensed under a BSD-3 clause license, included in the <code>LICENSE</code> file
in this directory.</p>
<p dir="auto"><h2 tabindex="-1" dir="auto">Support</h2><a id="user-content-support" aria-label="Permalink: Support" href="#support"></a></p>
<p dir="auto">Hermit currently supports x86_64 Linux. Aarch64 support is a
work in progress.</p>
</article></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Halo 2 in HD: Pushing the Original Xbox to the Limit (380 pts)]]></title>
            <link>https://icode4.coffee/?p=738</link>
            <guid>40076345</guid>
            <pubDate>Thu, 18 Apr 2024 14:01:06 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://icode4.coffee/?p=738">https://icode4.coffee/?p=738</a>, See on <a href="https://news.ycombinator.com/item?id=40076345">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>
									
									
<p>This blog post goes over all of the work I’ve done to add HD resolution support to the Original Xbox version of Halo 2. From patching the game to modifying the hardware of the Xbox console to writing custom tools for performance benchmarking, my goal with this project was to push the limits of both and see how far I could go. I’ve tried to keep this blog post as short as I could and only include the most technically interesting parts but even then it ended up quite long.</p>



<h2>Prelude</h2>



<p>A long time friend who goes by the handle “doom” has spent the past few years reverse engineering and researching the hardware and software on the original Xbox. His end goal was to learn more about PC hardware and see how far he could push the console. Some of his work includes swapping out the stock Pentium 3 CPU running at 733Mhz for a variant of the Pentium 3 CPU running at 1.4Ghz using a custom made CPU interposer board, and even being able to overclock it upwards of ~2Ghz. </p>



<div><figure><a href="https://icode4.coffee/wp-content/uploads/xbox_upgraded_cpu.png" target="_blank" rel="noopener"><img loading="lazy" width="960" height="720" src="https://icode4.coffee/wp-content/uploads/xbox_upgraded_cpu.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/xbox_upgraded_cpu.png 960w, https://icode4.coffee/wp-content/uploads/xbox_upgraded_cpu-300x225.png 300w, https://icode4.coffee/wp-content/uploads/xbox_upgraded_cpu-768x576.png 768w" sizes="(max-width: 960px) 100vw, 960px"></a><figcaption>Pentium 3 Tualatin on Doom’s custom interposer</figcaption></figure></div>



<p>Doom also wrote custom patches for the Xbox kernel in order to on-the-fly patch timing calculations for games so they ran properly with the faster CPU. Combined with a few other hardware upgrades such as additional RAM and an SSD, doom started to refer to these as “god boxes”. These god boxes were also running a custom kernel (or BIOS image) that doom made to support all of the hardware modifications and push the hardware and software as far as they could go. One of his demos for his work was showing the opening sequence in Half-Life 2 which is notorious for abysmally slow loading times and poor performance on the Xbox, running at a solid 30 FPS and loading in a matter of seconds. But there were still additional benefits to be had. Doom wanted someone to create a proper HD resolution patch for a popular game and really utilize the hardware upgrades he performed. </p>



<p>One night while talking over Discord doom asked if I would be interested in developing an HD patch for Halo 2 and in exchange he would provide me with a god box to develop it on. Halo 2 has a max supported video resolution of 480p and patching in support for 720p (and possibly 1080i) would get a lot of attention to demonstrate the benefits of all this work. We both knew that many of the community “HD” or “720p” game patches were not actually functioning correctly and that patching in HD resolution support for a game was more work than just searching for 640/480 in a disassembler and changing the resolution. These patches require a deep understanding of 3D graphics, DirectX APIs, and a lot of specific knowledge about the game and Xbox console. Having spent years reverse engineering the Xbox and Halo 2’s game engine I had the perfect background to take on the task. As doom would put it “there’s nobody more qualified than you to do it for halo 2 so that’s why I asked”. While it piqued my interest (and I was pretty jealous of these god boxes and all the experience he’d gotten developing them), I made a request/requirement before I would even entertain the idea. </p>



<p>The upgraded CPU has more than double the processing power compared to the stock CPU, however, the GPU was going to take on most of the increased processing load once the video resolution was increased. After all, each additional pixel in the output image would result in more pixel shader calculations which meant more work the GPU would have to do. If he could manage to overclock the GPU I would do it, but at stock clock speeds it wasn’t worth the time it would take to develop this patch just to have it fall over on the GPU. He said he would look into it, and after a few weeks time he came back and said it was done. He managed to overclock the GPU by ~15%, and said he had the “GENESIS-3” console ready for me (a nickname for the 3rd iteration of the “god box” upgrades he’d been working on).</p>



<h2>Part 1: Rendering in HD</h2>



<p>Having spent the past few years reverse engineering and re-implementing the Halo 2 rendering engine I already had a mental list of things I’d need to change to support higher video resolutions. The first thing that needed to be changed was the size of the D3D front and back buffers. The setup for the D3D device has 3 functions that need to be modified in order to use the proper resolution for the current video mode. The first is _rasterizer_detect_video_mode which checks the video mode and sets some global variables for widescreen and progressive video modes. Next is _rasterizer_init_screen_bounds which sets up the screen dimensions used for creating the D3D device, view frustum, and a number of other things. Lastly is rasterizer_device_initialize which is responsible for setting up the D3D device. Below is a shortened version of these 3 functions with the lines of interest highlighted. All of the code shown in this post has been reverse engineered from assembly back into C for ease of understanding.</p>



<div id="urvanov-syntax-highlighter-662143868a2df916053336" data-settings=" minimize scroll-mouseover">
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p><p>65</p></div>
				</td>
						<td><div><p><span>void</span><span> </span><span>_rasterizer_detect_video_mode</span><span>(</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>DWORD </span><span>videoStandard</span><span> </span><span>=</span><span> </span><span>XGetVideoStandard</span><span>(</span><span>)</span><span>;</span></p><p><span>	</span><span>DWORD </span><span>videoFlags</span><span> </span><span>=</span><span> </span><span>XGetVideoFlags</span><span>(</span><span>)</span><span>;</span></p><p><span>	</span><span>if</span><span> </span><span>(</span><span>videoStandard</span><span> </span><span>==</span><span> </span><span>XC_VIDEO_STANDARD_PAL_I</span><span>)</span></p><p><span>		</span><span>g_refresh_rate_hz</span><span> </span><span>=</span><span> </span><span>(</span><span>videoFlags</span><span> </span><span>&amp;</span><span> </span><span>XC_VIDEO_FLAGS_PAL_60Hz</span><span>)</span><span> </span><span>!=</span><span> </span><span>0</span><span> </span><span>?</span><span> </span><span>60</span><span> </span><span>:</span><span> </span><span>50</span><span>;</span></p><p><span>	</span><span>g_letterbox_enabled</span><span> </span><span>=</span><span> </span><span>(</span><span>videoFlags</span><span> </span><span>&amp;</span><span> </span><span>XC_VIDEO_FLAGS_LETTERBOX</span><span>)</span><span> </span><span>!=</span><span> </span><span>0</span><span>;</span></p><p><span>	</span><span>g_widescreen_enabled</span><span> </span><span>=</span><span> </span><span>(</span><span>videoFlags</span><span> </span><span>&amp;</span><span> </span><span>XC_VIDEO_FLAGS_WIDESCREEN</span><span>)</span><span> </span><span>!=</span><span> </span><span>0</span><span>;</span></p><p><span>	</span><span>g_progressive_scan_enabled</span><span> </span><span>=</span><span> </span><span>(</span><span>videoFlags</span><span> </span><span>&amp;</span><span> </span><span>XC_VIDEO_FLAGS_HDTV_480p</span><span>)</span><span> </span><span>!=</span><span> </span><span>0</span><span>;</span></p><p><span>	</span><span>.</span><span>.</span><span>.</span></p><p><span>}</span></p><p><span>void</span><span> </span><span>_rasterizer_init_screen_bounds</span><span>(</span><span>int</span><span> </span><span>x_off</span><span>,</span><span> </span><span>int</span><span> </span><span>y_off</span><span>,</span><span> </span><span>float</span><span> </span><span>scale</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>float</span><span> </span><span>width</span><span> </span><span>=</span><span> </span><span>640.0f</span><span> </span><span>*</span><span> </span><span>scale</span><span>;</span></p><p><span>	</span><span>float</span><span> </span><span>height</span><span> </span><span>=</span><span> </span><span>480.0f</span><span> </span><span>*</span><span> </span><span>scale</span><span>;</span></p><p><span>	</span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>x0</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span></p><p><span>	</span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>y0</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span></p><p><span>	</span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>x1</span><span> </span><span>=</span><span> </span><span>(</span><span>int</span><span>)</span><span>width</span><span>;</span></p><p><span>	</span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>y1</span><span> </span><span>=</span><span> </span><span>(</span><span>int</span><span>)</span><span>height</span><span>;</span></p><p><span>	</span><span>rasterizer_globals</span><span>.</span><span>frame_bounds</span><span>.</span><span>x0</span><span> </span><span>=</span><span> </span><span>x_off</span><span>;</span></p><p><span>	</span><span>rasterizer_globals</span><span>.</span><span>frame_bounds</span><span>.</span><span>y0</span><span> </span><span>=</span><span> </span><span>y_off</span><span>;</span></p><p><span>	</span><span>rasterizer_globals</span><span>.</span><span>frame_bounds</span><span>.</span><span>x1</span><span> </span><span>=</span><span> </span><span>(</span><span>int</span><span>)</span><span>width</span><span> </span><span>-</span><span> </span><span>x_off</span><span>;</span></p><p><span>	</span><span>rasterizer_globals</span><span>.</span><span>frame_bounds</span><span>.</span><span>y1</span><span> </span><span>=</span><span> </span><span>(</span><span>int</span><span>)</span><span>height</span><span> </span><span>-</span><span> </span><span>y_off</span><span>;</span></p><p><span>}</span></p><p><span>bool</span><span> </span><span>rasterizer_device_initialize</span><span>(</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>.</span><span>.</span><span>.</span></p><p><span>	</span><span>D3DPRESENT_PARAMETERS </span><span>PresentParams</span><span> </span><span>=</span><span> </span><span>{</span><span>0</span><span>}</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>BackBufferWidth</span><span> </span><span>=</span><span> </span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>x1</span><span> </span><span>-</span><span> </span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>x0</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>BackBufferHeight</span><span> </span><span>=</span><span> </span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>y1</span><span> </span><span>-</span><span> </span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>y1</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>BackBufferFormat</span><span> </span><span>=</span><span> </span><span>D3DFMT_A8R8G8B8</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>EnableAutoDepthStencil</span><span> </span><span>=</span><span> </span><span>TRUE</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>AutoDepthStencilFormat</span><span> </span><span>=</span><span> </span><span>D3DFMT_D24S8</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>Flags</span><span> </span><span>=</span><span> </span><span>D3DPRESENTFLAG_LOCKABLE_BACKBUFFER</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>FullScreen_RefreshRateInHz</span><span> </span><span>=</span><span> </span><span>g_refresh_rate_hz</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>FullScreen_PresentationInterval</span><span> </span><span>=</span><span> </span><span>D3DPRESENT_INTERVAL_IMMEDIATE</span><span>;</span></p><p><span>	</span><span>switch</span><span> </span><span>(</span><span>g_presentation_interval</span><span>)</span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>case</span><span> </span><span>0</span><span>:</span></p><p><span>			</span><span>PresentParams</span><span>.</span><span>SwapEffect</span><span> </span><span>=</span><span> </span><span>D3DSWAPEFFECT_FLIP</span><span>;</span></p><p><span>			</span><span>PresentParams</span><span>.</span><span>FullScreen_PresentationInterval</span><span> </span><span>=</span><span> </span><span>D3DPRESENT_INTERVAL_IMMEDIATE</span><span>;</span></p><p><span>			</span><span>break</span><span>;</span></p><p><span>		</span><span>case</span><span> </span><span>1</span><span>:</span></p><p><span>			</span><span>PresentParams</span><span>.</span><span>SwapEffect</span><span> </span><span>=</span><span> </span><span>D3DSWAPEFFECT_DISCARD</span><span>;</span></p><p><span>			</span><span>PresentParams</span><span>.</span><span>FullScreen_PresentationInterval</span><span> </span><span>|=</span><span> </span><span>g_present_immediately</span><span> </span><span>!=</span><span> </span><span>0</span><span> </span><span>?</span><span> </span><span>D3DPRESENT_INTERVAL_ONE</span><span> </span><span>:</span><span> </span><span>0</span><span>;</span></p><p><span>			</span><span>break</span><span>;</span></p><p><span>		</span><span>case</span><span> </span><span>2</span><span>:</span></p><p><span>			</span><span>PresentParams</span><span>.</span><span>SwapEffect</span><span> </span><span>=</span><span> </span><span>D3DSWAPEFFECT_DISCARD</span><span>;</span></p><p><span>			</span><span>PresentParams</span><span>.</span><span>FullScreen_PresentationInterval</span><span> </span><span>|=</span><span> </span><span>g_present_immediately</span><span> </span><span>!=</span><span> </span><span>0</span><span> </span><span>?</span><span> </span><span>D3DPRESENT_INTERVAL_TWO</span><span> </span><span>:</span><span> </span><span>0</span><span>;</span></p><p><span>			</span><span>break</span><span>;</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>g_pDirect3D</span><span>-&gt;</span><span>CreateDevice</span><span>(</span><span>0</span><span>,</span><span> </span><span>D3DDEVTYPE_HAL</span><span>,</span><span> </span><span>NULL</span><span>,</span><span> </span><span>D3DCREATE_HARDWARE_VERTEXPROCESSING</span><span>,</span><span> </span><span>&amp;</span><span>PresentParams</span><span>,</span><span> </span><span>&amp;</span><span>g_pD3DDevice</span><span>)</span><span>;</span></p><p><span>	</span><span>.</span><span>.</span><span>.</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>



<h4>Halo 2 already supports 480p, or does it…</h4>



<p>If you’ve ever looked at the back of the game case for Halo 2 you might have seen it supports 480p. However, looking at line 42 above, the D3DPRESENTFLAG_PROGRESSIVE flag is not being set on the present parameters. And, if we look at the call site for the _rasterizer_init_screen_bounds function we see this:</p>



<div><figure><a href="https://icode4.coffee/wp-content/uploads/ida_init_screen_bounds.png" target="_blank" rel="noopener"><img loading="lazy" width="605" height="471" src="https://icode4.coffee/wp-content/uploads/ida_init_screen_bounds.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/ida_init_screen_bounds.png 605w, https://icode4.coffee/wp-content/uploads/ida_init_screen_bounds-300x234.png 300w" sizes="(max-width: 605px) 100vw, 605px"></a><figcaption>Call site for _rasterizer_init_screen_bounds</figcaption></figure></div>



<p>The scale parameter is always set to 1.0f, which means the screen_bounds are always set to 640×480 regardless of what the video mode is set to on the console. On the Original Xbox 480p is considered to be 720×480, which means that <strong>Halo 2 does not render in 480p natively</strong> regardless of what the video settings are set to. If you enable 480p mode on the console you’ll get a 480p signal out but that’s because after the game is done drawing to the 640×480 back buffer it’ll get up-scaled to 720×480 by the GPU before being fed to the video encoder. I often get comments saying “that’s not not a 16:9 resolution” or “that’s not real 480p”, but “480p” <a rel="noreferrer noopener" href="https://en.wikipedia.org/wiki/480p#Resolutions" target="_blank">encapsulates a range of resolutions and aspect ratios</a> and 720×480 is the resolution the Xbox considers to be 480p (so take it up with Microsoft, not me…).</p>



<p>If you’ve ever played Halo 2 in 480p mode with wide screen enabled you may have noticed that things look a little weird. That’s because when wide screen mode is enabled the game will use an anamorphic camera with an aspect ratio of 1.33:1. That means it renders 1.3x the width into the same 640×480 surface as it would when wide screen mode is disabled. Here is a comparison showing the effect anamorphic scaling has on the Zanzibar wheel:</p>







<p>I’m not entirely sure why it does this and my only guess is if you set your TV to stretch mode it would “cancel out” the horizontal “squish” introduced by the anamorphic scaling and look somewhat normal. However, I personally hate it and wanted the cleanest image I could get out of the console so I added an option to disable the anamorphic scaling entirely.</p>



<h4>Back to the back buffer…</h4>



<p>To create the D3D front/back buffers with the right dimensions we’ll need to change g_progressive_scan_enabled to be set when 720p is enabled, set the screen_bounds and frame_bounds variables based on the proper video resolution for the video mode set, and finally set some additional flags on the D3D present parameters depending on if the video mode is progressive or interlaced (1080i mode). The pseudo code for the modifications is shown below with the changed lines highlighted. I ignored the scale variable in _rasterizer_init_screen_bounds because it’s only ever set to 1.0 anyway.</p>



<div id="urvanov-syntax-highlighter-662143868a2ec296228442" data-settings=" minimize scroll-mouseover">
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p><p>59</p><p>60</p><p>61</p><p>62</p><p>63</p><p>64</p><p>65</p><p>66</p><p>67</p><p>68</p><p>69</p><p>70</p><p>71</p><p>72</p><p>73</p><p>74</p><p>75</p><p>76</p><p>77</p><p>78</p><p>79</p><p>80</p><p>81</p><p>82</p><p>83</p><p>84</p></div>
				</td>
						<td><div><p><span>void</span><span> </span><span>_rasterizer_detect_video_mode</span><span>(</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>DWORD </span><span>videoStandard</span><span> </span><span>=</span><span> </span><span>XGetVideoStandard</span><span>(</span><span>)</span><span>;</span></p><p><span>	</span><span>DWORD </span><span>videoFlags</span><span> </span><span>=</span><span> </span><span>XGetVideoFlags</span><span>(</span><span>)</span><span>;</span></p><p><span>	</span><span>if</span><span> </span><span>(</span><span>videoStandard</span><span> </span><span>==</span><span> </span><span>XC_VIDEO_STANDARD_PAL_I</span><span>)</span></p><p><span>		</span><span>g_refresh_rate_hz</span><span> </span><span>=</span><span> </span><span>(</span><span>videoFlags</span><span> </span><span>&amp;</span><span> </span><span>XC_VIDEO_FLAGS_PAL_60Hz</span><span>)</span><span> </span><span>!=</span><span> </span><span>0</span><span> </span><span>?</span><span> </span><span>60</span><span> </span><span>:</span><span> </span><span>50</span><span>;</span></p><p><span>	</span><span>g_letterbox_enabled</span><span> </span><span>=</span><span> </span><span>(</span><span>videoFlags</span><span> </span><span>&amp;</span><span> </span><span>XC_VIDEO_FLAGS_LETTERBOX</span><span>)</span><span> </span><span>!=</span><span> </span><span>0</span><span>;</span></p><p><span>	</span><span>g_widescreen_enabled</span><span> </span><span>=</span><span> </span><span>(</span><span>videoFlags</span><span> </span><span>&amp;</span><span> </span><span>XC_VIDEO_FLAGS_WIDESCREEN</span><span>)</span><span> </span><span>!=</span><span> </span><span>0</span><span>;</span></p><p><span>	</span><span>g_progressive_scan_enabled</span><span> </span><span>=</span><span> </span><span>(</span><span>videoFlags</span><span> </span><span>&amp;</span><span> </span><span>(</span><span>XC_VIDEO_FLAGS_HDTV_480p</span><span> </span><span>|</span><span> </span><span>XC_VIDEO_FLAGS_HDTV_720p</span><span>)</span><span>)</span><span> </span><span>!=</span><span> </span><span>0</span><span>;</span></p><p><span>	</span><span>.</span><span>.</span><span>.</span></p><p><span>}</span></p><p><span>void</span><span> </span><span>_rasterizer_init_screen_bounds</span><span>(</span><span>int</span><span> </span><span>x_off</span><span>,</span><span> </span><span>int</span><span> </span><span>y_off</span><span>,</span><span> </span><span>float</span><span> </span><span>scale</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>// Set default resolution to 640x480.</span></p><p><span>	</span><span>float</span><span> </span><span>width</span><span> </span><span>=</span><span> </span><span>640.0f</span><span>;</span></p><p><span>	</span><span>float</span><span> </span><span>height</span><span> </span><span>=</span><span> </span><span>480.0f</span><span>;</span></p><p><span>	</span><span>// Adjust resolution based on current video mode set.</span></p><p><span>	</span><span>DWORD </span><span>videoFlags</span><span> </span><span>=</span><span> </span><span>XGetVideoFlags</span><span>(</span><span>)</span><span>;</span></p><p><span>	</span><span>if</span><span> </span><span>(</span><span>(</span><span>videoFlags</span><span> </span><span>&amp;</span><span> </span><span>XC_VIDEO_FLAGS_HDTV_1080i</span><span>)</span><span> </span><span>!=</span><span> </span><span>0</span><span>)</span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>width</span><span> </span><span>=</span><span> </span><span>1920</span><span>;</span></p><p><span>		</span><span>height</span><span> </span><span>=</span><span> </span><span>1080</span><span>;</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>else</span><span> </span><span>if</span><span> </span><span>(</span><span>(</span><span>videoFlags</span><span> </span><span>&amp;</span><span> </span><span>XC_VIDEO_FLAGS_HDTV_720p</span><span>)</span><span> </span><span>!=</span><span> </span><span>0</span><span>)</span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>width</span><span> </span><span>=</span><span> </span><span>1280</span><span>;</span></p><p><span>		</span><span>height</span><span> </span><span>=</span><span> </span><span>720</span><span>;</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>else</span><span> </span><span>if</span><span> </span><span>(</span><span>(</span><span>videoFlags</span><span> </span><span>&amp;</span><span> </span><span>XC_VIDEO_FLAGS_HDTV_480p</span><span>)</span><span> </span><span>!=</span><span> </span><span>0</span><span>)</span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>width</span><span> </span><span>=</span><span> </span><span>720</span><span>;</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>x0</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span></p><p><span>	</span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>y0</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span></p><p><span>	</span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>x1</span><span> </span><span>=</span><span> </span><span>(</span><span>int</span><span>)</span><span>width</span><span>;</span></p><p><span>	</span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>y1</span><span> </span><span>=</span><span> </span><span>(</span><span>int</span><span>)</span><span>height</span><span>;</span></p><p><span>	</span><span>rasterizer_globals</span><span>.</span><span>frame_bounds</span><span>.</span><span>x0</span><span> </span><span>=</span><span> </span><span>x_off</span><span>;</span></p><p><span>	</span><span>rasterizer_globals</span><span>.</span><span>frame_bounds</span><span>.</span><span>y0</span><span> </span><span>=</span><span> </span><span>y_off</span><span>;</span></p><p><span>	</span><span>rasterizer_globals</span><span>.</span><span>frame_bounds</span><span>.</span><span>x1</span><span> </span><span>=</span><span> </span><span>(</span><span>int</span><span>)</span><span>width</span><span> </span><span>-</span><span> </span><span>x_off</span><span>;</span></p><p><span>	</span><span>rasterizer_globals</span><span>.</span><span>frame_bounds</span><span>.</span><span>y1</span><span> </span><span>=</span><span> </span><span>(</span><span>int</span><span>)</span><span>height</span><span> </span><span>-</span><span> </span><span>y_off</span><span>;</span></p><p><span>}</span></p><p><span>bool</span><span> </span><span>rasterizer_device_initialize</span><span>(</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>.</span><span>.</span><span>.</span></p><p><span>	</span><span>D3DPRESENT_PARAMETERS </span><span>PresentParams</span><span> </span><span>=</span><span> </span><span>{</span><span>0</span><span>}</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>BackBufferWidth</span><span> </span><span>=</span><span> </span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>x1</span><span> </span><span>-</span><span> </span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>x0</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>BackBufferHeight</span><span> </span><span>=</span><span> </span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>y1</span><span> </span><span>-</span><span> </span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>y1</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>BackBufferFormat</span><span> </span><span>=</span><span> </span><span>D3DFMT_A8R8G8B8</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>EnableAutoDepthStencil</span><span> </span><span>=</span><span> </span><span>TRUE</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>AutoDepthStencilFormat</span><span> </span><span>=</span><span> </span><span>D3DFMT_D24S8</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>Flags</span><span> </span><span>=</span><span> </span><span>D3DPRESENTFLAG_LOCKABLE_BACKBUFFER</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>FullScreen_RefreshRateInHz</span><span> </span><span>=</span><span> </span><span>g_refresh_rate_hz</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>FullScreen_PresentationInterval</span><span> </span><span>=</span><span> </span><span>D3DPRESENT_INTERVAL_IMMEDIATE</span><span>;</span></p><p><span>	</span><span>.</span><span>.</span><span>.</span></p><p><span>	</span><span>// Check if wide screen mode is enabled.</span></p><p><span>	</span><span>if</span><span> </span><span>(</span><span>g_widescreen_enabled</span><span> </span><span>!=</span><span> </span><span>0</span><span>)</span></p><p><span>		</span><span>PresentParams</span><span>.</span><span>Flags</span><span> </span><span>|=</span><span> </span><span>D3DPRESENTFLAG_WIDESCREEN</span><span>;</span></p><p><span>	</span><span>// Check if the video mode supports progressive scan.</span></p><p><span>	</span><span>if</span><span> </span><span>(</span><span>g_progressive_scan_enabled</span><span> </span><span>!=</span><span> </span><span>0</span><span>)</span></p><p><span>		</span><span>PresentParams</span><span>.</span><span>Flags</span><span> </span><span>|=</span><span> </span><span>D3DPRESENTFLAG_PROGRESSIVE</span><span>;</span></p><p><span>	</span><span>// Check the resolution width to see if 1080i is enabled.</span></p><p><span>	</span><span>if</span><span> </span><span>(</span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>x1</span><span> </span><span>==</span><span> </span><span>1920</span><span>)</span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>PresentParams</span><span>.</span><span>Flags</span><span> </span><span>&amp;=</span><span> </span><span>~</span><span>D3DPRESENTFLAG_PROGRESSIVE</span><span>;</span></p><p><span>		</span><span>PresentParams</span><span>.</span><span>Flags</span><span> </span><span>|=</span><span> </span><span>D3DPRESENTFLAG_INTERLACED</span><span>;</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>g_pDirect3D</span><span>-&gt;</span><span>CreateDevice</span><span>(</span><span>0</span><span>,</span><span> </span><span>D3DDEVTYPE_HAL</span><span>,</span><span> </span><span>NULL</span><span>,</span><span> </span><span>D3DCREATE_HARDWARE_VERTEXPROCESSING</span><span>,</span><span> </span><span>&amp;</span><span>PresentParams</span><span>,</span><span> </span><span>&amp;</span><span>g_pD3DDevice</span><span>)</span><span>;</span></p><p><span>	</span><span>.</span><span>.</span><span>.</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>



<p>Booting up the game with these changes gives some less than pleasing results. Looking at the main menu the first thing we can see is the blue filter is now gone, and there’s some repeating line pattern strewn across the screen. Looking a bit closer and we can see part of the water geometry is also cut off, suspiciously at where the old 640 width would be compared to the new width of 720.</p>



<div><figure><a href="https://icode4.coffee/wp-content/uploads/main_menu_issues.png" target="_blank" rel="noopener"><img loading="lazy" width="720" height="480" src="https://icode4.coffee/wp-content/uploads/main_menu_issues.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/main_menu_issues.png 720w, https://icode4.coffee/wp-content/uploads/main_menu_issues-300x200.png 300w" sizes="(max-width: 720px) 100vw, 720px"></a><figcaption>Rendering issues in the main menu</figcaption></figure></div>



<h2>Making efficient use of D3D memory</h2>



<p>The Xbox uses a unified memory architecture meaning the CPU and GPU share the same RAM. Unlike a PC there’s no concept of creating a D3D allocation in VRAM and having the GPU manage it. On Xbox the CPU can create an allocation for textures, render targets, vertex buffers, etc, and pass the allocation address directly to the GPU. This gives developers the ability to allocate one buffer and have multiple resource “views” that utilize the memory. Consider the following code which shows how to create a render target letting D3D do all the work and how to create a render target by hand:</p>



<div id="urvanov-syntax-highlighter-662143868a2f2073411409" data-settings=" minimize scroll-mouseover">
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>// How to create a render target with D3D:</span></p><p><span>IDirect3DSurface8</span><span>*</span><span> </span><span>pRenderTarget</span><span> </span><span>=</span><span> </span><span>NULL</span><span>;</span></p><p><span>g_pD3DDevice</span><span>-&gt;</span><span>CreateRenderTarget</span><span>(</span><span>/* width */</span><span> </span><span>1024</span><span>,</span><span> </span><span>/* height */</span><span> </span><span>1024</span><span>,</span><span> </span><span>/* format */</span><span> </span><span>D3DFMT_A8R8G8B8</span><span>,</span><span> </span><span>NULL</span><span>,</span><span> </span><span>FALSE</span><span>,</span><span> </span><span>&amp;</span><span>pRenderTarget</span><span>)</span><span>;</span></p><p><span>// How to create a render target by hand:</span></p><p><span>// Allocate and initialize the texture header.</span></p><p><span>IDirect3DSurface8</span><span>*</span><span> </span><span>pRenderTarget</span><span> </span><span>=</span><span> </span><span>(</span><span>IDirect3DSurface8</span><span>*</span><span>)</span><span>malloc</span><span>(</span><span>sizeof</span><span>(</span><span>IDirect3DSurface8</span><span>)</span><span>)</span><span>;</span></p><p><span>DWORD </span><span>textureSize</span><span> </span><span>=</span><span> </span><span>XGSetTextureHeader</span><span>(</span><span>/* width */</span><span> </span><span>1024</span><span>,</span><span> </span><span>/* height */</span><span> </span><span>1024</span><span>,</span><span> </span><span>/* levels */</span><span> </span><span>0</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>/* format */</span><span> </span><span>D3DFMT_A8R8G8B8</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>pRenderTarget</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>0</span><span>)</span><span>;</span></p><p><span>// Allocate memory for the pixel buffer.</span></p><p><span>void</span><span>*</span><span> </span><span>pSurfaceBuffer</span><span> </span><span>=</span><span> </span><span>D3D_AllocContiguousMemory</span><span>(</span><span>/* size */</span><span> </span><span>textureSize</span><span>,</span><span> </span><span>/* alignment */</span><span> </span><span>D3DSURFACE_ALIGNMENT</span><span>)</span><span>;</span></p><p><span>pRenderTarget</span><span>-&gt;</span><span>Register</span><span>(</span><span>pSurfaceBuffer</span><span>)</span><span>;</span></p></div></td>
					</tr>
				</tbody></table>
			</div>



<p>While the latter looks more messy it provides greater control to the developer and is something Halo 2 makes great use of to conserve memory for all the render targets it uses. In total Halo 2 has approximately 25 different render targets it uses but there’s only 4-5 unique buffers allocated for them which saves a lot of memory. So what does this have to do with the issues we saw in the main menu? Well if Halo 2 is creating render targets by hand it’ll need to encode the width and height of the surface into the header of the render target structure. If it’s hard coded to use 640×480 resolution it would cause issues that could result in cut off images or repeating line patterns as the pitch of the surface would not match the pitch of the back buffer. Essentially, there’s two different “views” for the same memory but the views see the memory as being of different widths which results in misplaced pixels when spanning each scan line. </p>



<p>Looking around the D3D/raster initialization code I found a function I called rasterizer_primary_targets_initialize that does exactly this. It takes the back, front, and depth buffers created by D3D and creates additional render targets and texture views from them, using hard coded dimensions of 640×480. Here is the C representation of the disassembly:</p>



<div id="urvanov-syntax-highlighter-662143868a2f5014285151" data-settings=" minimize scroll-mouseover">
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p></div>
				</td>
						<td><div><p><span>bool</span><span> </span><span>rasterizer_primary_targets_initialize</span><span>(</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>// Get the back buffer, front buffer, and depth buffer surfaces.</span></p><p><span>	</span><span>global_d3d_device</span><span>-&gt;</span><span>GetBackBuffer</span><span>(</span><span>0</span><span>,</span><span> </span><span>D3DBACKBUFFER_TYPE_MONO</span><span>,</span><span> </span><span>&amp;</span><span>global_d3d_surface_render_primary</span><span>[</span><span>0</span><span>]</span><span>)</span><span>;</span></p><p><span>	</span><span>global_d3d_device</span><span>-&gt;</span><span>GetBackBuffer</span><span>(</span><span>-</span><span>1</span><span>,</span><span> </span><span>D3DBACKBUFFER_TYPE_MONO</span><span>,</span><span> </span><span>&amp;</span><span>global_d3d_surface_render_primary</span><span>[</span><span>1</span><span>]</span><span>)</span><span>;</span></p><p><span>	</span><span>global_d3d_device</span><span>-&gt;</span><span>GetDepthStencilSurface</span><span>(</span><span>&amp;</span><span>global_d3d_surface_render_primary_z</span><span>)</span><span>;</span></p><p><span>	</span><span>.</span><span>.</span><span>.</span></p><p><span>	</span><span>global_d3d_texture_render_primary</span><span>[</span><span>0</span><span>]</span><span> </span><span>=</span><span> </span><span>(</span><span>IDirect3DTexture8</span><span>*</span><span>)</span><span>malloc</span><span>(</span><span>sizeof</span><span>(</span><span>IDirect3DTexture8</span><span>)</span><span>)</span><span>;</span></p><p><span>	</span><span>global_d3d_texture_render_primary</span><span>[</span><span>1</span><span>]</span><span> </span><span>=</span><span> </span><span>(</span><span>IDirect3DTexture8</span><span>*</span><span>)</span><span>malloc</span><span>(</span><span>sizeof</span><span>(</span><span>IDirect3DTexture8</span><span>)</span><span>)</span><span>;</span></p><p><span>	</span><span>// Setup texture views for back/front buffers.</span></p><p><span>	</span><span>for</span><span> </span><span>(</span><span>int</span><span> </span><span>i</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span><span> </span><span>i</span><span> </span><span>&lt;</span><span> </span><span>2</span><span>;</span><span> </span><span>i</span><span>++</span><span>)</span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>XGSetTextureHeader</span><span>(</span><span>640</span><span>,</span><span> </span><span>480</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>D3DFMT_LIN_A8R8G8B8</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span></p><p><span>			</span><span>global_d3d_texture_render_primary</span><span>[</span><span>i</span><span>]</span><span>,</span><span> </span><span>global_d3d_surface_render_primary</span><span>[</span><span>i</span><span>]</span><span>-&gt;</span><span>Data</span><span>,</span><span> </span><span>0</span><span>)</span><span>;</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>// Create a render target surface for the depth buffer that matches the size and format of the back buffer.</span></p><p><span>	</span><span>global_d3d_surface_z_as_target</span><span> </span><span>=</span><span> </span><span>(</span><span>IDirect3DSurface8</span><span>*</span><span>)</span><span>malloc</span><span>(</span><span>sizeof</span><span>(</span><span>IDirect3DSurface8</span><span>)</span><span>)</span><span>;</span></p><p><span>	</span><span>memcpy</span><span>(</span><span>global_d3d_surface_z_as_target</span><span>,</span><span> </span><span>global_d3d_surface_render_primary</span><span>,</span><span> </span><span>sizeof</span><span>(</span><span>IDirect3DSurface8</span><span>)</span><span>)</span><span>;</span></p><p><span>	</span><span>global_d3d_surface_z_as_target</span><span>-&gt;</span><span>Data</span><span> </span><span>=</span><span> </span><span>global_d3d_surface_render_primary_z</span><span>-&gt;</span><span>Data</span><span>;</span></p><p><span>	</span><span>// Create two textures for the depth buffer, one in ARGB format and one in ABGR format.</span></p><p><span>	</span><span>global_d3d_texture_z_as_target</span><span>[</span><span>0</span><span>]</span><span> </span><span>=</span><span> </span><span>(</span><span>IDirect3DTexture8</span><span>*</span><span>)</span><span>malloc</span><span>(</span><span>sizeof</span><span>(</span><span>IDirect3DTexture8</span><span>)</span><span>)</span><span>;</span></p><p><span>	</span><span>XGSetTextureHeader</span><span>(</span><span>640</span><span>,</span><span> </span><span>480</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>D3DFMT_LIN_A8R8G8B8</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span></p><p><span>		</span><span>global_d3d_texture_z_as_target</span><span>[</span><span>0</span><span>]</span><span>,</span><span> </span><span>global_d3d_surface_render_primary_z</span><span>-&gt;</span><span>Data</span><span>,</span><span> </span><span>0</span><span>)</span><span>;</span></p><p><span>	</span><span>global_d3d_texture_z_as_target</span><span>[</span><span>1</span><span>]</span><span> </span><span>=</span><span> </span><span>(</span><span>IDirect3DTexture8</span><span>*</span><span>)</span><span>malloc</span><span>(</span><span>sizeof</span><span>(</span><span>IDirect3DTexture8</span><span>)</span><span>)</span><span>;</span></p><p><span>	</span><span>XGSetTextureHeader</span><span>(</span><span>640</span><span>,</span><span> </span><span>480</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>D3DFMT_LIN_A8B8G8R8</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span></p><p><span>		</span><span>global_d3d_texture_z_as_target</span><span>[</span><span>1</span><span>]</span><span>,</span><span> </span><span>global_d3d_surface_render_primary_z</span><span>-&gt;</span><span>Data</span><span>,</span><span> </span><span>0</span><span>)</span><span>;</span></p><p><span>	</span><span>.</span><span>.</span><span>.</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>



<p>This is relatively easy to fix, we simply need to hook this function, let it run normally, and then fix up the dimensions of the textures/surfaces afterwards. The pseudo code for this hook can be seen below:</p>



<div id="urvanov-syntax-highlighter-662143868a2f8039876927" data-settings=" minimize scroll-mouseover">
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p></div>
				</td>
						<td><div><p><span>bool</span><span> </span><span>Hook_rasterizer_primary_targets_initialize</span><span>(</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>// Call the trampoline and let the real function complete.</span></p><p><span>	</span><span>bool</span><span> </span><span>result</span><span> </span><span>=</span><span> </span><span>rasterizer_primary_targets_initialize_trampoline</span><span>(</span><span>)</span><span>;</span></p><p><span>	</span><span>// Update the dimensions of the surface/textures created to match the resolution of the back buffer.</span></p><p><span>	</span><span>Hack_UpdateD3dPixelContainerForScreenResolution</span><span>(</span><span>global_d3d_texture_render_primary</span><span>[</span><span>0</span><span>]</span><span>)</span><span>;</span></p><p><span>	</span><span>Hack_UpdateD3dPixelContainerForScreenResolution</span><span>(</span><span>global_d3d_texture_render_primary</span><span>[</span><span>1</span><span>]</span><span>)</span><span>;</span></p><p><span>	</span><span>Hack_UpdateD3dPixelContainerForScreenResolution</span><span>(</span><span>global_d3d_texture_z_as_target</span><span>[</span><span>0</span><span>]</span><span>)</span><span>;</span></p><p><span>	</span><span>Hack_UpdateD3dPixelContainerForScreenResolution</span><span>(</span><span>global_d3d_texture_z_as_target</span><span>[</span><span>1</span><span>]</span><span>)</span><span>;</span></p><p><span>	</span><span>return</span><span> </span><span>result</span><span>;</span></p><p><span>}</span></p><p><span>void</span><span> </span><span>Hack_UpdateD3dPixelContainerForScreenResolution</span><span>(</span><span>D3DBaseTexture</span><span>*</span><span> </span><span>pResource</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>// Calculate the correct pitch for the texture with tiling enabled. This can be different than the normal pitch</span></p><p><span>	</span><span>// value and if set incorrectly will cause a "striping" effect on the back buffer.</span></p><p><span>	</span><span>DWORD </span><span>format</span><span> </span><span>=</span><span> </span><span>(</span><span>pResource</span><span>-&gt;</span><span>Format</span><span> </span><span>&gt;&gt;</span><span> </span><span>8</span><span>)</span><span> </span><span>&amp;</span><span> </span><span>0xFF</span><span>;</span></p><p><span>	</span><span>DWORD </span><span>pitch</span><span> </span><span>=</span><span> </span><span>D3D_CalcTilePitch</span><span>(</span><span>/* width */</span><span> </span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>x1</span><span>,</span><span> </span><span>/* texture format */</span><span> </span><span>format</span><span>)</span><span>;</span></p><p><span>	</span><span>// Set the new dimensions of the texture using the size of the back buffer.</span></p><p><span>	</span><span>XGSetTextureHeader</span><span>(</span><span>/* width */</span><span> </span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>x1</span><span>,</span><span> </span><span>/* height */</span><span> </span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>y1</span><span>,</span></p><p><span>		</span><span>1</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>format</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>pResource</span><span>,</span><span> </span><span>pResource</span><span>-&gt;</span><span>Data</span><span>,</span><span> </span><span>pitch</span><span>)</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>



<p>There’s one additional thing to note here and it’s that the memory used for the back, front, and depth buffers is a special type of memory known as “tiled” memory. Tiled memory stores the pixel data in a way that’s more efficient to read and write to based on the design of the actual RAM chip’s memory cells. Storing the pixel data in tiled memory decreases the overall bandwidth required when reading and writing these buffers. The gotcha here is that the pitch value for the surface/texture is not always the same as it would be for a texture in normal memory (width * bpp). This is why I call D3D_CalcTilePitch in the the Hack_UpdateD3dPixelContainerForScreenResolution helper function. It will calculate the correct pitch for tiled memory based on the width and bits per pixel for the texture format. If the pitch value is calculated incorrectly (ex: by doing width * bpp) you’ll end up getting a “striping” effect on the back buffer (which affects 1080i video resolutions specifically). If you’re curious what tiled memory looks like if you don’t “un-tile” it here you go:</p>



<div><figure><a href="https://icode4.coffee/wp-content/uploads/tiled_back_buffer.png" target="_blank" rel="noopener"><img loading="lazy" width="1095" height="616" src="https://icode4.coffee/wp-content/uploads/tiled_back_buffer.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/tiled_back_buffer.png 1095w, https://icode4.coffee/wp-content/uploads/tiled_back_buffer-300x169.png 300w, https://icode4.coffee/wp-content/uploads/tiled_back_buffer-768x432.png 768w" sizes="(max-width: 1095px) 100vw, 1095px"></a><figcaption>D3D back buffer of the main menu in tiled form</figcaption></figure></div>



<p>This is the main menu image from earlier (only in 720p) dumped straight from the back buffer without un-tiling the data. If you squint hard enough you can almost make out the Halo 2 logo in the center. That aside it’s time to test the new patches and see if the modifications to the surface dimensions fixed our issues. Loading up the game with this new set of modifications gives us this:</p>



<div><figure><a href="https://icode4.coffee/wp-content/uploads/main_menu_issues2.png" target="_blank" rel="noopener"><img loading="lazy" width="720" height="480" src="https://icode4.coffee/wp-content/uploads/main_menu_issues2.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/main_menu_issues2.png 720w, https://icode4.coffee/wp-content/uploads/main_menu_issues2-300x200.png 300w" sizes="(max-width: 720px) 100vw, 720px"></a><figcaption>Main menu with some issues fixed</figcaption></figure></div>



<p>Okay so the striping effect from using the incorrect pitch value in the back/front buffer surfaces is now fixed. However, the water geometry is still cutoff even after we changed the resolutions of all the render targets/textures, right? Well we only updated the <em>primary</em> render targets, we still need to update the intermediate render targets used by the game’s rasterizer, and this is where having game engine specific knowledge comes in handy.</p>



<h2>Resizing the rasterizer targets</h2>



<p>As I mentioned earlier there’s ~25 render targets Halo 2 uses for different passes in the render loop such as detail texture blending, water, reflections, fog, shadows, etc. The game’s rasterizer system allows for creating a render target with child render targets that utilize the same underlying memory. The 25 render targets the game creates are backed by only 4-5 unique memory allocations and uses this parent/child relationship to make efficient use of the memory. When one render target is no longer in use the others are free to use that memory. While most render targets are smaller than the back buffer (ranging from 512×512 all the way down to 64×64) there’s one in particular that needs to match the back buffer resolution which is the texture accumulator target, or taxaccum for short.</p>



<p>The DirectX implementation on Xbox only allows for sampling from 4 textures per pixel shader pass. If you want to render something that uses more than 4 input textures you’ll need to do it in two or more passes. This is what the texaccum layer is for. Objects in the game that use more than 4 textures will first render all the detail textures to the texaccum layer. When the texaccum pass is completed the taxaccum render target will be fed into the lightmap pass as an input and combined with any additional textures for the object along with the lightmap texture to get the final output.</p>



<div><figure><a href="https://icode4.coffee/wp-content/uploads/taxaccum_lightmap_pass.png" target="_blank" rel="noopener"><img loading="lazy" width="1901" height="1080" src="https://icode4.coffee/wp-content/uploads/taxaccum_lightmap_pass-1901x1080.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/taxaccum_lightmap_pass-1901x1080.png 1901w, https://icode4.coffee/wp-content/uploads/taxaccum_lightmap_pass-300x170.png 300w, https://icode4.coffee/wp-content/uploads/taxaccum_lightmap_pass-768x436.png 768w, https://icode4.coffee/wp-content/uploads/taxaccum_lightmap_pass-1536x873.png 1536w, https://icode4.coffee/wp-content/uploads/taxaccum_lightmap_pass-2048x1164.png 2048w" sizes="(max-width: 1901px) 100vw, 1901px"></a><figcaption>Texaccum and lightmap shader passes</figcaption></figure></div>



<p>Here’s an example using the ground geometry in coagulation. In the texaccum pass the detail textures for the ground geometry are blended together into the texaccum render target. Then in the lightmap pass the texaccum render target is used as an input texture along with a bump map and lightmap texture to create the final image. The reason the water geometry in the main menu is cut off is because it’s being rendered to the texaccum render target which has a hard coded size of 640×480. Now that we’re rendering in larger video resolutions the dimensions of the texaccum target will need to be increased. Looking through the rasterizer initialization code we’ll find a function I called rasterizer_targets_initialize that allocates buffers for the various render targets and initializes them:</p>



<div id="urvanov-syntax-highlighter-662143868a2fb981828718" data-settings=" minimize scroll-mouseover">
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p></div>
				</td>
						<td><div><p><span>bool</span><span> </span><span>rasterizer_targets_initialize</span><span>(</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>// Allocate and initialize the texaccum render target.</span></p><p><span>	</span><span>if</span><span> </span><span>(</span><span>!</span><span>_rasterizer_alloc_and_create_render_target</span><span>(</span><span>1</span><span>,</span><span> </span><span>640</span><span>,</span><span> </span><span>480</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>false</span><span>)</span><span>)</span></p><p><span>		</span><span>return</span><span> </span><span>false</span><span>;</span></p><p><span>	</span><span>.</span><span>.</span><span>.</span></p><p><span>}</span></p><p><span>bool</span><span> </span><span>_rasterizer_alloc_and_create_render_target</span><span>(</span><span>int</span><span> </span><span>target_index</span><span>,</span><span> </span><span>int</span><span> </span><span>width</span><span>,</span><span> </span><span>int</span><span> </span><span>height</span><span>,</span><span> </span><span>int</span><span> </span><span>unk</span><span>,</span><span> </span><span>bool</span><span> </span><span>z_surface</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>// Calculate the allocation size rounded up to the nearest page size.</span></p><p><span>	</span><span>int</span><span> </span><span>allocationSize</span><span> </span><span>=</span><span> </span><span>(</span><span>(</span><span>(</span><span>(</span><span>width</span><span> </span><span>+</span><span> </span><span>63</span><span>)</span><span> </span><span>&amp;</span><span> </span><span>~</span><span>64</span><span>)</span><span> </span><span>*</span><span> </span><span>height</span><span> </span><span>*</span><span> </span><span>4</span><span>)</span><span> </span><span>+</span><span> </span><span>4095</span><span>)</span><span> </span><span>&amp;</span><span> </span><span>~</span><span>4096</span><span>;</span></p><p><span>	</span><span>// Allocate memory from the game's self-managed memory pool.</span></p><p><span>	</span><span>void</span><span>*</span><span> </span><span>pPhysicalAllocPtr</span><span> </span><span>=</span><span> </span><span>physical_memory_globals</span><span>.</span><span>hi_stage_address</span><span>[</span><span>physical_memory_globals</span><span>.</span><span>current_stage</span><span>]</span><span> </span><span>-</span><span> </span><span>allocationSize</span><span>;</span></p><p><span>	</span><span>if</span><span> </span><span>(</span><span>pPhysicalAllocPtr</span><span> </span><span>&gt;</span><span> </span><span>physical_memory_globals</span><span>.</span><span>low_stage_address</span><span>[</span><span>physical_memory_globals</span><span>.</span><span>current_stage</span><span>]</span><span>)</span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>physical_memory_globals</span><span>.</span><span>hi_stage_address</span><span>[</span><span>physical_memory_globals</span><span>.</span><span>current_stage</span><span>]</span><span> </span><span>=</span><span> </span><span>pPhysicalAllocPtr</span><span>;</span></p><p><span>		</span><span>// Mark the allocated memory as RW write-combine memory.</span></p><p><span>		</span><span>pPhysicalAllocPtr</span><span> </span><span>|=</span><span> </span><span>PHYSICAL_MEM_ADDRESS_MASK</span><span>;</span></p><p><span>		</span><span>XPhysicalProtect</span><span>(</span><span>pPhysicalAllocPtr</span><span>,</span><span> </span><span>allocationSize</span><span>,</span><span> </span><span>PAGE_READWRITE</span><span> </span><span>|</span><span> </span><span>PAGE_WRITECOMBINE</span><span>)</span><span>;</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>return</span><span> </span><span>_rasterizer_create_render_target</span><span>(</span><span>target_index</span><span>,</span><span> </span><span>/* type */</span><span> </span><span>1</span><span>,</span><span> </span><span>width</span><span>,</span><span> </span><span>height</span><span>,</span><span> </span><span>z_surface</span><span>,</span><span> </span><span>/* linear */</span><span> </span><span>true</span><span>,</span><span> </span><span>true</span><span>,</span><span> </span><span>pPhysicalAllocPtr</span><span>)</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>



<p>To fix the hard coded dimensions I simply hook the _rasterizer_alloc_and_create_render_target function, check the target_index parameter for the texaccum index, and change the dimensions to match the back buffer size. The pseudo code for the hook looks like this:</p>



<div id="urvanov-syntax-highlighter-662143868a2ff522909558" data-settings=" minimize scroll-mouseover">
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>bool</span><span> </span><span>Hook__rasterizer_alloc_and_create_render_target</span><span>(</span><span>int</span><span> </span><span>target_index</span><span>,</span><span> </span><span>int</span><span> </span><span>width</span><span>,</span><span> </span><span>int</span><span> </span><span>height</span><span>,</span><span> </span><span>int</span><span> </span><span>unk</span><span>,</span><span> </span><span>bool</span><span> </span><span>z_surface</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>// Check the rasterizer target index and adjust the surface dimensions accordingly.</span></p><p><span>	</span><span>if</span><span> </span><span>(</span><span>target_index</span><span> </span><span>==</span><span> </span><span>1</span><span>)</span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>// Texaccum rasterizer target:</span></p><p><span>		</span><span>width</span><span> </span><span>=</span><span> </span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>x1</span><span>;</span></p><p><span>		</span><span>height</span><span> </span><span>=</span><span> </span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>y1</span><span>;</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>// Call the trampoline and create the render target.</span></p><p><span>	</span><span>return</span><span> </span><span>_rasterizer_alloc_and_create_render_target_trampoline</span><span>(</span><span>target_index</span><span>,</span><span> </span><span>width</span><span>,</span><span> </span><span>height</span><span>,</span><span> </span><span>unk</span><span>,</span><span> </span><span>z_surface</span><span>)</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>



<p>Running the game with these modifications we can see the water geometry is no longer cutoff, and loading into a map doesn’t show any noticeable rendering issues:</p>



<div><figure><a href="https://icode4.coffee/wp-content/uploads/main_menu_texaccum_fixed.png" target="_blank" rel="noopener"><img loading="lazy" width="720" height="480" src="https://icode4.coffee/wp-content/uploads/main_menu_texaccum_fixed.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/main_menu_texaccum_fixed.png 720w, https://icode4.coffee/wp-content/uploads/main_menu_texaccum_fixed-300x200.png 300w" sizes="(max-width: 720px) 100vw, 720px"></a><figcaption>Main menu with the texaccum layer fixed</figcaption></figure></div>



<p>The game looks okay in 480p but the real goal of this work is to get the game playing decently in 720p, and maybe booting in 1080p, even though it won’t play well at that resolution nor will the Xbox output a 1080p video signal (but I can still take some sweet screenshots!). We still need to fix the missing blue filter on the main menu but in the interest of keeping this post as short as possible I’m going to skip the blue filter fix as it’s not very interesting anyway (spoiler: it was just a simple size check that needed updating). Changing the video settings on my console to 720p and booting the game results in… well it results in the game crashing on startup. The reason? Due to the increased size of the front/back/depth buffers and rasterizer targets we’re out of memory, or at least, out of memory that the game is able to use.</p>



<h2>Part 2: Memory Management and RAM Upgrades</h2>



<p>The original Xbox had two different console types, the retail consoles that consumers would buy with 64MB of RAM, and a development console (or dev kit/debug console) that was used by game developers with 128MB of RAM. The extra RAM on the development console helped developers debug their games and run additional test code during the development process. The motherboard used by both console types is nearly identical with the main difference being the software they run and the additional RAM chips on the dev kit motherboards (they also have a slightly different south bridge for security purposes but that’s not really important here). However, retail motherboards still had the placements for the 4 additional RAM chips and over the years people found that they could solder in the missing RAM chips and run a modified Xbox kernel to give them access to the extra memory. Retail games won’t make any use of that extra memory, but homebrew applications like Xbox Media Center will use it for things like video decoding when watching movies or streaming media. </p>



<p>I’ve neglected to mention that up until this point the only way I was able to get the game to boot with the increased back buffer size is by running it on a console with 128MB of RAM and using an Xbox kernel with support for the additional 64MB of RAM. As-is the game will not utilize any of the additional memory, however, this kernel has additional logic to “force” certain types of memory allocations into the upper 64MB region to make space for allocations that must be in the lower 64MB region. Going into this project I already knew that the only way this game would boot in 720p would be with the RAM upgrade. In fact, the only way to get it to boot in proper 480p resolution without the RAM upgrade was to steal some memory back from the game’s in-memory texture cache which ends up causing additional texture pop-in. But all of this can be fixed by patching the game’s memory allocator to support the additional 64MB of RAM.</p>



<h2>Halo 2’s memory management</h2>



<p>It’s quite common for game developers to write their own memory management system, especially on older hardware where the built-in memory allocator may be slow or even buggy. Developers would use the built-in memory allocator to make a couple large allocations that they’d wrap in their own allocator to chunk it up and dish out as needed. At startup Halo 2 creates one large allocation that uses ~48.9MB of the available 64MB of RAM on the console, basically, every last page of memory they could possibly get once you account for the Xbox kernel and game executable. This region of memory is then chunked up for various subsystems in the game such as level metadata, texture, geometry, animation, and sound caches, rasterizer targets, network and simulation resources, etc. </p>



<p>In order to patch Halo 2’s memory allocator I was going to need a way to visualize memory usage so I could see where things are located and how much space is being used. I spent a few nights working on a tool (<a rel="noreferrer noopener" href="https://github.com/grimdoomer/XboxImageGrabber" data-type="URL" data-id="https://github.com/grimdoomer/XboxImageGrabber" target="_blank">GitHub: XboxImageGrabber</a>) that would walk the page table entries for all the RAM on the console and create a crude bitmap that color codes various chunks of data, allowing me to create a visualization of what memory looks like:</p>



<div><figure><a href="https://icode4.coffee/wp-content/uploads/h2_retail_runtime_data.png" target="_blank" rel="noopener"><img loading="lazy" width="1697" height="1080" src="https://icode4.coffee/wp-content/uploads/h2_retail_runtime_data-1697x1080.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/h2_retail_runtime_data-1697x1080.png 1697w, https://icode4.coffee/wp-content/uploads/h2_retail_runtime_data-300x191.png 300w, https://icode4.coffee/wp-content/uploads/h2_retail_runtime_data-768x489.png 768w, https://icode4.coffee/wp-content/uploads/h2_retail_runtime_data-1536x977.png 1536w, https://icode4.coffee/wp-content/uploads/h2_retail_runtime_data-2048x1303.png 2048w, https://icode4.coffee/wp-content/uploads/h2_retail_runtime_data-110x70.png 110w" sizes="(max-width: 1697px) 100vw, 1697px"></a><figcaption>Memory profile of Halo 2</figcaption></figure></div>



<p>This might look like pixel barf and be hard to interpret but it was really only intended for my own use so I never bothered to make it pretty. The first column on the left shows the memory usage by the Xbox OS. At the very beginning is the Xbox kernel, down in the 0x83000000 region we have the Halo 2 executable and some virtual memory allocations, and at 0x84000000 is the end of the 64MB retail RAM region. This was taken on a console with 128MB of memory so everything after 0x84000000 is the “debug” memory region. The center column shows Halo 2’s memory usage for runtime data and d3d resources. This particular image doesn’t have color coding enabled so you can get an idea of how much memory the game reserves for this runtime data region. That blue blob? That’s the ~49MB allocation the game makes on startup. The column on the right shows combined memory usage, basically what has been allocated and what is free with no further classification for what the memory is used for. We can see that the stock version of the game uses almost every available page of memory it can get, sparing only a few as a safety net.</p>



<div><figure><a href="https://icode4.coffee/wp-content/uploads/h2_retail_memory_profile.png" target="_blank" rel="noopener"><img loading="lazy" width="1697" height="1080" src="https://icode4.coffee/wp-content/uploads/h2_retail_memory_profile-1697x1080.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/h2_retail_memory_profile-1697x1080.png 1697w, https://icode4.coffee/wp-content/uploads/h2_retail_memory_profile-300x191.png 300w, https://icode4.coffee/wp-content/uploads/h2_retail_memory_profile-768x489.png 768w, https://icode4.coffee/wp-content/uploads/h2_retail_memory_profile-1536x977.png 1536w, https://icode4.coffee/wp-content/uploads/h2_retail_memory_profile-2048x1303.png 2048w, https://icode4.coffee/wp-content/uploads/h2_retail_memory_profile-110x70.png 110w" sizes="(max-width: 1697px) 100vw, 1697px"></a><figcaption>Halo 2 memory profile with data classification</figcaption></figure></div>



<p>Here’s the same memory profile image with the runtime data region color coded to show the various subsystem allocations. There’s actually a few more not pictured here but they aren’t too important. The ones we’re concerned with are going to be tag data, texture cache, geometry cache, and rasterizer buffer. The runtime data allocation appearing immediately after the Xbox kernel is not a coincidence, it’s purposefully allocated at a hard coded address of 0x80061000. The “tag data” region is actually all the metadata for every object in a map file in the form of C-structs that have been serialized using the predetermined base address of 0x80061000. The tag data system is designed to be as flexible and performant as possible, and, in my opinion the inner workings are really a feat of engineering. I could write an entire blog post about the inner workings of the tag data system and why I think it makes the Blam engine one of the most flexible engines ever made, but that isn’t relevant to this post. The key takeaway here is that this data needs to always be at the same address or else the game won’t work. But all of the other data in the runtime region can be moved around at will.</p>



<h4>Patching the memory allocator</h4>



<p>The regions we’ll want to move out of the runtime data buffer are the rasterizer targets (at least the ones we’ll be increasing in size), and the texture and geometry caches so we can increase their size to help reduce pop-in issues. We’ll also want to reduce the size of the runtime data buffer to account for the things we’re removing so we don’t waste any memory by not filling it. The patches for the memory allocator will consist of 3 main changes:</p>



<ol><li>Hooking certain allocation calls and moving them to the debug memory region. </li><li>When these allocations are “released” (ex: when loading a new level) we’ll need to call the appropriate free function.</li><li>Adjusting the size of the runtime data region to reclaim memory that’s no longer being used.</li></ol>



<p>I’ve called the memory allocation function we’ll need to hook physical_memory_malloc, and it’s unfortunately inlined by the compiler which means each “call site” for it will need a unique patch, and the same is true for when an allocation is free’d. The pseudo code for the memory allocator patches looks like this:</p>



<div id="urvanov-syntax-highlighter-662143868a302749205471" data-settings=" minimize scroll-mouseover">
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p><p>48</p><p>49</p><p>50</p><p>51</p><p>52</p><p>53</p><p>54</p><p>55</p><p>56</p><p>57</p><p>58</p></div>
				</td>
						<td><div><p><span>struct</span><span> </span><span>physical_memory_alloc_info</span></p><p><span>{</span></p><p><span>	</span><span>const</span><span> </span><span>char</span><span>*</span><span> </span><span>name</span><span>;</span><span>				</span><span>// Name for the allocation, ex: "texture cache"</span></p><p><span>	</span><span>unsigned</span><span> </span><span>int</span><span> </span><span>override_size</span><span>;</span><span>		</span><span>// If non-zero use this size for the allocation</span></p><p><span>	</span><span>void</span><span>*</span><span> </span><span>address</span><span>;</span><span>					</span><span>// Allocation address</span></p><p><span>}</span><span>;</span></p><p><span>// Enum used to index into Hack_PhysicalMemoryRegionInfoTable</span></p><p><span>enum</span></p><p><span>{</span></p><p><span>	</span><span>PHYS_MEM_REGION_RASTERIZER_TEXACCUM_TARGET</span><span>,</span></p><p><span>	</span><span>PHYS_MEM_REGION_GEOMETRY_CACHE</span><span>,</span></p><p><span>	</span><span>PHYS_MEM_REGION_TEXTURE_CACHE</span><span>,</span></p><p><span>}</span><span>;</span></p><p><span>// Global array of tracked allocations:</span></p><p><span>physical_memory_alloc_info </span><span>Hack_PhysicalMemoryRegionInfoTable</span><span>[</span><span>]</span><span> </span><span>=</span></p><p><span>{</span></p><p><span>	</span><span>{</span><span> </span><span>"rasterizer texaccum target"</span><span>,</span><span> 	</span><span>0</span><span>,</span><span> </span><span>NULL</span><span> </span><span>}</span><span>,</span></p><p><span>	</span><span>{</span><span> </span><span>"geometry cache"</span><span>,</span><span> 				</span><span>0</span><span>,</span><span> </span><span>NULL</span><span> </span><span>}</span><span>,</span></p><p><span>	</span><span>{</span><span> </span><span>"texture cache"</span><span>,</span><span> 					</span><span>0</span><span>,</span><span> </span><span>NULL</span><span> </span><span>}</span><span>,</span></p><p><span>}</span><span>;</span></p><p><span>void</span><span>*</span><span> </span><span>Hack_PhysicalMemoryAlloc</span><span>(</span><span>unsigned</span><span> </span><span>int</span><span> </span><span>regionIndex</span><span>,</span><span> </span><span>unsigned</span><span> </span><span>int</span><span> </span><span>size</span><span>,</span><span> </span><span>int</span><span> </span><span>protect</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>// Get a pointer to the allocation info structure.</span></p><p><span>	</span><span>physical_memory_alloc_info</span><span>*</span><span> </span><span>pAllocInfo</span><span> </span><span>=</span><span> </span><span>&amp;</span><span>Hack_PhysicalMemoryRegionInfoTable</span><span>[</span><span>regionIndex</span><span>]</span><span>;</span></p><p><span>	</span><span>// If the override size is specified use it for the allocation.</span></p><p><span>	</span><span>if</span><span> </span><span>(</span><span>pAllocInfo</span><span>-&gt;</span><span>override_size</span><span> </span><span>!=</span><span> </span><span>0</span><span>)</span></p><p><span>		</span><span>size</span><span> </span><span>=</span><span> </span><span>pAllocInfo</span><span>-&gt;</span><span>override_size</span><span>;</span></p><p><span>	</span><span>// Round the size up to the nearest page interval.</span></p><p><span>	</span><span>size</span><span> </span><span>=</span><span> </span><span>(</span><span>size</span><span> </span><span>+</span><span> </span><span>PAGE_SIZE</span><span>-</span><span>1</span><span>)</span><span> </span><span>&amp;</span><span> </span><span>~</span><span>(</span><span>PAGE_SIZE</span><span>-</span><span>1</span><span>)</span><span>;</span></p><p><span>	</span><span>// TODO: Allocate memory from the debug region...</span></p><p><span>	</span><span>pAllocInfo</span><span>-&gt;</span><span>address</span><span> </span><span>=</span><span> </span><span>NULL</span><span>;</span></p><p><span>	</span><span>if</span><span> </span><span>(</span><span>pAllocInfo</span><span>-&gt;</span><span>address</span><span> </span><span>==</span><span> </span><span>NULL</span><span>)</span></p><p><span>		</span><span>DebugBreak</span><span>(</span><span>)</span><span>;</span></p><p><span>	</span><span>// Debug print the allocation info.</span></p><p><span>	</span><span>DbgPrint</span><span>(</span><span>"physical_memory_malloc %s %ld at 0x%08x\n"</span><span>,</span><span> </span><span>pAllocInfo</span><span>-&gt;</span><span>name</span><span>,</span><span> </span><span>size</span><span>,</span><span> </span><span>pAllocInfo</span><span>-&gt;</span><span>address</span><span>)</span><span>;</span></p><p><span>	</span><span>return</span><span> </span><span>pAllocInfo</span><span>-&gt;</span><span>address</span><span>;</span></p><p><span>}</span></p><p><span>void</span><span> </span><span>Hack_PhysicalMemoryFree</span><span>(</span><span>unsigned</span><span> </span><span>int</span><span> </span><span>regionIndex</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>// Get a pointer to the allocation info structure.</span></p><p><span>	</span><span>physical_memory_alloc_info</span><span>*</span><span> </span><span>pAllocInfo</span><span> </span><span>=</span><span> </span><span>&amp;</span><span>Hack_PhysicalMemoryRegionInfoTable</span><span>[</span><span>regionIndex</span><span>]</span><span>;</span></p><p><span>	</span><span>// If the allocation is valid free it.</span></p><p><span>	</span><span>if</span><span> </span><span>(</span><span>pAllocInfo</span><span>-&gt;</span><span>address</span><span> </span><span>!=</span><span> </span><span>NULL</span><span>)</span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>// TODO: Free the allocation...</span></p><p><span>		</span><span>pAllocInfo</span><span>-&gt;</span><span>address</span><span> </span><span>=</span><span> </span><span>NULL</span><span>;</span></p><p><span>	</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>



<p>This allows me to hook individual call sites where the physical_memory_malloc function is inlined using a patch like so:</p>



<div id="urvanov-syntax-highlighter-662143868a307402357472" data-settings=" minimize scroll-mouseover">
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p><span>push</span><span>	</span><span>404h</span><span>								</span><span>; PAGE_WRITECOMBINE | PAGE_READWRITE</span></p><p><span>push</span><span>	</span><span>ecx</span><span>									</span><span>; size, calculated earlier in function</span></p><p><span>push</span><span>	</span><span>PHYS</span><span>_</span><span>MEM</span><span>_</span><span>REGION</span><span>_</span><span>GEOMETRY</span><span>_</span><span>CACHE</span><span>		</span><span>; regionIndex</span></p><p><span>mov</span><span>		</span><span>eax</span><span>,</span><span> </span><span>Hack</span><span>_</span><span>PhysicalMemoryAlloc</span></p><p><span>call</span><span>	</span><span>eax</span><span>									</span><span>; Call our helper function to perform the allocation</span></p><p><span>; Jump over code we no longer need to execute.</span></p><p><span>push</span><span>	</span><span>0012DA73h</span></p><p><span>ret</span></p></div></td>
					</tr>
				</tbody></table>
			</div>



<p>Now you’re probably wondering why the lines that perform the allocation and free calls in the pseudo code above are labeled as “TODO”, and that’s because allocating physical contiguous memory in the debug memory region is problematic… </p>



<h2>Xbox memory architecture</h2>



<p>Earlier I mentioned that the original Xbox uses a unified memory design allowing the CPU and GPU to share the same RAM. When the CPU provides a memory address to the GPU (ex: address of a texture or vertex buffer) it must use a physical memory address and the memory span must be contiguous (meaning the pages backing the allocation are all consecutive with no gaps). This is because the GPU doesn’t have any concept of page tables or virtual memory addresses so it’s unable to translate virtual addresses to perform memory accesses. It simply treats the memory address as an offset from the start of RAM and reads data as needed starting from this offset. There’s specific APIs for allocating “video” or “GPU” memory but these are all wrappers for allocating memory that is physical and contiguous.</p>



<p>The Xbox kernel provides various functions for allocating memory but there’s two main types of memory allocations that can be made. Physical memory which is also contiguous, and virtual memory which is not explicitly contiguous (it can end up being contiguous by chance but it’s virtual memory so it’s not required to be contiguous). On an unmodified retail Xbox console there’s only 64MB of RAM and the entire 64MB region can be used to make physical or virtual allocations. When using a console with 128MB of RAM and kernel with extra RAM support only the first 64MB of RAM can be used for physical allocations, but virtual allocations can be made anywhere in the 128MB region. If you try to make a physical allocation and there’s not enough free contiguous memory in the first 64MB of RAM, the kernel will attempt to relocate virtual allocations into the upper 64MB region to satisfy the allocation request.</p>



<p>This was done on purpose to provide a closer experience to the retail hardware for developers to work with. The additional 64MB of “debug” memory was to allow developers to run extra code and profiling tools that consumed memory without having to take away from the memory their game would normally have. There’s no benefit to allowing developers to allocate more “video” memory in the debug region as it doesn’t exist on retail hardware and can’t be used in a final version of the game. However, this limits me in terms of how much additional memory I can give Halo 2 for video allocations.</p>



<h2>Hot patching the Xbox kernel</h2>



<p>Looking at the memory profile image above we can see the “runtime data region” consumes most of the first 64MB of RAM. Not everything allocated in this region is required to be “video” memory (and thus needs to be in physical memory), so I could move as many things as possible out of that region and into the upper 64MB of RAM as a virtual allocation. But this gets quite messy to track down all of the allocations being made and patch each call site, and it won’t give us as much memory as we really need for additional performance tweaks later on. Rather than go for a sub-par solution I decided to take matters (or memory) into my own hands and try something crazy.</p>



<p>I ran some tests where I made a video memory allocation “by hand” and just stole some unused page table entries for the upper 64MB address space. Instead of asking the kernel to allocate the memory for me, I just “commandeered” the page tables and did it myself. Feeding this address to the GPU for rendering worked just fine which meant that the limitation of only being able to allocate “video” memory in the lower 64MB of RAM is not a hardware limitation it’s a software one. The only thing preventing me from making physical memory allocations in the upper 64MB of RAM is the kernel. After spending a few nights digging through the memory management functions in the Xbox kernel I found the blocker that was preventing me from making physical allocations passed the 64MB mark:</p>



<div><figure><a href="https://icode4.coffee/wp-content/uploads/max_pfn_check-1.png" target="_blank" rel="noopener"><img loading="lazy" width="879" height="516" src="https://icode4.coffee/wp-content/uploads/max_pfn_check-1.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/max_pfn_check-1.png 879w, https://icode4.coffee/wp-content/uploads/max_pfn_check-1-300x176.png 300w, https://icode4.coffee/wp-content/uploads/max_pfn_check-1-768x451.png 768w" sizes="(max-width: 879px) 100vw, 879px"></a><figcaption>Max PFN check in MmAllocateContiguousMemoryEx</figcaption></figure></div>



<p>The MmAllocateContiguousMemoryEx function used to allocate contiguous physical memory takes in two parameters that let the caller specify the lowest and highest acceptable addresses for the memory allocation. This is how Halo 2 gets the runtime data region to always be at the address 0x80061000, by specifying the highest acceptable address as 0x61000 (the upper most bits are masked out). The kernel takes both of these parameters and converts them into page frame numbers (basically an index for the page of memory that corresponds to that address), and checks they’re less than or equal to this constant I called MAX_USABLE_PFN. The MAX_USABLE_PFN constant corresponds to the address 0x83FE0000, which is equal to 64MB – 128KB. What is the significance of this value? The top 128kb of RAM is always reserved with 64KB used as a “scratch” region for the GPU and the other 64KB used for the CPU page tables. I believe the GPU “scratch” region is used for storing data related to depth buffer compression tags and possibly processed vertex data that is still passing through the shader pipeline, but I’ve never actually confirmed this myself.</p>



<p>This check is our blocker for allocating physical memory in the upper 64MB of RAM. I changed this value at runtime after my test application loaded and confirmed I was able to allocate memory in the upper 64MB of RAM using MmAllocateContiguousMemoryEx, and the GPU was able to use that memory just fine. So now all I needed to do is write a function to hot patch the Xbox kernel when the game boots, no big deal right? For this patch I’ll first make sure the console has 128MB of RAM installed, then resolve the address of the MmAllocateContiguousMemoryEx function, search for the “mov edx, 0x3FDF” instruction, and patch it to use a new “MAX_USABLE_PFN” value suitable for 128MB RAM configuration. Here’s the pseudo code for the patch:</p>



<div id="urvanov-syntax-highlighter-662143868a309300802937" data-settings=" minimize scroll-mouseover">
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p></div>
				</td>
						<td><div><p><span>bool</span><span> </span><span>PatchMaxPFN</span><span>(</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>// Search for the max PFN value.</span></p><p><span>	</span><span>BYTE</span><span>*</span><span> </span><span>pPtr</span><span> </span><span>=</span><span> </span><span>(</span><span>BYTE</span><span>*</span><span>)</span><span>pMmAllocateContiguousMemoryEx</span><span>;</span></p><p><span>	</span><span>BYTE</span><span>*</span><span> </span><span>pEndPtr</span><span> </span><span>=</span><span> </span><span>(</span><span>BYTE</span><span>*</span><span>)</span><span>pMmAllocateContiguousMemoryEx</span><span> </span><span>+</span><span> </span><span>0x80</span><span>;</span></p><p><span>	</span><span>while</span><span> </span><span>(</span><span>pPtr</span><span> </span><span>&lt;</span><span> </span><span>pEndPtr</span><span>)</span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>// Check for the max PFN value.</span></p><p><span>		</span><span>if</span><span> </span><span>(</span><span>*</span><span>(</span><span>DWORD</span><span>*</span><span>)</span><span>pPtr</span><span> </span><span>==</span><span> </span><span>0x00003FDF</span><span>)</span></p><p><span>		</span><span>{</span></p><p><span>			</span><span>_asm</span></p><p><span>			</span><span>{</span></p><p><span>				</span><span>// Disable write protect.</span></p><p><span>				</span><span>pushf</span></p><p><span>				</span><span>cli</span><span>							</span><span>// Disable interrupts</span></p><p><span>				</span><span>mov		</span><span>eax</span><span>,</span><span> </span><span>cr0</span><span>			</span><span>// Get the control register value</span></p><p><span>				</span><span>push	</span><span>eax</span><span>					</span><span>// Save it for later</span></p><p><span>				</span><span>and</span><span>		</span><span>eax</span><span>,</span><span> </span><span>0xFFFEFFFF</span><span>		</span><span>// Disable write-protect</span></p><p><span>				</span><span>mov		</span><span>cr0</span><span>,</span><span> </span><span>eax</span></p><p><span>				</span><span>// Update the max PFN to use the 128MB limit value.</span></p><p><span>				</span><span>mov		</span><span>eax</span><span>,</span><span> </span><span>pPtr</span></p><p><span>				</span><span>mov		</span><span>dword </span><span>ptr</span><span> </span><span>[</span><span>eax</span><span>]</span><span>,</span><span> </span><span>0x00007FCF</span></p><p><span>				</span><span>// Re-enable write-protect.</span></p><p><span>				</span><span>pop		</span><span>eax</span></p><p><span>				</span><span>mov		</span><span>cr0</span><span>,</span><span> </span><span>eax</span><span>			</span><span>// Re-enable write-protect</span></p><p><span>				</span><span>popf</span></p><p><span>			</span><span>}</span></p><p><span>			</span><span>return</span><span> </span><span>true</span><span>;</span></p><p><span>		</span><span>}</span></p><p><span>		</span><span>// Next round.</span></p><p><span>		</span><span>pPtr</span><span>++</span><span>;</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>// Failed to patch max PFN value.</span></p><p><span>	</span><span>return</span><span> </span><span>false</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>



<p>Now that the memory allocation problems are solved we can fill in the two missing lines from the Hack_PhysicalMemoryAlloc/Hack_PhysicalMemoryFree functions above to use MmAllocateContiguousMemoryEx and MmFreeContiguousMemory. Once we hot patch the kernel we can call MmAllocateContiguousMemoryEx using a lowest acceptable address of 0 and highest acceptable address of 0xFFFFFFFF (which the function will override with our new MAX_USABLE_PFN value). The kernel will walk the page tables in reverse starting from the highest acceptable page number and search for a span of free pages large enough to satisfy the allocation request. This will guarantee the upper 64MB of RAM will take preference during allocation but allows using any available space in all 128MB of RAM to satisfy the request.</p>



<div id="urvanov-syntax-highlighter-662143868a30c283487506" data-settings=" minimize scroll-mouseover">
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p></div>
				</td>
						<td><div><p><span>void</span><span>*</span><span> </span><span>Hack_PhysicalMemoryAlloc</span><span>(</span><span>unsigned</span><span> </span><span>int</span><span> </span><span>regionIndex</span><span>,</span><span> </span><span>unsigned</span><span> </span><span>int</span><span> </span><span>size</span><span>,</span><span> </span><span>int</span><span> </span><span>protect</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>// Get a pointer to the allocation info structure.</span></p><p><span>	</span><span>physical_memory_alloc_info</span><span>*</span><span> </span><span>pAllocInfo</span><span> </span><span>=</span><span> </span><span>&amp;</span><span>Hack_PhysicalMemoryRegionInfoTable</span><span>[</span><span>regionIndex</span><span>]</span><span>;</span></p><p><span>	</span><span>// If the override size is specified use it for the allocation.</span></p><p><span>	</span><span>if</span><span> </span><span>(</span><span>pAllocInfo</span><span>-&gt;</span><span>override_size</span><span> </span><span>!=</span><span> </span><span>0</span><span>)</span></p><p><span>		</span><span>size</span><span> </span><span>=</span><span> </span><span>pAllocInfo</span><span>-&gt;</span><span>override_size</span><span>;</span></p><p><span>	</span><span>// Round the size up to the nearest page interval.</span></p><p><span>	</span><span>size</span><span> </span><span>=</span><span> </span><span>(</span><span>size</span><span> </span><span>+</span><span> </span><span>PAGE_SIZE</span><span>-</span><span>1</span><span>)</span><span> </span><span>&amp;</span><span> </span><span>~</span><span>(</span><span>PAGE_SIZE</span><span>-</span><span>1</span><span>)</span><span>;</span></p><p><span>	</span><span>// Allocate physical contiguous memory (using the entire 128MB address space).</span></p><p><span>	</span><span>pAllocInfo</span><span>-&gt;</span><span>address</span><span> </span><span>=</span><span> </span><span>MmAllocateContiguousMemoryEx</span><span>(</span><span>size</span><span>,</span><span> </span><span>/* LowestAcceptableAddress */</span><span> </span><span>0</span><span>,</span><span> </span><span>/* HighestAcceptableAddress */</span><span> </span><span>0xFFFFFFFF</span><span>,</span><span> </span><span>/* Alignment */</span><span> </span><span>PAGE_SIZE</span><span>,</span><span> </span><span>/* PageAccess */</span><span> </span><span>protect</span><span>)</span><span>;</span></p><p><span>	</span><span>if</span><span> </span><span>(</span><span>pAllocInfo</span><span>-&gt;</span><span>address</span><span> </span><span>==</span><span> </span><span>NULL</span><span>)</span></p><p><span>		</span><span>DebugBreak</span><span>(</span><span>)</span><span>;</span></p><p><span>	</span><span>// Debug print the allocation info.</span></p><p><span>	</span><span>DbgPrint</span><span>(</span><span>"physical_memory_malloc %s %ld at 0x%08x\n"</span><span>,</span><span> </span><span>pAllocInfo</span><span>-&gt;</span><span>name</span><span>,</span><span> </span><span>size</span><span>,</span><span> </span><span>pAllocInfo</span><span>-&gt;</span><span>address</span><span>)</span><span>;</span></p><p><span>	</span><span>return</span><span> </span><span>pAllocInfo</span><span>-&gt;</span><span>address</span><span>;</span></p><p><span>}</span></p><p><span>void</span><span> </span><span>Hack_PhysicalMemoryFree</span><span>(</span><span>unsigned</span><span> </span><span>int</span><span> </span><span>regionIndex</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>// Get a pointer to the allocation info structure.</span></p><p><span>	</span><span>physical_memory_alloc_info</span><span>*</span><span> </span><span>pAllocInfo</span><span> </span><span>=</span><span> </span><span>&amp;</span><span>Hack_PhysicalMemoryRegionInfoTable</span><span>[</span><span>regionIndex</span><span>]</span><span>;</span></p><p><span>	</span><span>// If the allocation is valid free it.</span></p><p><span>	</span><span>if</span><span> </span><span>(</span><span>pAllocInfo</span><span>-&gt;</span><span>address</span><span> </span><span>!=</span><span> </span><span>NULL</span><span>)</span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>// Free the allocation.</span></p><p><span>		</span><span>MmFreeContiguousMemory</span><span>(</span><span>pAllocInfo</span><span>-&gt;</span><span>address</span><span>)</span><span>;</span></p><p><span>		</span><span>pAllocInfo</span><span>-&gt;</span><span>address</span><span> </span><span>=</span><span> </span><span>NULL</span><span>;</span></p><p><span>	</span><span>}</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>



<h4>Visualizing the results</h4>



<p>That was a lot of work but the results are well worth it. As I mentioned earlier the only way to get the game to run in 720p or higher is with a RAM upgrade. Even running the game in proper 480p on a console without the RAM upgrade requires stealing memory back from the game to offset the additional memory requirements, which exacerbates the texture pop-in issues that are prevalent even in the game’s unmodified form. I’ve rambled on about memory management enough, here’s what the game looks like in 720p:</p>



<div><figure><a href="https://icode4.coffee/wp-content/uploads/halo_2_720p.png" target="_blank" rel="noopener"><img loading="lazy" width="1280" height="720" src="https://icode4.coffee/wp-content/uploads/halo_2_720p.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/halo_2_720p.png 1280w, https://icode4.coffee/wp-content/uploads/halo_2_720p-300x169.png 300w, https://icode4.coffee/wp-content/uploads/halo_2_720p-768x432.png 768w" sizes="(max-width: 1280px) 100vw, 1280px"></a><figcaption>Zanzibar beach in 720p</figcaption></figure></div>



<p>It looks great! But it doesn’t play great… The FPS is noticeably lower to the point where it’s dipping to 10 FPS or lower in heavy scenes. While I was expecting a performance hit I wasn’t expecting it to be this bad, but that’s okay because there’s things we can do to improve this quite a bit. Before that, lets give 1080p a try and see what it looks like. Remember that while the game is rendering natively in 1080p the Xbox console is only able to output a 1080i video signal. However, by dumping the D3D back buffer directly I’m able to get a proper 1080p screenshot before the GPU converts it into half frames for the video encoder to display on screen:</p>



<div><figure><a href="https://icode4.coffee/wp-content/uploads/1080p_zanzibar.png" target="_blank" rel="noopener"><img loading="lazy" width="1920" height="1080" src="https://icode4.coffee/wp-content/uploads/1080p_zanzibar-1920x1080.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/1080p_zanzibar.png 1920w, https://icode4.coffee/wp-content/uploads/1080p_zanzibar-300x169.png 300w, https://icode4.coffee/wp-content/uploads/1080p_zanzibar-768x432.png 768w, https://icode4.coffee/wp-content/uploads/1080p_zanzibar-1536x864.png 1536w" sizes="(max-width: 1920px) 100vw, 1920px"></a><figcaption>Zanzibar beach in 1080p</figcaption></figure></div>



<h4>Unforeseen consequences</h4>



<p>Okay so this kernel hot patching does have some undesirable side effects which is understandable since I just changed a pretty crucial aspect of how memory management works mid-execution. Hot patching the kernel and letting Halo 2 run works fine until you exit the game without cold rebooting the console. If you do a warm reboot (returning to the dashboard, ejecting the dvd tray, etc) the console is basically “hosed” and the next application/game to run will have severe graphical artifacting, and the console will most likely crash shortly after. This is likely because there’s more changes required to expand the physical memory region outside of the single change I made. I have some theories as to what the remaining issues are but having spent a significant amount of time on memory management patches I decided to take the cop out solution here. To make this more “robust” I added additional patches that would cold reboot the console (which reloads the kernel) whenever you exit the game so all of the side effects of this hot patching are hidden from the end user. This would prove useful later on as there’s additional changes I make that really should be reset after exiting the game and cold rebooting the console solves all of this.</p>



<h2>Part 3: Performance Improvements and Overclocking</h2>



<p>Now that the game is rendering in 720p and 1080p it’s time to address the performance issues and make it playable, at least in 720p. Adding 1080p support is really just a bonus to get nice screenshots and I have no expectations that the console will be able to run the game at that resolution and be “playable”, regardless of what performance improvements I can make. The first step was to get some baseline performance measurements on a stock Xbox console and the god box that doom sent me. The god box also had two different BIOS images, one that overclocked just the CPU, and one that overclocked both CPU and GPU. This would let me get three different measurements: one for stock hardware (no overclocking), one for CPU overclocking, and one for CPU + GPU overclocking. From these measurements I could determine where the performance bottlenecks were and start from there.</p>



<p>I found a particularly heavy area on Zanzibar that I’ll refer to as the “zanzibar benchmark scene”, which was a decent test case for performance benchmarks. While collecting the performance measurements I immediately realized that the FPS between all three setups was almost identical when under heavy load which was extremely suspicious. If overclocking the CPU and GPU show no improvement in performance then the bottleneck was certainly elsewhere. My first thought was I might be maxing the memory bandwidth now that the GPU has a lot more pixel calculations to do and thus a lot more memory to read and write. However, after spending a few nights running tests and bouncing ideas off doom I realized I’d overlooked something very obvious while staring at a performance graph.</p>



<div><figure><a href="https://icode4.coffee/wp-content/uploads/stock_perf_double_buffer-2.png" target="_blank" rel="noopener"><img loading="lazy" width="1920" height="961" src="https://icode4.coffee/wp-content/uploads/stock_perf_double_buffer-2-1920x961.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/stock_perf_double_buffer-2-1920x961.png 1920w, https://icode4.coffee/wp-content/uploads/stock_perf_double_buffer-2-300x150.png 300w, https://icode4.coffee/wp-content/uploads/stock_perf_double_buffer-2-768x384.png 768w, https://icode4.coffee/wp-content/uploads/stock_perf_double_buffer-2-1536x769.png 1536w, https://icode4.coffee/wp-content/uploads/stock_perf_double_buffer-2-2048x1025.png 2048w" sizes="(max-width: 1920px) 100vw, 1920px"></a><figcaption>Performance graph for stock console at 720p (double buffered)</figcaption></figure></div>



<p>This graph shows GPU use (yellow), CPU use (red), frames per second (blue), and swap stall rate (teal). Initially I didn’t know what “swap stall” was and I couldn’t find any documentation about it in the Xbox SDK docs. But after I realized the game was running with vsync on it made perfect sense, swap stall = swap chain stall, the GPU was stalling because the swap chain was full and vsync was on.</p>



<h4>VSync and swap chains</h4>



<p>Halo 2 runs with vsync on and uses double buffering so it only has 2 buffers in the swap chain (one front buffer and one back buffer). The back buffer is used by the GPU to render the current frame while the front buffer is the previous frame that was rendered and is now being displayed on screen. When the GPU finishes drawing the current frame it needs to swap the back and front buffers (or rotate the swap chain) so the newly completed frame can be drawn on screen and the old one can be used by the GPU for the next frame. But when vsync is on the GPU can only rotate the swap chain at the start of a vertical blanking (vblank) period (when the TV retraces to the top and starts drawing the image from the beginning). If you turn vsync off the GPU can rotate the swap chain at any time, but if the front buffer is only partially displayed on screen when you rotate the swap chain it’ll result in a “tearing” effect on screen (hence why you want vsync on as it prevents this).</p>



<p>The swap stall line in the graph above is the rate at which the GPU had to stall and wait for a vblank period in order to rotate the swap chain. Basically, the GPU isn’t able to render frames fast enough to keep up with the refresh rate of the screen and it ends up having to wait until the next screen refresh to rotate the swap chain. In hindsight this seems so obvious but at the time I was preoccupied with all the hardware modifications I completely forgot about vsync.</p>



<h2>From double to triple buffering</h2>



<p>This is relative easy to fix as we can just increase the number of buffers in the swap chain to 3 which allows us to queue a completed frame and immediately begin processing the next frame, even if the GPU needs to wait for the next vblank before rotating the swap chain. Here’s the updated pseudo code for the rasterizer_device_initialize hook:</p>



<div id="urvanov-syntax-highlighter-662143868a30f384347295" data-settings=" minimize scroll-mouseover">
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p></div>
				</td>
						<td><div><p><span>bool</span><span> </span><span>rasterizer_device_initialize</span><span>(</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>.</span><span>.</span><span>.</span></p><p><span>	</span><span>D3DPRESENT_PARAMETERS </span><span>PresentParams</span><span> </span><span>=</span><span> </span><span>{</span><span>0</span><span>}</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>BackBufferWidth</span><span> </span><span>=</span><span> </span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>x1</span><span> </span><span>-</span><span> </span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>x0</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>BackBufferHeight</span><span> </span><span>=</span><span> </span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>y1</span><span> </span><span>-</span><span> </span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>y1</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>BackBufferFormat</span><span> </span><span>=</span><span> </span><span>D3DFMT_A8R8G8B8</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>EnableAutoDepthStencil</span><span> </span><span>=</span><span> </span><span>TRUE</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>AutoDepthStencilFormat</span><span> </span><span>=</span><span> </span><span>D3DFMT_D24S8</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>Flags</span><span> </span><span>=</span><span> </span><span>D3DPRESENTFLAG_LOCKABLE_BACKBUFFER</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>FullScreen_RefreshRateInHz</span><span> </span><span>=</span><span> </span><span>g_refresh_rate_hz</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>FullScreen_PresentationInterval</span><span> </span><span>=</span><span> </span><span>D3DPRESENT_INTERVAL_IMMEDIATE</span><span>;</span></p><p><span>	</span><span>.</span><span>.</span><span>.</span></p><p><span>	</span><span>// Setup back buffer count and swap effect for triple buffering.</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>BackBufferCount</span><span> </span><span>=</span><span> </span><span>2</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>SwapEffect</span><span> </span><span>=</span><span> </span><span>D3DSWAPEFFECT_DISCARD</span><span>;</span></p><p><span>	</span><span>PresentParams</span><span>.</span><span>PresentationInterval</span><span> </span><span>=</span><span> </span><span>D3DPRESENT_INTERVAL_ONE</span><span>;</span></p><p><span>	</span><span>// Check if wide screen mode is enabled.</span></p><p><span>	</span><span>if</span><span> </span><span>(</span><span>g_widescreen_enabled</span><span> </span><span>!=</span><span> </span><span>0</span><span>)</span></p><p><span>		</span><span>PresentParams</span><span>.</span><span>Flags</span><span> </span><span>|=</span><span> </span><span>D3DPRESENTFLAG_WIDESCREEN</span><span>;</span></p><p><span>	</span><span>// Check if the video mode supports progressive scan.</span></p><p><span>	</span><span>if</span><span> </span><span>(</span><span>g_progressive_scan_enabled</span><span> </span><span>!=</span><span> </span><span>0</span><span>)</span></p><p><span>		</span><span>PresentParams</span><span>.</span><span>Flags</span><span> </span><span>|=</span><span> </span><span>D3DPRESENTFLAG_PROGRESSIVE</span><span>;</span></p><p><span>	</span><span>// Check the resolution width to see if 1080i is enabled.</span></p><p><span>	</span><span>if</span><span> </span><span>(</span><span>rasterizer_globals</span><span>.</span><span>screen_bounds</span><span>.</span><span>x1</span><span> </span><span>==</span><span> </span><span>1920</span><span>)</span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>PresentParams</span><span>.</span><span>Flags</span><span> </span><span>&amp;=</span><span> </span><span>~</span><span>D3DPRESENTFLAG_PROGRESSIVE</span><span>;</span></p><p><span>		</span><span>PresentParams</span><span>.</span><span>Flags</span><span> </span><span>|=</span><span> </span><span>D3DPRESENTFLAG_INTERLACED</span><span>;</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>g_pDirect3D</span><span>-&gt;</span><span>CreateDevice</span><span>(</span><span>0</span><span>,</span><span> </span><span>D3DDEVTYPE_HAL</span><span>,</span><span> </span><span>NULL</span><span>,</span><span> </span><span>D3DCREATE_HARDWARE_VERTEXPROCESSING</span><span>,</span><span> </span><span>&amp;</span><span>PresentParams</span><span>,</span><span> </span><span>&amp;</span><span>g_pD3DDevice</span><span>)</span><span>;</span></p><p><span>	</span><span>.</span><span>.</span><span>.</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>



<p>Here I’ve increased the back buffer count to 2 (default is 1), and set the swap effect such that the swap chain will be rotated on each present call. This will give us 3 buffers to work with (2 back and 1 front), but we’ll need to make another modification to the game’s rendering engine to account for this additional buffer. Earlier when I was going through the process of resizing the game’s render targets I showed some code for how the game sets up texture views for the back and front buffers for use in rendering passes:</p>



<div id="urvanov-syntax-highlighter-662143868a312449942468" data-settings=" minimize scroll-mouseover">
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p></div>
				</td>
						<td><div><p><span>bool</span><span> </span><span>rasterizer_primary_targets_initialize</span><span>(</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>// Get the back buffer, front buffer, and depth buffer surfaces.</span></p><p><span>	</span><span>global_d3d_device</span><span>-&gt;</span><span>GetBackBuffer</span><span>(</span><span>0</span><span>,</span><span> </span><span>D3DBACKBUFFER_TYPE_MONO</span><span>,</span><span> </span><span>&amp;</span><span>global_d3d_surface_render_primary</span><span>[</span><span>0</span><span>]</span><span>)</span><span>;</span></p><p><span>	</span><span>global_d3d_device</span><span>-&gt;</span><span>GetBackBuffer</span><span>(</span><span>-</span><span>1</span><span>,</span><span> </span><span>D3DBACKBUFFER_TYPE_MONO</span><span>,</span><span> </span><span>&amp;</span><span>global_d3d_surface_render_primary</span><span>[</span><span>1</span><span>]</span><span>)</span><span>;</span></p><p><span>	</span><span>global_d3d_device</span><span>-&gt;</span><span>GetDepthStencilSurface</span><span>(</span><span>&amp;</span><span>global_d3d_surface_render_primary_z</span><span>)</span><span>;</span></p><p><span>	</span><span>.</span><span>.</span><span>.</span></p><p><span>	</span><span>global_d3d_texture_render_primary</span><span>[</span><span>0</span><span>]</span><span> </span><span>=</span><span> </span><span>(</span><span>IDirect3DTexture8</span><span>*</span><span>)</span><span>malloc</span><span>(</span><span>sizeof</span><span>(</span><span>IDirect3DTexture8</span><span>)</span><span>)</span><span>;</span></p><p><span>	</span><span>global_d3d_texture_render_primary</span><span>[</span><span>1</span><span>]</span><span> </span><span>=</span><span> </span><span>(</span><span>IDirect3DTexture8</span><span>*</span><span>)</span><span>malloc</span><span>(</span><span>sizeof</span><span>(</span><span>IDirect3DTexture8</span><span>)</span><span>)</span><span>;</span></p><p><span>	</span><span>// Setup texture views for back/front buffers.</span></p><p><span>	</span><span>for</span><span> </span><span>(</span><span>int</span><span> </span><span>i</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span><span> </span><span>i</span><span> </span><span>&lt;</span><span> </span><span>2</span><span>;</span><span> </span><span>i</span><span>++</span><span>)</span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>XGSetTextureHeader</span><span>(</span><span>640</span><span>,</span><span> </span><span>480</span><span>,</span><span> </span><span>1</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span><span>D3DFMT_LIN_A8R8G8B8</span><span>,</span><span> </span><span>0</span><span>,</span><span> </span></p><p><span>			</span><span>global_d3d_texture_render_primary</span><span>[</span><span>i</span><span>]</span><span>,</span><span> </span><span>global_d3d_surface_render_primary</span><span>[</span><span>i</span><span>]</span><span>-&gt;</span><span>Data</span><span>,</span><span> </span><span>0</span><span>)</span><span>;</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>.</span><span>.</span><span>.</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>



<p>Each frame after the game calls Present() it’ll swap the Data field in global_d3d_surface_render_primary[0]/[1] and global_d3d_texture_render_primary[0]/[1] so they point to the correct memory for the new back and front buffers. This works fine when the game is double buffered but now that we introduced a third buffer into the swap chain we’ll need to account for this after the game calls Present(). We’ll also need to update the rasterizer_primary_targets_initialize hook from earlier to initialize these buffers correctly before the first frame is drawn. Here is the pseudo code for these functions:</p>



<div id="urvanov-syntax-highlighter-662143868a315969332592" data-settings=" minimize scroll-mouseover">
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p><p>33</p><p>34</p><p>35</p><p>36</p><p>37</p><p>38</p><p>39</p><p>40</p><p>41</p><p>42</p><p>43</p><p>44</p><p>45</p><p>46</p><p>47</p></div>
				</td>
						<td><div><p><span>void</span><span> </span><span>Hook_IDirect3DDevice8_Swap</span><span>(</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>// Call the trampoline and let the real function run.</span></p><p><span>	</span><span>IDirect3DDevice8_Swap_trampoline</span><span>(</span><span>)</span><span>;</span></p><p><span>	</span><span>// Check if triple buffering is enable.</span></p><p><span>	</span><span>if</span><span> </span><span>(</span><span>Hack_TripleBufferingEnabled</span><span> </span><span>==</span><span> </span><span>false</span><span>)</span></p><p><span>		</span><span>return</span><span>;</span></p><p><span>	</span><span>// Release references to the old back buffer.</span></p><p><span>	</span><span>global_d3d_surface_render_primary</span><span>[</span><span>0</span><span>]</span><span>-&gt;</span><span>Release</span><span>(</span><span>)</span><span>;</span></p><p><span>	</span><span>global_d3d_surface_render_primary</span><span>[</span><span>1</span><span>]</span><span>-&gt;</span><span>Release</span><span>(</span><span>)</span><span>;</span></p><p><span>	</span><span>// Get the new back buffer and increment the reference count twice.</span></p><p><span>	</span><span>global_d3d_device</span><span>-&gt;</span><span>GetBackBuffer</span><span>(</span><span>0</span><span>,</span><span> </span><span>D3DBACKBUFFER_TYPE_MONO</span><span>,</span><span> </span><span>&amp;</span><span>global_d3d_surface_render_primary</span><span>[</span><span>0</span><span>]</span><span>)</span><span>;</span></p><p><span>	</span><span>global_d3d_device</span><span>-&gt;</span><span>GetBackBuffer</span><span>(</span><span>0</span><span>,</span><span> </span><span>D3DBACKBUFFER_TYPE_MONO</span><span>,</span><span> </span><span>&amp;</span><span>global_d3d_surface_render_primary</span><span>[</span><span>1</span><span>]</span><span>)</span><span>;</span></p><p><span>	</span><span>// Update the Data field for the back buffer textures.</span></p><p><span>	</span><span>global_d3d_texture_render_primary</span><span>[</span><span>0</span><span>]</span><span>-&gt;</span><span>Data</span><span> </span><span>=</span><span> </span><span>global_d3d_surface_render_primary</span><span>[</span><span>0</span><span>]</span><span>-&gt;</span><span>Data</span><span>;</span></p><p><span>	</span><span>global_d3d_texture_render_primary</span><span>[</span><span>1</span><span>]</span><span>-&gt;</span><span>Data</span><span> </span><span>=</span><span> </span><span>global_d3d_surface_render_primary</span><span>[</span><span>0</span><span>]</span><span>-&gt;</span><span>Data</span><span>;</span></p><p><span>}</span></p><p><span>bool</span><span> </span><span>Hook_rasterizer_primary_targets_initialize</span><span>(</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>// Call the trampoline and let the real function complete.</span></p><p><span>	</span><span>bool</span><span> </span><span>result</span><span> </span><span>=</span><span> </span><span>rasterizer_primary_targets_initialize_trampoline</span><span>(</span><span>)</span><span>;</span></p><p><span>	</span><span>// Check if triple buffering is enabled.</span></p><p><span>	</span><span>if</span><span> </span><span>(</span><span>Hack_TripleBufferingEnabled</span><span> </span><span>!=</span><span> </span><span>true</span><span>)</span></p><p><span>	</span><span>{</span></p><p><span>		</span><span>// Set both primary render surfaces to point to the active back buffer.</span></p><p><span>		</span><span>global_d3d_device</span><span>-&gt;</span><span>GetBackBuffer</span><span>(</span><span>0</span><span>,</span><span> </span><span>D3DBACKBUFFER_TYPE_MONO</span><span>,</span><span> </span><span>&amp;</span><span>global_d3d_surface_render_primary</span><span>[</span><span>0</span><span>]</span><span>)</span><span>;</span></p><p><span>		</span><span>global_d3d_device</span><span>-&gt;</span><span>GetBackBuffer</span><span>(</span><span>0</span><span>,</span><span> </span><span>D3DBACKBUFFER_TYPE_MONO</span><span>,</span><span> </span><span>&amp;</span><span>global_d3d_surface_render_primary</span><span>[</span><span>1</span><span>]</span><span>)</span><span>;</span></p><p><span>		</span><span>// Update the Data field for the back buffer textures.</span></p><p><span>		</span><span>global_d3d_texture_render_primary</span><span>[</span><span>0</span><span>]</span><span>-&gt;</span><span>Data</span><span> </span><span>=</span><span> </span><span>global_d3d_surface_render_primary</span><span>[</span><span>0</span><span>]</span><span>-&gt;</span><span>Data</span><span>;</span></p><p><span>		</span><span>global_d3d_texture_render_primary</span><span>[</span><span>1</span><span>]</span><span>-&gt;</span><span>Data</span><span> </span><span>=</span><span> </span><span>global_d3d_surface_render_primary</span><span>[</span><span>0</span><span>]</span><span>-&gt;</span><span>Data</span><span>;</span></p><p><span>	</span><span>}</span></p><p><span>	</span><span>// Update the dimensions of the surface/textures created to match the resolution of the back buffer.</span></p><p><span>	</span><span>Hack_UpdateD3dPixelContainerForScreenResolution</span><span>(</span><span>global_d3d_texture_render_primary</span><span>[</span><span>0</span><span>]</span><span>)</span><span>;</span></p><p><span>	</span><span>Hack_UpdateD3dPixelContainerForScreenResolution</span><span>(</span><span>global_d3d_texture_render_primary</span><span>[</span><span>1</span><span>]</span><span>)</span><span>;</span></p><p><span>	</span><span>Hack_UpdateD3dPixelContainerForScreenResolution</span><span>(</span><span>global_d3d_texture_z_as_target</span><span>[</span><span>0</span><span>]</span><span>)</span><span>;</span></p><p><span>	</span><span>Hack_UpdateD3dPixelContainerForScreenResolution</span><span>(</span><span>global_d3d_texture_z_as_target</span><span>[</span><span>1</span><span>]</span><span>)</span><span>;</span></p><p><span>	</span><span>return</span><span> </span><span>result</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>



<p>With this change global_d3d_surface_render_primary[0]/[1] and global_d3d_texture_render_primary[0]/[1] will always reference the current back buffer. After the Swap hook returns the game will still swap global_d3d_surface_render_primary[0]/[1] and global_d3d_texture_render_primary[0]/[1] internally but this is basically a no-op since they point to the same underlying memory. Now, you might be thinking global_d3d_surface_render_primary[1] is supposed to point to the front buffer per the game’s original implementation, so what happens now that global_d3d_surface_render_primary[1] always points to the back buffer? And the answer, is nothing. The game never used the front buffer because it can’t do anything meaningful with it while it’s being drawn to screen. It only held the pointer so it could swap the surfaces every frame. With these changes in place I loaded up the Zanzibar benchmark scene and collected some new performance measurements:</p>



<figure><a href="https://icode4.coffee/wp-content/uploads/stock_perf_triple_buffer-1.png" target="_blank" rel="noopener"><img loading="lazy" width="1920" height="962" src="https://icode4.coffee/wp-content/uploads/stock_perf_triple_buffer-1-1920x962.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/stock_perf_triple_buffer-1-1920x962.png 1920w, https://icode4.coffee/wp-content/uploads/stock_perf_triple_buffer-1-300x150.png 300w, https://icode4.coffee/wp-content/uploads/stock_perf_triple_buffer-1-768x385.png 768w, https://icode4.coffee/wp-content/uploads/stock_perf_triple_buffer-1-1536x769.png 1536w, https://icode4.coffee/wp-content/uploads/stock_perf_triple_buffer-1-2048x1026.png 2048w" sizes="(max-width: 1920px) 100vw, 1920px"></a><figcaption>Performance graph for stock console at 720p (triple buffered)</figcaption></figure>



<p>As we can see the swap stall line is gone and the FPS is sitting at ~22 which is +~3 FPS higher than before. You might be thinking that a 3 FPS increase isn’t really much but when the game is capped at 30 FPS this is actually a 10% increase which is pretty nice. Also remember that the main goal here was to eliminate the swap stall which prevented the GPU from running as fast as it could. Looking at the graph some more we can see the GPU is now maxed! This might seem bad but we now know the GPU is the bottleneck. We’re still running on stock GPU clock speed and once we overclock the GPU the performance should increase quite a bit.</p>



<h2>Overclocking the GPU</h2>



<p>I spent a few nights digging through some PIX traces, running tests, and trying to find any other low hanging fruit for cheap performance gains. I was able to get another +1-2 FPS by tiling the texaccum render target but it seemed like that was all I was going to get for cheap gains. There’s one or two ideas I had that might get some performance increase but they required a decent amount of changes and I wasn’t sure if the end result would even get me a 1 FPS increase, so I decided to leave it alone and maybe loop back on it another day. With the changes to tile the texaccum render target the Zanzibar benchmark scene was sitting at 23-24 FPS which was a solid improvement over the original ~19 FPS. Now it was time to turn to overclocking, and running the Zanzibar benchmark scene on the god box with overclocked GPU gave a solid 27-28 FPS. Running around the map felt smooth and the FPS was typically holding at a steady 30 FPS, though there were still some areas (like the benchmark scene) where the FPS would drop. Overall I considered it to be highly playable and was relatively satisfied with the results. </p>



<p>The only problem is that the god box is running a one-off bespoke BIOS image that doom made for it. While the GPU overclocking settings could be patched into other community BIOS images it wouldn’t be great if the requirement to run this HD patch was “patch your BIOS image and reflash it to your console”. Luckily I wouldn’t have to resort to that because the GPU clock generator can be controlled entirely by memory mapped IO registers. Using these registers you can control the coefficients for the clock generator and change the clock speed on the fly. So for this next patch I’m going to have the game dynamically overclock the GPU on startup.</p>



<h4>Adjusting the clock speed</h4>



<p>The clock signal for the GPU is calculated as follows:</p>



<div id="urvanov-syntax-highlighter-662143868a319551302372" data-settings=" minimize scroll-mouseover">
				<table>
					<tbody><tr>
				<td data-settings="show">
					
				</td>
						<td><div><p>NVPLL_COEFF (32 bits):</p><p>	Bits 0-7: M</p><p>	Bits 8-15: N</p><p>	Bits 16-18: P</p><p>BASE_CLK = 16.6667 Mhz</p><p>nvclk = (N * BASE_CLK / (1 &lt;&lt; P) / M)</p></div></td>
					</tr>
				</tbody></table>
			</div>



<p>The M and P values are set to 1 by default, and BASE_CLK is always 16.6667 Mhz which is sourced from a crystal on the motherboard. So the formula can be shortened to: (N * 16.6667) / 2. We’ll be modifying the N component which is set to 28 by default for a GPU clock speed of 233.33 Mhz. This will let us step the clock speed in increments of ~8 Mhz which I made configurable via an ini file that the patch loads on startup. The pseudo code for overclocking the GPU looks like this:</p>



<div id="urvanov-syntax-highlighter-662143868a31c754659487" data-settings=" minimize scroll-mouseover">
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p></div>
				</td>
						<td><div><p><span>void</span><span> </span><span>Util_OverclockGPU</span><span>(</span><span>int</span><span> </span><span>step</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>/*</span></p><p><span>		NVPLL_COEFF (32 bits):</span></p><p><span>			Bits 0-7: M</span></p><p><span>			Bits 8-15: N</span></p><p><span>			Bits 16-18: P</span></p><p><span>		BASE_CLK = 16.6667 Mhz</span></p><p><span>		nvclk = (N * BASE_CLK / (1 &lt;&lt; P) / M)</span></p><p><span>	*/</span></p><p><span>	</span><span>// Read the current clock config from the NVPLL_COEFF register.</span></p><p><span>	</span><span>DWORD </span><span>clockConfig</span><span> </span><span>=</span><span> </span><span>*</span><span>(</span><span>DWORD</span><span>*</span><span>)</span><span>(</span><span>NV_GPU_BASE_ADDRESS</span><span> </span><span>+</span><span> </span><span>NVPLL_COEFF</span><span>)</span><span>;</span></p><p><span>	</span><span>// Mask out the old N value.</span></p><p><span>	</span><span>clockConfig</span><span> </span><span>&amp;=</span><span> </span><span>~</span><span>0xFF00</span><span>;</span></p><p><span>	</span><span>// Mask in the new N value.</span></p><p><span>	</span><span>clockConfig</span><span> </span><span>|=</span><span> </span><span>(</span><span>(</span><span>step</span><span> </span><span>&amp;</span><span> </span><span>0xFF</span><span>)</span><span> </span><span>&lt;&lt;</span><span> </span><span>8</span><span>)</span><span>;</span></p><p><span>	</span><span>// Write the new NVPLL_COEFF value.</span></p><p><span>	</span><span>*</span><span>(</span><span>DWORD</span><span>*</span><span>)</span><span>(</span><span>NV_GPU_BASE_ADDRESS</span><span> </span><span>+</span><span> </span><span>NVPLL_COEFF</span><span>)</span><span> </span><span>=</span><span> </span><span>clockConfig</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>



<p>That’s it, the GPU is now overclocked. Kind of lack luster I know, but you’re probably wondering how far can we overclock the GPU? And what does the new performance graph look like?</p>



<div><figure><a href="https://icode4.coffee/wp-content/uploads/oc_perf_triple_buffer.png" target="_blank" rel="noopener"><img loading="lazy" width="1920" height="961" src="https://icode4.coffee/wp-content/uploads/oc_perf_triple_buffer-1920x961.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/oc_perf_triple_buffer-1920x961.png 1920w, https://icode4.coffee/wp-content/uploads/oc_perf_triple_buffer-300x150.png 300w, https://icode4.coffee/wp-content/uploads/oc_perf_triple_buffer-768x384.png 768w, https://icode4.coffee/wp-content/uploads/oc_perf_triple_buffer-1536x769.png 1536w, https://icode4.coffee/wp-content/uploads/oc_perf_triple_buffer-2048x1025.png 2048w" sizes="(max-width: 1920px) 100vw, 1920px"></a><figcaption>Performance graph for 300Mhz GPU OC at 720p (triple buffered)</figcaption></figure></div>



<p>With the GPU overclocked to 300 Mhz (up from 233.33 Mhz stock) there’s a solid 3 FPS increase in performance in the Zanzibar benchmark scene compared to stock GPU clock speed. This doesn’t seem very impressive but remember this is the “benchmark” test, it was chosen because it puts a massive load on the GPU. Outside of this area there’s a noticeable increase in FPS and running around Zanzibar the game stays at 30 FPS most of the time, dipping slightly in a few heavy areas. So how far can we push the GPU? More speed better performance, right? </p>



<p>Semiconductor fabrication is not a perfect process and every chip has imperfections in it. While every GPU that made it into an Xbox console has minimum functional and quality requirements it had to meet, the maximum capabilities of each chip varies greatly. A lot of the GPUs in the 1.0-1.4 revision consoles are on the weaker end and seem to cap out in the low 300 Mhz range, while the GPUs in the 1.6 revision consoles have been able to go upwards of 400 Mhz stable. That’s almost a 100% increase in clock speed which is very impressive, but this won’t really improve the FPS much more (or so I think). There’s another bottleneck here, and one that can’t easily be worked around.</p>



<h4>Another chip, another clock…</h4>



<p>I spent a large amount of time throughout this project wondering if part of the bottleneck issue was memory bandwidth. There’s a number of articles in the Xbox SDK docs that go into great detail about the hardware in the console, the rendering pipeline, and all the gotchas you can hit that will hurt your game’s performance. There’s a number of times that memory bandwidth is mentioned and it seems the engineers believed you could max the memory bus bandwidth fairly easily. The bus has a theoretical maximum throughput of 6.4GB/s but only about 70% of that is usable in practice, for a practical max throughput of ~4.5GB/s. I captured a number of PIX traces on the game and the estimated memory usage for a single frame was never higher than low 40MBs. No matter how I ran the numbers I just could not see the memory bus bandwidth being maxed out. In my most generous calculation I estimated max throughput of 4GB/s / 30 FPS = ~135MB/frame. Even if we assume the CPU is consuming something like 50MBs that still gives ~80MBs for GPU data. Yeah 1280×720 is a lot of pixels but this would mean each frame is accessing more data than there is RAM on the console, and it was just hard to believe. However, I know very little in this area and it was very well possible that one of these numbers was off (perhaps PIX?). The engineers certainly believed it was possible so I was most likely missing or misunderstanding something.</p>



<p>Doom suggested I try increasing the RAM clock speed and see if FPS increases, which would indicate that memory is the likely bottleneck. The only problem is the RAM is already clocked at the practical maximum frequency of 200Mhz so you can only increase the speed by about ~10Mhz before it becomes unstable and the console crashes. After running some calculations I wrote the following snippet of code to change the memory clock speed:</p>



<div id="urvanov-syntax-highlighter-662143868a31e597178597" data-settings=" minimize scroll-mouseover">
				<table>
					<tbody><tr>
				<td data-settings="show">
					<div><p>1</p><p>2</p><p>3</p><p>4</p><p>5</p><p>6</p><p>7</p><p>8</p><p>9</p><p>10</p><p>11</p><p>12</p><p>13</p><p>14</p><p>15</p><p>16</p><p>17</p><p>18</p><p>19</p><p>20</p><p>21</p><p>22</p><p>23</p><p>24</p><p>25</p><p>26</p><p>27</p><p>28</p><p>29</p><p>30</p><p>31</p><p>32</p></div>
				</td>
						<td><div><p><span>void</span><span> </span><span>OverclockRAM</span><span>(</span><span>)</span></p><p><span>{</span></p><p><span>	</span><span>DWORD </span><span>MPLLCoeff</span><span> </span><span>=</span><span> </span><span>0</span><span>;</span></p><p><span>	</span><span>// Read CR_CPU_MPLL_COEFF</span></p><p><span>	</span><span>HalReadWritePCISpace</span><span>(</span><span>0</span><span>,</span><span> </span><span>0x60</span><span>,</span><span> </span><span>0x6C</span><span>,</span><span> </span><span>&amp;</span><span>MPLLCoeff</span><span>,</span><span> </span><span>sizeof</span><span>(</span><span>MPLLCoeff</span><span>)</span><span>,</span><span> </span><span>0</span><span>)</span><span>;</span></p><p><span>	</span><span>/*</span></p><p><span>		CR_CPU_MPLL_COEFF</span></p><p><span>			Bits 0-7: M</span></p><p><span>			Bits 8-15: N</span></p><p><span>			Bits 16-19: FSB_P</span></p><p><span>			Bits 20-23: MEM_P</span></p><p><span>		BASE_CLK = 16.6667 Mhz</span></p><p><span>		VCOFreq = (BASE_CLK / M) * FSB_P * 2 * N</span></p><p><span>		MEMCLK = VCOFreq / (2 * MEM_P)</span></p><p><span>	*/</span></p><p><span>	</span><span>// M/N values for 208 Mhz MEMCLK:</span></p><p><span>	</span><span>DWORD</span><span> </span><span>M</span><span> </span><span>=</span><span> </span><span>3</span><span>;</span></p><p><span>	</span><span>DWORD</span><span> </span><span>N</span><span> </span><span>=</span><span> </span><span>25</span><span>;</span></p><p><span>	</span><span>// Update PLL coefficients.</span></p><p><span>	</span><span>MPLLCoeff</span><span> </span><span>=</span><span> </span><span>(</span><span>MPLLCoeff</span><span> </span><span>&amp;</span><span> </span><span>~</span><span>0xFF</span><span>)</span><span> </span><span>|</span><span> </span><span>(</span><span>M</span><span> </span><span>&amp;</span><span> </span><span>0xFF</span><span>)</span><span>;</span></p><p><span>	</span><span>MPLLCoeff</span><span> </span><span>=</span><span> </span><span>(</span><span>MPLLCoeff</span><span> </span><span>&amp;</span><span> </span><span>~</span><span>0xFF00</span><span>)</span><span> </span><span>|</span><span> </span><span>(</span><span>(</span><span>N</span><span> </span><span>&amp;</span><span> </span><span>0xFF</span><span>)</span><span> </span><span>&lt;&lt;</span><span> </span><span>8</span><span>)</span><span>;</span></p><p><span>	</span><span>// Update PPL value.</span></p><p><span>	</span><span>HalReadWritePCISpace</span><span>(</span><span>0</span><span>,</span><span> </span><span>0x60</span><span>,</span><span> </span><span>0x6C</span><span>,</span><span> </span><span>&amp;</span><span>MPLLCoeff</span><span>,</span><span> </span><span>sizeof</span><span>(</span><span>MPLLCoeff</span><span>)</span><span>,</span><span> </span><span>1</span><span>)</span><span>;</span></p><p><span>}</span></p></div></td>
					</tr>
				</tbody></table>
			</div>



<p>The M and N values above are chosen such that the resulting memory clock speed will be ~208 Mhz. I could adjust them some more and get closer to 210 Mhz but this was good enough to test. With these changes in place I booted up Halo 2, loaded up the Zanzibar benchmark scene and watched the perf monitor. I ran this test a number of times with and without the memory overclocking and the result was a solid 0.7 FPS increase when the memory overclocking was active. These test results aren’t conclusive but they’re definitely compelling. </p>



<p>There’s different RAM chips that work on the Xbox console and have a maximum clock speed of 250 Mhz. I searched around online and placed an order for some, but at the time of writing this I haven’t gotten to installing them or running any further tests. Doom has already tried using these memory chips and said he had trouble getting them above ~230 Mhz while the GPU was overclocked, and that there’s likely another piece to the puzzle to get them running any higher. I wanted to “push the console to the limits” with this patch but I was now 3 months into development of it and needed a break. Ultimately, even if I could get these other RAM chips running close to 250 Mhz I’d more or less be the only person able to utilize it as they’re hard to come by, quite costly, and require removing any existing RAM chips from the console motherboard before installing. With the chips on order I decided to save this experiment for future me and continue on with finishing the patch.</p>



<h2>Reducing pop-in</h2>



<p>Halo 2 had some notoriously bad pop-in issues with textures and geometry and this issue has only been exacerbated on consoles that are still running the original mechanical HDDs from the early 2000s. But now that we have all this extra RAM this should be easy to solve. Earlier I talked about the game making a single large memory allocation of ~48.9MB that I referred to as the “runtime data region”. This memory region is divided up into smaller sections for various subsystems in the game such as network resources, geometry cache, texture cache, sound cache, level data, etc. </p>



<div><figure><a href="https://icode4.coffee/wp-content/uploads/h2_retail_memory_profile.png" target="_blank" rel="noopener"><img loading="lazy" width="1697" height="1080" src="https://icode4.coffee/wp-content/uploads/h2_retail_memory_profile-1697x1080.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/h2_retail_memory_profile-1697x1080.png 1697w, https://icode4.coffee/wp-content/uploads/h2_retail_memory_profile-300x191.png 300w, https://icode4.coffee/wp-content/uploads/h2_retail_memory_profile-768x489.png 768w, https://icode4.coffee/wp-content/uploads/h2_retail_memory_profile-1536x977.png 1536w, https://icode4.coffee/wp-content/uploads/h2_retail_memory_profile-2048x1303.png 2048w, https://icode4.coffee/wp-content/uploads/h2_retail_memory_profile-110x70.png 110w" sizes="(max-width: 1697px) 100vw, 1697px"></a><figcaption>Halo 2 retail memory profile</figcaption></figure></div>



<p>The ones we’re interested in are the texture cache and geometry cache. The geometry cache is given 6.5MB of space for single player maps and 7MB for multiplayer maps. The texture cache size varies and is given all the remaining data after the “tag data” section and before the “low detail texture cache”. The larger the map the smaller the texture cache will be and the more pressure that’ll be put on it (especially for single player maps). These caches are “least recently used” data structures (or “lruv caches” as the game refers to them, not sure what the v is…), and work by evicting the least recently used data after a certain time period has elapsed. Every 30 frames (~1 second) the game will iterate through each cache and evict any data that hasn’t been used in the last 30 frames to free up space. If a request is made to load in data and there’s enough free space in the cache the data is loaded immediately (typically asynchronously, though it can block) and the request is satisfied once the read completes. If the cache is full there’s two code paths that can be taken:</p>



<ol><li>The caller can specify a parameter that indicates they want to force eviction on some other data. In this case the game will iterate through every entry in the cache and forcefully evict the least recently used items until there’s enough free space to satisfy the load request. If those items are currently being displayed on screen they’ll disappear in the next frame (and most likely submit new cache load requests). </li><li>The caller specifies they don’t want to force eviction and the load request fails. The object will not appear on screen this frame and the game will try to load it again next frame.</li></ol>



<p>Almost every call site for a load request falls down code path #2 with very few locations falling down code path #1. This is the first cause of pop-in, a request to load data is made and fails resulting in the object not being displayed on screen at the proper time. When the data is successfully loaded it will “pop” on screen and typically be far enough into the players field of view that they notice it. In the case of texture loads the map file can have up to 3 different texture buffers for low, medium, and high level of detail (LOD) versions of the same image. This is not to be confused with mip maps because each texture LOD will have its own set of mip maps. When a request is made to load in a texture the game will default to using the highest LOD possible, and if the load request fails it will try again using medium and low LOD buffers in hope that they require less memory and the load request may be possible to satisfy without waiting for memory to become available. If a load for a lower LOD version of the texture succeeds the game will attempt to load the highest LOD possible in the next few frames when more memory (hopefully) becomes available. When this happens the texture will be visible immediately at lower detail and then “pop” to higher detail when it becomes available. This is typically noticeable in cut-scenes which have the highest on-demand load requirements compared to normal game play.</p>



<div><figure><a href="https://icode4.coffee/wp-content/uploads/pop_in_fbf.png" target="_blank" rel="noopener"><img loading="lazy" width="1439" height="480" src="https://icode4.coffee/wp-content/uploads/pop_in_fbf.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/pop_in_fbf.png 1439w, https://icode4.coffee/wp-content/uploads/pop_in_fbf-300x100.png 300w, https://icode4.coffee/wp-content/uploads/pop_in_fbf-768x256.png 768w" sizes="(max-width: 1439px) 100vw, 1439px"></a><figcaption>Master chief texture popping from low to high LOD</figcaption></figure></div>



<h4>Using cache eviction to find super bounces</h4>



<p>One additional note is that each map file also contains a “low detail texture cache” which contains an “emergency” version of almost every bitmap the map uses, in sizes from 2×2 pixels to at largest 8×8 pixels, which is always resident in memory while playing. This is used in cases where a model is present in memory but the load request for the texture(s) failed at all LODs. In this scenario there would normally be no textures to render the model with but the emergency low detail texture cache can be used temporarily to get the model on screen until the normal texture can be loaded into memory. Back in the Xbox Live days of Halo 2 there used to be a “glitch” where if you pulled up the Xbox Live friends menu and then closed it the level geometry would be rendered with extremely low detail textures. If you looked closely enough you could see “cracks” in the geometry (really, just where non-co-planar triangles were joined together) that you could try and use for super bounces. This technique was used to find suitable places for performing super bounces and I even remember finding a few myself using this method. It turns out this isn’t actually a “glitch” but the game using the emergency low detail texture cache because the normal textures for geometry were evicted and the geometry needs to be rendered this frame.</p>



<div><figure><a href="https://icode4.coffee/wp-content/uploads/low_detail_textures.png" target="_blank" rel="noopener"><img loading="lazy" width="720" height="480" src="https://icode4.coffee/wp-content/uploads/low_detail_textures.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/low_detail_textures.png 720w, https://icode4.coffee/wp-content/uploads/low_detail_textures-300x200.png 300w" sizes="(max-width: 720px) 100vw, 720px"></a><figcaption>Foundation with low detail textures</figcaption></figure></div>



<h4>Visualizing cache usage</h4>



<p>When I first started adjusting the geometry and texture cache sizes I could definitely see pop-in was being reduced but I didn’t really have any good indication of when the caches were large enough and further tweaks were just redundant. After scraping through every Halo 2 build I had along with the Vista and MCC versions on PC, I was able to find enough info to recreate a debugging feature that Bungie had implemented in their debug builds of the game (this was such a pita). Using this graph visualization I could see exactly how much of the cache memory was being used at any given time which let me fine tune the sizes to what I felt was a pretty good result.</p>



<div><figure><a href="https://icode4.coffee/wp-content/uploads/texture_cache_stock_chief.png" target="_blank" rel="noopener"><img loading="lazy" width="720" height="480" src="https://icode4.coffee/wp-content/uploads/texture_cache_stock_chief.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/texture_cache_stock_chief.png 720w, https://icode4.coffee/wp-content/uploads/texture_cache_stock_chief-300x200.png 300w" sizes="(max-width: 720px) 100vw, 720px"></a><figcaption>Halo 2 Outskirts stock texture cache</figcaption></figure></div>



<p>On the stock version of the game the campaign map Outskirts (old mombasa) has a texture cache size of ~19MB. I chose this map as my test map because the opening cinematic had pretty noticeable pop-in and with the original HDD in the console it could be comically bad at times. The image above shows the texture cache graph visualization. The graph is broken up into pairs of 2 lines. The first line indicates how the memory is being used: gray = free, red = in use high detail, purple = in use medium or lower detail (aka memory pressure), pink = stolen. The second line indicates when the memory was last used: green = in use this frame, blue = in use the last 30 frames. As a side note the game can steal memory from the texture cache for other purposes such as for rasterizer render targets that are only used in cinematic cutscenes, playing the intro/attraction/credits videos, etc. As we can see in the image above master chief is being rendered using the low detail texture cache because the normal texture cache is full and there’s no memory to satisfy the texture load request. Every single texture in the cache is either in use this frame or some time in the last 30 frames. So until enough textures age out and get evicted, master chief will be stuck in low detail.</p>



<div><figure><a href="https://icode4.coffee/wp-content/uploads/texture_cache_stock_sniper.png" target="_blank" rel="noopener"><img loading="lazy" width="720" height="480" src="https://icode4.coffee/wp-content/uploads/texture_cache_stock_sniper.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/texture_cache_stock_sniper.png 720w, https://icode4.coffee/wp-content/uploads/texture_cache_stock_sniper-300x200.png 300w" sizes="(max-width: 720px) 100vw, 720px"></a><figcaption>Halo 2 Outskirts stock texture cache</figcaption></figure></div>



<p>This scene with the sniper team is one of the heavier scenes in the opening cutscene and would often result in model and texture pop-in. We can see from the texture cache graph that almost all of the memory is in use and there’s quite a few textures that are being loaded at medium or lower detail (in purple) due to the memory pressure. I also implemented an almost identical graph view for the geometry cache and using both of these I began to fine tune the cache sizes until the pop-in issues were more or less gone. </p>



<h4>Increasing the cache sizes</h4>



<p>The final result is the geometry cache being increased from 6.5/7MB to 20MB, and the texture cache increased to a static size of 30MB, nearly doubling both caches in size from the stock version of the game. At these sizes I felt the caches had adequate space and texture and model pop-in was more or less resolved. </p>



<div><figure><a href="https://icode4.coffee/wp-content/uploads/texture_cache_upgrade.png" target="_blank" rel="noopener"><img loading="lazy" width="1439" height="480" src="https://icode4.coffee/wp-content/uploads/texture_cache_upgrade.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/texture_cache_upgrade.png 1439w, https://icode4.coffee/wp-content/uploads/texture_cache_upgrade-300x100.png 300w, https://icode4.coffee/wp-content/uploads/texture_cache_upgrade-768x256.png 768w" sizes="(max-width: 1439px) 100vw, 1439px"></a><figcaption>Halo 2 Outskirts upgraded texture cache</figcaption></figure></div>



<p>As we can see the scene where master chief would appear with low detail textures now appears with high detail textures immediately (no more pop-in!) and there’s even plenty of free space in the texture cache. For the sniper scene we can see that in the previous frames all of the cache memory was being utilized, but not all at the same time as there’s plenty of chunks where the texture data has aged out of the cache. However, there were still a few cases where things would pop-in even though there was free space in the caches. To further fix this I ended up adding support to increase the HDD transfer speed from the stock UDMA 2 speed (~33.3MB/s) to UDMA 3 (~44.4MB/s) or UDMA 5 (~100MB/s) if your console had an 80 pin IDE cable. This provided a 10% increase in transfer speeds for consoles running the stock IDE cable and up to a 300% increase (theoretically, the actual transfer speeds depend greatly on the size of data being transferred) for consoles with an upgraded IDE cable. This not only helped with the remaining pop-in issues but greatly reduced loading times for the game as well. At this point I was pretty satisfied with the result.</p>



<h4>The final memory profile</h4>



<p>So after all these changes what does the final memory profile look like for Halo 2 in 720p on a console with 128MB of RAM?</p>



<div><figure><a href="https://icode4.coffee/wp-content/uploads/720p_memory_profile.png" target="_blank" rel="noopener"><img loading="lazy" width="1697" height="1080" src="https://icode4.coffee/wp-content/uploads/720p_memory_profile-1697x1080.png" alt="" srcset="https://icode4.coffee/wp-content/uploads/720p_memory_profile-1697x1080.png 1697w, https://icode4.coffee/wp-content/uploads/720p_memory_profile-300x191.png 300w, https://icode4.coffee/wp-content/uploads/720p_memory_profile-768x489.png 768w, https://icode4.coffee/wp-content/uploads/720p_memory_profile-1536x977.png 1536w, https://icode4.coffee/wp-content/uploads/720p_memory_profile-2048x1303.png 2048w, https://icode4.coffee/wp-content/uploads/720p_memory_profile-110x70.png 110w" sizes="(max-width: 1697px) 100vw, 1697px"></a><figcaption>Halo 2 720p memory profile</figcaption></figure></div>



<p>The geometry and texture caches are now huge, and more than 75% of the available 128MB of RAM has been utilized. For 1080p mode I actually had to dial the geometry and texture cache sizes back a bit as the memory used by the swap chain and rasterizer targets was so large there wasn’t enough memory remaining for the increased caches, and more or less all 128MB of RAM was in use.</p>



<h2>Conclusion</h2>



<p>I wanna thank everyone that took the time to read all the way through this blog post. This is the longest post I’ve written to date and I tried to keep it as short as possible and even cut a bunch of smaller, less interesting things out. I also wanna give a huge thanks to Doom for encouraging me to do this work, providing hardware for testing, and insight into some deep technical areas. This project was a ton of fun to work on and I learned a lot throughout the process. I always wanted to work at Bungie on a game like Halo but never got the chance to do so, and working on this project in some ways felt like I actually got to work on the game. There’s still room for improvement with a lot of the performance and memory changes I made. But overall I feel this HD patch has pushed Halo 2 and the Xbox console to their limits and I’m satisfied with the results without trying to go any further.</p>



<p>You can find the download and source code for the Halo 2 HD patch here: <a rel="noreferrer noopener" href="https://github.com/grimdoomer/Halo-2-HD" data-type="URL" data-id="https://github.com/grimdoomer/Halo-2-HD" target="_blank">GitHub</a></p>



<p>I also made a video showing side-by-side comparisons of the stock game vs the HD patch, and performance metrics for each video resolution:</p>



<figure><p>
<iframe loading="lazy" title="Halo 2 in HD on the Original Xbox" width="470" height="264" src="https://www.youtube.com/embed/O_nk21389u8?feature=oembed" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen=""></iframe>
</p><figcaption>YouTube video showing a comparison between stock game and HD patch</figcaption></figure>
									
																		
								</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[My mother declared my bedroom a disaster area (1984) (222 pts)]]></title>
            <link>https://news.lettersofnote.com/p/my-mother-declared-my-bedroom-a-disaster</link>
            <guid>40075598</guid>
            <pubDate>Thu, 18 Apr 2024 12:43:07 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://news.lettersofnote.com/p/my-mother-declared-my-bedroom-a-disaster">https://news.lettersofnote.com/p/my-mother-declared-my-bedroom-a-disaster</a>, See on <a href="https://news.ycombinator.com/item?id=40075598">Hacker News</a></p>
<div id="readability-page-1" class="page"><div dir="auto"><p><em><span>The following exchange can be found in the </span><a href="https://books.lettersofnote.com/products/more-letters-of-note" rel="">second volume of Letters of Note</a><span>. Reprinted by kind permission of the Reagan Library. The picture of Ronald Reagan peering into a child’s messy bedroom—which I’m now realising, as I type, is mildly sinister?—is in fact, believe it or not, two photos mashed together</span><span><a data-component-name="FootnoteAnchorToDOM" id="footnote-anchor-1-143702151" href="https://news.lettersofnote.com/p/my-mother-declared-my-bedroom-a-disaster#footnote-1-143702151" target="_self" rel="">1</a></span><span>. Both are from Getty who I’m sure won’t mind. </span></em></p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F549d7677-b6e0-4c3b-8aa7-8fb95b9d72e7_1000x667.jpeg" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F549d7677-b6e0-4c3b-8aa7-8fb95b9d72e7_1000x667.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F549d7677-b6e0-4c3b-8aa7-8fb95b9d72e7_1000x667.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F549d7677-b6e0-4c3b-8aa7-8fb95b9d72e7_1000x667.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F549d7677-b6e0-4c3b-8aa7-8fb95b9d72e7_1000x667.jpeg 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F549d7677-b6e0-4c3b-8aa7-8fb95b9d72e7_1000x667.jpeg" width="1000" height="667" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/549d7677-b6e0-4c3b-8aa7-8fb95b9d72e7_1000x667.jpeg&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:667,&quot;width&quot;:1000,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:516484,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/jpeg&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:false,&quot;topImage&quot;:true,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F549d7677-b6e0-4c3b-8aa7-8fb95b9d72e7_1000x667.jpeg 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F549d7677-b6e0-4c3b-8aa7-8fb95b9d72e7_1000x667.jpeg 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F549d7677-b6e0-4c3b-8aa7-8fb95b9d72e7_1000x667.jpeg 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F549d7677-b6e0-4c3b-8aa7-8fb95b9d72e7_1000x667.jpeg 1456w" sizes="100vw" fetchpriority="high"></picture></div></a></figure></div><p>As one would expect, Ronald Reagan was the recipient of thousands of letters each month during his presidency; a mailbag so voluminous, in fact, that a gang of patient volunteers were tasked with opening them all on his behalf and passing him approximately 30 each week to read and respond to. Letters arrived from all over the world, written by a diverse group of people: men, women, fans, critics, average Joes, celebrities, world leaders, and, marking a moment in history, a letter from a 13-year-old boy from South Carolina named Andy Smith, written exactly 40 years ago on 18 April 1984. </p><div><figure><a target="_blank" href="https://substackcdn.com/image/fetch/f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00d4dd7d-dec1-4c09-b1ca-4e2718dc172c_773x895.png" data-component-name="Image2ToDOM" rel=""><div><picture><source type="image/webp" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00d4dd7d-dec1-4c09-b1ca-4e2718dc172c_773x895.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00d4dd7d-dec1-4c09-b1ca-4e2718dc172c_773x895.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00d4dd7d-dec1-4c09-b1ca-4e2718dc172c_773x895.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_webp,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00d4dd7d-dec1-4c09-b1ca-4e2718dc172c_773x895.png 1456w" sizes="100vw"><img src="https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00d4dd7d-dec1-4c09-b1ca-4e2718dc172c_773x895.png" width="773" height="895" data-attrs="{&quot;src&quot;:&quot;https://substack-post-media.s3.amazonaws.com/public/images/00d4dd7d-dec1-4c09-b1ca-4e2718dc172c_773x895.png&quot;,&quot;srcNoWatermark&quot;:null,&quot;fullscreen&quot;:null,&quot;imageSize&quot;:null,&quot;height&quot;:895,&quot;width&quot;:773,&quot;resizeWidth&quot;:null,&quot;bytes&quot;:424951,&quot;alt&quot;:null,&quot;title&quot;:null,&quot;type&quot;:&quot;image/png&quot;,&quot;href&quot;:null,&quot;belowTheFold&quot;:false,&quot;topImage&quot;:false,&quot;internalRedirect&quot;:null}" alt="" srcset="https://substackcdn.com/image/fetch/w_424,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00d4dd7d-dec1-4c09-b1ca-4e2718dc172c_773x895.png 424w, https://substackcdn.com/image/fetch/w_848,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00d4dd7d-dec1-4c09-b1ca-4e2718dc172c_773x895.png 848w, https://substackcdn.com/image/fetch/w_1272,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00d4dd7d-dec1-4c09-b1ca-4e2718dc172c_773x895.png 1272w, https://substackcdn.com/image/fetch/w_1456,c_limit,f_auto,q_auto:good,fl_progressive:steep/https%3A%2F%2Fsubstack-post-media.s3.amazonaws.com%2Fpublic%2Fimages%2F00d4dd7d-dec1-4c09-b1ca-4e2718dc172c_773x895.png 1456w" sizes="100vw"></picture></div></a><figcaption>Andy Smith to U.S. President Ronald Reagan, 18th April 1984</figcaption></figure></div><blockquote><p><span>Andy Smith</span><br><span>400 London Pride Road</span><br><span>Irmo, South Carolina 29063</span></p><p>April 18, 1984</p><p>Dear Mr. President,</p><p>My name is Andy Smith. I am a seventh grade student at Irmo Middle School, in Irmo, South Carolina.</p><p>Today my mother declared my bedroom a disaster area. I would like to request federal funds to hire a crew to clean up my room. I am prepared to provide the initial funds if you will provide matching funds for this project.</p><p>I know you will be fair when you consider my request. I will be awaiting your reply.</p><p><span>Sincerely yours,</span><br><span>Andy Smith</span></p></blockquote><blockquote><p>May 11, 1984</p><p>Dear Andy:</p><p>I’m sorry to be so late in answering your letter but, as you know, I’ve been in China and found your letter here upon my return.</p><p>Your application for disaster relief has been duly noted but I must point out one technical problem: the authority declaring the disaster is supposed to make the request. In this case, your mother.</p><p>However, setting that aside, I’ll have to point out the larger problem of available funds. This has been a year of disasters: 539 hurricanes as of May 4th and several more since, numerous floods, forest fires, drought in Texas and a number of earthquakes. What I’m getting at is that funds are dangerously low.</p><p>May I make a suggestion? This Administration, believing that government has done many things that could better be done by volunteers at the local level, has sponsored a Private Sector Initiative Program, calling upon people to practice voluntarism in the solving of a number of local problems.</p><p>Your situation appears to be a natural. I’m sure your mother was fully justified in proclaiming your room a disaster. Therefore, you are in an excellent position to launch another volunteer program to go along with the more than 3000 already underway in our nation. Congratulations.</p><p>Give my best regards to your mother.</p><p><span>Sincerely,</span><br><span>Ronald Reagan</span></p></blockquote></div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Inside Amazon’s Secret Operation to Gather Intel on Rivals (192 pts)]]></title>
            <link>https://www.wsj.com/business/retail/amazon-secret-operation-intel-rivals-eb82ea3c</link>
            <guid>40075539</guid>
            <pubDate>Thu, 18 Apr 2024 12:35:43 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.wsj.com/business/retail/amazon-secret-operation-intel-rivals-eb82ea3c">https://www.wsj.com/business/retail/amazon-secret-operation-intel-rivals-eb82ea3c</a>, See on <a href="https://news.ycombinator.com/item?id=40075539">Hacker News</a></p>
Couldn't get https://www.wsj.com/business/retail/amazon-secret-operation-intel-rivals-eb82ea3c: Error: Request failed with status code 401]]></description>
        </item>
        <item>
            <title><![CDATA[The invisible seafaring industry that keeps the internet afloat (256 pts)]]></title>
            <link>https://www.theverge.com/c/24070570/internet-cables-undersea-deep-repair-ships</link>
            <guid>40075402</guid>
            <pubDate>Thu, 18 Apr 2024 12:16:30 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.theverge.com/c/24070570/internet-cables-undersea-deep-repair-ships">https://www.theverge.com/c/24070570/internet-cables-undersea-deep-repair-ships</a>, See on <a href="https://news.ycombinator.com/item?id=40075402">Hacker News</a></p>
<div id="readability-page-1" class="page"><div>

	
	
	

	
			<p><span>O</span><span>n</span><span>On</span>  the afternoon of March 11th, 2011, Mitsuyoshi Hirai, the chief engineer of the cable maintenance ship Ocean Link,<em> </em>was sitting in his cabin 20 miles off Japan’s eastern coast, completing the paperwork that comes at the end of every repair. Two weeks earlier, something — you rarely knew what — damaged the 13,000-mile fiber optic cable connecting Kitaibaraki, Japan, and Point Arena, California. Alarms went off; calls were made; and the next day, Hirai was sailing out of the port in Yokohama to fix it.</p>
	
					


	
			<div>
								<p>The repair was now nearly done. All that remained was to rebury the cable on the seafloor, which they were doing using a bulldozer-sized remotely operated submersible named Marcas — and, of course, the paperwork.&nbsp;</p>


								<p>Suddenly, the ship began to shudder. Hirai got to his feet, found he could barely stand, and staggered out of his cabin, grasping the handrail as he pulled himself up the narrow stairway to the bridge. “Engine trouble?” Hirai asked the captain, who’d already checked and replied that everything seemed normal. The ship continued to tremble. Looking out from the bridge, the sea appeared to be boiling.</p>


			</div>
	
					<div>
				<video muted="" loop="" autoplay="" playsinline="" data-sourcedesktop="https://s3.amazonaws.com/assets.sbnation.com/csk/uploads/verge-features/underwater-cables/236543_Deep_sea_cable_repair_GTakayama_0199_shrunk_1.mp4" data-sourcetablet="https://s3.amazonaws.com/assets.sbnation.com/csk/uploads/verge-features/underwater-cables/236543_Deep_sea_cable_repair_GTakayama_0199_shrunk_1.mp4" data-sourcemobile="https://s3.amazonaws.com/assets.sbnation.com/csk/uploads/verge-features/underwater-cables/236543_Deep_sea_cable_repair_GTakayama_0199_shrunk_1.mp4" type="video/mp4">
				</video>
				
				
				
					<p>
						A sketch of the Ocean Link in port in Yokohama transitions into a video of the ship. A bird flies overhead and waves lap at its hull.
					</p>
			</div>



	
			<div>
								<p>They turned on the television. An emergency alert showed that an earthquake had struck 130 miles northeast of their location. The shaking finally stopped, and in the silence, Hirai’s mind leapt to what would come next: a tsunami.</p>


								<p>Hirai feared these waves more than most people. He had grown up hearing the story of how one afternoon in 1923, his aunt felt the ground shake, swept up her two-year-old brother, and sprinted uphill to the cemetery, narrowly escaping floods and fires that killed over 100,000 people. That child became Hirai’s father, so he owed his existence to his aunt’s quick thinking. Now, he found himself in the same position. He knew tsunamis become dangerous when all the water displaced by the quake reaches shallow water and slows and grows taller. The Ocean Link, floating in less than 500 feet of water, was too shallow for comfort. </p>


			</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/01_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/01_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/01_mobile_min.jpg" alt="A photo of Mitsuyoshi Hirai, the former chief engineer of the Ocean Link. He sits at a table, his hands folded on a chart." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/01_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
			<div>
								<p>In the family tree of professions, submarine cable work occupies a lonely branch somewhere between heavy construction and neurosurgery. It’s precision engineering on a shifting sea using heavy metal hooks and high-tension lines that, if they snap, can cut a person in half. In Hirai’s three decades with Kokusai Cable Ship Company (KCS), he had learned that every step must be followed, no matter how chaotic the situation. Above all else, he often said, “you must always be cool.”&nbsp;</p>


								<p>Across Ocean Link’s 400-foot deck, the ship’s 50 crew members were emerging from their cabins and workstations, trying to figure out what had just occurred. Over the intercom, the captain announced that there had been an earthquake, a tsunami was coming, and the crew should ready the ship to evacuate to deeper water. The crew fanned out to check fuel tanks and lash down machinery. Inside a darkened, monitor-filled shipping container on the starboard deck, the submersible’s pilot steered Marcas back toward the ship as fast as the bulky robot’s propellers could carry it. Minutes later, the submersible was hoisted aboard and the Ocean Link was underway. </p>


			</div>
	

						<div>
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/02_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/02_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/02_mobile_min.jpg" alt="The controls on the bridge of the Ocean Link. A video screen shows a complicated output; there are many gauges and buttons." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/02_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/03_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/03_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/03_mobile_min.jpg" alt="Rows of binoculars sit next to a window as the Ocean Link looks out over the port." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/03_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/04_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/04_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/04_mobile_min.jpg" alt="A bright orange lifeboat on the deck of the Ocean Link." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/04_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/05_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/05_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/05_mobile_min.jpg" alt="Two large wheels guide a cable attached to the Marcas submersible (not pictured)." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/05_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
								</div>
	
			<div>
								<p>The tsunami passed under them imperceptibly on their way out to sea, and when they came to a stop three hours later, the television was showing the first images of destruction. Members of the crew who weren’t working gathered on the bridge to watch the news, which continued to display a tsunami warning, a map of Japan with its eastern seaboard glowing red. They took turns trying to reach loved ones using the ship’s satellite phone, but no calls went through.&nbsp;</p>


								<p>As night fell, periodic aftershocks thumped against the hull. Hirai thought about his wife, who was working at a department store in Yokohama near the Ocean Link’s port; his son, a junior in high school at the time; and his parents, whom the family lived with in his hometown of Yokosuka — none of whom he’d been able to reach. Everyone had someone they were worried about.</p>


								<p>But Hirai also began to think about the work he knew lay ahead. The Ocean Link was one of a small number of ships that maintain the subsea cables that carry 99 percent of the world’s data. Positioned in strategic locations around the planet, these ships stand ready to sail out and fix faults the moment they are detected, and most of the time, they are more than equal to the task. But earthquakes, Hirai knew from experience, were different. They didn’t just break one cable — they broke many, and badly. If what he feared had happened, Japan risked being cut off from the world in its moment of need.</p>


								<p>Sure enough, that night, a call came from headquarters confirming the Ocean Link was safe and directing them to remain at sea until further notice, followed by messages announcing cable failure after cable failure, including the one they had just finished repairing. </p>


			</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/06_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/06_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/06_mobile_min.jpg" alt="Fumihide Kobayashi standing in front of the submersible Marcas." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/06_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
			<div>
								<p>Cable industry professionals tend to be pragmatic people, preoccupied with the material realities of working planet-scale construction. But in conversations about landing high-bandwidth cables in digitally neglected regions or putting millions of people back in contact with every fiber strand melted together, they often hint at a sense of larger purpose, an awareness that they are performing a function vital to a world that, if they do their jobs well, will continue to be unaware of their service.</p>


								<p>For the Ocean Link crew, this awareness was bound up in a still unfolding national tragedy. They knew that whenever they returned to land, they would have to care for their loved ones quickly, because they would soon be going back out to sea. For how long, no one knew. </p>


							

			</div>
	
			<div>
								<p><span>T</span><span>he</span><span>The</span>  world’s emails, TikToks, classified memos, bank transfers, satellite surveillance, and FaceTime calls travel on cables that are about as thin as a garden hose. There are about 800,000 miles of these skinny tubes crisscrossing the Earth’s oceans, representing nearly 600 different systems, according to the industry tracking organization TeleGeography. The cables are buried near shore, but for the vast majority of their length, they just sit amid the gray ooze and alien creatures of the ocean floor, the hair-thin strands of glass at their center glowing with lasers encoding the world’s data.&nbsp;</p>


								<p>If, hypothetically, all these cables were to simultaneously break, modern civilization would cease to function. The financial system would immediately freeze. Currency trading would stop; stock exchanges would close. Banks and governments would be unable to move funds between countries because the Swift and US interbank systems both rely on submarine cables to settle over $10 trillion in transactions each day. In large swaths of the world, people would discover their credit cards no longer worked and ATMs would dispense no cash. As US Federal Reserve staff director Steve Malphrus said at a 2009 cable security conference, “When communications networks go down, the financial services sector does not grind to a halt. It snaps to a halt.”</p>


			</div>
	
			
<div>
	<p>A map of the world showing the dozens of fibre optic cable systems which stretch across the oceans, connecting continents and island chains. Some of these cables are extremely long. The map animates to show the cables laid down between 1989 and the present, with planned cables up to 2027 also displayed.</p>
	
	
	
</div>
	
			<div>
								<p>Corporations would lose the ability to coordinate overseas manufacturing and logistics. Seemingly local institutions would be paralyzed as outsourced accounting, personnel, and customer service departments went dark. Governments, which rely on the same cables as everyone else for the vast majority of their communications, would be largely cut off from their overseas outposts and each other. Satellites would not be able to pick up even half a percent of the traffic. Contemplating the prospect of a mass cable cut to the UK, then-MP Rishi Sunak concluded, “Short of nuclear or biological warfare, it is difficult to think of a threat that could be more justifiably described as existential.”</p>


								<p>Fortunately, there is enough redundancy in the world’s cables to make it nearly impossible for a well-connected country to be cut off, but cable breaks do happen. On average, they happen every other day, about 200 times a year. The reason websites continue to load, bank transfers go through, and civilization persists is because of the thousand or so people living aboard 20-some ships stationed around the world, who race to fix each cable as soon as it breaks.</p>


			</div>
	

						<div>
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/07_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/07_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/07_mobile_min.jpg" alt="Bright yellow grapnel flukes of varying lengths on the deck of the Ocean Link." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/07_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/08_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/08_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/08_mobile_min.jpg" alt="A zoomed out view of the grapnels, situating them relative to the ship." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/08_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/09_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/09_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/09_mobile_min.jpg" alt="Mushroom anchors aboard the Ocean Link. The lack of flukes helps to avoid entangling cables." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/09_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/10_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/10_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/10_mobile_min.jpg" alt="The two wide channels of the Ocean Link’s bow sheave help guide cables and grapnels as they pass over into the sea. " src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/10_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/11_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/11_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/11_mobile_min.jpg" alt="A view of the Ocean Link’s bridge from the foredeck." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/11_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
								</div>
	
			<div>
								<p>The industry responsible for this crucial work traces its origins back far beyond the internet, past even the telephone, to the early days of telegraphy. It’s invisible, underappreciated, analog. Few people set out to join the profession, mostly because few people know it exists.&nbsp;</p>


								<p>Hirai’s career path is characteristic in its circuitousness. Growing up in the 1960s in the industrial city of Yokosuka, just down the Miura Peninsula from the Ocean Link’s port in Yokohama, he worked at his parents’ fish market from the age of 12. A teenage love of American rock ‘n’ roll led to a desire to learn English, which led him to take a job at 18 as a switchboard operator at the telecom company KDDI as a means to practice. When he was 26, he transferred to a cable landing station in Okinawa because working on the beach would let him perfect his windsurfing. This was his introduction to cable maintenance and also where he met his wife. Six years later, his English proficiency got him called back to KDDI headquarters to help design Ocean Link for KCS, a KDDI subsidiary. Once it was built, he decided to go to sea with it, eventually becoming the ship’s chief engineer.</p>


			</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/12_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/12_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/12_mobile_min.jpg" alt="Captain Shoichi Suzuki sits in front of the control panels in the bridge of the Ocean Link." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/12_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
			<div>
								<p>Others come to the field from merchant navies, marine construction, cable engineering, geology, optics, or other tangentially related disciplines. When Fumihide Kobayashi, the submersible operator — a tall and solidly built man from the mountain region of Nagano — joined KCS at the age of 20, he thought he would be working on ship maintenance, not working aboard a maintenance ship. He had never been on a boat before, but Hirai enticed him to stay with stories of all the whales and other marine creatures he would see on the remote ocean.</p>


								<p>Once people are in, they tend to stay. For some, it’s the adventure — repairing cables in the churning currents of the Congo Canyon, enduring hull-denting North Atlantic storms. Others find a sense of purpose in maintaining the infrastructure on which society depends, even if most people’s response when they hear about their job is, <em>But isn’t the internet all satellites by now?</em> The sheer scale of the work can be thrilling, too. People will sometimes note that these are the largest construction projects humanity has ever built or sum up a decades-long resume by saying they’ve laid enough cable to circle the planet six times.</p>


								<p>KCS has around 80 employees, many of whom, like Hirai, have worked there for decades. Because the industry is small and careers long, it can seem like everyone knows one another. People often refer to it as a family. Shipboard life lends itself to a strong sense of camaraderie, with periods of collaboration under pressure followed by long stretches — en route to a worksite or waiting for storms to pass — without much to do but hang out. Kobayashi learned to fish off the side of the ship and attempted to improve the repetitive cuisine by serving his crewmates sashimi. (His favorite is squid, but his colleagues would prefer he use the squid to catch mackerel.) Hirai, an enthusiastic athlete, figured out how to string up a net on the Ocean Link’s<em> </em>helideck and play tennis. Other times, he would join the crew for karaoke in the lounge, a wood-paneled room behind an anomalous stained-glass door containing massage chairs, a DVD library, and a bar. A self-described “walking jukebox,” Hirai favored Simon &amp; Garfunkel and Billy Joel, though he said the younger members of the fleet didn’t go in for it as much.</p>


			</div>
	

						<div>
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/13_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/13_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/13_mobile_min.jpg" alt="The Ocean Link’s galley features enough tables and chairs for 20 or more people." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/13_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/14_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/14_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/14_mobile_min.jpg" alt="Pale green curtains frame an on-ship shrine with decorated figures and a plant." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/14_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/15_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/15_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/15_mobile_min.jpg" alt="The lounge aboard the Ocean Link, including a large recliner, a bar, and a dartboard." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/15_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/16_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/16_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/16_mobile_min.jpg" alt="Dozens of condiments on one of the tables in the Ocean Link’s galley." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/16_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
								</div>
	
			<div>
								<p>The world is in the midst of a cable boom, with multiple new transoceanic lines announced every year. But there is growing concern that the industry responsible for maintaining these cables is running perilously lean. There are 77 cable ships in the world, according to data supplied by SubTel Forum, but most are focused on the more profitable work of laying new systems. Only 22 are designated for repair, and it’s an aging and eclectic fleet. Often, maintenance is their second act. Some, like Alcatel’s Ile de Molene, are converted tugs. Others, like Global Marine’s Wave Sentinel, were once ferries. Global Marine <a href="https://www.datacenterdynamics.com/en/analysis/the-cable-ship-capacity-crunch/">recently told Data Centre Dynamics</a> that it’s trying to extend the life of its ships to 40 years, citing a lack of money. One out of 4 repair ships have already passed that milestone. The design life for bulk carriers and oil tankers, by contrast, is 20 years.&nbsp;</p>


								<p>“We’re all happy to spend billions to build new cables, but we’re not really thinking about how we’re going to look after them,” said Mike Constable, the former CEO of Huawei Marine Networks, who gave a presentation on the state of the maintenance fleet at an industry event in Singapore last year. “If you talk to the ship operators, they say it’s not sustainable anymore.”</p>


								<p>He pointed to a case last year when four of Vietnam’s five subsea cables <a href="https://vietnaminsider.vn/vietnams-internet-connection-disrupted-as-four-of-five-undersea-cables-broken/">went down</a>, slowing the internet to a crawl. The cables hadn’t fallen victim to some catastrophic event. It was just the usual entropy of fishing, shipping, and technical failure. But with nearby ships already busy on other repairs, the cables didn’t get fixed for six months. (One promptly <a href="https://e.vnexpress.net/news/news/vietnam-s-undersea-cable-malfunctions-right-after-getting-fixed-4623749.html">broke again</a>.)&nbsp;</p>


								<p>But perhaps a greater threat to the industry’s long-term survival is that the people, like the ships, are getting old. In a profession learned almost entirely on the job, people take longer to train than ships to build. </p>


			</div>
	
			<div>
			<p><span>Key components of the KDDI Ocean Link</span></p><p><span>Drum engine</span>
			      	<span>A powerful but delicate 12-foot diameter electro-hydraulic steel drum used for paying out and recovering cables and grapnels during repairs.</span>
				</p>
				<p><span>Linear cable engine</span>
			      	<span>A conveyor comprised of 21 pairs of cable-gripping tires used for laying and retrieving cables.</span>
				</p>
				<p><span>Cable control room</span>
			      	<span>A command center adjoining the bridge where cable tension is monitored and all cable operations are managed.</span>
				</p>
				<p><span>Cable tanks</span>
			      	<span>Three tanks capable of holding a total of 2,800 miles of cable.</span>
				</p>
				<p><span>Bow Sheave</span>
			      	<span>A rolling sheave that cables and grapnel ropes are passed over.</span>
				</p>
				<p><span>Thrusters</span>
			      	<span>Bow and stern thrusters are used to maneuver into wind, waves, and currents to keep the ship stationary during repairs.</span>
				</p>
				<p><span>MARCAS ROV</span>
			      	<span>Remote submersible capable of operating at up to 8,000ft. Equipped with cameras, sensors, a robotic arm, and a powerful water jet for burying cables.</span>
				</p>
		</div>
	
			<div>
								<p>“One of the biggest problems we have in this industry is attracting new people to it,” said Constable. He recalled another panel he was on in Singapore meant to introduce university students to the industry. “The audience was probably about 10 university kids and 60 old gray people from the industry just filling out their day,” he said. When he speaks with students looking to get into tech, he tries to convince them that subsea cables are also part — a foundational part — of the tech industry. “They all want to be data scientists and that sort of stuff,” he said. “But for me, I find this industry fascinating. You’re dealing with the most hostile environment on the planet, eight kilometers deep in the oceans, working with some pretty high technology, traveling all over the world. You’re on the forefront of geopolitics, and it’s critical for the whole way the world operates now.”</p>


								<p>The lifestyle can be an obstacle. A career in subsea means enduring long stretches far from home, unpredictable schedules, and ironically, very poor internet.</p>


			</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/17_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/17_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/17_mobile_min.jpg" alt="Kaida Takashi stands on the foredeck of the Ocean Link." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/17_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
			<div>
								<p>“Everyone complains about that,” said Kaida Takashi, a senior advisor at KCS, who is trying to get the Ocean Link<em> </em>set up with Starlink. It’s a generational difference, he said. For someone like him, a 62-year-old ham radio enthusiast, Wi-Fi barely fast enough to email is a luxury. Other industry veterans reminisced about the days when they felt fortunate to get faxes on board, or waiting for the mailbag in port, or the novelty of using the very cable they were laying to make calls from the middle of the ocean. But for people who grew up with an expectation of constant connectivity, the disconnection of shipboard life can cause visible discomfort. “It’s a part of them,” one industry veteran marveled of his younger colleagues. “They can’t let it go.”&nbsp;</p>


								<p>The industry’s biggest recruiting challenge, however, is the industry’s invisibility. It’s a truism that people don’t think about infrastructure until it breaks, but they tend not to think about the fixing of it, either. In his 2014 essay, “Rethinking Repair,” professor of information science Steven Jackson argued that contemporary thinking about technology romanticizes moments of invention over the ongoing work of maintenance, though it is equally important to the deployment of functional technology in the world. There are few better examples than the subsea cable industry, which, for over a century, has been so effective at quickly fixing faults that the public has rarely had a chance to notice. Or as one industry veteran put it, “We are one of the best-kept secrets in the world, because things just work.”&nbsp;  </p>


							

			</div>
	
			<div>
								<p><span>T</span><span>he</span><span>The</span>  Ocean Link spent two nights at sea before receiving orders to return. As they neared land, Hirai saw debris from the tsunami’s backwash floating in the water: fishing nets, tires, the roofs of buildings, the bloated body of what he guessed was a cow.&nbsp;</p>


								<p>The earthquake measured 9.1 on the Richter scale, the fourth largest ever recorded and the largest to ever hit Japan. But it was the series of tsunami waves that arrived half an hour later that dealt the most destruction, surging miles inland and sweeping buildings, cars, and thousands of people out to sea. The death toll would eventually climb to nearly 20,000, and the day would become a national tragedy referred to simply as “3/11.”</p>


								<p>The full extent of the devastation was still becoming clear when the Ocean Link returned, but the disaster had already entered a new phase. One hundred and sixty miles north of Tokyo, a 50-foot tsunami wave overtopped a seawall protecting the Fukushima power plant, swamping the emergency generators that were cooling the reactors through its automatic post-quake shutdown and precipitating a nuclear meltdown.&nbsp;</p>


								<p>Hirai’s wife and son had made it back home to their house in Yokosuka, where they lived with Hirai’s parents. Kobayashi’s family, too, was safe. Some crew lost loved ones; others sent family to stay with relatives in the south out of fear of radiation. They all knew that they had only a few days before they would be sent back out to sea.</p>


			</div>
	
					<div>
				
				
				
					<p>
						The Ocean Link in a storm in the North Pacific. The ship pitches wildly in the heavy swell, the waves crashing over its bow.&nbsp;
					</p>
			</div>


	
			<div>
								<p>The disaster had severed phone lines and wrecked cell towers, causing phone service to cut out almost immediately after the earthquake struck. Instead, people turned to email, Skype, and other online services that were mostly able to route around damage to the network. There was a sense, according to one engineer’s postmortem <a href="https://www.ausnog.net/sites/default/files/ausnog-05/presentations/ausnog-05-d01p03-tomoya-yoshida-ntt.pdf">presentation</a>, that the internet was the only media that survived.</p>


								<p>But its survival was more tenuous than the public knew. While the cables connecting Japan to the rest of the world survived the initial destruction, later that night, as millions of people tried to find their way home with trains stopped and power intermittent, engineers in Tokyo network operation centers watched as one cable after another failed. By the next morning, seven of Japan’s 12 transpacific cables were severed. Engineers working through the night and following days managed to shift traffic to those that remained, but the new routes were near their maximum capacity. The head of telecom company NTT’s operation center at the time estimated that if another cable failed, it would have lost all traffic to the US. With servers for most major internet companies located there, Japan would have effectively lost the internet.&nbsp;</p>


								<p>Normally, the sequence of repairs would be determined by whichever cable owner reported the fault first, but given the extraordinary circumstances, the usually self-interested cable owners agreed to defer to KCS. The priority was to repair a cable — any cable — as fast as possible.&nbsp;</p>


								<p>It was impossible to know the state of the cables on the ocean floor, so like forensic investigators, Hirai and the other engineers had to work with the sparse facts available. By having the cable landing stations on either side of the ocean beam light down their end of the line and time the reflections back, they were able to locate the faults nearest to them within a few meters. Most of the faults lay in deep water, in the canyons channeling into the Japan Trench. This, plus the timing of the faults, indicated it wasn’t the quake that broke them but the underwater avalanches it triggered. </p>


			</div>
	
			<section>
	
	
	<p>“It hasn’t changed in 150 years... The Victorians did it that way and we’re doing it the same way.”</p>
</section>
	
			<div>
								<p>Submarine landslides are awesome events whose existence was only discovered in the 1950s, when scientists analyzed the timing of 12 cable faults that severed communication between Europe and North America two decades earlier. Before then, according to oceanographer Mike Clare, “It was assumed that deep water was boring and nothing happens down there.” In fact, the ocean floor is riven with mountains and canyons that experience avalanches that dwarf anything found on land, cascades of sediment and debris racing for hundreds of miles. Hirai had dealt with them in Taiwan in 2006, one of the most notorious events in the annals of cable repair.&nbsp;</p>


								<p>On December 26th, an earthquake dislodged sediment on Taiwan’s southern coast and sent it rushing 160 miles into the Luzon Strait, one of several global cable chokepoints. Nine cables were severed and Taiwan was knocked almost entirely offline. Banking, airlines, and communications were disrupted throughout the region. Trading of the Korean won was halted. The cables, buried under mountains of debris, were nearly impossible to find. It took 11 ships, including the Ocean Link, nearly two months to finish repairs.</p>


								<p>Often in a multi-cable disaster like the Taiwan earthquake, every ship in the region comes to assist. But with Japan, there was an unprecedented complication: the majority of the faults were located offshore of the ongoing nuclear meltdown at Fukushima. Ship operators deemed assistance too risky, which meant that, for the time being, the Ocean Link was on its own.&nbsp;</p>


						
								<p>The crew felt not only duty bound to work but uniquely capable of doing so. They had dealt with radiation before, though not at this scale. In 1993, shortly before the Ocean Link was to lay a cable linking Japan, Korea, and Russia, they learned the Soviets had dumped radioactive waste in the ocean along the planned route. With some trepidation, KCS proceeded with the job. They bought Geiger counters and protective gear, flew in nurses from the US with chemical weapons training, and scanned the water for radiation as they went. When none was detected, they put the gear in storage.&nbsp;</p>


								<p>Now, as they readied the ship for departure, an employee was dispatched to the depot to find the old radiation gear. A local university donated a few more sensors and trained the crew on how to use them.&nbsp;</p>


								<p>They decided to begin with the same cable they had just finished repairing when the earthquake struck. On a drizzling afternoon eight days after returning to port, with smoke still rising from the Fukushima power plant, the Ocean Link set back out to sea. </p>


			</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/18_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/18_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/18_mobile_min.jpg" alt="Cables are wrapped around a large metal structure in the KCS depot." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/18_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
			<div>
								<p><span>T</span><span>o</span><span>To</span>  the extent he is remembered, Cyrus Field is known to history as the person responsible for running a telegraph cable across the Atlantic Ocean, but he also conducted what at the time was considered an equally great technical feat: the first deep-sea cable repair.&nbsp;</p>


								<p>Field, a 35-year-old self-made paper tycoon, had no experience in telegraphy — which helps explain why, in 1854, he embarked on such a quixotic mission. Though small bodies of water like the English Channel had been bridged by telegraph, failure was routine and costly. Cables shorted out, snapped under tension, snagged on rocks, were sliced by anchors, twisted by currents, tangled around whales, attacked by swordfish, and devoured by a <a href="https://atlantic-cable.com/Article/Clifford/teredo.htm">“miserable little mollusc”</a> called the Teredo worm with an appetite for jute insulation.&nbsp;</p>


								<p>Field fared no better. Twelve years after he began, he had endured severed cables, near sinkings, and had one “success”: a cable laid in 1858 that prompted celebrations so enthusiastic that revelers set fire to New York City Hall. The cable failed weeks later.</p>


			</div>
	

						<div>
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/19_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/19_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/19_mobile_min.jpg" alt="A woodcut illustration of the SS Great Eastern as it attempts to recover the broken transatlantic telegraph cable in 1865. Men line the decks to watch the operation." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/19_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/20_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/20_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/20_mobile_min.jpg" alt="A woodcut illustration of sailors aboard the SS Great Eastern in 1865. Eighteen figures work to coil a cable around a large capstan." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/20_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/21_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/21_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/21_mobile_min.jpg" alt="A photograph of a display showing cables of various thickness as well as a model of a grapnel." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/21_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/22_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/22_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/22_mobile_min.jpg" alt="An illustration of Cyrus West Field sitting in an armchair reading a book." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/22_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
								</div>
	
			<div>
								<p>Field tried again seven years later only for the cable to snap halfway across the Atlantic. The next year, he set out yet again, promising not only to finally lay a working transatlantic cable but to recover the broken cable and finish that one, too.&nbsp;</p>


								<p>By that time, a crude method had been developed for fixing cables in shallow water. A ship would drag a hooked grapnel anchor across the seafloor, until, like the tremor of a fishing line, increasing tension showed they’d caught the cable, which they would then haul on board to fix. Field’s plan was basically this but bigger: bigger hooks, stronger rope, more powerful winding engine, all aboard the largest ship afloat, a passenger liner called the SS Great Eastern that had been retrofitted for the mission. William Thomson, the project’s scientific adviser and the future Lord Kelvin, did the math and deemed it feasible.&nbsp;</p>


								<p>“When it was first proposed to drag the bottom of the Atlantic for a cable lost in waters two and a half miles deep, the project was so daring that it seemed to be almost a war of the Titans upon the gods,” wrote Cyrus’ brother Henry. “Yet never was anything undertaken less in the spirit of reckless desperation. The cable was recovered as a city is taken by siege — by slow approaches, and the sure and inevitable result of mathematical calculation.”</p>


			</div>
	
			<section>
	
	
	<p>Humans continue to be by far the single greatest threat to cables</p>
</section>
	
			<div>
								<p>Field’s crew caught the cable on the first try and nearly had it aboard when the rope snapped and slipped back into the sea. After 28 more failed attempts, they caught it again. When they brought it aboard and found it still worked, the crew fired rockets in celebration. Field withdrew to his cabin, locked the door, and wept.</p>


								<p>Cable repair today works more or less the same as in Field’s day. There have been some refinements: ships now hold steady using automated dynamic positioning systems rather than churning paddle wheels in opposite directions, and Field’s pronged anchor has spawned a medieval-looking arsenal of grapnels — long chains called “rennies,” diamond-shaped “flat fish,” spring-loaded six-blade “son of sammys,” three-ton detrenchers with seven-foot blades for digging through marine muck — but at its core, cable repair is still a matter of a ship dragging a big hook along the ocean floor. Newfangled technologies like remotely operated submersibles can be useful in shallow water, but beyond 8,000 feet or so, conditions are so punishing that simple is best.</p>


			</div>
	
			<section>
	
	<span>A schematic view of the ocean depths, with the Ocean Link at the surface. A cable leads down from the ship into the depths. We pass through the Euphotic (Sunlight) zone where familiar animals live, before hitting the twilight zone 656 ft below sea level. The fauna gets more exotic and the light dimmer until we reach the Bathypelagic (Midnight) zone, at 3,280 ft. Here we see giant squid and anglerfish. Travelling further, the Abyssopelagic (abyssal) zone starts at 13,123 ft, and features a couple of weird fish and cephalopods. Finally, the cable terminates in a grapnel in the Hadopelagic (hadal) zone at 19,685 ft. It has hooked its target.</span>
	<p>The deepest repair the Ocean Link conducted in the aftermath of the 2011 earthquake was 6,200 meters (20,340 feet).</p>
</section>
	
			<div>
								<p>“It hasn’t changed in 150 years,” said Alasdair Wilkie, chair of the Atlantic Cable Maintenance &amp; Repair Agreement (ACMA). “The Victorians did it that way and we’re doing it the same way. I just think it’s one of those things that, if it ain’t broke, don’t fix it.”</p>


								<p>Nor have the causes of faults changed in the last century and a half. The first submarine cable, strung across the English Channel in 1850, survived for a single day before — in what may be apocryphal cable industry <a href="https://atlantic-cable.com/stamps/Cableships/indexstc.htm">slander</a> — a French eel fisherman accidentally hooked it, sliced off a piece, and came ashore bragging about his discovery of a new type of metal seaweed. In his history of global telecommunications, <em>How the World Was One</em>, Arthur C. Clarke declared this the first blow in a war between cable companies and other users of the sea that has continued to this day. </p>


			</div>
	
					<div>
				<video muted="" loop="" autoplay="" playsinline="" data-sourcedesktop="https://s3.amazonaws.com/assets.sbnation.com/csk/uploads/verge-features/underwater-cables/236543_Deep_sea_cable_repair_GTakayama_0199_shrunk.mp4" data-sourcetablet="https://s3.amazonaws.com/assets.sbnation.com/csk/uploads/verge-features/underwater-cables/236543_Deep_sea_cable_repair_GTakayama_0199_shrunk.mp4" data-sourcemobile="https://s3.amazonaws.com/assets.sbnation.com/csk/uploads/verge-features/underwater-cables/236543_Deep_sea_cable_repair_GTakayama_0199_shrunk.mp4" type="video/mp4">
				</video>
				
				
				
					<p>
						A sketch of the Ocean Link from the foredeck transitions into a video of the ship in port.
					</p>
			</div>



	
			<p>Humans continue to be by far the single greatest threat to cables. Fishing accounts for about 40 percent of faults, according to the International Cable Protection Committee (ICPC). Bottom trawling, particularly as it extends into new regions and deeper water in pursuit of depleting fish stocks, is especially damaging. Last year, <a href="https://apnews.com/article/matsu-taiwan-internet-cables-cut-china-65f10f5f73a346fa788436366d7a7c70#:~:text=The%20National%20Communications%20Commission%2C%20citing,cut%20the%20second%2C%20NCC%20said.">Chinese fishing vessels</a> severed cables to one of Taiwan’s outlying islands, triggering an international incident. (Severing Taiwan’s cables is one of the first moves in war games of a Chinese siege.) The year before, trawlers cut multiple cables <a href="https://www.bloomberg.com/news/articles/2023-04-24/fishing-boats-keep-running-over-ocean-internet-cables">off the coast of Scotland</a>, knocking several islands offline. Dragged anchors from cruise ships, cargo vessels, and pleasure boats are another common culprit. Last year, an improperly moored mega yacht knocked out <a href="https://nationwideradiojm.com/mega-yacht-causes-islandwide-communications-meltdown-in-anguilla/">all communication for the Caribbean island of Anguilla</a>.</p>
	

						
	
			<div>
								<p>One thing that is not a threat to cables, many in the industry are eager to emphasize, is sharks. The idea that sharks eat submarine cables — repeated in news stories and even some government reports — stems from an incident in the late 1980s when AT&amp;T was testing one of the first subsea fiber optic cables off the coast of the Canary Islands. The cable kept suffering mysterious faults, and when a repair ship hauled it up, teeth were found embedded near the breaks. A study was launched. Bell Labs scientists measured jaw radii and bite strength and, at one point, tried to feed captured sharks samples of cable. The culprit turned out to be a deepwater crocodile shark, possibly attracted to the electromagnetic field emitted from the power repeaters.&nbsp;</p>


								<p>Wrapping cables in metal tape seems to have solved any shark problems. Nevertheless, when an old YouTube video of a shark biting a cable went viral in 2014, it incited global news coverage. The ICPC issued a statement (“Sharks are not the nemesis of the internet — ICPC findings”) saying that it didn’t even look like a data cable, fish bites haven’t caused a fault in many years, and that humans are almost always to blame. Yet the myth endures, possibly because there is something satisfying about the idea of the modern world being brought down by the appetites of a prehistoric creature, and possibly because the idea of sharks eating the internet seems only slightly less improbable than the internet consisting of tubes on the bottom of the sea. </p>


							

			</div>
	
			<div>
								<p><span>O</span><span>n</span><span>On</span>  March 22nd, with the world’s attention fixed on the crisis at Fukushima, the<em> </em>Ocean Link reached its worksite 160 miles to the south. They had chosen one of the faults farthest from the meltdown, but the winter wind was blowing from the north and the crew remained inside the ship until it was deemed safe to go outside.&nbsp;</p>


								<p>As the chief engineer and one of the oldest members of the crew, Hirai felt it was his duty to perform the radiation checks. He pulled on the slick yellow coveralls and boots, strapped on a mask and goggles, and opened the heavy steel door leading to the foredeck.&nbsp;</p>


								<p>The sky was overcast and low, and the ship rocked on a building swell as Hirai walked out onto the pocked green-painted deck and held out the wand of his Geiger counter to see what the wind carried. To his relief, it registered only background radiation. Next, he walked to the side and lowered a sensor into the sea. Again, nothing. He would do it all again in two hours, but for now, work could begin.&nbsp;</p>


								<p>They spent the first day and night surveying the worksite, moving slowly along the cable route while measuring the depth and current. Conditions worsened overnight and dawn greeted them with 15-foot waves and gale-force winds, too violent for delicate cable work. They would have to wait.</p>


								<p>At the most basic level, a broken cable is fixed by patching the break with a piece of new cable, but because the break is miles away on the ocean floor, this must be done in several steps. The first step is to cut the cable near the break (often, the cable will have been damaged but not cleanly severed, and cables are laid with so little slack that they cannot be pulled to the surface in one piece). This is done by dragging a bladed grapnel across the cable in a so-called “cutting drive.” The ship then swaps the bladed grapnel for a hooked one and catches one end of the severed cable, hoists it to the surface, and attaches it to a buoy. Then they catch the other cable end, splice the spare cable to it, and tow the spare cable back to the first buoyed cable to complete the patch. The ship is now holding a working cable but one that is considerably longer than it used to be. This process of bringing each cable end to the surface separately means that every repair makes a cable longer — in deep water, by several miles. In order to minimize slack that could get tangled and snagged, the loop of new cable is towed to the side of the original route until it can lay taut on the ocean floor once again.</p>


			</div>
	

						<div>
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/25_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/25_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/25_mobile_min.jpg" alt="A hatch leading below deck in the Ocean Link. The room below is brightly illuminated." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/25_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/26_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/26_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/26_mobile_min.jpg" alt="The interior of the Ocean Link. Netted-off areas lead to the cable tanks. To the left is the jointing station, where cables are spliced." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/26_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/27_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/27_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/27_mobile_min.jpg" alt="The Ocean Link’s two powerful drum cable engines, used for paying out and reeling in cables and grapnel ropes." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/27_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/28_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/28_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/28_mobile_min.jpg" alt="A large collection of bright yellow tools stored on shelves." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/28_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/29_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/29_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/29_mobile_min.jpg" alt="A side view of a drum cable engine." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/29_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
								</div>
	
			<div>
								<p>The Ocean Link had repaired this same stretch of cable five years earlier, which meant they had already added the slack required to bring it to the surface, no cutting required. It should have been sitting on the seafloor in the form of a 12-mile loop. If they could catch it, Hirai reasoned, they would save time and — this was important — precious spare cable. Every cable ship is stationed next to a depot with a certain amount of spare cable for each system in its jurisdiction. If the Ocean Link used too much on their first repair, it would take six months to manufacture and deliver enough new cable to fix the remaining faults.</p>


								<p>By the afternoon, the Ocean Link was still plunging through heavy seas, but with the storm predicted to pass overnight, they decided to begin. From the arsenal of yellow-enameled grapnels strapped to the foredeck, Hirai selected a “jamming-type sliding prong,” a mace-like implement comprised of two metal bars studded with foot-long barbs, well suited for dragging across rocky seabed without getting stuck. They lowered it over the bow sheave and into the water. The ocean floor was more than three miles down, and it took the grapnel more than six hours to hit bottom. The Ocean Link began to move slowly forward.</p>


								<p>From this point onward, Hirai or another engineer would be in the cable control room — an instrument-filled command center behind the bridge — their attention fixed on the tension meter, a circular dial set into a pale green wall. The retro-looking analog gauge was less precise than a digital one but far better for intuitively conveying changes in tension than a jittery numerical readout. The steady wavering of its arm would mean the grapnel was plowing through the gray ooze of the ocean floors. A staccato spike; they had hooked a rock. A steady rise; the cable had been caught. Part of being an effective chief engineer, Hirai found, was the ability to read what was happening on the ocean floor from the limited information of the moving dial.&nbsp;</p>


								<p>At 6AM the next day, the engineer on duty saw the telltale rise of a caught cable, and the Ocean Link came to a stop. They had hooked the cable on the first run — rare in an earthquake repair — and began to reel it in.</p>


			</div>
	
			<section>
	
	
	<p>The ships are aging; the people are aging; and it’s unclear where the money will come from to turn things around</p>
</section>
	
			<div>
								<p>Almost immediately, there was a sign something was amiss. The tension was rising too high too fast. The cable must be pinned under debris, Hirai thought. He ordered the winding engine to slow lest the cable snap, reeling in the grapnel at a grinding 10 feet per minute.&nbsp;</p>


								<p>The morning passed, then the afternoon, Hirai suiting up every few hours to check for radiation. The drum engine continued its slow rotation. Night fell. Half past midnight, after 19 hours of winding, the cable reached the surface.&nbsp;</p>


								<p>The grapnel came over the bow and was illuminated by the deck lights. Hirai was horrified at what he saw. They had caught the cable, but it was mangled unlike anything he had seen before. Hooked around one of the grapnel’s lower barbs, the cable’s polyethylene and wire sheath had been stripped by extreme tension and sprang in coiled loops like Slinkys put through a dryer.&nbsp;</p>


						
								<p>It was a dangerous situation. There was no telling how much tension a cable this badly damaged could withstand. It was like a three-mile rubber band stretched tight from the ocean floor, being tested with every rocking wave. If it snapped, the grapnel would fly across the deck, killing anyone it hit before smashing into the cable engine room.&nbsp;</p>


								<p>They had to get the cable off the ship, but doing so involved working closely with the explosive bundle hovering, taut, above the deck. First, crew members lashed chains to either end of the cable to take the tension off the grapnel, which they then swapped for a version with a sharp blade at its center, typically used for severing cables on the ocean floor. This done, they evacuated the foredeck.&nbsp;</p>


								<p>The grapnel, cable, and chains were slowly lowered back over the prow and into the sea, the ship maneuvering delicately to minimize any sudden changes in tension. Once the cable was safely beneath the waves, they released the chains. Suddenly, pulled tight over the blade, the cable split and sank back to the ocean floor.&nbsp;</p>


								<p>For Hirai, relief at a disaster averted was soon followed by foreboding. The landslides created by the earthquake must have been far greater than he had imagined, dragging the cable for miles, mangling it, and burying it beneath who knew how much debris. He couldn’t think how to proceed. </p>


			</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/30_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/30_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/30_mobile_min.jpg" alt="The cable tension meter and other indicators in the Ocean Link’s cable control room." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/30_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
			<div>
								<p><span>D</span><span>ebates</span><span>Debates</span>  about the future of cable repair have become a staple of industry events. They typically begin with a few key facts: the ships are aging; the people are aging; and it’s unclear where the money will come from to turn things around.&nbsp;</p>


								<p>For much of the 20th century, cable maintenance wasn’t a distinct business; it was just something giant, vertically integrated telecom monopolies had to do in order to function. As they started laying coaxial cables in the 1950s, they decided to pool resources. Rather than each company having its own repair vessel mostly sitting idle, they divided the oceans into zones, each with a few designated repair ships.&nbsp;</p>


								<p>When the telcos were split up at the turn of the century, their marine divisions were sold off. Cable &amp; Wireless Marine became Global Marine. AT&amp;T’s division is now the New Jersey-based SubCom. (Both are now owned by private equity companies; KCS remains a subsidiary of KDDI.) The zone system continued, now governed by contracts between cable owners and ship operators. Cable owners can sign up with a nonprofit cooperative, like the Atlantic Cable Maintenance &amp; Repair Agreement, and pay an annual fee plus a day rate for repairs. In exchange, the zone’s three ships — a Global Marine vessel in Portland, UK, another in Curaçao, and an Orange Marine vessel in Brest, France — will stand ready to sail out within 24 hours of being notified of a fault.</p>


						
								<p>This system has been able to cope with the day-to-day cadence of cable breaks, but margins are thin and contracts are short-term, making it difficult to convince investors to spend $100 million on a new vessel.</p>


								<p>“The main issue for me in the industry has to do with hyperscalers coming in and saying we need to reduce costs every year,” said Wilkie, the chair of the ACMA, using the industry term for tech giants like Google and Meta. “We’d all like to have maintenance cheaper, but the cost of running a ship doesn’t actually change much from year to year. It goes up, actually. So there has been a severe lack of investment in new ships.”</p>


								<p>At the same time, there are more cables to repair than ever, also partly a result of the tech giants entering the industry. Starting around 2016, tech companies that previously purchased bandwidth from telcos began pouring billions of dollars into cable systems of their own, seeking to ensure their cloud services were always available and content libraries synced. The result has been not just a boom in new cables but a change in the topology of the internet. “In the old days we connected population centers,” said Constable, the former Huawei Marine executive. “Now we connect data centers. Eighty percent of traffic crossing the Atlantic is probably machines talking to machines.” </p>


			</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/31_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/31_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/31_mobile_min.jpg" alt="A black and white photograph of the bow of a cable ship." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/31_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
			<div>
								<p>Maintenance providers regard these changes with ambivalence. The cable boom means there will be no shortage of cables to fix, but it also means a future of negotiating with a handful of tech giants that can use their tremendous buying power to squeeze ship operators further.&nbsp;</p>


								<p>Market forces pose one challenge; geopolitics another. Tensions with China, including the increasing difficulty of getting permission to repair cables in the contested waters of the South China Sea, are contributing to decisions to route new systems through the Philippines and other less direct passages. Conflict in the Middle East has the industry looking nervously at the Red Sea, an infamous cable chokepoint: in February, a freighter struck by Houthi rockets dragged its anchor across three crucial connections between Asia and Europe, degrading connectivity and raising the frightening prospect of conducting repairs under fire. The Red Sea vulnerability has in turn renewed interest in an Arctic route, made potentially feasible by melting sea ice, though, for years, one of the fatal flaws of this proposal has been the question of who would repair such a cable, there being no ice-capable maintenance vessels.</p>


								<p>These and other recent events, like the 2022 Nord Stream pipeline explosion, have led governments to take a greater interest in cable security, often focusing on the specter of a deliberate attack. Late last year, NATO convened a symposium on undersea infrastructure and the future of “seabed warfare,” while the UK commissioned naval vessels to patrol their subsea connections. Meanwhile, the <a href="https://digital-strategy.ec.europa.eu/en/library/recommendation-security-and-resilience-submarine-cable-infrastructures">European Union</a>, India, and other governments have proposed investing in maintenance vessels directly.</p>


						
								<p>“The amount of ships is relatively limited, and there are a number of places where it could get critical,” said Christian Bueger, the lead author of a 2022 EU Parliament study on threats to subsea data infrastructure. As part of the study, he visited a cable repair ship in Cape Town, South Africa. It was old, he said, with oily, clanging machinery demanding hard physical labor — the opposite of the clean digital space he associated with the internet. One of his recommendations was that governments figure out a way to invest in cable fleets rather than rely on companies focused on cost cutting and efficiency.</p>


								<p>The situation of SubCom illustrates the industry’s strange moment. The company has been withdrawing from maintenance work, according to industry sources, in order to focus on more lucrative installations, many of which are for Google. At the same time, the company is <a href="https://www.reuters.com/investigates/special-report/us-china-tech-subcom/">increasingly intertwined with the US government</a>, which waged a pressure campaign to help SubCom beat China’s HMN Tech for the contract to build a major Asia-to-Europe cable, according to <em>Reuters</em>. SubCom also recently won a contract to operate the US’s first “cable security fleet.”</p>


								<p>Like the involvement of the tech giants, industry veterans regard this new government interest with ambivalence. More funding would be welcome, but the world of subsea cables is one of unforgiving tradeoffs, and it’s easy for well-intentioned policies to go awry. One often proposed solution, for example, is to corral cables into protected corridors, which can make them easier to guard against malicious actors but also makes it possible for a single landslide to take them all out at once. </p>


			</div>
	
			<section>
	
	
	<p>“Did any of us know that we went viral on TikTok?”</p>
</section>
	
			<div>
								<p>Secrecy, too, is a double-edged sword. Classifying cable locations might make them more difficult to attack while worsening exposure to what is their actual greatest threat: fishing accidents and other forms of human negligence. Greater secrecy could also heighten the tension between the industry’s near-total obscurity and its need for new recruits. Ships are a relatively easy problem to solve; they just take money. People take years to train.</p>


								<p>The submarine cable world has never been particularly public. The industry is small and competitive, and cable owners don’t want their cables to get a reputation for breaking, so they bind maintenance providers with nondisclosure agreements. The result is that in the rare case that a fault reaches public awareness, ship operators almost never talk about it. Add in national security concerns, and the result is a code of silence that pervades the entire business. (Which is also why many of the sources in this story are “industry veterans” or other anonymous descriptors.) The industry has begun to recognize that this poses a recruiting challenge.</p>


								<p>In 2022, the industry organization SubOptic gathered six cable employees in their 20s and 30s for a panel on the future of the industry. Most of them had stumbled into their jobs inadvertently after college, and the consensus was that the industry needed to be much better about raising public awareness, especially among the young.&nbsp;</p>


						
								<p>“I don’t know if anyone saw, but during the pandemic, submarine cables actually went viral on TikTok,” said one panelist, a young cable engineer from Vodafone. “People didn’t know they existed, and then suddenly, out of nowhere, they were viral. I think it’s engaging with youth and children through their own avenues — yes, you can have science museums and things like that, but they are online, they are on their iPads, they’re on their phones.”</p>


								<p>“We’ve got some pretty senior decision-makers and influencers in the subsea cable industry here,” said one audience member. “Did any of us know that we went viral on TikTok?” he asked, to laughter.&nbsp;</p>


								<p>“As this panel rightfully said upfront, it’s not that we have a brand problem,” said another audience member, “we just don’t have a brand at all.”</p>


							

			</div>
	
			<div>
								<p><span>I</span><span>t</span><span>It</span>  took the Ocean Link a month to complete its first repair. Failed grapnel runs, fishing gear entanglements, repeated radiation checks, and storms: it had been among the most difficult repairs Hirai had faced. They continued to work through the spring, but by June, they faced a dilemma.&nbsp;</p>


								<p>Many of the remaining faults lay 50 miles off the coast of Chiba, deep in the Japan Trench, where eight different cable lines passed near and sometimes over each other. It was a cable chokepoint, and a landslide must have crashed down and wrecked them all. It would be difficult to catch one without cutting its neighbor. Even if they could, it wasn’t clear they had enough spare cable to fix each fault individually, with all the loops of slack they would need to add to bring the cables to the surface.&nbsp;</p>


								<p>Hirai decided the only solution was to abandon the tangled mess and lay a new system on top of it. It would mean abandoning miles of cable as well as a branching unit: a 2,000-pound device that splits one cable into two different lines going to two destinations. But by reducing the number of loops, it would reduce the amount of cable required. Even then, it wasn’t clear they had enough. They did, however, have a lot of small bits of cable they had been careful to salvage during previous repairs — three miles here, five miles there. With a lot of work, they could be spliced together.</p>


								<p>Takashi Kurokawa had joined KCS 12 years earlier, after hearing about the company from a teacher while in engineering school. Unlike many of his colleagues who moved roles every few years, after Kurokawa learned to joint, he just kept jointing. He enjoyed the way jointing’s strict rules and standards for success created a structure within which he could push himself to attain ever greater precision and speed. </p>


			</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/32_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/32_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/32_mobile_min.jpg" alt="Takashi Kurokawa preparing to splice a fiber." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/32_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
			<div>
								<p>The work is extraordinarily delicate. Cables must be stripped of their polyurethane sheaths, copper conducting tubes, wire armor, and enamel coating until the clear glass threads themselves are exposed. Kurokawa then takes a glass strand from each cable, cleans them in a sonic bath (touching them risks damage and splinters), cleaves their ends at perfect right angles, and places them inside a black toaster-sized box called a fusion splicer, their ends almost but not quite touching. In an instant, the device aligns the ends and zaps an electric arc between them, melting the glass together. Kurokawa then winds the newly spliced fiber into a metal tube called a joint box and does it all again for the next fiber strand. The entire process can take 20 hours, with Kurokawa and his team working in shifts. Every step demands hunched, jeweler-like focus as they seek perfect precision — not in a seismically isolated clean room but in the belly of a rocking ship. Each joint is expected to function untouched under crushing pressure for at least 25 years.</p>


								<p>To speed matters, they decided to assemble what they could in port at Yokohama, with the Ocean Link moored and relatively stable. Working in shifts over 10 days, Kurokawa and his colleagues spliced 10 joints, four repeaters, and a branching unit — assembling a three-part, 100-mile system from the spare bits of cable they had on hand. At night, he dreamed of winding cables back and forth between storage tanks to get at the segments he needed. On June 26th, they tested the apparatus. It worked. They set sail the same day, with no estimate for how long it would take.</p>


								<p>Hirai had mapped out the plan to a meticulous 23 steps. They began by severing the cable running from the branching unit to Murayama in the south, catching the landward end, splicing the new cable to it, and sailing northward to the point where they planned to deposit the new branching unit. There, they attached the cable to a buoy and lowered it into the ocean. Then they were off to the northern cable, which they caught, spliced, and pulled back to the buoy. It took 12 days to get here, and now came the difficult part.</p>


			</div>
	

						<div>
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/33_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/33_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/33_mobile_min.jpg" alt="The cable jointing station aboard the Ocean Link. A large tarpaulin hangs over the station." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/33_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/34_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/34_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/34_mobile_min.jpg" alt="A close-up view of a metal vise, used to hold cables during repairs." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/34_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/44_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/44_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/44_mobile_min.jpg" alt="A cable is mounted in a vise and stripped to reveal the fiber strands at its core." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/44_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/45_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/45_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/45_mobile_min.jpg" alt="Each fiber is coated in colored enamel so workers can tell which is which." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/45_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/35_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/35_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/35_mobile_min.jpg" alt="Kurokawa selects a fiber to splice." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/35_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/36_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/36_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/36_mobile_min.jpg" alt="The colored enamel coating of the fiber is stripped, revealing the glass itself." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/36_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/37_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/37_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/37_mobile_min.jpg" alt="Kurokawa holds the stripped glass fiber close to the camera." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/37_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/38_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/38_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/38_mobile_min.jpg" alt="The fiber is cleaned in an ultrasound bath." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/38_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/39_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/39_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/39_mobile_min.jpg" alt="The fiber is cleaved at a right angle." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/39_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/40_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/40_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/40_mobile_min.jpg" alt="The fiber is placed inside the splicing machine. The stripping, cleaning, and cleaving process is repeated with the other fiber to be spliced and placed end to end with the first strand inside the machine." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/40_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/46_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/46_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/46_mobile_min.jpg" alt="" src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/46_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/41_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/41_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/41_mobile_min.jpg" alt="A plastic sheath is placed over the splice to reinforce it." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/41_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/42_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/42_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/42_mobile_min.jpg" alt="Each completed fiber splice is placed inside a sealed enclosure called a “joint box.”" src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/42_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
								</div>
	
			<div>
								<p>The final splice is the most precarious moment of the repair. On the first splice, the ship can pivot 360 degrees around the dangling cable in order to angle into the wind and waves and maintain position. But on the second splice, there are two cables hanging off the prow, and the ship’s maneuverability is far more restricted should the weather turn foul.</p>


								<p>With the branching unit, they had to complete two final splices — one for each leg — then deposit the whole apparatus to the ocean floor intact. This, the Ocean Link crew knew, would be its own challenge. A 2,000-pound weight dangling for miles through the water column can do funny things. In 2008, the Ocean Link was called to recover a branching unit that another cable ship accidentally dropped into the Japan Trench while trying to deploy it. With a typhoon approaching, they caught the cable, brought up the unit, and fashioned a webbing loincloth-like harness between the unit’s two legs for additional support before lowering it back to the bottom.</p>


								<p>They would again be working in deep water — nearly four miles — but what troubled Hirai was the current. A powerful river of warm water called the Kuroshio Current snakes unpredictably up from the south along Japan’s coast, and it happened to be racing through the worksite at four knots, aquamarine and glittering in the summer sun. The Ocean Link would have to constantly adjust its thrusters to maintain position against the stream and prevent the branching unit from banging against the hull as it descended. But the weather was fair and the swell was light, so they decided to proceed.&nbsp;</p>


								<p>Hirai, Kurokawa, Kobayashi, and more than a dozen other members of the crew assembled on the foredeck. The white-painted prow glared bright in the sun as the branching unit was brought out, a metal tube with two black accordion legs that tapered to slender cables. They had drilled this maneuver before leaving port. Clad in hard hats, the crew gingerly placed it on a metal dolly and strapped it down. Hirai tied yellow webbing between its legs to form a harness and affixed a safety rope. Kurokawa stood by the prow, watching the unit as it was rolled toward him. Kobayashi stood back by the drum engine, watching the cable unspool and worrying what would happen if it snapped, envisioning weeks of splicing plunging to the ocean floor. </p>


			</div>
	
					<div>
	<picture>
		<img data-sourcedesktop="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/47_min.jpg" data-sourcetablet="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/47_min.jpg" data-sourcemobile="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/47_mobile_min.jpg" alt="A group photo of the crew of the Ocean Link in 2011. The ship itself is in the background." src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/photos/min/47_mobile_min.jpg">
    	
    	
		<div>
					<p><img src="https://cdn.vox-cdn.com/csk/fe4f780a-1a25-4bcc-8489-4ea4403cece8/740a5e3d-5577-4a46-a47b-5580b718c574/images/logomark.svg" alt=""></p><p>Loading <span>.</span><span>.</span><span>.</span></p>
				</div>

	</picture>
	
</div>
	
			<div>
								<p>The ship’s thrusters hummed and moved the Ocean Link ever so slowly backward. One end of the branching unit lifted off the dolly as it was pulled up onto the bow sheave. To an observer, the ship would look nearly stationary as the current flowed around it. The unit went over the top of the prow and descended, hanging from its harness, until it slipped below the surface and out of sight.</p>


								<p>It was August by the time the Ocean Link finished the branching unit repair. Other ships, deeming the crisis at Fukushima stable enough to work, had arrived to help. Hirai sometimes advised them on the area’s tricky currents and rugged bathymetry, but mostly, they stayed out of each other’s way; the last thing you want to do is tangle two grapnels.</p>


								<p>The final repair was an easy one. They had to finish the job that had been interrupted by the earthquake nearly five months earlier. They returned to the site where they had made their rushed escape, deployed the submersible, and buried the rest of the cable beneath the sand.&nbsp;</p>


								<p>The repair was so close to port that there was no time to celebrate during their return, nor was there much of a mood to do so. The earthquake had caused more than 20 faults, and the Ocean Link had repaired 11 of them. It had taken 154 days of continuous work. They had missed a time of national mourning, school graduations, harvest celebrations, and the slow resumption of normalcy.&nbsp;</p>


								<p>After they docked, the crew departed for their homes. Hirai stayed behind to finish writing his final daily report, then made for home as well. As he rode the train back to Yokosuka, he watched his fellow passengers absorbed in their phones. <em>We completed the job,</em> he thought with satisfaction, <em>and they have no idea</em>. </p>


			</div>
<p><span>Creative Director: Kristen Radtke</span><span>Photo Editor: Amelia Holowaty Krales</span><span>Engineer: Graham MacAree</span>
</p>
</div></div>]]></description>
        </item>
        <item>
            <title><![CDATA[I Know the secret to the quiet mind. I wish I'd never learned it (2021) (175 pts)]]></title>
            <link>https://www.theatlantic.com/health/archive/2021/06/car-accident-brain-injury/619227/</link>
            <guid>40074520</guid>
            <pubDate>Thu, 18 Apr 2024 09:50:50 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://www.theatlantic.com/health/archive/2021/06/car-accident-brain-injury/619227/">https://www.theatlantic.com/health/archive/2021/06/car-accident-brain-injury/619227/</a>, See on <a href="https://news.ycombinator.com/item?id=40074520">Hacker News</a></p>
<div id="readability-page-1" class="page"><section data-event-module="article body" data-flatplan-body="true"><p data-flatplan-paragraph="true"><small><i data-stringify-type="italic">This article was featured in the One Story to Read Today newsletter. </i><i data-stringify-type="italic"><a data-event-element="inline link" data-sk="tooltip_parent" data-stringify-link="https://www.theatlantic.com/newsletters/sign-up/one-story-to-read-today/" delay="150" href="https://www.theatlantic.com/newsletters/sign-up/one-story-to-read-today/" rel="noopener noreferrer" target="_blank">Sign up for it here</a></i><i data-stringify-type="italic">.</i></small></p><p data-flatplan-paragraph="true">The worst things can happen on the most beautiful days. My family’s worst day was a perfect one in the summer of 2019. We picked my daughter up from camp and talked about where to go for lunch: the diner or the burger place. I don’t remember which we chose. What I do remember: being woken up, again and again, by doctors who insist on asking me the same questions—my name, where I am, what month it is—and telling me the same story, a story that I am sure is wrong.</p><p data-flatplan-paragraph="true">“You were in a car accident,” they say. But this cannot be. We’re having lunch and then going on a hike. I had promised the think tank where I work that I’d call in to a 4 p.m. meeting.</p><p data-flatplan-paragraph="true">“You are in Dartmouth-Hitchcock Hospital in New Hampshire.” Another ludicrous statement. I started the day in Vermont. Surely if I had crossed the river to New Hampshire I would know it.</p><p data-flatplan-paragraph="true">“What’s your name?” they ask me, and I tell them and tell them and tell them.</p><p data-flatplan-paragraph="true">“Where are you?” “New Hampshire,” I say, except for one time when I say “Vermont.” “New Hampshire,” they correct, and I want to say, “Really, we are so close to the border here, can’t you just give it to me this once?”</p><p data-flatplan-paragraph="true">“You were in a car accident,” they tell me again. “Your husband broke his leg and your son broke his collarbone.” These do not seem like horrible injuries, so I am waiting for the worse news, the news that my daughter is dead. She is the youngest and the smallest. She was born with albinism, and her existence has always felt improbable, and so now it must be over.</p><p data-flatplan-paragraph="true">But—thank God—it’s not. “Your daughter has fractures in her spine and damage to her lower intestine from the seat belt.” They tell me that my lower intestine was also injured, and that I’ve had surgery. I lift up my hospital gown and am surprised to see an angry red line and industrial-size staples. I remember an article I’d read about seat belts not being designed for women, and I ask the doctor if he sees more women with these injuries than men. I have yet to take in the reality of what has happened to me, to my family. Instead I am thinking about writing an exposé about the sexist seat-belt industry.</p><p data-flatplan-paragraph="true">They wake me up and ask me where I am and what my name is. A doctor asks me who the president is. “I don’t want to say,” I reply. He smiles. I am at Dartmouth for three days before I am transferred to the University of Vermont, where my husband and children are. The days pass like minutes, a loop of sleep interrupted by people asking me questions and telling me terrible things.</p><p id="injected-recirculation-link-0" data-view-action="view link - injected link - item 1" data-event-element="injected link" data-event-position="1"><a href="https://www.theatlantic.com/ideas/archive/2021/05/car-accident/618766/">Joshua Sharpe: </a><a href="https://www.theatlantic.com/ideas/archive/2021/05/car-accident/618766/">We should all be more afraid of driving</a></p><p data-flatplan-paragraph="true">One of the things I am told is that I have a brain bleed and a traumatic brain injury. I wonder if this is why I am slurring my words, but am told that the slurring is from the anti-seizure medication I am on. This sounds good. The slurring will stop. A doctor tells me I “got my bell rung.” This is a bad analogy. Bell clappers are meant to slam against the side of the bell. The brain is not meant to slam against the side of the skull.</p><p data-flatplan-paragraph="true" data-flatplan-dropcap="true">O<span>f all the injuries</span> my family is suffering from, mine is the worst. This is my totally biased opinion. My husband’s leg will take almost a year to heal. My daughter would have died if not for the surgery to repair her flayed abdomen. She is 10, and one of her friends tells her that because of the scar she will never be able to wear a bikini. She spends many days attempting to suss out whether she cares. She doesn’t yet know if she is the bikini-wearing type.</p><p data-flatplan-paragraph="true">My 13-year-old son is the only one who remembers the accident. He remembers a woman in a ponytail calling 911, the smell of gasoline and burnt metal. He remembers his father yelling “Jesus Christ.” He will have to live with the memory of his sister looking at my body and asking, “Is Mama dead?”</p><p data-flatplan-paragraph="true">These are terrible injuries, and yet, the other members of my family don’t walk around thinking, <em>Am I still me?</em> My brain injury has shaken my confidence in my own personality, my own existence. This is the worst injury.</p><p data-flatplan-paragraph="true">When we leave the hospital and move into a hotel, I frequently get lost in the hallway. The first time I roll into occupational therapy with my walker, I am grateful for the obvious signage pointing me toward the check-in desk. It’s almost as though the clinic is expecting people with brain damage.</p><p data-flatplan-paragraph="true">My therapist is a smiling, 40-something woman with dirty-blond hair. She reminds me of me before the accident. She asks if I am having any thinking problems or memory problems. I tell her about an incident with Parmesan cheese.</p><p data-flatplan-paragraph="true">“Can you get the Parmesan?” my husband asked.</p><p data-flatplan-paragraph="true">I opened the fridge and looked. I looked and looked.</p><p data-flatplan-paragraph="true">“I can’t find it,” I said with a shrug.</p><p data-flatplan-paragraph="true">My son opened the fridge and pulled out a block of Parmesan.</p><p data-flatplan-paragraph="true">It hadn’t occurred to me that this was a brain issue. Sometimes you just can’t find the Parmesan. Right?</p><p data-flatplan-paragraph="true">A test confirms that I have trouble<a data-event-element="inline link" href="https://msktc.org/tbi/factsheets/vision-problems-and-traumatic-brain-injury"> scanning a visual field</a> for objects. My brain is struggling to recognize what I see, but without a pre-accident baseline to judge from, there is no way to know how much worse I am at it now. Have I always been bad at finding things? Maybe? There are limits to how well an injured brain can scrutinize an injured brain.</p><p data-flatplan-paragraph="true">I have other visual-processing issues. At first I can’t watch television because my brain is unable to merge the images from my two eyes, so I see doubles of everything—two Phoebes, two Chandlers. I can watch with one eye closed, but I’m distracted, seething at my brain for failing to do such a simple task.</p><div data-flatplan-inline_image="true"><figure><picture><img alt="a face inside of a spiral" loading="lazy" sizes="(min-width: 729px) 655px, (min-width: 576px) calc(100vw - 48px), 100vw" srcset="https://cdn.theatlantic.com/thumbor/eiRQDwubiDbd9u68hFAUvHoFBho=/0x0:1080x1350/655x819/media/img/posts/2021/06/Patricia_Voulgaris/original.jpg 655w, https://cdn.theatlantic.com/thumbor/Xi73piGUB7i8lgSL109MioUqZ90=/0x0:1080x1350/750x938/media/img/posts/2021/06/Patricia_Voulgaris/original.jpg 750w, https://cdn.theatlantic.com/thumbor/J60ROHpmk9--89tS_nmkAFl22-g=/0x0:1080x1350/850x1063/media/img/posts/2021/06/Patricia_Voulgaris/original.jpg 850w, https://cdn.theatlantic.com/thumbor/3QBYBw90bCLgpcA-Zsh9DT5PWS0=/0x0:1080x1350/928x1160/media/img/posts/2021/06/Patricia_Voulgaris/original.jpg 928w" src="https://cdn.theatlantic.com/thumbor/eiRQDwubiDbd9u68hFAUvHoFBho=/0x0:1080x1350/655x819/media/img/posts/2021/06/Patricia_Voulgaris/original.jpg" width="655" height="819"></picture><figcaption>Patricia Voulgaris</figcaption></figure></div><p data-flatplan-paragraph="true">In one session, the therapist tells me we are going to play a game. She pulls out a deck of cards and asks me to turn cards over while saying the number or the color or the suit. The game is so difficult, I want to physically remove my brain from my skull and hurl it against a wall. I will never play this game again as long as I live.</p><p data-flatplan-paragraph="true">Eventually I graduate from occupational therapy. But occupational therapy isn’t about getting people back on their feet so they can return to think tanks. It is about making sure they can run errands without getting lost. I am someone who has always taken pride in my intelligence, and now I am not so smart. I am just a functional human being, according to occupational therapy.</p><p data-flatplan-paragraph="true" data-flatplan-dropcap="true">W<span>hen we go out in public</span> as a family, we are a walking nightmare. “Wow,” a stranger says, marveling at the device that is bolted into my husband’s femur. And then my son appears with his arm in a sling, my daughter limps over in her back brace. An injured couple is potentially funny. There is nothing funny about an injured family. “What happened to you guys?”</p><p data-flatplan-paragraph="true">When we tell the story, we explain that we were in no way at fault, which feels important. We wore our seat belts and drove the speed limit and the weather wasn’t bad and yet this happened to us. Someone was driving a pickup truck in the opposite direction. He was late to a job interview or to get his kid, or maybe he was just antsy. In front of him was a motorcycle slowing him down. Maybe he’d been behind that motorcycle for miles. Maybe he liked to take risks. He pulled into our lane and passed the motorcycle while going up a hill at 70 miles per hour. I don’t know who makes this kind of decision. Did he think, <em>I can’t believe I did something this stupid?</em> Did he also yell “Jesus Christ”?</p><p data-flatplan-paragraph="true">Because we are not at fault, <em>accident</em> feels like the wrong word. Not just wrong, but unfair. My husband starts calling it <em>the incident</em>, but an <em>incident</em> is a small thing, not something that scars you for life. <em>The smashing</em>? <em>The destruction</em>? <em>Newbury</em>, after the town where it occurred? The only thing that comes close is <em>the devastation</em>.</p><p data-flatplan-paragraph="true">The devastated me is different. My brain used to race, making lists and plans, skipping from an article I was researching to whether my kids were in appropriate after-school programs to what vacation we should take in February. Now it does none of that. There are no plans to make.</p><p data-flatplan-paragraph="true">A few days after regaining consciousness, I check my Twitter feed. I have always been a news junkie. But I have missed nothing. The news seems to be not just familiar but actually repeating itself. Something bonkers happened in the White House. People are dying in a country I’ve never been to. A company did something possibly illegal. There was a house fire in the Bronx. Are these the things I used to care about?</p><p data-flatplan-paragraph="true">The most interesting piece of news is the one I am experiencing. In the hospital we are waiting to make sure my daughter can poop through her reconstructed colon. This article isn’t in <em>The New York Times.</em></p><p data-flatplan-paragraph="true">When we return to New York I take the subway to doctor appointments. I don’t take out my phone, I just sit. My brain is quiet, which I find suspicious, but also soothing. Before the accident I went to yoga retreats and tried meditation. I said things like “I just need to unplug.” Apparently what I needed was to get hit by a truck. Perhaps I have discovered the secret to a peaceful mind, and it is traumatic brain injury. I fantasize about opening an expensive spa where busy people pay me money to whack them on the head with a baseball bat.</p><p data-flatplan-paragraph="true">The day of the accident I had been working on a project to improve how homeless people are placed into shelters. I say out loud, “I don’t care about homeless people” to see how it feels. It doesn’t ring true; I do care about homeless people. I just don’t feel like working. I have always been a regular exerciser. Now I can’t imagine wanting to do a burpee, let alone 10 of them. I always ate healthy things. But did you know that you can eat whole grains and still get hit by a truck?</p><p data-flatplan-paragraph="true">I have strange cravings. I think about apple cider all the time. Apple cider is not a normal part of my diet. I have a very detailed dream about eating chocolate cake. I eat the cake. That’s the entire dream. I find myself foraging in the fridge for flavors that don’t exist.</p><p data-flatplan-paragraph="true">I don’t know which symptoms are permanent and which are temporary. At first, the doctors say that after a year or two I’m likely to have a full return to my normal brain function. Or not. They don’t really know about the brain. It might be more like 95 percent. If I broke my elbow and someone told me I’d get 95 percent of my elbow function back, I’d be satisfied. But 95 percent of my brain function sounds terrifying. Which pieces will be missing?</p><p data-flatplan-paragraph="true">Some days I feel like myself. Other days all I can think about is the old life that is gone. Then, halfway through my recuperation, the coronavirus comes. The stores close, the schools close, the traffic on the avenue dwindles to a sporadic whoosh. And my busy friends who were always texting me about their crazy schedules are suddenly as quiet as I am. Together we wait for normal to return. The difference is that they know what normal looks like.</p><p data-flatplan-paragraph="true">In July it will be two years since the accident. The world is now coming back to life, my days slowly filling up with work and chores and exercise. Soon I will go back to in-person meetings and travel, and I wonder: Will I be up to the challenge? Or will I get lost in office buildings and airports?</p><p data-flatplan-paragraph="true">For now, in this liminal space between the old life and the new one, I often catch myself staring at my children. They have never been more beautiful. I chalk this up to the magic of braces––their teeth are finally coming into alignment––but I know this is ridiculous. They are beautiful because they are alive. I look at them, and I sit with the silence. Today, it is mine. Tomorrow, it may not be.</p></section></div>]]></description>
        </item>
        <item>
            <title><![CDATA[Cosmic Desktop: Hammering Out New Cosmic Features (199 pts)]]></title>
            <link>https://blog.system76.com/post/hammering-out-cosmic-features</link>
            <guid>40074383</guid>
            <pubDate>Thu, 18 Apr 2024 09:24:53 GMT</pubDate>
            <description><![CDATA[<p>URL: <a href="https://blog.system76.com/post/hammering-out-cosmic-features">https://blog.system76.com/post/hammering-out-cosmic-features</a>, See on <a href="https://news.ycombinator.com/item?id=40074383">Hacker News</a></p>
Couldn't get https://blog.system76.com/post/hammering-out-cosmic-features: Error: Request failed with status code 404]]></description>
        </item>
    </channel>
</rss>